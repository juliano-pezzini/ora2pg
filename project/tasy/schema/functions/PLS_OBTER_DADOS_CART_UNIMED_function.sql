-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_cart_unimed ( nr_seq_segurado_p bigint, nr_seq_plano_p bigint, ie_tipo_p text, qt_tipo_p bigint) RETURNS varchar AS $body$
DECLARE

/*
ie_tipo_p
	'DC' = cobertura
	'DR' = regiao
	'DRL' = regiao da unimed litoral
	'DRSJC' = regiao da unimed sao jose dos campos
	'DA = acomodacao
	'CA' = carencia
	'CAS' - carencia sem a data
	'CAM' = carencia com a data e mensagem
	'CAL' = carencia com data e mensagem (espacamento diferente - Unimed Lencois Paulista)
	'CAM2"' = carencia com a data e mensagem (novo layout litoral)
	'CAM3"' = carencia com a data  (novo layout litoral)
	'CAM4' = carencia com data (Blumenau - Apresentar data de adesao do contrato em beneficiarios especificos)
	'CAM6' =  carencia com a data (Unimed Maringa)
	'CAM7' =  carencia com a data (Unimed Sao Carlos)
	'DCPT' = data fim vigencia cpt
	'CR' = cooperativa responsavel
	'DASJ' = acomodacao da unimed sao jose rio preto

	CASBC = Carencias para o cartao SBC Saude
	CPTSBC = CPT para o cartao SBC Saude
*/
ds_retorno_w			varchar(4000);
nr_seq_cobertura_w		bigint;
ds_cobertura_w			varchar(255);
i				bigint;
nr_seq_regiao_w			bigint;
ds_municipio_w			varchar(255);
ds_regiao_w			varchar(4000);
cd_tiss_w			varchar(20);
qt_apartamento_w		bigint;
qt_enfermaria_w			bigint;
ds_carencia_w			varchar(255);
nr_seq_carencia_w		bigint;
dt_fim_vigencia_carencia_w	varchar(255);
ie_tipo_segurado_w		varchar(3);
nr_seq_segurado_w		bigint;
cd_cooperativa_w		varchar(10);
nr_apresentacao_w		bigint;
dt_inclusao_operadora_w		timestamp;
nr_seq_tipo_carencia_w		bigint;
ds_congenere_w			varchar(255);
qt_tipo_w			bigint;
ds_mensagem_w			varchar(4000);
nr_ordem_w			bigint;
ie_tipo_reg_w			varchar(2);
qt_caracteres_w			bigint;
nr_seq_regiao_ww		bigint;
ds_municipio_ww			varchar(255);
nr_seq_grupo_carencia_w		bigint;
qt_carencias_w			bigint;
nr_seq_segurado_ant_w		bigint;
dt_contratacao_benef_w		timestamp;
ie_acao_contrato_w		varchar(1);
dt_fim_vigencia_w		timestamp;
nr_seq_carencia_benef_w		bigint;
dt_contratacao_segurado_w	varchar(255);
nr_apresentacao_grupo_w		bigint;
ie_utilizacao_w			pls_tipo_carencia.ie_utilizacao%type;
qt_carencia_w			bigint;
qt_dias_w			pls_carencia.qt_dias%type;
dt_contratacao_w		pls_segurado.dt_contratacao%type;
ie_segmentacao_w		pls_plano.ie_segmentacao%type;
ie_carencia_abrangencia_ant_w	pls_parametros.ie_carencia_abrangencia_ant%type;
ie_carencia_abrang_nova_w	varchar(1);
cd_abrangencia_w		varchar(2);
cd_abrangencia_ant_w		varchar(2);
ie_apresentar_carencias_w	varchar(1);
qt_carencia_cumprida_w		integer;
qt_mensagens_w			integer;
nr_seq_plano_ant_w		pls_segurado_alt_plano.nr_seq_plano_ant%type;
dt_alteracao_plano_w		pls_segurado_alt_plano.dt_alteracao%type;
ie_acomodacao_w			pls_plano.ie_acomodacao%type;

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
		b.ds_cobertura
	from	pls_cobertura		a,
		pls_tipo_cobertura	b
	where	a.nr_seq_tipo_cobertura	= b.nr_sequencia
	and	a.nr_seq_plano		= nr_seq_plano_p
	and 	a.ie_situacao = 'A'
	and 	clock_timestamp() between coalesce(a.dt_inicio_vigencia, clock_timestamp()) and coalesce(a.dt_fim_vigencia, clock_timestamp())	
	order by a.nr_sequencia;

c02 CURSOR FOR
	SELECT	b.nr_sequencia
	from	pls_plano_area	a,
		pls_regiao	b
	where	a.nr_seq_regiao		= b.nr_sequencia
	and	a.nr_seq_plano		= nr_seq_plano_p
	order by a.nr_sequencia;

c03 CURSOR FOR
	SELECT	coalesce(ds_abreviacao,b.ds_municipio)
	from	pls_regiao_local	a,
		sus_municipio		b
	where	a.cd_municipio_ibge	= b.cd_municipio_ibge
	and	a.nr_seq_regiao		= nr_seq_regiao_w
	order by coalesce(ds_abreviacao,b.ds_municipio);

c04 CURSOR FOR
	SELECT	b.ds_carencia,
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_apresentacao,
		b.nr_sequencia,
		null
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	
union all

	SELECT	b.ds_grupo,
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.ie_ordem_impressao,
		null,
		b.nr_sequencia
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'

	
union all

	select	b.ds_carencia,
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_apresentacao,
		b.nr_sequencia,
		null
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_contrato		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	and	not exists (	select	1
				from	pls_carencia		a,
					pls_tipo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_tipo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
				
union all

				select	1
				from	pls_carencia		a,
					pls_grupo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_grupo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_imprimir_carteira,'N')	= 'S')
	
union all

	select	b.ds_carencia,
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_apresentacao,
		b.nr_sequencia,
		null
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_plano		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	and	not exists (	select	1
				from	pls_carencia		a,
					pls_tipo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_tipo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
				
union all

				select	1
				from	pls_carencia		a,
					pls_grupo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_grupo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_imprimir_carteira,'N')	= 'S')
	and	not exists (	select	1
				from	pls_carencia		a,
					pls_tipo_carencia	b,
					pls_segurado		c,
					pls_contrato		d
				where	a.nr_seq_tipo_carencia	= b.nr_sequencia
				and	a.nr_seq_contrato	= d.nr_sequencia
				and	c.nr_seq_contrato	= d.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_padrao_carteira,'N')	= 'S')
	order by nr_apresentacao;

c05 CURSOR FOR
	SELECT	a.nr_sequencia,
		b.ds_carencia,
		to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao nr_apresentacao,
		to_char(c.dt_contratacao,'dd/mm/yyyy'),
		b.ie_utilizacao,
		coalesce(a.qt_dias_fora_abrang_ant,a.qt_dias) qt_dias
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	a.ie_origem_carencia_benef	<> 'S'
	and	b.ie_cpt	= 'N'
	
union all

	SELECT	a.nr_sequencia,
		b.ds_carencia,
		to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao nr_apresentacao,
		to_char(c.dt_contratacao,'dd/mm/yyyy'),
		b.ie_utilizacao,
		coalesce(a.qt_dias_fora_abrang_ant,a.qt_dias) qt_dias
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_contrato		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	and	a.ie_origem_carencia_benef	<> 'S'
	and	((a.nr_seq_plano_contrato	= nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and (	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	a.nr_seq_segurado	= c.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	b.ie_cpt		='N') = 0
	
union all

	select	a.nr_sequencia,
		b.ds_carencia,
		to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao nr_apresentacao,
		to_char(c.dt_contratacao,'dd/mm/yyyy'),
		b.ie_utilizacao,
		coalesce(a.qt_dias_fora_abrang_ant,a.qt_dias) qt_dias
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_plano		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	and	a.ie_origem_carencia_benef	<> 'S'
	and (	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	a.nr_seq_segurado	= c.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	b.ie_cpt		= 'N') = 0
	and	(	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c,
				pls_contrato		d
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	c.nr_seq_contrato	= d.nr_sequencia
			and	a.nr_seq_contrato	= d.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	((a.nr_seq_plano_contrato	= nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
			and	b.ie_cpt		= 'N') = 0
	order	by	nr_apresentacao;

c06 CURSOR FOR
	SELECT	b.nr_sequencia
	from	pls_plano_area	a,
		pls_regiao	b
	where	a.nr_seq_regiao		= b.nr_sequencia
	and	a.nr_seq_plano		= nr_seq_plano_p
	order by a.nr_sequencia;

c07 CURSOR FOR
	SELECT	coalesce(ds_abreviacao,b.ds_municipio)
	from	pls_regiao_local	a,
		sus_municipio		b
	where	a.cd_municipio_ibge	= b.cd_municipio_ibge
	and	a.nr_seq_regiao		= nr_seq_regiao_ww
	order by b.ds_municipio;

/* Unimed Sao Jose do Rio Preto */

C08 CURSOR FOR
	SELECT	ds_grupo,
		dt_carencia,
		ie_tipo_segurado,
		nr_seq_segurado,
		ie_ordem_impressao
	from	(	SELECT	distinct b.ds_grupo,
            			CASE WHEN a.qt_dias=0 THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,(coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias)),'dd/mm/yyyy') END  dt_carencia,
            			c.ie_tipo_segurado,
            			c.nr_sequencia nr_seq_segurado,
            			b.ie_ordem_impressao
		FROM pls_segurado c, pls_grupo_carencia b, pls_carencia a
LEFT OUTER JOIN pls_tipo_carencia e ON (a.nr_seq_tipo_carencia = e.nr_sequencia)
WHERE (e.nr_seq_grupo = b.nr_sequencia or a.nr_seq_grupo_carencia = b.nr_sequencia) and a.nr_seq_segurado	= c.nr_sequencia and c.nr_sequencia		= nr_seq_segurado_p and coalesce(b.ie_imprimir_carteira,'N')	= 'S' and a.ie_origem_carencia_benef = 'P'
		
union all

		select	b.ds_grupo,
			CASE WHEN a.qt_dias=0 THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,(coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias)),'dd/mm/yyyy') END  dt_carencia,
			c.ie_tipo_segurado,
			c.nr_sequencia nr_seq_segurado,
			b.ie_ordem_impressao
		FROM pls_contrato d, pls_segurado c, pls_grupo_carencia b, pls_carencia a
LEFT OUTER JOIN pls_tipo_carencia e ON (a.nr_seq_tipo_carencia = e.nr_sequencia)
WHERE (e.nr_seq_grupo = b.nr_sequencia or a.nr_seq_grupo_carencia = b.nr_sequencia) and a.nr_seq_contrato	= d.nr_sequencia and c.nr_seq_contrato	= d.nr_sequencia and c.nr_sequencia		= nr_seq_segurado_p and ((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = '')) and coalesce(b.ie_imprimir_carteira,'N')	= 'S' and a.ie_origem_carencia_benef = 'P' and not exists (		select	1
            					FROM pls_segurado c, pls_grupo_carencia b, pls_carencia a
LEFT OUTER JOIN pls_tipo_carencia e ON (a.nr_seq_tipo_carencia = e.nr_sequencia)
WHERE (e.nr_seq_grupo		= b.nr_sequencia or a.nr_seq_grupo_carencia = b.nr_sequencia) and a.nr_seq_segurado	= c.nr_sequencia and c.nr_sequencia		= nr_seq_segurado_p )
		 
union all

		select	b.ds_grupo,
			CASE WHEN a.qt_dias=0 THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,(coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias)),'dd/mm/yyyy') END  dt_carencia,
			c.ie_tipo_segurado,
			c.nr_sequencia nr_seq_segurado,
			b.ie_ordem_impressao
		FROM pls_plano d, pls_segurado c, pls_grupo_carencia b, pls_carencia a
LEFT OUTER JOIN pls_tipo_carencia e ON (a.nr_seq_tipo_carencia = e.nr_sequencia)
WHERE (e.nr_seq_grupo = b.nr_sequencia or a.nr_seq_grupo_carencia = b.nr_sequencia) and a.nr_seq_plano		= d.nr_sequencia and c.nr_seq_plano		= d.nr_sequencia and c.nr_sequencia		= nr_seq_segurado_p and coalesce(b.ie_imprimir_carteira,'N')	= 'S' and a.ie_origem_carencia_benef = 'P' and not exists (		select	1
            					FROM pls_segurado c, pls_grupo_carencia b, pls_carencia a
LEFT OUTER JOIN pls_tipo_carencia e ON (a.nr_seq_tipo_carencia = e.nr_sequencia)
WHERE (e.nr_seq_grupo		= b.nr_sequencia or a.nr_seq_grupo_carencia = b.nr_sequencia) and a.nr_seq_segurado	= c.nr_sequencia and c.nr_sequencia		= nr_seq_segurado_p ) and not exists (	select	1
            					from	pls_carencia		a,
                					pls_grupo_carencia	b,
                					pls_segurado		c,
                					pls_contrato		d,
                					pls_tipo_carencia	e
            					where	a.nr_seq_tipo_carencia	= e.nr_sequencia
            					and	e.nr_seq_grupo		= b.nr_sequencia
            					and	a.nr_seq_contrato	= d.nr_sequencia
            					and	c.nr_seq_contrato	= d.nr_sequencia
            					and	c.nr_sequencia		= nr_seq_segurado_p
						and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))) ) alias31
	group by ds_grupo,
		dt_carencia,
		ie_tipo_segurado,
		nr_seq_segurado,
		ie_ordem_impressao
	order by ie_ordem_impressao;

C09 CURSOR FOR
	SELECT	b.ds_carencia,
		CASE WHEN a.qt_dias='0' THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w+a.qt_dias)),'dd/mm/yyyy') END  dt_carencia
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	b.ie_cpt		= 'S';

c10 CURSOR FOR
	SELECT	'M',
		null,
		null,
		null,
		null,
		null,
		1 nr_apresentacao,
		null,
		c.ds_mensagem,
		1 nr_ordem,
		null
	from	pls_segurado			a,
		pls_contrato			b,
		pls_contrato_mensagem_cart	c
	where	a.nr_seq_contrato	= b.nr_sequencia
	and	c.nr_seq_contrato	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_p
	and	c.ie_situacao		= 'A'
	and	clock_timestamp()	BETWEEN	coalesce(c.dt_inicio_vigencia,clock_timestamp()) and coalesce(c.dt_fim_vigencia,clock_timestamp())
	
union all

	SELECT	'M',
		null,
		null,
		null,
		null,
		null,
		1 nr_apresentacao,
		null,
		c.ds_mensagem,
		1 nr_ordem,
		null
	from	pls_segurado			a,
		pls_congenere			b,
		pls_congenere_mensagem		c
	where	a.nr_seq_congenere	= b.nr_sequencia
	and	c.nr_seq_congenere	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_p
	
union all

	select	'M',
		null,
		null,
		null,
		null,
		null,
		2 nr_apresentacao,
		null,
		c.ds_mensagem,
		2 nr_ordem,
		null
	from	pls_segurado		a,
		pls_plano		b,
		pls_plano_mensagem_cart	c
	where	a.nr_seq_plano	= b.nr_sequencia
	and	c.nr_seq_plano	= b.nr_sequencia
	and	a.nr_sequencia	= nr_seq_segurado_p
	and	c.ie_situacao	= 'A'
	and	clock_timestamp()	BETWEEN	coalesce(c.dt_inicio_vigencia,clock_timestamp()) and coalesce(c.dt_fim_vigencia,clock_timestamp())
	
union all

	select	'C',
		b.ds_carencia,
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w+a.qt_dias)),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_apresentacao,
		b.nr_sequencia,
		null ds_mensagem,
		3 nr_ordem,
		null
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	
union all

	select	'C',
		b.ds_grupo,
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w+a.qt_dias)),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.ie_ordem_impressao,
		null,
		null ds_mensagem,
		3 nr_ordem,
		b.nr_sequencia
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	
union all

	select	'C',
		b.ds_carencia,
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w+a.qt_dias)),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_apresentacao,
		b.nr_sequencia,
		null ds_mensagem,
		3 nr_ordem,
		null
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_contrato		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	
union all

	select	'C',
		b.ds_grupo,
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w+a.qt_dias)),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.ie_ordem_impressao nr_apresentacao,
		null,
		null ds_mensagem,
		3 nr_ordem,
		b.nr_sequencia
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c,
		pls_contrato		d
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	
union all

	select	'C',
		b.ds_carencia,
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w+a.qt_dias)),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_apresentacao,
		b.nr_sequencia,
		null ds_mensagem,
		3 nr_ordem,
		null
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_plano		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	
union all

	select	'C',
		b.ds_grupo,
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'ISENTO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w+a.qt_dias)),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.ie_ordem_impressao nr_apresentacao,
		null,
		null ds_mensagem,
		3 nr_ordem,
		b.nr_sequencia
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c,
		pls_plano		d
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	orDER	BY	nr_ordem,
			nr_apresentacao;

c11 CURSOR FOR
	SELECT	coalesce(ds_abreviacao,b.ds_municipio)
	from	pls_regiao_local	a,
		sus_municipio		b
	where	a.cd_municipio_ibge	= b.cd_municipio_ibge
	and	a.nr_seq_regiao		= nr_seq_regiao_w
	order by a.nr_sequencia;
	
c12 CURSOR FOR
	SELECT	b.ds_carencia,
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao nr_apresentacao
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	
union all

	SELECT	b.ds_carencia,
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao nr_apresentacao
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_contrato		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	and (	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	a.nr_seq_segurado	= c.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	b.ie_cpt		='N') = 0
	
union all

	select	b.ds_carencia,
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao nr_apresentacao
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_plano		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	and (	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	a.nr_seq_segurado	= c.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	b.ie_cpt		= 'N') = 0
	and	(	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c,
				pls_contrato		d
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	c.nr_seq_contrato	= d.nr_sequencia
			and	a.nr_seq_contrato	= d.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
			and	b.ie_cpt		= 'N') = 0
	orDER	BY	nr_apresentacao;

c13 CURSOR FOR /*Busca data de adesao e tipo de inclusao do beneficiario, e data de fim de vigencia da carencia  -  Unimed Blumenau*/
	SELECT	b.dt_contratacao,
		b.ie_acao_contrato,
		a.dt_fim_vigencia
	from	pls_carencia		a,
		pls_segurado		b
	where	b.nr_sequencia		= nr_seq_segurado_w
	and	a.nr_sequencia		= nr_seq_carencia_benef_w;	

c14 CURSOR FOR
	SELECT	substr(pls_obter_dados_grupo_carencia(b.nr_seq_grupo, 'N'),1,255) ds_carencia,
		to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	a.IE_ORIGEM_CARENCIA_BENEF	<> 'S'
	and	b.ie_cpt			= 'N'
	
union all

	SELECT	substr(pls_obter_dados_grupo_carencia(b.nr_seq_grupo, 'N'),1,255) ds_carencia,
		to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_contrato		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt			= 'N'
	and	a.ie_origem_carencia_benef	<> 'S'
	and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and (	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	a.nr_seq_segurado	= c.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	b.ie_cpt		='N') = 0
	
union all

	select	substr(pls_obter_dados_grupo_carencia(b.nr_seq_grupo, 'N'),1,255) ds_carencia,
		to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_plano		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt			= 'N'
	and	a.ie_origem_carencia_benef	<> 'S'
	and (	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	a.nr_seq_segurado	= c.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	b.ie_cpt		= 'N') = 0
	and	(	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c,
				pls_contrato		d
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	c.nr_seq_contrato	= d.nr_sequencia
			and	a.nr_seq_contrato	= d.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	((a.nr_seq_plano_contrato	= nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
			and	b.ie_cpt		= 'N') = 0
	order	by	nr_apresentacao;

C15 CURSOR FOR /* Santamalia - Deve gerar CPT tambem */
	SELECT	b.ds_carencia, /* Carencia beneficiario */
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		null,
		b.nr_apresentacao,
		0 nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	--and	b.ie_cpt	= 'N'
	
union all

	SELECT	d.ds_carencia, /* Grupo carencia beneficiario */
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		null,
		b.nr_sequencia,
		d.nr_apresentacao,
		b.ie_ordem_impressao
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c,
		pls_tipo_carencia	d
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	d.nr_seq_grupo		= b.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	
union all

	select	b.ds_carencia, /* Carencia contrato */
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		null,
		b.nr_apresentacao,
		0 nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_contrato		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	--and	b.ie_cpt	= 'N'
	and	not exists (	select	1
				from	pls_carencia		a,
					pls_tipo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_tipo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
				and	b.ie_cpt = 'N'
				
union all

				select	1
				from	pls_carencia		a,
					pls_grupo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_grupo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_imprimir_carteira,'N')	= 'S')
	
union all

	select	e.ds_carencia, /* Grupo carencia contrato */
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		null,
		b.nr_sequencia,
		e.nr_apresentacao,
		b.ie_ordem_impressao nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c,
		pls_contrato		d,
		pls_tipo_carencia	e
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	e.nr_seq_grupo		= b.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	and	not exists (	select	1
				from	pls_carencia		a,
					pls_tipo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_tipo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
				and	b.ie_cpt = 'N'
				
union all

				select	1
				from	pls_carencia		a,
					pls_grupo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_grupo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_imprimir_carteira,'N')	= 'S')
	
union all

	select	b.ds_carencia, /* Carencias do produto */
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		null,
		b.nr_apresentacao,
		0 nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_plano		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	--and	b.ie_cpt	= 'N'
	and	not exists (	select	1
				from	pls_carencia		a,
					pls_tipo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_tipo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
				and	b.ie_cpt = 'N'
				
union all

				select	1
				from	pls_carencia		a,
					pls_grupo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_grupo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_imprimir_carteira,'N')	= 'S')
	and	not exists (	select	1
				from	pls_carencia		a,
					pls_tipo_carencia	b,
					pls_segurado		c,
					pls_contrato		d
				where	a.nr_seq_tipo_carencia	= b.nr_sequencia
				and	a.nr_seq_contrato	= d.nr_sequencia
				and	c.nr_seq_contrato	= d.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
				
union all

				select	1
				from	pls_carencia		a,
					pls_grupo_carencia	b,
					pls_segurado		c,
					pls_contrato		d
				where	a.nr_seq_grupo_carencia	= b.nr_sequencia
				and	a.nr_seq_contrato	= d.nr_sequencia
				and	c.nr_seq_contrato	= d.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_imprimir_carteira,'N')	= 'S')
	
union all

	select	e.ds_carencia, /* Grupo arencias do produto */
		a.nr_sequencia,
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		null,
		e.nr_apresentacao,
		b.ie_ordem_impressao nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c,
		pls_plano		d,
		pls_tipo_carencia	e
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	e.nr_seq_grupo		= b.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	and	not exists (	select	1
				from	pls_carencia		a,
					pls_tipo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_tipo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
				and	b.ie_cpt = 'N'
				
union all

				select	1
				from	pls_carencia		a,
					pls_grupo_carencia	b,
					pls_segurado		c
				where	a.nr_seq_grupo_carencia	= b.nr_sequencia
				and	a.nr_seq_segurado	= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_imprimir_carteira,'N')	= 'S')
	and	not exists (	select	1
				from	pls_carencia		a,
					pls_tipo_carencia	b,
					pls_segurado		c,
					pls_contrato		d
				where	a.nr_seq_tipo_carencia	= b.nr_sequencia
				and	a.nr_seq_contrato	= d.nr_sequencia
				and	c.nr_seq_contrato	= d.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
				
union all

				select	1
				from	pls_carencia		a,
					pls_grupo_carencia	b,
					pls_segurado		c,
					pls_contrato		d
				where	a.nr_seq_grupo_carencia	= b.nr_sequencia
				and	a.nr_seq_contrato	= d.nr_sequencia
				and	c.nr_seq_contrato	= d.nr_sequencia
				and	c.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(b.ie_imprimir_carteira,'N')	= 'S')
	order by nr_apresentacao_grupo, nr_apresentacao;

C16 CURSOR FOR /* Unimed Maringa */
	SELECT	b.ds_carencia, /* Carencia beneficiario */
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia nr_seq_tipo_carencia,
		null nr_seq_grupo_carencia,
		b.nr_apresentacao,
		0 nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	--and	b.ie_cpt	= 'N'
	
union all

	SELECT	d.ds_carencia, /* Grupo carencia beneficiario */
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		null nr_seq_tipo_carencia,
		b.nr_sequencia nr_seq_grupo_carencia,
		d.nr_apresentacao,
		b.ie_ordem_impressao
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c,
		pls_tipo_carencia	d
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	d.nr_seq_grupo		= b.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	
union all

	select	b.ds_carencia, /* Carencia contrato */
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia nr_seq_tipo_carencia,
		null nr_seq_grupo_carencia,
		b.nr_apresentacao,
		0 nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_contrato		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	--and	b.ie_cpt	= 'N'
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_tipo_carencia	y,
					pls_segurado		z
				where	x.nr_seq_tipo_carencia	= y.nr_sequencia
				and	x.nr_seq_segurado	= z.nr_sequencia
				and	z.nr_sequencia		= nr_seq_segurado_p
				and	y.nr_sequencia		= b.nr_sequencia
				and	coalesce(y.ie_padrao_carteira,'N')	= 'S')
	
union all

	select	e.ds_carencia, /* Grupo carencia contrato */
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		null nr_seq_tipo_carencia,
		b.nr_sequencia nr_seq_grupo_carencia,
		e.nr_apresentacao,
		b.ie_ordem_impressao nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c,
		pls_contrato		d,
		pls_tipo_carencia	e
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	e.nr_seq_grupo		= b.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_grupo_carencia	y,
					pls_segurado		z
				where	x.nr_seq_grupo_carencia	= y.nr_sequencia
				and	x.nr_seq_segurado	= z.nr_sequencia
				and	y.nr_sequencia		= b.nr_sequencia
				and	z.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(y.ie_imprimir_carteira,'N')	= 'S')
	
union all

	select	b.ds_carencia, /* Carencias do produto */
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia nr_seq_tipo_carencia,
		null nr_seq_grupo_carencia,
		b.nr_apresentacao,
		0 nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_plano		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_tipo_carencia	z,
					pls_segurado		y
				where	x.nr_seq_tipo_carencia	= z.nr_sequencia
				and	x.nr_seq_segurado	= y.nr_sequencia
				and	y.nr_sequencia		= nr_seq_segurado_p
				and	z.nr_sequencia		= b.nr_sequencia
				and	coalesce(z.ie_padrao_carteira,'N')	= 'S')
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_tipo_carencia	y,
					pls_segurado		z,
					pls_contrato		w
				where	x.nr_seq_tipo_carencia	= b.nr_sequencia
				and	x.nr_seq_contrato	= w.nr_sequencia
				and	z.nr_seq_contrato	= w.nr_sequencia
				and	y.nr_sequencia		= b.nr_sequencia
				and	z.nr_sequencia		= nr_seq_segurado_p
				and	((x.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(x.nr_seq_plano_contrato::text, '') = ''))
				and	coalesce(y.ie_padrao_carteira,'N')	= 'S')
	
union all

	select	e.ds_carencia, /* Grupo arencias do produto */
		CASE WHEN a.qt_dias='0' THEN 'IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		null nr_seq_tipo_carencia,
		b.nr_sequencia nr_seq_grupo_carencia,
		e.nr_apresentacao,
		b.ie_ordem_impressao nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c,
		pls_plano		d,
		pls_tipo_carencia	e
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	e.nr_seq_grupo		= b.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_grupo_carencia	y,
					pls_segurado		z
				where	x.nr_seq_grupo_carencia	= y.nr_sequencia
				and	x.nr_seq_segurado	= z.nr_sequencia
				and	y.nr_sequencia		= b.nr_sequencia
				and	z.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(y.ie_imprimir_carteira,'N')	= 'S')
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_grupo_carencia	y,
					pls_segurado		z,
					pls_contrato		w
				where	x.nr_seq_grupo_carencia	= y.nr_sequencia
				and	x.nr_seq_contrato	= w.nr_sequencia
				and	z.nr_seq_contrato	= w.nr_sequencia
				and	y.nr_sequencia		= b.nr_sequencia
				and	z.nr_sequencia		= nr_seq_segurado_p
				and	((x.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(x.nr_seq_plano_contrato::text, '') = ''))
				and	coalesce(y.ie_imprimir_carteira,'N')	= 'S')
	order by nr_apresentacao_grupo, nr_apresentacao;

C17 CURSOR FOR /* Unimed Sao Carlos */
	SELECT	b.ds_carencia, /* Carencia beneficiario */
		CASE WHEN a.qt_dias='0' THEN '  IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia nr_seq_tipo_carencia,
		null nr_seq_grupo_carencia,
		b.nr_apresentacao,
		0 nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	--and	b.ie_cpt	= 'N'
	
union all

	SELECT	d.ds_carencia, /* Grupo carencia beneficiario */
		CASE WHEN a.qt_dias='0' THEN '  IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		null nr_seq_tipo_carencia,
		b.nr_sequencia nr_seq_grupo_carencia,
		d.nr_apresentacao,
		b.ie_ordem_impressao
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c,
		pls_tipo_carencia	d
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	d.nr_seq_grupo		= b.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	
union all

	select	b.ds_carencia, /* Carencia contrato */
		CASE WHEN a.qt_dias='0' THEN '  IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia nr_seq_tipo_carencia,
		null nr_seq_grupo_carencia,
		b.nr_apresentacao,
		0 nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_contrato		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	--and	b.ie_cpt	= 'N'
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_tipo_carencia	y,
					pls_segurado		z
				where	x.nr_seq_tipo_carencia	= y.nr_sequencia
				and	x.nr_seq_segurado	= z.nr_sequencia
				and	z.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(y.ie_padrao_carteira,'N')	= 'S')
	
union all

	select	e.ds_carencia, /* Grupo carencia contrato */
		CASE WHEN a.qt_dias='0' THEN '  IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		null nr_seq_tipo_carencia,
		b.nr_sequencia nr_seq_grupo_carencia,
		e.nr_apresentacao,
		b.ie_ordem_impressao nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c,
		pls_contrato		d,
		pls_tipo_carencia	e
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	e.nr_seq_grupo		= b.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	((a.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_grupo_carencia	y,
					pls_segurado		z
				where	x.nr_seq_grupo_carencia	= y.nr_sequencia
				and	x.nr_seq_segurado	= z.nr_sequencia
				and	z.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(y.ie_imprimir_carteira,'N')	= 'S')
	
union all

	select	b.ds_carencia, /* Carencias do produto */
		CASE WHEN a.qt_dias='0' THEN '  IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia nr_seq_tipo_carencia,
		null nr_seq_grupo_carencia,
		b.nr_apresentacao,
		0 nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_plano		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_tipo_carencia	z,
					pls_segurado		y
				where	x.nr_seq_tipo_carencia	= z.nr_sequencia
				and	x.nr_seq_segurado	= y.nr_sequencia
				and	y.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(z.ie_padrao_carteira,'N')	= 'S')
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_tipo_carencia	y,
					pls_segurado		z,
					pls_contrato		w
				where	x.nr_seq_contrato	= w.nr_sequencia
				and	z.nr_seq_contrato	= w.nr_sequencia
				and	z.nr_sequencia		= nr_seq_segurado_p
				and	((x.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(x.nr_seq_plano_contrato::text, '') = ''))
				and	coalesce(y.ie_padrao_carteira,'N')	= 'S')
	
union all

	select	e.ds_carencia, /* Grupo arencias do produto */
		CASE WHEN a.qt_dias='0' THEN '  IMEDIATO'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
		c.ie_tipo_segurado,
		c.nr_sequencia nr_seq_segurado,
		null nr_seq_tipo_carencia,
		b.nr_sequencia nr_seq_grupo_carencia,
		e.nr_apresentacao,
		b.ie_ordem_impressao nr_apresentacao_grupo
	from	pls_carencia		a,
		pls_grupo_carencia	b,
		pls_segurado		c,
		pls_plano		d,
		pls_tipo_carencia	e
	where	a.nr_seq_grupo_carencia	= b.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	e.nr_seq_grupo		= b.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_imprimir_carteira,'N')	= 'S'
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_grupo_carencia	y,
					pls_segurado		z
				where	x.nr_seq_grupo_carencia	= y.nr_sequencia
				and	x.nr_seq_segurado	= z.nr_sequencia
				and	z.nr_sequencia		= nr_seq_segurado_p
				and	coalesce(y.ie_imprimir_carteira,'N')	= 'S')
	and	not exists (	select	1
				from	pls_carencia		x,
					pls_grupo_carencia	y,
					pls_segurado		z,
					pls_contrato		w
				where	x.nr_seq_grupo_carencia	= y.nr_sequencia
				and	x.nr_seq_contrato	= w.nr_sequencia
				and	z.nr_seq_contrato	= w.nr_sequencia
				and	z.nr_sequencia		= nr_seq_segurado_p
				and	((x.nr_seq_plano_contrato = nr_seq_plano_p) or (coalesce(x.nr_seq_plano_contrato::text, '') = ''))
				and	coalesce(y.ie_imprimir_carteira,'N')	= 'S')
	order by nr_apresentacao_grupo, nr_apresentacao;

c18 CURSOR FOR /*UNIMED LITORAL */
	SELECT	'M' ie,
		null,
		c.ds_mensagem ds_carencia,
		null,
		null,
		null,
		0 nr_apresentacao,
		null,
		null,
		null
	from	pls_segurado			a,
		pls_contrato			b,
		pls_contrato_mensagem_cart	c
	where	a.nr_seq_contrato	= b.nr_sequencia
	and	c.nr_seq_contrato	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_p
	and	c.ie_situacao		= 'A'
	and	clock_timestamp()	BETWEEN	coalesce(c.dt_inicio_vigencia,clock_timestamp()) and coalesce(c.dt_fim_vigencia,clock_timestamp())
	
union all

	SELECT	'M' ie,
		null,
		c.ds_mensagem ds_carencia,
		null,
		null,
		null,
		0 nr_apresentacao,
		null,
		null,
		null
	from	pls_segurado			a,
		pls_congenere			b,
		pls_congenere_mensagem		c
	where	a.nr_seq_congenere	= b.nr_sequencia
	and	c.nr_seq_congenere	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_p
	
union all

	select	'M' ie,
		null,
		c.ds_mensagem ds_carencia,
		null,
		null,
		null,
		0 nr_apresentacao,
		null,
		null,
		null
	from	pls_segurado		a,
		pls_plano		b,
		pls_plano_mensagem_cart	c
	where	a.nr_seq_plano	= b.nr_sequencia
	and	c.nr_seq_plano	= b.nr_sequencia
	and	a.nr_sequencia	= nr_seq_segurado_p
	and	c.ie_situacao	= 'A'
	and	clock_timestamp()	BETWEEN	coalesce(c.dt_inicio_vigencia,clock_timestamp()) and coalesce(c.dt_fim_vigencia,clock_timestamp())
	
union all

	select	'C' ie,
		a.nr_sequencia,
		b.ds_carencia,
		to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao nr_apresentacao,
		to_char(c.dt_contratacao,'dd/mm/yyyy'),
		b.ie_utilizacao,
		coalesce(coalesce(a.qt_dias_fora_abrang_ant,a.qt_dias),0) qt_dias
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	a.ie_origem_carencia_benef	<> 'S'
	and	b.ie_cpt	= 'N'
	
union all

	select	'C' ie,
		a.nr_sequencia,
		b.ds_carencia,
		to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao nr_apresentacao,
		to_char(c.dt_contratacao,'dd/mm/yyyy'),
		b.ie_utilizacao,
		coalesce(coalesce(a.qt_dias_fora_abrang_ant,a.qt_dias),0) qt_dias
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_contrato		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	c.nr_seq_contrato	= d.nr_sequencia
	and	a.nr_seq_contrato	= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	and	a.ie_origem_carencia_benef	<> 'S'
	and	((a.nr_seq_plano_contrato	= nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
	and (	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	a.nr_seq_segurado	= c.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	b.ie_cpt		='N') = 0
	
union all

	select	'C' ie,
		a.nr_sequencia,
		b.ds_carencia,
		to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_inclusao_operadora_w)+a.qt_dias),'dd/mm/yyyy') dt_carencia,
		c.nr_sequencia nr_seq_segurado,
		b.nr_sequencia,
		b.nr_apresentacao nr_apresentacao,
		to_char(c.dt_contratacao,'dd/mm/yyyy'),
		b.ie_utilizacao,
		coalesce(coalesce(a.qt_dias_fora_abrang_ant,a.qt_dias),0) qt_dias
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c,
		pls_plano		d
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	a.nr_seq_plano		= d.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
	and	b.ie_cpt	= 'N'
	and	a.ie_origem_carencia_benef	<> 'S'
	and (	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	a.nr_seq_segurado	= c.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	b.ie_cpt		= 'N') = 0
	and	(	select	count(*)
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c,
				pls_contrato		d
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	c.nr_seq_contrato	= d.nr_sequencia
			and	a.nr_seq_contrato	= d.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	((a.nr_seq_plano_contrato	= nr_seq_plano_p) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
			and	b.ie_cpt		= 'N') = 0
	order	by	nr_apresentacao;

BEGIN
-- (Realizado tratamento para customizacao de relatorio)
begin
select	a.ie_tipo_segurado,
	a.dt_inclusao_operadora,
	a.nr_seq_segurado_ant,
	a.dt_contratacao,
	CASE WHEN b.ie_abrangencia='E' THEN 'ES' WHEN b.ie_abrangencia='GE' THEN 'A' WHEN b.ie_abrangencia='GM' THEN 'RB' WHEN b.ie_abrangencia='M' THEN 'MU' WHEN b.ie_abrangencia='N' THEN 'NA' END
into STRICT	ie_tipo_segurado_w,
	dt_inclusao_operadora_w,
	nr_seq_segurado_ant_w,
	dt_contratacao_w,
	cd_abrangencia_w
from	pls_segurado a,
	pls_plano b
where	a.nr_seq_plano = b.nr_sequencia
and	a.nr_sequencia	= nr_seq_segurado_p;
exception
when others then
	ie_tipo_segurado_w	:= null;
	dt_inclusao_operadora_w	:= null;
end;

if (ie_tipo_p = 'CA') then
	qt_tipo_w	:= qt_tipo_p;
	i		:= 0;
	if (coalesce(ds_retorno_w::text, '') = '') then
		open c04;
		loop
		fetch c04 into
			ds_carencia_w,
			nr_seq_carencia_w,
			dt_fim_vigencia_carencia_w,
			ie_tipo_segurado_w,
			nr_seq_segurado_w,
			nr_apresentacao_w,
			nr_seq_tipo_carencia_w,
			nr_seq_grupo_carencia_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			begin
			i	:= i + 1;

			if	((coalesce(nr_seq_tipo_carencia_w::text, '') = '') or (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S')) then
				if (qt_tipo_w = i) then
					ds_retorno_w	:= ds_carencia_w||';'||dt_fim_vigencia_carencia_w;
				end if;
			end if;
			end;
		end loop;
		close c04;
	end if;
elsif (ie_tipo_p = 'CAS') then
	i		:= 0;
	qt_tipo_w	:= 0;
	open c10;
	loop
	fetch c10 into
		ie_tipo_reg_w,
		ds_carencia_w,
		nr_seq_carencia_w,
		dt_fim_vigencia_carencia_w,
		ie_tipo_segurado_w,
		nr_seq_segurado_w,
		nr_apresentacao_w,
		nr_seq_tipo_carencia_w,
		ds_mensagem_w,
		nr_ordem_w,
		nr_seq_grupo_carencia_w;
	EXIT WHEN NOT FOUND; /* apply on c10 */
		begin
		i	:= i + 1;
		--if	(nr_ordem_w < 3) then

		--	qt_tipo_w	:= nvl(qt_tipo_w,0)+ 1; /* contador para as mensagens da carteirinha */

		--end if;
		if (ie_tipo_reg_w	= 'C') then
			--if	(dt_fim_vigencia_carencia_w = 'ISENTO') then

			--	dt_fim_vigencia_carencia_w	:= ' ( '||dt_fim_vigencia_carencia_w ||' )';

			--else

			--	dt_fim_vigencia_carencia_w	:= '';

			--end if;
			if	((coalesce(nr_seq_tipo_carencia_w::text, '') = '') or (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S')) then
					if	((qt_tipo_p - qt_tipo_w) = i) then /* numero da linha carencia na carteira, menos a quantidade de mensagem gerada */
						ds_retorno_w	:= ds_carencia_w||' '||dt_fim_vigencia_carencia_w;
					end if;
			end if;
		elsif (ie_tipo_reg_w	= 'M') then
			if (qt_tipo_p	= i) then
				ds_retorno_w	:= ds_retorno_w || ds_mensagem_w;
			end if;
		end if;
		end;
	end loop;
	close c10;
	if (substr(ds_retorno_w,length(ds_retorno_w) - 1,length(ds_retorno_w)) = ', ') then
		ds_retorno_w	:= substr(ds_retorno_w,1,length(ds_retorno_w)-2);
	end if;
	ds_retorno_w	:= substr(ds_retorno_w,1,255);
elsif (ie_tipo_p	= 'CAM') then
	i		:= 0;
	qt_tipo_w	:= 0;
	open c05;
	loop
	fetch c05 into
		nr_seq_carencia_benef_w,
		ds_carencia_w,
		dt_fim_vigencia_carencia_w,
		nr_seq_segurado_w,
		nr_seq_tipo_carencia_w,
		nr_apresentacao_w,
		dt_contratacao_segurado_w,
		ie_utilizacao_w,
		qt_dias_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		if	((dt_fim_vigencia_carencia_w <> 'ISENTO') and (clock_timestamp() > to_date(dt_fim_vigencia_carencia_w))) then
			dt_fim_vigencia_carencia_w	:= 'ISENTO';
		end if;
		
		if	((coalesce(nr_seq_tipo_carencia_w::text, '') = '') or (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S')) then
			i	:= i + 1;
			if (qt_tipo_p  = i) then
				ds_retorno_w	:= ds_carencia_w||';'||dt_fim_vigencia_carencia_w;
			end if;
		end if;
		end;
	end loop;
	close c05;
	ds_retorno_w	:= substr(ds_retorno_w,1,255);
elsif (ie_tipo_p	= 'CAL') then
	i		:= 0;
	qt_tipo_w	:= 0;
	open c14;
	loop
	fetch c14 into
		ds_carencia_w,
		dt_fim_vigencia_carencia_w,
		nr_seq_segurado_w,
		nr_seq_tipo_carencia_w,
		nr_apresentacao_w;
	EXIT WHEN NOT FOUND; /* apply on c14 */
		begin
		if	((dt_fim_vigencia_carencia_w <> 'ISENTO') and (clock_timestamp() > to_date(dt_fim_vigencia_carencia_w))) then
			dt_fim_vigencia_carencia_w	:= 'ISENTO';
		end if;
		
		if	((coalesce(nr_seq_tipo_carencia_w::text, '') = '') or (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S')) then
			i	:= i + 1;
			if (qt_tipo_p  = i) then
				ds_retorno_w	:= rpad(ds_carencia_w,30,' ')||';'||dt_fim_vigencia_carencia_w;
			end if;
		end if;
		end;
	end loop;
	close c14;	
	ds_retorno_w	:= substr(ds_retorno_w,1,255);	
elsif (ie_tipo_p	= 'CAM2') then
	i		:= 0;
	qt_tipo_w	:= 0;
	open c05;
	loop
	fetch c05 into
		nr_seq_carencia_benef_w,
		ds_carencia_w,
		dt_fim_vigencia_carencia_w,
		nr_seq_segurado_w,
		nr_seq_tipo_carencia_w,
		nr_apresentacao_w,
		dt_contratacao_segurado_w,
		ie_utilizacao_w,
		qt_dias_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		if	((dt_fim_vigencia_carencia_w <> 'IMEDIATO') and (clock_timestamp() > to_date(dt_fim_vigencia_carencia_w)) and (clock_timestamp() > to_date(dt_inclusao_operadora_w))) then
			dt_fim_vigencia_carencia_w	:= 'IMEDIATO';
		end if;
		
		if	((coalesce(nr_seq_tipo_carencia_w::text, '') = '') or (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S')) then
			i	:= i + 1;
			if (qt_tipo_p  = i) then
				ds_retorno_w	:= ds_carencia_w||';'||dt_fim_vigencia_carencia_w;
			end if;
		end if;
		end;
	end loop;
	close c05;
	ds_retorno_w	:= substr(ds_retorno_w,1,255);
elsif (ie_tipo_p	= 'CAM3') then
	i		:= 0;
	qt_tipo_w	:= 0;
		
	open c05;
	loop
	fetch c05 into
		nr_seq_carencia_benef_w,
		ds_carencia_w,
		dt_fim_vigencia_carencia_w,
		nr_seq_segurado_w,
		nr_seq_tipo_carencia_w,
		nr_apresentacao_w,
		dt_contratacao_segurado_w,
		ie_utilizacao_w,
		qt_dias_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		if	((dt_fim_vigencia_carencia_w <> 'ISENTO') and (clock_timestamp() > to_date(dt_fim_vigencia_carencia_w))) then
			if (nr_seq_segurado_ant_w IS NOT NULL AND nr_seq_segurado_ant_w::text <> '') then
				dt_fim_vigencia_carencia_w	:= dt_contratacao_w + qt_dias_w;
			else
				dt_fim_vigencia_carencia_w	:= dt_fim_vigencia_carencia_w;
			end if;
		end if;
		
		if	((coalesce(nr_seq_tipo_carencia_w::text, '') = '') or (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S')) then
			i	:= i + 1;
			if (qt_tipo_p  = i) then
				--foi solicitado que caso a da de fim de vigencia da carencia seja inferior a data de adesao do beneficiario o sistema traga a data de adesao do beneficiario.
				if (to_date(dt_fim_vigencia_carencia_w) < to_date(dt_contratacao_segurado_w)) then
					dt_fim_vigencia_carencia_w := dt_contratacao_segurado_w;
				end if;
				ds_retorno_w := ds_carencia_w||';'||to_date(dt_fim_vigencia_carencia_w,'dd/mm/yy');
			end if;
		end if;
		end;
	end loop;
	close c05;
	ds_retorno_w	:= substr(ds_retorno_w,1,255);
elsif (ie_tipo_p	= 'CAM4') then
	i		:= 0;
	qt_tipo_w	:= 0;
	
	open c05;
	loop
	fetch c05 into
		nr_seq_carencia_benef_w,
		ds_carencia_w,
		dt_fim_vigencia_carencia_w,
		nr_seq_segurado_w,
		nr_seq_tipo_carencia_w,
		nr_apresentacao_w,
		dt_contratacao_segurado_w,
		ie_utilizacao_w,
		qt_dias_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		open c13;
		loop
		fetch c13 into	
			dt_contratacao_benef_w,
			ie_acao_contrato_w,
			dt_fim_vigencia_w;
		EXIT WHEN NOT FOUND; /* apply on c13 */
			begin	
			if	--(dt_fim_vigencia_w < sysdate) and
				(ie_acao_contrato_w = 'M') then
				--(dt_contratacao_benef_w > sysdate) then				
				dt_fim_vigencia_carencia_w := dt_contratacao_benef_w;
				if (nr_seq_segurado_ant_w IS NOT NULL AND nr_seq_segurado_ant_w::text <> '') then
					select	max(dt_contratacao)
					into STRICT	dt_contratacao_benef_w
					from 	pls_segurado
					where 	nr_sequencia = nr_seq_segurado_ant_w;
					
					dt_fim_vigencia_carencia_w	:= dt_contratacao_benef_w + qt_dias_w;
				else
					dt_fim_vigencia_carencia_w	:= dt_contratacao_benef_w;
				end if;
			end if;
			end;
		end loop;
		close c13;	

		if	((dt_fim_vigencia_carencia_w <> 'IMEDIATO') and (clock_timestamp() > to_date(dt_fim_vigencia_carencia_w)) and (clock_timestamp() > to_date(dt_inclusao_operadora_w))) then
			dt_fim_vigencia_carencia_w	:= 'IMEDIATO';
		end if;	
		
		if	/*((nr_seq_tipo_carencia_w is null) or */
(pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S') then
			i	:= i + 1;
			if (qt_tipo_p  = i) then
				ds_retorno_w	:= ds_carencia_w||';'||dt_fim_vigencia_carencia_w;
			end if;
		end if;
		end;
	end loop;
	close c05;
	ds_retorno_w	:= substr(ds_retorno_w,1,255);
elsif (ie_tipo_p	= 'CAM5') then
	i		:= 0;
	qt_tipo_w	:= 0;
	open c15;
	loop
	fetch c15 into
		ds_carencia_w,
		nr_seq_carencia_benef_w,
		dt_fim_vigencia_carencia_w,
		ie_tipo_segurado_w,
		nr_seq_segurado_w,
		nr_seq_tipo_carencia_w,
		nr_seq_grupo_carencia_w,
		nr_apresentacao_w,
		nr_apresentacao_grupo_w;
	EXIT WHEN NOT FOUND; /* apply on c15 */
		begin
		if	((dt_fim_vigencia_carencia_w <> 'IMEDIATO') and (clock_timestamp() > to_date(dt_fim_vigencia_carencia_w)) and (clock_timestamp() > to_date(dt_inclusao_operadora_w))) then
			dt_fim_vigencia_carencia_w	:= 'IMEDIATO';
		end if;
		
		if	((coalesce(nr_seq_tipo_carencia_w::text, '') = '') or (coalesce(nr_seq_grupo_carencia_w::text, '') = '') or (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S')) then
			i	:= i + 1;
			if (qt_tipo_p  = i) then
				ds_retorno_w	:= ds_carencia_w||';'||dt_fim_vigencia_carencia_w;
			end if;
		end if;
		end;
	end loop;
	close c15;
	ds_retorno_w	:= substr(ds_retorno_w,1,255);
elsif (ie_tipo_p	= 'CAM6') then /* Unimed Maringa */
	i		:= 0;
	qt_tipo_w	:= 0;
	
	begin
	select	ie_segmentacao
	into STRICT	ie_segmentacao_w
	from	pls_plano
	where	nr_sequencia = nr_seq_plano_p;
	exception
	when others then
		ie_segmentacao_w := 0;
	end;
	
	for r_c16_w in C16 loop
		if (coalesce(r_c16_w.nr_seq_tipo_carencia,0) = 5019 and ie_segmentacao_w in (2,6,9,11)) or -- OS 946921
			(coalesce(r_c16_w.nr_seq_tipo_carencia,0) <> 5019) then		
		
			if (r_c16_w.dt_carencia = 'IMEDIATO') then
				if (trunc(clock_timestamp(), 'dd') > trunc(dt_inclusao_operadora_w, 'dd')) then
					r_c16_w.dt_carencia	:= 'IMEDIATO';
				elsif (trunc(dt_inclusao_operadora_w, 'dd') > clock_timestamp()) then
					r_c16_w.dt_carencia	:= to_char(dt_inclusao_operadora_w, 'dd/mm/yyyy');
				end if;
			elsif (dt_fim_vigencia_carencia_w <> 'IMEDIATO') and (trunc(clock_timestamp(),'dd') > trunc(to_date(dt_fim_vigencia_carencia_w), 'dd')) and (trunc(clock_timestamp(),'dd') > trunc(to_date(dt_inclusao_operadora_w),'dd')) then
				dt_fim_vigencia_carencia_w	:= 'IMEDIATO';
			end if;
			
			/*Se a carencia = 0 e a geracao do cartao for anterior a data de inclusao do segurado, o sistema deve estampar da data da contratacao (PLS_SEGURADO.DT_CONTRATACAO)... ou seja, se PLS_SEGURADO.DT_CONTRATACAO < SYSDATE e dias de carencia = 0 entao 
			PLS_SEGURADO.DT_CONTRATACAO... se SYSDATE > PLS_SEGURADO.DT_CONTRATACAO e dias de carencia = 0 entao IMEDIATO... ou seja, mesmo que carencia 0 mas a contratacao seja futura, deve-se estampar a data de adesao como menor valor, para que o segurado nao consiga utilizar o cartao no intercambio.*/
			
			if	((coalesce(r_c16_w.nr_seq_tipo_carencia::text, '') = '') or (coalesce(r_c16_w.nr_seq_grupo_carencia::text, '') = '') or (pls_consistir_sexo_carencia(r_c16_w.nr_seq_segurado,r_c16_w.nr_seq_tipo_carencia) = 'S')) then
				i	:= i + 1;
				if (qt_tipo_p  = i) then
					ds_retorno_w	:= r_c16_w.ds_carencia || ';' || r_c16_w.dt_carencia;
				end if;
			end if;
		end if;
	end loop;
	
	if (coalesce(ds_retorno_w::text, '') = '') then
		ds_retorno_w := ';';
	end if;
	
	ds_retorno_w	:= substr(ds_retorno_w,1,255);	
	
elsif (ie_tipo_p	= 'CAM7') then /* Sao Carlos*/
	i		:= 0;
	qt_tipo_w	:= 0;
	ie_apresentar_carencias_w := 'N';
	
	for r_c17_w in C17 loop
		if (r_c17_w.dt_carencia = '  IMEDIATO') then
			if (trunc(clock_timestamp(), 'dd') > trunc(dt_inclusao_operadora_w, 'dd')) then
				r_c17_w.dt_carencia	:= '  IMEDIATO';
			elsif (trunc(dt_inclusao_operadora_w, 'dd') > clock_timestamp()) then
				r_c17_w.dt_carencia	:= to_char(dt_inclusao_operadora_w, 'dd/mm/yyyy');
			end if;
		end if;
		
		if	((coalesce(r_c17_w.nr_seq_tipo_carencia::text, '') = '') or (coalesce(r_c17_w.nr_seq_grupo_carencia::text, '') = '') or (pls_consistir_sexo_carencia(r_c17_w.nr_seq_segurado,r_c17_w.nr_seq_tipo_carencia) = 'S')) then
			i	:= i + 1;
		
			if (qt_tipo_p  = i) then
				ds_retorno_w	:= rpad(substr(r_c17_w.ds_carencia,1,18),18,' ') || ' ' || r_c17_w.dt_carencia;
			end if;
			
			if (r_c17_w.dt_carencia <> '  IMEDIATO') then
				ie_apresentar_carencias_w := 'S';
			end if;
		end if;
	end loop;
	
	if (coalesce(ds_retorno_w::text, '') = '') then
		ds_retorno_w := ' ';
	end if;
	
	if (ie_apresentar_carencias_w = 'N') then
		ds_retorno_w := ' ';
		if (qt_tipo_p = 1) then
			ds_retorno_w := upper(wheb_mensagem_pck.get_texto(11089510));
		end if;
	else
		ds_retorno_w	:= substr(ds_retorno_w,1,255);	
	end if;
elsif (ie_tipo_p = 'CAR') then /* Unimed Sao Jose do Rio Preto */
	i		:= 0;
	qt_tipo_w	:= qt_tipo_p;
	open C08;
	loop
	fetch C08 into
		ds_carencia_w,
		dt_fim_vigencia_carencia_w,
		ie_tipo_segurado_w,
		nr_seq_segurado_w,
		nr_apresentacao_w;
	EXIT WHEN NOT FOUND; /* apply on C08 */
		begin
		i	:= i + 1;

		if	((coalesce(nr_seq_tipo_carencia_w::text, '') = '') or (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S')) then
			if (qt_tipo_w = nr_apresentacao_w) then
				ds_retorno_w	:= ds_carencia_w||';'||dt_fim_vigencia_carencia_w;
			end if;
		end if;
		end;
	end loop;
	close C08;
elsif (ie_tipo_p = 'DC') then
	i		:= 0;
	open c01;
	loop
	fetch c01 into
		nr_seq_cobertura_w,
		ds_cobertura_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		i	:= i + 1;

		if (qt_tipo_p = i) then
			ds_retorno_w	:= ds_cobertura_w;
		end if;
		end;
	end loop;
	close c01;
elsif (ie_tipo_p = 'DR') then
	i		:= 0;
	if	(qt_tipo_p = 1 AND ie_tipo_segurado_w = 'R') then
		select	max(cd_cooperativa)
		into STRICT	cd_cooperativa_w
		from	pls_segurado_repasse	a,
			pls_segurado		b
		where	a.nr_seq_segurado	= b.nr_sequencia
		and	b.nr_sequencia		= nr_seq_segurado_p;

		select	substr(obter_nome_pf_pj(null, cd_cgc),1,254)
		into STRICT	ds_retorno_w
		from	pls_congenere
		where	(cd_cooperativa)::numeric 	= (cd_cooperativa_w)::numeric;
	elsif (ie_tipo_segurado_w <> 'R') then
		open c02;
		loop
		fetch c02 into
			nr_seq_regiao_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			i	:= i + 1;
			if (qt_tipo_p = i) then
				open c11;
				loop
				fetch c11 into
					ds_municipio_w;
				EXIT WHEN NOT FOUND; /* apply on c11 */
					begin
					
					ds_municipio_w	:= INITCAP(ds_municipio_w);
					if (coalesce(ds_regiao_w::text, '') = '') then
						ds_regiao_w	:= ds_municipio_w;
					else
						ds_regiao_w	:= ds_regiao_w||','||ds_municipio_w;
					end if;
					end;
				end loop;
				close c11;

			ds_retorno_w	:= ds_regiao_w;
			end if;
			end;
		end loop;
		close c02;
	end if;
elsif (ie_tipo_p = 'DRL') then
	i		:= 0;
	qt_tipo_w	:= qt_tipo_p;
	if (ie_tipo_segurado_w = 'R') then
		if (qt_tipo_w = 1) then
			select	pls_obter_nome_congenere(max(nr_seq_congenere))
			into STRICT	ds_congenere_w
			from	pls_segurado_repasse
			where	nr_seq_segurado	= nr_seq_segurado_p;

			ds_retorno_w	:= 'REPASSE '||ds_congenere_w;
		else
			qt_tipo_w	:= qt_tipo_w - 1;
		end if;
	else
		open c02;
		loop
		fetch c02 into
			nr_seq_regiao_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			i	:= i + 1;

			if (qt_tipo_p = i) then
				open c03;
				loop
				fetch c03 into
					ds_municipio_w;
				EXIT WHEN NOT FOUND; /* apply on c03 */
					begin
					qt_caracteres_w	:= length(ds_municipio_w);
					if	((coalesce(length(ds_regiao_w),0)+qt_caracteres_w)	< 76) then
						if (coalesce(ds_regiao_w::text, '') = '') then
							ds_regiao_w	:= ds_municipio_w;
						else
							ds_regiao_w	:= ds_regiao_w||','||ds_municipio_w;
						end if;
					end if;

					end;
				end loop;
				close c03;
			ds_retorno_w	:= ds_regiao_w;
			end if;
			if (qt_tipo_p = 2) and (coalesce(ds_retorno_w::text, '') = '') then
				open c06;
				loop
				fetch c06 into
					nr_seq_regiao_ww;
				EXIT WHEN NOT FOUND; /* apply on c06 */
					begin
					open c07;
					loop
					fetch c07 into
						ds_municipio_ww;
					EXIT WHEN NOT FOUND; /* apply on c07 */
						begin
						qt_caracteres_w	:= length(ds_municipio_ww);
							if (coalesce(ds_regiao_w::text, '') = '') then
								ds_regiao_w	:= ds_municipio_ww;
							else
								ds_regiao_w	:= ds_regiao_w||','||ds_municipio_ww;
							end if;
						end;
					end loop;
					close c07;
					end;
				end loop;
				close c06;
			ds_retorno_w	:= ds_regiao_w;
			end if;
			end;
		end loop;
		close c02;
	end if;
/*Seguir o padrao da Unimed Sao Jose dos Campos*/

elsif (ie_tipo_p = 'DRSJC') then
	i		:= 0;
	if	(qt_tipo_p = 1 AND ie_tipo_segurado_w = 'R') then
		select	max(cd_cooperativa)
		into STRICT	cd_cooperativa_w
		from	pls_segurado_repasse	a,
			pls_segurado		b
		where	a.nr_seq_segurado	= b.nr_sequencia
		and	b.nr_sequencia		= nr_seq_segurado_p;

		select	substr(obter_nome_pf_pj(null, cd_cgc),1,254)
		into STRICT	ds_retorno_w
		from	pls_congenere
		where	(cd_cooperativa)::numeric 	= (cd_cooperativa_w)::numeric;
	elsif (ie_tipo_segurado_w <> 'R') then
		open c02;
		loop
		fetch c02 into
			nr_seq_regiao_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			i	:= i + 1;

			if (qt_tipo_p = i) then
				open c11;
				loop
				fetch c11 into
					ds_municipio_w;
				EXIT WHEN NOT FOUND; /* apply on c11 */
					begin
					
					ds_municipio_w	:= INITCAP(ds_municipio_w);
					if (UPPER(ds_municipio_w) = upper('Sao Jose Dos Campos'))then
						ds_municipio_w	:= 'SJCampos';
					end if;
					if (coalesce(ds_regiao_w::text, '') = '') then
						ds_regiao_w	:= ds_municipio_w;
					else
						ds_regiao_w	:= ds_regiao_w||','||ds_municipio_w;
					end if;
					end;
				end loop;
				close c11;

			ds_retorno_w	:= ds_regiao_w;
			end if;
			end;
		end loop;
		close c02;
	end if;
elsif (ie_tipo_p in ('DA','DASJ')) then
	select	max(b.cd_tiss),
		coalesce(max(c.ie_acomodacao), 'I')
	into STRICT	cd_tiss_w,
		ie_acomodacao_w
	from	pls_plano_acomodacao	a,
		pls_tipo_acomodacao	b,
		pls_plano c
	where	a.nr_seq_tipo_acomodacao = b.nr_sequencia
	and	c.nr_sequencia		= a.nr_seq_plano
	and	c.nr_sequencia		= nr_seq_plano_p;

	if (cd_tiss_w IS NOT NULL AND cd_tiss_w::text <> '') then
		if	((cd_tiss_w = '1') or (cd_tiss_w = '4') or (cd_tiss_w = '31') or (cd_tiss_w = '32') or (cd_tiss_w = '33')) then
			ds_retorno_w	:= 'ENFERMARIA';
		elsif	((cd_tiss_w = '7') or (cd_tiss_w = '11') or (cd_tiss_w = '12') or (cd_tiss_w = '13') or (cd_tiss_w = '14') or (cd_tiss_w = '15')) then
			ds_retorno_w	:= 'APARTAMENTO';
		else
			if (ie_acomodacao_w = 'I') then
				ds_retorno_w	:= 'APARTAMENTO';
			elsif (ie_acomodacao_w = 'C') then
				ds_retorno_w	:= 'ENFERMARIA';
			end if;
		end if;
	else
		select	COUNT(*)
		into STRICT	qt_apartamento_w
		from	pls_plano_acomodacao	a,
			pls_categoria		b,
			pls_regra_categoria	c,
			pls_tipo_acomodacao	d
		where	a.nr_seq_categoria	= b.nr_sequencia
		and	c.nr_seq_categoria	= b.nr_sequencia
		and	c.nr_seq_tipo_acomodacao = d.nr_sequencia
		and	a.nr_seq_plano		= nr_seq_plano_p
		and	d.cd_tiss IN (7,11,12,13,14,15);

		select	COUNT(*)
		into STRICT	qt_enfermaria_w
		from	pls_plano_acomodacao	a,
			pls_categoria		b,
			pls_regra_categoria	c,
			pls_tipo_acomodacao	d
		where	a.nr_seq_categoria	= b.nr_sequencia
		and	c.nr_seq_categoria	= b.nr_sequencia
		and	c.nr_seq_tipo_acomodacao = d.nr_sequencia
		and	a.nr_seq_plano		= nr_seq_plano_p
		and	d.cd_tiss IN (1,4,31,32,33);

		/*aso os dois nao tiver informacao, traz vazia*/

		if (qt_apartamento_w > 0) or (qt_enfermaria_w > 0) then
			if (qt_apartamento_w > qt_enfermaria_w) then
				ds_retorno_w	:= 'APARTAMENTO';
			else
				ds_retorno_w	:= 'ENFERMARIA';
			end if;
		end if;
	end if;

	if (ie_tipo_p	= 'DASJ') then
		if (ds_retorno_w	= 'APARTAMENTO') then
			ds_retorno_w	:= 'INDIVIDUAL';
		elsif (ds_retorno_w	= 'ENFERMARIA') then
			ds_retorno_w	:= 'COLETIVA';
		end if;
	end if;
elsif (ie_tipo_p = 'DCPT') then
	select	to_char(coalesce(max(a.dt_inicio_vigencia),max(c.dt_inclusao_operadora)) + max(a.qt_dias),'dd/mm/yyyy')
	into STRICT	ds_retorno_w
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_p
	and	b.ie_cpt	= 'S';
	if (coalesce(ds_retorno_w::text, '') = '') then
		ds_retorno_w	:= upper(wheb_mensagem_pck.get_texto(1108953));
	end if;
elsif (ie_tipo_p = 'CR') then
	select	max(cd_cooperativa)
	into STRICT	ds_retorno_w
	from	pls_segurado_repasse	a,
		pls_segurado		b
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_tipo_p = 'CASBC') then
	open c04;
	loop
	fetch c04 into
		ds_carencia_w,
		nr_seq_carencia_w,
		dt_fim_vigencia_carencia_w,
		ie_tipo_segurado_w,
		nr_seq_segurado_w,
		nr_apresentacao_w,
		nr_seq_tipo_carencia_w,
		nr_seq_grupo_carencia_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin
		if (coalesce(ds_retorno_w::text, '') = '') then
			ds_retorno_w	:= ds_carencia_w||':'||dt_fim_vigencia_carencia_w;
		else
			ds_retorno_w	:= ds_retorno_w||', '||ds_carencia_w||':'||dt_fim_vigencia_carencia_w;
		end if;
		end;
	end loop;
	close c04;

	if (coalesce(ds_retorno_w::text, '') = '') then
		select	count(1)
		into STRICT	qt_carencias_w
		from	pls_carencia		a,
			pls_tipo_carencia	b,
			pls_segurado		c
		where	a.nr_seq_tipo_carencia	= b.nr_sequencia
		and	a.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_sequencia		= nr_seq_segurado_p
		and	b.ie_cpt		= 'S';

		if (qt_carencias_w = 0) then
			ds_retorno_w	:= upper(wheb_mensagem_pck.get_texto(1109036));
		end if;
	end if;
elsif (ie_tipo_p = 'CPTSBC') then
	open c09;
	loop
	fetch c09 into
		ds_carencia_w,
		dt_fim_vigencia_carencia_w;
	EXIT WHEN NOT FOUND; /* apply on c09 */
		begin
		if (coalesce(ds_retorno_w::text, '') = '') then
			ds_retorno_w	:= ds_carencia_w||':'||dt_fim_vigencia_carencia_w;
		else
			ds_retorno_w	:= ds_retorno_w||', '||ds_carencia_w||':'||dt_fim_vigencia_carencia_w;
		end if;
		end;
	end loop;
	close c09;
elsif (ie_tipo_p = 'CSCF') then /* Carencia Santa Casa de Franca */
	i	:= 0;
	open c04;
	loop
	fetch c04 into
		ds_carencia_w,
		nr_seq_carencia_w,
		dt_fim_vigencia_carencia_w,
		ie_tipo_segurado_w,
		nr_seq_segurado_w,
		nr_apresentacao_w,
		nr_seq_tipo_carencia_w,
		nr_seq_grupo_carencia_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin
		if (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S') then
			i	:= i + 1;
			
			if (i = qt_tipo_p) then
				ds_retorno_w	:= substr(upper(ds_carencia_w),1,60);
			end if;
		end if;
		end;
	end loop;
	close c04;
elsif (ie_tipo_p = 'CSCFD') then /* Data Carencia Santa Casa de Franca */
	i	:= 0;
	open c04;
	loop
	fetch c04 into
		ds_carencia_w,
		nr_seq_carencia_w,
		dt_fim_vigencia_carencia_w,
		ie_tipo_segurado_w,
		nr_seq_segurado_w,
		nr_apresentacao_w,
		nr_seq_tipo_carencia_w,
		nr_seq_grupo_carencia_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin
		if (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S') then
			i	:= i + 1;
			
			if (i = qt_tipo_p) then
				ds_retorno_w	:= dt_fim_vigencia_carencia_w;
			end if;
		end if;
		end;
	end loop;
	close c04;
elsif (ie_tipo_p = 'ASCF') then /* Acomodacao Santa Casa de Franca */
	select	max(b.ds_tipo_acomodacao)
	into STRICT	ds_retorno_w
	from	pls_plano_acomodacao	a,
		pls_tipo_acomodacao	b
	where	a.nr_seq_tipo_acomodacao	= b.nr_sequencia
	and	a.nr_seq_plano			= nr_seq_plano_p;
elsif (ie_tipo_p = 'DTNSA') then /* Data Carencia Nossa Senhora Auxiliadora */
	i	:= 0;
	open c04;
	loop
	fetch c04 into
		ds_carencia_w,
		nr_seq_carencia_w,
		dt_fim_vigencia_carencia_w,
		ie_tipo_segurado_w,
		nr_seq_segurado_w,
		nr_apresentacao_w,
		nr_seq_tipo_carencia_w,
		nr_seq_grupo_carencia_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin
		if (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S') then
			i	:= i + 1;
			
			if (i = qt_tipo_p) then
				if (dt_fim_vigencia_carencia_w <> 'ISENTO') then
					if (to_date(dt_fim_vigencia_carencia_w) <= clock_timestamp()) then
						dt_fim_vigencia_carencia_w	:= 'CUMPRIDA';
					end if;
				end if;
				
				ds_retorno_w	:= dt_fim_vigencia_carencia_w;
			end if;
		end if;
		end;
	end loop;
	close c04;
elsif (ie_tipo_p = 'CAUB') then /*UNIMED BLUMENAU*/
	i		:= 0;
	qt_tipo_w	:= 0;
	ds_retorno_w	:= null;
	ie_carencia_abrang_nova_w := 'N';
	qt_mensagens_w	:= 0;
	
	begin
	select  b.nr_seq_plano_ant,
		b.dt_alteracao
	into STRICT	nr_seq_plano_ant_w,
		dt_alteracao_plano_w
	from    pls_segurado a,
		pls_segurado_alt_plano  b
	where   a.nr_sequencia = b.nr_seq_segurado
	and 	a.nr_seq_plano = b.nr_seq_plano_atual
	and  	a.nr_sequencia = nr_seq_segurado_p
	and	b.ie_situacao  = 'A' 
	order by b.dt_alteracao desc LIMIT 1;
	exception
	when others then
		nr_seq_plano_ant_w := null;
	end;
	--Verifica abrangencia  param
	select	max(ie_carencia_abrangencia_ant)
	into STRICT	ie_carencia_abrangencia_ant_w
	from	pls_parametros
	where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
	
	if (coalesce(ie_carencia_abrangencia_ant_w,'N') = 'S') then
		/*Alteracao de plano, sem alteracao de contrato */

		if (nr_seq_plano_ant_w IS NOT NULL AND nr_seq_plano_ant_w::text <> '') then			
			select 	CASE WHEN max(a.ie_abrangencia)='E' THEN 'ES' WHEN max(a.ie_abrangencia)='GE' THEN 'A' WHEN max(a.ie_abrangencia)='GM' THEN 'RB' WHEN max(a.ie_abrangencia)='M' THEN 'MU' WHEN max(a.ie_abrangencia)='N' THEN 'NA' END
			into STRICT	cd_abrangencia_ant_w
			from	pls_plano    a
			where	a.nr_sequencia = nr_seq_plano_ant_w;

		/*Alteracao de contrato */

		elsif (nr_seq_segurado_ant_w IS NOT NULL AND nr_seq_segurado_ant_w::text <> '') then
		
			select 	CASE WHEN max(b.ie_abrangencia)='E' THEN 'ES' WHEN max(b.ie_abrangencia)='GE' THEN 'A' WHEN max(b.ie_abrangencia)='GM' THEN 'RB' WHEN max(b.ie_abrangencia)='M' THEN 'MU' WHEN max(b.ie_abrangencia)='N' THEN 'NA' END
			into STRICT	cd_abrangencia_ant_w
			from	pls_segurado a,
				pls_plano    b
			where	a.nr_seq_plano = b.nr_sequencia	
			and	a.nr_sequencia = nr_seq_segurado_ant_w;
		
		end if;
		
		if ((cd_abrangencia_ant_w IS NOT NULL AND cd_abrangencia_ant_w::text <> '') and cd_abrangencia_ant_w <> cd_abrangencia_w) then
			--Verifica se a abrangencia atual e maior que a anterior
			if (cd_abrangencia_w = 'NA' ) or (cd_abrangencia_w = 'A'  and cd_abrangencia_ant_w <> 'NA') or (cd_abrangencia_w = 'ES' and cd_abrangencia_ant_w <> 'NA' and cd_abrangencia_ant_w <> 'A') or (cd_abrangencia_w = 'RB' and cd_abrangencia_ant_w = 'MU') then
				ie_carencia_abrang_nova_w := 'S';
			end if;
		end if;
	end if;
	
	open c18;
	loop
	fetch c18 into
		ie_tipo_reg_w,
		nr_seq_carencia_benef_w,
		ds_carencia_w,
		dt_fim_vigencia_carencia_w,
		nr_seq_segurado_w,
		nr_seq_tipo_carencia_w,
		nr_apresentacao_w,
		dt_contratacao_segurado_w,
		ie_utilizacao_w,
		qt_dias_w;
	EXIT WHEN NOT FOUND; /* apply on c18 */
		begin
		i	:= i + 1;
		
		if (ie_tipo_reg_w = 'M') then --Somente gerar as carencias se nao houver mensagens
			qt_mensagens_w := qt_mensagens_w + 1;
		end if;

		if (qt_tipo_p  = i) then
			if (ie_tipo_reg_w = 'M') then
				ds_retorno_w	:= ds_carencia_w ||';';
			elsif (qt_mensagens_w = 0) then
				if	((coalesce(nr_seq_tipo_carencia_w::text, '') = '') or (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S')) then
					if ((nr_seq_segurado_ant_w IS NOT NULL AND nr_seq_segurado_ant_w::text <> '') or (nr_seq_plano_ant_w IS NOT NULL AND nr_seq_plano_ant_w::text <> '')) then
						if	(ie_carencia_abrang_nova_w = 'S' AND qt_dias_w > 0) then
							if (nr_seq_plano_ant_w IS NOT NULL AND nr_seq_plano_ant_w::text <> '') then
								dt_fim_vigencia_carencia_w	:= to_date(dt_alteracao_plano_w)+qt_dias_w;
							else
								dt_fim_vigencia_carencia_w	:= to_date(dt_contratacao_segurado_w)+qt_dias_w;								
							end if;
						elsif (ie_carencia_abrang_nova_w = 'N' and (nr_seq_segurado_ant_w IS NOT NULL AND nr_seq_segurado_ant_w::text <> '')) then
							select	count(1)
							into STRICT	qt_carencia_cumprida_w
							from	(SELECT	1
								from	pls_carencia		a,
									pls_tipo_carencia	b,
									pls_segurado		c
								where	a.nr_seq_tipo_carencia	= b.nr_sequencia
								and	a.nr_seq_segurado	= c.nr_sequencia
								and	c.nr_sequencia		= nr_seq_segurado_ant_w
								and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
								and	a.ie_origem_carencia_benef	<> 'S'
								and	b.ie_cpt	= 'N'
								and (a.dt_inicio_vigencia+a.qt_dias) < dt_contratacao_segurado_w
								and	b.nr_sequencia = nr_seq_tipo_carencia_w
								
union all

								SELECT	1
								from	pls_carencia		a,
									pls_tipo_carencia	b,
									pls_segurado		c,
									pls_contrato		d
								where	a.nr_seq_tipo_carencia	= b.nr_sequencia
								and	c.nr_seq_contrato	= d.nr_sequencia
								and	a.nr_seq_contrato	= d.nr_sequencia
								and	c.nr_sequencia		= nr_seq_segurado_ant_w
								and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
								and	b.ie_cpt	= 'N'
								and	a.ie_origem_carencia_benef	<> 'S'
								and	((a.nr_seq_plano_contrato	= c.nr_seq_plano) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
								and (	select	count(*)
										from	pls_carencia		a,
											pls_tipo_carencia	b,
											pls_segurado		c
										where	a.nr_seq_tipo_carencia	= b.nr_sequencia
										and	a.nr_seq_segurado	= c.nr_sequencia
										and	c.nr_sequencia		= nr_seq_segurado_ant_w
										and	b.ie_cpt		='N') = 0
								and (a.dt_inicio_vigencia+a.qt_dias) < dt_contratacao_segurado_w
								and	b.nr_sequencia = nr_seq_tipo_carencia_w
								
union all

								select	1
								from	pls_carencia		a,
									pls_tipo_carencia	b,
									pls_segurado		c,
									pls_plano		d
								where	a.nr_seq_tipo_carencia	= b.nr_sequencia
								and	c.nr_seq_plano		= d.nr_sequencia
								and	a.nr_seq_plano		= d.nr_sequencia
								and	c.nr_sequencia		= nr_seq_segurado_ant_w
								and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
								and	b.ie_cpt	= 'N'
								and	a.ie_origem_carencia_benef	<> 'S'
								and (	select	count(*)
										from	pls_carencia		a,
											pls_tipo_carencia	b,
											pls_segurado		c
										where	a.nr_seq_tipo_carencia	= b.nr_sequencia
										and	a.nr_seq_segurado	= c.nr_sequencia
										and	c.nr_sequencia		= nr_seq_segurado_ant_w
										and	b.ie_cpt		= 'N') = 0
								and	(	select	count(*)
										from	pls_carencia		a,
											pls_tipo_carencia	b,
											pls_segurado		c,
											pls_contrato		d
										where	a.nr_seq_tipo_carencia	= b.nr_sequencia
										and	c.nr_seq_contrato	= d.nr_sequencia
										and	a.nr_seq_contrato	= d.nr_sequencia
										and	c.nr_sequencia		= nr_seq_segurado_ant_w
										and	((a.nr_seq_plano_contrato	= c.nr_seq_plano) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
										and	b.ie_cpt		= 'N') = 0
								and (a.dt_inicio_vigencia+a.qt_dias) < dt_contratacao_segurado_w
								and	b.nr_sequencia = nr_seq_tipo_carencia_w) alias23;
						
							if (qt_carencia_cumprida_w > 0) then
								dt_fim_vigencia_carencia_w	:= dt_contratacao_segurado_w;
							end if;
						end if;
					end if;
					
					if (dt_fim_vigencia_carencia_w IS NOT NULL AND dt_fim_vigencia_carencia_w::text <> '') then
						if (clock_timestamp() > to_date(dt_fim_vigencia_carencia_w) and (ie_tipo_p = 'CAUB')) then
							ds_retorno_w := ds_carencia_w||';'||'IMEDIATO';
						else							
							ds_retorno_w := ds_carencia_w||';'||to_date(dt_fim_vigencia_carencia_w,'dd/mm/yy');
						end if;
					end if;
				end if;
			end if;
		end if;
		end;
	end loop;
	close c18;
	ds_retorno_w	:= substr(ds_retorno_w,1,255);
elsif (ie_tipo_p = 'CAUL') then /*UNIMED LITORAL */
	i		:= 0;
	qt_tipo_w	:= 0;
	ds_retorno_w	:= null;
	ie_carencia_abrang_nova_w := 'N';
	qt_mensagens_w	:= 0;
	
	if (nr_seq_segurado_ant_w IS NOT NULL AND nr_seq_segurado_ant_w::text <> '') then
		--Verifica abrangencia  param
		select	max(ie_carencia_abrangencia_ant)
		into STRICT	ie_carencia_abrangencia_ant_w
		from	pls_parametros
		where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
		
		if (coalesce(ie_carencia_abrangencia_ant_w,'N') = 'S') then
			
			select 	CASE WHEN max(b.ie_abrangencia)='E' THEN 'ES' WHEN max(b.ie_abrangencia)='GE' THEN 'A' WHEN max(b.ie_abrangencia)='GM' THEN 'RB' WHEN max(b.ie_abrangencia)='M' THEN 'MU' WHEN max(b.ie_abrangencia)='N' THEN 'NA' END
			into STRICT	cd_abrangencia_ant_w
			from	pls_segurado a,
				pls_plano    b
			where	a.nr_seq_plano = b.nr_sequencia	
			and	a.nr_sequencia = nr_seq_segurado_ant_w;
			
			if (cd_abrangencia_ant_w <> cd_abrangencia_w) then
				--Verifica se a abrangencia atual e maior que a anterior
				if (cd_abrangencia_w = 'NA' ) or (cd_abrangencia_w = 'A'  and cd_abrangencia_ant_w <> 'NA') or (cd_abrangencia_w = 'ES' and cd_abrangencia_ant_w <> 'NA' and cd_abrangencia_ant_w <> 'A') or (cd_abrangencia_w = 'RB' and cd_abrangencia_ant_w = 'MU') then
					ie_carencia_abrang_nova_w := 'S';
				end if;
			end if;
		end if;
	end if;
	
	open c18;
	loop
	fetch c18 into
		ie_tipo_reg_w,
		nr_seq_carencia_benef_w,
		ds_carencia_w,
		dt_fim_vigencia_carencia_w,
		nr_seq_segurado_w,
		nr_seq_tipo_carencia_w,
		nr_apresentacao_w,
		dt_contratacao_segurado_w,
		ie_utilizacao_w,
		qt_dias_w;
	EXIT WHEN NOT FOUND; /* apply on c18 */
		begin
		i	:= i + 1;
		
		if (ie_tipo_reg_w = 'M') then --Somente gerar as carencias se nao houver mensagens
			qt_mensagens_w := qt_mensagens_w + 1;
		end if;
		
		if (qt_tipo_p  = i) then
			if (ie_tipo_reg_w = 'M') then
				ds_retorno_w	:= ds_carencia_w ||';';
			elsif (qt_mensagens_w = 0) then
				if	((coalesce(nr_seq_tipo_carencia_w::text, '') = '') or (pls_consistir_sexo_carencia(nr_seq_segurado_w,nr_seq_tipo_carencia_w) = 'S')) then
					if (nr_seq_segurado_ant_w IS NOT NULL AND nr_seq_segurado_ant_w::text <> '') then
						if	(ie_carencia_abrang_nova_w = 'S' AND qt_dias_w > 0) then
							dt_fim_vigencia_carencia_w	:= to_date(dt_contratacao_segurado_w)+qt_dias_w;
						elsif (ie_carencia_abrang_nova_w = 'N') then
							select	count(1)
							into STRICT	qt_carencia_cumprida_w
							from	(SELECT	1
								from	pls_carencia		a,
									pls_tipo_carencia	b,
									pls_segurado		c
								where	a.nr_seq_tipo_carencia	= b.nr_sequencia
								and	a.nr_seq_segurado	= c.nr_sequencia
								and	c.nr_sequencia		= nr_seq_segurado_ant_w
								and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
								and	a.ie_origem_carencia_benef	<> 'S'
								and	b.ie_cpt	= 'N'
								and (a.dt_inicio_vigencia+a.qt_dias) < dt_contratacao_segurado_w
								and	b.nr_sequencia = nr_seq_tipo_carencia_w
								
union all

								SELECT	1
								from	pls_carencia		a,
									pls_tipo_carencia	b,
									pls_segurado		c,
									pls_contrato		d
								where	a.nr_seq_tipo_carencia	= b.nr_sequencia
								and	c.nr_seq_contrato	= d.nr_sequencia
								and	a.nr_seq_contrato	= d.nr_sequencia
								and	c.nr_sequencia		= nr_seq_segurado_ant_w
								and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
								and	b.ie_cpt	= 'N'
								and	a.ie_origem_carencia_benef	<> 'S'
								and	((a.nr_seq_plano_contrato	= c.nr_seq_plano) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
								and (	select	count(*)
										from	pls_carencia		a,
											pls_tipo_carencia	b,
											pls_segurado		c
										where	a.nr_seq_tipo_carencia	= b.nr_sequencia
										and	a.nr_seq_segurado	= c.nr_sequencia
										and	c.nr_sequencia		= nr_seq_segurado_ant_w
										and	b.ie_cpt		='N') = 0
								and (a.dt_inicio_vigencia+a.qt_dias) < dt_contratacao_segurado_w
								and	b.nr_sequencia = nr_seq_tipo_carencia_w
								
union all

								select	1
								from	pls_carencia		a,
									pls_tipo_carencia	b,
									pls_segurado		c,
									pls_plano		d
								where	a.nr_seq_tipo_carencia	= b.nr_sequencia
								and	c.nr_seq_plano		= d.nr_sequencia
								and	a.nr_seq_plano		= d.nr_sequencia
								and	c.nr_sequencia		= nr_seq_segurado_ant_w
								and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
								and	b.ie_cpt	= 'N'
								and	a.ie_origem_carencia_benef	<> 'S'
								and (	select	count(*)
										from	pls_carencia		a,
											pls_tipo_carencia	b,
											pls_segurado		c
										where	a.nr_seq_tipo_carencia	= b.nr_sequencia
										and	a.nr_seq_segurado	= c.nr_sequencia
										and	c.nr_sequencia		= nr_seq_segurado_ant_w
										and	b.ie_cpt		= 'N') = 0
								and	(	select	count(*)
										from	pls_carencia		a,
											pls_tipo_carencia	b,
											pls_segurado		c,
											pls_contrato		d
										where	a.nr_seq_tipo_carencia	= b.nr_sequencia
										and	c.nr_seq_contrato	= d.nr_sequencia
										and	a.nr_seq_contrato	= d.nr_sequencia
										and	c.nr_sequencia		= nr_seq_segurado_ant_w
										and	((a.nr_seq_plano_contrato	= c.nr_seq_plano) or (coalesce(a.nr_seq_plano_contrato::text, '') = ''))
										and	b.ie_cpt		= 'N') = 0
								and (a.dt_inicio_vigencia+a.qt_dias) < dt_contratacao_segurado_w
								and	b.nr_sequencia = nr_seq_tipo_carencia_w) alias22;
						
							if (qt_carencia_cumprida_w > 0) then
								dt_fim_vigencia_carencia_w	:= dt_contratacao_segurado_w;
							end if;
						end if;
					end if;
					
					if (dt_fim_vigencia_carencia_w IS NOT NULL AND dt_fim_vigencia_carencia_w::text <> '') then
						if (clock_timestamp() > to_date(dt_fim_vigencia_carencia_w) and (ie_tipo_p = 'CAUB')) then
							ds_retorno_w := ds_carencia_w||';'||'IMEDIATO';
						else
							ds_retorno_w := ds_carencia_w||';'||to_date(dt_fim_vigencia_carencia_w,'dd/mm/yy');
						end if;
					end if;
				end if;
			end if;
		end if;
		end;
	end loop;
	close c18;
	ds_retorno_w	:= substr(ds_retorno_w,1,255);	
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_cart_unimed ( nr_seq_segurado_p bigint, nr_seq_plano_p bigint, ie_tipo_p text, qt_tipo_p bigint) FROM PUBLIC;

