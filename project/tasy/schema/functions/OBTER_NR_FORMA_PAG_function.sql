-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nr_forma_pag ( nr_titulo_p bigint) RETURNS varchar AS $body$
DECLARE

  nr_seq_nota_fiscal_w titulo_pagar.nr_seq_nota_fiscal%type;
  nr_seq_forma_pagto_w nota_fiscal.nr_seq_forma_pagto%type;
  nr_ordem_compra_w    nota_fiscal.nr_ordem_compra%type;
  cd_cgc_w             pessoa_juridica.cd_cgc%type;

BEGIN
  select coalesce(max(nr_seq_nota_fiscal),0),
    coalesce(max(cd_cgc),'X')
  into STRICT nr_seq_nota_fiscal_w,
    cd_cgc_w
  from titulo_pagar
  where nr_titulo = nr_titulo_p;

  if (nr_seq_nota_fiscal_w > 0) then
    /*Se tem nota fiscal, busca primeiro da Nota*/

    select coalesce(max(nr_seq_forma_pagto), 0),
      coalesce(max(nr_ordem_compra),0)
    into STRICT nr_seq_forma_pagto_w,
      nr_ordem_compra_w
    from nota_fiscal
    where nr_sequencia       = nr_seq_nota_fiscal_w;

    if (nr_seq_forma_pagto_w = 0) and (nr_ordem_compra_w > 0) then
      /*Se n√£o tem na Nota e tem Ordem, busca da Ordem de compras*/

      select coalesce(max(a.nr_seq_forma_pagto), 0)
      into STRICT nr_seq_forma_pagto_w
      from nota_fiscal b,
        ordem_compra a
      where a.nr_ordem_compra = b.nr_ordem_compra
      and b.nr_sequencia      = nr_seq_nota_fiscal_w;
    end if;
  end if;

  return nr_seq_forma_pagto_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nr_forma_pag ( nr_titulo_p bigint) FROM PUBLIC;

