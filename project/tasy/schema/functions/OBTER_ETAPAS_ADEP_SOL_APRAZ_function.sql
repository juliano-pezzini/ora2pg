-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_etapas_adep_sol_apraz (ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint) RETURNS bigint AS $body$
DECLARE


nr_etapas_w	smallint;


BEGIN
if (ie_tipo_solucao_p IS NOT NULL AND ie_tipo_solucao_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') then

	if (ie_tipo_solucao_p = 1) then -- soluções
		select	count(*)
		into STRICT	nr_etapas_w
		from	prescr_solucao_evento a
		where	ie_tipo_solucao = ie_tipo_solucao_p
		and	nr_prescricao = nr_prescricao_p
		and	nr_seq_solucao = nr_seq_solucao_p
		and	ie_alteracao in (1,2,16)
		and	((ie_alteracao in (1,16)) or ((ie_alteracao = 2) and (obter_se_motivo_troca_frasco(nr_seq_motivo) = 'S'))) --Ivan e Oraci em 04/01/2008 OS78263
		and	ie_evento_valido = 'S'
		and	((ie_alteracao <> 16) or (exists (SELECT	1
					from	prescr_mat_hor x
					where   x.nr_prescricao = a.nr_prescricao
					and	x.nr_seq_solucao = a.nr_seq_solucao
					and	x.nr_etapa_sol > obter_etapas_adep_sol(1,x.nr_prescricao,x.nr_seq_solucao)
					and	coalesce(x.dt_suspensao::text, '') = ''
					and	x.ie_agrupador = 4
					and	Obter_se_horario_liberado(x.dt_lib_horario, x.dt_horario) = 'S')));

	elsif (ie_tipo_solucao_p = 2) then -- suporte nutricional enteral
		select	count(*)
		into STRICT	nr_etapas_w
		from	prescr_solucao_evento
		where	ie_tipo_solucao = ie_tipo_solucao_p
		and	nr_prescricao = nr_prescricao_p
		and	nr_seq_material = nr_seq_solucao_p
		and	ie_alteracao in (1,2)
		and	((ie_alteracao = 1) or ((ie_alteracao = 2) and (obter_se_motivo_troca_frasco(nr_seq_motivo) = 'S'))) --Ivan e Oraci em 04/01/2008 OS78263
		and	ie_evento_valido = 'S';


	elsif (ie_tipo_solucao_p = 3) then -- hemocomponentes
		select	count(*)
		into STRICT	nr_etapas_w
		from	prescr_solucao_evento
		where	ie_tipo_solucao = ie_tipo_solucao_p
		and	nr_prescricao = nr_prescricao_p
		and	nr_seq_procedimento = nr_seq_solucao_p
		and	ie_alteracao in (1,2)
		and	((ie_alteracao = 1) or ((ie_alteracao = 2) and (obter_se_motivo_troca_frasco(nr_seq_motivo) = 'S'))) --Ivan e Oraci em 04/01/2008 OS78263
		and	ie_evento_valido = 'S';


	elsif (ie_tipo_solucao_p = 4) then -- npt adulta
		select	count(*)
		into STRICT	nr_etapas_w
		from	prescr_solucao_evento
		where	ie_tipo_solucao = ie_tipo_solucao_p
		and	nr_prescricao = nr_prescricao_p
		and	nr_seq_nut = nr_seq_solucao_p
		and	ie_alteracao in (1,2)
		and	((ie_alteracao = 1) or ((ie_alteracao = 2) and (obter_se_motivo_troca_frasco(nr_seq_motivo) = 'S'))) --Ivan e Oraci em 04/01/2008 OS78263
		and	ie_evento_valido = 'S';


	elsif (ie_tipo_solucao_p = 5) then -- npt neonatal
		select	count(*)
		into STRICT	nr_etapas_w
		from	prescr_solucao_evento
		where	ie_tipo_solucao = ie_tipo_solucao_p
		and	nr_prescricao = nr_prescricao_p
		and	nr_seq_nut_neo = nr_seq_solucao_p
		and	ie_alteracao in (1,2)
		and	((ie_alteracao = 1) or ((ie_alteracao = 2) and (obter_se_motivo_troca_frasco(nr_seq_motivo) = 'S'))) --Ivan e Oraci em 04/01/2008 OS78263
		and	ie_evento_valido = 'S';

	elsif (ie_tipo_solucao_p = 6) then -- npt adulta2
		select	count(*)
		into STRICT	nr_etapas_w
		from	prescr_solucao_evento
		where	ie_tipo_solucao = ie_tipo_solucao_p
		and	nr_prescricao = nr_prescricao_p
		and	nr_seq_nut_neo = nr_seq_solucao_p
		and	ie_alteracao in (1,2)
		and	((ie_alteracao = 1) or ((ie_alteracao = 2) and (obter_se_motivo_troca_frasco(nr_seq_motivo) = 'S'))) --Ivan e Oraci em 04/01/2008 OS78263
		and	ie_evento_valido = 'S';
	end if;
end if;

return nr_etapas_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_etapas_adep_sol_apraz (ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint) FROM PUBLIC;

