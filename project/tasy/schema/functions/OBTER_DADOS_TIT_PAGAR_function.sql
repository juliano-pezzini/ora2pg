-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_tit_pagar ( nr_titulo_p bigint, ie_tipo_dado_p text) RETURNS varchar AS $body$
DECLARE


/*
'D' - descontos da baixa titulo_pagar_baixa
'A' - valor do adiantamento vinculado ao título
'J' - juros do título
'M' - multa
'V' - valor do título
'OA'- vl outros acréscimos
'OD'- vl outras deduções
'DV'- vl devolução
'P' - valor pago
'NF'- número da nota fiscal
'TI'- tipo de tributo
'DARF' - código darf do título
'VT' - valor do título com tributos
'VE' - vencimento
'EM' - emissão
'DC' - data contábil
'T'  - valor dos tributos
'TD'  - valor dos tributos com descrição
'VN' - valor da nota
'B'  - descrição do tipo de baixa cpa do título.
'OB' - observação do título
'S' - situação do título
'DL' - data liquidação
'PI' - percentual imposto do título original
'PS' - pessoa física/jurídica,
'AD' - adiantamento gerado pelo títiulo
'PTO' - pessoa do título que originou o título de imposto
'NMPTO' - nome pessoa do título que originou o título de imposto
'VO' - vencimento original
'MO' - moeda
'TO' - título original
'RET' - número do retorno convênio que deu origem ao título
'LA' - lote de auditoria
'CL' - classificação
'OC' - ordem de compra
'BOR' - borderô e descrição
'VBC' - valor base de cálculo caso o título seja de tributo
'BP' - borderô da titulo pagar ou da bordero_tit_pagar
'BPC' - números do borderô da titulo pagar concatenados
'CNPJ' - cnpj da pj do título
'VTA' - valor dos tributos que afetam o saldo do título
'VST' - valor saldo do titulo
'DOC'  - documento /nosso número
'ESTAB' - código do estabelecimento do título
'LE' - lote encontro contas
'TPG' - título pagar gerado
'DTT' - descrição tipo do titulo
'DOT' - descrição origem titulo
'NFN' nota fiscal formatada
'CCP' código da condição de pagamento
'DTES' data entrada/saída da nota fiscal.
'CDO' código operadora
'NFSEQ' sequência da nota fiscal
'ST' Status do titulo
'DTL' Data de liberacao
'NML' Usuário de liberacao
'NDR' - Nota debito reembolso A560
*/
ds_retorno_w		varchar(4000);
vl_descontos_w		double precision;
vl_adiantamento_w		double precision;
vl_juros_baixa_w		double precision;
vl_base_calculo_w		double precision;
vl_juros_tit_w		double precision;
vl_multa_tit_w		double precision;
vl_multa_w		double precision;
vl_titulo_w		double precision;
vl_acrescimos_w		double precision;
vl_deducoes_w		double precision;
vl_devolucao_w		double precision;
vl_pago_w		double precision;
vl_tributo_w		double precision;
nr_nota_fiscal_w 		varchar(255);
nr_seq_tributo_w		bigint;
ie_tipo_tributo_w		varchar(15) := '';
cd_tributo_w		bigint;
cd_estabelecimento_w	bigint;
cd_cgc_w		varchar(20) := '';
cd_pessoa_fisica_w	varchar(20) := '';
cd_darf_w		varchar(100);
ds_tipo_baixa_cpa_w	varchar(255) := '';
nr_bordero_w		varchar(255) := '';
ds_observacao_w		varchar(4000);
ie_trib_atualiza_saldo_w	varchar(20) := '';
dt_vencimento_w		timestamp;
dt_emissao_w		timestamp;
dt_contabil_w		timestamp;
nr_seq_nota_fiscal_w	bigint;
vl_nota_fiscal_w		double precision;
ie_situacao_w		varchar(1);

vl_alterado_w		double precision;
dt_liquidacao_w		timestamp;

nr_titulo_original_w		bigint;
pr_imposto_w		double precision;
dt_vencimento_original_w	timestamp;
cd_moeda_w		integer;
nr_seq_classe_w		bigint;
nr_repasse_terceiro_w	bigint;
nr_seq_lote_res_pls_w	bigint;
qt_trib_repasse_w		bigint;
qt_trib_nf_w		bigint;
qt_trib_lote_pag_pls_w	bigint;
vl_saldo_titulo_w		double precision;
nr_documento_w		varchar(255);
cd_estab_w		bigint;
ds_tributo_w		varchar(255);
ie_tipo_titulo_w		varchar(255);
ie_origem_titulo_w		varchar(255);
nr_sequencia_alt_vl_w		bigint;
nr_nfe_imp_w			nota_fiscal.nr_nfe_imp%type;

qt_tributo_repasse_w			bigint;
qt_tributo_nf_w				bigint;
nr_seq_atrib_nota_fiscal_w		titulo_pagar.nr_seq_nota_fiscal%type;
qt_tributo_lote_pag_pls_w		bigint;
nr_seq_atrib_lote_res_pls_w		titulo_pagar.nr_seq_lote_res_pls%type;
qt_tributo_pls_pag_prest_w		bigint;
nr_seq_pls_pag_prest_w		titulo_pagar.nr_seq_pls_pag_prest%type;
qt_tributo_ordem_w				bigint;
nr_ordem_compra_w			titulo_pagar.nr_ordem_compra%type;
ie_tributo_saldo_tit_nf_w		parametros_contas_pagar.ie_trib_saldo_tit_nf%type;	
nr_repasse_atrib_terceiro_w		titulo_pagar.nr_repasse_terceiro%type;
ie_trib_saldo_tit_nf_w		parametros_contas_pagar.ie_trib_saldo_tit_nf%type;	



c01 CURSOR FOR
SELECT	vl_alteracao
from	titulo_pagar_alt_valor
where	nr_titulo	= nr_titulo_p
order	by nr_sequencia;

c02 CURSOR FOR
SELECT	distinct nr_bordero
from	titulo_pagar_bordero_v
where	nr_titulo	= nr_titulo_p;


BEGIN
select	coalesce(vl_saldo_juros, 0),
	coalesce(vl_saldo_multa, 0),
	vl_titulo,
	a.nr_seq_tributo,
	a.cd_estabelecimento,
	a.cd_cgc,
	a.cd_pessoa_fisica,
	a.dt_vencimento_atual,
	a.dt_emissao,
	a.dt_contabil,
	a.nr_seq_nota_fiscal,
	a.cd_darf,
	a.ds_observacao_titulo,
	a.ie_situacao,
	a.dt_liquidacao,
	a.dt_vencimento_original,
	a.nr_seq_classe,
	a.nr_repasse_terceiro,
	a.nr_seq_lote_res_pls,
	coalesce(a.vl_saldo_titulo,0),
	coalesce(to_char(a.nr_documento),a.nr_nosso_numero),
	a.ie_tipo_titulo,
	a.ie_origem_titulo
into STRICT	vl_juros_tit_w,
	vl_multa_tit_w,
	vl_titulo_w,
	nr_seq_tributo_w,
	cd_estabelecimento_w,
	cd_cgc_w,
	cd_pessoa_fisica_w,
	dt_vencimento_w,
	dt_emissao_w,
	dt_contabil_w,
	nr_seq_nota_fiscal_w,
	cd_darf_w,
	ds_observacao_w,
	ie_situacao_w,
	dt_liquidacao_w,
	dt_vencimento_original_w,
	nr_seq_classe_w,
	nr_repasse_terceiro_w,
	nr_seq_lote_res_pls_w,
	vl_saldo_titulo_w,
	nr_documento_w,
	ie_tipo_titulo_w,
	ie_origem_titulo_w
from	titulo_pagar a
where	nr_titulo = nr_titulo_p;

if (ie_tipo_dado_p = 'D') then
	begin
	select	coalesce(sum(vl_descontos), 0)
	into STRICT	vl_descontos_w
	from	titulo_pagar_baixa a
	where	nr_titulo = nr_titulo_p;

	ds_retorno_w := vl_descontos_w;
	end;
elsif (ie_tipo_dado_p = 'A') then

	select	coalesce(sum(vl_adiantamento), 0)
	into STRICT	vl_adiantamento_w
	from	titulo_pagar_adiant
	where	nr_titulo	= nr_titulo_p;

	ds_retorno_w := vl_adiantamento_w;
elsif (ie_tipo_dado_p = 'PS') then
	ds_retorno_w := substr(obter_nome_pf_pj(cd_pessoa_fisica_w,cd_cgc_w),1,254);
elsif (ie_tipo_dado_p = 'J') then
	begin
	select	coalesce(sum(vl_juros), 0)
	into STRICT	vl_juros_baixa_w
	from	titulo_pagar_baixa a
	where	nr_titulo = nr_titulo_p;

	ds_retorno_w := (vl_juros_baixa_w + vl_juros_tit_w);
	end;
elsif (ie_tipo_dado_p = 'M') then
	begin
	select	coalesce(sum(vl_multa),0)
	into STRICT	vl_multa_w
	from	titulo_pagar_baixa a
	where	nr_titulo = nr_titulo_p;

	ds_retorno_w := (vl_multa_w + vl_multa_tit_w);
	end;
elsif (ie_tipo_dado_p = 'OA') then
	begin
	select	coalesce(sum(vl_outros_acrescimos),0)
	into STRICT	vl_acrescimos_w
	from	titulo_pagar_baixa a
	where	nr_titulo = nr_titulo_p;

	ds_retorno_w := vl_acrescimos_w;
	end;
elsif (ie_tipo_dado_p = 'OD') then
	begin
	select	coalesce(sum(vl_outras_deducoes),0)
	into STRICT	vl_deducoes_w
	from	titulo_pagar_baixa a
	where	nr_titulo = nr_titulo_p;

	ds_retorno_w := vl_deducoes_w;
	end;
elsif (ie_tipo_dado_p = 'DV') then
	begin
	select	coalesce(sum(vl_devolucao),0)
	into STRICT	vl_devolucao_w
	from	titulo_pagar_baixa a
	where	nr_titulo = nr_titulo_p;

	ds_retorno_w := vl_devolucao_w;
	end;
elsif (ie_tipo_dado_p = 'P') then
	begin
	select	coalesce(sum(vl_pago),0)
	into STRICT	vl_pago_w
	from	titulo_pagar_baixa a
	where	nr_titulo = nr_titulo_p;

	ds_retorno_w := vl_pago_w;
	end;
elsif (ie_tipo_dado_p = 'NF') then
	begin
	select	max(nr_nota_fiscal)
	into STRICT	nr_nota_fiscal_w
	from	nota_fiscal
	where	nr_sequencia = nr_seq_nota_fiscal_w;

	ds_retorno_w := nr_nota_fiscal_w;
	end;
elsif (ie_tipo_dado_p = 'NFE') then
	begin
	select	max(nr_nfe_imp)
	into STRICT	nr_nfe_imp_w
	from	nota_fiscal
	where	nr_sequencia = nr_seq_nota_fiscal_w;

	ds_retorno_w := nr_nfe_imp_w;
	end;
elsif (ie_tipo_dado_p = 'NFSEQ') then
	begin
	ds_retorno_w := nr_seq_nota_fiscal_w;
	end;	
elsif (ie_tipo_dado_p = 'NFN') then
	begin
	select	max(nr_nota_fiscal)
	into STRICT	nr_nota_fiscal_w
	from	nota_fiscal
	where	nr_sequencia = nr_seq_nota_fiscal_w;

	if (coalesce(nr_nota_fiscal_w, '0') = '0') then
		ds_retorno_w := null;
	else
		ds_retorno_w := somente_numero(nr_nota_fiscal_w);
	end if;
	end;
elsif (ie_tipo_dado_p = 'OB') then
	ds_retorno_w := ds_observacao_w;
elsif (ie_tipo_dado_p = 'V') then

	/*select	nvl(sum(vl_anterior - vl_alteracao),0)
	into	vl_alterado_w
	from	titulo_pagar_alt_valor
	where	nr_titulo	= nr_titulo_p;*/
	select	max(nr_sequencia) -- AAMFIRMO OS 687111
	into STRICT	nr_sequencia_alt_vl_w
	from	titulo_pagar_alt_valor
	where	nr_titulo	= nr_titulo_p;

	if (nr_sequencia_alt_vl_w IS NOT NULL AND nr_sequencia_alt_vl_w::text <> '') then

		select	max(vl_alteracao)
		into STRICT	vl_alterado_w
		from	titulo_pagar_alt_valor
		where	nr_titulo	= nr_titulo_p
		and     nr_sequencia    = nr_sequencia_alt_vl_w;

		vl_titulo_w := coalesce(vl_alterado_w,0);
	end if;

	ds_retorno_w	:= vl_titulo_w;

elsif (ie_tipo_dado_p = 'VT') then

	select	coalesce(sum(vl_anterior - vl_alteracao),0)
	into STRICT	vl_alterado_w
	from	titulo_pagar_alt_valor
	where	nr_titulo	= nr_titulo_p;

	vl_titulo_w	:= vl_titulo_w - vl_alterado_w;

	select	b.ie_trib_atualiza_saldo,
			coalesce(b.ie_trib_saldo_tit_nf,'N')
	into STRICT	ie_trib_atualiza_saldo_w,
			ie_trib_saldo_tit_nf_w
	from	parametros_contas_pagar b
	where	b.cd_estabelecimento	= cd_estabelecimento_w;

	if (ie_trib_atualiza_saldo_w	= 'S') then
	
/*OS 1855324 - Fiz aqui igual na ATUALIZAR_TIT_PAGAR_CLASSIF*/

	select	max(a.nr_repasse_terceiro),
		max(a.nr_seq_nota_fiscal),
		max(a.nr_seq_lote_res_pls),
		max(a.nr_seq_pls_pag_prest),
		max(a.nr_ordem_compra)
	into STRICT	nr_repasse_atrib_terceiro_w,
		nr_seq_atrib_nota_fiscal_w,
		nr_seq_atrib_lote_res_pls_w,
		nr_seq_pls_pag_prest_w,
		nr_ordem_compra_w
	from	titulo_pagar a
	where	a.nr_titulo = nr_titulo_p;

	select	count(*)
	into STRICT	qt_tributo_repasse_w
	from	repasse_terceiro_venc b,
			repasse_terc_venc_trib a
	where	a.nr_seq_rep_venc		= b.nr_sequencia
	and		b.nr_repasse_terceiro	= nr_repasse_atrib_terceiro_w;

	select	count(*)
	into STRICT	qt_tributo_nf_w
	from	nota_fiscal_trib a
	where	a.nr_sequencia	= nr_seq_atrib_nota_fiscal_w;
	
	if (qt_tributo_nf_w = 0) then
		select	count(*)
		into STRICT	qt_tributo_nf_w
		from	nota_fiscal_item_trib a
		where	nr_sequencia	= nr_seq_atrib_nota_fiscal_w;
	end if;
	
	if (qt_tributo_nf_w = 0) then
		select	count(*)
		into STRICT	qt_tributo_nf_w
		from	nota_fiscal_venc_trib b,
				nota_fiscal_venc a
		where	a.nr_sequencia	= nr_seq_atrib_nota_fiscal_w
		and		a.nr_sequencia	= b.nr_sequencia;
	end if;
	
	select	count(*)
	into STRICT	qt_tributo_lote_pag_pls_w
	from	pls_lote_protocolo_venc b,
			pls_lote_prot_venc_trib a
	where	a.nr_seq_lote_venc	= b.nr_sequencia
	and		b.nr_seq_lote		= nr_seq_atrib_lote_res_pls_w
	and	exists (SELECT	1
			from	titulo_pagar_imposto x
			where	x.nr_titulo	= b.nr_titulo
			and	x.dt_atualizacao_nrec > a.dt_atualizacao_nrec);
			
	select	count(*)
	into STRICT	qt_tributo_pls_pag_prest_w		
	from	pls_pag_prest_venc_trib	c,
			pls_pag_prest_vencimento	b,
			pls_pagamento_prestador	a
	where	a.nr_sequencia	= b.nr_seq_pag_prestador
	and		b.nr_sequencia	= c.nr_seq_vencimento
	and		a.nr_sequencia	= nr_seq_pls_pag_prest_w;	

	select	count(*)
	into STRICT	qt_tributo_ordem_w
	from	ordem_compra_item_trib a
	where	nr_ordem_compra = nr_ordem_compra_w;	

	if (coalesce(nr_repasse_atrib_terceiro_w,0) = 0 or qt_tributo_repasse_w = 0) and (coalesce(nr_seq_atrib_nota_fiscal_w,0) = 0 or qt_tributo_nf_w = 0) and (coalesce(nr_seq_atrib_lote_res_pls_w,0) = 0 or qt_tributo_lote_pag_pls_w = 0) and (coalesce(nr_seq_pls_pag_prest_w,0) = 0 or qt_tributo_pls_pag_prest_w = 0) and (coalesce(nr_ordem_compra_w,0) = 0 or (qt_tributo_ordem_w = 0))	then
		
	
		select	coalesce(sum(a.vl_imposto),0)
		into STRICT	vl_tributo_w
		from	tributo b,
				titulo_pagar_imposto a
		where	a.nr_titulo						= nr_titulo_p
		and		a.cd_tributo					= b.cd_tributo
		and		a.ie_pago_prev					= 'V'
		and		coalesce(b.ie_saldo_tit_pagar,'S')	= 'S';		
		
	else
	
		if (ie_trib_saldo_tit_nf_w = 'N') then
			select	coalesce(sum(vl_imposto),0)
			into STRICT	vl_tributo_w
			from	titulo_pagar_imposto a,
					tributo b
			where	a.cd_tributo = b.cd_tributo
			and		nr_titulo	= nr_titulo_p
			and		ie_pago_prev	= 'V'
			and		(nr_seq_baixa IS NOT NULL AND nr_seq_baixa::text <> '')
			and		coalesce(b.ie_saldo_tit_pagar,'S')	= 'S';
		else
			select	coalesce(sum(vl_imposto),0)
			into STRICT	vl_tributo_w
			from	titulo_pagar_imposto a,
					tributo b
			where	a.cd_tributo 	= b.cd_tributo
			and		nr_titulo		= nr_titulo_p
			and		ie_pago_prev	= 'V'
			and		coalesce(b.ie_saldo_tit_pagar,'S')	= 'S';
		end if;		
	end if;	
	
		vl_titulo_w	:= vl_titulo_w - coalesce(vl_tributo_w,0);

	end if;

	ds_retorno_w		:= vl_titulo_w;
elsif (ie_tipo_dado_p = 'TI') then

	select	max(b.ie_tipo_tributo)
	into STRICT	ie_tipo_tributo_w
	from	titulo_pagar c,
		tributo b,
		titulo_pagar_imposto a
	where	a.nr_titulo	= c.nr_titulo
	and	a.cd_tributo	= b.cd_tributo
	and	a.nr_sequencia	= nr_seq_tributo_w;

	ds_retorno_w	:= ie_tipo_tributo_w;

elsif (ie_tipo_dado_p = 'DARF') then

	if (coalesce(cd_darf_w::text, '') = '') then

		select	max(a.cd_tributo),
			coalesce(max(a.cd_darf),substr(obter_codigo_darf(max(a.cd_tributo), max(c.cd_estabelecimento), max(c.cd_cgc), max(c.cd_pessoa_fisica)),1,10))
		into STRICT	cd_tributo_w,
			cd_darf_w
		from	titulo_pagar c,
			tributo b,
			titulo_pagar_imposto a
		where	a.nr_titulo	= c.nr_titulo
		and	a.cd_tributo	= b.cd_tributo
		and	a.nr_sequencia	= nr_seq_tributo_w;

	end if;

	if (coalesce(cd_tributo_w::text, '') = '') and (coalesce(cd_darf_w::text, '') = '') then
		select	cd_tributo
		into STRICT	cd_tributo_w
		from	titulo_pagar
		where	nr_titulo = nr_titulo_p;
	end if;

	ds_retorno_w	:= coalesce(cd_darf_w, obter_codigo_darf(cd_tributo_w, cd_estabelecimento_w, cd_cgc_w, cd_pessoa_fisica_w));

elsif (ie_tipo_dado_p = 'VE') then
	ds_retorno_w := to_char(dt_vencimento_w,'dd/mm/yyyy');
elsif (ie_tipo_dado_p = 'EM') then
	ds_retorno_w := to_char(dt_emissao_w,'dd/mm/yyyy');
elsif (ie_tipo_dado_p = 'DC') then
	ds_retorno_w := to_char(dt_contabil_w,'dd/mm/yyyy');
elsif (ie_tipo_dado_p = 'B') then

	select	max(a.ds_tipo_baixa)
	into STRICT	ds_tipo_baixa_cpa_w
	from	tipo_baixa_cpa a,
		titulo_pagar b
	where	a.cd_tipo_baixa	= b.cd_tipo_baixa_neg
	and	b.nr_titulo	= nr_titulo_p;

	ds_retorno_w := ds_tipo_baixa_cpa_w;

elsif (ie_tipo_dado_p = 'T') then

	select	coalesce(sum(b.vl_imposto), 0)
	into STRICT	vl_tributo_w
	from	titulo_pagar_imposto b,
		titulo_pagar a
	where	b.nr_titulo			= nr_titulo_p
	and	a.nr_titulo			= b.nr_titulo
	and	b.ie_pago_prev			= 'V';

	ds_retorno_w		:= vl_tributo_w;
elsif (ie_tipo_dado_p = 'TD') then

	select	coalesce(sum(b.vl_imposto), 0)
	into STRICT	vl_tributo_w
	from	titulo_pagar_imposto b,
		titulo_pagar a
	where	b.nr_titulo	= nr_titulo_p
	and	a.nr_titulo	= b.nr_titulo
	and	b.ie_pago_prev	= 'V';

	select	max(ds_tributo)
	into STRICT	ds_tributo_w
	from	titulo_pagar_imposto b,
		tributo a
	where	a.cd_tributo	= b.cd_tributo
	and	b.nr_titulo	= nr_titulo_p;

	ds_retorno_w		:= to_char(vl_tributo_w)|| ' '||ds_tributo_w;
elsif (ie_tipo_dado_p = 'VN') then
	if (nr_seq_nota_fiscal_w IS NOT NULL AND nr_seq_nota_fiscal_w::text <> '') then
		select	vl_mercadoria
		into STRICT	vl_nota_fiscal_w
		from	nota_fiscal
		where	nr_sequencia	= nr_seq_nota_fiscal_w;
	end if;

	ds_retorno_w	:= vl_nota_fiscal_w;
elsif (ie_tipo_dado_p = 'S') then
	ds_retorno_w := ie_situacao_w;
elsif (ie_tipo_dado_p = 'DL') then
	ds_retorno_w := to_char(dt_liquidacao_w,'dd/mm/yyyy');
elsif (ie_tipo_dado_p	= 'PI') then

	select	nr_seq_tributo
	into STRICT	nr_seq_tributo_w
	from	titulo_pagar
	where	nr_titulo		= nr_titulo_p;

	if (nr_seq_tributo_w IS NOT NULL AND nr_seq_tributo_w::text <> '') then

		select	vl_imposto,
			nr_titulo,
			pr_imposto
		into STRICT	vl_tributo_w,
			nr_titulo_original_w,
			pr_imposto_w
		from	titulo_pagar_imposto a
		where	nr_sequencia		= nr_seq_tributo_w;

		if (nr_titulo_original_w IS NOT NULL AND nr_titulo_original_w::text <> '') then
			ds_retorno_w	:= pr_imposto_w;
		end if;

	end if;
elsif (ie_tipo_dado_p	= 'AD') then
	select	max(nr_adiantamento)
	into STRICT	ds_retorno_w
	from	adiantamento_pago
	where	nr_titulo_original	= nr_titulo_p;
elsif (ie_tipo_dado_p	= 'PTO') then
	select	nr_seq_tributo
	into STRICT	nr_seq_tributo_w
	from	titulo_pagar
	where	nr_titulo		= nr_titulo_p;
	if (nr_seq_tributo_w IS NOT NULL AND nr_seq_tributo_w::text <> '') then
		select	coalesce(b.cd_pessoa_fisica, b.cd_cgc)
		into STRICT	ds_retorno_w
		from	titulo_pagar b,
			titulo_pagar_imposto a
		where	a.nr_sequencia		= nr_seq_tributo_w
		and	a.nr_titulo		= b.nr_titulo;
	end if;
elsif (ie_tipo_dado_p	= 'NMPTO') then
	select	nr_seq_tributo
	into STRICT	nr_seq_tributo_w
	from	titulo_pagar
	where	nr_titulo		= nr_titulo_p;
	if (nr_seq_tributo_w IS NOT NULL AND nr_seq_tributo_w::text <> '') then
		select	substr(obter_nome_pf_pj(b.cd_pessoa_fisica, b.cd_cgc),1,255)
		into STRICT	ds_retorno_w
		from	titulo_pagar b,
			titulo_pagar_imposto a
		where	a.nr_sequencia		= nr_seq_tributo_w
		and	a.nr_titulo		= b.nr_titulo;
	end if;
elsif (ie_tipo_dado_p = 'VO') then
	ds_retorno_w	:= to_char(dt_vencimento_original_w,'dd/mm/yyyy');
elsif (ie_tipo_dado_p = 'MO') then

	select	a.cd_moeda
	into STRICT	cd_moeda_w
	from	titulo_pagar a
	where	a.nr_titulo			= nr_titulo_p;

	ds_retorno_w		:= cd_moeda_w;
elsif (ie_tipo_dado_p = 'TO') then

	select	nr_titulo_original
	into STRICT	nr_titulo_original_w
	from	titulo_pagar a
	where	a.nr_titulo			= nr_titulo_p;

	ds_retorno_w		:= nr_titulo_original_w;
elsif (ie_tipo_dado_p = 'RET') then

	select	max(b.nr_seq_retorno)
	into STRICT	ds_retorno_w
	from	lote_auditoria b,
		lote_audit_hist a,
		titulo_pagar c
	where	c.nr_titulo		= nr_titulo_p
	and	a.nr_sequencia		= c.nr_seq_lote_audit_hist
	and	a.nr_seq_lote_audit	= b.nr_sequencia;

elsif (ie_tipo_dado_p = 'LA') then

	select	max(b.nr_seq_lote_audit)
	into STRICT	ds_retorno_w
	from	lote_audit_hist b,
		titulo_pagar a
	where	a.nr_titulo			= nr_titulo_p
	and	a.nr_seq_lote_audit_hist	= b.nr_sequencia;

elsif (ie_tipo_dado_p = 'CL') then

	select	max(a.ds_classe)
	into STRICT	ds_retorno_w
	from	classe_titulo_pagar a
	where	a.nr_sequencia	= nr_seq_classe_w;

elsif (ie_tipo_dado_p = 'OC') then

	select	max(a.nr_ordem_compra)
	into STRICT	ds_retorno_w
	from	ordem_compra_venc a
	where	a.nr_titulo_pagar	= nr_titulo_p;

	if (coalesce(ds_retorno_w::text, '') = '') then
		select	max(b.nr_ordem_compra)
		into STRICT	ds_retorno_w
		from	nota_fiscal b,
			titulo_pagar a
		where	a.nr_seq_nota_fiscal = b.nr_sequencia
		and	a.nr_titulo		= nr_titulo_p;
	end if;

elsif (ie_tipo_dado_p = 'BOR') then

	select	max(b.nr_bordero || ' - ' || b.ds_bordero)
	into STRICT	ds_retorno_w
	from	bordero_pagamento b,
		titulo_pagar_bordero_v a
	where	a.nr_titulo	= nr_titulo_p
	and	a.nr_bordero	= b.nr_bordero;
elsif (ie_tipo_dado_p = 'VBC') then

	select	coalesce(max(a.vl_base_calculo),0)
	into STRICT	vl_base_calculo_w
	from	titulo_pagar c,
		tributo b,
		titulo_pagar_imposto a
	where	a.nr_titulo	= c.nr_titulo
	and	a.cd_tributo	= b.cd_tributo
	and	a.nr_sequencia	= nr_seq_tributo_w;

	ds_retorno_w	:= vl_base_calculo_w;

elsif (ie_tipo_dado_p = 'BP') then

	select	max(nr_bordero)
	into STRICT	ds_retorno_w
	from	titulo_pagar
	where	nr_titulo = nr_titulo_p;

	if (coalesce(ds_retorno_w::text, '') = '') then

		select	max(b.nr_bordero)
		into STRICT	ds_retorno_w
		from	bordero_pagamento b,
			titulo_pagar_bordero_v a
		where	a.nr_titulo	= nr_titulo_p
		and	a.nr_bordero	= b.nr_bordero;

	end if;
elsif (ie_tipo_dado_p = 'BPC') then
	open c02;
	loop
	fetch c02 into
		nr_bordero_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	if (coalesce(ds_retorno_w::text, '') = '') then
		ds_retorno_w    := nr_bordero_w;
	else
		ds_retorno_w    := ds_retorno_w || ',' || nr_bordero_w;
	end if;
	end loop;
	close c02;
elsif (ie_tipo_dado_p = 'CNPJ') then
	ds_retorno_w	:= cd_cgc_w;
elsif (ie_tipo_dado_p = 'VTA') then

	select	b.ie_trib_atualiza_saldo
	into STRICT	ie_trib_atualiza_saldo_w
	from	parametros_contas_pagar b
	where	b.cd_estabelecimento	= cd_estabelecimento_w;

	if (ie_trib_atualiza_saldo_w	= 'S') then

		select	count(*)
		into STRICT	qt_trib_repasse_w
		from	repasse_terceiro_venc b,
			repasse_terc_venc_trib a
		where	a.nr_seq_rep_venc	= b.nr_sequencia
		and	b.nr_repasse_terceiro	= nr_repasse_terceiro_w;

		select	count(*)
		into STRICT	qt_trib_nf_w
		from	nota_fiscal_trib a
		where	a.nr_sequencia	= nr_seq_nota_fiscal_w;

		if (qt_trib_nf_w = 0) then
			select	count(*)
			into STRICT	qt_trib_nf_w
			from	nota_fiscal_item_trib a
			where	nr_sequencia_nf	= nr_seq_nota_fiscal_w;
		end if;

		if (qt_trib_nf_w = 0) then
			select	count(*)
			into STRICT	qt_trib_nf_w
			from	nota_fiscal_venc_trib b,
				nota_fiscal_venc a
			where	a.nr_sequencia	= nr_seq_nota_fiscal_w
			and	a.nr_sequencia	= b.nr_sequencia;
		end if;

		select	count(*)
		into STRICT	qt_trib_lote_pag_pls_w
		from	pls_lote_protocolo_venc b,
			pls_lote_prot_venc_trib a
		where	a.nr_seq_lote_venc	= b.nr_sequencia
		and	b.nr_seq_lote		= nr_seq_lote_res_pls_w
		and	exists (SELECT	1
				from	titulo_pagar_imposto x
				where	x.nr_titulo	= b.nr_titulo
				and	x.dt_atualizacao_nrec > a.dt_atualizacao_nrec);

		if (coalesce(nr_repasse_terceiro_w,0) = 0 or qt_trib_repasse_w = 0) and (coalesce(nr_seq_nota_fiscal_w,0) = 0 or qt_trib_nf_w = 0) and (coalesce(nr_seq_lote_res_pls_w,0) = 0 or qt_trib_lote_pag_pls_w = 0) then

			select	coalesce(sum(a.vl_imposto),0)
			into STRICT	vl_tributo_w
			from	tributo b,
				titulo_pagar_imposto a
			where	a.nr_titulo		= nr_titulo_p
			and	a.cd_tributo		= b.cd_tributo
			and	a.ie_pago_prev		= 'V'
			and	coalesce(b.ie_saldo_tit_pagar,'S')	= 'S';
		else

			select	coalesce(sum(vl_imposto),0)
			into STRICT	vl_tributo_w
			from	titulo_pagar_imposto
			where	nr_titulo	= nr_titulo_p
			and	ie_pago_prev	= 'V'
			and	(nr_seq_baixa IS NOT NULL AND nr_seq_baixa::text <> '');

		end if;

		ds_retorno_w	:= coalesce(vl_tributo_w,0);

	else
		ds_retorno_w	:= 0;
	end if;
elsif (ie_tipo_dado_p = 'VST') then
	ds_retorno_w := vl_saldo_titulo_w;
elsif (ie_tipo_dado_p = 'DOC') then
	ds_retorno_w := nr_documento_w;
elsif (ie_tipo_dado_p = 'ESTAB') then
	select	max(a.cd_estabelecimento)
	into STRICT	cd_estab_w
	from	titulo_pagar a
	where	a.nr_titulo	= nr_titulo_p;

	ds_retorno_w := cd_estab_w;
elsif (ie_tipo_dado_p = 'LE') then
	select	max(c.nr_sequencia)
	into STRICT	ds_retorno_w
	from	lote_encontro_contas	c,
		pessoa_encontro_contas	b,
		encontro_contas_item	a
	where	c.nr_sequencia		= b.nr_seq_lote
	and	b.nr_sequencia		= a.nr_seq_pessoa
	and	a.nr_titulo_pagar	=  nr_titulo_p;
elsif (ie_tipo_dado_p = 'TG') then
	select	max(coalesce(b.nr_titulo_pagar,b.nr_titulo_receber))
	into STRICT	ds_retorno_w
	from	pessoa_encontro_contas	b,
		encontro_contas_item	a
	where	b.nr_sequencia		= a.nr_seq_pessoa
	and	a.nr_titulo_pagar	=  nr_titulo_p;
elsif (ie_tipo_dado_p	= 'DTT') then
	ds_retorno_w := substr(obter_valor_dominio(502, ie_tipo_titulo_w),1,255);
elsif (ie_tipo_dado_p	= 'DOT') then
	ds_retorno_w := substr(obter_valor_dominio(500, ie_origem_titulo_w),1,255);
elsif (ie_tipo_dado_p	= 'PF') then
	ds_retorno_w := cd_pessoa_fisica_w;
elsif (ie_tipo_dado_p	= 'PJ') then
	ds_retorno_w := cd_pessoa_fisica_w;
elsif (ie_tipo_dado_p = 'CCP') then
	select 	b.cd_condicao_pagamento
	into STRICT	ds_retorno_w
	from	titulo_pagar a,
		nota_fiscal b
	where 	a.nr_seq_nota_fiscal = b.nr_sequencia
	and	a.nr_titulo = nr_titulo_p;
elsif (ie_tipo_dado_p = 'DTES') then
	select 	b.dt_entrada_saida
	into STRICT	ds_retorno_w
	from	titulo_pagar a,
		nota_fiscal b
	where 	a.nr_seq_nota_fiscal = b.nr_sequencia
	and	a.nr_titulo = nr_titulo_p;
elsif (ie_tipo_dado_p = 'CDO') then
	select	max(a.cd_cooperativa)
	into STRICT	ds_retorno_w
	from	pls_congenere	a,
		titulo_pagar	b
	where	a.cd_cgc	= b.cd_cgc
	and	b.nr_titulo	= nr_titulo_p;
elsif (ie_tipo_dado_p = 'ST') then
	select	ie_status
	into STRICT	ds_retorno_w
	from	titulo_pagar	b
	where	b.nr_titulo	= nr_titulo_p  LIMIT 1;
elsif (ie_tipo_dado_p = 'DTL') then
	select	to_char(dt_liberacao, 'dd/mm/yyyy')
	into STRICT	ds_retorno_w
	from	titulo_pagar	b
	where	b.nr_titulo	= nr_titulo_p  LIMIT 1;
elsif (ie_tipo_dado_p = 'NML') then
	select	nm_usuario_lib
	into STRICT	ds_retorno_w
	from	titulo_pagar	b
	where	b.nr_titulo	= nr_titulo_p  LIMIT 1;	
	
elsif (ie_tipo_dado_p = 'NDR') then
	select	max(a.nr_nota_debito)
	into STRICT	ds_retorno_w
	from	titulo_pagar		b,
		ptu_nota_deb_conclusao	a
	where	a.nr_sequencia	= b.nr_seq_nota_deb_conclusao
	and	b.nr_titulo	= nr_titulo_p;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_tit_pagar ( nr_titulo_p bigint, ie_tipo_dado_p text) FROM PUBLIC;

