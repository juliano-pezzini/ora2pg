-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_preco_amb (cd_procedimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_estabelecimento_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/*
ie_opcao_p:

'P' - vl_procedimento
'CO' - vl_custo_operacional
'M' - vl_medico
'A' - vl_anestesista
'F' - vl_filme
'MC' - vl_medico + vl_custo_operacional

*/
CD_EDICAO_AMB_w			integer;
VL_CUSTO_OPERACIONAL_W		double precision;
VL_MEDICO_W			double precision;
VL_FILME_W			double precision;
NR_PORTE_ANESTESICO_W		smallint;
NR_AUXILIARES_W			smallint;
VL_AUXILIARES_INFORM_W		double precision;
VL_PTO_CUSTO_OPERAC_W		double precision;
VL_PTO_MEDICO_W			double precision;
vl_procedimento_W		double precision;
CD_MOEDA_W			smallint;
VL_ANEST_INFORM_W		double precision;


BEGIN

SELECT	max(coalesce(CD_EDICAO_AMB, 0))
INTO STRICT	CD_EDICAO_AMB_W
FROM	CONVENIO_AMB
WHERE	CD_ESTABELECIMENTO	= CD_ESTABELECIMENTO_P
AND	CD_CONVENIO		= CD_CONVENIO_P
AND	CD_CATEGORIA		= CD_CATEGORIA_P
AND	coalesce(IE_SITUACAO,'A')	= 'A'
AND	DT_INICIO_VIGENCIA	=
	(SELECT	MAX(DT_INICIO_VIGENCIA)
	FROM	CONVENIO_AMB A
	WHERE	A.CD_ESTABELECIMENTO  = CD_ESTABELECIMENTO_P
	AND	A.CD_CONVENIO         = CD_CONVENIO_P
	AND	A.CD_CATEGORIA        = CD_CATEGORIA_P
	AND	coalesce(A.IE_SITUACAO,'A')= 'A');

begin
SELECT	coalesce(a.VL_CUSTO_OPERACIONAL,0),
	coalesce(a.VL_MEDICO,0),
	coalesce(a.QT_FILME,0),
	coalesce(a.QT_PORTE_ANESTESICO,0),
	coalesce(a.NR_AUXILIARES,0),
	coalesce(a.VL_AUXILIARES,0),
	coalesce(a.VL_CUSTO_OPERACIONAL,0),
	coalesce(a.VL_MEDICO,0),
	a.CD_MOEDA,
	coalesce(a.VL_ANESTESISTA,0),
	coalesce(a.vl_procedimento,0)
INTO STRICT	VL_CUSTO_OPERACIONAL_W,
	VL_MEDICO_W,
	VL_FILME_W,
	NR_PORTE_ANESTESICO_W,
	NR_AUXILIARES_W,
	VL_AUXILIARES_INFORM_W,
	VL_PTO_CUSTO_OPERAC_W,
	VL_PTO_MEDICO_W,
	CD_MOEDA_W,
	VL_ANEST_INFORM_W,
	vl_procedimento_w
FROM	PRECO_AMB A
WHERE	A.CD_PROCEDIMENTO  	= CD_PROCEDIMENTO_P
and	a.CD_EDICAO_AMB		= CD_EDICAO_AMB_w
and	coalesce(a.dt_inicio_vigencia,clock_timestamp() - interval '3650 days') =
				(SELECT	max(coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days'))
				from	preco_amb b
				where	b.cd_procedimento	= cd_procedimento_p
				and	b.CD_EDICAO_AMB		= CD_EDICAO_AMB_w);
exception
	when others then
		vl_procedimento_w		:= 0;
		VL_CUSTO_OPERACIONAL_W	:= 0;
		VL_PTO_MEDICO_W		:= 0;
		VL_ANEST_INFORM_W		:= 0;
end;

if (ie_opcao_p	= 'P') then
	return vl_procedimento_w;
elsif (ie_opcao_p	= 'CO') then
	return VL_CUSTO_OPERACIONAL_W;
elsif (ie_opcao_p	= 'M') then
	return VL_PTO_MEDICO_W;
elsif (ie_opcao_p	= 'A') then
	return VL_ANEST_INFORM_W;
elsif (ie_opcao_p	= 'MC') then
	return VL_PTO_MEDICO_W + VL_CUSTO_OPERACIONAL_W;
elsif (ie_opcao_p	= 'F') then
	return	vl_filme_w;
elsif (ie_opcao_p	= 'NR') then
	return	nr_auxiliares_w;
else
	return	0;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_preco_amb (cd_procedimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_estabelecimento_p bigint, ie_opcao_p text) FROM PUBLIC;

