-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_project_calendar (dt_referencia_p timestamp, cd_pessoa_fisica_p text) RETURNS bigint AS $body$
DECLARE


hr_inicio_w		varchar(50)	:= '09:00';
hr_fim_w		varchar(50)	:= '17:00';
qt_intervalo_w		bigint	:= 60;
qt_horas_dia_w		proj_cron_etapa.qt_hora_real%type;
qt_prev_dia_w		double precision	:= 0;
perc_dia_prev_w		double precision;
qt_adic_prev_dia_w	double precision	:= 0;
dt_hr_inicial		timestamp;
dt_hr_final		timestamp;

c01 CURSOR FOR
SELECT	a.nr_sequencia nr_seq_etapa,
	b.nr_sequencia nr_seq_cronograma,
	a.dt_inicio_prev,
	a.dt_fim_prev,
	a.qt_hora_prev
from	proj_cron_etapa a,
	proj_cronograma b
where	a.NR_SEQ_CRONOGRAMA = b.nr_sequencia
and	coalesce(b.IE_SITUACAO,'A') = 'A'
and	(b.DT_APROVACAO IS NOT NULL AND b.DT_APROVACAO::text <> '')
and	not	exists (	select	1
			from	PROJ_CRON_ETAPA x
			where	x.nr_seq_superior	= a.nr_sequencia)
and	exists (select 1 from proj_cron_etapa_equipe y
		where y.nr_seq_etapa_cron = a.nr_sequencia
		and y.cd_programador = cd_pessoa_fisica_p)
and	trunc(dt_referencia_p) between trunc(a.dt_inicio_prev) and trunc(a.dt_fim_prev);

BEGIN

for r_c01_w in c01 loop

	select	coalesce(max(hr_inicio),'09:00'),
		coalesce(max(hr_final),'17:00'),
		coalesce(max(qt_min_intervalo),60)
	into STRICT	hr_inicio_w,
		hr_fim_w,
		qt_intervalo_w
	from	proj_cron_calendario
	where	nr_seq_cronograma = r_c01_w.nr_seq_cronograma
	and	ie_dia_semana = 9;

	dt_hr_inicial 	:= to_date(to_char(dt_referencia_p,'dd/mm/yyyy')||' '||hr_inicio_w,'dd/mm/yyyy hh24:mi');
	dt_hr_final 	:= to_date(to_char(dt_referencia_p,'dd/mm/yyyy')||' '||hr_fim_w,'dd/mm/yyyy hh24:mi');
	qt_horas_dia_w	:= PKG_DATE_UTILS.get_DiffDate(dt_hr_inicial,dt_hr_final,'HOUR%') - (qt_intervalo_w/60);

	if (trunc(r_c01_w.dt_inicio_prev) = trunc(dt_referencia_p) and trunc(r_c01_w.dt_fim_prev) = trunc(dt_referencia_p)) then
		qt_prev_dia_w := qt_prev_dia_w + r_c01_w.qt_hora_prev;
	else
		qt_adic_prev_dia_w := qt_adic_prev_dia_w + r_c01_w.qt_hora_prev;
	end if;

end loop;

if (qt_adic_prev_dia_w > 0) then

	perc_dia_prev_w := 1 - (qt_prev_dia_w/qt_horas_dia_w);
	qt_prev_dia_w := qt_prev_dia_w + (qt_adic_prev_dia_w * perc_dia_prev_w);

end if;

return	qt_prev_dia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_project_calendar (dt_referencia_p timestamp, cd_pessoa_fisica_p text) FROM PUBLIC;

