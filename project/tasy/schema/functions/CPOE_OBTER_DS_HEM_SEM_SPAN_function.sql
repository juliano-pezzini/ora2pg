-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_ds_hem_sem_span ( nr_sequencia_p cpoe_hemoterapia.nr_sequencia%type, qt_procedimento_p cpoe_hemoterapia.qt_procedimento%type) RETURNS varchar AS $body$
DECLARE


cd_mat_hem1_w			cpoe_hemoterapia.cd_mat_hem1%type;
qt_dose_hem1_w			cpoe_hemoterapia.qt_dose_hem1%type;
cd_unid_medida_dose_hem1_w	cpoe_hemoterapia.cd_unid_medida_dose_hem1%type;
cd_mat_hem2_w			cpoe_hemoterapia.cd_mat_hem2%type;
qt_dose_hem2_w			cpoe_hemoterapia.qt_dose_hem2%type;
cd_unid_medida_dose_hem2_w	cpoe_hemoterapia.cd_unid_medida_dose_hem2%type;
cd_mat_hem3_w			cpoe_hemoterapia.cd_mat_hem3%type;
qt_dose_hem3_w			cpoe_hemoterapia.qt_dose_hem3%type;
cd_unid_medida_dose_hem3_w	cpoe_hemoterapia.cd_unid_medida_dose_hem3%type;
cd_mat_hem4_w			cpoe_hemoterapia.cd_mat_hem4%type;
qt_dose_hem4_w			cpoe_hemoterapia.qt_dose_hem4%type;
cd_unid_medida_dose_hem4_w	cpoe_hemoterapia.cd_unid_medida_dose_hem4%type;
cd_mat_hem5_w			cpoe_hemoterapia.cd_mat_hem5%type;
qt_dose_hem5_w			cpoe_hemoterapia.qt_dose_hem5%type;
cd_unid_medida_dose_hem5_w	cpoe_hemoterapia.cd_unid_medida_dose_hem5%type;
ds_retorno_w   			varchar(4000);
ds_hemocomponente_w   		varchar(4000);
	
	function dose_unidade_medida(qt_dose_p				bigint,
                                 ds_dose_diferenciada_p	text,
                                 cd_unidade_medida_p	text) return text is	
		qt_dose_w           varchar(50);
	
BEGIN
		if (coalesce(ds_dose_diferenciada_p::text, '') = '') then
			--Colocar '0' antes da virgula			
			qt_dose_w := qt_dose_p;
			if (substr(qt_dose_p,1,1) = ',') then				
				qt_dose_w	:= '0' || qt_dose_p;
				
				qt_dose_w	:= replace(qt_dose_w,'.',',');			
			end if;			
			
			return ' ' || qt_dose_w || ' ' || cd_unidade_medida_p || ' ';
		else
			--Colocar '0' antes da virgula
			qt_dose_w := ds_dose_diferenciada_p;
			
			if (substr(ds_dose_diferenciada_p,1,1) = ',') then
				qt_dose_w	:= '0' || ds_dose_diferenciada_p;
				
			qt_dose_w	:= replace(qt_dose_w,'.',',');						
			end if;			
		
			return ' ' || qt_dose_w || ' ' || cd_unidade_medida_p || ' ';
		end if;		
	end;
	
	function obter_descricao_subitem(	cd_material_p			number,
										qt_dose_p				number,
										cd_unidade_medida_p		varchar2,
										ds_dose_diferenciada_p	varchar2 )
	 		    	return varchar2 is
	begin
		return 	' ' || substr(obter_desc_material(cd_material_p),1,80) ||
			' ' || dose_unidade_medida(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p);
	end;
	
	function adep_dose_unidade_medida(	qt_dose_p				number,
										ds_dose_diferenciada_p	varchar2,
										cd_unidade_medida_p		varchar2) return varchar2 is	
		qt_dose_w           varchar2(50 char);
	begin
		if (coalesce(ds_dose_diferenciada_p::text, '') = '') then
			--Colocar '0' antes da virgula			
			qt_dose_w := qt_dose_p;
			if (substr(qt_dose_p,1,1) = ',') then				
				qt_dose_w	:= '0' || qt_dose_p;
				
				qt_dose_w	:= replace(qt_dose_w,'.',',');			
			end if;			
			
			return ' ' || qt_dose_w || ' ' || Obter_Desc_Unid_Med(cd_unidade_medida_p) || ' ';
		else
			--Colocar '0' antes da virgula
			qt_dose_w := ds_dose_diferenciada_p;
			
			if (substr(ds_dose_diferenciada_p,1,1) = ',') then
				qt_dose_w	:= '0' || ds_dose_diferenciada_p;
				
			qt_dose_w	:= replace(qt_dose_w,'.',',');						
			end if;			
		
			return ' ' || qt_dose_w || ' ' || Obter_Desc_Unid_Med(cd_unidade_medida_p) || ' ';
		end if;		
	end;
	
	function adep_obter_descricao_subitem(	cd_material_p			number,
											qt_dose_p				number,
											cd_unidade_medida_p		varchar2,
											ds_dose_diferenciada_p	varchar2 )
	 		    	return varchar2 is
	begin
		return 	' ' || substr(obter_desc_material(cd_material_p),1,80) ||
			' ' || adep_dose_unidade_medida(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p);
	end;

begin

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '')  then
	ds_retorno_w := cpoe_obter_desc_info_hemote(nr_sequencia_p);
end if;

if (qt_procedimento_p IS NOT NULL AND qt_procedimento_p::text <> '') then
	ds_retorno_w := ds_retorno_w || ' ' || qt_procedimento_p;
end if;

ds_retorno_w := ds_retorno_w || ' ' || obter_desc_expressao(729618,null) || ' ' || ds_hemocomponente_w;

select	cd_mat_hem1,
		qt_dose_hem1,
		cd_unid_medida_dose_hem1,
		cd_mat_hem2,
		qt_dose_hem2,
		cd_unid_medida_dose_hem2,
		cd_mat_hem3,
		qt_dose_hem3,
		cd_unid_medida_dose_hem3,
		cd_mat_hem4,
		qt_dose_hem4,
		cd_unid_medida_dose_hem4,
		cd_mat_hem5,
		qt_dose_hem5,
		cd_unid_medida_dose_hem5
into STRICT	cd_mat_hem1_w,
		qt_dose_hem1_w,
		cd_unid_medida_dose_hem1_w,
		cd_mat_hem2_w,
		qt_dose_hem2_w,
		cd_unid_medida_dose_hem2_w,
		cd_mat_hem3_w,
		qt_dose_hem3_w,
		cd_unid_medida_dose_hem3_w,
		cd_mat_hem4_w,
		qt_dose_hem4_w,
		cd_unid_medida_dose_hem4_w,
		cd_mat_hem5_w,
		qt_dose_hem5_w,
		cd_unid_medida_dose_hem5_w
from	cpoe_hemoterapia
where	nr_sequencia = nr_sequencia_p;

if (cd_mat_hem1_w IS NOT NULL AND cd_mat_hem1_w::text <> '') then
	ds_retorno_w := substr(ds_retorno_w || obter_descricao_subitem( cd_mat_hem1_w, qt_dose_hem1_w, cd_unid_medida_dose_hem1_w, null),1,4000);
end if;

RAISE NOTICE '%', cd_mat_hem2_w;
RAISE NOTICE '%', obter_descricao_subitem(cd_mat_hem2_w, qt_dose_hem2_w, cd_unid_medida_dose_hem2_w, null);

if (cd_mat_hem2_w IS NOT NULL AND cd_mat_hem2_w::text <> '') then
	ds_retorno_w := substr(ds_retorno_w || obter_descricao_subitem(cd_mat_hem2_w, qt_dose_hem2_w, cd_unid_medida_dose_hem2_w, null),1,4000);
end if;

if (cd_mat_hem3_w IS NOT NULL AND cd_mat_hem3_w::text <> '') then
	ds_retorno_w := substr(ds_retorno_w || obter_descricao_subitem( cd_mat_hem3_w, qt_dose_hem3_w, cd_unid_medida_dose_hem3_w, null),1,4000);
end if;

if (cd_mat_hem4_w IS NOT NULL AND cd_mat_hem4_w::text <> '') then
	ds_retorno_w := substr(ds_retorno_w || obter_descricao_subitem( cd_mat_hem4_w, qt_dose_hem4_w, cd_unid_medida_dose_hem4_w, null),1,4000);
end if;

if (cd_mat_hem5_w IS NOT NULL AND cd_mat_hem5_w::text <> '') then
	ds_retorno_w := substr(ds_retorno_w || obter_descricao_subitem( cd_mat_hem5_w, qt_dose_hem5_w, cd_unid_medida_dose_hem5_w, null),1,4000);
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_ds_hem_sem_span ( nr_sequencia_p cpoe_hemoterapia.nr_sequencia%type, qt_procedimento_p cpoe_hemoterapia.qt_procedimento%type) FROM PUBLIC;

