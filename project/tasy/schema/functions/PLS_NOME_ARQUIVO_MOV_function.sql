-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_nome_arquivo_mov ( nr_seq_lote_p bigint, nr_seq_operadora_p bigint) RETURNS varchar AS $body$
DECLARE


nm_arquivo_w		varchar(255);
cd_operadora_origem_w	pls_congenere.nr_seq_congenere%type;
cd_operadora_w		pls_mov_benef_operadora.nr_seq_congenere%type;
dt_referencia_w		timestamp;

BEGIN

select	max(b.nm_arquivo)
into STRICT	nm_arquivo_w
from	pls_mov_benef_lote      a,
	pls_mov_benef_regra     b
where	b.nr_sequencia = a.nr_seq_regra
and	a.nr_sequencia = nr_seq_lote_p;

select	coalesce(pls_obter_cd_seq_congenere(a.nr_seq_congenere,'CD'), a.nr_seq_congenere),
	b.dt_referencia
into STRICT	cd_operadora_w,
	dt_referencia_w
from	pls_mov_benef_operadora	a,
	pls_mov_benef_lote	b
where	b.nr_sequencia	= a.nr_seq_lote
and	a.nr_sequencia	= nr_seq_operadora_p;

select	coalesce(pls_obter_cd_seq_congenere(max(c.nr_seq_congenere),'CD'), max(c.nr_seq_congenere))
into STRICT	cd_operadora_origem_w
from	pls_mov_benef_lote	a,
	pls_outorgante		b,
	pls_congenere		c
where	b.cd_estabelecimento	= a.cd_estabelecimento
and	c.cd_cgc		= b.cd_cgc_outorgante
and	a.nr_sequencia		= nr_seq_lote_p;

nm_arquivo_w := replace(nm_arquivo_w,'@NR_LOTE',nr_seq_lote_p );
nm_arquivo_w := replace(nm_arquivo_w,'@CD_OPERADORA_ORIGEM',cd_operadora_origem_w );
nm_arquivo_w := replace(nm_arquivo_w,'@CD_OPERADORA',cd_operadora_w );
nm_arquivo_w := replace(nm_arquivo_w,'@DIA_REFERENCIA',to_char(dt_referencia_w,'DD') );
nm_arquivo_w := replace(nm_arquivo_w,'@MES_REFERENCIA',to_char(dt_referencia_w,'MM') );
nm_arquivo_w := replace(nm_arquivo_w,'@ANO_REFERENCIA',to_char(dt_referencia_w,'YYYY') );
nm_arquivo_w := replace(nm_arquivo_w,'@DIA_ATUAL',to_char(clock_timestamp(),'DD') );
nm_arquivo_w := replace(nm_arquivo_w,'@MES_ATUAL',to_char(clock_timestamp(),'MM') );
nm_arquivo_w := replace(nm_arquivo_w,'@ANO_ATUAL',to_char(clock_timestamp(),'YYYY') );

return	nm_arquivo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_nome_arquivo_mov ( nr_seq_lote_p bigint, nr_seq_operadora_p bigint) FROM PUBLIC;

