-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_solucao_prescr ( nr_atendimento_p bigint, ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_informacao_w		varchar(4000);
nr_prescricao_w		bigint;
dt_prescricao_w		varchar(20);
dt_prim_horario_w	varchar(20);
nr_horas_validade_w	integer;
nm_prescritor_w		varchar(60);
ds_item_w			varchar(100);
ds_componentes_w	varchar(2000);


BEGIN 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_solucao_p IS NOT NULL AND ie_tipo_solucao_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') then 
	if (ie_tipo_solucao_p = 1) then --solucao 
		/* obter informações prescrição */
	 
		select	to_char(a.dt_prescricao,'dd/mm/yyyy hh24:mi'), 
			to_char(a.dt_prescricao,'dd/mm/yyyy') || ' ' || to_char(a.dt_primeiro_horario,'hh24:mi'), 
			a.nr_horas_validade, 
			substr(obter_nome_pf(a.cd_prescritor),1,60), 
			ds_solucao, 
			substr(obter_componentes_solucao(nr_prescricao_p, nr_seq_solucao_p, 'S', null, null),1,2000) ds_componentes 
		into STRICT	dt_prescricao_w, 
			dt_prim_horario_w, 
			nr_horas_validade_w, 
			nm_prescritor_w, 
			ds_item_w, 
			ds_componentes_w 
		from	prescr_medica a, 
			prescr_solucao b 
		where	a.nr_prescricao = b.nr_prescricao 
		and	b.nr_prescricao = nr_prescricao_p 
		and	b.nr_seq_solucao = nr_seq_solucao_p;
 
		/* montar mensagem informações */
 
		ds_informacao_w :=	ds_item_w || chr(13) || chr(13) || chr(10) || 
					obter_desc_expressao(325814)/*'Prescrição: '*/
 || nr_prescricao_p	|| CHR(10) || 
					'Data: ' || dt_prescricao_w || CHR(10) || 
					obter_desc_expressao(648277)/*'Início: '*/
 || dt_prim_horario_w || CHR(10) || 
					obter_desc_expressao(296217)/*'Prescritor: '*/
 ||': '|| nm_prescritor_w 	|| CHR(10) || CHR(10) || 
					obter_desc_expressao(709571)/*'Componentes: '*/
 ||': '|| CHR(10) || ds_componentes_w;
 
	elsif (ie_tipo_solucao_p = 2) then --suporte nutricional enteral 
		/* obter informações prescrição */
	 
		select	to_char(a.dt_prescricao,'dd/mm/yyyy hh24:mi'), 
			to_char(a.dt_prescricao,'dd/mm/yyyy') || ' ' || to_char(a.dt_primeiro_horario,'hh24:mi'), 
			a.nr_horas_validade, 
			substr(obter_nome_pf(a.cd_prescritor),1,60), 
			substr(obter_desc_material(b.cd_material),1,100) 
		into STRICT	dt_prescricao_w, 
			dt_prim_horario_w, 
			nr_horas_validade_w, 
			nm_prescritor_w, 
			ds_item_w 
		from	prescr_medica a, 
			prescr_material b 
		where	a.nr_prescricao = b.nr_prescricao 
		and	b.nr_prescricao = nr_prescricao_p 
		and	b.nr_sequencia = nr_seq_solucao_p 
		and	b.ie_agrupador = 8;
 
		/* montar mensagem informações */
 
		ds_informacao_w :=	ds_item_w || chr(13) || chr(13) || chr(10) || 
					obter_desc_expressao(325814)/*'Prescrição: '*/
 || nr_prescricao_p	|| CHR(10) || 
					'Data: ' || dt_prescricao_w || CHR(10) || 
					obter_desc_expressao(648277)/*'Início: '*/
 || dt_prim_horario_w || CHR(10) || 
					obter_desc_expressao(296217)/*'Prescritor: '*/
 ||': '|| nm_prescritor_w;
 
	elsif (ie_tipo_solucao_p = 3) then --hemocomponente 
		/* obter informações prescrição */
	 
		select	to_char(a.dt_prescricao,'dd/mm/yyyy hh24:mi'), 
			to_char(a.dt_prescricao,'dd/mm/yyyy') || ' ' || to_char(a.dt_primeiro_horario,'hh24:mi'), 
			a.nr_horas_validade, 
			substr(obter_nome_pf(a.cd_prescritor),1,60), 
			substr(obter_desc_san_derivado(b.nr_seq_derivado),1,50) 
		into STRICT	dt_prescricao_w, 
			dt_prim_horario_w, 
			nr_horas_validade_w, 
			nm_prescritor_w, 
			ds_item_w 
		from	prescr_medica a, 
			prescr_procedimento b 
		where	a.nr_prescricao = b.nr_prescricao 
		and	b.nr_prescricao = nr_prescricao_p 
		and	b.nr_sequencia = nr_seq_solucao_p 
		and	(nr_seq_solic_sangue IS NOT NULL AND nr_seq_solic_sangue::text <> '') 
		and	(nr_seq_derivado IS NOT NULL AND nr_seq_derivado::text <> '');
 
		/* montar mensagem informações */
 
		ds_informacao_w :=	ds_item_w || chr(13) || chr(13) || chr(10) || 
					obter_desc_expressao(325814)/*'Prescrição: '*/
 || nr_prescricao_p	|| CHR(10) || 
					'Data: ' || dt_prescricao_w || CHR(10) || 
					obter_desc_expressao(648277)/*'Início: '*/
 || dt_prim_horario_w || CHR(10) || 
					obter_desc_expressao(296217)/*'Prescritor: '*/
 ||': '|| nm_prescritor_w;
 
	elsif (ie_tipo_solucao_p = 4) then --npt adulta 
		/* obter informações prescrição */
	 
		select	to_char(a.dt_prescricao,'dd/mm/yyyy hh24:mi'), 
			to_char(a.dt_prescricao,'dd/mm/yyyy') || ' ' || to_char(a.dt_primeiro_horario,'hh24:mi'), 
			a.nr_horas_validade, 
			substr(obter_nome_pf(a.cd_prescritor),1,60), 
			substr(obter_desc_expressao(305331)/*'NPT adulta'*/
,1,50) 
		into STRICT	dt_prescricao_w, 
			dt_prim_horario_w, 
			nr_horas_validade_w, 
			nm_prescritor_w, 
			ds_item_w 
		from	prescr_medica a, 
			nut_paciente b 
		where	a.nr_prescricao = b.nr_prescricao 
		and	b.nr_prescricao = nr_prescricao_p 
		and	b.nr_sequencia = nr_seq_solucao_p;
 
		/* montar mensagem informações */
 
		ds_informacao_w :=	ds_item_w || chr(13) || chr(13) || chr(10) || 
					obter_desc_expressao(325814)/*'Prescrição: '*/
 || nr_prescricao_p	|| CHR(10) || 
					'Data: ' || dt_prescricao_w || CHR(10) || 
					obter_desc_expressao(648277)/*'Início: '*/
 || dt_prim_horario_w || CHR(10) || 
					obter_desc_expressao(296217)/*'Prescritor: '*/
 ||': '|| nm_prescritor_w;
 
	elsif (ie_tipo_solucao_p = 5) then --npt neo 
		/* obter informações prescrição */
	 
		select	to_char(a.dt_prescricao,'dd/mm/yyyy hh24:mi'), 
			to_char(a.dt_prescricao,'dd/mm/yyyy') || ' ' || to_char(a.dt_primeiro_horario,'hh24:mi'), 
			a.nr_horas_validade, 
			substr(obter_nome_pf(a.cd_prescritor),1,60), 
			substr(obter_desc_expressao(305334)/*'NPT neonatal'*/
,1,50) 
		into STRICT	dt_prescricao_w, 
			dt_prim_horario_w, 
			nr_horas_validade_w, 
			nm_prescritor_w, 
			ds_item_w 
		from	prescr_medica a, 
			nut_pac b 
		where	a.nr_prescricao = b.nr_prescricao 
		and	b.nr_prescricao = nr_prescricao_p 
		and	b.nr_sequencia = nr_seq_solucao_p;
 
		/* montar mensagem informações */
 
		ds_informacao_w :=	ds_item_w || chr(13) || chr(13) || chr(10) || 
					obter_desc_expressao(325814)/*'Prescrição: '*/
 || nr_prescricao_p	|| CHR(10) || 
					'Data: ' || dt_prescricao_w || CHR(10) || 
					obter_desc_expressao(648277)/*'Início: '*/
 || dt_prim_horario_w || CHR(10) || 
					obter_desc_expressao(296217)/*'Prescritor: '*/
 ||': '|| nm_prescritor_w;
	end if;
end if;
 
return ds_informacao_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_solucao_prescr ( nr_atendimento_p bigint, ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint) FROM PUBLIC;

