-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_debitos_vencidos ( cd_pessoa_fisica_p text, cd_cgc_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
cont_w			integer;
nm_usuario_w		varchar(255);
ie_cobranca_w		varchar(1);
ie_perdas_w		varchar(1);
ie_valor_pendente_w	varchar(1);


BEGIN 
 
select	wheb_usuario_pck.get_nm_usuario 
into STRICT	nm_usuario_w
;
	 
ie_cobranca_w := obter_param_usuario(-815, 7, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_p, ie_cobranca_w);
ie_perdas_w := obter_param_usuario(-815, 8, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_p, ie_perdas_w);
 
if (coalesce(cd_cgc_p::text, '') = '') then 
	ie_valor_pendente_w := substr(obter_se_valores_pendente(cd_pessoa_fisica_p, cd_estabelecimento_p, 'S',null),1,1);
end if;
 
ie_valor_pendente_w	:= coalesce(ie_valor_pendente_w, 'N');
 
if (ie_valor_pendente_w = 'N') then 
	begin 
	cont_w := 0;
	 
	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then 
		select	count(*) + cont_w 
		into STRICT	cont_w 
		from (SELECT	/*+ use_concat*/ 1 
		FROM cheque_cr a
LEFT OUTER JOIN titulo_receber b ON (a.nr_titulo = b.nr_titulo)
LEFT OUTER JOIN atendimento_paciente c ON (b.nr_atendimento = c.nr_atendimento)
LEFT OUTER JOIN convenio d ON (b.cd_convenio_conta = d.cd_convenio)
WHERE coalesce(d.ie_tipo_convenio,1) = 1 and obter_status_cheque(a.nr_seq_cheque) in (3,5,10) and coalesce(a.cd_pessoa_fisica,'0')  	<> cd_pessoa_fisica_p and c.nr_atendimento   	in (select x.nr_atendimento from atendimento_paciente x where x.cd_pessoa_fisica = cd_pessoa_fisica_p) and (coalesce(trunc(b.dt_pagamento_previsto), clock_timestamp() - interval '1 days') < trunc(clock_timestamp())) 
		 
union all
 
		SELECT	/*+ use_concat*/ 1 
		FROM atendimento_paciente d, titulo_receber_liq b, cheque_cr a, titulo_receber c
LEFT OUTER JOIN convenio e ON (c.cd_convenio_conta = e.cd_convenio)
WHERE b.nr_titulo		= c.nr_titulo and c.nr_atendimento	= d.nr_atendimento and a.nr_seq_caixa_rec	= b.nr_seq_caixa_rec  and coalesce(e.ie_tipo_convenio,1) = 1 and obter_status_cheque(a.nr_seq_cheque) in (3,5,10) and coalesce(a.nr_titulo::text, '') = '' and coalesce(d.cd_pessoa_fisica,'0') 	<> cd_pessoa_fisica_p and d.nr_atendimento  	in (select x.nr_atendimento from atendimento_paciente x where x.cd_pessoa_fisica = cd_pessoa_fisica_p) and (coalesce(trunc(c.dt_pagamento_previsto),clock_timestamp() - interval '1 days') < trunc(clock_timestamp())) 
		 
union all
 
		select	1 
		from	cheque_cr b, 
			cobranca c 
		where	b.cd_pessoa_fisica	= cd_pessoa_fisica_p 
		and	c.nr_seq_cheque		= b.nr_seq_cheque 
		and	c.ie_status		= 'P' 
		and (c.cd_estabelecimento = cd_estabelecimento_p or cd_estabelecimento_p = 0) 
		and	'S'			= ie_cobranca_w 
		
union all
 
		select	1 
		from	perda_contas_receber a 
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_p 
		and (cd_estabelecimento_p = 0 or a.cd_estabelecimento = cd_estabelecimento_p) 
		and	a.ie_tipo_perda = 'R' 
		and	a.vl_saldo > 0 
		and	ie_perdas_w = 'S') alias27;
	elsif (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then 
		select	count(*) + cont_w 
		into STRICT	cont_w 
		from (SELECT	/*+ use_concat*/ 1 
		from	titulo_receber a 
		where	ie_situacao not in ('5','3') 
		and	coalesce(dt_liquidacao::text, '') = '' 
		and	a.cd_cgc  	= cd_cgc_p 
		and (coalesce(trunc(a.dt_pagamento_previsto), clock_timestamp() - interval '1 days') < trunc(clock_timestamp())) 
		
union all
 
		SELECT	1 
		from	cheque_cr b, 
			cobranca c 
		where	b.cd_cgc		= cd_cgc_p 
		and	c.nr_seq_cheque		= b.nr_seq_cheque 
		and	c.ie_status		= 'P' 
		and (c.cd_estabelecimento = cd_estabelecimento_p or cd_estabelecimento_p = 0) 
		and	'S'			= ie_cobranca_w 
		
union all
 
		select	1 
		from	perda_contas_receber a 
		where	a.cd_cgc 		= cd_cgc_p 
		and (cd_estabelecimento_p = 0 or a.cd_estabelecimento = cd_estabelecimento_p) 
		and	a.ie_tipo_perda = 'R' 
		and	a.vl_saldo > 0 
		and	ie_perdas_w = 'S') alias12;
	end if;
	 
	if (cont_w > 0) then 
		ie_valor_pendente_w := 'S';
	end if;
	end;
end if;
 
return ie_valor_pendente_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_debitos_vencidos ( cd_pessoa_fisica_p text, cd_cgc_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

