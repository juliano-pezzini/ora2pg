-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_validade_case ( dt_referencia_p timestamp, nr_atendimento_p bigint ) RETURNS timestamp AS $body$
DECLARE

			

dt_validade_case_w				timestamp;
nr_seq_tipo_episodio_w	    	episodio_paciente.nr_seq_tipo_episodio%type;
nr_seq_tipo_admissao_fat_w		atendimento_paciente.nr_seq_tipo_admissao_fat%type;
qt_mes_regra_w					bigint;
qt_mes_atual_w					bigint;
qt_ano_atual_w					bigint;
qt_mes_inicial_w				bigint;
qt_mes_w						bigint;
dt_referencia_w					timestamp;

C01 CURSOR FOR
	SELECT	(c.ie_mes)::numeric
	from	tipo_episodio a,
			subtipo_episodio b,
			subtipo_episodio_validade c
	where	b.nr_seq_tipo_episodio = a.nr_sequencia
	and		c.nr_seq_tipo = b.nr_sequencia
	and		b.nr_seq_tipo_admissao =  nr_seq_tipo_admissao_fat_w
	and		b.nr_seq_tipo_episodio =  nr_seq_tipo_episodio_w
	order by (c.ie_mes)::numeric;


BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then

	Select  max(a.nr_seq_tipo_episodio),
			max(b.nr_seq_tipo_admissao_fat)
	into STRICT	nr_seq_tipo_episodio_w,
			nr_seq_tipo_admissao_fat_w
	from    episodio_paciente a,
			atendimento_paciente b
	where 	a.nr_sequencia = b.nr_seq_episodio
	and		b.nr_atendimento = nr_atendimento_p;
	
	If (nr_seq_tipo_episodio_w IS NOT NULL AND nr_seq_tipo_episodio_w::text <> '') then
	
		Select  max(PKG_DATE_UTILS.extract_field('MONTH', dt_referencia_p)),
				max(PKG_DATE_UTILS.extract_field('YEAR', dt_referencia_p))
		into STRICT    qt_mes_atual_w,
				qt_ano_atual_w
		;
	
    	open C01;
    	loop
    	fetch C01 into	
    		qt_mes_regra_w;
    	EXIT WHEN NOT FOUND; /* apply on C01 */
    		begin
			if ( coalesce(qt_mes_inicial_w::text, '') = '' ) then
				qt_mes_inicial_w := qt_mes_regra_w;
			end if;		
			
			if ( qt_mes_regra_w >= qt_mes_atual_w ) then
				qt_mes_w := qt_mes_regra_w;				
				exit;
			end if;			
    		
    		end;
    	end loop;
    	close C01;
		
		if ( coalesce(qt_mes_w::text, '') = '') then
		
			qt_mes_w := qt_mes_inicial_w;
			qt_ano_atual_w := qt_ano_atual_w + 1;			
		
		end if;
		
		if (coalesce(qt_mes_w, 0) > 0 and  coalesce(qt_ano_atual_w, 0) > 0)then
			Select max(PKG_DATE_UTILS.END_OF(to_date(qt_mes_w||'/'||qt_ano_atual_w,'mm/yyyy'),'MONTH'))
			into STRICT   dt_validade_case_w
			;
		end if;
	
	end if;

end if;

return	dt_validade_case_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_validade_case ( dt_referencia_p timestamp, nr_atendimento_p bigint ) FROM PUBLIC;

