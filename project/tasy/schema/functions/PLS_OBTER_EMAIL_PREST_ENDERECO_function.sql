-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_email_prest_endereco ( nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) RETURNS varchar AS $body$
DECLARE

						
ds_email_w		varchar(4000);

c01 CURSOR(	nr_seq_prestador_pc	pls_prestador.nr_sequencia%type,
		cd_estabelecimento_pc	pls_prestador.cd_estabelecimento%type) FOR
	SELECT	cd_pessoa_fisica,
		cd_cgc,
		CASE WHEN ie_tipo_endereco='PFC' THEN  '2' WHEN ie_tipo_endereco='PFA' THEN  '9' WHEN ie_tipo_endereco='PFJ' THEN  '6' WHEN ie_tipo_endereco='PFM' THEN  '5' WHEN ie_tipo_endereco='PFP' THEN  '4' WHEN ie_tipo_endereco='PFR' THEN  '1' WHEN ie_tipo_endereco='PFV' THEN  '3' END  ie_tipo_endereco, -- 2 = Comercial | 9 = Adicional | 6 = Conjuge | 5 = Mae |  4 = Pai | 1 = Residencial | 3 = Responsavel
		ie_tipo_endereco ie_tipo_endereco_orig,
		nr_seq_tipo_compl_adic,
		nr_seq_compl_pf_tel_adic,
		nr_seq_compl_pj
	from	pls_prestador
	where	nr_sequencia 		= nr_seq_prestador_pc
	and	cd_estabelecimento	= cd_estabelecimento_pc;
	
c02 CURSOR(	cd_pessoa_fisica_pc	pls_prestador.cd_pessoa_fisica%type,
		ie_tipo_endereco_pc	pls_prestador.ie_tipo_endereco%type) FOR
	SELECT	ds_email
	from	compl_pessoa_fisica
	where	cd_pessoa_fisica 	= cd_pessoa_fisica_pc
	and	ie_tipo_complemento 	= ie_tipo_endereco_pc
	and 	(ds_email IS NOT NULL AND ds_email::text <> '')
	order by ds_email;
	
BEGIN

for r_c01_w in c01( nr_seq_prestador_p , cd_estabelecimento_p ) loop
	if (r_c01_w.cd_cgc IS NOT NULL AND r_c01_w.cd_cgc::text <> '') then
		if (r_c01_w.ie_tipo_endereco_orig = 'PJA') and (r_c01_w.nr_seq_compl_pj IS NOT NULL AND r_c01_w.nr_seq_compl_pj::text <> '') then
			select	max(ds_email)
			into STRICT	ds_email_w
			from	pessoa_juridica_compl
			where 	cd_cgc = r_c01_w.cd_cgc
			and 	nr_sequencia = r_c01_w.nr_seq_compl_pj;
		end if;
		
		if (coalesce(ds_email_w::text, '') = '') then
			ds_email_w	:= substr(obter_dados_pf_pj_estab(cd_estabelecimento_p, null, r_c01_w.cd_cgc, 'M'), 1, 255);
		end if;
	else
		if (r_c01_w.ie_tipo_endereco = '9') and (r_c01_w.nr_seq_tipo_compl_adic IS NOT NULL AND r_c01_w.nr_seq_tipo_compl_adic::text <> '') then
			select	max(ds_email)
			into STRICT	ds_email_w
			from	compl_pessoa_fisica
			where	cd_pessoa_fisica 	= r_c01_w.cd_pessoa_fisica
			and	ie_tipo_complemento	= 9	-- Adicional
			and	nr_seq_tipo_compl_adic	= r_c01_w.nr_seq_tipo_compl_adic;
			
		elsif (r_c01_w.ie_tipo_endereco = '2') and (r_c01_w.nr_seq_compl_pf_tel_adic IS NOT NULL AND r_c01_w.nr_seq_compl_pf_tel_adic::text <> '') then
			select	max(ds_email)
			into STRICT	ds_email_w
			from	compl_pf_tel_adic
			where	nr_sequencia = r_c01_w.nr_seq_compl_pf_tel_adic;
		end if;
		
		if (coalesce(ds_email_w::text, '') = '') then
			for r_c02_w in c02( r_c01_w.cd_pessoa_fisica , r_c01_w.ie_tipo_endereco ) loop
				ds_email_w	:= substr((ds_email_w || r_c02_w.ds_email || ';'), 1, 4000);
			end loop;
			
			ds_email_w	:= substr(ds_email_w, 1, length(ds_email_w) - 1);
		end if;
	end if;
end loop;

return	ds_email_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_email_prest_endereco ( nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

