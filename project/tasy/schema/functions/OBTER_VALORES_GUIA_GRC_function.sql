-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valores_guia_grc (nr_seq_lote_hist_p bigint, nr_interno_conta_p bigint, cd_autorizacao_p text, ie_valor_p text) RETURNS bigint AS $body$
DECLARE


/*
VA - Valor a menor
VP - Valor pago
VG - Valor glosado
VR - Valor revertido
VD - Valor da diferença (glosa aceita - saldo original) para glosa maior que o saldo
VM - Valor a maior/adicional
VTP - Valor pago + valor adicional
VPR - Valor pago do recurso
VAC - Valor acatado
*/
vl_retorno_w		double precision;


BEGIN

if (ie_valor_p = 'VA') then

	select	coalesce(sum(b.vl_amenor),0)
	into STRICT	vl_retorno_w
	from	lote_audit_hist_item b,
		lote_audit_hist_guia a
	where	b.nr_seq_guia		= a.nr_sequencia
	and	coalesce(a.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_p,a.cd_autorizacao),'0')
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.nr_seq_lote_hist	= nr_seq_lote_hist_p;

elsif (ie_valor_p = 'VAC') then

	select	coalesce(sum(b.vl_acatado),0)
	into STRICT	vl_retorno_w
	from	lote_audit_hist_item b,
		lote_audit_hist_guia a
	where	b.nr_seq_guia		= a.nr_sequencia
	and	coalesce(a.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_p,a.cd_autorizacao),'0')
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.nr_seq_lote_hist	= nr_seq_lote_hist_p;

elsif (ie_valor_p = 'VP') then

	select	coalesce(sum(b.vl_pago),0)
	into STRICT	vl_retorno_w
	from	lote_audit_hist_item b,
		lote_audit_hist_guia a
	where	b.nr_seq_guia		= a.nr_sequencia
	and	coalesce(a.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_p,a.cd_autorizacao),'0')
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.nr_seq_lote_hist	= nr_seq_lote_hist_p;

elsif (ie_valor_p = 'VG') then

	select	coalesce(sum(b.vl_glosa),0)
	into STRICT	vl_retorno_w
	from	lote_audit_hist_item b,
		lote_audit_hist_guia a
	where	b.nr_seq_guia	= a.nr_sequencia
	and	coalesce(a.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_p,a.cd_autorizacao),'0')
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.nr_seq_lote_hist	= nr_seq_lote_hist_p;

elsif (ie_valor_p = 'VR') then

	select	coalesce(sum(vl_item),0)
	into STRICT	vl_retorno_w
	from (SELECT	coalesce(vl_procedimento,0) * -1 vl_item
		from	procedimento_paciente b,
			conta_paciente a
		where (coalesce(b.nr_doc_convenio::text, '') = '' or b.nr_doc_convenio = coalesce(cd_autorizacao_p,b.nr_doc_convenio))
		and	a.nr_interno_conta		= b.nr_interno_conta
		and	a.ie_cancelamento		= 'E'
		and	a.nr_seq_conta_origem		= coalesce(nr_interno_conta_p,a.nr_interno_conta)
		and	a.nr_seq_audit_hist_glosa	= nr_seq_lote_hist_p
		
union all

		SELECT	coalesce(vl_material,0) * -1 vl_item
		from	material_atend_paciente b,
			conta_paciente a
		where (coalesce(b.nr_doc_convenio::text, '') = '' or b.nr_doc_convenio = coalesce(cd_autorizacao_p,b.nr_doc_convenio))
		and	a.nr_interno_conta		= b.nr_interno_conta
		and	a.ie_cancelamento		= 'E'
		and	a.nr_seq_conta_origem		= coalesce(nr_interno_conta_p,a.nr_interno_conta)
		and	a.nr_seq_audit_hist_glosa	= nr_seq_lote_hist_p) alias13;

elsif (ie_valor_p = 'VD') then

	select	coalesce(sum(b.vl_glosa),0) - coalesce(a.vl_saldo_guia,0)
	into STRICT	vl_retorno_w
	from	lote_audit_hist_item b,
		lote_audit_hist_guia a
	where	a.nr_sequencia		= b.nr_seq_guia
	and	a.vl_saldo_guia		> 0
	and	coalesce(a.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_p,a.cd_autorizacao),'0')
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.nr_seq_lote_hist	= nr_seq_lote_hist_p
	GROUP BY	coalesce(vl_saldo_guia,0);

elsif (ie_valor_p = 'VM' HAVING	sum(b.vl_glosa)		> coalesce(a.vl_saldo_guia,0)
	) then

	select	coalesce(sum(b.vl_adicional),0)
	into STRICT	vl_retorno_w
	from	lote_audit_hist_item b,
		lote_audit_hist_guia a
	where	a.nr_sequencia		= b.nr_seq_guia
  --622834 = Não Informada
	and	coalesce(a.cd_autorizacao, obter_desc_expressao(622834))	= coalesce(coalesce(cd_autorizacao_p,a.cd_autorizacao), obter_desc_expressao(622834))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.nr_seq_lote_hist	= nr_seq_lote_hist_p;

elsif (ie_valor_p = 'VTP') then

	select	coalesce(sum(b.vl_pago),0) + coalesce(sum(b.vl_adicional),0)
	into STRICT	vl_retorno_w
	from	lote_audit_hist_item b,
		lote_audit_hist_guia a
	where	b.nr_seq_guia		= a.nr_sequencia
	and	coalesce(a.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_p,a.cd_autorizacao),'0')
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.nr_seq_lote_hist	= nr_seq_lote_hist_p;

elsif (ie_valor_p = 'VPR') then
	/*Corresponde ao valor pago para a guia após o recurso de glosa.
	Este valor pago é gerado na baixa do retorno convênio de uma guia que foi recursada, gravando a informação na pasta 'Baixa' da GRG.*/
	select	coalesce(sum(b.vl_pago),0)
	into STRICT	vl_retorno_w
	from	lote_audit_hist_guia a,
		lote_audit_hist_baixa b
	where	a.nr_sequencia		= b.nr_seq_guia
	and	a.nr_seq_lote_hist	= nr_seq_lote_hist_p
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.cd_autorizacao	= cd_autorizacao_p
	and	(b.nr_seq_ret_item IS NOT NULL AND b.nr_seq_ret_item::text <> '');

end if;

return vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valores_guia_grc (nr_seq_lote_hist_p bigint, nr_interno_conta_p bigint, cd_autorizacao_p text, ie_valor_p text) FROM PUBLIC;

