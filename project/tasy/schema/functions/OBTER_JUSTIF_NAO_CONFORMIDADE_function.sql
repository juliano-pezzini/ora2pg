-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_justif_nao_conformidade (nr_prescricao_p bigint, ds_tipo_just_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(10000) := '';
ds_erro_compl_w	varchar(255) := '';
ds_justificativa_w	varchar(255) := '';
ds_observacao_w	varchar(255) := '';
ds_orientacao_w	varchar(255) := '';


BEGIN

      if (ds_tipo_just_p = 'ERRO') then
      begin

        SELECT
            		SUBSTR(coalesce(ds_erro,'') || ' ' || coalesce(ds_compl_erro,''),1,255) ds_erro_compl,
            		SUBSTR(a.ds_justificativa,1,255) ds_justificativa,
            		SUBSTR(b.ds_inf_adicional,1,255) ds_observacao,
            		SUBSTR('',1,255) ds_orientacao
        INTO STRICT
            		ds_erro_compl_w,
            		ds_justificativa_w,
            		ds_observacao_w,
            		ds_orientacao_w
        FROM	 prescr_material a,
            		prescr_medica_erro b
        WHERE	    a.nr_prescricao = b.nr_prescricao
        AND	      	b.nr_seq_medic  = a.nr_sequencia
        AND	     	a.nr_prescricao = nr_prescricao_p
        AND	      	a.ie_agrupador  = 1;

      end;
      else if (ds_tipo_just_p = 'RISCO') then
      begin

          SELECT
              		SUBSTR(obter_descricao_padrao('RISCO_MEDICAMENTO','DS_RISCO',nr_seq_risco),1,255) ds_erro_compl,
              		SUBSTR(a.ds_justificativa,1,255) ds_justificativa,
              		SUBSTR(c.ds_observacao,1,255) ds_observacao,
              		SUBSTR(c.ds_orientacao,1,255) ds_orientacao
        INTO STRICT
            		ds_erro_compl_w,
            		ds_justificativa_w,
            		ds_observacao_w,
           		 ds_orientacao_w
          FROM	prescr_material a,
                  	medicamento_risco c
          WHERE	 a.cd_material = c.cd_material
          AND	 a.nr_prescricao = nr_prescricao_p
          AND	 a.ie_agrupador  = 1
          AND	 coalesce(c.ie_nao_conformidade,'N') = 'S'
		  and	 coalesce(c.ie_situacao, 'A') = 'A';

      end;
      end if;
      end if;

      if (ds_orientacao_w <> '') then
      begin
         ds_retorno_w := obter_desc_expressao(322258) || ': '|| ds_orientacao_w || '\n';
      end;
      end if;

      if (ds_erro_compl_w <> '') then
      begin
          ds_retorno_w := obter_desc_expressao(322260) || ': '|| ds_erro_compl_w || '\n';
      end;
      end if;

      if (ds_observacao_w <> '') then
      begin
          ds_retorno_w := obter_desc_expressao(322261) || ': '|| ds_observacao_w || '\n';
      end;
      end if;

      if (ds_justificativa_w <> '') then
      begin
          ds_retorno_w := obter_desc_expressao(322262) || ': '|| ds_justificativa_w || '\n';
      end;
      end if;


return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_justif_nao_conformidade (nr_prescricao_p bigint, ds_tipo_just_p text) FROM PUBLIC;

