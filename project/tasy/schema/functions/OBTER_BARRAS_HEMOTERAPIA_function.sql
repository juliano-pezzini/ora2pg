-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_barras_hemoterapia (nr_seq_doacao_p bigint) RETURNS varchar AS $body$
DECLARE


ds_valor_param_331_w	varchar(255);
ds_valor_param_375_w	varchar(255);
cd_regional_w		varchar(3);
cd_pessoa_fisica_int_w	varchar(7);
cd_pessoa_fisica_w	varchar(7);
cd_doacao_w		varchar(7);
cd_barras_intergracao_w 	varchar(20) := null;
qt_doacao_w		varchar(3);



BEGIN

if (nr_seq_doacao_p IS NOT NULL AND nr_seq_doacao_p::text <> '') then

	ds_valor_param_331_w :=  obter_valor_param_usuario(450, 331, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);
	ds_valor_param_375_w :=  obter_valor_param_usuario(450, 375, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);

	--CÃ³digo Regional
	select	substr(lpad(max(cd_regional), 3,0), 1,3)
	into STRICT	cd_regional_w
	from	san_parametro
	where	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento;

	--paciente
	select	max(cd_pessoa_fisica),
		max(lpad(cd_pessoa_fisica,7,0)),
		max(lpad(nr_sequencia,7,0))
	into STRICT	cd_pessoa_fisica_w,
		cd_pessoa_fisica_int_w,
		cd_doacao_w
	from    	san_doacao
	where   	nr_sequencia = nr_seq_doacao_p;

	--qt_doacao
	select	lpad(count(*),3,0)
	into STRICT	qt_doacao_w
	from    	san_doacao
	where   	cd_pessoa_fisica = cd_pessoa_fisica_w
	and	nr_sequencia <= nr_seq_doacao_p;

	if (ds_valor_param_375_w = 'S') then
		qt_doacao_w	:= lpad(qt_doacao_w + 1,3,0);
	end if;


	if (ds_valor_param_331_w = 'H') then
			begin
				cd_barras_intergracao_w	:= cd_regional_w || cd_pessoa_fisica_w || cd_doacao_w || qt_doacao_w;
			end;
			elsif (ds_valor_param_331_w = 'I') then
			begin
				cd_barras_intergracao_w	:= cd_regional_w || cd_doacao_w || qt_doacao_w;
			end;
			elsif (ds_valor_param_331_w = 'J') then
			begin
				cd_barras_intergracao_w	:= cd_regional_w || cd_pessoa_fisica_w || cd_doacao_w;
			end;
	end if;

end if;

return	cd_barras_intergracao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_barras_hemoterapia (nr_seq_doacao_p bigint) FROM PUBLIC;

