-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_dt_final_bomba_transicao (nr_sequencia_interface_p bigint) RETURNS timestamp AS $body$
DECLARE

dt_final_transicao_w	         bomba_infusao_transicao.dt_transicao%TYPE;

BEGIN

    BEGIN
         SELECT bomba.dt_transicao
           INTO STRICT dt_final_transicao_w
           FROM (SELECT bit.dt_transicao
                   FROM bomba_infusao_transicao bit
                  INNER JOIN bomba_infusao bombas
                     ON bit.nr_seq_bomba_interface = bombas.nr_seq_bomba_interface
                  WHERE bit.nr_seq_bomba_interface = nr_sequencia_interface_p
                    AND bit.ie_status IN ('DS', 'ST', 'IS')
                    AND (bit.qt_volume IS NOT NULL AND bit.qt_volume::text <> '')
                    AND bit.dt_transicao > bombas.dt_bomba_infusao + (1/1440*1)
                  ORDER BY bit.nr_sequencia DESC) bomba LIMIT 1;
    EXCEPTION
        WHEN no_data_found THEN dt_final_transicao_w := clock_timestamp();
    END;

RETURN	dt_final_transicao_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_dt_final_bomba_transicao (nr_sequencia_interface_p bigint) FROM PUBLIC;

