-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nome_medico_combo_agcons ( cd_estabelecimento_p bigint, cd_agenda_p bigint, cd_tipo_agenda_p bigint, ie_opcao_p text, nm_pessoa_agenda_p text default null) RETURNS varchar AS $body$
DECLARE


nm_medico_w				varchar(100);
ds_complemento_w		varchar(60);
nm_guerra_w				varchar(100);
ds_retorno_w			varchar(550);
ds_especialidade_w		varchar(255);
ds_curta_w				varchar(30);
ds_agenda_w				varchar(50);
nr_seq_apresent_w		integer;
ds_setor_agenda_w		varchar(40);
ds_area_atuacao_w		varchar(80);
ie_opcao_w				varchar(80);
/*
							***CUIDAR COM A PERFORMANCE AO ALTERAR ESSA FUNCTION***
>> Observar as restricoes que serao adicionadas no select, evitar adicionar muitas functions, incluir apenas o que for realmente necessario;

*/
BEGIN

if (coalesce(cd_agenda_p,0) > 0) and (coalesce(cd_tipo_agenda_p,0) > 0) then

	select	ds_complemento,
			SUBSTR(CASE WHEN coalesce(a.CD_PESSOA_FISICA::text, '') = '' THEN  null  ELSE CASE WHEN wheb_usuario_pck.get_nr_seq_idioma=1 THEN  coalesce(nm_pessoa_agenda_p, OBTER_NOME_PF(a.CD_PESSOA_FISICA))  ELSE (SELECT NM_PESSOA_FISICA FROM TABLE(search_names_dev(NULL, NULL, (select	max(pf.nr_seq_person_name) from pessoa_fisica pf where pf.cd_pessoa_fisica = a.cd_pessoa_fisica), 'list', 'social,main'))) END  END , 0, 100) nm_medico,
			substr(CASE WHEN coalesce(a.CD_PESSOA_FISICA::text, '') = '' THEN  null  ELSE (SELECT nm_guerra FROM medico x WHERE x.CD_PESSOA_FISICA = a.cd_pessoa_fisica) END ,1,100) nm_guerra,
			substr(CASE WHEN coalesce(a.cd_especialidade::text, '') = '' THEN  obter_especialidades_medico(a.cd_pessoa_fisica)  ELSE (select max(d.ds_especialidade) from especialidade_medica d where d.cd_especialidade = a.cd_especialidade) END ,1,255) ds_especialidade,
			ds_curta,
			coalesce(nr_seq_apresent,0),
			ds_agenda,
			substr((select max(s.ds_setor_atendimento) from setor_atendimento s where s.cd_setor_atendimento = a.cd_setor_agenda),1,40) ds_setor,
			substr((select max(f.ds_area_atuacao) from area_atuacao_medica f where f.nr_sequencia = a.nr_seq_area_atuacao),1,80) ds_area_atuacao,
			coalesce(CASE WHEN coalesce(ie_opcao_p,'N')='N' THEN ie_ordenacao  ELSE ie_opcao_p END ,'N')
	into STRICT	ds_complemento_w,
			nm_medico_w,
			nm_guerra_w,
			ds_especialidade_w,
			ds_curta_w,
			nr_seq_apresent_w,
			ds_agenda_w,
			ds_setor_agenda_w,
			ds_area_atuacao_w,
			ie_opcao_w
	from	agenda a
	where	a.cd_agenda		= cd_agenda_p
	and		a.cd_tipo_agenda		= cd_tipo_agenda_p  LIMIT 1;

	if (ie_opcao_w = 'GC') then
		if (ds_complemento_w IS NOT NULL AND ds_complemento_w::text <> '') then
			ds_retorno_w := nm_guerra_w || ' - ' || ds_complemento_w;
		else
			ds_retorno_w := nm_guerra_w;
		end if;
	elsif (ie_opcao_w = 'N') then
		if (ds_complemento_w IS NOT NULL AND ds_complemento_w::text <> '') then
			ds_retorno_w := nm_medico_w || ' - ' || ds_complemento_w || ' ' || ds_especialidade_w;
		elsif (coalesce(ds_complemento_w::text, '') = '') and (ds_especialidade_w IS NOT NULL AND ds_especialidade_w::text <> '') then
			ds_retorno_w := nm_medico_w || ' - ' || ds_especialidade_w;
		else
			ds_retorno_w := nm_medico_w;
		end if;
	elsif (ie_opcao_w = 'S') then
		ds_retorno_w := nm_guerra_w;
	elsif (ie_opcao_w = 'SDP') then
		begin
		if (nr_seq_apresent_w IS NOT NULL AND nr_seq_apresent_w::text <> '') then
			ds_retorno_w := lpad(nr_seq_apresent_w,4,'0') || ' - ' || ds_curta_w || ' - ' || nm_medico_w;
		elsif (ds_curta_w IS NOT NULL AND ds_curta_w::text <> '') then
			ds_retorno_w := ds_curta_w || ' - ' || nm_medico_w;
		else
			ds_retorno_w :=nm_medico_w;
		end if;
		end;
	elsif (ie_opcao_w = 'SD') then
		begin
		if (nr_seq_apresent_w IS NOT NULL AND nr_seq_apresent_w::text <> '') then
			ds_retorno_w := lpad(nr_seq_apresent_w,4,'0') || ' - ' || ds_curta_w;
		elsif (ds_curta_w IS NOT NULL AND ds_curta_w::text <> '') then
			ds_retorno_w := ds_curta_w;
		end if;
		end;
	elsif (ie_opcao_w = 'CEP') then
		begin
		if (ds_complemento_w IS NOT NULL AND ds_complemento_w::text <> '') then
			ds_retorno_w := ds_complemento_w || ' - ' || ds_especialidade_w || ' - ' || nm_medico_w;
		elsif (coalesce(ds_complemento_w::text, '') = '') and (ds_especialidade_w IS NOT NULL AND ds_especialidade_w::text <> '') then
			ds_retorno_w := ds_especialidade_w || ' - ' || nm_medico_w;
		else
			ds_retorno_w := nm_medico_w;
		end if;
		end;
	elsif (ie_opcao_w = 'EPC') then
		begin
		if (ds_especialidade_w IS NOT NULL AND ds_especialidade_w::text <> '') then
			ds_retorno_w := ds_especialidade_w || ' - ' || nm_medico_w || ' - ' || ds_complemento_w;
		elsif (coalesce(ds_especialidade_w::text, '') = '') and (ds_complemento_w IS NOT NULL AND ds_complemento_w::text <> '') then
			ds_retorno_w := nm_medico_w || ' - ' || ds_complemento_w;
		else
			ds_retorno_w := nm_medico_w;
		end if;
		end;
	elsif (ie_opcao_w = 'PEC') then
		begin
		if (nm_medico_w IS NOT NULL AND nm_medico_w::text <> '') then
			ds_retorno_w := nm_medico_w || ' - ' || ds_especialidade_w || ' - ' || ds_complemento_w;
		elsif (coalesce(nm_medico_w::text, '') = '') and (ds_especialidade_w IS NOT NULL AND ds_especialidade_w::text <> '') then
			ds_retorno_w := ds_especialidade_w || ' - ' || ds_complemento_w;
		else
			ds_retorno_w := ds_complemento_w;
		end if;
		end;
	elsif (ie_opcao_w = 'DC') then
		begin
		if (ds_curta_w IS NOT NULL AND ds_curta_w::text <> '') then
			ds_retorno_w := ds_curta_w || ' - ' || ds_complemento_w;
		elsif (ds_complemento_w IS NOT NULL AND ds_complemento_w::text <> '') then
			ds_retorno_w := ds_complemento_w;
		end if;
		end;		
	elsif (ie_opcao_w = 'EDC') then
		begin
		ds_retorno_w := '';
		if (ds_especialidade_w IS NOT NULL AND ds_especialidade_w::text <> '') then
			ds_retorno_w := ds_retorno_w || ds_especialidade_w;
		end if;
		if (ds_curta_w IS NOT NULL AND ds_curta_w::text <> '') then
			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
				ds_retorno_w := ds_retorno_w || ' - ';
			end if;
			ds_retorno_w := ds_retorno_w || ds_curta_w;
		end if;
		if (ds_complemento_w IS NOT NULL AND ds_complemento_w::text <> '') then
			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
				ds_retorno_w := ds_retorno_w || ' - ';
			end if;
			ds_retorno_w := ds_retorno_w || ds_complemento_w;
		end if;
		end;
	elsif (ie_opcao_w = 'DP') then
		begin
			ds_retorno_w := '';
			if (ds_curta_w IS NOT NULL AND ds_curta_w::text <> '') then
				ds_retorno_w := ds_retorno_w || ds_curta_w;
			end if;
			
			if (nm_medico_w IS NOT NULL AND nm_medico_w::text <> '') then
				if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
					ds_retorno_w := ds_retorno_w || ' - ';
				end if;
				ds_retorno_w := ds_retorno_w || nm_medico_w;
			end if;
		end;
	elsif (ie_opcao_w = 'DPC') then
		begin
		ds_retorno_w := '';
		if (ds_curta_w IS NOT NULL AND ds_curta_w::text <> '') then
			ds_retorno_w := ds_retorno_w || ds_curta_w;
		end if;
		
		if (nm_medico_w IS NOT NULL AND nm_medico_w::text <> '') then
			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
				ds_retorno_w := ds_retorno_w || ' - ';
			end if;
			ds_retorno_w := ds_retorno_w || nm_medico_w;
		end if;
		
		if (ds_complemento_w IS NOT NULL AND ds_complemento_w::text <> '') then
			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := ds_retorno_w || ' - ';
			end if;
			ds_retorno_w := ds_retorno_w || ds_complemento_w;
		end if;
		end;
	elsif (ie_opcao_w = 'SPE') then
		begin
		ds_retorno_w := '';
		if (ds_setor_agenda_w IS NOT NULL AND ds_setor_agenda_w::text <> '') then
			ds_retorno_w := ds_setor_agenda_w || ' - ' || nm_medico_w || ' - ' || ds_especialidade_w;
		elsif (coalesce(ds_setor_agenda_w::text, '') = '') and (ds_especialidade_w IS NOT NULL AND ds_especialidade_w::text <> '') then
			ds_retorno_w := nm_medico_w || ' - ' || ds_especialidade_w;
		else
			ds_retorno_w := nm_medico_w;
		end if;
		end;
	elsif (ie_opcao_w = 'DCA') then
		ds_retorno_w := '';
		if (ds_curta_w IS NOT NULL AND ds_curta_w::text <> '') then
			ds_retorno_w := ds_retorno_w || ds_curta_w;
		end if;
		
		if (ds_complemento_w IS NOT NULL AND ds_complemento_w::text <> '') then
			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := ds_retorno_w || ' - ';
			end if;
			ds_retorno_w := ds_retorno_w || ds_complemento_w;
		end if;
		
		if (ds_area_atuacao_w IS NOT NULL AND ds_area_atuacao_w::text <> '') then
			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := ds_retorno_w || ' - ';
			end if;
			ds_retorno_w := ds_retorno_w || ds_area_atuacao_w;
		end if;
	elsif (ie_opcao_w = 'DA') then
		ds_retorno_w := '';
		if (ds_curta_w IS NOT NULL AND ds_curta_w::text <> '') then
			ds_retorno_w := ds_retorno_w || ds_curta_w;
		end if;
		
		if (ds_area_atuacao_w IS NOT NULL AND ds_area_atuacao_w::text <> '') then
			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := ds_retorno_w || ' - ';
			end if;
			ds_retorno_w := ds_retorno_w || ds_area_atuacao_w;
		end if;
	elsif (ie_opcao_w = 'PEA') then
		ds_retorno_w := '';
		
		if (nm_medico_w IS NOT NULL AND nm_medico_w::text <> '') then
			ds_retorno_w := ds_retorno_w || nm_medico_w;
		end if;
		
		if (ds_especialidade_w IS NOT NULL AND ds_especialidade_w::text <> '') then
			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
				ds_retorno_w := ds_retorno_w || ' - ';
			end if;
			ds_retorno_w := ds_retorno_w || ds_especialidade_w;
		end if;
		
		if (ds_area_atuacao_w IS NOT NULL AND ds_area_atuacao_w::text <> '') then
			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := ds_retorno_w || ' - ';
			end if;
			ds_retorno_w := ds_retorno_w || ds_area_atuacao_w;
		end if;
	elsif (ie_opcao_w = 'PA') then
		ds_retorno_w := '';
		if (nm_medico_w IS NOT NULL AND nm_medico_w::text <> '') then
			ds_retorno_w := ds_retorno_w || nm_medico_w;
		end if;
		
		if (ds_area_atuacao_w IS NOT NULL AND ds_area_atuacao_w::text <> '') then
			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
				ds_retorno_w := ds_retorno_w || ' - ';
			end if;
			ds_retorno_w := ds_retorno_w || ds_area_atuacao_w;
		end if;
	elsif (ie_opcao_w = 'PD') then
		begin
			ds_retorno_w := '';
			if (nm_medico_w IS NOT NULL AND nm_medico_w::text <> '') then
				ds_retorno_w := nm_medico_w;
			end if;
			
			if (ds_curta_w IS NOT NULL AND ds_curta_w::text <> '') then
				if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
					ds_retorno_w := ds_retorno_w || ' - ';
				end if;
				ds_retorno_w := ds_retorno_w || ds_curta_w;
			end if;
		end;
	end if;

	if (coalesce(ds_retorno_w::text, '') = '') then
		ds_retorno_w := ds_agenda_w;
	end if;	
	
	if (cd_tipo_agenda_p = 4) then
		ds_retorno_w := ds_curta_w;
	end if;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nome_medico_combo_agcons ( cd_estabelecimento_p bigint, cd_agenda_p bigint, cd_tipo_agenda_p bigint, ie_opcao_p text, nm_pessoa_agenda_p text default null) FROM PUBLIC;

