-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_situacao_exame ( CD_ESTABELECIMENTO_P bigint, IE_STATUS_EXECUCAO_P bigint, NR_PRESCRICAO_P bigint, NR_SEQ_PRESCRICAO_P bigint, NR_SEQ_SITUACAO_PROC_P bigint, IE_EXAME_TRAZIDO_P text, IE_EXAME_ANTERIOR_P text, IE_EXAME_IMPORTANTE_P text, IE_EXAME_IMPORTADO_P text, IE_EXAME_COMPLEMENTAR_P text, CD_ESPECIALIDADE_P bigint) RETURNS bigint AS $body$
DECLARE

				
nr_sequencia_w		bigint := 0;


BEGIN

select	se.nr_sequencia
into STRICT	nr_sequencia_w
from	situacao_exame se
inner join regra_situacao_exame rse ON (se.NR_SEQUENCIA = rse.NR_SEQ_SITUACAO_EXAME)
where	rse.CD_ESTABELECIMENTO = CD_ESTABELECIMENTO_P
and     ((rse.IE_STATUS_EXECUCAO = IE_STATUS_EXECUCAO_P) or (coalesce(rse.IE_STATUS_EXECUCAO::text, '') = '' and coalesce(IE_STATUS_EXECUCAO_P::text, '') = ''))
and     ((rse.IE_LISTA_CENTRAL_MEDICA = 'S' and (SELECT count(1) FROM lista_central_exame lce INNER JOIN lista_central_medico lcm ON lce.nr_seq_lista_medico = lcm.nr_sequencia WHERE lce.nr_prescricao = NR_PRESCRICAO_P AND lce.nr_sequencia_prescricao = NR_SEQ_PRESCRICAO_P) > 0)
		or (rse.IE_LISTA_CENTRAL_MEDICA = 'N' and (SELECT count(1) FROM lista_central_exame lce INNER JOIN lista_central_medico lcm ON lce.nr_seq_lista_medico = lcm.nr_sequencia WHERE lce.nr_prescricao = NR_PRESCRICAO_P AND lce.nr_sequencia_prescricao = NR_SEQ_PRESCRICAO_P) = 0))
and     ((rse.NR_SEQ_SITUACAO_PROC = NR_SEQ_SITUACAO_PROC_P) or (coalesce(rse.NR_SEQ_SITUACAO_PROC::text, '') = '' and coalesce(NR_SEQ_SITUACAO_PROC_P::text, '') = ''))
and     ((rse.IE_EXAME_TRAZIDO = IE_EXAME_TRAZIDO_P) or (coalesce(rse.IE_EXAME_TRAZIDO::text, '') = ''))
and     ((rse.IE_EXAME_ANTERIOR = IE_EXAME_ANTERIOR_P) or (coalesce(rse.IE_EXAME_ANTERIOR::text, '') = ''))
and     ((rse.IE_EXAME_IMPORTANTE = IE_EXAME_IMPORTANTE_P) or (coalesce(rse.IE_EXAME_IMPORTANTE::text, '') = ''))
and     ((rse.IE_EXAME_IMPORTADO = IE_EXAME_IMPORTADO_P) or (coalesce(rse.IE_EXAME_IMPORTADO::text, '') = ''))
and     ((rse.IE_EXAME_COMPLEMENTAR = IE_EXAME_COMPLEMENTAR_P) or (coalesce(rse.IE_EXAME_COMPLEMENTAR::text, '') = ''))
and     ((coalesce(rse.CD_MEDICO_PREFERENCIAL::text, '') = '') or (rse.CD_MEDICO_PREFERENCIAL in (select CD_PESSOA_FISICA from prescr_proc_laudo_pref where nr_prescricao = NR_PRESCRICAO_P and nr_seq_prescricao = NR_SEQ_PRESCRICAO_P)))
and     ((rse.CD_ESPECIALIDADE = CD_ESPECIALIDADE_P) or (coalesce(rse.CD_ESPECIALIDADE::text, '') = '' and coalesce(CD_ESPECIALIDADE_P::text, '') = ''));


return	nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_situacao_exame ( CD_ESTABELECIMENTO_P bigint, IE_STATUS_EXECUCAO_P bigint, NR_PRESCRICAO_P bigint, NR_SEQ_PRESCRICAO_P bigint, NR_SEQ_SITUACAO_PROC_P bigint, IE_EXAME_TRAZIDO_P text, IE_EXAME_ANTERIOR_P text, IE_EXAME_IMPORTANTE_P text, IE_EXAME_IMPORTADO_P text, IE_EXAME_COMPLEMENTAR_P text, CD_ESPECIALIDADE_P bigint) FROM PUBLIC;

