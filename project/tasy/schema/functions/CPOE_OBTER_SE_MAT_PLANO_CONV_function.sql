-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_se_mat_plano_conv ( nr_atendimento_p bigint, cd_material_p bigint, cd_setor_atendimento_p bigint, cd_convenio_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
cd_plano_convenio_w			varchar(10);							
qt_material_w				double precision;	
ie_retorno_w				varchar(15) := 'S';
ie_consiste_glosa_conv_w	varchar(15);
ie_erro_autorizacao_w		varchar(255);
ie_bloqueia_agenda_w		varchar(1);
ie_regra_plano_w			smallint;
nr_seq_regra_plano_w		bigint;

BEGIN
 
select	coalesce(ie_consiste_glosa_conv,'N') 
into STRICT	ie_consiste_glosa_conv_w 
from	parametro_medico 
where	coalesce(cd_estabelecimento,cd_estabelecimento_p) = cd_estabelecimento_p;
 
if (ie_consiste_glosa_conv_w <> 'N') then 
 
	qt_material_w := 1;
	cd_plano_convenio_w := substr(obter_dados_categ_conv(nr_atendimento_p,'P'),1,10);
	 
	SELECT * FROM consiste_mat_plano_convenio( 
						coalesce(cd_convenio_p,0), coalesce(cd_plano_convenio_w,'0'), cd_material_p, nr_atendimento_p, cd_setor_atendimento_p, ie_erro_autorizacao_w, ie_bloqueia_agenda_w, ie_regra_plano_w, nr_seq_regra_plano_w, qt_material_w, clock_timestamp(), null, cd_estabelecimento_p, null, null) INTO STRICT ie_erro_autorizacao_w, ie_bloqueia_agenda_w, ie_regra_plano_w, nr_seq_regra_plano_w;		
 
		if	((ie_erro_autorizacao_w IS NOT NULL AND ie_erro_autorizacao_w::text <> '') or (ie_regra_plano_w = 7)) then 
			if (ie_regra_plano_w in (1,2,7)) then 
					ie_retorno_w	:= ie_consiste_glosa_conv_w;
			end if;			
		end if;
			 
end if;
 
return coalesce(ie_retorno_w,'S');
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_se_mat_plano_conv ( nr_atendimento_p bigint, cd_material_p bigint, cd_setor_atendimento_p bigint, cd_convenio_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

