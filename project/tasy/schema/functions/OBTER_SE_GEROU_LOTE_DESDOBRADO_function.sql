-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_gerou_lote_desdobrado (nr_sequencia_nf_p bigint, nr_item_nf_p bigint, cd_material_p bigint, ie_nota_compra_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ie_gerou_desdobrado_w	varchar(1) := 'N';
cd_material_w		bigint;
ie_gera_w		varchar(1);
ie_quantidade_w		varchar(1);
ie_gerar_desdobrado_w	varchar(1);
qt_lotes_gerados_w	bigint;
ie_estoque_lote_w	varchar(1);
ie_acao_nf_w		varchar(1);
nr_sequencia_ref_w	bigint;
nr_sequencia_w		bigint;
ie_devolucao_w		varchar(1);
nr_seq_marca_w		bigint;
ie_agrupar_lote_w	regra_nf_lote_fornec.ie_agrupar_lote%type;
	

BEGIN

select	max(ie_acao_nf),
	max(nr_sequencia_ref)
into STRICT	ie_acao_nf_w,
	nr_sequencia_ref_w
from	nota_fiscal
where	nr_sequencia = nr_sequencia_nf_p;

select	a.ie_devolucao
into STRICT	ie_devolucao_w
from	operacao_nota a,
	nota_fiscal b
where	b.nr_sequencia    	= nr_sequencia_nf_p
and	b.cd_operacao_nf     	= a.cd_operacao_nf;

select	max(nr_seq_marca)
into STRICT	nr_seq_marca_w
from	nota_fiscal_item
where	nr_sequencia = nr_sequencia_nf_p
and	nr_item_nf = nr_item_nf_p;

if (ie_acao_nf_w = '2') then
	nr_sequencia_w := nr_sequencia_ref_w;
else
	if (ie_devolucao_w = 'S') and (nr_sequencia_ref_w IS NOT NULL AND nr_sequencia_ref_w::text <> '') then
		nr_sequencia_w := nr_sequencia_ref_w;
	else
		nr_sequencia_w := nr_sequencia_nf_p;
	end if;
end if;

if (ie_nota_compra_p = 6) then
	SELECT * FROM obter_regra_nf_lote_fornec(	cd_material_p, cd_estabelecimento_p, ie_gera_w, ie_quantidade_w, ie_gerar_desdobrado_w, ie_agrupar_lote_w, nr_seq_marca_w) INTO STRICT ie_gera_w, ie_quantidade_w, ie_gerar_desdobrado_w, ie_agrupar_lote_w;
	
	select	ie_estoque_lote
	into STRICT	ie_estoque_lote_w
	from	material_estab
	where	cd_material = cd_material_p
	and	cd_estabelecimento = cd_estabelecimento_p;

	if (ie_gera_w = 'S') and (ie_gerar_desdobrado_w = 'S') and (ie_estoque_lote_w = 'S') then
		
		select	count(*)
		into STRICT	qt_lotes_gerados_w
		from	material_lote_fornec
		where	nr_sequencia_nf = nr_sequencia_w
		and	nr_item_nf = nr_item_nf_p
		and	cd_material = cd_material_p;
		
		if (qt_lotes_gerados_w > 0) then
			ie_gerou_desdobrado_w := 'S';
		end if;
	end if;
end if;
				
return	ie_gerou_desdobrado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_gerou_lote_desdobrado (nr_sequencia_nf_p bigint, nr_item_nf_p bigint, cd_material_p bigint, ie_nota_compra_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

