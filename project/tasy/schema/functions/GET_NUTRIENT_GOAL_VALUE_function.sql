-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_nutrient_goal_value ( ie_nutriente text, nr_atendimento_p bigint, dt_meta_p timestamp, ie_meta_p text, ie_tipo_meta_p text ) RETURNS bigint AS $body$
DECLARE


nr_seq_goal_w bigint;
vl_meta_result_w bigint;
vl_meta_min_w bigint;
vl_meta_max_w bigint;


BEGIN

    select max(b.nr_sequencia)
    into STRICT nr_seq_goal_w
    from nutrition_intake_goals b
    where b.nr_atendimento = nr_atendimento_p and b.DT_META <= dt_meta_p;

    SELECT coalesce(max(qt_meta_max),0), coalesce(max(qt_meta_min),0)
    INTO STRICT   vl_meta_max_w, vl_meta_min_w
    FROM nutrition_intake_goals ni
    INNER JOIN NUTRITION_INTAKE_GOAL_ITEM NIM ON (NIM.NR_SEQ_GOAL = NI.NR_SEQUENCIA)
    WHERE ni.NR_SEQUENCIA = nr_seq_goal_w
    and NIM.IE_TIPO_NUTRIENTE = ie_nutriente and NIM.IE_TIPO_META = ie_tipo_meta_p;

  if (ie_meta_p = 'MX') then
    if (vl_meta_max_w = 0) then
      vl_meta_result_w := null;
    else
      vl_meta_result_w := vl_meta_max_w;
    end if;
  end if;

  if (ie_meta_p = 'MG') then
    if (vl_meta_min_w = 0) then
      vl_meta_result_w := null;
    else
      vl_meta_result_w := vl_meta_min_w;
    end if;
  end if;

  RETURN vl_meta_result_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_nutrient_goal_value ( ie_nutriente text, nr_atendimento_p bigint, dt_meta_p timestamp, ie_meta_p text, ie_tipo_meta_p text ) FROM PUBLIC;

