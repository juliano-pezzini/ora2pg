-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_vl_producao_prest ( nr_seq_pagamento_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/* ie_opcao_p
T - Valor total
P - Valor de procedimentos e materiais
E - Valor de eventos
EN - Valor de eventos negativos
EP - Valor de eventos positivos
L - Valor líquido
PNN - Valor de procedimentos e materiais (Pagamento novo)
EPN - Valor de eventos positivos (Pagamento novo)
ENN - Valor de eventos negativos (Pagamento novo)
LNN - Valor líquido (Pagamento novo) */
vl_pagamento_w		double precision;


BEGIN

if (ie_opcao_p = 'T') then
	select	vl_pagamento
	into STRICT	vl_pagamento_w
	from	pls_pagamento_prestador
	where	nr_sequencia = nr_seq_pagamento_p;

elsif (ie_opcao_p = 'P') then
	select	sum(b.vl_item)
	into STRICT	vl_pagamento_w
	from	pls_pagamento_item	b,
		pls_pagamento_prestador	a
	where	b.nr_seq_pagamento	= a.nr_sequencia
	and	a.nr_sequencia		= nr_seq_pagamento_p
	and not exists (	SELECT	1
				from	pls_evento_movimento	x
				where	x.nr_seq_lote_pgto	= a.nr_seq_lote
				and	x.nr_seq_evento		= b.nr_seq_evento
				and	a.nr_seq_prestador	= x.nr_seq_prestador);

elsif (ie_opcao_p = 'E') then
	select	sum(b.vl_item)
	into STRICT	vl_pagamento_w
	from	pls_pagamento_item	b,
		pls_pagamento_prestador	a
	where	b.nr_seq_pagamento	= a.nr_sequencia
	and	a.nr_sequencia		= nr_seq_pagamento_p
	and exists (	SELECT	1
			from	pls_evento_movimento	x
			where	x.nr_seq_lote_pgto	= a.nr_seq_lote
			and	x.nr_seq_evento		= b.nr_seq_evento
			and	a.nr_seq_prestador	= x.nr_seq_prestador);

elsif (ie_opcao_p = 'EN') then
	select	sum(CASE WHEN sign(b.vl_item)=1 THEN  0  ELSE b.vl_item END )
	into STRICT	vl_pagamento_w
	from	pls_pagamento_item	b,
		pls_pagamento_prestador	a
	where	b.nr_seq_pagamento	= a.nr_sequencia
	and	a.nr_sequencia		= nr_seq_pagamento_p
	and exists (	SELECT	1
			from	pls_evento_movimento	x
			where	x.nr_seq_lote_pgto	= a.nr_seq_lote
			and	x.nr_seq_evento		= b.nr_seq_evento
			and	a.nr_seq_prestador	= x.nr_seq_prestador);

elsif (ie_opcao_p = 'EP') then
	select	sum(CASE WHEN sign(b.vl_item)=-1 THEN  0  ELSE b.vl_item END )
	into STRICT	vl_pagamento_w
	from	pls_pagamento_item	b,
		pls_pagamento_prestador	a
	where	b.nr_seq_pagamento	= a.nr_sequencia
	and	a.nr_sequencia		= nr_seq_pagamento_p
	and exists (	SELECT	1
			from	pls_evento_movimento	x
			where	x.nr_seq_lote_pgto	= a.nr_seq_lote
			and	x.nr_seq_evento		= b.nr_seq_evento
			and	a.nr_seq_prestador	= x.nr_seq_prestador);

elsif (ie_opcao_p = 'L') then
	select	sum(b.vl_liquido)
	into STRICT	vl_pagamento_w
	from	pls_pag_prest_vencimento	b,
		pls_pagamento_prestador		a
	where	b.nr_seq_pag_prestador		= a.nr_sequencia
	and	a.nr_sequencia			= nr_seq_pagamento_p;

elsif (ie_opcao_p = 'PNN') then
	select	sum(b.vl_item)
	into STRICT	vl_pagamento_w
	from	pls_pp_prest_evento_valor	b,
		pls_pp_prestador		a
	where	a.nr_seq_lote			= b.nr_seq_lote
	and	a.nr_seq_prestador		= b.nr_seq_prestador
	and	a.nr_sequencia			= nr_seq_pagamento_p
	and exists (	SELECT	1
			from	pls_pp_item_lote 	i
			where	i.nr_seq_lote		= b.nr_seq_lote
			and	i.nr_seq_evento		= b.nr_seq_evento
			and	i.nr_seq_prestador	= b.nr_seq_prestador
			and	i.ie_tipo_item in (2,3,4,5,6,7,10));

elsif (ie_opcao_p = 'EPN') then
	select	sum(CASE WHEN sign(b.vl_item)=-1 THEN  0  ELSE b.vl_item END )
	into STRICT	vl_pagamento_w
	from	pls_pp_prest_evento_valor	b,
		pls_pp_prestador		a
	where	a.nr_seq_lote			= b.nr_seq_lote
	and	a.nr_seq_prestador		= b.nr_seq_prestador
	and	a.nr_sequencia			= nr_seq_pagamento_p
	and exists (	SELECT	1
			from	pls_pp_item_lote 	i
			where	i.nr_seq_lote		= b.nr_seq_lote
			and	i.nr_seq_evento		= b.nr_seq_evento
			and	i.nr_seq_prestador	= b.nr_seq_prestador
			and	i.ie_tipo_item in (2,3,4,5,6,7,10));

elsif (ie_opcao_p = 'ENN') then
	select	sum(CASE WHEN sign(b.vl_item)=1 THEN  0  ELSE b.vl_item END )
	into STRICT	vl_pagamento_w
	from	pls_pp_prest_evento_valor	b,
		pls_pp_prestador		a
	where	a.nr_seq_lote			= b.nr_seq_lote
	and	a.nr_seq_prestador		= b.nr_seq_prestador
	and	a.nr_sequencia			= nr_seq_pagamento_p
	and exists (	SELECT	1
			from	pls_pp_item_lote 	i
			where	i.nr_seq_lote		= b.nr_seq_lote
			and	i.nr_seq_evento		= b.nr_seq_evento
			and	i.nr_seq_prestador	= b.nr_seq_prestador
			and	i.ie_tipo_item in (2,3,4,5,6,7,10));
end if;

return	coalesce(vl_pagamento_w, 0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_vl_producao_prest ( nr_seq_pagamento_p bigint, ie_opcao_p text) FROM PUBLIC;

