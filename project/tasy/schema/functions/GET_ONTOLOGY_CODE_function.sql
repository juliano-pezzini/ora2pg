-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_ontology_code ( cd_seq_record_p text, ie_group_p text, ds_type_p text ) RETURNS varchar AS $body$
DECLARE

    cd_ontology_w res_cadastro_ontologia_phi.cd_valor_ontologia%TYPE;

BEGIN
    IF ds_type_p = 'GROUP' THEN
        SELECT
            phi.cd_valor_ontologia
        INTO STRICT cd_ontology_w
        FROM
            res_cadastro_ontologia_phi   phi
            INNER JOIN valor_dominio_v              vd ON vd.ds_valor_dominio = phi.nm_atributo
        WHERE
            vd.vl_dominio = ie_group_p
            AND phi.ie_ontologia = 'SNO'
            AND phi.nm_tabela = 'ONTOLOGIA_LISTA_W'
            AND phi.nm_atributo = 'null'
            AND coalesce(phi.nr_seq_atrib_grupo::text, '') = ''
            AND coalesce(phi.cd_valor_tasy::text, '') = ''  LIMIT 1;

    ELSIF ds_type_p = 'TABLE' THEN
        SELECT DISTINCT
            phi.cd_valor_ontologia
        INTO STRICT cd_ontology_w
        FROM
            res_cadastro_ontologia_phi   phi
            INNER JOIN ontologia_tabela             ot ON phi.nm_tabela = ot.nm_tabela
        WHERE
            ot.nr_sequencia = (cd_seq_record_p)::numeric
            AND ie_ontologia = 'SNO'
            AND phi.nm_atributo = 'null'
            AND coalesce(phi.nr_seq_atrib_grupo::text, '') = ''
            AND coalesce(phi.cd_valor_tasy::text, '') = '';

    ELSIF ds_type_p = 'ATTRIBUTE_GROUP' THEN
        SELECT
            phi.cd_valor_ontologia
        INTO STRICT cd_ontology_w
        FROM
            res_cadastro_ontologia_phi   phi
            INNER JOIN ontologia_tabela_atributo    ota ON phi.nm_tabela = ota.nm_tabela
                                                        AND phi.nm_atributo = ota.nm_atributo
            INNER JOIN ontologia_tabela             ot ON ot.nm_tabela = ota.nm_tabela
            INNER JOIN ontologia_tab_atrib_grupo    otag ON otag.nr_sequencia = ota.nr_seq_ontolo_tab_atrib_grupo
        WHERE
            otag.nr_sequencia = (cd_seq_record_p)::numeric
            AND phi.ie_ontologia = 'SNO'
            AND (phi.nm_tabela IS NOT NULL AND phi.nm_tabela::text <> '')
            AND phi.nm_atributo = 'null'
            AND coalesce(phi.cd_valor_tasy::text, '') = ''  LIMIT 1;

    ELSE
        SELECT
            phi.cd_valor_ontologia
        INTO STRICT cd_ontology_w
        FROM
            res_cadastro_ontologia_phi   phi
            INNER JOIN ontologia_tabela_atributo    ota ON phi.nm_tabela = ota.nm_tabela
                                                        AND phi.nm_atributo = ota.nm_atributo
            INNER JOIN ontologia_tabela             ot ON ot.nm_tabela = ota.nm_tabela
        WHERE
            ota.nr_sequencia = (cd_seq_record_p)::numeric
            AND phi.ie_ontologia = 'SNO'
            AND coalesce(phi.cd_valor_tasy::text, '') = ''  LIMIT 1;

    END IF;

    RETURN cd_ontology_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_ontology_code ( cd_seq_record_p text, ie_group_p text, ds_type_p text ) FROM PUBLIC;

