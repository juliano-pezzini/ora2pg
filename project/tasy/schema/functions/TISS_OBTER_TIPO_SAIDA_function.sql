-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tiss_obter_tipo_saida (ie_tipo_guia_p text, nr_interno_conta_p bigint) RETURNS varchar AS $body$
DECLARE


/*
ie_tipo_guia_p

'C' - guia de consulta
'SPSADT' - guia de spsadt
'I' - guia de internação

*/
cd_tipo_saida_w			varchar(20)	:= '';
nr_seq_saida_consulta_w		bigint;
nr_seq_saida_int_w		bigint;
nr_seq_saida_spsadt_w		bigint;
ds_versao_w			varchar(20);
ie_obito_w			varchar(1);


BEGIN

if (coalesce(nr_interno_conta_p,0) > 0) then

	select	max(a.nr_seq_saida_consulta),
		max(coalesce(a.nr_seq_saida_int, b.nr_seq_saida_int)),
		max(a.nr_seq_saida_spsadt),
		max(tiss_obter_versao(a.cd_convenio_parametro,a.cd_estabelecimento,a.dt_mesano_referencia))
	into STRICT	nr_seq_saida_consulta_w,
		nr_seq_saida_int_w,
		nr_seq_saida_spsadt_w,
		ds_versao_w
	from	tiss_parametros_convenio b,
		conta_paciente a
	where	a.nr_interno_conta	= nr_interno_conta_p
	and	a.cd_estabelecimento	= b.cd_estabelecimento
	and	a.cd_convenio_parametro	= b.cd_convenio;
	
	if (ie_tipo_guia_p = 'C') and (coalesce(nr_seq_saida_consulta_w,0) > 0) then

		select	cd_tipo_saida
		into STRICT	cd_tipo_saida_w
		from	tiss_tipo_saida_consulta
		where	nr_sequencia	= nr_seq_saida_consulta_w;


	elsif (ie_tipo_guia_p = 'SPSADT') and (coalesce(nr_seq_saida_spsadt_w,0) > 0) then
	
		select	cd_tipo_saida
		into STRICT	cd_tipo_saida_w
		from	tiss_tipo_saida_spsadt
		where	nr_sequencia	= nr_seq_saida_spsadt_w;
		
		select	max(c.ie_obito)
		into STRICT	ie_obito_w
		from	motivo_alta c,
			atendimento_paciente b,
			conta_paciente a
		where	a.nr_atendimento	= b.nr_atendimento
		and	b.cd_motivo_alta	= c.cd_motivo_alta
		and	a.nr_interno_conta	= nr_interno_conta_p;
				
		if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S') and (coalesce(ie_obito_w,'N') = 'N') then --Na versão 3.00.01 e superiores, somente deve ser preenchido tipo de saída em caso de óbito
			cd_tipo_saida_w	:= null;
		end if;
	
	elsif (ie_tipo_guia_p = 'I') and (coalesce(nr_seq_saida_int_w,0) > 0) then

		select	cd_motivo
		into STRICT	cd_tipo_saida_w
		from	tiss_motivo_saida_int
		where	nr_sequencia	= nr_seq_saida_int_w;

	end if;
end if;

return	cd_tipo_saida_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_obter_tipo_saida (ie_tipo_guia_p text, nr_interno_conta_p bigint) FROM PUBLIC;

