-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_recalcula_horarios_md ( dt_referencia_p timestamp, ie_operacao_p text, dt_fim_p timestamp, ds_horarios_p INOUT text ) AS $body$
DECLARE

    ds_retorno_w	varchar(4000) := '';
    ds_hora_w       varchar(255) := '';
    dt_horario_w	timestamp;
    i_pos_w			integer;
    qt_dia_adic_w	integer := 0;
    qt_pertence_w	integer;

BEGIN
    if (ie_operacao_p  not in ('F', 'D')) then
        while (ds_horarios_p IS NOT NULL AND ds_horarios_p::text <> '') loop
            ds_hora_w := null;
            i_pos_w := position(' ' in ds_horarios_p);

            if ((i_pos_w > 1) and ((substr(ds_horarios_p, 1, i_pos_w -1) IS NOT NULL AND (substr(ds_horarios_p, 1, i_pos_w -1))::text <> ''))) then
                ds_hora_w := replace(substr(ds_horarios_p, 1, i_pos_w-1), ' ', '');
                ds_horarios_p := substr(ds_horarios_p, i_pos_w + 1, 2000);
            elsif (ds_horarios_p IS NOT NULL AND ds_horarios_p::text <> '') then
                ds_hora_w := replace(ds_horarios_p, ' ', '');
                ds_horarios_p := '';
            end if;

            if (ds_hora_w IS NOT NULL AND ds_hora_w::text <> '') then
                if ((position('A' in ds_hora_w) > 0) and (qt_dia_adic_w = 0)) then
                    qt_dia_adic_w := 1;
                elsif (position('AA' in ds_hora_w) > 0) then
                    qt_dia_adic_w := qt_dia_adic_w + 1;
                end if;

                ds_hora_w := replace(ds_hora_w, 'A', '');
                dt_horario_w :=	pkg_date_utils.get_time(dt_referencia_p + qt_dia_adic_w, replace(ds_hora_w,'A',''), 0);

                select count(*)
                    into STRICT qt_pertence_w

                    where dt_horario_w >= dt_referencia_p
                    and dt_horario_w < dt_fim_p;

                if (qt_pertence_w > 0) then
                   ds_retorno_w := ds_retorno_w || to_char(dt_horario_w, 'hh24:mi') || ' ';
                end if;
            end if;
        end loop;
		return;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_recalcula_horarios_md ( dt_referencia_p timestamp, ie_operacao_p text, dt_fim_p timestamp, ds_horarios_p INOUT text ) FROM PUBLIC;

