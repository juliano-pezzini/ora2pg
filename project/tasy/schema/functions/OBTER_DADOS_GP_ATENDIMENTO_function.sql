-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_gp_atendimento ( ie_opcao_p text, nr_seq_tipo_p bigint, nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
/* 
urgp	-	último registro do tipo de perda/ganho 
hur	-	horas do último registro 
*/
 
 
dt_medida_w				timestamp;
dt_medida_similar_w		timestamp;
ds_retorno_w			varchar(255);
qt_horas_w				double precision;
dt_alta_w				timestamp;
dt_entrada_w			timestamp;
nr_seq_tipo_pg_similar_w	bigint;


BEGIN 
 
select	dt_alta, 
	dt_entrada 
into STRICT	dt_alta_w, 
	dt_entrada_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_p;
 
select	max(dt_medida) 
into STRICT	dt_medida_w 
from	atendimento_perda_ganho 
where	nr_atendimento	=	nr_atendimento_p 
and	nr_seq_tipo  	=	nr_seq_tipo_p 
and	ie_situacao 	= 	'A' 
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
 
select	max(b.dt_medida) 
into STRICT	dt_medida_similar_w 
from 	tipo_perda_ganho_similar a, 
		atendimento_perda_ganho b	 
where	b.nr_seq_tipo		=	a.nr_seq_tipo_pg_similar 	 
and		a.nr_seq_tipo_pg	=	nr_seq_tipo_p 
and		b.nr_atendimento	= 	nr_atendimento_p 
and		b.ie_situacao 		= 	'A' 
and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '');
 
if (dt_medida_similar_w > dt_medida_w AND dt_medida_similar_w IS NOT NULL AND dt_medida_similar_w::text <> '') then 
 dt_medida_w:= dt_medida_similar_w;
end if;
 
if (ie_opcao_p = 'URGP') then 
	ds_retorno_w	:= to_char(dt_medida_w,'dd/mm/yyyy hh24:mi:ss');
elsif (ie_opcao_p = 'HUR') then 
	ds_retorno_w	:= to_char(trunc((coalesce(dt_alta_w,clock_timestamp()) - coalesce(dt_medida_w,dt_entrada_w)) * 24));
end if;	
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_gp_atendimento ( ie_opcao_p text, nr_seq_tipo_p bigint, nr_atendimento_p bigint) FROM PUBLIC;

