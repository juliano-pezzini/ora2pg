-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_alarms_count ( nr_seq_patient_p text, alarms_code_p text, alarms_hours_p bigint ) RETURNS bigint AS $body$
DECLARE


nr_alarms 			bigint;
nr_alarms_error 	bigint := 0;


BEGIN

	select count(*) alarms
	into STRICT nr_alarms
	from 	pfcs_patient_flag ppf
	where ppf.cd_flag = alarms_code_p
		and ppf.nr_seq_patient = nr_seq_patient_p
		and round((clock_timestamp() - coalesce(ppf.period_start  , clock_timestamp()))::numeric  * 24) < alarms_hours_p
		and round((clock_timestamp() - coalesce(ppf.period_start  , clock_timestamp()))::numeric  * 24) > 0;

	return nr_alarms;

	exception
	-- If there will be no record
	when no_data_found then
	  return nr_alarms_error;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_alarms_count ( nr_seq_patient_p text, alarms_code_p text, alarms_hours_p bigint ) FROM PUBLIC;

