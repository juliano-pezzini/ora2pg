-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_concurrent_appointments ( cd_pessoa_fisica_p text, dt_agenda_p timestamp, cd_agenda_p text ) RETURNS varchar AS $body$
DECLARE


ds_agenda_retorno_w        varchar(200);
dt_agenda_w                timestamp;
ds_agenda_w                varchar(200);


C01 CURSOR FOR
        SELECT    dt_agenda ,
                  obter_desc_agenda(cd_agenda)
            from (SELECT cd_agenda ,
                         dt_agenda 
                        from (select    a.cd_agenda ,
                                        a.dt_agenda
                            from    agenda_consulta a 
                            where    a.cd_pessoa_fisica = cd_pessoa_fisica_p
                            and     a.ie_Status_Agenda <> 'C'
                            and     a.cd_agenda <> cd_agenda_p
                            and     a.dt_agenda  between trunc(dt_agenda_p)
                            and     TRUNC(dt_agenda_p) + 86399 / 86400
                                    
                            
union
    
                            select    a.cd_agenda ,
                                    a.dt_agenda 
                            from    agenda_paciente a 
                            where    a.cd_pessoa_fisica =    cd_pessoa_fisica_p
                            and     a.ie_Status_Agenda <> 'C'
                            and     a.hr_inicio  between trunc(dt_agenda_p)
                            and     TRUNC(dt_agenda_p) + 86399 / 86400
                            
                            
union

                            select    b.cd_agenda , 
                                    a.dt_agenda 
                            from    agenda_quimio a ,
                                    agenda_consulta b
                            where    a.nr_seq_agenda_cons = b.nr_sequencia
                            and     a.cd_pessoa_fisica = cd_pessoa_fisica_p
                            and     a.ie_Status_Agenda <> 'C'
                            and     a.dt_agenda  between trunc(dt_agenda_p) 
                            and     TRUNC(dt_agenda_p) + 86399 / 86400) alias7
                    order by    dt_agenda) alias8;


BEGIN
 if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
    open C01;
    loop
    fetch C01 into
        dt_agenda_w,ds_agenda_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */

    begin
    
    ds_agenda_retorno_w := ds_agenda_w || ', ' ||ds_agenda_retorno_w;

    end;
    end loop;
    close C01;
 end if;

return  substr(ds_agenda_retorno_w, 1, length(ds_agenda_retorno_w)-2);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_concurrent_appointments ( cd_pessoa_fisica_p text, dt_agenda_p timestamp, cd_agenda_p text ) FROM PUBLIC;

