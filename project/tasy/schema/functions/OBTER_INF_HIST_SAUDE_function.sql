-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_hist_saude (cd_pessoa_fisica_p text, ie_opcao_p text ) RETURNS varchar AS $body$
DECLARE

ds_retorno_w varchar(2000);
				
ds_medicamento_w varchar(255);
ds_lista_medicamentos_w varchar(2000);
ds_cirurgia_w	varchar(255);
ds_lista_cirurgias_w varchar(2000);
ds_anestesia_w varchar(255);
ds_lista_anestesia_w varchar(2000);
ds_doenca_w varchar(255);
ds_lista_doenca_w varchar(2000);
ds_habitos_w varchar(255);
ds_lista_habitos_w varchar(2000);
ds_alergias_w varchar(400);
ds_lista_alergias_w varchar(2000);

expressao1_w	varchar(255) := obter_desc_expressao_idioma(294059, null, wheb_usuario_pck.get_nr_seq_idioma);--Nega Doen√ßas 
 
 
C01 CURSOR FOR 
SELECT	coalesce(b.ds_material,a.ds_medicamento) 
FROM paciente_medic_uso a
LEFT OUTER JOIN material b ON (a.cd_material = b.cd_material)
WHERE a.cd_pessoa_fisica = cd_pessoa_fisica_p;

C02 CURSOR FOR 
SELECT	coalesce(b.ds_procedimento,a.ds_procedimento_inf), 
		substr(obter_valor_dominio(36,a.ie_tipo_anestesia),1,60) 
FROM historico_saude_cirurgia a
LEFT OUTER JOIN procedimento b ON (a.cd_procedimento = b.cd_procedimento AND a.ie_origem_proced = b.ie_origem_proced)
WHERE a.cd_pessoa_fisica = cd_pessoa_fisica_p;

C03 CURSOR FOR 
SELECT	coalesce(a.ds_doenca,coalesce(b.ds_doenca,c.ds_doenca_cid)) 
FROM paciente_antec_clinico a
LEFT OUTER JOIN pe_doenca b ON (a.nr_seq_doenca = b.nr_sequencia)
LEFT OUTER JOIN cid_doenca c ON (a.cd_doenca = c.cd_doenca_cid)
WHERE coalesce(a.ie_paciente,'S')	= 'S' and coalesce(a.ds_doenca,coalesce(b.ds_doenca,c.ds_doenca_cid)) is not null and a.cd_pessoa_fisica = cd_pessoa_fisica_p 
 
union
 
SELECT	expressao1_w ds_doenca 
FROM paciente_antec_clinico a
LEFT OUTER JOIN pe_doenca b ON (a.nr_seq_doenca = b.nr_sequencia)
LEFT OUTER JOIN cid_doenca c ON (a.cd_doenca = c.cd_doenca_cid)
WHERE coalesce(a.ie_paciente,'S')	= 'S' and coalesce(a.ie_nega_doencas,'S') = 'S' and a.cd_pessoa_fisica	= cd_pessoa_fisica_p;

C04 CURSOR FOR 
SELECT	b.ds_vicio 
from	paciente_habito_vicio a, 
		med_tipo_vicio b 
where	a.nr_seq_tipo = b.nr_sequencia 
and		a.cd_pessoa_fisica = cd_pessoa_fisica_p;

C05 CURSOR FOR 
SELECT	CASE WHEN coalesce(d.ds_substancia::text, '') = '' THEN ''  ELSE d.ds_substancia END  || 
	CASE WHEN coalesce(c.ds_dcb::text, '') = '' THEN ''  ELSE c.ds_dcb END  || 
	CASE WHEN coalesce(b.ds_material::text, '') = '' THEN ''  ELSE b.ds_material END  ||		 
	CASE WHEN coalesce(e.ds_classe_material::text, '') = '' THEN ''  ELSE e.ds_classe_material END  || 
	CASE WHEN coalesce(a.DS_MEDIC_NAO_CAD::text, '') = '' THEN ''  ELSE a.DS_MEDIC_NAO_CAD END  
FROM paciente_alergia a
LEFT OUTER JOIN material b ON (a.cd_material = b.cd_material)
LEFT OUTER JOIN dcb_medic_controlado c ON (a.nr_seq_dcb = c.nr_sequencia)
LEFT OUTER JOIN medic_ficha_tecnica d ON (a.nr_seq_ficha_tecnica = d.nr_sequencia)
LEFT OUTER JOIN classe_material e ON (a.CD_CLASSE_MAT = e.cd_classe_material)
WHERE a.cd_pessoa_fisica = cd_pessoa_fisica_p;


BEGIN 
 
open C01;
	loop 
	fetch C01 into 
		ds_medicamento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	 
		if (ds_lista_medicamentos_w IS NOT NULL AND ds_lista_medicamentos_w::text <> '') then 
			ds_lista_medicamentos_w := substr(ds_lista_medicamentos_w || ' , ',1,2000);
		end if;
		ds_lista_medicamentos_w := substr(ds_lista_medicamentos_w || ds_medicamento_w,1,2000);
		 
	end loop;
close C01;
 
open C02;
	loop 
	fetch C02 into 
		ds_cirurgia_w, 
		ds_anestesia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		 
		if (ds_lista_cirurgias_w IS NOT NULL AND ds_lista_cirurgias_w::text <> '') then 
			ds_lista_cirurgias_w := substr(ds_lista_cirurgias_w || ' , ',1,2000);
		end if;
		ds_lista_cirurgias_w := substr(ds_lista_cirurgias_w || ds_cirurgia_w,1,2000);
		 
		if (ds_lista_anestesia_w IS NOT NULL AND ds_lista_anestesia_w::text <> '') then 
			ds_lista_anestesia_w := substr(ds_lista_anestesia_w || ' , ',1,2000);
		end if;
		ds_lista_anestesia_w := substr(ds_lista_anestesia_w || ds_anestesia_w,1,2000);
		 
	end loop;
close C02;
 
 
open C03;
	loop 
	fetch C03 into 
		ds_doenca_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
	 
		if (ds_lista_doenca_w IS NOT NULL AND ds_lista_doenca_w::text <> '') then 
			ds_lista_doenca_w := substr(ds_lista_doenca_w || ' , ',1,2000);
		end if;
		ds_lista_doenca_w := substr(ds_lista_doenca_w || ds_doenca_w,1,2000);
		 
	end loop;
close C03;
 
 
open C04;
	loop 
	fetch C04 into 
		ds_habitos_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
	 
		if (ds_lista_habitos_w IS NOT NULL AND ds_lista_habitos_w::text <> '') then 
			ds_lista_habitos_w := substr(ds_lista_habitos_w || ' , ',1,2000);
		end if;
		ds_lista_habitos_w := substr(ds_lista_habitos_w || ds_habitos_w,1,2000);
		 
	end loop;
close C04;
 
 
open C05;
	loop 
	fetch C05 into 
		ds_alergias_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
	 
		if (ds_lista_alergias_w IS NOT NULL AND ds_lista_alergias_w::text <> '') then 
			ds_lista_alergias_w := substr(ds_lista_alergias_w || ' , ',1,2000);
		end if;
		ds_lista_alergias_w := substr(ds_lista_alergias_w || ds_alergias_w,1,2000);
		 
	end loop;
close C05;
 
 
if (ie_opcao_p = 'M') then 
	ds_retorno_w := ds_lista_medicamentos_w;
else if (ie_opcao_p = 'C') then 
	ds_retorno_w := ds_lista_cirurgias_w;
else if (ie_opcao_p = 'A') then 
	ds_retorno_w := ds_lista_anestesia_w;
else if (ie_opcao_p = 'D') then 
	ds_retorno_w := ds_lista_doenca_w;
else if (ie_opcao_p = 'H') then 
	ds_retorno_w := ds_lista_habitos_w;
else if (ie_opcao_p = 'AL') then 
	ds_retorno_w := ds_lista_alergias_w;
end if;
end if;
end if;
end if;	
end if;
end if;
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_hist_saude (cd_pessoa_fisica_p text, ie_opcao_p text ) FROM PUBLIC;

