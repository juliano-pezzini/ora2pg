-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_cfps_mun_regra ( nr_sequencia_p nota_fiscal.nr_sequencia%type, nr_item_nf_p nota_fiscal_item.nr_item_nf%type, cd_estabelecimento_p nota_fiscal.cd_estabelecimento%type) RETURNS varchar AS $body$
DECLARE

 
cd_mun_ibge_prest_w	varchar(7);
cd_mun_ibge_tom_w	varchar(7);
cd_uf_prestador_w	varchar(2);
cd_uf_tomador_w		varchar(2);
ds_retorno_w		varchar(10);
nr_seq_item_serv_w	procedimento.nr_seq_item_serv%type;
cd_setor_digitacao_w	nota_fiscal.cd_setor_digitacao%type;

c01 CURSOR FOR 
	SELECT	nr_sequencia, 
		ie_tipo_situacao, 
		nr_seq_item_serv, 
		cd_setor_atendimento 
	from	regra_cfps 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and	nr_seq_item_serv = nr_seq_item_serv_w;

	 
vet01			c01%rowType;


BEGIN 
 
select	max(p.nr_seq_item_serv), 
	max(a.cd_setor_digitacao), 
	substr(nfe_obter_dados_pj(max(a.cd_cgc_emitente),'IBGE'),1,7), 
	substr(CASE WHEN coalesce(max(a.cd_pessoa_fisica)::text, '') = '' THEN nfe_obter_dados_pj(max(a.cd_cgc),'IBGE')  ELSE OBTER_COMPL_PF(max(a.cd_pessoa_fisica),1,'CDMDV') END ,1,7), 
	substr(nfe_obter_dados_pj(max(a.cd_cgc_emitente),'UF'),1,7), 
	substr(CASE WHEN coalesce(max(a.cd_pessoa_fisica)::text, '') = '' THEN nfe_obter_dados_pj(max(a.cd_cgc),'UF')  ELSE OBTER_COMPL_PF(max(a.cd_pessoa_fisica),1,'UF') END ,1,7) 
into STRICT	nr_seq_item_serv_w, 
	cd_setor_digitacao_w, 
	cd_mun_ibge_prest_w, 
	cd_mun_ibge_tom_w, 
	cd_uf_prestador_w, 
	cd_uf_tomador_w 
from	nota_fiscal a, 
	nota_fiscal_item b, 
	procedimento p 
where	a.nr_sequencia = b.nr_sequencia 
and	a.nr_sequencia = nr_sequencia_p 
and	b.nr_item_nf = nr_item_nf_p 
and	a.cd_estabelecimento = cd_estabelecimento_p 
and	b.cd_procedimento = p.cd_procedimento 
and	b.ie_origem_proced = p.ie_origem_proced;
 
open c01;
loop 
fetch c01 into 
	vet01;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	 
	if (vet01.cd_setor_atendimento IS NOT NULL AND vet01.cd_setor_atendimento::text <> '') then 
		begin 
		 
		if (cd_setor_digitacao_w = vet01.cd_setor_atendimento) then 
			begin 
			 
			if (cd_uf_prestador_w = cd_uf_tomador_w) and (not cd_uf_tomador_w in ('IN','EX')) then 
				ds_retorno_w := '05';
			elsif (cd_uf_prestador_w <> cd_uf_tomador_w) and (not cd_uf_tomador_w in ('IN','EX')) then 
				ds_retorno_w := '06';
			elsif (cd_uf_prestador_w <> cd_uf_tomador_w) and (cd_uf_tomador_w in ('IN','EX')) then 
				ds_retorno_w := '07';
			end if;
			 
			end;
		end if;
		 
		end;
	else 
		begin 
		 
		if (cd_mun_ibge_prest_w = cd_mun_ibge_tom_w) then 
			ds_retorno_w := '01';
		elsif (cd_uf_prestador_w = cd_uf_tomador_w) and (not cd_uf_tomador_w in ('IN','EX')) then 
			ds_retorno_w := '02';
		elsif (cd_uf_prestador_w <> cd_uf_tomador_w) and (not cd_uf_tomador_w in ('IN','EX')) then 
			ds_retorno_w := '03';
		elsif (cd_uf_prestador_w <> cd_uf_tomador_w) and (cd_uf_tomador_w in ('IN','EX')) then 
			ds_retorno_w := '04';
		end if;
		 
		end;
	end if;
	 
	end;
end loop;
close C01;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_cfps_mun_regra ( nr_sequencia_p nota_fiscal.nr_sequencia%type, nr_item_nf_p nota_fiscal_item.nr_item_nf%type, cd_estabelecimento_p nota_fiscal.cd_estabelecimento%type) FROM PUBLIC;

