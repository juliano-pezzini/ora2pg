-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_bomba_elastomerica (nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_cd_ds_p text) RETURNS varchar AS $body$
DECLARE

/*
ie_cd_ds_p = [D]escrição / [C]ódigo
*/
/* Lê a tabela REGRA_BOMBA_ELASTOMERICA e
retorna a sequencia da  tabela BOMBA_ELASTOMERICA que se aplica a solução*/
ie_tipo_dosagem_w	varchar(3);
qt_solucao_total_w	double precision;
qt_dosagem_w		double precision;
ie_bomba_infusao_w	varchar(1);
nr_seq_bomba_elast_w	bigint := null;
nr_seq_bomba_elast_final_w	bigint := null;
qt_reg_w		bigint;
ds_bomba_w		varchar(255);
qt_tempo_aplicacao_w	double precision;

c01 CURSOR FOR
SELECT	d.nr_sequencia
from	regra_bomba_elastomerica c,
		bomba_elastomerica d
where 	c.nr_seq_bomba	= d.nr_sequencia
and	coalesce(d.ie_situacao,'I') = 'A'
and	c.qt_solucao_total >= qt_solucao_total_w
and (qt_tempo_aplicacao_w * c.qt_dosagem) <= c.qt_solucao_total
and	Obter_vel_sol_mlh(c.ie_tipo_dosagem, c.qt_dosagem) >= qt_solucao_total_w / qt_tempo_aplicacao_w
order by c.qt_solucao_total asc,
	Obter_vel_sol_mlh(c.ie_tipo_dosagem, c.qt_dosagem) desc;



BEGIN
Select	max(ie_bomba_elastomerica)
into STRICT	nr_seq_bomba_elast_w
from	prescr_solucao a,
	Prescr_medica b
where	a.nr_prescricao	= b.nr_prescricao
and	a.nr_prescricao	= nr_prescricao_p
and	a.nr_seq_solucao = nr_seq_solucao_p
and 	(coalesce(dt_liberacao, dt_liberacao_medico) IS NOT NULL AND (coalesce(dt_liberacao, dt_liberacao_medico))::text <> '');

Select	count(*)
into STRICT	qt_reg_w
from	regra_bomba_elastomerica
where	coalesce(nr_seq_bomba_elast_w::text, '') = '';

if (qt_reg_w > 0) then
	Select	max(qt_solucao_total),
		max(ie_tipo_dosagem),
		max(qt_dosagem),
		max(ie_bomba_infusao),
		CASE WHEN coalesce(max(qt_tempo_aplicacao),0)=0 THEN 1  ELSE max(qt_tempo_aplicacao) END
	into STRICT	qt_solucao_total_w,
		ie_tipo_dosagem_w,
		qt_dosagem_w,
		ie_bomba_infusao_w,
		qt_tempo_aplicacao_w
	from	prescr_solucao
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_solucao	= nr_seq_solucao_p;

	select	sum(a.qt_solucao)
	into STRICT	qt_solucao_total_w
	from	prescr_material a,
		material b
	where	b.cd_material 		= a.cd_material
	and	a.nr_prescricao		= nr_prescricao_p
	and	a.nr_sequencia_solucao	= nr_seq_solucao_p
	and 	coalesce(b.ie_ancora_solucao,'S') = 'S'
	and 	a.ie_agrupador		= 4;

	if (ie_tipo_dosagem_w IS NOT NULL AND ie_tipo_dosagem_w::text <> '') and (qt_dosagem_w IS NOT NULL AND qt_dosagem_w::text <> '') and (qt_solucao_total_w IS NOT NULL AND qt_solucao_total_w::text <> '') and (ie_bomba_infusao_w = 'B') then
		open C01;
		loop
		fetch C01 into
			nr_seq_bomba_elast_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			if (coalesce(nr_seq_bomba_elast_final_w::text, '') = '') then
				nr_seq_bomba_elast_final_w := nr_seq_bomba_elast_w;
			end if;
		end loop;
		close C01;
	end if;

end if;
if	ie_cd_ds_p = 'C' then
	return	nr_seq_bomba_elast_final_w;
else
	Select	max(nm_bomba)
	into STRICT	ds_bomba_w
	from	bomba_elastomerica
	where 	nr_sequencia = nr_seq_bomba_elast_final_w;

	return ds_bomba_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_bomba_elastomerica (nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_cd_ds_p text) FROM PUBLIC;

