-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_parametro_usuario ( cd_estabelecimento_p bigint, nr_prescricao_p bigint, ds_maquina_p text, ie_parametro_p text, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE

 
ie_tipo_atendimento_w		smallint;
ie_tem_regra_w			smallint;
ds_maquina_w			varchar(100);
ie_integra_fleury_w		varchar(1);
cd_unidade_fleury_w		varchar(5);
ds_url_serv_fleury_w		varchar(100);
ds_url_perg_fleury_w		lab_parametro.ds_url_perg_fleury%type;
ds_url_cont_fleury_w		varchar(100);
cd_unid_fleury_param_w		varchar(20) := null;
cd_perfil_w			perfil.cd_perfil%type;
cd_contrato_fleury_w		lab_parametro.cd_contrato_fleury%type;
cd_convenio_w			convenio.cd_convenio%type;
cd_categoria_w			categoria_convenio.cd_categoria%type;
ds_url_perg_par_fleury_w	lab_parametro.ds_url_perg_par_fleury%type;

c01 CURSOR FOR 
	SELECT	ie_integra_fleury, 
		cd_unidade_fleury, 
		ds_url_serv_fleury, 
		ds_url_perg_fleury, 
		ds_url_cont_fleury, 
		cd_contrato_fleury, 
		ds_url_perg_par_fleury 
	from	lab_param_maquina 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0)) = coalesce(ie_tipo_atendimento_w,0) 
	and	coalesce(ds_maquina,coalesce(ds_maquina_p,0))	= coalesce(ds_maquina_p,0)	 
	and	coalesce(cd_perfil, coalesce(cd_perfil_w,0)) 	= coalesce(cd_perfil_w,0) 
	and	coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0) 
	and	coalesce(cd_categoria, coalesce(cd_categoria_w,0)) = coalesce(cd_categoria_w,0) 
	order 	by coalesce(ie_tipo_atendimento, 0), coalesce(ds_maquina, coalesce(ds_maquina_p,0));
	

BEGIN 
 
cd_perfil_w	:= obter_perfil_ativo;
 
select	coalesce(max(ie_tipo_atendimento),0), 
	coalesce(max(obter_convenio_atendimento(b.nr_atendimento)),0), 
	coalesce(max(obter_cat_conv_atend(b.nr_atendimento, obter_convenio_atendimento(b.nr_atendimento))),0), 
	coalesce(max(a.cd_perfil_ativo), obter_perfil_ativo) 
into STRICT	ie_tipo_atendimento_w, 
	cd_convenio_w, 
	cd_categoria_w, 
	cd_perfil_w 
from	atendimento_paciente b, 
	prescr_medica a 
where	a.nr_atendimento = b.nr_atendimento 
and	a.nr_prescricao = nr_prescricao_p;
 
cd_unid_fleury_param_w := obter_valor_param_usuario(0, 144, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p);
 
ie_tem_regra_w	:= 0;
/*open c01; 
loop 
	fetch c01 into	ie_integra_fleury_w, 
			cd_unidade_fleury_w, 
			ds_url_serv_fleury_w, 
			ds_url_perg_fleury_w, 
			ds_url_cont_fleury_w, 
			cd_contrato_fleury_w, 
			ds_url_perg_par_fleury_w; 
	exit when c01%notfound;	 
	ie_tem_regra_w := ie_tem_regra_w + 1; 
	end loop; 
close c01;*/
 
 
 
begin 
select IE_INTEGRA_FLEURY, 
		CD_UNIDADE_FLEURY, 
		DS_URL_SERV_FLEURY, 
		DS_URL_PERG_FLEURY, 
		DS_URL_CONT_FLEURY, 
		cd_contrato_fleury, 
		ds_url_perg_par_fleury, 
		1 
into STRICT  	IE_INTEGRA_FLEURY_W, 
		CD_UNIDADE_FLEURY_W, 
		DS_URL_SERV_FLEURY_W, 
		DS_URL_PERG_FLEURY_W, 
		DS_URL_CONT_FLEURY_W, 
		cd_contrato_fleury_w, 
		ds_url_perg_par_fleury_w, 
		ie_tem_regra_w 
from ( 
		SELECT	IE_INTEGRA_FLEURY, 
				CD_UNIDADE_FLEURY, 
				DS_URL_SERV_FLEURY, 
				DS_URL_PERG_FLEURY, 
				DS_URL_CONT_FLEURY, 
				cd_contrato_fleury, 
				ds_url_perg_par_fleury 
		from 	lab_param_maquina 
		where 	cd_estabelecimento = cd_estabelecimento_p 
		and 	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0)) = coalesce(ie_tipo_atendimento_w,0) 
		and 	coalesce(ds_maquina, coalesce(ds_maquina_p,0)) = coalesce(ds_maquina_p,0) 
		and 	coalesce(cd_perfil, coalesce(cd_perfil_w,0))  = coalesce(cd_perfil_w,0) 
		and 	coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0) 
		and 	coalesce(cd_categoria, coalesce(cd_categoria_w,0)) = coalesce(cd_categoria_w,0) 
		order by coalesce(ie_tipo_atendimento, 0) desc, 
				coalesce(ds_maquina,'0'), 
				coalesce(cd_convenio, 0) desc, 
				coalesce(cd_perfil, 0) desc, 
				coalesce(cd_categoria, '0')) alias20 LIMIT 1;
 
exception 
	when no_data_found then 
		begin 
		ie_tem_regra_w	:= 0;
		end;		
end;
 
 
if (ie_tem_regra_w = 0) then 
 
	select	coalesce(max(ie_integra_fleury), 'N'), 
		coalesce(max(cd_unidade_fleury), null), 
		coalesce(max(ds_url_serv_fleury), null), 
		coalesce(max(ds_url_perg_fleury), null), 
		coalesce(max(ds_url_cont_fleury), null), 
		coalesce(max(ds_url_perg_par_fleury_w), null), 
		coalesce(max(cd_contrato_fleury),0) 
	into STRICT	ie_integra_fleury_w, 
		cd_unidade_fleury_w, 
		ds_url_serv_fleury_w, 
		ds_url_perg_fleury_w, 
		ds_url_cont_fleury_w, 
		ds_url_perg_par_fleury_w, 
		cd_contrato_fleury_w 
	from	lab_parametro 
	where	cd_estabelecimento = cd_estabelecimento_p;
	 
end if;
 
 
if (cd_unid_fleury_param_w <> '') or (cd_unid_fleury_param_w IS NOT NULL AND cd_unid_fleury_param_w::text <> '')then 
 
	cd_unidade_fleury_w := cd_unid_fleury_param_w;
 
end if;
 
if (ie_parametro_p = 'IF') then 
	return ie_integra_fleury_w;
elsif (ie_parametro_p = 'UF') then 
	return cd_unidade_fleury_w;
elsif (ie_parametro_p = 'SF') then 
	return ds_url_serv_fleury_w;
elsif (ie_parametro_p = 'PF') then 
	return ds_url_perg_fleury_w;
elsif (ie_parametro_p = 'CF') then 
	return ds_url_cont_fleury_w;
elsif (ie_parametro_p = 'COF') then 
	return cd_contrato_fleury_w;
elsif (ie_parametro_p = 'PU') then 
	return ds_url_perg_par_fleury_w;
else 
	return null;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_parametro_usuario ( cd_estabelecimento_p bigint, nr_prescricao_p bigint, ds_maquina_p text, ie_parametro_p text, nm_usuario_p text) FROM PUBLIC;

