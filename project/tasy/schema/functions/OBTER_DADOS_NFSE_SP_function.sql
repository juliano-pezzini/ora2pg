-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_nfse_sp (cd_pessoa_fisica_p text, cd_cgc_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
			 
 
insc_muninipal_w		varchar(256);
insc_estadual_w		varchar(256);
nm_razao_social_w		varchar(256);
ds_tipo_logradouro_w	varchar(256);
nm_logradouro_w		varchar(256);
nr_endereco_w		varchar(256);
ds_compl_endereco_w	varchar(256);
ds_bairro_w		varchar(256);
ds_cidade_w		varchar(256);
ds_uf_w			varchar(256);
cd_cep_w		varchar(256);
ds_email_w		varchar(256);
retorno_w			varchar(256);

 
/* 
IM: InscricaoMunicipalTomador 
IE: InscricaoEstadualTomador 
NM: RazaoSocialTomador 
TLG: TipoLogradouro 
LG: Logradouro 
NR: NumeroEndereco 
COM: ComplementoEndereco 
BAI: Bairro 
CID: Cidade 
UF: UF 
CEP: CEP 
EML: EmailTomador 
*/
			 
 

BEGIN 
 
select	CASE WHEN cd_cgc_p='' THEN null  ELSE CASE WHEN obter_dados_pf_pj(cd_pessoa_fisica_p,cd_cgc_p,'CDM')='355030' THEN obter_dados_pf_pj(cd_pessoa_fisica_p,cd_cgc_p,'IM')  ELSE null END  END  InscricaoMunicipalTomador, 
	obter_dados_pf_pj(null,cd_cgc_p,'IE') InscricaoEstadualTomador, 
	tiss_eliminar_caractere(elimina_acentuacao(obter_nome_pf_pj(cd_pessoa_fisica_p,cd_cgc_p))) RazaoSocialTomador, 
	'Rua' TipoLogradouro, 
	tiss_eliminar_caractere(elimina_acentuacao(coalesce(obter_dados_pf_pj(cd_pessoa_fisica_p,cd_cgc_p,'EN'),'Endereco'))) Logradouro, 
	coalesce(obter_dados_pf_pj(cd_pessoa_fisica_p,cd_cgc_p,'NR'),'00') NumeroEndereco, 
	tiss_eliminar_caractere(elimina_acentuacao(coalesce(obter_dados_pf_pj(cd_pessoa_fisica_p,cd_cgc_p,'CO'),'Complemento'))) ComplementoEndereco, 
	tiss_eliminar_caractere(elimina_acentuacao(CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica_p, cd_cgc_p)='N' THEN substr(somente_nao_numero(obter_dados_pf_pj(cd_pessoa_fisica_p,cd_cgc_p,'CI')) || ' - ' || obter_dados_pf_pj(cd_pessoa_fisica_p,cd_cgc_p,'PAIS'),1,30)  ELSE coalesce(substr(obter_dados_pf_pj(cd_pessoa_fisica_p, cd_cgc_p,'B'),1,30),'Bairro') END )) Bairro, 
	lpad(elimina_acentuacao(obter_dados_pf_pj(cd_pessoa_fisica_p,cd_cgc_p,'CDMDV')),7,'0') Cidade, 
	obter_dados_pf_pj(cd_pessoa_fisica_p,cd_cgc_p,'UF') UF, 
	somente_numero(substr(obter_dados_pf_pj(cd_pessoa_fisica_p,cd_cgc_p,'CEP'),1,15)) CEP, 
	tiss_eliminar_caractere(elimina_acentuacao(CASE WHEN obter_se_email_valido(obter_dados_pf_pj(cd_pessoa_fisica_p, cd_cgc_p,'M'))='N' THEN NULL  ELSE obter_dados_pf_pj(cd_pessoa_fisica_p,cd_cgc_p,'M') END )) EmailTomador 
into STRICT	insc_muninipal_w, 
	insc_estadual_w, 
	nm_razao_social_w, 
	ds_tipo_logradouro_w, 
	nm_logradouro_w, 
	nr_endereco_w, 
	ds_compl_endereco_w, 
	ds_bairro_w, 
	ds_cidade_w, 
	ds_uf_w, 
	cd_cep_w, 
	ds_email_w
;
 
if (ie_opcao_p = 'IM') then 
	retorno_w:= insc_muninipal_w;
elsif (ie_opcao_p = 'IE') then 
	retorno_w:= insc_estadual_w;	
elsif (ie_opcao_p = 'NM') then 
	retorno_w:= nm_razao_social_w;
elsif (ie_opcao_p = 'TLG') then 
	retorno_w:= ds_tipo_logradouro_w;	
elsif (ie_opcao_p = 'LG') then 
	retorno_w:= nm_logradouro_w;	
elsif (ie_opcao_p = 'NR') then 
	retorno_w:= nr_endereco_w;
elsif (ie_opcao_p = 'COM') then 
	retorno_w:= ds_compl_endereco_w;
elsif (ie_opcao_p = 'BAI') then 
	retorno_w:= ds_bairro_w;
elsif (ie_opcao_p = 'CID') then 
	retorno_w:= ds_cidade_w;
elsif (ie_opcao_p = 'UF') then 
	retorno_w:= ds_uf_w;
elsif (ie_opcao_p = 'CEP') then 
	retorno_w:= cd_cep_w;
elsif (ie_opcao_p = 'EML') then 
	retorno_w:= ds_email_w;	
end if;
	 
return	retorno_w;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_nfse_sp (cd_pessoa_fisica_p text, cd_cgc_p text, ie_opcao_p text) FROM PUBLIC;

