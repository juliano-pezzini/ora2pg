-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_gca (nr_atendimento_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_cor_fonte_w		varchar(80);
ds_cor_fundo_w		varchar(80);
ds_gradacao_w		varchar(255);
qt_pontos_w		bigint := 0;
ds_descricao_w		varchar(255);
nr_sequencia_w		bigint;
dt_avaliacao_w		timestamp;
nr_seq_gradacao_w	bigint;
ds_autor_w			varchar(255);

/*
ie_opcao_p
 CT - Cor fonte
 CD - Cor fundo
 G - Gradação
 P - Pontos
 S - Sequencia
 PC - Panorama clínico
*/
BEGIN

if (ie_opcao_p in ('P', 'G','PC')) then
	select	qt_pontuacao
	into STRICT	qt_pontos_w
	from	gca_atendimento
	where	nr_sequencia	=	(SELECT	max(nr_sequencia)
					from	gca_atendimento x
					where	x.nr_atendimento	= nr_atendimento_p
					and		(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
					and		coalesce(x.dt_inativacao::text, '') = '');
end if;

if (ie_opcao_p <> 'P') then
	select	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	gca_atendimento x
	where 	x.nr_atendimento = nr_atendimento_p
	and		(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
	and		coalesce(x.dt_inativacao::text, '') = '';

	if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
		begin
		select	b.ds_cor_fonte,
			b.ds_cor_fundo,
			b.ds_gradacao,
			a.dt_avaliacao,
			b.nr_Sequencia,
			substr(obter_valor_dominio(4562,a.IE_AUTOR),1,255)
		into STRICT	ds_cor_fonte_w,
			ds_cor_fundo_w,
			ds_gradacao_w,
			dt_avaliacao_w,
			nr_seq_gradacao_w,
			ds_autor_w
		from	gca_gradacao	b,
			gca_atendimento	a
		WHERE	a.nr_atendimento	= nr_atendimento_p
		AND	a.nr_seq_gradacao	= b.nr_sequencia
		and	a.nr_sequencia	=	nr_sequencia_w;
		exception

			when others then
			null;
		end;

	end if;
end if;


if (ie_opcao_p =	'CT') then
	ds_descricao_w	:=	ds_cor_fonte_w;
elsif (ie_opcao_p =	'CD') then
	ds_descricao_w	:=	ds_cor_fundo_w;
elsif (ie_opcao_p =	'SEQ') then
	ds_descricao_w	:=	nr_sequencia_w;
elsif (ie_opcao_p in ('G','PC')) then
	ds_descricao_w	:=	ds_gradacao_w;

	if (dt_avaliacao_w IS NOT NULL AND dt_avaliacao_w::text <> '') then
		ds_descricao_w := ds_descricao_w || ' (' || to_char(qt_pontos_w);
		if (qt_pontos_w = 1) then
			ds_descricao_w := ds_descricao_w || ' ' || Wheb_mensagem_pck.get_texto(411506) || ')';
		else
			ds_descricao_w := ds_descricao_w || ' ' || Wheb_mensagem_pck.get_texto(411518) || ')';
		end if;
		ds_descricao_w	:= ds_descricao_w || ' - '||to_char(dt_avaliacao_w,'dd/mm/yyyy');

		ds_descricao_w	:= ds_descricao_w || ' - '||ds_autor_w;
	end if;


elsif (ie_opcao_p =	'GSD') then
	ds_descricao_w	:=	ds_gradacao_w;
	if (dt_avaliacao_w IS NOT NULL AND dt_avaliacao_w::text <> '') then
		ds_descricao_w	:= ds_descricao_w;
		ds_descricao_w	:= ds_descricao_w || ' - '||ds_autor_w;
	end if;
elsif (ie_opcao_p =	'P') then
	ds_descricao_w	:=	qt_pontos_w;
elsif (ie_opcao_p =	'S') then
	ds_descricao_w	:=	nr_seq_gradacao_w;
end if;

RETURN ds_descricao_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_gca (nr_atendimento_p bigint, ie_opcao_p text) FROM PUBLIC;

