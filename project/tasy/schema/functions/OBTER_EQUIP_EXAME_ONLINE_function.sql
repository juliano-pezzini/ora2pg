-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_equip_exame_online ( nr_seq_exame_p bigint, cd_equipamento_p bigint, ie_opcao_p text, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


cd_equipamento_w		integer;
ds_sigla_w			varchar(10);
ds_equipamento_w		varchar(50);
cd_exame_equip_w		varchar(20);
cd_exame_equip_integr_w		varchar(20);
Resultado_w	 		varchar(50);
nr_dia_semana_w 		smallint;


BEGIN

/* Opções
	C	- Código Equipamento
	S	- Sigla Equipamento
	D	- Descrição Equipamento
	CI	- Código Integração
	Caso nao seja uma destas opções busca o equipamento para a sigla
*/
nr_dia_semana_w := pkg_date_utils.get_WeekDay(clock_timestamp());

select 	coalesce(max(a.cd_equipamento),null),
	coalesce(max(b.ds_sigla),null),
	coalesce(max(b.ds_equipamento),null),
	coalesce(max(a.cd_exame_equip),null)
into STRICT	cd_equipamento_w,
	ds_sigla_w,
	ds_equipamento_w,
	cd_exame_equip_w
from	equipamento_lab b,
	exame_lab_equip_regra c,
	lab_exame_equip a
where a.cd_equipamento 	= b.cd_equipamento
  and a.nr_sequencia	= c.nr_seq_exame_equip
  and a.nr_seq_exame 	= nr_seq_exame_p
  and ((a.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,a.ie_tipo_atendimento)) or (coalesce(a.ie_tipo_atendimento::text, '') = ''))
  and a.cd_equipamento	= coalesce(cd_equipamento_p,a.cd_equipamento)
  and c.cd_estabelecimento = cd_estabelecimento_p
  and c.ie_dia_semana	= nr_dia_semana_w
  and	clock_timestamp()	>= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || c.ds_hora_inicio || ':00','dd/mm/yyyy hh24:mi:ss')
  and	clock_timestamp()	<= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || c.ds_hora_fim || ':00','dd/mm/yyyy hh24:mi:ss')
  AND (TO_CHAR(clock_timestamp(),'hh24'))::numeric  >= (TO_CHAR(TO_DATE(c.ds_hora_inicio,'hh24:mi'),'hh24'))::numeric
  and coalesce(DS_FORMA_ENVIO_EQUIP,'X') <> 'BCO'
  AND (TO_CHAR(clock_timestamp(),'hh24'))::numeric  <= (TO_CHAR(TO_DATE(c.ds_hora_fim,'hh24:mi'),'hh24'))::numeric;

if (coalesce(cd_equipamento_w::text, '') = '') then
	select 	coalesce(max(a.cd_equipamento),null),
		coalesce(max(b.ds_sigla),null),
		coalesce(max(b.ds_equipamento),null),
		coalesce(max(a.cd_exame_equip),null)
	into STRICT	cd_equipamento_w,
		ds_sigla_w,
		ds_equipamento_w,
		cd_exame_equip_w
	from	equipamento_lab b,
		exame_lab_equip_regra c,
		lab_exame_equip a
	where a.cd_equipamento 	= b.cd_equipamento
	  and a.nr_sequencia	= c.nr_seq_exame_equip
	  and coalesce(DS_FORMA_ENVIO_EQUIP,'X') <> 'BCO'
	  and a.nr_seq_exame 	= nr_seq_exame_p
	  and a.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,a.ie_tipo_atendimento)
	  and a.cd_equipamento	= coalesce(cd_equipamento_p,a.cd_equipamento)
	  and c.cd_estabelecimento = cd_estabelecimento_p;

	if (coalesce(cd_equipamento_w::text, '') = '') then

		select 	coalesce(max(a.cd_equipamento),null),
			coalesce(max(b.ds_sigla),null),
			coalesce(max(b.ds_equipamento),null),
			coalesce(max(a.cd_exame_equip),null)
		into STRICT	cd_equipamento_w,
			ds_sigla_w,
			ds_equipamento_w,
			cd_exame_equip_w
		from	equipamento_lab b,
			lab_exame_equip a
		where a.cd_equipamento 	= b.cd_equipamento
		and coalesce(DS_FORMA_ENVIO_EQUIP,'X') <> 'BCO'
		and a.nr_seq_exame 	= nr_seq_exame_p
		and a.cd_equipamento	= coalesce(cd_equipamento_p,a.cd_equipamento);
	end if;

end if;

if (ie_opcao_p = 'C') then
	resultado_w := cd_equipamento_w;
elsif (ie_opcao_p = 'S') then
	resultado_w := ds_sigla_w;
elsif (ie_opcao_p = 'D') then
	resultado_w := ds_equipamento_w;
elsif (ie_opcao_p = 'CI') then
	resultado_w := cd_exame_equip_w;
else
	select coalesce(max(b.cd_exame_equip),null)
	into STRICT cd_exame_equip_integr_w
	from equipamento_lab a,
		exame_lab_equip_regra c,
	     lab_exame_equip b
        where a.cd_equipamento	= b.cd_equipamento
         and b.nr_sequencia	= c.nr_seq_exame_equip
	 and b.nr_seq_exame 	= nr_seq_exame_p
	 and a.ds_sigla 	= ie_opcao_p
	 and coalesce(DS_FORMA_ENVIO_EQUIP,'X') <> 'BCO'
	 and b.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,b.ie_tipo_atendimento)
	 and c.cd_estabelecimento = cd_estabelecimento_p
	 and coalesce(c.ie_dia_semana, nr_dia_semana_w)	= nr_dia_semana_w
	 and clock_timestamp()	>= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || coalesce(c.ds_hora_inicio,to_char(clock_timestamp(),'hh24:mi')) || ':00','dd/mm/yyyy hh24:mi:ss')
	 and clock_timestamp()	<= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || coalesce(c.ds_hora_inicio,to_char(clock_timestamp(),'hh24:mi')) || ':00','dd/mm/yyyy hh24:mi:ss')
	 and (ds_hora_inicio IS NOT NULL AND ds_hora_inicio::text <> '')
	 and (ds_hora_fim IS NOT NULL AND ds_hora_fim::text <> '');

	if (coalesce(cd_exame_equip_integr_w::text, '') = '') then

		select coalesce(max(b.cd_exame_equip),null)
		into STRICT cd_exame_equip_integr_w
		from equipamento_lab a,
			exame_lab_equip_regra c,
		     lab_exame_equip b
	        where a.cd_equipamento	= b.cd_equipamento
	         and b.nr_sequencia	= c.nr_seq_exame_equip
		 and b.nr_seq_exame 	= nr_seq_exame_p
		 and a.ds_sigla 	= ie_opcao_p
		 and coalesce(b.ie_tipo_atendimento::text, '') = ''
		 and coalesce(DS_FORMA_ENVIO_EQUIP,'X') <> 'BCO'
		 and c.cd_estabelecimento = cd_estabelecimento_p
		 and coalesce(c.ie_dia_semana, nr_dia_semana_w)	= nr_dia_semana_w
		 and clock_timestamp()	>= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || coalesce(c.ds_hora_inicio,to_char(clock_timestamp(),'hh24:mi')) || ':00','dd/mm/yyyy hh24:mi:ss')
		 and clock_timestamp()	<= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || coalesce(c.ds_hora_inicio,to_char(clock_timestamp(),'hh24:mi')) || ':00','dd/mm/yyyy hh24:mi:ss')
		 and (ds_hora_inicio IS NOT NULL AND ds_hora_inicio::text <> '')
		 and (ds_hora_fim IS NOT NULL AND ds_hora_fim::text <> '');


		if (coalesce(cd_exame_equip_integr_w::text, '') = '') then
			select 	coalesce(max(b.cd_exame_equip),null)
			into STRICT 	cd_exame_equip_integr_w
			from 	exame_lab_equip_regra c,
				equipamento_lab a,
				lab_exame_equip b
			where a.cd_equipamento	= b.cd_equipamento
			and b.nr_sequencia	= c.nr_seq_exame_equip
			and b.nr_seq_exame 	= nr_seq_exame_p
			and c.cd_estabelecimento = cd_estabelecimento_p
			and coalesce(coalesce(DS_FORMA_ENVIO_EQUIP,'X'),'X') <> 'BCO'
			and (b.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,b.ie_tipo_atendimento))
			and a.ds_sigla 	= ie_opcao_p
			and coalesce(ds_hora_inicio::text, '') = ''
			and coalesce(ds_hora_fim::text, '') = '';

			if (coalesce(cd_exame_equip_integr_w::text, '') = '') then

				select 	coalesce(max(b.cd_exame_equip),null)
				into STRICT 	cd_exame_equip_integr_w
				from 	exame_lab_equip_regra c,
					equipamento_lab a,
					lab_exame_equip b
				where a.cd_equipamento	= b.cd_equipamento
				and b.nr_sequencia	= c.nr_seq_exame_equip
				and b.nr_seq_exame 	= nr_seq_exame_p
				and c.cd_estabelecimento = cd_estabelecimento_p
				and coalesce(b.ie_tipo_atendimento::text, '') = ''
				and a.ds_sigla 	= ie_opcao_p
				and coalesce(coalesce(DS_FORMA_ENVIO_EQUIP,'X'),'X') <> 'BCO'
				and coalesce(ds_hora_inicio::text, '') = ''
				and coalesce(ds_hora_fim::text, '') = '';

				if (coalesce(cd_exame_equip_integr_w::text, '') = '') then
					select 	coalesce(max(b.cd_exame_equip),null)
					into STRICT 	cd_exame_equip_integr_w
					from 	equipamento_lab a,
						lab_exame_equip b
					where a.cd_equipamento	= b.cd_equipamento
					and b.nr_seq_exame 	= nr_seq_exame_p
					and coalesce(coalesce(DS_FORMA_ENVIO_EQUIP,'X'),'X') <> 'BCO'
					and b.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,b.ie_tipo_atendimento)
					and a.ds_sigla 	= ie_opcao_p;

					if (coalesce(cd_exame_equip_integr_w::text, '') = '') then
						select 	coalesce(max(b.cd_exame_equip),null)
						into STRICT 	cd_exame_equip_integr_w
						from 	equipamento_lab a,
							lab_exame_equip b
						where a.cd_equipamento	= b.cd_equipamento
						and b.nr_seq_exame 	= nr_seq_exame_p
						and coalesce(coalesce(DS_FORMA_ENVIO_EQUIP,'X'),'X') <> 'BCO'
						and coalesce(b.ie_tipo_atendimento::text, '') = ''
						and a.ds_sigla 	= ie_opcao_p;
					end if;
				end if;
			end if;
		end if;
	end if;
	resultado_w := cd_exame_equip_integr_w;
end if;

RETURN resultado_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_equip_exame_online ( nr_seq_exame_p bigint, cd_equipamento_p bigint, ie_opcao_p text, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

