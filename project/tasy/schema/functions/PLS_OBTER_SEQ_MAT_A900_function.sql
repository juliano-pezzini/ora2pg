-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_seq_mat_a900 ( nr_seq_material_p pls_material.nr_sequencia%type, dt_vigencia_p timestamp, ie_alc_p pls_mat_unimed_trib.id_alc%type, ie_tipo_tabela_p pls_regra_preco_mat.ie_tabela_adicional%type) RETURNS PLS_MATERIAL_A900.CD_MATERIAL_A900%TYPE AS $body$
DECLARE


/*
	Essa function ? utilizada para obter a sequ?ncia do material A900 utilizada na valoriza??o de material por TNUMM. Apenas ? 
	chamada na pls_define_preco_mat
	
	
	OBS : Essa rotina apenas reflete o que a regra de pre?o j? faz.
	pls_obter_preco_mat_A900 para tabela adicional 3 
	pls_obter_icms_mat_A900 para tabela adicional 4
	
	A vig?ncia passada por par?metro aqui ? a data de atendimento ent?o 
	onde se v? a.dt_inicio_vigencia < dt_vig_ini_w  e de inicio parece estar invertido, na verdade
	verifica se o registro pls_material_a900 tem vig?ncia inicial inferior a data de atendimento, portanto
	tendo vig?ncia inicial v?lida.
	
*/
					
nr_seq_mat_unimed_w		pls_material_unimed.nr_sequencia%type	:= null;
cd_material_w			pls_material_unimed.cd_material%type	:= null;
dt_vig_ini_w			timestamp;
dt_vig_fim_w			timestamp;
cd_estabelecimento_w			estabelecimento.cd_estabelecimento%type;
ie_vigencia_informada_a900_w	pls_parametros.ie_vigencia_informada_a900%type;
ie_priorizar_cnv_mat_w		pls_parametros.ie_priorizar_conv_mat%type;
					

BEGIN
	
	cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

	select	coalesce(max(ie_vigencia_informada_a900),'N'),
		coalesce(max(ie_priorizar_conv_mat),'N')
	into STRICT	ie_vigencia_informada_a900_w,
		ie_priorizar_cnv_mat_w
	from	pls_parametros
	where	cd_estabelecimento = cd_estabelecimento_w;

	if (dt_vigencia_p IS NOT NULL AND dt_vigencia_p::text <> '') then
		dt_vig_ini_w := fim_dia(dt_vigencia_p);
		dt_vig_fim_w := fim_dia(dt_vigencia_p - 1);
	end if;	

	--Se estiver parametrizado para nao priorizar conversao a900, entao busca diretamente do material primeiramente e so se nao achar, busca 

	--via conversao
	if ( ie_priorizar_cnv_mat_w = 'N') then
		
		select	max(nr_seq_material_unimed)
		into STRICT	nr_seq_mat_unimed_w
		from	pls_material
		where	nr_sequencia	= nr_seq_material_p;
		
	end if;
	
	if ( coalesce(nr_seq_mat_unimed_w::text, '') = '') then
	
		if (dt_vigencia_p IS NOT NULL AND dt_vigencia_p::text <> '') then
		
			--Se parametrizado para vig?ncia informada A900, ent?o deve buscar maior data inicio vig?ncia da pls_material_unimed que seja

			--inferior a data vig?ncia passada por par?metro
			if (ie_vigencia_informada_a900_w = 'S') then
				
				if (ie_tipo_tabela_p = 3) then

					with query_tmp as (
						select	b.nr_sequencia
						from	pls_material_a900	a,
								pls_material_unimed	b
						where	a.nr_seq_material	= nr_seq_material_p
						and		b.cd_material		= a.cd_material_a900
						and		b.dt_inicio_vigencia_val < dt_vig_ini_w
						order by dt_inicio_vigencia_val desc
					)
					select 	max(nr_sequencia)
					into STRICT	nr_seq_mat_unimed_w
					from	query_tmp LIMIT 1;

				else
				
					with query_tmp as(
						select	b.nr_sequencia
						from	pls_material_a900	a,
								pls_material_unimed	b
						where	a.nr_seq_material	= nr_seq_material_p
						and		b.cd_material		= a.cd_material_a900
						and		b.dt_inicio_vigencia_val < dt_vig_ini_w
						and	exists	(select	1
								from	pls_mat_unimed_trib	c
								where	c.nr_seq_mat_unimed	= b.nr_sequencia
								and		((coalesce(c.dt_inicio_vigencia::text, '') = '') or (dt_vigencia_p > c.dt_inicio_vigencia))
								and		c.id_alc = ie_alc_p)
						order by dt_inicio_vigencia_val desc
					)
					select 	max(nr_sequencia)
					into STRICT	nr_seq_mat_unimed_w
					from	query_tmp LIMIT 1;

				end if;
				
			else
		
				if (ie_tipo_tabela_p = 3) then
					select max(nr_sequencia)
					into STRICT	nr_seq_mat_unimed_w
					from (
						SELECT	b.nr_sequencia
						from	pls_material_a900	a,
							pls_material_unimed	b
						where	a.nr_seq_material	= nr_seq_material_p
						and	b.cd_material		= a.cd_material_a900
						and 	coalesce(a.dt_fim_vigencia::text, '') = ''
						and	a.dt_inicio_vigencia < dt_vig_ini_w
						
union all

						SELECT	b.nr_sequencia
						from	pls_material_a900	a,
							pls_material_unimed	b
						where	a.nr_seq_material	= nr_seq_material_p
						and	b.cd_material		= a.cd_material_a900
						and 	a.dt_fim_vigencia > dt_vig_fim_w
						and 	a.dt_inicio_vigencia < dt_vig_ini_w) alias3;
				else
					select max(nr_sequencia)
					into STRICT	nr_seq_mat_unimed_w
					from 	(
						SELECT	b.nr_sequencia
						from	pls_material_a900	a,
							pls_material_unimed	b
						where	a.nr_seq_material	= nr_seq_material_p
						and	b.cd_material		= a.cd_material_a900
						and 	coalesce(a.dt_fim_vigencia::text, '') = ''
						and	a.dt_inicio_vigencia < dt_vig_ini_w
						and	exists	(SELECT	1
								from	pls_mat_unimed_trib	c
								where	c.nr_seq_mat_unimed	= b.nr_sequencia
								and	((coalesce(c.dt_inicio_vigencia::text, '') = '') or (dt_vigencia_p > c.dt_inicio_vigencia))
								and	c.id_alc = ie_alc_p)
						
union all

						select	b.nr_sequencia
						from	pls_material_a900	a,
							pls_material_unimed	b
						where	a.nr_seq_material	= nr_seq_material_p
						and	b.cd_material		= a.cd_material_a900
						and 	a.dt_fim_vigencia > dt_vig_fim_w
						and 	a.dt_inicio_vigencia < dt_vig_ini_w
						and	exists	(select	1
								from	pls_mat_unimed_trib	c
								where	c.nr_seq_mat_unimed	= b.nr_sequencia
								and	((coalesce(c.dt_inicio_vigencia::text, '') = '') or (dt_vigencia_p > c.dt_inicio_vigencia))
								and	c.id_alc = ie_alc_p)) alias12;
				end if;
			end if;
		else
			select	max(b.nr_sequencia)
			into STRICT	nr_seq_mat_unimed_w
			from	pls_material_a900	a,
					pls_material_unimed	b
			where	a.nr_seq_material	= nr_seq_material_p
			and	b.cd_material		= a.cd_material_a900;
		end if;
	else	
		--Entender que existem duas tabelas em quest?o, a pls_material_unimed e a pls_material_a900 que tem um cd_material_A900 que 

		--? o cd_material da pls_material_unimed

	
		--Se inicialmente encontrou material, quer dizer que retornou diretamente o seq_unimed e a finalidade da 

		--rotina ? buscar o cd_material_a900 que foi utilizado na valoriza??o refletindo o que ocorre na valoriza??o,

		--retornando propositalmente nulo aqui, j? que a valoriza??o n?o levou em conta o registro A900(materiais/Operado /convers?es)
		nr_seq_mat_unimed_w := null;
	
	end if;
	
	select 	max(cd_material)
	into STRICT	cd_material_w
	from	pls_material_unimed
	where 	nr_sequencia = nr_seq_mat_unimed_w;
	
return	cd_material_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_seq_mat_a900 ( nr_seq_material_p pls_material.nr_sequencia%type, dt_vigencia_p timestamp, ie_alc_p pls_mat_unimed_trib.id_alc%type, ie_tipo_tabela_p pls_regra_preco_mat.ie_tabela_adicional%type) FROM PUBLIC;

