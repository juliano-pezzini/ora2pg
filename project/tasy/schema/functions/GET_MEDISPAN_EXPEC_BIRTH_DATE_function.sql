-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_medispan_expec_birth_date ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type ) RETURNS timestamp AS $body$
DECLARE

	
	nr_atendimento_mae_w	atendimento_paciente.nr_atendimento%type;
	dt_retorno_w			med_pac_pre_natal.dt_prov_parto_us%type;
	ie_pac_rn_w				varchar(5);
	dt_nascimento_w			pessoa_fisica.dt_nascimento%type;
	qt_semanas_w			nascimento.qt_sem_ig%type;
	qt_dias_w				nascimento.qt_dia_ig%type;


BEGIN
	dt_retorno_w := null;

	begin
		ie_pac_rn_w := obter_se_Atend_rn(nr_atendimento_p);
		
		if (ie_pac_rn_w = 'S') then
			/* Mesmos selects da GERAR_IGC_RN */

			select	max(a.qt_sem_ig),
					max(a.qt_dia_ig)
			  into STRICT	qt_semanas_w,
					qt_dias_w
			  from	nascimento a
			 where	a.nr_atend_rn = nr_atendimento_p;

			qt_semanas_w := coalesce(qt_semanas_w, 0);
			qt_dias_w    := coalesce(qt_dias_w, 0);

			if ((qt_dias_w IS NOT NULL AND qt_dias_w::text <> '') or (qt_semanas_w IS NOT NULL AND qt_semanas_w::text <> '')) and (coalesce(qt_semanas_w,0)	<= 36) and (coalesce(qt_dias_w,0) <=6)then
				if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

					select	max(a.dt_nascimento)
					  into STRICT	dt_nascimento_w
					  from	pessoa_fisica a
					 where	a.cd_pessoa_fisica = cd_pessoa_fisica_p;

					dt_retorno_w := (dt_nascimento_w + (280 - ((qt_semanas_w * 7) + qt_dias_w)));
				end if;
			end if;

			if (coalesce(dt_retorno_w::text, '') = '') then
				/* Mesmos selects da obter_dados_obst_nascimento. Estao aqui por que o WSI nao esta pegando a data no formato certo na variavel OUT */

				select coalesce(max(nr_atendimento_mae), 0)
				  into STRICT nr_atendimento_mae_w
				  from atendimento_paciente
				 where nr_atendimento = nr_atendimento_p;

				if (nr_atendimento_mae_w > 0) then
					select	max(a.dt_prov_parto_us)
					  into STRICT	dt_retorno_w
					  from	med_pac_pre_natal a
					 where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
												from med_pac_pre_natal b, 
													 atendimento_paciente c 
											   where (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
												 and coalesce(b.dt_inativacao::text, '') = '' 
												 and b.dt_liberacao >= (clock_timestamp() - interval '308 days')
												 and b.nr_atendimento = c.nr_atendimento 
												 and c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_mae_w, 'C'));
				end if;
			end if;
		end if;

	exception when others then
		dt_retorno_w := null;
	end;

	return dt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_medispan_expec_birth_date ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type ) FROM PUBLIC;

