-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cf_obter_alt_dados ( nr_interno_conta_p bigint, ie_tipo_dado_p text) RETURNS varchar AS $body$
DECLARE

 
ie_altera_dados_exec_w	varchar(1)		:= 'N';
ie_altera_dados_guia_w	varchar(1)		:= 'N';
nr_seq_status_fat_w		bigint;
cd_estabelecimento_w	bigint;
cd_empresa_w			bigint;
ie_status_acerto_w		smallint;

c01 CURSOR FOR 
	SELECT	coalesce(ie_altera_dados_exec,'N'), 
			coalesce(ie_altera_dados_guia,'N') 
	from	cf_controle_alt_dados 
	where	coalesce(cd_empresa, cd_empresa_w) = cd_empresa_w	 
	and		coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w 
	and		coalesce(nr_seq_status_fat, nr_seq_status_fat_w) = nr_seq_status_fat_w 
	order by	coalesce(cd_empresa,0), 
				coalesce(cd_estabelecimento,0), 
				coalesce(nr_seq_status_fat,0);


BEGIN 
 
select	coalesce(max(ie_status_acerto),0), 
		coalesce(max(nr_seq_status_fat),0), 
		coalesce(max(cd_estabelecimento),0) 
into STRICT	ie_status_acerto_w, 
		nr_seq_status_fat_w, 
		cd_estabelecimento_w 
from	conta_paciente 
where	nr_interno_conta = nr_interno_conta_p;
 
if (ie_status_acerto_w	in (0,2)) then	 
		ie_altera_dados_exec_w := 'N';
		ie_altera_dados_guia_w := 'N';
		 
else 
 
	select	coalesce(max(cd_empresa),0) 
	into STRICT	cd_empresa_w 
	from	estabelecimento 
	where	cd_estabelecimento = cd_estabelecimento_w;
		 
	open c01;
	loop 
	fetch c01 into	 
		ie_altera_dados_exec_w, 
		ie_altera_dados_guia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		ie_altera_dados_exec_w := ie_altera_dados_exec_w;
		ie_altera_dados_guia_w := ie_altera_dados_guia_w;
		 
		end;
	end loop;
	close c01;
	 
end if;
 
if (ie_tipo_dado_p = 'E') then 
 
		return	ie_altera_dados_exec_w;
		 
elsif (ie_tipo_dado_p = 'G') then 
 
		return	ie_altera_dados_guia_w;
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cf_obter_alt_dados ( nr_interno_conta_p bigint, ie_tipo_dado_p text) FROM PUBLIC;

