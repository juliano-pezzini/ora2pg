-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_equipamento_mat_exame ( nr_seq_exame_p bigint, cd_equipamento_p bigint, nr_seq_material_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


cd_equipamento_w		integer;
ds_sigla_w			varchar(10);
ds_equipamento_w		varchar(50);
cd_exame_equip_w		varchar(20);
cd_exame_equip_integr_w		varchar(20);
Resultado_w	 		varchar(50);


BEGIN

/* Opções
	C	- Código Equipamento
	S	- Sigla Equipamento
	D	- Descrição Equipamento
	CI	- Código Integração
	Caso nao seja uma destas opções busca o equipamento para a sigla
*/
if 	((ie_opcao_p = 'C') or (ie_opcao_p = 'S') or (ie_opcao_p = 'D') or (ie_opcao_p = 'CI')) then

	select 	coalesce(max(a.cd_equipamento),null),
		coalesce(max(b.ds_sigla),null),
		coalesce(max(b.ds_equipamento),null),
		coalesce(max(a.cd_exame_equip),null)
	into STRICT	cd_equipamento_w,
		ds_sigla_w,
		ds_equipamento_w,
		cd_exame_equip_w
	from	equipamento_lab b,
		lab_exame_equip a
	where a.cd_equipamento 	= b.cd_equipamento
	  and a.nr_seq_exame 	= nr_seq_exame_p
	  and a.cd_equipamento	= coalesce(cd_equipamento_p,a.cd_equipamento);

end if;

if (ie_opcao_p = 'C') then
	resultado_w := cd_equipamento_w;
elsif (ie_opcao_p = 'S') then
	resultado_w := ds_sigla_w;
elsif (ie_opcao_p = 'D') then
	resultado_w := ds_equipamento_w;
elsif (ie_opcao_p = 'CI') then
	resultado_w := cd_exame_equip_w;
else
      select coalesce(max(b.cd_exame_equip),null)
	into STRICT cd_exame_equip_integr_w
	from equipamento_lab a,
	     lab_exame_equip b
       where a.cd_equipamento	= b.cd_equipamento
	 and b.nr_seq_exame 	= nr_seq_exame_p
	 and a.ds_sigla 	= ie_opcao_p
	 and coalesce(nr_seq_material,0) = coalesce(nr_seq_material_p,coalesce(nr_seq_material,0));

	resultado_w := cd_exame_equip_integr_w;
end if;

RETURN resultado_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_equipamento_mat_exame ( nr_seq_exame_p bigint, cd_equipamento_p bigint, nr_seq_material_p bigint, ie_opcao_p text) FROM PUBLIC;

