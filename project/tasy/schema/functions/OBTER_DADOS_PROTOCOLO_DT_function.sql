-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_protocolo_dt ( nr_seq_protocolo_p bigint, ie_opcao_p text) RETURNS timestamp AS $body$
DECLARE

 
/* Opção 
 
DT - Data protocolo 
DD - Data Definitivo 
DI - Data integração CR 
DV - Data vencimento 
DE - Data envio 
DTP - Data protocolo diltro (DT_MESANO_REF_PAR) 
DEN - Data de entrega convenio 
DTI - Data inicial protocolo 
DTF - Data fibal protocolo 
DVNF - Data de vencimento da NF 
DTEN - Data de Emissão da Nota 
DVT - Data de vencimento do título 
 
*/
 
 
dt_mesano_referencia_w	timestamp;
dt_mesano_ref_par_w	timestamp;
dt_definitivo_w		timestamp;
dt_integracao_cr_w		timestamp;
dt_vencimento_w		timestamp;
dt_envio_w		timestamp;
dt_entrega_convenio_w	timestamp;
dt_periodo_final_w		timestamp;
dt_periodo_inicial_w	timestamp;
dt_emissao_nota_w		timestamp;

nr_seq_nf_saida_w		bigint;


BEGIN 
 
select	max(dt_mesano_referencia), 
	max(dt_definitivo), 
	max(dt_integracao_cr), 
	max(dt_vencimento), 
	max(dt_envio), 
	max(dt_mesano_ref_par), 
	max(dt_entrega_convenio), 
	max(dt_periodo_final), 
	max(dt_periodo_inicial) 
into STRICT	dt_mesano_referencia_w, 
	dt_definitivo_w, 
	dt_integracao_cr_w, 
	dt_vencimento_w, 
	dt_envio_w, 
	dt_mesano_ref_par_w, 
	dt_entrega_convenio_w, 
	dt_periodo_final_w, 
	dt_periodo_inicial_w 
from	protocolo_convenio 
where	nr_seq_protocolo = nr_seq_protocolo_p;
 
if (ie_opcao_p = 'DT') then 
	return	dt_mesano_referencia_w;
	 
elsif (ie_opcao_p = 'DTP') then 
	return	dt_mesano_ref_par_w;
		 
elsif (ie_opcao_p = 'DD') then 
	return dt_definitivo_w;
	 
elsif (ie_opcao_p = 'DI') then 
	return dt_integracao_cr_w;
	 
elsif (ie_opcao_p = 'DV') then 
	return dt_vencimento_w;
	 
elsif (ie_opcao_p = 'DE') then 
	return dt_envio_w;
	 
elsif (ie_opcao_p = 'DEN') then 
	return	dt_entrega_convenio_w;
	 
elsif (ie_opcao_p = 'DTI') then 
	return	dt_periodo_inicial_w;
	 
elsif (ie_opcao_p = 'DTF') then 
	return	dt_periodo_final_w;
	 
elsif (ie_opcao_p = 'DVNF') then 
	select	min(b.dt_vencimento) 
	into STRICT	dt_vencimento_w 
	from	nota_fiscal_venc b, 
		nota_fiscal a 
	where	a.nr_seq_protocolo	= nr_seq_protocolo_p 
	and	a.nr_sequencia		= b.nr_sequencia;
 
	return dt_vencimento_w;
	 
elsif (ie_opcao_p = 'DTEN') then 
 
	select	max(nr_seq_nf_saida) 
	into STRICT	nr_seq_nf_saida_w 
	from	titulo_receber 
	where	nr_seq_protocolo = nr_seq_protocolo_p 
	and 	coalesce(nr_nota_fiscal,'0')	<> '0';
	 
	select	max(dt_emissao) 
	into STRICT	dt_emissao_nota_w 
	from	nota_fiscal 
	where	nr_sequencia = nr_seq_nf_saida_w;
	 
	if (coalesce(dt_emissao_nota_w::text, '') = '') then --Se não localizou NF vinculada ao título do protocolo, busca direto a NF do protocolo. 
	 
		select	max(a.dt_emissao) 
		into STRICT	dt_emissao_nota_w 
		from	nota_fiscal a 		 
		where	a.nr_seq_protocolo	= nr_seq_protocolo_p;
		 
	end if;
 
	return dt_emissao_nota_w;
	 
elsif (ie_opcao_p = 'DVT') then 
 
	select	min(a.dt_vencimento) 
	into STRICT	dt_vencimento_w 
	from	titulo_receber a 
	where	a.nr_seq_protocolo	= nr_seq_protocolo_p 
	and	a.ie_situacao		= '1';
	 
	return dt_vencimento_w;
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_protocolo_dt ( nr_seq_protocolo_p bigint, ie_opcao_p text) FROM PUBLIC;

