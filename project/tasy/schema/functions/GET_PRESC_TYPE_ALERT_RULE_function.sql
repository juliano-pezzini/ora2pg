-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_presc_type_alert_rule ( nr_seq_order_unit_p bigint ) RETURNS varchar AS $body$
DECLARE

ds_retorno_w cpoe_presc_type_alert_rule.ds_alert_message%type := null;
qt_record_w	bigint;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
ie_tipo_atendimento_w	atendimento_paciente.ie_tipo_atendimento%type;
si_type_of_prescription_w	cpoe_order_unit.si_type_of_prescription%type;
cd_pessoa_fisica_w	cpoe_order_unit.cd_pessoa_fisica%type;
dt_order_w	cpoe_order_unit.dt_start%type;
dt_start_w	cpoe_order_unit.dt_start%type;
dt_end_w	cpoe_order_unit.dt_start%type;
ds_lang_tag_w	user_locale.ds_locale%type;
ds_date_mask_shortdate_w	locale_formats.ds_localized_mask%type;
ds_date_mask_shorttime_w	locale_formats.ds_localized_mask%type;
ds_date_mask_withhours_w	locale_formats.ds_localized_mask%type;

c_rule CURSOR FOR
SELECT  a.ds_alert_message,
        a.ie_tipo_atendimento,
        a.si_type_of_prescription,
        a.hr_start,
        a.hr_end,
        qt_days_before
from    cpoe_presc_type_alert_rule a
where   a.cd_estabelecimento = cd_estabelecimento_w;

BEGIN

-- Get lang tag and all formats date from locale
ds_lang_tag_w := pkg_date_formaters.getUserLanguageTag(cd_estabelcimento_p	=> wheb_usuario_pck.get_cd_estabelecimento,
		nm_usuario_p	=> wheb_usuario_pck.get_nm_usuario);
ds_date_mask_shortdate_w:= pkg_date_formaters.localize_mask(ds_mask => 'shortDate',
		lang_tag=> ds_lang_tag_w);
ds_date_mask_shorttime_w:= pkg_date_formaters.localize_mask(ds_mask => 'shortTime',
		lang_tag=> ds_lang_tag_w);
ds_date_mask_withhours_w:= pkg_date_formaters.localize_mask(ds_mask => 'short',
		lang_tag=> ds_lang_tag_w);

begin
select  b.cd_estabelecimento,
        b.ie_tipo_atendimento,
        a.si_type_of_prescription,
        a.cd_pessoa_fisica,
        coalesce(a.dt_start,clock_timestamp())
into STRICT    cd_estabelecimento_w,
        ie_tipo_atendimento_w,
        si_type_of_prescription_w,
        cd_pessoa_fisica_w,
        dt_order_w
from    atendimento_paciente b,
        cpoe_order_unit a
where   a.nr_atendimento = b.nr_atendimento
and     a.nr_sequencia = nr_seq_order_unit_p;
exception
    when others then
    cd_estabelecimento_w    := null;
    ie_tipo_atendimento_w   := null;
    si_type_of_prescription_w  := null;
end;

for r_c_rule in c_rule loop

	dt_start_w := to_date(to_char(dt_order_w, ds_date_mask_shortdate_w) || ' ' ||to_char(r_c_rule.hr_start, ds_date_mask_shorttime_w),
                                        ds_date_mask_shortdate_w || ' ' || ds_date_mask_shorttime_w);
	dt_end_w := to_date( to_char(dt_order_w, ds_date_mask_shortdate_w) || ' ' ||to_char(r_c_rule.hr_end, ds_date_mask_shorttime_w),
                                        ds_date_mask_shortdate_w || ' ' || ds_date_mask_shorttime_w);

    if (ie_tipo_atendimento_w = r_c_rule.ie_tipo_atendimento or coalesce(r_c_rule.ie_tipo_atendimento::text, '') = '') and (coalesce(r_c_rule.hr_start::text, '') = '' or dt_order_w >= dt_start_w) and (coalesce(r_c_rule.hr_end::text, '') = '' or dt_order_w <= dt_end_w ) then

        select  count(1)
        into STRICT    qt_record_w
        from    cpoe_order_unit a
        where   a.cd_pessoa_fisica = cd_pessoa_fisica_w
        and     (coalesce(a.dt_start,clock_timestamp()) >= (trunc(dt_order_w,'dd') - r_c_rule.qt_days_before) or coalesce(r_c_rule.qt_days_before::text, '') = '')
        and (coalesce(r_c_rule.hr_start::text, '') = '' or to_char(coalesce(a.dt_start,clock_timestamp()), 'hh24mi') >= to_char(coalesce(r_c_rule.hr_start,clock_timestamp()), 'hh24mi'))
        and (coalesce(r_c_rule.hr_end::text, '') = '' or to_char(coalesce(a.dt_start,clock_timestamp()), 'hh24mi') <= to_char(coalesce(r_c_rule.hr_end,clock_timestamp()), 'hh24mi'))
        and     a.si_type_of_prescription = r_c_rule.si_type_of_prescription
        and     a.si_type_of_prescription = si_type_of_prescription_w
        and     a.nr_sequencia <> nr_seq_order_unit_p;

        if (qt_record_w > 0) then
            ds_retorno_w := ds_retorno_w || r_c_rule.ds_alert_message || chr(13)||chr(10);
        end if;

    end if;
end loop;

if (length(ds_retorno_w) > 0) then
	ds_retorno_w := substr(ds_retorno_w, 1, length(ds_retorno_w) - 2);
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_presc_type_alert_rule ( nr_seq_order_unit_p bigint ) FROM PUBLIC;

