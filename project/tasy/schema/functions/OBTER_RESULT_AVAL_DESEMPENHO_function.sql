-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_result_aval_desempenho ( dt_inicio_vigencia_p timestamp, dt_fim_vigencia_p timestamp, cd_cnpj_p text, cd_estabelecimento_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

 
/*ie_opcao_p 
LR - Lotes Rejeitados 
TL - Total Lotes 
D - Desempenho 
AD - Avaliação Desempenho*/
 
 
qt_lotes_rejeitados_w			double precision;
qt_total_lotes_w				double precision;
qt_desempenho_w				double precision;
qt_aval_desempenho_w			double precision;
vl_retorno_w				double precision;
qt_avaliacao_w				bigint;


BEGIN 
 
select	sum(a.qt_devolucao) qt_lotes_rejeitados, 
	(select	count(*) 
	from	nota_fiscal_v x 
	where  x.cd_estabelecimento = cd_estabelecimento_p 
	and 	x.cd_cgc = a.cd_fornecedor 
	and 	x.ie_tipo_nota = 'EN' 
	and	coalesce(x.ie_situacao,'1') = '1' 
	and 	trunc(dt_entrada_saida,'dd') between dt_inicio_vigencia_p and dt_fim_vigencia_p) qt_total_lotes, 
	dividir(sum(a.qt_devolucao),(	select	count(*) 
					from	nota_fiscal_v x 
					where  x.cd_estabelecimento = cd_estabelecimento_p 
					and 	x.cd_cgc = a.cd_fornecedor 
					and 	x.ie_tipo_nota = 'EN' 
					and	coalesce(x.ie_situacao,'1') = '1' 
					and	trunc(x.dt_entrada_saida,'dd') between dt_inicio_vigencia_p and dt_fim_vigencia_p)) qt_desempenho, 
	((1 - (dividir(sum(a.qt_devolucao),(	select	count(*) 
					from	nota_fiscal_v x 
					where  x.cd_estabelecimento = cd_estabelecimento_p 
					and 	x.cd_cgc = a.cd_fornecedor 
					and 	x.ie_tipo_nota = 'EN' 
					and	coalesce(x.ie_situacao,'1') = '1' 
					and 	x.dt_entrada_saida between trunc(dt_inicio_vigencia_p,'mm') and dt_fim_vigencia_p)))) * 100) qt_aval_desempenho, 
	count(1) 
into STRICT	qt_lotes_rejeitados_w, 
	qt_total_lotes_w, 
	qt_desempenho_w, 
	qt_aval_desempenho_w, 
	qt_avaliacao_w 
from	avaliacao_fornecedor a, 
	pessoa_juridica b 
where	a.cd_fornecedor = b.cd_cgc 
and	a.cd_fornecedor = cd_cnpj_p 
and	a.dt_mesano_referencia between trunc(dt_inicio_vigencia_p,'mm') and trunc(dt_fim_vigencia_p,'mm') 
group by a.cd_fornecedor;
 
select 	CASE WHEN qt_aval_desempenho_w=0 THEN  100  ELSE qt_aval_desempenho_w END  
into STRICT	qt_aval_desempenho_w
;
 
if (ie_opcao_p = 'LR') then 
	vl_retorno_w	:= qt_lotes_rejeitados_w;
elsif (ie_opcao_p = 'TL') then 
	vl_retorno_w	:= qt_total_lotes_w;
elsif (ie_opcao_p = 'D') then 
	vl_retorno_w	:= qt_desempenho_w;
elsif (ie_opcao_p = 'AD') then 
	vl_retorno_w	:= qt_aval_desempenho_w;
elsif (ie_opcao_p = 'QA') then 
	vl_retorno_w	:= qt_avaliacao_w;
end if;	
 
return	vl_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_result_aval_desempenho ( dt_inicio_vigencia_p timestamp, dt_fim_vigencia_p timestamp, cd_cnpj_p text, cd_estabelecimento_p bigint, ie_opcao_p text) FROM PUBLIC;

