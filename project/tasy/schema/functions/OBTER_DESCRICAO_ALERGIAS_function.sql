-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_descricao_alergias (cd_pessoa_fisica_p text) RETURNS varchar AS $body$
DECLARE


    -- Variaveis
    ds_alergia_w 	            varchar(4000);
    ds_retorno_w	            varchar(4000) := null;
    ds_intensidade_w            varchar(4000) := null;
    ie_intensidade_w            varchar(4000) := null;
    ie_liberar_hist_saude_w		varchar(1);

    -- Cursor para guardar as alergias
    c_alergias CURSOR FOR
        SELECT	distinct coalesce(
            v.ds_ficha_tecnica,
            v.ds_dcb,            
            v.ds_material,
	    v.ds_dcb_mat,
            v.ds_classe_mat,
            v.ds_medic_nao_cad,
            v.ds_alergeno) ds_agente,
            a.ie_intensidade ie_intensidade
        from	alergia_v v,
                paciente_alergia a
        where	v.cd_pessoa_fisica = cd_pessoa_fisica_p
            and a.cd_pessoa_fisica = v.cd_pessoa_fisica
            and a.nr_sequencia = v.nr_seq_alerta
            and	((ie_liberar_hist_saude_w = 'N') or (v.dt_liberacao IS NOT NULL AND v.dt_liberacao::text <> ''))
        order	by 1;

BEGIN
    -- Obter o ie_liberar_hist_saude_w
    select	coalesce(max(ie_liberar_hist_saude),'N')
    into STRICT	ie_liberar_hist_saude_w
    from	parametro_medico
    where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

    
    -- Tratar a descricao das alergias
    for linha_cursor in c_alergias() loop
        ds_alergia_w        := linha_cursor.ds_agente;
        ie_intensidade_w    := linha_cursor.ie_intensidade;
        ds_intensidade_w    := null;

        if (ds_alergia_w IS NOT NULL AND ds_alergia_w::text <> '')then            
            ds_retorno_w := ds_retorno_w || ds_alergia_w;

            if (ie_intensidade_w = 'L')then
                ds_intensidade_w :=  obter_desc_expressao(331099); -- leve
            end if;

            if (ie_intensidade_w = 'M') then
                ds_intensidade_w :=  obter_desc_expressao(331188); -- moderada
            end if;

            if (ie_intensidade_w = 'I') then
                ds_intensidade_w :=  obter_desc_expressao(487813); -- intensa
            end if;

            if (ie_intensidade_w = 'D') then
                ds_intensidade_w :=  obter_desc_expressao(965143); -- desconhecido / nao informado
            end if;

            if (ds_intensidade_w IS NOT NULL AND ds_intensidade_w::text <> '')then
                ds_retorno_w := ds_retorno_w || ' - ' || ds_intensidade_w ||'; ';
            end if;
            
        end if;
       
    end loop;

    return	ds_retorno_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_descricao_alergias (cd_pessoa_fisica_p text) FROM PUBLIC;

