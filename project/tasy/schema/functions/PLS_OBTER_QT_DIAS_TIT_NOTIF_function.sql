-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_qt_dias_tit_notif ( nr_seq_notific_pagador_p bigint, nr_titulo_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

/*	ie_opcao_p 
	DTL = Data do lote 
	DTA = Data atual 
*/
 
 
qt_dias_w			bigint;
dt_referencia_w			timestamp;
dt_lote_w			pls_notificacao_lote.dt_lote%type;
nr_seq_regra_w			pls_notificacao_regra.nr_sequencia%type;
ie_data_base_w			pls_notificacao_regra.ie_data_base%type;
dt_vencimento_titulo_w		pls_notificacao_item.dt_vencimento_titulo%type;
dt_vencimento_original_w	pls_notificacao_item.dt_vencimento_original%type;


BEGIN 
 
if (nr_seq_notific_pagador_p IS NOT NULL AND nr_seq_notific_pagador_p::text <> '') and (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') then 
	dt_referencia_w	:= clock_timestamp();
	 
	select	trunc(max(b.dt_lote),'dd'), 
		max(b.nr_seq_regra) 
	into STRICT	dt_lote_w, 
		nr_seq_regra_w 
	from	pls_notificacao_lote b, 
		pls_notificacao_pagador a 
	where	a.nr_seq_lote	= b.nr_sequencia 
	and	a.nr_sequencia	= nr_seq_notific_pagador_p;
	 
	if (ie_opcao_p = 'DTL') then 
		dt_referencia_w	:= dt_lote_w;
	end if;
	 
	select	coalesce(max(ie_data_base),'VA') 
	into STRICT	ie_data_base_w 
	from	pls_notificacao_regra 
	where	nr_sequencia	= nr_seq_regra_w;
	 
	select	trunc(max(a.dt_vencimento_titulo),'dd'), 
		trunc(max(a.dt_vencimento_original),'dd') 
	into STRICT	dt_vencimento_titulo_w, 
		dt_vencimento_original_w 
	from	pls_notificacao_item a 
	where	a.nr_seq_notific_pagador = nr_seq_notific_pagador_p 
	and	a.nr_titulo	= nr_titulo_p;
	 
	if (ie_data_base_w = 'VO') then 
		qt_dias_w	:= dt_referencia_w - dt_vencimento_original_w;
	else 
		qt_dias_w	:= dt_referencia_w - dt_vencimento_titulo_w;
	end if;
end if;
 
return	qt_dias_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_qt_dias_tit_notif ( nr_seq_notific_pagador_p bigint, nr_titulo_p bigint, ie_opcao_p text) FROM PUBLIC;

