-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_insurance_holder_value ( cd_pessoa_fisica_p bigint, nr_sequencia_p bigint, ie_insurance_type_p bigint, ie_opcao_p text, cd_convenio_p text) RETURNS varchar AS $body$
DECLARE

ie_retorno_w 		varchar(30) := '';
nr_sequencia_w 		bigint;
cd_convenio_w 		bigint;
cd_rec_convenio_w 	bigint;


BEGIN
nr_sequencia_w := get_insurance_holder_sequencia(cd_pessoa_fisica_p, ie_insurance_type_p);

if (coalesce(nr_sequencia_w::text, '') = '' and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '')) then
	nr_sequencia_w := nr_sequencia_p;
end if;

if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
  /*
						ie_opcao_p
  Category  					'C'
  Plan   					'P'
  Holder   					'H'
  Membership  					'M'
  To know if insurance is of medcare		'E'
  */
  
	case ie_opcao_p
	
		when 'C' then
			select	to_char(cd_categoria)
			into STRICT	ie_retorno_w
			from	pessoa_titular_convenio
			where	nr_sequencia = nr_sequencia_w;
		when 'P' then
			select	to_char(cd_plano_convenio)
			into STRICT	ie_retorno_w
			from 	pessoa_titular_convenio
			where 	nr_sequencia = nr_sequencia_w;
		when 'H' then
			select 	to_char(cd_pessoa_titular)
			into STRICT 	ie_retorno_w
			from 	pessoa_titular_convenio
			where 	nr_sequencia = nr_sequencia_w;
		when 'M' then
			select 	to_char(cd_usuario_convenio)
			into STRICT 	ie_retorno_w
			from 	pessoa_titular_convenio
			where 	nr_sequencia = nr_sequencia_w;
		when 'E' then
		
			select 	max(cd_convenio)
			into STRICT 	cd_convenio_w
			from 	convenio
			where 	ie_tipo_convenio 	= 12
			and 	cd_convenio = cd_convenio_p;

			if (cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') then
				ie_retorno_w := 'S';
			else
				ie_retorno_w := 'N';
			end if;
	
	end case;
end if;
return ie_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_insurance_holder_value ( cd_pessoa_fisica_p bigint, nr_sequencia_p bigint, ie_insurance_type_p bigint, ie_opcao_p text, cd_convenio_p text) FROM PUBLIC;

