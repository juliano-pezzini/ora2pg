-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_dose_total_mat_orc (nr_sequencia_orcamento_p bigint, nr_seq_mat_orcamento_p bigint) RETURNS bigint AS $body$
DECLARE


qt_dose_retorno_w		orcamento_paciente_mat.qt_dose%type;
qt_dose_w			orcamento_paciente_mat.qt_dose%type;
qt_superficie_corporea_w	orcamento_paciente_mat.qt_superficie_corporea%type;
ds_dias_aplicacao_w		orcamento_paciente_mat.ds_dias_aplicacao%type;
ds_ciclos_aplicacao_w		orcamento_paciente_mat.ds_ciclos_aplicacao%type;

cd_estabelecimento_w		orcamento_paciente.cd_estabelecimento%type;

qt_dias_ciclo_mult_w		bigint;
ie_regra_apresent_quimio_w	varchar(1);


BEGIN

if (coalesce(nr_seq_mat_orcamento_p,0) > 0) then

	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	orcamento_paciente
	where	nr_sequencia_orcamento = nr_sequencia_orcamento_p;

	select	max(qt_dose),
		coalesce(max(qt_superficie_corporea),1),
		max(ds_dias_aplicacao),
		max(ds_ciclos_aplicacao)
	into STRICT	qt_dose_w,
		qt_superficie_corporea_w,
		ds_dias_aplicacao_w,
		ds_ciclos_aplicacao_w
	from	orcamento_paciente_mat
	where	nr_sequencia_orcamento = nr_sequencia_orcamento_p
	and	nr_sequencia = nr_seq_mat_orcamento_p;	


	if (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') then

		ie_regra_apresent_quimio_w	:=  coalesce(Obter_valor_param_usuario(106, 135,obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario,cd_estabelecimento_w),'N');

		if (ie_regra_apresent_quimio_w = 'C') then
		
			qt_dias_ciclo_mult_w	:= 1;
			
			if (ds_dias_aplicacao_w IS NOT NULL AND ds_dias_aplicacao_w::text <> '') then
				qt_dias_ciclo_mult_w	:= qt_dias_ciclo_mult_w * obter_qt_dias_aplicacao(ds_dias_aplicacao_w);
			end if;
			
			if (ds_ciclos_aplicacao_w IS NOT NULL AND ds_ciclos_aplicacao_w::text <> '') then
				qt_dias_ciclo_mult_w	:= qt_dias_ciclo_mult_w * obter_qt_ciclos_aplicacao(ds_ciclos_aplicacao_w);
			end if;
		
			qt_dose_retorno_w	:= qt_dose_w * qt_dias_ciclo_mult_w;
			
		else
			qt_dose_retorno_w	:= qt_dose_w * qt_superficie_corporea_w;
		end if;
		
	end if;
	
end if;
	
return	qt_dose_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_dose_total_mat_orc (nr_sequencia_orcamento_p bigint, nr_seq_mat_orcamento_p bigint) FROM PUBLIC;

