-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valores_item_nf_icms ( nr_seq_nf_p bigint, nr_item_nf_p bigint, ie_tipo_valor_p text) RETURNS bigint AS $body$
DECLARE


vl_contabil_w		double precision;
vl_base_calculo_w		double precision;
vl_tributo_w		double precision;
vl_isenta_w		double precision;
vl_outras_w		double precision;
vl_retorno		double precision;

/*Valor Contábil 		- VC
Base de Calculo	     	- BC
Valor tributo	     	- VT
Isenta ou não tributada	     	- IT
Outros valores	     	- O */
BEGIN

	select	coalesce(sum(i.vl_total_item_nf),0) vl_item_nf,
		coalesce(sum(obter_valor_nf_item(i.nr_sequencia, i.nr_item_nf, 'ICMS', 'BC')),0) vl_base_calculo_item,
		coalesce(sum(obter_valor_nf_item(i.nr_sequencia, i.nr_item_nf, 'ICMS', 'VT')),0) vl_tributo
	into STRICT	vl_contabil_w,
		vl_base_calculo_w,
		vl_tributo_w
	from	natureza_operacao o,
		nota_fiscal a,
		nota_fiscal_item i
	where	i.cd_natureza_operacao	= o.cd_natureza_operacao
	and	i.nr_sequencia		= a.nr_sequencia
	and	exists (	SELECT  t.nr_item_nf
				from	nota_fiscal_item_trib t,
						tributo d
				where	t.nr_sequencia = i.nr_sequencia
				and		t.nr_item_nf = i.nr_item_nf
				and		t.cd_tributo	= d.cd_tributo
				and		d.ie_tipo_tributo = 'ICMS')
	and	a.nr_sequencia = nr_seq_nf_p
	and	i.nr_item_nf   = nr_item_nf_p;

	select	coalesce(sum(i.vl_total_item_nf),0) vl_item_nf
	into STRICT	vl_isenta_w
	from	natureza_operacao o,
		nota_fiscal a,
		nota_fiscal_item i
	where	i.cd_natureza_operacao	= o.cd_natureza_operacao
	and	i.nr_sequencia		= a.nr_sequencia
	and	not exists (	SELECT  t.nr_item_nf
			from	nota_fiscal_item_trib t,
					tributo d
			where	t.nr_sequencia = i.nr_sequencia
			and	t.nr_item_nf = i.nr_item_nf
			and	t.cd_tributo	= d.cd_tributo
			and	d.ie_tipo_tributo = 'ICMS')
	and a.nr_sequencia = nr_seq_nf_p
	and	i.nr_item_nf   = nr_item_nf_p;

	if (vl_contabil_w > 0) then
		vl_outras_w := vl_contabil_w - vl_base_calculo_w - vl_isenta_w;
	end if;

	if (UPPER(ie_tipo_valor_p) = 'VC') then
		vl_retorno := vl_contabil_w;
	elsif (UPPER(ie_tipo_valor_p) = 'BC') then
		vl_retorno := vl_base_calculo_w;
	elsif (UPPER(ie_tipo_valor_p) = 'VT') then
		vl_retorno := vl_tributo_w;
	elsif (UPPER(ie_tipo_valor_p) = 'IT') then
		vl_retorno := vl_isenta_w;
	elsif (UPPER(ie_tipo_valor_p) = 'O') then
		vl_retorno := vl_outras_w;
	end if;

return	vl_retorno;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valores_item_nf_icms ( nr_seq_nf_p bigint, nr_item_nf_p bigint, ie_tipo_valor_p text) FROM PUBLIC;

