-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nf_conta_ret ( nr_interno_conta_P bigint, ie_opcao_p bigint default null) RETURNS varchar AS $body$
DECLARE

 
/*ie_opcao_p				 
1	Nota fiscel 
2	NFE 
*/
 
 
nr_nota_fiscal_w	bigint;
ds_nota_w		varchar(4000)	:= ' ';
nr_seq_lote_prot_w	bigint;
nr_nfe_imp_w		varchar(255);
ds_nota_nfe_imp_w	varchar(4000)	:= ' ';

C01 CURSOR FOR 
SELECT	c.nr_nota_fiscal nr_nota, 
	c.nr_nfe_imp 
from	nota_fiscal c 
where	c.nr_interno_conta = nr_interno_conta_p 
and	c.ie_situacao = '1';

C02 CURSOR FOR 
SELECT	c.nr_nota_fiscal nr_nota, 
	c.nr_nfe_imp 
from	conta_paciente a, 
	protocolo_convenio b, 
	nota_fiscal c 
where	a.nr_seq_protocolo = b.nr_Seq_protocolo 
and	b.nr_seq_protocolo = c.nr_seq_protocolo 
and	a.nr_interno_conta = nr_interno_conta_p 
and	c.ie_situacao = '1';

C03 CURSOR FOR 
SELECT	c.nr_nota_fiscal nr_nota, 
	c.nr_nfe_imp 
from	nota_fiscal c 
where	c.ie_situacao = '1' 
and	c.nr_seq_lote_prot = nr_seq_lote_prot_w;


BEGIN 
 
 
open C01;
loop 
fetch C01 into 
	nr_nota_fiscal_w, 
	nr_nfe_imp_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	if (length(ds_nota_w) < 3600) then 
		ds_nota_w := substr(ds_nota_w || nr_nota_fiscal_w ||', ',1,4000);
	end if;
	if (length(ds_nota_nfe_imp_w) < 3600) and (nr_nfe_imp_w IS NOT NULL AND nr_nfe_imp_w::text <> '') then 
		ds_nota_nfe_imp_w := substr(ds_nota_nfe_imp_w || nr_nfe_imp_w ||', ',1,4000);
	end if;
end loop;
close C01;
 
open C02;
loop 
fetch C02 into 
	nr_nota_fiscal_w, 
	nr_nfe_imp_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	if (length(ds_nota_w) < 3600) then 
		ds_nota_w := substr(ds_nota_w || nr_nota_fiscal_w ||', ',1,4000);
	end if;
	if (length(ds_nota_nfe_imp_w) < 3600) and (nr_nfe_imp_w IS NOT NULL AND nr_nfe_imp_w::text <> '') then 
		ds_nota_nfe_imp_w := substr(ds_nota_nfe_imp_w || nr_nfe_imp_w ||', ',1,4000);
	end if;
end loop;
close C02;
 
select	max(a.nr_seq_lote_protocolo) 
into STRICT	nr_seq_lote_prot_w 
from	protocolo_convenio a, 
	conta_paciente b	 
where	a.nr_seq_protocolo 	= b.nr_Seq_protocolo 
and	b.nr_interno_conta 	= nr_interno_conta_p;
 
 
open C03;
loop 
fetch C03 into	 
	nr_nota_fiscal_w, 
	nr_nfe_imp_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	if (length(ds_nota_w) < 3600) then 
		ds_nota_w := substr(ds_nota_w || nr_nota_fiscal_w ||', ',1,4000);
	end if;
	if (length(ds_nota_nfe_imp_w) < 3600) and (nr_nfe_imp_w IS NOT NULL AND nr_nfe_imp_w::text <> '') then 
		ds_nota_nfe_imp_w := substr(ds_nota_nfe_imp_w || nr_nfe_imp_w ||', ',1,4000);
	end if;
end loop;
close C03;
 
if (coalesce(ie_opcao_p,1) = 1) then --Nota Fiscal 
	return ltrim(substr(ds_nota_w,1,length(ds_nota_w) - 2));
elsif (coalesce(ie_opcao_p,1) = 2) then --NFE 
	return ltrim(substr(ds_nota_nfe_imp_w,1,length(ds_nota_nfe_imp_w) - 2));
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nf_conta_ret ( nr_interno_conta_P bigint, ie_opcao_p bigint default null) FROM PUBLIC;

