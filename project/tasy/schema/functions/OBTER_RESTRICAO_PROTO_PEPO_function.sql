-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_restricao_proto_pepo (cd_pessoa_fisica_p text, nr_seq_item_p bigint, ie_type_p text) RETURNS varchar AS $body$
DECLARE


cidades CURSOR FOR
SELECT f.qt_idade_max, f.qt_idade_min, f.qt_idade_max_mes, f.qt_idade_min_mes, f.qt_idade_max_dia, f.qt_idade_min_dia, f.qt_ig_max, f.qt_ig_min,a.NR_SEQ_FAIXA_ETARIA
from prot_modelo_cirurg_restr a,
     faixa_etaria_cuidado f
where f.nr_sequencia = a.nr_seq_faixa_etaria
  and ((ie_type_p = 'T' and a.nr_seq_tec_anest = nr_seq_item_p)
    or (ie_type_p = 'H' and a.nr_seq_hemo = nr_seq_item_p)
    or (ie_type_p = 'N' and a.nr_seq_nota_cli = nr_seq_item_p)
    or (ie_type_p = 'A' and a.nr_seq_agente_anest = nr_seq_item_p));

w_retorno varchar(1) := 'S';
w_count integer;
w_anos smallint;
w_meses smallint;
w_dias smallint;
w_igest smallint;

BEGIN

select count(1)
into STRICT w_count
from prot_modelo_cirurg_restr a
where ((ie_type_p = 'T' and a.nr_seq_tec_anest = nr_seq_item_p)
    or (ie_type_p = 'H' and a.nr_seq_hemo = nr_seq_item_p)
    or (ie_type_p = 'N' and a.nr_seq_nota_cli = nr_seq_item_p)
    or (ie_type_p = 'A' and a.nr_seq_agente_anest = nr_seq_item_p)
    );

if (w_count > 0) then
	w_retorno := 'N';

	select obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'A')
		  ,obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'MM')
		  ,obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'DI')
	  into STRICT w_anos, w_meses, w_dias
	;

	select coalesce(max(qt_ig_semana),-1)
	  into STRICT w_igest
	  from atendimento_gravidez
	 where nr_sequencia = (SELECT max(nr_sequencia)
							 from atendimento_gravidez
							where cd_pessoa_fisica = cd_pessoa_fisica_p
							  and ie_pac_gravida = 'S'
						  );

	for r1 in cIdades loop
		if ((r1.qt_idade_max IS NOT NULL AND r1.qt_idade_max::text <> '') or (r1.qt_idade_min IS NOT NULL AND r1.qt_idade_min::text <> '')) then
			if ((w_anos between coalesce(r1.qt_idade_min,w_anos) and coalesce(r1.qt_idade_max,w_anos))
			and (w_meses between coalesce(r1.qt_idade_min_mes,w_meses) and coalesce(r1.qt_idade_max_mes,w_meses))
			and (w_dias between coalesce(r1.qt_idade_min_dia,w_dias) and coalesce(r1.qt_idade_max_dia,w_dias))
			and (w_igest between coalesce(r1.qt_ig_min,w_igest) and coalesce(r1.qt_ig_max,w_igest))) then
				w_retorno := 'S';
			end if;
		elsif (((r1.qt_idade_max_mes IS NOT NULL AND r1.qt_idade_max_mes::text <> '') or (r1.qt_idade_min_mes IS NOT NULL AND r1.qt_idade_min_mes::text <> '')) and w_anos <= 0) then
			if ((w_meses between coalesce(r1.qt_idade_min_mes,w_meses) and coalesce(r1.qt_idade_max_mes,w_meses))
			and (w_dias between coalesce(r1.qt_idade_min_dia,w_dias) and coalesce(r1.qt_idade_max_dia,w_dias))
			and (w_igest between coalesce(r1.qt_ig_min,w_igest) and coalesce(r1.qt_ig_max,w_igest))) then
				w_retorno := 'S';
			end if;
		elsif (((r1.qt_idade_min_dia IS NOT NULL AND r1.qt_idade_min_dia::text <> '') or (r1.qt_idade_max_dia IS NOT NULL AND r1.qt_idade_max_dia::text <> '')) and (w_anos <= 0 and w_meses <= 0)) then
			if (w_dias between coalesce(r1.qt_idade_min_dia,w_dias) and coalesce(r1.qt_idade_max_dia,w_dias)
			and (w_igest between coalesce(r1.qt_ig_min,w_igest) and coalesce(r1.qt_ig_max,w_igest))) then
				w_retorno := 'S';
			end if;
		elsif (w_igest >= 0 and (w_igest between coalesce(r1.qt_ig_min,w_igest) and coalesce(r1.qt_ig_max,w_igest))) then
				w_retorno := 'S';
		end if;
	end loop;
end if;
return w_retorno;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_restricao_proto_pepo (cd_pessoa_fisica_p text, nr_seq_item_p bigint, ie_type_p text) FROM PUBLIC;

