-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_titular_obito ( nr_seq_segurado_p bigint, ie_tipo_obito_p text, ie_tipo_retorno_p text) RETURNS varchar AS $body$
DECLARE

			
/*ie_tipo_obito_p
M - Manter no contrato atual
N  - Gerar novo contrato
*/


/*ie_tipo_retorno_p
P - Possui beneficio
S - Retorna a sequencia da regra
Q - Quantidade de anos de validade
*/
			
ds_retorno_w		varchar(10);
qt_registros_w		bigint;
dt_contrato_w		pls_contrato.dt_contrato%type;
nr_seq_contrato_w	bigint;
nr_seq_intercambio_w	bigint;


BEGIN

select	nr_seq_contrato,
	nr_seq_intercambio
into STRICT	nr_seq_contrato_w,
	nr_seq_intercambio_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;

if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
	select dt_contrato
	into STRICT dt_contrato_w
	from pls_contrato
	where nr_sequencia = nr_seq_contrato_w;
	
elsif (nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') then
	select dt_inclusao
	into STRICT dt_contrato_w
	from pls_intercambio
	where nr_sequencia = nr_seq_intercambio_w;	
else
	dt_contrato_w	:= clock_timestamp();
end if;

select	count(*)
into STRICT	qt_registros_w
from	PLS_SCA_REGRA_OBITO	c,
	pls_sca_vinculo		b,
	pls_plano		a
where	b.nr_seq_plano		= a.nr_sequencia
and	c.nr_seq_sca		= a.nr_sequencia
and	b.nr_seq_segurado	= nr_seq_segurado_p
and	((coalesce(b.dt_fim_vigencia::text, '') = '') or (b.dt_fim_vigencia > clock_timestamp()))
and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
and	dt_contrato_w between trunc(coalesce(c.dt_contrato_inicial, dt_contrato_w),'dd') and fim_dia(coalesce(c.dt_contrato_final, dt_contrato_w))
and	c.ie_acao_seguro	= ie_tipo_obito_p;


if (ie_tipo_retorno_p = 'P') then
	if (qt_registros_w > 0) then
		ds_retorno_w	:= 'S';
	else
		ds_retorno_w	:= 'N';
	end if;	
elsif (ie_tipo_retorno_p = 'S') then
	if (qt_registros_w > 0) then
		select	to_char(max(c.nr_sequencia))	
		into STRICT	ds_retorno_w
		from	PLS_SCA_REGRA_OBITO	c,
			pls_sca_vinculo		b,
			pls_plano		a	
		where	b.nr_seq_plano		= a.nr_sequencia
		and	c.nr_seq_sca		= a.nr_sequencia
		and	b.nr_seq_segurado	= nr_seq_segurado_p
		and	((coalesce(b.dt_fim_vigencia::text, '') = '') or (b.dt_fim_vigencia > clock_timestamp()))
		and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
		and	dt_contrato_w between trunc(coalesce(c.dt_contrato_inicial, dt_contrato_w),'dd') and fim_dia(coalesce(c.dt_contrato_final, dt_contrato_w))
		and	c.ie_acao_seguro	= ie_tipo_obito_p;
	end if;
elsif (ie_tipo_retorno_p = 'Q') then
	if (qt_registros_w > 0) then
	select	to_char(max(c.QT_VALIDADE_CONTRATO))
		into STRICT	ds_retorno_w
		from	PLS_SCA_REGRA_OBITO	c,
			pls_sca_vinculo		b,
			pls_plano		a
		where	b.nr_seq_plano		= a.nr_sequencia
		and	c.nr_seq_sca		= a.nr_sequencia
		and	b.nr_seq_segurado	= nr_seq_segurado_p
		and	((coalesce(b.dt_fim_vigencia::text, '') = '') or (b.dt_fim_vigencia > clock_timestamp()))
		and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
    and	dt_contrato_w between trunc(coalesce(c.dt_contrato_inicial, dt_contrato_w),'dd') and fim_dia(coalesce(c.dt_contrato_final, dt_contrato_w))
		and	c.ie_acao_seguro	= ie_tipo_obito_p;
	end if;
end if;
	
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_titular_obito ( nr_seq_segurado_p bigint, ie_tipo_obito_p text, ie_tipo_retorno_p text) FROM PUBLIC;

