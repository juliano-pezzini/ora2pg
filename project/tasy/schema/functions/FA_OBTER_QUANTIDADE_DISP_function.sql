-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION fa_obter_quantidade_disp (nr_seq_entrega_p bigint, nr_seq_paciente_entr_p bigint, nr_seq_receita_p bigint, nr_seq_rec_item_p bigint, cd_material_p bigint, qt_dispensar_p bigint,-- a qtde esta na unidade feito na receita
 nm_usuario_p text) RETURNS bigint AS $body$
DECLARE

qt_dias_saldo_w		bigint;
nr_seq_entrega_ant_w	bigint;
qt_saldo_w		double precision;
qt_dispensar_w		double precision;
cd_unidade_origem_w	varchar(10);
cd_unidade_destino_w	varchar(10);
ds_observacao_w		varchar(255);


BEGIN
qt_saldo_w := 0;

--*** Unidade de Origem
select 	i.cd_unidade_medida
into STRICT	cd_unidade_origem_w
from	fa_receita_farmacia_item i
where	i.nr_sequencia =  nr_seq_rec_item_p;

--*** Unidade Destino
select	max(cd_unidade_medida)
into STRICT	cd_unidade_destino_w
from	fa_medic_farmacia_amb
where	cd_material = cd_material_p;

-- Verificar na entrega anterior se existe saldo para este medicamento
--qt_saldo_w := fa_obter_saldo_anterior(nr_seq_entrega_p,nr_seq_paciente_entr_p,cd_material_p,nm_usuario_p,qt_dispensar_p);
SELECT * FROM fa_obter_saldo_ant_intervalo(nr_seq_entrega_p, nr_seq_paciente_entr_p, cd_material_p, nm_usuario_p, ds_observacao_w, qt_saldo_w, qt_dispensar_p) INTO STRICT ds_observacao_w, qt_saldo_w;

qt_dispensar_w := qt_dispensar_p - qt_saldo_w;

--convers√£o da dose a dispensar para o unidade de destino
qt_dispensar_w := Obter_dose_convertida(cd_material_p,qt_dispensar_w,cd_unidade_origem_w,cd_unidade_destino_w);

-- Varifica se deu fracionado, caso sim , acrescenta 1
if (qt_dispensar_w <> trunc(qt_dispensar_w)) then
qt_dispensar_w := trunc(qt_dispensar_w) + 1;
end if;

return	qt_dispensar_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION fa_obter_quantidade_disp (nr_seq_entrega_p bigint, nr_seq_paciente_entr_p bigint, nr_seq_receita_p bigint, nr_seq_rec_item_p bigint, cd_material_p bigint, qt_dispensar_p bigint, nm_usuario_p text) FROM PUBLIC;

