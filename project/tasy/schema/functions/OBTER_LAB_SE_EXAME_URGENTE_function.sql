-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_lab_se_exame_urgente (nr_prescricao_p bigint, nr_seq_material_p bigint) RETURNS varchar AS $body$
 --nr_seq_frasco_p number
DECLARE

				ds_retorno_w varchar(100);
				ds_urgente_w bigint;

c01 CURSOR FOR

	SELECT	coalesce(count(*),0)
	from	exame_lab_frasco e,
			exame_lab_material c,
			prescr_procedimento h,
			exame_laboratorio j,
			material_exame_lab b,
			w_lab_etiqueta a,
			prescr_medica g
	where	1=1
	and		a.nr_prescricao		= nr_prescricao_p
	and		c.nr_seq_material	= nr_seq_material_p
	and		a.nr_seq_material	= b.nr_sequencia
	and     a.nr_prescricao     = h.nr_prescricao
	and     a.nr_seq_material   = c.nr_seq_material
	and     b.nr_sequencia     	= c.nr_seq_material
	and     h.nr_seq_exame      = j.nr_seq_exame
	and		h.cd_material_exame = b.cd_material_exame
	and		c.nr_seq_exame	  	=  h.nr_seq_exame
	and     e.nr_seq_material   = c.nr_seq_material
	and     e.nr_seq_exame      = j.nr_seq_exame
	and     c.nr_seq_exame      = e.nr_seq_exame
	and		c.nr_seq_material	= e.nr_seq_material
	and		a.nr_prescricao		= g.nr_prescricao
	and		coalesce(e.ie_situacao,'A') = 'A'
	and		h.ie_urgencia 		= 'S'
	order by 	a.nr_sequencia;


		
BEGIN
		open c01;
			loop
			fetch c01 into
				ds_urgente_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				ds_urgente_w	:= ds_urgente_w + ds_urgente_w;
			end loop;
		close c01;

	begin
		if (ds_urgente_w > 0) then
			ds_retorno_w := upper(wheb_mensagem_pck.get_texto(309568)); -- URGENTE
		else
			ds_retorno_w := '';
		end if;
	end;
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_lab_se_exame_urgente (nr_prescricao_p bigint, nr_seq_material_p bigint) FROM PUBLIC;

