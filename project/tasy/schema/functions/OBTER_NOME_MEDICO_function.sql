-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nome_medico ( cd_medico_p text, ie_tipo_nome_p text) RETURNS varchar AS $body$
DECLARE



/* tipo nome         */

/*  i = iniciais do nome do medico    */

/*   g = nome de guerra       */

/*  n = nome completo      */

/*  c = numero do crm      */

/*  ps = pronome + nome      */

/*  pms = pronome somente quando ha cadastro medico+ nome      */

/*  p = pronome + nome - crm    */

/*  nc = nome completo + crm       */

/*  uf = uf do crm      */

/*  sl = senha do laudo      */

/*  crm = apenas numero crm    */

/*  gc = nome de guerra + crm    */

/*  pc = pronome + nome + conselho    */

/*  ncd = nome completo + descricao do crm  */

/*  ncde = nome completo + descricao do crm se houver */

/*  nco= nome completo + conselho    */

/*  pn = pronome + name + Prescriber number   */

/*  npn = name + Prescriber number   */

nm_medico_w      varchar(254);
nm_guerra_w      varchar(254);
nr_crm_w      varchar(254);
nm_pessoa_fisica_w    varchar(254);
nm_iniciais_w      varchar(254);
ie_ant_branco_w      boolean;
ie_sexo_w      varchar(1);
i        bigint;
ds_pronome_w      varchar(10);
ie_tipo_nome_w      varchar(5);
uf_crm_w      medico.uf_crm%type;
ds_senha_laudo_w    varchar(15);
ds_conselho_w      varchar(50);
nr_rqe_w      medico.nr_rqe%type;
ds_info_pf_w      varchar(2000);
nr_prescritor_w   medico.nr_prescritor%type;


BEGIN
ie_ant_branco_w        := true;

begin /* rafael em 03/05/2007 gerava erro na pixeon_worklist_v qdo pessoa parametro nao era medico */
select   a.nm_guerra,
  substr(obter_crm_medico(a.cd_pessoa_fisica), 1, 255),
  substr(obter_uf_crm_medico(a.cd_pessoa_fisica),1, 255)uf_crm,
  substr(obter_conselho_profissional(b.nr_seq_conselho, 'S'),1,100) ds_conselho,
  a.nr_rqe,
  a.nr_prescritor
into STRICT   nm_guerra_w,
  nr_crm_w,
  uf_crm_w,
  ds_conselho_w,
  nr_rqe_w,
  nr_prescritor_w
from   pessoa_fisica b,
  medico a
where   a.cd_pessoa_fisica  = b.cd_pessoa_fisica
and  a.cd_pessoa_fisica  = cd_medico_p;
exception
when others then
  nm_guerra_w  := null;
  --return null;
end;

ie_tipo_nome_w    := upper(ie_tipo_nome_p);

if ( ie_tipo_nome_w = 'G' ) then
  nm_medico_w := nm_guerra_w;
elsif ( ie_tipo_nome_w = 'CRM' ) then
  nm_medico_w   := nr_crm_w;
elsif (ie_tipo_nome_w = 'UF' ) then
  nm_medico_w   := uf_crm_w;
elsif ( ie_tipo_nome_w = 'SL' ) then
  select coalesce(max(ds_senha_laudo),null)
  into STRICT  ds_senha_laudo_w
  from  usuario
  where  cd_pessoa_fisica  = cd_medico_p;

  nm_medico_w   := ds_senha_laudo_w;
else
  select  substr(obter_nome_pf(b.cd_pessoa_fisica), 1, 255),
    b.ie_sexo
  into STRICT  nm_pessoa_fisica_w,
    ie_sexo_w
  from   pessoa_fisica b
  where   b.cd_pessoa_fisica  = cd_medico_p;

  if (ie_sexo_w = 'M') then
    ds_pronome_w    := OBTER_DESC_EXPRESSAO(495926)||' ';
  elsif (ie_sexo_w = 'F') then
    ds_pronome_w    := OBTER_DESC_EXPRESSAO(495927)||' ';
  else
    ds_pronome_w    := OBTER_DESC_EXPRESSAO(726891)||' ';
  end if;

  if (ie_tipo_nome_w = 'I') then
      for i in 1 .. length(nm_pessoa_fisica_w) loop
          if (substr(nm_pessoa_fisica_w,i,1) <> ' ') and (ie_ant_branco_w = true) then
        begin
        nm_iniciais_w   := nm_iniciais_w || substr(nm_pessoa_fisica_w,i,1);
        ie_ant_branco_w  := false;
        end;
      end if;

      if (substr(nm_pessoa_fisica_w,i,1) = ' ') then
        ie_ant_branco_w  := true;
      end if;
      end loop;
        nm_medico_w := nm_iniciais_w;
  elsif (ie_tipo_nome_w = 'N') then
        nm_medico_w := nm_pessoa_fisica_w;
  elsif (ie_tipo_nome_w = 'C') then
    if (nr_crm_w IS NOT NULL AND nr_crm_w::text <> '') then
      nm_medico_w   := ds_pronome_w || nm_pessoa_fisica_w ||   ' (' || obter_desc_expressao(286400) || ' ' || nr_crm_w || ')';
    else
      nm_medico_w := ds_pronome_w || nm_pessoa_fisica_w;
    end if;
  elsif (ie_tipo_nome_w = 'P') then
    nm_medico_w   := ds_pronome_w || nm_pessoa_fisica_w || ' (' || obter_desc_expressao(286400) || ' ' || nr_crm_w || ')';
  elsif (ie_tipo_nome_w = 'PNNO') then
    nm_medico_w   := ds_pronome_w || nm_pessoa_fisica_w;
  elsif (ie_tipo_nome_w = 'PN') then
    nm_medico_w   := ds_pronome_w || nm_pessoa_fisica_w || ' (' || obter_desc_expressao(926859) || ' ' || nr_prescritor_w || ')';
  elsif (ie_tipo_nome_w = 'PC') then
    nm_medico_w   := ds_pronome_w || nm_pessoa_fisica_w || ' ('||ds_conselho_w || ' ' || nr_crm_w || ')';
  elsif (ie_tipo_nome_w = 'NCO') then
    nm_medico_w   := nm_pessoa_fisica_w || ' ('||ds_conselho_w || ' ' || nr_crm_w || ')';
  elsif (ie_tipo_nome_w = 'PS') then
    nm_medico_w   := ds_pronome_w || nm_pessoa_fisica_w;
  elsif (ie_tipo_nome_w = 'PMS') then
    if (coalesce(nm_guerra_w::text, '') = '') then /* como o campo nm_guerra obrigatario, quando o mesmo nao for nulo,  que tem cadastro medico */
      nm_medico_w   := nm_pessoa_fisica_w;
    else
      nm_medico_w   := ds_pronome_w || nm_pessoa_fisica_w;
    end if;
  elsif (ie_tipo_nome_w = 'NC') then
    nm_medico_w   := nm_pessoa_fisica_w || ' (' || obter_desc_expressao(286400) || ' ' || nr_crm_w || ')';
  elsif (ie_tipo_nome_w = 'GC') then
    nm_medico_w   := nm_guerra_w || ' (' ||obter_desc_expressao(286400) || ' ' || nr_crm_w || ')';
  elsif (ie_tipo_nome_w = 'NCD') then
    nm_medico_w   := nm_pessoa_fisica_w || ' (' || coalesce(ds_conselho_w,obter_desc_expressao(286400))||' '||nr_crm_w||')';
  elsif (ie_tipo_nome_w = 'NPN') then
    nm_medico_w   := nm_pessoa_fisica_w || ' (' || coalesce(ds_conselho_w,obter_desc_expressao(926859))||' '||nr_prescritor_w||')';
  elsif (ie_tipo_nome_w = 'NCDE') then
    if (ds_conselho_w IS NOT NULL AND ds_conselho_w::text <> '') then
      nm_medico_w   := nm_pessoa_fisica_w || ' (' ||ds_conselho_w ||' '|| nr_crm_w ||')';
    else
      nm_medico_w   := nm_pessoa_fisica_w;
    end if;
  elsif (ie_tipo_nome_w = 'NCE') then
    nm_medico_w   := ds_pronome_w||nm_pessoa_fisica_w || ' ('||coalesce(ds_conselho_w,obter_desc_expressao(286400))||' - ' || uf_crm_w ||' '||nr_crm_w||')';
  elsif (ie_tipo_nome_w = 'NCEQ') then
    nm_medico_w   := ds_pronome_w||nm_pessoa_fisica_w ||chr(13)||chr(10)|| ' '||coalesce(ds_conselho_w,obter_desc_expressao(286400))||' - ' || uf_crm_w ||' '||nr_crm_w;
  elsif (ie_tipo_nome_w = 'PRO') then
    nm_medico_w   := ds_pronome_w;
  elsif (ie_tipo_nome_w = 'NCER') then
    if (nr_rqe_w IS NOT NULL AND nr_rqe_w::text <> '') then
      nm_medico_w   := ds_pronome_w || nm_pessoa_fisica_w || ' (' || coalesce(ds_conselho_w,obter_desc_expressao(286400)) || ' - ' || uf_crm_w || ' ' || nr_crm_w || ' / '||OBTER_DESC_EXPRESSAO(727772)||' - ' || nr_rqe_w || ')';
    else
      nm_medico_w   := ds_pronome_w || nm_pessoa_fisica_w || ' (' || coalesce(ds_conselho_w,obter_desc_expressao(286400)) || ' - ' || uf_crm_w || ' ' || nr_crm_w || ')';
    end if;
  elsif (ie_tipo_nome_w = 'PNGPF') then
    select   max(b.ds_forma_tratamento)
    into STRICT  ds_info_pf_w
    from  pessoa_fisica a, PF_FORMA_TRATAMENTO b
    where   cd_pessoa_fisica = cd_medico_p
    and   a.nr_seq_forma_trat = b.nr_sequencia;
    if (ds_info_pf_w IS NOT NULL AND ds_info_pf_w::text <> '') then
      if (nm_guerra_w IS NOT NULL AND nm_guerra_w::text <> '') then
        nm_medico_w := ds_info_pf_w || ' ' || nm_guerra_w;
      else
        nm_medico_w := ds_info_pf_w || ' ' || nm_pessoa_fisica_w;
      end if;
    else
      if (nm_guerra_w IS NOT NULL AND nm_guerra_w::text <> '') then
        nm_medico_w := nm_guerra_w;
      else
        nm_medico_w := nm_pessoa_fisica_w;
      end if;
    end if;
  end if;
end if;

return nm_medico_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nome_medico ( cd_medico_p text, ie_tipo_nome_p text) FROM PUBLIC;

