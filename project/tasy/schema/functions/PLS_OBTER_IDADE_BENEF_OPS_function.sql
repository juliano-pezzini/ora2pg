-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_idade_benef_ops ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_referencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) RETURNS bigint AS $body$
DECLARE


ie_regulamentacao_w		pls_plano.ie_regulamentacao%type;
ie_data_ref_reaj_adaptado_w	pls_parametros.ie_data_ref_reaj_adaptado%type;
dt_base_inclusao_w		timestamp;
dt_contratacao_w		pls_segurado.dt_contratacao%type;
dt_inclusao_operadora_w		pls_segurado.dt_inclusao_operadora%type;
dt_adaptacao_w			pls_segurado_alt_plano.dt_alteracao%type;
nr_seq_mtvo_alteracao_w		pls_motivo_alteracao_plano.nr_sequencia%type;


BEGIN
select	max(a.dt_contratacao),
	max(a.dt_inclusao_operadora),
	max(b.ie_regulamentacao)
into STRICT	dt_contratacao_w,
	dt_inclusao_operadora_w,
	ie_regulamentacao_w
from	pls_segurado a,
	pls_plano b
where	b.nr_sequencia	= a.nr_seq_plano
and	a.nr_sequencia	= nr_seq_segurado_p;

if (ie_regulamentacao_w = 'A') then
	select	coalesce(max(ie_data_ref_reaj_adaptado),'A')
	into STRICT	ie_data_ref_reaj_adaptado_w
	from	pls_parametros
	where	cd_estabelecimento = cd_estabelecimento_p;
	
	if (ie_data_ref_reaj_adaptado_w = 'A') then
		dt_base_inclusao_w	:= dt_contratacao_w;
	elsif (ie_data_ref_reaj_adaptado_w = 'D') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_mtvo_alteracao_w
		from	pls_motivo_alteracao_plano
		where	cd_ans	= '12';
		
		select	max(dt_alteracao)
		into STRICT	dt_adaptacao_w
		from	pls_segurado_alt_plano
		where	nr_seq_segurado		= nr_seq_segurado_p
		and	ie_situacao 		= 'A'
		and	nr_seq_motivo_alt	= nr_seq_mtvo_alteracao_w;
		
		dt_base_inclusao_w	:= coalesce(dt_adaptacao_w,dt_inclusao_operadora_w);
	else
		dt_base_inclusao_w	:= dt_inclusao_operadora_w;
	end if;
else
	dt_base_inclusao_w	:= dt_inclusao_operadora_w;
end if;

return	trunc(months_between(dt_referencia_p, dt_base_inclusao_w) / 12);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_idade_benef_ops ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_referencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

