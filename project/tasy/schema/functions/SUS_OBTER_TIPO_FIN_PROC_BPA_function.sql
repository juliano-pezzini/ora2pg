-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_tipo_fin_proc_bpa ( cd_procedimento_p procedimento_paciente.cd_procedimento%type, ie_origem_proced_p procedimento_paciente.ie_origem_proced%type, dt_procedimento_p procedimento_paciente.dt_procedimento%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, ie_tipo_p bigint) RETURNS varchar AS $body$
DECLARE


/*
ie_tipo_p
1 - Código
2 - Descrição
*/
ds_retorno_w			varchar(255);
ie_tipo_financiamento_w		sus_procedimento.ie_tipo_financiamento%type;
qt_idade_pac_w			varchar(255)	:= '0';
dt_nascimento_w			pessoa_fisica.dt_nascimento%type;


BEGIN

begin
select	/*+index (susproc_pk)*/	ie_tipo_financiamento
into STRICT	ie_tipo_financiamento_w
from	sus_procedimento
where	cd_procedimento		= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_p
and	(ie_tipo_financiamento IS NOT NULL AND ie_tipo_financiamento::text <> '');
exception
	when others then
	ds_retorno_w	:= '';
end;

if (cd_procedimento_p = 204030188) and (dt_procedimento_p < to_date('01/02/2018','dd/mm/yyyy')) then
	begin

	select	a.dt_nascimento
	into STRICT	dt_nascimento_w
	from	pessoa_fisica a,
		atendimento_paciente b
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	b.nr_atendimento	= nr_atendimento_p;

	begin
	qt_idade_pac_w	:= Obter_Idade(dt_nascimento_w,dt_procedimento_p,'A');
	exception
	when others then
		qt_idade_pac_w	:= '0';
	end;

	if (qt_idade_pac_w between '50' and '69') then
		ie_tipo_financiamento_w := '04';
	end if;

	end;
end if;

if (ie_tipo_p	= 1) then
	ds_retorno_w	:= ie_tipo_financiamento_w;
elsif (ie_tipo_p	= 2) then
	ds_retorno_w	:= obter_valor_dominio(2135, ie_tipo_financiamento_w);
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_tipo_fin_proc_bpa ( cd_procedimento_p procedimento_paciente.cd_procedimento%type, ie_origem_proced_p procedimento_paciente.ie_origem_proced%type, dt_procedimento_p procedimento_paciente.dt_procedimento%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, ie_tipo_p bigint) FROM PUBLIC;

