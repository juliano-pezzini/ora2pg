-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_result_prescr (nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_opcao_p bigint, ie_mostra_resultado_p text, ie_separador_p text) RETURNS varchar AS $body$
DECLARE


cd_pessoa_fisica_w	varchar(10);
dt_aprovacao_w	timestamp;


ds_unidade_medida_w	varchar(100);
ds_resultado_w		varchar(2000);

ds_retorno_w		varchar(2000);
cd_estabelecimento_w	smallint;
qt_exame_ant_w		integer;
qt_result_anterior_w	integer;
ie_recem_nato_w		varchar(1);

c01 CURSOR FOR
	SELECT	substr(coalesce(coalesce(CASE WHEN c.ds_resultado='0' THEN ''  ELSE CASE WHEN d.ie_formato_resultado='V' THEN ''  ELSE c.ds_resultado END  END ,	coalesce(to_char(c.qt_resultado),to_char(CASE WHEN c.pr_resultado=0 THEN ''  ELSE c.pr_resultado END ))),c.ds_resultado),1,100)
	from	exame_laboratorio d,
		exame_lab_result_item c,
		exame_lab_resultado b
	where	b.nr_seq_resultado	= c.nr_seq_resultado
	  and	d.nr_seq_exame 		= c.nr_seq_exame
	  and 	b.nr_prescricao 	= nr_prescricao_p
	  and	c.nr_seq_prescr		= nr_seq_prescr_p
	  and	ie_mostra_resultado_p 	= 'S'
	order by nm_exame;

BEGIN

open c01;
loop
	fetch c01 into	ds_resultado_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	if (ie_opcao_p = 0) and (coalesce(length(ds_retorno_w),0) < 2000) and (ds_resultado_w IS NOT NULL AND ds_resultado_w::text <> '') then

		ds_retorno_w := ds_retorno_w || ds_resultado_w || ie_separador_p;

	end if;

end loop;
close c01;

ds_retorno_w	:= substr(ds_retorno_w,1,length(ds_retorno_w)-1);

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_result_prescr (nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_opcao_p bigint, ie_mostra_resultado_p text, ie_separador_p text) FROM PUBLIC;

