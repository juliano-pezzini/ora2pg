-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_solucao_rediluente ( ie_proporcao_dil_p text, qt_diluente_p bigint, qt_ref_diluente_p bigint, qt_dose_medic_p bigint, cd_unidade_medida_dose_p text, cd_material_p bigint, ie_subtrair_volume_medic_p text, qt_volume_medic_p bigint ) RETURNS bigint AS $body$
DECLARE


qt_dose_diluicao_w		double precision;
qt_conversao_w			material_conversao_unidade.qt_conversao%type;
qt_unitaria_medic_w		double precision;
qt_conc_medic_w			double precision;
qt_medic_diluido_w		double precision;
qt_diluicao_w			material_diluicao.qt_diluicao%type;
qt_solucao_w			material_diluicao.qt_volume%type;


BEGIN

if (ie_subtrair_volume_medic_p = 'S') and (qt_volume_medic_p > 0) then
	qt_medic_diluido_w		:= qt_diluente_p - qt_volume_medic_p;
end if;

qt_dose_diluicao_w	:= qt_diluente_p;

if (coalesce(qt_ref_diluente_p,0) > 0) then

	if (ie_proporcao_dil_p = 'SC') then

		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_w
		from	material_conversao_unidade
		where	cd_unidade_medida = cd_unidade_medida_dose_p
		and		cd_material = cd_material_p;

		qt_unitaria_medic_w := dividir_sem_round(qt_dose_medic_p, qt_conversao_w);

		qt_diluicao_w	:= qt_unitaria_medic_w * qt_ref_diluente_p;						

		if (qt_medic_diluido_w > 0) then
			
			qt_conc_medic_w 	 := obter_dose_convertida(cd_material_p, qt_volume_medic_p, obter_unid_med_usua('ml'), cd_unidade_medida_dose_p);
			
			qt_solucao_w 		:= dividir_sem_round(qt_dose_medic_p, dividir_sem_round(qt_conc_medic_w, qt_medic_diluido_w));
			qt_dose_diluicao_w	:= qt_diluicao_w - qt_solucao_w;
		end if;
	end if;						
end if;

return	qt_dose_diluicao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION obter_qt_solucao_rediluente ( ie_proporcao_dil_p text, qt_diluente_p bigint, qt_ref_diluente_p bigint, qt_dose_medic_p bigint, cd_unidade_medida_dose_p text, cd_material_p bigint, ie_subtrair_volume_medic_p text, qt_volume_medic_p bigint ) FROM PUBLIC;

