-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION san_status_hemocomp_producao (nr_seq_producao_p bigint, ie_tipo_res_p text) RETURNS varchar AS $body$
DECLARE


ds_status_w		varchar(255)	:= null;
ds_status_res_w		varchar(255)	:= null;
ds_retorno_w		varchar(255)	:= null;

C01 CURSOR FOR
	SELECT	CASE WHEN x.ie_filtrado='S' THEN 'F'  ELSE null END
	from	san_producao x
	where	x.nr_sequencia	= nr_seq_producao_p
	
union

	SELECT	CASE WHEN x.ie_lavado='S' THEN 'L'  ELSE null END 
	from	san_producao x
	where	x.nr_sequencia	= nr_seq_producao_p
	
union

	select	CASE WHEN x.ie_aliquotado='S' THEN 'A'  ELSE null END 
	from	san_producao x
	where	x.nr_sequencia	= nr_seq_producao_p
	
union

	select	CASE WHEN CASE WHEN coalesce(x.nr_seq_inutil::text, '') = '' THEN 'N'  ELSE 'S' END ='S' THEN 'I'  ELSE null END 
	from	san_producao x
	where	x.nr_sequencia	= nr_seq_producao_p
	
union

	select	CASE WHEN x.ie_irradiado='S' THEN 'IR'  ELSE null END 
	from	san_producao x
	where	x.nr_sequencia	= nr_seq_producao_p;
	/*union
	select	decode(substr(san_obter_se_regra_reproducao(x.nr_seq_doacao,x.nr_seq_derivado),1,1), 'S','R', null)
	from	san_producao x
	where	x.nr_sequencia	= nr_seq_producao_p;*/
/*
F	-> Filtrado
L	-> Lavado
A	-> Aliquotado
I	-> Inutilizado
IR	-> Irradiado
R	-> Reprocessado
*/
BEGIN
if (nr_seq_producao_p IS NOT NULL AND nr_seq_producao_p::text <> '') then
	open C01;
	loop
	fetch C01 into
		ds_status_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ds_status_w IS NOT NULL AND ds_status_w::text <> '') then
			if (ie_tipo_res_p = 'D') then
				select	CASE WHEN ds_status_w='F' THEN wheb_mensagem_pck.get_texto(796657) WHEN ds_status_w='L' THEN wheb_mensagem_pck.get_texto(796652) WHEN ds_status_w='A' THEN wheb_mensagem_pck.get_texto(796658) WHEN ds_status_w='I' THEN wheb_mensagem_pck.get_texto(803077) WHEN ds_status_w='IR' THEN wheb_mensagem_pck.get_texto(796651) WHEN ds_status_w='R' THEN wheb_mensagem_pck.get_texto(803079) END
				into STRICT	ds_status_res_w
				;

				ds_retorno_w	:= ds_retorno_w||ds_status_res_w||', ';

			elsif (ie_tipo_res_p != 'D') then
				ds_retorno_w	:= ds_retorno_w||ds_status_w||', ';
			end if;
		end if;
		end;
	end loop;
	close C01;

	ds_retorno_w	:= substr(ds_retorno_w,1,length(ds_retorno_w)-2);

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION san_status_hemocomp_producao (nr_seq_producao_p bigint, ie_tipo_res_p text) FROM PUBLIC;

