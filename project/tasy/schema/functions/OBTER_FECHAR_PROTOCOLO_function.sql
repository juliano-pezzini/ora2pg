-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_fechar_protocolo ( nr_seq_protocolo_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_incons_w		varchar(254)	:= '';
cd_estabelecimento_w	bigint;
ie_fim_w		boolean		:= False;
qt_incons_w		integer	:= 0;
ie_pos_w		smallint	:= 0;
cd_incons_w		numeric(22)	:= 0;
cd_incons_ww		varchar(50);
ie_pos_proc_w		smallint	:= 0;
ie_fecha_pro_w		varchar(1)	:= 'S';
ie_fecha_pro_ww		varchar(1)	:= 'S';
ie_cont_w		smallint	:= 0;

 

BEGIN 
 
select	replace(ds_inconsistencia,' ',',') || ',', 
	cd_estabelecimento 
into STRICT	ds_incons_w, 
	cd_estabelecimento_w 
from	protocolo_convenio 
where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
while not ie_fim_w loop 
	begin 
	qt_incons_w	:= qt_incons_w + 1;	
	ie_pos_w 	:= position(',' in ds_incons_w);
	if (ie_pos_w > 0) then 
		begin 
		cd_incons_ww	:= substr(ds_incons_w,1,ie_pos_w);
		ie_pos_proc_w	:= position('(' in cd_incons_ww);
		 
		if (ie_pos_proc_w > 0) then 
			cd_incons_ww	:= substr(cd_incons_ww,1,ie_pos_proc_w);
		end if;		
 
		cd_incons_w 	:= somente_numero(cd_incons_ww);
		ds_incons_w 	:= substr(ds_incons_w,ie_pos_w + 1,length(ds_incons_w));
 
		ie_fecha_pro_ww	:= '';
		select	min(coalesce(c.ie_fecha_protocolo,coalesce(b.ie_fecha_protocolo,a.ie_fecha_protocolo))), 
			count(*) 
		into STRICT	ie_fecha_pro_ww, 
			ie_cont_w 
		FROM inconsistencia a
LEFT OUTER JOIN inconsistencia_estab b ON (a.nr_sequencia = b.nr_seq_inconsistencia AND cd_estabelecimento_w = b.cd_estabelecimento)
LEFT OUTER JOIN inconsistencia_perfil c ON (a.nr_sequencia = c.nr_seq_inconsistencia AND obter_perfil_ativo = c.cd_perfil)
WHERE a.cd_inconsistencia	= cd_incons_w;
		if (ie_cont_w = 1) then 
			if (ie_fecha_pro_ww	= 'N') then 
				ie_fecha_pro_w		:= 'N';
			end if;
		end if;
		end;
	end if;
	ie_fim_w	:= (ie_pos_w < 1) or (qt_incons_w > 100);
	end;
end loop;	
RETURN ie_fecha_pro_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_fechar_protocolo ( nr_seq_protocolo_p bigint) FROM PUBLIC;

