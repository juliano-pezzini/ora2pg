-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dia_semana_agenda_cons (ie_diario_p text, dt_agenda_p timestamp, cd_agenda_p bigint, cd_agenda_diaria_p text, ie_turno_p bigint, cd_agenda_where_p text) RETURNS varchar AS $body$
DECLARE


ds_dia_semana_w		varchar(15);
qt_hor_agenda_w		bigint;
qt_hor_total_agenda_w	bigint;

ds_dia_agenda_w	varchar(240);


BEGIN
IF (ie_diario_p IS NOT NULL AND ie_diario_p::text <> '') AND (dt_agenda_p IS NOT NULL AND dt_agenda_p::text <> '') THEN

	/* obter dia semana */

	SELECT	obter_dia_semana(dt_agenda_p)
	INTO STRICT	ds_dia_semana_w
	;

	/* obter agendamentos */

	IF (ie_diario_p = 'N') THEN

		SELECT	COUNT(*)
		INTO STRICT	qt_hor_agenda_w
		FROM	agenda_consulta
		WHERE	dt_agenda between trunc(dt_agenda_p) and trunc(dt_Agenda_p) + 86399/86400
		--TRUNC(dt_agenda,'dd')	= TRUNC(dt_agenda_p,'dd')
		AND	cd_agenda			= cd_agenda_p
		AND	((cd_turno			= ie_turno_p) OR (ie_turno_p = 2))
		AND	ie_status_agenda 		NOT IN ('L','B','C','F','I','II');

		SELECT	COUNT(*)
		INTO STRICT	qt_hor_total_agenda_w
		FROM	agenda_consulta
		WHERE	dt_agenda between trunc(dt_agenda_p) and trunc(dt_Agenda_p) + 86399/86400
		--TRUNC(dt_agenda,'dd')	= TRUNC(dt_agenda_p,'dd')
		AND	cd_agenda			= cd_agenda_p
		and	ie_status_agenda not in ('II','C');

	ELSE

		IF (cd_agenda_where_p IS NOT NULL AND cd_agenda_where_p::text <> '') THEN

			qt_hor_agenda_w := obter_valor_dinamico(	'select	count(*) ' 													||
							'from	agenda_consulta '													||
							--'where	trunc(dt_agenda,'||CHR(39)||'dd'||CHR(39)||') = trunc(to_date('||CHR(39)||TO_CHAR(dt_agenda_p,'dd/mm/yyyy')||CHR(39)||','||CHR(39)||'dd/mm/yyyy'||CHR(39)||'),'||CHR(39)||'dd'||CHR(39)||') ' 	||
							'where	dt_agenda between trunc(to_date('||CHR(39)||TO_CHAR(dt_agenda_p,'dd/mm/yyyy')||CHR(39)||','||CHR(39)||'dd/mm/yyyy'||CHR(39)||')) and trunc(to_date('||CHR(39)||TO_CHAR(dt_agenda_p,'dd/mm/yyyy')||CHR(39)||','||CHR(39)||'dd/mm/yyyy'||CHR(39)||')) + 86399/86400' 	||
						cd_agenda_where_p 														|| ' ' ||
						'and	((cd_turno			= ie_turno_p) or (ie_turno_p = 2)) ' ||
						'and	ie_status_agenda not in ('||CHR(39)||'L'||CHR(39)||','||CHR(39)||'B'||CHR(39)||','||CHR(39)||'C'||CHR(39)||','||CHR(39)||'F'||CHR(39)||','||CHR(39)||'I'||CHR(39)||','||CHR(39)||'II'||CHR(39)||')', qt_hor_agenda_w);

			qt_hor_agenda_w := obter_valor_dinamico(	'select	count(*) ' 													||
							'from	agenda_consulta '	 												||
							--'where	trunc(dt_agenda,'||CHR(39)||'dd'||CHR(39)||') = trunc(to_date('||CHR(39)||TO_CHAR(dt_agenda_p,'dd/mm/yyyy')||CHR(39)||','||CHR(39)||'dd/mm/yyyy'||CHR(39)||'),'||CHR(39)||'dd'||CHR(39)||') ' 	||
							'where	dt_agenda between trunc(to_date('||CHR(39)||TO_CHAR(dt_agenda_p,'dd/mm/yyyy')||CHR(39)||','||CHR(39)||'dd/mm/yyyy'||CHR(39)||')) and trunc(to_date('||CHR(39)||TO_CHAR(dt_agenda_p,'dd/mm/yyyy')||CHR(39)||','||CHR(39)||'dd/mm/yyyy'||CHR(39)||')) + 86399/86400' 	||
						cd_agenda_where_p, qt_hor_agenda_w);

		ELSIF (cd_agenda_diaria_p IS NOT NULL AND cd_agenda_diaria_p::text <> '') THEN

			SELECT	COUNT(*)
			INTO STRICT	qt_hor_agenda_w
			FROM	agenda_consulta
			WHERE	dt_agenda between trunc(dt_agenda_p) and trunc(dt_Agenda_p) + 86399/86400
			--TRUNC(dt_agenda,'dd')				= TRUNC(dt_agenda_p,'dd')
			AND	obter_se_contido(cd_agenda,cd_agenda_diaria_p)	= 'S'
			AND	((cd_turno			= ie_turno_p) OR (ie_turno_p = 2))
			AND	ie_status_agenda 					NOT IN ('L','B','C','F','I','II');

			SELECT	COUNT(*)
			INTO STRICT	qt_hor_total_agenda_w
			FROM	agenda_consulta
			WHERE	dt_agenda between trunc(dt_agenda_p) and trunc(dt_Agenda_p) + 86399/86400
			--TRUNC(dt_agenda,'dd')				= TRUNC(dt_agenda_p,'dd')
			AND	obter_se_contido(cd_agenda,cd_agenda_diaria_p)	= 'S'
			and	ie_status_agenda not in ('II','C');

		END IF;

	END IF;

	ds_dia_agenda_w	:= ds_dia_semana_w || ' (' || TO_CHAR(qt_hor_total_agenda_w) || ' - ' || TO_CHAR(qt_hor_agenda_w) || ')';

END IF;

RETURN ds_dia_agenda_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dia_semana_agenda_cons (ie_diario_p text, dt_agenda_p timestamp, cd_agenda_p bigint, cd_agenda_diaria_p text, ie_turno_p bigint, cd_agenda_where_p text) FROM PUBLIC;

