-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_item_lib_hor_gpt ( ie_tipo_item_p text, nr_seq_cpoe_p bigint) RETURNS varchar AS $body$
DECLARE

	ie_lib_hor_w			varchar(1);
	qt_hor_w				bigint;
	qt_lib_hor_w			bigint;
	ie_item_existe_w		varchar(1);
	ie_assoc_proc_existe_w	varchar(1);
	ie_momento_lote_w		varchar(1);
	ie_liberacao_w			varchar(1);
	

BEGIN
	ie_lib_hor_w := 'N';
	ie_item_existe_w := 'N';
	
	if (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then			
		if (ie_tipo_item_p in ('D', 'SNE', 'S', 'LD', 'NPTA', 'NPTI')) then
			
			if ((ie_item_existe_w = 'N') and (ie_tipo_item_p in ('NPTA', 'NPTI'))) then
				select	coalesce(max('S'),'N'),
						sum(CASE WHEN coalesce(c.nr_sequencia::text, '') = '' THEN  0  ELSE 1 END ),
						sum(CASE WHEN coalesce(c.dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
				into STRICT	ie_item_existe_w,
						qt_hor_w,
						qt_lib_hor_w
				FROM nut_pac a, prescr_material b
LEFT OUTER JOIN prescr_mat_hor c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_seq_material)
WHERE a.nr_seq_npt_cpoe = nr_seq_cpoe_p and a.nr_prescricao = obter_prescr_item_cpoe(nr_seq_cpoe_p, ie_tipo_item_p) and b.nr_seq_nut_pac = a.nr_sequencia and coalesce(b.dt_suspensao::text, '') = '';
			end if;
			
			if ((ie_item_existe_w = 'N') and (ie_tipo_item_p in ('SNE', 'S', 'LD'))) then
				select	coalesce(max('S'),'N'),
						sum(CASE WHEN coalesce(c.nr_sequencia::text, '') = '' THEN  0  ELSE 1 END ),
						sum(CASE WHEN coalesce(c.dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
				into STRICT	ie_item_existe_w,
						qt_hor_w,
						qt_lib_hor_w
				FROM prescr_material b
LEFT OUTER JOIN prescr_mat_hor c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_seq_material)
WHERE b.nr_seq_dieta_cpoe = nr_seq_cpoe_p and b.nr_prescricao = obter_prescr_item_cpoe(nr_seq_cpoe_p, ie_tipo_item_p) and coalesce(b.dt_suspensao::text, '') = '';
			end if;
			
			if ((ie_item_existe_w = 'N') and (ie_tipo_item_p in ('D', 'LD', 'NPTA', 'NPTI'))) then
				select	coalesce(max('S'),'N'),
						sum(CASE WHEN coalesce(c.nr_sequencia::text, '') = '' THEN  0  ELSE 1 END ),
						sum(CASE WHEN coalesce(c.dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
				into STRICT	ie_item_existe_w,
						qt_hor_w,
						qt_lib_hor_w
				FROM prescr_dieta b
LEFT OUTER JOIN prescr_dieta_hor c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_seq_dieta)
WHERE b.nr_seq_dieta_cpoe = nr_seq_cpoe_p and b.nr_prescricao = obter_prescr_item_cpoe(nr_seq_cpoe_p, 'D') and coalesce(b.dt_suspensao::text, '') = '';
			end if;
			
		elsif (ie_tipo_item_p in ('R')) then
			select	sum(1),
					sum(CASE WHEN coalesce(dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
			into STRICT	qt_hor_w,
					qt_lib_hor_w
			from	prescr_recomendacao b,
					prescr_rec_hor c
			where	b.nr_seq_rec_cpoe = nr_seq_cpoe_p
			and 	b.nr_prescricao = obter_prescr_item_cpoe(nr_seq_cpoe_p, ie_tipo_item_p)
			and     coalesce(b.dt_suspensao::text, '') = ''
			and     c.nr_prescricao = b.nr_prescricao
			and     c.nr_seq_recomendacao = b.nr_sequencia;
		elsif (ie_tipo_item_p in ('O')) then
			select	sum(1),
					sum(CASE WHEN coalesce(dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
			into STRICT	qt_hor_w,
					qt_lib_hor_w
			from	prescr_gasoterapia b,
					prescr_gasoterapia_hor c
			where	b.nr_seq_gas_cpoe = nr_seq_cpoe_p
			and 	b.nr_prescricao = obter_prescr_item_cpoe(nr_seq_cpoe_p, ie_tipo_item_p)
			and     coalesce(b.dt_suspensao::text, '') = ''
			and     c.nr_prescricao = b.nr_prescricao
			and     c.nr_seq_gasoterapia = b.nr_sequencia;
		elsif (ie_tipo_item_p in ('M', 'MAT', 'SOL')) then
			select	sum(1),
					sum(CASE WHEN coalesce(dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
			into STRICT	qt_hor_w,
					qt_lib_hor_w
			from	prescr_material b,
					prescr_mat_hor c
			where	b.nr_seq_mat_cpoe = nr_seq_cpoe_p
			and 	b.nr_prescricao = obter_prescr_item_cpoe(nr_seq_cpoe_p, ie_tipo_item_p)
			and     coalesce(b.dt_suspensao::text, '') = ''
			and     c.nr_prescricao = b.nr_prescricao
			and     c.nr_seq_material = b.nr_sequencia;
		elsif (ie_tipo_item_p in ('P', 'HM')) then
			select	sum(1),
					sum(CASE WHEN coalesce(dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
			into STRICT	qt_hor_w,
					qt_lib_hor_w
			from	prescr_procedimento b,
					prescr_proc_hor c
			where	b.nr_seq_proc_cpoe = nr_seq_cpoe_p
			and 	b.nr_prescricao = obter_prescr_item_cpoe(nr_seq_cpoe_p, ie_tipo_item_p)
			and     coalesce(b.dt_suspensao::text, '') = ''
			and     c.nr_prescricao = b.nr_prescricao
			and     c.nr_seq_procedimento = b.nr_sequencia;
		end if;
		
		if (qt_hor_w > 0 AND qt_hor_w = qt_lib_hor_w) then
			ie_lib_hor_w := 'S';
		end if;
			
		if ((ie_lib_hor_w = 'N') and (ie_item_existe_w = 'N') and (ie_tipo_item_p in ('J', 'D', 'SNE', 'S', 'LD', 'NPTA', 'NPTI'))) then
			-- Dietas
			select	cpoe_obter_momento_lote(
						a.ie_motivo_prescricao,	-- ie_motivo_prescricao_p
						a.cd_setor_atendimento,	-- cd_setor_prescr_p
						a.cd_estabelecimento,	-- cd_estabelecimento_p
						null, 					-- ie_quimio_p
						'CPOE_DIETA',			-- nm_tabela_p
						null,					-- nr_sequencia_p
						b.ie_tipo_dieta,		-- ie_tipo_dieta_p
						null,					-- ie_controle_tempo_p
						null,					-- ie_material_p
						null,					-- ie_urgencia_p
						null,					-- nr_ocorrencia_p
						null					-- ie_dose_ataque_p
					),
					CASE WHEN coalesce(dt_liberacao_enf::text, '') = '' THEN  'M'  ELSE CASE WHEN coalesce(dt_liberacao_farm::text, '') = '' THEN  'E'  ELSE 'F' END  END
			into STRICT	ie_momento_lote_w,
					ie_liberacao_w
			from	prescr_medica a,
					cpoe_dieta b
			where	a.nr_prescricao = obter_prescr_item_cpoe(nr_seq_cpoe_p, ie_tipo_item_p)
			and 	b.nr_sequencia = nr_seq_cpoe_p;
			
			if (ie_momento_lote_w = 'M') then
				if (ie_liberacao_w in ('M', 'E', 'F'))then
					ie_lib_hor_w := 'S';
				end if;
			elsif (ie_momento_lote_w = 'E') then				
				if (ie_liberacao_w in ('E', 'F'))then
					ie_lib_hor_w := 'S';
				end if;
			elsif (ie_momento_lote_w = 'F') then				
				if (ie_liberacao_w in ('F'))then
					ie_lib_hor_w := 'S';
				end if;
			end if;
		end if;
			
		if (ie_lib_hor_w = 'S' AND ie_tipo_item_p = 'P') then
			-- Materiais/Medicamentos associados ao procedimento
			select	coalesce(max('S'),'N'),
					sum(CASE WHEN coalesce(c.nr_sequencia::text, '') = '' THEN  0  ELSE 1 END ),
					sum(CASE WHEN coalesce(c.dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
			into STRICT	ie_assoc_proc_existe_w,
					qt_hor_w,
					qt_lib_hor_w
			FROM prescr_material b
LEFT OUTER JOIN prescr_mat_hor c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_seq_material)
WHERE (b.nr_prescricao, b.nr_sequencia_proc) in (
				SELECT	y.nr_prescricao, y.nr_sequencia
				from	prescr_procedimento y
				where	y.nr_seq_proc_cpoe = nr_seq_cpoe_p
				and 	y.nr_prescricao = obter_prescr_item_cpoe(nr_seq_cpoe_p, 'P')
				and 	coalesce(y.dt_suspensao::text, '') = ''
			) and coalesce(b.ie_checar_adep, 'N') = 'N' and coalesce(b.dt_suspensao::text, '') = '';
			
			if (ie_assoc_proc_existe_w = 'S') then
				if (qt_hor_w > 0 AND qt_hor_w = qt_lib_hor_w) then
					ie_lib_hor_w := 'S';
				else
					ie_lib_hor_w := 'N';
				end if;
			end if;
		end if;
	end if;

	return ie_lib_hor_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_item_lib_hor_gpt ( ie_tipo_item_p text, nr_seq_cpoe_p bigint) FROM PUBLIC;

