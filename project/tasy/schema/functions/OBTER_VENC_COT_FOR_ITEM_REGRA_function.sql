-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_venc_cot_for_item_regra ( nr_cot_compra_p bigint, nr_item_cot_compra_p bigint) RETURNS bigint AS $body$
DECLARE


nr_seq_item_fornec_w		bigint;
ie_regra_preco_w			varchar(01);
cd_estabelecimento_w		smallint;
ie_somente_encerrada_w		varchar(01);
ie_rentabilidade_w			varchar(01) := 'N';
ie_forma_venc_cotacao_w		varchar(15);

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	cot_compra_forn b,
		cot_compra_forn_item a
	where	a.nr_seq_cot_forn	= b.nr_sequencia
	and	a.nr_cot_compra 	= nr_cot_compra_p
	and	a.nr_item_cot_compra 	= nr_item_cot_compra_p
	and	a.vl_unitario_material	> 0
	and	coalesce(a.ie_situacao,'A') = 'A'
	and	(((ie_somente_encerrada_w = 'S') and (coalesce(b.ie_status,'AH') in ('AH','FF','FH'))) or (ie_somente_encerrada_w = 'N'))
	order by
		CASE WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='N' THEN  CASE WHEN Obter_qt_item_cotacao(nr_cot_compra_p, nr_item_cot_compra_p)=a.qt_material THEN a.vl_presente  ELSE coalesce(a.vl_unitario_liquido, a.vl_presente) END  WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='CO' THEN CASE WHEN Obter_qt_item_cotacao(nr_cot_compra_p, nr_item_cot_compra_p)=a.qt_material THEN dividir(a.vl_presente,obter_dados_material(a.cd_material,'QEC'))  ELSE dividir((coalesce(a.vl_unitario_liquido, a.vl_presente)),obter_dados_material(a.cd_material,'QEC')) END  WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='CE' THEN CASE WHEN Obter_qt_item_cotacao(nr_cot_compra_p, nr_item_cot_compra_p)=a.qt_material THEN dividir(a.vl_presente,obter_dados_material(a.cd_material,'QCE'))  ELSE dividir((coalesce(a.vl_unitario_liquido, a.vl_presente)),obter_dados_material(a.cd_material,'QCE')) END  END  desc,
		a.qt_prioridade,
		a.vl_preco_liquido desc;

C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	cot_compra_forn b,
		cot_compra_forn_item a
	where	a.nr_seq_cot_forn	= b.nr_sequencia
	and	a.nr_cot_compra 	= nr_cot_compra_p
	and	a.nr_item_cot_compra 	= nr_item_cot_compra_p
	and	a.vl_unitario_material	> 0
	and	coalesce(a.ie_situacao,'A') = 'A'
	and	(((ie_somente_encerrada_w = 'S') and (coalesce(b.ie_status,'AH') in ('AH','FF','FH'))) or (ie_somente_encerrada_w = 'N'))
	order by
		CASE WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='N' THEN  CASE WHEN Obter_qt_item_cotacao(nr_cot_compra_p, nr_item_cot_compra_p)=a.qt_material THEN a.vl_presente  ELSE coalesce(a.vl_unitario_liquido, a.vl_presente) END  WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='CO' THEN CASE WHEN Obter_qt_item_cotacao(nr_cot_compra_p, nr_item_cot_compra_p)=a.qt_material THEN dividir(a.vl_presente,obter_dados_material(a.cd_material,'QEC'))  ELSE dividir((coalesce(a.vl_unitario_liquido, a.vl_presente)),obter_dados_material(a.cd_material,'QEC')) END  WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='CE' THEN CASE WHEN Obter_qt_item_cotacao(nr_cot_compra_p, nr_item_cot_compra_p)=a.qt_material THEN dividir(a.vl_presente,obter_dados_material(a.cd_material,'QCE'))  ELSE dividir((coalesce(a.vl_unitario_liquido, a.vl_presente)),obter_dados_material(a.cd_material,'QCE')) END  END  desc,
		a.vl_presente desc,
		a.qt_prioridade,
		a.vl_preco_liquido desc;

C03 CURSOR FOR
	SELECT	a.nr_sequencia
	from	cot_compra_forn b,
		cot_compra_forn_item a
	where	a.nr_seq_cot_forn	= b.nr_sequencia
	and	a.nr_cot_compra 	= nr_cot_compra_p
	and	a.nr_item_cot_compra 	= nr_item_cot_compra_p
	and	a.vl_unitario_material	> 0
	and	coalesce(a.ie_situacao,'A') = 'A'
	and	(((ie_somente_encerrada_w = 'S') and (coalesce(b.ie_status,'AH') in ('AH','FF','FH'))) or (ie_somente_encerrada_w = 'N'))
	order by
		obter_result_cot_fornec_item(a.nr_sequencia),
		CASE WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='N' THEN  CASE WHEN Obter_qt_item_cotacao(nr_cot_compra_p, nr_item_cot_compra_p)=a.qt_material THEN a.vl_presente  ELSE coalesce(a.vl_unitario_liquido, a.vl_presente) END  WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='CO' THEN CASE WHEN Obter_qt_item_cotacao(nr_cot_compra_p, nr_item_cot_compra_p)=a.qt_material THEN dividir(a.vl_presente,obter_dados_material(a.cd_material,'QEC'))  ELSE dividir((coalesce(a.vl_unitario_liquido, a.vl_presente)),obter_dados_material(a.cd_material,'QEC')) END  WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='CE' THEN CASE WHEN Obter_qt_item_cotacao(nr_cot_compra_p, nr_item_cot_compra_p)=a.qt_material THEN dividir(a.vl_presente,obter_dados_material(a.cd_material,'QCE'))  ELSE dividir((coalesce(a.vl_unitario_liquido, a.vl_presente)),obter_dados_material(a.cd_material,'QCE')) END  END  desc,
		a.vl_presente desc,
		a.qt_prioridade,
		a.vl_preco_liquido desc;

C04 CURSOR FOR
	SELECT	a.nr_sequencia
	from	cot_compra_forn b,
		cot_compra_forn_item a
	where	a.nr_seq_cot_forn	= b.nr_sequencia
	and	a.nr_cot_compra 	= nr_cot_compra_p
	and	a.nr_item_cot_compra 	= nr_item_cot_compra_p
	and	a.vl_unitario_material	> 0
	and	coalesce(a.ie_situacao,'A') = 'A'
	and	(((ie_somente_encerrada_w = 'S') and (coalesce(b.ie_status,'AH') in ('AH','FF','FH'))) or (ie_somente_encerrada_w = 'N'))
	order by
		CASE WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='N' THEN  coalesce(a.vl_unitario_material, a.vl_presente) WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='CO' THEN dividir(coalesce(a.vl_unitario_material, a.vl_presente),obter_dados_material(a.cd_material,'QEC')) WHEN obter_regra_conv_cotacao(cd_estabelecimento_w,a.cd_material)='CE' THEN dividir(coalesce(a.vl_unitario_material, a.vl_presente),obter_dados_material(a.cd_material,'QCE')) END  desc,
		a.vl_presente desc,
		a.qt_prioridade,
		a.vl_preco_liquido desc;


BEGIN

select	coalesce(max(nr_seq_cot_item_forn),'0'),
	coalesce(max(ie_regra_preco),'N')
into STRICT	nr_seq_item_fornec_w,
	ie_regra_preco_w
from	cot_compra_item
where	nr_cot_compra		= nr_cot_compra_p
and	nr_item_cot_compra	= nr_item_cot_compra_p;

select	cd_estabelecimento,
	ie_forma_venc_cotacao
into STRICT	cd_estabelecimento_w,
	ie_forma_venc_cotacao_w
from	cot_compra
where	nr_cot_compra = nr_cot_compra_p;

select	coalesce(max(ie_somente_cot_encerrada),'N'),
	coalesce(max(coalesce(ie_forma_venc_cotacao_w, ie_forma_venc_cotacao)),'N')
into STRICT	ie_somente_encerrada_w,
	ie_rentabilidade_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

if (nr_seq_item_fornec_w = 0) then
	begin
	if (coalesce(ie_rentabilidade_w,'N') = 'N') then
		if (ie_regra_preco_w = 'N') then
			open c01;
			loop
			FETCH C01 into
				nr_seq_item_fornec_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				nr_seq_item_fornec_w		:= nr_seq_item_fornec_w;
			END LOOP;
			CLOSE C01;
		else
			open c02;
			loop
			FETCH C02 into
				nr_seq_item_fornec_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				nr_seq_item_fornec_w		:= nr_seq_item_fornec_w;
			END LOOP;
			CLOSE C02;
		end if;
	elsif (coalesce(ie_rentabilidade_w,'N') = 'S') then
		open c03;
			loop
			FETCH C03 into
				nr_seq_item_fornec_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				nr_seq_item_fornec_w		:= nr_seq_item_fornec_w;
			END LOOP;
			CLOSE C03;
	elsif (coalesce(ie_rentabilidade_w,'N') = 'U') then
		open c04;
			loop
			FETCH C04 into
				nr_seq_item_fornec_w;
			EXIT WHEN NOT FOUND; /* apply on c04 */
				nr_seq_item_fornec_w		:= nr_seq_item_fornec_w;
			END LOOP;
			CLOSE C04;
	end if;
	end;
end if;

RETURN	nr_seq_item_fornec_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_venc_cot_for_item_regra ( nr_cot_compra_p bigint, nr_item_cot_compra_p bigint) FROM PUBLIC;

