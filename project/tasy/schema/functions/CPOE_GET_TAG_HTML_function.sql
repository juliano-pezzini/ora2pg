-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_get_tag_html ( ie_tipo_item_p text default null, nr_sequencia_p bigint default null, ds_observacao_p text default null) RETURNS varchar AS $body$
DECLARE


ds_tag_w varchar(4000)	:= null;

ds_template_w	varchar(4000)	:= '<div class="legend-cell-content-tag-cpoe" style="cursor: default;">
                            <div class="legend-cell-tag-cpoe" style="background-color: rgb(255, 233, 171); cursor: default;"
                            uib-tooltip="#@#@MY_TAG_TOOLTIP#@#@" tooltip-class="cpoe-status-tooltip" tooltip-append-to-body="true">
                                #@#@MY_TAG#@#@
                            </div>
			</div>';

cd_material_w		cpoe_material.cd_material%type;
ds_observacao_w		cpoe_material.ds_observacao%type;
ie_administracao_w	cpoe_material.ie_administracao%type;
dt_fim_w		cpoe_material.dt_fim%type;
ie_evento_unico_w	cpoe_material.ie_evento_unico%type;
dt_suspensao_w		cpoe_material.dt_suspensao%type;

	procedure addTag(	ds_informacao_p	text) is
	ds_my_tag_w	varchar(4000);
	ds_text_w	varchar(4000)	:= ds_informacao_p;
	
BEGIN
	ds_my_tag_w	:= replace(ds_template_w,'#@#@MY_TAG_TOOLTIP#@#@',ds_text_w);
	
	if (dt_suspensao_w IS NOT NULL AND dt_suspensao_w::text <> '') then
		ds_text_w	:=  '<div class="cpoe-item-suspenso">'||ds_text_w|| '</div>';
	end if;
	
	ds_tag_w	:= ds_tag_w || replace(ds_my_tag_w,'#@#@MY_TAG#@#@',ds_text_w);	
	end;

	
	function getMessageTag(	nr_seq_texto_p	number) return varchar2 is
	
	begin
	
	return wheb_mensagem_pck.get_texto(nr_seq_texto_p);
	
	end;
	
	procedure addTagTexto(	nr_seq_texto_p	number) is
	begin
	addTag(getMessageTag(nr_seq_texto_p));
	end;

begin

if (ie_tipo_item_p	in ('SOL','M')) then
	
	select	a.cd_material,
		a.ds_observacao,
		a.ie_administracao,
		a.dt_suspensao,
		a.dt_fim
	into STRICT	cd_material_w,
		ds_observacao_w,
		ie_administracao_w,
		dt_suspensao_w,
		dt_fim_w
	from	cpoe_material a
	where	nr_sequencia = nr_sequencia_p;
	
	
	if (ie_tipo_item_p	= 'SOL') then
		addTagTexto(1135866);
	end if;
	
	if (Get_Ordered_on_behalf(nr_sequencia_p,'M')	= 'S') then
		addTagTexto(1135865);
	end if;
	
	if (ie_administracao_w	= 'N') then
		addTagTexto(1135884);
	end if;
	
	if (ie_evento_unico_w	= 'S') then
		addTagTexto(1136256);
	end if;
	
	if (get_if_tapering_dose(nr_sequencia_p)	= 'S') then
		addTagTexto(1139373);
		if (coalesce(dt_fim_w::text, '') = '') then
			addTagTexto(1153314);
		end if;
	end if;
	
	if (get_if_variable_dose(nr_sequencia_p)	= 'S') then
		addTagTexto(1146170);
	end if;
	
	if (get_if_nurse_initiated(nr_sequencia_p)	= 'S') then
		addTagTexto(1149071);
	end if;
	
	if (CPOE_OBTER_SE_MAT_TAG(cd_material_w,'ANTCOAG')	= 'S') then
		addTagTexto(1151942);
	end if;
	
	if (CPOE_OBTER_SE_MAT_TAG(cd_material_w,'INSUL')	= 'S') then
		addTagTexto(1151944);
	end if;
	
	if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
		addTagTexto(1139298);
	end if;
else
	if (ds_observacao_p IS NOT NULL AND ds_observacao_p::text <> '') then
		addTagTexto(1139298);
	end if;

end if;

return ds_tag_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_get_tag_html ( ie_tipo_item_p text default null, nr_sequencia_p bigint default null, ds_observacao_p text default null) FROM PUBLIC;

