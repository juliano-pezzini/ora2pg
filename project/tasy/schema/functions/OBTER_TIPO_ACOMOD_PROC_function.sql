-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tipo_acomod_proc (nr_atendimento_p bigint, nr_sequencia_proc_p bigint) RETURNS bigint AS $body$
DECLARE


/* parametros para obter o tipo de acomodacao */

/* '1'- Da atend_categoria_convenio da maior vigencia */

/* '2'- Da atend_paciente_unidade  */

/* '3'- Da procedimento_paciente  */

ie_tipo_acomodacao_w		smallint;
cd_tipo_acomodacao_w		smallint;
dt_procedimento_w		timestamp;


BEGIN
cd_tipo_acomodacao_w	:= 0;
/* Obter parametro */

begin
select	a.ie_tipo_acomodacao,
	b.dt_procedimento
into STRICT	ie_tipo_acomodacao_w,
	dt_procedimento_w
from	convenio a,
	procedimento_paciente b
where	b.cd_convenio	= a.cd_convenio
and	b.nr_sequencia	= nr_sequencia_proc_p;
exception
     		when others then
		ie_tipo_acomodacao_w := 1;
end;

if (ie_tipo_acomodacao_w	= 1)	then
	begin
	/* Geliard - 22/01/2014. Alterado para melhoria de performance na OS 690883

	select	nvl(a.cd_tipo_acomodacao,0)
	from		atend_categoria_convenio_v a,
			procedimento_paciente b
	where		b.nr_sequencia		= nr_sequencia_proc_p
	and		a.nr_atendimento		= b.nr_atendimento
	and		a.cd_convenio		= b.cd_convenio
	and		a.cd_categoria		= b.cd_categoria;*/
	begin
	select	coalesce(a.cd_tipo_acomodacao,0)
	into STRICT	cd_tipo_acomodacao_w
	from	atend_categoria_convenio a,
		procedimento_paciente b
	where	a.dt_inicio_vigencia = (SELECT max(w.dt_inicio_vigencia)
					from atend_categoria_convenio w
					where w.nr_atendimento  = a.nr_atendimento)
	and	a.cd_categoria		= b.cd_categoria
	and	a.cd_convenio		= b.cd_convenio
	and	a.nr_atendimento	= b.nr_atendimento
	and	b.nr_sequencia		= nr_sequencia_proc_p;
	exception
		when others then
		cd_tipo_acomodacao_w := 0;
	end;

	end;
end if;

if (ie_tipo_acomodacao_w	= 2)	then
		begin
		select coalesce(max(b.cd_tipo_acomodacao),0)
		into STRICT	 cd_tipo_acomodacao_w
		from	 atend_paciente_unidade b,
			 setor_atendimento a
		where	 b.nr_atendimento		= nr_atendimento_p
		and	 b.cd_setor_atendimento	= a.cd_setor_atendimento
		and	 a.cd_classif_setor in ('3','4','8')
		and	 dt_procedimento_w between b.dt_entrada_unidade	and coalesce(b.dt_saida_unidade, dt_procedimento_w);
		exception
     				when others then
          			cd_tipo_acomodacao_w := 0;
		end;
end if;

if (ie_tipo_acomodacao_w	= 3)	then
		begin
		select	coalesce(a.cd_tipo_acomodacao,0)
		into STRICT		cd_tipo_acomodacao_w
		from		atend_paciente_unidade a,
				procedimento_paciente b
		where		b.nr_sequencia		= nr_sequencia_proc_p
		and		b.nr_atendimento		= a.nr_atendimento
		and		b.dt_entrada_unidade	= a.dt_entrada_unidade;
		exception
     				when others then
          			cd_tipo_acomodacao_w := 0;
		end;
end if;

RETURN cd_tipo_acomodacao_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tipo_acomod_proc (nr_atendimento_p bigint, nr_sequencia_proc_p bigint) FROM PUBLIC;

