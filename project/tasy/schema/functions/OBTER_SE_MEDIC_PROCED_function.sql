-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_medic_proced ( nr_atendimento_p bigint, nr_seq_proc_interno_p bigint, nr_seq_exame_p bigint, ie_tipo_p bigint) RETURNS varchar AS $body$
DECLARE


ie_retorno_w			varchar(1) := 'N';
nr_seq_proc_interno_w	bigint;
cd_material_w			bigint;
cd_material_ww			prescr_material.cd_material%type;
qt_existe_w				smallint;
ds_material_w			varchar(2000);
ds_mensagem_w			varchar(255);
nr_seq_ficha_tecnica_w	material.nr_seq_ficha_tecnica%type;

C01 CURSOR FOR
	SELECT	cd_material,
			nr_seq_ficha_tecnica,
			ds_mensagem
	from	proced_medic_reacao
	where	coalesce(nr_seq_proc_interno, coalesce(nr_seq_proc_interno_p,0)) = coalesce(nr_seq_proc_interno_p,0)
	and		coalesce(nr_seq_exame, coalesce(nr_seq_exame_p,0)) = coalesce(nr_seq_exame_p,0);


BEGIN

if (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') or (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') then

	if (ie_tipo_p = 1) then

		open C01;
		loop
		fetch C01 into
				cd_material_w,
				nr_seq_ficha_tecnica_w,
				ds_mensagem_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') or (nr_seq_ficha_tecnica_w IS NOT NULL AND nr_seq_ficha_tecnica_w::text <> '') then

				select	coalesce(max('S'),'N'),
						max(a.cd_material)
				into STRICT	ie_retorno_w,
						cd_material_ww
				from	prescr_material a,
						prescr_medica b
				where	a.nr_prescricao = b.nr_prescricao
				and		b.nr_atendimento = nr_atendimento_p
				and		a.cd_material = coalesce(cd_material_w,a.cd_material)
				and		coalesce(obter_ficha_tecnica_medic(a.cd_material),0) = coalesce(nr_seq_ficha_tecnica_w, coalesce(obter_ficha_tecnica_medic(a.cd_material),0))
				and		coalesce(a.nr_sequencia_dieta::text, '') = ''
				and		a.ie_suspenso <> 'S';

				if (ie_retorno_w = 'N') then
					select	coalesce(max('S'),'N')
					into STRICT	ie_retorno_w
					from	paciente_medic_uso
					where	cd_material = cd_material_w
					and		nr_atendimento = nr_atendimento_p
					and		coalesce(dt_fim::text, '') = ''
					and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
				end if;

				if (ie_retorno_w = 'S') then
					exit;
				end if;

			end if;
			end;
		end loop;
		close C01;
		return	ie_retorno_w;

	end if;

	if (ie_tipo_p = 2) then

		ds_material_w := wheb_mensagem_pck.get_texto(309370) || ' : '; -- Medicamento
		open C01;
		loop
		fetch C01 into
			cd_material_w,
			nr_seq_ficha_tecnica_w,
			ds_mensagem_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') or (nr_seq_ficha_tecnica_w IS NOT NULL AND nr_seq_ficha_tecnica_w::text <> '') then

				select	coalesce(max('S'),'N'),
						max(a.cd_material)
				into STRICT	ie_retorno_w,
						cd_material_ww
				from	prescr_material a,
						prescr_medica b
				where	a.nr_prescricao = b.nr_prescricao
				and		b.nr_atendimento = nr_atendimento_p
				and		a.cd_material = coalesce(cd_material_w,a.cd_material)
				and		coalesce(obter_ficha_tecnica_medic(a.cd_material),0) = coalesce(nr_seq_ficha_tecnica_w, coalesce(obter_ficha_tecnica_medic(a.cd_material),0))
				and		coalesce(a.nr_sequencia_dieta::text, '') = ''
				and		a.ie_suspenso <> 'S';

				if (ie_retorno_w = 'N') then
					select	coalesce(max('S'),'N')
					into STRICT	ie_retorno_w
					from	paciente_medic_uso
					where	cd_material = cd_material_w
					and		nr_atendimento = nr_atendimento_p
					and		coalesce(dt_fim::text, '') = ''
					and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
				end if;

				if (ie_retorno_w = 'S') then
					ds_material_w	:= ds_material_w || substr(obter_desc_material(cd_material_ww),1,100) || ', ';
					if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
						ds_material_w	:= ds_material_w || chr(13) || ds_mensagem_w;
					end if;
				end if;

			end if;
			end;
		end loop;
		close C01;

		return 	ds_material_w;

	end if;

end if;

return 	ds_material_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_medic_proced ( nr_atendimento_p bigint, nr_seq_proc_interno_p bigint, nr_seq_exame_p bigint, ie_tipo_p bigint) FROM PUBLIC;

