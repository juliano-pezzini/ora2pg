-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_convenio_quimio ( nr_seq_atendimento_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(255);
nr_seq_paciente_w	bigint;
nr_atendimento_w    bigint;
cd_convenio_w		bigint;
cd_categoria_w      bigint;


BEGIN

select max(nr_atendimento)
into STRICT nr_atendimento_w
from agenda_quimio
where nr_seq_atendimento = nr_seq_atendimento_p;

if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

    select	substr(obter_convenio_atendimento(nr_atendimento_w),1,50)
    into STRICT	cd_convenio_w
;

    --Descricao do convenio
    if (coalesce(ie_opcao_p, 'C') = 'D') then

        select	ds_convenio
        into STRICT	ds_retorno_w
        from	convenio
        where	cd_convenio	= cd_convenio_w;

    --Categoria do convenio   
    elsif (coalesce(ie_opcao_p, 'C') = 'CA') then
    
        select	substr(obter_categoria_atendimento(nr_atendimento_w),1,50)
        into STRICT	cd_categoria_w
;

        select	ds_categoria
        into STRICT	ds_retorno_w
        from	categoria_convenio
        where	cd_convenio	= cd_convenio_w
        and     cd_categoria = cd_categoria_w;

    --Codigo do convenio
    elsif (coalesce(ie_opcao_p, 'C') = 'C') then
    
        select	substr(obter_convenio_atendimento(nr_atendimento_w),1,50)
        into STRICT	ds_retorno_w
;
        
    end if;
else      
    select 	max(nr_seq_paciente)
    into STRICT	nr_seq_paciente_w
    from 	paciente_atendimento
    where 	nr_seq_atendimento = nr_seq_atendimento_p;

    if (coalesce(nr_seq_paciente_w,0) > 0) then
          
            --Codigo do convenio
        
        if (coalesce(ie_opcao_p, 'C') = 'C') then   
    
            select  max(cd_convenio)
            into STRICT 	ds_retorno_w
            from 	paciente_setor_convenio
            where 	nr_seq_paciente = nr_seq_paciente_w;

        --Descricao do convenio	
    
        elsif (coalesce(ie_opcao_p, 'C') = 'D') then   
    
            select  substr(max(obter_desc_convenio(cd_convenio)),1,255)
            into STRICT 	ds_retorno_w
            from 	paciente_setor_convenio
            where 	nr_seq_paciente = nr_seq_paciente_w;

        --Categoria do convenio
    
        elsif (coalesce(ie_opcao_p, 'C') = 'CA') then
    
            select  substr(OBTER_CATEGORIA_CONVENIO(max(cd_convenio), max(cd_categoria)),1,255)
            into STRICT 	ds_retorno_w
            from 	paciente_setor_convenio
            where 	nr_seq_paciente = nr_seq_paciente_w;
            
        end if;
    end if;
end if;
return	ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_convenio_quimio ( nr_seq_atendimento_p bigint, ie_opcao_p text) FROM PUBLIC;

