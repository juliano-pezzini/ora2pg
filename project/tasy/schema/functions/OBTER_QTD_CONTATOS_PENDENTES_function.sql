-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qtd_contatos_pendentes (NR_SEQ_LISTA_ESPERA_P bigint) RETURNS bigint AS $body$
DECLARE


  QTD_CONTATOS_W      bigint;
  NR_SEQ_W            bigint;
  NR_SITUACAO_ATUAL_W bigint;
  IE_TIPO_CONTATO_W   varchar(5);

  C1 CURSOR FOR
    SELECT NR_SEQUENCIA
      FROM AG_LISTA_ESPERA_CONTATO
     WHERE NR_SEQ_LISTA_ESPERA = NR_SEQ_LISTA_ESPERA_P
       AND coalesce(DT_INATIVACAO::text, '') = ''
       AND (DT_LIBERACAO IS NOT NULL AND DT_LIBERACAO::text <> '');


BEGIN
  QTD_CONTATOS_W := 0;

  OPEN C1;
  LOOP
    FETCH C1
      INTO NR_SEQ_W;
    EXIT WHEN NOT FOUND; /* apply on C1 */

    /*AR - AGUARDANDO RESPOSTA
    PN - PACIENTE NÃO ENCONTRADO
    PC - PACIENTE CIENTE
    PJ - PACIENTE JÁ REALIZOU
    PF - PACIENTE FALTOU
    PD - PACIENTE DESISTIU
    */
  
    IF (NR_SEQ_W IS NOT NULL AND NR_SEQ_W::text <> '') THEN
      SELECT MAX(NR_SEQ_SITUACAO_ATUAL)
        INTO STRICT NR_SITUACAO_ATUAL_W
        FROM AG_LISTA_ESPERA_CONTATO
       WHERE NR_SEQUENCIA = NR_SEQ_W;
    END IF;

    IF (NR_SITUACAO_ATUAL_W IS NOT NULL AND NR_SITUACAO_ATUAL_W::text <> '') THEN
      SELECT MAX(IE_TIPO_CONTATO)
        INTO STRICT IE_TIPO_CONTATO_W
        FROM LISTA_ESPERA_SITUACAO_CONT
       WHERE NR_SEQUENCIA = NR_SITUACAO_ATUAL_W
         AND IE_SITUACAO = 'A';
    END IF;

    IF ((IE_TIPO_CONTATO_W IS NOT NULL AND IE_TIPO_CONTATO_W::text <> '') AND IE_TIPO_CONTATO_W IN ('AR', 'PN')) THEN
      QTD_CONTATOS_W := QTD_CONTATOS_W + 1;
    END IF;

  END LOOP;
  CLOSE C1;

  RETURN QTD_CONTATOS_W;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qtd_contatos_pendentes (NR_SEQ_LISTA_ESPERA_P bigint) FROM PUBLIC;

