-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_material_global ( CD_MATERIAL_P bigint, DT_REFERENCIA_P timestamp, CD_ESTABELECIMENTO_P bigint, CD_SETOR_ATENDIMENTO_P bigint, CD_CONVENIO_P bigint , CD_CATEGORIA_P text, CD_PLANO_P text) RETURNS varchar AS $body$
DECLARE


cd_retorno_w 			material_vinculo_global.cd_material_glo%type;
cd_setor_atendimento_w 	material_vinculo_global.cd_setor_atendimento%type;


BEGIN
if (cd_setor_atendimento_p = 0) then
	cd_setor_atendimento_w := null;
else
	cd_setor_atendimento_w := cd_setor_atendimento_p;
end if;

begin
select *
into STRICT cd_retorno_w
from (SELECT  cd_material_glo
  from material_vinculo_global
  where   cd_material = cd_material_p
  and     cd_estabelecimento = cd_estabelecimento_p
  and (
          cd_setor_atendimento = cd_setor_atendimento_w
          or (coalesce(cd_setor_atendimento::text, '') = '' and coalesce(cd_setor_atendimento_w::text, '') = '')
          or coalesce(cd_setor_atendimento::text, '') = ''
          ) 
  and (
          cd_convenio = cd_convenio_p
          or (coalesce(cd_convenio::text, '') = '' and coalesce(cd_convenio_p::text, '') = '')
          or coalesce(cd_convenio::text, '') = ''
          )
  and (
          cd_categoria = cd_categoria_p
          or (coalesce(cd_categoria::text, '') = '' and coalesce(cd_categoria_p::text, '') = '')
          or coalesce(cd_categoria::text, '') = ''
          )
  and (
          cd_plano = cd_plano_p
          or (coalesce(cd_plano::text, '') = '' and coalesce(cd_plano_p::text, '') = '')
          or coalesce(cd_plano::text, '') = ''
          )
  and     dt_inicio_vigencia <= dt_referencia_p
  and (dt_fim_vigencia >= dt_referencia_p or coalesce(dt_fim_vigencia::text, '') = '')
  order   by cd_convenio, cd_plano, cd_setor_atendimento desc) alias22 LIMIT 1;

exception
	when others then
	cd_retorno_w	:= '';
end;

RETURN cd_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_material_global ( CD_MATERIAL_P bigint, DT_REFERENCIA_P timestamp, CD_ESTABELECIMENTO_P bigint, CD_SETOR_ATENDIMENTO_P bigint, CD_CONVENIO_P bigint , CD_CATEGORIA_P text, CD_PLANO_P text) FROM PUBLIC;

