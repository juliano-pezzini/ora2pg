-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hrva_obterjustificativa_laudo (nr_seq_laudo_p bigint) RETURNS varchar AS $body$
DECLARE

 
retorno_w			varchar(4000):='';
codigo_rel_w			bigint:= 29;
ds_justificativa_original_w	varchar(1000);
ds_justificativa_adic_w		varchar(4000):='';
cd_pessoa_fisica_w		varchar(10);
nm_medico_solic_w		varchar(200);
nr_crm_w			varchar(20);
var_crm				varchar(20);

C01 CURSOR FOR 
	SELECT	b.DS_JUSTIFICATIVA, 
		substr(Obter_Pessoa_Fisica_Usuario(b.nm_usuario_nrec,'C'),1,50) cd_pessoa_fisica 
	from	sus_laudo_paciente a, 
		SUS_LAUDO_PROCED_ADIC b 
	where	nr_seq_interno	= nr_seq_laudo_p 
	and 	a.nr_seq_interno = b.nr_seq_laudo  LIMIT 10;

 

BEGIN 
 
select	a.ds_justificativa, 
	substr(obter_nome_pf(a.cd_medico_requisitante),1,200) nm_medico_solic, 
	substr(Obter_CRM_Medico(a.cd_medico_requisitante),1,120) nr_crm 
into STRICT	ds_justificativa_original_w, 
	nm_medico_solic_w, 
	nr_crm_w 
from	sus_laudo_paciente a 
where	a.nr_seq_interno	= nr_seq_laudo_p;
 
open C01;
loop 
fetch C01 into	 
	ds_justificativa_adic_w, 
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	begin 
	var_crm:= coalesce(Obter_CRM_Medico(cd_pessoa_fisica_w),'0');
	 
	exception 
	when others then 
	var_crm:= '0';
	end;
	 
	codigo_rel_w:= codigo_rel_w+3;
	retorno_w:= retorno_w || to_char(codigo_rel_w) || ' - ' || ds_justificativa_adic_w|| ' - '|| substr(obter_nome_pf(cd_pessoa_fisica_w),1,120)|| ' '|| var_crm ||'; ';
	if (codigo_rel_w = 38) then 
		begin 
		codigo_rel_w := 50;
		end;
	end if;	
	end;
end loop;
close C01;
 
retorno_w:= substr('29 - '||ds_justificativa_original_w|| ' - '|| nm_medico_solic_w|| ' '||nr_crm_w||'; '||retorno_w,1,4000);
 
return	retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hrva_obterjustificativa_laudo (nr_seq_laudo_p bigint) FROM PUBLIC;

