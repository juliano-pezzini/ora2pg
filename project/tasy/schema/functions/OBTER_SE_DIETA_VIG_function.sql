-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_dieta_vig ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ie_dieta_vig_w	varchar(1);

C01 CURSOR FOR
SELECT	coalesce(max('S'),'N')
from	prescr_mat_hor a,
	prescr_material c,
	prescr_medica b
where	a.nr_prescricao	 = b.nr_prescricao
and	a.nr_prescricao	 = c.nr_prescricao
and	b.nr_prescricao	 = c.nr_prescricao
and	a.nr_seq_material = c.nr_sequencia
and	b.nr_atendimento = nr_atendimento_p
and	a.dt_horario between dt_inicio_p and dt_fim_p
and	coalesce(a.dt_suspensao::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	coalesce(c.ie_suspenso,'N')	<> 'S'
and	((coalesce(c.dt_suspensao_progr::text, '') = '') or (a.dt_horario	< c.dt_suspensao_progr))
and	coalesce(a.dt_fim_horario::text, '') = ''
and	a.ie_agrupador in (8, 12, 16)
and	((b.nm_usuario_original = nm_usuario_p) or ((coalesce(b.dt_liberacao_medico,b.dt_liberacao) IS NOT NULL AND (coalesce(b.dt_liberacao_medico,b.dt_liberacao))::text <> '')))

union

select	coalesce(max('S'),'N')
from	prescr_dieta_hor a,
	prescr_dieta c,
	prescr_medica b
where	a.nr_prescricao = b.nr_prescricao
and	a.nr_prescricao = c.nr_prescricao
and	b.nr_prescricao = c.nr_prescricao
and	a.nr_seq_dieta	= c.nr_sequencia
and	b.nr_atendimento = nr_atendimento_p
and	a.dt_horario between dt_inicio_p and dt_fim_p
and	coalesce(a.dt_suspensao::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	coalesce(c.ie_suspenso,'N')	<> 'S'
and	((coalesce(c.dt_suspensao_progr::text, '') = '') or (a.dt_horario	< c.dt_suspensao_progr))
and	coalesce(a.dt_fim_horario::text, '') = ''
and	((b.nm_usuario_original = nm_usuario_p) or ((coalesce(b.dt_liberacao_medico,b.dt_liberacao) IS NOT NULL AND (coalesce(b.dt_liberacao_medico,b.dt_liberacao))::text <> '')));


BEGIN

open C01;
loop
fetch C01 into
	ie_dieta_vig_w;
exit when(ie_dieta_vig_w = 'S') or C01%notfound;
end loop;
close C01;

return	ie_dieta_vig_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_dieta_vig ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) FROM PUBLIC;

