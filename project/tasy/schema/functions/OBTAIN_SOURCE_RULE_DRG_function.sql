-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obtain_source_rule_drg ( nr_atendimento_p bigint, nr_seq_episodio_paciente_p bigint, ie_option_p text) RETURNS varchar AS $body$
DECLARE

cd_external_code_w 	origin_version_rule.cd_external_code%type;
cd_health_fund_w 	origin_version_rule.cd_health_fund%type;
ie_health_fund_type_w	origin_version_rule.ie_health_fund_type%type;
nr_atendimento_w 	atendimento_paciente.nr_atendimento%type;
ds_uso_case_w 		varchar(1);
ds_retorno_w		varchar(100);
qt_existe_w		bigint;

/*ie_option_p is 'E' then return value will be external code cd_external_code*/

BEGIN
if (ie_option_p = 'E') then
	ds_uso_case_w := OBTER_USO_CASE(wheb_usuario_pck.get_nm_usuario);
	/* If value is 'N' then the input is case number
	If value is 'S' then input is encounter number */
	if (ds_uso_case_w = 'N') then
		if (nr_seq_episodio_paciente_p IS NOT NULL AND nr_seq_episodio_paciente_p::text <> '') then
			select	max(b.nr_atendimento) 
			into STRICT 	nr_atendimento_w 
			from 	episodio_paciente a,atendimento_paciente b 
			where 	b.nr_seq_episodio = a.nr_sequencia 
			and 	a.nr_sequencia = nr_seq_episodio_paciente_p;
	
		else
			nr_atendimento_w := nr_atendimento_p;
		end if;
	else
		nr_atendimento_w := nr_atendimento_p;
	end if;

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

		cd_health_fund_w := Obter_Convenio_Atendimento(nr_atendimento_w);
		ie_health_fund_type_w := obter_tipo_convenio_atend(nr_atendimento_w);


		select  max(a.cd_external_code)
		into STRICT	cd_external_code_w
		from    origin_version_rule a
		where   clock_timestamp() between coalesce(trunc(a.dt_start),clock_timestamp()) and coalesce(trunc(a.dt_end),clock_timestamp())
		and     a.cd_health_fund = cd_health_fund_w
		and	a.ie_origem_proced = 15;
		
		if (coalesce(cd_external_code_w::text, '') = '') then

			select  max(a.cd_external_code)
			into STRICT	cd_external_code_w
			from    origin_version_rule a
			where   clock_timestamp() between coalesce(trunc(a.dt_start),clock_timestamp()) and coalesce(trunc(a.dt_end),clock_timestamp())
			and     a.ie_health_fund_type = ie_health_fund_type_w
			and	a.ie_origem_proced = 15;

		end if;

		if (coalesce(cd_external_code_w::text, '') = '') then

			select  max(a.cd_external_code)
			into STRICT	cd_external_code_w
			from    origin_version_rule a
			where   clock_timestamp() between coalesce(trunc(a.dt_start),clock_timestamp()) and coalesce(trunc(a.dt_end),clock_timestamp())
			and     coalesce(a.cd_health_fund::text, '') = ''
			and     coalesce(a.ie_health_fund_type::text, '') = ''
			and	a.ie_origem_proced = 15;

		end if;
	end if;
end if;

ds_retorno_w := cd_external_code_w;
return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obtain_source_rule_drg ( nr_atendimento_p bigint, nr_seq_episodio_paciente_p bigint, ie_option_p text) FROM PUBLIC;

