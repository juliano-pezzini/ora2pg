-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_seq_medida_ref_laudo (nr_seq_laudo_med_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_refer_medida_w		varchar(80);
nr_sequencia_w			bigint;
qt_idade_minima_w		smallint;
qt_idade_maxima_w		smallint;
qt_peso_minimo_w		smallint;
qt_peso_maximo_w		smallint;
ds_medida_ref_w			varchar(80);
nr_seq_laudo_w			bigint;
cd_pessoa_w			varchar(10);
dt_nascimento_w			timestamp;
qt_idade_w			integer;
qt_peso_w			integer;
nr_atendimento_w		bigint;
dt_laudo_w			timestamp;
ie_sexo_w			varchar(1);

nr_prescricao_w			bigint;

nr_seq_med_refer_w		bigint;
vl_minimo_adic_w		double precision;
vl_maximo_adic_w		double precision;
nr_seq_med_adic_w		bigint;
ds_refer_med_ant_w 		varchar(80);
vl_exame_adic_w			double precision;

ie_tipo_medida_w		varchar(15);

nr_seq_medida_refer_w		bigint;
nr_seq_medida_refer_ant_w	bigint;

 
c01 CURSOR FOR 
	SELECT	nr_sequencia, 
		qt_idade_minima, 
		qt_idade_maxima, 
		qt_peso_minimo, 
		qt_peso_maximo, 
		ds_medida_referencia 
	from	medida_exame_refer 
	where	nr_seq_medida = nr_sequencia_w 
	and (ie_sexo = ie_sexo_w or ie_sexo = 'A') 
	and (coalesce(ie_tipo_medida,1) = coalesce(coalesce(ie_tipo_medida_w, ie_tipo_medida) ,1))	  
	order by ie_sexo;

	 
c02 CURSOR FOR 
	SELECT	vl_minimo, 
		vl_maximo, 
		nr_seq_med_adic 
	from	medida_exame_ref_adic 
	where	nr_seq_med_refer = nr_seq_med_refer_w;


BEGIN 
 
select	b.ds_medida_referencia, 
	b.nr_sequencia, 
	a.nr_seq_laudo 
into STRICT	ds_refer_medida_w, 
	nr_sequencia_w, 
	nr_seq_laudo_w 
from	medida_exame_laudo b, 
	laudo_paciente_medida a 
where	a.nr_seq_medida		= b.nr_sequencia 
and	a.nr_sequencia		= nr_seq_laudo_med_p;
 
 
select	nr_atendimento, 
	dt_laudo, 
	nr_prescricao, 
	ie_tipo_medida 
into STRICT	nr_atendimento_w, 
	dt_laudo_w, 
	nr_prescricao_w, 
	ie_tipo_medida_w 
from	laudo_paciente 
where	nr_sequencia = nr_seq_laudo_w;
 
 
select	obter_pessoa_atendimento(nr_atendimento_w, 'C') 
into STRICT	cd_pessoa_w
;
 
select	dt_nascimento, 
	coalesce(ie_sexo,'A') 
into STRICT	dt_nascimento_w, 
	ie_sexo_w 
from	pessoa_fisica 
where	cd_pessoa_fisica = cd_pessoa_w;
 
select	obter_idade(dt_nascimento_w,dt_laudo_w,'A') 
into STRICT	qt_idade_w
;
 
select	coalesce(obter_peso_prescr_sinal(nr_prescricao_w),0) 
into STRICT	qt_peso_w
;	
 
 
nr_seq_medida_refer_ant_w := null;
 
open c01;
loop 
fetch c01 into 
	nr_seq_med_refer_w, 
	qt_idade_minima_w, 
	qt_idade_maxima_w, 
	qt_peso_minimo_w, 
	qt_peso_maximo_w, 
	ds_medida_ref_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	if	(qt_idade_w >= qt_idade_minima_w AND qt_idade_w <= qt_idade_maxima_w) and 
		(((coalesce(qt_peso_minimo_w::text, '') = '') and (coalesce(qt_peso_maximo_w::text, '') = '')) or 
		 ((qt_peso_w >= coalesce(qt_peso_minimo_w,0)) and (qt_peso_w <= coalesce(qt_peso_maximo_w,9999)))) then		 
		nr_seq_medida_refer_w := nr_seq_med_refer_w;
	end if;
	 
 
	open c02;
	loop 
	fetch c02 into 
		vl_minimo_adic_w, 
		vl_maximo_adic_w, 
		nr_seq_med_adic_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
 
		select 	valor_medida_laudo(nr_seq_med_adic_w, nr_seq_laudo_w, 'V') 
		into STRICT	vl_exame_adic_w 
		;
 
		if	(qt_idade_w >= qt_idade_minima_w AND qt_idade_w <= qt_idade_maxima_w) and 
			(((coalesce(qt_peso_minimo_w::text, '') = '') and (coalesce(qt_peso_maximo_w::text, '') = '')) or 
			 ((qt_peso_w >= coalesce(qt_peso_minimo_w,0)) and (qt_peso_w <= coalesce(qt_peso_maximo_w,9999)))) and 
			(vl_exame_adic_w >= vl_minimo_adic_w AND vl_exame_adic_w <= vl_maximo_adic_w) then 
 
			nr_seq_medida_refer_w := nr_seq_med_refer_w;
		else 
			nr_seq_med_refer_w := nr_seq_medida_refer_ant_w;
			nr_seq_medida_refer_w := nr_seq_med_refer_w;
		end if;
 
 
		if	(qt_idade_w >= qt_idade_minima_w AND qt_idade_w <= qt_idade_maxima_w) and 
			(((coalesce(qt_peso_minimo_w::text, '') = '') and (coalesce(qt_peso_maximo_w::text, '') = '')) or 
			 ((qt_peso_w >= coalesce(qt_peso_minimo_w,0)) and (qt_peso_w <= coalesce(qt_peso_maximo_w,9999)))) then 
			 
			nr_seq_medida_refer_ant_w := nr_seq_medida_refer_w;
		end if;
 
 
	end loop;
	close c02;
 
	if	(qt_idade_w >= qt_idade_minima_w AND qt_idade_w <= qt_idade_maxima_w) and 
		(((coalesce(qt_peso_minimo_w::text, '') = '') and (coalesce(qt_peso_maximo_w::text, '') = '')) or 
		 ((qt_peso_w >= coalesce(qt_peso_minimo_w,0)) and (qt_peso_w <= coalesce(qt_peso_maximo_w,9999)))) then 
		 
		nr_seq_medida_refer_ant_w := nr_seq_medida_refer_w;
	end if;
 
 
end loop;
close c01;
 
 
return	nr_seq_medida_refer_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_seq_medida_ref_laudo (nr_seq_laudo_med_p bigint) FROM PUBLIC;

