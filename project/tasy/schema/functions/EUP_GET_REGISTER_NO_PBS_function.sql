-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION eup_get_register_no_pbs (NR_ATENDIMENTO_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE, NR_PRESCRICAO_P PRESCR_PROCEDIMENTO.NR_PRESCRICAO%TYPE) RETURNS varchar AS $body$
DECLARE

IS_EPS_CONVENIO_W     CONVENIO_PLANO.IE_EPS%TYPE;
DS_RESULT_W           varchar(1);

BEGIN
  DS_RESULT_W := 'N';

  SELECT  MAX(IS_EPS_CONVENIO(B.CD_CONVENIO, B.CD_PLANO_CONVENIO))
  INTO STRICT    IS_EPS_CONVENIO_W
  FROM    ATEND_CATEGORIA_CONVENIO B
  WHERE   B.NR_ATENDIMENTO = NR_ATENDIMENTO_P;

  IF (IS_EPS_CONVENIO_W = 'S') THEN
 	SELECT CASE WHEN COUNT(1)=0 THEN  'N'  ELSE 'S' END
	INTO STRICT   DS_RESULT_W
	FROM  PRESCR_PROCEDIMENTO A
	WHERE A.NR_PRESCRICAO = NR_PRESCRICAO_P
	AND   coalesce(A.DT_SUSPENSAO::text, '') = ''
	AND   EXISTS (  SELECT  1
			FROM    PROCEDIMENTO B
			WHERE   B.CD_PROCEDIMENTO = A.CD_PROCEDIMENTO
			AND     COALESCE(B.IE_NOPBS, 'N') = 'S'
			AND     B.IE_ORIGEM_PROCED = 4);
  END IF;

  RETURN DS_RESULT_W;
EXCEPTION
  WHEN no_data_found THEN RETURN NULL;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eup_get_register_no_pbs (NR_ATENDIMENTO_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE, NR_PRESCRICAO_P PRESCR_PROCEDIMENTO.NR_PRESCRICAO%TYPE) FROM PUBLIC;

