-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_medic_risco_queda ( cd_material_p bigint , cd_estabelecimento_p bigint , cd_perfil_p bigint , cd_setor_atendimento_p bigint , nm_usuario_p text , nr_atendimento_p bigint ) RETURNS varchar AS $body$
DECLARE


cd_classe_material_w   material.cd_classe_material%type;
nr_seq_familia_w       material.nr_seq_familia%type;
nr_seq_ficha_tecnica_w material.nr_seq_ficha_tecnica%type;
cd_grupo_material_w    grupo_material.cd_grupo_material%type;

c01 CURSOR FOR
    SELECT *
    FROM (SELECT leg.cd_material
                   , leg.cd_classe_material
                   , leg.ie_escala
                   , leg.qt_pontuacao_escala
                   , lib.cd_perfil
                   , lib.cd_setor_atendimento
                   , lib.nm_usuario_regra
                   , lib.cd_estabelecimento_regra
                   , leg.nr_seq_ordenacao
            FROM   regra_legenda_risco_queda leg
                   left join regra_libera_risco_queda lib
                          ON lib.nr_seq_legenda_queda = leg.nr_sequencia
            WHERE  leg.cd_material = cd_material_p
                OR leg.nr_seq_familia = nr_seq_familia_w
                OR leg.nr_seq_ficha_tecnica = nr_seq_ficha_tecnica_w
                OR leg.cd_classe_material = cd_classe_material_w
                OR leg.cd_grupo_material = cd_grupo_material_w
            ORDER  BY leg.nr_seq_ordenacao) alias0;

BEGIN
    SELECT cm.cd_classe_material
           , mat.nr_seq_familia
           , mat.nr_seq_ficha_tecnica
           , gm.cd_grupo_material
    INTO STRICT   cd_classe_material_w
           , nr_seq_familia_w
           , nr_seq_ficha_tecnica_w
           , cd_grupo_material_w
    FROM   material mat
           , classe_material cm
           , subgrupo_material sm
           , grupo_material gm
    WHERE  mat.cd_classe_material = cm.cd_classe_material
       AND cm.cd_subgrupo_material = sm.cd_subgrupo_material
       AND sm.cd_grupo_material = gm.cd_grupo_material
       AND cd_material = cd_material_p;

    FOR c01_w IN c01 LOOP
        RAISE NOTICE 'nm_usuario_regra: % cd_perfil: % cd_setor_atendimento: % cd_estabelecimento_regra: %', c01_w.nm_usuario_regra, c01_w.cd_perfil, c01_w.cd_setor_atendimento, c01_w.cd_estabelecimento_regra;
        IF (Coalesce(c01_w.nm_usuario_regra, to_char(c01_w.cd_perfil), to_char(c01_w.cd_setor_atendimento), to_char(c01_w.cd_estabelecimento_regra)) IS NULL
            OR coalesce(c01_w.nm_usuario_regra, '-1') = nm_usuario_p
            OR coalesce(c01_w.cd_perfil, -1) = cd_perfil_p
            OR coalesce(c01_w.cd_setor_atendimento, -1) = cd_setor_atendimento_p
            OR coalesce(c01_w.cd_estabelecimento_regra, -1) = cd_estabelecimento_p) then
                IF (coalesce(c01_w.ie_escala::text, '') = '' AND coalesce(c01_w.qt_pontuacao_escala::text, '') = '') THEN
                    RETURN 'S';
                END IF;
        END IF;
    END LOOP;

    RETURN 'N';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_medic_risco_queda ( cd_material_p bigint , cd_estabelecimento_p bigint , cd_perfil_p bigint , cd_setor_atendimento_p bigint , nm_usuario_p text , nr_atendimento_p bigint ) FROM PUBLIC;

