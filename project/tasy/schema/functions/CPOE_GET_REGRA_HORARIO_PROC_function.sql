-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_get_regra_horario_proc (nr_atendimento_p bigint, nr_seq_cpoe_order_unit_p bigint) RETURNS timestamp AS $body$
DECLARE


dt_return_w			timestamp;
cd_classif_setor_w		setor_atendimento.cd_classif_setor%type;
cd_setor_atendimento_w	setor_atendimento.cd_setor_atendimento%type;
dt_current_w		timestamp:= clock_timestamp();
nr_seq_cpoe_tipo_pedido_w	cpoe_order_unit.nr_seq_cpoe_tipo_pedido%type;
ie_tipo_atendimento_w	atendimento_paciente.ie_tipo_atendimento%type;
qt_hour_w	integer;
qt_minute_w	integer;


c_rule CURSOR FOR
SELECT	a.nr_qt_dias,
		a.dt_horario
from	regra_horario_proc a
where (a.cd_setor_atendimento = cd_setor_atendimento_w or coalesce(a.cd_setor_atendimento::text, '') = '')
and (a.cd_classif_setor = cd_classif_setor_w or coalesce(a.cd_classif_setor::text, '') = '')
and (a.cd_tipo_atendimento = ie_tipo_atendimento_w or coalesce(a.cd_tipo_atendimento::text, '') = '')
and (a.nr_seq_tipo_pedido = nr_seq_cpoe_tipo_pedido_w or coalesce(a.nr_seq_tipo_pedido::text, '') = '')
order by
	coalesce(a.cd_setor_atendimento,0),
	coalesce(a.cd_classif_setor,0),
	coalesce(a.nr_seq_tipo_pedido,0),
	coalesce(a.cd_tipo_atendimento,0);
										
BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	select	obter_setor_atendimento(a.nr_atendimento),
			obter_classif_setor(obter_setor_atendimento(a.nr_atendimento)),
			a.ie_tipo_atendimento
	into STRICT	cd_setor_atendimento_w,
			cd_classif_setor_w,
			ie_tipo_atendimento_w
	from	atendimento_paciente a
	where	a.nr_atendimento = nr_atendimento_p;
end if;

if (nr_seq_cpoe_order_unit_p IS NOT NULL AND nr_seq_cpoe_order_unit_p::text <> '') then
	select	a.nr_seq_cpoe_tipo_pedido
	into STRICT	nr_seq_cpoe_tipo_pedido_w
	from	cpoe_order_unit a
	where	a.nr_sequencia = nr_seq_cpoe_order_unit_p;
end if;

for r_c_rule in c_rule loop
	qt_hour_w	:= coalesce(pkg_date_utils.extract_field(field => 'HOUR',
													baseDate => r_c_rule.dt_horario),0);
	qt_minute_w	:= coalesce(pkg_date_utils.extract_field(field => 'MINUTE',
													baseDate => r_c_rule.dt_horario),0);

	if (r_c_rule.nr_qt_dias > 0) then
		dt_return_w	:= pkg_date_utils.get_DateTime(baseDate => dt_current_w + r_c_rule.nr_qt_dias,
													baseTime => pkg_date_utils.get_Time(hour => qt_hour_w,
																						minute => qt_minute_w));
	else
		dt_return_w	:= pkg_date_utils.get_DateTime(baseDate	=> dt_current_w,
													baseTime => pkg_date_utils.get_Time(hour => qt_hour_w,
																						minute => qt_minute_w));
	end if;
	
	if (dt_return_w < clock_timestamp()) then
		dt_return_w	:= dt_return_w + 1;
	end if;
end loop;

return	dt_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_get_regra_horario_proc (nr_atendimento_p bigint, nr_seq_cpoe_order_unit_p bigint) FROM PUBLIC;

