-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gpt_obter_se_exibe_item_susp (nr_prescricao_p prescr_medica.nr_prescricao%type) RETURNS varchar AS $body$
DECLARE


ie_nao_suspensos_w	varchar(1);
ie_susp_w		varchar(1);
ds_retorno_w		varchar(1);


BEGIN

ds_retorno_w		:= 'N';
ie_susp_w		:= 'N';

	-- Checks if there are any items in the prescription that are not suspended
	select coalesce(max('S'), 'N')
	into STRICT ie_nao_suspensos_w
	
	where exists (
		SELECT	1
		from	prescr_material m
		where	m.nr_prescricao = nr_prescricao_p
		and		coalesce(m.dt_suspensao::text, '') = ''
		and		m.ie_agrupador in (1, 2, 4, 5, 8, 12, 16)
	 LIMIT 1)
	or exists (
		SELECT	1
		from	prescr_solucao s
		where	s.nr_prescricao = nr_prescricao_p
		and	coalesce(s.dt_suspensao::text, '') = '' 
	 LIMIT 1)	
	or exists (
		select	1
		from	prescr_procedimento p
		where	p.nr_prescricao = nr_prescricao_p
		and	coalesce(p.dt_suspensao::text, '') = '' 
	 LIMIT 1)
	or exists (
		select	1
		from	prescr_dieta d
		where	d.nr_prescricao = nr_prescricao_p
		and	coalesce(d.dt_suspensao::text, '') = '' 
	 LIMIT 1)
	or exists (
		select	1
		from	rep_jejum j
		where	j.nr_prescricao	= nr_prescricao_p
		and	coalesce(j.ie_suspenso,'N') = 'N' 
	 LIMIT 1)
	or exists (
		select	1
		from	nut_pac n
		where	n.nr_prescricao = nr_prescricao_p
		and	coalesce(n.ie_suspenso,'N') = 'N' 
	 LIMIT 1)
	or exists (
		select	1
		from	prescr_gasoterapia g
		where	g.nr_prescricao = nr_prescricao_p
		and	coalesce(g.dt_suspensao::text, '') = '' 
	 LIMIT 1)
	or exists (
		select	1
		from	prescr_recomendacao r
		where	r.nr_prescricao = nr_prescricao_p
		and	coalesce(r.dt_suspensao::text, '') = '' 
	 LIMIT 1)
	or exists (
		select	1
		from	cpoe_hemoterapia h,
			prescr_solic_bco_sangue b,
			prescr_medica pr
		where	b.nr_prescricao = nr_prescricao_p
		and	b.nr_prescricao = pr.nr_prescricao
		and	h.nr_atendimento = pr.nr_atendimento
		and     h.nr_sequencia = b.nr_seq_hemo_cpoe
		and	((coalesce(h.dt_suspensao::text, '') = '') and (coalesce(pr.dt_suspensao::text, '') = '')) 
	 LIMIT 1);

	if (ie_nao_suspensos_w = 'N') then

		-- Checks if there are any suspended items in the prescription
		select coalesce(max('S'), 'N')
		into STRICT ie_susp_w
		
		where exists (
			SELECT	1
			from	prescr_material m
			where	m.nr_prescricao = nr_prescricao_p
			and		(m.dt_suspensao IS NOT NULL AND m.dt_suspensao::text <> '')
			and		m.ie_agrupador in (1, 2, 4, 5, 8, 12, 16)
			and		coalesce(m.ie_suspenso,'N') = 'S'
		 LIMIT 1)
		or exists (
			SELECT	1
			from	prescr_solucao s
			where	s.nr_prescricao = nr_prescricao_p
			and	(s.dt_suspensao IS NOT NULL AND s.dt_suspensao::text <> '')
			and	coalesce(s.ie_suspenso,'N') = 'S' 	
		 LIMIT 1)
		or exists (
			select	1
			from	prescr_procedimento p
			where	p.nr_prescricao = nr_prescricao_p
			and	(p.dt_suspensao IS NOT NULL AND p.dt_suspensao::text <> '')
			and	coalesce(p.ie_suspenso,'N') = 'S' 
		 LIMIT 1)
		or exists (
			select	1
			from	prescr_dieta d
			where	d.nr_prescricao = nr_prescricao_p
			and	(d.dt_suspensao IS NOT NULL AND d.dt_suspensao::text <> '')
			and	coalesce(d.ie_suspenso,'N') = 'S' 
		 LIMIT 1)
		or exists (
			select	1
			from	rep_jejum j
			where	j.nr_prescricao	= nr_prescricao_p
			and	coalesce(j.ie_suspenso,'N')	= 'S' 
		 LIMIT 1)
		or exists (
			select	1
			from	nut_pac n
			where	n.nr_prescricao = nr_prescricao_p
			and	coalesce(n.ie_suspenso,'N') = 'S'
			and	(n.dt_suspensao IS NOT NULL AND n.dt_suspensao::text <> '') 
		 LIMIT 1)
		or exists (
			select	1
			from	prescr_gasoterapia g
			where	g.nr_prescricao = nr_prescricao_p
			and	(g.dt_suspensao IS NOT NULL AND g.dt_suspensao::text <> '')
			and	coalesce(g.ie_suspenso,'N') = 'S' 		
		 LIMIT 1)
		or exists (
			select	1
			from	prescr_recomendacao r
			where	r.nr_prescricao = nr_prescricao_p
			and	(r.dt_suspensao IS NOT NULL AND r.dt_suspensao::text <> '')
			and	coalesce(r.ie_suspenso,'N')	= 'S' 
		 LIMIT 1)
		or exists (
			select	1
			from	cpoe_hemoterapia h,
				prescr_solic_bco_sangue b,
				prescr_medica pr
			where	b.nr_prescricao = nr_prescricao_p
			and	b.nr_prescricao = pr.nr_prescricao
			and	h.nr_atendimento = pr.nr_atendimento
			and     h.nr_sequencia = b.nr_seq_hemo_cpoe
			and	(h.dt_suspensao IS NOT NULL AND h.dt_suspensao::text <> '' AND pr.dt_suspensao IS NOT NULL AND pr.dt_suspensao::text <> '') 
		 LIMIT 1);

	end if;

if (ie_nao_suspensos_w = 'S') then
	ds_retorno_w := 'N'; -- INCLUDE this prescription as there are items not suspended
elsif (ie_nao_suspensos_w = 'N') and (ie_susp_w = 'S') then
	ds_retorno_w := 'S'; -- EXCLUDE this prescription as there are only suspended items in it
elsif (ie_nao_suspensos_w = 'N') and (ie_susp_w = 'N') then
	ds_retorno_w := 'S'; -- EXCLUDE this prescription as there are no items
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gpt_obter_se_exibe_item_susp (nr_prescricao_p prescr_medica.nr_prescricao%type) FROM PUBLIC;

