-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_val_apres_resumo ( nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


/*
	Consiste se vl_cobrado_manual está ok em relação ao valor do protocolo
	na geração do demonstrativo do protocolo(Gerar resumo protocolo)
*/
ie_consiste_valor_w		varchar(1);
ie_tipo_guia_w			pls_protocolo_conta.nr_sequencia%type;
ie_origem_protocolo_w	pls_protocolo_conta.ie_origem_protocolo%type;
ie_apresentacao_w		pls_protocolo_conta.ie_apresentacao%type;
vl_cobrado_manual_w		pls_protocolo_conta.vl_cobrado_manual%type;
vl_procedimento_imp_w	pls_conta_proc.vl_procedimento_imp%type;
vl_retorno_w			pls_conta_proc.vl_procedimento_imp%type;
vl_material_imp_w		pls_conta_mat.vl_material_imp%type;
ds_erro_w				varchar(255) := '';


BEGIN

	select	ie_tipo_guia,
			ie_origem_protocolo,
			ie_apresentacao,
			coalesce(vl_cobrado_manual,0) vl_cobrado_manual
	into STRICT	ie_tipo_guia_w,
			ie_origem_protocolo_w,
			ie_apresentacao_w,
			vl_cobrado_manual_w
	from	pls_protocolo_conta
	where	nr_sequencia = nr_seq_protocolo_p;

	ie_consiste_valor_w	:= pls_obter_se_cons_vl_apre_prot( ie_origem_protocolo_w, ie_tipo_guia_w, ie_apresentacao_w);

	if (ie_consiste_valor_w = 'S') then
		select	coalesce(sum(a.vl_procedimento_imp), 0) -- Ajustado para verificar o mat também pois énão era verificado
		into STRICT	vl_procedimento_imp_w
		from	pls_conta_proc	a,
			pls_conta	b
		where	a.nr_seq_conta		= b.nr_sequencia
		and	b.nr_seq_protocolo	= nr_seq_protocolo_p
		and	a.ie_status		not in ('D','M');

		select	coalesce(sum(a.vl_material_imp), 0)
		into STRICT	vl_material_imp_w
		from 	pls_conta_mat	a,
			pls_conta	b
		where	a.nr_seq_conta		= b.nr_sequencia
		and	b.nr_seq_protocolo	= nr_seq_protocolo_p
		and	a.ie_status		not in ('D','M');

		vl_retorno_w	:= coalesce(vl_procedimento_imp_w,0) + coalesce(vl_material_imp_w,0);

		if (vl_retorno_w <> vl_cobrado_manual_w ) then
			if (vl_cobrado_manual_w > 0) then
				ds_erro_w := wheb_mensagem_pck.get_texto(682603,'VL_PROCOLO=' || vl_cobrado_manual_w || ';' || 'VL_CONTA=' || vl_retorno_w || ';' || 'NR_SEQ_PROT=' || nr_seq_protocolo_p || ';' || 'NR_SEQ_LOTE=' || null);
			else
				--Se chegou aqui é por que há divergência de valores e também uma regra válida de consistência de valor e ainda o vl_cobrado_manual está nulo, então
				--retora um string de controle para alertar usuário.
				ds_erro_w := 'ZERADO';
			end if;
		end if;

	end if;

return ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_val_apres_resumo ( nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type) FROM PUBLIC;

