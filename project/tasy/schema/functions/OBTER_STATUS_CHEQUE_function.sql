-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_cheque (nr_seq_cheque_p bigint) RETURNS bigint AS $body$
DECLARE



/*	1 - À DEPOSITAR
	2 - DEPOSITADO
	3 - DEVOLVIDO
	4 - REAPRESENTADO
	5 - SEGUNDA DEVOLUCAO
	6 - DEVOLUCAO PACIENTE
	7 - VENDIDO PARA TERCEIROS
	8 - SACADO
	9 - SEGUNDA REAPRESENTAÇÃO
	10 - TERCEIRA DEVOLUÇAO
	11 - CUSTÓDIA
	12 - RESGATE CUSTÓDIA
	13 - Perda
	14 - Perda cobrança
*/
ie_status_cheque_w		smallint := 0;
dt_seg_devolucao_w		timestamp;
dt_reapresentacao_w		timestamp;
dt_devolucao_w			timestamp;
dt_devolucao_pac_w		timestamp;
dt_deposito_w			timestamp;
dt_venda_terc_w			timestamp;
dt_saque_w			timestamp;
dt_seg_reapresentacao_w		timestamp;
dt_terc_devolucao_w		timestamp;
dt_custodia_w			timestamp;
dt_resgate_custodia_w		timestamp;
nr_titulo_w			bigint;
nr_seq_baixa_w			integer;
dt_perda_w			timestamp;
ie_cheque_perda_w		varchar(255);
ie_existe_w			varchar(1);
ie_status_perda_cobr_w		varchar(1);


BEGIN
ie_existe_w := 'S';

begin
select	dt_deposito,
	dt_devolucao_banco,
	dt_reapresentacao,
	dt_seg_devolucao,
	dt_devolucao,
	dt_venda_terc,
	dt_saque,
	dt_seg_reapresentacao,
	dt_terc_devolucao,
	dt_custodia,
	dt_resgate_custodia,
	nr_titulo
into STRICT	dt_deposito_w,
	dt_devolucao_w,
	dt_reapresentacao_w,
	dt_seg_devolucao_w,
	dt_devolucao_pac_w,
	dt_venda_terc_w,
	dt_saque_w,
	dt_seg_reapresentacao_w,
	dt_terc_devolucao_w,
	dt_custodia_w,
	dt_resgate_custodia_w,
	nr_titulo_w
from	cheque_cr
where	nr_seq_cheque	= nr_seq_cheque_p;
exception
when others then
	ie_existe_w := 'N';
end;

if (ie_existe_w = 'S') then

	select	max(ie_status)
	into STRICT	ie_status_perda_cobr_w
	from	cobranca
	where	nr_seq_cheque	= nr_seq_cheque_p;

	dt_perda_w	:= to_date(obter_dados_cheque_cr(nr_seq_cheque_p, 'DTP'),'dd/mm/yyyy hh24:mi:ss');

	if (dt_perda_w IS NOT NULL AND dt_perda_w::text <> '') then
		ie_status_cheque_w	:= 13;
	elsif (dt_devolucao_pac_w IS NOT NULL AND dt_devolucao_pac_w::text <> '') then
		ie_status_cheque_w	:= 6;
	elsif (dt_venda_terc_w IS NOT NULL AND dt_venda_terc_w::text <> '') then
		ie_status_cheque_w	:= 7;
	elsif (dt_terc_devolucao_w IS NOT NULL AND dt_terc_devolucao_w::text <> '') then
		ie_status_cheque_w 	:= 10;
	elsif (dt_seg_reapresentacao_w IS NOT NULL AND dt_seg_reapresentacao_w::text <> '') then
		ie_status_cheque_w 	:= 9;
	elsif (dt_saque_w IS NOT NULL AND dt_saque_w::text <> '') then
		ie_status_cheque_w 	:= 8;
	elsif (dt_seg_devolucao_w IS NOT NULL AND dt_seg_devolucao_w::text <> '') then
		ie_status_cheque_w	:= 5;
	elsif (dt_reapresentacao_w IS NOT NULL AND dt_reapresentacao_w::text <> '') then
		ie_status_cheque_w	:= 4;
	elsif (dt_devolucao_w IS NOT NULL AND dt_devolucao_w::text <> '') then
		ie_status_cheque_w	:= 3;
	elsif (dt_deposito_w IS NOT NULL AND dt_deposito_w::text <> '') and (coalesce(dt_venda_terc_w::text, '') = '') then
		ie_status_cheque_w	:= 2;
	else

		if (dt_resgate_custodia_w IS NOT NULL AND dt_resgate_custodia_w::text <> '') then
			ie_status_cheque_w	:= 12;
		elsif (dt_custodia_w IS NOT NULL AND dt_custodia_w::text <> '') then
			ie_status_cheque_w	:= 11;
		elsif (coalesce(ie_status_perda_cobr_w,'P') = 'R') then
			ie_status_cheque_w	:= 14;
		else
			ie_status_cheque_w	:= 1;
		end if;

	end if;

end if;

return ie_status_cheque_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_cheque (nr_seq_cheque_p bigint) FROM PUBLIC;

