-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_descricao_rps_danfe ( cd_estabelecimento_p bigint, nr_seq_nota_p bigint, ds_atributo_p text) RETURNS varchar AS $body$
DECLARE

 
/* 
ds_atributo_p = é o atributo do arquivo que corresponde a descricao, hoje tratamento somente o ds_servicos 
 
Dom - 2706: 
1 - CD_ITEM 
2 - DS_ITEM 
3 - QT_ITEM 
4 - DS_OBS_NOTA 
5 - DS_PERIODO_CONTA 
6 - DS_CONTAS_PROTOCOLO 
7 - NR_SEQ_PROTOCOLO 
8 - NM_PACIENTE 
9 - DS_SETOR_ATENDIMENTO 
10 - NR_CPF 
11 - NR_PROTOCOLO 
12 - DS_COMPL_ITEM_NF 
13 - NR_NOTA_FISCAL 
14 - VL_ITEM 
15 - DT_ENTRADA (ATENDIMENTO_PACIENTE) 
16 - NR_INTERNO_CONTA 
17 - NR_ATENDIMENTO 
18 - NM_PESSOA_ATENDIMENTO 
19 - DT_NASCIMENTO_PACIENTE 
20 - VL_TOTAL_ITEM_NF 
21 - NM_PAGADOR 
22 - NR_CPF_PAGADOR 
23 - NR_CNPJ_PAGADOR 
24 - DT_VENCIMENTO 
25 - NM_MEDICO 
26 - DS_ESPECIALIDADE 
27 - NR_CRM 
28 - VL_TOTAL_NOTA 
29 - DS_PROCON 
30 - VL_LIQUIDO	-- criado por mhbarth 
31 - DS_TEXTO_PADRAO 
32 - VL_ATO_COOPERADO_PRINCIPAL 
33 - VL_ATO_COOPERADO_AUXILIAR 
56 - NR_TITULO (Título da conta paciente) 
34 - DS_TRIBUTO 
61 - DS_OBS_PROTOCOLO_CONVENIO 
62 - DS_TRIBUTO_CSLL 
63 - VL_TRIBUTO_CSLL 
64 - TX_TRIBUTO_CSLL 
65 - VL_SALDO_TIT_RECEBER 
79 - NR_FATURA 
*/
 
 
qt_existe_w		integer;
ds_retorno_w		varchar(2000)	:= '';
ds_regra_w		varchar(15);
ds_item_w		varchar(255);
cd_item_w		bigint;
qt_item_w		double precision;
vl_item_w			double precision;
vl_total_item_nf_w		double precision;
ie_ordem_w		integer;
nr_seq_protocolo_w	bigint;
cd_convenio_w		integer;
ds_contas_protocolo_w	varchar(2000);
nm_paciente_w		varchar(255);
qt_regra_convenio_w		bigint	:=0;
qt_regra_cgc_w			bigint	:=0;
qt_regra_operacao_nf_w		bigint	:=0;
ds_setor_atendimento_w	varchar(255);
ie_caracter_ant_w		varchar(255);
ie_caracter_pos_w		varchar(255);
nr_cpf_w			varchar(11);
nr_protocolo_w		varchar(40);
ds_complemento_w		varchar(255);
nr_nota_fiscal_w		varchar(255);
nr_interno_conta_w		bigint;
nr_atendimento_w		bigint;
nm_pessoa_atendimento_w	varchar(255);
dt_nascimento_paciente_w	varchar(255);
nm_pagador_w		varchar(255);
nr_cpf_pagador_w		varchar(20);
nr_cnpj_pagador_w		varchar(20);
dt_vencimento_w		timestamp;
nm_medico_w		varchar(255);
ds_especialidade_w	varchar(255);
nr_crm_w			varchar(255);
vl_total_nota_w		double precision;
vl_descontos_w		double precision;
vl_descontos_item_w	double precision;
ds_periodo_conta_w	varchar(255);
ds_observacao_w		varchar(2000);
dt_periodo_inicial_w	varchar(80);
dt_periodo_final_w		varchar(80);
ds_procom_w		varchar(1000);
vl_liquido_w		double precision;
ds_texto_padrao_w		varchar(1000);
vl_ato_principal_w		double precision;
vl_ato_auxiliar_w		double precision;
qt_nr_atendimento_w	bigint;
ds_tributo_pis_w		varchar(40);
vl_tributo_pis_w		double precision;
tx_tributo_pis_w		double precision;
ds_tributo_cofins_w		varchar(40);
vl_tributo_cofins_w		double precision;
tx_tributo_cofins_w		double precision;
ds_tributo_icms_w		varchar(40);
vl_tributo_icms_w		double precision;
tx_tributo_icms_w		double precision;
ds_tributo_iss_w		varchar(40);
vl_tributo_iss_w		double precision;
tx_tributo_iss_w		double precision;
ds_tributo_ir_w		varchar(40);
vl_tributo_ir_w		double precision;
tx_tributo_ir_w		double precision;
ds_tributo_inss_w		varchar(40);
vl_tributo_inss_w		double precision;
tx_tributo_inss_w		double precision;
vl_base_calculo_inss_w	double precision;
nr_seq_mensalidade_w	bigint;
ie_tipo_lote_mens_w	varchar(2);
vl_ato_nao_coop_w	double precision;
nr_protocolo_ans_w	varchar(20);
ds_plano_w		varchar(80);
vl_total_tributos_w		double precision;
tx_total_tributos_w		double precision;
vl_total_trib_percent_w	double precision;
ds_obs_prot_convenio_w	varchar(800);
ds_tributo_csll_w		varchar(40);
vl_tributo_csll_w		double precision;
tx_tributo_csll_w		double precision;
vl_saldo_tit_receber_w		double precision;
cd_cgc_w			nota_fiscal.cd_cgc%type;
ie_saldo_tit_maior_zero_w	regra_descricao_rps.ie_saldo_tit_maior_zero%type;	
cd_operacao_nf_w		operacao_nota.cd_operacao_nf%type;

c01 CURSOR FOR 
	/*Listar as regras gerais ou busca a regra geral se não existe regra para o convenio da nota e nem para Pessoa Jurídica */
 
	SELECT	distinct 
		CASE WHEN ds_regra='1' THEN 'I' WHEN ds_regra='2' THEN 'I' WHEN ds_regra='3' THEN 'I' WHEN ds_regra='12' THEN 'I' WHEN ds_regra='14' THEN 'I' WHEN ds_regra='20' THEN 'I' WHEN ds_regra='30' THEN 'I' WHEN ds_regra='57' THEN 'I'  ELSE ds_regra END , 
		max(ie_ordem) ie_ordem, 
		coalesce(max(ie_saldo_tit_maior_zero),'N') ie_saldo_tit_maior_zero, 
		coalesce(substr(max(ie_caractere_ant),1,255),'') caracter_ant, 
		coalesce(substr(max(ie_caractere_fim),1,255),'') caracter_pos 
	from	regra_descricao_rps 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and	((coalesce(cd_convenio_w::text, '') = '' and coalesce(cd_convenio::text, '') = '') or ((cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') and coalesce(cd_convenio::text, '') = '' and qt_regra_convenio_w = 0)) 
	and	((coalesce(cd_cgc_w::text, '') = '' and coalesce(cd_cnpj::text, '') = '') or ((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and coalesce(cd_cnpj::text, '') = '' and qt_regra_cgc_w = 0)) 
	and	((coalesce(ie_mensalidade,'N') = 'S' and (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '')) or (coalesce(ie_mensalidade,'N') = 'M' and coalesce(nr_seq_mensalidade_w::text, '') = '') or (coalesce(ie_mensalidade,'N') = 'N')) 
	and	((ie_tipo_lote_mensalidade = ie_tipo_lote_mens_w) or (coalesce(ie_tipo_lote_mensalidade::text, '') = '')) 
	and	((coalesce(cd_operacao_nf_w::text, '') = '' and coalesce(cd_operacao_nf::text, '') = '') or ((cd_operacao_nf_w IS NOT NULL AND cd_operacao_nf_w::text <> '') and coalesce(cd_operacao_nf::text, '') = '' and qt_regra_operacao_nf_w = 0)) 
	and 	coalesce(ie_situacao,'A') = 'A' 
	group by CASE WHEN ds_regra='1' THEN 'I' WHEN ds_regra='2' THEN 'I' WHEN ds_regra='3' THEN 'I' WHEN ds_regra='12' THEN 'I' WHEN ds_regra='14' THEN 'I' WHEN ds_regra='20' THEN 'I' WHEN ds_regra='30' THEN 'I' WHEN ds_regra='57' THEN 'I'  ELSE ds_regra END  
	
union all
 
	/*Listar somente a regra para o convenio da nota*/
 
	SELECT	distinct 
		CASE WHEN ds_regra='1' THEN 'I' WHEN ds_regra='2' THEN 'I' WHEN ds_regra='3' THEN 'I' WHEN ds_regra='12' THEN 'I' WHEN ds_regra='14' THEN 'I' WHEN ds_regra='20' THEN 'I' WHEN ds_regra='30' THEN 'I' WHEN ds_regra='57' THEN 'I'  ELSE ds_regra END , 
		max(ie_ordem) ie_ordem, 
		coalesce(max(ie_saldo_tit_maior_zero),'N') ie_saldo_tit_maior_zero, 
		coalesce(substr(max(ie_caractere_ant),1,255),'') caracter_ant, 
		coalesce(substr(max(ie_caractere_fim),1,255),'') caracter_pos 
	from	regra_descricao_rps 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and	(cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') 
	and	cd_convenio = cd_convenio_w 
	and 	coalesce(ie_situacao,'A') = 'A' 
	and	coalesce(cd_cnpj::text, '') = '' 
	and	coalesce(cd_operacao_nf::text, '') = '' 
	group by CASE WHEN ds_regra='1' THEN 'I' WHEN ds_regra='2' THEN 'I' WHEN ds_regra='3' THEN 'I' WHEN ds_regra='12' THEN 'I' WHEN ds_regra='14' THEN 'I' WHEN ds_regra='20' THEN 'I' WHEN ds_regra='30' THEN 'I' WHEN ds_regra='57' THEN 'I'  ELSE ds_regra END  
	
union all
 
	/*Listar somente a regra para Pessoa Jurídica da nota*/
 
	select	distinct 
		CASE WHEN ds_regra='1' THEN 'I' WHEN ds_regra='2' THEN 'I' WHEN ds_regra='3' THEN 'I' WHEN ds_regra='12' THEN 'I' WHEN ds_regra='14' THEN 'I' WHEN ds_regra='20' THEN 'I' WHEN ds_regra='30' THEN 'I' WHEN ds_regra='57' THEN 'I'  ELSE ds_regra END , 
		max(ie_ordem) ie_ordem, 
		coalesce(max(ie_saldo_tit_maior_zero),'N') ie_saldo_tit_maior_zero, 
		coalesce(substr(max(ie_caractere_ant),1,255),'') caracter_ant, 
		coalesce(substr(max(ie_caractere_fim),1,255),'') caracter_pos 
	from	regra_descricao_rps 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and	(cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') 
	and	cd_cnpj = cd_cgc_w 
	and 	coalesce(ie_situacao,'A') = 'A' 
	and	coalesce(cd_convenio::text, '') = '' 
	and	coalesce(cd_operacao_nf::text, '') = '' 
	group by CASE WHEN ds_regra='1' THEN 'I' WHEN ds_regra='2' THEN 'I' WHEN ds_regra='3' THEN 'I' WHEN ds_regra='12' THEN 'I' WHEN ds_regra='14' THEN 'I' WHEN ds_regra='20' THEN 'I' WHEN ds_regra='30' THEN 'I' WHEN ds_regra='57' THEN 'I'  ELSE ds_regra END  
	
union all
 
	/* Listar somente a regra para Operação da Nota Fiscal */
 
	select	distinct 
		CASE WHEN ds_regra='1' THEN 'I' WHEN ds_regra='2' THEN 'I' WHEN ds_regra='3' THEN 'I' WHEN ds_regra='12' THEN 'I' WHEN ds_regra='14' THEN 'I' WHEN ds_regra='20' THEN 'I' WHEN ds_regra='30' THEN 'I' WHEN ds_regra='57' THEN 'I'  ELSE ds_regra END , 
		max(ie_ordem) ie_ordem, 
		coalesce(max(ie_saldo_tit_maior_zero),'N') ie_saldo_tit_maior_zero, 
		coalesce(substr(max(ie_caractere_ant),1,255),'') caracter_ant, 
		coalesce(substr(max(ie_caractere_fim),1,255),'') caracter_pos 
	from	regra_descricao_rps 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and	(cd_operacao_nf_w IS NOT NULL AND cd_operacao_nf_w::text <> '') 
	and	cd_operacao_nf = cd_operacao_nf_w 
	and 	coalesce(ie_situacao,'A') = 'A' 
	and	coalesce(cd_convenio::text, '') = '' 
	and	coalesce(cd_cnpj::text, '') = '' 
	group by CASE WHEN ds_regra='1' THEN 'I' WHEN ds_regra='2' THEN 'I' WHEN ds_regra='3' THEN 'I' WHEN ds_regra='12' THEN 'I' WHEN ds_regra='14' THEN 'I' WHEN ds_regra='20' THEN 'I' WHEN ds_regra='30' THEN 'I' WHEN ds_regra='57' THEN 'I'  ELSE ds_regra END  
	order by ie_ordem;

c02 CURSOR FOR  -- Apenas regra sem PJ e Convênio 
	SELECT	ds_regra, 
		ie_ordem, 
		coalesce(substr(ie_caractere_ant,1,255),'') caracter_ant, 
		coalesce(substr(ie_caractere_fim,1,255),'') caracter_pos 
	from	regra_descricao_rps 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and	((coalesce(cd_convenio_w::text, '') = '' and coalesce(cd_convenio::text, '') = '') or ((cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') and coalesce(cd_convenio::text, '') = '' and qt_regra_convenio_w = 0)) 
	and	((coalesce(cd_cgc_w::text, '') = '' and coalesce(cd_cnpj::text, '') = '') or ((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and coalesce(cd_cnpj::text, '') = '' and qt_regra_cgc_w = 0)) 
	and	((coalesce(cd_operacao_nf_w::text, '') = '' and coalesce(cd_operacao_nf::text, '') = '') or ((cd_operacao_nf_w IS NOT NULL AND cd_operacao_nf_w::text <> '') and coalesce(cd_operacao_nf::text, '') = '' and qt_regra_operacao_nf_w = 0)) 
	and	ds_regra in ('1','2','3','12','14','20','30','57') 
	and 	coalesce(ie_situacao,'A') = 'A' 
	group by ds_regra, ie_ordem, ie_caractere_ant, ie_caractere_fim 
	
union all
  -- union que traz regra por Convênio 
	SELECT	ds_regra, 
		ie_ordem, 
		coalesce(substr(ie_caractere_ant,1,255),'') caracter_ant, 
		coalesce(substr(ie_caractere_fim,1,255),'') caracter_pos 
	from	regra_descricao_rps 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and	(cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') 
	and	cd_convenio = cd_convenio_w 
	and	ds_regra in ('1','2','3','12','14','20','30','57') 
	and 	coalesce(ie_situacao,'A') = 'A' 
	and	coalesce(cd_cnpj::text, '') = '' 
	and	coalesce(cd_operacao_nf::text, '') = '' 
	group by ds_regra, ie_ordem, ie_caractere_ant, ie_caractere_fim 
	
union all
   -- union que traz regra por PJ 
	select	ds_regra, 
		ie_ordem, 
		coalesce(substr(max(ie_caractere_ant),1,255),'') caracter_ant, 
		coalesce(substr(max(ie_caractere_fim),1,255),'') caracter_pos 
	from	regra_descricao_rps 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and	(cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') 
	and	cd_cnpj = cd_cgc_w 
	and	ds_regra in ('1','2','3','12','14','20','30','57') 
	and 	coalesce(ie_situacao,'A') = 'A' 
	and	coalesce(cd_convenio::text, '') = '' 
	and	coalesce(cd_operacao_nf::text, '') = '' 
	group by ds_regra, ie_ordem, ie_caractere_ant, ie_caractere_fim 
	
union all
  --union que traz a regra por operacao da nota 
	select	ds_regra, 
		ie_ordem, 
		coalesce(substr(max(ie_caractere_ant),1,255),'') caracter_ant, 
		coalesce(substr(max(ie_caractere_fim),1,255),'') caracter_pos 
	from	regra_descricao_rps 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and	(cd_operacao_nf_w IS NOT NULL AND cd_operacao_nf_w::text <> '') 
	and	cd_operacao_nf = cd_operacao_nf_w 
	and	ds_regra in ('1','2','3','12','14','20','30','57') 
	and 	coalesce(ie_situacao,'A') = 'A' 
	and	coalesce(cd_convenio::text, '') = '' 
	and	coalesce(cd_cnpj::text, '') = '' 
	group by ds_regra, ie_ordem, ie_caractere_ant, ie_caractere_fim 
	order by ie_ordem;
	
 
c03 CURSOR FOR 
	SELECT	coalesce(cd_material, cd_procedimento) cd_item, 
		qt_item_nf, 
		vl_unitario_item_nf, 
		vl_total_item_nf, 
		vl_liquido, 
		coalesce(substr(obter_desc_material(cd_material),1,255), 
		substr(obter_descricao_procedimento(cd_procedimento, ie_origem_proced),1,255)) ds_item, 
		coalesce(substr(ds_complemento,1,255),'') ds_complemento, 
		vl_desconto 
	from	nota_fiscal_item 
	where	nr_sequencia	= nr_seq_nota_p;

c04 CURSOR FOR 
	SELECT	dt_vencimento 
	from	nota_fiscal_venc 
	where 	nr_sequencia = nr_seq_nota_p;

c05 CURSOR FOR 
	SELECT	coalesce(sum(d.vl_ato_cooperado),0), 
		coalesce(sum(d.vl_ato_auxiliar),0), 
		coalesce(sum(d.vl_ato_nao_cooperado),0) 
	from	pls_mensalidade_seg_item	d, 
		pls_mensalidade_segurado	c, 
		pls_mensalidade			b, 
		nota_fiscal			a 
	where	a.nr_sequencia		= nr_seq_nota_p 
	and	a.nr_seq_mensalidade	= b.nr_sequencia 
	and	b.nr_sequencia		= c.nr_seq_mensalidade 
	and	c.nr_sequencia		= d.nr_seq_mensalidade_seg;

c06 CURSOR FOR 
	SELECT	max(ds_pis) ds_pis, 
		max(vl_pis) vl_pis, 
		max(tx_pis) tx_pis, 
		max(ds_cofins) ds_cofins, 
		max(vl_cofins) vl_cofins, 
		max(tx_cofins) tx_cofins, 
		max(ds_icms) ds_icms, 
		max(vl_icms) vl_icms, 
		max(tx_icms) tx_icms, 
		max(ds_iss) ds_iss, 
		max(vl_iss) vl_iss, 
		max(tx_iss) tx_iss, 
		max(ds_ir) ds_ir, 
		max(vl_ir) vl_ir, 
		max(tx_ir) tx_ir, 
		max(ds_inss) ds_inss, 
		max(vl_inss) vl_inss, 
		max(tx_inss) tx_inss, 
		max(vl_base_calculo_inss) vl_base_calculo_inss, 
		max(ds_csll) ds_csll, 
		max(vl_csll) vl_csll, 
		max(tx_csll) tx_csll 
	from ( 
		SELECT	b.ds_tributo	ds_pis, 
			a.vl_tributo	vl_pis, 
			a.tx_tributo	tx_pis, 
			''		ds_cofins, 
			null		vl_cofins, 
			null		tx_cofins, 
			''		ds_icms, 
			null		vl_icms, 
			null		tx_icms, 
			''		ds_iss, 
			null		vl_iss, 
			null		tx_iss, 
			''		ds_ir, 
			null		vl_ir, 
			null		tx_ir, 
			''		ds_inss, 
			null		vl_inss, 
			null		tx_inss, 
			null		vl_base_calculo_inss, 
			''			ds_csll, 
			null		vl_csll, 
			null		tx_csll 
		from	nota_fiscal_trib a, 
			tributo b 
		where	a.cd_tributo	= b.cd_tributo 
		and	nr_sequencia	= nr_seq_nota_p 
		and	b.ie_tipo_tributo = 'PIS' 
		
union all
 
		select	''		ds_pis, 
			null		vl_pis, 
			null		tx_pis, 
			b.ds_tributo	ds_cofins, 
			a.vl_tributo	vl_cofins, 
			a.tx_tributo	tx_cofins, 
			''		ds_icms, 
			null		vl_icms, 
			null		tx_icms, 
			''		ds_iss, 
			null		vl_iss, 
			null		tx_iss, 
			''		ds_ir, 
			null		vl_ir, 
			null		tx_ir, 
			''		ds_inss, 
			null		vl_inss, 
			null		tx_inss, 
			null		vl_base_calculo_inss, 
			''			ds_csll, 
			null		vl_csll, 
			null		tx_csll 
		from	nota_fiscal_trib a, 
			tributo b 
		where	a.cd_tributo	= b.cd_tributo 
		and	nr_sequencia	= nr_seq_nota_p 
		and	b.ie_tipo_tributo = 'COFINS' 
		
union all
 
		select	''		ds_pis, 
			null		vl_pis, 
			null		tx_pis, 
			''		ds_cofins, 
			null		vl_cofins, 
			null		tx_cofins, 
			b.ds_tributo	ds_icms, 
			a.vl_tributo	vl_icms, 
			a.tx_tributo	tx_icms, 
			''		ds_iss, 
			null		vl_iss, 
			null		tx_iss, 
			''		ds_ir, 
			null		vl_ir, 
			null		tx_ir, 
			''		ds_inss, 
			null		vl_inss, 
			null		tx_inss, 
			null		vl_base_calculo_inss, 
			''			ds_csll, 
			null		vl_csll, 
			null		tx_csll 
		from	nota_fiscal_trib a, 
			tributo b 
		where	a.cd_tributo	= b.cd_tributo 
		and	nr_sequencia	= nr_seq_nota_p 
		and	b.ie_tipo_tributo = 'ICMS' 
		
union all
 
		select	''		ds_pis, 
			null		vl_pis, 
			null		tx_pis, 
			''		ds_cofins, 
			null		vl_cofins, 
			null		tx_cofins, 
			''		ds_icms, 
			null		vl_icms, 
			null		tx_icms, 
			b.ds_tributo	ds_iss, 
			a.vl_tributo	vl_iss, 
			a.tx_tributo	tx_iss, 
			''		ds_ir, 
			null		vl_ir, 
			null		tx_ir, 
			''		ds_inss, 
			null		vl_inss, 
			null		tx_inss, 
			null		vl_base_calculo_inss, 
			''			ds_csll, 
			null		vl_csll, 
			null		tx_csll 
		from	nota_fiscal_trib a, 
			tributo b 
		where	a.cd_tributo	= b.cd_tributo 
		and	nr_sequencia	= nr_seq_nota_p 
		and	b.ie_tipo_tributo = 'ISS' 
		
union all
 
		select	''		ds_pis, 
			null		vl_pis, 
			null		tx_pis, 
			''		ds_cofins, 
			null		vl_cofins, 
			null		tx_cofins, 
			''		ds_icms, 
			null		vl_icms, 
			null		tx_icms, 
			''		ds_iss, 
			null		vl_iss, 
			null		tx_iss, 
			b.ds_tributo	ds_ir, 
			a.vl_tributo	vl_ir, 
			a.tx_tributo	tx_ir, 
			''		ds_inss, 
			null		vl_inss, 
			null		tx_inss, 
			null		vl_base_calculo_inss, 
			''			ds_csll, 
			null		vl_csll, 
			null		tx_csll 
		from	nota_fiscal_trib a, 
			tributo b 
		where	a.cd_tributo	= b.cd_tributo 
		and	nr_sequencia	= nr_seq_nota_p 
		and	b.ie_tipo_tributo = 'IR' 
		
union all
 
		select	''		ds_pis, 
			null		vl_pis, 
			null		tx_pis, 
			''		ds_cofins, 
			null		vl_cofins, 
			null		tx_cofins, 
			''		ds_icms, 
			null		vl_icms, 
			null		tx_icms, 
			''		ds_iss, 
			null		vl_iss, 
			null		tx_iss, 
			''		ds_ir, 
			null		vl_ir, 
			null		tx_ir, 
			b.ds_tributo	ds_inss, 
			a.vl_tributo	vl_inss, 
			a.tx_tributo	tx_inss, 
			a.vl_base_calculo vl_base_calculo_inss, 
			''			ds_csll, 
			null		vl_csll, 
			null		tx_csll 
		from	nota_fiscal_trib a, 
			tributo b 
		where	a.cd_tributo	= b.cd_tributo 
		and	nr_sequencia	= nr_seq_nota_p 
		and	b.ie_tipo_tributo = 'INSS' 
		
union all
 
		select	''		ds_pis, 
			null		vl_pis, 
			null		tx_pis, 
			''		ds_cofins, 
			null		vl_cofins, 
			null		tx_cofins, 
			''		ds_icms, 
			null		vl_icms, 
			null		tx_icms, 
			''		ds_iss, 
			null		vl_iss, 
			null		tx_iss, 
			''		ds_ir, 
			null		vl_ir, 
			null		tx_ir, 
			''		ds_inss, 
			null		vl_inss, 
			null		tx_inss, 
			null		vl_base_calculo_inss, 
			b.ds_tributo	ds_csll, 
			a.vl_tributo	vl_csll, 
			a.tx_tributo	tx_csll 
		from	nota_fiscal_trib a, 
			tributo b 
		where	a.cd_tributo	= b.cd_tributo 
		and	nr_sequencia	= nr_seq_nota_p 
		and	b.ie_tipo_tributo = 'CSLL') alias22;


BEGIN 
 
select	count(*) 
into STRICT	qt_existe_w 
from	regra_descricao_rps 
where	cd_estabelecimento	= cd_estabelecimento_p 
and 	coalesce(ie_situacao,'A') = 'A';
 
select	obter_convenio_nf(nr_seq_nota_p) 
into STRICT	cd_convenio_w
;
 
begin 
select	max(cd_cgc) 
into STRICT	cd_cgc_w 
from	nota_fiscal 
where	nr_sequencia = nr_seq_nota_p;
exception 
	when no_data_found then 
		cd_cgc_w := null;
end;
 
select	max(cd_operacao_nf) 
into STRICT	cd_operacao_nf_w 
from	nota_fiscal 
where	nr_sequencia = nr_seq_nota_p;
 
select	count(*) 
into STRICT	qt_regra_convenio_w 
from	regra_descricao_rps 
where	cd_estabelecimento	= cd_estabelecimento_p 
and	cd_convenio		= coalesce(cd_convenio_w,0) 
and 	coalesce(ie_situacao,'A') = 'A';
 
select	count(*) 
into STRICT	qt_regra_cgc_w 
from	regra_descricao_rps 
where	cd_estabelecimento	= cd_estabelecimento_p 
and	cd_cnpj			= coalesce(cd_cgc_w,0) 
and 	coalesce(ie_situacao,'A') = 'A';
 
select	count(*) 
into STRICT	qt_regra_operacao_nf_w 
from	regra_descricao_rps 
where	cd_estabelecimento	= cd_estabelecimento_p 
and	cd_operacao_nf		= cd_operacao_nf_w;
 
select	substr(obter_select_concatenado_bv(' 
		select	nr_interno_conta 
		from	conta_paciente 
		where	nr_seq_protocolo = :nr_seq_protocolo', 
		'nr_seq_protocolo='|| nr_seq_protocolo || ';',', '),1,2000) 
into STRICT	ds_contas_protocolo_w 
from	nota_fiscal 
where	nr_sequencia = nr_seq_nota_p;
 
if (qt_existe_w > 0) then 
	begin 
	if (ds_atributo_p = 'DS_SERVICOS') then 
		begin	 
		 
		select	n.nr_seq_protocolo, 
			n.nr_nota_fiscal, 
			coalesce(n.vl_total_nota,0), 
			n.nr_interno_conta, 
			obter_nr_atendimento_nota(n.nr_sequencia), 
			substr(elimina_acentuacao(obter_pessoa_atendimento(obter_nr_atendimento_nota(n.nr_sequencia), 'N')), 1, 80), 
			coalesce(obter_pagador_atend(coalesce(obter_nr_atendimento_nota(n.nr_sequencia), 0)), coalesce(obter_pessoa_atendimento(obter_nr_atendimento_nota(n.nr_sequencia), 'N'),'')), 
			substr(obter_Cpf_Pessoa_Fisica(Obter_pessoa_Pagador_Atend(obter_nr_atendimento_nota(n.nr_sequencia))),1, 20), 
			CASE WHEN(length(substr(Obter_pessoa_Pagador_Atend(obter_nr_atendimento_nota(n.nr_sequencia)),1, 20)))=14 THEN  Obter_pessoa_Pagador_Atend(obter_nr_atendimento_nota(n.nr_sequencia))  ELSE '' END , 
			n.nr_seq_mensalidade, 
			n.vl_descontos, 
			(((select f.vl_base_calculo from nota_fiscal_trib f where f.nr_sequencia = n.nr_sequencia  LIMIT 1) / 100) * Obter_Valor_Tributo_Nota(n.nr_sequencia, 'X')), -- Alterado por apapandini OS 622531 
			Obter_Valor_Tributo_Nota(n.nr_sequencia, 'X')		-- Alterado por apapandini OS 622531 
		into STRICT	nr_seq_protocolo_w, 
			nr_nota_fiscal_w, 
			vl_total_nota_w, 
			nr_interno_conta_w, 
			nr_atendimento_w, 
			nm_pessoa_atendimento_w, 
			nm_pagador_w, 
			nr_cpf_pagador_w, 
			nr_cnpj_pagador_w, 
			nr_seq_mensalidade_w, 
			vl_descontos_w, 
			vl_total_tributos_w, 
			tx_total_tributos_w 
		from	nota_fiscal n 
		where	n.nr_sequencia	= nr_seq_nota_p;
		 
		if (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '') then 
			select	max(ie_tipo_lote) 
			into STRICT	ie_tipo_lote_mens_w 
			from	pls_mensalidade	a, 
				pls_lote_mensalidade b 
			where	a.nr_seq_lote	= b.nr_sequencia 
			and	a.nr_sequencia	= nr_seq_mensalidade_w;
		end if;
		 
		select	coalesce(max(b.nr_protocolo),'0'), 
				max(b.ds_observacao) 
		into STRICT	nr_protocolo_w, 
				ds_obs_prot_convenio_w 
		from	nota_fiscal a, 
			protocolo_convenio b 
		where	a.nr_seq_protocolo	= nr_seq_protocolo_w 
		and	a.nr_seq_protocolo	= b.nr_seq_protocolo 
		and	a.nr_sequencia		= nr_seq_nota_p;
		 
		if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then 
			begin 
			select	substr(obter_dados_atendimento(nr_atendimento_w ,'NMR'),1,255), 
				substr(obter_dados_medico(obter_dados_atendimento(nr_atendimento_w ,'MR'), 'CRM'),1,255), 
				substr(obter_especialidade_medico(obter_dados_atendimento(nr_atendimento_w ,'MR'), 'DV'),1,255) 
			into STRICT	nm_medico_w, 
				nr_crm_w, 
				ds_especialidade_w 
			;
			end;
		end if;
		 
		if (coalesce(nr_seq_protocolo_w::text, '') = '') then 
			begin 
			select	substr((select	substr(obter_nome_pf(a.cd_pessoa_fisica),1,150) 
							from	atendimento_paciente a, 
									conta_paciente c 
							where	a.nr_atendimento = c.nr_atendimento 
							and		c.nr_interno_conta = n.nr_interno_conta),1,2000) 
			into STRICT	nm_paciente_w 
			from	nota_fiscal n 
			where	n.nr_sequencia = nr_seq_nota_p;
			 
			select	substr((select substr(obter_dados_pf(a.cd_pessoa_fisica, 'DN'),1,30) 
							from	atendimento_paciente a, 
									conta_paciente c 
							where	a.nr_atendimento = c.nr_atendimento 
							and	c.nr_interno_conta = n.nr_interno_conta),1,30) 
			into STRICT	dt_nascimento_paciente_w 
			from	nota_fiscal n 
			where	n.nr_sequencia	= nr_seq_nota_p;
			 
			select	substr((select substr(obter_dados_pf(a.cd_pessoa_fisica,'CPF'),1,11) 
							from	atendimento_paciente a, 
									conta_paciente c 
							where	a.nr_atendimento = c.nr_atendimento 
							and		c.nr_interno_conta = n.nr_interno_conta),1,2000) 
			into STRICT	nr_cpf_w 
			from	nota_fiscal n 
			where	n.nr_sequencia		= nr_seq_nota_p;
			 
			select	max(substr(obter_nome_setor(obter_setor_atendimento(c.nr_atendimento)),1,255)) 
			into STRICT	ds_setor_atendimento_w 
			from	conta_paciente c, 
				nota_fiscal n 
			where	n.nr_sequencia		= nr_seq_nota_p 
			and	c.nr_interno_conta	= n.nr_interno_conta;
			end;
		else 
			begin 
			select	count(l.nr_atendimento) 
			into STRICT	qt_nr_atendimento_w 
			from (SELECT	nr_atendimento 
					from	nota_fiscal_item 
					where	nr_sequencia = nr_seq_nota_p 
					group by nr_atendimento) l;
			 
			if (qt_nr_atendimento_w = 1) then 
				begin 
				select	substr((select substr(obter_nome_pf(a.cd_pessoa_fisica),1,150) 
						from	atendimento_paciente a, 
								conta_paciente c 
						where	a.nr_atendimento = c.nr_atendimento 
						and	c.nr_interno_conta = n.nr_interno_conta),1,2000) 
				into STRICT	nm_paciente_w 
				from	nota_fiscal n 
				where	n.nr_sequencia = nr_seq_nota_p;
				 
				select	substr((select substr(obter_dados_pf(a.cd_pessoa_fisica, 'DN'),1,30) 
						from	atendimento_paciente a, 
								conta_paciente c 
						where	a.nr_atendimento = c.nr_atendimento 
						and	c.nr_interno_conta = n.nr_interno_conta),1,30) 
				into STRICT	dt_nascimento_paciente_w 
				from	nota_fiscal n 
				where	n.nr_sequencia = nr_seq_nota_p;
				 
				select	substr((select substr(obter_dados_pf(a.cd_pessoa_fisica,'CPF'),1,11) 
						from	atendimento_paciente a, 
								conta_paciente c 
						where	a.nr_atendimento = c.nr_atendimento 
						and	c.nr_interno_conta = n.nr_interno_conta),1,2000) 
				into STRICT	nr_cpf_w 
				from	nota_fiscal n 
				where	n.nr_sequencia = nr_seq_nota_p;
				 
				select	max(substr(obter_nome_setor(obter_setor_atendimento(c.nr_atendimento)),1,255)) 
				into STRICT	ds_setor_atendimento_w 
				from	conta_paciente c, 
					nota_fiscal n 
				where	n.nr_sequencia = nr_seq_nota_p 
				and	c.nr_interno_conta = n.nr_interno_conta;
				end;
			end if;
			end;
		end if;
		 
		open c01;
		loop 
		fetch c01 into 
			ds_regra_w, 
			ie_ordem_w, 
			ie_saldo_tit_maior_zero_w, 
			ie_caracter_ant_w, 
			ie_caracter_pos_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin 
			if (ds_regra_w = '8') then 
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nm_paciente_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '10') then 
				ds_retorno_w	:= substr(ds_retorno_w || ie_caracter_ant_w || nr_cpf_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '16') then 
				ds_retorno_w	:= substr(ds_retorno_w || ie_caracter_ant_w || nr_interno_conta_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '17') then 
				ds_retorno_w	:= substr(ds_retorno_w || ie_caracter_ant_w || nr_atendimento_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '18') then 
				ds_retorno_w	:= substr(ds_retorno_w || ie_caracter_ant_w || nm_pessoa_atendimento_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '19') then 
				ds_retorno_w	:= substr(ds_retorno_w || ie_caracter_ant_w || dt_nascimento_paciente_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '21') and (nm_pagador_w IS NOT NULL AND nm_pagador_w::text <> '') then 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nm_pagador_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '22') and (nr_cpf_pagador_w IS NOT NULL AND nr_cpf_pagador_w::text <> '') then 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_cpf_pagador_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '23') and (nr_cnpj_pagador_w IS NOT NULL AND nr_cnpj_pagador_w::text <> '') then 
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_cnpj_pagador_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '25') then 
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nm_medico_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '26') then 
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_especialidade_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '27') then 
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_crm_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '5') then 
				if (coalesce(ie_caracter_ant_w::text, '') = '') then 
					ie_caracter_ant_w := ' ' || 'Período de fechamento ';
				else 
					ie_caracter_ant_w := ie_caracter_ant_w;
				end if;
				 
				if (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') then 
					select	to_char(c.dt_periodo_inicial, 'dd/mm/yyyy'), 
						to_char(c.dt_periodo_final, 'dd/mm/yyyy') 
					into STRICT	dt_periodo_inicial_w, 
						dt_periodo_final_w 
					from	atendimento_paciente a, 
						conta_paciente c 
					where	a.nr_atendimento = c.nr_atendimento 
					and	c.nr_interno_conta = nr_interno_conta_w;
					 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || dt_periodo_inicial_w || ' a ' || dt_periodo_final_w || ie_caracter_pos_w,1,2000);
				end if;
			elsif (ds_regra_w = '15') then 
				select	substr(ds_retorno_w || ie_caracter_ant_w || dt_entrada || ie_caracter_pos_w,1,2000) 
				into STRICT	ds_retorno_w 
				from	nota_fiscal n, 
					atendimento_paciente a, 
					conta_paciente c 
				where	a.nr_atendimento = c.nr_atendimento 
				and	c.nr_interno_conta = n.nr_interno_conta 
				and	n.nr_sequencia = nr_seq_nota_p;								
			elsif (ds_regra_w = '56') then 
				select	substr(ds_retorno_w || ie_caracter_ant_w || max(obter_titulo_conta_protocolo(0,n.nr_interno_conta)) || ie_caracter_pos_w,1,2000) 
				into STRICT	ds_retorno_w 
				from	nota_fiscal n, 
					conta_paciente c 
				where	n.nr_sequencia = nr_seq_nota_p;				
			elsif (ds_regra_w = '79') then 
				select	substr(ds_retorno_w || ie_caracter_ant_w || max(nr_seq_fatura) || ie_caracter_pos_w,1,2000) 
				into STRICT	ds_retorno_w 
				from	nota_fiscal 
				where	nr_sequencia = nr_seq_nota_p;				
			elsif (ds_regra_w = '4') then 
				if (coalesce(ie_caracter_ant_w::text, '') = '') then 
					ie_caracter_ant_w := ' ';
				else 
					ie_caracter_ant_w := ie_caracter_ant_w;
				end if;
				select	substr(ds_observacao, 1, 1000) 
				into STRICT	ds_observacao_w 
				from	nota_fiscal 
				where	nr_sequencia	= nr_seq_nota_p;
				 
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_observacao_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '6') and ((trim(both ds_contas_protocolo_w) IS NOT NULL AND (trim(both ds_contas_protocolo_w))::text <> '')) then 
					if (coalesce(ie_caracter_ant_w::text, '') = '') then 
						ds_retorno_w := substr(ds_retorno_w || ' Conta(s): ' || ds_contas_protocolo_w,1,2000);
					else 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_contas_protocolo_w || ie_caracter_pos_w,1,2000);
					end if;
			elsif (ds_regra_w = '7') and (nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') then 
				if (coalesce(ie_caracter_ant_w::text, '') = '') then 
					ds_retorno_w := substr(ds_retorno_w || ' Protocolo: ' || nr_seq_protocolo_w,1,2000);
				else 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_seq_protocolo_w || ie_caracter_pos_w,1,2000);
				end if;
			elsif (ds_regra_w = '11') and (nr_protocolo_w IS NOT NULL AND nr_protocolo_w::text <> '') then 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_protocolo_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '9') and (ds_setor_atendimento_w IS NOT NULL AND ds_setor_atendimento_w::text <> '') then 
				if (coalesce(ie_caracter_ant_w::text, '') = '') then 
					ds_retorno_w := substr(ds_retorno_w || ' Setor: ' || ds_setor_atendimento_w,1,2000);
				else 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_setor_atendimento_w || ie_caracter_pos_w,1,2000);
				end if;
			elsif (ds_regra_w = '29') then 
				ds_procom_w := 'PROCON RJ - PROGRAMA DE ORIENTAÇÃO E PROTEÇÃO AO CONSUMIDOS Postos de Atendimento: -PROCON NITEROI - Rua Visconde de Sepeptiba, 519 - Térreo -Posto PROCON Rio Simples - Carioca - Rua da Ajuda, 05 - Subsolo -Posto PROCON Rio Simples - Central do Brasil, Pça Cristiano Ottoni, subsolo, s/nº- Ed. D. Pedro II Telefone: 151 www.procon.rj.gov.br <http://www.procon.rj.gov.br> COMISSÃO DE DEFESA DO CONSUMIDOR DA ASSEMBLEIA LEGISLATIVA DO ESTADO DO RIO DE JANEIRO - CODECON Rua da Alfândega, nº 8 - - Centro - Rio de Janeiro - RJ Telefone: 0800-2827060 ';
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_procom_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '13') and (nr_nota_fiscal_w IS NOT NULL AND nr_nota_fiscal_w::text <> '') then 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_nota_fiscal_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '28') and (vl_total_nota_w IS NOT NULL AND vl_total_nota_w::text <> '') then 
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || vl_total_nota_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '58') and (vl_descontos_w IS NOT NULL AND vl_descontos_w::text <> '') then 
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || campo_mascara_virgula(vl_descontos_w) || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '31') then 
				select	ds_texto_padrao 
				into STRICT	ds_texto_padrao_w 
				from	regra_descricao_rps 
				where	cd_estabelecimento	= cd_estabelecimento_p 
				and	((cd_convenio = cd_convenio_w) or (coalesce(cd_convenio::text, '') = '')) 
				and	((cd_cnpj = cd_cgc_w) or (coalesce(cd_cnpj::text, '') = '')) 
				and	((cd_operacao_nf = cd_operacao_nf_w) or ((coalesce(cd_operacao_nf::text, '') = '') and ((SELECT count(1) 
														from	regra_descricao_rps x 
														where	x.cd_estabelecimento	= cd_estabelecimento_p 
														and	((x.cd_convenio = cd_convenio_w) or (coalesce(x.cd_convenio::text, '') = '')) 
														and	((x.cd_cnpj = cd_cgc_w) or (coalesce(x.cd_cnpj::text, '') = '')) 
														and	cd_operacao_nf = cd_operacao_nf_w 
														) <= 0))) 
				and	ds_regra = 31 
				and 	coalesce(ie_situacao,'A') = 'A'  
				order by cd_convenio,nr_sequencia LIMIT 1;
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_texto_padrao_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '24') then 
				open C04;
				loop 
				fetch C04 into	 
					dt_vencimento_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin 
					if (dt_vencimento_w IS NOT NULL AND dt_vencimento_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || dt_vencimento_w || ie_caracter_pos_w,1,2000);
					end if;
					end;
				end loop;
				close C04;
			elsif (ds_regra_w = '54') then 
				select	max(d.nr_protocolo_ans) 
				into STRICT	nr_protocolo_ans_w 
				from	pls_segurado			e, 
					pls_plano			d, 
					pls_mensalidade_segurado	c, 
					pls_mensalidade			b, 
					nota_fiscal			a 
				where	a.nr_sequencia		= nr_seq_nota_p 
				and	a.nr_seq_mensalidade	= b.nr_sequencia 
				and	b.nr_sequencia		= c.nr_seq_mensalidade 
				and	e.nr_sequencia		= c.nr_seq_segurado 
				and	d.nr_sequencia		= e.nr_seq_plano;
				 
				if (nr_protocolo_ans_w IS NOT NULL AND nr_protocolo_ans_w::text <> '') then 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_protocolo_ans_w || ie_caracter_pos_w,1,2000);
				end if;
			elsif (ds_regra_w = '55') then 
				select	max(d.ds_plano) 
				into STRICT	ds_plano_w 
				from	pls_segurado			e, 
					pls_plano			d, 
					pls_mensalidade_segurado	c, 
					pls_mensalidade			b, 
					nota_fiscal			a 
				where	a.nr_sequencia		= nr_seq_nota_p 
				and	a.nr_seq_mensalidade	= b.nr_sequencia 
				and	b.nr_sequencia		= c.nr_seq_mensalidade 
				and	e.nr_sequencia		= c.nr_seq_segurado 
				and	d.nr_sequencia		= e.nr_seq_plano;
				 
				if (ds_plano_w IS NOT NULL AND ds_plano_w::text <> '') then 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_plano_w || ie_caracter_pos_w,1,2000);
				end if;
			elsif (ds_regra_w = '59') and (vl_total_tributos_w IS NOT NULL AND vl_total_tributos_w::text <> '') then 
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || campo_mascara_virgula(vl_total_tributos_w) || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '60') and (tx_total_tributos_w IS NOT NULL AND tx_total_tributos_w::text <> '') then 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || campo_mascara_virgula(tx_total_tributos_w) || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '61') and (ds_obs_prot_convenio_w IS NOT NULL AND ds_obs_prot_convenio_w::text <> '') then 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_obs_prot_convenio_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = 'I') then 
				open c03;
				loop 
				fetch c03 into 
					cd_item_w, 
					qt_item_w, 
					vl_item_w, 
					vl_total_item_nf_w, 
					vl_liquido_w, 
					ds_item_w, 
					ds_complemento_w, 
					vl_descontos_item_w;
				EXIT WHEN NOT FOUND; /* apply on c03 */
					begin 
					open c02;
					loop 
					fetch c02 into 
						ds_regra_w, 
						ie_ordem_w, 
						ie_caracter_ant_w, 
						ie_caracter_pos_w;
					EXIT WHEN NOT FOUND; /* apply on c02 */
						begin 
						if (ds_regra_w = '1') then 
							if (coalesce(ie_caracter_ant_w::text, '') = '') then 
								ds_retorno_w := substr(ds_retorno_w || ' Cód.: ' || cd_item_w,1,2000);
							else 
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || cd_item_w || ie_caracter_pos_w,1,2000);
							end if;
						elsif (ds_regra_w = '2') then 
							if (coalesce(ie_caracter_ant_w::text, '') = '') then 
								ds_retorno_w := substr(ds_retorno_w || ' ' || ds_item_w,1,2000);
							else 
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_item_w || ie_caracter_pos_w,1,2000);
							end if;
						elsif (ds_regra_w = '3') then 
							if (coalesce(ie_caracter_ant_w::text, '') = '') then 
								ds_retorno_w := substr(ds_retorno_w || ' Qtde.: ' || qt_item_w,1,2000);
							else 
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || qt_item_w || ie_caracter_pos_w,1,2000);
							end if;
						elsif (ds_regra_w = '14') then 
							if (coalesce(ie_caracter_ant_w::text, '') = '') then 
								ds_retorno_w := substr(ds_retorno_w || ' Vl.: ' || campo_mascara_virgula(vl_item_w),1,2000);
							else 
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || campo_mascara_virgula(vl_item_w) || ie_caracter_pos_w,1,2000);
							end if;
						elsif (ds_regra_w = '20') then 
							if (coalesce(ie_caracter_ant_w::text, '') = '') then 
								ds_retorno_w := substr(ds_retorno_w || ' Vl.: ' || campo_mascara_virgula(vl_total_item_nf_w),1,2000);
							else 
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || campo_mascara_virgula(vl_total_item_nf_w) || ie_caracter_pos_w,1,2000);
							end if;
						elsif (ds_regra_w = '30') then 
							if (coalesce(ie_caracter_ant_w::text, '') = '') then 
								ds_retorno_w := substr(ds_retorno_w || ' Vl.: ' || campo_mascara_virgula(vl_liquido_w),1,2000);
							else 
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || campo_mascara_virgula(vl_liquido_w) || ie_caracter_pos_w,1,2000);
							end if;
						elsif (ds_regra_w = '57') and (vl_descontos_item_w IS NOT NULL AND vl_descontos_item_w::text <> '') then 
							if (coalesce(ie_caracter_ant_w::text, '') = '') then 
								ds_retorno_w := substr(ds_retorno_w || ' Vl.: ' || campo_mascara_virgula(vl_descontos_item_w),1,2000);
							else 
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || campo_mascara_virgula(vl_descontos_item_w) || ie_caracter_pos_w,1,2000);
							end if;
						elsif (ds_regra_w = '12') then 
							ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_complemento_w || ie_caracter_pos_w,1,2000);
						end if;
						end;
					end loop;
					close c02;
					end;
				end loop;
				close c03;
			elsif (ds_regra_w in ('32','33','53')) then 
				open C05;
				loop 
				fetch C05 into	 
					vl_ato_principal_w, 
					vl_ato_auxiliar_w, 
					vl_ato_nao_coop_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					begin 
					if (ds_regra_w = '32') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ' ATO COOPERADO PRINCIPAL: ' || campo_mascara_virgula(vl_ato_principal_w) || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '33') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ' ATO COOPERADO AUXILIAR: ' || campo_mascara_virgula(vl_ato_auxiliar_w) || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '53') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ' ATO NÃO COOPERADO: ' || campo_mascara_virgula(vl_ato_nao_coop_w) || ie_caracter_pos_w,1,2000);
					end if;
					end;
				end loop;
				close C05;
			elsif (ds_regra_w in ('34','35','36','37','38','39','40','41', 
						'42','43','44','45','46','47','48','49','50','51','52','62','63','64')) then 
				open C06;
				loop 
				fetch C06 into 
					ds_tributo_pis_w, 
					vl_tributo_pis_w, 
					tx_tributo_pis_w, 
					ds_tributo_cofins_w, 
					vl_tributo_cofins_w, 
					tx_tributo_cofins_w, 
					ds_tributo_icms_w, 
					vl_tributo_icms_w, 
					tx_tributo_icms_w, 
					ds_tributo_iss_w, 
					vl_tributo_iss_w, 
					tx_tributo_iss_w, 
					ds_tributo_ir_w, 
					vl_tributo_ir_w, 
					tx_tributo_ir_w, 
					ds_tributo_inss_w, 
					vl_tributo_inss_w, 
					tx_tributo_inss_w, 
					vl_base_calculo_inss_w, 
					ds_tributo_csll_w, 
					vl_tributo_csll_w, 
					tx_tributo_csll_w;
				EXIT WHEN NOT FOUND; /* apply on C06 */
					begin 
					-- PIS 
					if (ds_regra_w = '34') and (ds_tributo_pis_w IS NOT NULL AND ds_tributo_pis_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_pis_w || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '35') and (vl_tributo_pis_w IS NOT NULL AND vl_tributo_pis_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(vl_tributo_pis_w) || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '36') and (tx_tributo_pis_w IS NOT NULL AND tx_tributo_pis_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(tx_tributo_pis_w) || ie_caracter_pos_w,1,2000);
					-- COFINS	 
					elsif (ds_regra_w = '37') and (ds_tributo_cofins_w IS NOT NULL AND ds_tributo_cofins_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_cofins_w || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '38') and (vl_tributo_cofins_w IS NOT NULL AND vl_tributo_cofins_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(vl_tributo_cofins_w) || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '39') and (tx_tributo_cofins_w IS NOT NULL AND tx_tributo_cofins_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(tx_tributo_cofins_w) || ie_caracter_pos_w,1,2000);
					-- ICMS	 
					elsif (ds_regra_w = '40') and (ds_tributo_icms_w IS NOT NULL AND ds_tributo_icms_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_icms_w || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '41') and (vl_tributo_icms_w IS NOT NULL AND vl_tributo_icms_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(vl_tributo_icms_w) || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '42') and (tx_tributo_icms_w IS NOT NULL AND tx_tributo_icms_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(tx_tributo_icms_w) || ie_caracter_pos_w,1,2000);
					-- ISS 
					elsif (ds_regra_w = '43') and (ds_tributo_iss_w IS NOT NULL AND ds_tributo_iss_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_iss_w || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '44') and (vl_tributo_iss_w IS NOT NULL AND vl_tributo_iss_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(vl_tributo_iss_w) || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '45') and (tx_tributo_iss_w IS NOT NULL AND tx_tributo_iss_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(tx_tributo_iss_w) || ie_caracter_pos_w,1,2000);
					-- IR	 
					elsif (ds_regra_w = '46') and (ds_tributo_ir_w IS NOT NULL AND ds_tributo_ir_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_ir_w || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '47') and (vl_tributo_ir_w IS NOT NULL AND vl_tributo_ir_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(vl_tributo_ir_w) || ie_caracter_pos_w,1,2000);	
					elsif (ds_regra_w = '48') and (tx_tributo_ir_w IS NOT NULL AND tx_tributo_ir_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(tx_tributo_ir_w) || ie_caracter_pos_w,1,2000);
					-- INSS 
					elsif (ds_regra_w = '49') and (ds_tributo_inss_w IS NOT NULL AND ds_tributo_inss_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_inss_w || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '50') and (vl_tributo_inss_w IS NOT NULL AND vl_tributo_inss_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(vl_tributo_inss_w) || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '51') and (tx_tributo_inss_w IS NOT NULL AND tx_tributo_inss_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(tx_tributo_inss_w) || ie_caracter_pos_w,1,2000);
					elsif (ds_regra_w = '52') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || Campo_Mascara_virgula(vl_base_calculo_inss_w) || ie_caracter_pos_w,1,2000);
					-- CSLL 
					elsif (ds_regra_w = '62') and (ds_tributo_csll_w IS NOT NULL AND ds_tributo_csll_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_csll_w || ie_caracter_pos_w ,1,2000);
					elsif (ds_regra_w = '63') and (vl_tributo_csll_w IS NOT NULL AND vl_tributo_csll_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || campo_mascara_virgula(vl_tributo_csll_w) || ie_caracter_pos_w ,1,2000);
					elsif (ds_regra_w = '64') and (tx_tributo_csll_w IS NOT NULL AND tx_tributo_csll_w::text <> '') then 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || campo_mascara_virgula(tx_tributo_csll_w) || ie_caracter_pos_w ,1,2000);
					end if;
					end;
				end loop;
				close C06;
			 
			elsif (ds_regra_w in ('65')) then 
				-- VL_SALDO_TIT_RECEBER 
				select	coalesce(sum(obter_saldo_titulo_receber(nr_titulo,trunc(clock_timestamp(),'dd'))),0) 
				into STRICT	vl_saldo_tit_receber_w 
				from	titulo_receber 
				where	nr_seq_nf_saida = nr_seq_nota_p;
				 
				if (coalesce(ie_saldo_tit_maior_zero_w,'N') = 'S') then 
					begin 
					 
					if (coalesce(vl_saldo_tit_receber_w,0) > 0) then 
						begin 
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || campo_mascara_virgula(vl_saldo_tit_receber_w) || ie_caracter_pos_w ,1,2000);
						end;
					end if;
					 
					end;
				else 
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || campo_mascara_virgula(vl_saldo_tit_receber_w) || ie_caracter_pos_w ,1,2000);
				end if;
				 
				 
				 
			end if;
			end;
		end loop;
		close c01;
		end;
	end if;
	 
	select	substr(nfe_elimina_caractere_especial(ds_retorno_w),1,2000) 
	into STRICT	ds_retorno_w 
	;
	end;
else 
	begin 
	select 	nfe_elimina_caractere_especial(CASE WHEN coalesce(nr_seq_protocolo::text, '') = '' THEN  		substr((select substr(obter_nome_pf(a.cd_pessoa_fisica),1,150) 		from	atendimento_paciente a, 			conta_paciente c 		where	a.nr_atendimento = c.nr_atendimento 		and	c.nr_interno_conta = n.nr_interno_conta) || '  ' || 		(select	substr(obter_dados_pf(a.cd_pessoa_fisica,'CPF'),1,11) 		from	atendimento_paciente a, 			conta_paciente c 		where	a.nr_atendimento = c.nr_atendimento 		and	c.nr_interno_conta = n.nr_interno_conta) || ' ' || 			substr(obter_select_concatenado( 'select decode(a.cd_material, null, 
				substr(obter_descricao_procedimento(a.cd_procedimento, ie_origem_proced),1,240), 
				substr(obter_desc_material(a.cd_material),1,100)) || chr(32) || b.ds_observacao 
				from nota_fiscal_item a, nota_fiscal b where a.nr_sequencia = b.nr_sequencia and a.nr_sequencia = '|| n.nr_sequencia,null,' '),1,1000) || '  ' || 		'Período de fechamento '|| 		(select	c.dt_periodo_inicial 		from	atendimento_paciente a, 			conta_paciente c 		where	a.nr_atendimento = c.nr_atendimento 		and	c.nr_interno_conta = n.nr_interno_conta) || 'a ' || 		(select	c.dt_periodo_final 		from	atendimento_paciente a, 			conta_paciente c 		where	a.nr_atendimento = c.nr_atendimento 		and	c.nr_interno_conta = n.nr_interno_conta),1,1000)  ELSE substr(obter_select_concatenado( 		'select decode(a.cd_material, null, 
	substr(obter_descricao_procedimento(a.cd_procedimento, ie_origem_proced),1,240), 
	substr(obter_desc_material(a.cd_material),1,100)) || chr(32) || b.ds_observacao 
		from nota_fiscal_item a, nota_fiscal b where a.nr_sequencia = b.nr_sequencia and a.nr_sequencia = ' || n.nr_sequencia,null,' '),1,1000) END ) ds_servicos 
	into STRICT	ds_retorno_w 
	from	nota_fiscal n 
	where	n.nr_sequencia = nr_seq_nota_p;
	end;
end if;
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_descricao_rps_danfe ( cd_estabelecimento_p bigint, nr_seq_nota_p bigint, ds_atributo_p text) FROM PUBLIC;

