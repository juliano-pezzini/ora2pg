-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_custo_mat_consignado ( nr_prescricao_p bigint, cd_material_p bigint, cd_cgc_fornecedor_p text, nr_atendimento_p bigint) RETURNS bigint AS $body$
DECLARE

 
vl_custo_w			double precision;
nr_ordem_compra_w		bigint;
qt_conversao_w			double precision;
dt_ult_ordem_compra_w		timestamp;
nr_atendimento_w		double precision;


BEGIN 
 
vl_custo_w			:= 0;
begin 
	 
 
if (obter_valor_param_usuario(927, 71, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento)='S') then 
	 
	select	coalesce(max(dt_ordem_compra),clock_timestamp()),max(a.nr_ordem_compra) 
	into STRICT	dt_ult_ordem_compra_w,nr_ordem_compra_w 
	from	Ordem_Compra a 
	where	((a.nr_atendimento =nr_atendimento_p) or (nr_atendimento_p =nr_atendimento_p))	 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')   
	and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
	and	exists (SELECT 1 
		from	ordem_compra_item b 
		where	a.nr_ordem_compra	= b.nr_ordem_compra 
		and	b.cd_material		= cd_material_p);
	 
	 
 
else 
	 
	select	coalesce(max(a.nr_ordem_compra),0) 
	into STRICT	nr_ordem_compra_w 
	from	Ordem_Compra a 
	where	a.nr_prescricao		= nr_prescricao_p 
	and	a.cd_cgc_fornecedor	= cd_cgc_fornecedor_p 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
	and	exists (SELECT 1 
		from	ordem_compra_item b 
		where	a.nr_ordem_compra	= b.nr_ordem_compra 
		and	b.cd_material		= cd_material_p);
end if;
 
 
select	dividir(sum(vl_item_Liquido), sum(qt_material)) 
into STRICT	vl_custo_w 
from	ordem_compra_item 
where	nr_ordem_compra	= nr_ordem_compra_w 
 and	cd_material		= cd_material_p;
exception 
	when others then 
		vl_custo_w	:= 0;	
end;
 
select	coalesce(qt_conv_estoque_consumo,1) * coalesce(qt_conv_compra_estoque,1) 
into STRICT	qt_conversao_w 
from	material 
where	cd_material		= cd_material_p;
 
vl_custo_w			:= dividir(vl_custo_w, qt_conversao_w);
 
 
return vl_custo_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_custo_mat_consignado ( nr_prescricao_p bigint, cd_material_p bigint, cd_cgc_fornecedor_p text, nr_atendimento_p bigint) FROM PUBLIC;

