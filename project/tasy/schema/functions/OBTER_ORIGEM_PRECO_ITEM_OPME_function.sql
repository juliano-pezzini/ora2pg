-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_origem_preco_item_opme (nr_sequencia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

			 
cd_material_w		bigint;
cd_convenio_w		integer;
cd_categoria_w		varchar(10);		
vl_retorno_w		integer;	
ds_retorno_w		varchar(255);
qt_material_w		double precision;
ie_tipo_atendimento_w	smallint;
ie_achou_w		varchar(1) := 'N';
dt_vigencia_w		timestamp;

/* P - Origem pre√ßo*/
 
 
c01 CURSOR FOR 
	SELECT	cd_categoria 
	from	categoria_convenio a 
	where	a.cd_convenio	= cd_convenio_w 
	and 	Obter_Se_Categoria_Lib_Estab(wheb_usuario_pck.get_cd_estabelecimento, a.cd_convenio, a.cd_categoria) = 'S' 
	and	a.ie_situacao	= 'A' 
	and	exists (SELECT	1 
		from	convenio_amb x 
		where	x.cd_convenio		= a.cd_convenio 
		and	x.cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento 
		and	x.cd_categoria		= a.cd_categoria 
		
union 	all
 
		select	1 
		from	convenio_preco_mat x 
		where	x.cd_convenio		= a.cd_convenio 
		and	x.cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento 
		and	x.cd_categoria		= a.cd_categoria 
		
union 	all
 
		select	1 
		from	convenio_servico x 
		where	x.cd_convenio		= a.cd_convenio 
		and	x.cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento 
		and	x.cd_categoria		= a.cd_categoria 
		
union  all
 
		select	1 
		from	categoria_convenio x 
		where	x.cd_convenio		= a.cd_convenio 
		and	x.cd_categoria		= a.cd_categoria 
		and	x.IE_PRECO_CUSTO	= 'S') 
	order by cd_categoria desc;

BEGIN
 
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then 
	begin 
	 
	select	max(a.cd_material), 
		max(b.cd_convenio), 
		max(b.cd_categoria), 
		max(a.qt_material), 
		max(b.ie_tipo_atendimento) 
	into STRICT	cd_material_w, 
		cd_convenio_w, 
		cd_categoria_w, 
		qt_material_w, 
		ie_tipo_atendimento_w 
	from  agenda_pac_opme a, 
		agenda_paciente b 
	where  a.nr_seq_agenda = b.nr_sequencia 
	and	a.nr_sequencia = nr_sequencia_p;
 
	if (coalesce(cd_categoria_w::text, '') = '') then 
		/* 
		select	max(cd_categoria) 
		into	cd_categoria_w 
		from	categoria_convenio 
		where	cd_convenio = cd_convenio_w 
		and	nvl(ie_situacao,'A') = 'A';	 
		*/
 
		ie_achou_w := 'N';
		open c01;
		loop 
		fetch c01 into 
			cd_categoria_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin 
			if (ie_achou_w = 'N') then 
				if (ie_opcao_p = 'OP') then 
					select 	max(Obter_Origem_Preco_Material(wheb_usuario_pck.get_cd_estabelecimento,cd_convenio_w,cd_categoria_w,clock_timestamp(),cd_material_w,0,ie_tipo_atendimento_w,0,null,0,0,'OP')) 
					into STRICT	vl_retorno_w 
					;
					 
					select substr(obter_valor_dominio(61,vl_retorno_w),1,200) 
					into STRICT	ds_retorno_w	 
					;	
				end if;
				 
				if (ie_opcao_p = 'TP') then 
					select 	max(Obter_Origem_Preco_Material(wheb_usuario_pck.get_cd_estabelecimento,cd_convenio_w,cd_categoria_w,clock_timestamp(),cd_material_w,0,ie_tipo_atendimento_w,0,null,0,0,'TP')) 
					into STRICT	vl_retorno_w 
					;
					 
					select substr(OBTER_DESC_TABELA_PRECO(wheb_usuario_pck.get_cd_estabelecimento,vl_retorno_w),1,200) 
					into STRICT	ds_retorno_w	 
					;	
				end if;
				 
				if (ie_opcao_p = 'DV') then 
					select max(Obter_dt_vigencia_Material(wheb_usuario_pck.get_cd_estabelecimento,cd_convenio_w,cd_categoria_w,clock_timestamp(),cd_material_w,0,ie_tipo_atendimento_w,0,null,0,0,'DV')) 
					into STRICT  dt_vigencia_w 
					;
				 
					select to_char(dt_vigencia_w, 'dd/mm/yyyy') 
					into STRICT	ds_retorno_w 
					;
					 
				end if;
			 
				if (coalesce(vl_retorno_w,0) > 0) then 
					ie_achou_w := 'S';
				end if;	
			end if;	
			end;
		end loop;
		close c01;	
	else 
		if (ie_opcao_p = 'OP') then 
			select 	max(Obter_Origem_Preco_Material(wheb_usuario_pck.get_cd_estabelecimento,cd_convenio_w,cd_categoria_w,clock_timestamp(),cd_material_w,0,ie_tipo_atendimento_w,0,null,0,0,'OP')) 
			into STRICT	vl_retorno_w 
			;
					 
			select substr(obter_valor_dominio(61,vl_retorno_w),1,200) 
			into STRICT	ds_retorno_w	 
			;
			 
		end if;
		 
		if (ie_opcao_p = 'TP') then 
			select 	max(Obter_Origem_Preco_Material(wheb_usuario_pck.get_cd_estabelecimento,cd_convenio_w,cd_categoria_w,clock_timestamp(),cd_material_w,0,ie_tipo_atendimento_w,0,null,0,0,'TP')) 
			into STRICT	vl_retorno_w 
			;
					 
			select substr(OBTER_DESC_TABELA_PRECO(wheb_usuario_pck.get_cd_estabelecimento,vl_retorno_w),1,200) 
			into STRICT	ds_retorno_w	 
			;	
		end if;
		 
		if (ie_opcao_p = 'DV') then 
			select max(Obter_dt_vigencia_Material(wheb_usuario_pck.get_cd_estabelecimento,cd_convenio_w,cd_categoria_w,clock_timestamp(),cd_material_w,0,ie_tipo_atendimento_w,0,null,0,0,'DV')) 
			into STRICT  dt_vigencia_w 
			;
				 
			select to_char(dt_vigencia_w, 'dd/mm/yyyy') 
			into STRICT	ds_retorno_w 
			;
					 
		end if;
	 
	end if;	
	end;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_origem_preco_item_opme (nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

