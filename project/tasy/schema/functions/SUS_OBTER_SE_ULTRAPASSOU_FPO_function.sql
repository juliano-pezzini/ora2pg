-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_se_ultrapassou_fpo (nr_seq_regra_p bigint) RETURNS varchar AS $body$
DECLARE


vl_orcamento_w		double precision := 0;
qt_fisico_w		bigint := 0;
qt_procedimento_w		bigint;
vl_procedimento_w		double precision;
cd_estabelecimento_w	smallint;
dt_competencia_w		timestamp;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
nr_seq_grupo_w		bigint;
nr_seq_subgrupo_w	bigint;
nr_seq_forma_org_w	bigint;
ie_tipo_atendimento_w	varchar(20);
ie_tipo_financiamento_w	varchar(4);
ie_complexidade_w		varchar(2);
cd_cbo_w		varchar(6);
cd_convenio_sus_w	integer;
cd_carater_internacao_w	varchar(2);
qt_fisico_exet_w		bigint := 0;
vl_orcamento_exet_w	double precision := 0;
ds_retorno_w		varchar(15) := 'N';
cd_procedencia_w	varchar(20);


BEGIN

select	cd_estabelecimento,
	dt_competencia,
	cd_cbo,
	cd_procedimento,
	coalesce(ie_origem_proced,7),
	ie_complexidade,
	ie_tipo_atendimento,
	ie_tipo_financiamento,
	nr_seq_forma_org,
	nr_seq_grupo,
	nr_seq_subgrupo,
	cd_carater_internacao,
	vl_orcamento,
	qt_fisico,
	cd_procedencia
into STRICT	cd_estabelecimento_w,
	dt_competencia_w,
	cd_cbo_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	ie_complexidade_w,
	ie_tipo_atendimento_w,
	ie_tipo_financiamento_w,
	nr_seq_forma_org_w,
	nr_seq_grupo_w,
	nr_seq_subgrupo_w,
	cd_carater_internacao_w,
	vl_orcamento_w,
	qt_fisico_w,
	cd_procedencia_w
from	sus_fpo_regra
where	nr_sequencia = nr_seq_regra_p;

select	max(cd_convenio_sus)
into STRICT	cd_convenio_sus_w
from	parametro_faturamento
where	cd_estabelecimento = cd_estabelecimento_w;

begin
select	coalesce(sum(a.qt_procedimento),0),
	coalesce(sum(a.vl_procedimento),0)
into STRICT	qt_procedimento_w,
	vl_procedimento_w
FROM sus_estrutura_procedimento_v d, atendimento_paciente c, procedimento_paciente a, conta_paciente b
LEFT OUTER JOIN sus_aih_unif e ON (b.nr_interno_conta = e.nr_interno_conta)
WHERE a.nr_interno_conta 		= b.nr_interno_conta and b.nr_atendimento 		= c.nr_atendimento and a.cd_procedimento		= d.cd_procedimento and coalesce(a.ie_origem_proced,7)	= d.ie_origem_proced and b.cd_estabelecimento	= coalesce(cd_estabelecimento_w,b.cd_estabelecimento) and trunc(a.dt_procedimento,'month') = trunc(dt_competencia_w,'month') and (exists (SELECT	1
		from 	sus_fpo_regra_proc w
		where	w.nr_seq_regra	= nr_seq_regra_p
		and	w.cd_procedimento	= a.cd_procedimento
		and	w.ie_origem_proced	= a.ie_origem_proced
		and	w.ie_situacao 	= 'A') or (a.cd_procedimento		= coalesce(cd_procedimento_w,a.cd_procedimento) and
	a.ie_origem_proced		= coalesce(ie_origem_proced_w,a.ie_origem_proced))) and (not exists (select	1
		from 	sus_fpo_regra_setor y
		where	y.nr_seq_regra	= nr_seq_regra_p
		and	y.ie_situacao 	= 'A')	or
	exists (select	1
		from	sus_fpo_regra_setor q
		where	q.nr_seq_regra	= nr_seq_regra_p
		and	q.ie_situacao	= 'A'
		and	q.cd_setor_atendimento	= a.cd_setor_atendimento)) and d.ie_complexidade		= coalesce(ie_complexidade_w,d.ie_complexidade) and obter_se_contido(c.ie_tipo_atendimento,coalesce(ie_tipo_atendimento_w,c.ie_tipo_atendimento)) = 'S' and obter_se_contido(c.cd_procedencia,coalesce(cd_procedencia_w,c.cd_procedencia)) = 'S'  and (e.ie_tipo_financiamento = coalesce(ie_tipo_financiamento_w,e.ie_tipo_financiamento) or (coalesce(e.ie_tipo_financiamento::text, '') = '' and d.ie_tipo_financiamento = coalesce(ie_tipo_financiamento_w,d.ie_tipo_financiamento))) and d.nr_seq_forma_org		= coalesce(nr_seq_forma_org_w,d.nr_seq_forma_org) and d.nr_seq_grupo		= coalesce(nr_seq_grupo_w,d.nr_seq_grupo) and d.nr_seq_subgrupo		= coalesce(nr_seq_subgrupo_w,d.nr_seq_subgrupo) and (exists (select	1
		from	sus_fpo_regra_cbo z
		where	z.cd_cbo		= coalesce(a.cd_cbo,'0')
		and	z.nr_seq_fpo_regra	= nr_seq_regra_p) or
	coalesce(a.cd_cbo,'0') 			= coalesce(cd_cbo_w,coalesce(a.cd_cbo,'0'))) and (((coalesce(cd_carater_internacao_w,'X') <> 'X')  and ((	select	count(*)
								from	sus_aih_unif s
								where	s.nr_interno_conta 	= b.nr_interno_conta
								and	s.cd_carater_internacao	= cd_carater_internacao_w) > 0)) or (coalesce(cd_carater_internacao_w,'X') = 'X')) and not exists (	select	1
			from	sus_fpo_regra_desconsid x
			where	x.nr_seq_fpo_regra	= nr_seq_regra_p
			and	coalesce(a.cd_cbo,'0')	= coalesce(x.cd_cbo,coalesce(a.cd_cbo,'0'))
			and	a.cd_procedimento	= coalesce(x.cd_procedimento,a.cd_procedimento)
			and	a.ie_origem_proced	= coalesce(x.ie_origem_proced,a.ie_origem_proced)
			and	d.nr_seq_forma_org	= coalesce(x.nr_seq_forma_org,d.nr_seq_forma_org)
			and	d.nr_seq_grupo	= coalesce(x.nr_seq_grupo,d.nr_seq_grupo)
			and	d.nr_seq_subgrupo	= coalesce(x.nr_seq_subgrupo,d.nr_seq_subgrupo)) and coalesce(a.cd_motivo_exc_conta::text, '') = '' and b.cd_convenio_parametro	= cd_convenio_sus_w;
exception
	when others then
	qt_procedimento_w	:= 0;
	vl_procedimento_w	:= 0;
end;

begin
select	coalesce(sum(qt_fisico_prot),0),
	coalesce(sum(vl_orcamento_prot),0)
into STRICT	qt_fisico_exet_w,
	vl_orcamento_exet_w
from	sus_fpo_regra_externo
where 	nr_seq_fpo_regra = nr_seq_regra_p;
exception
	when others then
	qt_fisico_exet_w		:= 0;
	vl_orcamento_exet_w	:= 0;
	end;

if	((qt_fisico_w IS NOT NULL AND qt_fisico_w::text <> '') and
	((qt_fisico_w - (qt_procedimento_w + qt_fisico_exet_w)) < 0)) or
	((vl_orcamento_w IS NOT NULL AND vl_orcamento_w::text <> '') and
	((vl_orcamento_w - (vl_procedimento_w + vl_orcamento_exet_w)) < 0)) then
	begin
	ds_retorno_w := 'S';
	end;
end if;

return	coalesce(ds_retorno_w,'N');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_se_ultrapassou_fpo (nr_seq_regra_p bigint) FROM PUBLIC;

