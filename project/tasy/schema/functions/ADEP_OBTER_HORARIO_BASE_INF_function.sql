-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION adep_obter_horario_base_inf ( ie_tipo_item_p text, cd_item_p text, nr_seq_proc_interno_p bigint, cd_intervalo_p text, qt_item_p bigint, nr_prescricoes_p text) RETURNS bigint AS $body$
DECLARE


ds_sql_w		varchar(255);
nr_prescricao_base_w	bigint;
nr_seq_hor_base_w	bigint := 0;
dt_fim_w		varchar(19);
dt_inicio_w		varchar(19);
cd_item_w		varchar(255);


BEGIN

if (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (cd_item_p IS NOT NULL AND cd_item_p::text <> '') and (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') then
	begin
	if (ie_tipo_item_p <> 'E') then
		begin
		ds_sql_w	:= 'select max(nr_prescricao) from prescr_medica where nr_prescricao in :nr_prescricoes_p';

		nr_prescricao_base_w := obter_valor_dinamico_in_bv(ds_sql_w, '', ':nr_prescricoes_p', nr_prescricoes_p, ',', nr_prescricao_base_w);

		if (coalesce(nr_prescricao_base_w,0) > 0) then
			begin
			if (ie_tipo_item_p = 'DI') then
				begin
				select	coalesce(min(c.nr_sequencia),0)
				into STRICT	nr_seq_hor_base_w
				from	hd_prescricao b,
						prescr_solucao x,
						prescr_medica a,
						prescr_material y,
						prescr_mat_hor c
				where	x.nr_prescricao = a.nr_prescricao
				and     b.nr_sequencia  = x.nr_seq_dialise
				and		x.nr_prescricao = y.nr_prescricao
				and		x.nr_seq_solucao = y.nr_sequencia_solucao
				and		y.nr_prescricao = c.nr_prescricao
				and		y.nr_sequencia = c.nr_seq_material
				and     b.ie_tipo_dialise in ('H','P')
				and		x.nr_seq_dialise = cd_item_p
				and		y.ie_agrupador		= 13
				and		coalesce(c.ie_adep,'S')		= 'S'
				and		coalesce(c.ie_situacao,'A')	= 'A'
				and		coalesce(c.dt_fim_horario::text, '') = ''
				and		a.nr_prescricao			= nr_prescricao_base_w
				and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S';
				end;
			elsif (ie_tipo_item_p = 'S') then
				begin
				select	coalesce(min(a.nr_sequencia),0)
				into STRICT	nr_seq_hor_base_w
				from	prescr_mat_hor a,
					prescr_material b
				where	a.nr_prescricao			= b.nr_prescricao
				and	a.nr_seq_material		= b.nr_sequencia
				and	a.ie_horario_especial		= 'S'
				and	coalesce(a.ie_adep,'S')		= 'S'
				and	coalesce(a.ie_situacao,'A')		= 'A'
				and	coalesce(a.dt_fim_horario::text, '') = ''
				and	b.nr_prescricao			= nr_prescricao_base_w
				and	b.cd_material			= cd_item_p
				and	coalesce(b.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
				and	coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
				and	b.ie_agrupador			= 12
				and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
				end;
			elsif (ie_tipo_item_p in ('M', 'IAH')) then
				begin
				select	coalesce(min(a.nr_sequencia),0)
				into STRICT	nr_seq_hor_base_w
				from	prescr_mat_hor a,
					prescr_material b
				where	a.nr_prescricao			= b.nr_prescricao
				and	a.nr_seq_material		= b.nr_sequencia
				and	a.ie_horario_especial		= 'S'
				and	coalesce(a.ie_adep,'S')		= 'S'
				and	coalesce(a.ie_situacao,'A')		= 'A'
				and	coalesce(a.dt_fim_horario::text, '') = ''
				and	b.nr_prescricao			= nr_prescricao_base_w
				and	b.cd_material			= cd_item_p
				and	coalesce(b.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
				and	coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
				and	b.ie_agrupador			= 1
				and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
				end;
			elsif (ie_tipo_item_p = 'P') then
				begin
				select	coalesce(min(a.nr_sequencia),0)
				into STRICT	nr_seq_hor_base_w
				from	prescr_proc_hor a,
					prescr_procedimento b
				where	a.nr_prescricao					= b.nr_prescricao
				and	a.nr_seq_procedimento				= b.nr_sequencia
				and	a.ie_horario_especial				= 'S'
				and	coalesce(a.ie_situacao,'A')				= 'A'
				and	coalesce(a.dt_fim_horario::text, '') = ''
				and	b.nr_prescricao					= nr_prescricao_base_w
				and	b.cd_procedimento				= cd_item_p
				and	coalesce(b.nr_seq_proc_interno,0)			= coalesce(nr_seq_proc_interno_p,0)
				and	coalesce(b.cd_intervalo,'XPTO')			= coalesce(cd_intervalo_p,'XPTO')
				and	coalesce(b.qt_procedimento,1)			= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
				and	coalesce(b.nr_seq_exame::text, '') = ''
				and	obter_ctrl_glic_proc(b.nr_seq_proc_interno)	= 'NC'
				and	obter_se_proc_ivc(b.nr_seq_proc_interno)	= 'N'
				and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
				end;
			elsif (ie_tipo_item_p = 'L') then
				begin
				select	coalesce(min(a.nr_sequencia),0)
				into STRICT	nr_seq_hor_base_w
				from	prescr_proc_hor a,
					prescr_procedimento b
				where	a.nr_prescricao					= b.nr_prescricao
				and	a.nr_seq_procedimento				= b.nr_sequencia
				and	a.ie_horario_especial				= 'S'
				and	coalesce(a.ie_situacao,'A')				= 'A'
				and	coalesce(a.dt_fim_horario::text, '') = ''
				and	b.nr_prescricao					= nr_prescricao_base_w
				and	b.cd_procedimento				= cd_item_p
				and	coalesce(b.nr_seq_proc_interno,0)			= coalesce(nr_seq_proc_interno_p,0)
				and	coalesce(b.cd_intervalo,'XPTO')			= coalesce(cd_intervalo_p,'XPTO')
				and	coalesce(b.qt_procedimento,1)			= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
				and	(b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '')
				and	obter_ctrl_glic_proc(b.nr_seq_proc_interno)	= 'NC'
				and	obter_se_proc_ivc(b.nr_seq_proc_interno)	= 'N'
				and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
				end;
			elsif (ie_tipo_item_p = 'R') then
				begin

				select	coalesce(min(a.nr_sequencia),0)
				into STRICT	nr_seq_hor_base_w
				from	prescr_rec_hor a,
					prescr_recomendacao b
				where	a.nr_prescricao						= b.nr_prescricao
				and	a.nr_seq_recomendacao					= b.nr_sequencia
				and	a.ie_horario_especial					= 'S'
				and	coalesce(a.ie_situacao,'A')					= 'A'
				and	coalesce(a.dt_fim_horario::text, '') = ''
				and	b.nr_prescricao						= nr_prescricao_base_w
				and	coalesce(to_char(b.cd_recomendacao),b.ds_recomendacao)	= cd_item_p
				and	coalesce(b.cd_intervalo,'XPTO')				= coalesce(cd_intervalo_p,'XPTO')
				and	coalesce(b.qt_recomendacao,0)				= coalesce(qt_item_p,coalesce(b.qt_recomendacao,0))
				and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
				end;
			elsif (ie_tipo_item_p = 'MAT') then
				begin
				select	coalesce(min(a.nr_sequencia),0)
				into STRICT	nr_seq_hor_base_w
				from	prescr_mat_hor a,
					prescr_material b
				where	a.nr_prescricao			= b.nr_prescricao
				and	a.nr_seq_material		= b.nr_sequencia
				and	a.ie_horario_especial		= 'S'
				and	coalesce(a.ie_adep,'S')		= 'S'
				and	coalesce(a.ie_situacao,'A')		= 'A'
				and	coalesce(a.dt_fim_horario::text, '') = ''
				and	b.nr_prescricao			= nr_prescricao_base_w
				and	b.cd_material			= cd_item_p
				and	coalesce(b.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
				and	coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
				and	b.ie_agrupador			= 2
				and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
				end;
			elsif (ie_tipo_item_p = 'D') then
				begin
				select	coalesce(min(a.nr_sequencia),0)
				into STRICT	nr_seq_hor_base_w
				from	prescr_dieta_hor a,
					prescr_dieta b
				where	a.nr_prescricao	= b.nr_prescricao
				and	b.nr_sequencia = a.nr_seq_dieta
				and	b.nr_prescricao	= nr_prescricao_base_w
				and	(((to_char(b.cd_dieta) = cd_item_p) and (coalesce(a.cd_refeicao::text, '') = '')) or
					  (a.cd_refeicao IS NOT NULL AND a.cd_refeicao::text <> '' AND a.cd_refeicao	= cd_item_p))
				and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
				end;
			elsif (ie_tipo_item_p = 'J') then
				begin

				cd_item_w       :=  replace(cd_item_p,'J','');
				dt_inicio_w 	:= substr(cd_item_w, 1, position('-' in cd_item_w) - 1);
				dt_fim_w		:= substr(cd_item_w, position('-' in cd_item_w) +1, 19);

				if (dt_fim_w IS NOT NULL AND dt_fim_w::text <> '') and (dt_inicio_w IS NOT NULL AND dt_inicio_w::text <> '') then

					select	coalesce(max(a.nr_sequencia),0)
					into STRICT	nr_seq_hor_base_w
					from	rep_jejum a
					where	obter_se_contido(nr_prescricoes_p, nr_prescricoes_p) = 'S'
					and	((to_char(a.dt_inicio, 'dd/mm/yyyy hh24:mi:ss') = dt_inicio_w) and (to_char(a.dt_fim, 'dd/mm/yyyy hh24:mi:ss') = dt_fim_w));
				end if;
				end;
			end if;
			end;
		end if;
		end;
	else
		begin
		ds_sql_w	:= 'select max(nr_sequencia) from pe_prescricao where nr_sequencia in :nr_prescricoes_p';

		nr_prescricao_base_w := obter_valor_dinamico_in_bv(ds_sql_w, '', ':nr_prescricoes_p', nr_prescricoes_p, ',', nr_prescricao_base_w);

		if (coalesce(nr_prescricao_base_w,0) > 0) then
			begin
			select	coalesce(min(a.nr_sequencia),0)
			into STRICT	nr_seq_hor_base_w
			from	pe_prescr_proc_hor a,
				pe_prescr_proc b
			where	a.nr_seq_pe_prescr		= b.nr_seq_prescr
			and	a.nr_seq_pe_proc		= b.nr_sequencia
			and	ie_horario_especial		= 'S'
			and	coalesce(a.ie_situacao,'A')		= 'A'
			and	coalesce(a.dt_fim_horario::text, '') = ''
			and	b.nr_seq_prescr			= nr_prescricao_base_w
			and	b.nr_seq_proc			= cd_item_p
			and	coalesce(b.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO');
			end;
		end if;
		end;
	end if;
	end;
end if;
return nr_seq_hor_base_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION adep_obter_horario_base_inf ( ie_tipo_item_p text, cd_item_p text, nr_seq_proc_interno_p bigint, cd_intervalo_p text, qt_item_p bigint, nr_prescricoes_p text) FROM PUBLIC;

