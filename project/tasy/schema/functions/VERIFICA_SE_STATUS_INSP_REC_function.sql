-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION verifica_se_status_insp_rec ( nr_seq_inspecao_p bigint, ie_status_p text) RETURNS varchar AS $body$
DECLARE

 
/* 
Verifica se a inspeção está no status passado como parâmetro 
Usado na ativação do DBPanel de registro de inspeções, no HTML 
*/
 
 
ie_retorno_w		varchar(1)	:= 'N';
qt_existe_w			smallint;


BEGIN 
 
select	count(*) 
into STRICT	qt_existe_w 
from	inspecao_registro 
where	nr_sequencia = nr_seq_inspecao_p 
and	( 
	((ie_status_p = 'L') and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') and (substr(obter_se_itens_nf_devol_total(nr_sequencia,nr_seq_nf),1,2) not in ('P','T')) and (coalesce(obter_dados_nota_fiscal(nr_seq_nf, 27)::text, '') = '')) 
or	 
	((ie_status_p = 'NL') and (coalesce(dt_liberacao::text, '') = '') and (substr(obter_se_itens_nf_devol_total(nr_sequencia,nr_seq_nf),1,2) not in ('P','T')) and (coalesce(obter_dados_nota_fiscal(nr_seq_nf, 27)::text, '') = '')) 
or 
	((ie_status_p = 'NF') and ((obter_dados_nota_fiscal(nr_seq_nf, 27) IS NOT NULL AND (obter_dados_nota_fiscal(nr_seq_nf, 27))::text <> '')) and (substr(obter_se_itens_nf_devol_total(nr_sequencia,nr_seq_nf),1,2) not in ('P','T'))) 
or 
	((ie_status_p = 'P') and 
	(substr(obter_se_itens_nf_devol_total(nr_sequencia,nr_seq_nf),1,2) = ('P'))) 
or 
	((ie_status_p = 'T') and 
	(substr(obter_se_itens_nf_devol_total(nr_sequencia,nr_seq_nf),1,2) = ('T'))) 
or	 
	(ie_status_p = 'D' AND dt_devolucao IS NOT NULL AND dt_devolucao::text <> ''));
	 
if (qt_existe_w <> 0) then 
	ie_retorno_w	:= 'S';
end if;
 
return	ie_retorno_w;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION verifica_se_status_insp_rec ( nr_seq_inspecao_p bigint, ie_status_p text) FROM PUBLIC;

