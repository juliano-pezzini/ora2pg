-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_copia_hora_sae ( nr_seq_prescr_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


ie_copiar_w			varchar(1) := 'S';
hr_prim_horario_w  	varchar(5);
cd_intervalo_w	 	varchar(7);
qt_operacao_w  		intervalo_prescricao.qt_operacao%type;
ie_operacao_w 		varchar(1);
qt_dif_w			bigint;
nr_hora_w			bigint;
dt_prescricao_w		timestamp;
dt_intervalo_w		timestamp;
dt_validade_w		timestamp;



BEGIN

Select  max(hr_prim_horario),
		max(cd_intervalo)
into STRICT	hr_prim_horario_w,
		cd_intervalo_w
from	pe_prescr_proc
where	nr_seq_prescr	= nr_seq_prescr_p
and		nr_sequencia 	= nr_sequencia_p;

Select 	max(dt_prescricao)
into STRICT	dt_prescricao_w
from	PE_PRESCRICAO
where	nr_sequencia = nr_seq_prescr_p;


if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then

	select 	max(ie_operacao),
			max(qt_operacao)
	into STRICT	ie_operacao_w,
			qt_operacao_w
	from 	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_w;

	if (coalesce(ie_operacao_w,'X') = 'H') and (coalesce(qt_operacao_w,0) > 24)then

		nr_hora_w	:= (to_char(to_date(hr_prim_horario_w,'hh24:mi'),'hh24'))::numeric;

		dt_intervalo_w :=  to_date(to_char(dt_prescricao_w,'dd/mm/yyyy') ||' ' ||to_char(to_date(hr_prim_horario_w,'hh24:mi'),'hh24')||':00:00','dd/mm/yyyy hh24:mi:ss');

		dt_validade_w :=  dt_intervalo_w + (qt_operacao_w/24);

		if ( clock_timestamp() < dt_validade_w) then

			ie_copiar_w := 'N';

		end if;


	end if;

end if;


return	ie_copiar_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_copia_hora_sae ( nr_seq_prescr_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

