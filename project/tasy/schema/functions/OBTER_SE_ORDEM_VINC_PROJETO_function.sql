-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_ordem_vinc_projeto ( nr_sequencia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*
1 - Ordens vinculadas ao projeto (proj_ordem_servico - execução do cronograma)
2 - Ordens que geraram o projeto (vinculada à proj_projeto)
3 - Verificar se a ordem esta vinculado a um projeto de desenvolvimento. Originou o projeto / Cliente adicional / Vinculada ao projeto / Vinculada a etapa
4 - Verificar se a ordem esta vinculado a um projeto de desenvolvimento Capitalizável. Originou o projeto / Cliente adicional / Vinculada ao projeto / Vinculada a etapa
5 - Verificar se a ordem esta vinculado a um projeto Capitalizável (Desenvolvimento, Implantação, ... Originou o projeto / Cliente adicional / Vinculada ao projeto / Vinculada a etapa
*/
ds_retorno_w		varchar(01) := 'N';
ie_adicional_w		varchar(01);


BEGIN

if (ie_opcao_p = '1') then
	begin
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ds_retorno_w
	from	proj_projeto a
	where	a.nr_seq_ordem_serv = nr_sequencia_p
	and	a.ie_origem	= 'D';

	if (ds_retorno_w = 'N') then
			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ds_retorno_w
			from	proj_projeto a,
				proj_ordem_servico b
			where	b.nr_seq_ordem 	= nr_sequencia_p
			and	a.nr_sequencia	= b.nr_seq_proj
			and	a.ie_origem	= 'D';
	end if;
	end;
elsif (ie_opcao_p = '2') then
	begin

	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_adicional_w
	from	proj_projeto_cliente_adic
	where	NR_SEQ_ORDEM_SERV 	= nr_sequencia_p;

	if (ie_adicional_w = 'N') then
		begin

		select  CASE WHEN sum(qt_soma)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ds_retorno_w
		from (SELECT count(*) qt_soma
			from    proj_projeto
			where   nr_seq_ordem_serv 	= nr_sequencia_p
			
union

			SELECT  count(*)
			from    proj_projeto a, proj_ordem_servico b
			where   b.nr_seq_ordem 		= nr_sequencia_p
			and	a.nr_sequencia		= b.nr_seq_proj
			and	a.ie_origem		= 'D') alias4;
		end;
	else
		ds_retorno_w	:= 'S';
	end if;
	end;

elsif (ie_opcao_p = '3') then
	begin

	select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ds_retorno_w
	from	proj_projeto d,
		proj_cronograma c,
		proj_cron_etapa b,
		man_ordem_servico a
	where	a.nr_sequencia			= nr_sequencia_p
	and	a.nr_seq_proj_cron_etapa	= b.nr_sequencia
	and	b.nr_seq_cronograma		= c.nr_sequencia
	and	c.nr_seq_proj			= d.nr_sequencia
	and	d.ie_origem			= 'D';

	if (ds_retorno_w = 'N') then

		select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ds_retorno_w
		from	proj_projeto a,
			proj_ordem_servico b
		where	b.nr_seq_ordem 	= nr_sequencia_p
		and	a.nr_sequencia	= b.nr_seq_proj
		and	a.ie_origem	= 'D';

		if (ds_retorno_w = 'N') then

			select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ds_retorno_w
			from	proj_projeto a
			where	a.nr_seq_ordem_serv	= nr_sequencia_p
			and	a.ie_origem		= 'D';

			if (ds_retorno_w = 'N') then

				select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ds_retorno_w
				from	proj_projeto b,
					proj_projeto_cliente_adic a
				where	a.nr_seq_projeto	= b.nr_sequencia
				and	a.NR_SEQ_ORDEM_SERV 	= nr_sequencia_p
				and	b.ie_origem		= 'D';

			end if;
		end if;

	end if;

	end;
elsif (ie_opcao_p = '4') then
	begin

	select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ds_retorno_w
	from	proj_programa p,
		proj_projeto d,
		proj_cronograma c,
		proj_cron_etapa b,
		man_ordem_servico a
	where	a.nr_sequencia			= nr_sequencia_p
	and	a.nr_seq_proj_cron_etapa	= b.nr_sequencia
	and	b.nr_seq_cronograma		= c.nr_sequencia
	and	c.nr_seq_proj			= d.nr_sequencia
	and	p.nr_sequencia			= d.nr_seq_programa
	and	d.ie_origem			= 'D'
	and	coalesce(p.ie_capitalizar,'N')	= 'S';

	if (ds_retorno_w = 'N') then

		select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ds_retorno_w
		from	proj_programa p,
			proj_projeto a,
			proj_ordem_servico b
		where	b.nr_seq_ordem 			= nr_sequencia_p
		and	a.nr_sequencia			= b.nr_seq_proj
		and	p.nr_sequencia			= a.nr_seq_programa
		and	a.ie_origem			= 'D'
		and	coalesce(p.ie_capitalizar,'N')	= 'S';

		if (ds_retorno_w = 'N') then

			select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ds_retorno_w
			from	proj_programa p,
				proj_projeto a
			where	a.nr_seq_ordem_serv		= nr_sequencia_p
			and	p.nr_sequencia			= a.nr_seq_programa
			and	a.ie_origem			= 'D'
			and	coalesce(p.ie_capitalizar,'N')	= 'S';

			if (ds_retorno_w = 'N') then

				select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ds_retorno_w
				from	proj_programa p,
					proj_projeto b,
					proj_projeto_cliente_adic a
				where	a.nr_seq_projeto		= b.nr_sequencia
				and	p.nr_sequencia			= b.nr_seq_programa
				and	a.NR_SEQ_ORDEM_SERV 		= nr_sequencia_p
				and	b.ie_origem			= 'D'
				and	coalesce(p.ie_capitalizar,'N')	= 'S';

			end if;
		end if;

	end if;

	end;
elsif (ie_opcao_p = '5') then
	begin

	select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ds_retorno_w
	from	proj_programa p,
		proj_projeto d,
		proj_cronograma c,
		proj_cron_etapa b,
		man_ordem_servico a
	where	a.nr_sequencia			= nr_sequencia_p
	and	a.nr_seq_proj_cron_etapa	= b.nr_sequencia
	and	b.nr_seq_cronograma		= c.nr_sequencia
	and	c.nr_seq_proj			= d.nr_sequencia
	and	p.nr_sequencia			= d.nr_seq_programa
	and	coalesce(p.ie_capitalizar,'N')	= 'S';

	if (ds_retorno_w = 'N') then

		select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ds_retorno_w
		from	proj_programa p,
			proj_projeto a,
			proj_ordem_servico b
		where	b.nr_seq_ordem 			= nr_sequencia_p
		and	a.nr_sequencia			= b.nr_seq_proj
		and	p.nr_sequencia			= a.nr_seq_programa
		and	coalesce(p.ie_capitalizar,'N')	= 'S';

		if (ds_retorno_w = 'N') then

			select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ds_retorno_w
			from	proj_programa p,
				proj_projeto a
			where	a.nr_seq_ordem_serv		= nr_sequencia_p
			and	p.nr_sequencia			= a.nr_seq_programa
			and	coalesce(p.ie_capitalizar,'N')	= 'S';

			if (ds_retorno_w = 'N') then

				select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ds_retorno_w
				from	proj_programa p,
					proj_projeto b,
					proj_projeto_cliente_adic a
				where	a.nr_seq_projeto		= b.nr_sequencia
				and	p.nr_sequencia			= b.nr_seq_programa
				and	a.NR_SEQ_ORDEM_SERV 		= nr_sequencia_p
				and	coalesce(p.ie_capitalizar,'N')	= 'S';

			end if;
		end if;

	end if;

	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_ordem_vinc_projeto ( nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

