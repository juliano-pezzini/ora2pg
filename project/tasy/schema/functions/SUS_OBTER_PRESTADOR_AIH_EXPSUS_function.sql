-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_prestador_aih_expsus ( ie_tipo_servico_p bigint, ie_tipo_ato_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_cgc_prestador_p text, cd_setor_atendimento_p bigint, cd_medico_p text, cd_convenio_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE



ds_retorno_w		varchar(14);
cd_cnes_estab_w		integer;
cd_cnes_w		varchar(7);
ie_altera_tipo_serv_w	varchar(1);
ie_conveniado_w		varchar(1);
nr_cpf_medico_w		varchar(11);
cd_cgc_w		varchar(14);
cd_medico_w		varchar(10);


BEGIN

/* alteração feita à respeito da portaria nº 847 de 16 de novembro do sus, onde deve ser exportado o cnes ao invés do cnpj, exceto para opm e terapia */

/* obter dados dos parametros sus */

begin
select	cd_cnes,
	ie_altera_tipo_serv
into STRICT	cd_cnes_estab_w,
	ie_altera_tipo_serv_w
from	sus_parametros
where	cd_estabelecimento	= cd_estabelecimento_p;
exception
	when others then
	ie_altera_tipo_serv_w	:= 'N';
end;

cd_medico_w	:= substr(obter_medico_sus_aih(cd_procedimento_p,ie_origem_proced_p,ie_tipo_servico_p,ie_tipo_ato_p,cd_medico_p),1,10);

/* obter o cpf do médico */

select	coalesce(max(nr_cpf),'')
into STRICT	nr_cpf_medico_w
from	pessoa_fisica
where	cd_pessoa_fisica	= cd_medico_w;

/* buscar o cnes do prestador */

select	coalesce(max(substr(cd_cnes,1,7)),cd_cnes_estab_w)
into STRICT	cd_cnes_w
from	pessoa_juridica
where	cd_cgc	= cd_cgc_prestador_p;

ie_conveniado_w	:= substr(obter_se_medico_conveniado(cd_estabelecimento_p,cd_medico_w,cd_convenio_p, null, null, null,null,null,null, null, null),1,1);
cd_cgc_w	:= sus_obter_substituir_cgc(ie_tipo_servico_p, ie_tipo_ato_p, cd_cgc_prestador_p, cd_estabelecimento_p);


if (ie_tipo_servico_p in (1,26,50,53,55)) then
	ds_retorno_w	:= cd_cgc_w;
elsif (ie_altera_tipo_serv_w	= 'S') and (ie_tipo_servico_p in (6,7,21,23,45)) then
	ds_retorno_w	:= cd_cnes_w;
elsif	((cd_medico_w IS NOT NULL AND cd_medico_w::text <> '') or (cd_medico_w <> '')) and (ie_tipo_servico_p not in (1,4,5)) and (ie_conveniado_w = 'S') then
	ds_retorno_w	:= nr_cpf_medico_w;
else
	ds_retorno_w	:= cd_cnes_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_prestador_aih_expsus ( ie_tipo_servico_p bigint, ie_tipo_ato_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_cgc_prestador_p text, cd_setor_atendimento_p bigint, cd_medico_p text, cd_convenio_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

