-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_dispensacao_sae ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_unid_med_dose_p text, ie_via_aplicacao_p text, cd_intervalo_p text, nr_atendimento_p bigint, ie_opcao_p text, nr_prescricao_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


/*Opções:
	P	- Regra dispensação dose
	A	- Regra dispensação farmácia
	U	- Regra dispensação usuário
	T	- Regra dispensação dose e farmácia
*/
ie_regra_w				varchar(1);
ie_regra_disp_w			varchar(1);
cd_unid_med_solic_w		varchar(30);
cd_unid_med_estoque_w	varchar(30);
cd_material_estoque_w   integer;
cd_convenio_w			integer := 0;
cd_setor_atendimento_w	integer := 0;
ie_usuario_def_disp_w	varchar(1);
ie_acm_w			varchar(1);
ie_se_necessario_w		varchar(1);
IE_MOTIVO_PRESCRICAO_w	varchar(3);

C01 CURSOR FOR
	SELECT	ie_regra,
			ie_regra_disp,
			ie_usuario_def_disp
	from	material_regra_disp
	where	cd_estabelecimento	= cd_estabelecimento_p
	and		((coalesce(cd_unidade_medida::text, '') = '') or
			 ((ie_unidade_medida = 1) and (coalesce(cd_unid_med_solic_w,cd_unidade_medida) = cd_unidade_medida)) or
             ((ie_unidade_medida = 2) and (coalesce(cd_unid_med_dose_p,cd_unidade_medida) = cd_unidade_medida)) or
			 ((ie_unidade_medida = 3) and (coalesce(cd_unid_med_estoque_w,cd_unidade_medida) = cd_unidade_medida)))
	and		(((coalesce(cd_material, cd_material_p)	= cd_material_p) and (coalesce(ie_material_estoque,'N') = 'N')) or
			((coalesce(cd_material, cd_material_estoque_w)	= cd_material_estoque_w) and (coalesce(ie_material_estoque,'N') = 'S')))
	and		coalesce(cd_convenio, cd_convenio_w)		= cd_convenio_w
	and		coalesce(cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
	and		coalesce(cd_perfil, coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
	and		coalesce(cd_unid_med_estoque, cd_unid_med_estoque_w) = cd_unid_med_estoque_w
	and		((coalesce(ie_via_aplicacao::text, '') = '') or (coalesce(ie_via_aplicacao_p, ie_via_aplicacao) = ie_via_aplicacao))
	and		((coalesce(cd_intervalo::text, '') = '') or (coalesce(cd_intervalo_p, cd_intervalo) = cd_intervalo))
	and		(((coalesce(ie_acm_sn,'X') = 'N') and (ie_acm_w = 'N') and (ie_se_necessario_w = 'N')) or
			 ((coalesce(ie_acm_sn,'X') = 'S') and
		          ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S'))) or (coalesce(ie_acm_sn,'X') = 'X'))
	and 	((coalesce(IE_MOTIVO_PRESCRICAO::text, '') = '') or (IE_MOTIVO_PRESCRICAO = IE_MOTIVO_PRESCRICAO_w))
	and		((coalesce(nr_seq_estrut_int::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrut_int,cd_material_p) = 'S'))
	order by coalesce(cd_material,0),
			--nvl(ie_unidade_medida,0),
			coalesce(cd_convenio,0),
			coalesce(cd_setor_atendimento,0),
			coalesce(cd_unidade_medida,'zzzz') desc,
			coalesce(ie_via_aplicacao,'zzzz') desc,
			coalesce(nr_seq_estrut_int,0),
			coalesce(cd_intervalo,0);


BEGIN

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

	select	substr(obter_dados_material_estab(cd_material_p,cd_estabelecimento_p,'UMS'),1,30),
			substr(obter_dados_material_estab(cd_material_p,cd_estabelecimento_p,'UME'),1,30),
			substr(obter_dados_material(cd_material_p,'EST'),1,30)
	into STRICT	cd_unid_med_solic_w,
			cd_unid_med_estoque_w,
			cd_material_estoque_w
	;

	if (coalesce(nr_atendimento_p,0) > 0) then
		select	coalesce(max(cd_convenio),0),
				coalesce(max(cd_setor_atendimento),0)
		into STRICT	cd_convenio_w,
				cd_setor_atendimento_w
		from	atendimento_paciente_v
		where	nr_atendimento = nr_atendimento_p;
	end if;

	ie_acm_w			:= 'N';
	ie_se_necessario_w	:= 'N';

	select	max(IE_MOTIVO_PRESCRICAO)
	into STRICT	IE_MOTIVO_PRESCRICAO_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;


	open C01;
	loop
	fetch C01 into
		ie_regra_w,
		ie_regra_disp_w,
		ie_usuario_def_disp_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_regra_w				:= ie_regra_w;
		ie_regra_disp_w			:= ie_regra_disp_w;
		ie_usuario_def_disp_w 	:= ie_usuario_def_disp_w;
		end;
	end loop;
	close C01;

end if;

if (ie_opcao_p = 'P') then
	return	coalesce(ie_regra_w,'S');
elsif (ie_opcao_p = 'A') then
	return	coalesce(ie_regra_disp_w,'C');
elsif (ie_opcao_p = 'U') then
	return	coalesce(ie_usuario_def_disp_w,'N');
else
	return	coalesce(ie_regra_w,'S') || coalesce(ie_regra_disp_w,'C');
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_dispensacao_sae ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_unid_med_dose_p text, ie_via_aplicacao_p text, cd_intervalo_p text, nr_atendimento_p bigint, ie_opcao_p text, nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

