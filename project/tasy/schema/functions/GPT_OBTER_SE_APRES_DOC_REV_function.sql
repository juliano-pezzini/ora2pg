-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gpt_obter_se_apres_doc_rev ( nr_seq_cpoe_p bigint, ie_tipo_item_p text) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(1) := 'N';
nm_usuario_nrec_w	varchar(15);
ie_group_type_w		varchar(5);
ie_dados_usuario_w	varchar(255);
cd_perfil_w			bigint;
ie_profissional_w	bigint;


BEGIN

	if (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') then

		if (ie_tipo_item_p in ('D', 'J', 'SNE','S','LD', 'NPTA', 'NPTI')) then

			select	max(nm_usuario_nrec) nm_usuario_nrec,
					'N'  ie_group_type
			into STRICT	nm_usuario_nrec_w,
					ie_group_type_w
			from	cpoe_dieta
			where	nr_sequencia = nr_seq_cpoe_p;

		elsif (ie_tipo_item_p = 'DI') then

			select	max(nm_usuario_nrec) nm_usuario_nrec,
					'DIA' ie_group_type
			into STRICT	nm_usuario_nrec_w,
					ie_group_type_w
			from	cpoe_dialise
			where	nr_sequencia = nr_seq_cpoe_p;

		elsif (ie_tipo_item_p = 'O') then

			select	max(nm_usuario_nrec) nm_usuario_nrec,
					'G' ie_group_type
			into STRICT	nm_usuario_nrec_w,
					ie_group_type_w
			from	cpoe_gasoterapia
			where	nr_sequencia = nr_seq_cpoe_p;

		elsif (ie_tipo_item_p in ('M', 'SOL')) then

			select	max(nm_usuario_nrec) nm_usuario_nrec,
					'M' ie_group_type
			into STRICT	nm_usuario_nrec_w,
					ie_group_type_w
			from	cpoe_material
			where	nr_sequencia = nr_seq_cpoe_p
			and		(ie_material IS NOT NULL AND ie_material::text <> '');

		elsif (ie_tipo_item_p = 'R') then

			select	max(nm_usuario_nrec) nm_usuario_nrec,
					'R'
			into STRICT	nm_usuario_nrec_w,
					ie_group_type_w
			from	cpoe_recomendacao
			where	nr_sequencia = nr_seq_cpoe_p;

		elsif (ie_tipo_item_p = 'P') then

			select	max(nm_usuario_nrec) nm_usuario_nrec,
					'P' ie_group_type
			into STRICT	nm_usuario_nrec_w,
					ie_group_type_w
			from	cpoe_procedimento
			where	nr_sequencia = nr_seq_cpoe_p;

		end if;

		if (nm_usuario_nrec_w IS NOT NULL AND nm_usuario_nrec_w::text <> '') then
			ie_profissional_w := gpt_obter_Profissional_Usuario(nm_usuario_nrec_w);
			ie_dados_usuario_w := Obter_dados_usuario_opcao(nm_usuario_nrec_w, 'F');
			cd_perfil_w := wheb_usuario_pck.get_cd_perfil;

			if(('S' = gpt_obter_se_apresenta_grupo(cd_perfil_w, ie_group_type_w)) and (
					(((ie_profissional_w IS NOT NULL AND ie_profissional_w::text <> '') and  gpt_funcao_prescr_liberada(cd_perfil_w ,ie_profissional_w) = 'S') or
					((coalesce(ie_profissional_w::text, '') = '') and gpt_funcao_prescr_liberada(cd_perfil_w ,ie_dados_usuario_w) = 'S')))) then

						ie_retorno_w := 'S';

			end if;

		end if;

	end if;

return ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gpt_obter_se_apres_doc_rev ( nr_seq_cpoe_p bigint, ie_tipo_item_p text) FROM PUBLIC;

