-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_valor_conta ( nr_seq_mes_ref_p bigint, cd_conta_contabil_p text, cd_estabelecimento_p bigint, nr_seq_unid_neg_p bigint, ie_opcao_p text, dt_inicial_p timestamp default null, nr_seq_demo_p bigint default null) RETURNS bigint AS $body$
DECLARE


ds_comando_w       		varchar(4000);
ds_conta_w         		varchar(4000);
ds_divisor_w       		varchar(4000);
ds_dividendo_w     		varchar(4000);
vl_conta_w         		double precision;
vl_saldo_w         		double precision;
vl_encerramento_w  		double precision;
vl_movimento_w     		double precision;
vl_result_w        		double precision;
cd_conta_w         		varchar(40);
cd_centro_w        		varchar(40);
ie_pos_mais_w      		integer;
ie_pos_menos_w     		integer;
ie_pos_mult_w      		integer;
ie_pos_div_w       		integer;
ie_pos_w           		integer;
ie_pos_cc_w         		integer;
ie_pos_tipo_cc_w   		integer;
ie_sinal_w          		varchar(01)    := '+';
ie_tipo_conta_w     		varchar(01);
ie_tipo_custo_w     		varchar(40);
ie_tipo_w           		varchar(01);
ie_opcao_w          		varchar(15);
cd_classif_w        		varchar(40);
dt_referencia_w     		timestamp;
ie_pos_estab_w      		integer;
cd_estab_w          		integer;
vl_credito_w        		double precision;
vl_debito_w         		double precision;
vl_dividendo_w      		double precision    := 0;
vl_divisor_w        		double precision    := 0;
dt_inicial_w        		timestamp;
nr_seq_grupo_emp_w  		ctb_demonstrativo.nr_seq_grupo_emp%type := null;
nr_seq_tipo_w	    		ctb_demonstrativo.nr_seq_tipo%type := null;
ds_oper_estab_w			ctb_modelo_relat.ds_oper_estab%type;
ds_oper_centro_custo_w		ctb_modelo_relat.ds_oper_centro_custo%type;
ds_oper_tipo_centro_w		ctb_modelo_relat.ds_oper_tipo_centro%type;
ie_ifrs_w			varchar(1);

/* opcoes
    'S' - saldo da conta no mes (tira o encerramento)
    'SC'    - saldo da conta no mes
    'M' - movimento da conta no mes
    'MA'    - movimento da conta ate o mes
    'MD'    - movimento das contas (somente debitos)
    'MC'    - movimento das contas (somente creditos)
    'MAD'   - movimento ano ate o mes (somente debitos)
    'MAC'   - movimento ano ate o mes (somente creditos)
*/
BEGIN

ds_conta_w      := cd_conta_contabil_p;
ds_conta_w      := replace(ds_conta_w,' ','');
vl_result_w     := 0;
ie_opcao_w      := coalesce(ie_opcao_p,'S');

begin
select	'S'
into STRICT	ie_ifrs_w

where	exists (
        SELECT	1

        where	ie_opcao_w in ('IS', 'ISC', 'IM', 'IMA', 'IMD', 'IMC', 'IMAD', 'IMAC', 'IMCSE', 'IMASE')
);
exception
when no_data_found then
	ie_ifrs_w :=	'N';
end;

select  max(dt_referencia)
into STRICT    dt_referencia_w
from    ctb_mes_ref
where   nr_sequencia    = nr_seq_mes_ref_p;

if (nr_seq_demo_p IS NOT NULL AND nr_seq_demo_p::text <> '') then
	select  nr_seq_grupo_emp,
		nr_seq_tipo
	into STRICT    nr_seq_grupo_emp_w,
		nr_seq_tipo_w
	from    ctb_demonstrativo
	where   nr_sequencia = nr_seq_demo_p;

	if (nr_seq_tipo_w IS NOT NULL AND nr_seq_tipo_w::text <> '') then
		select 	ds_oper_estab,
			ds_oper_centro_custo,
			ds_oper_tipo_centro
		into STRICT 	ds_oper_estab_w,
			ds_oper_centro_custo_w,
			ds_oper_tipo_centro_w
		from	ctb_modelo_relat
		where 	nr_sequencia = nr_seq_tipo_w;
	end if;
end if;

dt_inicial_w :=  coalesce(dt_inicial_p, trunc(dt_referencia_w,'year'));

while(length(ds_conta_w) > 0)  loop
    cd_conta_w      := null;
    ie_pos_mais_w       := position('+' in ds_conta_w);
    ie_pos_menos_w      := position('-' in ds_conta_w);
    ie_pos_mult_w       := position('*' in ds_conta_w);
    ie_pos_div_w        := position('/' in ds_conta_w);

    if (ie_pos_mais_w = 0) and (ie_pos_menos_w = 0) and (ie_pos_div_w = 0) then
        ie_pos_w    := 0;
    elsif (ie_pos_menos_w > 0) and ((ie_pos_menos_w < ie_pos_mais_w) or (ie_pos_mais_w = 0)) then
        ie_pos_w    := ie_pos_menos_w;
    elsif (ie_pos_mais_w > 0) and ((ie_pos_mais_w < ie_pos_mult_w) or (ie_pos_mult_w = 0)) then
        ie_pos_w    := ie_pos_mais_w;
    elsif (ie_pos_mult_w > 0) and ((ie_pos_mult_w < ie_pos_div_w) or (ie_pos_div_w = 0)) then
        ie_pos_w    := ie_pos_mult_w;
    else
        ie_pos_w    := ie_pos_div_w;
    end if;

    if (ie_pos_w > 0) then
        cd_conta_w  := substr(ds_conta_w,1, ie_pos_w - 1);
        ds_conta_w  := substr(ds_conta_w, ie_pos_w, 4000);

        if (ie_pos_w = 1) then
            cd_conta_w  := 0;
            ds_conta_w  := substr('0 ' || ds_conta_w,1,4000);
        end if;
    else
        cd_conta_w  := substr(ds_conta_w,1,40);
        ds_conta_w  := null;
    end if;

    /*se possui restricao por estabelecimento*/

    ie_pos_estab_w 	:= position(coalesce(trim(both ds_oper_estab_w),'@') in cd_conta_w);
    if (ie_pos_estab_w > 0) then
	cd_estab_w	:= substr(cd_conta_w, 1, ie_pos_estab_w - 1);
	cd_conta_w	:= substr(cd_conta_w, ie_pos_estab_w + LENGTH(coalesce(trim(both ds_oper_estab_w),'@')), 20);
    end if;

    /*ie_pos_estab_w  := instr(cd_conta_w,'@');
          if  (ie_pos_estab_w > 0) then
	cd_estab_w  := substr(cd_conta_w, 1, ie_pos_estab_w - 1);
	cd_conta_w  := substr(cd_conta_w, ie_pos_estab_w + 1, 20);
          end if;*/


    /*se possui restricao por centro de custo*/


    /*cd_centro_w     := '';
    ie_pos_cc_w         := instr(cd_conta_w,'#');
    if  (ie_pos_cc_w > 0) then
        cd_centro_w := substr(cd_conta_w, ie_pos_cc_w + 1, 20);
        cd_conta_w  := substr(cd_conta_w, 1, ie_pos_cc_w - 1);
    end if;*/
    cd_centro_w		:= '';
    ie_pos_cc_w 	:= position(coalesce(trim(both ds_oper_centro_custo_w),'#') in cd_conta_w);
    if (ie_pos_cc_w > 0) then
	cd_centro_w	:= substr(cd_conta_w, ie_pos_cc_w + LENGTH(coalesce(trim(both ds_oper_centro_custo_w),'#')), 20);
	cd_conta_w	:= substr(cd_conta_w, 1, ie_pos_cc_w - 1);
    end if;

    /*se possui restricao por tipo de custo*/


    /*ie_tipo_custo_w     := '';
    ie_pos_tipo_cc_w        := instr(cd_conta_w, 'T');
    if  (ie_pos_tipo_cc_w > 1) then

        ie_tipo_custo_w := substr(cd_conta_w, ie_pos_tipo_cc_w + 1, 20);
        cd_conta_w  := substr(cd_conta_w, 1, ie_pos_tipo_cc_w - 1);
    end if;*/
    ie_tipo_custo_w		:= '';
    ie_pos_tipo_cc_w		:= position(coalesce(trim(both ds_oper_tipo_centro_w), 'T') in cd_conta_w);
    if (ie_pos_tipo_cc_w > 0) then
	ie_tipo_custo_w	:= substr(cd_conta_w, ie_pos_tipo_cc_w + LENGTH(coalesce(trim(both ds_oper_tipo_centro_w),'T')), 20);
	cd_conta_w	:= substr(cd_conta_w, 1, ie_pos_tipo_cc_w - 1);
    end if;

    if (ie_ifrs_w = 'S') then
      begin
          select c.ie_tipo
          into STRICT   ie_tipo_w
          from   ctb_plano_conta_ifrs c
          where  c.nr_sequencia = cd_conta_w;
          exception
          when no_data_found then
              ie_tipo_w := null;
          when too_many_rows then
              ie_tipo_w := null;
       end;
    else
      select  max(b.ie_tipo),
          max(a.ie_tipo)
      into STRICT    ie_tipo_conta_w,
          ie_tipo_w
      from    ctb_grupo_conta b,
          conta_contabil a
      where   a.cd_grupo      = b.cd_grupo
      and a.cd_conta_contabil = cd_conta_w;
    end if;

    vl_saldo_w      := 0;
    vl_encerramento_w   := 0;
    vl_movimento_w  := 0;
    if (cd_conta_w IS NOT NULL AND cd_conta_w::text <> '') then
        if (coalesce(cd_centro_w::text, '') = '') then

            if (coalesce(ie_tipo_custo_w::text, '') = '') then
                if (coalesce(nr_seq_grupo_emp_w::text, '') = '') then
                    begin
		
		    if (ie_ifrs_w = 'N') then
			    select  coalesce(sum(vl_saldo),0),
				    coalesce(sum(vl_encerramento),0),
				    coalesce(sum(vl_movimento),0),
				    coalesce(sum(vl_credito),0),
				    coalesce(sum(vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    ctb_saldo a
			    where   nr_seq_mes_ref in ( SELECT  nr_seq_mes_ref_p
							
							where   ie_opcao_w not in ('MA','MAC','MAD','MASE')
							
union

							SELECT  nr_sequencia
							from    ctb_mes_ref
							where   dt_referencia between dt_inicial_w and dt_referencia_w
							and     ie_opcao_w in ('MA','MAC','MAD','MASE'))
			    and     cd_conta_contabil = cd_conta_w
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
											    from    estabelecimento
											    where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;
		    else
			    select  coalesce(sum(vl_saldo),0),
				    coalesce(sum(vl_encerramento),0),
				    coalesce(sum(vl_movimento),0),
				    coalesce(sum(vl_credito),0),
				    coalesce(sum(vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    ctb_saldo_ifrs a
			    where   nr_seq_mes_ref in ( SELECT  nr_seq_mes_ref_p
							
							where   ie_opcao_w not in ('IMA','IMAC','IMAD','IMASE')
							
union

							SELECT  nr_sequencia
							from    ctb_mes_ref
							where   dt_referencia between dt_inicial_w and dt_referencia_w
							and     ie_opcao_w in ('IMA','IMAC','IMAD','IMASE'))
			    and     nr_seq_conta_ifrs = cd_conta_w
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  e.cd_estabelecimento
											    from    estabelecimento e
											    where   e.nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;
		    end if;

                    end;
                else
                    /*Grupo de empresa*/

                    begin
		
		    if (ie_ifrs_w = 'N') then
			    select  coalesce(sum(vl_saldo),0),
				    coalesce(sum(vl_encerramento),0),
				    coalesce(sum(vl_movimento),0),
				    coalesce(sum(vl_credito),0),
				    coalesce(sum(vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    conta_contabil b,
				    ctb_saldo a
			    where   nr_seq_mes_ref in ( SELECT  b.nr_sequencia
							from    ctb_mes_ref b,
								grupo_empresa_v c
							where   ie_opcao_w not in ('MA','MAC','MAD','MASE')
							and     b.dt_referencia = CTB_OBTER_MES_REF(nr_seq_mes_ref_p)
							and     b.cd_empresa = c.cd_empresa
							and     c.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w
							
union

							SELECT  b.nr_sequencia
							from    ctb_mes_ref b,
								grupo_empresa_v c
							where   dt_referencia between dt_inicial_w and dt_referencia_w
							and     ie_opcao_w in ('MA','MAC','MAD','MASE')
							and     b.cd_empresa = c.cd_empresa
							and     c.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w)
			    and     a.cd_conta_contabil = b.cd_conta_contabil
			    and     coalesce(b.cd_conta_referencia, b.cd_conta_contabil) = cd_conta_w
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (      select  cd_estabelecimento
												    from    estabelecimento
												    where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;
		    else
		    	    select  coalesce(sum(vl_saldo),0),
				    coalesce(sum(vl_encerramento),0),
				    coalesce(sum(vl_movimento),0),
				    coalesce(sum(vl_credito),0),
				    coalesce(sum(vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    ctb_saldo_ifrs a
			    where   nr_seq_mes_ref in ( SELECT  b.nr_sequencia
							from    ctb_mes_ref b,
								grupo_empresa_v c
							where   ie_opcao_w not in ('IMA','IMAC','IMAD','IMASE')
							and     b.dt_referencia = CTB_OBTER_MES_REF(nr_seq_mes_ref_p)
							and     b.cd_empresa = c.cd_empresa
							and     c.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w
							
union

							SELECT  b.nr_sequencia
							from    ctb_mes_ref b,
								grupo_empresa_v c
							where   dt_referencia between dt_inicial_w and dt_referencia_w
							and     ie_opcao_w in ('IMA','IMAC','IMAD','IMASE')
							and     b.cd_empresa = c.cd_empresa
							and     c.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w)
			    and     a.nr_seq_conta_ifrs = cd_conta_w
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (      select  e.cd_estabelecimento
												    from    estabelecimento e
												    where   e.nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;
		    end if;
                    end;
                end if;
            else
                if (ie_tipo_w = 'A') then
                    /*Contas analiticas*/

                    if (coalesce(nr_seq_grupo_emp_w::text, '') = '') then
                        begin
			
			if (ie_ifrs_w = 'N') then
				select  coalesce(sum(vl_saldo),0),
					coalesce(sum(vl_encerramento),0),
					coalesce(sum(vl_movimento),0),
					coalesce(sum(vl_credito),0),
					coalesce(sum(vl_debito),0)
				into STRICT    vl_saldo_w,
					vl_encerramento_w,
					vl_movimento_w,
					vl_credito_w,
					vl_debito_w
				from    centro_custo b,
					ctb_saldo a
				where   nr_seq_mes_ref in ( SELECT  nr_seq_mes_ref_p
							
							    where   ie_opcao_w not in ('MA','MAC','MAD','MASE')
							    
union

							    SELECT  nr_sequencia
							    from    ctb_mes_ref
							    where   dt_referencia between dt_inicial_w and dt_referencia_w
							    and ie_opcao_w in ('MA','MAC','MAD','MASE'))
				and     cd_conta_contabil       = cd_conta_w
				and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
				and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
												    from    estabelecimento
												    where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
				and     a.cd_centro_custo   = b.cd_centro_custo
				and     b.ie_tipo_custo     = ie_tipo_custo_w
				and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;
			else
				select  coalesce(sum(a.vl_saldo),0),
					coalesce(sum(a.vl_encerramento),0),
					coalesce(sum(a.vl_movimento),0),
					coalesce(sum(a.vl_credito),0),
					coalesce(sum(a.vl_debito),0)
				into STRICT    vl_saldo_w,
					vl_encerramento_w,
					vl_movimento_w,
					vl_credito_w,
					vl_debito_w
				from    centro_custo b,
					ctb_saldo_ifrs a
				where   nr_seq_mes_ref in ( SELECT  nr_seq_mes_ref_p
							
							    where   ie_opcao_w not in ('IMA','IMAC','IMAD','IMASE')
							    
union

							    SELECT  nr_sequencia
							    from    ctb_mes_ref
							    where   dt_referencia between dt_inicial_w and dt_referencia_w
							    and ie_opcao_w in ('IMA','IMAC','IMAD','IMASE'))
				and     nr_seq_conta_ifrs       = cd_conta_w
				and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
				and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  e.cd_estabelecimento
												    from    estabelecimento e
												    where   e.nr_seq_unid_neg = nr_seq_unid_neg_p)))
				and     a.cd_centro_custo   = b.cd_centro_custo
				and     b.ie_tipo_custo     = ie_tipo_custo_w
				and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;
			end if;
                        end;
                    else
                        /*Grupo de empresa*/

                        begin
			
			if (ie_ifrs_w = 'N') then
				select  coalesce(sum(vl_saldo),0),
					coalesce(sum(vl_encerramento),0),
					coalesce(sum(vl_movimento),0),
					coalesce(sum(vl_credito),0),
					coalesce(sum(vl_debito),0)
				into STRICT    vl_saldo_w,
					vl_encerramento_w,
					vl_movimento_w,
					vl_credito_w,
					vl_debito_w
				from    conta_contabil c,
					centro_custo b,
					ctb_saldo a
				where   a.nr_seq_mes_ref in (   SELECT  b.nr_sequencia
								from    ctb_mes_ref b,
									grupo_empresa_v d
								where   ie_opcao_w not in ('MA','MAC','MAD','MASE')
								and     b.dt_referencia = CTB_OBTER_MES_REF(nr_seq_mes_ref_p)
								and     b.cd_empresa    = d.cd_empresa
								and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
								and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w
								
union

								SELECT  b.nr_sequencia
								from    ctb_mes_ref b,
									grupo_empresa_v d
								where   dt_referencia between dt_inicial_w and dt_referencia_w
								and     ie_opcao_w in ('MA','MAC','MAD','MASE')
								and     b.cd_empresa = d.cd_empresa
								and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
								and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w )
				and     coalesce(c.cd_conta_referencia, c.cd_conta_contabil) = cd_conta_w
				and     a.cd_centro_custo   = b.cd_centro_custo
				and     a.cd_conta_contabil = c.cd_conta_contabil
				and     b.ie_tipo_custo     = ie_tipo_custo_w
				and     a.cd_estabelecimento    = coalesce(cd_estab_w, a.cd_estabelecimento)
				and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
				and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
												    from    estabelecimento
												    where   nr_seq_unid_neg = nr_seq_unid_neg_p)));
			else
				select  coalesce(sum(a.vl_saldo),0),
					coalesce(sum(a.vl_encerramento),0),
					coalesce(sum(a.vl_movimento),0),
					coalesce(sum(a.vl_credito),0),
					coalesce(sum(a.vl_debito),0)
				into STRICT    vl_saldo_w,
					vl_encerramento_w,
					vl_movimento_w,
					vl_credito_w,
					vl_debito_w
				from    ctb_plano_conta_ifrs c,
					centro_custo b,
					ctb_saldo_ifrs a
				where   a.nr_seq_mes_ref in (   SELECT  b.nr_sequencia
								from    ctb_mes_ref b,
									grupo_empresa_v d
								where   ie_opcao_w not in ('IMA','IMAC','IMAD','IMASE')
								and     b.dt_referencia = CTB_OBTER_MES_REF(nr_seq_mes_ref_p)
								and     b.cd_empresa    = d.cd_empresa
								and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
								and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w
								
union

								SELECT  b.nr_sequencia
								from    ctb_mes_ref b,
									grupo_empresa_v d
								where   dt_referencia between dt_inicial_w and dt_referencia_w
								and     ie_opcao_w in ('IMA','IMAC','IMAD','IMASE')
								and     b.cd_empresa = d.cd_empresa
								and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
								and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w )
				and     a.nr_seq_conta_ifrs = cd_conta_w
				and     a.cd_centro_custo   = b.cd_centro_custo
				and     a.nr_seq_conta_ifrs = c.nr_sequencia
				and     b.ie_tipo_custo     = ie_tipo_custo_w
				and     a.cd_estabelecimento    = coalesce(cd_estab_w, a.cd_estabelecimento)
				and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
				and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  e.cd_estabelecimento
												    from    estabelecimento e
												    where   e.nr_seq_unid_neg = nr_seq_unid_neg_p)));
			end if;
                        end;
                    end if;
                else
                    /*Contas totalizadoras*/

		    if (ie_ifrs_w = 'N') then
			    select  substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_referencia_w),1,40)
			    into STRICT    cd_classif_w
			    from    conta_contabil
			    where   cd_conta_contabil       = cd_conta_w;
		    end if;

                    if (coalesce(nr_seq_grupo_emp_w::text, '') = '') then
                            begin
			    if (ie_ifrs_w = 'N') then
				    select  coalesce(sum(vl_saldo),0),
					    coalesce(sum(vl_encerramento),0),
					    coalesce(sum(vl_movimento),0),
					    coalesce(sum(vl_credito),0),
					    coalesce(sum(vl_debito),0)
				    into STRICT    vl_saldo_w,
					    vl_encerramento_w,
					    vl_movimento_w,
					    vl_credito_w,
					    vl_debito_w
				    from    centro_custo b,
					    ctb_saldo a
				    where   nr_seq_mes_ref in ( SELECT  nr_seq_mes_ref_p
								
								where   ie_opcao_w not in ('MA','MAC','MAD','MASE')
								
union

								SELECT  nr_sequencia
								from    ctb_mes_ref
								where   dt_referencia between dt_inicial_w and dt_referencia_w
								and ie_opcao_w in ('MA','MAC','MAD','MASE'))
				    and (substr(ctb_obter_se_classif_sup(a.cd_classificacao, cd_classif_w),1,1) = 'S')
				    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
				    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
												    from    estabelecimento
												    where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
				    and     a.cd_centro_custo   = b.cd_centro_custo
				    and     b.ie_tipo_custo     = ie_tipo_custo_w
				    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;
			    else
				    select  coalesce(sum(a.vl_saldo),0),
					    coalesce(sum(a.vl_encerramento),0),
					    coalesce(sum(a.vl_movimento),0),
					    coalesce(sum(a.vl_credito),0),
					    coalesce(sum(a.vl_debito),0)
				    into STRICT    vl_saldo_w,
					    vl_encerramento_w,
					    vl_movimento_w,
					    vl_credito_w,
					    vl_debito_w
				    from    centro_custo b,
					    ctb_saldo_ifrs a
				    where   nr_seq_mes_ref in ( SELECT  nr_seq_mes_ref_p
								
								where   ie_opcao_w not in ('IMA','IMAC','IMAD','IMASE')
								
union

								SELECT  nr_sequencia
								from    ctb_mes_ref
								where   dt_referencia between dt_inicial_w and dt_referencia_w
								and ie_opcao_w in ('IMA','IMAC','IMAD','IMASE'))
				    and (substr(ctb_obter_se_classif_sup_ifrs((cd_conta_w)::numeric , a.cd_classificacao),1,1) = 'S')
				    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
				    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  e.cd_estabelecimento
												    from    estabelecimento e
												    where   e.nr_seq_unid_neg = nr_seq_unid_neg_p)))
				    and     a.cd_centro_custo   = b.cd_centro_custo
				    and     b.ie_tipo_custo     = ie_tipo_custo_w
				    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;
			    end if;
                            end;
                    else
                            /*Grupo de empresa*/

                            begin
			    if (ie_ifrs_w = 'N') then
				    select  coalesce(sum(vl_saldo),0),
					    coalesce(sum(vl_encerramento),0),
					    coalesce(sum(vl_movimento),0),
					    coalesce(sum(vl_credito),0),
					    coalesce(sum(vl_debito),0)
				    into STRICT    vl_saldo_w,
					    vl_encerramento_w,
					    vl_movimento_w,
					    vl_credito_w,
					    vl_debito_w
				    from    centro_custo b,
					    ctb_saldo a
				    where   nr_seq_mes_ref in ( SELECT  b.nr_sequencia
								from    ctb_mes_ref b,
									grupo_empresa_v c
								where   ie_opcao_w not in ('MA','MAC','MAD','MASE')
								and     b.dt_referencia = CTB_OBTER_MES_REF(nr_seq_mes_ref_p)
								and     b.cd_empresa    = c.cd_empresa
								and     c.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
								and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w
								
union

								SELECT  b.nr_sequencia
								from    ctb_mes_ref b,
									grupo_empresa_v c
								where   dt_referencia between dt_inicial_w and dt_referencia_w
								and     ie_opcao_w in ('MA','MAC','MAD','MASE')
								and     b.cd_empresa = c.cd_empresa
								and     c.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
								and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w )
				    and (substr(ctb_obter_se_classif_sup(a.cd_classificacao, cd_classif_w),1,1) = 'S')
				    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
				    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
													from    estabelecimento
													where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
				    and     a.cd_centro_custo   = b.cd_centro_custo
				    and     b.ie_tipo_custo     = ie_tipo_custo_w
				    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;			
			    else
				    select  coalesce(sum(a.vl_saldo),0),
					    coalesce(sum(a.vl_encerramento),0),
					    coalesce(sum(a.vl_movimento),0),
					    coalesce(sum(a.vl_credito),0),
					    coalesce(sum(a.vl_debito),0)
				    into STRICT    vl_saldo_w,
					    vl_encerramento_w,
					    vl_movimento_w,
					    vl_credito_w,
					    vl_debito_w
				    from    centro_custo b,
					    ctb_saldo_ifrs a
				    where   nr_seq_mes_ref in ( SELECT  b.nr_sequencia
								from    ctb_mes_ref b,
									grupo_empresa_v c
								where   ie_opcao_w not in ('IMA','IMAC','IMAD','IMASE')
								and     b.dt_referencia = CTB_OBTER_MES_REF(nr_seq_mes_ref_p)
								and     b.cd_empresa    = c.cd_empresa
								and     c.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
								and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w
								
union

								SELECT  b.nr_sequencia
								from    ctb_mes_ref b,
									grupo_empresa_v c
								where   dt_referencia between dt_inicial_w and dt_referencia_w
								and     ie_opcao_w in ('IMA','IMAC','IMAD','IMASE')
								and     b.cd_empresa = c.cd_empresa
								and     c.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
								and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w )
				    and (substr(ctb_obter_se_classif_sup_ifrs((cd_conta_w)::numeric , a.cd_classificacao),1,1) = 'S')
				    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
				    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  e.cd_estabelecimento
													from    estabelecimento e
													where   e.nr_seq_unid_neg = nr_seq_unid_neg_p)))
				    and     a.cd_centro_custo   = b.cd_centro_custo
				    and     b.ie_tipo_custo     = ie_tipo_custo_w
				    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;
			    end if;

                            end;
                    end if;
                end if;
            end if;

        elsif (ie_tipo_w = 'A') then

            if (coalesce(nr_seq_grupo_emp_w::text, '') = '') then
                    begin
		
		    if (ie_ifrs_w = 'N') then
			    select  coalesce(sum(vl_saldo),0),
				    coalesce(sum(vl_encerramento),0),
				    coalesce(sum(vl_movimento),0),
				    coalesce(sum(vl_credito),0),
				    coalesce(sum(vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    centro_custo b,
				    ctb_saldo a
			    where   nr_seq_mes_ref  in (    SELECT  nr_seq_mes_ref_p
							    
							    where   ie_opcao_w not in ('MA','MAC','MAD','MASE')
							    
union

							    SELECT  nr_sequencia
							    from    ctb_mes_ref
							    where   dt_referencia between dt_inicial_w and dt_referencia_w
							    and     ie_opcao_w in ('MA','MAC','MAD','MASE'))
			    and     cd_conta_contabil   = cd_conta_w
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
											    from    estabelecimento
											    where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento
			    and     a.cd_centro_custo   = b.cd_centro_custo
			    and     cd_centro_w     = substr(b.cd_classificacao,1, length(cd_centro_w));
		    else
			    select  coalesce(sum(a.vl_saldo),0),
				    coalesce(sum(a.vl_encerramento),0),
				    coalesce(sum(a.vl_movimento),0),
				    coalesce(sum(a.vl_credito),0),
				    coalesce(sum(a.vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    centro_custo b,
				    ctb_saldo_ifrs a
			    where   nr_seq_mes_ref  in (    SELECT  nr_seq_mes_ref_p
							
							    where   ie_opcao_w not in ('IMA','IMAC','IMAD','IMASE')
							    
union

							    SELECT  nr_sequencia
							    from    ctb_mes_ref
							    where   dt_referencia between dt_inicial_w and dt_referencia_w
							    and     ie_opcao_w in ('IMA','IMAC','IMAD','IMASE'))
			    and     nr_seq_conta_ifrs   = cd_conta_w
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
											    from    estabelecimento
											    where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento
			    and     a.cd_centro_custo   = b.cd_centro_custo
			    and     cd_centro_w     = substr(b.cd_classificacao,1, length(cd_centro_w));

		    end if;
                    end;
            else
                    begin
		    if (ie_ifrs_w = 'N') then
			    select  coalesce(sum(vl_saldo),0),
				    coalesce(sum(vl_encerramento),0),
				    coalesce(sum(vl_movimento),0),
				    coalesce(sum(vl_credito),0),
				    coalesce(sum(vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    conta_contabil c,
				    centro_custo b,
				    ctb_saldo a
			    where   nr_seq_mes_ref  in (    SELECT  b.nr_sequencia
							    from    ctb_mes_ref b,
								    grupo_empresa_v d
							    where   ie_opcao_w not in ('MA','MAC','MAD','MASE')
							    and     b.dt_referencia = CTB_OBTER_MES_REF(nr_seq_mes_ref_p)
							    and     b.cd_empresa    = d.cd_empresa
							    and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							    and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w
							
union

							    SELECT  b.nr_sequencia
							    from    ctb_mes_ref b,
								    grupo_empresa_v d
							    where   dt_referencia between dt_inicial_w and dt_referencia_w
							    and     ie_opcao_w in ('MA','MAC','MAD','MASE')
							    and     b.cd_empresa = d.cd_empresa
							    and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							    and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w )
			    and     a.cd_conta_contabil = c.cd_conta_contabil
			    and     coalesce(c.cd_conta_referencia, c.cd_conta_contabil) = cd_conta_w
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
												from    estabelecimento
												where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento
			    and     a.cd_centro_custo = b.cd_centro_custo
			    and     cd_centro_w     = substr(b.cd_classificacao,1, length(cd_centro_w));		
		    else
			    select  coalesce(sum(vl_saldo),0),
				    coalesce(sum(vl_encerramento),0),
				    coalesce(sum(vl_movimento),0),
				    coalesce(sum(vl_credito),0),
				    coalesce(sum(vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    ctb_plano_conta_ifrs c,
				    centro_custo b,
				    ctb_saldo_ifrs a
			    where   nr_seq_mes_ref  in (    SELECT  b.nr_sequencia
							    from    ctb_mes_ref b,
								    grupo_empresa_v d
							    where   ie_opcao_w not in ('IMA','IMAC','IMAD','IMASE')
							    and     b.dt_referencia = CTB_OBTER_MES_REF(nr_seq_mes_ref_p)
							    and     b.cd_empresa    = d.cd_empresa
							    and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							    and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w
							    
union

							    SELECT  b.nr_sequencia
							    from    ctb_mes_ref b,
								    grupo_empresa_v d
							    where   dt_referencia between dt_inicial_w and dt_referencia_w
							    and     ie_opcao_w in ('IMA','IMAC','IMAD','IMASE')
							    and     b.cd_empresa = d.cd_empresa
							    and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							    and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w )
			    and     a.nr_seq_conta_ifrs = c.nr_sequencia
			    and     c.nr_sequencia = cd_conta_w
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
												from    estabelecimento
												where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento
			    and     a.cd_centro_custo = b.cd_centro_custo
			    and     cd_centro_w     = substr(b.cd_classificacao,1, length(cd_centro_w));
		    end if;

                    end;
            end if;
        else
	    if (ie_ifrs_w = 'N') then
		select  substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_referencia_w),1,40)
		into STRICT    cd_classif_w
		from    conta_contabil
		where   cd_conta_contabil   = cd_conta_w;
	    else
		begin
		select	cd_classificacao
		into STRICT	cd_classif_w
		from	ctb_plano_conta_ifrs
		where	nr_sequencia	= cd_conta_w;
		exception when no_data_found then
			cd_classif_w := '';
		end;
	    end if;
            if (coalesce(nr_seq_grupo_emp_w::text, '') = '') then
                    begin
		    if (ie_ifrs_w = 'N') then
			    select  coalesce(sum(vl_saldo),0),
				    coalesce(sum(vl_encerramento),0),
				    coalesce(sum(vl_movimento),0),
				    coalesce(sum(vl_credito),0),
				    coalesce(sum(vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    conta_contabil c,
				    centro_custo b,
				    ctb_saldo a
			    where   nr_seq_mes_ref  in (    SELECT  nr_seq_mes_ref_p
							
							    where   ie_opcao_w not in ('MA','MAC','MAD','MASE')
							    
union

							    SELECT  nr_sequencia
							    from    ctb_mes_ref
							    where   dt_referencia between dt_inicial_w and dt_referencia_w
							    and ie_opcao_w in ('MA','MAC','MAD','MASE'))
			    and     a.cd_conta_contabil = c.cd_conta_contabil
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
												from    estabelecimento
												where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento
			    and     a.cd_centro_custo   = b.cd_centro_custo
			    and     cd_centro_w     = substr(b.cd_classificacao,1, length(cd_centro_w))
			    and     cd_classif_w    = substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, dt_referencia_w),1, length(cd_classif_w));
		    else
			    select  coalesce(sum(vl_saldo),0),
				    coalesce(sum(vl_encerramento),0),
				    coalesce(sum(vl_movimento),0),
				    coalesce(sum(vl_credito),0),
				    coalesce(sum(vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    ctb_plano_conta_ifrs c,
				    centro_custo b,
				    ctb_saldo_ifrs a
			    where   nr_seq_mes_ref  in (    SELECT  nr_seq_mes_ref_p
							
							    where   ie_opcao_w not in ('IMA','IMAC','IMAD','IMASE')
							    
union

							    SELECT  nr_sequencia
							    from    ctb_mes_ref
							    where   dt_referencia between dt_inicial_w and dt_referencia_w
							    and ie_opcao_w in ('IMA','IMAC','IMAD','IMASE'))
			    and     a.nr_seq_conta_ifrs = c.nr_sequencia
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
												from    estabelecimento
												where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento
			    and     a.cd_centro_custo   = b.cd_centro_custo
			    and     cd_centro_w     = substr(b.cd_classificacao,1, length(cd_centro_w))
			    and     cd_classif_w    = substr(c.cd_classificacao,1, length(cd_classif_w));
		    end if;
                    end;
            else
                    begin
		    if (ie_ifrs_w = 'N') then
			    select  coalesce(sum(vl_saldo),0),
				    coalesce(sum(vl_encerramento),0),
				    coalesce(sum(vl_movimento),0),
				    coalesce(sum(vl_credito),0),
				    coalesce(sum(vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    conta_contabil c,
				    centro_custo b,
				    ctb_saldo a
			    where   nr_seq_mes_ref  in (    SELECT  b.nr_sequencia
							    from    ctb_mes_ref b,
								    grupo_empresa_v d
							    where   ie_opcao_w not in ('MA','MAC','MAD','MASE')
							    and     b.dt_referencia = CTB_OBTER_MES_REF(nr_seq_mes_ref_p)
							    and     b.cd_empresa    = d.cd_empresa
							    and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							    and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w
							
union

							    SELECT  b.nr_sequencia
							    from    ctb_mes_ref b,
								    grupo_empresa_v d
							    where   dt_referencia between dt_inicial_w and dt_referencia_w
							    and     ie_opcao_w in ('MA','MAC','MAD','MASE')
							    and     b.cd_empresa = d.cd_empresa
							    and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							    and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w )
			    and     a.cd_conta_contabil = c.cd_conta_contabil
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
												from    estabelecimento
												where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento
			    and     a.cd_centro_custo = b.cd_centro_custo
			    and     cd_centro_w     = substr(b.cd_classificacao,1, length(cd_centro_w))
			    and     cd_classif_w    = substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, dt_referencia_w),1, length(cd_classif_w));
		    else
			    select  coalesce(sum(vl_saldo),0),
				    coalesce(sum(vl_encerramento),0),
				    coalesce(sum(vl_movimento),0),
				    coalesce(sum(vl_credito),0),
				    coalesce(sum(vl_debito),0)
			    into STRICT    vl_saldo_w,
				    vl_encerramento_w,
				    vl_movimento_w,
				    vl_credito_w,
				    vl_debito_w
			    from    ctb_plano_conta_ifrs c,
				    centro_custo b,
				    ctb_saldo_ifrs a
			    where   nr_seq_mes_ref  in (    SELECT  b.nr_sequencia
							    from    ctb_mes_ref b,
								    grupo_empresa_v d
							    where   ie_opcao_w not in ('IMA','IMAC','IMAD','IMASE')
							    and     b.dt_referencia = CTB_OBTER_MES_REF(nr_seq_mes_ref_p)
							    and     b.cd_empresa    = d.cd_empresa
							    and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							    and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w
							
union

							    SELECT  b.nr_sequencia
							    from    ctb_mes_ref b,
								    grupo_empresa_v d
							    where   dt_referencia between dt_inicial_w and dt_referencia_w
							    and     ie_opcao_w in ('IMA','IMAC','IMAD','IMASE')
							    and     b.cd_empresa = d.cd_empresa
							    and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
							    and     holding_pck.get_grupo_emp_estrut_vigente(b.cd_empresa) = nr_seq_grupo_emp_w )
			    and     a.nr_seq_conta_ifrs = c.nr_sequencia
			    and     ((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
			    and     ((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (  select  cd_estabelecimento
												from    estabelecimento
												where   nr_seq_unid_neg = nr_seq_unid_neg_p)))
			    and     coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento
			    and     a.cd_centro_custo = b.cd_centro_custo
			    and     cd_centro_w     = substr(b.cd_classificacao,1, length(cd_centro_w))
			    and     cd_classif_w    = substr(c.cd_classificacao,1, length(cd_classif_w));
		    end if;
                    end;
            end if;
        end if;
    end if;

    if (ie_opcao_w in ('S','IS')) then
        if (vl_encerramento_w <> 0) then
            vl_conta_w      := vl_saldo_w - vl_encerramento_w;
        else
            vl_conta_w      := vl_saldo_w;
        end if;
    elsif (ie_opcao_w in ('SC','ISC')) then
        vl_conta_w          := vl_saldo_w;
    elsif (ie_opcao_w in ('M','IM')) then
        vl_conta_w          := vl_movimento_w;
    elsif (ie_opcao_w in ('MA','IMA')) then
        vl_conta_w          := vl_movimento_w;
    elsif (ie_opcao_w in ('MD','MAD','IMD','IMAD')) then
        vl_conta_w          := vl_debito_w;
    elsif (ie_opcao_w in ('MC','MAC','IMC','IMAC')) then
        vl_conta_w          := vl_credito_w;
    elsif (ie_opcao_w in ('MASE','MCSE','IMASE','IMCSE')) then
        if (vl_encerramento_w <> 0) then
            vl_conta_w      := vl_movimento_w - vl_encerramento_w;
        else
            vl_conta_w      := vl_movimento_w;
        end if;
    end if;

    if (ie_sinal_w = '-') then
        vl_result_w         := vl_result_w - vl_conta_w;
    elsif (ie_sinal_w = '+') then
        vl_result_w         := vl_result_w + vl_conta_w;
    elsif (ie_sinal_w = '*') then
        vl_result_w         := vl_result_w * vl_conta_w;
    elsif (ie_sinal_w = '/') then
        vl_result_w         := dividir(vl_result_w, vl_conta_w);
    end if;
    if (ds_conta_w IS NOT NULL AND ds_conta_w::text <> '') and (substr(ds_conta_w,1,1) in ('+','-','*','/')) then
        ie_sinal_w          := substr(ds_conta_w,1,1);
        ds_conta_w          := substr(ds_conta_w,2,4000);
    end if;

end loop;

return  vl_result_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_valor_conta ( nr_seq_mes_ref_p bigint, cd_conta_contabil_p text, cd_estabelecimento_p bigint, nr_seq_unid_neg_p bigint, ie_opcao_p text, dt_inicial_p timestamp default null, nr_seq_demo_p bigint default null) FROM PUBLIC;

