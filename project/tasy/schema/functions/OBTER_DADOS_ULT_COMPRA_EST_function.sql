-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_ult_compra_est ( cd_estabelecimento_p bigint, cd_material_p bigint, ie_retorno_p text) RETURNS varchar AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_sequencia_atual_w		bigint;
cd_material_estoque_w		integer;
cd_material_atual_w		integer;
cd_material_w			integer;
cd_unidade_medida_compra_w	varchar(30);
vl_total_item_nf_w			double precision;
vl_unitario_item_nf_w		double precision;
vl_item_nf_w			double precision;
qt_item_nf_w			double precision;
nr_nota_fiscal_w			varchar(255);
nr_seq_ultima_compra_w		bigint;
nr_ordem_compra_w		bigint;
cd_cgc_emitente_w		varchar(14);
dt_entrada_saida_w		timestamp;
ie_ultima_compra_w		varchar(1);
vl_retorno_w			varchar(100);
qt_item_estoque_w		double precision;
ie_inf_ultima_compra_w		varchar(1);
vl_liquido_w			double precision;
qt_conv_it_est			double precision;
cd_serie_nf_w			nota_fiscal.cd_serie_nf%type;
cd_imob_serie_w			varchar(20);

c01 CURSOR FOR
SELECT	cd_material
from	material
where	cd_material_estoque = cd_material_estoque_w
and	coalesce(ie_inf_ultima_compra,'S') = 'S'
order by	cd_material;


BEGIN

nr_sequencia_w	:= 0;
cd_material_w	:= 0;

select	coalesce(ie_inf_ultima_compra,'S'),
	cd_material_estoque
into STRICT	ie_inf_ultima_compra_w,
	cd_material_estoque_w
from	material
where	cd_material = cd_material_p;

if (ie_inf_ultima_compra_w = 'S') then
	begin

	open c01;
	loop
	fetch c01 into
		cd_material_atual_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select	coalesce(max(nr_seq_nota),0)
		into STRICT	nr_sequencia_atual_w
		from	sup_dados_ultima_compra
		where	cd_material = cd_material_atual_w;

		if (nr_sequencia_atual_w > nr_sequencia_w) then
			nr_sequencia_w	:= nr_sequencia_atual_w;
			cd_material_w	:= cd_material_atual_w;
		end if;

		end;
	end loop;
	close c01;

	if (nr_sequencia_w = 0) then
		begin

		select	coalesce(max(x.nr_sequencia),0)
		into STRICT	nr_sequencia_w
		from	natureza_operacao n,
			operacao_nota o,
			nota_fiscal x,
			nota_fiscal_item y
		where	x.nr_sequencia = y.nr_sequencia
		and	n.cd_natureza_operacao = x.cd_natureza_operacao
		and	x.cd_operacao_nf = o.cd_operacao_nf
		and	n.ie_entrada_saida = 'E'
		and	x.ie_acao_nf = 1
		and	coalesce(o.ie_ultima_compra, 'S') = 'S'
		and	y.cd_material_estoque = cd_material_estoque_w
		and	y.cd_estabelecimento = cd_estabelecimento_p
		and	x.dt_emissao >= clock_timestamp() - interval '90 days';

		if (nr_sequencia_w <> 0) then

			select	coalesce(max(cd_material),0)
			into STRICT	cd_material_w
			from	nota_fiscal_item
			where	nr_sequencia = nr_sequencia_w
			and	cd_material_estoque = cd_material_estoque_w;

		end if;

		end;
	end if;

	if (nr_sequencia_w <> 0) then
		begin

		select	coalesce(max(cd_cgc_emitente),''),
			coalesce(max(dt_entrada_saida),''),
			coalesce(max(somente_numero(nr_nota_fiscal)),0),
			coalesce(max(cd_serie_nf),'')
		into STRICT	cd_cgc_emitente_w,
			dt_entrada_saida_w,
			nr_nota_fiscal_w,
			cd_serie_nf_w
		from	nota_fiscal
		where	nr_sequencia = nr_sequencia_w;

		if (ie_retorno_p = 'VU') then
			begin

			select	coalesce(max(vl_unitario_item_nf),0)
			into STRICT	vl_unitario_item_nf_w
			from	nota_fiscal_item
			where	nr_sequencia = nr_sequencia_w
			and	cd_material = cd_material_w;

			end;
		else
			begin

			select 	max(cd_unidade_medida_compra),
				coalesce(max(vl_total_item_nf),0),
				coalesce(max(nr_ordem_compra),0),
				coalesce(max(qt_item_nf),0),
				coalesce(max(dividir((coalesce(vl_total_item_nf,0) - coalesce(vl_desconto,0) - coalesce(vl_desconto_rateio,0) + coalesce(vl_frete,0) + coalesce(vl_despesa_acessoria,0) + coalesce(vl_seguro,0)),qt_item_nf)),0),
				coalesce(max(qt_item_estoque),0),
				coalesce(max(vl_liquido),0),
				coalesce(max(cd_imob_serie),'')
			into STRICT	cd_unidade_medida_compra_w,
				vl_total_item_nf_w,
				nr_ordem_compra_w,
				qt_item_nf_w,
				vl_item_nf_w,
				qt_item_estoque_w,
				vl_liquido_w,
				cd_imob_serie_w
			from	nota_fiscal_item
			where	nr_sequencia = nr_sequencia_w
			and	cd_material = cd_material_w;

			end;
		end if;

		if (ie_retorno_p = 'UC') then
			vl_retorno_w	:= cd_unidade_medida_compra_w;
		elsif (ie_retorno_p = 'VTI') then
			vl_retorno_w	:= vl_total_item_nf_w;
		elsif (ie_retorno_p = 'VU') then
			vl_retorno_w 	:= vl_unitario_item_nf_w;
		elsif (ie_retorno_p = 'NF') then
			vl_retorno_w 	:= substr(nr_nota_fiscal_w,1,100);
		elsif (ie_retorno_p = 'NFS') then
			vl_retorno_w 	:= nr_sequencia_w;
		elsif (ie_retorno_p = 'PJ') then
			vl_retorno_w	:= cd_cgc_emitente_w;
		elsif (ie_retorno_p = 'DT') then
			vl_retorno_w	:= to_char(dt_entrada_saida_w,'dd/mm/yyyy');
		elsif (ie_retorno_p = 'S') then
			vl_retorno_w	:= cd_serie_nf_w;
		elsif (ie_retorno_p = 'SI') then
			vl_retorno_w	:= cd_imob_serie_w;
		elsif (ie_retorno_p = 'OC') then
			vl_retorno_w	:= to_char(nr_ordem_compra_w);
		elsif (ie_retorno_p = 'MA') then
			vl_retorno_w	:= to_char(cd_material_w);
		elsif (ie_retorno_p = 'C') and (nr_ordem_compra_w > 0) then
			begin

			select	substr(sup_obter_nome_comprador(cd_estabelecimento_p,cd_comprador),1,100)
			into STRICT	vl_retorno_w
			from	ordem_compra
			where	nr_ordem_compra = nr_ordem_compra_w;

			end;
		elsif (ie_retorno_p = 'QT') then
			vl_retorno_w	:= to_char(qt_item_nf_w);
		elsif (ie_retorno_p = 'VI') then
			vl_retorno_w	:= to_char(vl_item_nf_w);
		elsif (ie_retorno_p = 'VE') then
			vl_retorno_w 	:= to_char(dividir(vl_total_item_nf_w, qt_item_estoque_w));
		elsif (ie_retorno_p = 'CM') then
			vl_retorno_w 	:= to_char(dividir(vl_liquido_w, qt_item_estoque_w));
		elsif (ie_retorno_p = 'VEC') then
			vl_retorno_w 	:= to_char(dividir(vl_total_item_nf_w, qt_item_estoque_w));
		end if;

		end;
	end if;

	end;
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_ult_compra_est ( cd_estabelecimento_p bigint, cd_material_p bigint, ie_retorno_p text) FROM PUBLIC;

