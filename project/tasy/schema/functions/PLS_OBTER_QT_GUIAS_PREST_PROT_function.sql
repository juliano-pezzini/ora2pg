-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_qt_guias_prest_prot ( nr_seq_prestador_p bigint, ie_tipo_guia_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ie_tiss_p text) RETURNS bigint AS $body$
DECLARE


/*

  ==========================================================================================================
||				ATENÇÃO						||
||										||
||	Esta function foi criada apenas para uso no relatório RT11 - Qtd. e Valor dos eventos por prestador		||
||										||
   =========================================================================================================

 */
vl_retorno_w	numeric(30) := 0;
qt_guias_w	numeric(30) := 0;


BEGIN

if (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '') then

	if (ie_tipo_guia_p IS NOT NULL AND ie_tipo_guia_p::text <> '') then

		begin

		select	count(a.nr_sequencia)
		into STRICT	qt_guias_w
		from	pls_conta a,
			pls_protocolo_conta b
		where	a.nr_seq_protocolo = b.nr_sequencia
		and	a.nr_seq_prestador_exec = nr_seq_prestador_p
		and	(
			(ie_tipo_guia_p = 5 AND a.ie_tipo_guia = 6)
			or (ie_tipo_guia_p = 4 AND a.ie_tipo_guia = 5)
			or ((ie_tipo_guia_p = 2) and (a.ie_tipo_guia = 4) and (pls_obter_cd_tiss_atendimento(a.nr_seq_tipo_atendimento) <> '04'))
			or ((ie_tipo_guia_p = 1) and (a.ie_tipo_guia = 4) and (pls_obter_cd_tiss_atendimento(a.nr_seq_tipo_atendimento) = '04'))
			or (ie_tipo_guia_p = 1 AND a.ie_tipo_guia = 3)
			)
		/*and	a.ie_tipo_guia = (
						case
							when (ie_tipo_guia_p = 5) then 6
							when (ie_tipo_guia_p = 4) then 5
							when (
								(ie_tipo_guia_p = 2)
								and (a.ie_tipo_guia = 4)
								and (a.nr_seq_tipo_atendimento <> 8)
								) then 4
							when (
								(ie_tipo_guia_p = 1)
								and (a.ie_tipo_guia = 4)
								and (a.nr_seq_tipo_atendimento = 8)
								) then 4
							when (ie_tipo_guia_p = 1) then 3
							else 0
						end
					)*/
		/*and	(
			(a.ie_tipo_guia = ie_tipo_guia_p) or
						(
							(ie_tipo_guia_p = 3) and
							(a.ie_tipo_guia = 4) and
							(pls_obter_cd_tiss_atendimento(a.nr_seq_tipo_atendimento) = '04')
						)
			)*/
		and	(b.dt_mes_competencia >= dt_inicio_p AND b.dt_mes_competencia <= dt_fim_p)
		and	b.ie_situacao in ('A','D','T')
		and	b.ie_tipo_protocolo <> 'R'
		--and	((((b.ie_origem_protocolo = 'E') and (nvl(ie_tiss_p,'N') = 'S')) or (nvl(ie_tiss_p,'N') = 'N'))
		and 	(((a.ie_origem_conta = 'E') and (coalesce(ie_tiss_p,'N') = 'S')) or (coalesce(ie_tiss_p,'N') = 'N'));
		exception
		when others then
			qt_guias_w := 0;
		end;
	end if;
end if;

vl_retorno_w := coalesce(qt_guias_w,0);

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_qt_guias_prest_prot ( nr_seq_prestador_p bigint, ie_tipo_guia_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ie_tiss_p text) FROM PUBLIC;

