-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_day_clasification ( nr_atendimento_p bigint, calculation_date_p timestamp ) RETURNS varchar AS $body$
DECLARE

  /*
  this function is to calculate on the day mealcalculation
  01:meal:nutrition = oral diets excluding special/liquid meal
  02:no meal:  nutrition = fasting or out-of-hospital
  06:meal + special meal (liquid meal):  special meal addition = addition
  or meal type = addition
  or meal type = liquid meal )
  08:overnight stay:nutrition=overnight stay
  */
	ds_return_w varchar(100) := '0';
	ie_tipo_dieta_w cpoe_dieta.ie_tipo_dieta%type;
	ie_dieta_especial_w cpoe_dieta.ie_dieta_especial%type;
	cd_pessoa_fisica_w cpoe_dieta.cd_pessoa_fisica%type;

BEGIN
		select ie_tipo_dieta,
			   ie_dieta_especial,
			   cd_pessoa_fisica
		into STRICT   ie_tipo_dieta_w,
			   ie_dieta_especial_w,
			   cd_pessoa_fisica_w
		from   cpoe_dieta
		where  nr_atendimento = nr_atendimento_p
		and trunc(dt_inicio)  = trunc(calculation_date_p)
		order by dt_atualizacao desc LIMIT 1;
		
    ds_return_w := cpoe_get_type_nutrition_diet(nr_atendimento_p,cd_pessoa_fisica_w,clock_timestamp(),ie_tipo_dieta_w);
		if (ds_return_w = 'O') then
			ds_return_w  := '01';
			/*oral diet*/

		elsif (ds_return_w = 'J') then
			ds_return_w     := '02';
			/*fasting*/

		elsif (ds_return_w = 'SM')then
			ds_return_w     := '06';
			/*special meal*/

		else
			ds_return_w := '08';
			/*over night stay*/

		end if;
		
return ds_return_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_day_clasification ( nr_atendimento_p bigint, calculation_date_p timestamp ) FROM PUBLIC;

