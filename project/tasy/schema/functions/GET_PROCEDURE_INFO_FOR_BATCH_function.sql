-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_procedure_info_for_batch ( nr_sequence_p bigint, nr_batch_p bigint, ie_option_p bigint) RETURNS varchar AS $body$
DECLARE


                
ds_nr_documento_w         bigint;
ds_dt_procedimento_w         timestamp;
ds_cd_procedimento_loc_w     varchar(255);
ds_nr_atendimento_w         bigint;
ds_dt_entrada_w            timestamp;
ds_dt_alta_w             timestamp;
ds_return_w            varchar(255);
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
nr_interno_conta_w	bigint;
nr_seq_nota_w		bigint;
cd_tributo_w		bigint;


 

/*
1-DRG
2-Dt procedure
3- Dt admission 
4-Dt discharge
*/
 


BEGIN

 


select  coalesce(max(nr_documento),0)
into STRICT     ds_nr_documento_w
from    movimento_contabil_doc
where   nm_tabela = 'PROCEDIMENTO_PACIENTE'
and     nr_seq_movimento = nr_sequence_p
and     nr_lote_contabil = nr_batch_p;




begin

 

select  a.dt_procedimento,
        b.cd_procedimento_loc,
	a.nr_atendimento
into STRICT     ds_dt_procedimento_w,
	ds_cd_procedimento_loc_w,
	ds_nr_atendimento_w
from    procedimento_paciente a,
        procedimento b
where   a.cd_procedimento = b.cd_procedimento
and     a.ie_origem_proced = b.ie_origem_proced
and     a.ie_origem_proced = 15 -- DRG
and     a.nr_sequencia = ds_nr_documento_w;



exception
when others then
    ds_dt_procedimento_w := null;
    ds_cd_procedimento_loc_w := null;
    ds_dt_procedimento_w := null;
end;



select  max(a.dt_procedimento),
	max(a.nr_atendimento),
	max(a.cd_procedimento),
	max(a.ie_origem_proced),
	max(a.nr_interno_conta)
into STRICT     ds_dt_procedimento_w,
	ds_nr_atendimento_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	nr_interno_conta_w
from    procedimento_paciente a,
        procedimento b
where   a.cd_procedimento = b.cd_procedimento
and     a.ie_origem_proced = b.ie_origem_proced
and     a.nr_sequencia = ds_nr_documento_w;


begin

 

select    dt_entrada,
    dt_alta 
into STRICT     ds_dt_entrada_w,
    ds_dt_alta_w 
from    atendimento_paciente 
where    nr_atendimento = ds_nr_atendimento_w;



exception
when others then
    ds_dt_entrada_w    := null;
    ds_dt_alta_w    := null;
end;


if (ie_option_p = 1) then
    ds_return_w := ds_cd_procedimento_loc_w;
elsif (ie_option_p = 2) then
    ds_return_w := ds_dt_procedimento_w;
elsif (ie_option_p = 3) then
    ds_return_w := ds_dt_entrada_w;
elsif (ie_option_p = 4) then
    ds_return_w := ds_dt_alta_w;

elsif (ie_option_p	= 5) then

	select	max(nr_sequencia)
	into STRICT	nr_seq_nota_w
	from	nota_fiscal
	where	nr_interno_conta = nr_interno_conta_w;
	
	if (nr_seq_nota_w IS NOT NULL AND nr_seq_nota_w::text <> '') then
		select	max(a.cd_tributo)
		into STRICT	cd_tributo_w
		from	nota_fiscal_item_trib a,
			nota_fiscal_item b
		where	a.nr_sequencia 		= b.nr_sequencia
		and	a.nr_item_nf		= b.nr_item_nf
		and	a.nr_sequencia 		= nr_seq_nota_w
		and	b.cd_procedimento 	= cd_procedimento_w
		and	b.ie_origem_proced	= ie_origem_proced_w;
		
		
		ds_return_w	:= cd_tributo_w;
		
	end if;
	
end if;



return    ds_return_w;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_procedure_info_for_batch ( nr_sequence_p bigint, nr_batch_p bigint, ie_option_p bigint) FROM PUBLIC;

