-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_tempo_restante_def ( nr_seq_ordem_serv_p bigint, nr_seq_sla_p bigint ) RETURNS bigint AS $body$
DECLARE


qt_minutos_rest_w			bigint;


BEGIN

if (nr_seq_ordem_serv_p IS NOT NULL AND nr_seq_ordem_serv_p::text <> '') then

	select (sla.qt_min_termino - sla.qt_minutos)
	into STRICT	qt_minutos_rest_w
	from	(
		SELECT	max(qt_min_termino) 	qt_min_termino,
			coalesce(sum(qt_minutos), 0) qt_minutos
		from	(
				SELECT	msr.qt_min_termino,
					man_obter_tempo_com(
						ml.cd_estabelecimento,
						mose.dt_atualizacao, 
						(	select	coalesce(min(a.dt_atualizacao), clock_timestamp())
							from	man_ordem_serv_estagio a
							where	a.nr_seq_ordem  = mos.nr_sequencia
							and	a.dt_atualizacao > mose.dt_atualizacao), 
						'MC') qt_minutos
				from	man_sla ms,
					man_sla_regra msr,
					man_localizacao ml,
					man_ordem_servico mos,
					man_ordem_serv_estagio mose,
					man_estagio_processo mep
				where	ms.ie_situacao = 'A'
				and	ms.nr_sequencia = msr.nr_seq_sla
				and	msr.ie_prioridade = mos.ie_prioridade
				and	mos.nr_seq_localizacao = ml.nr_sequencia
				and	mos.nr_sequencia = mose.nr_seq_ordem
				and	mose.nr_seq_estagio = mep.nr_sequencia
				and	mos.ie_classificacao = 'E'
				and	((mos.nr_seq_equipamento = msr.nr_seq_equipamento) or (coalesce(msr.nr_seq_equipamento::text, '') = ''))
				and	mos.nr_sequencia = nr_seq_ordem_serv_p
				and	ms.nr_sequencia = nr_seq_sla_p
				and	mep.nr_sequencia not in (2, 261, 1511, 1902, 1341, 511, 9, 121, 41)
				order by
					coalesce(msr.ie_prioridade, ' '), msr.nr_seq_sla) alias16
		group by
			qt_min_termino) sla;

end if;

return	qt_minutos_rest_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_tempo_restante_def ( nr_seq_ordem_serv_p bigint, nr_seq_sla_p bigint ) FROM PUBLIC;

