-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION far_obter_qtde_disp_venda (cd_material_p bigint, cd_local_estoque_p bigint) RETURNS bigint AS $body$
DECLARE


qt_reserva_w			double precision;
qt_retorno_w			double precision;
qt_disp_estoque_w		double precision;
cd_estabelecimento_w		smallint := wheb_usuario_pck.get_cd_estabelecimento;
qt_conv_estoque_venda_w		double precision;
cd_unidade_medida_venda_w	varchar(30);
qt_reg_w				bigint;


BEGIN
select	count(*)
into STRICT	qt_reg_w
from	material_estab
where	cd_material = cd_material_p
and	cd_estabelecimento = cd_estabelecimento_w;


if (qt_reg_w > 0) then
	begin

	select	coalesce(b.cd_unidade_venda,a.cd_unidade_medida_consumo),
		coalesce(b.qt_conv_estoque_venda,a.qt_conv_estoque_consumo)
	into STRICT	cd_unidade_medida_venda_w,
		qt_conv_estoque_venda_w
	from 	material a,
		material_estab b
	where	a.cd_material = cd_material_p
	and	b.cd_material = a.cd_material
	and	b.cd_estabelecimento = cd_estabelecimento_w;

	end;
else
	select	max(cd_unidade_medida_consumo),
		max(qt_conv_estoque_consumo)
	into STRICT	cd_unidade_medida_venda_w,
		qt_conv_estoque_venda_w
	from	material
	where	cd_material = cd_material_p;

end if;

select	coalesce(sum(qt_material),0)
into STRICT	qt_reserva_w
from	far_reserva_mat
where	cd_material = cd_material_p
and	cd_estabelecimento = cd_estabelecimento_w
and (cd_local_estoque = coalesce(cd_local_estoque_p,0) or coalesce(cd_local_estoque_p,0) = 0)
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	coalesce(dt_baixa::text, '') = '';

select	obter_saldo_disp_estoque(cd_estabelecimento_w, cd_material_p, cd_local_estoque_p, clock_timestamp())
into STRICT	qt_disp_estoque_w
;

qt_retorno_w	:= (qt_disp_estoque_w * qt_conv_estoque_venda_w);
qt_retorno_w	:= (qt_retorno_w - qt_reserva_w);

return	qt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION far_obter_qtde_disp_venda (cd_material_p bigint, cd_local_estoque_p bigint) FROM PUBLIC;

