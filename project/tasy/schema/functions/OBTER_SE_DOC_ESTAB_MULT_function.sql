-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_doc_estab_mult ( nr_seq_doc_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE



ds_retorno_w			varchar(1):= 'N';
qt_estab_w			bigint;
qt_exclusivo_w			bigint;
cd_estab_w			smallint := wheb_usuario_pck.get_cd_estabelecimento;
cd_estab_doc_w			smallint;
ie_consid_lib_sem_regra_w	varchar(15);


BEGIN
ie_consid_lib_sem_regra_w := obter_param_usuario(4000, 199, obter_perfil_ativo, nm_usuario_p, cd_estab_w, ie_consid_lib_sem_regra_w);

select	count(*)
into STRICT	qt_estab_w
from	qua_doc_lib_estab
where	nr_seq_doc = nr_seq_doc_p;

/*Se não possui liberação por estabelecimento, verifica parâmetro*/

if (qt_estab_w = 0) then
	begin
	/*Se não considera como liberado sem regra, retorna N, senão S*/

	if (coalesce(ie_consid_lib_sem_regra_w,'N') = 'N') then
		ds_retorno_w:= 'N';
	else
		ds_retorno_w:= 'S';
	end if;
	end;
elsif (qt_estab_w > 1) then
	/*Se possui mais de um estabelecimento liberado, retorna S*/

	ds_retorno_w:= 'S';
else
	/*Se possui apenas um estabelecimento liberado, verifica se é o mesmo do documento, senão são dois (estab doc mais estab liberado)*/

	begin
	select 	CASE WHEN count(distinct(cd_estabelecimento))=1 THEN 'N'  ELSE 'S' END
	into STRICT	ds_retorno_w
	from (
		SELECT	cd_estabelecimento
		from	qua_documento
		where	nr_sequencia = nr_seq_doc_p
		
union all

		SELECT	cd_estabelecimento
		from	qua_doc_lib_estab
		where	nr_seq_doc = nr_seq_doc_p) alias2;
	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_doc_estab_mult ( nr_seq_doc_p bigint, nm_usuario_p text) FROM PUBLIC;

