-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_medico_externo ( cd_pessoa_fisica_paciente_p text, cd_opcao_p text ) RETURNS varchar AS $body$
DECLARE


/*

  N - Nome
  T - Telefone
  E - Endereco
  C - Cidade
  ESP - Especialidade

*/
dado_medico_w               varchar(255):='';
nr_seq_med_externo_w        numeric(38);



BEGIN

if (cd_pessoa_fisica_paciente_p IS NOT NULL AND cd_pessoa_fisica_paciente_p::text <> '')then

  if (cd_opcao_p = 'N')then
    select max(nr_sequencia)
    into STRICT nr_seq_med_externo_w
    from pf_medico_externo pme
    where pme.cd_pessoa_fisica = cd_pessoa_fisica_paciente_p
    and exists (SELECT 1
               from tipo_medico_externo tme
               where pme.NR_SEQ_TIPO_MEDICO = tme.nr_sequencia
               and tme.IE_MEDICO_FAMILIA = 'S');

    select  max(substr(obter_nome_medico(cd_medico, 'N'),1,255))
    into STRICT dado_medico_w
    from  pf_medico_externo pme	
    where	pme.cd_medico = (SELECT max(cd_medico)
                           from pf_medico_externo pme
                           where pme.nr_sequencia = nr_seq_med_externo_w);
  end if;

    if (cd_opcao_p = 'T')then  
   select max(nr_sequencia) 
   into STRICT nr_seq_med_externo_w
    from pf_medico_externo pme
    where pme.cd_pessoa_fisica = cd_pessoa_fisica_paciente_p
    and exists (SELECT 1 
               from tipo_medico_externo tme
               where pme.NR_SEQ_TIPO_MEDICO = tme.nr_sequencia
               and tme.IE_MEDICO_FAMILIA = 'S');

    select nr_telefone_celular
    into STRICT dado_medico_w
    from pessoa_fisica pf
    where pf.cd_pessoa_fisica = (SELECT max(cd_medico) 
                           from pf_medico_externo pme
                           where pme.nr_sequencia = nr_seq_med_externo_w);
  end if;

  if (cd_opcao_p = 'E')then
   select max(nr_sequencia)
   into STRICT nr_seq_med_externo_w
    from pf_medico_externo pme
    where pme.cd_pessoa_fisica = cd_pessoa_fisica_paciente_p
    and exists (SELECT 1
               from tipo_medico_externo tme
               where pme.NR_SEQ_TIPO_MEDICO = tme.nr_sequencia
               and tme.IE_MEDICO_FAMILIA = 'S');

   select substr((
      CASE WHEN coalesce(compl.ds_endereco::text, '') = '' THEN  null  ELSE compl.ds_endereco || ', ' END  ||
      CASE WHEN coalesce(compl.DS_COMPL_END::text, '') = '' THEN  null  ELSE compl.DS_COMPL_END || ', ' END  ||
      CASE WHEN coalesce(compl.ds_municipio::text, '') = '' THEN  null  ELSE compl.ds_municipio || ', ' END  ||
      CASE WHEN coalesce(compl.CD_CEP::text, '') = '' THEN  null  ELSE compl.CD_CEP || ', ' END ), 0,  length(CASE WHEN coalesce(compl.ds_endereco::text, '') = '' THEN  null  ELSE compl.ds_endereco || ', ' END  ||
      CASE WHEN coalesce(compl.DS_COMPL_END::text, '') = '' THEN  null  ELSE compl.DS_COMPL_END || ', ' END  ||
      CASE WHEN coalesce(compl.ds_municipio::text, '') = '' THEN  null  ELSE compl.ds_municipio || ', ' END  ||
      CASE WHEN coalesce(compl.CD_CEP::text, '') = '' THEN  null  ELSE compl.CD_CEP || ', ' END) -2)
    into STRICT dado_medico_w
    from compl_pessoa_fisica compl
    where compl.cd_pessoa_fisica = (SELECT max(pme.cd_medico)
                           from pf_medico_externo pme
                           where pme.nr_sequencia = nr_seq_med_externo_w);
  end if;

    if (cd_opcao_p = 'C')then
   select max(nr_sequencia)
   into STRICT nr_seq_med_externo_w
    from pf_medico_externo pme
    where pme.cd_pessoa_fisica = cd_pessoa_fisica_paciente_p
    and exists (SELECT 1
               from tipo_medico_externo tme
               where pme.NR_SEQ_TIPO_MEDICO = tme.nr_sequencia
               and tme.IE_MEDICO_FAMILIA = 'S');
select max(compl.DS_MUNICIPIO)
 into STRICT dado_medico_w
      from compl_pessoa_fisica compl
      where compl.cd_pessoa_fisica = 
     (SELECT max(pme.cd_medico)
                           from pf_medico_externo pme
                           where pme.nr_sequencia = nr_seq_med_externo_w);
  end if;
      if (cd_opcao_p = 'ESP')then
       select max(nr_sequencia)
       into STRICT nr_seq_med_externo_w
        from pf_medico_externo pme
        where pme.cd_pessoa_fisica = cd_pessoa_fisica_paciente_p
        and exists (SELECT 1
                   from tipo_medico_externo tme
                   where pme.NR_SEQ_TIPO_MEDICO = tme.nr_sequencia
                   and tme.IE_MEDICO_FAMILIA = 'S');

        select 	b.ds_especialidade
            into STRICT dado_medico_w
            from 	especialidade_medica b,
             medico_especialidade a
            where 	a.cd_especialidade	= b.cd_especialidade
            and a.cd_pessoa_fisica	= (SELECT max(pme.cd_medico)
                                   from pf_medico_externo pme
                                   where pme.nr_sequencia = nr_seq_med_externo_w);
      end if;

end if;

return  dado_medico_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_medico_externo ( cd_pessoa_fisica_paciente_p text, cd_opcao_p text ) FROM PUBLIC;

