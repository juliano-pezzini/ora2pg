-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_escala_mapa_setor (cd_setor_atendimento_p bigint, nr_seq_interno_p bigint) RETURNS varchar AS $body$
DECLARE


ds_escalas_w			varchar(4000);

ie_escala_1_w			varchar(15);
ds_escala_1_w			varchar(255);

ie_escala_2_w			varchar(15);
ds_escala_2_w			varchar(255);

ie_escala_3_w			varchar(15);
ds_escala_3_w			varchar(255);

ie_escala_4_w			varchar(15);
ds_escala_4_w			varchar(255);

nr_atendimento_w 		bigint;

ie_opcao_w			varchar(10);
ds_valor_escala_w		varchar(255);


BEGIN

select	max(nr_atendimento)
into STRICT	nr_atendimento_w
from	UNIDADE_ATENDIMENTO
where	nr_seq_interno = nr_seq_interno_p;

select	max(ie_complexidade_assit),
	max(substr(obter_valor_dominio(1893, ie_complexidade_assit),1,255)) ds_complexidade_assist,
	max(ie_complexidade_assit2),
	max(substr(obter_valor_dominio(1893, ie_complexidade_assit2),1,255)) ds_complexidade_assist2,
	max(ie_complexidade_assit3),
	max(substr(obter_valor_dominio(1893, ie_complexidade_assit3),1,255)) ds_complexidade_assist3,
	max(ie_complexidade_assit4),
	max(substr(obter_valor_dominio(1893, ie_complexidade_assit4),1,255)) ds_complexidade_assist4
into STRICT	ie_escala_1_w,
	ds_escala_1_w,
	ie_escala_2_w,
	ds_escala_2_w,
	ie_escala_3_w,
	ds_escala_3_w,
	ie_escala_4_w,
	ds_escala_4_w
from	SETOR_ATENDIMENTO
where	cd_setor_atendimento = cd_setor_atendimento_p;

if (ie_escala_1_w IS NOT NULL AND ie_escala_1_w::text <> '') then
	if (ie_escala_1_w = 'E') then
		ie_opcao_w	:= 'GSD';
	else
		ie_opcao_w	:= 'G';
	end if;

	ds_valor_escala_w	:= SUBSTR(obter_complexidade_assist(nr_atendimento_w, cd_setor_atendimento_p, ie_opcao_w, '1'),1,100);

	if (ds_valor_escala_w IS NOT NULL AND ds_valor_escala_w::text <> '') then
		ds_escalas_w:= ds_escalas_w || ds_escala_1_w || ': ' || ds_valor_escala_w || '<br>';
	end if;
end if;

if (ie_escala_2_w IS NOT NULL AND ie_escala_2_w::text <> '') then
	if (ie_escala_2_w = 'E') then
		ie_opcao_w	:= 'GSD';
	else
		ie_opcao_w	:= 'G';
	end if;

	ds_valor_escala_w	:= SUBSTR(obter_complexidade_assist(nr_atendimento_w, cd_setor_atendimento_p, ie_opcao_w,'2'),1,100);

	if (ds_valor_escala_w IS NOT NULL AND ds_valor_escala_w::text <> '') then
		ds_escalas_w:= ds_escalas_w || ds_escala_2_w || ': ' || ds_valor_escala_w || '<br>';
	end if;
end if;

if (ie_escala_3_w IS NOT NULL AND ie_escala_3_w::text <> '') then
	if (ie_escala_3_w = 'E') then
		ie_opcao_w	:= 'GSD';
	else
		ie_opcao_w	:= 'G';
	end if;

	ds_valor_escala_w	:= SUBSTR(obter_complexidade_assist(nr_atendimento_w, cd_setor_atendimento_p, ie_opcao_w,'3'),1,100);

	if (ds_valor_escala_w IS NOT NULL AND ds_valor_escala_w::text <> '') then
		ds_escalas_w:= ds_escalas_w || ds_escala_3_w || ': ' || ds_valor_escala_w || '<br>';
	end if;
end if;

if (ie_escala_4_w IS NOT NULL AND ie_escala_4_w::text <> '') then
	if (ie_escala_4_w = 'E') then
		ie_opcao_w	:= 'GSD';
	else
		ie_opcao_w	:= 'G';
	end if;

	ds_valor_escala_w	:= SUBSTR(obter_complexidade_assist(nr_atendimento_w, cd_setor_atendimento_p, ie_opcao_w,'4'),1,100);

	if (ds_valor_escala_w IS NOT NULL AND ds_valor_escala_w::text <> '') then
		ds_escalas_w:= ds_escalas_w || ds_escala_4_w || ': ' || ds_valor_escala_w;
	end if;
end if;

return ds_escalas_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_escala_mapa_setor (cd_setor_atendimento_p bigint, nr_seq_interno_p bigint) FROM PUBLIC;

