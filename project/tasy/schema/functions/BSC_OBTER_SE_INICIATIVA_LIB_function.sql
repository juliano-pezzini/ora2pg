-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION bsc_obter_se_iniciativa_lib ( cd_estabelecimento_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ie_permissao_acesso_p text default null) RETURNS varchar AS $body$
DECLARE


cd_pessoa_fisica_usuario_w		varchar(10);
ie_permissao_acesso_w		varchar(15);
ie_permite_w			varchar(1) := 'S';
ie_regra_w			varchar(1);
i				integer;
cd_pf_resp_w			varchar(15);
nr_grupo_trabalho_w		man_grupo_trabalho.nr_sequencia%type;


BEGIN

if (coalesce(ie_permissao_acesso_p::text, '') = '') then

	ie_permissao_acesso_w	:= coalesce(obter_valor_param_usuario(7024, 27, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p), 'N');
else
	ie_permissao_acesso_w	:= ie_permissao_acesso_p;
end if;

if (ie_permissao_acesso_w not in ('N','S')) then

	cd_pessoa_fisica_usuario_w	:= substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10);
	ie_permite_w			:= 'N';
	for i in 1..length(ie_permissao_acesso_w) loop
		begin
		ie_regra_w		:= substr(ie_permissao_acesso_w,i,1);

		if	((ie_regra_w = 'O') or (ie_regra_w = 'M')) and (ie_permite_w = 'N') then
			
			select	coalesce(max('S'),'N')
			into STRICT	ie_permite_w
			from	man_ordem_servico
			where	cd_pessoa_solicitante	= cd_pessoa_fisica_usuario_w
			and	nr_sequencia		= nr_sequencia_p;
		end if;

		if	((ie_regra_w = 'R') or (ie_regra_w = 'M')) and (ie_permite_w = 'N') then
			
			select	coalesce(max('S'),'N')
			into STRICT	ie_permite_w
			from	man_ordem_servico
			where	cd_pf_resp_bsc		= cd_pessoa_fisica_usuario_w
			and	nr_sequencia		= nr_sequencia_p;
		end if;

		if	((ie_regra_w = 'E') or (ie_regra_w = 'M')) and (ie_permite_w = 'N') then
			
			select	coalesce(max('S'),'N')
			into STRICT	ie_permite_w
			from	man_ordem_servico_exec
			where	nm_usuario_exec		= nm_usuario_p
			and	nr_seq_ordem		= nr_sequencia_p;
		end if;
		
		if	((ie_regra_w = 'P') or (ie_regra_w = 'M')) and (ie_permite_w = 'N') then
			begin			
			
			select	coalesce(max('S'),'N')
			into STRICT	ie_permite_w
			from	ple_objetivo a,
				man_ordem_servico b
			where	a.nr_sequencia = b.nr_seq_obj_bsc
			and 	a.cd_pf_resp = cd_pessoa_fisica_usuario_w
			and	b.nr_sequencia = nr_sequencia_p;
			end;
		end if;
		
		if	((ie_regra_w = 'G') or (ie_regra_w = 'M')) and (ie_permite_w = 'N') then
			
			select	nr_seq_grupo_trab
			into STRICT	nr_grupo_trabalho_w
			from	man_grupo_trab_usuario
			where	NM_USUARIO_PARAM = nm_usuario_p
			and	nr_seq_grupo_trab = 
				(SELECT	nr_grupo_trabalho			
				from	man_ordem_servico
				where	nr_sequencia = nr_sequencia_p);			

			if (coalesce(nr_grupo_trabalho_w, 0) <> 0) then
				ie_permite_w := 'S';
			end if;
		
		end if;
		
		end;
	end loop;

else
	ie_permite_w	:= substr(ie_permissao_acesso_w,1,1);
end if;

return	ie_permite_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION bsc_obter_se_iniciativa_lib ( cd_estabelecimento_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ie_permissao_acesso_p text default null) FROM PUBLIC;

