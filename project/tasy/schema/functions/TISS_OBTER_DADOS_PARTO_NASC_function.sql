-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tiss_obter_dados_parto_nasc ( nr_atendimento_P bigint, qt_baixo_peso_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_W		varchar(2);
nr_seq_nascimento_w	smallint;
qt_peso_W		bigint;
cont_w			bigint;
cont_atermo_w		bigint;
qt_obito_pre_w		bigint;
qt_obito_tardio_w	bigint;
ie_gestacao_w		varchar(2);
ie_aborto_w		varchar(2);
ie_transtorno_w		varchar(2);
ie_atend_rn_w		varchar(2);
ie_complic_puerperio_w	varchar(2);
ie_complic_neonatal_w	varchar(2);
ie_baixo_peso_w		varchar(2);
ie_parto_cesaria_w		varchar(2);
ie_parto_normal_w		varchar(2);


BEGIN

/*
G - Gestação
A - Aborto
T - Transtorno
P - Complicação puerpério
N - Complicação neonatal
B - Baixo_peso
C - Parto cesária
R - Parto normal
S - Atendimento ao RN na sala de parto
QT - Quantidade de nascidos vivos prematuros
QTA - Quantidade de nascidos vivos a termo / pos termo
QTP - Quantidade de óbito neonatal precoce
QTT - Quantidade de óbito neonatal tardio
*/
select	max(nr_sequencia)
into STRICT	nr_seq_nascimento_w
from	nascimento
where	nr_atendimento	= nr_atendimento_p;

select	count(*)
into STRICT	cont_w
from	nascimento
where	nr_atendimento		= nr_atendimento_p
and	ie_tipo_nascimento	= 3;

select	count(*)
into STRICT	cont_atermo_w
from	nascimento
where	nr_atendimento		= nr_atendimento_p
and	ie_tipo_nascimento	in (4,10);

if (coalesce(nr_seq_nascimento_w, 0) > 0) then

	select	max(qt_peso)
	into STRICT	qt_peso_w
	from	nascimento
	where	nr_atendimento	= nr_atendimento_p
	and	nr_sequencia	= nr_seq_nascimento_w;

	if (coalesce(qt_peso_w, 0) < coalesce(qt_baixo_peso_p,0)) then
		ie_baixo_peso_w	:= '1';
	else
		ie_baixo_peso_w	:= '0';

	end if;

	select	max(CASE WHEN n.ie_tipo_nascimento='1' THEN  '1'  ELSE '0' END ) ie_gestacao,
		max(CASE WHEN n.ie_tipo_nascimento='2' THEN  '1'  ELSE '0' END ) ie_aborto,
		max(CASE WHEN n.ie_tipo_nascimento='6' THEN  '1'  ELSE '0' END ) ie_transtorno,
		max(CASE WHEN coalesce(n.cd_pediatra::text, '') = '' THEN  '0'  ELSE '1' END ) ie_atend_rn_sala_parto,
		max(CASE WHEN n.ie_tipo_nascimento='8' THEN  1  ELSE 0 END ) qt_obito_pre,
		max(CASE WHEN n.ie_tipo_nascimento='7' THEN  1  ELSE 0 END ) qt_obito_tardio
	into STRICT	ie_gestacao_w,
		ie_aborto_w,
		ie_transtorno_w,
		ie_atend_rn_w,
		qt_obito_pre_w,
		qt_obito_tardio_w
	from	nascimento n
	where	nr_atendimento	= nr_atendimento_p
	and	nr_sequencia	= nr_seq_nascimento_w;

	select	max(CASE WHEN coalesce(e.ds_complicacao::text, '') = '' THEN  '0'  ELSE '1' END )
	into STRICT	ie_complic_neonatal_w
	from	nascimento_evento e
	where	nr_atendimento		= nr_atendimento_p
	and	nr_seq_nascimento	= nr_seq_nascimento_w;

	if (coalesce(ie_complic_neonatal_w::text, '') = '') then
		ie_complic_neonatal_w	:= '0';
	end if;

end if;

select	max(CASE WHEN ie_parto_cesaria='S' THEN  1  ELSE 0 END ),
	max(CASE WHEN ie_parto_normal='S' THEN  1  ELSE 0 END )
into STRICT	ie_parto_cesaria_w,
	ie_parto_normal_w
from	parto
where	nr_atendimento	= nr_atendimento_p;

select	max(CASE WHEN coalesce(ds_complicacao::text, '') = '' THEN  '0'  ELSE '1' END )
into STRICT	ie_complic_puerperio_w
from	parto_eventos
where	nr_atendimento	= nr_atendimento_p;

if (coalesce(ie_complic_puerperio_w::text, '') = '') then
	ie_complic_puerperio_w	:= '0';
end if;

if (ie_opcao_p = 'G') then
	ds_retorno_w	:= ie_gestacao_w;
elsif (ie_opcao_p = 'A') then
	ds_retorno_w	:= ie_aborto_w;
elsif (ie_opcao_p = 'T') then
	ds_retorno_w	:= ie_transtorno_w;
elsif (ie_opcao_p = 'P') then
	ds_retorno_w	:= ie_complic_puerperio_w;
elsif (ie_opcao_p = 'N') then
	ds_retorno_w	:= ie_complic_neonatal_w;
elsif (ie_opcao_p = 'B') then
	ds_retorno_w	:= ie_baixo_peso_w;
elsif (ie_opcao_p = 'C') then
	ds_retorno_w	:= ie_parto_cesaria_w;
elsif (ie_opcao_p = 'R') then
	ds_retorno_w	:= ie_parto_normal_w;
elsif (ie_opcao_p = 'QT') then
	ds_retorno_w	:= to_char(cont_w);
elsif (ie_opcao_p = 'QTA') then
	ds_retorno_w	:= to_char(cont_atermo_w);
elsif (ie_opcao_p = 'QTP') then
	ds_retorno_w	:= to_char(qt_obito_pre_w);
elsif (ie_opcao_p = 'QTT') then
	ds_retorno_w	:= to_char(qt_obito_tardio_w);
else
	ds_retorno_w	:= ie_atend_rn_w;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_obter_dados_parto_nasc ( nr_atendimento_P bigint, qt_baixo_peso_p bigint, ie_opcao_p text) FROM PUBLIC;

