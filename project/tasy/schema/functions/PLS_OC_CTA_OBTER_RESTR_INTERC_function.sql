-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_oc_cta_obter_restr_interc ( ie_opcao_p text, dados_regra_p pls_tipos_ocor_pck.dados_regra, cursor_p integer, dados_filtro_interc_p pls_tipos_ocor_pck.dados_filtro_interc) RETURNS varchar AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Responsável por montar as restrições e atualizar as binds durante a execução do
	select para aplicação dos filtros de intercâmbio.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

Alterações:
------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_restricao_w		varchar(4000);
ds_select_interc_w	varchar(4000);
ds_filtro_interc_w	varchar(4000);

BEGIN

--Inicializar as variáveis.
ds_filtro_interc_w	:= null;
ds_restricao_w		:= null;

-- Montar o subselect base.
ds_select_interc_w :=	pls_tipos_ocor_pck.enter_w ||
			'and	exists ('||pls_tipos_ocor_pck.enter_w||
			'		select	1 '||pls_tipos_ocor_pck.enter_w||
			'		from	pls_conta_intercambio_v interc '||pls_tipos_ocor_pck.enter_w||
			'		where	interc.nr_sequencia = conta.nr_sequencia ';

-- Tipo de contrato de Intercâmbio
if (dados_filtro_interc_p.ie_tipo_contrato_intercambio IS NOT NULL AND dados_filtro_interc_p.ie_tipo_contrato_intercambio::text <> '') then

	if (ie_opcao_p = 'RESTRICAO') then

		ds_filtro_interc_w :=	ds_filtro_interc_w|| pls_tipos_ocor_pck.enter_w ||
					'		and	interc.ie_tipo_contrato = :ie_tipo_contrato_intercambio ';
	else
		dbms_sql.bind_variable(cursor_p, ':ie_tipo_contrato_intercambio', dados_filtro_interc_p.ie_tipo_contrato_intercambio);
	end if;
end if;

-- Tipo de intercâmbio (Nacional ou Estadual) Só  adiciona a restrição se ele for diferente de A (Ambos), caso ele seja igual a A ou nulo então não deve ser adicionado a restrição
if (dados_filtro_interc_p.ie_tipo_intercambio <> 'A') then

	if (ie_opcao_p = 'RESTRICAO') then

		ds_filtro_interc_w :=	ds_filtro_interc_w || pls_tipos_ocor_pck.enter_w ||
					'		and	interc.ie_tipo_intercambio = :ie_tipo_intercambio ';
	else
		dbms_sql.bind_variable(cursor_p, ':ie_tipo_intercambio',dados_filtro_interc_p.ie_tipo_intercambio);
	end if;
end if;

-- Congenere da conta de Intercâmbrio
if (dados_filtro_interc_p.nr_seq_congenere IS NOT NULL AND dados_filtro_interc_p.nr_seq_congenere::text <> '') then

	if (ie_opcao_p = 'RESTRICAO') then

		ds_filtro_interc_w :=	ds_filtro_interc_w|| pls_tipos_ocor_pck.enter_w ||
					'		and	interc.nr_seq_congenere = :nr_seq_congenere ';
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_congenere', dados_filtro_interc_p.nr_seq_congenere);
	end if;
end if;

-- Contrato de Intercâmbio
if (dados_filtro_interc_p.nr_seq_intercambio IS NOT NULL AND dados_filtro_interc_p.nr_seq_intercambio::text <> '') then

	if (ie_opcao_p = 'RESTRICAO') then

		ds_filtro_interc_w :=	ds_filtro_interc_w|| pls_tipos_ocor_pck.enter_w ||
					'		and	interc.nr_seq_intercambio = :nr_seq_intercambio ';
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_intercambio', dados_filtro_interc_p.nr_seq_intercambio);
	end if;
end if;

-- Estado da Operadora Congênere
if (dados_filtro_interc_p.sg_estado_operadora IS NOT NULL AND dados_filtro_interc_p.sg_estado_operadora::text <> '') then

	if (ie_opcao_p = 'RESTRICAO') then

		ds_filtro_interc_w :=	ds_filtro_interc_w || pls_tipos_ocor_pck.enter_w  ||
					'		and	interc.sg_estado_congenere = :sg_estado_operadora ';
	else
		dbms_sql.bind_variable(cursor_p, ':sg_estado_operadora', dados_filtro_interc_p.sg_estado_operadora);
	end if;
end if;

-- Só retorna algo se teve algum campo informado.
if (ds_filtro_interc_w IS NOT NULL AND ds_filtro_interc_w::text <> '') then

	ds_restricao_w := ds_select_interc_w || ds_filtro_interc_w ||'		)';
end if;

return	ds_restricao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_oc_cta_obter_restr_interc ( ie_opcao_p text, dados_regra_p pls_tipos_ocor_pck.dados_regra, cursor_p integer, dados_filtro_interc_p pls_tipos_ocor_pck.dados_filtro_interc) FROM PUBLIC;

