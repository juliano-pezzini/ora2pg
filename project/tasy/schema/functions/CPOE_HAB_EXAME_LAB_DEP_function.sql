-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_hab_exame_lab_dep ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nr_seq_proc_interno_p exame_laboratorio.nr_seq_proc_interno%type, nr_seq_rotina_p exame_lab_rotina.nr_seq_exame%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_exame_dep_p exame_lab_dependente.nr_seq_exame_dep%type, cd_material_exame_p material_exame_lab.cd_material_exame%type, ds_opcao_p text ) RETURNS varchar AS $body$
DECLARE


	ds_retorno_w				varchar(1) := 'N';
	dt_vigencia_w				timestamp := clock_timestamp();
    cd_convenio_w				atend_categoria_convenio.cd_convenio%type;
	cd_plano_convenio_w			atend_categoria_convenio.cd_plano_convenio%type;
    cd_categoria_w				atend_categoria_convenio.cd_categoria%type;
	nr_seq_material_prescr_w	material_exame_lab.nr_sequencia%type;
	ie_origem_proced_cursor_w	exame_laboratorio.ie_origem_proced%type;
	ie_origem_proced_sus_w		exame_laboratorio.ie_origem_proced%type;
	ie_origem_proced_w			exame_laboratorio.ie_origem_proced%type;
	nr_seq_exame_w				exame_lab_dependente.nr_seq_exame_dep%type;
	ie_tipo_atendimento_w 		atendimento_Paciente.ie_tipo_atendimento%type;
	ie_tipo_convenio_w			convenio.ie_tipo_convenio%type;
	cd_edicao_amb_w				convenio_amb.cd_edicao_amb%type;


BEGIN
    if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

		SELECT * FROM CPOE_Obter_Param_Exame_Dep(	nr_atendimento_p, cd_estabelecimento_p, nr_seq_proc_interno_p, nr_seq_rotina_p, cd_material_exame_p, cd_convenio_w, cd_plano_convenio_w, cd_categoria_w, nr_seq_material_prescr_w, ie_origem_proced_cursor_w, ie_origem_proced_sus_w, ie_origem_proced_w, nr_seq_exame_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_edicao_amb_w) INTO STRICT cd_convenio_w, cd_plano_convenio_w, cd_categoria_w, nr_seq_material_prescr_w, ie_origem_proced_cursor_w, ie_origem_proced_sus_w, ie_origem_proced_w, nr_seq_exame_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_edicao_amb_w;

		select	coalesce(max('S'), 'N')
		  into STRICT	ds_retorno_w
		  FROM table(lista_pck.obter_lista(ds_opcao_p)) d, exame_laboratorio c, exame_lab_dependente a
LEFT OUTER JOIN exame_lab_convenio b ON (a.nr_seq_exame_dep = b.nr_seq_exame AND ie_origem_proced_w = b.ie_origem_proced)
WHERE d.nr_registro = a.ie_geracao  and a.nr_seq_exame_dep = c.nr_seq_exame  and a.nr_seq_exame = nr_seq_exame_w and ((c.nr_seq_proc_interno IS NOT NULL AND c.nr_seq_proc_interno::text <> '') or exists (SELECT 1
																  from proc_interno x
																 where x.nr_seq_exame_lab = c.nr_seq_exame)) and coalesce(a.cd_convenio, cd_convenio_w) = cd_convenio_w and coalesce(a.cd_setor_atendimento, cd_setor_atendimento_p) = cd_setor_atendimento_p  and (((a.nr_seq_exame_dep = c.nr_seq_exame) and (coalesce(nr_seq_exame_dep_p::text, '') = '')) or
				 ((nr_seq_exame_dep_p IS NOT NULL AND nr_seq_exame_dep_p::text <> '') and (a.nr_seq_exame_dep = nr_seq_exame_dep_p) and (a.nr_seq_exame_dep = c.nr_seq_exame))) and coalesce(a.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p and coalesce(a.cd_setor_prescricao, cd_setor_atendimento_p) = cd_setor_atendimento_p and coalesce(a.nr_seq_material_regra, nr_seq_material_prescr_w) = nr_seq_material_prescr_w    and coalesce(c.ie_situacao, 'A') = 'A'   and ((((ie_origem_proced_sus_w not in (2, 3)) or (b.ie_origem_proced = ie_origem_proced_sus_w)) and (coalesce(b.ie_origem_proced_regra::text, '') = '')) or 
				 (b.ie_origem_proced_regra IS NOT NULL AND b.ie_origem_proced_regra::text <> '' AND b.ie_origem_proced_regra = ie_origem_proced_cursor_w))     order by coalesce(a.cd_convenio, cd_convenio_w),
				  coalesce(a.cd_setor_atendimento, cd_setor_atendimento_p), 
				  a.nr_seq_exame_dep;
    end if;
	
	return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_hab_exame_lab_dep ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nr_seq_proc_interno_p exame_laboratorio.nr_seq_proc_interno%type, nr_seq_rotina_p exame_lab_rotina.nr_seq_exame%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_exame_dep_p exame_lab_dependente.nr_seq_exame_dep%type, cd_material_exame_p material_exame_lab.cd_material_exame%type, ds_opcao_p text ) FROM PUBLIC;

