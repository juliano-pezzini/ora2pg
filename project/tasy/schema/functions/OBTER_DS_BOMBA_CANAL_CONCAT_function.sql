-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ds_bomba_canal_concat ( nr_prescricao_p bomba_infusao.nr_prescricao%type, nr_atendimento_p bomba_infusao.nr_atendimento%type, nr_sequencia_p prescr_solucao_evento.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE

	
c01 CURSOR FOR
	SELECT	bi.nr_seq_equipamento nr_seq_equipamento,
		bi.nr_seq_canal_bomba nr_seq_canal_bomba
	from    prescr_solucao_evento e,
		bomba_infusao bi
	where   bi.nr_sequencia = e.nr_seq_bomba_event
	and     e.nr_atendimento = nr_atendimento_p
	and     e.nr_sequencia = nr_sequencia_p;
c01_w		c01%rowtype;


ds_equipamento_w	man_equipamento.ds_equipamento%type	:= null;
ds_canal_bomba_w	man_equipamento_bomba.ds_descricao%type	:= null;
ds_bomba_canal_w	man_equipamento.ds_endereco%type;
ds_return_w		man_equipamento.ds_endereco%type;


BEGIN

open c01;
loop
fetch c01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	if (c01_w.nr_seq_equipamento IS NOT NULL AND c01_w.nr_seq_equipamento::text <> '') then
		begin
		
		begin
			select	ds_equipamento
			into STRICT	ds_equipamento_w
			from	man_equipamento a
			where	a.nr_sequencia = c01_w.nr_seq_equipamento;
		exception
		when no_data_found then
			ds_equipamento_w := null;
		when too_many_rows then raise;
		end;
		
		ds_bomba_canal_w := ds_equipamento_w;
		
		if (c01_w.nr_seq_canal_bomba IS NOT NULL AND c01_w.nr_seq_canal_bomba::text <> '') then
			select	a.ds_descricao
			into STRICT	ds_canal_bomba_w
			from	man_equipamento_bomba a
			where	a.nr_sequencia = c01_w.nr_seq_canal_bomba
			and	a.nr_equipamento = c01_w.nr_seq_equipamento;
			
			ds_bomba_canal_w := substr(ds_bomba_canal_w||' - '||ds_canal_bomba_w,1,255);
		end if;		
		
		end;
	end if;

	ds_return_w := ds_return_w||ds_bomba_canal_w||' ,';
	
	end;
end loop;
close c01;

ds_return_w := substr(ds_return_w,1,length(ds_return_w) - 1);

return	ds_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ds_bomba_canal_concat ( nr_prescricao_p bomba_infusao.nr_prescricao%type, nr_atendimento_p bomba_infusao.nr_atendimento%type, nr_sequencia_p prescr_solucao_evento.nr_sequencia%type) FROM PUBLIC;

