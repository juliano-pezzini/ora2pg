-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_conta_deb_auto_pls (nr_titulo_p bigint) RETURNS varchar AS $body$
DECLARE

  ds_retorno_w                 varchar(255);
  nr_seq_conta_banco_deb_aut_w pls_mensalidade.nr_seq_conta_banco_deb_aut%type;
  nr_seq_mensalidade_w         titulo_receber.nr_seq_mensalidade%type;
  ie_origem_titulo_w           titulo_receber.ie_origem_titulo%type;
  ie_tipo_titulo_w             titulo_receber.ie_tipo_titulo%type;


BEGIN

  if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') then

    select max(nr_seq_mensalidade),
           max(ie_origem_titulo),
           max(ie_tipo_titulo)
      into STRICT nr_seq_mensalidade_w, ie_origem_titulo_w, ie_tipo_titulo_w
      from titulo_receber
     where nr_titulo = nr_titulo_p;

    if (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '') then
      -- titulo de mensalidade
    
      select max(nr_seq_conta_banco_deb_aut)
        into STRICT nr_seq_conta_banco_deb_aut_w
        from pls_mensalidade
       where nr_sequencia = nr_seq_mensalidade_w;

    elsif (ie_origem_titulo_w in ('10', '12', '18')) and -- titulo a receber de ocorrencia financeira/pagamento produ?/pagamento prestadores
         
          (ie_tipo_titulo_w = '10') then
      -- d?to automatico
    
      select ds_conta
        into STRICT ds_retorno_w
        from (SELECT substr(obter_nome_banco(pj.cd_banco), 1, 30) || ' - ' ||
                     obter_desc_expressao(283230) || ' ' ||
                     pj.cd_agencia_bancaria || ' - ' ||
                     obter_desc_expressao(285928) || ' ' || pj.nr_conta ds_conta
                from titulo_receber        tit,
                     pls_prestador         prest,
                     pls_prestador_rec     pr,
                     pessoa_juridica_conta pj
               where tit.nr_titulo = nr_titulo_p
                 and ((prest.cd_pessoa_fisica = tit.cd_pessoa_fisica) or (prest.cd_cgc = tit.cd_cgc))
                 and prest.ie_situacao = 'A'
                 and pr.nr_seq_prestador = prest.nr_sequencia
                 and pj.cd_cgc = prest.cd_cgc
                 and pj.nr_sequencia = pr.nr_seq_pessoa_jur_conta
              
union

              SELECT substr(obter_nome_banco(pf.cd_banco), 1, 30) || ' - ' ||
                     obter_desc_expressao(283230) || ' ' ||
                     pf.cd_agencia_bancaria || ' - ' ||
                     obter_desc_expressao(285928) || ' ' || pf.nr_conta ds_conta
                from titulo_receber      tit,
                     pls_prestador       prest,
                     pls_prestador_rec   pr,
                     pessoa_fisica_conta pf
               where tit.nr_titulo = nr_titulo_p
                 and ((prest.cd_pessoa_fisica = tit.cd_pessoa_fisica) or (prest.cd_cgc = tit.cd_cgc))
                 and prest.ie_situacao = 'A'
                 and pf.cd_pessoa_fisica = prest.cd_pessoa_fisica
                 and pf.nr_sequencia = pr.nr_seq_pessoa_fisica_conta) alias17;

      return ds_retorno_w;

    end if;

    if (nr_seq_conta_banco_deb_aut_w IS NOT NULL AND nr_seq_conta_banco_deb_aut_w::text <> '') then
    
      select max(ds_conta)
        into STRICT ds_retorno_w
        from banco_estabelecimento_v
       where nr_sequencia = nr_seq_conta_banco_deb_aut_w;

    end if;

  end if;

  return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_conta_deb_auto_pls (nr_titulo_p bigint) FROM PUBLIC;

