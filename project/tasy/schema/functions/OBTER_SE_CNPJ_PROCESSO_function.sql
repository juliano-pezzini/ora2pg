-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_cnpj_processo (cd_cnpj_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w    varchar(1);
qtd_w           bigint;


BEGIN

if (ie_opcao_p = '2010') then

	select count(*)
	into STRICT   qtd_w
	from   fis_reinf_r1070 a,
	       fis_reinf_r2010 b,
	       fis_reinf_notas_r2010 c
	where  c.cd_cnpj = cd_cnpj_p
	and    b.nr_sequencia = c.nr_seq_superior
	and    b.cd_tributo = a.cd_tributo
	and    a.cd_cnpj = c.cd_cnpj
	and    to_date(b.dt_competencia,'dd/mm/yyyy') between to_date(a.dt_inicio_validade,'dd/mm/yyyy') and fim_dia(to_date(coalesce(a.dt_fim_validade, clock_timestamp()),'dd/mm/yyyy'));

else

	select count(*)
	into STRICT   qtd_w
	from   fis_reinf_r1070 a,
	       fis_reinf_r2020 b,
	       fis_reinf_notas_r2020 c
	where  c.cd_cnpj = cd_cnpj_p
	and    b.nr_sequencia = c.nr_seq_superior
	and    b.cd_tributo = a.cd_tributo
	and    a.cd_cnpj = c.cd_cnpj
	and    to_date(b.dt_competencia,'dd/mm/yyyy') between to_date(a.dt_inicio_validade,'dd/mm/yyyy') and fim_dia(to_date(coalesce(a.dt_fim_validade, clock_timestamp()),'dd/mm/yyyy'));

end if;


if (qtd_w > 0) then

ds_retorno_w := 'S';

else

ds_retorno_w := 'N';

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_cnpj_processo (cd_cnpj_p text, ie_opcao_p text) FROM PUBLIC;

