-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_proximo_evento_mult_pepo ( nr_cirurgia_p evento_cirurgia_paciente.nr_cirurgia%type, nr_seq_pepo_p evento_cirurgia_paciente.nr_seq_pepo%type, nm_usuario_p evento_cirurgia_paciente.nm_usuario%type, cd_perfil_ativo_p evento_cirurgia_lib.cd_perfil%type, ie_estrutura_pepo text default 'N', ie_tipo_item_p evento_cirurgia.ie_tipo_item%type default 'P') RETURNS bigint AS $body$
DECLARE

nr_seq_exec_max_registrado_w evento_cirurgia.nr_seq_execucao%type;
nr_seq_exec_min_disponivel_w evento_cirurgia.nr_seq_execucao%type;
nr_sequencia_proximo_evento_w evento_cirurgia.nr_sequencia%type;
cd_estabelecimento_w estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;

BEGIN

    nr_sequencia_proximo_evento_w := obter_proximo_evento_pepo(nr_cirurgia_p, cd_perfil_ativo_p, ie_estrutura_pepo, ie_tipo_item_p, nr_seq_pepo_p);

    begin
        select  nr_seq_execucao
        into STRICT    nr_seq_exec_min_disponivel_w
        from    evento_cirurgia
        where   nr_sequencia = nr_sequencia_proximo_evento_w;
    exception when others then
        nr_seq_exec_min_disponivel_w := 0;
    end;

    begin
        select  max(nr_seq_execucao)
        into STRICT    nr_seq_exec_max_registrado_w
        from    w_evento_cirurgia_paciente a,
                evento_cirurgia b
        where   a.nr_seq_evento = b.nr_sequencia
        and     ((coalesce(a.nr_cirurgia, 0) = coalesce(nr_cirurgia_p, 0) and ie_estrutura_pepo = 'N') or
                ((((coalesce(a.nr_cirurgia, 0) = coalesce(nr_cirurgia_p, 0) and coalesce(a.nr_seq_pepo::text, '') = '') or (coalesce(a.nr_cirurgia::text, '') = '' and coalesce(a.nr_seq_pepo, 0) = coalesce(nr_seq_pepo_p, 0)))) and ie_estrutura_pepo = 'S'))
        and     a.nm_usuario = nm_usuario_p;
    exception when others then
        nr_seq_exec_max_registrado_w := 0;
    end;

    if ((nr_seq_exec_max_registrado_w IS NOT NULL AND nr_seq_exec_max_registrado_w::text <> '') and nr_seq_exec_max_registrado_w >= coalesce(nr_seq_exec_min_disponivel_w, 0)) then
        select  min(nr_seq_execucao)
        into STRICT    nr_seq_exec_min_disponivel_w
        from    evento_cirurgia
        where (substr(obter_se_mostra_evento(nr_cirurgia_p, nr_seq_pepo_p, nr_sequencia, cd_perfil_ativo_p, nm_usuario_p),1,1) = 'S')
        and     ie_situacao = 'A'
        and     ((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
        and     nr_seq_execucao > coalesce(nr_seq_exec_max_registrado_w, 0)
        and     ((coalesce(ie_tipo_item, ie_tipo_item_p) = ie_tipo_item_p) or (ie_tipo_item = 'A'));
    end if;

    if (nr_seq_exec_min_disponivel_w IS NOT NULL AND nr_seq_exec_min_disponivel_w::text <> '') then
        select  max(a.nr_sequencia)
        into STRICT    nr_sequencia_proximo_evento_w
        from    evento_cirurgia a
        where (substr(obter_se_mostra_evento(nr_cirurgia_p, nr_seq_pepo_p, nr_sequencia, cd_perfil_ativo_p, nm_usuario_p),1,1) = 'S')
        and     a.nr_seq_execucao = nr_seq_exec_min_disponivel_w
        and     ((a.cd_estabelecimento = cd_estabelecimento_w) or (coalesce(a.cd_estabelecimento::text, '') = ''))
        and     a.ie_situacao = 'A'
        and     ((coalesce(ie_tipo_item, ie_tipo_item_p) = ie_tipo_item_p) or (ie_tipo_item = 'A'));
    end if;

    return coalesce(nr_sequencia_proximo_evento_w,0);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_proximo_evento_mult_pepo ( nr_cirurgia_p evento_cirurgia_paciente.nr_cirurgia%type, nr_seq_pepo_p evento_cirurgia_paciente.nr_seq_pepo%type, nm_usuario_p evento_cirurgia_paciente.nm_usuario%type, cd_perfil_ativo_p evento_cirurgia_lib.cd_perfil%type, ie_estrutura_pepo text default 'N', ie_tipo_item_p evento_cirurgia.ie_tipo_item%type default 'P') FROM PUBLIC;

