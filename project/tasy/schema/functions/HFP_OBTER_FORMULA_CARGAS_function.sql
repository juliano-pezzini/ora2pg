-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hfp_obter_formula_cargas (ds_formula_p text, nr_seq_musc_p bigint, qt_valor_p text) RETURNS varchar AS $body$
DECLARE


ds_formula_w		varchar(2000);
ie_formula_ok_w		integer;
ds_formula_aux_w	varchar(2000);
nr_seq_musc_w		bigint;
ie_tamanho_w		integer;
i			integer;
qt_valor_atual_w	varchar(255);
ds_resultado_w		varchar(255);


BEGIN

qt_valor_atual_w := replace(qt_valor_p, ',', '.');

ds_formula_w	:= ds_formula_p;
ie_formula_ok_w	:= position('@' in ds_formula_w);

if (ie_formula_ok_w > 0) then

	ds_formula_aux_w 	:= ds_formula_w;

	while(position('@' in ds_formula_aux_w) > 0) loop

		ie_formula_ok_w := position('@' in ds_formula_aux_w);
		ie_tamanho_w := 0;

		for i in ie_formula_ok_w..length(ds_formula_aux_w) + 1 loop

			if	((substr(ds_formula_aux_w, i, 1) in (' ','/','*','+','-','(',')','@',',')) or (i = length(ds_formula_aux_w) + 1)) and
				(i > (ie_formula_ok_w + 1)) then

				ie_tamanho_w := i;
				exit;

			end if;

		end loop;

		begin

		nr_seq_musc_w	:= to_number(substr(ds_formula_aux_w, ie_formula_ok_w + 1, ie_tamanho_w - (ie_formula_ok_w + 1)));

		exception
			when others then
				nr_seq_musc_w	:= to_number(replace(substr(ds_formula_aux_w, ie_formula_ok_w + 1, ie_tamanho_w - (ie_formula_ok_w +  1)),',','.'));
		end;

		ds_formula_aux_w 	:= replace((replace(ds_formula_aux_w, '@' || coalesce(nr_seq_musc_w,nr_seq_musc_p), qt_valor_atual_w)),' ','');
		ds_formula_w 	 	:= ds_formula_aux_w;

	end loop;

end if;

ie_formula_ok_w := position('@' in ds_formula_w);

if (coalesce(ie_formula_ok_w,0) = 0) then

	ds_resultado_w := obter_valor_dinamico_char_bv('select '||ds_formula_w||' from dual', null, ds_resultado_w);

	if (coalesce(ds_resultado_w::text, '') = '') or (ds_resultado_w = '') then
		ds_resultado_w := obter_valor_dinamico('select ' || replace(ds_formula_w, ',', '.') || ' from dual', ds_resultado_w);
	end if;
end if;

return ds_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hfp_obter_formula_cargas (ds_formula_p text, nr_seq_musc_p bigint, qt_valor_p text) FROM PUBLIC;

