-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION es_obter_dados_proj (IE_OPCAO_P text, cd_projeto_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(60);
qt_horas_w      varchar(60);
pr_concluido_w  varchar(60);
previstas_w     varchar(60);
realizado_w     varchar(60);
saldo_w         varchar(60);
qt_horas_ad_w   varchar(60);

/*
H	- % Horas consumidas
P	- % Conclusao projeto
 T	- Horas Previstas
 R	- Horas Realizadas
 S	- Horas Saldo
 A	- Horas Adicionais
 */
BEGIN
select 	distinct(' ' || (dividir(coalesce(b.qt_hora_real,0), coalesce(b.qt_hora_prev,0))* 100)  || '% horas ') qt_horas,
	b.pr_etapa || '% implantado' pr_concluido,
	Campo_Mascara_virgula_casas( b.qt_hora_prev, 1) qt_total_horas,
    Campo_Mascara_virgula_casas( b.qt_hora_real, 1) qt_horas_realizado,
    Campo_Mascara_virgula_casas( b.qt_hora_saldo, 1) qt_horas_saldo
into STRICT qt_horas_w, pr_concluido_w, previstas_w, realizado_w, saldo_w
from    proj_cron_etapa b,
         proj_cronograma a
where  a.nr_sequencia = b.nr_seq_cronograma
and  a.ie_cobrado = 'S'
and  a.nr_seq_proj  = cd_projeto_p
and  coalesce(b.nr_seq_superior::text, '') = ''  LIMIT 1;

if (coalesce(ie_opcao_p, 'H') = 'H') then
ds_retorno_w	:= qt_horas_w;
elsif (coalesce(ie_opcao_p, 'P') = 'P') then
ds_retorno_w	:= pr_concluido_w;
elsif (coalesce(ie_opcao_p, 'T') = 'T') then
ds_retorno_w	:= previstas_w;
elsif (coalesce(ie_opcao_p, 'R') = 'R') then
ds_retorno_w	:= realizado_w;
elsif (coalesce(ie_opcao_p, 'S') = 'S') then
ds_retorno_w	:= saldo_w;
elsif (coalesce(ie_opcao_p, 'A') = 'A') then
select	sum(qt_n_adicionais) qt_realizadas
into STRICT qt_horas_ad_w
from (
SELECT	sum((dividir(a.qt_min_ativ, 60))::numeric ) qt_adicionais,
sum((dividir(CASE WHEN a.ie_atividade_extra='S' THEN  a.qt_min_ativ  ELSE 0 END , 60))::numeric ) qt_n_adicionais,
coalesce(d.qt_horas_saldo,0) qt_saldo
from	proj_rat b,
proj_rat_ativ a,
proj_cron_etapa x,
proj_cronograma d,
proj_projeto c
where	b.nr_sequencia = a.nr_seq_rat
and	d.nr_sequencia  = x.nr_seq_cronograma
and	x.nr_sequencia  = a.nr_seq_etapa_cron
and	d.nr_seq_proj = c.nr_sequencia
and	c.nr_seq_cliente = b.nr_seq_cliente
and	c.nr_sequencia = cd_projeto_p
and	d.ie_cobrado = 'S'
group by	d.qt_horas_saldo) alias10 where
group by qt_saldo LIMIT 1;

ds_retorno_w	:= qt_horas_ad_w;
end if;

RETURN	ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION es_obter_dados_proj (IE_OPCAO_P text, cd_projeto_p bigint) FROM PUBLIC;

