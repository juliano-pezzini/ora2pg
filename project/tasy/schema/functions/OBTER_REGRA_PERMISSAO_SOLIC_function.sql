-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_permissao_solic ( cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_material_p bigint, ie_urgente_p text, dt_solic_compra_p timestamp, cd_setor_entrega_p bigint, cd_estabelecimento_p bigint, ie_tipo_servico_p text) RETURNS varchar AS $body$
DECLARE



cd_grupo_material_w		smallint;
cd_subgrupo_material_w		smallint;
cd_classe_material_w		integer;
cd_local_estoque_w		bigint;
cd_centro_custo_w			integer;
qt_registro_w			bigint;
ie_padronizado_w		varchar(1);
ie_permissao_w			varchar(1) := 'S';
ds_retorno_w			varchar(1) := 'S';

C01 CURSOR FOR
SELECT	coalesce(a.ie_permissao,'S')
from	regra_permissao_solic a
where	coalesce(cd_centro_custo,coalesce(cd_centro_custo_p, 0))		= coalesce(cd_centro_custo_p, 0)
and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p, 0))	= coalesce(cd_local_estoque_p, 0)
and	coalesce(cd_perfil,cd_perfil_p)				= cd_perfil_p
and	coalesce(nm_usuario_regra,nm_usuario_p) 			= nm_usuario_p
and	coalesce(a.cd_grupo_material,cd_grupo_material_w) 		= cd_grupo_material_w
and	coalesce(a.cd_subgrupo_material,cd_subgrupo_material_w)	= cd_subgrupo_material_w
and	coalesce(a.cd_classe_material,cd_classe_material_w) 		= cd_classe_material_w
and	coalesce(a.cd_material,cd_material_p) 			= cd_material_p
and	coalesce(a.cd_setor_entrega,coalesce(cd_setor_entrega_p,0))		= coalesce(cd_setor_entrega_p,0)
and	coalesce(a.cd_estabelecimento,coalesce(cd_estabelecimento_p,0))	= coalesce(cd_estabelecimento_p,0)
and	((a.ie_padronizado = ie_padronizado_w) or (coalesce(a.ie_padronizado, 'A') = 'A'))
and	((a.ie_urgente = ie_urgente_p) or (coalesce(a.ie_urgente, 'A') = 'A'))
and	((coalesce(ie_dia_semana::text, '') = '') or
	((ie_dia_semana IS NOT NULL AND ie_dia_semana::text <> '') and (ie_dia_semana = 9) and (substr(obter_cod_dia_semana(dt_solic_compra_p), 1,1) in (2,3,4,5,6))) or
	((ie_dia_semana IS NOT NULL AND ie_dia_semana::text <> '') and (ie_dia_semana <> 9) and (substr(obter_cod_dia_semana(dt_solic_compra_p), 1,1) = ie_dia_semana)))
and (to_char(hr_inicio,'hh24:mi:ss') < to_char(dt_solic_compra_p,'hh24:mi:ss') or
	coalesce(hr_inicio::text, '') = '')
and (to_char(hr_fim,'hh24:mi:ss') > to_char(dt_solic_compra_p,'hh24:mi:ss') or
	coalesce(hr_fim::text, '') = '')
and	(((coalesce(dt_inicio::text, '') = '') or (coalesce(dt_fim::text, '') = '')) or (to_char(dt_solic_compra_p,'dd/mm') between to_char(dt_inicio,'dd/mm') and to_char(dt_fim,'dd/mm')))
and (to_char(lpad(nr_dia_fixo_mes,2,0)) = to_char(dt_solic_compra_p,'dd') or
	coalesce(nr_dia_fixo_mes::text, '') = '')
and	((coalesce(nr_dia_inicio,0) = 0) or (coalesce(nr_dia_fim,0) = 0) or ((to_char(dt_solic_compra_p,'dd'))::numeric  between nr_dia_inicio and nr_dia_fim))
and (cd_material_p <> 0)
and	((cd_grupo_material IS NOT NULL AND cd_grupo_material::text <> '') or (cd_subgrupo_material IS NOT NULL AND cd_subgrupo_material::text <> '') or (cd_classe_material IS NOT NULL AND cd_classe_material::text <> '') or (cd_material IS NOT NULL AND cd_material::text <> '') or (ie_padronizado in ('S','N')))
and 	coalesce(a.ie_tipo_servico,coalesce(ie_tipo_servico_p,'ES')) = coalesce(ie_tipo_servico_p,'ES')
order by	coalesce(cd_material,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(nm_usuario_regra,'aaaa'),
		coalesce(cd_perfil,0);

BEGIN

if (coalesce(cd_material_p, 0) = 0) then
	select	count(*)
	into STRICT	qt_registro_w
	from	regra_permissao_solic
	where	coalesce(cd_centro_custo,coalesce(cd_centro_custo_p, 0))		= coalesce(cd_centro_custo_p, 0)
	and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p, 0))	= coalesce(cd_local_estoque_p, 0)
	and	coalesce(cd_perfil,cd_perfil_p)				= cd_perfil_p
	and	coalesce(nm_usuario_regra,nm_usuario_p) 			= nm_usuario_p
	and	coalesce(cd_setor_entrega,coalesce(cd_setor_entrega_p,0))		= coalesce(cd_setor_entrega_p,0)
	and	coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_p,0))	= coalesce(cd_estabelecimento_p,0)
	and	((ie_padronizado = ie_padronizado_w) or (coalesce(ie_padronizado, 'A') = 'A'))
	and	((ie_urgente = ie_urgente_p) or (coalesce(ie_urgente, 'A') = 'A'))
	and	((coalesce(ie_dia_semana::text, '') = '') or
		((ie_dia_semana IS NOT NULL AND ie_dia_semana::text <> '') and (ie_dia_semana = 9) and (substr(obter_cod_dia_semana(dt_solic_compra_p), 1,1) in (2,3,4,5,6))) or
		((ie_dia_semana IS NOT NULL AND ie_dia_semana::text <> '') and (ie_dia_semana <> 9) and (substr(obter_cod_dia_semana(dt_solic_compra_p), 1,1) = ie_dia_semana)))
	and (to_char(hr_inicio,'hh24:mi:ss') < to_char(dt_solic_compra_p,'hh24:mi:ss') or
		coalesce(hr_inicio::text, '') = '')
	and (to_char(hr_fim,'hh24:mi:ss') > to_char(dt_solic_compra_p,'hh24:mi:ss') or
		coalesce(hr_fim::text, '') = '')
	and	(((coalesce(dt_inicio::text, '') = '') or (coalesce(dt_fim::text, '') = '')) or (to_char(dt_solic_compra_p,'dd/mm') between to_char(dt_inicio,'dd/mm') and to_char(dt_fim,'dd/mm')))
	and (to_char(lpad(nr_dia_fixo_mes,2,0)) = to_char(dt_solic_compra_p,'dd') or
		coalesce(nr_dia_fixo_mes::text, '') = '')
	and	((coalesce(nr_dia_inicio,0) = 0) or (coalesce(nr_dia_fim,0) = 0) or ((to_char(dt_solic_compra_p,'dd'))::numeric  between nr_dia_inicio and nr_dia_fim))
	and	ie_permissao = 'N'
	and	coalesce(cd_grupo_material::text, '') = ''
	and	coalesce(cd_subgrupo_material::text, '') = ''
	and	coalesce(cd_classe_material::text, '') = ''
	and	coalesce(cd_material::text, '') = '';

elsif (coalesce(cd_material_p,0) <> 0) then
	begin
	select	cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		obter_se_material_padronizado(cd_estabelecimento_p, cd_material)
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		ie_padronizado_w
	from	estrutura_material_v
	where	cd_material	= cd_material_p;

	open C01;
	loop
	fetch C01 into
		ie_permissao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_retorno_w	:= ie_permissao_w;
		end;
	end loop;
	close C01;
	end;

end if;

if (qt_registro_w > 0) then
	ds_retorno_w := 'N';
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_permissao_solic ( cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_material_p bigint, ie_urgente_p text, dt_solic_compra_p timestamp, cd_setor_entrega_p bigint, cd_estabelecimento_p bigint, ie_tipo_servico_p text) FROM PUBLIC;

