-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_estagio_autor_agecons (nr_seq_agenda_p bigint) RETURNS varchar AS $body$
DECLARE


nr_autorizacao_w		         varchar(50);
ds_estagio_w			varchar(60);
agenda_sessao_w	                  bigint;
ie_autorizacao_w                    varchar(3);
qt_aprovada_w                       double precision;
nr_secao_w                          smallint;
qt_autorizacoes_w					bigint;
cd_convenio_agenda_w				bigint;


BEGIN

select	count(1)
into STRICT	qt_autorizacoes_w
from	estagio_autorizacao b,
	autorizacao_convenio a
where	a.nr_seq_estagio		= b.nr_sequencia
and 	a.nr_seq_agenda_consulta	= nr_seq_agenda_p;

if (qt_autorizacoes_w = 1) then

	select	max(b.ds_estagio)
	into STRICT	ds_estagio_w
	from	estagio_autorizacao b,
		autorizacao_convenio a
	where	a.nr_seq_estagio		= b.nr_sequencia
	and 	a.nr_seq_agenda_consulta	= nr_seq_agenda_p;

elsif (qt_autorizacoes_w > 1) then
	begin

		select 	max(cd_convenio)
		into STRICT 	cd_convenio_agenda_w
		from	agenda_consulta
		where 	nr_sequencia = nr_seq_agenda_p;

		select	max(b.ds_estagio)
		into STRICT	ds_estagio_w
		from	estagio_autorizacao b,
				autorizacao_convenio a
		where	a.nr_seq_estagio		= b.nr_sequencia
		and 	a.nr_seq_agenda_consulta	= nr_seq_agenda_p
		and 	a.cd_convenio = cd_convenio_agenda_w
		and		a.dt_atualizacao = (SELECT	max(c.dt_atualizacao)
									from	estagio_autorizacao d,
											autorizacao_convenio c
									where	c.nr_seq_estagio		= d.nr_sequencia
									and 	c.nr_seq_agenda_consulta	= nr_seq_agenda_p
									and 	c.cd_convenio = cd_convenio_agenda_w
									and 	c.nr_seq_estagio <> 12);

		if (coalesce(ds_estagio_w::text, '') = '') then

			select	max(b.ds_estagio)
			into STRICT	ds_estagio_w
			from	estagio_autorizacao b,
					autorizacao_convenio a
			where	a.nr_seq_estagio		= b.nr_sequencia
			and 	a.nr_seq_agenda_consulta	= nr_seq_agenda_p
			and		a.dt_atualizacao = (SELECT	max(c.dt_atualizacao)
										from	estagio_autorizacao d,
												autorizacao_convenio c
										where	c.nr_seq_estagio		= d.nr_sequencia
										and 	c.nr_seq_agenda_consulta	= nr_seq_agenda_p);

		end if;

	end;
end if;

if (coalesce(ds_estagio_w::text, '') = '') then
	select   nr_seq_agenda_sessao
	into STRICT     agenda_sessao_w
	from     agenda_consulta
	where	nr_sequencia = nr_seq_agenda_p;

	if (coalesce(agenda_sessao_w,0) > 0) then
		begin
			select  p.qt_autorizada
			into STRICT    qt_aprovada_w
			from	procedimento_autorizado p,
				agenda_consulta a
			where   p.nr_seq_agenda_consulta   = a.nr_seq_agenda_sessao
			and     a.nr_sequencia             = nr_seq_agenda_p
			and     a.cd_procedimento          = p.cd_procedimento
			and     a.ie_origem_proced         = p.ie_origem_proced
			and 	p.qt_autorizada > 0
			and     coalesce(p.qt_autorizada,0)     >= coalesce(a.nr_secao,0)  LIMIT 1;
		exception
		when others then
			qt_aprovada_w := 0;
		end;

		if (coalesce( qt_aprovada_w ,0) <= 0) then
			ds_estagio_w := '';
		else
			select	max(b.ds_estagio)
			into STRICT	ds_estagio_w
			from	estagio_autorizacao b,
				autorizacao_convenio a,
				regra_gerar_autorizacao r
			where	a.nr_seq_estagio		= b.nr_sequencia
			and 	a.nr_seq_agenda_consulta	= agenda_sessao_w
			and 	a.nr_seq_regra_autor 	= r.nr_sequencia
			and 	coalesce(r.qt_sessao_agenda,'N')= 'S';
		end if;
	end if;
end if;
return	ds_estagio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_estagio_autor_agecons (nr_seq_agenda_p bigint) FROM PUBLIC;

