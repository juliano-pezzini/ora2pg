-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dose_presc_medic (cd_pessoa_fisica_p text, nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, nr_seq_material_p bigint, cd_material_p bigint, qt_peso_p bigint, qt_altura_p bigint, qt_peso_ideal_p bigint, qt_fator_correcao_p bigint, ie_peso_considerar_p text, qt_dose_p bigint, qt_hora_aplicacao_p bigint, qt_redutor_sc_p bigint, pr_reducao_p bigint, pr_reducao_item_p bigint, nm_usuario_p text, cd_unidade_med_p text, cd_unid_med_prescr_p text, ie_formula_sup_corporea_p text, ie_via_aplicacao_p text, ie_aplica_reducao_p text, cd_intervalo_p text) RETURNS double precision AS $body$
DECLARE


/* function created using the procedure atualizar_dose_onc_protocolo as base */

dose_presc_w 				double precision;
temp_dose_presc_w			double precision;
qt_superficie_corporea_w	double precision;
ie_peso_considerar_w    	varchar(1)  := 'A';
cd_pessoa_fisica_w 			varchar(20);
mgcar_desc_w				varchar(10);
casas_dec_sc_w				smallint;
cd_unidade_med_sec_w		varchar(15) := '';
qt_mg_carboplatina_w		double precision;
ie_mult_h_aplic_w			varchar(3);
ie_calcula_preenchido_w		varchar(3);
cd_unidade_medida_conv_w	varchar(30);
qt_peso_w					double precision;
ie_formula_sup_corporea_w   paciente_setor.ie_formula_sup_corporea%type;


BEGIN
	ie_calcula_preenchido_w := Obter_Param_Usuario(281, 476, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, obter_estabelecimento_ativo, ie_calcula_preenchido_w);

	dose_presc_w := qt_dose_p;
	
	ie_formula_sup_corporea_w := ie_formula_sup_corporea_p;

	if (coalesce(ie_formula_sup_corporea_w::text, '') = '' and (nr_seq_paciente_p IS NOT NULL AND nr_seq_paciente_p::text <> '')) then
		select ie_formula_sup_corporea
		into STRICT ie_formula_sup_corporea_w
		from paciente_setor
		where nr_seq_paciente = nr_seq_paciente_p;
	end if;
	
	if (nr_seq_atendimento_p IS NOT NULL AND nr_seq_atendimento_p::text <> '') then
		qt_mg_carboplatina_w := obter_qt_mg_carbo_ciclo(nr_seq_atendimento_p);
	else
		qt_mg_carboplatina_w := obter_qt_mg_carboplatina(nr_seq_paciente_p);
	end if;
	
	mgcar_desc_w := obter_desc_expressao(782176);
	casas_dec_sc_w := coalesce(obter_numero_casas_sc, 2);

	qt_superficie_corporea_w := round(obter_superficie_corp_red_ped(qt_peso_p,
												   qt_altura_p, 
												   qt_redutor_sc_p, 
												   cd_pessoa_fisica_p, 
												   nm_usuario_p,
												   ie_formula_sup_corporea_w),casas_dec_sc_w);
												
	 select max(lower(cd_unidade_med_sec))
     into STRICT cd_unidade_med_sec_w
     from unidade_medida
     where cd_unidade_medida = cd_unidade_med_p
     and ((cd_unidade_med_princ IS NOT NULL AND cd_unidade_med_princ::text <> '') and cd_unidade_medida <> cd_unidade_med_princ);

	select coalesce(upper(ie_mult_h_aplic), 'N')
	into STRICT ie_mult_h_aplic_w
	from unidade_medida
	where cd_unidade_medida = cd_unidade_med_p;
	
	if (cd_unidade_med_sec_w = 'm2' and (qt_superficie_corporea_w IS NOT NULL AND qt_superficie_corporea_w::text <> '')) then
		dose_presc_w := qt_dose_p * qt_superficie_corporea_w;
	end if;

	if (cd_unidade_med_sec_w = 'mgc' and (qt_mg_carboplatina_w IS NOT NULL AND qt_mg_carboplatina_w::text <> '') and qt_mg_carboplatina_w > 0) then
		dose_presc_w := qt_dose_p * qt_mg_carboplatina_w;
	end if;

	if (cd_unidade_med_sec_w = mgcar_desc_w and (qt_mg_carboplatina_w IS NOT NULL AND qt_mg_carboplatina_w::text <> '') and qt_mg_carboplatina_w > 0) then
		dose_presc_w := qt_mg_carboplatina_w;
	end if;

	if (cd_unidade_med_sec_w in ('m2','mgc','kg', mgcar_desc_w) and ie_calcula_preenchido_w = 'C') then
		dose_presc_w := coalesce(Obter_dose_convertida(cd_material_p,qt_dose_p,cd_unidade_med_p,cd_unid_med_prescr_p),dose_presc_w);
	end if;

	qt_peso_w := qt_peso_p;
	
	if (ie_peso_considerar_p IS NOT NULL AND ie_peso_considerar_p::text <> '') then
		if ('J' = ie_peso_considerar_p) then
			qt_peso_w := obter_peso_ideal_ajust_pac(cd_pessoa_fisica_p, qt_peso_p, qt_fator_correcao_p, qt_altura_p);

		elsif ('I' = ie_peso_considerar_p) then
			qt_peso_w := qt_peso_ideal_p;
		end if;
	end if;

	if (cd_unidade_med_sec_w = 'kg' and (qt_peso_w IS NOT NULL AND qt_peso_w::text <> '') and qt_peso_w > 0) then
		dose_presc_w := qt_dose_p * qt_peso_w;
	end if;

	if (ie_aplica_reducao_p = 'S' and (pr_reducao_p IS NOT NULL AND pr_reducao_p::text <> '') and pr_reducao_p > 0) then
		dose_presc_w := dose_presc_w - ((pr_reducao_p * coalesce(dose_presc_w, 0)) / 100);
	end if;

	if (ie_mult_h_aplic_w = 'S' and (qt_hora_aplicacao_p IS NOT NULL AND qt_hora_aplicacao_p::text <> '') and qt_hora_aplicacao_p <> 0) then
		dose_presc_w := dose_presc_w * qt_hora_aplicacao_p;
	end if;
	
	if (ie_aplica_reducao_p = 'S' and (pr_reducao_item_p IS NOT NULL AND pr_reducao_item_p::text <> '') and pr_reducao_item_p not in (100, 0)) then
		dose_presc_w := (coalesce(pr_reducao_item_p,100) * coalesce(dose_presc_w,0)) / 100;
	end if;
	
	temp_dose_presc_w := dose_presc_w;
	SELECT * FROM Obter_qt_dose_onco_conv(cd_material_p, temp_dose_presc_w, ie_via_aplicacao_p, cd_unidade_med_p, cd_unidade_medida_conv_w, cd_intervalo_p) INTO STRICT temp_dose_presc_w, cd_unidade_medida_conv_w;
	
	if ((temp_dose_presc_w IS NOT NULL AND temp_dose_presc_w::text <> '') and temp_dose_presc_w <> dose_presc_w) then
		dose_presc_w := temp_dose_presc_w;
	end if;
	
return dose_presc_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dose_presc_medic (cd_pessoa_fisica_p text, nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, nr_seq_material_p bigint, cd_material_p bigint, qt_peso_p bigint, qt_altura_p bigint, qt_peso_ideal_p bigint, qt_fator_correcao_p bigint, ie_peso_considerar_p text, qt_dose_p bigint, qt_hora_aplicacao_p bigint, qt_redutor_sc_p bigint, pr_reducao_p bigint, pr_reducao_item_p bigint, nm_usuario_p text, cd_unidade_med_p text, cd_unid_med_prescr_p text, ie_formula_sup_corporea_p text, ie_via_aplicacao_p text, ie_aplica_reducao_p text, cd_intervalo_p text) FROM PUBLIC;

