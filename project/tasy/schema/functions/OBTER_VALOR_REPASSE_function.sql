-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_repasse ( nr_repasse_terceiro_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


vl_repasse_w			double precision;
vl_repasse_proc_w		double precision;
vl_Liberado_Proc_w		double precision;
vl_repasse_mat_w		double precision;
vl_Liberado_mat_w		double precision;
vl_repasse_item_w		double precision;
vl_glosa_mat_w			double precision;
vl_glosa_proc_w			double precision;
vl_maior_proc_w			double precision;
vl_maior_mat_w			double precision;
vl_repasse_item_pos_w		double precision;
vl_proc_glosa_negativa_w	double precision;
vl_mat_glosa_negativa_w		double precision;

/* Opcao
R	- Repasse
RPM	- Repasse procedimento/material
RI	- Repasse item
L	- Liberado
LP	- Valor liberado desconsiderando itens de repasses negativos
G	- Glosado
M	- Maior
I	- Valor liquido dos vencimentos
LI	- Valor liberado somente de procedimentos e materiais
RIP	- Repasse desconsiderando itens negativos
RM	- Repasse material
PI	- Repasse Procedimento + Repasse Item
VV	- Valor vencimento 
PRO	- Repasse procedimento
CVP - Considerar o item de repasse para calculo do valor de piso
*/
BEGIN

select
	coalesce(sum(vl_repasse),0),
	coalesce(sum(vl_liberado),0),
	coalesce(sum(somente_positivo(coalesce(vl_repasse,0) - somente_positivo(coalesce(vl_liberado,0)))),0),
	coalesce(sum(somente_positivo(coalesce(vl_liberado,0) - somente_positivo(coalesce(vl_repasse,0)))),0)
into STRICT	vl_repasse_proc_w,
	vl_liberado_proc_w,
	vl_glosa_proc_w,
	vl_maior_proc_w
from 	procedimento_repasse
where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

select 	coalesce(sum(vl_repasse),0),
	coalesce(sum(vl_liberado),0),
	coalesce(sum(somente_positivo(coalesce(vl_repasse,0) - somente_positivo(coalesce(vl_liberado,0)))),0),	-- inclui somente_positivo no 2 valor (Jacson OS 45598)
	coalesce(sum(somente_positivo(coalesce(vl_liberado,0) - somente_positivo(coalesce(vl_repasse,0)))),0)	-- inclui somente_positivo no 2 valor (Jacson OS 45598)
into STRICT	vl_repasse_mat_w,
	vl_liberado_mat_w,
	vl_glosa_mat_w,
	vl_maior_mat_w
from 	material_repasse
where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

select	coalesce(sum(vl_repasse),0)
into STRICT	vl_proc_glosa_negativa_w
from	procedimento_repasse
where	nr_repasse_terceiro	= nr_repasse_terceiro_p
and	vl_repasse		< 0
and	IE_STATUS		= 'G';
vl_glosa_proc_w			:= vl_glosa_proc_w + vl_proc_glosa_negativa_w;

select	coalesce(sum(vl_repasse),0)
into STRICT	vl_mat_glosa_negativa_w
from	material_repasse
where	nr_repasse_terceiro	= nr_repasse_terceiro_p
and	vl_repasse		< 0
and	IE_STATUS		= 'G';
vl_glosa_mat_w			:= vl_glosa_mat_w + vl_mat_glosa_negativa_w;

select coalesce(sum(case when ie_opcao_p = 'CVP' and coalesce(ie_participa_piso, 'S')  = 'N' then 0 else vl_repasse end),0)
into STRICT   vl_repasse_item_w
from   repasse_terceiro_item
where nr_repasse_terceiro	= nr_repasse_terceiro_p;

select coalesce(sum(case when ie_opcao_p = 'CVP' and coalesce(ie_participa_piso, 'S') = 'N' then 0 else vl_repasse end),0)
into STRICT   vl_repasse_item_pos_w
from   repasse_terceiro_item
where  nr_repasse_terceiro	= nr_repasse_terceiro_p
and	vl_repasse > 0;

vl_repasse_w			:= 0;
if (ie_opcao_p	in ('R', 'CVP')) then
	vl_repasse_w	:= vl_repasse_proc_w + vl_repasse_mat_w + vl_repasse_item_w;
elsif (ie_opcao_p	= 'RPM') then
	vl_repasse_w	:= vl_repasse_proc_w + vl_repasse_mat_w;
elsif (ie_opcao_p	= 'RI') then
	vl_repasse_w	:= vl_repasse_item_w;
elsif (ie_opcao_p	= 'L') then
	vl_repasse_w	:= vl_liberado_proc_w + vl_liberado_mat_w + vl_repasse_item_w;
elsif (ie_opcao_p	= 'LP') then
	vl_repasse_w	:= vl_liberado_proc_w + vl_liberado_mat_w + vl_repasse_item_pos_w;
elsif (ie_opcao_p	= 'G') then
	vl_repasse_w	:= vl_glosa_mat_w + vl_glosa_proc_w;
elsif (ie_opcao_p	= 'M') then
	vl_repasse_w	:= vl_maior_mat_w + vl_maior_proc_w;
elsif (ie_opcao_p	= 'I') then
	select	coalesce(sum(vl_liquido),0)
	into STRICT	vl_repasse_w
	from	repasse_terceiro_venc
	where	nr_repasse_terceiro	= nr_repasse_terceiro_p;
elsif (ie_opcao_p	= 'LI') then
	vl_repasse_w	:= vl_liberado_proc_w + vl_liberado_mat_w;
elsif (ie_opcao_p	= 'RIP') then
	vl_repasse_w	:= vl_repasse_proc_w + vl_repasse_mat_w + vl_repasse_item_pos_w;
elsif (ie_opcao_p	= 'RM') then
	vl_repasse_w	:= vl_repasse_mat_w;
elsif (ie_opcao_p	= 'PI') then
	vl_repasse_w	:= vl_repasse_proc_w + vl_repasse_item_w;
elsif (ie_opcao_p	= 'VV') then
	select	coalesce(sum(vl_vencimento),0)
	into STRICT	vl_repasse_w
	from	repasse_terceiro_venc
	where	nr_repasse_terceiro	= nr_repasse_terceiro_p;
elsif (ie_opcao_p	= 'PRO') then
	vl_repasse_w	:= vl_repasse_proc_w;
end if;

RETURN vl_repasse_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_repasse ( nr_repasse_terceiro_p bigint, ie_opcao_p text) FROM PUBLIC;

