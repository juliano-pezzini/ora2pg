-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_conteudo_email_gv ( nr_seq_gv_p bigint, cd_declaracao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


nr_seq_agenda_w			gestao_vaga.nr_seq_agenda%type;
dt_prevista_w			varchar(4000);
ie_agenda_paciente_w	varchar(1);
ds_declaracao_w			varchar(4000) := '';
nm_paciente_w			varchar(255);

BEGIN

if (coalesce(nr_seq_gv_p,0) > 0) then 

	select	nr_seq_agenda,
		pkg_date_formaters.to_varchar(dt_prevista, 'date(short)', cd_estabelecimento_p, nm_usuario_p),
		substr(coalesce(obter_nome_pf(cd_pessoa_fisica),nm_paciente),1,255)
	into STRICT	nr_seq_agenda_w,
		dt_prevista_w,
		nm_paciente_w
	from	gestao_vaga
	where	nr_sequencia = nr_seq_gv_p;
	
	if (cd_declaracao_p IS NOT NULL AND cd_declaracao_p::text <> '') then
		if (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') then
			select	CASE WHEN count(nr_sequencia)=0 THEN  'N'  ELSE 'S' END
			into STRICT	ie_agenda_paciente_w
			from	agenda_paciente
			where	nr_sequencia = nr_seq_agenda_w
			and		obter_tipo_agenda(cd_agenda) = 1;
	
			if (ie_agenda_paciente_w = 'S') then
				ds_declaracao_w := substr(obter_conteudo_email(nr_seq_agenda_w, cd_declaracao_p),1,4000);
			end if;
		else
			select	substr(max(ds_declaracao),1,4000)
			into STRICT	ds_declaracao_w
			from 	declaracao
			where 	cd_declaracao = cd_declaracao_p;
		end if;
	end if;
	
ds_declaracao_w	:= substr(replace_macro(ds_declaracao_w, '@dtprevgestaovaga', dt_prevista_w),1,4000);
ds_declaracao_w	:= substr(replace_macro(ds_declaracao_w,'@paciente',nm_paciente_w),1,4000);	

end if;
return 	substr(ds_declaracao_w,1,4000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_conteudo_email_gv ( nr_seq_gv_p bigint, cd_declaracao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

