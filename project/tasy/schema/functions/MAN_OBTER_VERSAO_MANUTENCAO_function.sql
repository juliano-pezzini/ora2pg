-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_versao_manutencao ( cd_versao_destino_p text) RETURNS varchar AS $body$
DECLARE


cd_versao_w			varchar(15);
dt_versao_w			timestamp;
cd_versao_teste_w		varchar(15);
cd_versao_extranet_w		varchar(15);
cd_versao_ultimo_build_w	varchar(15);
ie_controle_proc_w		bigint := 0;
ds_versao_w			varchar(50);

C01 CURSOR FOR
SELECT	cd_versao,
dt_versao
from (
	SELECT	cd_versao cd_versao,
		dt_versao dt_versao
	from	aplicacao_tasy_versao
	where	cd_aplicacao_tasy = 'Tasy'
	and	coalesce(IE_VERSAO_OFICIAL, 'N') = 'S'
	order by dt_versao desc) alias1
where (clock_timestamp() - dt_versao) > 5  LIMIT 3;


BEGIN
/*
Function responsável por obter as versões que estão na extranet mas a versão do teste. Com isso comparamos a versão de destino do cliente e via webservice a rotina da atualização ira impedir atualização para versões antigas.
*/
	open C01;
	loop
	fetch C01 into
		cd_versao_w,
		dt_versao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		ie_controle_proc_w := ie_controle_proc_w + 1;
		if (ie_controle_proc_w = 1) then
			begin
			cd_versao_teste_w := cd_versao_w;
			end;
		elsif (ie_controle_proc_w = 2) then
			begin
			cd_versao_extranet_w := cd_versao_w;
			end;
		elsif (ie_controle_proc_w = 3) then
			begin
			cd_versao_ultimo_build_w := cd_versao_w;
			end;
		end if;

		end;
	end loop;
	close C01;

	ds_versao_w  := cd_versao_extranet_w || ' - ' ||  cd_versao_ultimo_build_w;

return	ds_versao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_versao_manutencao ( cd_versao_destino_p text) FROM PUBLIC;

