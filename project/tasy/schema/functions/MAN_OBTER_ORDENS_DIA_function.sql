-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_ordens_dia ( dt_referencia_p timestamp, ie_opcao_p text, nr_seq_gerencia_p bigint, nr_seq_grupo_des_p bigint, ie_tipo_prev_p text, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(255);
dt_referencia_w			timestamp;


BEGIN

dt_referencia_w		:= trunc(dt_referencia_p,'dd');

if (ie_opcao_p	= 'E') then /* Executadas */
	select	count(*)
	into STRICT	ds_retorno_w
	from (
		SELECT	a.nr_sequencia
		FROM man_ordem_ativ_prev y, w_resumo_prev_os_item r, pessoa_fisica p, grupo_desenvolvimento c, man_estagio_processo b, man_ordem_servico a
LEFT OUTER JOIN man_localizacao z ON (a.nr_seq_localizacao = z.nr_sequencia)
LEFT OUTER JOIN setor_atendimento w ON (z.cd_setor = w.cd_setor_atendimento)
WHERE a.nr_seq_estagio		= b.nr_sequencia and a.nr_sequencia		= y.nr_seq_ordem_serv and r.nr_seq_ordem       = a.nr_sequencia and r.ie_tipo_prev = ie_tipo_prev_p and r.nm_usuario   = nm_usuario_p and r.dt_previsao  = dt_referencia_w   and a.nr_seq_grupo_des   = c.nr_sequencia and a.cd_pessoa_solicitante = p.cd_pessoa_fisica and y.dt_prevista between trunc(dt_referencia_w,'dd') and fim_dia(dt_referencia_w) and (coalesce(nr_seq_gerencia_p::text, '') = '' or c.nr_seq_gerencia = nr_seq_gerencia_p) and (coalesce(nr_seq_grupo_des_p::text, '') = '' or a.nr_seq_grupo_des = nr_seq_grupo_des_p) and (coalesce(b.ie_situacao_os,'0') <> '3' or exists (	SELECT	1
								from	man_ordem_serv_ativ x
								where	x.nr_seq_ordem_serv = a.nr_sequencia
								and	x.nm_usuario_exec = y.nm_usuario_prev
								and	x.dt_atividade between trunc(y.dt_prevista,'dd') and fim_dia(y.dt_prevista))) and (y.dt_real IS NOT NULL AND y.dt_real::text <> '') and y.pr_atividade = 100 and exists (	select	1
				from	usuario_grupo_des p
				where	p.nr_seq_grupo = a.nr_seq_grupo_des
				and   p.nm_usuario_grupo = y.nm_usuario_prev) group by	a.nr_sequencia,
			a.ie_classificacao,
			a.dt_ordem_servico,
			a.ie_prioridade,
			w.ds_setor_atendimento,
			p.nm_pessoa_fisica,
			a.ds_dano_breve,
			a.ie_classificacao,
			b.ds_estagio,
			z.ds_localizacao,
			a.ie_prioridade_desen,
			obter_tipo_os(a.dt_ordem_servico),
			a.ie_obriga_news,
			a.ds_just_ret_news,
			a.nr_seq_classif) alias16;
elsif (ie_opcao_p	= 'EE') then /* Em execução */
	select	count(*)
	into STRICT	ds_retorno_w
	from (
		SELECT	a.nr_sequencia
		FROM man_ordem_ativ_prev y, w_resumo_prev_os_item r, pessoa_fisica p, grupo_desenvolvimento c, man_estagio_processo b, man_ordem_servico a
LEFT OUTER JOIN man_localizacao z ON (a.nr_seq_localizacao = z.nr_sequencia)
LEFT OUTER JOIN setor_atendimento w ON (z.cd_setor = w.cd_setor_atendimento)
WHERE a.nr_seq_estagio		= b.nr_sequencia and a.nr_sequencia		= y.nr_seq_ordem_serv   and r.nr_seq_ordem       = a.nr_sequencia and r.IE_TIPO_PREV = ie_tipo_prev_p and r.nm_usuario   = nm_usuario_p and r.dt_previsao  = dt_referencia_w and a.nr_seq_grupo_des   = c.nr_sequencia and a.cd_pessoa_solicitante = p.cd_pessoa_fisica and y.dt_prevista between trunc(dt_referencia_w,'dd') and fim_dia(dt_referencia_w) and (coalesce(nr_seq_gerencia_p::text, '') = '' or c.nr_seq_gerencia = nr_seq_gerencia_p) and (coalesce(nr_seq_grupo_des_p::text, '') = '' or a.nr_seq_grupo_des = nr_seq_grupo_des_p) and a.ie_status_ordem <> '3' and (b.ie_desenv = 'S' or b.ie_tecnologia = 'S') and (coalesce(b.ie_situacao_os,'0') <> '3' or exists (	SELECT	1
							from	man_ordem_serv_ativ x
							where	x.nr_seq_ordem_serv = a.nr_sequencia
							and	x.nm_usuario_exec = y.nm_usuario_prev
							and	x.dt_atividade between trunc(y.dt_prevista,'dd') and fim_dia(y.dt_prevista)
											    )
			) and exists (	select	1
				from	usuario_grupo_des p
				where	p.nr_seq_grupo = a.nr_seq_grupo_des
				and	p.nm_usuario_grupo = y.nm_usuario_prev) and exists (	select 	1
				from	man_ordem_serv_ativ
			       	where	nr_seq_ordem_serv	= a.nr_sequencia
				and	coalesce(dt_fim_atividade::text, '') = ''
				and	nm_usuario_exec		= y.nm_usuario_prev
				and	dt_atividade between trunc(clock_timestamp()) and fim_dia(clock_timestamp())) group by	a.nr_sequencia,
			a.ie_classificacao,
			a.dt_ordem_servico,
			a.ie_prioridade,
			w.ds_setor_atendimento,
			p.nm_pessoa_fisica,
			a.ds_dano_breve,
			a.ie_classificacao,
			b.ds_estagio,
			z.ds_localizacao,
			a.ie_prioridade_desen,
			obter_tipo_os(a.dt_ordem_servico),
			a.ie_obriga_news,
			a.ds_just_ret_news,
			a.nr_seq_classif) alias22;
elsif (ie_opcao_p	= 'NE') then /* Não executadas */
	select	count(*)
	into STRICT	ds_retorno_w
	from (
		SELECT	a.nr_sequencia
		FROM man_ordem_ativ_prev y, w_resumo_prev_os_item r, pessoa_fisica p, grupo_desenvolvimento c, man_estagio_processo b, man_ordem_servico a
LEFT OUTER JOIN man_localizacao z ON (a.nr_seq_localizacao = z.nr_sequencia)
LEFT OUTER JOIN setor_atendimento w ON (z.cd_setor = w.cd_setor_atendimento)
WHERE a.nr_seq_estagio		= b.nr_sequencia and a.nr_sequencia		= y.nr_seq_ordem_serv  and r.nr_seq_ordem       = a.nr_sequencia and r.IE_TIPO_PREV = ie_tipo_prev_p and r.nm_usuario   = nm_usuario_p and r.dt_previsao  = dt_referencia_w  and a.nr_seq_grupo_des   = c.nr_sequencia and a.cd_pessoa_solicitante = p.cd_pessoa_fisica and y.dt_prevista between trunc(dt_referencia_w,'dd') and fim_dia(dt_referencia_w) and (coalesce(nr_seq_gerencia_p::text, '') = '' or c.nr_seq_gerencia = nr_seq_gerencia_p) and (coalesce(nr_seq_grupo_des_p::text, '') = '' or a.nr_seq_grupo_des = nr_seq_grupo_des_p) and a.ie_status_ordem <> '3' and (b.ie_desenv = 'S' or b.ie_tecnologia = 'S') and (coalesce(b.ie_situacao_os,'0') <> '3' or exists (	SELECT	1
							from	man_ordem_serv_ativ x
							where	x.nr_seq_ordem_serv = a.nr_sequencia
							and	x.nm_usuario_exec = y.nm_usuario_prev
							and	x.dt_atividade between trunc(y.dt_prevista,'dd') and fim_dia(y.dt_prevista)
											    )
			) and (coalesce(y.dt_real::text, '') = '' or y.pr_atividade <> 100) and exists (	select	1
				from	usuario_grupo_des p
		      		where	p.nr_seq_grupo = a.nr_seq_grupo_des
				and	p.nm_usuario_grupo = y.nm_usuario_prev) and not exists (	select	1
			       	from	man_ordem_serv_ativ
			       	where	nr_seq_ordem_serv	= a.nr_sequencia
			       	and	coalesce(dt_fim_atividade::text, '') = ''
			       	and	nm_usuario_exec	= y.nm_usuario_prev
			       	and	dt_atividade between trunc(clock_timestamp()) and fim_dia(clock_timestamp())
			       ) group by	a.nr_sequencia,
		a.ie_classificacao,
		a.dt_ordem_servico,
		a.ie_prioridade,
		w.ds_setor_atendimento,
		p.nm_pessoa_fisica,
		a.ds_dano_breve,
		a.ie_classificacao,
		b.ds_estagio,
		z.ds_localizacao,
		a.ie_prioridade_desen,
		obter_tipo_os(a.dt_ordem_servico),
		a.ie_obriga_news,
		a.ds_just_ret_news,
		a.nr_seq_classif) alias24;
elsif (ie_opcao_p	= 'EF') then /* Executadas  fora da previsão*/
	select	count(*)
	into STRICT	ds_retorno_w
	from (
		SELECT	a.nr_sequencia
		FROM man_ordem_ativ_prev y, w_resumo_prev_os_item r, pessoa_fisica p, grupo_desenvolvimento c, man_estagio_processo b, man_ordem_servico a
LEFT OUTER JOIN man_localizacao z ON (a.nr_seq_localizacao = z.nr_sequencia)
LEFT OUTER JOIN setor_atendimento w ON (z.cd_setor = w.cd_setor_atendimento)
WHERE a.nr_seq_estagio		= b.nr_sequencia and a.nr_sequencia		= y.nr_seq_ordem_serv and r.nr_seq_ordem       = a.nr_sequencia and r.ie_tipo_prev = ie_tipo_prev_p and r.nm_usuario   = nm_usuario_p and r.dt_previsao  = dt_referencia_w   and a.nr_seq_grupo_des   = c.nr_sequencia and a.cd_pessoa_solicitante = p.cd_pessoa_fisica and y.dt_prevista between trunc(dt_referencia_w,'dd') and fim_dia(dt_referencia_w) and (coalesce(nr_seq_gerencia_p::text, '') = '' or c.nr_seq_gerencia = nr_seq_gerencia_p) and (coalesce(nr_seq_grupo_des_p::text, '') = '' or a.nr_seq_grupo_des = nr_seq_grupo_des_p) and (coalesce(b.ie_situacao_os,'0') <> '3' or exists (	SELECT	1
							from	man_ordem_serv_ativ x
							where	x.nr_seq_ordem_serv = a.nr_sequencia
							and	x.nm_usuario_exec = y.nm_usuario_prev
							and	x.dt_atividade between trunc(y.dt_prevista,'dd') and fim_dia(y.dt_prevista))) and (y.dt_real IS NOT NULL AND y.dt_real::text <> '') and y.pr_atividade = 100 and y.ie_fora_planej_diario = 'S' and exists (	select	1
				from	usuario_grupo_des p
				where	p.nr_seq_grupo = a.nr_seq_grupo_des
		      		and	p.nm_usuario_grupo = y.nm_usuario_prev) group by	a.nr_sequencia,
			a.ie_classificacao,
			a.dt_ordem_servico,
			a.ie_prioridade,
			w.ds_setor_atendimento,
			p.nm_pessoa_fisica,
			a.ds_dano_breve,
			a.ie_classificacao,
			b.ds_estagio,
			z.ds_localizacao,
			a.ie_prioridade_desen,
			obter_tipo_os(a.dt_ordem_servico),
			a.ie_obriga_news,
			a.ds_just_ret_news,
			a.nr_seq_classif) alias16;
elsif (ie_opcao_p	= 'T') then /* Todas */
	select	count(*)
	into STRICT	ds_retorno_w
	from (
		SELECT	a.nr_sequencia
		FROM man_ordem_ativ_prev y, grupo_desenvolvimento c, man_estagio_processo b, man_ordem_servico a
LEFT OUTER JOIN man_localizacao z ON (a.nr_seq_localizacao = z.nr_sequencia)
LEFT OUTER JOIN setor_atendimento w ON (z.cd_setor = w.cd_setor_atendimento)
WHERE a.nr_seq_estagio		= b.nr_sequencia and a.nr_sequencia		= y.nr_seq_ordem_serv   and a.nr_seq_grupo_des   = c.nr_sequencia and y.dt_prevista between trunc(dt_referencia_w,'dd') and fim_dia(dt_referencia_w) and (coalesce(nr_seq_gerencia_p::text, '') = '' or c.nr_seq_gerencia = nr_seq_gerencia_p) and (coalesce(nr_seq_grupo_des_p::text, '') = '' or a.nr_seq_grupo_des = nr_seq_grupo_des_p) and exists (	SELECT	1
				from	usuario_grupo_des t
				where	t.nr_seq_grupo = a.nr_seq_grupo_des
				and   t.nm_usuario_grupo = y.nm_usuario_prev) group by	a.nr_sequencia,
			a.ie_classificacao,
			a.dt_ordem_servico,
			a.ie_prioridade,
			w.ds_setor_atendimento,
			a.ds_dano_breve,
			a.ie_classificacao,
			b.ds_estagio,
			z.ds_localizacao,
			a.ie_prioridade_desen,
			obter_tipo_os(a.dt_ordem_servico),
			a.ie_obriga_news,
			a.ds_just_ret_news,
			a.nr_seq_classif) alias10;
elsif (ie_opcao_p	= 'ET') then /* Executadas*/
	select	count(*)
	into STRICT	ds_retorno_w
	from (
		SELECT	a.nr_sequencia
		FROM man_ordem_ativ_prev y, grupo_desenvolvimento c, man_estagio_processo b, man_ordem_servico a
LEFT OUTER JOIN man_localizacao z ON (a.nr_seq_localizacao = z.nr_sequencia)
LEFT OUTER JOIN setor_atendimento w ON (z.cd_setor = w.cd_setor_atendimento)
WHERE a.nr_seq_estagio		= b.nr_sequencia and a.nr_sequencia		= y.nr_seq_ordem_serv   and a.nr_seq_grupo_des   = c.nr_sequencia and y.dt_prevista between trunc(dt_referencia_w,'dd') and fim_dia(dt_referencia_w) and (coalesce(nr_seq_gerencia_p::text, '') = '' or c.nr_seq_gerencia = nr_seq_gerencia_p) and (coalesce(nr_seq_grupo_des_p::text, '') = '' or a.nr_seq_grupo_des = nr_seq_grupo_des_p) and (y.dt_real IS NOT NULL AND y.dt_real::text <> '') and y.pr_atividade = 100 and exists (	SELECT	1
				from	usuario_grupo_des t
				where	t.nr_seq_grupo = a.nr_seq_grupo_des
				and   t.nm_usuario_grupo = y.nm_usuario_prev) group by	a.nr_sequencia,
			a.ie_classificacao,
			a.dt_ordem_servico,
			a.ie_prioridade,
			w.ds_setor_atendimento,
			a.ds_dano_breve,
			a.ie_classificacao,
			b.ds_estagio,
			z.ds_localizacao,
			a.ie_prioridade_desen,
			obter_tipo_os(a.dt_ordem_servico),
			a.ie_obriga_news,
			a.ds_just_ret_news,
			a.nr_seq_classif) alias11;
elsif (ie_opcao_p	= 'DP') then /* Defeitos pendentes*/
	select	count(1)
	into STRICT	ds_retorno_w
	from	man_estagio_processo b,
		man_ordem_servico a
	where	1=1
	and	a.ie_classificacao = 'E'
	and	a.nr_seq_estagio = b.nr_sequencia
	and	b.ie_desenv = 'S'
	and	b.ie_aguarda_cliente = 'N'
	and	b.nr_sequencia <> 261
	and	a.ie_status_ordem in ('1','2')
	and (a.nr_seq_grupo_des = nr_seq_grupo_des_p or coalesce(nr_seq_grupo_des_p::text, '') = '')
	and (substr(obter_gerencia_grupo_desen(a.nr_seq_grupo_des,'C'),1,20)  = nr_seq_gerencia_p or coalesce(nr_seq_gerencia_p::text, '') = '');
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_ordens_dia ( dt_referencia_p timestamp, ie_opcao_p text, nr_seq_gerencia_p bigint, nr_seq_grupo_des_p bigint, ie_tipo_prev_p text, nm_usuario_p text) FROM PUBLIC;

