-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_horarios_reapr ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_prescricoes_p text, nr_seq_horario_p bigint, ie_tipo_item_p text, dt_atual_p timestamp, dt_desejado_p timestamp, ie_seguintes_p text, nr_seq_cpoe_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_separador_c		constant varchar(1) := ' ';
ie_primeiro_w		varchar(1);
ds_hor_w			varchar(20)	:= '';
ds_horarios_w		varchar(255)	:= '';
qt_min_dif_w		bigint;
nr_seq_item_w		bigint;
nr_seq_horario_w	bigint;
dt_fim_validade_w	prescr_medica.dt_validade_prescr%type;
	
c01 CURSOR(nr_prescricao_pc  prescr_medica.nr_prescricao%type) FOR
    SELECT  distinct a.dt_horario
    from    reaprazar_horarios_html5_v a
    where   a.nr_seq_item   = nr_seq_item_w
    and     a.dt_horario    >= dt_atual_p
    and     a.ie_tipo_item  = ie_tipo_item_p
	and		a.nr_prescricao = nr_prescricao_pc
    order by dt_horario;
	
c02 CURSOR FOR
	SELECT	x.nr_registro nr_prescricao
	from	table(lista_pck.obter_lista(nr_prescricoes_p)) x;
	
BEGIN	

ie_primeiro_w	:= 'S';

qt_min_dif_w	:= (dt_desejado_p - dt_atual_p)::numeric  * 1440;

if (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') then
	for c02_w in c02 loop
		begin
			select	max(dt_validade_prescr)
			into STRICT	dt_fim_validade_w
			from	prescr_medica a
			where	a.nr_prescricao = c02_w.nr_prescricao;

			if (dt_fim_validade_w > dt_atual_p) then
				if (ie_tipo_item_p = 'SOL') then --Quando o tipo do item e solucao, o numero da etapa vem no horario
					select	max(a.nr_sequencia)
					into STRICT	nr_seq_item_w
					from	prescr_material a
					where	a.nr_prescricao = nr_prescricao_p
					and		a.nr_seq_mat_cpoe = nr_seq_cpoe_p;

					if (coalesce(nr_seq_item_w::text, '') = '') then
						select	max(a.nr_sequencia)
						into STRICT	nr_seq_horario_w
						from	prescr_mat_hor	a
						where	a.nr_prescricao	= nr_prescricao_p
						and		a.nr_etapa_sol	= nr_seq_horario_p
						and		a.dt_horario	= dt_atual_p;
					end if;

				else
					nr_seq_horario_w	:= nr_seq_horario_p;
				end if;

				if (coalesce(nr_seq_item_w::text, '') = '') then
					nr_seq_item_w	:= obter_seq_item_prescr(nr_seq_horario_w,ie_tipo_item_p);
				end if;

				for c01_w in c01(c02_w.nr_prescricao) loop
					begin
						ds_hor_w	:= to_char(c01_w.dt_horario + (qt_min_dif_w / 1440),'hh24:mi');

						if (qt_min_dif_w <> 0 and ie_seguintes_p = 'N') then
							qt_min_dif_w	:= 0;
						end if;
						
						if (ie_primeiro_w = 'S') then
							ie_primeiro_w 	:= 'N';
							ds_horarios_w	:= ds_hor_w;
						else
							ds_horarios_w	:= ds_horarios_w || ds_separador_c || ds_hor_w;
						end if;	
					end;
				end loop;
			end if;
		end;
	end loop;
end if;

return	trim(both ds_horarios_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_horarios_reapr ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_prescricoes_p text, nr_seq_horario_p bigint, ie_tipo_item_p text, dt_atual_p timestamp, dt_desejado_p timestamp, ie_seguintes_p text, nr_seq_cpoe_p bigint default null) FROM PUBLIC;

