-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_cooperado ( nr_seq_cooperado_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(255)	:= null;
cd_pessoa_fisica_w	varchar(10);
cd_cgc_w		varchar(14);

-- N - Nome
-- M - Matricula
-- EM - Email
BEGIN

if (nr_seq_cooperado_p IS NOT NULL AND nr_seq_cooperado_p::text <> '') then
	if (ie_opcao_p	= 'N') then
		select	obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc)
		into STRICT	ds_retorno_w
		from	pls_cooperado a
		where	a.nr_sequencia	= nr_seq_cooperado_p;
	elsif (ie_opcao_p	= 'M')	then
		select	max(a.cd_matricula)
		into STRICT	ds_retorno_w
		from	pls_cooperado a
		where	a.nr_sequencia	= nr_seq_cooperado_p;
	elsif (ie_opcao_p	= 'EM')	then
		select	max(a.cd_pessoa_fisica),
			max(a.cd_cgc)
		into STRICT	cd_pessoa_fisica_w,
			cd_cgc_w
		from	pls_cooperado a
		where	a.nr_sequencia	= nr_seq_cooperado_p;

		if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
			select	substr(max(ds_email),1,255)
			into STRICT	ds_retorno_w
			from	compl_pf_tel_adic
			where	cd_pessoa_fisica = cd_pessoa_fisica_w
			and	ie_email_princ	= 'S'
			and	nr_seq_compl	= (	SELECT	max(nr_sequencia)
							from	compl_pessoa_fisica
							where	ie_tipo_complemento = 30
							and	cd_pessoa_fisica = cd_pessoa_fisica_w);

			if (coalesce(trim(both ds_retorno_w)::text, '') = '') then
				select	substr(max(ds_email),1,255)
				into STRICT	ds_retorno_w
				from	compl_pf_tel_adic
				where	cd_pessoa_fisica = cd_pessoa_fisica_w
				and	nr_seq_compl	= (	SELECT	max(nr_sequencia)
								from	compl_pessoa_fisica
								where	ie_tipo_complemento = 30
								and	cd_pessoa_fisica = cd_pessoa_fisica_w);
			end if;

			if (coalesce(trim(both ds_retorno_w)::text, '') = '') then
				ds_retorno_w := substr(obter_dados_pf_pj(cd_pessoa_fisica_w,null,'M'),1,255);
			end if;

		elsif (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
			ds_retorno_w := substr(obter_dados_pf_pj(null,cd_cgc_w,'M'),1,255);
		end if;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_cooperado ( nr_seq_cooperado_p bigint, ie_opcao_p text) FROM PUBLIC;

