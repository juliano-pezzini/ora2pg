-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_item_prob_sem_dt_fim ( nr_seq_registro_p bigint, ie_tipo_registro_p text, nm_tabela_p text, cd_pessoa_fisica_p bigint, ie_const_fim_prob_p text default 'S') RETURNS varchar AS $body$
DECLARE

ds_retorno_w varchar(1) := 'N';					
ie_problema_finalizado_w varchar(1) := 'N';

BEGIN
if (nr_seq_registro_p IS NOT NULL AND nr_seq_registro_p::text <> '' AND ie_tipo_registro_p IS NOT NULL AND ie_tipo_registro_p::text <> '') then 
	 
	select	coalesce(max('N'),'S') 
	into STRICT	ie_problema_finalizado_w 
	from	lista_problema_pac 
	where	nr_sequencia in (SELECT c.nr_seq_problema 
						from lista_problema_pac_item c 
						where c.nr_seq_registro = nr_seq_registro_p 
						and c.ie_tipo_registro = ie_tipo_registro_p 
						and c.nm_tabela = nm_tabela_p) 
	and coalesce(dt_fim::text, '') = '';
	 
	if (ie_problema_finalizado_w = 'N' or ie_const_fim_prob_p = 'N') then 
		if (ie_tipo_registro_p = 'DM') then 
			if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then 
				select coalesce(max('S'),'N') 
				into STRICT ds_retorno_w 
				from diagnostico_doenca d, atendimento_paciente e 
				where d.nr_atendimento = e.nr_atendimento 
				and e.cd_pessoa_fisica = cd_pessoa_fisica_p 
				and d.nr_seq_interno = nr_seq_registro_p 
				and coalesce(d.dt_fim::text, '') = '';
			end if;
		elsif (ie_tipo_registro_p = 'HS') then 
			if (nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '') then 
				if (nm_tabela_p = 'PACIENTE_ALERGIA') then 
					select coalesce(max('S'),'N') 
					into STRICT ds_retorno_w 
					from paciente_alergia 
					where nr_sequencia = nr_seq_registro_p 
					and coalesce(dt_fim::text, '') = '';
					 
				elsif (nm_tabela_p = 'PACIENTE_HABITO_VICIO') then 
					select coalesce(max('S'),'N') 
					into STRICT ds_retorno_w 
					from paciente_habito_vicio 
					where nr_sequencia = nr_seq_registro_p 
					and coalesce(dt_fim::text, '') = '';
					 
				elsif (nm_tabela_p = 'PACIENTE_ANTEC_CLINICO') then 
					select coalesce(max('S'),'N') 
					into STRICT ds_retorno_w 
					from paciente_antec_clinico 
					where nr_sequencia = nr_seq_registro_p 
					and coalesce(dt_fim::text, '') = '';			
				 
				end if;
			end if;
		end if;
	end if;
		 
end if;
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_item_prob_sem_dt_fim ( nr_seq_registro_p bigint, ie_tipo_registro_p text, nm_tabela_p text, cd_pessoa_fisica_p bigint, ie_const_fim_prob_p text default 'S') FROM PUBLIC;

