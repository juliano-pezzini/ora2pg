-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_horario_dieta (nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_horario_p bigint, dt_horario_p timestamp, nr_prescricoes_p text) RETURNS varchar AS $body$
DECLARE


ds_informacao_w		varchar(4000);
nr_prescricao_w		bigint;
dt_prescricao_w		varchar(20);
dt_prim_horario_w	varchar(20);
nr_horas_validade_w	integer;
nm_prescritor_w		varchar(60);
nm_responsavel_w	varchar(60);
ds_item_w			varchar(240);
ds_observacao_w		varchar(255);
ds_observacoes_w	varchar(4000);

/* obter dietas */

c01 CURSOR FOR
SELECT	substr(obter_nome_dieta(cd_dieta),1,80),
	ds_observacao
from	prescr_dieta
where	nr_prescricao = nr_prescricao_w
order by
	nr_sequencia;


BEGIN
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	/* obter prescrição */

	if (coalesce(nr_prescricao_p,0) > 0) then
		nr_prescricao_w := nr_prescricao_p;
	else
		select	obter_prescricao_horario(nr_seq_horario_p, 'D', 'P') nr_prescricao
		into STRICT	nr_prescricao_w
		;
	end if;

	/* obter informações x prescrição */

	select	to_char(dt_prescricao,'dd/mm/yyyy hh24:mi'),
		to_char(dt_prescricao,'dd/mm/yyyy') || ' ' || to_char(dt_primeiro_horario,'hh24:mi'),
		nr_horas_validade,
		substr(obter_nome_pf(cd_prescritor),1,60)
	into STRICT	dt_prescricao_w,
		dt_prim_horario_w,
		nr_horas_validade_w,
		nm_prescritor_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_w;

	/* obter informações x atendimento */

	select	substr(coalesce(obter_resp_atend_data(nr_atendimento_p, dt_horario_p),obter_desc_expressao(327119)/*'Não informado'*/
),1,60)
	into STRICT	nm_responsavel_w
	;

	/* montar mensagem informações */

	ds_informacao_w :=	obter_desc_expressao(325814)/*'Prescrição: '*/
 || nr_prescricao_w  	|| CHR(10) ||
				obter_desc_expressao(327202)/*'Data: '*/
 || dt_prescricao_w  		|| CHR(10) ||
				obter_desc_expressao(648277)/*'Início: '*/
 || dt_prim_horario_w		|| CHR(10) ||
				obter_desc_expressao(296217)	||': '/*'Prescritor: '*/ || nm_prescritor_w  	|| CHR(10) ||
				obter_desc_expressao(330022)/*'Responsável: '*/
 || nm_responsavel_w	|| CHR(10) || CHR(10) ||
				obter_desc_expressao(781048)/*'Dietas relacionadas: '*/
 || CHR(10);

	/* gerar dietas mensagem */

	open c01;
	loop
	fetch c01 into 	ds_item_w,
			ds_observacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		ds_informacao_w := ds_informacao_w || '- ' || ds_item_w || chr(10);
		ds_observacoes_w := ds_observacoes_w || ds_observacao_w || chr(10);
		end;
	end loop;
	close c01;

	/* gerar prescrições mmensagem */

	ds_informacao_w := ds_informacao_w || chr(10) || obter_desc_expressao(323185)/*'Prescrições relacionadas: '*/
 || chr(10) || '- ' || nr_prescricoes_p || chr(10) || chr(10) ||
			obter_desc_expressao(692668)/*'Observações: '*/
 || ds_observacoes_w;
end if;

return ds_informacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_horario_dieta (nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_horario_p bigint, dt_horario_p timestamp, nr_prescricoes_p text) FROM PUBLIC;

