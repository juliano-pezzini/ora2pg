-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_unid_atend_setor_atual ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, ie_informacao_p text) RETURNS varchar AS $body$
DECLARE



/* Informacao
	U = Unidade basica - complementar
	UB = Unidade básica
	UC = Unidade complementar
	DT = Data entrada unidade
	CS = Código Setor
*/
cd_setor_atendimento_w		bigint;
ds_unidade_w			varchar(255);
cd_unidade_basica_w		varchar(010);
cd_unidade_compl_w		varchar(010);
ds_setor_atendimento_w		varchar(100);
nr_seq_interno_w		bigint;
dt_entrada_unidade_w		varchar(20);


BEGIN

if (coalesce(nr_atendimento_p,0) > 0) then
	begin

	select	coalesce(max(b.nr_seq_interno),0)
	into STRICT	nr_seq_interno_w
	from	setor_atendimento a,
		atend_paciente_unidade b
	where	b.nr_atendimento	= nr_atendimento_p
	and	b.cd_setor_atendimento	= a.cd_setor_atendimento
	and	b.cd_setor_atendimento	= cd_setor_atendimento_p
	and	coalesce(b.dt_saida_unidade::text, '') = '';

	if (nr_seq_interno_w = 0) then
		select	max(coalesce(b.nr_seq_interno,0))
		into STRICT	nr_seq_interno_w
		from	setor_atendimento a,
			atend_paciente_unidade b
		where	b.nr_atendimento	= nr_atendimento_p
		and	b.cd_setor_atendimento	= a.cd_setor_atendimento
		and	b.cd_setor_atendimento	= cd_setor_atendimento_p
		and	b.dt_saida_unidade	= (	SELECT	max(dt_saida_unidade)
							from	setor_atendimento a,
								atend_paciente_unidade b
							where	b.nr_atendimento	= nr_atendimento_p
							and	b.cd_setor_atendimento	= a.cd_setor_atendimento
							and	b.cd_setor_atendimento	= cd_setor_atendimento_p);
	end if;

	if (nr_seq_interno_w > 0) or (coalesce(nr_seq_interno_w::text, '') = '') then
		begin

		select	cd_setor_atendimento,
			cd_unidade_basica,
			cd_unidade_compl,
			to_char(dt_entrada_unidade,'dd/mm/yyyy hh24:mi:ss')
		into STRICT	cd_setor_atendimento_w,
			cd_unidade_basica_w,
			cd_unidade_compl_w,
			dt_entrada_unidade_w
		from	atend_paciente_unidade
		where	nr_seq_interno	= nr_seq_interno_w;

		if (ie_informacao_p = 'U') then
			ds_unidade_w	:= cd_unidade_basica_w || ' ' || cd_unidade_compl_w;
		elsif (ie_informacao_p = 'UB') then
			ds_unidade_w	:= cd_unidade_basica_w;
		elsif (ie_informacao_p = 'UC') then
			ds_unidade_w	:= cd_unidade_compl_w;
		elsif (ie_informacao_p = 'DT') then
			ds_unidade_w	:= dt_entrada_unidade_w;
		elsif (ie_informacao_p = 'CS') then
			ds_unidade_w	:= cd_setor_atendimento_w;
		end if;

		end;
	end if;

	end;
end if;

return ds_unidade_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_unid_atend_setor_atual ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, ie_informacao_p text) FROM PUBLIC;

