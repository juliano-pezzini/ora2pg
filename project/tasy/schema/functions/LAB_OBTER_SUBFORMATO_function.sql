-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_subformato ( nr_seq_formato_p bigint, nr_seq_exame_p bigint, qt_resultado_p bigint, pr_resultado_p bigint, nr_prescricao_p bigint, ds_resultado_p text) RETURNS bigint AS $body$
DECLARE

 
nr_seq_formato_w bigint;
ds_regra_w varchar(255);
vl_resultado_w double precision;
qt_idade_w double precision;
ie_tipo_atend_w	bigint;
nr_seq_cor_pele_w	bigint;
ie_sexo_w	varchar(1);

c01 CURSOR FOR 
 SELECT nr_seq_formato, 
  replace(replace(ds_regra, '@'||nr_seq_exame_p, 
	CASE WHEN coalesce(qt_resultado_p::text, '') = '' THEN chr(39)||ds_resultado_p||chr(39)  ELSE replace(qt_resultado_p,',','.') END ), 
	'%'||nr_seq_exame_p, replace(pr_resultado_p,',','.')) 
 from exame_lab_format 
 where nr_seq_superior = nr_seq_formato_p 
  and ds_regra like '%@' || nr_seq_exame_p || '%' 
 
union
 
 SELECT nr_seq_formato, 
  replace(replace(ds_regra, '@'||nr_seq_exame_p, 
	CASE WHEN coalesce(qt_resultado_p::text, '') = '' THEN chr(39)||ds_resultado_p||chr(39)  ELSE replace(qt_resultado_p,',','.') END ), 
	'%'||nr_seq_exame_p, replace(pr_resultado_p,',','.')) 
 from exame_lab_format 
 where nr_seq_superior = nr_seq_formato_p 
  and ds_regra like '%%' || nr_seq_exame_p || '%';

BEGIN
 
select max(round((a.dt_prescricao - coalesce(b.dt_nascimento,a.dt_prescricao)) / 365.25)), 
max(nr_seq_cor_pele), 
max(ie_sexo) 
into STRICT qt_idade_w, 
nr_seq_cor_pele_w, 
ie_sexo_w 
from pessoa_fisica b, 
 prescr_medica a 
where a.cd_pessoa_fisica = b.cd_pessoa_fisica 
 and a.nr_prescricao = nr_prescricao_p;
 
select	OBTER_TIPO_ATEND_PRESCR(nr_prescricao_p) 
into STRICT	ie_tipo_atend_w
;
 
open c01;
loop 
fetch c01 into nr_seq_formato_w, 
 ds_regra_w;
 EXIT WHEN NOT FOUND; /* apply on c01 */
 
 ds_regra_w := Substr(replace_macro(upper(ds_regra_w), '@IDADE', qt_idade_w),1,4000);
 ds_regra_w := Substr(replace_macro(upper(ds_regra_w), '@TIPO_ATEND', ie_tipo_atend_w),1,4000);
 ds_regra_w := Substr(replace_macro(upper(ds_regra_w), '@COR_PELE', nr_seq_cor_pele_w),1,4000);
 ds_regra_w := Substr(replace_macro(upper(ds_regra_w), '@SEXO', ie_sexo_w),1,4000);
 
 vl_resultado_w := obter_valor_dinamico('select 1 from dual where ' || ds_regra_w, vl_resultado_w);
 if (coalesce(vl_resultado_w::text, '') = '') or (vl_resultado_w = 0) then 
 vl_resultado_w := obter_valor_dinamico('select 1 from dual where ' || replace(ds_regra_w, ',', '.'), vl_resultado_w);
 end if;
 
 if (coalesce(vl_resultado_w,0) = 0) then 
 nr_seq_formato_w := '';
 else 
 exit;
 end if;
end loop;
close c01;
 
return nr_seq_formato_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_subformato ( nr_seq_formato_p bigint, nr_seq_exame_p bigint, qt_resultado_p bigint, pr_resultado_p bigint, nr_prescricao_p bigint, ds_resultado_p text) FROM PUBLIC;

