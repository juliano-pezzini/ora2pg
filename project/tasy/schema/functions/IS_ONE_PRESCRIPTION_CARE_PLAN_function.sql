-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION is_one_prescription_care_plan (nr_prescricoes_p text) RETURNS bigint AS $body$
DECLARE


nr_prescricoes_w                    varchar(2000);
ds_retorno_w                        smallint := 0;
is_care_plan                        smallint := 0;
nr_prescricao_w                     bigint;
pos_arr                             bigint;
loop_max                            bigint;

BEGIN

    select (length(nr_prescricoes_p) - length(replace(nr_prescricoes_p,',','')) + 1) into STRICT loop_max;

    nr_prescricoes_w := replace(nr_prescricoes_p, ' ', '');

    begin
        for indice in 1..loop_max loop
            pos_arr := position(',' in nr_prescricoes_w) - 1;
            if (pos_arr = -1) then
                pos_arr := length(nr_prescricoes_w);
            end if;

            nr_prescricao_w := substr(nr_prescricoes_w,0,pos_arr);
            nr_prescricoes_w := regexp_replace(nr_prescricoes_w,nr_prescricao_w,'',1,1);--tirando prescricao encontrada da string
            nr_prescricoes_w := regexp_replace(nr_prescricoes_w,',','',1,1);--tirando primeira virgula encontrada da string
            select count(*)
            into STRICT is_care_plan 
            from PE_PRESCRICAO 
            where NR_SEQUENCIA = nr_prescricao_w and IE_TIPO = 'CP';

            if (is_care_plan = 1) then
                ds_retorno_w := 1;
                return ds_retorno_w;
            end if;
        end loop;

    exception when others then
        ds_retorno_w := 0;
    end;
return ds_retorno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION is_one_prescription_care_plan (nr_prescricoes_p text) FROM PUBLIC;

