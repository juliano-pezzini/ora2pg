-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION rel_obter_pr_atend ( CD_CONVENIO_P bigint, DT_INICIAL_P timestamp, DT_FINAL_P timestamp, IE_TIPO_CONVENIO_P bigint, CD_ESTABELECIMENTO_P bigint, CD_CARATER_ATEND_P bigint, IE_INTERNADO_P text, IE_CDI_P text, IE_PRONTO_SOCORRO_P text, IE_AMBULATORIAL_P text) RETURNS bigint AS $body$
DECLARE

 
QT_TOTAL_CONV_W	bigint;
QT_TOTAL_W	bigint;


BEGIN 
SELECT	COUNT(*) 
INTO STRICT	QT_TOTAL_CONV_W 
FROM	ATENDIMENTO_PACIENTE A 
WHERE	A.DT_ENTRADA BETWEEN DT_INICIAL_P AND FIM_DIA(DT_FINAL_P) 
AND (A.IE_TIPO_CONVENIO = IE_TIPO_CONVENIO_P 
OR	IE_TIPO_CONVENIO_P = 0) 
AND (A.CD_ESTABELECIMENTO = CD_ESTABELECIMENTO_P 
OR	CD_ESTABELECIMENTO_P = 0) 
AND (A.IE_CARATER_INTER_SUS = CD_CARATER_ATEND_P 
OR	CD_CARATER_ATEND_P = 0) 
AND (A.IE_TIPO_ATENDIMENTO IN (	CASE WHEN IE_INTERNADO_P='S' THEN  1  ELSE 0 END , 
					CASE WHEN IE_CDI_P='S' THEN  7  ELSE 0 END , 
					CASE WHEN IE_PRONTO_SOCORRO_P='S' THEN  3  ELSE 0 END , 
					CASE WHEN IE_AMBULATORIAL_P='S' THEN  8  ELSE 0 END ) 
OR (IE_INTERNADO_P = 'N' 
AND	IE_CDI_P = 'N' 
AND	IE_PRONTO_SOCORRO_P = 'N' 
AND	IE_AMBULATORIAL_P = 'N')) 
AND	OBTER_CONVENIO_ATENDIMENTO(A.NR_ATENDIMENTO) = CD_CONVENIO_P;
 
SELECT	SUM(COUNT(*)) 
INTO STRICT	QT_TOTAL_W 
FROM	ATENDIMENTO_PACIENTE A 
WHERE	A.DT_ENTRADA BETWEEN DT_INICIAL_P AND FIM_DIA(DT_FINAL_P) 
AND (A.IE_TIPO_CONVENIO = IE_TIPO_CONVENIO_P 
OR	IE_TIPO_CONVENIO_P = 0) 
AND (A.CD_ESTABELECIMENTO = CD_ESTABELECIMENTO_P 
OR	CD_ESTABELECIMENTO_P = 0) 
AND (A.IE_CARATER_INTER_SUS = CD_CARATER_ATEND_P 
OR	CD_CARATER_ATEND_P = 0) 
AND (A.IE_TIPO_ATENDIMENTO IN (	CASE WHEN IE_INTERNADO_P='S' THEN  1  ELSE 0 END , 
					CASE WHEN IE_CDI_P='S' THEN  7  ELSE 0 END , 
					CASE WHEN IE_PRONTO_SOCORRO_P='S' THEN  3  ELSE 0 END , 
					CASE WHEN IE_AMBULATORIAL_P='S' THEN  8  ELSE 0 END ) 
OR (IE_INTERNADO_P = 'N' 
AND	IE_CDI_P = 'N' 
AND	IE_PRONTO_SOCORRO_P = 'N' 
AND	IE_AMBULATORIAL_P = 'N')) 
GROUP BY OBTER_CONVENIO_ATENDIMENTO(A.NR_ATENDIMENTO);
 
RETURN	round((QT_TOTAL_CONV_W * 100 / QT_TOTAL_W)::numeric,2);
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION rel_obter_pr_atend ( CD_CONVENIO_P bigint, DT_INICIAL_P timestamp, DT_FINAL_P timestamp, IE_TIPO_CONVENIO_P bigint, CD_ESTABELECIMENTO_P bigint, CD_CARATER_ATEND_P bigint, IE_INTERNADO_P text, IE_CDI_P text, IE_PRONTO_SOCORRO_P text, IE_AMBULATORIAL_P text) FROM PUBLIC;

