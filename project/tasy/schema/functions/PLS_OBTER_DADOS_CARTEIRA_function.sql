-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_carteira ( nr_seq_carteira_p bigint, cd_usuario_plano_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

				 
/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade:  Obter dados do segurado e do cartão de identificação 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ x ] Tasy (Delphi/Java) [ x ] Portal [ ] Relatórios [ ] Outros: 
 ---------------------------------------------------------------------------------------------------------------------------------------------------- 
Pontos de atenção: 
	Essa função é utilizada nas seguintes tabelas do dicionário de dados: 
 
	* PLS_PROCESSO_CONTA (cd_pessoa_fisica_f) 
	* PLS_PROCESSO_CONTA (nm_beneficiario) 
	* PLS_PROCESSO_CONTA (nr_seq_segurado_f) 
 
	 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++				 
 
	ie_opcao_p	 
 
	S - Nr. sequência do segurado 
	C - Número da carteirinha 
	N - Nome segurado 
	V - Validade carteira 
	T - Status da carteira 
	DT - Descrição do Status 
	E - Email do segurado 
	SC - Nr sequencia da carteira 
	PF - Pessoa física do segurado 
	DS - Data de solicitação 
	NS - Nome do solicitante 
	O - Observação 
	VI - Via carteira 
	ES - Estipulante 
	SU - Subestipulante 
	DI - Data início vigência -> Alex August Schlote 01/04/2010 
	T1 - Trilha1 
	T2 - Trilha2 
	T3 - Trilha3 
	P - Pagador 
	SP - Sequência pagador 
	DD - Data de devolução 
	DE - Data de envio da carteirinha para o lote de emissão. 
*/ 
 
 
 
ds_retorno_w			varchar(255);
nm_segurado_w			varchar(255);
ds_observacao_w			varchar(255);
nm_usuario_solicitante_w	varchar(255);
cd_usuario_plano_w		varchar(30);
cd_pessoa_fisica_w		varchar(10);
nr_via_solicitacao_w		varchar(5);
ie_situacao_w			varchar(1);
nr_seq_segurado_w		bigint;
nr_seq_carteira_w		bigint;
nr_seq_pagador_w		bigint;
dt_validade_carteira_w		timestamp;
dt_solicitacao_w		timestamp;
dt_inicio_vigencia_w		timestamp;
dt_devolucao_w			timestamp;
dt_envio_w			timestamp;


BEGIN 
nr_seq_carteira_w	:= nr_seq_carteira_p;
 
if (coalesce(nr_seq_carteira_w::text, '') = '') then 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_carteira_w 
	from	pls_segurado_carteira 
	where	cd_usuario_plano	= cd_usuario_plano_p;
end if;
 
if ((nr_seq_carteira_w IS NOT NULL AND nr_seq_carteira_w::text <> '') and ie_opcao_p = 'SC') then 
	ds_retorno_w	:= nr_seq_carteira_w;
	 
	return ds_retorno_w;
end if;
 
if (nr_seq_carteira_w IS NOT NULL AND nr_seq_carteira_w::text <> '') then 
	if (ie_opcao_p = 'S') then 
		select	a.nr_seq_segurado 
		into STRICT	nr_seq_segurado_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
		 
		ds_retorno_w	:= to_char(nr_seq_segurado_w);
	elsif (ie_opcao_p = 'C') then 
		select	a.cd_usuario_plano 
		into STRICT	cd_usuario_plano_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
		 
		ds_retorno_w 	:= cd_usuario_plano_w;
	elsif (ie_opcao_p = 'N') then 
		select	substr(obter_nome_pf(b.cd_pessoa_fisica),1,255) 
		into STRICT	nm_segurado_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
	 
		ds_retorno_w 	:= nm_segurado_w;
	elsif (ie_opcao_p = 'V') then 
		select	trunc(dt_validade_carteira,'dd') 
		into STRICT	dt_validade_carteira_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
	 
		ds_retorno_w 	:= to_char(dt_validade_carteira_w,'dd/mm/yyyy');
	elsif (ie_opcao_p = 'T') then 
		select	a.ie_situacao 
		into STRICT	ie_situacao_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
	 
		ds_retorno_w 	:= ie_situacao_w;
	elsif (ie_opcao_p = 'E') then 
		select	b.cd_pessoa_fisica 
		into STRICT	cd_pessoa_fisica_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
		 
		select	ds_email 
		into STRICT	ds_retorno_w 
		from	compl_pessoa_fisica 
		where	cd_pessoa_fisica	= cd_pessoa_fisica_w 
		and	ie_tipo_complemento 	= 1;
	elsif (ie_opcao_p = 'PF') then 
		select	b.cd_pessoa_fisica 
		into STRICT	cd_pessoa_fisica_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
	 
		ds_retorno_w	:= cd_pessoa_fisica_w;
	elsif (ie_opcao_p = 'DS') then 
		select	a.dt_solicitacao 
		into STRICT	dt_solicitacao_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
		 
		ds_retorno_w 	:= to_char(dt_solicitacao_w,'dd/mm/yyyy');
	elsif (ie_opcao_p = 'NS') then 
		select	a.nm_usuario_solicitante 
		into STRICT	nm_usuario_solicitante_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
	 
		ds_retorno_w 	:= nm_usuario_solicitante_w;
	elsif (ie_opcao_p = 'O') then 
		select	a.ds_observacao 
		into STRICT	ds_observacao_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
	 
		ds_retorno_w 	:= ds_observacao_w;
	elsif (ie_opcao_p = 'VI') then 
		select	a.nr_via_solicitacao 
		into STRICT	nr_via_solicitacao_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
	 
		ds_retorno_w 	:= to_char(nr_via_solicitacao_w);
	elsif (ie_opcao_p = 'ES') then 
		select	a.nr_seq_segurado 
		into STRICT	nr_seq_segurado_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
	 
		select	substr(obter_nome_pf_pj(b.cd_pf_estipulante, b.cd_cgc_estipulante),1,80) 
		into STRICT	ds_retorno_w 
		from	pls_segurado a, 
			pls_contrato b 
		where	b.nr_sequencia	= a.nr_seq_contrato 
		and	a.nr_sequencia	= nr_seq_segurado_w;
	elsif (ie_opcao_p = 'SU') then 
		select	a.nr_seq_segurado 
		into STRICT	nr_seq_segurado_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
	 
		select	substr(obter_nome_pf_pj(b.cd_pessoa_fisica, b.cd_cgc),1,80) 
		into STRICT	ds_retorno_w 
		from	pls_segurado a, 
			pls_sub_estipulante b 
		where	b.nr_sequencia	= a.nr_seq_subestipulante 
		and	a.nr_sequencia	= nr_seq_segurado_w;
	elsif (ie_opcao_p = 'DI') then 
		select	a.dt_inicio_vigencia 
		into STRICT	dt_inicio_vigencia_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
	 
		ds_retorno_w	:= to_char(dt_inicio_vigencia_w);
	elsif (ie_opcao_p = 'T1') then 
		select	max(ds_trilha1) 
		into STRICT	ds_retorno_w 
		from	pls_segurado_carteira 
		where	nr_sequencia = nr_seq_carteira_p;
	elsif (ie_opcao_p = 'T2') then 
		select	max(ds_trilha2) 
		into STRICT	ds_retorno_w 
		from	pls_segurado_carteira 
		where	nr_sequencia = nr_seq_carteira_p;
	elsif (ie_opcao_p = 'T3') then 
		select	max(ds_trilha3) 
		into STRICT	ds_retorno_w 
		from	pls_segurado_carteira 
		where	nr_sequencia = nr_seq_carteira_p;
	elsif (ie_opcao_p = 'DT') then 
		select	a.ie_situacao 
		into STRICT	ie_situacao_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
	 
		if (ie_situacao_w = 'P') then 
			ds_retorno_w	:= 'Provisório';
		elsif (ie_situacao_w = 'D') then	 
			ds_retorno_w	:= 'Definitivo';
		end if;	
	elsif (ie_opcao_p = 'P') then 
		select	b.nr_seq_pagador 
		into STRICT	nr_seq_pagador_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
		 
		select (	select x.nm_pessoa_fisica 
				from	pessoa_fisica x 
				where	x.cd_pessoa_fisica = a.cd_pessoa_fisica 
				
UNION ALL
 
				select	y.ds_razao_social 
				from	pessoa_juridica y 
				where	y.cd_cgc	= a.cd_cgc) 
		into STRICT	ds_retorno_w 
		from	pls_contrato_pagador	a 
		where	nr_sequencia	= nr_seq_pagador_w;
	elsif (ie_opcao_p = 'SP') then 
		select	b.nr_seq_pagador 
		into STRICT	nr_seq_pagador_w 
		from	pls_segurado_carteira a, 
			pls_segurado b 
		where	a.nr_seq_segurado	= b.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_carteira_w;
		 
		ds_retorno_w	:= nr_seq_pagador_w;
	elsif (ie_opcao_p = 'DD') then 
		select	max(b.dt_alteracao) 
		into STRICT	dt_devolucao_w 
		from	pls_segurado_carteira	a, 
			pls_segurado_cart_estagio b 
		where	b.nr_seq_cartao_seg = a.nr_sequencia 
		and	a.nr_sequencia	= nr_seq_carteira_w 
		and	b.ie_estagio_emissao = '8' 
		and	a.nr_via_solicitacao = b.nr_via;
		 
		ds_retorno_w	:= to_char(dt_devolucao_w,'dd/mm/yyyy');
		 
	elsif (ie_opcao_p = 'DE') then 
		select	max(a.dt_envio) 
		into STRICT	dt_envio_w 
		from	pls_lote_carteira a, 
			pls_carteira_emissao b, 
			pls_segurado_carteira c 
		where	b.nr_seq_lote = a.nr_sequencia 
		and	b.nr_seq_seg_carteira = c.nr_sequencia 
		and	c.nr_sequencia = nr_seq_carteira_w;
		 
		ds_retorno_w	:= to_char(dt_envio_w,'dd/mm/yyyy');
	end if;
end if;
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_carteira ( nr_seq_carteira_p bigint, cd_usuario_plano_p text, ie_opcao_p text) FROM PUBLIC;

