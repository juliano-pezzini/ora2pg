-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_se_ass_dig_rel ( nr_seq_evento_p bigint default 0, nr_seq_horario_p bigint default 0, nr_seq_cpoe_p bigint default 0, nr_prescricao_p bigint default 0, nr_seq_item_p bigint default 0, nr_seq_apres_view_p bigint default 0, ie_tipo_solucao_p bigint default 0, ie_tipo_consulta_p text default 'P') RETURNS varchar AS $body$
DECLARE


ie_assinatura_w  	varchar(1)	:= 'N';

BEGIN

if (ie_tipo_consulta_p in ('A', 'S', 'I', 'T')) then
	if (nr_seq_apres_view_p = 1) then

		select	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	prescr_mat_alteracao a,
				prescr_dieta_hor b
		where	a.nr_seq_horario_dieta = b.nr_sequencia
		and (a.nr_sequencia = nr_seq_evento_p
		or		a.nr_seq_horario_dieta = nr_seq_horario_p)
		and		coalesce(a.ie_evento_valido, 'S') = 'S'
		and 	coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')
		and		(((b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '')
		and		ie_tipo_consulta_p = 'A'
		and 	a.ie_alteracao = 3)
		or ((b.dt_suspensao IS NOT NULL AND b.dt_suspensao::text <> '')
		and		ie_tipo_consulta_p = 'S'
		and 	a.ie_alteracao = 5));

	elsif (nr_seq_apres_view_p in (2, 3, 4, 8, 9, 10, 13)) then	

		select	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	prescr_mat_alteracao a,
				prescr_mat_hor b
		where	a.nr_seq_horario = b.nr_sequencia
		and (a.nr_sequencia = nr_seq_evento_p
		or		a.nr_seq_horario = nr_seq_horario_p)
		and		coalesce(a.ie_evento_valido, 'S') = 'S'
		and 	coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')
		and		(((b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '')
		and		ie_tipo_consulta_p = 'A'
		and		a.ie_alteracao = 3)
		or ((b.dt_suspensao IS NOT NULL AND b.dt_suspensao::text <> '')
		and		ie_tipo_consulta_p = 'S'
		and		a.ie_alteracao = 5));


	elsif (nr_seq_apres_view_p in (5, 11, 12)) then

		select	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	prescr_mat_alteracao a,
				prescr_proc_hor b
		where	a.nr_seq_horario_proc = b.nr_sequencia
		and (a.nr_sequencia = nr_seq_evento_p
		or		a.nr_seq_horario_proc = nr_seq_horario_p)
		and		coalesce(a.ie_evento_valido, 'S') = 'S'
		and 	coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')
		and		(((b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '')
		and		ie_tipo_consulta_p = 'A'
		and 	a.ie_alteracao = 3)
		or ((b.dt_suspensao IS NOT NULL AND b.dt_suspensao::text <> '')
		and		ie_tipo_consulta_p = 'S'
		and		a.ie_alteracao = 5));


	elsif (nr_seq_apres_view_p = 6) then

		select	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	prescr_mat_alteracao a,
				prescr_rec_hor b
		where	a.nr_seq_horario_rec = b.nr_sequencia
		and (a.nr_sequencia = nr_seq_evento_p
		or		a.nr_seq_horario_rec = nr_seq_horario_p)
		and		coalesce(a.ie_evento_valido, 'S') = 'S'
		and 	coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')
		and		(((b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '')
		and		ie_tipo_consulta_p  = 'A'
		and 	a.ie_alteracao = 3)
		or ((b.dt_suspensao IS NOT NULL AND b.dt_suspensao::text <> '')
		and		ie_tipo_consulta_p = 'S'
		and 	a.ie_alteracao = 5));


	elsif (nr_seq_apres_view_p = 7) then

		select	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	prescr_mat_alteracao a,
				pe_prescr_proc_hor b
		where	a.nr_seq_horario_sae= b.nr_sequencia
		and (a.nr_sequencia = nr_seq_evento_p
		or		a.nr_seq_horario_sae = nr_seq_horario_p)
		and		coalesce(a.ie_evento_valido, 'S') = 'S'
		and 	coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')
		and		(((b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '')
		and		ie_tipo_consulta_p = 'A'
		and 	a.ie_alteracao = 3)
		or ((b.dt_suspensao IS NOT NULL AND b.dt_suspensao::text <> '')
		and		ie_tipo_consulta_p = 'S'
		and 	a.ie_alteracao = 5));


	elsif (nr_seq_apres_view_p = 14) then

		select	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	prescr_gasoterapia_evento a,
				prescr_mat_hor b
		where	a.nr_seq_horario = b.nr_sequencia
		and (a.nr_sequencia = nr_seq_evento_p
		or		a.nr_seq_horario = nr_seq_horario_p)
		and		coalesce(a.ie_evento_valido, 'S') = 'S'
		and		coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')
		and		(((b.dt_inicio_horario IS NOT NULL AND b.dt_inicio_horario::text <> '')
		and		coalesce(b.dt_fim_horario::text, '') = ''
		and		coalesce(b.dt_suspensao::text, '') = ''
		and		ie_tipo_consulta_p = 'I'
		and		a.ie_evento in ('I', 'R'))
		or ((b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '')
		and		coalesce(b.dt_suspensao::text, '') = ''
		and		ie_tipo_consulta_p = 'A'
		and 	a.ie_evento = 'T')
		or ((b.dt_suspensao IS NOT NULL AND b.dt_suspensao::text <> '')
		and		ie_tipo_consulta_p = 'S'
		and 	a.ie_evento in ('S', 'SH')));

	elsif (coalesce(nr_seq_apres_view_p,0) = 999) then

		select	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	atendimento_monit_resp a
		where	a.nr_sequencia = nr_seq_evento_p
		and		coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')
		and		coalesce(a.dt_inativacao::text, '') = '';

	elsif (coalesce(ie_tipo_solucao_p, 0) = 1) then

		select	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	prescr_solucao_evento a,
				prescr_mat_hor b
		where	a.nr_prescricao = b.nr_prescricao
		and		a.nr_seq_solucao = b.nr_seq_solucao
		and		a.nr_sequencia = nr_seq_evento_p
		and		a.ie_tipo_solucao = ie_tipo_solucao_p
		and		coalesce(a.ie_evento_valido, 'S') = 'S'
		and		coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')
		and		(((b.dt_inicio_horario IS NOT NULL AND b.dt_inicio_horario::text <> '')
		and		coalesce(b.dt_fim_horario::text, '') = ''
		and		coalesce(b.dt_suspensao::text, '') = ''
		and		ie_tipo_consulta_p = 'I'
		and		a.ie_alteracao in (1, 3, 35))
		or ((b.dt_inicio_horario IS NOT NULL AND b.dt_inicio_horario::text <> '')
		and		(b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '')
		and		coalesce(b.dt_suspensao::text, '') = ''
		and		ie_tipo_consulta_p = 'T'
		and 	a.ie_alteracao = 4)
		or ((b.dt_suspensao IS NOT NULL AND b.dt_suspensao::text <> '')
		and		ie_tipo_consulta_p = 'S'
		and 	a.ie_alteracao = 53));

	elsif (coalesce(ie_tipo_solucao_p, 0) = 2) then

		select	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	prescr_solucao_evento a,
				prescr_mat_hor b
		where	a.nr_prescricao = b.nr_prescricao
		and		a.nr_seq_material = b.nr_seq_material
		and		a.nr_sequencia = nr_seq_evento_p
		and		a.ie_tipo_solucao = ie_tipo_solucao_p
		and		coalesce(a.ie_evento_valido, 'S') = 'S'
		and 	coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')
		and		(((b.dt_inicio_horario IS NOT NULL AND b.dt_inicio_horario::text <> '')
		and		coalesce(b.dt_fim_horario::text, '') = ''
		and		coalesce(b.dt_suspensao::text, '') = ''
		and		ie_tipo_consulta_p = 'I'
		and		a.ie_alteracao in (1, 3, 35))
		or ((b.dt_inicio_horario IS NOT NULL AND b.dt_inicio_horario::text <> '')
		and		(b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '')
		and		coalesce(b.dt_suspensao::text, '') = ''
		and		ie_tipo_consulta_p = 'T'
		and 	a.ie_alteracao = 4)
		or ((b.dt_suspensao IS NOT NULL AND b.dt_suspensao::text <> '')
		and		ie_tipo_consulta_p = 'S'
		and 	a.ie_alteracao = 53));

	elsif (coalesce(ie_tipo_solucao_p, 0) = 3) then

		select	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	prescr_solucao_evento a,
				prescr_proc_hor b
		where	a.nr_prescricao = b.nr_prescricao
		and		a.nr_seq_procedimento = b.nr_seq_procedimento
		and		a.nr_sequencia = nr_seq_evento_p
		and		a.ie_tipo_solucao = ie_tipo_solucao_p
		and		coalesce(a.ie_evento_valido, 'S') = 'S'
		and 	coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')
		and		(((b.dt_inicio_horario IS NOT NULL AND b.dt_inicio_horario::text <> '')
		and		coalesce(b.dt_fim_horario::text, '') = ''
		and		coalesce(b.dt_suspensao::text, '') = ''
		and		ie_tipo_consulta_p = 'I'
		and		a.ie_alteracao in (1, 3))
		or ((b.dt_inicio_horario IS NOT NULL AND b.dt_inicio_horario::text <> '')
		and		(b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '')
		and		coalesce(b.dt_suspensao::text, '') = ''
		and		ie_tipo_consulta_p = 'T'
		and 	a.ie_alteracao = 4)
		or ((b.dt_suspensao IS NOT NULL AND b.dt_suspensao::text <> '')
		and		ie_tipo_consulta_p = 'S'
		and 	a.ie_alteracao = 53));

	elsif (coalesce(ie_tipo_solucao_p, 0) = 999) then

		select	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	hd_prescricao_evento a,
				prescr_solucao b,
				prescr_mat_hor c
		where	a.nr_prescricao = b.nr_prescricao
		and		a.nr_seq_solucao = b.nr_seq_solucao
		and		b.nr_prescricao = c.nr_prescricao
		and		b.nr_seq_solucao = c.nr_seq_solucao
		and		a.nr_prescricao = nr_prescricao_p
		and		a.nr_seq_solucao = nr_seq_item_p
		and 	coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')
		and		(((c.dt_inicio_horario IS NOT NULL AND c.dt_inicio_horario::text <> '')
		and		coalesce(c.dt_fim_horario::text, '') = ''
		and		coalesce(c.dt_suspensao::text, '') = ''
		and		ie_tipo_consulta_p = 'I'
		and		a.ie_evento in ('II', 'IT', 'DI'))
		or ((c.dt_inicio_horario IS NOT NULL AND c.dt_inicio_horario::text <> '')
		and		(c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> '')
		and		coalesce(c.dt_suspensao::text, '') = ''
		and		ie_tipo_consulta_p = 'T'
		and 	a.ie_evento in ('DT', 'T'))
		or ((c.dt_suspensao IS NOT NULL AND c.dt_suspensao::text <> '')
		and		ie_tipo_consulta_p = 'S'
		and 	a.ie_evento in ('SI', 'SE')));

	end if;
else
	if (nr_seq_apres_view_p = 1) then

		select 	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	cpoe_dieta a,
				prescr_dieta b
		where	b.nr_seq_dieta_cpoe = a.nr_sequencia
		and		((a.nr_sequencia = nr_seq_cpoe_p and
				coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')) 
		or (b.nr_prescricao = nr_prescricao_p 
		and 	b.nr_sequencia = nr_seq_item_p
		and		coalesce(b.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(b.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(b.nr_seq_assinatura))::text <> '')));

	elsif (nr_seq_apres_view_p in (2, 3, 4, 8, 9, 10, 13)) then

		if (nr_seq_apres_view_p in (3,4,8,9)) then

			select 	coalesce(max('S'),'N') ie_assinado
			into STRICT	ie_assinatura_w
			from	cpoe_material a,
					prescr_material b
			where	b.nr_seq_mat_cpoe = a.nr_sequencia
			and		((a.nr_sequencia = nr_seq_cpoe_p
			and 	coalesce(a.nr_seq_assinatura, 0) > 0
			and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> '')) 
			or (b.nr_prescricao = nr_prescricao_p 
			and 	b.nr_sequencia = nr_seq_item_p
			and		coalesce(b.nr_seq_assinatura, 0) > 0
			and		(obter_data_assinatura_digital(b.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(b.nr_seq_assinatura))::text <> '')));

		elsif (nr_seq_apres_view_p in (2, 10)) then

			select 	coalesce(max('S'),'N') ie_assinado
			into STRICT	ie_assinatura_w
			from	cpoe_dieta a,
					prescr_material b
			where	b.nr_seq_dieta_cpoe = a.nr_sequencia
			and		((a.nr_sequencia = nr_seq_cpoe_p
			and 	coalesce(a.nr_seq_assinatura, 0) > 0
			and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> ''))
			or (b.nr_prescricao = nr_prescricao_p 
			and 	b.nr_sequencia = nr_seq_item_p
			and		coalesce(b.nr_seq_assinatura, 0) > 0
			and		(obter_data_assinatura_digital(b.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(b.nr_seq_assinatura))::text <> '')));

		else

			select 	coalesce(max('S'),'N') ie_assinado
			into STRICT	ie_assinatura_w
			from	cpoe_dieta a,
					nut_pac b,
					prescr_material c
			where	b.nr_seq_npt_cpoe = a.nr_sequencia
			and		c.nr_seq_nut_pac = b.nr_sequencia
			and		((a.nr_sequencia = nr_seq_cpoe_p
			and     coalesce(a.nr_seq_assinatura, 0) > 0
			and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> ''))
			or		(c.nr_prescricao = nr_prescricao_p
			and		c.nr_sequencia = nr_seq_item_p
			and		(((coalesce(b.nr_seq_assinatura, 0) > 0
			and		(obter_data_assinatura_digital(b.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(b.nr_seq_assinatura))::text <> ''))
			or (coalesce(c.nr_seq_assinatura, 0) > 0
			and		(obter_data_assinatura_digital(c.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(c.nr_seq_assinatura))::text <> ''))))));

		end if;

	elsif (nr_seq_apres_view_p in (5, 11, 12)) then

		select 	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	cpoe_procedimento a,
				prescr_procedimento b
		where	a.nr_sequencia = nr_seq_cpoe_p
		and		((a.nr_sequencia = nr_seq_cpoe_p
		and     coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> ''))
		or (b.nr_prescricao = nr_prescricao_p
		and		b.nr_sequencia = nr_seq_item_p
		and		coalesce(b.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(b.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(b.nr_seq_assinatura))::text <> '')));

	elsif (nr_seq_apres_view_p = 6) then

		select 	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	cpoe_recomendacao a,
				prescr_recomendacao b
		where	b.nr_seq_rec_cpoe = a.nr_sequencia
		and		((a.nr_sequencia = nr_seq_cpoe_p
		and     coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> ''))
		or (b.nr_prescricao = nr_prescricao_p
		and		b.nr_sequencia = nr_seq_item_p
		and		coalesce(b.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(b.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(b.nr_seq_assinatura))::text <> '')));

	elsif (nr_seq_apres_view_p = 7) then

		select 	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	pe_prescr_proc b,
				pe_prescricao c
		where	b.nr_seq_prescr = c.nr_sequencia
		and		b.nr_seq_prescr = nr_prescricao_p
		and		b.nr_seq_item = nr_seq_item_p
		and		coalesce(c.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(c.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(c.nr_seq_assinatura))::text <> '');

	elsif (nr_seq_apres_view_p = 14) then

		select 	coalesce(max('S'),'N') ie_assinado
		into STRICT	ie_assinatura_w
		from	cpoe_gasoterapia a,
				prescr_gasoterapia b
		where	b.nr_seq_gas_cpoe = a.nr_sequencia
		and		((a.nr_sequencia = nr_seq_cpoe_p
		and     coalesce(a.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(a.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(a.nr_seq_assinatura))::text <> ''))
		or (b.nr_prescricao = nr_prescricao_p
		and		b.nr_sequencia = nr_seq_item_p
		and		coalesce(b.nr_seq_assinatura, 0) > 0
		and		(obter_data_assinatura_digital(b.nr_seq_assinatura) IS NOT NULL AND (obter_data_assinatura_digital(b.nr_seq_assinatura))::text <> '')));

	end if;
end if;

return ie_assinatura_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_se_ass_dig_rel ( nr_seq_evento_p bigint default 0, nr_seq_horario_p bigint default 0, nr_seq_cpoe_p bigint default 0, nr_prescricao_p bigint default 0, nr_seq_item_p bigint default 0, nr_seq_apres_view_p bigint default 0, ie_tipo_solucao_p bigint default 0, ie_tipo_consulta_p text default 'P') FROM PUBLIC;

