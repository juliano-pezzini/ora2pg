-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_prot_tipo_atend ( nr_interno_conta_p bigint, ie_tipo_protocolo_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(1)	:= 'S';
cd_convenio_w			integer;
qt_registros_w			integer	:= 0;
qt_reg_regra_w			integer	:= 0;
ie_tipo_atendimento_w		smallint;
ie_tipo_atend_conta_w		conta_paciente.ie_tipo_atend_conta%type;
cd_setor_atendimento_w		integer;
cd_procedencia_w		integer;
ie_regime_internacao_w		varchar(2);
nr_atendimento_w		bigint;
qt_atend_conv_w			bigint;
cd_estabelecimento_w		smallint;
ie_tipo_atend_tiss_w		varchar(2);

BEGIN


/* Buscar o tipo de atendimento e o convenio da conta */

SELECT	a.cd_convenio_parametro,
	b.ie_tipo_atendimento,
	a.ie_tipo_atend_conta,
	coalesce(b.cd_setor_atendimento,0),
	coalesce(b.cd_procedencia,0),
	b.nr_atendimento,
	coalesce(a.ie_tipo_atend_tiss,0),
	coalesce(a.cd_estabelecimento,0)
INTO STRICT	cd_convenio_w,
	ie_tipo_atendimento_w,
	ie_tipo_atend_conta_w,
	cd_setor_atendimento_w,
	cd_procedencia_w,
	nr_atendimento_w,
	ie_tipo_atend_tiss_w,	
	cd_estabelecimento_w
FROM	atendimento_paciente_v	b,
	conta_paciente		a
WHERE	nr_interno_conta	= nr_interno_conta_p
AND	a.nr_atendimento	= b.nr_atendimento;

SELECT	COUNT(*)
INTO STRICT	qt_atend_conv_w
FROM	atend_categoria_convenio
WHERE	nr_atendimento = nr_atendimento_w
AND	cd_convenio = cd_convenio_w;

IF (coalesce(qt_atend_conv_w,0) > 0) THEN
	SELECT	MAX(a.ie_regime_internacao)
	INTO STRICT	ie_regime_internacao_w
	FROM	atend_categoria_convenio a
	WHERE	a.nr_atendimento = nr_atendimento_w
	AND	a.cd_convenio = cd_convenio_w;
ELSE
	SELECT	MAX(a.ie_regime_internacao)
	INTO STRICT	ie_regime_internacao_w
	FROM	atend_categoria_convenio a
	WHERE	a.nr_atendimento = nr_atendimento_w
	AND	a.nr_seq_interno = obter_atecaco_atendimento(nr_atendimento_w);
END IF;

/* Verificar se existe regra para o convenio e tipo do protocolo */

SELECT	COUNT(*)
INTO STRICT	qt_registros_w
FROM	regra_prot_tipo_atend
WHERE	cd_convenio						= cd_convenio_w
AND	((ie_util_tipo_atend_conta = 'S' and  ie_tipo_atendimento = coalesce(ie_tipo_atend_conta_w, ie_tipo_atendimento_w))
OR (coalesce(ie_util_tipo_atend_conta, 'N') = 'N' and ie_tipo_atendimento = ie_tipo_atendimento_w));

/* Se existir regra, verificar quais os tipos de atendimentos permitido */

IF (qt_registros_w > 0 ) THEN
	SELECT	COUNT(*)
        INTO STRICT	qt_reg_regra_w
        FROM	regra_prot_tipo_atend
        WHERE	cd_convenio						= cd_convenio_w
        AND	ie_tipo_protocolo 					= ie_tipo_protocolo_p
        AND	((ie_util_tipo_atend_conta = 'S' and ie_tipo_atendimento = coalesce(ie_tipo_atend_conta_w, ie_tipo_atendimento_w))
		OR (coalesce(ie_util_tipo_atend_conta, 'N') = 'N' and ie_tipo_atendimento = ie_tipo_atendimento_w))
	AND 	coalesce(ie_tipo_atend_tiss,ie_tipo_atend_tiss_w)		= ie_tipo_atend_tiss_w
	AND	coalesce(cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
	AND	coalesce(cd_procedencia,cd_procedencia_w)			= cd_procedencia_w
	AND	((coalesce(ie_regime_internacao_w::text, '') = '') OR (coalesce(ie_regime_internacao,ie_regime_internacao_w) = ie_regime_internacao_w))
	AND	coalesce(cd_perfil, coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
	AND	coalesce(nm_usuario_regra, coalesce(wheb_usuario_pck.get_nm_usuario, 'Tasy')) = coalesce(wheb_usuario_pck.get_nm_usuario,'Tasy')
	AND	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w;

        /*Se o tipo de atendimento nao esta na regra entao nao podera visualizar o protocolo*/

        IF (qt_reg_regra_w	= 0) THEN
		ds_retorno_w	:= 'N';
        END IF;
END IF;

RETURN	ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_prot_tipo_atend ( nr_interno_conta_p bigint, ie_tipo_protocolo_p bigint) FROM PUBLIC;

