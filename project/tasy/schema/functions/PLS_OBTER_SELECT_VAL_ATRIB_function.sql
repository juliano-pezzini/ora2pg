-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_select_val_atrib ( ie_componente_p tabela_atributo.ie_componente%type, cd_exp_valores_p tabela_atributo.cd_exp_valores%type, ds_valores_p tabela_atributo.ds_valores%type, cd_dominio_p tabela_atributo.cd_dominio%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) RETURNS varchar AS $body$
DECLARE


-- Dicionario de Objetos 496137
cd_valor_w		varchar(255);
ds_valor_w		varchar(255);
cd_val_ret_w		varchar(255);
ds_val_ret_w		varchar(255);
ds_retorno_w		varchar(4000);
i     			integer;
ie_ultimo_w		boolean := false;
ie_componente_w		tabela_atributo.ie_componente%type	:= upper(ie_componente_p);
ds_valores_w		tabela_atributo.ds_valores%type		:= ds_valores_p;


BEGIN
-- Se for opção de RadioGroup (informando opções) / CheckBox (informar valores) / Edit (informando qual tabela/campo)
if	((ie_componente_w in ('RG','CB','DE')) and
	((cd_exp_valores_p IS NOT NULL AND cd_exp_valores_p::text <> '') or (ds_valores_p IS NOT NULL AND ds_valores_p::text <> ''))) and (upper(ds_valores_p) not like '%SELECT%') then

	-- Expressão
	if (coalesce(ds_valores_w::text, '') = '') and (cd_exp_valores_p IS NOT NULL AND cd_exp_valores_p::text <> '') then
		ds_valores_w := substr(obter_desc_expressao(cd_exp_valores_p),1,254);
	end if;

	-- Se for CheckBox
	if (ie_componente_w = 'CB') then
		ds_valores_w := trim(both replace(ds_valores_w,',',''));

		ds_retorno_w :=	'select '	|| chr(39) || substr(ds_valores_w,1,1) || chr(39) || ' cd,' || chr(13)
						|| chr(39) || 'Marcado' || chr(39) || ' ds'  || chr(13) ||
				'from dual'	|| chr(13) ||
				'union all'	|| chr(13) ||
				'select '	|| chr(39) || substr(ds_valores_w,2,1) || chr(39) || ' cd,' || chr(13)
						|| chr(39) || 'Desmarcado' || chr(39) || ' ds'  || chr(13) ||
				'from dual';

	-- Se for RadioGroup
	elsif (ie_componente_w in ('RG','DE')) then
		select	trim(both replace(replace(substr(ds_valores_w,1,position(')' in ds_valores_w)),'(',''),')',''))
		into STRICT	cd_valor_w
		;

		select	trim(both replace(replace(substr(ds_valores_w,position(')' in ds_valores_w),length(ds_valores_w)),'(',''),')',''))
		into STRICT	ds_valor_w
		;

		ds_retorno_w := null;
		for i in 1..length(cd_valor_w) loop

			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
				ds_retorno_w := ds_retorno_w || 'union all ' || chr(13);
			end if;

			cd_val_ret_w	:= trim(both replace(substr(cd_valor_w,1,position(',' in cd_valor_w)),',',''));
			ds_val_ret_w	:= trim(both replace(substr(ds_valor_w,1,position(',' in ds_valor_w)),',',''));
			ie_ultimo_w 	:= (coalesce(trim(both cd_val_ret_w)::text, '') = '');

			cd_valor_w	:= trim(both substr(cd_valor_w,position(',' in cd_valor_w)+1,length(cd_valor_w)));
			ds_valor_w	:= trim(both substr(ds_valor_w,position(',' in ds_valor_w)+1,length(ds_valor_w)));

			if (ie_ultimo_w) then
				cd_val_ret_w	:= replace(trim(both cd_valor_w),',','');
				ds_val_ret_w	:= replace(trim(both ds_valor_w),',','');
			end if;

			ds_retorno_w :=	ds_retorno_w || 'select '	|| chr(39) || cd_val_ret_w || chr(39) || ' cd,' || chr(13)
									|| chr(39) || ds_val_ret_w || chr(39) || ' ds'  || chr(13) ||
							'from dual'	|| chr(13);

			if (ie_ultimo_w) then
				exit;
			end if;
		end loop;
	end if;

-- Se tem select nos valores do campo
elsif (ds_valores_p IS NOT NULL AND ds_valores_p::text <> '') then
	ds_retorno_w := replace(upper(ds_valores_p),upper(':cd_estabelecimento'),cd_estabelecimento_p);

-- Se apenas tem dominio no campo
elsif (cd_dominio_p IS NOT NULL AND cd_dominio_p::text <> '') then
	ds_retorno_w	:=	' select	vl_dominio cd, ' 	|| chr(13) ||
				'		ds_expressao ds '	|| chr(13) ||
				' from		valor_dominio_v '	|| chr(13) ||
				' where		ie_situacao = '		|| chr(39) || 'A' || chr(39) || chr(13) ||
				' and		cd_dominio = ' 		|| chr(39) || cd_dominio_p || chr(39) || chr(13) ||
				' order by 2 ';
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_select_val_atrib ( ie_componente_p tabela_atributo.ie_componente%type, cd_exp_valores_p tabela_atributo.cd_exp_valores%type, ds_valores_p tabela_atributo.ds_valores%type, cd_dominio_p tabela_atributo.cd_dominio%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

