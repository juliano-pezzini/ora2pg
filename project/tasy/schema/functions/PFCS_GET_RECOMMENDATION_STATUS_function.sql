-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_recommendation_status ( nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


  
ie_recommendation_status varchar(5) := 'R';
ie_started_status            varchar(5)   := 'S';
ie_finished_status           varchar(5)   := 'F';
dt_start_time prescr_rec_hor.dt_horario%type;
dt_end_time prescr_rec_hor.dt_fim_horario%type;


BEGIN

  select dt_start, dt_end 
  into STRICT dt_start_time, dt_end_time
  from (
	  SELECT c.dt_horario dt_start, c.dt_fim_horario dt_end
	  from cpoe_recomendacao a,
		   prescr_recomendacao b,
		   prescr_rec_hor c,
       equipamento d,
       unidade_atend_equip e,
       atend_paciente_unidade f,
       unidade_atendimento g 
	  where a.nr_sequencia = b.nr_seq_rec_cpoe
		and   b.nr_sequencia = c.nr_seq_recomendacao
		and   b.nr_prescricao = c.nr_prescricao
		and   e.cd_equipamento = d.cd_equipamento
		and   e.cd_unidade_basica = g.cd_unidade_basica
		and   e.cd_setor_atendimento = g.cd_setor_atendimento
		and   a.nr_atendimento = f.nr_atendimento
		and   f.cd_unidade_basica = e.cd_unidade_basica
		and   f.cd_setor_atendimento = e.cd_setor_atendimento
		and   d.ie_tipo_equipamento = 'TL'
		and   f.cd_unidade_compl = e.cd_unidade_compl 
		and   a.nr_sequencia = nr_sequencia_p
		order by c.nr_sequencia desc) alias0 LIMIT 1;


  ie_recommendation_status :=
	  case 
    -- If the request was met and the device is still in use
		when (dt_start_time IS NOT NULL AND dt_start_time::text <> '') 
			and coalesce(dt_end_time::text, '') = '' 
		then ie_started_status
		-- If the request was met and the device use has been discontinued
		when (dt_start_time IS NOT NULL AND dt_start_time::text <> '') 
			and (dt_end_time IS NOT NULL AND dt_end_time::text <> '') 
		then ie_finished_status
	  end;

return ie_recommendation_status;

exception
-- If the request is not met, there will be no 
-- record in the prescr_rec_hor table. So,
when no_data_found then
  return ie_recommendation_status;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_recommendation_status ( nr_sequencia_p bigint) FROM PUBLIC;

