-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_desc_comp_rel ( cd_material_p bigint, nr_seq_hemoterapia_p bigint, ie_via_aplicacao_p text default null, qt_dose_p bigint default null, cd_unidade_medida_p text default null, cd_intervalo_p text default null, ds_doses_diferenciada_p text default null, ie_administracao_p text default null, ie_urgente_p text default null, nr_seq_adicional_p bigint default null, nr_seq_ataque_p bigint default null) RETURNS varchar AS $body$
DECLARE


	function desc_material return text is
		ds_retorno_w varchar(255);
	
BEGIN

		if (cd_material_p > 0) then
			if (nr_seq_hemoterapia_p IS NOT NULL AND nr_seq_hemoterapia_p::text <> '') then
				ds_retorno_w := '('||obter_desc_expressao(333812, null)||') ';
			end if;

			return substr(ds_retorno_w || obter_desc_material(cd_material_p),1,255) || ' ';
		end if;

		return null;
	end;

	function via_aplicacao return varchar2 is
		ds_retorno_ww	varchar2(255);
	begin
		if (ie_via_aplicacao_p IS NOT NULL AND ie_via_aplicacao_p::text <> '') then

			select	max(ds_via_aplicacao) ds
			into STRICT	ds_retorno_ww
			from	via_aplicacao
			where	ie_via_aplicacao = ie_via_aplicacao_p;

			return ' ' || obter_desc_expressao(301661, '') || ' ' || ds_retorno_ww || ' ';
		end if;
		return '';
	end;

	function dose_unidade_medidda return VARCHAR2 is
		qt_dose_w           varchar2(50);
	begin
		if (coalesce(ds_doses_diferenciada_p::text, '') = '') then
			--Colocar '0' antes da vírgula
			qt_dose_w := qt_dose_p;
			if (substr(qt_dose_p,1,1) = ',') then
				qt_dose_w	:= '0' || qt_dose_p;

				qt_dose_w	:= replace(qt_dose_w,'.',',');
			end if;

			return ' ' || qt_dose_w || ' ' || obter_dados_unid_medida(cd_unidade_medida_p, 'DS') || ' ';
		else
			--Colocar '0' antes da vírgula
			qt_dose_w := ds_doses_diferenciada_p;

			if (substr(ds_doses_diferenciada_p,1,1) = ',') then
				qt_dose_w	:= '0' || ds_doses_diferenciada_p;

			qt_dose_w	:= replace(qt_dose_w,'.',',');
			end if;

			return ' ' || qt_dose_w || ' ' || obter_dados_unid_medida(cd_unidade_medida_p, 'DS') || ' ';
		end if;
	end;

	function desc_intervalo return varchar2 is
	begin
		if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
			return ' ' || obter_desc_expressao(292190, '') || ': ' ||obter_desc_intervalo(cd_intervalo_p);
		end if;

		return '';
	end;

	function tipo_adm return varchar2 is
	begin

		IF (ie_administracao_p = 'N' ) THEN
			RETURN  ' ' || obter_desc_expressao(298074, '');
		ELSIF (ie_administracao_p = 'C') THEN
			RETURN ' ' || obter_desc_expressao(689215, '');
		END IF;

		return '';
	end;

	function ds_dose_ataque return varchar2 is
	begin

		if (coalesce(nr_seq_ataque_p,0) > 0) then
			return obter_desc_expressao(303811, '');
		end if;

		return null;

	end;

	function ds_dose_adicional return varchar2 is
	begin

		if (coalesce(nr_seq_adicional_p,0) > 0) then
			return obter_desc_expressao(656390, '');
		end if;

		return null;

	end;

	function ds_urgencia return varchar2 is
	begin

		if (ie_administracao_p = 'P') and (ie_urgente_p IS NOT NULL AND ie_urgente_p::text <> '') then
			return  ' ' || obter_valor_dominio(7069, ie_urgente_p);
		end if;

		return '';
	end;

begin

return substr(desc_material()|| dose_unidade_medidda|| via_aplicacao() || coalesce(ds_dose_ataque(),ds_dose_adicional(),desc_intervalo()) || tipo_adm() || ds_urgencia(),1,4000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_desc_comp_rel ( cd_material_p bigint, nr_seq_hemoterapia_p bigint, ie_via_aplicacao_p text default null, qt_dose_p bigint default null, cd_unidade_medida_p text default null, cd_intervalo_p text default null, ds_doses_diferenciada_p text default null, ie_administracao_p text default null, ie_urgente_p text default null, nr_seq_adicional_p bigint default null, nr_seq_ataque_p bigint default null) FROM PUBLIC;

