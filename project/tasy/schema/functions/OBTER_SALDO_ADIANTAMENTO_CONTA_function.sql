-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_saldo_adiantamento_conta (nr_adiantamento_p bigint, ie_opcao_p bigint) RETURNS varchar AS $body$
DECLARE

vl_disponivel_w 	double precision;
ie_tipo_w		smallint;
resultado_w		varchar(20);
vl_adiant_conta_w	double precision;


BEGIN 
 
/*	Edgar 22/01/2009, OS 124702, não identifiquei qual a necessidade disto 
select	nvl(sum(vl_recebido),0) + nvl(sum(vl_rec_maior),0) + nvl(sum(vl_juros),0) + nvl(sum(vl_multa),0) 
into	vl_recebido_adiant_w 
from	titulo_receber_liq 
where	nr_adiantamento		= nr_adiantamento_p; 
*/
 
 
-- Edgar 22/01/2009 OS 124702, calculado o valor que está vinculado à conta mas não deduziu do título ainda 
select	coalesce(sum(vl_adiantamento),0) 
into STRICT	vl_adiant_conta_w 
from	conta_paciente b, 
	conta_paciente_adiant a 
where	a.nr_adiantamento	= nr_adiantamento_p 
and	a.nr_interno_conta	= b.nr_interno_conta 
and	coalesce(b.ie_cancelamento::text, '') = '' 
and	not exists (SELECT 1 from titulo_receber x where x.nr_interno_conta = a.nr_interno_conta);
 
select x.ie_tipo, 
	sum(x.vl_disponivel) 
into STRICT	ie_tipo_w, 
	vl_disponivel_w 
from ( 
SELECT	1 ie_tipo, 
	(a.vl_saldo - vl_adiant_conta_w) vl_disponivel 
from	adiantamento a 
where	coalesce(a.vl_especie,0)	<> 0 
and	a.nr_adiantamento	= nr_adiantamento_p 

union
 
SELECT	2 ie_tipo, 
	(a.vl_saldo - vl_adiant_conta_w) vl_disponivel 
from	tipo_recebimento d, 
	adiantamento a 
where	a.cd_tipo_recebimento		= d.cd_tipo_recebimento 
and	a.nr_adiantamento 		= nr_adiantamento_p 
and	d.ie_tipo_consistencia 		<> 3 
and	coalesce(a.vl_especie,0) 		= 0 
group	by a.nr_atendimento, 
	a.nr_adiantamento, 
	a.dt_adiantamento, 
	a.cd_tipo_recebimento, 
	a.vl_saldo, 
	a.vl_especie, 
	a.vl_saldo 

union
 
select 	3 ie_tipo, 
	(a.vl_saldo - vl_adiant_conta_w) vl_disponivel 
from	tipo_recebimento d, 
	adiantamento a, 
	conta_paciente d 
where	a.cd_tipo_recebimento	= d.cd_tipo_recebimento 
and	a.nr_adiantamento	= nr_adiantamento_p 
and	d.ie_tipo_consistencia	= 3 
and	coalesce(a.vl_especie,0)	= 0) x 
group by x.ie_tipo;
 
if (ie_opcao_p = 1) then 
	resultado_w := ie_tipo_w;
else 
	resultado_w := vl_disponivel_w;
end if;
 
return resultado_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_saldo_adiantamento_conta (nr_adiantamento_p bigint, ie_opcao_p bigint) FROM PUBLIC;

