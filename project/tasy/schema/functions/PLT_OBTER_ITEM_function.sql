-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION plt_obter_item (ie_tipo_item_p text, nr_seq_item_p bigint, nr_prescricao_p bigint, nr_seq_leite_p bigint, nm_tabela_p text, qt_item_p bigint, ds_dose_diferenciada_p text, cd_item_p text, cd_intervalo_p text, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, nr_seq_prot_glic_p bigint, ie_acm_sn_p text, nr_seq_exame_p bigint, cd_unidade_medida_dose_p text, ie_via_aplicacao_p text, ds_info_item_p text, ie_erro_p text, ie_respiracao_p text, ie_disp_resp_esp_p text, ie_modo_adm_p text, ds_material_exame_p text, ie_status_item_p text, qt_solucao_p bigint) RETURNS bigint AS $body$
DECLARE


nr_seq_item_w			bigint;

			

BEGIN

if (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') then
	if (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
		nr_seq_item_w	:= nr_seq_item_p;
	else
		if (nm_tabela_p	= 'PRESCR_MATERIAL') then
		
			if (ie_tipo_item_p	<> 'LD') then
				
				
				if (ie_erro_p <> 0) then
				
								
					select	coalesce(max(nr_sequencia),0)
					into STRICT	nr_seq_item_w
					from	prescr_material
					where	nr_prescricao			= nr_prescricao_p
					and	((coalesce(qt_dose,0)			= coalesce(qt_item_p,coalesce(qt_dose,0))) or (ds_dose_diferenciada 		= ds_dose_diferenciada_p))
					and	to_char(cd_material)		= cd_item_p
					and	coalesce(cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
					and	coalesce(substr(obter_desc_unid_med(obter_unid_med_usua(cd_unidade_medida_dose)),1,30),'XPTO') = coalesce(cd_unidade_medida_dose_p,'XPTO')
					and	coalesce(ds_medic_nao_padrao,'XPTO') = coalesce(ds_info_item_p,'XPTO')
					and	coalesce(ie_via_aplicacao,'XPTO')	= coalesce(ie_via_aplicacao_p,'XPTO')
					and	ie_agrupador <> 5
					and coalesce(ie_erro,0) 				= ie_erro_p
					and ((coalesce(qt_solucao,0) 			= coalesce(qt_solucao_p,0)) or ie_tipo_item_p <> 'M')
					and (((coalesce(ie_suspenso, 'N') = 'S') and 
						   ((coalesce(ie_status_item_p, 'N') = 'S') or (coalesce(ie_modificado, 'N') = 'S'))) or (coalesce(ie_suspenso, 'N') = 'N'));
				
				else
						
					select	coalesce(max(nr_sequencia),0)
					into STRICT	nr_seq_item_w
					from	prescr_material
					where	nr_prescricao			= nr_prescricao_p
					and	((coalesce(qt_dose,0)			= coalesce(qt_item_p,coalesce(qt_dose,0))) or (ds_dose_diferenciada 		= ds_dose_diferenciada_p))
					and	to_char(cd_material)		= cd_item_p
					and	coalesce(cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
					and	coalesce(substr(obter_desc_unid_med(obter_unid_med_usua(cd_unidade_medida_dose)),1,30),'XPTO') = coalesce(cd_unidade_medida_dose_p,'XPTO')
					and	coalesce(ds_medic_nao_padrao,'XPTO') = coalesce(ds_info_item_p,'XPTO')
					and	coalesce(ie_via_aplicacao,'XPTO')	= coalesce(ie_via_aplicacao_p,'XPTO')
					and ((coalesce(qt_solucao,0) 			= coalesce(qt_solucao_p,0)) or ie_tipo_item_p <> 'M')
					and	ie_agrupador <> 5
					and (((coalesce(ie_suspenso, 'N') = 'S') and
						   ((coalesce(ie_status_item_p, 'N') = 'S') or (coalesce(ie_modificado, 'N') = 'S'))) or (coalesce(ie_suspenso, 'N') = 'N'));
				
				end if;

				if (nr_seq_item_w	= 0) then

					select	coalesce(max(nr_sequencia),0)
					into STRICT	nr_seq_item_w
					from	prescr_material
					where	nr_prescricao			= nr_prescricao_p
					and	((coalesce(qt_dose,0)			= coalesce(qt_item_p,coalesce(qt_dose,0))) or (ds_dose_diferenciada 		= ds_dose_diferenciada_p))
					and	to_char(cd_material)		= cd_item_p
					and	coalesce(cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
					and ((coalesce(qt_solucao,0) 			= coalesce(qt_solucao_p,0)) or ie_tipo_item_p <> 'M')
					and (((coalesce(ie_suspenso, 'N') = 'S') and
						   ((coalesce(ie_status_item_p, 'N') = 'S') or (coalesce(ie_modificado, 'N') = 'S'))) or (coalesce(ie_suspenso, 'N') = 'N'));
				
				end if;
					
			else
			
				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_seq_item_w
				from	prescr_material
				where	nr_prescricao			= nr_prescricao_p
				and	((coalesce(qt_dose,0)			= coalesce(qt_item_p,coalesce(qt_dose,0))) or (ds_dose_diferenciada 		= ds_dose_diferenciada_p))
				and	to_char(cd_material)		= cd_item_p
				and	nr_seq_leite_deriv			= nr_seq_leite_p
				and	coalesce(cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
				and ((coalesce(qt_solucao,0) 			= coalesce(qt_solucao_p,0)) or ie_tipo_item_p <> 'M')
				and (((coalesce(ie_suspenso, 'N') = 'S') and
						   ((coalesce(ie_status_item_p, 'N') = 'S') or (coalesce(ie_modificado, 'N') = 'S'))) or (coalesce(ie_suspenso, 'N') = 'N'));		
			
			end if;
		elsif (nm_tabela_p	= 'PRESCR_PROCEDIMENTO') then

			select  coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_item_w
			from    prescr_procedimento
			where	nr_prescricao			= nr_prescricao_p
			and	coalesce(qt_procedimento,0)		= coalesce(qt_item_p,0)
			and	to_char(cd_procedimento)	= cd_item_p
			and	ie_origem_proced		= ie_origem_proced_p
			and	coalesce(nr_seq_origem::text, '') = ''
			and	((nr_seq_proc_interno		= nr_seq_proc_interno_p) or
				 ((coalesce(nr_seq_proc_interno::text, '') = '') and (coalesce(nr_seq_proc_interno_p,0) = 0)))
			and	((nr_seq_prot_glic 		= nr_seq_prot_glic_p) or
				 ((coalesce(nr_seq_prot_glic::text, '') = '') and (coalesce(nr_seq_prot_glic_p,0) 	= 0)))
			and	((nr_seq_exame 			= nr_seq_exame_p) or
				 ((coalesce(nr_seq_exame::text, '') = '') and (coalesce(nr_seq_exame_p,0) 	= 0)))
			and	coalesce(cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')			
			and ((coalesce(cd_material_exame::text, '') = '' or coalesce(ds_material_exame_p::text, '') = '') or (position(ds_material_exame_p in Obter_Desc_Material_Exame_Lab(cd_material_exame)) > 0));
		elsif (nm_tabela_p	= 'PRESCR_RECOMENDACAO') then
			
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_item_w
			from	prescr_recomendacao
			where	nr_prescricao			= nr_prescricao_p
			and	coalesce(qt_recomendacao,0)		= coalesce(qt_item_p,coalesce(qt_recomendacao,0))
			and	coalesce(to_char(cd_recomendacao),ds_recomendacao) = cd_item_p
			and	coalesce(cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,coalesce(cd_intervalo,'XPTO'))
			and	coalesce(substr(ds_recomendacao,1,2000),'XPTO')	= coalesce(ds_info_item_p,coalesce(substr(ds_recomendacao,1,2000),'XPTO'));
			
		elsif (nm_tabela_p	= 'PRESCR_GASOTERAPIA') then
			
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_item_w
			from	prescr_gasoterapia
			where	nr_prescricao			= nr_prescricao_p
			and		coalesce(qt_gasoterapia,0)	= coalesce(qt_item_p,coalesce(qt_gasoterapia,0))
			and		to_char(nr_seq_gas)		= cd_item_p
			and		coalesce(cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,coalesce(cd_intervalo,'XPTO'))
			and		coalesce(ie_respiracao,'XPTO')   = coalesce(ie_respiracao_p,'XPTO')
			and		coalesce(ie_disp_resp_esp,'XPTO')   = coalesce(ie_disp_resp_esp_p,'XPTO')
			and		coalesce(ie_modo_adm,'XPTO')   = coalesce(ie_modo_adm_p,'XPTO');
			
			
			
		elsif (nm_tabela_p	= 'PE_PRESCR_PROC_HOR') then

			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_item_w
			from	pe_prescr_proc
			where	nr_seq_prescr			= nr_prescricao_p
			and	obter_se_acm_sn(null,ie_se_necessario)	= ie_acm_sn_p
			and	to_char(nr_seq_proc)		= cd_item_p
			and	coalesce(cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO');
		
		end if;
	end if;
end if;


if (nr_seq_item_w	= 0) then
	nr_seq_item_w	:= null;
end if;	

return	nr_seq_item_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION plt_obter_item (ie_tipo_item_p text, nr_seq_item_p bigint, nr_prescricao_p bigint, nr_seq_leite_p bigint, nm_tabela_p text, qt_item_p bigint, ds_dose_diferenciada_p text, cd_item_p text, cd_intervalo_p text, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, nr_seq_prot_glic_p bigint, ie_acm_sn_p text, nr_seq_exame_p bigint, cd_unidade_medida_dose_p text, ie_via_aplicacao_p text, ds_info_item_p text, ie_erro_p text, ie_respiracao_p text, ie_disp_resp_esp_p text, ie_modo_adm_p text, ds_material_exame_p text, ie_status_item_p text, qt_solucao_p bigint) FROM PUBLIC;

