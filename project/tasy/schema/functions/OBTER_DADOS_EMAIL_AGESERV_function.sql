-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_email_ageserv ( ie_agenda_semanal_p text, cd_agenda_p bigint, dt_agenda_p timestamp, dt_agenda_fim_p timestamp) RETURNS varchar AS $body$
DECLARE


ds_sql_w				varchar(2000);
ds_parametros_w			varchar(2000);
ds_retorno_w			varchar(32000);
ds_email_per_ag_serv_w  parametro_agenda.ds_email_per_ag_serv%type;
ds_agenda_w				varchar(100);
nm_medico_w				varchar(255);
dt_agenda_w				varchar(20);
nm_paciente_w			agenda_consulta.nm_paciente%type;
ds_procedimento_w		varchar(255);
ds_exame_w				varchar(255);
nm_convenio_w			varchar(255);
nr_secao_w				agenda_consulta.nr_secao%type;
ds_url_telemedicina_w 			agenda_consulta_adic.ds_url_telemedicina%TYPE;
ds_url_tele_terc_w agenda_consulta_adic.ds_url_tele_terc%TYPE;

C01 CURSOR FOR
	SELECT 	substr(obter_nome_agenda(a.cd_agenda),1,100),
			substr(obter_nome_medico(a.cd_medico, 'NC'),1,255),
			to_char(a.dt_agenda, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario))),
			a.nm_paciente,
			substr(obter_exame_agenda(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno),1,255),
			substr(obter_desc_exame(a.nr_seq_exame),1,255),
			substr(obter_nome_convenio(a.cd_convenio),1,255),
			(a.nr_secao / a.qt_total_secao),
			b.ds_url_telemedicina,
      b.ds_url_tele_terc
	FROM agenda_consulta a
LEFT OUTER JOIN agenda_consulta_adic b ON (a.nr_sequencia = b.nr_seq_agenda)
WHERE a.dt_agenda >= trunc(dt_agenda_p) and a.dt_agenda <= fim_dia(trunc(dt_agenda_p)) and a.ie_status_agenda not in ('L','C') and (coalesce(a.cd_agenda,cd_agenda_p) = cd_agenda_p) and obter_tipo_agenda(a.cd_agenda) = 5
	order 	by a.nr_secao;
	

BEGIN

ds_parametros_w	:= 'nl=\n';

select	max(ds_email_per_ag_serv)
into STRICT	ds_email_per_ag_serv_w
from 	parametro_agenda
where 	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

if (coalesce(ds_email_per_ag_serv_w::text, '') = '') then

	ds_sql_w	:= ' select	'''||wheb_mensagem_pck.get_texto(791362)||' '' || substr(obter_nome_agenda(cd_agenda),1,100) || :nl ';
	ds_sql_w	:= ds_sql_w || ' 	|| '''||wheb_mensagem_pck.get_texto(802701)||' '' || substr(obter_nome_medico(cd_medico, ''NC''),1,255) || :nl ';
	ds_sql_w	:= ds_sql_w || ' 	|| '''||wheb_mensagem_pck.get_texto(793494)||': '' || to_char(dt_agenda, ''dd/mm/yyyy hh24:mi'') || :nl ';
	ds_sql_w	:= ds_sql_w || ' 	|| '''||wheb_mensagem_pck.get_texto(791350)||': '' || nm_paciente || :nl ';
	ds_sql_w	:= ds_sql_w || ' 	|| '''||wheb_mensagem_pck.get_texto(795138)||': '' || substr(obter_exame_agenda(cd_procedimento, ie_origem_proced, nr_seq_proc_interno),1,255) || :nl ';
	ds_sql_w	:= ds_sql_w || ' 	|| '''||wheb_mensagem_pck.get_texto(798800)||': '' || substr(obter_desc_exame(nr_seq_exame),1,255) || :nl ';
	ds_sql_w	:= ds_sql_w || ' 	|| '''||wheb_mensagem_pck.get_texto(802056)||': '' || substr(obter_nome_convenio(cd_convenio),1,255) || :nl ';
	ds_sql_w	:= ds_sql_w || ' 	|| '''||wheb_mensagem_pck.get_texto(1056837)||': '' || nr_secao || ''/'' || qt_total_secao || :nl ds_agenda ';
	ds_sql_w	:= ds_sql_w || ' from	agenda_consulta ';
	ds_sql_w	:= ds_sql_w || ' where	dt_agenda >= :dt_agenda ';
	ds_sql_w	:= ds_sql_w || ' and	dt_agenda <= fim_dia(:dt_agenda_fim) ';
	ds_sql_w	:= ds_sql_w || ' and	ie_status_agenda not in (''L'',''C'') ';
	ds_sql_w	:= ds_sql_w || ' and	obter_tipo_agenda(cd_agenda) = 5 ';

else
	
	open C01;
	loop
	fetch C01 into	
		ds_agenda_w,
		nm_medico_w,	
		dt_agenda_w,	
		nm_paciente_w,
		ds_procedimento_w,
		ds_exame_w,	
		nm_convenio_w,
		nr_secao_w,
		ds_url_telemedicina_w,
    ds_url_tele_terc_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin		
		ds_retorno_w := substr(ds_retorno_w || chr(10)|| ds_email_per_ag_serv_w,1,4000);
		ds_retorno_w := substr(replace_macro(ds_retorno_w,'@DS_AGENDA@', ds_agenda_w),1,4000);
		ds_retorno_w := substr(replace_macro(ds_retorno_w,'@PROFISSIONAL@', nm_medico_w),1,4000);
		ds_retorno_w := substr(replace_macro(ds_retorno_w,'@DT_AGENDA@', dt_agenda_w),1,4000);
		ds_retorno_w := substr(replace_macro(ds_retorno_w,'@PACIENTE@', nm_paciente_w),1,4000);
		ds_retorno_w := substr(replace_macro(ds_retorno_w,'@PROCEDIMENTO@', ds_procedimento_w),1,4000);
		ds_retorno_w := substr(replace_macro(ds_retorno_w,'@EXAMELABORATORIO@', ds_exame_w),1,4000);
		ds_retorno_w := substr(replace_macro(ds_retorno_w,'@CONVENIO@', nm_convenio_w),1,4000);
		ds_retorno_w := substr(replace_macro(ds_retorno_w,'@SESSAO@', nr_secao_w),1,4000);
		ds_retorno_w := substr(replace_macro(ds_retorno_w,'@URL_TELEMEDICINA@', ds_url_telemedicina_w),1,4000);
    ds_retorno_w := substr(replace_macro(ds_retorno_w,'@urlTelemedicinaExterno', ds_url_tele_terc_w),1,4000);
				
		end;
	end loop;
	close C01;
	
	return	ds_retorno_w;
	
end if;

ds_parametros_w	:= ds_parametros_w ||  ';dt_agenda=' || to_date(to_char(dt_agenda_p, 'dd/mm/yyyy'),'dd/mm/yyyy');

if (ie_agenda_semanal_p = 'S') then
	ds_parametros_w	:= ds_parametros_w || ';dt_agenda_fim=' || to_date(to_char(dt_agenda_p, 'dd/mm/yyyy'),'dd/mm/yyyy');
else
	ds_parametros_w	:= ds_parametros_w || ';dt_agenda_fim=' || to_date(to_char(dt_agenda_p, 'dd/mm/yyyy'),'dd/mm/yyyy');
end if;

if (cd_agenda_p <> 0) then
	ds_sql_w	:= ds_sql_w || ' and	   cd_agenda = :cd_agenda ';
	ds_parametros_w	:= ds_parametros_w || ';cd_agenda=' || cd_agenda_p;
end if;

ds_sql_w	:= ds_sql_w || ' order by	ds_agenda';

ds_retorno_w	:= obter_select_concatenado_bv(ds_sql_w, ds_parametros_w, '\n');

return	ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_email_ageserv ( ie_agenda_semanal_p text, cd_agenda_p bigint, dt_agenda_p timestamp, dt_agenda_fim_p timestamp) FROM PUBLIC;

