-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_change_diag_class ( nr_atendimento_p bigint, nr_seq_interno_p bigint, IE_DIAG_TRATAMENTO_P text, IE_DIAG_PRINC_EPISODIO_P text, IE_DIAG_REFERENCIA_P text, IE_DIAG_ADMISSAO_P text, IE_DIAG_ALTA_P text, IE_DIAG_CIRURGIA_P text, IE_DIAG_OBITO_P text, IE_DIAG_PRE_CIR_P text, IE_DIAG_PRINC_DEPART_P text, IE_DIAG_TRAT_CERT_P text, IE_DIAG_CRONICO_P text, IE_DIAG_TRAT_ESPECIAL_P text) RETURNS varchar AS $body$
DECLARE


C01 CURSOR FOR
	SELECT 'DPE' cd, 'IE_DIAG_PRINC_EPISODIO' ds
	
union

	SELECT 'UBE' cd, 'IE_DIAG_REFERENCIA' ds 
	
union

	select 'BEH' cd, 'IE_DIAG_TRATAMENTO' ds 
	
union

	select 'AUF' cd, 'IE_DIAG_ADMISSAO' ds 
	
union

	select 'ENT' cd, 'IE_DIAG_ALTA' ds 
	
union

	select 'OPD' cd, 'IE_DIAG_CIRURGIA' ds 
	
union

	select 'TOD' cd, 'IE_DIAG_OBITO' ds 
	
union

	select 'POD' cd, 'IE_DIAG_PRE_CIR' ds 
	
union

	select 'FAC' cd, 'IE_DIAG_PRINC_DEPART' ds 
	
union

	select 'BHS' cd, 'IE_DIAG_TRAT_CERT' ds 
	
union

	select 'FAL' cd, 'IE_DIAG_CRONICO' ds 
	
union

	select 'ASV' cd, 'IE_DIAG_TRAT_ESPECIAL' ds;
				
ds_retorno_w		varchar(4000) := 'S';
ds_dominio_w		varchar(255) := 'S';
qt_max_diag_w		bigint;
qt_diag_depart_w	bigint;

IE_DIAG_TRATAMENTO_W	 	bigint;
IE_DIAG_PRINC_EPISODIO_W	bigint;
IE_DIAG_REFERENCIA_W		bigint;
IE_DIAG_ADMISSAO_W			bigint;
IE_DIAG_ALTA_W				bigint;
IE_DIAG_CIRURGIA_W			bigint;
IE_DIAG_OBITO_W				bigint;
IE_DIAG_PRE_CIR_W			bigint;
IE_DIAG_WRINC_DEPART_W		bigint;
IE_DIAG_TRAT_CERT_W			bigint;
IE_DIAG_CRONICO_W			bigint;
IE_DIAG_TRAT_ESPECIAL_W		bigint;

BEGIN

for c01_w in C01 loop
	begin
		select	coalesce(max(qt_diagnostico), 0), max(coalesce(DS_CURTA, Obter_Valor_Dominio(9288, ie_classificacao_diagnostico)))
		into STRICT	qt_max_diag_w,
				ds_dominio_w
		from	classificacao_diagnostico
		where	ie_classificacao_diagnostico = c01_w.cd
		and		ie_situacao = 'A';
		
		if (qt_max_diag_w > 0) then
			select	sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_PRINC_EPISODIO = 'S' and IE_DIAG_PRINC_EPISODIO_P = 'S') 	or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S')) 	then 1 else 0 end) IE_DIAG_PRINC_EPISODIO,
					sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_REFERENCIA = 'S' and IE_DIAG_REFERENCIA_P = 'S')     	or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S'))     	then 1 else 0 end) IE_DIAG_REFERENCIA, 
					sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_TRATAMENTO = 'S' and IE_DIAG_TRATAMENTO_P = 'S') 	  	or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S')) 	  	then 1 else 0 end) IE_DIAG_TRATAMENTO, 
					sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_ADMISSAO = 'S' and IE_DIAG_ADMISSAO_P = 'S') 		or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S')) 			then 1 else 0 end) IE_DIAG_ADMISSAO, 
					sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_ALTA = 'S' and IE_DIAG_ALTA_P = 'S') 			or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S')) 				then 1 else 0 end) IE_DIAG_ALTA, 
					sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_CIRURGIA = 'S' and IE_DIAG_CIRURGIA_P = 'S') 		or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S')) 			then 1 else 0 end) IE_DIAG_CIRURGIA, 
					sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_OBITO = 'S' and IE_DIAG_OBITO_P = 'S') 		 	or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S')) 		 		then 1 else 0 end) IE_DIAG_OBITO, 
					sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_PRE_CIR = 'S' and IE_DIAG_PRE_CIR_P = 'S') 		 	or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S')) 			then 1 else 0 end) IE_DIAG_PRE_CIR, 
					sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_PRINC_DEPART = 'S' and IE_DIAG_PRINC_DEPART_P = 'S') 	or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S')) 		then 1 else 0 end) IE_DIAG_PRINC_DEPART, 
					sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_TRAT_CERT = 'S' and IE_DIAG_TRAT_CERT_P = 'S') 	 	or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S')) 	 		then 1 else 0 end) IE_DIAG_TRAT_CERT, 
					sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_CRONICO = 'S' and IE_DIAG_CRONICO_P = 'S') 		 	or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S')) 		 	then 1 else 0 end) IE_DIAG_CRONICO, 
					sum(case when ((x.nr_sequencia <> coalesce(nr_seq_interno_p, 0) and IE_DIAG_TRAT_ESPECIAL = 'S' and IE_DIAG_TRAT_ESPECIAL_P = 'S')  	or (x.nr_sequencia = nr_seq_interno_p and 'S' <> 'S'))  	then 1 else 0 end) IE_DIAG_TRAT_ESPECIAL
			into STRICT	IE_DIAG_PRINC_EPISODIO_W,
			        IE_DIAG_REFERENCIA_W,	
					IE_DIAG_TRATAMENTO_W,	
			        IE_DIAG_ADMISSAO_W,		
			        IE_DIAG_ALTA_W,			
			        IE_DIAG_CIRURGIA_W,		
			        IE_DIAG_OBITO_W,			
			        IE_DIAG_PRE_CIR_W,		
			        IE_DIAG_WRINC_DEPART_W,	
			        IE_DIAG_TRAT_CERT_W,		
			        IE_DIAG_CRONICO_W,		
			        IE_DIAG_TRAT_ESPECIAL_W
			from	diagnostico_doenca_depart x
			where	x.nr_atendimento in (	SELECT 	nr_atendimento
											from	atendimento_paciente
											where	nr_seq_episodio = obter_episodio_atendimento(nr_atendimento_p) )
			and		coalesce(x.ie_situacao,'A') = 'A';
			
			if (c01_w.cd = 'DPE' and IE_DIAG_PRINC_EPISODIO_W >= qt_max_diag_w) then
				if (ds_retorno_w = 'S') then
					ds_retorno_w := null;
				end if;
				ds_retorno_w := ds_retorno_w || chr(10) || chr(13) || ' - ' || ds_dominio_w;
			elsif (c01_w.cd = 'UBE' and IE_DIAG_REFERENCIA_W >= qt_max_diag_w) then
				if (ds_retorno_w = 'S') then
					ds_retorno_w := null;
				end if;
				ds_retorno_w := ds_retorno_w || chr(10) || chr(13) || ' - ' || ds_dominio_w;
			elsif (c01_w.cd = 'BEH' and IE_DIAG_TRATAMENTO_W >= qt_max_diag_w) then
				if (ds_retorno_w = 'S') then
					ds_retorno_w := null;
				end if;
				ds_retorno_w := ds_retorno_w || chr(10) || chr(13) || ' - ' || ds_dominio_w;
			elsif (c01_w.cd = 'AUF' and IE_DIAG_ADMISSAO_W >= qt_max_diag_w) then
				if (ds_retorno_w = 'S') then
					ds_retorno_w := null;
				end if;
				ds_retorno_w := ds_retorno_w || chr(10) || chr(13) || ' - ' || ds_dominio_w;
			elsif (c01_w.cd = 'ENT' and IE_DIAG_ALTA_W >= qt_max_diag_w) then
				if (ds_retorno_w = 'S') then
					ds_retorno_w := null;
				end if;
				ds_retorno_w := ds_retorno_w || chr(10) || chr(13) || ' - ' || ds_dominio_w;
			elsif (c01_w.cd = 'OPD' and IE_DIAG_CIRURGIA_W >= qt_max_diag_w) then
				if (ds_retorno_w = 'S') then
					ds_retorno_w := null;
				end if;
				ds_retorno_w := ds_retorno_w || chr(10) || chr(13) || ' - ' || ds_dominio_w;
			elsif (c01_w.cd = 'TOD' and IE_DIAG_OBITO_W >= qt_max_diag_w) then
				if (ds_retorno_w = 'S') then
					ds_retorno_w := null;
				end if;
				ds_retorno_w := ds_retorno_w || chr(10) || chr(13) || ' - ' || ds_dominio_w;
			elsif (c01_w.cd = 'POD' and IE_DIAG_PRE_CIR_W >= qt_max_diag_w) then
				if (ds_retorno_w = 'S') then
					ds_retorno_w := null;
				end if;
				ds_retorno_w := ds_retorno_w || chr(10) || chr(13) || ' - ' || ds_dominio_w;
			elsif (c01_w.cd = 'FAC' and IE_DIAG_WRINC_DEPART_W >= qt_max_diag_w) then
				if (ds_retorno_w = 'S') then
					ds_retorno_w := null;
				end if;
				ds_retorno_w := ds_retorno_w || chr(10) || chr(13) || ' - ' || ds_dominio_w;
			elsif (c01_w.cd = 'BHS' and IE_DIAG_TRAT_CERT_W >= qt_max_diag_w) then
				if (ds_retorno_w = 'S') then
					ds_retorno_w := null;
				end if;
				ds_retorno_w := ds_retorno_w || chr(10) || chr(13) || ' - ' || ds_dominio_w;
			end if;
		end if;
	end;
end loop;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_change_diag_class ( nr_atendimento_p bigint, nr_seq_interno_p bigint, IE_DIAG_TRATAMENTO_P text, IE_DIAG_PRINC_EPISODIO_P text, IE_DIAG_REFERENCIA_P text, IE_DIAG_ADMISSAO_P text, IE_DIAG_ALTA_P text, IE_DIAG_CIRURGIA_P text, IE_DIAG_OBITO_P text, IE_DIAG_PRE_CIR_P text, IE_DIAG_PRINC_DEPART_P text, IE_DIAG_TRAT_CERT_P text, IE_DIAG_CRONICO_P text, IE_DIAG_TRAT_ESPECIAL_P text) FROM PUBLIC;

