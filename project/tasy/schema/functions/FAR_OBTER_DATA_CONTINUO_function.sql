-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION far_obter_data_continuo (cd_pessoa_fisica_p text, cd_material_p bigint, ie_tipo_retorno_p text) RETURNS timestamp AS $body$
DECLARE



qt_medic_cont_w			integer;
qt_consumo_w			bigint;
qt_dias_w			varchar(5);
qt_pedido_w			integer;
dt_ult_compra_w			timestamp;
qt_material_pedido_w		bigint;
qt_uso_w				integer;
cd_unidade_uso_w			varchar(30);
qt_periodo_w			integer;
ie_periodo_w			varchar(3);
cd_unidade_venda_w		varchar(15);
cd_unidade_estoque_w 		varchar(15);
qt_conv_estoque_venda_w		double precision;
qt_dias_total_w			bigint;
retorno_w				timestamp;
regra_w				double precision;


BEGIN

select	count(*)
into STRICT	qt_medic_cont_w
from	far_medic_uso_continuo
where	cd_pessoa_fisica = cd_pessoa_fisica_p
and	cd_material	= cd_material_p;

if (qt_medic_cont_w > 0) then

	select count(*)
	into STRICT	qt_pedido_w
	from	far_pedido a
	where	cd_pessoa_fisica = cd_pessoa_fisica_p
	and	ie_classificacao = 'P'
	and	(dt_fechamento IS NOT NULL AND dt_fechamento::text <> '')
	and	exists (SELECT	1
			from	far_pedido_item x
			where	x.nr_seq_pedido = a.nr_sequencia
			and	x.cd_material = cd_material_p);

	if (qt_pedido_w > 0) then

		select	max(cd_unidade_venda),
			max(cd_unidade_medida_estoque),
			max(qt_conv_estoque_venda)
		into STRICT	cd_unidade_venda_w,
			cd_unidade_estoque_w,
			qt_conv_estoque_venda_w
		from	material_estab
		where	cd_material = cd_material_p;

		select	max(qt_uso),
			max(cd_unidade_uso),
			max(qt_periodo),
			max(ie_periodo)
		into STRICT	qt_uso_w,
			cd_unidade_uso_w,
			qt_periodo_w,
			ie_periodo_w
		from	far_medic_uso_continuo
		where	cd_pessoa_fisica = cd_pessoa_fisica_p
		and	cd_material	= cd_material_p;

		select	sum(b.qt_material),
			max(dt_fechamento)
		into STRICT	qt_material_pedido_W,
			dt_ult_compra_w
		from	far_pedido a,
			far_pedido_item b
		where	b.nr_seq_pedido = a.nr_sequencia
		and	b.cd_material = cd_material_p
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_p
		and	(dt_fechamento IS NOT NULL AND dt_fechamento::text <> '')
		and	dt_fechamento =	(SELECT	max(dt_fechamento)
					from	far_pedido x,
						far_pedido_item y
					where	y.nr_seq_pedido = x.nr_sequencia
					and	y.cd_material = cd_material_p
					and	x.cd_pessoa_fisica = cd_pessoa_fisica_p);

		qt_dias_total_w:= qt_periodo_w;

		if (ie_periodo_w = 'M') then
			qt_dias_total_w:= (qt_periodo_w * 30);
		end if;

		if (cd_unidade_uso_w = cd_unidade_estoque_w) and (cd_unidade_uso_w <> cd_unidade_venda_w) then
			qt_material_pedido_W:= (qt_material_pedido_w * qt_conv_estoque_venda_w);
		end if;

		regra_w:= (dividir(qt_dias_total_w,qt_uso_w)* qt_material_pedido_W);

		if (ie_tipo_retorno_p = 'U') then
			retorno_w:= dt_ult_compra_w;
		elsif (ie_tipo_retorno_p = 'P') then
			retorno_w:= (dt_ult_compra_w+regra_w);
		end if;

	end if;

end if;

return	retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION far_obter_data_continuo (cd_pessoa_fisica_p text, cd_material_p bigint, ie_tipo_retorno_p text) FROM PUBLIC;

