-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION plt_obter_ultimo_horario ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text) RETURNS timestamp AS $body$
DECLARE


dt_horario_w				timestamp;			
ie_formato_solucoes_w			varchar(15);
cd_estabelecimento_w			smallint;
nr_atendimento_w			bigint;
cd_pessoa_fisica_w			varchar(10);
nr_seq_orig_w				numeric(20);
nr_prescr_orig_w			numeric(20);
	

BEGIN

select	max(b.nr_atendimento),
	max(b.cd_pessoa_fisica)
into STRICT	nr_atendimento_w,
	cd_pessoa_fisica_w
from	atendimento_paciente b,
	prescr_medica a
where	a.nr_atendimento	= b.nr_atendimento
and	a.nr_prescricao		= nr_prescricao_p;

if (ie_tipo_item_p = 'IAG') or (ie_tipo_item_p = 'IA') or (ie_tipo_item_p = 'M') or (ie_tipo_item_p = 'LD') or (ie_tipo_item_p = 'ME') or (ie_tipo_item_p = 'MAT') or (ie_tipo_item_p = 'S') then

	nr_prescr_orig_w	:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_MATERIAL','P');
	nr_seq_orig_w		:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_MATERIAL','S');	
	
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		
		select	max(dt_horario)
		into STRICT	dt_horario_w
		from (SELECT	a.dt_horario
			from	prescr_mat_hor a,
				prescr_material b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_material	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	a.nr_seq_material	= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''
			and	coalesce(ie_situacao,'A') = 'A'
			
union all
		
			SELECT	a.dt_horario
			from	prescr_mat_hor a,
				prescr_material b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_material	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A') alias14;
	else
		
		select	max(dt_horario)
		into STRICT	dt_horario_w
		from (SELECT	a.dt_horario
			from	prescr_mat_hor a,
				prescr_material b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_material	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	a.nr_seq_material	= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A'
			
union all
		
			SELECT	a.dt_horario
			from	prescr_mat_hor a,
				prescr_material b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_material	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A') alias15;	
	end if;		
	
elsif (ie_tipo_item_p = 'G') or (ie_tipo_item_p = 'C') or (ie_tipo_item_p = 'L') or (ie_tipo_item_p = 'I') or (ie_tipo_item_p = 'P') then

	nr_prescr_orig_w	:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_PROCEDIMENTO','P');
	nr_seq_orig_w		:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_PROCEDIMENTO','S');		
	
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		
		select	max(dt_horario)
		into STRICT	dt_horario_w
		from (SELECT	a.dt_horario
			from	prescr_proc_hor a,
				prescr_procedimento b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_procedimento	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	a.nr_seq_procedimento	= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A'
			
union all
		
			SELECT	a.dt_horario
			from	prescr_proc_hor a,
				prescr_procedimento b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_procedimento	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A') alias14;
	else
		
		select	max(dt_horario)
		into STRICT	dt_horario_w
		from (SELECT	a.dt_horario
			from	prescr_proc_hor a,
				prescr_procedimento b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_procedimento	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	a.nr_seq_procedimento	= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A'
			
union all
		
			SELECT	a.dt_horario
			from	prescr_proc_hor a,
				prescr_procedimento b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_procedimento	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A') alias15;
	end if;			

elsif (ie_tipo_item_p = 'O') then

	nr_prescr_orig_w	:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_GASOTERAPIA','P');
	nr_seq_orig_w		:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_GASOTERAPIA','S');

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		
		select	max(dt_horario)
		into STRICT	dt_horario_w
		from (   SELECT	a.dt_horario
                    from	prescr_gasoterapia_hor a,
                            prescr_gasoterapia b,
                            prescr_medica c
                    where	a.nr_prescricao 	    = b.nr_prescricao
                    and	    a.nr_seq_gasoterapia	= b.nr_sequencia
                    and	    a.nr_prescricao		    = c.nr_prescricao
                    and	    b.nr_prescricao		    = c.nr_prescricao
                    and	    b.nr_prescricao		    = nr_prescr_orig_w
                    and	    a.nr_seq_gasoterapia	= nr_seq_orig_w
                    and	    c.nr_atendimento	    = nr_atendimento_w
                    and	    (coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
                    and	    coalesce(a.dt_fim_horario::text, '') = ''                    
                    
union all
		
                    SELECT	a.dt_horario
                    from	prescr_gasoterapia_hor a,
                            prescr_gasoterapia b,
                            prescr_medica c
                    where	a.nr_prescricao 	        = b.nr_prescricao
                    and	    a.nr_seq_gasoterapia	    = b.nr_sequencia
                    and	    a.nr_prescricao		        = c.nr_prescricao
                    and	    b.nr_prescricao		        = c.nr_prescricao
                    and	    b.nr_prescricao_original	= nr_prescr_orig_w
                    and	    b.nr_seq_anterior	        = nr_seq_orig_w
                    and	    c.nr_atendimento	        = nr_atendimento_w
                    and	    (coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
                    and	    coalesce(a.dt_fim_horario::text, '') = ''                                
                ) alias12;
	else
		
		select	max(dt_horario)
		into STRICT	dt_horario_w
		from (   SELECT	a.dt_horario
                    from	prescr_gasoterapia_hor a,
                            prescr_gasoterapia b,
                            prescr_medica c
                    where	a.nr_prescricao 	    = b.nr_prescricao
                    and	    a.nr_seq_gasoterapia	= b.nr_sequencia
                    and	    a.nr_prescricao		    = c.nr_prescricao
                    and	    b.nr_prescricao		    = c.nr_prescricao
                    and	    b.nr_prescricao		    = nr_prescr_orig_w
                    and	    a.nr_seq_gasoterapia	= nr_seq_orig_w
                    and	    coalesce(c.nr_atendimento::text, '') = ''
                    and	    c.cd_pessoa_fisica	    = cd_pessoa_fisica_w
                    and	    (coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
                    and	    coalesce(a.dt_fim_horario::text, '') = ''			
                    
union all
		
                    SELECT	a.dt_horario
                    from	prescr_gasoterapia_hor a,
                            prescr_gasoterapia b,
                            prescr_medica c
                    where	a.nr_prescricao 	        = b.nr_prescricao
                    and	    a.nr_seq_gasoterapia	    = b.nr_sequencia
                    and	    a.nr_prescricao		        = c.nr_prescricao
                    and	    b.nr_prescricao		        = c.nr_prescricao
                    and	    b.nr_prescricao_original	= nr_prescr_orig_w
                    and	    b.nr_seq_anterior	        = nr_seq_orig_w
                    and	    coalesce(c.nr_atendimento::text, '') = ''
                    and	    c.cd_pessoa_fisica	        = cd_pessoa_fisica_w
                    and	    (coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
                    and	    coalesce(a.dt_fim_horario::text, '') = ''                    
                ) alias13;	
	end if;

    if (coalesce(dt_horario_w::text, '') = '') then

        select	coalesce(max(a.dt_prev_execucao),max(b.dt_inicio_prescr))
        into STRICT	dt_horario_w
        from	prescr_medica b,
                prescr_gasoterapia a
        where	a.nr_prescricao = b.nr_prescricao
        and	    a.nr_prescricao	= nr_prescr_orig_w
        and	    a.nr_sequencia	= nr_seq_orig_w;

    end if;

elsif (ie_tipo_item_p = 'D') then

	nr_prescr_orig_w	:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_DIETA','P');
	nr_seq_orig_w		:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_DIETA','S');		
	
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		
		select	max(dt_horario)
		into STRICT	dt_horario_w
		from (SELECT	a.dt_horario
			from	prescr_dieta_hor a,
				prescr_dieta b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_dieta		= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	a.nr_seq_dieta		= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A'
			
union all
		
			SELECT	a.dt_horario
			from	prescr_dieta_hor a,
				prescr_dieta b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_dieta		= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A') alias14;
	else
		
		select	max(dt_horario)
		into STRICT	dt_horario_w
		from (SELECT	a.dt_horario
			from	prescr_dieta_hor a,
				prescr_dieta b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_dieta		= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	a.nr_seq_dieta		= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A'
			
union all
		
			SELECT	a.dt_horario
			from	prescr_dieta_hor a,
				prescr_dieta b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_dieta		= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A') alias15;
	end if;	
	
elsif (ie_tipo_item_p = 'B') then

	select	max(dt_horario)
	into STRICT	dt_horario_w
	from	prescr_ordem_hor
	where	nr_seq_ordem		= nr_seq_item_p
	and		ie_horario_especial = 'N';
	
elsif (ie_tipo_item_p = 'R') then

	nr_prescr_orig_w	:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_RECOMENDACAO','P');
	nr_seq_orig_w		:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_RECOMENDACAO','S');		
	
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		
		select	max(dt_horario)
		into STRICT	dt_horario_w
		from (SELECT	a.dt_horario
			from	prescr_rec_hor a,
				prescr_recomendacao b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_recomendacao	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	a.nr_seq_recomendacao	= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A'
			
union all
		
			SELECT	a.dt_horario
			from	prescr_rec_hor a,
				prescr_recomendacao b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_recomendacao	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A') alias14;
	else
		
		select	max(dt_horario)
		into STRICT	dt_horario_w
		from (SELECT	a.dt_horario
			from	prescr_rec_hor a,
				prescr_recomendacao b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_recomendacao	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	a.nr_seq_recomendacao	= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A'
			
union all
		
			SELECT	a.dt_horario
			from	prescr_rec_hor a,
				prescr_recomendacao b,
				prescr_medica c
			where	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_seq_recomendacao	= b.nr_sequencia
			and	a.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
			and	coalesce(a.dt_fim_horario::text, '') = ''			
			and	coalesce(ie_situacao,'A') = 'A') alias15;
	end if;	

elsif (ie_tipo_item_p = 'HM') then	

	nr_prescr_orig_w	:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_PROCEDIMENTO','P');
	nr_seq_orig_w		:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_PROCEDIMENTO','S');		
	
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		
		select	max(dt_status)
		into STRICT	dt_horario_w
		from (SELECT	b.dt_status
			from	prescr_procedimento b,
				prescr_medica c
			where	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	b.nr_sequencia		= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w
			
union all
		
			SELECT	b.dt_status
			from	prescr_procedimento b,
				prescr_medica c
			where	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w) alias2;
	else
		
		select	max(dt_status)
		into STRICT	dt_horario_w
		from (SELECT	b.dt_status
			from	prescr_procedimento b,
				prescr_medica c
			where	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	b.nr_sequencia		= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			
union all
		
			SELECT	b.dt_status
			from	prescr_procedimento b,
				prescr_medica c
			where	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w) alias3;
	end if;	

elsif (ie_tipo_item_p = 'SNE') then	

	nr_prescr_orig_w	:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_MATERIAL','P');
	nr_seq_orig_w		:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_MATERIAL','S');		
	
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		
		select	max(dt_status)
		into STRICT	dt_horario_w
		from (SELECT	b.dt_status
			from	prescr_material b,
				prescr_medica c
			where	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	b.nr_sequencia		= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w
			
union all
		
			SELECT	b.dt_status
			from	prescr_material b,
				prescr_medica c
			where	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	c.nr_atendimento	= nr_atendimento_w) alias2;
	else
		
		select	max(dt_status)
		into STRICT	dt_horario_w
		from (SELECT	b.dt_status
			from	prescr_material b,
				prescr_medica c
			where	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao		= nr_prescr_orig_w
			and	b.nr_sequencia		= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			
union all
		
			SELECT	b.dt_status
			from	prescr_material b,
				prescr_medica c
			where	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_prescricao_original	= nr_prescr_orig_w
			and	b.nr_seq_anterior	= nr_seq_orig_w
			and	coalesce(c.nr_atendimento::text, '') = ''
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w) alias3;
	end if;	
elsif (ie_tipo_item_p = 'E') then	

	select	max(dt_horario)
	into STRICT	dt_horario_w
	from	pe_prescr_proc_hor
	where	nr_seq_pe_prescr = nr_prescricao_p
	and	nr_seq_pe_proc	 = nr_seq_item_p
	and	coalesce(dt_fim_horario::text, '') = '';

elsif (ie_tipo_item_p = 'SOL') then	

	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	ie_formato_solucoes_w := obter_param_usuario(1113, 241, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_formato_solucoes_w);

	nr_prescr_orig_w	:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_SOLUCAO','P');
	nr_seq_orig_w		:= PLT_obter_item_orig(nr_prescricao_p,nr_seq_item_p,'PRESCR_SOLUCAO','S');		
	
	if (ie_formato_solucoes_w = 'I') then
	
		if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
			
			select	max(dt_status)
			into STRICT	dt_horario_w
			from (SELECT	b.dt_status
				from	prescr_solucao b,
					prescr_medica c
				where	b.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao		= nr_prescr_orig_w
				and	b.nr_seq_solucao	= nr_seq_orig_w
				and	c.nr_atendimento	= nr_atendimento_w
				
union all
		
				SELECT	b.dt_status
				from	prescr_solucao b,
					prescr_medica c
				where	b.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao_original	= nr_prescr_orig_w
				and	b.nr_seq_anterior	= nr_seq_orig_w
				and	c.nr_atendimento	= nr_atendimento_w) alias3;
		else
			
			select	max(dt_status)
			into STRICT	dt_horario_w
			from (SELECT	b.dt_status
				from	prescr_solucao b,
					prescr_medica c
				where	b.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao		= nr_prescr_orig_w
				and	b.nr_seq_solucao	= nr_seq_orig_w
				and	coalesce(c.nr_atendimento::text, '') = ''
				and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
				
union all
		
				SELECT	b.dt_status
				from	prescr_solucao b,
					prescr_medica c
				where	b.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao_original	= nr_prescr_orig_w
				and	b.nr_seq_anterior	= nr_seq_orig_w
				and	coalesce(c.nr_atendimento::text, '') = ''
				and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w) alias3;
		end if;	
	
	elsif (ie_formato_solucoes_w = 'H') then	

		if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
			
			select	max(dt_horario)
			into STRICT	dt_horario_w
			from (SELECT	a.dt_horario
				from	prescr_mat_hor a,
					prescr_solucao b,
					prescr_medica c
				where	a.nr_prescricao 	= b.nr_prescricao
				and	a.nr_seq_solucao	= b.nr_seq_solucao
				and	a.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao		= nr_prescr_orig_w
				and	a.nr_seq_solucao	= nr_seq_orig_w
				and	c.nr_atendimento	= nr_atendimento_w
				and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
				and	coalesce(a.dt_fim_horario::text, '') = ''
				and	coalesce(ie_situacao,'A') = 'A'
				
union all
		
				SELECT	a.dt_horario
				from	prescr_mat_hor a,
					prescr_solucao b,
					prescr_medica c
				where	a.nr_prescricao 	= b.nr_prescricao
				and	a.nr_seq_solucao	= b.nr_seq_solucao
				and	a.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao_original	= nr_prescr_orig_w
				and	b.nr_seq_anterior	= nr_seq_orig_w
				and	c.nr_atendimento	= nr_atendimento_w
				and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
				and	coalesce(a.dt_fim_horario::text, '') = ''				
				and	coalesce(ie_situacao,'A') = 'A') alias15;
		else
			
			select	max(dt_horario)
			into STRICT	dt_horario_w
			from (SELECT	a.dt_horario
				from	prescr_mat_hor a,
					prescr_solucao b,
					prescr_medica c
				where	a.nr_prescricao 	= b.nr_prescricao
				and	a.nr_seq_solucao	= b.nr_seq_solucao
				and	a.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao		= nr_prescr_orig_w
				and	a.nr_seq_solucao	= nr_seq_orig_w
				and	coalesce(c.nr_atendimento::text, '') = ''
				and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
				and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
				and	coalesce(a.dt_fim_horario::text, '') = ''				
				and	coalesce(ie_situacao,'A') = 'A'
				
union all
		
				SELECT	a.dt_horario
				from	prescr_mat_hor a,
					prescr_solucao b,
					prescr_medica c
				where	a.nr_prescricao 	= b.nr_prescricao
				and	a.nr_seq_solucao	= b.nr_seq_solucao
				and	a.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao		= c.nr_prescricao
				and	b.nr_prescricao_original	= nr_prescr_orig_w
				and	b.nr_seq_anterior	= nr_seq_orig_w
				and	coalesce(c.nr_atendimento::text, '') = ''
				and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
				and	(coalesce(c.dt_liberacao_medico, c.dt_liberacao) IS NOT NULL AND (coalesce(c.dt_liberacao_medico, c.dt_liberacao))::text <> '')
				and	coalesce(a.dt_fim_horario::text, '') = ''				
				and	coalesce(ie_situacao,'A') = 'A') alias15;
		end if;	
		
	end if;

end if;

return	dt_horario_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION plt_obter_ultimo_horario ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text) FROM PUBLIC;

