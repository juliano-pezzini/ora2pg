-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_num_ordenacao_diag ( nr_prescricao_p bigint, nr_seq_diagnostico_p bigint, IE_DIAG_COLAB_P text ) RETURNS varchar AS $body$
DECLARE

    NUM_SEQ_ORDENACAO bigint := null;
    CD_PESSOA_FISICA_PE_PRESCRICAO  PE_PRESCRICAO.CD_PESSOA_FISICA%type;

BEGIN
    if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then

      select	MAX(CD_PESSOA_FISICA)
      into STRICT	CD_PESSOA_FISICA_PE_PRESCRICAO
      from	PE_PRESCRICAO
      where	nr_sequencia = nr_prescricao_p;


      SELECT
          MAX(c.NR_SEQ_ORDENACAO)
      INTO STRICT NUM_SEQ_ORDENACAO
      FROM PE_PRESCRICAO a
      INNER JOIN pe_prescr_diag c ON
          c.nr_seq_prescr = a.NR_SEQUENCIA
      WHERE 
          coalesce(a.dt_inativacao::text, '') = '' AND 
          a.CD_PESSOA_FISICA = CD_PESSOA_FISICA_PE_PRESCRICAO AND
          c.NR_SEQ_DIAG = nr_seq_diagnostico_p AND
          c.IE_DIAG_COLAB = IE_DIAG_COLAB_P;

      IF (coalesce(NUM_SEQ_ORDENACAO::text, '') = '' ) THEN

          SELECT
              coalesce(MAX(c.NR_SEQ_ORDENACAO),0) + 1
          INTO STRICT NUM_SEQ_ORDENACAO
          FROM PE_PRESCRICAO a
          INNER JOIN pe_prescr_diag c ON
              c.nr_seq_prescr = a.NR_SEQUENCIA
          WHERE 
              coalesce(a.dt_inativacao::text, '') = '' AND 
              a.CD_PESSOA_FISICA = CD_PESSOA_FISICA_PE_PRESCRICAO AND
              c.IE_DIAG_COLAB = IE_DIAG_COLAB_P;

      END IF;
    END IF;
    return NUM_SEQ_ORDENACAO;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_num_ordenacao_diag ( nr_prescricao_p bigint, nr_seq_diagnostico_p bigint, IE_DIAG_COLAB_P text ) FROM PUBLIC;

