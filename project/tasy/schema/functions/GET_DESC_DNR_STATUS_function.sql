-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_desc_dnr_status (cd_pessoa_fisica_p text, nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

	
ds_retorno_w varchar(4000);
ds_auxiliar_w diretriz_atendimento.DS_GUIDELINE_DESCRIPTION%type;

C01 CURSOR FOR
	SELECT coalesce(DS_GUIDELINE_DESCRIPTION, substr(obter_valor_dominio(8478 , a.ie_diretriz) , 1, 100))
	from diretriz_atendimento a
	WHERE (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')     
	AND coalesce(ie_situacao, 'A') = 'A' 
	AND (coalesce(NR_ATENDIMENTO_P::text, '') = '' or NR_ATENDIMENTO_P = NR_ATENDIMENTO)
	AND cd_pessoa_fisica = CD_PESSOA_FISICA_P
	AND IE_DISPLAY_PATIENTBAR = 'S'
    AND coalesce(dt_final::text, '') = ''
	Order by NR_SEQ_PRESENTATION;


BEGIN
	
	open C01;
	loop
	fetch C01 into
		ds_auxiliar_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		if (coalesce(ds_retorno_w::text, '') = '') then
			ds_retorno_w := ds_auxiliar_w;
		else
			ds_retorno_w := ds_retorno_w||'; '|| ds_auxiliar_w;
		end if;

	end loop;
	close C01;

	return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_desc_dnr_status (cd_pessoa_fisica_p text, nr_atendimento_p bigint) FROM PUBLIC;

