-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_conta_paciente ( nr_interno_conta_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*ie_opcao_p
R	- Responsavel
DC	- Descricao categoria
C	- Categoria
O	- Observacao - Adicionado p/ utilizar o grid do EIS Contas pendentes - Geliard OS234310
TAC	- Tipo atedimento conta -  Adicionado p/ utilizar nos relatorios do EIS Contas pendentes - Geliard OS235399
DVNF	- Data de vencimento da NF - Usado no repasse para terceiros (repasses pendentes) - ahoffelder 05/10/2010 OS 253507
DPI	- Periodo inicial - jcaraujo 27/10/10 - OS261902
DPF	- Periodo final - jcaraujo 27/10/10 - OS261902
DTA	- Data da alta do paciente
VC	- Valor Total da Conta.
DTC	- data de cancelamento null
P	- protocolo conta
DR	- Data mes ano referencia
N	-  Codigo Convenio
DN	- Descricao Convenio
SA	- Sequencia de apresentacao
CRI	- Convenio Retorno Item - bcurioletti OS816836
*/
cd_responsavel_w			varchar(10);
ds_retorno_w			varchar(255);
cd_convenio_parametro_w		integer;
nr_atendimento_w			bigint;
cd_categoria_parametro_w		varchar(10);
ds_categoria_w			varchar(80);
ds_observacao_w			varchar(255);
ie_tipo_atend_conta_w		smallint;
dt_vencimento_w			timestamp;
dt_periodo_inicial_w		timestamp;
dt_periodo_final_w			timestamp;
vl_procedimento_w			double precision;
vl_material_w			double precision;
is_conta_cancelada_w		varchar(1);
nr_protocolo_w			varchar(40);
dt_mesano_referencia_w		timestamp;
ds_convenio_w			varchar(255);
nr_seq_apresentacao_w		conta_paciente.nr_seq_apresentacao%type;
nr_conta_convenio_w		conta_paciente.nr_conta_convenio%type;


BEGIN

select	cd_responsavel,
	cd_convenio_parametro,
	cd_categoria_parametro,
	substr(ds_observacao,1,255),
	ie_tipo_atend_conta,
	dt_periodo_inicial,
	dt_periodo_final,
	nr_atendimento,
	CASE WHEN coalesce(dt_cancelamento::text, '') = '' THEN 'N'  ELSE 'S' END ,
	nr_protocolo,
	dt_mesano_referencia,
	nr_seq_apresentacao,
	nr_conta_convenio
into STRICT	cd_responsavel_w,
	cd_convenio_parametro_w,
	cd_categoria_parametro_w,
	ds_observacao_w,
	ie_tipo_atend_conta_w,
	dt_periodo_inicial_w,
	dt_periodo_final_w,
	nr_atendimento_w,
	is_conta_cancelada_w,
	nr_protocolo_w,
	dt_mesano_referencia_w,
	nr_seq_apresentacao_w,
	nr_conta_convenio_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_p;

if (ie_opcao_p = 'R') then
	ds_retorno_w 	:= cd_responsavel_w;
elsif (ie_opcao_p = 'N') then
	ds_retorno_w	:= cd_convenio_parametro_w;
elsif (ie_opcao_p = 'DN') then
	select	max(ds_convenio)
	into STRICT	ds_convenio_w
	from	convenio
	where	cd_convenio	= cd_convenio_parametro_w;
	
	ds_retorno_w	:= ds_convenio_w;
elsif (ie_opcao_p = 'C') then
	ds_retorno_w	:= cd_categoria_parametro_w;
elsif (ie_opcao_p = 'DC') then
	begin
	select	ds_categoria
	into STRICT	ds_categoria_w
	from	categoria_convenio
	where	cd_convenio	= cd_convenio_parametro_w
	and	cd_categoria	= cd_categoria_parametro_w;
	
	ds_retorno_w	:= ds_categoria_w;
	end;
elsif (ie_opcao_p = 'O') then	
	ds_retorno_w := ds_observacao_w;
elsif (ie_opcao_p = 'TAC') then	
	ds_retorno_w := ie_tipo_atend_conta_w;
elsif (ie_opcao_p = 'DVNF') then
	select	min(b.dt_vencimento)
	into STRICT	dt_vencimento_w
	from	nota_fiscal_venc b,
		nota_fiscal a
	where	a.nr_interno_conta	= nr_interno_conta_p
	and	a.nr_sequencia	= b.nr_sequencia;

	ds_retorno_w	:= to_char(dt_vencimento_w,'dd/mm/yyyy');
elsif (ie_opcao_p = 'DPI') then
	ds_retorno_w	:= to_char(dt_periodo_inicial_w,'dd/mm/yyyy hh24:mi:ss');
elsif (ie_opcao_p = 'DPF') then
	ds_retorno_w	:= to_char(dt_periodo_final_w,'dd/mm/yyyy hh24:mi:ss');
elsif (ie_opcao_p = 'DTA') then
	select	to_char(dt_alta,'dd/mm/yyyy')
	into STRICT	ds_retorno_w
	from	atendimento_paciente
	where	nr_atendimento	= nr_atendimento_w;
elsif (ie_opcao_p = 'VC') then
	select	SUM(a.vl_procedimento)
	into STRICT	vl_procedimento_w
	from	procedimento_paciente a
	where 	a.nr_interno_conta = nr_interno_conta_p;
	
	select	SUM(x.vl_material)
	into STRICT	vl_material_w
	from	material_atend_paciente x
	where	x.nr_interno_conta	= nr_interno_conta_p;

	ds_retorno_w := coalesce(vl_procedimento_w,0) + coalesce(vl_material_w,0);
elsif (ie_opcao_p = 'DTC') then
	ds_retorno_w	:= is_conta_cancelada_w;
elsif (ie_opcao_p = 'P') then
	ds_retorno_w	:= nr_protocolo_w;	
elsif (ie_opcao_p = 'DR') then
	ds_retorno_w	:= to_char(dt_mesano_referencia_w,'dd/mm/yyyy hh24:mi:ss');
elsif (ie_opcao_p = 'SA') then
	ds_retorno_w	:= nr_seq_apresentacao_w;
elsif (ie_opcao_p = 'NP') then
	ds_retorno_w	:= substr(Obter_Dados_Atendimento(nr_atendimento_w, 'NP'),1,255);
elsif (ie_opcao_p = 'CRI') then
	ds_retorno_w := nr_conta_convenio_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_conta_paciente ( nr_interno_conta_p bigint, ie_opcao_p text) FROM PUBLIC;

