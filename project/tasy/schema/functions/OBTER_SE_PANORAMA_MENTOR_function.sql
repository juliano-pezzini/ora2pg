-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_panorama_mentor (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

								
ie_retorno_w			varchar(255) := 'N';
qt_horas_retroativa_w	double precision;
qt_reg_w		        bigint;
qt_pendencia_w		    bigint;
ie_status_sepsis_w	varchar(4);

C01 CURSOR FOR
SELECT  distinct b.nr_seq_regra_acao, b.ds_acao
from    gqa_pendencia_pac      a,
		gqa_pend_pac_acao      b,
		gqa_pend_pac_acao_dest c,
		gqa_pendencia_regra    d,
		gqa_pendencia          e
where	a.nr_sequencia  = b.nr_seq_pend_pac
and	b.nr_sequencia      = c.nr_seq_pend_pac_acao
and	d.nr_sequencia      = a.nr_seq_pend_regra
and d.nr_seq_pendencia  = e.nr_sequencia
and	a.nr_atendimento    = nr_atendimento_p
and coalesce(e.ie_situacao,'A') = 'A'
and coalesce(d.ie_situacao,'A') = 'A'
and (coalesce(d.ie_apresentar_panorama,'N') = 'S' and d.NR_SEQ_ESCALA != 124)--NR_SEQ_ESCALA 124 = SEPSE
and coalesce(c.dt_encerramento::text, '') = ''
and coalesce(c.dt_justificativa::text, '') = ''
and	coalesce(b.dt_encerramento::text, '') = ''
and	((qt_horas_retroativa_w = 0) or (a.dt_atualizacao_nrec >= clock_timestamp() - qt_horas_retroativa_w))
and regexp_like(pep_obter_info_pend_mentor(c.nr_seq_pend_pac_acao, 'J'), 'S|N')
and	( (((b.nr_seq_proc IS NOT NULL AND b.nr_seq_proc::text <> '') or (b.nr_seq_proc_saps IS NOT NULL AND b.nr_seq_proc_saps::text <> ''))
	and not exists (SELECT	1
			from	pe_prescricao e
			where	e.nr_seq_pend_pac_acao in (select nr_sequencia 
							   from   gqa_pend_pac_acao
							   where  nr_seq_pend_pac = a.nr_sequencia)))
	or ((b.nr_seq_protocolo IS NOT NULL AND b.nr_seq_protocolo::text <> '')		
	and not exists (select	1
			from	prescr_medica f
			where	f.nr_seq_pend_pac_acao = b.nr_sequencia)) );
			

BEGIN
qt_horas_retroativa_w := obter_param_usuario(355, 2, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, obter_estabelecimento_ativo, qt_horas_retroativa_w);

qt_horas_retroativa_w := coalesce( ((1/24)* qt_horas_retroativa_w),0);

Select  count(*)
into STRICT	qt_reg_w
from	gqa_pendencia_pac	
where	nr_atendimento = nr_atendimento_p
and   ((qt_horas_retroativa_w = 0) or (dt_atualizacao_nrec >= clock_timestamp() - qt_horas_retroativa_w));

if (qt_reg_w > 0) then
	for protocolos in C01 loop
		if (ie_retorno_w = 'N') then
			ie_retorno_w := protocolos.ds_acao;
		else
			ie_retorno_w := ie_retorno_w || '<br>' ||protocolos.ds_acao;
		end if;
	end loop;
end if;

ie_status_sepsis_w := null;
select max(IE_STATUS_SEPSIS)
into STRICT ie_status_sepsis_w
  from (SELECT IE_STATUS_SEPSIS
        from escala_sepse 
        where nr_atendimento = nr_atendimento_p 
	and coalesce(dt_inativacao::text, '') = ''
        order by DT_ATUALIZACAO desc) alias2 LIMIT 1;

if (ie_status_sepsis_w IS NOT NULL AND ie_status_sepsis_w::text <> '') and ie_status_sepsis_w not in ('D','RD','RF','SN', 'RC', 'SC', 'RE') then
	if (ie_retorno_w = 'N') then
		ie_retorno_w := OBTER_DESC_EXPRESSAO(499285) || ' - ' || obter_des_status_sepse(ie_status_sepsis_w);
	else
		ie_retorno_w := ie_retorno_w || '<br>' || OBTER_DESC_EXPRESSAO(499285) || ' - ' || obter_des_status_sepse(ie_status_sepsis_w);
	end if;
end if;

return ie_retorno_w;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_panorama_mentor (nr_atendimento_p bigint) FROM PUBLIC;

