-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_valor_pagar ( dt_referencia_p timestamp, ds_prestador_p text, nr_documento_p bigint) RETURNS bigint AS $body$
DECLARE


vl_retorno_w	double precision;


BEGIN

select	max(CASE WHEN  b.ie_situacao='D' THEN (	select	sum(x.vl_titulo)		from	titulo_pagar	x		where	x.nr_titulo_original = b.nr_titulo		and (trunc(x.dt_liquidacao,'month') > trunc(dt_referencia_p,'month')		or	coalesce(x.dt_liquidacao::text, '') = '')		and	b.ie_situacao = 'D')  ELSE a.vl_liquido END ) vl_pagar
into STRICT 	vl_retorno_w
from   	pls_conta_medica_v 	c,
	pls_conta 		d,
	pls_lote_protocolo 	e,
	pls_protocolo_conta 	f,
	pls_segurado 		g,
	pls_plano 		h,
	pls_contrato 		i,
	pls_lote_protocolo_venc a,
	titulo_pagar 		b
where  	c.nr_seq_conta 		= d.nr_sequencia
and	d.nr_seq_protocolo 	= f.nr_sequencia
and	f.nr_seq_lote 		= e.nr_sequencia
and	a.nr_seq_lote 		= e.nr_sequencia
and    	a.nr_titulo 		= b.nr_titulo
and	d.nr_seq_segurado 	= g.nr_sequencia
and	g.nr_seq_plano 		= h.nr_sequencia
and	g.nr_seq_contrato 	= i.nr_sequencia
and (b.cd_cgc = ds_prestador_p or b.cd_pessoa_fisica = ds_prestador_p)
and	b.nr_documento = nr_documento_p
and	(((to_char(trunc(b.dt_emissao,'month'),'dd/mm/yy') = to_char(trunc(dt_referencia_p, 'month'),'dd/mm/yy')) and (coalesce(b.vl_saldo_titulo,0) > 0))
	or ((trunc(b.dt_liquidacao,'month') > trunc(dt_referencia_p, 'month')) and (trunc(b.dt_liquidacao, 'month') > trunc(b.dt_emissao, 'month')) and (to_char(trunc(b.dt_emissao,'month'),'dd/mm/yy') = to_char(trunc(dt_referencia_p, 'month'),'dd/mm/yy')))
	or ((trunc(b.dt_liquidacao,'month') <= trunc(dt_referencia_p,'month')) and b.ie_situacao = 'D'));

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_valor_pagar ( dt_referencia_p timestamp, ds_prestador_p text, nr_documento_p bigint) FROM PUBLIC;

