-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_regra_exo_dem_bonificacao ( nr_seq_desconto_p bigint, ie_vinculo_bonific_p text, qt_vidas_exonerados_p bigint, qt_vidas_p bigint, qt_vidas_bonificacao_p bigint) RETURNS bigint AS $body$
DECLARE

/*	ie_vinculo_bonific_p
	B = Beneficiário
	C = Contrato
	P = Pagador
	SB = SCA Beneficiário
	GC = Grupo de contrato
*/
nr_seq_preco_regra_www	bigint;
nr_seq_preco_regra_w	bigint;
nr_seq_preco_regra_ww	bigint;
ie_demitido_exonerado_w	varchar(10);
ie_possui_bonificacao_w	varchar(1);

C01 CURSOR FOR
	SELECT	ie_demitido_exonerado,
		ie_possui_bonificacao,
		nr_sequencia
	from	pls_preco_regra
	where	nr_seq_regra = nr_seq_desconto_p;


BEGIN

open C01;
loop
fetch C01 into
	ie_demitido_exonerado_w,
	ie_possui_bonificacao_w,
	nr_seq_preco_regra_ww;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if	((coalesce(ie_possui_bonificacao_w,'N') = 'S') and (ie_vinculo_bonific_p in ('B','SB'))) then
		select	max(nr_sequencia)
		into STRICT	nr_seq_preco_regra_www
		from	pls_preco_regra
		where	nr_sequencia = nr_seq_preco_regra_ww
		and	qt_vidas_bonificacao_p between coalesce(qt_min_vidas,qt_vidas_bonificacao_p) and coalesce(qt_max_vidas,qt_vidas_bonificacao_p);
	elsif (coalesce(ie_demitido_exonerado_w,'N') = 'S') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_preco_regra_www
		from	pls_preco_regra
		where	nr_sequencia = nr_seq_preco_regra_ww
		and	qt_vidas_exonerados_p between coalesce(qt_min_vidas,qt_vidas_exonerados_p) and coalesce(qt_max_vidas,qt_vidas_exonerados_p);
	elsif (coalesce(ie_demitido_exonerado_w,'N') = 'N') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_preco_regra_www
		from	pls_preco_regra
		where	nr_sequencia = nr_seq_preco_regra_ww
		and	qt_vidas_p between coalesce(qt_min_vidas,qt_vidas_p) and coalesce(qt_max_vidas,qt_vidas_p);
	end if;

	if (nr_seq_preco_regra_www IS NOT NULL AND nr_seq_preco_regra_www::text <> '') then
		nr_seq_preco_regra_w	:= nr_seq_preco_regra_www;
	end if;

	end;
end loop;
close C01;


return	nr_seq_preco_regra_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_regra_exo_dem_bonificacao ( nr_seq_desconto_p bigint, ie_vinculo_bonific_p text, qt_vidas_exonerados_p bigint, qt_vidas_p bigint, qt_vidas_bonificacao_p bigint) FROM PUBLIC;

