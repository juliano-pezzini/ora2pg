-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dia_semana_agenda_exame (ie_diario_p text, dt_agenda_p timestamp, cd_agenda_p bigint, cd_agenda_diaria_p text, cd_agenda_where_p text) RETURNS varchar AS $body$
DECLARE


ds_dia_semana_w	varchar(15);
qt_hor_agenda_w	bigint;

ds_dia_agenda_w	varchar(240);


BEGIN
if (ie_diario_p IS NOT NULL AND ie_diario_p::text <> '') and (dt_agenda_p IS NOT NULL AND dt_agenda_p::text <> '') then

	/* obter dia semana */

	select	obter_dia_semana(dt_agenda_p)
	into STRICT	ds_dia_semana_w
	;

	/* obter agendamentos */

	if (ie_diario_p = 'N') then

		select	count(*)
		into STRICT	qt_hor_agenda_w
		from	agenda_paciente
		where	trunc(dt_agenda,'dd')	= trunc(dt_agenda_p,'dd')
		and	cd_agenda			= cd_agenda_p
		and	ie_status_agenda 		not in ('L','B','C','F','I','II');

	else

		if (cd_agenda_where_p IS NOT NULL AND cd_agenda_where_p::text <> '') then

			qt_hor_agenda_w := obter_valor_dinamico(	'select	count(*) ' 													||
							'from	agenda_paciente '													||
							'where	trunc(dt_agenda,'||chr(39)||'dd'||chr(39)||') = trunc(to_date('||chr(39)||to_char(dt_agenda_p,'dd/mm/yyyy')||chr(39)||','||chr(39)||'dd/mm/yyyy'||chr(39)||'),'||chr(39)||'dd'||chr(39)||') ' 	||
						cd_agenda_where_p 														|| ' ' ||
						'and	ie_status_agenda not in ('||chr(39)||'L'||chr(39)||','||chr(39)||'B'||chr(39)||','||chr(39)||'C'||chr(39)||','||chr(39)||'F'||chr(39)||','||chr(39)||'I'||chr(39)||','||chr(39)||'II'||chr(39)||')', qt_hor_agenda_w);

		elsif (cd_agenda_diaria_p IS NOT NULL AND cd_agenda_diaria_p::text <> '') then

			select	count(*)
			into STRICT	qt_hor_agenda_w
			from	agenda_paciente
			where	trunc(dt_agenda,'dd')				= trunc(dt_agenda_p,'dd')
			and	obter_se_contido(cd_agenda,cd_agenda_diaria_p)	= 'S'
			and	ie_status_agenda 					not in ('L','B','C','F','I','II');

		end if;

	end if;

	ds_dia_agenda_w	:= ds_dia_semana_w || ' (' || to_char(qt_hor_agenda_w) || ')';

end if;

return ds_dia_agenda_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dia_semana_agenda_exame (ie_diario_p text, dt_agenda_p timestamp, cd_agenda_p bigint, cd_agenda_diaria_p text, cd_agenda_where_p text) FROM PUBLIC;

