-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ageint_obter_setor_proc_int ( nr_seq_proc_interno_p bigint, cd_setor_origem_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_proced_principal_p text default 'S', cd_estabelecimento_p bigint DEFAULT NULL) RETURNS bigint AS $body$
DECLARE


cd_setor_atendimento_w	integer;
cd_estabelecimento_w	smallint;
ie_tipo_convenio_w	smallint;
nr_seq_agrupamento_w	bigint;
cd_medico_w				varchar(10);

/* Rafael em 5/3/8 OS85232. Incluí o parâmetro cd_setor_origem_p e substituí este cursos pelo novo cursor abaixo;
Cursor C01 is
select	cd_setor_atendimento
from	proc_interno_setor
where	nr_seq_proc_interno	= nr_seq_proc_interno_p
order by nr_prioridade desc;
*/
C01 CURSOR FOR
SELECT	cd_setor_atendimento
from	proc_interno_setor
where	nr_seq_proc_interno	= nr_seq_proc_interno_p
and	((cd_setor_origem	= cd_setor_origem_p) or (coalesce(cd_setor_origem_p::text, '') = '') or (coalesce(cd_setor_origem::text, '') = ''))
and (coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_p,1))	= coalesce(cd_estabelecimento_p,1))
and 	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_p,0)) = coalesce(ie_tipo_atendimento_p,0)
and	coalesce(cd_perfil,obter_perfil_ativo) = obter_perfil_ativo
AND ((coalesce(ie_somente_principal,'N') = 'N') OR
	((coalesce(ie_somente_principal,'N') = 'S') AND (ie_proced_principal_p = 'S')))
and 	coalesce(ie_tipo_convenio, coalesce(ie_tipo_convenio_w,0)) = coalesce(ie_tipo_convenio_w,0)
and	coalesce(nr_seq_agrupamento, coalesce(nr_seq_agrupamento_w,0)) = coalesce(nr_seq_agrupamento_w,0)
and		((coalesce(cd_especialidade::text, '') = '') or (obter_se_especialidade_medico(cd_medico_w,cd_especialidade) = 'S'))
order by
	nr_prioridade desc,
	coalesce(cd_setor_origem,0),
	coalesce(ie_tipo_atendimento,0),
	coalesce(ie_tipo_convenio_w,0),
	coalesce(nr_seq_agrupamento,0);


BEGIN

select	max(ie_tipo_convenio)
into STRICT	ie_tipo_convenio_w
from	convenio
where	cd_convenio 	= cd_convenio_p;

select	coalesce(max(nr_seq_agrupamento),0)
into STRICT	nr_seq_agrupamento_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_origem_p;

select	max(a.cd_pessoa_fisica)
into STRICT	cd_medico_w
from	medico a,
		usuario b
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and		b.nm_usuario		= wheb_usuario_pck.get_nm_usuario;

open C01;
loop
	fetch C01 into
		cd_setor_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	cd_setor_atendimento_w	:= cd_setor_atendimento_w;
end loop;
close C01;

return	cd_setor_atendimento_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ageint_obter_setor_proc_int ( nr_seq_proc_interno_p bigint, cd_setor_origem_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_proced_principal_p text default 'S', cd_estabelecimento_p bigint DEFAULT NULL) FROM PUBLIC;

