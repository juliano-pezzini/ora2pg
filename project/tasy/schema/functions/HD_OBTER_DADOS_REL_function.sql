-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hd_obter_dados_rel (nm_usuario_cor_p text, dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_fisica_p text, nr_unidade_p1_p bigint, dt_referencia1_p timestamp, ie_exame_p text, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


ds_retorno_w			double precision;
ds_maiores_anual_w		bigint;
ds_maiores_trimestral_w		bigint;
ds_resultado_anual_w		bigint;
ds_resultado_trimestral_w	bigint;
ds_resultado_todos_w		bigint;
ds_entre_onze_treze_w		bigint;
ds_menores_onze_w		bigint;
ds_maiores_treze_w		bigint;
ds_entre_cem_seiscentos_w	bigint;
ds_menores_cem_w		bigint;
ds_maiores_seiscentos_w		bigint;
ds_vinte_quarenta_cinco_w	bigint;
ds_menores_vinte_w		bigint;
ds_maiores_quarenta_cinco_w 	bigint;
ds_maiores_tres_pto_cinco_w	bigint;
ds_entre_cem_quinhentos_w	bigint;
ds_maiores_quinhentos_w		bigint;
ds_fosforo_w			bigint;
ds_calcio_potassio_w		bigint;
ds_todos_fosforo_w		bigint;
ds_todos_calcio_potassio_w	bigint;
ds_maiores_noventa_w		bigint;
ds_menores_cinco_w		bigint;
nr_seq_motivo_fim_w		bigint;
nr_atendimento_w		bigint;


BEGIN

if (ie_exame_p = 'KTV') then  -- 3
	 select	count(a.ds_resultado1)
	 into STRICT	ds_maiores_anual_w
	 from	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 where	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 and 	a.nm_usuario = nm_usuario_cor_p
	 and	a.dt_referencia between dt_inicial_p-365 and dt_final_p
	 and 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 and	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 and (u.nr_sequencia = nr_unidade_p1_p)
	 and	ie_ordem = 5
	 and	obter_somente_numero(a.ds_resultado1) > 1.2;

	 select	count(a.ds_resultado1)
	 into STRICT 	ds_maiores_trimestral_w
	 from	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 where	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 and 	a.nm_usuario = nm_usuario_cor_p
	 and	a.dt_referencia between dt_inicial_p-90 and dt_final_p
	 and 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 and	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 and (u.nr_sequencia = nr_unidade_p1_p)
	 and	ie_ordem = 5
	 and	obter_somente_numero(a.ds_resultado1) > 1.2;

	 select	count(a.ds_resultado1)
	 into STRICT 	ds_resultado_anual_w
	 from	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 where	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 and 	a.nm_usuario = nm_usuario_cor_p
	 and	a.dt_referencia between dt_inicial_p-365 and dt_final_p
	 and 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 and	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 and (u.nr_sequencia = nr_unidade_p1_p)
	 and	a.ds_resultado1 <> '-'
	 and	ie_ordem = 5;

	 select	count(a.ds_resultado1)
	 into STRICT 	ds_resultado_trimestral_w
	 from	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 where	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 and 	a.nm_usuario = nm_usuario_cor_p
	 and	a.dt_referencia between dt_inicial_p-90 and dt_final_p
	 and 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 and	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 and (u.nr_sequencia = nr_unidade_p1_p)
	 and	a.ds_resultado1 <> '-'
	 and	ie_ordem = 5;

	 if (ie_opcao_p = 'PA') then  -- PA = Percentual anual
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_maiores_anual_w)=0 THEN 1  ELSE MAX(ds_maiores_anual_w) END  * CASE WHEN MAX(ds_maiores_anual_w)=0 THEN 0  ELSE 100 END)/CASE WHEN MAX(ds_resultado_anual_w)=0 THEN 1  ELSE MAX(ds_resultado_anual_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 ELSIF (ie_opcao_p = 'PT') THEN  --  PT = Percentual trimestral
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_maiores_trimestral_w)=0 THEN 1  ELSE MAX(ds_maiores_trimestral_w) END  * CASE WHEN MAX(ds_maiores_trimestral_w)=0 THEN 0  ELSE 100 END)/CASE WHEN MAX(ds_resultado_trimestral_w)=0 THEN 1  ELSE MAX(ds_resultado_trimestral_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 END IF;

END IF;

IF (ie_exame_p = 'ANEMIA') THEN	--9
	 SELECT	COUNT(a.ds_resultado2)
	 INTO STRICT 	ds_entre_onze_treze_w
	 FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado2) BETWEEN 11 AND 13;

	 SELECT	COUNT(a.ds_resultado2)
	 INTO STRICT 	ds_menores_onze_w
	 FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado2) < 11;

	 SELECT	COUNT(a.ds_resultado2)
	 INTO STRICT 	ds_maiores_treze_w
	 FROM	HD_EXAME_GRID_CONTROLE a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado2) > 13;

	 SELECT	COUNT(a.ds_resultado2)
	 INTO STRICT 	ds_resultado_todos_w
	 FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	a.ds_resultado2 <> '-'
	 AND	ie_ordem = 5;

         IF (ie_opcao_p = 'POT') THEN  --  POT = Percentual dos valores entre 11 e 13
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_entre_onze_treze_w)=0 THEN 1  ELSE MAX(ds_entre_onze_treze_w) END  * CASE WHEN MAX(ds_entre_onze_treze_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 ELSIF (ie_opcao_p = 'PMEO') THEN  --  PMEO = Percentual dos valores menores do que 11
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_menores_onze_w)=0 THEN 1  ELSE MAX(ds_menores_onze_w) END  * CASE WHEN MAX(ds_menores_onze_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 ELSIF (ie_opcao_p = 'PMAT') THEN --  PMAT = Percentual dos valores maiores do que 13
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_maiores_treze_w)=0 THEN 1  ELSE MAX(ds_maiores_treze_w) END  * CASE WHEN MAX(ds_maiores_treze_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 END IF;
END IF;

IF (ie_exame_p = 'FERRITINA') THEN  --  14
	 SELECT	COUNT(a.ds_resultado6)
	 INTO STRICT 	ds_entre_cem_seiscentos_w
	 FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado6) BETWEEN 100 AND 600;

	 SELECT	COUNT(a.ds_resultado6)
	 INTO STRICT 	ds_menores_cem_w
	 FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado6) < 100;

	 SELECT	COUNT(a.ds_resultado6)
	 INTO STRICT 	ds_maiores_seiscentos_w
	 FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado6) > 600;

	 SELECT	COUNT(a.ds_resultado6)
	 INTO STRICT 	ds_resultado_todos_w
	 FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	a.ds_resultado6	 <> '-'
	 AND	ie_ordem = 5;

	 IF (ie_opcao_p = 'PCS') THEN  --  PCS = Percentual dos valores entre 100 e 600
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_entre_cem_seiscentos_w)=0 THEN 1  ELSE MAX(ds_entre_cem_seiscentos_w) END  * CASE WHEN MAX(ds_entre_cem_seiscentos_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 ELSIF (ie_opcao_p = 'PMEC') THEN  --  PMEC = Percentual dos valores menores do que 100
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_menores_cem_w)=0 THEN 1  ELSE MAX(ds_menores_cem_w) END  * CASE WHEN MAX(ds_menores_cem_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 ELSIF (ie_opcao_p = 'PMAS') THEN  --  PMAS = Percentual dos valores maiores do que 600
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_maiores_seiscentos_w)=0 THEN 1  ELSE MAX(ds_maiores_seiscentos_w) END  * CASE WHEN MAX(ds_maiores_seiscentos_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 END IF;
END IF;

IF (ie_exame_p = 'TRANSFERRINA') THEN  --  45
	SELECT	COUNT(a.ds_resultado5)
	INTO STRICT 	ds_vinte_quarenta_cinco_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado5) BETWEEN 20 AND 45;

	SELECT	COUNT(a.ds_resultado5)
	INTO STRICT 	ds_menores_vinte_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado5) < 20;

	SELECT	COUNT(a.ds_resultado5)
	INTO STRICT 	ds_maiores_quarenta_cinco_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado5) > 45;

	SELECT	COUNT(a.ds_resultado5)
	INTO STRICT 	ds_resultado_todos_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	a.ds_resultado5 <> '-'
	 AND	ie_ordem = 5;

	 IF (ie_opcao_p = 'PVQC') THEN  --   PVQC = Percentual dos valores entre 20 e 45
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_vinte_quarenta_cinco_w)=0 THEN 1  ELSE MAX(ds_vinte_quarenta_cinco_w) END  * CASE WHEN MAX(ds_vinte_quarenta_cinco_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 ELSIF (ie_opcao_p = 'PMEV') THEN  --  PMEV = Precentual dos valores menores que 20
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_menores_vinte_w)=0 THEN 1  ELSE MAX(ds_menores_vinte_w) END  * CASE WHEN MAX(ds_menores_vinte_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 ELSIF (ie_opcao_p = 'PMAQC') THEN  --  PMAQC = Percentual dos valores maiores que 45
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_maiores_quarenta_cinco_w)=0 THEN 1  ELSE MAX(ds_maiores_quarenta_cinco_w) END  * CASE WHEN MAX(ds_maiores_quarenta_cinco_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 END IF;
END IF;

IF (ie_exame_p = 'NUTRICAO') THEN  -- 24
	SELECT	COUNT(a.ds_resultado4)
	INTO STRICT 	ds_maiores_tres_pto_cinco_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado4) > 3.5;

	SELECT	COUNT(a.ds_resultado4)
	INTO STRICT 	ds_resultado_todos_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	a.ds_resultado4 <> '-'
	 AND	ie_ordem = 5;

	 IF (ie_opcao_p = 'PTPC') THEN  --   PTPC = Percentual dos valores maiores do que 3,5
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN MAX(ds_maiores_tres_pto_cinco_w)=0 THEN 1  ELSE MAX(ds_maiores_tres_pto_cinco_w) END  * CASE WHEN MAX(ds_maiores_tres_pto_cinco_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 END IF;
END IF;

IF (ie_exame_p = 'METABOLISMO') THEN  -- 34 PTH
	SELECT	COUNT(a.ds_resultado10)
	INTO STRICT 	ds_entre_cem_quinhentos_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado10) BETWEEN 100 AND 500;

	SELECT	COUNT(a.ds_resultado10)
	INTO STRICT 	ds_menores_cem_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado10) < 100;

	SELECT	COUNT(a.ds_resultado10)
	INTO STRICT 	ds_maiores_quinhentos_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado10) > 500;

	SELECT	COUNT(a.ds_resultado10)
	INTO STRICT 	ds_resultado_todos_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	a.ds_resultado10 <> '-'
	 AND	ie_ordem = 5;

	SELECT	COUNT(a.ds_resultado8) --  16 Fósforo
	INTO STRICT 	ds_fosforo_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	obter_somente_numero(a.ds_resultado8) < 5.5;

	SELECT	COUNT(a.ds_resultado8)
	INTO STRICT 	ds_todos_fosforo_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	a.ds_resultado8 <> '-'
	 AND	ie_ordem = 5;

	SELECT	COUNT(a.ds_resultado7)  -- a.ds_resultado7 = Calcio / a.ds_resultado3 = Potássio
	INTO STRICT 	ds_calcio_potassio_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND (obter_somente_numero(a.ds_resultado7) * obter_somente_numero(a.ds_resultado3)) < 55;

	SELECT	COUNT(a.ds_resultado7)
	INTO STRICT 	ds_todos_calcio_potassio_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	a.ds_resultado7 <> '-'
	 AND	ie_ordem = 5;

	 IF (ie_opcao_p = 'PCQ') THEN  --  PQC = Percentual dos valores entre 100 e 500
		SELECT 	SUBSTR(campo_mascara_virgula_casas((CASE WHEN ds_entre_cem_quinhentos_w=0 THEN 1  ELSE ds_entre_cem_quinhentos_w END  * CASE WHEN MAX(ds_entre_cem_quinhentos_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 ELSIF (ie_opcao_p = 'PMECEM') THEN  -- PMECEM = Percentual dos valores menores do que 100
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN ds_menores_cem_w=0 THEN 1  ELSE ds_menores_cem_w END  * CASE WHEN MAX(ds_menores_cem_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 ELSIF (ie_opcao_p = 'PMAQ') THEN  --  PMAQ = Percentual dos valores maiores que 500
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN ds_maiores_quinhentos_w=0 THEN 1  ELSE ds_maiores_quinhentos_w END  * CASE WHEN MAX(ds_maiores_quinhentos_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_resultado_todos_w)=0 THEN 1  ELSE MAX(ds_resultado_todos_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 ELSIF (ie_opcao_p = 'PFOS') THEN  --  Fósforo
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN ds_fosforo_w=0 THEN 1  ELSE ds_fosforo_w END  * CASE WHEN MAX(ds_fosforo_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_todos_fosforo_w)=0 THEN 1  ELSE MAX(ds_todos_fosforo_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 ELSIF (ie_opcao_p = 'PCALPOT') THEN	 --  Calcio X Potassio
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN ds_calcio_potassio_w=0 THEN 1  ELSE ds_calcio_potassio_w END  * CASE WHEN MAX(ds_calcio_potassio_w)=0 THEN 0  ELSE 100 END) / CASE WHEN MAX(ds_todos_calcio_potassio_w)=0 THEN 1  ELSE MAX(ds_todos_calcio_potassio_w) END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	 END IF;
END IF;

IF (ie_exame_p = 'FAV') THEN  -- Aguardando informações
	SELECT	COUNT(b.nr_seq_tecnica)
	INTO STRICT 	ds_maiores_noventa_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p,
		hd_acesso b,
		hd_tecnica_acesso c
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND	b.cd_pessoa_fisica = p.cd_pessoa_fisica
	 AND	b.nr_seq_tecnica = c.nr_sequencia
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	 AND	c.ie_tipo_acesso = 'FAV';

	SELECT	COUNT(b.nr_seq_tecnica)
	INTO STRICT 	ds_resultado_todos_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p,
		hd_acesso b,
		hd_tecnica_acesso c
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND	b.cd_pessoa_fisica = p.cd_pessoa_fisica
	 AND	b.nr_seq_tecnica = c.nr_sequencia
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5;

	IF (ie_opcao_p = 'PMANOV') THEN
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN ds_maiores_noventa_w=0 THEN 1  ELSE ds_maiores_noventa_w END  * CASE WHEN ds_maiores_noventa_w=0 THEN 0  ELSE 100 END) / CASE WHEN ds_resultado_todos_w=0 THEN 1  ELSE ds_resultado_todos_w END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	END IF;
END IF;

IF (ie_exame_p = 'GPID') THEN
	SELECT	COUNT(b.qt_gpid)
	INTO STRICT 	ds_menores_cinco_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p,
		hd_dialise b
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	AND 	b.qt_gpid < 5;

	SELECT	COUNT(b.qt_gpid)
	INTO STRICT 	ds_resultado_todos_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p,
		hd_dialise b
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5;

	IF (ie_opcao_p = 'PMECIN') THEN
		SELECT	SUBSTR(campo_mascara_virgula_casas((CASE WHEN ds_menores_cinco_w=0 THEN 1  ELSE ds_menores_cinco_w END  * CASE WHEN ds_menores_cinco_w=0 THEN 0  ELSE 100 END ) / CASE WHEN ds_resultado_todos_w=0 THEN 1  ELSE ds_resultado_todos_w END ,2),1,10)
		INTO STRICT	ds_retorno_w
		;
	END IF;
END IF;

IF (ie_exame_p = 'OBITO') THEN
	SELECT	DISTINCT MAX(b.nr_seq_motivo_fim)
	INTO STRICT	nr_seq_motivo_fim_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p,
		paciente_tratamento b
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5
	AND     b.dt_final_tratamento = (SELECT MAX(x.dt_final_tratamento)
		 			 FROM	paciente_tratamento x
					 WHERE  x.cd_pessoa_fisica = b.cd_pessoa_fisica);
	IF (ie_opcao_p = 'OBITO') THEN
		ds_retorno_w := nr_seq_motivo_fim_w;
	END IF;

END IF;

IF (ie_exame_p = 'ATEND') THEN
	SELECT	DISTINCT MAX(SUBSTR(hd_obter_atend_hd_Dialise(p.cd_pessoa_fisica,hd_obter_hemodialise_atual(p.cd_pessoa_fisica, 'U')),1,30))
	INTO STRICT	nr_atendimento_w
	FROM	hd_exame_grid_controle a,
		hd_unidade_dialise u,
		hd_pac_renal_cronico p
	 WHERE	p.cd_pessoa_fisica = a.cd_pessoa_fisica
	 AND 	a.nm_usuario = nm_usuario_cor_p
	 AND	a.dt_referencia BETWEEN dt_inicial_p AND dt_final_p
	 AND 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) OR (coalesce(cd_pessoa_fisica_p,'0') = '0'))
	 AND	coalesce(hd_obter_unidade_prc(p.cd_pessoa_fisica,'C'),p.nr_seq_unid_dialise) = u.nr_sequencia
	 and	hd_obter_se_trat_ativo_agudo(p.cd_pessoa_fisica,dt_final_p) = 'N'
	 and	hd_obter_se_pac_ativo_data(p.cd_pessoa_fisica, dt_final_p) = 'S'
	 AND (u.nr_sequencia = nr_unidade_p1_p)
	 AND	ie_ordem = 5;

	IF (ie_opcao_p = 'ATEND') THEN
		ds_retorno_w := nr_atendimento_w;
	END IF;

END IF;

RETURN	ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hd_obter_dados_rel (nm_usuario_cor_p text, dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_fisica_p text, nr_unidade_p1_p bigint, dt_referencia1_p timestamp, ie_exame_p text, ie_opcao_p text) FROM PUBLIC;

