-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nota_conta_prot_conv ( nr_seq_protocolo_p bigint, nr_interno_conta_p bigint, ie_titulo_p text, ie_somente_ativas_p text default 'S', ie_tipo_nota_p text default 'I') RETURNS varchar AS $body$
DECLARE


nr_nota_w			varchar(255);
nr_nfe_imp_w			varchar(255);
ds_nota_w			varchar(4000) := ' ';
ie_titulo_w			varchar(1) := 'N';
ie_exibir_nf_cred_deb_w		varchar(1) := 'N';

c01 CURSOR FOR
	SELECT 	nr_nota_fiscal,
		nr_nfe_imp
	from  	nota_fiscal
	where (nr_seq_protocolo_p <> 0)
	and (nr_seq_protocolo = nr_seq_protocolo_p)
	and (nr_interno_conta_p = nr_interno_conta or nr_interno_conta_p = 0)
	and     ((coalesce(ie_somente_ativas_p, 'S') = 'S' and ie_situacao = '1') or (coalesce(ie_somente_ativas_p, 'S') <> 'S'))
	and     ((coalesce(ie_exibir_nf_cred_deb_w, 'N') = 'N' and ie_tipo_fatura not in ('D', 'C')) or (coalesce(ie_exibir_nf_cred_deb_w, 'S') = 'S'))
	
union

	SELECT 	substr(b.nr_nota_fiscal,1,255) nr_nota_fiscal, 
		substr(b.nr_nfe_imp,1,255)
	from  	nota_fiscal b,
		conta_paciente a
	where (nr_seq_protocolo_p <> 0) 
	and  	a.nr_seq_protocolo  = nr_seq_protocolo_p
	and  	a.nr_interno_conta  = b.nr_interno_conta
	and (nr_interno_conta_p  = a.nr_interno_conta or nr_interno_conta_p = 0)
	and     ((coalesce(ie_somente_ativas_p, 'S') = 'S' and ie_situacao = '1') or (coalesce(ie_somente_ativas_p, 'S') <> 'S'))
	and     ((coalesce(ie_exibir_nf_cred_deb_w, 'N') = 'N' and b.ie_tipo_fatura not in ('D', 'C')) or (coalesce(ie_exibir_nf_cred_deb_w, 'S') = 'S'))
	
union
 
	select 	nr_nota_fiscal, 
		(select x.nr_nfe_imp from nota_fiscal x where x.nr_sequencia = nr_seq_nf_saida)  nr_nfe_imp
	from  	titulo_receber
	where  	nr_seq_protocolo  = nr_seq_protocolo_p
	and    	coalesce(nr_nota_fiscal,'0')  <> '0'
	and (nr_interno_conta_p  = nr_interno_conta or nr_interno_conta_p = 0)
	and  	ie_titulo_w = 'S'
	
union

	select  a.nr_nota_fiscal, 
		a.nr_nfe_imp
	from  	nota_fiscal a,
		protocolo_convenio b
	where   a.nr_seq_lote_prot = b.nr_seq_lote_protocolo
	and  	nr_seq_protocolo_p  <> 0
	and     ((coalesce(ie_somente_ativas_p, 'S') = 'S' and ie_situacao = '1') or (coalesce(ie_somente_ativas_p, 'S') <> 'S'))
	and     ((coalesce(ie_exibir_nf_cred_deb_w, 'N') = 'N' and a.ie_tipo_fatura not in ('D', 'C')) or (coalesce(ie_exibir_nf_cred_deb_w, 'S') = 'S'))
	and  	b.nr_seq_protocolo  = nr_seq_protocolo_p
	order by nr_nota_fiscal;


BEGIN

ie_titulo_w := ie_titulo_p;

if (coalesce(ie_titulo_p,'X') = 'X') then
	ie_titulo_w := Obter_Valor_Param_Usuario(85,56,wheb_usuario_pck.get_cd_perfil,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
end if;

/* Parametros da funcao "Consulta de protocolo" -14
   2 - Exibir notas de debito / credito na "Consulta de protocolos"
   S,N 
   
   3 - Tipos de numeracao de faturas a exibir na "Consulta de protocolos"
   T - Numero de fatura interna e externa 
   I - Somente numero fatura interna (NR_NOTA_FISCAL)
   E - Somente numero fatura externa (NR_NFE_IMP)
*/
ie_exibir_nf_cred_deb_w := Obter_Valor_Param_Usuario(-14,2,wheb_usuario_pck.get_cd_perfil,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);

open c01;
loop
fetch c01 into
	nr_nota_w,
	nr_nfe_imp_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	if (length(ds_nota_w) < 3600) then
		if (ie_tipo_nota_p = 'I') then
			ds_nota_w := substr(ds_nota_w || nr_nota_w ||', ', 1, 4000);
		elsif (ie_tipo_nota_p = 'E') then
			if (nr_nfe_imp_w IS NOT NULL AND nr_nfe_imp_w::text <> '') then
				ds_nota_w := substr(ds_nota_w || nr_nfe_imp_w ||', ', 1, 4000);
			end if;
		end if;
	end if;
end loop;
close c01;

return substr(ds_nota_w,1,length(ds_nota_w) - 2);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nota_conta_prot_conv ( nr_seq_protocolo_p bigint, nr_interno_conta_p bigint, ie_titulo_p text, ie_somente_ativas_p text default 'S', ie_tipo_nota_p text default 'I') FROM PUBLIC;

