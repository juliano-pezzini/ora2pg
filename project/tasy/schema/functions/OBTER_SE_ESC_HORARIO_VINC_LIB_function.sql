-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_esc_horario_vinc_lib ( nr_seq_esc_horario_p bigint, nr_seq_esc_diaria_p bigint, nr_seq_esc_diaria_ref_p bigint) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(1) := 'N';
qt_reg_w			bigint;
nr_seq_escala_w		escala_diaria.nr_seq_escala%type;
ie_dia_semana_w		escala_horario_medico_lib.ie_dia_semana%type;
ie_dia_semana_esc_w	varchar(15);
dt_escala_w		timestamp;
hr_inicial_w		varchar(20);
hr_final_w		varchar(20);
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;

C01 CURSOR FOR
	SELECT	(coalesce(ie_dia_semana,0))::numeric
	from	escala_horario_medico_lib
	where	nr_seq_escala_horario = nr_seq_esc_horario_p
	and	nr_seq_escala = nr_seq_escala_w
	and	hr_inicial_vinc = hr_inicial_w
	and	hr_final_vinc = hr_final_w
	and (coalesce(ie_feriado,'N') = 'N'
		or (ie_feriado = 'S' and obter_se_feriado(cd_estabelecimento_w,dt_escala_w) > 0)
		or (ie_feriado = 'F' and obter_se_feriado(cd_estabelecimento_w,dt_escala_w) = 0))
	group by coalesce(ie_dia_semana,0)
	order by 1;


BEGIN

select	count(*)
into STRICT	qt_reg_w
from	escala_horario_medico_lib
where	nr_seq_escala_horario = nr_seq_esc_horario_p;

if (qt_reg_w > 0) then
	begin

	begin
	select	nr_seq_escala,
		pkg_date_utils.get_WeekDay(dt_inicio),
		dt_inicio
	into STRICT	nr_seq_escala_w,
		ie_dia_semana_esc_w,
		dt_escala_w
	from	escala_diaria
	where	nr_sequencia = nr_seq_esc_diaria_p;

	select	to_char(dt_inicio,'hh24:mi'),
		to_char(dt_fim,'hh24:mi')
	into STRICT	hr_inicial_w,
		hr_final_w
	from	escala_diaria
	where	nr_sequencia = coalesce(nr_seq_esc_diaria_ref_p,nr_seq_esc_diaria_p);
	exception
	when others then
		goto final;
	end;

	open C01;
	loop
	fetch C01 into
		ie_dia_semana_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_dia_semana_w = 0) then /* Todos os dias */
			begin
			ie_retorno_w	:= 'S';
			goto final;
			end;
		elsif (ie_dia_semana_w between 1 and 7) then /* Todos os dias da semana */
			begin
			if (ie_dia_semana_w = ie_dia_semana_esc_w) then
				begin
				ie_retorno_w	:= 'S';
				goto final;
				end;
			end if;
			end;
		elsif (ie_dia_semana_w = 9) then /* Dias de trabalho */
			begin
			if (pkg_date_utils.IS_BUSINESS_DAY(dt_escala_w) = 1) then --  ie_dia_semana_esc_w between 2 and 6
				begin
				ie_retorno_w	:= 'S';
				goto final;
				end;
			end if;
			end;
		elsif (ie_dia_semana_w = 10) then /* Finais de semana */
			begin
			if (pkg_date_utils.IS_BUSINESS_DAY(dt_escala_w) = 0) then -- ie_dia_semana_esc_w in (7,1)
				begin
				ie_retorno_w	:= 'S';
				goto final;
				end;
			end if;
			end;
		end if;
		end;
	end loop;
	close C01;
	end;
end if;

<<final>>

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_esc_horario_vinc_lib ( nr_seq_esc_horario_p bigint, nr_seq_esc_diaria_p bigint, nr_seq_esc_diaria_ref_p bigint) FROM PUBLIC;

