-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_convenio_agendamento (cd_pessoa_fisica_p text, cd_tipo_agenda_p bigint, dt_agenda_p timestamp, hr_inicio_p timestamp, ie_forma_convenio_p text, nm_usuario_p text) RETURNS bigint AS $body$
DECLARE

						 
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
cd_usuario_convenio_w	varchar(30);
dt_validade_w			timestamp;
nr_doc_convenio_w		varchar(20);
cd_tipo_acomodacao_w	smallint;	
dt_inicio_w				timestamp;					
nr_sequencia_w			bigint;
CD_PLANO_w			varchar(20);
						

BEGIN 
 
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (cd_tipo_agenda_p IS NOT NULL AND cd_tipo_agenda_p::text <> '') and (hr_inicio_p IS NOT NULL AND hr_inicio_p::text <> '') and (ie_forma_convenio_p IS NOT NULL AND ie_forma_convenio_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then	 
	dt_inicio_w := pkg_date_utils.get_DateTime(dt_agenda_p, hr_inicio_p);
		 
		 
	if (ie_forma_convenio_p = 'AT') then /* convenio ultimo atendimento */
 
	 
		SELECT * FROM define_convenio_atend_agenda(cd_pessoa_fisica_p, nm_usuario_p, cd_convenio_w, cd_categoria_w, dt_validade_w, cd_usuario_convenio_w, nr_doc_convenio_w, cd_tipo_acomodacao_w, CD_PLANO_w) INTO STRICT cd_convenio_w, cd_categoria_w, dt_validade_w, cd_usuario_convenio_w, nr_doc_convenio_w, cd_tipo_acomodacao_w, CD_PLANO_w;
		 
	elsif (ie_forma_convenio_p = 'AG') or (ie_forma_convenio_p = 'A') then /* convenio ultimo agendamento */
 
		if (cd_tipo_agenda_p in (1,2)) then 
			 
	 
			select	coalesce(max(b.nr_sequencia),0) 
			into STRICT	nr_sequencia_w 
			from	agenda a, 
					agenda_paciente b 
			where	a.cd_agenda = b.cd_agenda 
			and		a.cd_tipo_agenda in (1,2) 
			and		((ie_forma_convenio_p	= 'A') or (b.ie_status_agenda = 'E')) 
			and		b.cd_pessoa_fisica = cd_pessoa_fisica_p 
			and		hr_inicio < dt_inicio_w;
			 
			select 	cd_convenio 
			into STRICT 	cd_convenio_w 
			from	agenda_paciente 
			where 	nr_sequencia = nr_sequencia_w;
			 
		 
		elsif (cd_tipo_agenda_p in (3,4)) then 
				 
			select	coalesce(max(b.nr_sequencia),0) 
			into STRICT	nr_sequencia_w 
			from	agenda a, 
					agenda_consulta b 
			where	a.cd_agenda = b.cd_agenda 
			and		a.cd_tipo_agenda = 3 
			and		((ie_forma_convenio_p	= 'A') or (b.ie_status_agenda = 'E')) 
			and		b.cd_pessoa_fisica = cd_pessoa_fisica_p 
			and		dt_agenda < dt_inicio_w;
			 
			select 	cd_convenio 
			into STRICT 	cd_convenio_w 
			from	agenda_consulta 
			where 	nr_sequencia = nr_sequencia_w;
		 
		end if;
	end if;
end if;
 
return	cd_convenio_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_convenio_agendamento (cd_pessoa_fisica_p text, cd_tipo_agenda_p bigint, dt_agenda_p timestamp, hr_inicio_p timestamp, ie_forma_convenio_p text, nm_usuario_p text) FROM PUBLIC;

