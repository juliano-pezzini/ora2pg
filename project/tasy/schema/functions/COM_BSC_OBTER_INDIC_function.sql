-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION com_bsc_obter_indic ( dt_referencia_p timestamp, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


qt_retorno_w			double precision;
dt_ref_mes_w			timestamp;
dt_fim_mes_w			timestamp;
qt_atual_w			double precision;
qt_anterior_w			double precision;
qt_total_w			double precision;
qt_erro_w			double precision;
qt_duvida_w			double precision;
qt_solic_w			double precision;
qt_sugest_w			double precision;

/* Opções
	Cliente - Obter os clientes ativos até o mès em questão
	Contrato - Obter os contratos em aberto no mês em questão
	%ClienteAno - Obter o percentual de aumento de clientes de um ano para outro
	%ErroProduto - Obter o percentual de OS de Erro dentre as recebidas no mês
	OS_Rec_Tecnologia - Obter o número de OS recebidas no mês pelo depto de tecnologia excluindo as de dúvida
	OS_Rec_Desenvolvimento - Obter o número de OS recebidas no mês pelo depto de desenvolvimento excluindo as de dúvida
	OS_Rec_Suporte - Obter o número de OS recebidas no mês pelo depto de suporte com classificação de dúvida ou Erro
*/
BEGIN
dt_ref_mes_w			:= PKG_DATE_UTILS.start_of(dt_referencia_p,'month',0);
dt_fim_mes_w			:= PKG_DATE_UTILS.END_OF(dt_ref_mes_w, 'MONTH', 0);

if (ie_opcao_p = 'Cliente') then
	begin
	select	count(*)
	into STRICT	qt_retorno_w
	from	com_cliente a
	where	cd_cnpj not in ('01950338000177','81627838000535') --- Wheb e Ação
	and	ie_classificacao = 'C'
	and	a.ie_produto in ('I', 'M', 'MD', 'MDC', 'P', 'O')
	and	a.dt_revisao_prevista <= dt_fim_mes_w;
	end;
elsif (ie_opcao_p = '%ClienteAno') then
	begin
	select	count(*)
	into STRICT	qt_atual_w
	from	com_cliente a
	where	cd_cnpj not in ('01950338000177','81627838000535') --- Wheb e Ação
	and	ie_classificacao = 'C'
	and	a.ie_produto in ('P','O')
	and	a.dt_revisao_prevista <= dt_fim_mes_w;
	select	count(*)
	into STRICT	qt_anterior_w
	from	com_cliente a
	where	cd_cnpj not in ('01950338000177','81627838000535') --- Wheb e Ação
	and	ie_classificacao = 'C'
	and	a.ie_produto in ('P','O')
	and	a.dt_revisao_prevista <= PKG_DATE_UTILS.END_OF(PKG_DATE_UTILS.ADD_MONTH(dt_fim_mes_w,-12,0), 'MONTH', 0);
	qt_retorno_w	:= (dividir(qt_atual_w, qt_anterior_w)-1)*100;
	end;
elsif (ie_opcao_p = 'Contrato') then
	begin
	if (dt_ref_mes_w = PKG_DATE_UTILS.start_of(clock_timestamp(),'month',0)) then
		select 	count(*)
		into STRICT	qt_retorno_w
		from 	com_cliente
		where 	cd_cnpj not in ('01950338000177','81627838000535') --- Wheb e Ação
 		and 	ie_classificacao = 'P'
		and	ie_fase_venda in ('C');
	else
		select	sum(a.clientes)
		into STRICT	qt_retorno_w
		from (
		SELECT	count(*) clientes
		from	com_cliente a
		where	cd_cnpj not in ('01950338000177','81627838000535') --- Wheb e Ação
		and	ie_classificacao = 'C'
		and	a.dt_revisao_prevista > dt_ref_mes_w
		and	exists (
			SELECT 1
			from Com_cliente_log b
			where a.nr_sequencia = b.nr_seq_cliente
			and b.ie_log		= '1'
			and b.ie_fase_venda	in ('C')
			and PKG_DATE_UTILS.start_of(dt_log,'day',0)	<= dt_fim_mes_w)
		
union

		select	count(*) prospect
		from	com_cliente a
		where	cd_cnpj not in ('01950338000177','81627838000535') --- Wheb e Ação
		and	ie_classificacao = 'P'
		and	exists (
			select 1
			from Com_cliente_log b
			where a.nr_sequencia = b.nr_seq_cliente
			and b.ie_log		= '1'
			and b.ie_fase_venda	in ('C')
			and PKG_DATE_UTILS.start_of(dt_log,'day',0)	<= dt_fim_mes_w)) a;
	end if;
	end;
elsif (ie_opcao_p = '%ErroProduto') then
	begin
	select	count(*) qt_total_os,
		sum(CASE WHEN COM_Obter_Tipo_Classif_OS(nr_sequencia)='W' THEN 1  ELSE 0 END ) qt_erro_os
	into STRICT	qt_total_w,
		qt_erro_w
	from	man_ordem_servico
	where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w;
	qt_retorno_w	:= dividir(qt_erro_w, qt_total_w)*100;
	end;
elsif (ie_opcao_p = 'OS_Rec_Suporte') then
	begin
	select  count(*) qt_total_os,
		sum(CASE WHEN ie_classificacao='D' THEN 1  ELSE 0 END ) qt_duvida_os,
		sum(CASE WHEN ie_classificacao='E' THEN 1  ELSE 0 END ) qt_erro_os,
		sum(CASE WHEN ie_classificacao='S' THEN 1  ELSE 0 END ) qt_solicitacao_os,
		sum(CASE WHEN ie_classificacao='T' THEN 1  ELSE 0 END ) qt_sugestao_os
	into STRICT	qt_total_w,
		qt_duvida_w,
		qt_erro_w,
		qt_solic_w,
		qt_sugest_w
	from    man_ordem_servico a
	where   dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	obter_gerencia_grupo_sup(a.nr_seq_grupo_sup,'C') in (5,58)
	and exists (	SELECT	1
			from	man_ordem_serv_estagio x,
				man_estagio_processo y
			where	x.nr_seq_estagio = y.nr_sequencia
			and	x.nr_seq_ordem = a.nr_sequencia
			and	x.nr_seq_estagio <> 511
			and	y.ie_suporte = 'S');
	qt_retorno_w	:= qt_duvida_w + qt_erro_w + qt_solic_w + qt_sugest_w;
	end;
elsif (ie_opcao_p = 'OS_Rec_Tecnologia') then
	begin

	select  count(*) qt_total_os,
		sum(CASE WHEN ie_classificacao='D' THEN 1  ELSE 0 END ) qt_duvida_os,
		sum(CASE WHEN ie_classificacao='E' THEN 1  ELSE 0 END ) qt_erro_os,
		sum(CASE WHEN ie_classificacao='S' THEN 1  ELSE 0 END ) qt_solicitacao_os,
		sum(CASE WHEN ie_classificacao='T' THEN 1  ELSE 0 END ) qt_sugestao_os
	into STRICT	qt_total_w,
		qt_duvida_w,
		qt_erro_w,
		qt_solic_w,
		qt_sugest_w
	from    man_ordem_servico a
	where   dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	nr_seq_grupo_des in (7,31,32,33)
	and exists (SELECT 1 from man_ordem_serv_estagio x, man_estagio_processo y
	  where x.nr_seq_estagio = y.nr_sequencia
	  and x.nr_seq_ordem = a.nr_sequencia
	  and y.ie_tecnologia = 'S');

	qt_retorno_w	:= qt_solic_w + qt_sugest_w + qt_erro_w + qt_duvida_w;

	end;
elsif (ie_opcao_p = 'OS_Rec_Desenvolvimento') then
	begin

	select  count(*) qt_total_os,
		sum(CASE WHEN ie_classificacao='D' THEN 1  ELSE 0 END ) qt_duvida_os,
		sum(CASE WHEN ie_classificacao='E' THEN 1  ELSE 0 END ) qt_erro_os,
		sum(CASE WHEN ie_classificacao='S' THEN 1  ELSE 0 END ) qt_solicitacao_os,
		sum(CASE WHEN ie_classificacao='T' THEN 1  ELSE 0 END ) qt_sugestao_os
	into STRICT	qt_total_w,
		qt_duvida_w,
		qt_erro_w,
		qt_solic_w,
		qt_sugest_w
	from    man_ordem_servico a
	where   dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and exists (SELECT 1 from man_ordem_serv_estagio x, man_estagio_processo y
	  where x.nr_seq_estagio = y.nr_sequencia
	  and x.nr_seq_ordem = a.nr_sequencia
	  and y.ie_desenv = 'S')
	and	nr_seq_grupo_des not in (7,31,32,33);

	qt_retorno_w	:= qt_solic_w + qt_sugest_w + qt_erro_w + qt_duvida_w;
	end;
end if;

return	qt_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION com_bsc_obter_indic ( dt_referencia_p timestamp, ie_opcao_p text) FROM PUBLIC;

