-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_obs_aval_consult ( nr_seq_quesito_p bigint, nr_seq_proj_p bigint, cd_consultor_p bigint) RETURNS varchar AS $body$
DECLARE


observacoes_w		varchar(4000);
observacao_w		varchar(500);


C01 CURSOR FOR
	SELECT 	substr(wheb_mensagem_pck.get_texto(300252,	'DT_AVALIACAO=' || b.dt_avaliacao || ';' ||
								'DS_OBSERVACAO=' || a.ds_observacao),1,4000)
	FROM      proj_consultor_aval_quesito	a,
		  proj_consultor_aval	b
	WHERE     b.nr_sequencia	= a.nr_seq_avaliacao
	AND	  cd_consultor		= cd_consultor_p
	AND	  (a.ds_observacao IS NOT NULL AND a.ds_observacao::text <> '')
	AND	  (TO_CHAR(b.dt_avaliacao, 'mm'))::numeric  > ((TO_CHAR(clock_timestamp(), 'mm'))::numeric -5)
	AND	  b.nr_seq_proj = nr_seq_proj_p
	AND	  a.nr_seq_quesito = nr_seq_quesito_p;


BEGIN
OPEN C01;
LOOP
FETCH C01 INTO
	observacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN
	observacoes_w	:= SUBSTR(observacao_w || '  ' || observacoes_w,1,4000);
	END;
END LOOP;
CLOSE C01;

RETURN	observacoes_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_obs_aval_consult ( nr_seq_quesito_p bigint, nr_seq_proj_p bigint, cd_consultor_p bigint) FROM PUBLIC;

