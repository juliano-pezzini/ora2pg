-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_cooperado_ativo ( cd_pessoa_fisica_p text, dt_referencia_p text, ds_param1 text, nr_seq_conta_p pls_conta.nr_sequencia%type default null) RETURNS varchar AS $body$
DECLARE


ie_cooperado_w	  		varchar(1) := 'N';
ie_situacao_w			varchar(3);
nr_seq_situacao_w		bigint;
nr_seq_cooperado_w		bigint;
dt_inclusao_w			timestamp;
dt_exclusao_w			timestamp;
dt_referencia_w			timestamp;
ie_ativo_data_w			varchar(3)	:= 'N';


BEGIN

begin
	dt_referencia_w	:= dt_referencia_p;

exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(296634, 'NR_SEQ_CONTA='||nr_seq_conta_p);
end;

if (coalesce(dt_referencia_w::text, '') = '') then
	dt_referencia_w	:= clock_timestamp();
end if;

/* Verificar primeiro se a pessoa física está cadastrada como cooperado */

select	max(nr_sequencia)
into STRICT	nr_seq_cooperado_w
from 	pls_cooperado
where 	cd_pessoa_fisica	= cd_pessoa_fisica_p
and	ie_status		= 'A';


if (nr_seq_cooperado_w IS NOT NULL AND nr_seq_cooperado_w::text <> '')	then
	/* Buscar a última alteração de situação */

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_situacao_w
	from 	pls_cooperado_situacao	a
	where 	a.nr_seq_cooperado	= nr_seq_cooperado_w
	and 	a.dt_alteracao	<= dt_referencia_w;

	if (nr_seq_situacao_w IS NOT NULL AND nr_seq_situacao_w::text <> '') then
		select 	max(ie_situacao)
		into STRICT	ie_ativo_data_w
		from 	pls_cooperado_situacao
		where 	nr_sequencia = nr_seq_situacao_w;
	/* Se não houve nenhuma alteração de situação, tem que confirmar se entá entre inclusão e exclusão */

	else
		select  dt_inclusao,
			dt_exclusao,
			coalesce(ie_status,'A')
		into STRICT	dt_inclusao_w,
			dt_exclusao_w,
			ie_situacao_w
		from 	pls_cooperado
		where 	nr_sequencia	= nr_seq_cooperado_w;

		if (dt_referencia_w >= dt_inclusao_w) and (dt_referencia_w < coalesce(dt_exclusao_w,dt_referencia_w+1)) then
			ie_ativo_data_w	:= 'A';
		end if;
	end if;
end if;

if (ie_ativo_data_w = 'A') then
	ie_cooperado_w	:= 'S';
end if;

return	ie_cooperado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_cooperado_ativo ( cd_pessoa_fisica_p text, dt_referencia_p text, ds_param1 text, nr_seq_conta_p pls_conta.nr_sequencia%type default null) FROM PUBLIC;

