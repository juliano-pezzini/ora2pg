-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hmcg_descricao_exames ( nr_prescricao_p bigint, cd_medico_p text, ie_opcao_p bigint) RETURNS varchar AS $body$
DECLARE


/*
Opção
1 - Primeira parte do SQL - Exame 1 traz os três primeiros exames
2 - Segunda parte do SQL - Exame 2 traz a partir do quarto ao sexto exame
3 - Terceira parte do SQL - Exame 3 traz a partir do sétimo ao nono exame
*/
ds_retorno_w	varchar(4000);


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (cd_medico_p IS NOT NULL AND cd_medico_p::text <> '') then
	begin

	if (ie_opcao_p = 1) then
		begin

		select 	obter_select_concatenado_bv('	select	ltrim(rpad(ltrim(nm_exame),33,'' '') || decode(mod(rownum,3),0,'''','''')) nm_exame
							from(	select  nm_exame,
									rownum linha
								from(	select	substr(c.nm_exame ||''(''||d.ds_material_exame||'')'',1,40) nm_exame
									from    prescr_medica a,
										prescr_procedimento b,
										exame_laboratorio c,
										material_exame_lab d
									where   a.nr_prescricao = b.nr_prescricao
									and    	b.nr_seq_exame = c.nr_seq_exame
									and    	b.cd_material_exame = d.cd_material_exame
									and    	a.nr_prescricao = :nr_prescricao_p
									and    	a.cd_medico = :cd_medico_p
									and    	((b.CD_MEDICO_SOLICITANTE is null) or (b.cd_medico_solicitante = a.cd_medico))
									and    	b.cd_motivo_baixa=0
									union all
									select  substr(c.nm_exame ||''(''||d.ds_material_exame||'')'',1,40) nm_exame
									from    prescr_medica a,
										prescr_procedimento b,
										exame_laboratorio c,
										material_exame_lab d
									where   a.nr_prescricao = b.nr_prescricao
									and    	b.nr_seq_exame = c.nr_seq_exame
									and    	b.cd_material_exame = d.cd_material_exame
									and     a.nr_prescricao = :nr_prescricao_p
									and     b.CD_MEDICO_SOLICITANTE = :cd_medico_p
									and     ((b.CD_MEDICO_SOLICITANTE is not null) or (b.cd_medico_solicitante <> a.cd_medico))
									and    b.cd_motivo_baixa=0
									union all
									select  substr(d.nm_exame ||''(''||e.ds_material_exame||'')'',1,40) nm_exame
									from    prescr_medica a,
										prescr_procedimento b,
										PRESCR_MEDICA_PROF_ADIC c,
										exame_laboratorio d,
										material_exame_lab e
									where   a.nr_prescricao = b.nr_prescricao
									and     b.nr_prescricao = c.nr_prescricao
									/*estranho não ter condicao*/

									and    b.nr_seq_exame = d.nr_seq_exame
									and    b.cd_material_exame = e.cd_material_exame
									and    a.nr_prescricao = :nr_prescricao_p
									and    c.CD_MEDICO_SOLICITANTE = :cd_medico_p
									and    b.cd_motivo_baixa=0
									union all
									select	substr(d.nm_exame ||''(''||e.ds_material_exame||'')'',1,40) nm_exame
									from   	prescr_medica a,
										prescr_procedimento b,
										PRESCR_PROCED_PROF_ADIC c,
										exame_laboratorio d,
										material_exame_lab e
									where  	a.nr_prescricao = b.nr_prescricao
									and    	b.nr_prescricao = c.nr_prescricao
									and    	b.nr_sequencia = c.nr_seq_procedimento
									and    	b.nr_seq_exame = d.nr_seq_exame
									and    	b.cd_material_exame = e.cd_material_exame
									and    	a.nr_prescricao = :nr_prescricao_p
									and    	c.CD_PROFISSIONAL = :cd_medico_p
									and    	b.cd_motivo_baixa=0))
									where   linha <= 3','nr_prescricao_p='|| nr_prescricao_p ||';'||'cd_medico_p='|| cd_medico_p,' ') nm_exame_1
		into STRICT 	ds_retorno_w
		;


		end;
	elsif (ie_opcao_p = 2) then
		begin

		select 	obter_select_concatenado_bv('	select  ltrim(rpad(ltrim(nm_exame),33,'' '') || decode(mod(rownum,3),0,'''','''')) nm_exame
							from(	select  nm_exame,
									rownum linha
								from(	select	substr(c.nm_exame ||''(''||d.ds_material_exame||'')'',1,40) nm_exame
									from    prescr_medica a,
										prescr_procedimento b,
										exame_laboratorio c,
										material_exame_lab d
									where   a.nr_prescricao = b.nr_prescricao
									and    	b.nr_seq_exame = c.nr_seq_exame
									and    	b.cd_material_exame = d.cd_material_exame
									and    	a.nr_prescricao = :nr_prescricao_p
									and    	a.cd_medico = :cd_medico_p
									and    	((b.CD_MEDICO_SOLICITANTE is null) or (b.cd_medico_solicitante = a.cd_medico))
									and    	b.cd_motivo_baixa=0
									union all
									select  substr(c.nm_exame ||''(''||d.ds_material_exame||'')'',1,40) nm_exame
									from    prescr_medica a,
										prescr_procedimento b,
										exame_laboratorio c,
										material_exame_lab d
									where   a.nr_prescricao = b.nr_prescricao
									and    	b.nr_seq_exame = c.nr_seq_exame
									and    	b.cd_material_exame = d.cd_material_exame
									and     a.nr_prescricao = :nr_prescricao_p
									and     b.CD_MEDICO_SOLICITANTE = :cd_medico_p
									and     ((b.CD_MEDICO_SOLICITANTE is not null) or (b.cd_medico_solicitante <> a.cd_medico))
									and    b.cd_motivo_baixa=0
									union all
									select  substr(d.nm_exame ||''(''||e.ds_material_exame||'')'',1,40) nm_exame
									from    prescr_medica a,
										prescr_procedimento b,
										PRESCR_MEDICA_PROF_ADIC c,
										exame_laboratorio d,
										material_exame_lab e
									where   a.nr_prescricao = b.nr_prescricao
									and     b.nr_prescricao = c.nr_prescricao
									/*estranho não ter condicao*/

									and    b.nr_seq_exame = d.nr_seq_exame
									and    b.cd_material_exame = e.cd_material_exame
									and    a.nr_prescricao = :nr_prescricao_p
									and    c.CD_MEDICO_SOLICITANTE = :cd_medico_p
									and    b.cd_motivo_baixa=0
									union all
									select substr(d.nm_exame ||''(''||e.ds_material_exame||'')'',1,40) nm_exame
									from   prescr_medica a,
										prescr_procedimento b,
										PRESCR_PROCED_PROF_ADIC c,
										exame_laboratorio d,
										material_exame_lab e
									where  a.nr_prescricao = b.nr_prescricao
									and    b.nr_prescricao = c.nr_prescricao
									and    b.nr_sequencia = c.nr_seq_procedimento
									and    b.nr_seq_exame = d.nr_seq_exame
									and    b.cd_material_exame = e.cd_material_exame
									and    a.nr_prescricao = :nr_prescricao_p
									and    c.CD_PROFISSIONAL = :cd_medico_p
									and    b.cd_motivo_baixa=0))
									where  linha >= 4 and linha <= 6','nr_prescricao_p='|| nr_prescricao_p ||';'||'cd_medico_p='|| cd_medico_p ,' ') nm_exame_2
		into STRICT	ds_retorno_w
		;

		end;
	elsif (ie_opcao_p = 3) then
		begin
		select 	obter_select_concatenado_bv('	select  ltrim(rpad(ltrim(nm_exame),33,'' '') || decode(mod(rownum,3),0,'''','''')) nm_exame
							from(	select  nm_exame,
									rownum linha
								from(	select	substr(c.nm_exame ||''(''||d.ds_material_exame||'')'',1,40) nm_exame
									from    prescr_medica a,
										prescr_procedimento b,
										exame_laboratorio c,
										material_exame_lab d
									where   a.nr_prescricao = b.nr_prescricao
									and    	b.nr_seq_exame = c.nr_seq_exame
									and    	b.cd_material_exame = d.cd_material_exame
									and    	a.nr_prescricao = :nr_prescricao_p
									and    	a.cd_medico = :cd_medico_p
									and    	((b.CD_MEDICO_SOLICITANTE is null) or (b.cd_medico_solicitante = a.cd_medico))
									and    	b.cd_motivo_baixa=0
									union all
									select  substr(c.nm_exame ||''(''||d.ds_material_exame||'')'',1,40) nm_exame
									from    prescr_medica a,
										prescr_procedimento b,
										exame_laboratorio c,
										material_exame_lab d
									where   a.nr_prescricao = b.nr_prescricao
									and    	b.nr_seq_exame = c.nr_seq_exame
									and    	b.cd_material_exame = d.cd_material_exame
									and     a.nr_prescricao = :nr_prescricao_p
									and     b.CD_MEDICO_SOLICITANTE = :cd_medico_p
									and     ((b.CD_MEDICO_SOLICITANTE is not null) or (b.cd_medico_solicitante <> a.cd_medico))
									and    b.cd_motivo_baixa=0
									union all
									select  substr(d.nm_exame ||''(''||e.ds_material_exame||'')'',1,40) nm_exame
									from    prescr_medica a,
										prescr_procedimento b,
										PRESCR_MEDICA_PROF_ADIC c,
										exame_laboratorio d,
										material_exame_lab e
									where   a.nr_prescricao = b.nr_prescricao
									and     b.nr_prescricao = c.nr_prescricao
									/*estranho não ter condicao*/

									and    b.nr_seq_exame = d.nr_seq_exame
									and    b.cd_material_exame = e.cd_material_exame
									and    a.nr_prescricao = :nr_prescricao_p
									and    c.CD_MEDICO_SOLICITANTE = :cd_medico_p
									and    b.cd_motivo_baixa=0
									union all
									select substr(d.nm_exame ||''(''||e.ds_material_exame||'')'',1,40) nm_exame
									from   prescr_medica a,
										prescr_procedimento b,
										PRESCR_PROCED_PROF_ADIC c,
										exame_laboratorio d,
										material_exame_lab e
									where  a.nr_prescricao = b.nr_prescricao
									and    b.nr_prescricao = c.nr_prescricao
									and    b.nr_sequencia = c.nr_seq_procedimento
									and    b.nr_seq_exame = d.nr_seq_exame
									and    b.cd_material_exame = e.cd_material_exame
									and    a.nr_prescricao = :nr_prescricao_p
									and    c.CD_PROFISSIONAL = :cd_medico_p
									and    b.cd_motivo_baixa=0))
									where  linha >= 7 and linha <= 9','nr_prescricao_p='|| nr_prescricao_p ||';'||'cd_medico_p='|| cd_medico_p ,' ') nm_exame_3
		into STRICT ds_retorno_w
		;
		end;
	end if;
	end;

end if;

return	substr(ds_retorno_w,1,4000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hmcg_descricao_exames ( nr_prescricao_p bigint, cd_medico_p text, ie_opcao_p bigint) FROM PUBLIC;

