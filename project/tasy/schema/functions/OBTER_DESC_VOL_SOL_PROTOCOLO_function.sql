-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_vol_sol_protocolo ( cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_solucao_p bigint) RETURNS varchar AS $body$
DECLARE



qt_solucao_total_w			double precision;
cd_unidade_medida_w		varchar(30);
qt_tempo_aplicacao_w		double precision;
ds_total_w			varchar(60);
ds_bomba_w			varchar(40);
ds_dosagem_w			varchar(60);
ds_solucao_w			varchar(100);
ds_retorno_w			varchar(255);
ie_esquema_alternado_w	varchar(1);
ie_tipo_dosagem_w         varchar(15);
ds_valor_dominio_w       varchar(255);


BEGIN
if (coalesce(cd_protocolo_p,0) <> 0) then
	begin
	select	qt_solucao_total,
		--cd_unidade_medida,
		qt_tempo_aplicacao,
		--ds_solucao,

		--decode(ie_bomba_infusao, 'S' , 'em bomba infusion','A','em bomba seringa', ''),
		CASE WHEN ie_bomba_infusao='S' THEN  OBTER_DESC_EXPRESSAO(727792) WHEN ie_bomba_infusao='A' THEN OBTER_DESC_EXPRESSAO(727796)  ELSE '' END ,
		CASE WHEN upper(ie_tipo_dosagem)='ACM' THEN  '(ACM)'  ELSE qt_dosagem  || ' ds_valor_dominio' || CASE WHEN ie_acm='S' THEN  ' ACM'  ELSE '' END  END ,
		ie_esquema_alternado,
          ie_tipo_dosagem
	into STRICT	qt_solucao_total_w,
		--cd_unidade_medida_w,
		qt_tempo_aplicacao_w,
		--ds_solucao_w,
		ds_bomba_w,
		ds_dosagem_w,
		ie_esquema_alternado_w,
          ie_tipo_dosagem_w
	from 	protocolo_medic_solucao
	where	cd_protocolo 	= cd_protocolo_p
	and	nr_seq_solucao	= nr_seq_solucao_p
	and	nr_sequencia	= nr_sequencia_p;

     select max(ds_valor_dominio)
     into STRICT   ds_valor_dominio_w
     from   valor_dominio
     where  cd_dominio = 93
     and    vl_dominio = ie_tipo_dosagem_w;
     
     ds_dosagem_w := replace(ds_dosagem_w, 'ds_valor_dominio', coalesce(ds_valor_dominio_w,ie_tipo_dosagem_w));

	if (coalesce(qt_solucao_total_w, 0) <> 0) then
		--ds_total_w	:= 'Vol. ' || qt_solucao_total_w || 'ml' || '/'|| qt_tempo_aplicacao_w || 'h';
		ds_total_w	:= WHEB_MENSAGEM_PCK.get_texto(456772,'qt_solucao_total_w='|| qt_solucao_total_w ||';qt_tempo_aplicacao_w='|| qt_tempo_aplicacao_w);
	else
		ds_total_w	:= '';
	end if;
	if (ie_esquema_alternado_w = 'N') then
		ds_retorno_w	:= ds_total_w || ' a ' || ds_dosagem_w || ' ' || ds_bomba_w;
	else
		--ds_retorno_w	:= ds_total_w || ' Dose diferenciada' || ds_bomba_w;
		ds_retorno_w	:= ds_total_w || ' ' || OBTER_DESC_EXPRESSAO(288235) || ' ' || ds_bomba_w;
	end if;
	if (ds_solucao_w IS NOT NULL AND ds_solucao_w::text <> '') then
		ds_retorno_w	:= ds_retorno_w || ' (' || ds_solucao_w || ')';
	end if;
	end;
end if;

RETURN replace(replace(ds_retorno_w,' .',' 0,'),' ,',' 0,');
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_vol_sol_protocolo ( cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_solucao_p bigint) FROM PUBLIC;

