-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_horas_validade_prescr ( dt_prim_horario_prescr_p timestamp, nr_atendimento_p atendimento_paciente.nr_atendimento%type, ie_estender_prim_prescr_p text, ie_regra_prim_prescr_p text, dt_prescricao_p timestamp, nr_prescricao_p prescr_medica.nr_prescricao%type) RETURNS bigint AS $body$
DECLARE


hr_inicio_setor_w			varchar(10);
hr_inicio_prescr_w			varchar(10);
dt_prim_horario_setor_w		timestamp;
dt_val_horario_prescr_w		timestamp;
cd_setor_paciente_w			setor_atendimento.cd_setor_atendimento%type;
nr_horas_validade_w			double precision:=24;
hr_estender_validade_w		timestamp;
ie_estender_validade_w		varchar(1);
ie_possui_w					char(1);
dt_prescricao_w				prescr_medica.dt_prescricao%type;


BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

	select	max(cd_setor_atendimento)
	into STRICT	cd_setor_paciente_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;

	if (coalesce(cd_setor_paciente_w::text, '') = '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
		cd_setor_paciente_w	:= obter_unidade_atendimento(nr_atendimento_p,'IA','CS');

		if (coalesce(cd_setor_paciente_w::text, '') = '') then
			cd_setor_paciente_w	:= obter_Setor_Atendimento(nr_atendimento_p);
		end if;
	end if;

	select 	max(hr_inicio_prescricao),
			max(hr_estender_validade)
	into STRICT	dt_prim_horario_setor_w,
			hr_estender_validade_w
	from 	setor_atendimento
	where 	cd_setor_atendimento = cd_setor_paciente_w;

	if (dt_prim_horario_setor_w IS NOT NULL AND dt_prim_horario_setor_w::text <> '') and (to_char(dt_prim_horario_setor_w, 'hh24:mi:ss') <> '00:00:00')then

		hr_inicio_prescr_w	:= coalesce(to_char(dt_prim_horario_prescr_p,'hh24:mi:ss'),'00:00:00');
		hr_inicio_setor_w	:= to_char(dt_prim_horario_setor_w,'hh24:mi:ss');

		if (hr_inicio_prescr_w > hr_inicio_setor_w) then
			nr_horas_validade_w	:= (((to_date(hr_inicio_setor_w,'hh24:mi:ss') + 1) - to_date(hr_inicio_prescr_w,'hh24:mi:ss')) * 24);

			begin

				if ((to_char(to_date(hr_inicio_prescr_w,'hh24:mi:ss'), 'mi') = '59') and (to_char(to_date(hr_inicio_prescr_w,'hh24:mi:ss'), 'ss') <> '00')) then
					nr_horas_validade_w	:= (((to_date(hr_inicio_setor_w,'hh24:mi:ss') + 1) - (to_date(hr_inicio_prescr_w,'hh24:mi:ss') + 1/1440)) * 24);
				end if;
			exception when others then
				nr_horas_validade_w	:= (((to_date(hr_inicio_setor_w,'hh24:mi:ss') + 1) - to_date(hr_inicio_prescr_w,'hh24:mi:ss')) * 24);
			end;

		elsif (hr_inicio_setor_w > hr_inicio_prescr_w) then
			nr_horas_validade_w	:= ((to_date(hr_inicio_setor_w,'hh24:mi:ss') - to_date(hr_inicio_prescr_w,'hh24:mi:ss')) * 24);

			if (ie_estender_prim_prescr_p <> 'N') and (hr_inicio_prescr_w >= coalesce(to_char(hr_estender_validade_w,'HH24:MI:SS'),hr_inicio_prescr_w)) then
				begin
				if (ie_estender_prim_prescr_p = 'S') then
					begin
					if (obter_se_primeira_prescricao(null, nr_atendimento_p, cd_setor_paciente_w, ie_regra_prim_prescr_p) = 'S') then
						nr_horas_validade_w	:= nr_horas_validade_w + 24;
					end if;
					end;
				elsif (ie_estender_prim_prescr_p = 'V') then
					begin
					select	coalesce(max('S'),'N')
					into STRICT	ie_possui_w
					from	prescr_medica
					where	nr_atendimento	= nr_atendimento_p
					and		(dt_liberacao_medico IS NOT NULL AND dt_liberacao_medico::text <> '')
					and		ie_origem_inf	= '1'
					and		dt_prescricao_p between dt_inicio_prescr and dt_validade_prescr LIMIT 1;

					if (ie_possui_w = 'N') then
						nr_horas_validade_w	:= nr_horas_validade_w + 24;
					end if;
					end;
				elsif (ie_estender_prim_prescr_p = 'VS') then
					begin

					if (dt_prescricao_p IS NOT NULL AND dt_prescricao_p::text <> '') and (pkg_date_utils.get_time(dt_prescricao_p,hr_inicio_prescr_w,0) > dt_prescricao_p) then
						dt_prescricao_w := pkg_date_utils.get_time(dt_prescricao_p,hr_inicio_prescr_w,0);
					else
						dt_prescricao_w := dt_prescricao_p;
					end if;

					select	coalesce(max('S'),'N')
					into STRICT	ie_possui_w
					from	prescr_medica
					where	nr_atendimento	= nr_atendimento_p
					and		(dt_liberacao_medico IS NOT NULL AND dt_liberacao_medico::text <> '')
					and		ie_origem_inf	= '1'
					and		cd_setor_atendimento	= cd_setor_paciente_w
					and		dt_prescricao_w between dt_inicio_prescr and dt_validade_prescr LIMIT 1;

					if (ie_possui_w = 'N') then
						nr_horas_validade_w	:= nr_horas_validade_w + 24;
					end if;
					end;
				elsif (ie_estender_prim_prescr_p = 'DS') then
					begin

					dt_val_horario_prescr_w := (dt_prim_horario_prescr_p + 24);

					select	coalesce(max(ie_estender_validade),'S')
					into STRICT	ie_estender_validade_w
					from	setor_atendimento
					where	cd_setor_atendimento = cd_setor_paciente_w;

					if (ie_estender_validade_w = 'S') then
						nr_horas_validade_w	:= nr_horas_validade_w + (dt_val_horario_prescr_w - dt_prim_horario_prescr_p);
					end if;

					end;
				elsif (ie_estender_prim_prescr_p = 'SE') then
					nr_horas_validade_w	:= nr_horas_validade_w + 24;
				elsif (ie_estender_prim_prescr_p = 'SS') then
					begin
					if (obter_se_primeira_prescricao(null, nr_atendimento_p, cd_setor_paciente_w, ie_regra_prim_prescr_p) = 'S') then
						dt_val_horario_prescr_w		:= (dt_prim_horario_prescr_p + 24);

						select	coalesce(max(ie_estender_validade),'S')
						into STRICT	ie_estender_validade_w
						from	setor_atendimento
						where	cd_setor_atendimento = cd_setor_paciente_w;

						if (ie_estender_validade_w = 'S') then
							nr_horas_validade_w	:= nr_horas_validade_w +(dt_val_horario_prescr_w - dt_prim_horario_prescr_p);
						end if;
					end if;
					end;
				elsif (ie_estender_prim_prescr_p = 'VT') then
					begin
					select	coalesce(max(ie_estender_validade),'S')
					into STRICT	ie_estender_validade_w
					from	setor_atendimento
					where	cd_setor_atendimento = cd_setor_paciente_w;

					if (ie_estender_validade_w = 'S') then
						select	coalesce(max('S'),'N')
						into STRICT	ie_possui_w
						from	prescr_medica
						where	nr_atendimento	= nr_atendimento_p
						and		(dt_liberacao_medico IS NOT NULL AND dt_liberacao_medico::text <> '')
						and		ie_origem_inf	= '1'
						and		cd_setor_atendimento	= cd_setor_paciente_w
						and		dt_prescricao_p between dt_inicio_prescr and dt_validade_prescr LIMIT 1;

						if (ie_possui_w = 'N') then
							nr_horas_validade_w	:= nr_horas_validade_w + 24;
						end if;
					end if;
					end;
				end if;
				end;
			end if;

		end if;
	end if;
end if;

return ceil(nr_horas_validade_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_horas_validade_prescr ( dt_prim_horario_prescr_p timestamp, nr_atendimento_p atendimento_paciente.nr_atendimento%type, ie_estender_prim_prescr_p text, ie_regra_prim_prescr_p text, dt_prescricao_p timestamp, nr_prescricao_p prescr_medica.nr_prescricao%type) FROM PUBLIC;

