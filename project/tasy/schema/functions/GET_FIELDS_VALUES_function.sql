-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_fields_values (nm_tabela_p text, nm_atributo_p patient_profile_log.nm_atributo%type, nr_seq_tabela_p patient_profile_log.nr_seq_origem%type, ie_componente_p tabela_visao_atributo.ie_componente%type, cd_dominio_p tabela_visao_atributo.cd_dominio%type, ds_valores_p tabela_visao_atributo.ds_valores%type, cd_exp_valores_p tabela_visao_atributo.cd_exp_valores%type, nr_seq_localizador_p tabela_visao_atributo.nr_seq_localizador%type, nr_atendimento_p nascimento.nr_atendimento%type DEFAULT NULL) RETURNS varchar AS $body$
DECLARE

    ds_comando_w            varchar(300);
    ds_condicao             varchar(100);
    field_value_w           patient_profile_value.ds_new_value%type;
    sql_ds_valores_w        varchar(600);
    sql_tipo_coluna_w       varchar(400);
    ds_condicao_lcb_w       varchar(100);
    ds_condicao_loc_w       varchar(100);
    ds_condicao_atc_w       varchar(100);
    tipo_coluna_w           all_tab_columns.data_type%type;
    sql_campo_aux_w         tipo_localizar.ds_sql%type;
    coluna_tabela           tipo_localizar.ds_sql%type;
    varSql                  tipo_localizar.ds_sql%type;
    var_hora                varchar(30);
    DS_LOCALIZADOR_W        tipo_localizar_Atributo.NM_ATRIBUTO%TYPE;
    var_minuto              varchar(30);


BEGIN 
        varSql := chr(39);
        sql_tipo_coluna_w := 'SELECT data_type FROM all_tab_columns WHERE UPPER(table_name)'|| '=' || varSql|| nm_tabela_p ||varSql ||' AND UPPER(column_name)'|| '=' || varSql|| nm_atributo_p ||varSql;
        tipo_coluna_w := Obter_Select_Concatenado(sql_tipo_coluna_w, null, null);
        IF (nm_tabela_p = 'NASCIMENTO') THEN
            ds_condicao := ' WHERE nr_sequencia = ' || nr_seq_tabela_p || ' AND nr_atendimento = ' || nr_atendimento_p;
        ELSIF (nm_tabela_p = 'CIR_MARCAPASSO') THEN
            ds_condicao := ' WHERE nr_seq_pac_acessorio = ' || nr_seq_tabela_p;
        ELSE
            ds_condicao := ' WHERE nr_sequencia = ' || nr_seq_tabela_p;
        END IF;
        IF (tipo_coluna_w = 'DATE') THEN
            var_hora := Obter_Select_Concatenado('SELECT to_char((SELECT ' || nm_atributo_p || ' FROM ' || nm_tabela_p || ds_condicao || '), ''HH24'' ) FROM DUAL', null, null);
            var_minuto := Obter_Select_Concatenado('SELECT to_char((SELECT ' || nm_atributo_p || ' FROM ' || nm_tabela_p || ds_condicao || '), ''MI'' ) FROM DUAL', null, null);

            IF (var_hora = '00' AND var_minuto = '00') THEN
                ds_comando_w := 'SELECT TO_CHAR((SELECT ' || nm_atributo_p || ' FROM ' || nm_tabela_p || ds_condicao || '), pkg_date_formaters.localize_mask(''shortDate'', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario))) FROM DUAL';
            ELSE
                ds_comando_w := 'SELECT TO_CHAR((SELECT ' || nm_atributo_p || ' FROM ' || nm_tabela_p || ds_condicao || '), pkg_date_formaters.localize_mask(''short'', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario))) FROM DUAL';
            END IF;
        ELSE
            ds_comando_w := 'SELECT ' || nm_atributo_p || ' FROM ' || nm_tabela_p || ds_condicao;
        END IF;
        field_value_w := Obter_Select_Concatenado(ds_comando_w, null, null);

        IF (ie_componente_p = 'lcb' AND (ds_valores_p IS NOT NULL AND ds_valores_p::text <> '') AND coalesce(cd_dominio_p::text, '') = '') THEN
            IF (nm_tabela_p = 'CUIDADO_LONGO_PRAZO' AND nm_atributo_p = 'CD_TIPO_CUIDADO') THEN
                ds_condicao_lcb_w := ' WHERE cd_procedencia' || '=' || varSql|| field_value_w ||varSql;
            ELSIF (nm_tabela_p = 'NASCIMENTO' AND nm_atributo_p = 'IE_TIPO_NASCIMENTO') THEN
                ds_condicao_lcb_w := ' WHERE cd_dominio = 1122  AND vl_dominio' || '=' || varSql|| field_value_w ||varSql;
            ELSE
                ds_condicao_lcb_w := ' WHERE nr_sequencia' || '=' || varSql|| field_value_w ||varSql;
            END IF;
            sql_ds_valores_w := 'SELECT DS FROM(' || REGEXP_REPLACE(REPLACE(UPPER(ds_valores_p), CHR(10), ' '), '(WHERE|ORDER BY).*', ds_condicao_lcb_w ) ||')';
            field_value_w := Obter_Select_Concatenado(sql_ds_valores_w, null, null);
        ELSIF (ie_componente_p = 'lcb' AND coalesce(ds_valores_p::text, '') = '' AND coalesce(cd_dominio_p::text, '') = '') THEN
            IF (nm_tabela_p = 'PACIENTE_ANTEC_CLINICO' AND nm_atributo_p = 'NR_SEQ_NIVEL_SEG') THEN
                sql_ds_valores_w := 'SELECT ds_nivel FROM nivel_seguranca_alerta WHERE nr_sequencia = ' || field_value_w;
                field_value_w := Obter_Select_Concatenado(sql_ds_valores_w, null, null);

            END IF;
        ELSIF (ie_componente_p = 'lcb' AND (cd_dominio_p IS NOT NULL AND cd_dominio_p::text <> '')) THEN
            sql_campo_aux_w := 'SELECT cd_exp_valor_dominio FROM VALOR_DOMINIO WHERE cd_dominio' || '=' || VarSql||cd_dominio_p ||VarSql || ' AND vl_dominio' || '=' || VarSql|| field_value_w ||VarSql;
            sql_campo_aux_w := Obter_Select_Concatenado(sql_campo_aux_w, null, null);
            sql_ds_valores_w := 'SELECT obter_desc_expressao_idioma('||sql_campo_aux_w||', null, wheb_usuario_pck.get_nr_seq_idioma) FROM DUAL';
            field_value_w := Obter_Select_Concatenado(sql_ds_valores_w, null, null);
        ELSIF (ie_componente_p = 'rg' AND coalesce(cd_dominio_p::text, '') = '') THEN
            field_value_w := obter_desc_radio_group(cd_exp_valores_p, field_value_w);
        ELSIF (ie_componente_p = 'loc' AND (nr_seq_localizador_p IS NOT NULL AND nr_seq_localizador_p::text <> '')) THEN
            /* ------------------------ Localizador ---------------------------*/

            SELECT 
                MAX(NM_ATRIBUTO)
            INTO STRICT DS_LOCALIZADOR_W
            FROM tipo_localizar_Atributo a 
            WHERE 
                a.nr_seq_tipo_localizar = nr_seq_localizador_p AND 
                a.IE_DESC_RESULT = 'S' AND
                a.NR_SEQ_APRESENT = (SELECT 
                                        MIN(b.NR_SEQ_APRESENT) 
                                     FROM  tipo_localizar_Atributo b   
                                     WHERE 
                                        a.nr_seq_tipo_localizar = b.nr_seq_tipo_localizar AND
                                        b.IE_DESC_RESULT = 'S');

            IF (nm_tabela_p IN ('PACIENTE_ALERGIA', 'HISTORICO_INFECCAO', 'PATIENT_DISEASE_NOTIF') AND nm_atributo_p IN ('CD_DOENCA', 'CD_CID_NOTIFY')) THEN
                ds_condicao_loc_w := ' WHERE cd_doenca_cid' || '=' || varSql || field_value_w || varSql;
            ELSE
                ds_condicao_loc_w := ' WHERE nr_sequencia' || '=' || varSql || field_value_w || varSql;
            END IF;
            IF (nr_seq_localizador_p = 21) THEN
                sql_ds_valores_w := 'SELECT substr(Obter_Desc_Procedimento(' ||field_value_w|| ', ''''),1,255) FROM DUAL';
                field_value_w := Obter_Select_Concatenado(sql_ds_valores_w, null, null);
            ELSE
                sql_campo_aux_w := 'SELECT ds_sql FROM  tipo_localizar WHERE nr_sequencia' || '=' || varSql || nr_seq_localizador_p || varSql;
                sql_campo_aux_w := Obter_Select_Concatenado(sql_campo_aux_w, null, null);
                sql_ds_valores_w := 'SELECT '|| coalesce(DS_LOCALIZADOR_W,'DS') || ' FROM(' || REGEXP_REPLACE(REPLACE(UPPER(sql_campo_aux_w), CHR(10), ' '), '(WHERE|ORDER BY).*', ds_condicao_loc_w ) ||')';
                field_value_w := Obter_Select_Concatenado(sql_ds_valores_w, null, null);
            END IF;
            /* ------------------------------ */

        ELSIF (ie_componente_p = 'atc' AND (nr_seq_localizador_p IS NOT NULL AND nr_seq_localizador_p::text <> '')) THEN
            IF (nm_tabela_p IN ('PACIENTE_MEDIC_USO', 'HISTORICO_INFECCAO') AND nm_atributo_p = 'CD_MATERIAL') THEN
                ds_condicao_atc_w := ' WHERE cd_material' || '=' || varSql|| field_value_w || varSql;
                coluna_tabela := 'ds_material';
            ELSE
                ds_condicao_atc_w := ' WHERE nr_sequencia' || '=' || varSql|| field_value_w || varSql;
                coluna_tabela := 'DS';
            END IF;
            SELECT ds_sql into STRICT sql_campo_aux_w FROM  tipo_localizar WHERE nr_sequencia  = varSql|| nr_seq_localizador_p ||varSql;
            sql_ds_valores_w := 'SELECT ' || coluna_tabela || ' FROM(' || REGEXP_REPLACE(REPLACE(UPPER(sql_campo_aux_w), CHR(10), ' '), '(WHERE|ORDER BY).*', ds_condicao_atc_w ) ||')';
            field_value_w := Obter_Select_Concatenado(sql_ds_valores_w, null, null);
        ELSIF (ie_componente_p = 'atc' AND coalesce(nr_seq_localizador_p::text, '') = '') THEN
            IF (nm_tabela_p = 'PACIENTE_ACESSORIO' AND nm_atributo_p = 'NR_SEQ_ACESSORIO') THEN
                sql_ds_valores_w := 'SELECT ds_acessorio FROM acessorio_paciente WHERE nr_sequencia = ' || field_value_w;
                field_value_w := Obter_Select_Concatenado(sql_ds_valores_w, null, null);
            END IF;
        ELSIF (UPPER(ie_componente_p) = 'TFL' AND coalesce(cd_dominio_p::text, '') = '') THEN
            IF (nm_tabela_p = 'PACIENTE_ANTEC_CLINICO' AND nm_atributo_p = 'NR_SEQ_DISEASE_NUMBER') THEN
                field_value_w := Obter_Select_Concatenado( 'SELECT DS_DISEASE_NAME FROM icd_codes_main_jpn WHERE NR_DISEASE_NUMBER =' || field_value_w, NULL, NULL);
            END IF;
        ELSIF (ie_componente_p = 'cb' AND coalesce(cd_dominio_p::text, '') = '') THEN
            sql_ds_valores_w := 'SELECT DECODE('''|| field_value_w ||''',' ||'''Y'''||',obter_desc_expressao_idioma(327113, null, wheb_usuario_pck.get_nr_seq_idioma),'
                                                                           ||'''S'''||',obter_desc_expressao_idioma(327113, null, wheb_usuario_pck.get_nr_seq_idioma),'
                                                                           ||'''N'''||',obter_desc_expressao_idioma(327114, null, wheb_usuario_pck.get_nr_seq_idioma),'
                                                                           ||'''A'''||',obter_desc_expressao_idioma(695840, null, wheb_usuario_pck.get_nr_seq_idioma),'
                                                                           ||'''I'''||',obter_desc_expressao_idioma(319239, null, wheb_usuario_pck.get_nr_seq_idioma)) FROM DUAL';
            field_value_w := Obter_Select_Concatenado(sql_ds_valores_w, NULL, NULL);

        END IF;
    RETURN field_value_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_fields_values (nm_tabela_p text, nm_atributo_p patient_profile_log.nm_atributo%type, nr_seq_tabela_p patient_profile_log.nr_seq_origem%type, ie_componente_p tabela_visao_atributo.ie_componente%type, cd_dominio_p tabela_visao_atributo.cd_dominio%type, ds_valores_p tabela_visao_atributo.ds_valores%type, cd_exp_valores_p tabela_visao_atributo.cd_exp_valores%type, nr_seq_localizador_p tabela_visao_atributo.nr_seq_localizador%type, nr_atendimento_p nascimento.nr_atendimento%type DEFAULT NULL) FROM PUBLIC;

