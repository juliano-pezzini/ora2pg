-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nr_internado_agenda ( cd_pessoa_p text, dt_agenda_p timestamp default null, ie_opcao_p text default 'N', ie_status_agenda_P text default '') RETURNS varchar AS $body$
DECLARE


ds_retorno_w 	varchar(10) := '0';
ie_param_15_w	varchar(1);	
dt_agenda_w 	timestamp;
				

BEGIN

if (coalesce(dt_agenda_p::text, '') = '') then

	
	SELECT MAX(dt_agenda)
	into STRICT dt_agenda_w
	from agenda_hc_paciente
	where cd_pessoa_fisica = cd_pessoa_p
	and trunc(dt_agenda) = trunc(clock_timestamp());
	
else

	dt_agenda_w:= dt_agenda_p;
	
end if;

if (coalesce(ie_opcao_p,'N') = 'PI') then

	ie_param_15_w := obter_param_usuario(867, 15, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_param_15_w);

	if ( ie_param_15_w = 'S') then
	
		select	count(*)
		into STRICT 	ds_retorno_w
		from    setor_atendimento c,
				atendimento_paciente b,
				atend_paciente_unidade  a
		where   a.nr_atendimento        = b.nr_atendimento
		and     a.cd_setor_atendimento  = c.cd_setor_atendimento
		and     c.cd_classif_setor      in (3,4,8)
		and     b.cd_pessoa_fisica      = cd_pessoa_p
		and		trunc(coalesce(dt_agenda_w,a.dt_entrada_unidade)) between trunc(a.dt_entrada_unidade) and trunc(coalesce(a.dt_saida_unidade,dt_agenda_w));
		
	end if;



else

	select	count(*)
	into STRICT 	ds_retorno_w
	from    setor_atendimento c,
			atendimento_paciente b,
			unidade_atendimento a
	where   a.nr_atendimento        = b.nr_atendimento
	and     a.cd_setor_atendimento  = c.cd_setor_atendimento
	and     c.cd_classif_setor      in (3,4,8)
	and     b.cd_pessoa_fisica      = cd_pessoa_p;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nr_internado_agenda ( cd_pessoa_p text, dt_agenda_p timestamp default null, ie_opcao_p text default 'N', ie_status_agenda_P text default '') FROM PUBLIC;

