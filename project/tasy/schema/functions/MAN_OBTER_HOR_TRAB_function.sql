-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_hor_trab ( ie_opcao_p text, dt_referencia_p timestamp default clock_timestamp(), nm_usuario_p text default null, nr_grupo_planej_p bigint default null, nr_grupo_trabalho_p bigint default null) RETURNS varchar AS $body$
DECLARE


hr_inicial_w 		man_horario_trabalho.hr_inicial%type;
hr_final_w		man_horario_trabalho.hr_final%type;
qt_min_intervalo_w 	man_horario_trabalho.qt_min_intervalo%type;
qt_min_lanche_w 	man_horario_trabalho.qt_min_lanche%type;

/*	ie_opcao_p
	DI - Data Inicial
	DF - Data Final
	MI - Minutos Intervalo
	ML - Minutos Lanche	*/
BEGIN

select	pkg_date_utils.get_Time(dt_referencia_p,a.hr_inicio),
	pkg_date_utils.get_Time(dt_referencia_p,a.hr_fim),
	a.qt_min_intervalo,
	a.qt_min_lanche
into STRICT	hr_inicial_w,
	hr_final_w,
	qt_min_intervalo_w,
	qt_min_lanche_w
from	man_horario_trabalho a
where	a.nr_sequencia = (SELECT max(x.nr_sequencia)
			from	man_horario_trabalho x
			where	x.ie_dia_semana = pkg_date_utils.get_WeekDay(dt_referencia_p)
			and	substr(man_obter_se_hor_trab_lib(x.nr_sequencia,nr_grupo_planej_p,nr_grupo_trabalho_p,coalesce(nm_usuario_p,wheb_usuario_pck.get_nm_usuario)),1,1) = 'S');

if (ie_opcao_p = 'DI') then
	return to_char(hr_inicial_w,'dd/mm/yyyy hh24:mi:ss');
elsif (ie_opcao_p = 'DF') then
	begin
	if (hr_inicial_w > hr_final_w) then
		hr_final_w := hr_final_w + 1;
	end if;

	return to_char(hr_final_w,'dd/mm/yyyy hh24:mi:ss');
	end;
elsif (ie_opcao_p = 'MI') then
	return qt_min_intervalo_w;
elsif (ie_opcao_p = 'ML') then
	return qt_min_lanche_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_hor_trab ( ie_opcao_p text, dt_referencia_p timestamp default clock_timestamp(), nm_usuario_p text default null, nr_grupo_planej_p bigint default null, nr_grupo_trabalho_p bigint default null) FROM PUBLIC;

