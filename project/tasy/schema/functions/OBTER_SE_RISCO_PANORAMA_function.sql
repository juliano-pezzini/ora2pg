-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_risco_panorama ( nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w			varchar(4000) := null;
cd_classif_setor_w		varchar(2);
qt_registros_w			bigint;
ie_profilaxia_tev_w		varchar(1);
ie_profilaxia_lamg_w	varchar(1);
ie_decubito_elev_w		varchar(1);
ie_mudanca_decubito_w	varchar(1);
ie_sedacao_w			varchar(1);
ie_desmame_vini_w		varchar(1);


BEGIN 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_atendimento_p > 0) then 
	begin 
	select obter_classif_setor_atend(nr_atendimento_p) 
	into STRICT	cd_classif_setor_w 
	;
 
	if (cd_classif_setor_w = '4') then 
		begin 
		 
		select	count(*) 
		into STRICT	qt_registros_w			 
		from	w_gerenciamento_risco 
		where	nr_atendimento = nr_atendimento_p 
		and		trunc(dt_atualizacao) = trunc(clock_timestamp());
		 
		if (qt_registros_w > 0) then 
			begin 
			select coalesce(max(ie_profilaxia_tev),'N'), 
					coalesce(max(ie_profilaxia_lamg),'N'), 
					coalesce(max(ie_decubito_elev),'N'), 
					coalesce(max(ie_mudanca_decubito),'N'), 
					coalesce(max(ie_sedacao),'N'), 
					coalesce(max(ie_desmame_vini),'N') 
			into STRICT	ie_profilaxia_tev_w, 
					ie_profilaxia_lamg_w, 
					ie_decubito_elev_w, 
					ie_mudanca_decubito_w, 
					ie_sedacao_w, 
					ie_desmame_vini_w 
			from	w_gerenciamento_risco 
			where	nr_atendimento = nr_atendimento_p 
			and		trunc(dt_atualizacao) = trunc(clock_timestamp());
			 
			if (ie_profilaxia_tev_w <> 'S') then 
				begin 
				ds_retorno_w := substr(ds_retorno_w||'Prescrever profilaxia para TEV'|| '<br>',1,4000);
				end;
			end if;
			 
			if (ie_profilaxia_lamg_w <> 'S') then 
				begin 
				ds_retorno_w := substr(ds_retorno_w||'Prescrever profilaxia para LAMG'|| '<br>',1,4000);
				end;
			end if;
			 
			if (ie_decubito_elev_w <> 'S') then 
				begin 
				ds_retorno_w := substr(ds_retorno_w||'Prescrever decúbito com cabeceira elevada'|| '<br>',1,4000);
				end;
			end if;
			 
			if (ie_mudanca_decubito_w <> 'S') then 
				begin 
				ds_retorno_w := substr(ds_retorno_w||'Prescrever mudança de decúbito conforme protocolo'|| '<br>',1,4000);
				end;
			end if;
			 
			if (ie_sedacao_w <> 'S') then 
				begin 
				ds_retorno_w := substr(ds_retorno_w||'Prescrever Interrupção de Sedação Diária'|| '<br>',1,4000);
				end;
			end if;
			 
			if (ie_desmame_vini_w <> 'S') then 
				begin 
				ds_retorno_w  := substr(ds_retorno_w||'Prescrever Avaliação para Desmame da VMI'|| '<br>',1,4000);
				end;
			end if;
			 
			if (ds_retorno_w = '') then 
				begin 
				ds_retorno_w := null;
				end;
			end if;
			end;
		else 
			begin 
			ds_retorno_w := substr(ds_retorno_w||'Prescrever profilaxia para TEV'|| '<br>',1,4000);
			ds_retorno_w := substr(ds_retorno_w||'Prescrever profilaxia para LAMG'|| '<br>',1,4000);
			ds_retorno_w := substr(ds_retorno_w||'Prescrever decúbito com cabeceira elevada'|| '<br>',1,4000);
			ds_retorno_w := substr(ds_retorno_w||'Prescrever mudança de decúbito conforme protocolo'|| '<br>',1,4000);
			end;
		end if;
		end;
	end if;
	end;
end if;
return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_risco_panorama ( nr_atendimento_p bigint) FROM PUBLIC;

