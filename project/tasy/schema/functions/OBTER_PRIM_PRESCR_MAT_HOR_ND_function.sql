-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prim_prescr_mat_hor_nd ( nr_prescricao_p bigint, ie_consid_medic_nao_nec_disp_p text, ie_agrupador_p text) RETURNS timestamp AS $body$
DECLARE


dt_primeiro_horario_w	    timestamp	:= clock_timestamp();
cd_perfil_w                 integer;
cd_estabelecimento_w        integer;
nm_usuario_w                varchar(255);
ie_prioriza_apenas_apraz_w  varchar(1);


BEGIN

cd_perfil_w             :=  obter_perfil_ativo;
cd_estabelecimento_w    :=  wheb_usuario_pck.get_cd_estabelecimento;
nm_usuario_w            :=  wheb_usuario_pck.get_nm_usuario;

ie_prioriza_apenas_apraz_w := Obter_Param_Usuario(7010, 154, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_prioriza_apenas_apraz_w);


select	coalesce(min(dt_horario),clock_timestamp() + interval '60 days')
into STRICT	dt_primeiro_horario_w
FROM	prescr_mat_hor a, prescr_material b
WHERE	a.nr_prescricao = nr_prescricao_p
AND 	a.nr_prescricao = b.nr_prescricao
AND 	a.nr_seq_material = b.nr_sequencia
and    ((ie_prioriza_apenas_apraz_w = 'N') or ((ie_prioriza_apenas_apraz_w = 'S')  and ((HR_PRIM_HORARIO IS NOT NULL AND HR_PRIM_HORARIO::text <> '') and (DS_HORARIOS IS NOT NULL AND DS_HORARIOS::text <> '') or (trim(both DS_HORARIOS) = ':'))))
AND 	((ie_consid_medic_nao_nec_disp_p = 'S') OR ((ie_consid_medic_nao_nec_disp_p = 'N') and (coalesce(b.ie_regra_disp,'S') <> 'N')))
and	((substr(obter_se_contido(b.ie_agrupador,ie_agrupador_p),1,1) = 'S') or (coalesce(ie_agrupador_p,'0') = '0'))
AND	coalesce(a.dt_suspensao::text, '') = '';

return	dt_primeiro_horario_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prim_prescr_mat_hor_nd ( nr_prescricao_p bigint, ie_consid_medic_nao_nec_disp_p text, ie_agrupador_p text) FROM PUBLIC;

