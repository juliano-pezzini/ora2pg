-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_list_api_available ( nr_atendimento_p atendimento_paciente.nr_atendimento%type default null, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type default null, ie_load_cache_p text default null) RETURNS varchar AS $body$
DECLARE

													
	ds_result_w			varchar(255);
	ie_pregnant_w		varchar(1);
	ie_lactating_w		varchar(1);
	cd_funcao_ativa_w	bigint;
	
	cListAPI CURSOR FOR
		SELECT	coalesce(ie_drug_interaction_ativo,'N') DRUG_INTERACTIONS,
				coalesce(ie_duplicidade_ativo,'N') DUPLICATE_THERAPY,
				coalesce(ie_dose_ativo,'N') DRUG_DOSE_INTERACTIONS,
				coalesce(ie_via_ativo,'N') ROUTE_CONTRAINDICATIONS,
				coalesce(ie_idade_ativo,'N') AGE_CONTRAINDICATION,
				coalesce(ie_genero_ativo,'N') GENDER_CONTRAINDICATIONS,
				coalesce(ie_gravidez_ativo,'N') PREGNANT_CONTRAINDICATION,
				coalesce(ie_lactacao_ativo,'N') LACTATION_CONTRAINDICATIONS,
				coalesce(ie_doenca_ativo,'N') DRUG_DISEASE_CONTRAINDICATIONS
		  from	status_integration_lexcomp;

BEGIN
	ie_pregnant_w := obter_inf_saude_mulher(nr_atendimento_p, 'G');
	ie_lactating_w := obter_inf_saude_mulher(nr_atendimento_p, 'A');
	cd_funcao_ativa_w := obter_funcao_ativa;
	
	for cListAPI_w in cListAPI
	loop
		ds_result_w := '';

		if (cListAPI_w.DRUG_INTERACTIONS = 'S') then
			ds_result_w := ds_result_w || 'A,';
		end if;

		if (cListAPI_w.DUPLICATE_THERAPY = 'S') then
			ds_result_w := ds_result_w || 'C,';
		end if;

		if (cListAPI_w.DRUG_DOSE_INTERACTIONS = 'S') then
			ds_result_w := ds_result_w || 'D,';
		end if;

		if (cListAPI_w.ROUTE_CONTRAINDICATIONS = 'S') then
			ds_result_w := ds_result_w || 'E,';
		end if;

		if (cListAPI_w.AGE_CONTRAINDICATION = 'S') then
			ds_result_w := ds_result_w || 'F,';
		end if;

		if (cListAPI_w.GENDER_CONTRAINDICATIONS = 'S') then
			ds_result_w := ds_result_w || 'G,';
		end if;

		if ((cListAPI_w.PREGNANT_CONTRAINDICATION = 'S') and ((ie_pregnant_w = 'S') or (ie_load_cache_p = 'S'))) then
			ds_result_w := ds_result_w || 'H,';
		end if;

		if ((cListAPI_w.LACTATION_CONTRAINDICATIONS = 'S') and ((ie_lactating_w = 'S') or (ie_load_cache_p = 'S'))) then
			ds_result_w := ds_result_w || 'I,';
		end if;

		if (cListAPI_w.DRUG_DISEASE_CONTRAINDICATIONS = 'S') then
			if (cd_funcao_ativa_w = 924) then
				ds_result_w := ds_result_w || 'B,';
			else
				ds_result_w := ds_result_w || 'DDC,';
			end if;
		end if;
	end loop;
	
	return ds_result_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_list_api_available ( nr_atendimento_p atendimento_paciente.nr_atendimento%type default null, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type default null, ie_load_cache_p text default null) FROM PUBLIC;

