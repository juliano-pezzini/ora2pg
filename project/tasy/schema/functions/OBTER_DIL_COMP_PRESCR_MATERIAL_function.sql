-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dil_comp_prescr_material ( nr_prescricao_p prescr_material.nr_prescricao%type, nr_seq_item_p prescr_material.nr_sequencia%type, nr_agrupamento_p prescr_material.nr_agrupamento%type, ie_via_aplicacao_p prescr_material.ie_via_aplicacao%type, cd_intervalo_p prescr_material.cd_intervalo%type, ie_agrupador_p prescr_material.ie_agrupador%type ) RETURNS varchar AS $body$
DECLARE


ds_justificativa_w 	cpoe_material.ds_justificativa%type;
ds_observacao_w		cpoe_material.ds_observacao%type;
ds_intervalo_w		varchar(50);
ds_retorno_w		varchar(4000);

c01 CURSOR FOR
SELECT	y.ds_material ds_material,
		substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,x.nr_sequencia,x.ie_acm,x.ie_se_necessario),1,100) ds_um_dosagem,
		x.ie_agrupador ie_agrupador
from	material y,
		prescr_material x,
		prescr_medica a
where	y.cd_material = x.cd_material
and		x.nr_prescricao = a.nr_prescricao
and		x.nr_agrupamento = nr_agrupamento_p
and		x.nr_prescricao = nr_prescricao_p
and		ie_agrupador = ie_agrupador_p;

c02 CURSOR FOR
SELECT	y.ds_material ds_material,
		substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,x.nr_sequencia,x.ie_acm,x.ie_se_necessario),1,100) ds_um_dosagem,
		x.ie_agrupador ie_agrupador
from	material y,
		prescr_material x,
		prescr_medica a
where	y.cd_material = x.cd_material
and		x.nr_prescricao = a.nr_prescricao
and		x.nr_agrupamento = nr_agrupamento_p
and		x.nr_prescricao = nr_prescricao_p
and		ie_agrupador in (3,7,10)
order by ie_agrupador asc;
BEGIN

	ds_justificativa_w := obter_justificativa_item(nr_prescricao_p, nr_seq_item_p, 'S');
	ds_observacao_w := obter_observacao_item_prescr('S', nr_prescricao_p, nr_seq_item_p);

	for c01_r in c01
	loop
	begin
		ds_retorno_w := substr(ds_retorno_w || c01_r.ds_material || ' ' ,1,1900);
		if (c01_r.ds_um_dosagem IS NOT NULL AND c01_r.ds_um_dosagem::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || chr(10) || /* Administrar */
 wheb_mensagem_pck.get_texto(306859) || ' ' || c01_r.ds_um_dosagem ,1,1900)|| chr(10);
		end if;
	end;
	end loop;

	for c02_r in c02 loop
	begin
		ds_retorno_w := substr(ds_retorno_w || c02_r.ds_material || ' ' ,1,1900);
		if (c02_r.ds_um_dosagem IS NOT NULL AND c02_r.ds_um_dosagem::text <> '') then
			if (c02_r.ie_agrupador = 3) then
				ds_retorno_w := substr(ds_retorno_w || chr(10) || /* Diluir */
 wheb_mensagem_pck.get_texto(306860) || ' ' || c02_r.ds_um_dosagem ,1,1900)|| chr(10);
			elsif (c02_r.ie_agrupador = 7) then
				ds_retorno_w := substr(ds_retorno_w || chr(10) || /* Rediluir */
 wheb_mensagem_pck.get_texto(306848) || ' ' || c02_r.ds_um_dosagem ,1,1900)|| chr(10);
			elsif (c02_r.ie_agrupador = 10) then
				ds_retorno_w := substr(ds_retorno_w || chr(10) || /* Reconstituir cada  */
 wheb_mensagem_pck.get_texto(306838) || ' ' || c02_r.ds_um_dosagem ,1,1900)|| chr(10);
			end if;
		end if;
	end;
	end loop;

	if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
		select	substr(max(ds_prescricao),1,1900)
		into STRICT	ds_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo	= cd_intervalo_p;
	end if;

	if (ds_intervalo_w IS NOT NULL AND ds_intervalo_w::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || chr(10) || ' (' || ds_intervalo_w || ') ',1,1900);
	end if;

	if (ie_via_aplicacao_p = 'O') then
		ds_retorno_w := substr(ds_retorno_w || chr(10) || ' ' || /* Via oral */
 wheb_mensagem_pck.get_texto(1091743),1,1900);
	elsif (ie_via_aplicacao_p = 'S') then
		ds_retorno_w := substr(ds_retorno_w || ' ' || /* Via sonda */
 wheb_mensagem_pck.get_texto(1091744),1,1900);
	end if;

	if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || chr(10) || ds_observacao_w,1,1900);
			else
			ds_retorno_w := substr(ds_observacao_w,1,1900);
		end if;
	end if;

	if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || chr(10) || /* Justificativa: #@DS_JUSTIFICATIVA#@ */
 wheb_mensagem_pck.get_texto(1091527,'DS_JUSTIFICATIVA=' || ds_justificativa_w),1,1900);
			else
			ds_retorno_w := substr(/* Justificativa: #@DS_JUSTIFICATIVA#@ */
 wheb_mensagem_pck.get_texto(1091527,'DS_JUSTIFICATIVA=' || ds_justificativa_w),1,1900);
		end if;
	end if;

	return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dil_comp_prescr_material ( nr_prescricao_p prescr_material.nr_prescricao%type, nr_seq_item_p prescr_material.nr_sequencia%type, nr_agrupamento_p prescr_material.nr_agrupamento%type, ie_via_aplicacao_p prescr_material.ie_via_aplicacao%type, cd_intervalo_p prescr_material.cd_intervalo%type, ie_agrupador_p prescr_material.ie_agrupador%type ) FROM PUBLIC;

