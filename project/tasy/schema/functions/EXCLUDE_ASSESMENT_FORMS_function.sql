-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION exclude_assesment_forms ( nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, cd_evaluation_p nursing_care_exclusion.nr_seq_nursing_care%TYPE ) RETURNS varchar AS $body$
DECLARE


    ds_return_w                 varchar(1);
    end_date_w                  wocupacao_saida_temporaria.dt_end_date%TYPE;
    cd_pessoa_fisica_w          pessoa_fisica.cd_pessoa_fisica%TYPE;
    dt_discharge_w              atendimento_paciente.dt_alta%TYPE;
    dt_temporary_leave_w        wocupacao_saida_temporaria.dt_start_date%TYPE;
    cd_departamento_w           departamento_medico.cd_departamento%TYPE;
    si_obstetric_department_w   departamento_medico.si_obstetric_department%TYPE;
	si_odonto_department_w      departamento_medico.si_odonto_department%TYPE;
    cur_seq_justificativa CURSOR FOR
    SELECT
        nr_seq_justificativa
    FROM
        nursing_care_exclusion
    WHERE
        nr_seq_nursing_care = cd_evaluation_p;

BEGIN
    ds_return_w := 'S';
	
	SELECT MAX(OBTER_DEPARTAMENTO_SETOR(cd_setor_atendimento))
    INTO STRICT cd_departamento_w
    FROM unidade_atendimento
    WHERE nr_atendimento = nr_atendimento_p;
	
   FOR recur_seq_justificativa IN cur_seq_justificativa LOOP
    IF ( recur_seq_justificativa.nr_seq_justificativa = '2' ) THEN
        SELECT
            cd_pessoa_fisica
        INTO STRICT cd_pessoa_fisica_w
        FROM
            atendimento_paciente
        WHERE
            nr_atendimento = nr_atendimento_p;

        IF ( obter_dados_pf(cd_pessoa_fisica_w, 'I') < 15 ) THEN
            ds_return_w := 'N';
        END IF;

    ELSIF ( recur_seq_justificativa.nr_seq_justificativa = '7' ) THEN
        SELECT
            MAX(dt_alta)
        INTO STRICT dt_discharge_w
        FROM
            atendimento_paciente
        WHERE
            nr_atendimento = nr_atendimento_p;

        IF (dt_discharge_w IS NOT NULL AND dt_discharge_w::text <> '') THEN
            ds_return_w := 'N';
        END IF;
    ELSIF ( recur_seq_justificativa.nr_seq_justificativa = '5' ) THEN
        IF ( coalesce(obter_convenio_atendimento(nr_atendimento_p)::text, '') = '' ) THEN
            ds_return_w := 'N';
        END IF;
    ELSIF ( recur_seq_justificativa.nr_seq_justificativa = '4') THEN
        SELECT
            MAX(dt_start_date),
            MAX(dt_end_date)
        INTO STRICT
            dt_temporary_leave_w,
            end_date_w
        FROM
            wocupacao_saida_temporaria
        WHERE
            nr_atendimento = nr_atendimento_p;

        IF ( (dt_temporary_leave_w IS NOT NULL AND dt_temporary_leave_w::text <> '') AND clock_timestamp() < end_date_w ) THEN
            ds_return_w := 'N';
        END IF;

    ELSIF ( recur_seq_justificativa.nr_seq_justificativa = '3' ) THEN
        SELECT
            MAX(si_obstetric_department)
        INTO STRICT si_obstetric_department_w
        FROM
            departamento_medico
        WHERE
            cd_departamento = cd_departamento_w;

        IF ( si_obstetric_department_w = 'S' ) THEN
            ds_return_w := 'N';
        END IF;
		
	ELSIF ( recur_seq_justificativa.nr_seq_justificativa = '6' ) THEN
        SELECT
            MAX(si_odonto_department)
        INTO STRICT si_odonto_department_w
        FROM
            departamento_medico
        WHERE
            cd_departamento = cd_departamento_w;

        IF ( si_odonto_department_w = 'S' ) THEN
            ds_return_w := 'N';
        END IF;
    END IF;
    END LOOP;

    RETURN ds_return_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION exclude_assesment_forms ( nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, cd_evaluation_p nursing_care_exclusion.nr_seq_nursing_care%TYPE ) FROM PUBLIC;

