-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tempos_higienizacao ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text) RETURNS varchar AS $body$
DECLARE

dt_historico_alta_w	varchar(19);
dt_historico_higi_w	varchar(19);
dt_historico_livre_w	varchar(19);
qt_min_ah_w		varchar(40);
qt_min_hl_w		varchar(40);
qt_min_al_w		varchar(40);
ds_retorno_w		varchar(255);


BEGIN

select	to_char(max(a.dt_historico),'dd/mm/yyyy hh24:mi:ss')
into STRICT	dt_historico_alta_w
from	unidade_atendimento u,
	unidade_atend_hist a
where	u.nr_seq_interno	= a.nr_seq_unidade
and	u.cd_setor_atendimento	= cd_setor_atendimento_p
and	u.cd_unidade_basica	= cd_unidade_basica_p
and	u.cd_unidade_compl	= cd_unidade_compl_p
and	a.ie_status_unidade	= 'A';

select	to_char(max(a.dt_historico),'dd/mm/yyyy hh24:mi:ss')
into STRICT	dt_historico_higi_w
from	unidade_atendimento u,
	unidade_atend_hist a
where	u.nr_seq_interno	= a.nr_seq_unidade
and	u.cd_setor_atendimento	= cd_setor_atendimento_p
and	u.cd_unidade_basica	= cd_unidade_basica_p
and	u.cd_unidade_compl	= cd_unidade_compl_p
and	a.ie_status_unidade	= 'H'
and	a.dt_historico		> to_date(dt_historico_alta_w,'dd/mm/yyyy hh24:mi:ss');

select	to_char(max(a.dt_historico),'dd/mm/yyyy hh24:mi:ss')
into STRICT	dt_historico_livre_w
from	unidade_atendimento u,
	unidade_atend_hist a
where	u.nr_seq_interno	= a.nr_seq_unidade
and	u.cd_setor_atendimento	= cd_setor_atendimento_p
and	u.cd_unidade_basica	= cd_unidade_basica_p
and	u.cd_unidade_compl	= cd_unidade_compl_p
and	a.ie_status_unidade	= 'L'
and	a.dt_historico		> coalesce(to_date(dt_historico_higi_w,'dd/mm/yyyy hh24:mi:ss'),to_date(dt_historico_alta_w,'dd/mm/yyyy hh24:mi:ss'));

if (dt_historico_alta_w IS NOT NULL AND dt_historico_alta_w::text <> '') and (dt_historico_higi_w IS NOT NULL AND dt_historico_higi_w::text <> '') then

	select	obter_hora_duracao(abs(to_date(dt_historico_alta_w,'dd/mm/yyyy hh24:mi:ss') - to_date(dt_historico_higi_w,'dd/mm/yyyy hh24:mi:ss')) * 86400)
	into STRICT	qt_min_ah_w
	;
end if;

if (dt_historico_higi_w IS NOT NULL AND dt_historico_higi_w::text <> '') and (dt_historico_livre_w IS NOT NULL AND dt_historico_livre_w::text <> '') then

	select	obter_hora_duracao(abs(to_date(dt_historico_higi_w,'dd/mm/yyyy hh24:mi:ss') - to_date(dt_historico_livre_w,'dd/mm/yyyy hh24:mi:ss')) * 86400)
	into STRICT	qt_min_hl_w
	;
end if;

if (dt_historico_alta_w IS NOT NULL AND dt_historico_alta_w::text <> '') and (dt_historico_livre_w IS NOT NULL AND dt_historico_livre_w::text <> '') then

	select	obter_hora_duracao(abs(to_date(dt_historico_alta_w,'dd/mm/yyyy hh24:mi:ss') - to_date(dt_historico_livre_w,'dd/mm/yyyy hh24:mi:ss')) * 86400)
	into STRICT	qt_min_al_w
	;
end if;

ds_retorno_w := coalesce(dt_historico_alta_w,'                                 ')	|| '       ' ||
		coalesce(dt_historico_higi_w,'                                 ')	|| '       ' ||
		coalesce(dt_historico_livre_w,'                                 ')	|| '                        ' ||
		coalesce(lpad(qt_min_ah_w, 8,' '),'            0') 		|| '                                     ' ||
		coalesce(lpad(qt_min_hl_w, 8,' '),'            0') 		|| '                                       ' ||
		coalesce(lpad(qt_min_al_w, 8,' '),'            0');

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tempos_higienizacao ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text) FROM PUBLIC;

