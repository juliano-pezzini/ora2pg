-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_doc_pf ( cd_pessoa_fisica_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


nr_documento_w		bigint;
nr_doc_paciente_w	varchar(32);
ds_retorno_w		varchar(32);
nr_matricula_nasc_w     varchar(32);
nr_pis_pasep_w		varchar(11);
nr_identidade_w		varchar(11);
nr_cert_nasc_w		varchar(11);
nr_cpf_w		varchar(11);

/*
Opções:
D - Documento
I - Identificador do documento
 */
BEGIN

select	nr_pis_pasep,
	substr(somente_numero(nr_identidade),1,11),
	substr(nr_cert_nasc,1,11) nr_cert_nasc,
	substr(nr_matricula_nasc,1,32) nr_matricula_nasc,
	nr_cpf
into STRICT	nr_pis_pasep_w,
	nr_identidade_w,
	nr_cert_nasc_w,
	nr_matricula_nasc_w,
	nr_cpf_w
from	pessoa_fisica
where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

if (nr_pis_pasep_w IS NOT NULL AND nr_pis_pasep_w::text <> '') then
	nr_doc_paciente_w  	:= nr_pis_pasep_w;
        nr_documento_w   	:= 1;
elsif (coalesce(nr_doc_paciente_w::text, '') = '') and (nr_identidade_w IS NOT NULL AND nr_identidade_w::text <> '') and (nr_identidade_w <> 0) then
        nr_doc_paciente_w  	:= nr_identidade_w;
        nr_documento_w   	:= 2;
elsif (coalesce(nr_doc_paciente_w::text, '') = '') and (nr_cert_nasc_w IS NOT NULL AND nr_cert_nasc_w::text <> '') then
        nr_doc_paciente_w  	:= nr_cert_nasc_w;
        nr_documento_w   	:= 3;
elsif (coalesce(nr_doc_paciente_w::text, '') = '') and (nr_cpf_w IS NOT NULL AND nr_cpf_w::text <> '') then
        nr_doc_paciente_w  	:= nr_cpf_w;
        nr_documento_w   	:= 4;
elsif (coalesce(nr_doc_paciente_w::text, '') = '') and (nr_matricula_nasc_w IS NOT NULL AND nr_matricula_nasc_w::text <> '') then
	nr_doc_paciente_w  	:= nr_matricula_nasc_w;
        nr_documento_w   	:= 6;
else
        nr_doc_paciente_w  	:= ' ';
        nr_documento_w   	:= 5;
end if;

if (ie_opcao_p = 'D') then
	ds_retorno_w := nr_doc_paciente_w;
else
	ds_retorno_w := nr_documento_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_doc_pf ( cd_pessoa_fisica_p text, ie_opcao_p text) FROM PUBLIC;

