-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hem_obter_global_score (cd_syntax_score_p bigint, qt_score_euro_p bigint, nr_atendimento_p bigint default 0) RETURNS bigint AS $body$
DECLARE

			 
cd_return_w		smallint;
cd_pessoa_fisica_w	varchar(15);
nr_seq_syntax_w		bigint;
cd_syntax_score_w	double precision;
qt_score_euro_w		double precision;


BEGIN 
if ((cd_syntax_score_p IS NOT NULL AND cd_syntax_score_p::text <> '' AND qt_score_euro_p IS NOT NULL AND qt_score_euro_p::text <> '') or (coalesce(nr_atendimento_p,0) > 0)) then 
	begin 
	cd_syntax_score_w	:= coalesce(cd_syntax_score_p,0);
	qt_score_euro_w		:= coalesce(qt_score_euro_p,0);
	 
	if (coalesce(nr_atendimento_p,0) > 0) then 
	 
		select	max(cd_pessoa_fisica) 
		into STRICT	cd_pessoa_fisica_w 
		from	atendimento_paciente 
		where	nr_atendimento = nr_atendimento_p;
		 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_syntax_w 
		from	hem_syntax 
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;
		 
		select	max(cd_syntax_score) 
		into STRICT	cd_syntax_score_w 
		from	hem_syntax 
		where	nr_sequencia = nr_seq_syntax_w;
		 
		select	max(qt_score) 
		into STRICT	qt_score_euro_w 
		from	euroscore 
		where	nr_atendimento = nr_atendimento_p;
		 
	end if;
	 
	 
	if (cd_syntax_score_w < 19) then 
		begin 
		 
		if (qt_score_euro_w < 3) then 
			cd_return_w := 1;
			 
		else	if (qt_score_euro_w <= 6) then 
				cd_return_w := 4;
			 
			else 
				cd_return_w := 7;
				 
			end if;
		end if;
		end;
	else	if (cd_syntax_score_w <= 27) then 
			begin 
			if (qt_score_euro_w < 3) then 
				cd_return_w := 2;
				 
			else	if (qt_score_euro_w <= 6) then 
					cd_return_w := 5;
				 
				else 
					cd_return_w := 8;
				 
				end if;
			end if;
			end;
		else 
			begin 
			if (qt_score_euro_w < 3) then 
				cd_return_w := 3;
				 
			else	if (qt_score_euro_w <= 6) then 
					cd_return_w := 6;
					 
				else 
					cd_return_w := 9;
				 
				end if;
			end if;
			end;
		end if;
	end if;
	end;
end if;
 
 
return	cd_return_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hem_obter_global_score (cd_syntax_score_p bigint, qt_score_euro_p bigint, nr_atendimento_p bigint default 0) FROM PUBLIC;

