-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_utilizacao_dt_reg_benef ( dt_inicio_p text, dt_fim_p text) RETURNS varchar AS $body$
DECLARE


-- Verifica se a data de inicio e a data fim da consulta se encaixa nas regras de consulta e de vigência
dt_inicio_w		timestamp := to_date(dt_inicio_p);
dt_fim_w		timestamp := to_date(dt_fim_p);
dt_vigencia_inicio_w	timestamp;
dt_vigencia_fim_w	timestamp;
dt_consulta_inicio_w	timestamp;
dt_consulta_fim_w	timestamp;
ie_dia_vig_ini_w	pls_regra_utili_benef_web.ie_dia_vig_ini%type;
ie_dia_vig_fin_w	pls_regra_utili_benef_web.ie_dia_vig_fin%type;
nr_mes_inicio_w		pls_regra_utili_benef_web.nr_mes_inicio%type;
nr_mes_final_w		pls_regra_utili_benef_web.nr_mes_final%type;
ie_dia_utilizado_ini_w	pls_regra_utili_benef_web.ie_dia_utilizado_ini%type;
ie_dia_utilizado_fin_w	pls_regra_utili_benef_web.ie_dia_utilizado_fin%type;
nr_mes_util_ini_w	pls_regra_utili_benef_web.nr_mes_util_ini%type;
nr_mes_util_fin_w	pls_regra_utili_benef_web.nr_mes_util_fin%type;
ds_mensagem_w		pls_regra_utili_benef_web.ds_mensagem%type;

C01 CURSOR FOR
	SELECT	ie_dia_vig_ini,
		nr_mes_inicio,
		ie_dia_vig_fin,
		nr_mes_final,
		ie_dia_utilizado_ini,
		nr_mes_util_ini,
		ie_dia_utilizado_fin,
		nr_mes_util_fin,
		ds_mensagem
	from	pls_regra_utili_benef_web
	where	ie_situacao = 'A';


BEGIN

open C01;
loop
fetch C01 into
	ie_dia_vig_ini_w,
	nr_mes_inicio_w,
	ie_dia_vig_fin_w,
	nr_mes_final_w,
	ie_dia_utilizado_ini_w,
	nr_mes_util_ini_w,
	ie_dia_utilizado_fin_w,
	nr_mes_util_fin_w,
	ds_mensagem_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	--monta data vigência
	dt_vigencia_inicio_w := to_date('01/'||to_char(nr_mes_inicio_w, '09')||'/'||to_char(clock_timestamp(),'yyyy'));

	if (ie_dia_vig_ini_w = 2) then --último dia do mês
		dt_vigencia_inicio_w := trunc(last_day(dt_vigencia_inicio_w),'dd');
	end if;

	dt_vigencia_fim_w := to_date('01/'||to_char(nr_mes_final_w, '09')||'/'||to_char(clock_timestamp(),'yyyy'));

	if (ie_dia_vig_fin_w = 2) then --último dia do mês
		dt_vigencia_fim_w := trunc(last_day(dt_vigencia_fim_w),'dd');
	end if;

	--verifica se a data atual se encaixa na vigência da regra
	if (trunc(clock_timestamp(),'dd') between dt_vigencia_inicio_w and dt_vigencia_fim_w) then
		--monta datas consulta
		dt_consulta_inicio_w := to_date('01/'||to_char(nr_mes_util_ini_w, '09')||'/'||to_char(clock_timestamp(),'yyyy'));

		if (ie_dia_utilizado_ini_w = 2) then --último dia do mês
			dt_consulta_inicio_w := trunc(last_day(dt_consulta_inicio_w),'dd');
		end if;

		dt_consulta_fim_w := to_date('01/'||to_char(nr_mes_util_fin_w, '09')||'/'||to_char(clock_timestamp(),'yyyy'));

		if (ie_dia_utilizado_fin_w = 2) then --último dia do mês
			dt_consulta_fim_w := trunc(last_day(dt_consulta_fim_w),'dd');
		end if;

		--verifica se as datas se encaixam no período da consulta
		if (dt_inicio_w not between dt_consulta_inicio_w and dt_consulta_fim_w) or (dt_fim_w not between dt_consulta_inicio_w and dt_consulta_fim_w) then
			--caso não se encaixa retorna a mensagem
			return ds_mensagem_w;
		end if;
	end if;
	end loop;
close C01;

return null;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_utilizacao_dt_reg_benef ( dt_inicio_p text, dt_fim_p text) FROM PUBLIC;

