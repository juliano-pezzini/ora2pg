-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_verif_exist_carencia_web ( nr_seq_segurado_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(1) := 'N';
qt_registros_w			bigint;
ds_origem_carencia_w		varchar(255);
nr_seq_contrato_w		varchar(10);
nr_seq_plano_w			bigint;
ie_tipo_segurado_w		varchar(1);
cont_w				bigint;


BEGIN

begin
	select	ie_tipo_segurado
	into STRICT	ie_tipo_segurado_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;

	if (ie_tipo_segurado_w in ('C','T')) then
		select	coalesce(a.nr_seq_plano,0),
			b.nr_sequencia
		into STRICT	nr_seq_plano_w,
			nr_seq_contrato_w
		from	pls_segurado a,
			pls_intercambio b
		where	a.nr_seq_intercambio	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_segurado_p;
	elsif (ie_tipo_segurado_w not in ('C','T','I')) then
		select	coalesce(a.nr_seq_plano,0),
			b.nr_sequencia
		into STRICT	nr_seq_plano_w,
			nr_seq_contrato_w
		from	pls_segurado a,
			pls_contrato b
		where	a.nr_seq_contrato	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_segurado_p;
	elsif (ie_tipo_segurado_w = 'I') then
		select	coalesce(a.nr_seq_plano,0),
			0
		into STRICT	nr_seq_plano_w,
			nr_seq_contrato_w
		from	pls_segurado a
		where	a.nr_sequencia		= nr_seq_segurado_p;
	end if;

	/* Obter origem da carÃªncia */

	select	count(1)
	into STRICT	cont_w
	from	pls_carencia
	where	nr_seq_segurado	= nr_seq_segurado_p
	and	ie_cpt = 'N';

	if (cont_w > 0) then
		ds_origem_carencia_w	:= 'Beneficiario';
	else
		select	count(1)
		into STRICT	cont_w
		from	pls_carencia
		where	nr_seq_contrato		= nr_seq_contrato_w;

		if (cont_w > 0) then
			ds_origem_carencia_w	:= 'Contrato';
		else
			select	count(1)
			into STRICT	cont_w
			from	pls_carencia
			where	nr_seq_plano	= nr_seq_plano_w;

			if (cont_w > 0) then
				ds_origem_carencia_w		:= 'Produto';
			end if;
		end if;
	end if;

	if (upper(ds_origem_carencia_w) = upper('BENEFICIARIO')) then
		select	count(1)
		into STRICT	qt_registros_w
		from	pls_carencia
		where	substr(pls_obter_se_cpt(nr_seq_tipo_carencia),1,1) =  'N'
		and 	nr_seq_segurado = nr_seq_segurado_p
		and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy'), 'dd/mm/yyyy') < to_date(pls_obter_dados_carencia( nr_sequencia, nr_seq_segurado_p, 'DT'), 'dd/mm/yyyy');
	elsif (upper(ds_origem_carencia_w) = upper('CONTRATO')) then
		select	count(1)
		into STRICT	qt_registros_w
		from	pls_carencia
		where	substr(pls_obter_se_cpt(nr_seq_tipo_carencia),1,1) =  'N'
		and 	nr_seq_contrato = nr_seq_contrato_w
		and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy'), 'dd/mm/yyyy') < to_date(pls_obter_dados_carencia( nr_sequencia, nr_seq_segurado_p, 'DT'), 'dd/mm/yyyy');
	elsif (upper(ds_origem_carencia_w) = upper('PRODUTO')) then
		select	count(1)
		into STRICT	qt_registros_w
		from	pls_carencia
		where	substr(pls_obter_se_cpt(nr_seq_tipo_carencia),1,1) =  'N'
		and 	nr_seq_plano = nr_seq_plano_w
		and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy'), 'dd/mm/yyyy') < to_date(pls_obter_dados_carencia( nr_sequencia, nr_seq_segurado_p, 'DT'), 'dd/mm/yyyy');
	end if;
exception
	when others then
	qt_registros_w	:= 0;
end;

if (qt_registros_w > 0) then
	ds_retorno_w := 'S';
end if;

return	ds_retorno_w;

end 	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_verif_exist_carencia_web ( nr_seq_segurado_p bigint) FROM PUBLIC;

