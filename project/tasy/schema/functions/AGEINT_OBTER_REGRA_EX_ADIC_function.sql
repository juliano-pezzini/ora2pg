-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ageint_obter_regra_ex_adic ( nr_seq_proc_interno_p bigint, cd_estabelecimento_p bigint, cd_agenda_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text) RETURNS bigint AS $body$
DECLARE


vl_retorno_w		bigint	:= 0;
qt_exclusivo_w		bigint;
nr_seq_regra_w		bigint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
cd_area_proced_w	integer;
cd_espec_proced_w	integer;
cd_grupo_proced_w	bigint;
			

BEGIN
if (nr_seq_proc_interno_p	> 0) then
	SELECT * FROM obter_proc_tab_interno_conv(
					nr_seq_proc_interno_p, cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, cd_plano_p, null, cd_procedimento_w, ie_origem_proced_w, null, clock_timestamp(), null, null, null, null, null, null, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;

	select	coalesce(max(cd_area_procedimento),0),
		coalesce(max(cd_especialidade),0),
		coalesce(max(cd_grupo_proc),0)
	into STRICT	cd_area_proced_w,
		cd_espec_proced_w,
		cd_grupo_proced_w
	from	estrutura_procedimento_v
	where	cd_procedimento = cd_procedimento_w
	and	ie_origem_proced = ie_origem_proced_w;

	select	count(*)
	into STRICT	qt_exclusivo_w
	from	agenda_cons_regra_proc
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	coalesce(cd_agenda,cd_agenda_p) = cd_agenda_p
	and	((cd_convenio = cd_convenio_p) or (coalesce(cd_convenio::text, '') = ''))
	and	coalesce(ie_permite,'S') = 'E';

	if (qt_exclusivo_w > 0) then

		select	coalesce(max(nr_sequencia),0)
		into STRICT	vl_retorno_w
		from	agenda_cons_regra_proc
		where	cd_estabelecimento 	= cd_estabelecimento_p
		and	coalesce(cd_agenda,cd_agenda_p) = cd_agenda_p
		and	((cd_convenio 		= cd_convenio_p) or (coalesce(cd_convenio::text, '') = ''))
		and	((cd_categoria = cd_categoria_p) or (coalesce(cd_categoria::text, '') = ''))
		and	((cd_plano_convenio = cd_plano_p) or (coalesce(cd_plano_convenio::text, '') = ''))
		and	((cd_area_procedimento = cd_area_proced_w) or (coalesce(cd_area_procedimento::text, '') = ''))
		and	((cd_especialidade = cd_espec_proced_w) or (coalesce(cd_especialidade::text, '') = ''))
		and	((cd_grupo_proc = cd_grupo_proced_w) or (coalesce(cd_grupo_proc::text, '') = ''))
		and	((cd_procedimento = cd_procedimento_w) or (coalesce(cd_procedimento::text, '') = ''))
		and	((coalesce(cd_procedimento::text, '') = '') or ((ie_origem_proced = ie_origem_proced_w) or (coalesce(ie_origem_proced::text, '') = '')))
		and	((nr_seq_proc_interno = nr_seq_proc_interno_p) or (coalesce(nr_seq_proc_interno::text, '') = ''))
		and	coalesce(ie_permite,'S') = 'E';
	else
		select	coalesce(max(nr_sequencia),0)
		into STRICT	vl_retorno_w
		from	agenda_cons_regra_proc
		where	cd_estabelecimento = cd_estabelecimento_p
		and	coalesce(cd_agenda,cd_agenda_p) = cd_agenda_p
		and	((cd_convenio = cd_convenio_p) or (coalesce(cd_convenio::text, '') = ''))
		and	((cd_categoria = cd_categoria_p) or (coalesce(cd_categoria::text, '') = ''))
		and	((cd_plano_convenio = cd_plano_p) or (coalesce(cd_plano_convenio::text, '') = ''))
		and	((cd_area_procedimento = cd_area_proced_w) or (coalesce(cd_area_procedimento::text, '') = ''))
		and	((cd_especialidade = cd_espec_proced_w) or (coalesce(cd_especialidade::text, '') = ''))
		and	((cd_grupo_proc = cd_grupo_proced_w) or (coalesce(cd_grupo_proc::text, '') = ''))
		and	((cd_procedimento = cd_procedimento_w) or (coalesce(cd_procedimento::text, '') = ''))
		and	((coalesce(cd_procedimento::text, '') = '') or ((ie_origem_proced = ie_origem_proced_w) or (coalesce(ie_origem_proced::text, '') = '')))
		and	((nr_seq_proc_interno = nr_seq_proc_interno_p) or (coalesce(nr_seq_proc_interno::text, '') = ''))
		and	coalesce(ie_permite,'S')	= 'S';
	end if;
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ageint_obter_regra_ex_adic ( nr_seq_proc_interno_p bigint, cd_estabelecimento_p bigint, cd_agenda_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text) FROM PUBLIC;

