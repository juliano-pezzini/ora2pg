-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_material_imp ( nr_seq_material_p bigint, ie_tipo_relacao_p text, cd_material_imp_p text, dt_atendimento_p pls_conta_mat.dt_atendimento%type, ie_material_tuss_p text) RETURNS varchar AS $body$
DECLARE


cd_material_imp_w		varchar(20);
ie_tipo_despesa_w		varchar(10);
ie_tipo_material_w		varchar(10);	
nr_seq_material_w		bigint;
nr_seq_material_ww		bigint;
nr_seq_material_ativo_w	bigint;
cd_material_imp_ww		pls_material.cd_material_ops%type;
dt_atendimento_imp_w	pls_conta_mat.dt_atendimento_imp%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
ie_priorizar_ativos_w	pls_param_importacao_conta.ie_priorizar_ativos%type := 'N';

C01 CURSOR FOR
	SELECT	ie_tipo_material,
		ie_tipo_despesa
	from	pls_regra_importacao_mat
	where	coalesce(cd_codigo,coalesce(cd_material_imp_p,'X'))	= coalesce(cd_material_imp_p,'X')
	and	coalesce(ie_tipo_relacao,coalesce(ie_tipo_relacao_p,'X'))	= coalesce(ie_tipo_relacao_p,'X')
	and	coalesce(ie_situacao,'A')	= 'A'
	order by 	coalesce(ie_tipo_despesa,'A'),
				coalesce(ie_tipo_relacao,'A');

BEGIN

/*
	Abaixo faz várias tentativas de localizar sequência do material, priorizando uma busca por material vinculado a TUSS(Quando parâmetro for V) e após cada
	select verificando o vínculo com TUSS, caso não encontrar o material, busca material sem vínculo(
*/
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then
	select 	coalesce(max(ie_priorizar_ativos),'N')
	into STRICT	ie_priorizar_ativos_w
	from 	pls_param_importacao_conta
	where 	cd_estabelecimento = cd_estabelecimento_w;
end if;

nr_seq_material_ww := null;
open C01;
loop
fetch C01 into	
	ie_tipo_material_w,
	ie_tipo_despesa_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	
	if (ie_tipo_material_w		= 'H') then
		
		begin		
			select 	max(nr_sequencia)
			into STRICT	nr_seq_material_w
			from	pls_material
			where	cd_material	= cd_material_imp_p
			and	ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa)
			and	ie_situacao = 'A'
			and	(nr_seq_tuss_mat_item IS NOT NULL AND nr_seq_tuss_mat_item::text <> '')
			and	dt_atendimento_p between dt_inclusao_ref and dt_fim_vigencia_ref
			and	ie_material_tuss_p	= 'V';
				
			if (coalesce(nr_seq_material_w::text, '') = '') then
				select max(nr_sequencia)
				into STRICT	nr_seq_material_w
				from	pls_material
				where	cd_material	= cd_material_imp_p
				and	ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa)
				and	ie_situacao = 'A'
				and	dt_atendimento_p between dt_inclusao_ref and dt_fim_vigencia_ref;
			end if;
			
			if (coalesce(nr_seq_material_w::text, '') = '') then
				
				select	max(nr_sequencia)
				into STRICT	nr_seq_material_w				
				from	pls_material
				where	cd_material	= cd_material_imp_p
				and	(nr_seq_tuss_mat_item IS NOT NULL AND nr_seq_tuss_mat_item::text <> '')
				and	ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa)
				and	ie_material_tuss_p	= 'V';	

				if (coalesce(nr_seq_material_w::text, '') = '') then
					select	max(nr_sequencia)	
					into STRICT	nr_seq_material_w
					from	pls_material
					where	cd_material	= cd_material_imp_p
					and	ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa);
				end if;
					
			end if;
		
		exception
		when others then
			nr_seq_material_w := null;
		end;
		
	elsif (ie_tipo_material_w 	= 'C') then
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_material_w
		from	pls_material
		where	cd_material_ops	= cd_material_imp_p
		and	ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa)
		and	ie_situacao = 'A'
		and	(nr_seq_tuss_mat_item IS NOT NULL AND nr_seq_tuss_mat_item::text <> '')
		and	dt_atendimento_p between dt_inclusao_ref and dt_fim_vigencia_ref
		and	ie_material_tuss_p	= 'V';
			
		if (coalesce(nr_seq_material_w::text, '') = '') then
		
			select	max(nr_sequencia)
			into STRICT	nr_seq_material_w
			from	pls_material
			where	cd_material_ops	= cd_material_imp_p
			and		ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa)
			and		ie_situacao = 'A'
			and		dt_atendimento_p between dt_inclusao_ref and dt_fim_vigencia_ref;
				
		end if;
		
		if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
			nr_seq_material_ativo_w := nr_seq_material_w;
		end if;
		
		if (coalesce(nr_seq_material_w::text, '') = '') then
			select	max(nr_sequencia)
				into STRICT	nr_seq_material_w
				from	pls_material
				where	cd_material_ops	= cd_material_imp_p
				and	(nr_seq_tuss_mat_item IS NOT NULL AND nr_seq_tuss_mat_item::text <> '')
				and	ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa)
				and	ie_material_tuss_p	= 'V';
				
			if (coalesce(nr_seq_material_w::text, '') = '') then

				select	max(nr_sequencia)
				into STRICT	nr_seq_material_w
				from	pls_material
				where	cd_material_ops	= cd_material_imp_p
				and	ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa);
				
			end if;
				
		end if;
		
		if (coalesce(nr_seq_material_w::text, '') = '') then
			begin
				cd_material_imp_ww	:= (cd_material_imp_p)::numeric;
			exception
			when others then
				cd_material_imp_ww	:= null;
			end;
			
			select	max(nr_sequencia)
			into STRICT	nr_seq_material_w
			from	pls_material
			where	cd_material_ops_number 	= cd_material_imp_ww
			and	((ie_tipo_despesa	= ie_tipo_despesa_w) or (coalesce(ie_tipo_despesa_w::text, '') = ''))
			and	ie_situacao = 'A'
			and	(nr_seq_tuss_mat_item IS NOT NULL AND nr_seq_tuss_mat_item::text <> '')
			and	dt_atendimento_p between dt_inclusao_ref and dt_fim_vigencia_ref
			and	ie_material_tuss_p	= 'V';
				
			if (coalesce(nr_seq_material_w::text, '') = '' ) then
			
				select	max(nr_sequencia)
				into STRICT	nr_seq_material_w
				from	pls_material
				where	cd_material_ops_number 	= cd_material_imp_ww
				and		((ie_tipo_despesa	= ie_tipo_despesa_w) or (coalesce(ie_tipo_despesa_w::text, '') = ''))
				and		ie_situacao = 'A'
				and		dt_atendimento_p between dt_inclusao_ref and dt_fim_vigencia_ref;
				
			end if;
			
			if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
				nr_seq_material_ativo_w := nr_seq_material_w;
			end if;

			if (coalesce(nr_seq_material_w::text, '') = '') then
				

					select	max(nr_sequencia)
					into STRICT	nr_seq_material_w
					from	pls_material
					where	cd_material_ops_number 	= cd_material_imp_ww
					and	(nr_seq_tuss_mat_item IS NOT NULL AND nr_seq_tuss_mat_item::text <> '')
					and	((ie_tipo_despesa	= ie_tipo_despesa_w) or (coalesce(ie_tipo_despesa_w::text, '') = ''))
					and	ie_material_tuss_p	= 'V';
					
					if ( coalesce(nr_seq_material_w::text, '') = '') then
					
						select	max(nr_sequencia)
						into STRICT	nr_seq_material_w
						from	pls_material
						where	cd_material_ops_number 	= cd_material_imp_ww
						and		((ie_tipo_despesa	= ie_tipo_despesa_w) or (coalesce(ie_tipo_despesa_w::text, '') = ''));
					
					end if;
					
			end if;
		end if;
	else
		begin
			select	max(nr_sequencia)
			into STRICT	nr_seq_material_w
			from	pls_material
			where	nr_sequencia	= cd_material_imp_p
			and	ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa)
			and	ie_situacao = 'A'
			and	(nr_seq_tuss_mat_item IS NOT NULL AND nr_seq_tuss_mat_item::text <> '')
			and	dt_atendimento_p between dt_inclusao_ref and dt_fim_vigencia_ref
			and	ie_material_tuss_p	= 'V';
				
			if ( coalesce(nr_seq_material_w::text, '') = '' ) then
			
				select	max(nr_sequencia)
				into STRICT	nr_seq_material_w
				from	pls_material
				where	nr_sequencia	= cd_material_imp_p
				and		ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa)
				and		ie_situacao = 'A'
				and		dt_atendimento_p between dt_inclusao_ref and dt_fim_vigencia_ref;
			
			end if;
			
			if (coalesce(nr_seq_material_w::text, '') = '') then
				
				select	max(nr_sequencia)
				into STRICT	nr_seq_material_w
				from	pls_material
				where	nr_sequencia	= cd_material_imp_p
				and		(nr_seq_tuss_mat_item IS NOT NULL AND nr_seq_tuss_mat_item::text <> '')
				and		ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa)
				and		ie_material_tuss_p	= 'V';
					
				if ( coalesce(nr_seq_material_w::text, '') = '') then
					
					select	max(nr_sequencia)
					into STRICT	nr_seq_material_w			
					from	pls_material
					where	nr_sequencia	= cd_material_imp_p
					and		ie_tipo_despesa	= coalesce(ie_tipo_despesa_w,ie_tipo_despesa);
					
				end if;
				
			end if;
				
		exception
		when others then
			nr_seq_material_w := null;
		end;
	end if;
	
	--Se tem material ativo localizado, prioriza  o mesmo. O material ativo pode ter sido encontrado nessa ou em iteração anterior pelas regras, considerando que 

	--pode iterar por regras distintas tendo tipo despesa diferentes. Pode ter um material com situação ativa com um tipo despesa e esse mesmo cd_material_ops em um 

	--material inativo com outro tipo despesa. Essa situação fazia com que em alguns cenários, retornasse o código inativo.
	if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
		if ((nr_seq_material_ativo_w IS NOT NULL AND nr_seq_material_ativo_w::text <> '') and ie_priorizar_ativos_w = 'S') then
			nr_seq_material_ww := nr_seq_material_ativo_w;
		else
			nr_seq_material_ww := nr_seq_material_w;
		end if;
		
	end if;
	
	end;
end loop;
close C01;

return	nr_seq_material_ww;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_material_imp ( nr_seq_material_p bigint, ie_tipo_relacao_p text, cd_material_imp_p text, dt_atendimento_p pls_conta_mat.dt_atendimento%type, ie_material_tuss_p text) FROM PUBLIC;

