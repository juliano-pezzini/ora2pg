-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nfse_obter_dados_sp_intermed ( nr_sequencia_p bigint, ie_tipo_tomador_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

			 
ds_retorno_w				varchar(255) := '';
ds_insicriacao_municipal_w		varchar(255);
ie_iss_retido_intermediario_w		varchar(1);
ds_email_intermediario_w		varchar(255);
ie_possui_intermed_w			varchar(1);
cd_cgc_w				nota_fiscal.cd_cgc%type;
cd_pessoa_fisica_w			nota_fiscal.cd_pessoa_fisica%type;
cd_cgc_convenio_w			convenio.cd_cgc%type;

			 
/* 
 
ie_opcao_p 
 
CI- CPF / CNPJ Intermediário 
II - Inscrição Municipal do Intermediário 
EI - Email Intermediário 
RI - ISS Retido Intermediário 
--------------------------------- 
RS - Razão Social Tomador 
IE - Inscrição Estadual Tomador 
IM -Inscrição Municipal Tomador 
FT - CPF / CNPJ Tomador 
TL - Tipo Logradouro Tomador 
LT - Logradouro Tomador 
NE - Número Endereço Tomador 
CE - Complemento Endereço Tomador 
BT - Bairro Tomador 
CT - Cidade Tomador 
UF - UF Tomador 
EP - Cep Tomador 
ET - Email Tomador 
 
*/
 
			 

BEGIN 
 
select	max(cd_cgc), 
	max(cd_pessoa_fisica), 
	coalesce(obter_se_possui_intermed_nf(max(nr_sequencia)),'N') 
into STRICT	cd_cgc_w, 
	cd_pessoa_fisica_w, 
	ie_possui_intermed_w 
from	nota_fiscal 
where	nr_sequencia = nr_sequencia_p;
 
if (ie_possui_intermed_w = 'S') then 
	begin 
	 
	if (ie_tipo_tomador_p = 'N') then 
		begin 
		 
		select	obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)), 
			substr(CASE WHEN obter_dados_pf_pj(null,obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)),'CDM')=355030 THEN  obter_dados_pf_pj(null,obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)),'IM')  ELSE '' END ,1,8) InscricaoMunicipalIntermed, 
			CASE 
			WHEN(coalesce(obter_dados_pf_pj(null,obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)),'CDM'),0) = 355030) and (CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='1' THEN 'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='2' THEN 'F' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='3' THEN 'I' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='5' THEN 'J'  ELSE 'I' END  = 'I') THEN 
				'N' 
			ELSE 
				CASE WHEN obter_dados_pf_pj(null,obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)),'CDM')=355030 THEN  'S' WHEN obter_dados_pf_pj(null,obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)),'CDM')='' THEN  ''  ELSE 'N' END  
			END AS ISSRetidoIntermediario, 
			substr(obter_dados_pf_pj_estab(a.cd_estabelecimento, null, obter_cgc_convenio(obter_convenio_nf(a.nr_sequencia)), 'M'),1,75)	EmailIntermediario 
		into STRICT	cd_cgc_convenio_w, 
			ds_insicriacao_municipal_w, 
			ie_iss_retido_intermediario_w, 
			ds_email_intermediario_w 
		from	nota_fiscal a 
		where	nr_sequencia = nr_sequencia_p;
		 
		if (ie_opcao_p = 'CI') then 
			ds_retorno_w := cd_cgc_convenio_w;
		elsif (ie_opcao_p = 'II') then 
			ds_retorno_w := ds_insicriacao_municipal_w;
		elsif (ie_opcao_p = 'EI') then 
			ds_retorno_w := ds_email_intermediario_w;
		elsif (ie_opcao_p = 'RI') then 
			ds_retorno_w := ie_iss_retido_intermediario_w;
		end if;
	 
		end;
	elsif (ie_tipo_tomador_p = 'C') and (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then 
		begin 
		 
		select	a.cd_cgc, 
			substr(CASE WHEN obter_dados_pf_pj(null,a.cd_cgc,'CDM')=355030 THEN  obter_dados_pf_pj(null,a.cd_cgc,'IM')  ELSE '' END ,1,8) InscricaoMunicipalIntermed, 
			CASE 
			WHEN(coalesce(obter_dados_pf_pj(null,a.cd_cgc,'CDM'),0) = 355030) and (CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='1' THEN 'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='2' THEN 'F' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='3' THEN 'I' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='5' THEN 'J'  ELSE 'I' END  = 'I') THEN 
				'N' 
			ELSE 
				CASE WHEN obter_dados_pf_pj(null,a.cd_cgc,'CDM')=355030 THEN  'S' WHEN obter_dados_pf_pj(null,a.cd_cgc,'CDM')='' THEN  ''  ELSE 'N' END  
			END AS ISSRetidoIntermediario, 
			substr(obter_dados_pf_pj_estab(a.cd_estabelecimento, null, a.cd_cgc, 'M'),1,75)	EmailIntermediario 
		into STRICT	cd_cgc_convenio_w, 
			ds_insicriacao_municipal_w, 
			ie_iss_retido_intermediario_w, 
			ds_email_intermediario_w 
		from	nota_fiscal a 
		where	nr_sequencia = nr_sequencia_p;
		 
		if (ie_opcao_p = 'CI') then 
			ds_retorno_w := cd_cgc_convenio_w;
		elsif (ie_opcao_p = 'II') then 
			ds_retorno_w := ds_insicriacao_municipal_w;
		elsif (ie_opcao_p = 'EI') then 
			ds_retorno_w := ds_email_intermediario_w;
		elsif (ie_opcao_p = 'RI') then 
			ds_retorno_w := ie_iss_retido_intermediario_w;
		end if;
		 
		end;
	end if;
	 
 
	 
	end;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nfse_obter_dados_sp_intermed ( nr_sequencia_p bigint, ie_tipo_tomador_p text, ie_opcao_p text) FROM PUBLIC;

