-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION bsc_obter_perc_part_cmo ( dt_referencia_p timestamp, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


pr_retorno_w		double precision;
dt_ref_inicial_w	timestamp;
dt_ref_final_w		timestamp;
qt_encerrada_w		bigint;
qt_participacao_w	bigint;

/*
ie_opcao_p
CMO	- % de participação do CMO sobre as OS's de cliente (solicitação e defeito) das funções assistenciais
AN	- % de participação dos analistas de negócio asssistenciais sobre as OS's de cliente (solicitação e defeito) das funções assistenciais
CMO/AN	- % de participação do CMO sobre as OS's de cliente (solicitação e defeito) que tiveram participação dos analistas de negócio assistenciais nas funções assistenciais
CMO+AN	- % de participação do CMO + analistas de negócio assistenciais sobre as OS's de cliente (solicitação e defeito) das funções assistenciais
*/
BEGIN

dt_ref_inicial_w	:= trunc(dt_referencia_p,'month');
dt_ref_final_w		:= fim_dia(last_day(dt_ref_inicial_w));

if (ie_opcao_p in ('CMO','AN','CMO+AN')) then

	select	count(*)
	into STRICT	qt_encerrada_w
	from	funcao f,
		man_localizacao b,
		man_ordem_servico o,
		os_encerrada_gerencia_v a
	where	o.cd_funcao		= f.cd_funcao
	and	a.nr_seq_localizacao	= b.nr_sequencia
	and	o.nr_sequencia		= a.nr_sequencia
	and	f.ie_classif_comercial	= '5'
	and	o.ie_classificacao	<> 'D'
	and	a.dt_fim_real between dt_ref_inicial_w and dt_ref_final_w
	and	b.ie_terceiro		= 'S';

elsif (ie_opcao_p = 'CMO/AN') then

	select	count(*)
	into STRICT	qt_encerrada_w
	from	funcao f,
		man_localizacao b,
		man_ordem_servico o,
		os_encerrada_gerencia_v a
	where	o.cd_funcao		= f.cd_funcao
	and	a.nr_seq_localizacao	= b.nr_sequencia
	and	o.nr_sequencia		= a.nr_sequencia
	and	f.ie_classif_comercial	= '5'
	and	o.ie_classificacao	<> 'D'
	and	a.dt_fim_real between dt_ref_inicial_w and dt_ref_final_w
	and	b.ie_terceiro		= 'S'
	and	exists (SELECT 1
			from	GERENCIA_WHEB_GRUPO_USU d,
				MAN_ORDEM_SERV_TECNICO c
			where	c.nm_usuario = d.nm_usuario_grupo
			and	d.nr_seq_grupo = 494 /*Grupo de produto dos analistas clinicos nos cadastros gerais*/
			and	a.nr_sequencia = c.NR_SEQ_ORDEM_SERV
			and	c.dt_liberacao <  dt_ref_final_w
			and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> ''));

end if;

if (ie_opcao_p in ('CMO','CMO/AN')) then

	select	count(*)
	into STRICT	qt_participacao_w
	from	funcao f,
		man_localizacao b,
		man_ordem_servico o,
		os_encerrada_gerencia_v a
	where	o.cd_funcao		= f.cd_funcao
	and	a.nr_seq_localizacao = b.nr_sequencia
	and	o.nr_sequencia		= a.nr_sequencia
	and	f.ie_classif_comercial	= '5'
	and	o.ie_classificacao	<> 'D'
	and	a.dt_fim_real between dt_ref_inicial_w and dt_ref_final_w
	and	b.ie_terceiro = 'S'
	and	exists (SELECT 1
			from	GERENCIA_WHEB_GRUPO_USU d,
				MAN_ORDEM_SERV_TECNICO c
			where	c.nm_usuario = d.nm_usuario_grupo
			and	d.nr_seq_grupo = 249 /*Grupo do CMO nos cadastros gerais*/
			and	a.nr_sequencia = c.NR_SEQ_ORDEM_SERV
			and	c.dt_liberacao   <  dt_ref_final_w
			and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> ''));

elsif (ie_opcao_p = 'AN') then

	select	count(*)
	into STRICT	qt_participacao_w
	from	funcao f,
		man_localizacao b,
		man_ordem_servico o,
		os_encerrada_gerencia_v a
	where	o.cd_funcao		= f.cd_funcao
	and	a.nr_seq_localizacao = b.nr_sequencia
	and	o.nr_sequencia		= a.nr_sequencia
	and	f.ie_classif_comercial	= '5'
	and	o.ie_classificacao	<> 'D'
	and	a.dt_fim_real between dt_ref_inicial_w and dt_ref_final_w
	and	b.ie_terceiro = 'S'
	and	exists (SELECT 1
			from	GERENCIA_WHEB_GRUPO_USU d,
				MAN_ORDEM_SERV_TECNICO c
			where	c.nm_usuario = d.nm_usuario_grupo
			and	d.nr_seq_grupo = 494 /*Grupo de produto dos analistas clinicos nos cadastros gerais*/
			and	a.nr_sequencia = c.NR_SEQ_ORDEM_SERV
			and	c.dt_liberacao   <  dt_ref_final_w
			and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> ''));

elsif (ie_opcao_p = 'CMO+AN') then

	select	count(*)
	into STRICT	qt_participacao_w
	from	funcao f,
		man_localizacao b,
		man_ordem_servico o,
		os_encerrada_gerencia_v a
	where	o.cd_funcao		= f.cd_funcao
	and	a.nr_seq_localizacao = b.nr_sequencia
	and	o.nr_sequencia		= a.nr_sequencia
	and	f.ie_classif_comercial	= '5'
	and	o.ie_classificacao	<> 'D'
	and	a.dt_fim_real between dt_ref_inicial_w and dt_ref_final_w
	and	b.ie_terceiro = 'S'
	and	exists (SELECT 1
			from	GERENCIA_WHEB_GRUPO_USU d,
				MAN_ORDEM_SERV_TECNICO c
			where	c.nm_usuario = d.nm_usuario_grupo
			and	d.nr_seq_grupo in (249,494) /*Grupo de produto dos analistas clinicos + CMO nos cadastros gerais*/
			and	a.nr_sequencia = c.NR_SEQ_ORDEM_SERV
			and	c.dt_liberacao   <  dt_ref_final_w
			and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> ''));

end if;

pr_retorno_w	:= dividir(qt_participacao_w * 100,qt_encerrada_w);

return	pr_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION bsc_obter_perc_part_cmo ( dt_referencia_p timestamp, ie_opcao_p text) FROM PUBLIC;

