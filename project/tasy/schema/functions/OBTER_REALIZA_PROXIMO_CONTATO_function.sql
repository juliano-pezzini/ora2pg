-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_realiza_proximo_contato (NR_SEQ_LISTA_ESPERA_P bigint) RETURNS varchar AS $body$
DECLARE

  IE_TEMPO_REGRA_W    varchar(2);
  QT_TEMPO_REGRA_W    bigint;
  DT_ULTIMO_CONTATO_W timestamp;
  DT_LIMITE_CONTATO_W timestamp;
  NR_SEQ_CONTATO_W    bigint;


BEGIN

  SELECT A.NR_SEQUENCIA, A.DT_CONTATO
    INTO STRICT NR_SEQ_CONTATO_W, DT_ULTIMO_CONTATO_W
    FROM AG_LISTA_ESPERA_CONTATO A
   WHERE A.NR_SEQ_LISTA_ESPERA = NR_SEQ_LISTA_ESPERA_P
     AND coalesce(A.DT_INATIVACAO::text, '') = ''
     AND (A.DT_LIBERACAO IS NOT NULL AND A.DT_LIBERACAO::text <> '')
     AND OBTER_STATUS_CONTATO_LISTA(NR_SEQ_LISTA_ESPERA_P) IN ('AR','PN')
   ORDER BY A.DT_CONTATO DESC LIMIT 1;

  SELECT MAX(B.IE_TIPO_TEMPO_CONTATOS), MAX(B.QTD_TEMPO_ENTRE_CONTATOS)
    INTO STRICT IE_TEMPO_REGRA_W, QT_TEMPO_REGRA_W
    FROM REGRA_LISTA_ESPERA_CONTATO B LIMIT 1;

  IF (IE_TEMPO_REGRA_W IS NOT NULL AND IE_TEMPO_REGRA_W::text <> '') THEN

    IF (IE_TEMPO_REGRA_W = 'AA') THEN
      DT_LIMITE_CONTATO_W := ADD_MONTHS(DT_ULTIMO_CONTATO_W,
                                        QT_TEMPO_REGRA_W * 12);

    ELSIF (IE_TEMPO_REGRA_W = 'MM') THEN
      DT_LIMITE_CONTATO_W := ADD_MONTHS(DT_ULTIMO_CONTATO_W,
                                        QT_TEMPO_REGRA_W);
    ELSIF (IE_TEMPO_REGRA_W = 'DD') THEN
      DT_LIMITE_CONTATO_W := DT_ULTIMO_CONTATO_W + QT_TEMPO_REGRA_W;

    ELSIF (IE_TEMPO_REGRA_W = 'HH') THEN
      DT_LIMITE_CONTATO_W := DT_ULTIMO_CONTATO_W + (QT_TEMPO_REGRA_W / 24);

    ELSIF (IE_TEMPO_REGRA_W = 'MI') THEN
      DT_LIMITE_CONTATO_W := DT_ULTIMO_CONTATO_W +
                             (QT_TEMPO_REGRA_W / 1440);

    ELSIF (IE_TEMPO_REGRA_W = 'SS') THEN
      DT_LIMITE_CONTATO_W := DT_ULTIMO_CONTATO_W +
                             (QT_TEMPO_REGRA_W / 86400);

    END IF;

  END IF;

  IF (clock_timestamp() > DT_LIMITE_CONTATO_W ) THEN
    RETURN 'S';
  END IF;
  RETURN 'N';

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_realiza_proximo_contato (NR_SEQ_LISTA_ESPERA_P bigint) FROM PUBLIC;

