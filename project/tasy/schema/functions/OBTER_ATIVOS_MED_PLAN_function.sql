-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ativos_med_plan ( cd_material_p bigint) RETURNS varchar AS $body$
DECLARE


qtd_ativos_w 	smallint;
nm_active_main_w varchar(80) := null;
ds_retorno_w	varchar(4000) := null;
ds_agente_w		varchar(4000) := null;

C01 CURSOR FOR
	 SELECT substr(coalesce(obter_desc_ficha_tecnica(mpa.nr_seq_medic_ficha_tecnica), ''), 1, 80) ds_agent
	 from material mat, MATERIAL_PRINC_ATIVO mpa
	 where mat.cd_material = mpa.cd_material
	 and mat.cd_material = cd_material_p
	 order by mpa.nr_seq_medic_ficha_tecnica;


BEGIN

	select count(mpa.nr_seq_medic_ficha_tecnica) qtd_ativos
		into STRICT qtd_ativos_w	
		from material mat, MATERIAL_PRINC_ATIVO mpa
		where mat.cd_material = mpa.cd_material
		and mat.cd_material = cd_material_p;
	
	nm_active_main_w := obter_princ_ativo_matmed(cd_material_p);
	
	if (qtd_ativos_w = 0 and coalesce(nm_active_main_w::text, '') = '') then
		ds_retorno_w := '';
	elsif (((nm_active_main_w IS NOT NULL AND nm_active_main_w::text <> '') and qtd_ativos_w > 2) or qtd_ativos_w > 3) then
		ds_retorno_w := obter_desc_expressao(971834);
	else
	
		if (nm_active_main_w IS NOT NULL AND nm_active_main_w::text <> '') then
			ds_retorno_w := nm_active_main_w;
		end if;
		
		open c01;
		loop
		fetch	c01 into
			ds_agente_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			if (ds_agente_w IS NOT NULL AND ds_agente_w::text <> '')then
				if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
					ds_retorno_w := ds_retorno_w  || ' ' || chr(13) || ' ';
				end if;
			ds_retorno_w := ds_retorno_w || ds_agente_w;
			end if;
		end loop;
		close C01;
	end if;
	
	return	ds_retorno_w;
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ativos_med_plan ( cd_material_p bigint) FROM PUBLIC;

