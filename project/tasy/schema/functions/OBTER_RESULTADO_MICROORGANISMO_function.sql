-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_resultado_microorganismo (nr_prescricao_p bigint, nr_seq_exame_p bigint, nr_seq_material_p bigint default null, nr_seq_resultado_lab_p bigint default 0) RETURNS varchar AS $body$
DECLARE

ds_medicamento_w	varchar(20);
ie_tipo_w		varchar(30);
cih_microorganismo_w	varchar(30);
ds_resultado_w		varchar(2000) := '';
cd_microorganismo_w	bigint;
ds_microorganismo_w	varchar(255);
ie_ordem_w		smallint;
QT_MICROORGANISMO_w	varchar(150);
ds_resultado_antib_w exame_lab_result_antib.ds_resultado_antib%TYPE;

C01 CURSOR FOR
	SELECT 	distinct a.cd_microorganismo,
		substr(obter_cih_microorganismo(a.cd_microorganismo),1,255) ds,
		a.QT_MICROORGANISMO
	from	exame_lab_result_antib a,
		exame_lab_result_item b,
		exame_laboratorio c,
		exame_lab_resultado d
	where 	 a.nr_seq_resultado = b.nr_seq_resultado
	and    	d.nr_seq_resultado = b.nr_seq_resultado
	and    	a.nr_seq_result_item = b.nr_sequencia
	and    	c.nr_seq_exame = b.nr_seq_exame
	and	a.ie_resultado <> 'N'
	and    	c.nr_seq_exame = nr_seq_exame_p
	and	d.nr_prescricao = nr_prescricao_p
	and	((coalesce(nr_seq_material_p::text, '') = '') or (b.nr_seq_material = nr_seq_material_p))
	order by ds;

c02 CURSOR FOR
	SELECT 	substr(obter_desc_medic_cih(a.cd_medicamento),1,255) ds_medicamento,
		CASE WHEN a.ie_resultado='S' THEN  obter_desc_expressao(306274) WHEN a.ie_resultado='I' THEN  obter_desc_expressao(304784) WHEN a.ie_resultado='R' THEN  obter_desc_expressao(306164) WHEN a.ie_resultado='D' THEN  obter_desc_expressao(344985) END  ie_tipo,
        CASE WHEN a.ie_resultado='S' THEN 1  WHEN a.ie_resultado='I' THEN  3 WHEN a.ie_resultado='R' THEN  2 WHEN a.ie_resultado='D' THEN  4 END 	ie_ordem,
        a.ds_resultado_antib
	from    	exame_lab_result_antib a,
		exame_lab_result_item b,
		exame_laboratorio c,
		exame_lab_resultado d
	where  	a.nr_seq_resultado = b.nr_seq_resultado
	and    	d.nr_seq_resultado = b.nr_seq_resultado
	and    	a.nr_seq_result_item = b.nr_sequencia
	and    	c.nr_seq_exame = b.nr_seq_exame
	and	a.ie_resultado <> 'N'
	and     	c.nr_seq_exame = nr_seq_exame_p
	and	d.nr_prescricao = nr_prescricao_p
	and	a.cd_microorganismo =  cd_microorganismo_w
	and	((coalesce(nr_seq_material_p::text, '') = '') or (b.nr_seq_material = nr_seq_material_p))
	and	((coalesce(nr_seq_resultado_lab_p,0) = 0) or (b.nr_sequencia = nr_seq_resultado_lab_p))
	order by ie_ordem, ds_medicamento;



C03 CURSOR FOR
	SELECT 	distinct a.cd_microorganismo,
		substr(obter_cih_microorganismo(a.cd_microorganismo),1,255)  ds,
		a.QT_MICROORGANISMO
	from	exame_lab_result_antib a,
		exame_lab_result_item b,
		exame_laboratorio c,
		exame_lab_resultado d
	where 	 a.nr_seq_resultado = b.nr_seq_resultado
	and    	d.nr_seq_resultado = b.nr_seq_resultado
	and    	a.nr_seq_result_item = b.nr_sequencia
	and    	c.nr_seq_exame = b.nr_seq_exame
	and	coalesce(a.ie_resultado,'N') ='N'
	and    	c.nr_seq_exame = nr_seq_exame_p
	and	d.nr_prescricao = nr_prescricao_p
	and	((coalesce(nr_seq_material_p::text, '') = '') or (b.nr_seq_material = nr_seq_material_p))
	order by ds;

BEGIN
open c01;
loop
fetch c01 into
	cd_microorganismo_w,
	ds_microorganismo_w,
	QT_MICROORGANISMO_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	ds_resultado_w := ds_resultado_w||ds_microorganismo_w||'   -   '||QT_MICROORGANISMO_w|| chr(13) || chr(10);
	open C02;
	loop
	fetch C02 into
		ds_medicamento_w,
		ie_tipo_w,
		ie_ordem_w,
        ds_resultado_antib_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
        if (coalesce(ds_resultado_antib_w::text, '') = '') then
            ds_resultado_w := ds_resultado_w||'       '||ds_medicamento_w||' - '||ie_tipo_w|| chr(13) || chr(10);
        else
            ds_resultado_w := ds_resultado_w||'       '||ds_medicamento_w||' - '||ie_tipo_w||' ('||ds_resultado_antib_w||')'|| chr(13) || chr(10);
        end if;
		end;
	end loop;
	close C02;

end loop;
close c01;


if (coalesce(ds_resultado_w::text, '') = '') then
	open C03;
	loop
	fetch C03 into
		cd_microorganismo_w,
		ds_microorganismo_w,
		QT_MICROORGANISMO_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		ds_resultado_w := ds_resultado_w||ds_microorganismo_w||'   -   '||QT_MICROORGANISMO_w|| chr(13) || chr(10);
		end;
	end loop;
	close C03;
end if;


return ds_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_resultado_microorganismo (nr_prescricao_p bigint, nr_seq_exame_p bigint, nr_seq_material_p bigint default null, nr_seq_resultado_lab_p bigint default 0) FROM PUBLIC;

