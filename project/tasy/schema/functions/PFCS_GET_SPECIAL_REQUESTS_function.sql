-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_special_requests ( nr_seq_encounter_p bigint, nr_seq_location_p bigint default null, ie_option_p text default 'A', max_requests_p bigint default null) RETURNS varchar AS $body$
DECLARE


/*
    ie_option_p
    'A' -> All types of special requests
    'E' -> Encounter special requests only
    'L' -> Location special requests only
*/
c01_rqts is CURSOR
with temp as (
SELECT distinct enc.cd_flag, enc.ds_flag
from pfcs_patient_flag enc
where enc.cd_category = 'SR100'
    and enc.si_status = 'ACTIVE'
    and (enc.period_start IS NOT NULL AND enc.period_start::text <> '')
    and coalesce(enc.period_end::text, '') = ''
    and enc.nr_seq_encounter = nr_seq_encounter_p
    and (ie_option_p = 'A' or ie_option_p = 'E')
    and (nr_seq_encounter_p IS NOT NULL AND nr_seq_encounter_p::text <> '')

union all

select distinct loc.cd_flag, loc.ds_flag
from pfcs_patient_flag loc
where loc.cd_category = 'SR100'
    and loc.si_status = 'ACTIVE'
    and (loc.period_start IS NOT NULL AND loc.period_start::text <> '')
    and coalesce(loc.period_end::text, '') = ''
    and loc.nr_seq_location = nr_seq_location_p
    and (ie_option_p = 'A' or ie_option_p = 'L')
    and (nr_seq_location_p IS NOT NULL AND nr_seq_location_p::text <> '')
)
select cd_flag, ds_flag,
    coalesce(map.nm_icon, (select nm_icon from pfcs_special_request_map where cd_special_request = 'DEFAULT')) nm_icon
from temp t
left join pfcs_special_request_map map on t.cd_flag = map.cd_special_request and map.ie_situacao = 'A';

request_list_w              varchar(4000) := '';
ds_flag_w              varchar(4000) := '';
aux_length_w                numeric(20) := 0;
max_requests_w              smallint := 0;


BEGIN
    for rqts in c01_rqts loop
        ds_flag_w :='';
        ds_flag_w := (rqts.ds_flag || ':' || rqts.nm_icon);
        request_list_w := (request_list_w || ds_flag_w || ';');
        max_requests_w := max_requests_w + 1;
        if ((max_requests_p IS NOT NULL AND max_requests_p::text <> '') and max_requests_w = max_requests_p) then
            EXIT;
        end if;
    end loop;

    aux_length_w := length(request_list_w);
    if (aux_length_w > 0) then
        request_list_w := substr(request_list_w, 1, (aux_length_w - 1));
    else
        request_list_w := null;
    end if;

    RETURN request_list_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_special_requests ( nr_seq_encounter_p bigint, nr_seq_location_p bigint default null, ie_option_p text default 'A', max_requests_p bigint default null) FROM PUBLIC;

