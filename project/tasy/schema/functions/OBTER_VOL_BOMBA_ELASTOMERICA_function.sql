-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_vol_bomba_elastomerica (nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_cd_ds_p text) RETURNS bigint AS $body$
DECLARE

/*
ie_cd_ds_p = [D]escrição / [C]ódigo
*/
/* Lê a tabela REGRA_BOMBA_ELASTOMERICA e
retorna a sequencia da  tabela BOMBA_ELASTOMERICA que se aplica a solução*/
ie_tipo_dosagem_w	varchar(3);
qt_solucao_total_w	double precision;
qt_dosagem_w		double precision := 0;
ie_bomba_infusao_w	varchar(1);
nr_seq_bomba_elast_w	bigint := null;
qt_reg_w		bigint;
ds_bomba_w		varchar(255);
qt_tempo_aplicacao_w	double precision;
nr_seq_bomba_elast_regra_w	 bigint;

BEGIN
Select	max(ie_bomba_elastomerica)
into STRICT	nr_seq_bomba_elast_w
from	prescr_solucao a
where	a.nr_prescricao	= nr_prescricao_p
and	a.nr_seq_solucao = nr_seq_solucao_p;

Select	count(*)
into STRICT	qt_reg_w
from	regra_bomba_elastomerica;

if (qt_reg_w > 0) then
	nr_seq_bomba_elast_regra_w := Obter_bomba_elastomerica(nr_prescricao_p,
				nr_seq_solucao_p, 'C');
	if (coalesce(nr_seq_bomba_elast_w::text, '') = '') or (nr_seq_bomba_elast_w	<> nr_seq_bomba_elast_regra_w) then
		nr_seq_bomba_elast_w	:= nr_seq_bomba_elast_regra_w;
	end if;
	Select	max(qt_solucao_total),
		max(ie_tipo_dosagem),
		max(qt_dosagem),
		max(ie_bomba_infusao),
		CASE WHEN coalesce(max(qt_tempo_aplicacao),0)=0 THEN 1  ELSE max(qt_tempo_aplicacao) END
	into STRICT	qt_solucao_total_w,
		ie_tipo_dosagem_w,
		qt_dosagem_w,
		ie_bomba_infusao_w,
		qt_tempo_aplicacao_w
	from	prescr_solucao
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_solucao	= nr_seq_solucao_p;

	select	sum(a.qt_solucao)
	into STRICT	qt_solucao_total_w
	from	prescr_material a,
		material b
	where	b.cd_material 		= a.cd_material
	and	a.nr_prescricao		= nr_prescricao_p
	and	a.nr_sequencia_solucao	= nr_seq_solucao_p
	and 	coalesce(b.ie_ancora_solucao,'S') = 'S'
	and 	a.ie_agrupador		= 4;

	if (ie_tipo_dosagem_w IS NOT NULL AND ie_tipo_dosagem_w::text <> '') and (qt_dosagem_w IS NOT NULL AND qt_dosagem_w::text <> '') and (qt_solucao_total_w IS NOT NULL AND qt_solucao_total_w::text <> '') and (ie_bomba_infusao_w = 'B') then

		Select	min(b.qt_dosagem)
		into STRICT	qt_dosagem_w
		from	bomba_elastomerica a,
			regra_bomba_elastomerica b
		where	a.nr_sequencia = b.nr_seq_bomba
		and 	coalesce(a.ie_situacao,'I') = 'A'
		and 	a.nr_sequencia	= nr_seq_bomba_elast_regra_w
		and 	b.qt_solucao_total =
				(SELECT	min(c.qt_solucao_total)
				from	regra_bomba_elastomerica c,
					bomba_elastomerica d
				where 	c.nr_seq_bomba	= d.nr_sequencia
				and	coalesce(d.ie_situacao,'I') = 'A'
				and 	d.nr_sequencia	= nr_seq_bomba_elast_regra_w
				and	c.qt_solucao_total >= qt_solucao_total_w
				and	Obter_vel_sol_mlh(c.ie_tipo_dosagem, c.qt_dosagem) >=
					qt_solucao_total_w / qt_tempo_aplicacao_w)
		and	Obter_vel_sol_mlh(b.ie_tipo_dosagem, b.qt_dosagem)>=
			qt_solucao_total_w / qt_tempo_aplicacao_w;
	end if;

end if;

return qt_dosagem_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_vol_bomba_elastomerica (nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_cd_ds_p text) FROM PUBLIC;

