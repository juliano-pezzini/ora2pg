-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_pessoa_titulo_data ( nr_titulo_p bigint, dt_referencia_p timestamp, ie_tipo_p text default 'N') RETURNS varchar AS $body$
DECLARE

 
/* 
N -> Nome 
C -> Codigo 
*/
					 
 
nm_pessoa_w	varchar(255);
cd_pessoa_fisica_w	varchar(20);
dt_alteracao_w	timestamp;
dt_referencia_w	timestamp;


BEGIN 
 
select	max(a.dt_alteracao) 
into STRICT	dt_alteracao_w 
from	tit_rec_alt_pessoa a 
where	a.dt_alteracao	<= dt_referencia_p 
and	a.nr_titulo	= nr_titulo_p;
 
if (coalesce(dt_alteracao_w::text, '') = '') then 
 
	select	max(a.dt_alteracao) 
	into STRICT	dt_alteracao_w 
	from	tit_rec_alt_pessoa a 
	where	a.dt_alteracao	> dt_referencia_p 
	and	a.nr_titulo	= nr_titulo_p;
 
	if (coalesce(dt_alteracao_w::text, '') = '') then 
 
		select	max(a.cd_pessoa_fisica), 
			max(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc)) 
		into STRICT	cd_pessoa_fisica_w, 
			nm_pessoa_w 
		from	titulo_receber a 
		where	a.nr_titulo	= nr_titulo_p;
 
	else 
 
		select	max(a.cd_pessoa_fisica), 
			obter_nome_pf_pj(max(a.cd_pessoa_fisica_ant),max(a.cd_cgc_ant)) 
		into STRICT	cd_pessoa_fisica_w, 
			nm_pessoa_w 
		from	tit_rec_alt_pessoa a 
		where	a.dt_alteracao	= dt_alteracao_w 
		and	a.nr_titulo	= nr_titulo_p;
 
	end if;
 
else 
 
	select	max(a.cd_pessoa_fisica), 
		obter_nome_pf_pj(max(a.cd_pessoa_fisica),max(a.cd_cgc)) nm_pessoa 
	into STRICT	cd_pessoa_fisica_w, 
		nm_pessoa_w 
	from	tit_rec_alt_pessoa a 
	where	a.dt_alteracao	= dt_alteracao_w 
	and	a.nr_titulo	= nr_titulo_p;
 
end if;
 
if ie_tipo_p = 'N' then 
	return	nm_pessoa_w;
else 
	return	cd_pessoa_fisica_w;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_pessoa_titulo_data ( nr_titulo_p bigint, dt_referencia_p timestamp, ie_tipo_p text default 'N') FROM PUBLIC;

