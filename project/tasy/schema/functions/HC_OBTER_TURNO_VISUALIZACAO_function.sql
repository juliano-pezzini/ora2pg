-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hc_obter_turno_visualizacao ( hr_atual_p timestamp, ie_opcao_p bigint) RETURNS bigint AS $body$
DECLARE


/*
ie_opcao_p

1 = Turno para o WCPanel da esquerda (agenda_matutino_wcp)
2 = Turno para o WCPanel da direita  (agenda_vespertino_wcp)
*/
nr_retorno_w		bigint;
nr_sequencia_w		bigint;
hr_ini_visualizacao_w	timestamp;
hr_fim_visualizacao_w	timestamp;
qt_final_w		smallint;
qt_hr_outro_dia_w	smallint;
ie_turno_w		varchar(1);
ie_matutino_w		varchar(1);
nr_seq_mat_w		bigint;
ie_vespertino_w		varchar(1);
nr_seq_ves_w		bigint;
ie_noturno_w		varchar(1);
nr_seq_not_w		bigint;

C01 CURSOR FOR
	SELECT	hr_ini_visualizacao,
		nr_sequencia,
		(to_char(hr_ini_visualizacao,'hh24')+qt_horas_visual)::numeric ,
		ie_turno
	from	hc_turno
	where	coalesce(ie_situacao,'A') = 'A';


BEGIN

if	((hr_atual_p IS NOT NULL AND hr_atual_p::text <> '') and (coalesce(ie_opcao_p,0) > 0)) then
	begin
	ie_matutino_w	:= 'N';
	ie_vespertino_w := 'N';
	ie_noturno_w	:= 'N';

	open C01;
	loop
	fetch C01 into
		hr_ini_visualizacao_w,
		nr_sequencia_w,
		qt_final_w,
		ie_turno_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		qt_hr_outro_dia_w := 0;
		if (qt_final_w >= 24) then
			qt_hr_outro_dia_w := qt_final_w - 24;
		end if;
		/*
		if	(to_char(hr_ini_visualizacao_w,'hh24:mi:ss') >= to_char(hr_fim_visualizacao_w,'hh24:mi:ss')) then

			if	(to_char(hr_ini_visualizacao_w,'hh24:mi:ss') >= to_char(hr_atual_p,'hh24:mi:ss')) then
				begin
				hr_fim_visualizacao_w := to_date(to_char(hr_atual_p,'dd/mm/yyyy')||' '|| to_char(lpad(qt_final_w,2,'0'))||to_char(hr_ini_visualizacao_w,'mi:ss'),'dd/mm/yyyy hh24:mi:ss');
				hr_ini_visualizacao_w := to_date(to_char(hr_atual_p-1,'dd/mm/yyyy')||' '||to_char(hr_ini_visualizacao_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
				end;
			end if;

			if	(to_char(hr_ini_visualizacao_w,'hh24:mi:ss') <= to_char(hr_atual_p,'hh24:mi:ss')) then
				begin
				hr_fim_visualizacao_w := to_date(to_char(hr_atual_p+1,'dd/mm/yyyy')||' '|| to_char(lpad(qt_final_w,2,'0'))||to_char(hr_ini_visualizacao_w,'mi:ss'),'dd/mm/yyyy hh24:mi:ss');
				hr_ini_visualizacao_w := to_date(to_char(hr_atual_p,'dd/mm/yyyy')||' '||to_char(hr_ini_visualizacao_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
				end;
			end if;
		else
			hr_fim_visualizacao_w := to_date(to_char(hr_atual_p,'dd/mm/yyyy')||' '|| to_char(lpad(qt_final_w,2,'0'))||to_char(hr_ini_visualizacao_w,'mi:ss'),'dd/mm/yyyy hh24:mi:ss');
			hr_ini_visualizacao_w := to_date(to_char(hr_atual_p,'dd/mm/yyyy')||' '||to_char(hr_ini_visualizacao_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
		end if;


		if 	((hr_ini_visualizacao_w < hr_atual_p)
			and (hr_fim_visualizacao_w >= hr_atual_p)) then
			*/
		if	((to_char(hr_ini_visualizacao_w,'hh24:mi:ss') <= to_char(hr_atual_p,'hh24:mi:ss'))
			and	((qt_final_w > (to_char(hr_atual_p,'hh24'))::numeric )
			or	((qt_hr_outro_dia_w >= (to_char(hr_atual_p,'hh24'))::numeric )
				and (qt_final_w >= 24))))
		or	((to_char(hr_ini_visualizacao_w,'hh24:mi:ss') >= to_char(hr_atual_p,'hh24:mi:ss'))
			and (qt_hr_outro_dia_w >= (to_char(hr_atual_p,'hh24'))::numeric )) then

			if (ie_turno_w = 'M') then
				ie_matutino_w	:= 'S';
				nr_seq_mat_w	:= nr_sequencia_w;
			elsif (ie_turno_w = 'V') then
				ie_vespertino_w := 'S';
				nr_seq_ves_w	:= nr_sequencia_w;
			elsif (ie_turno_w = 'N') then
				ie_noturno_w	:= 'S';
				nr_seq_not_w	:= nr_sequencia_w;
			end if;
		end if;

		end;
	end loop;
	close C01;
	if (ie_opcao_p = 1) then
		select	CASE WHEN  ie_matutino_w='S' THEN nr_seq_mat_w  ELSE CASE WHEN ie_vespertino_w='S' THEN nr_seq_ves_w  ELSE CASE WHEN ie_noturno_w='S' THEN nr_seq_not_w  ELSE 0 END  END  END
		into STRICT	nr_retorno_w
		;
	end if;
	if (ie_opcao_p = 2) then
		select	CASE WHEN  ie_noturno_w='S' THEN nr_seq_not_w  ELSE CASE WHEN ie_vespertino_w='S' THEN nr_seq_ves_w  ELSE CASE WHEN ie_matutino_w='S' THEN nr_seq_mat_w  ELSE 0 END  END  END
		into STRICT	nr_retorno_w
		;
	end if;

	if (ie_matutino_w = 'S') and (ie_noturno_w = 'S') and (ie_vespertino_w = 'N') then

		if (ie_opcao_p = 1) then
			nr_retorno_w := nr_seq_not_w;
		end if;

		if (ie_opcao_p = 2) then
			nr_retorno_w := nr_seq_mat_w;
		end if;

	end if;
	end;
end if;

return	nr_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hc_obter_turno_visualizacao ( hr_atual_p timestamp, ie_opcao_p bigint) FROM PUBLIC;

