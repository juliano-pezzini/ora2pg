-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_cid_causa_morte_mx ( nr_atendimento_p bigint, ie_tipo_causa_p text) RETURNS varchar AS $body$
DECLARE




/*

Utilizada na guia NOM 13 - Mortalidade General

- verificar se algum dos CID's da causa de óbito estão entre os códigos O00 e O99.



	ie_tipo_causa_p

	- P - principal

	- S - Secundária

*/
ds_retorno_w		varchar(255)	:= 'N';

cd_cid_direta_w		declaracao_obito.cd_cid_direta%type;

cd_cid_adic_1_w		declaracao_obito.cd_cid_adic_1%type;

cd_cid_adic_2_w		declaracao_obito.cd_cid_adic_2%type;

cd_cid_adic_3_w		declaracao_obito.cd_cid_adic_3%type;

cd_cid_basica_w		declaracao_obito.cd_cid_basica%type;

cd_cid_adic_4_w		declaracao_obito.cd_cid_adic_4%type;




BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then



		select 	max(cd_cid_direta),

		max(cd_cid_adic_1),

		max(cd_cid_adic_2),

		max(cd_cid_adic_3),

		max(cd_cid_basica),

		max(cd_cid_adic_4)

	into STRICT	cd_cid_direta_w,

		cd_cid_adic_1_w,

		cd_cid_adic_2_w,

		cd_cid_adic_3_w,

		cd_cid_basica_w,

		cd_cid_adic_4_w

	from	declaracao_obito

	where ie_situacao = 'A'

	and 	nr_atendimento = nr_atendimento_p;



	if (ie_tipo_causa_p = 'P') then

		if (cd_cid_direta_w IS NOT NULL AND cd_cid_direta_w::text <> '') and (substr(cd_cid_direta_w,1,1) = 'O') then

			ds_retorno_w := 'S';

		end if;



		if (cd_cid_adic_1_w IS NOT NULL AND cd_cid_adic_1_w::text <> '') and (substr(cd_cid_adic_1_w,1,1) = 'O')  then

			ds_retorno_w := 'S';

		end if;



		if (cd_cid_adic_2_w IS NOT NULL AND cd_cid_adic_2_w::text <> '') and (substr(cd_cid_adic_2_w,1,1) = 'O')  then

			ds_retorno_w := 'S';

		end if;



		if (cd_cid_adic_3_w IS NOT NULL AND cd_cid_adic_3_w::text <> '') and (substr(cd_cid_adic_3_w,1,1) = 'O')  then

			ds_retorno_w := 'S';

		end if;



	elsif (ie_tipo_causa_p = 'S') then

		if (cd_cid_basica_w IS NOT NULL AND cd_cid_basica_w::text <> '') and (substr(cd_cid_basica_w,1,1) = 'O')  then

			ds_retorno_w := 'S';

		end if;



		if (cd_cid_adic_4_w IS NOT NULL AND cd_cid_adic_4_w::text <> '') and (substr(cd_cid_adic_4_w,1,1) = 'O')  then

			ds_retorno_w := 'S';

		end if;

	end if;

end if;



return	ds_retorno_w;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_cid_causa_morte_mx ( nr_atendimento_p bigint, ie_tipo_causa_p text) FROM PUBLIC;

