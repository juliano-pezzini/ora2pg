-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_cir_autor_mat ( nr_atendimento_p bigint, nr_seq_agenda_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


nr_cirurgia_w			bigint;
ds_retorno_w			varchar(255);

ie_mostra_realizadas_w		varchar(5) := 'N';
dt_inicio_previsto_w		timestamp;
/*
ie_opcao_p
NR - NÃºmero da cirurgia
DT - Data prevista
*/
BEGIN

ie_mostra_realizadas_w := obter_param_usuario(3006, 31, obter_perfil_ativo, Wheb_Usuario_Pck.Get_nm_usuario, Wheb_Usuario_Pck.Get_cd_estabelecimento, ie_mostra_realizadas_w);

if (coalesce(nr_seq_agenda_p,0) > 0) then

	select	max(nr_cirurgia),
		max(dt_inicio_prevista)
	into STRICT	nr_cirurgia_w,
		dt_inicio_previsto_w
	from	cirurgia
	where	nr_seq_agenda		= nr_seq_agenda_p;

elsif (coalesce(nr_atendimento_p,0) > 0) then

	select	max(a.nr_cirurgia),
		max(a.dt_inicio_prevista) dt
	into STRICT	nr_cirurgia_w,
		dt_inicio_previsto_w
	from	cirurgia a
	where	a.nr_atendimento	= nr_atendimento_p;

end if;

if (ie_opcao_p = 'NR') then
	ds_retorno_w	:= nr_cirurgia_w;
ELSIF (ie_opcao_p = 'DT') THEN

	if (coalesce(ie_mostra_realizadas_w,'N') = 'N') and (clock_timestamp() < dt_inicio_previsto_w) then

		ds_retorno_w := to_char(dt_inicio_previsto_w,'dd/mm/yyyy hh24:mi:ss');

	elsif (coalesce(ie_mostra_realizadas_w,'N') = 'S') then

		ds_retorno_w := to_char(dt_inicio_previsto_w,'dd/mm/yyyy hh24:mi:ss');
	end if;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_cir_autor_mat ( nr_atendimento_p bigint, nr_seq_agenda_p bigint, ie_opcao_p text) FROM PUBLIC;

