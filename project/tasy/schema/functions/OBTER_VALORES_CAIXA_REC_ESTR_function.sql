-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valores_caixa_rec_estr ( nr_seq_caixa_rec_p bigint, cd_moeda_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

 
dt_cancelamento_receb_w		timestamp;
ie_tipo_receb_w			varchar(1);
vl_especie_w			double precision;
vl_cheques_w			double precision;
vl_cartao_w			double precision;
vl_recebido_w			double precision;
vl_juros_w			double precision;
vl_multa_w			double precision;
vl_desp_bancaria_w		double precision;
vl_descontos_w			double precision;
vl_total_w			double precision;
vl_retorno_w			double precision;
vl_adiantamento_w		double precision;
vl_transacao_w			double precision;
vl_terceiro_w			double precision;
vl_negociado_w			double precision;
vl_desconto_w			double precision;
vl_acrescimo_w			double precision;
vl_baixa_perda_w		double precision;
vl_glosa_w			double precision;
vl_outros_acrescimos_w		double precision;
vl_juros_cheque_w		double precision;
vl_multa_cheque_w		double precision;
vl_rec_maior_w			double precision;
vl_troco_informado_w		double precision;
ie_acao_w			varchar(10);
cd_tipo_receb_caixa_w		integer;
/* Projeto Multimoeda - Variáveis */
vl_especie_estrang_w		double precision;
cd_moeda_empresa_w		integer;
cd_estabelecimento_w		bigint;
vl_cheques_estrang_w		double precision;
vl_recebido_estrang_w		double precision;
vl_adto_estrang_w		double precision;
vl_transacao_estrang_w		double precision;
vl_adto_pago_w			double precision;
vl_adto_pago_estrang_w		double precision;


BEGIN 
select	coalesce(a.vl_especie,0), 
	coalesce(a.ie_tipo_receb,'R'), 
	a.dt_cancelamento, 
	a.cd_tipo_receb_caixa, 
	coalesce(a.vl_troco_informado,0), 
	c.cd_estabelecimento 
into STRICT	vl_especie_w, 
	ie_tipo_receb_w, 
	dt_cancelamento_receb_w, 
	cd_tipo_receb_caixa_w, 
	vl_troco_informado_w, 
	cd_estabelecimento_w 
from	caixa_receb a, 
	caixa_saldo_diario b, 
	caixa c 
where	a.nr_seq_saldo_caixa	= b.nr_sequencia 
and	b.nr_seq_caixa		= c.nr_sequencia 
and	a.nr_sequencia		= nr_seq_caixa_rec_p;
 
select	obter_moeda_padrao_empresa(cd_estabelecimento_w,'E') 
into STRICT	cd_moeda_empresa_w
;
 
select	coalesce(sum(vl_especie_estrang),0) 
into STRICT	vl_especie_estrang_w 
from	caixa_receb_estrang 
where	nr_seq_caixa_receb = nr_seq_caixa_rec_p 
and	cd_moeda = coalesce(cd_moeda_p,cd_moeda_empresa_w);
 
if (coalesce(cd_tipo_receb_caixa_w,0) <> 0) then 
	select	max(ie_acao_rec_caixa) 
	into STRICT	ie_acao_w 
	from	tipo_recebimento 
	where	cd_tipo_recebimento = cd_tipo_receb_caixa_w;
else 
	select	max(a.ie_acao) 
	into STRICT	ie_acao_w 
	from	transacao_financeira a, 
		caixa_receb b 
	where	a.nr_sequencia	= b.nr_seq_trans_financ 
	and	b.nr_sequencia	= nr_seq_caixa_rec_p;
end if;
 
if (dt_cancelamento_receb_w IS NOT NULL AND dt_cancelamento_receb_w::text <> '') then 
	return 0;
end if;
 
if (ie_tipo_receb_w = 'P') then 
	select	coalesce(sum(vl_perda),0)	 
	into STRICT	vl_cheques_w 
	from	CHEQUE_CR_PERDA 
	where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p 
	and	cd_moeda_empresa_w	= coalesce(cd_moeda_p,cd_moeda_empresa_w);
else 
	select	coalesce(sum(vl_cheque),0), 
		coalesce(sum(vl_cheque_estrang),0) 
	into STRICT	vl_cheques_w, 
		vl_cheques_estrang_w 
	from	cheque_cr 
	where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p 
	and	coalesce(cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_p,cd_moeda_empresa_w);
end if;
 
select	coalesce(sum(vl_transacao),0) 
into STRICT	vl_cartao_w 
from	movto_cartao_cr 
where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p 
and	coalesce(dt_cancelamento::text, '') = '' 
and ((dt_confirmacao_tef IS NOT NULL AND dt_confirmacao_tef::text <> '') or coalesce(dt_integracao_tef::text, '') = '') 
and	cd_moeda_empresa_w = coalesce(cd_moeda_p,cd_moeda_empresa_w);
 
/* Todos valores de baixa do recebimento */
 
select	coalesce(sum(vl_recebido),0), 
	coalesce(sum(vl_juros),0), 
	coalesce(sum(vl_multa),0), 
	coalesce(sum(vl_despesa_bancaria),0), 
	coalesce(sum(vl_descontos),0), 
	coalesce(sum(vl_glosa),0), 
	coalesce(sum(vl_outros_acrescimos),0), 
	coalesce(sum(vl_rec_maior),0), 
	coalesce(sum(vl_recebido_estrang),0) 
into STRICT	vl_recebido_w, 
	vl_juros_w, 
	vl_multa_w, 
	vl_desp_bancaria_w, 
	vl_descontos_w, 
	vl_glosa_w, 
	vl_outros_acrescimos_w, 
	vl_rec_maior_w, 
	vl_recebido_estrang_w 
from	titulo_receber_liq a 
where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p 
and	coalesce(cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_p,cd_moeda_empresa_w);
 
/* Todos valores da negociacao de cheque */
 
select	coalesce(sum(vl_negociado),0), 
	coalesce(sum(vl_desconto),0), 
	coalesce(sum(vl_acrescimo),0), 
	coalesce(sum(vl_terceiro),0), 
	coalesce(sum(vl_juros),0), 
	coalesce(sum(vl_multa),0) 
into STRICT	vl_negociado_w, 
	vl_desconto_w, 
	vl_acrescimo_w, 
	vl_terceiro_w, 
	vl_juros_cheque_w, 
	vl_multa_cheque_w 
from	cheque_cr_negociado 
where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p 
and	cd_moeda_empresa_w = coalesce(cd_moeda_p,cd_moeda_empresa_w);
 
select	coalesce(sum(vl_adiantamento),0), 
	coalesce(sum(vl_adto_estrang),0) 
into STRICT	vl_adiantamento_W, 
	vl_adto_estrang_w 
from	adiantamento 
where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p 
and	coalesce(cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_p,cd_moeda_empresa_w);
 
select	coalesce(sum(vl_adiantamento),0), 
	coalesce(sum(vl_adto_estrang),0) 
into STRICT	vl_adto_pago_w, 
	vl_adto_pago_estrang_w 
from	adiantamento_pago 
where	nr_seq_caixa_rec = nr_seq_caixa_rec_p 
and	coalesce(cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_p,cd_moeda_empresa_w);
 
/* Tratar valor de baixa por gratuidade */
 
select	coalesce(sum(coalesce(vl_recebido,0) + 
	coalesce(vl_juros,0) + 
	coalesce(vl_multa,0) + 
	coalesce(vl_despesa_bancaria,0) + 
	coalesce(vl_descontos,0) + 
	coalesce(vl_glosa,0)),0) 
into STRICT	vl_baixa_perda_w 
from	transacao_financeira b, 
	titulo_receber_liq a 
where	a.nr_seq_trans_caixa	= b.nr_sequencia 
and	b.ie_acao		= 18 
and	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p 
and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_p,cd_moeda_empresa_w);
 
select	coalesce(sum(vl_transacao),0), 
	coalesce(sum(vl_transacao_estrang),0) 
into STRICT	vl_transacao_w, 
	vl_transacao_estrang_w 
from	transacao_financeira b, 
	movto_trans_financ a 
where	a.nr_seq_trans_financ	= b.nr_sequencia 
and	b.ie_caixa		= 'D' 
and	coalesce(a.nr_seq_titulo_receber::text, '') = '' 
and	coalesce(a.nr_adiantamento::text, '') = '' 
and	nr_seq_caixa_rec	= nr_seq_caixa_rec_p 
and	coalesce(cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_p,cd_moeda_empresa_w);
 
/* Tratar pelo tipo de recebimento (Normal/Negociacao de cheque) */
 
if (ie_tipo_receb_w = 'R') then 
	vl_total_w	:= (vl_recebido_w + vl_juros_w + vl_multa_w + vl_desp_bancaria_w + 
				vl_descontos_w + vl_glosa_w + vl_outros_acrescimos_w + vl_rec_maior_w) + 
		 	vl_adiantamento_w + vl_transacao_w;
elsif (ie_tipo_receb_w = 'C') then 
	vl_total_w	:= (vl_negociado_w + vl_acrescimo_w + vl_terceiro_w + vl_juros_cheque_w + vl_multa_cheque_w);
end if;
 
if (ie_acao_w = '34') then --tratado para desconsiderar o valor do adiantamento 
	vl_total_w		:= (vl_recebido_w + vl_juros_w + vl_multa_w + vl_desp_bancaria_w + vl_descontos_w + vl_glosa_w + vl_outros_acrescimos_w + vl_rec_maior_w) + vl_transacao_w;
end if;
 
if (ie_opcao_p	= 'VE') then /* Valor espécie */
 
	vl_retorno_w	:= coalesce(vl_especie_w,0);
elsif (ie_opcao_p	= 'VEE') then /* Valor espécie estrang */
 
	vl_retorno_w	:= coalesce(vl_especie_estrang_w,0);
elsif (ie_opcao_p	= 'VCH') then /* Valor cheques */
 
	vl_retorno_w	:= vl_cheques_w;
elsif (ie_opcao_p	= 'VCHE') then /* Valor cheques_estrang */
 
	vl_retorno_w	:= coalesce(vl_cheques_estrang_w,0);
elsif (ie_opcao_p	= 'VCA') then /* Valor cartão */
 
	vl_retorno_w	:= vl_cartao_w;
elsif (ie_opcao_p	= 'VDO') then /* Valor documentos */
 
	vl_retorno_w	:= vl_total_w + vl_adto_pago_w;
elsif (ie_opcao_p	= 'VDOE') then /* Valor documentos estrang*/
 
	vl_retorno_w	:= coalesce(vl_recebido_estrang_w,0) + coalesce(vl_adto_estrang_w,0) + coalesce(vl_transacao_estrang_w,0) + coalesce(vl_adto_pago_estrang_w,0);
	if (ie_acao_w = '34') then 
		vl_retorno_w := coalesce(vl_recebido_estrang_w,0) + coalesce(vl_transacao_estrang_w,0);
	end if;
elsif (ie_opcao_p	= 'VT') then /* Valor total */
 
	vl_retorno_w	:= vl_especie_w + vl_cheques_w + vl_cartao_w;
elsif (ie_opcao_p	= 'VTE') then /* Valor total estrang*/
 
	vl_retorno_w	:= coalesce(vl_especie_estrang_w,0) + coalesce(vl_cheques_estrang_w,0);
end if;
 
return	vl_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valores_caixa_rec_estr ( nr_seq_caixa_rec_p bigint, cd_moeda_p bigint, ie_opcao_p text) FROM PUBLIC;

