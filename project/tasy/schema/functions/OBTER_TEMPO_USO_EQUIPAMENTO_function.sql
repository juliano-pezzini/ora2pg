-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tempo_uso_equipamento (nr_seq_agenda_p bigint, nr_seq_classif_equip_p bigint) RETURNS bigint AS $body$
DECLARE



qt_hora_w					bigint;
dt_inicial_w				timestamp;
dt_final_w					timestamp;
qt_tempo_esterilizacao_w	bigint := 0;
qt_min_fim_cirur_w			bigint;
qt_tempo_total_w			bigint;




BEGIN

select coalesce(obter_tempo_total_proced(nr_seq_proc_interno, cd_medico),0)
into STRICT	qt_tempo_total_w
from	agenda_paciente
where 	nr_sequencia = nr_seq_agenda_p;


select	coalesce(max(qt_tempo_esterelizacao),0),
		coalesce(max(qt_min_fim_cirur),0)
into STRICT	qt_tempo_esterilizacao_w,
		qt_min_fim_cirur_w
from	classif_equipamento
where	nr_sequencia = nr_seq_classif_equip_p;


if (qt_min_fim_cirur_w = 0) then
	select	hr_inicio,
			hr_inicio + ((coalesce(qt_tempo_total_w, nr_minuto_duracao) + coalesce(qt_tempo_esterilizacao_w,0)) / 1440)
	into STRICT	dt_inicial_w,
			dt_final_w
	from	agenda_paciente
	where	nr_sequencia	= nr_seq_agenda_p;
else
	select	hr_inicio + ((coalesce(qt_tempo_total_w, nr_minuto_duracao) + coalesce(qt_tempo_esterilizacao_w,0)) / 1440) - (qt_min_fim_cirur_w/1440),
			hr_inicio + ((coalesce(qt_tempo_total_w, nr_minuto_duracao) + coalesce(qt_tempo_esterilizacao_w,0)) / 1440) - (1/86400)
	into STRICT	dt_inicial_w,
			dt_final_w
	from	agenda_paciente
	where	nr_sequencia	= nr_seq_agenda_p;
end if;


qt_hora_w := obter_dif_data(dt_inicial_w,dt_final_w,'TM')/60;

return	qt_hora_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tempo_uso_equipamento (nr_seq_agenda_p bigint, nr_seq_classif_equip_p bigint) FROM PUBLIC;

