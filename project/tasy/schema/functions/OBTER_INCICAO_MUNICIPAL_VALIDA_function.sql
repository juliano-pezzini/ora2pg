-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE tvetor AS (tvetor smallint[11]);


CREATE OR REPLACE FUNCTION obter_incicao_municipal_valida ( nr_inscricao_estadual_p text, sg_estado_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(255);
nr_inscricao_estadual_w		pessoa_juridica.nr_inscricao_estadual%type;


function valida_insc_munic_mg(	nr_inscricao_estadual_p		text)
 		    	return text is

ds_retorno_w			varchar(255);
vl_total_w			bigint;
vl_valor_conta_w		bigint;
vl_multiplicador_w		bigint;
vl_primeiro_digito_w		bigint;
vl_segundo_digito_w		bigint;

vetor_digito tvetor := tvetor(0,0,0,0,0,0,0,0,0,0,0);
BEGIN

FOR i in 1..11 loop
	begin

	vetor_digito(i) := substr(nr_inscricao_estadual_p, i, 1);

	end;
end loop;

vl_total_w:= 0;
vl_multiplicador_w:= 1;

for i in 1..vetor_digito.count loop
	begin

	vl_valor_conta_w:= vetor_digito(i) * vl_multiplicador_w;

	if (length(vl_valor_conta_w) > 1) then
		vl_total_w:= vl_total_w + substr(vl_valor_conta_w, 1, 1) + substr(vl_valor_conta_w, 2, 1);
	else
		vl_total_w:= vl_total_w + vl_valor_conta_w;
	end if;

	if (i <> 3) then
		if (vl_multiplicador_w = 1) then
			vl_multiplicador_w:= 2;
		else
			vl_multiplicador_w:= 1;
		end if;
	end if;
	end;
end loop;

vl_primeiro_digito_w:= (trunc(vl_total_w, -1) + 10) - vl_total_w;

if (vl_primeiro_digito_w >= 10 ) then
	vl_primeiro_digito_w:= 0;
end if;

vl_total_w:= 0;
vl_multiplicador_w:= 2;

vl_total_w:= vl_primeiro_digito_w * vl_multiplicador_w;

vl_multiplicador_w:= 3;

for i IN REVERSE vetor_digito.count..1 loop
	begin
	vl_valor_conta_w:= vetor_digito(i) * vl_multiplicador_w;
	vl_total_w	:= vl_total_w + vl_valor_conta_w;

	if (vl_multiplicador_w = 11) then
		vl_multiplicador_w:= 2;
	else
		vl_multiplicador_w:=	vl_multiplicador_w + 1;
	end if;

	end;
end loop;

if (mod(vl_total_w, 11) = 1) or (mod(vl_total_w, 11) = 0) then
	vl_segundo_digito_w:= 0;
else
	vl_segundo_digito_w:= 11 - mod(vl_total_w, 11);
end if;

ds_retorno_w:= 'N';
if	((substr(nr_inscricao_estadual_p, length(nr_inscricao_estadual_p) - 1, 1) = vl_primeiro_digito_w) and
	((substr(nr_inscricao_estadual_p, length(nr_inscricao_estadual_p), 1)) = vl_segundo_digito_w)) then
	ds_retorno_w:= 'S';
end if;

return	ds_retorno_w;

end;

begin

nr_inscricao_estadual_w:= replace(replace(nr_inscricao_estadual_p, '/', ''), '.', '');


if (coalesce(upper(nr_inscricao_estadual_w), upper('ISENTO')) = 'ISENTO') then
	ds_retorno_w:=	'S';
else
	begin

	case upper(sg_estado_p)
	when 'MG' then
	ds_retorno_w := valida_insc_munic_mg(nr_inscricao_estadual_w);
	else
	ds_retorno_w := 'S';
	end case;

	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_incicao_municipal_valida ( nr_inscricao_estadual_p text, sg_estado_p text) FROM PUBLIC;

