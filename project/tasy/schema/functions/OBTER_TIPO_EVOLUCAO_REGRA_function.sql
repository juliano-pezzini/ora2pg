-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tipo_evolucao_regra ( nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
cd_setor_atendimento_w		bigint;
ie_tipo_atendimento_w		bigint;
ie_clinica_w			varchar(100);
cd_tipo_evolucao_w		varchar(10);
qt_evolucao_atend_w		bigint;
ie_regra_w			varchar(3);
ie_regra_aux_w		varchar(3);
nm_usuario_w			varchar(15);
ie_tipo_evolucao_w		varchar(3);
cd_medico_resp_w		varchar(10);
qt_evolucao_medico_w		bigint;
qt_setor_internacao_w		bigint;

c01 CURSOR FOR	 
	SELECT	cd_tipo_evolucao 
	from	regra_tipo_evolucao 
	where	ie_regra 						= ie_regra_w 
	and	coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w)		= ie_tipo_atendimento_w 
	and	coalesce(ie_clinica,ie_clinica_w)				= ie_clinica_w 
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w 
	and	coalesce(cd_perfil,obter_perfil_ativo)			= obter_perfil_ativo 
	and	coalesce(ie_tipo_evolucao,ie_tipo_evolucao_w)		= ie_tipo_evolucao_w 
	and	ie_situacao						= 'A' 
	order by	coalesce(ie_tipo_atendimento,0), 
			coalesce(cd_setor_atendimento,0), 
			coalesce(ie_clinica,0), 
			coalesce(cd_perfil,0), 
			coalesce(ie_tipo_evolucao,' ');


BEGIN 
begin 
cd_setor_atendimento_w	:=	obter_setor_atendimento(nr_atendimento_p);
exception 
when others then 
	cd_setor_atendimento_w	:=	0;
end;
 
nm_usuario_w		:= wheb_usuario_pck.get_nm_usuario;
ie_tipo_evolucao_w	:= Obter_Dados_Usuario_Opcao(nm_usuario_w,'F');
 
select	coalesce(max(ie_tipo_atendimento),0), 
	coalesce(max(ie_clinica),0), 
	coalesce(max(cd_medico_resp),'') 
into STRICT	ie_tipo_atendimento_w, 
	ie_clinica_w, 
	cd_medico_resp_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_p;
 
select	count(*) 
into STRICT	qt_evolucao_atend_w 
from	evolucao_paciente 
where	nr_atendimento = nr_atendimento_p 
and	coalesce(dt_inativacao::text, '') = '';
 
ie_regra_w	:=	'E';
if (qt_evolucao_atend_w = 0) then 
	ie_regra_w	:=	'P';
end if;
 
if (ie_regra_w <> 'P') then 
	select	count(*) 
	into STRICT	qt_evolucao_atend_w 
	from	evolucao_paciente 
	where	nr_atendimento = nr_atendimento_p 
	and	ie_tipo_evolucao = ie_tipo_evolucao_w 
	and	coalesce(dt_inativacao::text, '') = '' 
	and	coalesce(nr_atend_alta::text, '') = '';
	 
	if (qt_evolucao_atend_w = 0) then 
		ie_regra_w	:=	'PF';
	end if;
	if (qt_evolucao_atend_w = 1) then 
		ie_regra_w	:=	'SF';
	end if;
	if (qt_evolucao_atend_w = 2) then 
		ie_regra_w	:=	'TF';
	end if;
	 
	select 	count(*) 
	into STRICT	qt_evolucao_medico_w 
	from	evolucao_paciente 
	where	cd_medico = cd_medico_resp_w 
	and	nr_atendimento = nr_atendimento_p 
	and	coalesce(dt_inativacao::text, '') = '';
 
	if (qt_evolucao_medico_w = 0 ) and (cd_medico_resp_w	= Obter_Dados_Usuario_Opcao(nm_usuario_w,'C'))then 
		ie_regra_w	:= 	'PR';
	end if;
		 
end if;
 
open C01;
loop 
fetch C01 into	 
	cd_tipo_evolucao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;
 
if (coalesce(cd_tipo_evolucao_w::text, '') = '') and (ie_regra_w = 'PR') then 
	begin 
	select	count(*) 
	into STRICT	qt_evolucao_atend_w 
	from	evolucao_paciente 
	where	nr_atendimento = nr_atendimento_p 
	and	ie_tipo_evolucao = ie_tipo_evolucao_w 
	and	coalesce(nr_atend_alta::text, '') = '' 
	and	coalesce(dt_inativacao::text, '') = '';
	 
	if (qt_evolucao_atend_w = 0) then 
		ie_regra_w	:=	'PF';
	end if;
	if (qt_evolucao_atend_w = 1) then 
		ie_regra_w	:=	'SF';
	end if;
	if (qt_evolucao_atend_w = 2) then 
		ie_regra_w	:=	'TF';
	end if;
	open C01;
	loop 
	fetch C01 into	 
		cd_tipo_evolucao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;
	end;
end if;
 
if (coalesce(cd_tipo_evolucao_w::text, '') = '') and 
	((ie_regra_w = 'P') or (ie_regra_w =	'PF') or (ie_regra_w ='SF') or (ie_regra_w = 'TF')) then 
 
	ie_regra_aux_w	:= ie_regra_w;
	 
	 
	select 	max(1) 
	into STRICT	qt_setor_internacao_w 
	from	setor_atendimento 
	where	cd_setor_atendimento = cd_setor_atendimento_w 
	and	cd_classif_setor in (3,4,8);
 
	if (qt_setor_internacao_w > 0) then 
 
		select 	count(*) 
		into STRICT 	qt_setor_internacao_w 
		from	evolucao_paciente    e,	 
        atendimento_paciente  p, 
        atend_paciente_unidade u 
		where	e.nr_atendimento    = p.nr_atendimento 
		and	  p.nr_atendimento    = u.nr_atendimento 
		and	  p.nr_atendimento    = nr_atendimento_p 
		and	  e.cd_setor_atendimento = cd_setor_atendimento_w 
		and	  e.ie_tipo_evolucao   = ie_tipo_evolucao_w 
		and	e.dt_evolucao between u.dt_entrada_unidade and clock_timestamp();
 
		if (coalesce(qt_setor_internacao_w,0) = 0) then 
			ie_regra_w	:= 	'PI';
			 
			open C01;
			loop 
			fetch C01 into	 
				cd_tipo_evolucao_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
			end loop;
			close C01;			
			 
		end if;
	end if;	
	 
	 
 
	if (coalesce(cd_tipo_evolucao_w::text, '') = '') then 
		ie_regra_w	:= ie_regra_aux_w;
	end if;
end if;
 
if (coalesce(cd_tipo_evolucao_w::text, '') = '') and (ie_regra_w = 'P') then 
	ie_regra_w	:=	'PF';
	open C01;
	loop 
	fetch C01 into	 
		cd_tipo_evolucao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;
	if (coalesce(cd_tipo_evolucao_w::text, '') = '') then 
		ie_regra_w	:= 'P';
	end if;
end if;
 
if (coalesce(cd_tipo_evolucao_w::text, '') = '') and (ie_regra_w = 'P') then 
	 
	select 	count(*) 
	into STRICT	qt_evolucao_medico_w 
	from	evolucao_paciente 
	where	cd_medico = cd_medico_resp_w 
	and	nr_atendimento = nr_atendimento_p 
	and	coalesce(dt_inativacao::text, '') = '';
 
	if (qt_evolucao_medico_w = 0) and (cd_medico_resp_w	= Obter_Dados_Usuario_Opcao(nm_usuario_w,'C')) then 
		ie_regra_w	:= 	'PR';
		open C01;
		loop 
		fetch C01 into	 
			cd_tipo_evolucao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		end loop;
		close C01;
	if (coalesce(cd_tipo_evolucao_w::text, '') = '') then 
		ie_regra_w	:= 'P';
	end if;
	end if;
end if;
 
if (coalesce(cd_tipo_evolucao_w::text, '') = '') and (ie_regra_w = 'P') then 
	 
	select	count(*) 
	into STRICT	qt_evolucao_atend_w 
	from	evolucao_paciente 
	where	nr_atendimento = nr_atendimento_p 
	and	coalesce(dt_inativacao::text, '') = '';
	 
	if (qt_evolucao_atend_w = 0) then 
		ie_regra_w	:= 'A';
		open C01;
		loop 
		fetch C01 into 
			cd_tipo_evolucao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		end loop;
		close C01;
		 
		if (coalesce(cd_tipo_evolucao_w::text, '') = '') then 
			ie_regra_w	:= 'P';
		end if;
	end if;
end if;
 
if (coalesce(cd_tipo_evolucao_w::text, '') = '') and (ie_regra_w <> 'E') then 
	ie_regra_w	:=	'E';
	open C01;
	loop 
	fetch C01 into	 
		cd_tipo_evolucao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;
end if;
 
	 
 
 
return cd_tipo_evolucao_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tipo_evolucao_regra ( nr_atendimento_p bigint) FROM PUBLIC;

