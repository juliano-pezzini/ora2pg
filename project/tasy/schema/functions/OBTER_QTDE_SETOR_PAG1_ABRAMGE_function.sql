-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qtde_setor_pag1_abramge (nr_interno_conta_p bigint) RETURNS bigint AS $body$
DECLARE

 
qt_setores_pag_1_w	bigint;


BEGIN 
 
qt_setores_pag_1_w := 0;
 
 
select count(distinct cd_setor_atendimento) 
into STRICT	qt_setores_pag_1_w 
from 	( 
	SELECT y.*, 
		row_number() OVER () AS item 
	from 	( 
		SELECT -1, 
			CASE WHEN a.cd_grupo_item=5 THEN 4  ELSE a.cd_grupo_item END , 
			a.DT_ITEM, 
			CASE WHEN b.cd_convenio_parametro=69 THEN replace(replace(a.ds_item,'custo oper - ', ''),'Filme - ','')  ELSE a.ds_item END ds_item, 
			a.IE_EME, 
			a.IE_DHE, 
			Obter_Funcao_Medico_Abramge(somente_numero(a.IE_FUNCAO_MEDICO)) ie_fun_med, 
			a.CD_ITEM, 
			a.cd_setor_atendimento 
		from	conta_paciente b,w_conta_abramge_item a 
		where 	a.nr_interno_conta = nr_interno_conta_p 
		and 	a.nr_interno_conta = b.nr_interno_conta 
		and 	b.cd_convenio_parametro = 69 
		and 	((ie_tipo_item = 1) or ((upper(ds_item) like '%FILME%') and (ie_tipo_item = 2) and (cd_grupo_item = '5'))) 
		and	vl_item > 0 
		group by CASE WHEN a.cd_grupo_item=5 THEN 4  ELSE a.cd_grupo_item END , 
			a.DT_ITEM, 
			CASE WHEN b.cd_convenio_parametro=69 THEN replace(replace(a.ds_item,'custo oper - ', ''),'Filme - ','')  ELSE a.ds_item END , 
			a.IE_EME, 
			a.IE_DHE, 
			somente_numero(a.IE_FUNCAO_MEDICO), 
			a.CD_ITEM, 
			a.cd_setor_atendimento 
		
union all
	 
		select	0, 
			a.cd_grupo_item, 
			a.DT_ITEM, 
			a.ds_item, 
			a.IE_EME, 
			a.IE_DHE, 
			Obter_Funcao_Medico_Abramge(somente_numero(a.IE_FUNCAO_MEDICO))ie_fun_med, 
			a.CD_ITEM, 
			a.cd_setor_atendimento 
		from	conta_paciente b,w_conta_abramge_item a 
		where	a.nr_interno_conta = nr_interno_conta_p 
		and 	a.nr_interno_conta = b.nr_interno_conta 
		and 	b.cd_convenio_parametro <> 69 
		and (ie_tipo_item = 1) 
		and	vl_item > 0 
		group by a.cd_grupo_item, 
			a.DT_ITEM, 
			a.ds_item, 
			a.IE_EME, 
			a.IE_DHE, 
			Obter_Funcao_Medico_Abramge(somente_numero(a.IE_FUNCAO_MEDICO)), 
			a.CD_ITEM, 
			a.cd_setor_atendimento 
		order by 1,2,3,4) y LIMIT 33) alias21;
 
RETURN qt_setores_pag_1_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qtde_setor_pag1_abramge (nr_interno_conta_p bigint) FROM PUBLIC;

