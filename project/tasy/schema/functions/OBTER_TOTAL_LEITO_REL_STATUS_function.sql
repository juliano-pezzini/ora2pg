-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_total_leito_rel_status (cd_estabelecimento_p bigint, nm_usuario_cor_p text, ie_todos_estab_p text, ie_status_p text) RETURNS bigint AS $body$
DECLARE

 
cd_setor_atend_w	bigint;
qt_w			bigint;
qt_aux_w		bigint;

C01 CURSOR FOR 
	SELECT	cd_setor_atendimento 
	from	ocupacao_setores_v 
	where	ie_ocup_hospitalar = 'S' 
	and	obter_se_exibe_estab(	cd_estabelecimento_base, 
					cd_estabelecimento_p, 
					nm_usuario_cor_p, 
					ie_todos_estab_p) = 'S';


BEGIN 
 
qt_w := 0;
qt_aux_w := 0;
open C01;
loop 
fetch C01 into	 
	cd_setor_atend_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	 
	if (ie_status_p = 'O') then 
		 
		begin 
			select	count(*) 
			into STRICT	qt_aux_w 
			from	unidade_atendimento 
			where	cd_setor_atendimento = cd_setor_atend_w 
			and	ie_status_unidade in ('A', 'P', 'M');
		exception 
			when 	others then 
				qt_aux_w := 0;
		end;
		 
	elsif (ie_status_p = 'L') then 
		 
		begin 
			select	count(*) 
			into STRICT	qt_aux_w 
			from	unidade_atendimento 
			where	cd_setor_atendimento = cd_setor_atend_w 
			and	ie_status_unidade in ('L');
		exception 
			when 	others then 
				qt_aux_w := 0;
		end;
	else 
		qt_aux_w := 0;
	end if;
	 
	qt_w := qt_w + qt_aux_w;
	 
end loop;
close C01;
 
return	qt_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_total_leito_rel_status (cd_estabelecimento_p bigint, nm_usuario_cor_p text, ie_todos_estab_p text, ie_status_p text) FROM PUBLIC;

