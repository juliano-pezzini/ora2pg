-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_convenio_tipo_pj (NR_ATENDIMENTO_P bigint) RETURNS bigint AS $body$
DECLARE


NR_SEQ_TIPO_W EPISODIO_PACIENTE.NR_SEQ_TIPO_EPISODIO%TYPE;

IE_TIPO_W TIPO_EPISODIO.IE_TIPO%TYPE;

CD_TIPO_EMPRESA_W PESSOA_JURIDICA.CD_TIPO_PESSOA%TYPE;

CD_PESSOA_FISICA_W EPISODIO_PACIENTE.CD_PESSOA_FISICA%TYPE;

CD_CGC_W COMPL_PESSOA_FISICA.CD_CGC%TYPE;

CD_CONVENIO_W CONVENIO_EMPRESA.CD_CONVENIO%TYPE := 0;

CD_CONVENIO_AUX_W CONVENIO_EMPRESA.CD_CONVENIO%TYPE;

NR_TIPO_ADMISSAO_FAT_W TIPO_ADMISSAO_FAT.NR_SEQUENCIA%TYPE;



BEGIN



  IF (NR_ATENDIMENTO_P IS NOT NULL AND NR_ATENDIMENTO_P::text <> '') THEN

    SELECT  MAX(E.NR_SEQ_TIPO_EPISODIO),

      MAX(E.CD_PESSOA_FISICA),
      MAX(A.NR_SEQ_TIPO_ADMISSAO_FAT)

      INTO STRICT NR_SEQ_TIPO_W,

        CD_PESSOA_FISICA_W,
        
       NR_TIPO_ADMISSAO_FAT_W         

    FROM EPISODIO_PACIENTE E,

    ATENDIMENTO_PACIENTE A     

    WHERE E.NR_SEQUENCIA = A.NR_SEQ_EPISODIO

    AND A.NR_ATENDIMENTO = NR_ATENDIMENTO_P;



    SELECT MAX(T.IE_TIPO)

      INTO STRICT IE_TIPO_W

    FROM TIPO_EPISODIO T

    WHERE T.NR_SEQUENCIA = NR_SEQ_TIPO_W;



    IF (IE_TIPO_W = 8) THEN --OUTPATIENT
      select	max(pfe.cd_cgc)
      into STRICT	cd_cgc_w
      from	pessoa_fisica_empregador pfe,
		atendimento_paciente ap
      where 	pfe.cd_pessoa_fisica = cd_pessoa_fisica_w
      and 	pfe.cd_pessoa_fisica = ap.cd_pessoa_fisica
      and	ap.nr_atendimento = nr_atendimento_p
       and	((ap.dt_entrada between pfe.dt_inicio_trabalho and pfe.dt_fim_trabalho) or (ap.dt_entrada >= pfe.dt_inicio_trabalho and coalesce(pfe.dt_fim_trabalho::text, '') = ''));


      IF (CD_CGC_W IS NOT NULL AND CD_CGC_W::text <> '') THEN 

        SELECT MAX(J.CD_TIPO_PESSOA)

            INTO STRICT CD_TIPO_EMPRESA_W

        FROM PESSOA_JURIDICA J

        WHERE J.CD_CGC = CD_CGC_W;


        SELECT MAX(CE.CD_CONVENIO)

          INTO STRICT CD_CONVENIO_AUX_W 

        FROM CONVENIO_EMPRESA CE

        WHERE CE.CD_TIPO_PESSOA = CD_TIPO_EMPRESA_W

        AND CE.NR_SEQ_TIPO_ADMISSAO_FAT = NR_TIPO_ADMISSAO_FAT_W;


        IF (CD_CONVENIO_AUX_W IS NOT NULL AND CD_CONVENIO_AUX_W::text <> '') THEN

          CD_CONVENIO_W := CD_CONVENIO_AUX_W;

        END IF;


      END IF;

    END IF;

  END IF;

  RETURN CD_CONVENIO_W;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_convenio_tipo_pj (NR_ATENDIMENTO_P bigint) FROM PUBLIC;

