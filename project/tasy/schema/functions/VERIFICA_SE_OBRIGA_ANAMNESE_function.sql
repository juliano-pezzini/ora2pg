-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION verifica_se_obriga_anamnese (nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE

 
ie_obriga_w			varchar(1);			
cd_convenio_w			integer;
ie_tipo_atendimento_w		integer;
ie_geral_w			varchar(1);
			

BEGIN 
 
select	max(a.ie_tipo_atendimento), 
	Obter_Convenio_Atendimento(max(a.nr_atendimento)) 
into STRICT	ie_tipo_atendimento_w, 
	cd_convenio_w	 
from	prescr_medica b, 
	atendimento_paciente a 
where	a.nr_atendimento = b.nr_atendimento 
and	b.nr_prescricao = nr_prescricao_p;
 
select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
into STRICT	ie_geral_w 
from	regra_obriga_anamnese 
where	coalesce(cd_convenio::text, '') = '' 
and	coalesce(ie_tipo_atendimento::text, '') = '';
 
if (ie_geral_w = 'S') then 
	select	max(ie_consistir) 
	into STRICT	ie_obriga_w 
	from	regra_obriga_anamnese 
	where	coalesce(cd_convenio::text, '') = '' 
	and	coalesce(ie_tipo_atendimento::text, '') = '';
else 
	select	coalesce(max(ie_consistir),'N') 
	into STRICT	ie_obriga_w 
	from	regra_obriga_anamnese 
	where	((cd_convenio = cd_convenio_w) or (coalesce(cd_convenio::text, '') = '')) 
	and	((ie_tipo_atendimento = ie_tipo_atendimento_w) or (coalesce(ie_tipo_atendimento::text, '') = ''));
end if;
 
return	ie_obriga_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION verifica_se_obriga_anamnese (nr_prescricao_p bigint) FROM PUBLIC;

