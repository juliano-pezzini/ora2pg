-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_regra_sla ( cd_estabelecimento_p bigint, nm_usuario_p text, ie_prioridade_p text, ie_classificacao_p text, nr_seq_localizacao_p bigint, nr_seq_grupo_trab_p bigint, dt_ordem_servico_p timestamp, dt_inicio_p timestamp, nr_seq_estagio_p bigint, nr_seq_equipamento_p bigint, nr_seq_classif_p bigint, ie_parado_p text) RETURNS bigint AS $body$
DECLARE


qt_min_inicio_w		bigint;
qt_min_termino_w		bigint;
nr_seq_sla_w		bigint;
ie_tempo_w		varchar(15);
nr_seq_estagio_w		bigint;
nr_seq_tipo_equip_w	bigint;
nr_seq_tipo_equip_ww	bigint;
nr_seq_equipamento_w	bigint;
ie_utiliza_sla_w		varchar(255) := obter_valor_param_usuario(299,57,wheb_usuario_pck.get_cd_perfil,coalesce(nm_usuario_p,wheb_usuario_pck.get_nm_usuario),wheb_usuario_pck.get_cd_estabelecimento);

C01 CURSOR FOR
SELECT	b.nr_sequencia,
	b.qt_min_inicio,
	b.qt_min_termino,
	b.ie_tempo,
	b.nr_seq_estagio,
	b.nr_seq_equipamento,
	b.nr_seq_tipo_equipamento
FROM man_sla_regra b, man_sla a
LEFT OUTER JOIN man_sla_loc c ON (a.nr_sequencia = c.nr_seq_sla)
WHERE a.nr_sequencia					= b.nr_seq_sla  and a.dt_vigencia					<= clock_timestamp() and coalesce(c.nr_seq_local,nr_seq_localizacao_p)	= nr_seq_localizacao_p and coalesce(a.nr_seq_grupo_trab, coalesce(nr_seq_grupo_trab_p,0)) 	= coalesce(nr_seq_grupo_trab_p,0) and b.ie_classificacao					= ie_classificacao_p and coalesce(ie_prioridade,ie_prioridade_p)			= ie_prioridade_p and coalesce(nr_seq_estagio, coalesce(nr_seq_estagio_p,0)) 		= coalesce(nr_seq_estagio_p,0) and coalesce(nr_seq_classif, coalesce(nr_seq_classif_p,0)) 		= coalesce(nr_seq_classif_p,0) and coalesce(nr_seq_equipamento, coalesce(nr_seq_equipamento_p,0)) 	= coalesce(nr_seq_equipamento_p,0) and coalesce(nr_seq_tipo_equipamento, coalesce(nr_seq_tipo_equip_w,0)) 	= coalesce(nr_seq_tipo_equip_w,0) and coalesce(b.ie_parado, coalesce(ie_parado_p,'X'))			= coalesce(ie_parado_p,'X') and coalesce(a.ie_situacao,'A')				= 'A' and ((c.nr_seq_local IS NOT NULL AND c.nr_seq_local::text <> '') or ie_utiliza_sla_w = 'L') order by coalesce(ie_prioridade,' '),
        c.nr_seq_sla,
        CASE WHEN ie_utiliza_sla_w='l' THEN  ''  ELSE c.nr_seq_local END  desc,
        a.nr_seq_grupo_trab desc,
        b.nr_seq_equipamento desc,
        b.nr_seq_estagio desc,
        b.nr_seq_classif desc,
        b.nr_seq_tipo_equipamento desc,
        b.ie_parado desc,
        c.nr_seq_local desc;


BEGIN

select	coalesce(max(nr_seq_tipo_equip),0)
into STRICT	nr_seq_tipo_equip_w
from	man_equipamento
where	nr_sequencia = nr_seq_equipamento_p;


open C01;
loop
fetch C01 into
	nr_seq_sla_w,
	qt_min_inicio_w,
	qt_min_termino_w,
	ie_tempo_w,
	nr_seq_estagio_w,
	nr_seq_equipamento_w,
	nr_seq_tipo_equip_ww;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;

return	nr_seq_sla_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_regra_sla ( cd_estabelecimento_p bigint, nm_usuario_p text, ie_prioridade_p text, ie_classificacao_p text, nr_seq_localizacao_p bigint, nr_seq_grupo_trab_p bigint, dt_ordem_servico_p timestamp, dt_inicio_p timestamp, nr_seq_estagio_p bigint, nr_seq_equipamento_p bigint, nr_seq_classif_p bigint, ie_parado_p text) FROM PUBLIC;

