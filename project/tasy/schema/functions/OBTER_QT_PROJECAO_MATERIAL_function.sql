-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_projecao_material ( cd_estabelecimento_p bigint, cd_material_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/*ie_opcao_p
PMA - Projeção Mes Atual
PA - Projeção ajustada*/
qt_resultado_w			double precision := 0;
qt_media_diaria_w		double precision := 0;
qt_consumo_3_meses_w		double precision := 0;
qt_consumo_mes_atual_w		double precision := 0;
nr_ultimo_dia_mes_w		double precision := 0;
nr_dia_atual_w			double precision := 0;


BEGIN

if (ie_opcao_p = 'PMA') then

	select	coalesce(obter_cons_medio_diario_mat('QDA', cd_estabelecimento_p, null, cd_material_p,null,null,null),0)
	into STRICT	qt_media_diaria_w
	;

	qt_resultado_w := (qt_media_diaria_w * 30);

	if (qt_resultado_w <= 0) then

		select (sum(CASE WHEN dt_mesano_referencia=PKG_DATE_UTILS.ADD_MONTH(PKG_DATE_UTILS.start_of(clock_timestamp(),'mm', 0), - 3, 0) THEN  coalesce(qt_consumo,0)  ELSE 0 END ) +
			 sum(CASE WHEN dt_mesano_referencia=PKG_DATE_UTILS.ADD_MONTH(PKG_DATE_UTILS.start_of(clock_timestamp(),'mm', 0), - 2, 0) THEN  coalesce(qt_consumo,0)  ELSE 0 END ) +
			 sum(CASE WHEN dt_mesano_referencia=PKG_DATE_UTILS.ADD_MONTH(PKG_DATE_UTILS.start_of(clock_timestamp(),'mm', 0), - 1, 0) THEN  coalesce(qt_consumo,0)  ELSE 0 END )) qt_consumo_3_meses
		into STRICT	qt_consumo_3_meses_w
		from 	movto_estoque_operacao_v
		where	cd_estabelecimento = cd_estabelecimento_p
		and 	cd_material = cd_material_p
		and	dt_mesano_referencia between PKG_DATE_UTILS.ADD_MONTH(PKG_DATE_UTILS.start_of(clock_timestamp(),'mm', 0), - 3, 0) and pkg_date_utils.start_of(clock_timestamp(), 'MONTH', 0);

		qt_resultado_w := dividir(qt_consumo_3_meses_w, 3);
	end if;
end if;

if (ie_opcao_p = 'PA') then

	select	sum(CASE WHEN dt_mesano_referencia=PKG_DATE_UTILS.ADD_MONTH(PKG_DATE_UTILS.start_of(clock_timestamp(),'mm', 0), 0, 0) THEN  coalesce(qt_consumo,0)  ELSE 0 END )
	into STRICT	qt_consumo_mes_atual_w
	from 	movto_estoque_operacao_v
	where	cd_estabelecimento = cd_estabelecimento_p
	and 	cd_material = cd_material_p
	and	dt_mesano_referencia = pkg_date_utils.start_of(clock_timestamp(), 'MONTH', 0);

	nr_ultimo_dia_mes_w	:= (substr(pkg_date_utils.end_of(clock_timestamp(), 'MONTH', 0),1,2))::numeric;
	nr_dia_atual_w		:= (substr(clock_timestamp(),1,2))::numeric;

	qt_resultado_w		:= dividir((qt_consumo_mes_atual_w * nr_ultimo_dia_mes_w),nr_dia_atual_w);
end if;

return	qt_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_projecao_material ( cd_estabelecimento_p bigint, cd_material_p bigint, ie_opcao_p text) FROM PUBLIC;

