-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_auditoria_item ( nr_sequencia_p bigint, ie_procmat_p text) RETURNS bigint AS $body$
DECLARE



vl_item_w		double precision;
vl_total_w		double precision:=0;
qt_ajuste_w		auditoria_matpaci.qt_ajuste%type;
qt_original_w		auditoria_matpaci.qt_original%type;
qt_dif_w		double precision;
ie_tipo_w		smallint;

vl_preco_w		double precision;
vl_unitario_w		double precision;
nr_interno_conta_w	bigint;

tx_proc_original_w	double precision;
tx_proc_ajuste_w	double precision;
tx_dif_w		double precision;
ie_tipo_auditoria_w	varchar(1);
ie_tipo_item_w		varchar(1);
nr_seq_audit_ext_w	bigint;
nr_seq_item_w		bigint;
nr_sequencia_w		bigint;

qt_procedimento_w	bigint;

c01 CURSOR FOR
	SELECT	coalesce(a.vl_material,0),
			b.qt_ajuste,
			b.qt_original,
			1,
			a.vl_unitario,
			null,
			null,
			'I',
			null,
			null
	from	material_atend_paciente a,
			auditoria_matpaci b
	where	a.nr_sequencia	    = b.nr_seq_matpaci
	and		a.nr_sequencia		= nr_sequencia_p
	and		coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and		coalesce(a.nr_seq_proc_pacote,0)	<> a.nr_sequencia
	and		ie_procmat_p = 2
	
union all

	SELECT	coalesce(a.vl_procedimento,0),
			b.qt_ajuste,
			b.qt_original,
			2,
			null,
			b.tx_proc_original,
			b.tx_proc_ajuste,
			'I',
			null,
			null
	from	procedimento_paciente a,
			auditoria_propaci b
	where	a.nr_sequencia	    = b.nr_seq_propaci
	and		a.nr_sequencia		= nr_sequencia_p
	and		coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and		ie_procmat_p = 1
	and		coalesce(a.nr_seq_proc_pacote,0)	<> a.nr_sequencia;



BEGIN

open C01;
loop
fetch C01 into
	vl_item_w,
	qt_ajuste_w,
	qt_original_w,
	ie_tipo_w,
	vl_unitario_w,
	tx_proc_original_w,
	tx_proc_ajuste_w,
	ie_tipo_auditoria_w,
	nr_seq_audit_ext_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ie_tipo_auditoria_w = 'I') then -- Auditoria Interna
		if (qt_ajuste_w IS NOT NULL AND qt_ajuste_w::text <> '') then
			qt_dif_w:= qt_ajuste_w - qt_original_w;

			if (ie_tipo_w = 1) then

				vl_total_w	:=   (vl_unitario_w * qt_dif_w);

			elsif (ie_tipo_w = 2) then

				vl_preco_w	:=  dividir(vl_item_w, qt_original_w);
				vl_total_w	:=  (vl_preco_w * qt_dif_w);

			end if;

		elsif (tx_proc_ajuste_w IS NOT NULL AND tx_proc_ajuste_w::text <> '') then
			tx_dif_w:= tx_proc_ajuste_w - tx_proc_original_w;

			vl_total_w:=  (vl_item_w * tx_dif_w / 100);
		end if;

	end if;

	end;
end loop;
close C01;

return	vl_total_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_auditoria_item ( nr_sequencia_p bigint, ie_procmat_p text) FROM PUBLIC;

