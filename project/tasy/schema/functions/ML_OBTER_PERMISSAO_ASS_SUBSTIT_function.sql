-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ml_obter_permissao_ass_substit ( nm_usuario_resp_p usuario.nm_usuario%type, nm_usuario_substit_p usuario.nm_usuario%type) RETURNS varchar AS $body$
DECLARE

ds_retorno_w			varchar(1) := 'N';
cd_medico_w				usuario.cd_pessoa_fisica%type;
cd_medico_subst_w		usuario.cd_pessoa_fisica%type;


BEGIN
if (nm_usuario_resp_p IS NOT NULL AND nm_usuario_resp_p::text <> '' AND nm_usuario_substit_p IS NOT NULL AND nm_usuario_substit_p::text <> '') then
    cd_medico_w := obter_pessoa_fisica_usuario(nm_usuario_resp_p, 'C');
    cd_medico_subst_w := obter_pessoa_fisica_usuario(nm_usuario_substit_p, 'C');
	
    begin
    if (ds_retorno_w <> 'S') then
        select coalesce(max('S'),'N')
        into STRICT	ds_retorno_w
        from medico_carta_medica a, medico_carta_medica_subst c
        where not exists    (SELECT b.nr_seq_medico_carta_medica 
                            from medico_carta_medica_permit b 
                            where b.nr_seq_medico_carta_medica = a.nr_sequencia
                            and		b.ie_situacao = 'A'
                            and 	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
                            and    	(((dt_inicio IS NOT NULL AND dt_inicio::text <> '') and (dt_fim IS NOT NULL AND dt_fim::text <> '') and clock_timestamp() between dt_inicio and dt_fim) or coalesce(dt_inicio::text, '') = '' and coalesce(dt_fim::text, '') = ''))
        and a.cd_medico = cd_medico_w
        and c.cd_pessoa_fisica = cd_medico_subst_w
        and (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
        and c.ie_situacao = 'A';
    end if;
    exception
    when others then
        ds_retorno_w := 'N';
    end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ml_obter_permissao_ass_substit ( nm_usuario_resp_p usuario.nm_usuario%type, nm_usuario_substit_p usuario.nm_usuario%type) FROM PUBLIC;

