-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_legenda_os ( nr_sequencia_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE

 
/*Retorna o status de acordo com a legenda de cores da pasta Pendentes da ordem de serviço 
E - Emergencia 
A - Alta 
M - Media 
B - Baixa 
S - Sem prioridade 
H - Novo histórico 
T - Aberta 
R - Reaberta 
P - Atrasada*/
			 
 
ds_retorno_w			varchar(1) := 'T';
dt_inicio_desejado_w		timestamp;
dt_fim_previsto_w		timestamp;
dt_reabertura_w		timestamp;
ie_novo_hist_w		varchar(1);
ie_prioridade_w		varchar(1);
ie_status_ordem_w		varchar(1);


BEGIN 
 
select	dt_inicio_desejado, 
	dt_fim_previsto, 
	dt_reabertura, 
	substr(Man_Obter_Se_Novo_Hist(nr_sequencia,nm_usuario_p),1,3) ie_novo_hist, 
	ie_prioridade, 
	ie_status_ordem 
into STRICT	dt_inicio_desejado_w, 
	dt_fim_previsto_w, 
	dt_reabertura_w, 
	ie_novo_hist_w, 
	ie_prioridade_w, 
	ie_status_ordem_w 
from	man_ordem_servico_v 
where	nr_sequencia = nr_sequencia_p;
 
if (ie_status_ordem_w = '1') and (dt_inicio_desejado_w < clock_timestamp()) then 
	ds_retorno_w := 'T'; /*Abertas*/
elsif	((dt_fim_previsto_w IS NOT NULL AND dt_fim_previsto_w::text <> '') and (dt_fim_previsto_w < clock_timestamp())) then 
	ds_retorno_w := 'P';/*Atrasadas*/
elsif (dt_reabertura_w IS NOT NULL AND dt_reabertura_w::text <> '') then 
	ds_retorno_w := 'R'; /*Reaberta*/
elsif (ie_prioridade_w = 'E') then 
	ds_retorno_w := 'E'; /*Emergencia*/
elsif (ie_prioridade_w = 'A') then 
	ds_retorno_w := 'A'; /*Alta*/
elsif (ie_prioridade_w = 'M') then 
	ds_retorno_w := 'M'; /*Media*/
elsif (ie_prioridade_w = 'B') then 
	ds_retorno_w := 'B'; /*Baixa*/
elsif (ie_prioridade_w = 'S') then 
	ds_retorno_w := 'S'; /*Sem prioridade*/
elsif (ie_novo_hist_w = 'S') then 
	ds_retorno_w := 'H'; /*Novo Histórico*/
end if;
 
return	ds_retorno_w;
 
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_legenda_os ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

