-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_saldo_mat_autor ( nr_atendimento_p bigint, cd_material_p bigint, cd_convenio_p bigint, dt_atendimento_p timestamp, qt_material_p bigint, nr_seq_matpaci_p bigint) RETURNS bigint AS $body$
DECLARE


qt_saldo_w	double precision := 0;
qt_autorizada_w	double precision := 0;
qt_utilizada_w	double precision := 0;
ie_autor_generico_w	varchar(1);
cd_material_validar_w	integer;

BEGIN

select 	coalesce(max(ie_autor_generico),'N')
into STRICT	ie_autor_generico_w
from	atendimento_paciente a,
	convenio_estabelecimento e
where	a.nr_atendimento	= nr_atendimento_p
and 	e.cd_estabelecimento 	= a.cd_estabelecimento
and 	e.cd_convenio 		= cd_convenio_p;

/* Obter Materiais autorizados */

if (ie_autor_generico_w = 'S') then

	cd_material_validar_w := obter_material_generico(cd_material_p);

	select 	coalesce(sum(coalesce(a.qt_autorizada,0)),0)
	into STRICT	qt_autorizada_w
	FROM material_autorizado a, autorizacao_convenio b
LEFT OUTER JOIN estagio_autorizacao c ON (b.nr_seq_estagio = c.nr_sequencia)
WHERE b.nr_atendimento 		= nr_atendimento_p and b.cd_convenio		= cd_convenio_p and coalesce(dt_atendimento_p,clock_timestamp()) between coalesce(b.dt_inicio_vigencia, coalesce(dt_atendimento_p,clock_timestamp())) and coalesce(b.dt_fim_vigencia,clock_timestamp()) and a.nr_sequencia_autor	= b.nr_sequencia  and a.cd_material	 	= cd_material_validar_w and coalesce(c.ie_interno,'10')	= '10';
else

	select 	coalesce(sum(coalesce(a.qt_autorizada,0)),0)
	into STRICT	qt_autorizada_w
	FROM material_autorizado a, autorizacao_convenio b
LEFT OUTER JOIN estagio_autorizacao c ON (b.nr_seq_estagio = c.nr_sequencia)
WHERE b.nr_atendimento 		= nr_atendimento_p and b.cd_convenio		= cd_convenio_p and coalesce(dt_atendimento_p,clock_timestamp()) between coalesce(b.dt_inicio_vigencia, coalesce(dt_atendimento_p,clock_timestamp())) and coalesce(b.dt_fim_vigencia,clock_timestamp()) and a.nr_sequencia_autor	= b.nr_sequencia  and a.cd_material	 	= cd_material_p and coalesce(c.ie_interno,'10')	= '10';
end if;



/* Obter Materiais lan√ßados */

begin
select	coalesce(sum(qt_material),0) /*+ nvl(qt_material_p,0)*/into STRICT	qt_utilizada_w
from	material_atend_paciente
where	nr_atendimento 		= nr_atendimento_p
and	cd_convenio		= cd_convenio_p
and	cd_material		= cd_material_p
and	coalesce(cd_motivo_exc_conta::text, '') = ''
and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
and	nr_sequencia		<> coalesce(nr_seq_matpaci_p,0);
exception
when others then
	qt_utilizada_w := 0;
end;

qt_saldo_w	:= qt_autorizada_w - qt_utilizada_w;

return	qt_saldo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_saldo_mat_autor ( nr_atendimento_p bigint, cd_material_p bigint, cd_convenio_p bigint, dt_atendimento_p timestamp, qt_material_p bigint, nr_seq_matpaci_p bigint) FROM PUBLIC;

