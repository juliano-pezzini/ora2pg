-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_icms_prest ( sg_uf_prestador_p pls_regra_icms_prest_uf.sg_estado%type, dt_referencia_p pls_conta_proc.dt_procedimento_referencia%type, ie_tipo_despesa_p pls_material.ie_tipo_despesa%type, ie_generico_p text, ie_brasindice_p text) RETURNS PLS_REGRA_ICMS_PREST.TX_AJUSTE%TYPE AS $body$
DECLARE


tx_ajuste_w		pls_regra_icms_prest.tx_ajuste%type := 1;

C01 CURSOR(	sg_uf_prestador_pc	pls_regra_icms_prest_uf.sg_estado%type,
		dt_referencia_pc	pls_conta_proc.dt_procedimento_referencia%type) FOR
	SELECT	a.tx_ajuste,
		CASE WHEN a.ie_generico='N' THEN  'N' WHEN a.ie_generico='G' THEN  'S'  ELSE 'A' END  ie_generico
	from	pls_regra_icms_prest a,
		pls_regra_icms_prest_uf b
	where	a.nr_sequencia = b.nr_seq_regra_icms_prest
	and	dt_referencia_pc between a.dt_inicio_vigencia and a.dt_fim_vigencia_ref
	and (coalesce(a.ie_tipo_despesa::text, '') = '' or a.ie_tipo_despesa = ie_tipo_despesa_p)
	and (coalesce(a.ie_brasindice::text, '') = '' or a.ie_brasindice = 'N' or a.ie_brasindice 	= ie_brasindice_p)
	and	b.sg_estado = sg_uf_prestador_pc
	order by 	coalesce(a.ie_generico,'A'),
			coalesce(a.ie_brasindice,'N'),
			coalesce(a.ie_tipo_despesa,0),
			a.dt_inicio_vigencia;

BEGIN

for r_C01_w in C01(sg_uf_prestador_p, dt_referencia_p) loop




	if	((r_C01_w.ie_generico = 'A') or (r_C01_w.ie_generico =  ie_generico_p) ) then
		tx_ajuste_w := r_C01_w.tx_ajuste;
	end if;

end loop;

return	tx_ajuste_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_icms_prest ( sg_uf_prestador_p pls_regra_icms_prest_uf.sg_estado%type, dt_referencia_p pls_conta_proc.dt_procedimento_referencia%type, ie_tipo_despesa_p pls_material.ie_tipo_despesa%type, ie_generico_p text, ie_brasindice_p text) FROM PUBLIC;

