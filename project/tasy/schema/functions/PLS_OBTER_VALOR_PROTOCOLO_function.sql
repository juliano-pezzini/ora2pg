-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_valor_protocolo ( nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

/*
	ie_opcao_p
	C - Valor cobrado
	T - Valor total
	G - Valor glosado
	CA- Valor calculado
	A - Valor apresentado
	CO - Valor co-participação
	CTB - Valor contábil
	P - Pendente
	LB - Liberado sistema
	LU - Liberado usuário
	QI - Qtd de itens
	BE - Valor beneficiário
*/
vl_total_w			double precision;
vl_retorno_w			double precision;
vl_total_glosa_w		double precision;
qt_ocorrencias_w		double precision;


BEGIN

if (ie_opcao_p = 'C') then

	select	coalesce(sum(vl_cobrado), 0)
	into STRICT	vl_retorno_w
	from	pls_conta
	where	nr_seq_protocolo = nr_seq_protocolo_p;

elsif (ie_opcao_p = 'T') then

	select	coalesce(sum(vl_total), 0)
	into STRICT	vl_retorno_w
	from	pls_conta
	where	nr_seq_protocolo = nr_seq_protocolo_p;

elsif (ie_opcao_p = 'TC') then

	select	coalesce(sum(vl_apresentado), 0)
	into STRICT	vl_retorno_w
	from (SELECT sum(d.vl_procedimento_imp) vl_apresentado
		 from   pls_conta_proc_v d
		 where 	d.nr_seq_protocolo = nr_seq_protocolo_p
		
union all

		 SELECT sum(e.vl_material_imp) vl_apresentado
		 from   pls_conta_mat_v e
		 where 	e.nr_seq_protocolo = nr_seq_protocolo_p) alias5;

elsif (ie_opcao_p = 'TP') then

	select	coalesce(sum(vl_apresentado), 0)
	into STRICT	vl_retorno_w
	from (SELECT sum(d.vl_apresentado_xml) vl_apresentado
		 from   pls_conta_proc_v d
		 where 	d.nr_seq_protocolo = nr_seq_protocolo_p
		
union all

		 SELECT sum(e.vl_apresentado_xml) vl_apresentado
		 from   pls_conta_mat_v e
		 where 	e.nr_seq_protocolo = nr_seq_protocolo_p) alias5;

elsif (ie_opcao_p = 'G') then

	select	coalesce(sum(pls_obter_valor_conta(nr_sequencia,'GO')), 0)
	into STRICT	vl_retorno_w
	from	pls_conta
	where	nr_seq_protocolo = nr_seq_protocolo_p;

elsif (ie_opcao_p = 'CTB') then

	select	sum(vl_total),
		sum(vl_glosa)
	into STRICT	vl_total_w,
		vl_total_glosa_w
	from	pls_conta
	where	nr_seq_protocolo	= nr_seq_protocolo_p;

	vl_retorno_w := coalesce(vl_total_w,0) + coalesce(vl_total_glosa_w,0) + coalesce(vl_total_glosa_w,0);

elsif (ie_opcao_p = 'CO') then

	-- retirado o cursor e feito tudo em um select apenas
	select	coalesce(sum(b.vl_coparticipacao), 0)
	into STRICT	vl_retorno_w
	from	pls_conta a,
		pls_conta_coparticipacao b
	where	a.nr_seq_protocolo = nr_seq_protocolo_p
	and	b.nr_seq_conta	= a.nr_sequencia;

elsif (ie_opcao_p = 'P') then

	select	coalesce(sum(vl_pendente), 0)
	into STRICT	vl_retorno_w
	from	pls_conta_medica_item_v
	where	nr_seq_protocolo = nr_seq_protocolo_p
	and	ie_status_item not in ('S','L');

elsif (ie_opcao_p = 'LS') then

	select	coalesce(sum(vl_lib_sistema), 0)
	into STRICT	vl_retorno_w
	from	pls_conta_medica_item_v
	where	nr_seq_protocolo = nr_seq_protocolo_p;

elsif (ie_opcao_p = 'LU') then

	select	coalesce(sum(vl_lib_usuario), 0)
	into STRICT	vl_retorno_w
	from	pls_conta_medica_item_v
	where	nr_seq_protocolo = nr_seq_protocolo_p;

elsif (ie_opcao_p = 'QI') then

	select	sum(qt_ocorrencias)
	into STRICT	qt_ocorrencias_w
	from	pls_conta_medica_item_v
	where	nr_seq_protocolo = nr_seq_protocolo_p;

	vl_retorno_w := coalesce(qt_ocorrencias_w,0);

elsif (ie_opcao_p = 'BE') then

	select	coalesce(sum(vl_total_beneficiario), 0)
	into STRICT	vl_retorno_w
	from	pls_conta
	where	nr_seq_protocolo = nr_seq_protocolo_p;

elsif (ie_opcao_p = 'CA') then

	select 	sum(vl_item)
	into STRICT 	vl_retorno_w
	from (SELECT	coalesce(sum(a.vl_procedimento),0) vl_item
		from	pls_conta_proc	a,
			pls_conta	b
		where	a.nr_seq_conta = b.nr_sequencia
		and	b.nr_seq_protocolo = nr_seq_protocolo_p
		and 	a.ie_status <> 'D'
		
union all

		SELECT	coalesce(sum(a.vl_material),0) vl_item -- Ajustado para verificar o mat também pois não era verificado
		from	pls_conta_mat	a,
			pls_conta	b
		where	a.nr_seq_conta = b.nr_sequencia
		and	b.nr_seq_protocolo = nr_seq_protocolo_p
		and 	a.ie_status <> 'D') alias6;

elsif (ie_opcao_p = 'A') then

	select 	sum(vl_item)
	into STRICT 	vl_retorno_w
	from (SELECT	coalesce(sum(a.vl_procedimento_imp),0) vl_item -- Ajustado para verificar o mat também pois énão era verificado
		from	pls_conta_proc	a,
			pls_conta	b
		where	a.nr_seq_conta = b.nr_sequencia
		and	b.nr_seq_protocolo = nr_seq_protocolo_p
		and 	a.ie_status <> 'D'
		
union all

		SELECT	coalesce(sum(a.vl_material_imp),0) vl_item
		from 	pls_conta_mat	a,
			pls_conta	b
		where	a.nr_seq_conta = b.nr_sequencia
		and	b.nr_seq_protocolo = nr_seq_protocolo_p
		and 	a.ie_status <> 'D') alias6;
end if;

return vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_valor_protocolo ( nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, ie_opcao_p text) FROM PUBLIC;

