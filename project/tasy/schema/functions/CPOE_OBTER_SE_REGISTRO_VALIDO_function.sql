-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_se_registro_valido (nr_sequencia_p bigint, ie_tipo_item_p text, nm_usuario_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
 
cd_material_w			cpoe_fav_material.cd_material%type;
cd_mat_comp1_w			cpoe_fav_material.cd_mat_comp1%type;
cd_mat_comp2_w			cpoe_fav_material.cd_mat_comp2%type;
cd_mat_comp3_w			cpoe_fav_material.cd_mat_comp3%type;
cd_mat_comp4_w			cpoe_fav_material.cd_mat_comp4%type;
cd_mat_comp5_w			cpoe_fav_material.cd_mat_comp5%type;
cd_mat_comp6_w			cpoe_fav_material.cd_mat_comp6%type;
cd_mat_dil_w			cpoe_fav_material.cd_mat_dil%type;
cd_mat_recons_w			cpoe_fav_material.cd_mat_recons%type;
cd_mat_red_w			cpoe_fav_material.cd_mat_red%type;

nr_seq_proc_interno_w	cpoe_fav_procedimento.nr_seq_proc_interno%type;
cd_mat_proc1_w			cpoe_fav_procedimento.cd_mat_proc1%type;
cd_mat_proc2_w			cpoe_fav_procedimento.cd_mat_proc2%type;
cd_mat_proc3_w			cpoe_fav_procedimento.cd_mat_proc3%type;
cd_mat_proc4_w			cpoe_fav_procedimento.cd_mat_proc4%type;
cd_mat_proc5_w			cpoe_fav_procedimento.cd_mat_proc5%type;

cd_recomendacao_w		cpoe_fav_recomendacao.cd_recomendacao%type;

cd_dieta_w				cpoe_fav_dieta.cd_dieta%type;	
nr_seq_tipo_w			cpoe_fav_dieta.nr_seq_tipo%type;	
ie_tipo_dieta_w			cpoe_fav_dieta.ie_tipo_dieta%type;
cd_mat_prod1_w			cpoe_fav_dieta.cd_mat_prod1%type;
cd_mat_prod2_w			cpoe_fav_dieta.cd_mat_prod2%type;
cd_mat_prod3_w			cpoe_fav_dieta.cd_mat_prod3%type;
cd_mat_prod4_w			cpoe_fav_dieta.cd_mat_prod3%type;
cd_mat_prod5_w			cpoe_fav_dieta.cd_mat_prod4%type;

nr_seq_gas_w			cpoe_fav_gasoterapia.nr_seq_gas%type;	
ie_respiracao_w			cpoe_fav_gasoterapia.ie_respiracao%type;
cd_mat_equip1_w			cpoe_fav_gasoterapia.cd_mat_equip1%type;
cd_mat_equip2_w			cpoe_fav_gasoterapia.cd_mat_equip2%type;
cd_mat_equip3_w			cpoe_fav_gasoterapia.cd_mat_equip3%type;	
 
ie_ativo_classif_w		classificacao_recomendacao.ie_situacao%type;
ie_localizador_w		proc_interno.ie_localizador%type;	
ie_ativo_rec_w			tipo_recomendacao.ie_situacao%type;	
 
ie_prescricao_w			varchar(2);
ie_ativo_w				varchar(2);
	

BEGIN 
 
if (ie_tipo_item_p = 'M') or (ie_tipo_item_p = 'S')then 
	/* 
	Checbox Prescricao = 'S' (Cadastro de Material) 
	Deve estar ativo no cadastro 
	*/
	 
	select max(coalesce(cd_material,0)) cd_material, 
		max(coalesce(cd_mat_comp1,0)) cd_mat_comp1, 
	  max(coalesce(cd_mat_comp2,0)) cd_mat_comp2, 
	  max(coalesce(cd_mat_comp3,0)) cd_mat_comp3, 
		max(coalesce(cd_mat_comp4,0)) cd_mat_comp4, 
	  max(coalesce(cd_mat_comp5,0)) cd_mat_comp5, 
	  max(coalesce(cd_mat_comp6,0)) cd_mat_comp6, 
	  max(coalesce(cd_mat_dil,0)) cd_mat_dil, 
	  max(coalesce(cd_mat_recons,0)) cd_mat_recons, 
	  max(coalesce(cd_mat_red,0)) cd_mat_red 
	into STRICT	cd_material_w, 
		cd_mat_comp1_w, 
		cd_mat_comp2_w, 
		cd_mat_comp3_w, 
		cd_mat_comp4_w, 
		cd_mat_comp5_w, 
		cd_mat_comp6_w, 
		cd_mat_dil_w, 
		cd_mat_recons_w, 
		cd_mat_red_w		 
	from cpoe_fav_material 
	where nr_sequencia = nr_sequencia_p;
	 
	if (coalesce(cd_material_w,0) > 0) then 
		 
		--Material Principal 
		if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_material_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_material_w),'I') <> 'A') then 
			return 'N';
		end if;
		 
		--Mat Auxiliar 1 
		if (coalesce(cd_mat_comp1_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_comp1_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_comp1_w),'I') <> 'A') then 
				return 'N';
			end if;						
		end if;
		 
		--Mat Auxiliar 2 
		if (coalesce(cd_mat_comp2_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_comp2_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_comp2_w),'I') <> 'A') then 
				return 'N';
			end if;						
		end if;
 
		--Mat Auxiliar 3 
		if (coalesce(cd_mat_comp3_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_comp3_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_comp3_w),'I') <> 'A') then 
				return 'N';
			end if;						
		end if;
		 
		--Mat Auxiliar 4 
		if (coalesce(cd_mat_comp4_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_comp4_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_comp4_w),'I') <> 'A') then 
				return 'N';
			end if;						
		end if;
		 
		--Mat Auxiliar 6 
		if (coalesce(cd_mat_comp6_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_comp6_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_comp6_w),'I') <> 'A') then 
				return 'N';
			end if;						
		end if;
		 
		--Mat Auxiliar 5 
		if (coalesce(cd_mat_comp5_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_comp5_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_comp5_w),'I') <> 'A') then 
				return 'N';
			end if;						
		end if;
	 
		--Diluente 
		if (coalesce(cd_mat_dil_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_dil_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_dil_w),'I') <> 'A') then 
				return 'N';
			end if;						
		end if;		
		 
		--Reconstituinte 
		if (coalesce(cd_mat_recons_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_recons_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_recons_w),'I') <> 'A') then 
				return 'N';
			end if;						
		end if;	
		 
		--Rediluente 
		if (coalesce(cd_mat_red_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_red_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_red_w),'I') <> 'A') then 
				return 'N';
			end if;						
		end if;			
		 
		return 'S';		
	end if;
	 
elsif (ie_tipo_item_p = 'P') then 
	/* 
	Exame deve estar ativo(Exames e procedimentos internos) 
	Checbox Localizador proc interno, deve estar marcado. 
	*/
 
	 
	select max(coalesce(nr_seq_proc_interno,0)) nr_seq_proc_interno, 
		max(coalesce(cd_mat_proc1,0)) cd_mat_proc1, 
		max(coalesce(cd_mat_proc2,0)) cd_mat_proc2, 
		max(coalesce(cd_mat_proc3,0)) cd_mat_proc3, 
		max(coalesce(cd_mat_proc4,0)) cd_mat_proc4, 
		max(coalesce(cd_mat_proc5,0)) cd_mat_proc5 
	into STRICT	nr_seq_proc_interno_w, 
		cd_mat_proc1_w, 
		cd_mat_proc2_w, 
		cd_mat_proc3_w, 
		cd_mat_proc4_w, 
		cd_mat_proc5_w 
	from cpoe_fav_procedimento 
	where nr_sequencia = nr_sequencia_p;
	 
	if (coalesce(nr_seq_proc_interno_w,0) > 0) then 
	 
		select max(coalesce(ie_situacao,'A')) ie_ativo,		 
			max(coalesce(ie_localizador,'N')) ie_localizador 
		into STRICT	ie_ativo_w, 
			ie_localizador_w 
		from proc_interno 
		where nr_sequencia = nr_seq_proc_interno_w;
	 
		if (coalesce(ie_ativo_w,'I') <> 'A') or (coalesce(ie_localizador_w,'I') <> 'S') then 
			return 'N';
		end if;		
	 
		--Mat adicional 1 
		if (coalesce(cd_mat_proc1_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_proc1_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_proc1_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;	
		 
		--Mat adicional 2 
		if (coalesce(cd_mat_proc2_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_proc2_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_proc2_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;	
 
		--Mat adicional 3 
		if (coalesce(cd_mat_proc3_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_proc3_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_proc3_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;	
	 
		--Mat adicional 4 
		if (coalesce(cd_mat_proc4_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_proc4_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_proc4_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;	
 
		--Mat adicional 5 
		if (coalesce(cd_mat_proc5_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_proc5_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_proc5_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;			
	 
		return 'S';	
	end if;
	 
elsif (ie_tipo_item_p = 'R') then 
	/* 
	Recomendacao e sua respectiva classificação deve estar ativas(Aplicação Principal/Médico/Classificação Recomendação) 
	*/
			 
	select max(coalesce(cd_recomendacao,0)) cd_recomendacao 
	into STRICT cd_recomendacao_w 
	from cpoe_fav_recomendacao 
	where nr_sequencia = nr_sequencia_p;
 
	if (coalesce(cd_recomendacao_w,0) > 0) then 
 
		select max(coalesce(b.ie_situacao,'A')) ie_ativo_classif, 
		     max(coalesce(a.ie_situacao,'A')) ie_ativo_rec 
		into STRICT ie_ativo_classif_w, 
			ie_ativo_rec_w 
		from tipo_recomendacao a, 
		   classificacao_recomendacao b 
		where a.nr_seq_classif = b.nr_sequencia 
		and ((cd_estabelecimento = cd_estabelecimento_p) or (coalesce(cd_estabelecimento::text, '') = '')) 
		and a.cd_tipo_recomendacao = cd_recomendacao_w;
	 
		if (coalesce(ie_ativo_classif_w,'A') = 'A') and (coalesce(ie_ativo_rec_w,'A') = 'A') then 
			return 'S';
		else 
			return 'N';
		end if;		
	 
	end if;
	 
elsif (ie_tipo_item_p = 'N') then 
	 
	select max(coalesce(cd_dieta,0)) cd_dieta, 
	  max(coalesce(nr_seq_tipo,0)) nr_seq_tipo, 
	  max(ie_tipo_dieta) ie_tipo_dieta, 
	  max(cd_material) cd_material, 
		max(coalesce(cd_mat_prod1,0)) cd_mat_prod1 
	into STRICT	cd_dieta_w, 
		nr_seq_tipo_w, 
		ie_tipo_dieta_w, 
		cd_material_w, 
		cd_mat_prod1_w 
	from cpoe_fav_dieta 
	where nr_sequencia = nr_sequencia_p;	
	 
	if (ie_tipo_dieta_w = 'O') and (coalesce(cd_dieta_w,0) > 0) then		 
		/* 
		Cadastro Aplicação Principal/Nutrição/Dieta esteja ativa 
		*/
					 
		select max(coalesce(ie_situacao,'A')) ie_ativo 
		into STRICT ie_ativo_w 
		from dieta 
		where ((cd_estabelecimento = cd_estabelecimento_p) or (coalesce(cd_estabelecimento::text, '') = '')) 
		and cd_dieta = cd_dieta_w;
		 
		if (coalesce(ie_ativo_w,'A') <> 'A') then 
			return 'N';
		end if;
		 
		return 'S';
		 
	elsif (ie_tipo_dieta_w = 'J') and (coalesce(nr_seq_tipo_w,0) > 0) then		 
		/* 
		Cadastro Aplicação Principal/Médico/Tipos de Jejum esteja ativo 
		*/
 
		select max(coalesce(ie_situacao,'A')) ie_ativo 
		into STRICT ie_ativo_w 
		from rep_tipo_jejum 
		where nr_sequencia = nr_seq_tipo_w;
 
		if (coalesce(ie_ativo_w,'A') <> 'A') then 
			return 'N';
		end if;	
		 
		return 'S';
 
	elsif (ie_tipo_dieta_w = 'L') then	 
 
		select max(coalesce(cd_mat_prod2,0)) cd_mat_prod2, 
			max(coalesce(cd_mat_prod3,0)) cd_mat_prod3, 
			max(coalesce(cd_mat_prod4,0)) cd_mat_prod4, 
			max(coalesce(cd_mat_prod5,0)) cd_mat_prod5 
		into STRICT	cd_mat_prod2_w, 
			cd_mat_prod3_w, 
			cd_mat_prod4_w,	 
			cd_mat_prod5_w 
		from cpoe_fav_dieta 
		where nr_sequencia = nr_sequencia_p;
		 
		--Item Principal 
		if (coalesce(cd_mat_prod1_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_prod1_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_prod1_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;			
		 
		--Adicional 
		if (coalesce(cd_mat_prod2_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_prod2_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_prod2_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;		
 
		--Adicional 
		if (coalesce(cd_mat_prod3_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_prod3_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_prod3_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;		
 
		--Adicional 
		if (coalesce(cd_mat_prod4_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_prod4_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_prod4_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;		
 
		--Adicional 
		if (coalesce(cd_mat_prod5_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_prod5_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_prod5_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;				
		 
		return 'S';
		 
	elsif (ie_tipo_dieta_w = 'S') and (coalesce(cd_material_w,0) > 0) then	 
	 
		--Item Principal 
		if (coalesce(cd_material_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_material_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_material_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;				
		 
		--Diluente 
		if (coalesce(cd_mat_prod1_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_prod1_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_prod1_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;			
 
		return 'S';
		 
	 
	elsif (ie_tipo_dieta_w = 'E') and (coalesce(cd_material_w,0) > 0) then 
		  
		--Item Principal 
		if (coalesce(cd_material_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_material_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_material_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;	
		 
		return 'S';
	end if;
 
	return 'S';
	 
elsif (ie_tipo_item_p = 'G') then 
	/* 
	Cadastro Aplicação Principal/Médico/Cadastro de gases esteja ativo 
	*/
		 
	select max(coalesce(nr_seq_gas,0)) nr_seq_gas, 
    max(ie_respiracao) ie_respiracao, 
    max(coalesce(cd_mat_equip1,0)) cd_mat_equip1, 
    max(coalesce(cd_mat_equip3,0)) cd_mat_equip2, 
    max(coalesce(cd_mat_equip3,0)) cd_mat_equip3 
	into STRICT	nr_seq_gas_w, 
		ie_respiracao_w, 
		cd_mat_equip1_w, 
		cd_mat_equip2_w, 
		cd_mat_equip3_w 
	from cpoe_fav_gasoterapia 
	where nr_sequencia = nr_sequencia_p;
	 
	if (coalesce(nr_seq_gas_w,0) > 0) then 
 
		select max(coalesce(ie_situacao,'A')) ie_ativo 
		into STRICT ie_ativo_w	 
		from gas 
		where ((cd_estabelecimento = cd_estabelecimento_p) or (coalesce(cd_estabelecimento::text, '') = '')) 
		and obter_se_exibe_gas(ie_respiracao_w, nr_sequencia) = 'S' 
		and nr_sequencia = nr_seq_gas_w;
		 
		--Item pricipal 
		if (coalesce(ie_ativo_w,'A') <> 'A') then 
			return 'N';
		end if;		
 
		--Mat Associado 1 
		if (coalesce(cd_mat_equip1_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_equip1_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_equip1_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;	
 
		--Mat Associado 2 
		if (coalesce(cd_mat_equip2_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_equip2_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_equip2_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;	 		
		 
		--Mat Associado 3 
		if (coalesce(cd_mat_equip3_w,0) > 0) then			 
			if (coalesce(obter_se_material_prescricao(cd_estabelecimento_p, cd_mat_equip3_w),'I') <> 'S') or (coalesce(obter_se_material_ativo(cd_mat_equip3_w),'I') <> 'A') then 
				return 'N';
			end if;
		end if;	
 
		return 'S';		
	end if;	
	 
	return 'S';	
end if;
 
return	'S';
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_se_registro_valido (nr_sequencia_p bigint, ie_tipo_item_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

