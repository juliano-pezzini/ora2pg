-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hd_relat_mapa_disp (ie_tipo_hemodialise_p text ,ie_cateter_p text ,nr_seq_diametro_agulha_p bigint ,nr_seq_mod_dialisador_p bigint ,cd_pessoa_fisica_p text ,dt_agenda_p timestamp ,ie_tipo_info_p text, nr_atendimento_p bigint default null) RETURNS varchar AS $body$
DECLARE


  w_kit_name                  kit_material.ds_kit_material%TYPE;
  w_kit_cd                    kit_material.cd_kit_material%TYPE;
  w_mat_name                  varchar(4000);
  w_item                      varchar(4000) := '';
  w_ie_sorologia              bigint := 0;
  w_return                    varchar(4000) := '';


c_01 CURSOR FOR
  SELECT * FROM HD_MAPA_DISPENSACAO_KIT
  WHERE (IE_TIPO_HEMODIALISE = ie_tipo_hemodialise_p OR coalesce(IE_TIPO_HEMODIALISE::text, '') = '')                                                                        
  AND (IE_CATETER = ie_cateter_p OR coalesce(IE_CATETER::text, '') = '')
  AND (NR_SEQ_DIAMETRO_AGULHA = nr_seq_diametro_agulha_p OR coalesce(NR_SEQ_DIAMETRO_AGULHA::text, '') = '')                                          
  AND (NR_SEQ_MOD_DIALISADOR =  nr_seq_mod_dialisador_p OR coalesce(NR_SEQ_MOD_DIALISADOR::text, '') = '');
	c_01_w   c_01%ROWTYPE;

  R RECORD;

BEGIN
  BEGIN
    BEGIN
	    SELECT	Count(1) 
		INTO STRICT 	w_ie_sorologia 
		FROM 	HD_PACIENTE_CLASSIF_SOR a,
				HD_CLASSIFICACAO_SOROLOGIA b
		WHERE 	a.cd_pessoa_fisica = cd_pessoa_fisica_p 
		and		a.nr_seq_classificacao = b.nr_sequencia
		and		b.ie_necessita_vaga_esp = 'S'
		and (coalesce(a.dt_fim::text, '') = '' or trunc(a.dt_fim) < dt_agenda_p);
	  EXCEPTION
	    WHEN Others THEN
	    w_ie_sorologia := 0;
	  END;
    BEGIN
      OPEN c_01;
      LOOP
      FETCH c_01 INTO c_01_w;
      EXIT WHEN NOT FOUND; /* apply on c_01 */
		    BEGIN
		      IF ( (coalesce(c_01_w.ie_possui_classif_sor, 'N') = 'S' AND w_ie_sorologia > 0) OR coalesce(c_01_w.ie_possui_classif_sor, 'N') = 'N' AND w_ie_sorologia = 0 ) THEN
            IF ie_tipo_info_p = 'K' THEN

              w_kit_name:= '';

		  	      BEGIN
		  	        SELECT ds_kit_material INTO STRICT  w_kit_name FROM kit_material WHERE cd_kit_material = c_01_w.cd_kit_material;
		  	      EXCEPTION
		  	      WHEN Others THEN
		  	        w_kit_name := '';
		  	      END;

              RETURN w_kit_name;

            ELSIF ie_tipo_info_p  = 'I' THEN

              w_kit_name:= '';

              FOR R IN ( SELECT distinct obter_desc_material(cd_material)|| ' Dose: '||QT_DOSE||'('||CD_UNIDADE_MEDIDA||')' ds_material
								FROM cpoe_material
								WHERE nr_atendimento = nr_atendimento_p
								AND	  (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
								
UNION ALL

								SELECT distinct obter_desc_material(CD_MAT_RECONS)|| ' Dose: '||QT_DOSE_RECONS||'('||CD_UNID_MED_DOSE_RECONS||')' ds_material
								FROM cpoe_material
								WHERE nr_atendimento = nr_atendimento_p
								AND	  (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
								AND	  (CD_MAT_RECONS IS NOT NULL AND CD_MAT_RECONS::text <> '')
								
UNION ALL

								SELECT distinct obter_desc_material(CD_MAT_DIL)|| ' Dose: '||QT_DOSE_DIL||'('||CD_UNID_MED_DOSE_DIL||')' ds_material
								FROM cpoe_material
								WHERE nr_atendimento = nr_atendimento_p
								AND	  (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
								AND	  (CD_MAT_RECONS IS NOT NULL AND CD_MAT_RECONS::text <> '')
								ORDER BY ds_material ) LOOP

		  	        w_mat_name := R.DS_MATERIAL;
		  	        w_item := w_item || Chr(13)||Chr(10) || w_mat_name;

		  	      END LOOP;
              w_return := w_item;
            END IF;
          END IF;

		    EXCEPTION
		    WHEN Others THEN
		      w_item := '';
		    END;
		
      END LOOP;
      CLOSE c_01;
    END;
  END;
  RETURN w_return || Chr(13)||Chr(10);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hd_relat_mapa_disp (ie_tipo_hemodialise_p text ,ie_cateter_p text ,nr_seq_diametro_agulha_p bigint ,nr_seq_mod_dialisador_p bigint ,cd_pessoa_fisica_p text ,dt_agenda_p timestamp ,ie_tipo_info_p text, nr_atendimento_p bigint default null) FROM PUBLIC;

