-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gerar_arquivo_dmed_estab (cd_cnpj_estab_p text, nr_seq_dmed_p bigint) RETURNS varchar AS $body$
DECLARE

			
ds_decpj		      varchar(255);
cd_responsavel_w	varchar(255);
separador_w			  varchar(2) := '|';
nr_cpf_w			    pessoa_fisica.nr_cpf%type;


BEGIN
select	a.cd_responsavel_cnpj
into STRICT	  cd_responsavel_w
from	  dmed a
where	  a.nr_sequencia	= nr_seq_dmed_p;

select	max(f.nr_cpf)
into STRICT	  nr_cpf_w
from	  pessoa_fisica	f
where	  f.cd_pessoa_fisica	= cd_responsavel_w;

if (coalesce(nr_cpf_w::text, '') = '') then
	select	max(f.nr_cpf)
	into STRICT	  nr_cpf_w
	from	  pessoa_juridica	p,
		      pessoa_fisica	f
	where	  p.cd_pf_resp_tecnico	= f.cd_pessoa_fisica
	and	    p.cd_cgc		= cd_cnpj_estab_p;
end if;

select	'DECPJ' 						                                                    || separador_w ||
	      lpad(cd_cnpj_estab_p,14,'0')				                                    || separador_w ||
	      substr(p.ds_razao_social,1,150)				                                  || separador_w ||
	      CASE WHEN t.ie_comercial_ops='H' THEN '1' WHEN t.ie_comercial_ops='O' THEN '2'  ELSE '3' END 	                        || separador_w ||
	      lpad(p.cd_ans,6,'0')					                                          || separador_w ||
	      lpad(obter_cnes_estab_cnpj(cd_cnpj_estab_p),7,'0')	                    || separador_w ||
	      lpad(nr_cpf_w,11,'0') 					                                        || separador_w ||
	      'N'							                                                        || separador_w ||
	      ''							                                                        || separador_w ||
        CASE WHEN t.ie_comercial_ops='H' THEN  ''  ELSE CASE WHEN coalesce(p.cd_ans::text, '') = '' THEN  'N'  ELSE 'S' END  END    || separador_w
into STRICT	  ds_decpj	
from	  pessoa_juridica		p,
	      tipo_pessoa_juridica	t
where 	p.cd_tipo_pessoa	= t.cd_tipo_pessoa
and	    p.cd_cgc		= cd_cnpj_estab_p;	

return  ds_decpj;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gerar_arquivo_dmed_estab (cd_cnpj_estab_p text, nr_seq_dmed_p bigint) FROM PUBLIC;

