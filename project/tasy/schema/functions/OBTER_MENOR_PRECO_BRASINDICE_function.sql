-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_menor_preco_brasindice ( cd_estabelecimento_p bigint, cd_material_p bigint, dt_vigencia_p timestamp, ie_unid_med_conversao_p text, ie_tipo_preco_p text) RETURNS bigint AS $body$
DECLARE


/*ie_unid_med_conversao_p
	C - Em unidade de consumo
	P - Em unidade de compras */
vl_brasindice_w			double precision;
qt_conv_compra_estoque_w		double precision;


BEGIN

select	coalesce(min(dividir(b.vl_preco_medicamento, coalesce(a.qt_conversao,1))),0)
into STRICT	vl_brasindice_w
from	material_brasindice a,
	brasindice_preco b
where	a.cd_material		= cd_material_p
and	a.cd_laboratorio		= b.cd_laboratorio
and	a.cd_medicamento		= b.cd_medicamento
and	a.cd_apresentacao		= b.cd_apresentacao
and	coalesce(a.ie_situacao, 'A')	= 'A'
and	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p, 0))	= coalesce(cd_estabelecimento_p, 0)
and	b.ie_tipo_preco			= ie_tipo_preco_p
and 	b.dt_inicio_vigencia = (
			SELECT 	max(x.dt_inicio_vigencia)
			from 	brasindice_preco x,
				material_brasindice y
			where 	x.cd_laboratorio	= y.cd_laboratorio
			and 	x.cd_medicamento	= y.cd_medicamento
			and 	x.cd_apresentacao	= y.cd_apresentacao
			and 	x.cd_laboratorio	= a.cd_laboratorio
			and 	x.cd_medicamento	= a.cd_medicamento
			and 	x.cd_apresentacao	= a.cd_apresentacao
			and 	coalesce(x.dt_inicio_vigencia,dt_vigencia_p) <= dt_vigencia_p);

if (ie_unid_med_conversao_p = 'P') then

	select	qt_conv_compra_estoque
	into STRICT	qt_conv_compra_estoque_w
	from	material
	where	cd_material = cd_material_p;

	vl_brasindice_w := vl_brasindice_w * qt_conv_compra_estoque_w;
end if;

return	vl_brasindice_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_menor_preco_brasindice ( cd_estabelecimento_p bigint, cd_material_p bigint, dt_vigencia_p timestamp, ie_unid_med_conversao_p text, ie_tipo_preco_p text) FROM PUBLIC;

