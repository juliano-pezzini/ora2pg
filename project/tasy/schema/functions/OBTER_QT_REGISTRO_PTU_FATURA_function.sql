-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_registro_ptu_fatura ( nr_sequencia_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

/*ie_opcao_p =
	502 -> qt_total_r502
	503 -> qt_total_r503
	504 -> qt_total_r504
	505 -> qt_total_r505
	qt_nota -> qt_nota_exec
	qt_serv -> qt_total_inclusao
	vl_serv -> qt_exclusos_benef
	507 -> qt_total_r507
	508 -> qt_total_r508
	*/
ie_opcao_w			varchar(4000);
qt_total_w			double precision;


BEGIN
ie_opcao_w := upper(ie_opcao_p);

if (ie_opcao_w = '502') then
	select	count(1)
	into STRICT	qt_total_w
	from	ptu_fatura		a,
		ptu_nota_cobranca	b
	where	a.nr_sequencia		= b.nr_seq_fatura
	and	a.nr_sequencia		= nr_sequencia_p;

elsif (ie_opcao_w = '503') then
	select	count(1)
	into STRICT	qt_total_w
	from	ptu_fatura		a,
		ptu_nota_cobranca	b,
		ptu_nota_hospitalar	c
	where	a.nr_sequencia		= b.nr_seq_fatura
	and	b.nr_sequencia		= c.nr_seq_nota_cobr
	and	a.nr_Sequencia		= nr_Sequencia_p;

elsif (ie_opcao_w = '504') then
	select	count(1)
	into STRICT	qt_total_w
	from	ptu_fatura		a,
		ptu_nota_cobranca	b,
		ptu_nota_servico	c
	where	a.nr_sequencia		= b.nr_seq_fatura
	and	b.nr_sequencia		= c.nr_seq_nota_cobr
	and	coalesce(c.qt_procedimento,0) > 0
	and	a.nr_sequencia		= nr_sequencia_p;

elsif (ie_opcao_w = '505') then
	-- Foi criado um IF para inserir os complementos no arquivo, conforme OS 1266544
	--  Esse IF atualmente apenas valida se uma sentença é nulla, se for o complemento não deve ser considerado
	-- O count foi alterado para contar a expressão utilizada no IF, para que não conte os valores null, e consequentemente
	-- não são incluidos no arquivo.
	select	count(1)
	into STRICT	qt_total_w
	from	ptu_fatura		a,
		ptu_nota_cobranca	b,
		ptu_nota_complemento	c
	where	a.nr_sequencia		= b.nr_seq_fatura
	and	b.nr_sequencia		= c.nr_seq_nota_cobr
	and	replace(replace(ptu_somente_caracter_permitido(c.ds_complemento,'ANS'),chr(10),''),chr(13),'') is not null
	and	a.nr_sequencia		= nr_sequencia_p;

elsif (ie_opcao_w = '507') then
	select	count(1)
	into STRICT	qt_total_w
	from	ptu_fatura		a,
		ptu_nota_cobranca_rrs	b
	where	a.nr_sequencia		= b.nr_seq_fatura
	and	a.nr_sequencia		= nr_sequencia_p;

elsif (ie_opcao_w = '508') then
	select	count(1)
	into STRICT	qt_total_w
	from	ptu_fatura		a,
		ptu_nota_cobranca_rrs	b,
		ptu_nota_servico_rrs	c
	where	a.nr_sequencia		= b.nr_seq_fatura
	and	b.nr_sequencia		= c.nr_seq_nota_cobr_rrs
	and	coalesce(c.qt_cobrada,0) > 0
	and	a.nr_sequencia		= nr_sequencia_p;

elsif (ie_opcao_w	= 'QT_NOTA') then
	select	count(1)
	into STRICT	qt_total_w
	from	ptu_fatura		a,
		ptu_nota_cobranca	b
	where	a.nr_sequencia		= b.nr_seq_fatura
	and	b.cd_excecao		<> '0'
	and	a.nr_sequencia		= nr_sequencia_p;

elsif (ie_opcao_w	= 'QT_SERV') then
	select	sum(coalesce(qt_procedimento,0))
	into STRICT	qt_total_w
	from	ptu_fatura		a,
		ptu_nota_cobranca	b,
		ptu_nota_servico	c
	where	a.nr_sequencia		= b.nr_seq_fatura
	and	b.nr_sequencia		= c.nr_seq_nota_cobr
	and	(c.vl_procedimento IS NOT NULL AND c.vl_procedimento::text <> '')
	and	coalesce(c.qt_procedimento,0) > 0
	and	a.nr_sequencia		= nr_sequencia_p;

elsif (ie_opcao_w	= 'VL_SERV') then
	select	coalesce(sum((replace(substr(ptu_obter_dados_nota_servico(c.nr_sequencia,'VTP'),1,255),'.',''))::numeric ),0)
	into STRICT	qt_total_w
	from	ptu_fatura		a,
		ptu_nota_cobranca	b,
		ptu_nota_servico	c
	where	a.nr_sequencia		= b.nr_seq_fatura
	and	b.nr_sequencia		= c.nr_seq_nota_cobr
	and	a.nr_sequencia		= nr_sequencia_p;
end if;

return	qt_total_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_registro_ptu_fatura ( nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

