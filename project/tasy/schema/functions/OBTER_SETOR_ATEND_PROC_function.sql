-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_setor_atend_proc ( cd_estabelecimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_setor_atend_p bigint, cd_setor_origem_p bigint, nm_usuario_p text, nr_seq_proc_interno_p bigint, nr_atendimento_p bigint, ie_proced_principal_p text default 'S') RETURNS bigint AS $body$
DECLARE


cd_setor_atendimento_w		integer;
cd_setor_exclusivo_w		integer;
ie_setor_paciente_w			varchar(10);
ie_tipo_atendimento_w		smallint;
cd_convenio_w				integer;
cd_categoria_w				varchar(10);

C01 CURSOR FOR
	SELECT	cd_setor_atendimento
	from	procedimento_setor_atend
	where	cd_procedimento		= cd_procedimento_p
	and		ie_origem_proced	= ie_origem_proced_p
	and		cd_estabelecimento	= cd_estabelecimento_p
	AND     ((coalesce(ie_somente_principal,'N') = 'N') OR
			((coalesce(ie_somente_principal,'N') = 'S') AND (ie_proced_principal_p = 'S')))
	and		((cd_setor_origem	= cd_setor_origem_p) or (coalesce(cd_setor_origem_p::text, '') = '') or (coalesce(cd_setor_origem::text, '') = ''))
	order by ie_prioridade desc,
			 coalesce(cd_setor_origem,0);

C02 CURSOR FOR
	SELECT	a.cd_setor_atendimento
	from	usuario_setor_v b,
			procedimento_setor_atend a
	where	a.cd_procedimento		= cd_procedimento_p
	and		a.ie_origem_proced		= ie_origem_proced_p
	and		a.cd_estabelecimento	= cd_estabelecimento_p
	and		b.nm_usuario			= nm_usuario_p
	and		a.cd_setor_atendimento	= b.cd_setor_atendimento
	AND     ((coalesce(a.ie_somente_principal,'N') = 'N') OR
			((coalesce(a.ie_somente_principal,'N') = 'S') AND (ie_proced_principal_p = 'S')))
	and		((a.cd_setor_origem	= cd_setor_origem_p) or (coalesce(cd_setor_origem_p::text, '') = '') or (coalesce(a.cd_setor_origem::text, '') = ''))
	order by a.ie_prioridade desc,
			 coalesce(a.cd_setor_origem,0);


BEGIN

if (cd_setor_atend_p IS NOT NULL AND cd_setor_atend_p::text <> '') then
	select	max(b.cd_setor_atendimento)
	into STRICT	cd_setor_atendimento_w
	from	procedimento_setor_atend b
	where	b.cd_procedimento		= cd_procedimento_p
	and		b.ie_origem_proced		= ie_origem_proced_p
	and		b.cd_setor_atendimento	= cd_setor_atend_p
	AND     ((coalesce(b.ie_somente_principal,'N') = 'N') OR
			((coalesce(b.ie_somente_principal,'N') = 'S') AND (ie_proced_principal_p = 'S')))
	and		b.cd_estabelecimento	= cd_estabelecimento_p;
end if;


if (coalesce(cd_setor_atendimento_w::text, '') = '') then

	if (nr_seq_proc_interno_p > 0) then
		select 	max(ie_tipo_atendimento)
		into STRICT	ie_tipo_atendimento_w
		from 	atendimento_paciente
		where 	nr_atendimento = nr_atendimento_p;

		select	max(cd_convenio),
			max(cd_categoria)
		into STRICT	cd_convenio_w,
			cd_categoria_w
		from	atend_categoria_convenio
		where	nr_seq_interno = Obter_Atecaco_atendimento(nr_atendimento_p);

		select	Obter_Setor_exec_proc_interno(nr_seq_proc_interno_p,cd_setor_origem_p, ie_tipo_atendimento_w, cd_convenio_w, cd_categoria_w, ie_proced_principal_p)
		into STRICT	cd_setor_atendimento_w
		;
	end if;

	if (coalesce(cd_setor_atendimento_w::text, '') = '') then
		select	max(b.cd_setor_exclusivo)
		into STRICT	cd_setor_exclusivo_w
		from	procedimento b,
				setor_atendimento a
		where	b.cd_procedimento	 = cd_procedimento_p
		and		b.ie_origem_proced	 = ie_origem_proced_p
		and		b.cd_setor_exclusivo = a.cd_setor_atendimento
		and		a.cd_estabelecimento = cd_estabelecimento_p;

		if (coalesce(cd_setor_exclusivo_w::text, '') = '') then

			if (coalesce(nr_atendimento_p,0) > 0) then
				select	coalesce(max(ie_setor_paciente),'N')
				into STRICT	ie_setor_paciente_w
				from	proc_interno
				where	nr_sequencia	= nr_seq_proc_interno_p;

				if (ie_setor_paciente_w = 'S') then
					cd_setor_atendimento_w	:= obter_setor_atendimento(nr_atendimento_p);
				end if;
			end if;


			if (coalesce(cd_setor_atendimento_w::text, '') = '') then
				if (coalesce(nm_usuario_p::text, '') = '') then
					open c01;
					loop
					fetch c01 into
						cd_setor_atendimento_w;
					EXIT WHEN NOT FOUND; /* apply on c01 */
						begin
						cd_setor_atendimento_w	:= cd_setor_atendimento_w;
						end;
					end loop;
					close c01;
				else
					open c02;
					loop
					fetch c02 into
						cd_setor_atendimento_w;
					EXIT WHEN NOT FOUND; /* apply on c02 */
						begin
						cd_setor_atendimento_w	:= cd_setor_atendimento_w;
						end;
					end loop;
					close c02;
				end if;
			end if;
		else
			cd_setor_atendimento_w := cd_setor_exclusivo_w;
		end if;
	end if;
end if;

return cd_setor_atendimento_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_setor_atend_proc ( cd_estabelecimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_setor_atend_p bigint, cd_setor_origem_p bigint, nm_usuario_p text, nr_seq_proc_interno_p bigint, nr_atendimento_p bigint, ie_proced_principal_p text default 'S') FROM PUBLIC;

