-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_resumo_contrato ( nr_seq_contrato_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/* ie_opcao_p
	QAA - Quantidade de ativos adesão
	VAA - Valor de ativos adesão
	QIA - Quantidade de inativos adesão
	VIA - Valor de inativos adesão
	QBA - Quantidade abertos adesão

	QAM - Quantidade de ativos migração
	VAM - Valor de ativos migração
	QIM - Quantidade de inativos migração
	VIM - Valor de inativos migração
	QBM - Quantidade abertos migração

	QAR - Quantidade de ativos reativação
	VAR - Valor de ativos reativação
	QIR - Quantidade de inativos reativação
	VIR - Valor de inativos reativação
	QBR - Quantidade abertos reativação
*/
vl_retorno_w				double precision;
qt_retorno_w				bigint;


BEGIN

if (ie_opcao_p = 'QAA') or (ie_opcao_p = 'VAA') then
	select	count(*),
				coalesce(sum(pls_obter_valor_segurado(b.nr_sequencia, 'VCD')),0)
	into STRICT		qt_retorno_w,
				vl_retorno_w
	from		pls_segurado b
	where		b.nr_seq_contrato = nr_seq_contrato_p
	and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and		coalesce(b.dt_migracao::text, '') = ''
	and		coalesce(b.dt_rescisao::text, '') = ''
	and		coalesce(b.dt_reativacao::text, '') = '';
elsif (ie_opcao_p = 'QIA') or (ie_opcao_p = 'VIA') then
	select	count(*),
				coalesce(sum(pls_obter_valor_segurado(b.nr_sequencia, 'VCD')),0)
	into STRICT		qt_retorno_w,
				vl_retorno_w
	from		pls_segurado b
	where		b.nr_seq_contrato = nr_seq_contrato_p
	and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and		(b.dt_rescisao IS NOT NULL AND b.dt_rescisao::text <> '')
	and		coalesce(b.dt_migracao::text, '') = '';
elsif (ie_opcao_p = 'QBA') then
	select	count(*)
	into STRICT		qt_retorno_w
	from		pls_segurado b
	where		b.nr_seq_contrato = nr_seq_contrato_p
	and		coalesce(b.dt_liberacao::text, '') = ''
	and		coalesce(b.dt_rescisao::text, '') = ''
	and		coalesce(b.dt_migracao::text, '') = '';
elsif (ie_opcao_p = 'QAM') or (ie_opcao_p = 'VAM') then
	select	count(*),
				coalesce(sum(pls_obter_valor_segurado(b.nr_sequencia, 'VCD')),0)
	into STRICT		qt_retorno_w,
				vl_retorno_w
	from		pls_segurado b
	where		b.nr_seq_contrato = nr_seq_contrato_p
	and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and		(b.dt_migracao IS NOT NULL AND b.dt_migracao::text <> '')
	and		coalesce(b.dt_rescisao::text, '') = '';
elsif (ie_opcao_p = 'QIM') or (ie_opcao_p = 'VIM') then
	select	count(*),
				coalesce(sum(pls_obter_valor_segurado(b.nr_sequencia, 'VCD')),0)
	into STRICT		qt_retorno_w,
				vl_retorno_w
	from		pls_segurado b
	where		b.nr_seq_contrato = nr_seq_contrato_p
	and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and		(b.dt_migracao IS NOT NULL AND b.dt_migracao::text <> '')
	and		(b.dt_rescisao IS NOT NULL AND b.dt_rescisao::text <> '');
elsif (ie_opcao_p = 'QBM') then
	select	count(*)
	into STRICT		qt_retorno_w
	from		pls_segurado b
	where		b.nr_seq_contrato = nr_seq_contrato_p
	and		coalesce(b.dt_liberacao::text, '') = ''
	and		(b.dt_migracao IS NOT NULL AND b.dt_migracao::text <> '')
	and		coalesce(b.dt_rescisao::text, '') = '';
elsif (ie_opcao_p = 'QAR') or (ie_opcao_p = 'VAR') then
	select	count(*),
				coalesce(sum(pls_obter_valor_segurado(b.nr_sequencia, 'VCD')),0)
	into STRICT		qt_retorno_w,
				vl_retorno_w
	from		pls_segurado b
	where		b.nr_seq_contrato = nr_seq_contrato_p
	and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and		coalesce(b.dt_migracao::text, '') = ''
	and		(b.dt_reativacao IS NOT NULL AND b.dt_reativacao::text <> '');
elsif (ie_opcao_p = 'QIR') or (ie_opcao_p = 'VIR') then
	select	count(*),
				coalesce(sum(pls_obter_valor_segurado(b.nr_sequencia, 'VCD')),0)
	into STRICT		qt_retorno_w,
				vl_retorno_w
	from		pls_segurado b
	where		b.nr_seq_contrato = nr_seq_contrato_p
	and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and		coalesce(b.dt_migracao::text, '') = ''
	and		(b.dt_reativacao IS NOT NULL AND b.dt_reativacao::text <> '')
	and		(b.dt_rescisao IS NOT NULL AND b.dt_rescisao::text <> '');
elsif (ie_opcao_p = 'QBR') then
	select	count(*)
	into STRICT		qt_retorno_w
	from		pls_segurado b
	where		b.nr_seq_contrato = nr_seq_contrato_p
	and		coalesce(b.dt_liberacao::text, '') = ''
	and		coalesce(b.dt_migracao::text, '') = ''
	and		(b.dt_reativacao IS NOT NULL AND b.dt_reativacao::text <> '');
end if;

if (substr(ie_opcao_p,1,1) = 'Q') then
	return qt_retorno_w;
else
	return vl_retorno_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_resumo_contrato ( nr_seq_contrato_p bigint, ie_opcao_p text) FROM PUBLIC;

