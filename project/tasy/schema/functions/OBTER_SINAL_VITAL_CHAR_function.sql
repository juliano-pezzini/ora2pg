-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_sinal_vital_char ( nr_atendimento_p bigint, ie_sinal_p text) RETURNS varchar AS $body$
DECLARE


vl_retorno_w		varchar(255);
nr_atend_alta_w		bigint;
dt_retorno_w		timestamp;


BEGIN

if (nr_atendimento_p > 0) and (ie_sinal_p IS NOT NULL AND ie_sinal_p::text <> '') then
	begin
		
	if (ie_sinal_p = obter_desc_expressao(295698)) then
		select	max(qt_peso)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_peso IS NOT NULL AND qt_peso::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'PesoData') then
		select	max(qt_peso),
				max(dt_sinal_vital)
		into STRICT	vl_retorno_w,
				dt_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_peso IS NOT NULL AND qt_peso::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
					
		if (vl_retorno_w IS NOT NULL AND vl_retorno_w::text <> '') then
			vl_retorno_w	:= vl_retorno_w ||' - '||to_char(dt_retorno_w,'dd/mm/yyyy hh24:mi');
		end if;
	elsif (ie_sinal_p = 'FC') then
		select	max(qt_freq_cardiaca)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_freq_cardiaca IS NOT NULL AND qt_freq_cardiaca::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'FR') then
		select	max(qt_freq_resp)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_freq_resp IS NOT NULL AND qt_freq_resp::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'PAMIN') then
		select	max(qt_pa_diastolica)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_pa_diastolica IS NOT NULL AND qt_pa_diastolica::text <> '')
					and	(qt_pa_sistolica IS NOT NULL AND qt_pa_sistolica::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'PAMAX') then
		select	max(qt_pa_sistolica)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_pa_sistolica IS NOT NULL AND qt_pa_sistolica::text <> '')
					and	(qt_pa_diastolica IS NOT NULL AND qt_pa_diastolica::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'SC') then
		select	max(qt_superf_corporia)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_superf_corporia IS NOT NULL AND qt_superf_corporia::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'IMC') then
		select	max(qt_imc)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_imc IS NOT NULL AND qt_imc::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'IM') then
		select	max(ie_membro)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(ie_membro IS NOT NULL AND ie_membro::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	elsif (ie_sinal_p = 'IA') then
		select	max(ie_aparelho_pa)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(ie_aparelho_pa IS NOT NULL AND ie_aparelho_pa::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	elsif (ie_sinal_p = obter_desc_expressao(283402)) then
		select	max(qt_altura_cm)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_altura_cm IS NOT NULL AND qt_altura_cm::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = obter_desc_expressao(299207)) then
		select	max(qt_temp)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_temp IS NOT NULL AND qt_temp::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'ESCDOR') then
		select	max(qt_escala_dor)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_escala_dor IS NOT NULL AND qt_escala_dor::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'PAM') then
		select	max(qt_pam)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_pam IS NOT NULL AND qt_pam::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');					
	elsif (ie_sinal_p = 'GC') then
		select	max(qt_glicemia_capilar)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_glicemia_capilar IS NOT NULL AND qt_glicemia_capilar::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	elsif (ie_sinal_p = 'REDOR') then
		select	max(NR_SEQ_RESULT_DOR)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(NR_SEQ_RESULT_DOR IS NOT NULL AND NR_SEQ_RESULT_DOR::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	elsif (ie_sinal_p = 'SAT') then
		select	max(qt_saturacao_o2)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_saturacao_o2 IS NOT NULL AND qt_saturacao_o2::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
   elsif (ie_sinal_p = 'DTGC') then
         select	to_char(max(dt_atualizacao_nrec),'dd/mm/yyyy hh24:mi:ss')
         into STRICT	vl_retorno_w
         from	atendimento_sinal_vital
         where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
                  from	atendimento_sinal_vital
                  where	(qt_glicemia_capilar IS NOT NULL AND qt_glicemia_capilar::text <> '')
                  and	nr_atendimento	= nr_atendimento_p
                  and	coalesce(ie_situacao,'A') = 'A'
                  and	coalesce(IE_RN,'N')	= 'N');	
   elsif (ie_sinal_p = 'TMGC') then
         select	max(ie_tipo_medicao)
         into STRICT	vl_retorno_w
         from	atendimento_sinal_vital
         where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
                  from	atendimento_sinal_vital
                  where	(qt_glicemia_capilar IS NOT NULL AND qt_glicemia_capilar::text <> '')
                  and	nr_atendimento	= nr_atendimento_p
                  and	coalesce(ie_situacao,'A') = 'A'
                  and	coalesce(IE_RN,'N')	= 'N');	
	elsif (ie_sinal_p = 'dataSinal') then
         select	max(dt_sinal_vital)
         into STRICT	vl_retorno_w
         from	atendimento_sinal_vital
         where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(dt_sinal_vital IS NOT NULL AND dt_sinal_vital::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	ie_situacao = 'A'
					and	coalesce(IE_RN,'N')	= 'N');
	elsif (ie_sinal_p = 'REVISAOPE') then			
		select	max(ie_revisao_pe)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(ie_revisao_pe IS NOT NULL AND ie_revisao_pe::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	elsif (ie_sinal_p = 'OLHO') then			
		select	max(ie_fundo_olho)
		into STRICT	vl_retorno_w
		from	atendimento_sinal_vital
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(ie_fundo_olho IS NOT NULL AND ie_fundo_olho::text <> '')
					and	nr_atendimento	= nr_atendimento_p
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(IE_RN,'N')	= 'N');	
	end if;	
	
	end;

	if (coalesce(vl_retorno_w::text, '') = '') then

		select 	max(nr_atend_alta)
		into STRICT	nr_atend_alta_w
		from 	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
		
		if (nr_atend_alta_w IS NOT NULL AND nr_atend_alta_w::text <> '') then
			begin
				
			if (ie_sinal_p = obter_desc_expressao(295698)) then
				select	max(qt_peso)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_peso IS NOT NULL AND qt_peso::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'FC') then
				select	max(qt_freq_cardiaca)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_freq_cardiaca IS NOT NULL AND qt_freq_cardiaca::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'FR') then
				select	max(qt_freq_resp)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_freq_resp IS NOT NULL AND qt_freq_resp::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'PAMIN') then
				select	max(qt_pa_diastolica)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_pa_diastolica IS NOT NULL AND qt_pa_diastolica::text <> '')
							and	(qt_pa_sistolica IS NOT NULL AND qt_pa_sistolica::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'PAMAX') then
				select	max(qt_pa_sistolica)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_pa_sistolica IS NOT NULL AND qt_pa_sistolica::text <> '')
							and	(qt_pa_diastolica IS NOT NULL AND qt_pa_diastolica::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'SC') then
				select	max(qt_superf_corporia)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_superf_corporia IS NOT NULL AND qt_superf_corporia::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'IMC') then
				select	max(qt_imc)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_imc IS NOT NULL AND qt_imc::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = obter_desc_expressao(283402)) then
				select	max(qt_altura_cm)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital	
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_altura_cm IS NOT NULL AND qt_altura_cm::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = obter_desc_expressao(299207)) then
				select	max(qt_temp)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_temp IS NOT NULL AND qt_temp::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'ESCDOR') then
				select	max(qt_escala_dor)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_escala_dor IS NOT NULL AND qt_escala_dor::text <> '')
							and	nr_atendimento	= nr_atendimento_p
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'PAM') then
				select	max(qt_pam)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_pam IS NOT NULL AND qt_pam::text <> '')
							and	nr_atendimento	= nr_atendimento_p
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');							
			elsif (ie_sinal_p = 'GC') then
				select	max(qt_glicemia_capilar)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(qt_glicemia_capilar IS NOT NULL AND qt_glicemia_capilar::text <> '')
							and	nr_atendimento	= nr_atendimento_p
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');		
			elsif (ie_sinal_p = 'dataSinal') then
				select	max(dt_sinal_vital)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(dt_sinal_vital IS NOT NULL AND dt_sinal_vital::text <> '')
							and	nr_atendimento	= nr_atendimento_p
							and	ie_situacao = 'A'
							and	coalesce(IE_RN,'N')	= 'N');
			elsif (ie_sinal_p = 'REVISAOPE') then
				select	max(ie_revisao_pe)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(ie_revisao_pe IS NOT NULL AND ie_revisao_pe::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');	
			elsif (ie_sinal_p = 'OLHO') then
				select	max(ie_fundo_olho)
				into STRICT	vl_retorno_w
				from	atendimento_sinal_vital
				where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
							from	atendimento_sinal_vital
							where	(ie_fundo_olho IS NOT NULL AND ie_fundo_olho::text <> '')
							and	nr_atendimento	= nr_atend_alta_w
							and	coalesce(ie_situacao,'A') = 'A'
							and	coalesce(IE_RN,'N')	= 'N');			
			end if;
			end;
		
		end if;
	end if;

end if;

return vl_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_sinal_vital_char ( nr_atendimento_p bigint, ie_sinal_p text) FROM PUBLIC;

