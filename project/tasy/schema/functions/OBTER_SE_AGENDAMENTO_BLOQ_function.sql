-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_agendamento_bloq (nr_seq_agenda_p bigint) RETURNS varchar AS $body$
DECLARE


dt_inicial_w				timestamp;
dt_final_w				timestamp;
hr_inicial_w				varchar(20);
hr_final_w				varchar(20);
ie_dia_semana_w				integer;
ie_classif_bloqueio_w			varchar(5);
ie_bloqueado_w				varchar(1) := 'N';

dt_agenda_w				agenda_consulta. dt_agenda %type;
hr_agenda_w				varchar(10);
nr_dia_semana_w				bigint;
ie_business_day_w			bigint;
ie_classif_agenda_w			agenda_consulta. ie_classif_agenda %type;

C01 CURSOR FOR
SELECT	trunc(b.dt_inicial),
	fim_dia(b.dt_final),
	coalesce(to_char(b.hr_inicio_bloqueio,'hh24:mi:ss'),'00:00:00'),
	coalesce(to_char(b.hr_final_bloqueio,'hh24:mi:ss'),'00:00:00'),
	b.ie_dia_semana,
	b.ie_classif_bloqueio
from	agenda_bloqueio b,
	agenda a,
	agenda_consulta c
where	a.cd_agenda = b.cd_agenda
and	a.cd_agenda = c.cd_agenda
and	c.nr_sequencia = nr_seq_agenda_p;


BEGIN
if (nr_seq_agenda_p > 0) then
	select	a.dt_agenda,
		to_char(a.dt_agenda,'hh24:mi:ss'),
		pkg_date_utils.get_WeekDay(a.dt_agenda),
		pkg_date_utils.is_business_day(a.dt_agenda),
		a.ie_classif_agenda
	into STRICT	dt_agenda_w,
		hr_agenda_w,
		nr_dia_semana_w,
		ie_business_day_w,
		ie_classif_agenda_w
	from	agenda_consulta a
	where	a.nr_sequencia = nr_seq_agenda_p;

	open C01;
	loop
	fetch C01 into
			dt_inicial_w,
			dt_final_w,
			hr_inicial_w,
			hr_final_w,
			ie_dia_semana_w,
			ie_classif_bloqueio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_bloqueado_w = 'N') then
			if (hr_inicial_w <> '00:00:00') and (hr_final_w <> '00:00:00') then
				begin
				if (dt_agenda_w between dt_inicial_w and dt_final_w) and (hr_agenda_w between hr_inicial_w and hr_final_w) and
					((nr_dia_semana_w = ie_dia_semana_w) or (ie_dia_semana_w = 9 and ie_business_day_w = 1) or (coalesce(ie_dia_semana_w::text, '') = '')) and (ie_classif_agenda_w = ie_classif_bloqueio_w or coalesce(ie_classif_bloqueio_w::text, '') = '') then
					ie_bloqueado_w := 'S';
				end if;
				end;
			elsif (hr_inicial_w <> '00:00:00') then
				begin
				if (dt_agenda_w between dt_inicial_w and dt_final_w) and (hr_agenda_w > hr_inicial_w) and
					((nr_dia_semana_w = ie_dia_semana_w) or (ie_dia_semana_w = 9 and ie_business_day_w = 1) or (coalesce(ie_dia_semana_w::text, '') = '')) and (ie_classif_agenda_w = ie_classif_bloqueio_w or coalesce(ie_classif_bloqueio_w::text, '') = '') then
					ie_bloqueado_w := 'S';
				end if;
				end;
			elsif (hr_final_w <> '00:00:00') then
				begin
				if (dt_agenda_w between dt_inicial_w and dt_final_w) and (hr_agenda_w < hr_final_w) and
					((nr_dia_semana_w = ie_dia_semana_w) or (ie_dia_semana_w = 9 and ie_business_day_w = 1) or (coalesce(ie_dia_semana_w::text, '') = '')) and (ie_classif_agenda_w = ie_classif_bloqueio_w or coalesce(ie_classif_bloqueio_w::text, '') = '') then
					ie_bloqueado_w := 'S';
				end if;
				end;
			else
				begin
				if (dt_agenda_w between dt_inicial_w and dt_final_w) and
					((nr_dia_semana_w = ie_dia_semana_w) or (ie_dia_semana_w = 9 and ie_business_day_w = 1) or (coalesce(ie_dia_semana_w::text, '') = '')) and (ie_classif_agenda_w = ie_classif_bloqueio_w or coalesce(ie_classif_bloqueio_w::text, '') = '') then
					ie_bloqueado_w := 'S';
				end if;
				end;
			end if;
		end if;
		end;
	end loop;
	close C01;
end if;
return ie_bloqueado_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_agendamento_bloq (nr_seq_agenda_p bigint) FROM PUBLIC;

