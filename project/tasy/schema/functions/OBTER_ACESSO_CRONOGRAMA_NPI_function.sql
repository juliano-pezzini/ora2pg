-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_acesso_cronograma_npi ( nr_seq_projeto_p text, nr_seq_fase_processo_p text, nm_usuario_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
nm_usuario_cron_w		varchar(15);
qt_regra_w			bigint;
ie_retorno_w			varchar(1);
ie_permite_visualizar_w		varchar(1);
ie_permite_criar_w		varchar(1);
ie_permite_liberar_w		varchar(1);

/* 
ie_opcao 
 
V = Visualizar 
C = Criar / Editar 
L = Liberar (Aprovar cronograma) 
*/
 
			 

BEGIN 
 
ie_retorno_w:= 'N';
 
select	coalesce(max(a.ie_permite_visualizar),'N'), 
	coalesce(max(a.ie_permite_criar),'N'), 
	coalesce(max(a.ie_permite_liberar),'N') 
into STRICT	ie_permite_visualizar_w, 
	ie_permite_criar_w, 
	ie_permite_liberar_w 
from	PRP_REGRA_CRONOGRAMA a 
where	((coalesce(a.nm_usuario_cron ,'0') = '0') or (	SELECT	count(*) 
							 
							where	a.nm_usuario_cron = nm_usuario_p) > 0) 
and	((coalesce(a.nr_seq_grupo_cargo ,0) = 0) or (	select	count(*) 
							from	prp_regra_equipe_padrao x, 
								prp_area_processo_partic y, 
								prp_regra_equipe_partic k 
							where	x.nr_seq_area_proc_partic = y.nr_sequencia 
							and	a.nr_seq_grupo_cargo = y.nr_seq_grupo 
							and	x.nr_sequencia = k.nr_seq_equipe_padrao 
							and	k.cd_pessoa_fisica = obter_pf_usuario(nm_usuario_p,'C')) > 0) 
and	((coalesce(a.nr_seq_fase_processo,0) = 0) or (	select	count(*) 
							 
							where	a.nr_seq_fase_processo = nr_seq_fase_processo_p) > 0) 
and	((coalesce(a.ie_tipo_cronograma,0) = 0) or (		SELECT	count(*) 
							from	proj_projeto x 
							where	(x.nr_seq_tipo_projeto IS NOT NULL AND x.nr_seq_tipo_projeto::text <> '') 
							and	x.nr_sequencia = nr_seq_projeto_p) > 0) 
and	((coalesce(a.ie_equipe_projeto,'N') = 'N') or (	select	count(*) 
							from	proj_equipe x, 
								proj_equipe_papel y 
							where	x.nr_sequencia = y.nr_seq_equipe 
							and	x.nr_seq_proj = nr_seq_projeto_p 
							and	y.cd_pessoa_fisica = obter_pf_usuario(nm_usuario_p,'C')) > 0) 
and	((coalesce(a.ie_permite_visualizar,'N') = 'N') or (a.ie_permite_visualizar = 'S')) 
and	((coalesce(a.ie_permite_criar,'N') = 'N') or (a.ie_permite_criar = 'S')) 
and	((coalesce(a.ie_permite_liberar,'N') = 'N') or (a.ie_permite_liberar = 'S'));
 
if (ie_opcao_p = 'V') then 
	ie_retorno_w:= ie_permite_visualizar_w;
elsif (ie_opcao_p = 'C') then 
	ie_retorno_w:= ie_permite_criar_w;
elsif (ie_opcao_p = 'L') then 
	ie_retorno_w:= ie_permite_liberar_w;
end if;
 
return	ie_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_acesso_cronograma_npi ( nr_seq_projeto_p text, nr_seq_fase_processo_p text, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

