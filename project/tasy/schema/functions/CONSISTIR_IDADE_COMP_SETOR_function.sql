-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consistir_idade_comp_setor (cd_pessoa_fisica_p text, cd_setor_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

			 
ie_idade_perm_setor	varchar(1) := 'S';
qt_idade_minima_w	real;
qt_idade_maxima_w	real;
qt_idade_dias_min_w	smallint;
qt_idade_dias_max_w	smallint;
qt_idade_anos_w		real;
qt_idade_dias_w		bigint;
qt_idade_w		real;
nr_sequencia_regra_w	bigint;


BEGIN 
ie_idade_perm_setor := 'S';
 
 
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then 
 
	select	obter_idade_pf(cd_pessoa_fisica_p,clock_timestamp(),'A') 
	into STRICT	qt_idade_anos_w 
	;
	 
	qt_idade_w := qt_idade_anos_w;
	 
	select	coalesce(max(nr_sequencia),0) 
	into STRICT	nr_sequencia_regra_w 
	from	regra_setor 
	where	cd_setor_atendimento	=	cd_setor_atendimento_p;
	 
	if (nr_sequencia_regra_w > 0) then 
 
		select	qt_idade_min, 
			qt_idade_max, 
			qt_idade_dias_min, 
			qt_idade_dias_max 
		into STRICT	qt_idade_minima_w, 
			qt_idade_maxima_w, 
			qt_idade_dias_min_w, 
			qt_idade_dias_max_w 
		from	regra_setor 
		where	cd_setor_atendimento	=	cd_setor_atendimento_p 
		and	nr_sequencia 		= 	nr_sequencia_regra_w;
		 
		if (coalesce(qt_idade_dias_min_w::text, '') = '') and (coalesce(qt_idade_dias_max_w::text, '') = '') then 
 
			if (qt_idade_minima_w IS NOT NULL AND qt_idade_minima_w::text <> '') and (qt_idade_minima_w > qt_idade_w) then 
				ie_idade_perm_setor := 'N';	
			end if;
 
			if (qt_idade_maxima_w IS NOT NULL AND qt_idade_maxima_w::text <> '') and (qt_idade_maxima_w < qt_idade_w) then 
				ie_idade_perm_setor := 'N';	
			end if;
		else		 
				 
				select trunc(clock_timestamp()-to_date(obter_dados_pf(cd_pessoa_fisica_p,'DN'))) 
				into STRICT	qt_idade_dias_w 
				;
			 
				if (qt_idade_dias_min_w IS NOT NULL AND qt_idade_dias_min_w::text <> '') and (qt_idade_w = 0) and (qt_idade_dias_min_w > qt_idade_dias_w) then 
					ie_idade_perm_setor := 'N';
				end if;
				 
		 
				if (qt_idade_dias_max_w IS NOT NULL AND qt_idade_dias_max_w::text <> '') and (qt_idade_w = 0) and (qt_idade_dias_max_w < qt_idade_dias_w) then 
					ie_idade_perm_setor := 'N';	
				elsif (qt_idade_dias_max_w IS NOT NULL AND qt_idade_dias_max_w::text <> '') and (qt_idade_w > 0) then 
					ie_idade_perm_setor := 'N';
				end if;
 
				if (qt_idade_minima_w IS NOT NULL AND qt_idade_minima_w::text <> '') and (qt_idade_w > 0) and (qt_idade_minima_w > qt_idade_w) then 
					ie_idade_perm_setor := 'N';	
				end if;
 
				if (qt_idade_maxima_w IS NOT NULL AND qt_idade_maxima_w::text <> '') and (qt_idade_w > 0) and (qt_idade_maxima_w < qt_idade_w) then 
					ie_idade_perm_setor := 'N';	
				end if;			
					 
		end if;
	end if;
end if;
 
return	ie_idade_perm_setor;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consistir_idade_comp_setor (cd_pessoa_fisica_p text, cd_setor_atendimento_p bigint) FROM PUBLIC;

