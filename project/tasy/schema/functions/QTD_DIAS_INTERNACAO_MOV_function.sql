-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION qtd_dias_internacao_mov ( nr_atendimento_p bigint, cd_setor_atend_p bigint) RETURNS bigint AS $body$
DECLARE


qt_dias_w		bigint := 0;
dt_entrada_unidade_w	timestamp;
dt_saida_unidade_w	timestamp;
dt_entrada_ant_w	timestamp := null;
C01 CURSOR FOR
	SELECT	a.dt_entrada_unidade,
		coalesce(a.dt_saida_unidade,clock_timestamp())
	FROM 	atend_paciente_unidade a,
		setor_atendimento b
	WHERE 	a.nr_atendimento       = nr_atendimento_p
	AND	a.cd_setor_atendimento = cd_setor_atend_p
	AND   	a.cd_setor_atendimento = b.cd_setor_atendimento
	AND   	b.cd_classif_setor IN (3,4)
	order by a.cd_setor_atendimento, a.dt_entrada_unidade;



BEGIN
if (coalesce(nr_atendimento_p,0) > 0) and (coalesce(cd_setor_atend_p,0) > 0) then

	open C01;
	loop
	fetch C01 into
		dt_entrada_unidade_w,
		dt_saida_unidade_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		qt_dias_w := qt_dias_w + coalesce(obter_dias_entre_datas(dt_entrada_unidade_w,dt_saida_unidade_w),0);
		if (dt_entrada_ant_w IS NOT NULL AND dt_entrada_ant_w::text <> '') and (trunc(dt_entrada_ant_w) <> trunc(dt_saida_unidade_w)) then
			qt_dias_w := qt_dias_w - 1;
		dt_entrada_ant_w := dt_entrada_unidade_w;
		end if;
		end;
	end loop;
	close C01;

end if;
qt_dias_w := qt_dias_w + 1;
return	qt_dias_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION qtd_dias_internacao_mov ( nr_atendimento_p bigint, cd_setor_atend_p bigint) FROM PUBLIC;

