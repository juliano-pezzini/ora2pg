-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION fa_obter_data_retorno_pmc ( cd_pessoa_fisica_p text, nr_seq_pac_pmc_p bigint) RETURNS timestamp AS $body$
DECLARE


dt_prevista_retorno_w	timestamp;
ie_tipo_entrega_w	varchar(3);

BEGIN
select	max(substr(fa_obter_tipo_entrega_pac(nr_seq_pac_pmc_p),1,3))
into STRICT	ie_tipo_entrega_w
;

if (ie_tipo_entrega_w = 'PMC') then

	SELECT  trunc(min(dt_prevista_retorno))
	into STRICT	dt_prevista_retorno_w
	FROM   	fa_entrega_medicacao a
	WHERE  	cd_pessoa_fisica = cd_pessoa_fisica_p
	and		coalesce(dt_cancelamento::text, '') = ''
	and		trunc(dt_prevista_retorno) >= trunc(clock_timestamp())
	and	exists ( 	SELECT 	1
				from   	FA_ENTREGA_MEDICACAO_ITEM b,
					fa_medic_farmacia_amb c
				where  	b.nr_seq_fa_entrega	         = a.nr_sequencia
				and    	b.cd_material 		= c.cd_material
				and    coalesce(c.ie_medicamento_pmc,'N') = 'S');




elsif (ie_tipo_entrega_w = 'PNC') then
	SELECT  trunc(min(dt_prevista_retorno))
	into STRICT	dt_prevista_retorno_w
	FROM   	fa_entrega_medicacao a
	WHERE  	cd_pessoa_fisica = cd_pessoa_fisica_p
	and	coalesce(dt_cancelamento::text, '') = ''
	and		trunc(dt_prevista_retorno) >= trunc(clock_timestamp())
	and	exists ( 	SELECT 	1
				from   	FA_ENTREGA_MEDICACAO_ITEM b,
					fa_medic_farmacia_amb c
				where  	b.nr_seq_fa_entrega	         = a.nr_sequencia
				and    	b.cd_material 		= c.cd_material
				and    coalesce(c.ie_nutricao,'N') = 'S');
end if;

if (coalesce(dt_prevista_retorno_w::text, '') = '') then
	SELECT  trunc(max(dt_prevista_retorno))
	into STRICT	dt_prevista_retorno_w
	FROM   	fa_entrega_medicacao a
	WHERE  	cd_pessoa_fisica = cd_pessoa_fisica_p
	and	coalesce(dt_cancelamento::text, '') = ''
	and ( exists ( 	SELECT 	1
				from   	FA_ENTREGA_MEDICACAO_ITEM b,
					fa_medic_farmacia_amb c
				where  	b.nr_seq_fa_entrega	         = a.nr_sequencia
				and    	b.cd_material 		= c.cd_material
				and (coalesce(c.ie_medicamento_pmc,'N') = 'S' or coalesce(c.ie_nutricao,'N') = 'S')) or ( fa_obter_se_entrega_pmc(a.nr_sequencia) = 'S'));
end if;


if (coalesce(dt_prevista_retorno_w::text, '') = '') then
	select	trunc(max(DT_RETORNO))
	into STRICT	dt_prevista_retorno_w
	from	fa_paciente_pmc
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;
end if;
return	dt_prevista_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION fa_obter_data_retorno_pmc ( cd_pessoa_fisica_p text, nr_seq_pac_pmc_p bigint) FROM PUBLIC;

