-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION status_hemocomp_dispensacao ( NR_SEQ_PRODUCAO_P bigint, NR_SEQ_TRANSFUSAO_P bigint ) RETURNS varchar AS $body$
DECLARE

	IE_STATUS_RETORNO_W	varchar(2);
	NR_SANGUE_W			varchar(20);
	NR_SEQ_TRANSFUSAO_W	bigint;
    NR_SEQUENCIA_W	    bigint;

BEGIN
	SELECT
		MAX(NR_SANGUE),
		MAX(NR_SEQ_TRANSFUSAO)
	INTO STRICT
		NR_SANGUE_W,
		NR_SEQ_TRANSFUSAO_W
	FROM
		SAN_PRODUCAO A
	WHERE
		A.NR_SEQUENCIA      = NR_SEQ_PRODUCAO_P
	AND A.NR_SEQ_TRANSFUSAO = NR_SEQ_TRANSFUSAO_P
;
	
	IF coalesce(NR_SANGUE_W::text, '') = '' THEN
		RETURN NULL;
	END IF;

    SELECT
        MAX(PRD_B.NR_SEQUENCIA)
    INTO STRICT
        NR_SEQUENCIA_W
    FROM
        SAN_PRODUCAO PRD_B INNER JOIN SAN_TRANSFUSAO ST ON
            ST.NR_SEQUENCIA = PRD_B.NR_SEQ_TRANSFUSAO
    WHERE
        PRD_B.NR_SANGUE = NR_SANGUE_W
    AND PRD_B.NR_SEQ_TRANSFUSAO <> NR_SEQ_TRANSFUSAO_W
    AND NOT coalesce(ST.DT_DISPENSADO::text, '') = ''
    AND ST.IE_STATUS <> 'C'
;

	IF NOT coalesce(NR_SEQUENCIA_W::text, '') = '' THEN
		RETURN 'D'; -- DISPENSADO
	END IF;

    SELECT
        MAX(NR_SEQUENCIA)
    INTO STRICT
        NR_SEQUENCIA_W
    FROM (
        SELECT
			MAX(PRD_B.NR_SEQUENCIA) NR_SEQUENCIA
		FROM
			SAN_PRODUCAO PRD_B INNER JOIN SAN_TRANSFUSAO ST ON
				ST.NR_SEQUENCIA = NR_SEQ_TRANSFUSAO_W
			INNER JOIN SAN_RESERVA_PROD SRP ON
					SRP.NR_SEQ_PRODUCAO = PRD_B.NR_SEQUENCIA
				AND ST.NR_SEQ_RESERVA <> PRD_B.NR_SEQ_RESERVA
			INNER JOIN SAN_RESERVA R ON
				R.NR_SEQUENCIA = SRP.NR_SEQ_RESERVA
		WHERE
			PRD_B.NR_SANGUE = NR_SANGUE_W
		AND PRD_B.NR_SEQ_TRANSFUSAO <> NR_SEQ_TRANSFUSAO_W
		AND R.IE_STATUS <> 'C'
		AND ST.IE_STATUS <> 'C'
		
UNION ALL

		SELECT
			MAX(PRD_B.NR_SEQUENCIA) NR_SEQUENCIA
		FROM
			SAN_PRODUCAO PRD_B INNER JOIN SAN_TRANSFUSAO ST ON
				ST.NR_SEQUENCIA = PRD_B.NR_SEQ_TRANSFUSAO
		WHERE
			PRD_B.NR_SANGUE = NR_SANGUE_W
		AND PRD_B.NR_SEQ_TRANSFUSAO <> NR_SEQ_TRANSFUSAO_W
		AND NOT coalesce(PRD_B.NR_SEQ_TRANSFUSAO::text, '') = ''
		AND ST.IE_STATUS <> 'C'
        ) TB
;

    IF NOT coalesce(NR_SEQUENCIA_W::text, '') = '' THEN
		RETURN 'R'; -- RESERVADO
	END IF;

    SELECT
        MAX(PRD_B.NR_SEQUENCIA)
    INTO STRICT
       NR_SEQUENCIA_W
    FROM
        SAN_PRODUCAO PRD_B INNER JOIN SAN_TRANSFUSAO ST ON
            ST.NR_SEQUENCIA = NR_SEQ_TRANSFUSAO_W
        INNER JOIN SAN_RESERVA_PROD SRP ON
                SRP.NR_SEQ_PRODUCAO = PRD_B.NR_SEQUENCIA
            AND ST.NR_SEQ_RESERVA <> PRD_B.NR_SEQ_RESERVA
    WHERE
        PRD_B.NR_SANGUE = NR_SANGUE_W
    AND PRD_B.NR_SEQ_TRANSFUSAO <> NR_SEQ_TRANSFUSAO_W
    AND SRP.IE_STATUS <> 'N'
    AND ST.IE_STATUS <> 'C'
;

	IF NOT coalesce(NR_SEQUENCIA_W::text, '') = '' THEN
		RETURN 'U'; -- UTILIZADO
	END IF;

    RETURN NULL;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION status_hemocomp_dispensacao ( NR_SEQ_PRODUCAO_P bigint, NR_SEQ_TRANSFUSAO_P bigint ) FROM PUBLIC;

