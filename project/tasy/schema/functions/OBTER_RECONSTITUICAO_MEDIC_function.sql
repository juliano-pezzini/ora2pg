-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_reconstituicao_medic ( nr_sequencia_p bigint, nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE



cd_material_w			integer;
ds_retorno_w			varchar(2000)	:= '';
qt_dose_w			double precision;
ds_reconstituir_w		varchar(255) 	:= '';
qt_min_aplicacao_ant_w		smallint  	:= 0;
cd_unid_med_dose_w		varchar(30) 	:= '';
qt_solucao_w			double precision 	:= 0;
qt_hora_aplicacao_ant_w		smallint  	:= 0;
ie_agrupador_w			smallint;
cd_unidade_medida_w		varchar(30);
mascara_w			smallint 	:= 0;
ds_material_w			varchar(100);
qt_dose_str_w			varchar(20) 	:= '';

c01 CURSOR FOR
	SELECT	cd_material,
		qt_dose,
		qt_min_aplicacao,
		qt_hora_aplicacao,
		cd_unidade_medida_dose,
		ie_agrupador,
		qt_solucao
	from 	prescr_material
	where 	((nr_sequencia_diluicao = nr_sequencia_p) or (nr_sequencia = nr_sequencia_p))
	and 	nr_prescricao = nr_prescricao_p
	and	ie_agrupador in (1,9,3,7)
	order by ie_agrupador;


BEGIN

select	cd_unidade_medida
into STRICT	cd_unidade_medida_w
from 	prescr_material
where 	nr_sequencia	= nr_sequencia_p
and 	nr_prescricao 	= nr_prescricao_p
and	ie_agrupador 	= 1;

open	c01;
loop
fetch	c01 into
	cd_material_w,
	qt_dose_w,
	qt_min_aplicacao_ant_w,
	qt_hora_aplicacao_ant_w,
	cd_unid_med_dose_w,
	ie_agrupador_w,
	qt_solucao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 9) then
		begin
		select 	substr(obter_desc_material(cd_material_w),1,80)
	   	into STRICT	ds_material_w
	   	;

		if (qt_dose_w < 1) or (mod(qt_dose_w, trunc(qt_dose_w)) <> 0) then
			mascara_w	:= 0;
		else
			mascara_w	:= 1;
		end if;

		Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_dose_w, 2)  ELSE campo_mascara(qt_dose_w, 0) END
		into STRICT	qt_dose_str_w
		;

		ds_reconstituir_w := 	ds_reconstituir_w || obter_desc_expressao(346565) ||cd_unidade_medida_w ||
				obter_desc_expressao(341615)||replace(qt_dose_str_w,'.',',')||' '||cd_unid_med_dose_w||
				obter_desc_expressao(746911)||ds_material_w;


		end;
	end if;

	end;
end loop;
close c01;

ds_retorno_w 	:= ds_reconstituir_w;
ds_retorno_w	:= replace(ds_retorno_w,' ,',' 0,');
ds_retorno_w	:= replace(ds_retorno_w,' .',' 0,');

return substr(ds_retorno_w,1,2000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_reconstituicao_medic ( nr_sequencia_p bigint, nr_prescricao_p bigint) FROM PUBLIC;

