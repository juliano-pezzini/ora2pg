-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gqa_obter_se_etapa_tag_lib (ie_funcao_p text, nr_seq_protocolo_p bigint) RETURNS varchar AS $body$
DECLARE


resposta             varchar(1) := 'S';
qtd                  bigint;
nr_sequencia_atual_w gqa_protocolo_etapa_pac.nr_sequencia%type;
nr_seq_etapa_atual_w gqa_protocolo_etapa_pac.nr_seq_etapa%type;

BEGIN
  begin
    select nr_sequencia, nr_seq_etapa into STRICT nr_sequencia_atual_w, nr_seq_etapa_atual_w from (
        SELECT dt_inicio, nr_sequencia, nr_seq_etapa from gqa_protocolo_etapa_pac
        where nr_seq_prot_pac = nr_seq_protocolo_p and (dt_inicio IS NOT NULL AND dt_inicio::text <> '')
        order by dt_inicio desc
    ) alias1 LIMIT 1;
  exception when no_data_found then
    nr_sequencia_atual_w := null;
    nr_seq_etapa_atual_w := null;
  end;

  if (nr_sequencia_atual_w IS NOT NULL AND nr_sequencia_atual_w::text <> '' AND nr_seq_etapa_atual_w IS NOT NULL AND nr_seq_etapa_atual_w::text <> '') then
    select count(1) into STRICT qtd from gqa_pendencia_regra_tag where nr_seq_gqa_regra = nr_seq_etapa_atual_w;

    if (qtd = 0) then --se nao tiver nada cadastrado para esse protocolo, retorna sim.
      return 'S';
    else --tem cadastrado, fazer consistencias.
      select  CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
        into STRICT  resposta
        from  gqa_pendencia_regra_tag
        where nr_seq_gqa_regra = nr_seq_etapa_atual_w and coalesce(ie_funcao,ie_funcao_p) = ie_funcao_p
        and (coalesce(cd_perfil::text, '') = ''
        or    cd_perfil = wheb_usuario_pck.get_cd_perfil)
        and (coalesce(cd_estabelecimento::text, '') = ''
        or    cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento)
        and (coalesce(cd_setor_atendimento::text, '') = ''
        or    cd_setor_atendimento = wheb_usuario_pck.get_cd_setor_atendimento)
        and (coalesce(cd_especialidade::text, '') = ''
        or    cd_especialidade = obter_especialidade_pf(obter_pf_usuario(wheb_usuario_pck.get_nm_usuario, 'C')));

      return resposta;
    end if;
  else
    return 'S';
  end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gqa_obter_se_etapa_tag_lib (ie_funcao_p text, nr_seq_protocolo_p bigint) FROM PUBLIC;

