-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hscs_obter_prescricoes_dia ( nr_atendimento_p bigint, ie_status_prescr_p text default 'T') RETURNS varchar AS $body$
DECLARE


ds_temp_w varchar(4000);
ds_retorno_w  varchar(4000);

/*
ie_status_prescr_p
T	- Todas
L	- Liberadas
N	- NÃ£o liberadas
*/
c01 CURSOR FOR
	SELECT  distinct
		w.nr_prescricao
	from	prescr_medica w
	where	w.nr_atendimento = nr_atendimento_p
	and	trunc(w.dt_prescricao) = trunc(clock_timestamp())
	and	((ie_status_prescr_p = 'T') or
		 ((ie_status_prescr_p = 'L') and ((coalesce(w.dt_liberacao,w.dt_liberacao_medico) IS NOT NULL AND (coalesce(w.dt_liberacao,w.dt_liberacao_medico))::text <> ''))) or
		 ((ie_status_prescr_p = 'N') and (coalesce(coalesce(w.dt_liberacao,w.dt_liberacao_medico)::text, '') = '')))
	order by w.nr_prescricao desc;

BEGIN

ds_retorno_w := '';

open  c01;
loop
fetch c01 into
	ds_temp_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	ds_retorno_w := substr(ds_retorno_w || ds_temp_w||', ',1,4000);
	end;
end loop;
close c01;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hscs_obter_prescricoes_dia ( nr_atendimento_p bigint, ie_status_prescr_p text default 'T') FROM PUBLIC;

