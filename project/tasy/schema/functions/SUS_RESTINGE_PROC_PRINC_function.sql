-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_restinge_proc_princ (cd_procedimento_p procedimento_paciente.cd_procedimento%type, ie_origem_proced_p procedimento_paciente.ie_origem_proced%type, nr_seq_proc_interno_p procedimento_paciente.nr_seq_proc_interno%type, cd_setor_atendimento_p procedimento_paciente.cd_setor_atendimento%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) RETURNS bigint AS $body$
DECLARE


qt_retorno_w			bigint := 1;
qt_reg_proc_w			bigint;
qt_reg_proc_princ_w		bigint;
cd_procedimento_real_w		sus_aih_unif.cd_procedimento_real%type;
nr_seq_regra_sh_w		sus_regra_rateio_sh.nr_sequencia%type;
cd_grupo_proc_w			sus_regra_rateio_sh.cd_grupo_proc%type;
cd_especial_proc_w		sus_regra_rateio_sh.cd_especialidade%type;
cd_area_proc_w			sus_regra_rateio_sh.cd_area_procedimento%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	sus_regra_rateio_sh
	where	cd_estabelecimento			= cd_estabelecimento_p
	and	coalesce(ie_sus_unificado,'N')		= 'S'
	and	coalesce(cd_procedimento,cd_procedimento_p)	= cd_procedimento_p
	and	coalesce(cd_area_procedimento,cd_area_proc_w) = cd_area_proc_w
	and	coalesce(cd_especialidade,cd_especial_proc_w) = cd_especial_proc_w
	and	coalesce(cd_grupo_proc,cd_grupo_proc_w)	= cd_grupo_proc_w
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_p) = cd_setor_atendimento_p
	and	coalesce(nr_seq_proc_interno,nr_seq_proc_interno_p) = nr_seq_proc_interno_p
	and	coalesce(cd_material::text, '') = ''
	and	coalesce(cd_grupo_material::text, '') = ''
	and	coalesce(cd_subgrupo_material::text, '') = ''
	and	coalesce(cd_classe_material::text, '') = ''
	order by	coalesce(cd_procedimento,0),
			coalesce(nr_seq_proc_interno,0),
			coalesce(cd_grupo_proc,0),
			coalesce(cd_especialidade,0),
			coalesce(cd_area_procedimento,0),
			coalesce(cd_setor_atendimento,0);


BEGIN

select	count(1)
into STRICT	qt_reg_proc_w
from	sus_regra_proc_princ_sh
where	ie_situacao = 'A'  LIMIT 1;

if (qt_reg_proc_w > 0) then
	begin

	cd_procedimento_real_w	:= coalesce(Sus_Obter_Proc_Aih_Unif(nr_interno_conta_p,2,'C'),0);

	if (cd_procedimento_real_w > 0) then
		begin

		begin
		select	coalesce(a.cd_grupo_proc,0),
			coalesce(b.cd_especialidade,0),
			coalesce(c.cd_area_procedimento,0)
		into STRICT	cd_grupo_proc_w,
			cd_especial_proc_w,
			cd_area_proc_w
		from	procedimento a,
			grupo_proc b,
			especialidade_proc c
		where	a.cd_grupo_proc		= b.cd_grupo_proc
		and	b.cd_especialidade	= c.cd_especialidade
		and	a.cd_procedimento 	= cd_procedimento_p
		and	a.ie_origem_proced	= ie_origem_proced_p  LIMIT 1;
		exception
		when others then
			cd_grupo_proc_w		:= 0;
			cd_especial_proc_w	:= 0;
			cd_area_proc_w		:= 0;
		end;

		open C01;
		loop
		fetch C01 into
			nr_seq_regra_sh_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		end loop;
		close C01;

		if (coalesce(nr_seq_regra_sh_w,0) > 0) then
			begin


			select	count(1)
			into STRICT	qt_reg_proc_princ_w
			from	sus_regra_proc_princ_sh
			where	nr_seq_regra_rateio = nr_seq_regra_sh_w
			and	ie_situacao = 'A'  LIMIT 1;

			if (qt_reg_proc_princ_w > 0) then
				begin

				begin
				select	count(1)
				into STRICT	qt_retorno_w
				from	sus_regra_proc_princ_sh
				where	cd_procedimento = cd_procedimento_real_w
				and	ie_origem_proced = 7
				and	nr_seq_regra_rateio = nr_seq_regra_sh_w
				and	ie_situacao = 'A';
				exception
				when others then
					qt_retorno_w := 1;
				end;

				end;
			end if;

			end;
		end if;

		end;
	end if;

	end;
end if;

return	qt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_restinge_proc_princ (cd_procedimento_p procedimento_paciente.cd_procedimento%type, ie_origem_proced_p procedimento_paciente.ie_origem_proced%type, nr_seq_proc_interno_p procedimento_paciente.nr_seq_proc_interno%type, cd_setor_atendimento_p procedimento_paciente.cd_setor_atendimento%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

