-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_dt_prev_os_planej ( nr_seq_planej_prev_p bigint, nr_seq_equipamento_p bigint) RETURNS varchar AS $body$
DECLARE


qt_dia_w				smallint := 0;
nr_seq_tipo_equip_w		bigint;
nr_seq_equip_especifico_w		bigint;
ie_dia_ultima_verif_w		varchar(1) := 'E';
dt_inicial_w			timestamp;
nr_seq_marca_w			bigint;
cd_setor_atendimento_w		integer;
cd_estabelecimento_w		smallint := coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);
nr_ordem_servico_w		bigint;
dt_ordem_servico_w		timestamp;
qt_existe_w			bigint;
ds_retorno_w			varchar(10);
ie_converter_mes_w		varchar(1);


BEGIN

if (coalesce(nr_seq_planej_prev_p,0) <> 0) and (coalesce(nr_seq_equipamento_p,0) <> 0) then
	begin
	null;
	select	b.qt_dia,
		a.nr_seq_tipo_equip,
		coalesce(a.nr_seq_equip,0),
		a.ie_dia_ultima_verif,
		a.dt_inicial,
		coalesce(a.nr_seq_marca,0),
		coalesce(a.cd_setor_atendimento,0),
		b.ie_converter_mes
	into STRICT	qt_dia_w,
		nr_seq_tipo_equip_w,
		nr_seq_equip_especifico_w,
		ie_dia_ultima_verif_w,
		dt_inicial_w,
		nr_seq_marca_w,
		cd_setor_atendimento_w,
		ie_converter_mes_w
	from	man_planej_prev a,
		man_freq_planej b
	where	a.nr_seq_frequencia = b.nr_sequencia
	and	coalesce(a.ie_situacao,'A') = 'A'
	and	a.nr_sequencia	=  nr_seq_planej_prev_p;

	select	count(*)
	into STRICT	qt_existe_w
	from	man_equipamento a,
		man_localizacao b
	where	a.nr_seq_local = b.nr_sequencia
	and	a.nr_seq_tipo_equip = nr_seq_tipo_equip_w
	and	coalesce(a.ie_situacao,'A') = 'A'
	and	((a.nr_sequencia = nr_seq_equip_especifico_w) or (nr_seq_equip_especifico_w = 0))
	and	((a.cd_estab_contabil = cd_estabelecimento_w) or (cd_estabelecimento_w = 0))
	and	((a.nr_seq_marca = nr_seq_marca_w) or (nr_seq_marca_w = 0))
	and	((b.cd_setor = cd_setor_atendimento_w) or (cd_setor_atendimento_w = 0))
	and	a.nr_sequencia = nr_seq_equipamento_p;

	if (qt_existe_w > 0) then
		begin
		select	max(nr_sequencia),
			CASE WHEN ie_dia_ultima_verif_w='G' THEN max(dt_ordem_servico) WHEN ie_dia_ultima_verif_w='E' THEN max(dt_fim_real) WHEN ie_dia_ultima_verif_w='I' THEN max(dt_inicio_desejado) END
		into STRICT	nr_ordem_servico_w,
			dt_ordem_servico_w
		from	man_ordem_servico
		where	nr_seq_planej = nr_seq_planej_prev_p
		and	ie_tipo_ordem = 2
		and	nr_seq_equipamento = nr_seq_equipamento_p;

		select 	count(*)
		into STRICT	qt_existe_w
		from	man_regra_data_frequencia
		where	nr_seq_planej_prev = nr_seq_planej_prev_p
		and	nr_seq_equipamento = nr_seq_equipamento_p;

		if (qt_existe_w = 0) then
			ds_retorno_w := to_char(obter_data_prev_futura(coalesce(coalesce(dt_ordem_servico_w,dt_inicial_w),clock_timestamp()), (qt_dia_w * 1), ie_converter_mes_w), 'dd/mm/yyyy');
		else
			select	to_char(dt_geracao,'dd/mm/yyyy')
			into STRICT	ds_retorno_w
			from	man_regra_data_frequencia
			where	nr_seq_equipamento = nr_seq_equipamento_p
			and	(dt_geracao IS NOT NULL AND dt_geracao::text <> '')  LIMIT 1;
		end if;
		end;
	end if;
	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_dt_prev_os_planej ( nr_seq_planej_prev_p bigint, nr_seq_equipamento_p bigint) FROM PUBLIC;

