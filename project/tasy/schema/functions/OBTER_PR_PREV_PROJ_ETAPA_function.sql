-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_pr_prev_proj_etapa ( dt_ref_p timestamp , dt_inicio_prev_p timestamp, dt_fim_prev_p timestamp, qt_hora_prev_p bigint) RETURNS bigint AS $body$
DECLARE

/* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Obter percentual previsto de execução de uma etapa do projeto
---------------------------------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ]  Relatórios [ ] Outros:
 --------------------------------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
pr_retorno_w	double precision := 0;
hrs_prev_w		double precision;
dias_uteis_w	double precision;
dias_uteis_data_atual_w	double precision;
hrs_executadas_prev_w	double precision;
total_hrs_prev_w	    double precision := 0;
total_hrs_exec_prev_w   double precision := 0;


BEGIN


hrs_prev_w				:= qt_hora_prev_p;
dias_uteis_w			:= obter_dias_uteis_periodo(dt_inicio_prev_p, dt_fim_prev_p, 1);
dias_uteis_data_atual_w	:= obter_dias_uteis_periodo(dt_inicio_prev_p, trunc(dt_ref_p), 1);

if (dias_uteis_data_atual_w >= dias_uteis_w) then
	hrs_executadas_prev_w := hrs_prev_w;
else
	hrs_executadas_prev_w := ((dias_uteis_data_atual_w / dias_uteis_w) * hrs_prev_w);
end if;

total_hrs_exec_prev_w := total_hrs_exec_prev_w + hrs_executadas_prev_w;
total_hrs_prev_w := total_hrs_prev_w + hrs_prev_w;

if (total_hrs_exec_prev_w = 0 and total_hrs_prev_w = 0)then
	pr_retorno_w := 0;
else
	pr_retorno_w := ((total_hrs_exec_prev_w / total_hrs_prev_w) * 100);
end if;


return  pr_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_pr_prev_proj_etapa ( dt_ref_p timestamp , dt_inicio_prev_p timestamp, dt_fim_prev_p timestamp, qt_hora_prev_p bigint) FROM PUBLIC;

