-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_ocor_excecao_aut ( nr_seq_conta_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_motivo_glosa_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ie_excecao_w		varchar(1)	:= 'N';
nr_seq_guia_w		bigint;
qt_regra_w 		bigint;
nr_seq_ocorrencia_w	bigint;
dt_emissao_w		timestamp;
cd_guia_imp_w 		varchar(20);
cd_guia_w		varchar(20);
cd_guia_pesquisa_w	varchar(20);
cd_guia_referencia_w	varchar(20);



BEGIN
/*Buscar a sequencia da guia*/

begin
select  nr_seq_guia,
	dt_emissao_imp
into STRICT	nr_seq_guia_w,
	dt_emissao_w
from	pls_conta
where	nr_sequencia = nr_seq_conta_p;
exception
when others then
	nr_seq_guia_w	:= null;
	dt_emissao_w	:= null;
end;

/*Tratamento para obrer a ocorrência, e não gerar a glosa indevidamente*/

if (coalesce(nr_seq_ocorrencia_p::text, '') = '')		and (nr_seq_motivo_glosa_p IS NOT NULL AND nr_seq_motivo_glosa_p::text <> '')	then

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_ocorrencia_w
	from	pls_ocorrencia a
	where	a.nr_seq_motivo_glosa = nr_seq_motivo_glosa_p
	and	a.ie_glosa	= 'S'
	and	a.ie_situacao	= 'A';

else
	nr_seq_ocorrencia_w	:= nr_seq_ocorrencia_p;
end if;

/*se a guia for nula tenta buscar pelos codigos de guia*/

if (coalesce(nr_seq_guia_w::text, '') = '')	then
	begin
	select	cd_guia_imp,
		cd_guia,
		cd_guia_referencia,
		dt_emissao
	into STRICT	cd_guia_imp_w,
		cd_guia_w,
		cd_guia_referencia_w,
		dt_emissao_w
	from	pls_conta
	where 	nr_sequencia = nr_seq_conta_p;
	exception
	when others then
		cd_guia_imp_w		:= null;
		cd_guia_w		:= null;
		cd_guia_referencia_w	:= null;
		dt_emissao_w		:= null;
	end;

	if (cd_guia_imp_w IS NOT NULL AND cd_guia_imp_w::text <> '')		then
		cd_guia_pesquisa_w	:= null;

		select	max(nr_sequencia)
		into STRICT	nr_seq_guia_w
		from	pls_guia_plano
		where	cd_guia = cd_guia_imp_w;

		if (coalesce(nr_seq_guia_w::text, '') = '')	then
			cd_guia_pesquisa_w	:=  pls_converte_cd_guia_pesquisa(cd_guia_imp_w);

			select	max(nr_sequencia)
			into STRICT	nr_seq_guia_w
			from	pls_guia_plano
			where	cd_guia_pesquisa = cd_guia_pesquisa_w;
		end if;

	end if;

	if (coalesce(nr_seq_guia_w::text, '') = '')	and (cd_guia_w IS NOT NULL AND cd_guia_w::text <> '')	then
		cd_guia_pesquisa_w	:= null;

		select	max(nr_sequencia)
		into STRICT	nr_seq_guia_w
		from	pls_guia_plano
		where	cd_guia = cd_guia_w;

		if (coalesce(nr_seq_guia_w::text, '') = '')	then
			cd_guia_pesquisa_w	:=  pls_converte_cd_guia_pesquisa(cd_guia_w);

			select	max(nr_sequencia)
			into STRICT	nr_seq_guia_w
			from	pls_guia_plano
			where	cd_guia_pesquisa = cd_guia_pesquisa_w;
		end if;
	end if;

	/*se não encontrar com o código da guia principal ou imp buscar pelo código da guia referência*/

	if (coalesce(nr_seq_guia_w::text, '') = '')	and (cd_guia_w IS NOT NULL AND cd_guia_w::text <> '')	then
		cd_guia_pesquisa_w	:= null;

		select	max(nr_sequencia)
		into STRICT	nr_seq_guia_w
		from	pls_guia_plano
		where	cd_guia = cd_guia_referencia_w;

		if (coalesce(nr_seq_guia_w::text, '') = '')	then
			cd_guia_pesquisa_w	:=  pls_converte_cd_guia_pesquisa(cd_guia_referencia_w);

			select	max(nr_sequencia)
			into STRICT	nr_seq_guia_w
			from	pls_guia_plano
			where	cd_guia_pesquisa = cd_guia_pesquisa_w;
		end if;
	end if;
end if;

/*Tratamento para se não houver data*/

if (coalesce(dt_emissao_w::text, '') = '')	then
	dt_emissao_w := clock_timestamp();
end if;

/*Verifica se a guia não está mais nula, se o sistema encontrar uma guia
irá verificar se a ocorrência criada para a glosa está cadastrada na liberação da ocorrência para
XML TISS, na autorização*/
if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '')	then

		select	count(1)
		into STRICT	qt_regra_w
		from	pls_guia_lib_ocor_web	a
		where	a.nr_seq_ocorrencia	= nr_seq_ocorrencia_w
		and	a.nr_seq_guia		= nr_seq_guia_w
		and	dt_emissao_w between trunc(dt_inicio_vigencia) and fim_dia(coalesce(dt_fim_vigencia, dt_emissao_w))  LIMIT 1;

		if (qt_regra_w > 0) then
			ie_excecao_w	:= 'S';
		end if;
end if;


return	ie_excecao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_ocor_excecao_aut ( nr_seq_conta_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_motivo_glosa_p bigint, nm_usuario_p text) FROM PUBLIC;

