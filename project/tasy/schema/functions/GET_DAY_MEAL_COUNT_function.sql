-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_day_meal_count ( nr_atendimento_p bigint, calculation_date_p timestamp, ie_type_p text ) RETURNS varchar AS $body$
DECLARE

  /*
  this function returns number of meals on the day
  for ex:-
  breakfast  lunch  dinner
  meal      meal    -     total meal count is 2(breakfast+lunch)
  M - mela(oral diet)
  S - special meal
  L - Liquid Meal
  */
  ds_return_w  atendimento_paciente.cd_pessoa_fisica%type;
  day_count_w  atendimento_paciente.cd_pessoa_fisica%type;
  no_of_count_w  atendimento_paciente.cd_pessoa_fisica%type;
  cd_pessoa_fisica_w         atendimento_paciente.cd_pessoa_fisica%type;

BEGIN

    select coalesce(max(cd_pessoa_fisica), 0)
    into STRICT cd_pessoa_fisica_w
    from atendimento_paciente
    where nr_atendimento=nr_atendimento_p;

    if ( ie_type_p = 'M') then
	
	       
      begin   
           select (count(case ie_status_breakfast  when 'S'  then 1 end)+
                     count(case ie_status_lunch when 'S'  then 1 end)+
                     count(case ie_status_dinner  when 'S'  then 1 end)	 )  day_meal_count,       
                     count(*)  no_of_record   
            into STRICT  day_count_w,
                  no_of_count_w
            
            from 
            table(SELECT meal_history_pck.meal_history(to_date(calculation_date_p), to_date(calculation_date_p),cd_pessoa_fisica_w,nr_atendimento_p,'S') )
            where trunc(calculation_date_p) in trunc(dt_reference);
            exception
                    when no_data_found then
                        no_of_count_w := '0';
                    end;
                    
            if (no_of_count_w <> '0') then                
                 ds_return_w := day_count_w;
            else
                 ds_return_w := '0';
            end if;

                
    elsif ( ie_type_p = 'S') then
	
		select  count(*) -- total (lunch /breakfast/dinner)count  for the day
		into STRICT    ds_return_w
		from    prescr_medica b,
				nut_atend_serv_dia_rep d,
				nut_atend_serv_dia e,
				cpoe_dieta c,
				prescr_dieta p
		where  b.nr_prescricao  in (d.nr_prescr_jejum,d.nr_prescr_oral)
		and    e.nr_sequencia      = d.nr_seq_serv_dia
		and    c.nr_sequencia      = p.nr_seq_dieta_cpoe
		and    p.nr_prescricao     = b.nr_prescricao
		and    ie_dieta_especial   = 'S' --special meal
		and    trunc(e.dt_servico) = trunc(calculation_date_p)
		and    e.nr_atendimento    = nr_atendimento_p
		and    coalesce(b.dt_suspensao::text, '') = '' -- prescription not cancelled
		and    (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '');
	else
	    select  count(*) -- total (lunch /breakfast/dinner)count  for the day
		into STRICT    ds_return_w
		from    prescr_medica b,
				nut_atend_serv_dia_rep d,
				nut_atend_serv_dia e,
				cpoe_dieta c,
				prescr_dieta p
		where  ((b.nr_prescricao  in (d.nr_prescr_enteral) 
		and    ie_dieta_especial   = 'S') --special meal
     	or     b.nr_prescricao   in (d.nr_prescr_enteral))
		and    e.nr_sequencia      = d.nr_seq_serv_dia
		and    c.nr_sequencia      = p.nr_seq_dieta_cpoe
		and    p.nr_prescricao     = b.nr_prescricao		
		and    trunc(e.dt_servico) = trunc(calculation_date_p)
		and    e.nr_atendimento    = nr_atendimento_p
		and    coalesce(b.dt_suspensao::text, '') = '' -- prescription not cancelled
		and    (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '');
	
  end if;
return ds_return_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_day_meal_count ( nr_atendimento_p bigint, calculation_date_p timestamp, ie_type_p text ) FROM PUBLIC;

