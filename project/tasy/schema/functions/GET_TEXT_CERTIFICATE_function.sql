-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_text_certificate ( nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE



ds_texto_w				varchar(4000);
ds_texto_ww				varchar(4000);
dt_icu_admission_w		timestamp;
ds_transfer_in_w		varchar(255);
nr_sequencia_w			bigint;
dt_registration_w		timestamp;


C01 CURSOR FOR
SELECT  ds_justificativa
from    paciente_justificativa
where   nr_atendimento = nr_atendimento_p
and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	    ie_situacao = 'A'
and     ie_tipo_justificativa in ('TB','TC');



c02 CURSOR(nr_atendimento_p   bigint) FOR
SELECT  a.nr_sequencia nr_seq_assessment,
        a.dt_avaliacao dt_assessment,
		a.nr_seq_tipo_avaliacao nr_seq_type_assessment,
		b.ds_tipo ds_type_assessment
from    med_avaliacao_paciente a,
		med_tipo_avaliacao b
where   a.nr_atendimento = nr_atendimento_p
and     a.nr_seq_tipo_avaliacao in (130,132,131)
and     a.ie_situacao = 'A'
and     (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and		b.nr_sequencia = a.nr_seq_tipo_avaliacao
order by a.nr_seq_tipo_avaliacao, a.dt_avaliacao;


c03 CURSOR(nr_seq_type_assessment_p   bigint, nr_seq_assessment_p  bigint) FOR
SELECT   a.nr_sequencia,
         a.ds_item,
         CASE WHEN Obter_Desc_Result_Avaliacao(nr_seq_assessment_p,a.nr_sequencia)='N' THEN 'No' WHEN Obter_Desc_Result_Avaliacao(nr_seq_assessment_p,a.nr_sequencia)='S' THEN 'Yes'  ELSE Obter_Desc_Result_Avaliacao(nr_seq_assessment_p,a.nr_sequencia) END  ds_result
from     med_item_avaliar a,
         med_avaliacao_paciente b
where    a.nr_seq_tipo = nr_seq_type_assessment_p
and      b.nr_seq_tipo_avaliacao = a.nr_seq_tipo
and      b.nr_sequencia = nr_seq_assessment_p;


C04 CURSOR(nr_seq_icunsw_p bigint) FOR
SELECT  x.ds_label,
        CASE WHEN x.ds_valor='N' THEN 'No' WHEN x.ds_valor='S' THEN  'Yes'  ELSE x.ds_valor END  ds_result
from (select  obter_desc_expressao_idioma(coalesce(CD_EXP_LABEL_LONGO,CD_EXP_LABEL),null,5) || ':' ds_label,
        nm_atributo,
        Obter_select_concatenado_bv('select ' || nm_atributo || ' from ICUNSW_DAILY where nr_seq_icunsw = :nr_seq_icunsw','nr_seq_icunsw=' || nr_seq_icunsw_p || ';',';') ds_valor
from    tabela_atributo
where   nm_tabela = 'ICUNSW_DAILY'
and     nm_atributo not in ('DS_JUSTIFICATIVA','IE_SITUACAO','NM_USUARIO','NM_USUARIO_NREC', 'DT_ATUALIZACAO', 'DT_ATUALIZACAO_NREC',
							'NR_SEQ_ICUNSW', 'NR_SEQUENCIA', 'NM_USUARIO_INATIVACAO', 'NM_PESSOA_FISICA' , 'CD_PESSOA_FISICA', 
							'DT_INATIVACAO','DT_LIBERACAO','DT_REGISTRATION')) x;
BEGIN

for r_c01 in c01 loop
	begin
	ds_texto_w	:= substr(remove_formatacao_rtf_html(r_c01.ds_justificativa) || chr(13) || chr(10),1,500);
	end;
end loop;


for r_c02 in c02(nr_atendimento_p) loop
	begin

	ds_texto_ww	:= r_c02.ds_type_assessment || chr(13) || chr(10);

	for r_c03 in c03(r_c02.nr_seq_type_assessment, r_c02.nr_seq_assessment) loop
		begin

		if (r_c03.ds_result IS NOT NULL AND r_c03.ds_result::text <> '') then

			ds_texto_ww	:= ds_texto_ww || r_c03.ds_item || ' ' || r_c03.ds_result;

			ds_texto_w := substr(ds_texto_w || ds_texto_ww ||  chr(13) || chr(10),1,4000);

			ds_texto_ww := null;

		end if;

		end;
	end loop;

	ds_texto_w := substr(ds_texto_w || chr(13) || chr(10),1,4000);

	end;
end loop;


select  max(a.dt_icu_admission),
        max(a.ds_transfer_in),
        max(a.nr_sequencia),
        max(a.dt_registration)
into STRICT	dt_icu_admission_w,
		ds_transfer_in_w,
		nr_sequencia_w,
		dt_registration_w
from    icunsw a
where   a.nr_atendimento = nr_atendimento_p
and     (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and     a.ie_situacao = 'A';



if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then

	ds_texto_ww :=	obter_desc_expressao(952430) ||  chr(13) || chr(10) ||
					obter_desc_expressao(287188) || ': ' || dt_registration_w ||  chr(13) || chr(10) ||
					obter_desc_expressao(952531) || ': ' || ds_transfer_in_w ||  chr(13) || chr(10) || 
					obter_desc_expressao(288664) || ': ' || dt_icu_admission_w ||  chr(13) || chr(10);

	ds_texto_w	:= substr(ds_texto_w || ds_texto_ww ||  chr(13) || chr(10),1,4000);

	ds_texto_ww	:= null;

	for r_c04 in c04(nr_sequencia_w) loop
		begin

		if (r_c04.ds_result IS NOT NULL AND r_c04.ds_result::text <> '') then

			ds_texto_ww	:= ds_texto_ww || r_c04.ds_label || ' ' || r_c04.ds_result;

			ds_texto_w	:= substr(ds_texto_w || ds_texto_ww ||  chr(13) || chr(10),1,4000);

			ds_texto_ww := null;
		end if;

		end;
	end loop;

end if;
return ds_texto_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_text_certificate ( nr_atendimento_p bigint) FROM PUBLIC;

