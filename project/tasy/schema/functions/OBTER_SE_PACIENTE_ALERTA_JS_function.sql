-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_paciente_alerta_js ( cd_pessoa_fisica_p text, cd_pessoa_usuario_p text, nr_atendimento_p bigint, cd_estabelecimento_p bigint) RETURNS bigint AS $body$
DECLARE


ie_paciente_alerta_w		varchar(1);
c02        				integer;
ds_comando_w			varchar(255);
qt_linhas_retorno_w			bigint	:= 0;
retorno_w				bigint;

c01 CURSOR FOR
SELECT	a.ds_sql
from    pep_alerta_seguranca_item a,
	pep_alerta_seguranca b
where	a.nr_seq_alerta_sg		= b.nr_sequencia
and	coalesce(a.ie_situacao, 'A')	= 'A'
and	coalesce(b.ie_situacao, 'A')	= 'A';

vet01				c01%rowtype;

BEGIN

if (coalesce(cd_pessoa_fisica_p::text, '') = '') and (coalesce(nr_atendimento_p,0)  = 0) then
	return 0;
end if;

ie_paciente_alerta_w		:= substr(obter_se_paciente_alerta(	cd_pessoa_fisica_p,
								cd_pessoa_usuario_p,
								cd_estabelecimento_p,
								nr_atendimento_p), 1, 1);

if (ie_paciente_alerta_w = 'N') then
	begin
	open c01;
	loop
	fetch c01 into	
		vet01;
	EXIT WHEN NOT FOUND or coalesce(qt_linhas_retorno_w, 0) <> 0;  /* apply on c01 */ /*Sair quando nao encontrar mais linhas, ou uma das sub-consultas resultar registros*/
		begin
		
		c02 := DBMS_SQL.OPEN_CURSOR;
		
		/*Executa o comando conforme sql vindo do cursor*/

		DBMS_SQL.PARSE(c02, vet01.ds_sql, DBMS_SQL.NATIVE);
		
		/*Se existir as bind Variables*/

		if (position(':CD_PESSOA_FISICA' in upper(vet01.ds_sql)) > 0) then
			DBMS_SQL.BIND_VARIABLE(c02 ,':cd_pessoa_fisica', cd_pessoa_fisica_p);	
		end if;
		
		if (position(':NR_ATENDIMENTO' in upper(vet01.ds_sql)) > 0) then
			DBMS_SQL.BIND_VARIABLE(c02 ,':nr_atendimento', nr_atendimento_p);	
		end if;
		
		if (position(':CD_FUNCAO' in upper(vet01.ds_sql)) > 0) then
			DBMS_SQL.BIND_VARIABLE(c02 ,':CD_FUNCAO', obter_funcao_ativa);	
		end if;
		
		retorno_w		:= dbms_sql.execute(c02);
		
		/*Retorna a quantidade de registros que a consulta resultou*/

		qt_linhas_retorno_w	:= DBMS_SQL.FETCH_ROWS(c02);
		DBMS_SQL.CLOSE_CURSOR(c02);
		exception when others then
			DBMS_SQL.CLOSE_CURSOR(c02);
		end;
	end loop;
	close c01;
	
	end;
else
	qt_linhas_retorno_w		:= 1; /*Ou seja..., verdadeiro*/
end if;
return	qt_linhas_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_paciente_alerta_js ( cd_pessoa_fisica_p text, cd_pessoa_usuario_p text, nr_atendimento_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

