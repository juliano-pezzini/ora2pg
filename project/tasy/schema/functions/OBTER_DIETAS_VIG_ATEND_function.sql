-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dietas_vig_atend ( nr_atendimento_p bigint, qt_horas_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(2000);
qt_reg_w		bigint;
qt_reg_ww		bigint;
qt_horas_w		bigint;

BEGIN

if (qt_horas_p	<=0) then
	qt_horas_w	:=  24;
else
	qt_horas_w	:= qt_horas_p;
end if;

select	count(*)
into STRICT	qt_reg_w
from	prescr_medica a,
		prescr_material b
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_atendimento = nr_atendimento_p
and		a.dt_prescricao between clock_timestamp() - (qt_horas_w/24) and clock_timestamp() + interval '3 days'
and		b.ie_agrupador	= 8
and		clock_timestamp() between a.DT_INICIO_PRESCR and a.DT_VALIDADE_PRESCR
and		(coalesce(a.dt_liberacao_medico,a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico,a.dt_liberacao))::text <> '')
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(b.DT_SUSPENSAO::text, '') = '';

if (qt_reg_w	> 0) then
	ds_retorno_w	:= ds_retorno_w||obter_desc_expressao(298607)||' '||qt_reg_w||',';
end if;

select	count(*)
into STRICT	qt_reg_w
from	prescr_medica a,
		prescr_material b
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_atendimento = nr_atendimento_p
and		a.dt_prescricao between clock_timestamp() - (qt_horas_w/24) and clock_timestamp() + interval '3 days'
and		b.ie_agrupador	= 12
and		clock_timestamp() between a.DT_INICIO_PRESCR and a.DT_VALIDADE_PRESCR
and		(coalesce(a.dt_liberacao_medico,a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico,a.dt_liberacao))::text <> '')
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(b.DT_SUSPENSAO::text, '') = '';

if (qt_reg_w	> 0) then
	ds_retorno_w	:= ds_retorno_w||' '||obter_desc_expressao(347769)||''||qt_reg_w||',';
end if;


select	count(*)
into STRICT	qt_reg_w
from	prescr_medica a,
		prescr_dieta b
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_atendimento = nr_atendimento_p
and		a.dt_prescricao between clock_timestamp() - (qt_horas_w/24) and clock_timestamp() + interval '3 days'
and		clock_timestamp() between a.DT_INICIO_PRESCR and a.DT_VALIDADE_PRESCR
and		(coalesce(a.dt_liberacao_medico,a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico,a.dt_liberacao))::text <> '')
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(b.DT_SUSPENSAO::text, '') = '';

if (qt_reg_w	> 0) then
	ds_retorno_w	:= ds_retorno_w||' '||obter_desc_expressao(287913)||' '||qt_reg_w||',';
else

	select	count(distinct cd_dieta)
	into STRICT	qt_reg_w
	from	prescr_medica a,
			prescr_dieta b,
			prescr_dieta_hor c
	where	a.nr_prescricao = b.nr_prescricao
	and		c.nr_prescricao	= b.nr_prescricao
	and		c.NR_SEQ_DIETA   = b.nr_sequencia
	and		a.nr_atendimento = nr_atendimento_p
	and		a.dt_prescricao between clock_timestamp() - (qt_horas_w/24) and clock_timestamp() + interval '3 days'
	--and		sysdate between a.DT_INICIO_PRESCR and a.DT_VALIDADE_PRESCR
	and		(coalesce(a.dt_liberacao_medico,a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico,a.dt_liberacao))::text <> '')
	and		b.IE_DOSE_ESPEC_AGORA	= 'S'
	and		(b.HR_DOSE_ESPECIAL IS NOT NULL AND b.HR_DOSE_ESPECIAL::text <> '')
	and		c.dt_horario between a.dt_prescricao and clock_timestamp() + interval '1 days'
	and		coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(b.DT_SUSPENSAO::text, '') = '';

	if (qt_reg_w	> 0) then
		ds_retorno_w	:= ds_retorno_w||' '||obter_desc_expressao(287913)||' '||qt_reg_w||',';
	end if;

end if;


select	count(*)
into STRICT	qt_reg_w
from	prescr_medica a,
		REP_JEJUM b
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_atendimento = nr_atendimento_p
and		a.dt_prescricao between clock_timestamp() - (qt_horas_w/24) and clock_timestamp() + interval '3 days'
and		clock_timestamp() between a.DT_INICIO_PRESCR and a.DT_VALIDADE_PRESCR
and		(coalesce(a.dt_liberacao_medico,a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico,a.dt_liberacao))::text <> '')
and		coalesce(a.dt_suspensao::text, '') = '';

if (qt_reg_w	> 0) then
	ds_retorno_w	:= ds_retorno_w||' '||obter_desc_expressao(304828)||' '||qt_reg_w||',';
end if;

select	count(*)
into STRICT	qt_reg_w
from	prescr_medica a,
		NUT_PAC b
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_atendimento = nr_atendimento_p
and		a.dt_prescricao between clock_timestamp() - (qt_horas_w/24) and clock_timestamp() + interval '3 days'
and		clock_timestamp() between a.DT_INICIO_PRESCR and a.DT_VALIDADE_PRESCR
and		(coalesce(a.dt_liberacao_medico,a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico,a.dt_liberacao))::text <> '')
and		b.ie_npt_adulta = 'S'
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(b.DT_SUSPENSAO::text, '') = '';

select	count(*)
into STRICT	qt_reg_ww
from	prescr_medica a,
		Nut_Paciente b
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_atendimento = nr_atendimento_p
and		a.dt_prescricao between clock_timestamp() - (qt_horas_w/24) and clock_timestamp() + interval '3 days'
and		clock_timestamp() between a.DT_INICIO_PRESCR and a.DT_VALIDADE_PRESCR
and		(coalesce(a.dt_liberacao_medico,a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico,a.dt_liberacao))::text <> '')
and		b.ie_npt_adulta = 'S'
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(b.DT_SUSPENSAO::text, '') = '';
qt_reg_w	:= qt_reg_w + qt_reg_ww;
if (qt_reg_w	> 0) then
	ds_retorno_w	:= ds_retorno_w||' '||obter_desc_expressao(305331)||' '||qt_reg_w||',';
end if;


select	count(*)
into STRICT	qt_reg_w
from	prescr_medica a,
		NUT_PAC b
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_atendimento = nr_atendimento_p
and		a.dt_prescricao between clock_timestamp() - (qt_horas_w/24) and clock_timestamp() + interval '3 days'
and		clock_timestamp() between a.DT_INICIO_PRESCR and a.DT_VALIDADE_PRESCR
and		(coalesce(a.dt_liberacao_medico,a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico,a.dt_liberacao))::text <> '')
and		b.ie_npt_adulta = 'N'
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(b.DT_SUSPENSAO::text, '') = '';

if (qt_reg_w	> 0) then
	ds_retorno_w	:= ds_retorno_w||' '||obter_desc_expressao(305334)||' '||qt_reg_w||',';
end if;

select	count(*)
into STRICT	qt_reg_w
from	prescr_medica a,
		NUT_PAC b
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_atendimento = nr_atendimento_p
and		a.dt_prescricao between clock_timestamp() - (qt_horas_w/24) and clock_timestamp() + interval '3 days'
and		clock_timestamp() between a.DT_INICIO_PRESCR and a.DT_VALIDADE_PRESCR
and		(coalesce(a.dt_liberacao_medico,a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico,a.dt_liberacao))::text <> '')
and		b.ie_npt_adulta = 'P'
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(b.DT_SUSPENSAO::text, '') = '';

if (qt_reg_w	> 0) then
	ds_retorno_w	:= ds_retorno_w||' '||obter_desc_expressao(493524)||' '||qt_reg_w||',';
end if;

ds_retorno_w	:= trim(both ds_retorno_w);
ds_retorno_w	:= substr(ds_retorno_w,1,length(ds_retorno_w)-1);


return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dietas_vig_atend ( nr_atendimento_p bigint, qt_horas_p bigint) FROM PUBLIC;

