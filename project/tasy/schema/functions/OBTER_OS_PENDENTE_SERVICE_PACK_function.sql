-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_os_pendente_service_pack (CD_VERSAO_P text) RETURNS varchar AS $body$
DECLARE


NR_SEQ_ORDEM_SERV_W bigint;
ds_mensagem_w varchar(1000);
ds_comando_cursor_w text;
C010 integer;
retorno_w bigint;


BEGIN

     --se retornar maior que zero é porque a versão não tem nehum service pack liberado, portanto o service pack é o 00, se retornar zero ignorar
    ds_comando_cursor_w :=
        'select distinct d.nr_sequencia '||chr(13)||
        'from REG_TC_PENDENCIES@dblink a, '||chr(13)||
        '     REG_TC_EVIDENCE_ITEM@dblink b, '||chr(13)||
        '     REG_TC_SO_PENDENCIES@dblink c, '||chr(13)||
        '     man_ordem_servico@dblink d '||chr(13)||
        'where a.NR_SEQUENCIA = b.NR_SEQ_TC_ITEM '||chr(13)||
        'and b.NR_SEQUENCIA = c.NR_SEQ_EV_ITEM '||chr(13)||
        'and d.nr_sequencia = c.nr_seq_service_order '||chr(13)||
        'and somente_numero(a.ds_version) > 3011733 '||chr(13)||
        'and d.IE_STATUS_ORDEM <> 3 '||CHR(13)||
        'and a.DS_VERSION = :CD_VERSAO_P ';

    if OBTER_SE_BASE_WHEB = 'S' then
        ds_comando_cursor_w := replace(ds_comando_cursor_w,'@dblink','');
    else
        ds_comando_cursor_w := replace(ds_comando_cursor_w,'@dblink','@orcl');
    end if;

    C010 := DBMS_SQL.OPEN_CURSOR;
    DBMS_SQL.PARSE(C010, ds_comando_cursor_w, dbms_sql.Native);
    DBMS_SQL.bind_variable(c010,':CD_VERSAO_P', cd_versao_p);
    DBMS_SQL.DEFINE_COLUMN(C010, 1, NR_SEQ_ORDEM_SERV_W);
    retorno_w := DBMS_SQL.execute(c010);

    while(DBMS_SQL.FETCH_ROWS(C010) > 0 ) loop
        DBMS_SQL.COLUMN_VALUE(C010, 1, NR_SEQ_ORDEM_SERV_W);
        if (coalesce(ds_mensagem_w::text, '') = '') then
            ds_mensagem_w := NR_SEQ_ORDEM_SERV_W;
        else
            ds_mensagem_w := ds_mensagem_w ||', '||NR_SEQ_ORDEM_SERV_W;
        end if;
    end loop;

    DBMS_SQL.CLOSE_CURSOR(C010);

    return substr(trim(both ds_mensagem_w),1,1000);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_os_pendente_service_pack (CD_VERSAO_P text) FROM PUBLIC;

