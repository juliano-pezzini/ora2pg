-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_regra_email_compra (ie_tipo_mensagem_p bigint, cd_estabelecimento_p bigint, nr_documento_p bigint, ie_retorno_p text, dt_retorno_prev_p timestamp, nm_usuario_p text, cd_cgc_p text, ie_tipo_registro_p text default 'S', -- PCS
 nr_seq_registro_p bigint default 0, --PCS
 nr_seq_regra_p bigint default 0) RETURNS varchar AS $body$
DECLARE


/* Tipo mensagem
1 - Cotacao - Alteracao na data retorno prevista (Maior) (Fornecedor)
2 - Cotacao - Alteracao na data retorno prevista (Menor) (Fornecedor)
3 - Cotacao - No momento do calculo da cotacao (Fornecedor)
4 - Cotacao - No momento de gerar a ordem de compras (Fornecedor)
5 - Cotacao - No momento de cancelar para internet (Fornecedor)
6 - Cotacao - No momento de liberar a cotacao para a internet (Fornecedor)
7 - Cotacao - No momento de desfazer a cotacao (Fornecedor)
8 - Ordem - No momento de cancelar a Ordem de compras (Fornecedor)
9 - Ordem - Ao liberar a Ordem de compras para aprovacao (Aprovador)
10- Solicitacao - Ao liberar a solicitacao p/ aprovacao (Aprovador)
11- Ordem - Ao liberar a Ordem de compras para aprovacao (Fornecedor)
12- Aprovacao - Ao solicitar um parecer
13- Aprovacao - Ao informar um parecer
14- Aprovacao - No momento de aprovar o documento
15- Ordem / Aprovacoes pendentes - Ao aprovador do processo
16- Utilizada na procedure comunic_fornec_atraso_compra
17- Utilizada na procedure OBTER_DADOS_REGRA_SENHA_PJ
18 - Cotacao - Ao gerar a ordem, avisar fornecedor perdedor da cotacao
21 - Cotacao - Apos todos os fornecedores confirmarem no portal (Comprador e Solicitante)
22 - Ordem / Aprovacoes pendentes - Ao aprovar uma ordem de compra (Fornecedor)
26 - Ordem - Liberar para o fornecedor no portal (opcao da ordem de compra)
27 - Ordem - Estornar liberacao fornecedor portal (opcao da ordem de compra)
28 - Cotacao - No momento de gerar a ordem de compras (Avisa Resp. Setor Compras)
30 - Solicitacao - Ao liberar uma solicitacao urgente (Avisa resp. compras).
31 -3 - Cotacao - No momento do calculo da cotacao (Comprador)
32 - Cotacao - Apos todos os fornecedores confirmarem no portal (Comprador)
33 - Aprovacoes pendentes - Ao aprovar solicitacao (Avisa comprador resp. compras)
36 - Ordem / Aprovacoes - (Somente ao aprovador do processo)
39 - Solicitacao - Ao liberar uma solicitacao (Avisa resp. compras)
72 - Requisicao Material - Requisicao pendente de aprovacao.
73 - Ordem - Ao liberar uma ordem de compra urgente (Avisa resp. compras)
75 - Aprovacoes pendentes - Tipo de servico(SR, SN,SP)
82 - Solicitacao - Ao gerar ordem de compra de contrato automaticamente. (Avisa fornecedor)
85 - Nota fiscal - Ao liberar uma avaliacao dinamica
86 - Inspecao recebimento - Ao devolver uma inspecao (Comprador e solicitante)
105 - PCS - Gerar solicitacao/emprestimo/transferencia
*/


/* Retorno
M - Mensagem padrao
S - Sequencia da regra
A - Assunto
E - Tipo de email (U - Usuario, C - Setor de compras)
O - Email origem
U - Usuario origem
D - Email Adicional
P - Perfil disparar
G - Enviar e-mail imediatamente ou gerar para envio posterior (I - Imediato, A - Envio posterior)
ED - Enviar para pessoa delegada (caso destino seja aprovador)
SH - Senha do remetente fixo
RF - Remetente fixo
RE - E-mail's dos usuarios fixos informados nos parametros de regras para envio de e-mail no compras
EC - E-mail comprador responsavel que esta informado no campo "Comprador" nos parametros de compras.
*/
	
nr_seq_regra_param_w		bigint;
nr_seq_regra_w			regra_envio_email_compra.nr_sequencia%type;
nr_sequencia_w			regra_envio_email_compra.nr_sequencia%type;
ie_consignado_w			regra_envio_email_compra.ie_consignado%type;
qt_consignado_w			integer;
dt_retorno_prev_w		timestamp;
ds_mensagem_padrao_w		varchar(4000);
ds_assunto_w			varchar(255);
ie_tipo_documento_w		varchar(20);
ie_tipo_doc_w			varchar(20);
ds_tipo_documento_w		varchar(50);
nm_pessoa_solicitante_w		varchar(60);
nm_fantasia_w			varchar(80);
nm_razao_social_w		pessoa_juridica.ds_razao_social%type;
ds_estabelecimento_w		varchar(100);
ds_senha_w			varchar(255);
ds_senha_acesso_w		varchar(255);
nm_usuario_w			varchar(100);
ds_cargo_w			varchar(80);
nr_telefone_w			varchar(15);
nr_ramal_w			varchar(20);
ds_email_w			varchar(255);
nr_ordem_w			bigint;
ie_alterar_senha_w		varchar(1) := 'N';
cd_cgc_fornecedor_w		varchar(14);
nr_cot_compra_w			bigint;
ds_site_fornec_w		varchar(255);
ds_site_estab_w			pessoa_juridica.ds_site_internet%type;
ds_itens_w			varchar(255);
ds_lista_materiais_w		varchar(4000);
cd_cnpj_editado_w		varchar(20);
cd_cnpj_w			varchar(14);
ie_usuario_w			regra_envio_email_compra.ie_usuario%type;
ds_email_origem_w		varchar(255);
ds_usuario_origem_w		varchar(255);
ds_email_comprador_w		varchar(255);
ds_usuario_comprador_w		varchar(255);
cd_comprador_padrao_w		varchar(10);
cd_comprador_w			varchar(10);
ds_url_cotacao_w		varchar(120);
ds_email_adicional_w		regra_envio_email_compra.ds_email_adicional%type;
ds_observacao_w			varchar(255);
ds_observacao_ww		varchar(2000);
nr_ordem_compra_w		bigint;
ds_lista_ordem_w		varchar(255);
nm_responsavel_compras_w	varchar(100);
ie_urgente_w			varchar(1);
nm_comprador_w			comprador.nm_guerra%type;
ds_lista_itens_w		varchar(2000);
ds_lista_itens_est_w		varchar(2000);
cd_material_w			integer;
cd_perfil_disparar_w		regra_envio_email_compra.cd_perfil_disparar%type;
cd_local_estoque_w		smallint;
ds_local_estoque_w		varchar(100);
cd_centro_custo_w		integer;
ds_centro_custo_w		varchar(100);
nr_cpf_editado_w		varchar(20);
nr_cpf_w			varchar(11);
nm_pessoa_fisica_w		varchar(80);
ie_momento_envio_w		regra_envio_email_compra.ie_momento_envio%type;
ds_item_solic_w			varchar(4000);
ds_lista_mat_solic_w		varchar(4000);
ds_item_ww			varchar(2000);
ds_ordens_ww			varchar(2000);
ds_item_w			varchar(2000);
ds_descricao_compl_w		varchar(2000);
ds_descricao_compl_ww		varchar(2000);
ds_estrutura_w			varchar(2000);
ds_estrutura_ww			varchar(2000);
ds_item_qt_preco_w		varchar(2000);
ds_item_qt_preco_ww		varchar(2000);
dt_entrega_w			varchar(2000);
dt_entrega_ww			varchar(2000);
dt_liberacao_w			timestamp;
ie_envia_pessoa_deleg_w		regra_envio_email_compra.ie_envia_pessoa_deleg%type;
nm_pessoa_lib_w			varchar(255);
nr_requisicao_w			bigint;
nm_requisitante_w		varchar(255);		
nm_solicitante_req_w		varchar(255);
ie_urgente_req_w		varchar(3);
ds_operacao_estoque_w		varchar(40);
ds_local_estoque_req_w		varchar(40);
ds_local_est_dest_w		varchar(40);
ds_centro_custo_req_w		varchar(80);
ds_material_req_w		varchar(255);
ds_material_req_ww		varchar(3000);
ds_mat_est_req_w		varchar(355);
ds_mat_est_req_ww		varchar(3000);
vl_rateio_w			varchar(60);
vl_total_ordem_w		varchar(60);
ds_email_remetente_w		regra_envio_email_compra.ds_email_remetente%type;
nr_solic_compra_w		bigint;
nr_nota_fiscal_w		varchar(255);
dt_emissao_w			timestamp;
ds_fornecedor_w			varchar(80);
cd_cgc_estab_w			varchar(20);
nm_fantasia_estab_w		varchar(255);
nm_razao_social_estab_w		varchar(100);
ds_motivo_devolucao_w		varchar(255);
nm_solicitante_w		varchar(255);
ds_senha_remetente_w		regra_envio_email_compra.ds_senha_remetente%type;
ds_remetente_fixo_w		regra_envio_email_compra.ds_email_remetente%type;
ds_emails_usuarios_fixos	varchar(2000);
ds_email_ww				usuario.ds_email%type;

c01 CURSOR FOR
SELECT	substr(cd_material || ' - ' || obter_desc_material(cd_material),1,255)
from	cot_compra_item
where	nr_cot_compra = nr_documento_p
order by nr_item_cot_compra;

c02 CURSOR FOR
SELECT	distinct
	nr_cot_compra
from	ordem_compra_item
where	nr_cot_compra = nr_documento_p;

c03 CURSOR FOR
SELECT	distinct(a.cd_material)
from	cot_compra_forn_item a,
       	cot_compra_item b
where	a.nr_cot_compra		= b.nr_cot_compra
and	a.nr_item_cot_compra	= b.nr_item_cot_compra
and	b.nr_cot_compra		= nr_documento_p
and not exists (
	SELECT	d.nr_cot_compra
	from	cot_compra_forn_item d
	where	d.nr_cot_compra		= a.nr_cot_compra
	and	d.nr_item_cot_compra	= a.nr_item_cot_compra
	and	d.vl_unitario_material	<> 0);

c04 CURSOR FOR	
SELECT	distinct(Obter_controlador_estoque(a.cd_material))
from	cot_compra_forn_item a,
       	cot_compra_item b
where	a.nr_cot_compra		= b.nr_cot_compra
and	a.nr_item_cot_compra	= b.nr_item_cot_compra
and	b.nr_cot_compra		= nr_documento_p
and not exists (
	SELECT	d.nr_cot_compra
	from	cot_compra_forn_item d
	where	d.nr_cot_compra		= a.nr_cot_compra
	and	d.nr_item_cot_compra	= a.nr_item_cot_compra
	and	d.vl_unitario_material	<> 0);	
	
	
C05 CURSOR FOR
	SELECT obter_desc_material(cd_material)
	FROM solic_compra_item
	WHERE nr_solic_compra = nr_documento_p;	

c06 CURSOR FOR
SELECT	substr(a.cd_material || ' - ' || obter_desc_material(a.cd_material),1,2000) ds_material,
	substr(CASE WHEN a.ds_material_direto='' THEN a.cd_material || ' - ' || obter_desc_material(a.cd_material)  ELSE a.cd_material || ' - ' || obter_desc_material(a.cd_material) || ' - ' ||  a.DS_MATERIAL_DIRETO END ,1,2000) ds_material_compl,
	substr(
	wheb_mensagem_pck.get_texto(299020, 	'CD_MATERIAL=' || a.cd_material || ';DS_MATERIAL=' || e.ds_material ||
						';CD_GRUPO_MATERIAL=' || e.cd_grupo_material || ';DS_GRUPO_MATERIAL=' || e.ds_grupo_material || 
						';CD_SUBGRUPO_MATERIAL=' || e.cd_subgrupo_material || ';DS_SUBGRUPO_MATERIAL=' || e.ds_subgrupo_material || 
						';CD_CLASSE_MATERIAL=' || e.cd_classe_material || ';DS_CLASSE_MATERIAL=' || e.ds_classe_material),1,2000) ds_estrutura,
	substr(a.cd_material || ' - ' || obter_desc_material(a.cd_material) || ' - ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(a.dt_solic_item,'shortDate', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE),1,2000) dt_entrega_item,
	substr(	
	/*#@CD_MATERIAL#@ - #@DS_MATERIAL#@ - Qtde.: #@QT_MATERIAL#@ - Preco: #@VL_UNITARIO#@*/

	wheb_mensagem_pck.get_texto(299097, 	'CD_MATERIAL=' || a.cd_material || 
						';DS_MATERIAL=' || e.ds_material || 
						';QT_MATERIAL=' || campo_mascara_virgula_casas(a.qt_material,4) ||
						';VL_UNITARIO=' || campo_mascara_virgula_casas(a.vl_unit_previsto,4)),1,2000)
from	solic_compra_item a,
	estrutura_material_v e
where	a.cd_material = e.cd_material
and	a.nr_solic_compra = nr_documento_p;

c07 CURSOR FOR
SELECT	substr(obter_desc_material(cd_material),1,255) ds_material,
	substr(obter_desc_material(cd_material),1,255) || ' - ' || campo_mascara_virgula_casas(obter_saldo_estoque_solic_req(nr_requisicao, nr_sequencia),2) ds_material_estoque
from item_requisicao_material
where nr_requisicao = nr_documento_p;

c08 CURSOR FOR
SELECT	nr_ordem_compra
from	ordem_compra_item
where	nr_solic_compra = nr_documento_p
group by nr_ordem_compra;

c09 CURSOR FOR
SELECT	substr(a.cd_material || ' - ' || obter_desc_material(a.cd_material),1,2000) ds_material,
		substr(CASE WHEN a.ds_material_direto='' THEN a.cd_material || ' - ' || obter_desc_material(a.cd_material)  ELSE a.cd_material || ' - ' || obter_desc_material(a.cd_material) || ' - ' ||  a.DS_MATERIAL_DIRETO END ,1,2000) ds_material_compl,
		substr(wheb_mensagem_pck.get_texto(299020, 	'CD_MATERIAL=' || a.cd_material || ';DS_MATERIAL=' || e.ds_material ||
						';CD_GRUPO_MATERIAL=' || e.cd_grupo_material || ';DS_GRUPO_MATERIAL=' || e.ds_grupo_material || 
						';CD_SUBGRUPO_MATERIAL=' || e.cd_subgrupo_material || ';DS_SUBGRUPO_MATERIAL=' || e.ds_subgrupo_material || 
						';CD_CLASSE_MATERIAL=' || e.cd_classe_material || ';DS_CLASSE_MATERIAL=' || e.ds_classe_material),1,2000) ds_estrutura
from	ordem_compra_item a,
		estrutura_material_v e
where	a.cd_material = e.cd_material
and	a.nr_ordem_compra = nr_documento_p;

c10 CURSOR FOR
SELECT	substr(coalesce(obter_valor_dominio(1639,b.ie_motivo_devolucao),''),1,255) ds_motivo_devolucao,
	substr(b.cd_material || ' - ' || obter_desc_material(b.cd_material),1,2000) ds_material
from	inspecao_recebimento a,
	inspecao_contagem b,
	ordem_compra_item_entrega c
where	a.nr_seq_registro = nr_documento_p
and	b.nr_seq_inspecao = a.nr_sequencia
and	c.nr_ordem_compra = a.nr_ordem_compra
and	c.nr_sequencia = a.nr_seq_entrega;

c11 CURSOR FOR
SELECT	distinct a.nr_ordem_compra
from	inspecao_recebimento a,
	inspecao_contagem b,
	ordem_compra_item_entrega c
where	a.nr_seq_registro = nr_documento_p
and	b.nr_seq_inspecao = a.nr_sequencia
and	c.nr_ordem_compra = a.nr_ordem_compra
and	c.nr_sequencia = a.nr_seq_entrega;

c12 CURSOR FOR
SELECT	coalesce(nr_sequencia,0),
	coalesce(ie_consignado,'A'),
	coalesce(ie_usuario,'U'),
	coalesce(ds_email_remetente,'X'),
	replace(ds_email_adicional,',',';'),
	cd_perfil_disparar,
	coalesce(ie_momento_envio,'I'),
	coalesce(ie_envia_pessoa_deleg,'N'),
	ds_senha_remetente,
	ds_email_remetente
from	regra_envio_email_compra
where	cd_estabelecimento = cd_estabelecimento_p
and	ie_tipo_mensagem   = ie_tipo_mensagem_p
and	ie_situacao = 'A'
and	((nr_seq_regra_param_w = 0) or
	(nr_seq_regra_param_w > 0 AND nr_sequencia = nr_seq_regra_param_w));
	

C13 CURSOR FOR
	SELECT	substr(b.cd_material || ' - ' || obter_desc_material(cd_material),1,255)
	from	solic_compra a,
			solic_compra_item b
	where 	a.nr_solic_compra = b.nr_solic_compra
	and		a.nr_solic_compra = nr_documento_p
	order by b.nr_item_solic_compra;
	
C14 CURSOR FOR	
	SELECT	substr(a.cd_material || ' - ' || obter_desc_material(a.cd_material),1,2000) ds_material
	from	ordem_compra_item a
	where	a.nr_ordem_compra = nr_documento_p
	order by a.nr_item_oci;
	
C15 CURSOR FOR	
	SELECT	substr(a.cd_material || ' - ' || obter_desc_material(a.cd_material),1,2000) ds_material
	from	emprestimo_material a
	where	a.nr_emprestimo = nr_documento_p
	order by a.nr_sequencia;	
	
C16 CURSOR FOR
	SELECT 	u.DS_EMAIL
	FROM   	REGRA_ENVIO_EMAIL_USU a,
			USUARIO u
	WHERE  	a.NM_USUARIO_RECEB = u.NM_USUARIO
	AND	   	(u.DS_EMAIL IS NOT NULL AND u.DS_EMAIL::text <> '')
	AND	   	a.NR_SEQ_REGRA = nr_seq_regra_param_w;
	

BEGIN
ds_mensagem_padrao_w	:= '';
dt_retorno_prev_w	:= dt_retorno_prev_p;
nr_seq_regra_param_w	:= coalesce(nr_seq_regra_p,0);

ds_emails_usuarios_fixos:= '';

if (ie_retorno_p = 'RE') then
	open c16;
	loop
	fetch c16 into	
		ds_email_ww;		
	EXIT WHEN NOT FOUND; /* apply on c16 */
		begin
		ds_emails_usuarios_fixos := ds_emails_usuarios_fixos || ds_email_ww || ';';
		end;
	end loop;
	close c16;
end if;

if (ie_retorno_p = 'RE') then
	return	ds_emails_usuarios_fixos;
end if;
		
select	cd_comprador_padrao,
	ds_url_cotacao
into STRICT	cd_comprador_padrao_w,
	ds_url_cotacao_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_p;

if (ie_retorno_p = 'EC') then
	select	max(DS_EMAIL)
	into STRICT	DS_EMAIL_WW
	from	COMPRADOR
	where	CD_PESSOA_FISICA = cd_comprador_padrao_w
	and		IE_SITUACAO = 'A'
	and		(DS_EMAIL IS NOT NULL AND DS_EMAIL::text <> '')
	and 	cd_estabelecimento = cd_estabelecimento_p;
end if;

if (ie_retorno_p = 'EC') then
	return	DS_EMAIL_WW;
end if;
	
select	coalesce(CASE WHEN obter_tipo_documento_compras(nr_documento_p, '0')='O' THEN 'OC' WHEN obter_tipo_documento_compras(nr_documento_p, '0')='S' THEN 'SC' WHEN obter_tipo_documento_compras(nr_documento_p, '0')='C' THEN 'CC'  ELSE 'OC' END ,'OC')
into STRICT	ie_tipo_doc_w
;

open c12;
loop
fetch c12 into	
	nr_sequencia_w,
	ie_consignado_w,
	ie_usuario_w,
	ds_email_remetente_w,
	ds_email_adicional_w,
	cd_perfil_disparar_w,
	ie_momento_envio_w,
	ie_envia_pessoa_deleg_w,
	ds_senha_remetente_w,
	ds_remetente_fixo_w;
EXIT WHEN NOT FOUND; /* apply on c12 */
	begin
	if (obter_se_envia_email_regra(	nr_documento_p,
						ie_tipo_doc_w,
						ie_tipo_mensagem_p,
						cd_estabelecimento_p,
						nr_sequencia_w) = 'S') then
		Exit;
	end if;
	
	end;
end loop;
close c12;


if (ie_usuario_w = 'U') then --Usuario
	select	substr(obter_dados_usuario_opcao(nm_usuario_p,'M'),1,8),
		substr(obter_dados_usuario_opcao(nm_usuario_p,'E'),1,255),
		substr(obter_dados_pf_pj(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),obter_cgc_estabelecimento(cd_estabelecimento_p),'T'),1,15)
	into STRICT	nr_ramal_w,
		ds_email_w,
		nr_telefone_w
	from	usuario
	where	nm_usuario = nm_usuario_p;
elsif (ie_usuario_w = 'C') then --Setor compras
	select	ds_email,
		nr_telefone
	into STRICT	ds_email_w,
		nr_telefone_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_p;
end if;

if (ie_tipo_mensagem_p in (10)) and (nr_sequencia_w > 0) then
	begin
	
	select	cd_comprador_resp,
		coalesce(dt_liberacao,clock_timestamp())
	into STRICT	cd_comprador_w,
		dt_liberacao_w
	from	solic_compra
	where	nr_solic_compra = nr_documento_p;
	
	open C06;
	loop
	fetch C06 into	
		ds_item_w,
		ds_descricao_compl_w,
		ds_estrutura_w,
		dt_entrega_w,
		ds_item_qt_preco_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */
		begin
		ds_item_ww		:= substr(ds_item_ww 		|| ds_item_w || chr(13),1,2000);
		ds_descricao_compl_ww	:= substr(ds_descricao_compl_ww	|| ds_item_w || chr(13),1,2000);
		ds_estrutura_ww		:= substr(ds_estrutura_ww 	|| ds_estrutura_w || chr(13),1,2000);
		dt_entrega_ww		:= substr(dt_entrega_ww 	|| dt_entrega_w || chr(13),1,2000);
		ds_item_qt_preco_ww	:= substr(ds_item_qt_preco_ww 	|| ds_item_qt_preco_w || chr(13),1,2000);
		end;
	end loop;
	close C06;
	
	
	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := substr(replace_macro(ds_assunto_w,'@solicitacao',nr_documento_p),1,255);
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitacao',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@dt_liberacao',PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_liberacao_w,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE)),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@materiais',ds_item_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_complementar',ds_descricao_compl_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@data_entrega',dt_entrega_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_estrutura',ds_estrutura_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_qtd_preco',ds_item_qt_preco_ww),1,4000);	
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);

	select	count(*)
	into STRICT	qt_consignado_w
	from	solic_compra_item
	where	nr_solic_compra = nr_documento_p
	and	substr(obter_se_mat_consignado(cd_material),1,1) in ('1','2');

	if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') or (cd_comprador_padrao_w IS NOT NULL AND cd_comprador_padrao_w::text <> '') then
		select	max(ds_email),
			max(nm_guerra)
		into STRICT	ds_email_comprador_w,
			ds_usuario_comprador_w
		from	comprador
		where	cd_pessoa_fisica = coalesce(cd_comprador_w,cd_comprador_padrao_w)
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;
	end;
	
elsif (ie_tipo_mensagem_p in (1,2,3,5,18,31)) and (nr_sequencia_w > 0) then
	begin
	select	count(*)
	into STRICT	qt_consignado_w
	from	cot_compra_item
	where	nr_cot_compra = nr_documento_p
	and	substr(obter_se_mat_consignado(cd_material),1,1) in ('1','2');
	
	select	substr(ds_observacao,1,255),
		cd_comprador,
		sup_obter_nome_comprador(cd_estabelecimento, cd_comprador)
	into STRICT	ds_observacao_w,
		cd_comprador_w,
		nm_comprador_w
	from	cot_compra
	where	nr_cot_compra = nr_documento_p;

	if (coalesce(cd_cgc_p,'X') <> 'X') and (coalesce(nm_usuario_p,'X') <> 'X') then	
		
		if (ie_usuario_w = 'O') then --Comprador
			select	max(ds_email),
				max(nr_telefone)
			into STRICT	ds_email_w,
				nr_telefone_w
			from	comprador
			where	cd_pessoa_fisica 	= cd_comprador_w
			and	cd_estabelecimento	= cd_estabelecimento_p;
		end if;		
		
		select	obter_cgc_cpf_editado(cd_cgc) cd_cnpj_editado,
			cd_cgc,
			substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,100),
			substr(obter_nome_usuario(nm_usuario_p),1,100),
			substr(obter_desc_cargo(obter_dados_usuario_opcao(nm_usuario_p,'R')),1,80),
			nm_fantasia,
			ds_razao_social,
			ds_senha
		into STRICT	cd_cnpj_editado_w,
			cd_cnpj_w,
			ds_estabelecimento_w,
			nm_usuario_w,
			ds_cargo_w,
			nm_fantasia_w,
			nm_razao_social_w,
			ds_senha_w
		from	pessoa_juridica
		where	cd_cgc = cd_cgc_p;
	end if;

	if (ie_tipo_mensagem_p = 31) then
	
		open C03;
		loop
		fetch C03 into	
			cd_material_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			ds_lista_itens_w := substr(ds_lista_itens_w || cd_material_w || ' - ' || obter_desc_material(cd_material_w) || chr(13) || chr(10),1,2000);
			end;
		end loop;
		close C03;
	
		ds_lista_itens_w	:= substr(ds_lista_itens_w,1,length(ds_lista_itens_w)-2);
		
		if (coalesce(ds_lista_itens_w::text, '') = '') then
			ds_lista_itens_w := wheb_mensagem_pck.get_texto(297865);
		end if;		
		
		open C04;
		loop
		fetch C04 into	
			cd_material_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
			ds_lista_itens_est_w := substr(ds_lista_itens_est_w || cd_material_w || ' - ' || obter_desc_material(cd_material_w) || chr(13) || chr(10),1,2000);
			end;
		end loop;
		close C04;
	
		ds_lista_itens_est_w	:= substr(ds_lista_itens_est_w,1,length(ds_lista_itens_est_w)-2);
		
		if (coalesce(ds_lista_itens_est_w::text, '') = '') then
			ds_lista_itens_est_w := wheb_mensagem_pck.get_texto(297865);
		end if;	
		
	end if;
	
	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj_editado',cd_cnpj_editado_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj',cd_cnpj_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@data',PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_retorno_prev_w,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE));
	ds_assunto_w := replace_macro(ds_assunto_w,'@cotacao',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@observacao',ds_observacao_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fantasia_pj',nm_fantasia_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@razao_pj',nm_razao_social_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@estabelecimento',ds_estabelecimento_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@comprador',nm_comprador_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@itens_nao_cotados',ds_lista_itens_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@itens_est_nao_cotados',ds_lista_itens_est_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@senha',ds_senha_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@url',ds_url_cotacao_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nm_usuario',nm_usuario_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@usuario',nm_usuario_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cargo',ds_cargo_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fone',nr_telefone_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ramal',nr_ramal_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@email',ds_email_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);	
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj_editado',cd_cnpj_editado_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj',cd_cnpj_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@data',PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_retorno_prev_w,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE)),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cotacao',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@observacao',ds_observacao_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fantasia_pj',nm_fantasia_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@razao_pj',nm_razao_social_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@estabelecimento',ds_estabelecimento_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@comprador',nm_comprador_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@itens_nao_cotados',ds_lista_itens_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@itens_est_nao_cotados',ds_lista_itens_est_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@senha',ds_senha_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@url',ds_url_cotacao_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nm_usuario',nm_usuario_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@usuario',nm_usuario_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cargo',ds_cargo_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fone',nr_telefone_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ramal',nr_ramal_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@email',ds_email_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);
	
	select	max(ds_email),
		max(nm_guerra)
	into STRICT	ds_email_comprador_w,
		ds_usuario_comprador_w
	from	comprador
	where	cd_pessoa_fisica = cd_comprador_w
	and	cd_estabelecimento = cd_estabelecimento_p;
	
	end;
elsif (ie_tipo_mensagem_p = 4) and (nr_sequencia_w > 0) then
	begin
	select	count(*)
	into STRICT	qt_consignado_w
	from	cot_compra_item
	where	nr_cot_compra = nr_documento_p
	and	substr(obter_se_mat_consignado(cd_material),1,1) in ('1','2');

	select	cd_comprador
	into STRICT	cd_comprador_w
	from	cot_compra
	where	nr_cot_compra = nr_documento_p;
	
	if (coalesce(cd_cgc_p,'X') <> 'X') and (coalesce(nm_usuario_p,'X') <> 'X') then		
			
		if (ie_usuario_w = 'O') then --Comprador			
			select	max(ds_email),
				max(nr_telefone)
			into STRICT	ds_email_w,
				nr_telefone_w
			from	comprador
			where	cd_pessoa_fisica 	= cd_comprador_w
			and	cd_estabelecimento	= cd_estabelecimento_p;
		end if;
		
		select	obter_cgc_cpf_editado(cd_cgc) cd_cnpj_editado,
			cd_cgc,
			substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,100),
			substr(obter_nome_usuario(nm_usuario_p),1,100),
			substr(obter_desc_cargo(obter_dados_usuario_opcao(nm_usuario_p,'R')),1,80),
			nm_fantasia,
			ds_razao_social,
			ds_senha
		into STRICT	cd_cnpj_editado_w,
			cd_cnpj_w,
			ds_estabelecimento_w,
			nm_usuario_w,
			ds_cargo_w,
			nm_fantasia_w,
			nm_razao_social_w,
			ds_senha_w
		from	pessoa_juridica
		where	cd_cgc = cd_cgc_p;

		select	distinct max(nr_ordem_compra)
		into STRICT	nr_ordem_w
		from	cot_compra_forn_item_tr_v
		where	nr_cot_compra = nr_documento_p
		and	cd_cgc_fornecedor = cd_cgc_p;
	end if;

	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@ordem',nr_ordem_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj_editado',cd_cnpj_editado_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj',cd_cnpj_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fantasia_pj',nm_fantasia_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@razao_pj',nm_razao_social_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@estabelecimento',ds_estabelecimento_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@senha',ds_senha_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@url',ds_url_cotacao_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nm_usuario',nm_usuario_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@usuario',nm_usuario_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cargo',ds_cargo_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fone',nr_telefone_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ramal',nr_ramal_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@email',ds_email_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);	
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ordem',nr_ordem_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj_editado',cd_cnpj_editado_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj',cd_cnpj_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fantasia_pj',nm_fantasia_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@razao_pj',nm_razao_social_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@estabelecimento',ds_estabelecimento_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@senha',ds_senha_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@url',ds_url_cotacao_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nm_usuario',nm_usuario_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@usuario',nm_usuario_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cargo',ds_cargo_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fone',nr_telefone_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ramal',nr_ramal_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@email',ds_email_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);
	
	select	max(ds_email),
		max(nm_guerra)
	into STRICT	ds_email_comprador_w,
		ds_usuario_comprador_w
	from	comprador
	where	cd_pessoa_fisica = cd_comprador_w
	and	cd_estabelecimento = cd_estabelecimento_p;
	
	end;
elsif (ie_tipo_mensagem_p = 6) and (nr_sequencia_w > 0) then
	begin
	select	count(*)
	into STRICT	qt_consignado_w
	from	cot_compra_item
	where	nr_cot_compra = nr_documento_p
	and	substr(obter_se_mat_consignado(cd_material),1,1) in ('1','2');

	select	cd_comprador
	into STRICT	cd_comprador_w
	from	cot_compra
	where	nr_cot_compra = nr_documento_p;

	if (ie_usuario_w = 'O') then --Comprador
		select	max(ds_email),
			max(nr_telefone)
		into STRICT	ds_email_w,
			nr_telefone_w
		from	comprador
		where	cd_pessoa_fisica 	= cd_comprador_w
		and	cd_estabelecimento	= cd_estabelecimento_p;
	end if;

	if (coalesce(cd_cgc_p,'X') <> 'X') and (coalesce(nm_usuario_p,'X') <> 'X') and (length(cd_cgc_p) = 14) then

		select	coalesce(max(ie_alterar_senha),'N')
		into STRICT	ie_alterar_senha_w
		from	pessoa_juridica
		where	cd_cgc = cd_cgc_p;

		select	obter_cgc_cpf_editado(cd_cgc) cd_cnpj_editado,
			cd_cgc,
			substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,100),
			substr(obter_nome_usuario(nm_usuario_p),1,100),
			substr(obter_desc_cargo(obter_dados_usuario_opcao(nm_usuario_p,'R')),1,80),
			nm_fantasia,
			ds_razao_social,
			ds_site_internet,
			ds_senha,
			CASE WHEN ie_alterar_senha_w='N' THEN '' WHEN ie_alterar_senha_w='S' THEN wheb_mensagem_pck.get_texto(299108, 'DS_SENHA=' || ds_senha) END
		into STRICT	cd_cnpj_editado_w,
			cd_cnpj_w,
			ds_estabelecimento_w,
			nm_usuario_w,
			ds_cargo_w,
			nm_fantasia_w,
			nm_razao_social_w,
			ds_site_fornec_w,
			ds_senha_acesso_w,
			ds_senha_w
		from	pessoa_juridica
		where	cd_cgc = cd_cgc_p;
	else 	if (coalesce(cd_cgc_p,'X') <> 'X') and (coalesce(nm_usuario_p,'X') <> 'X') then

			/*Pega as informacoes do fornecedor quando  Pessoa Fisica*/

			select	obter_cgc_cpf_editado(nr_cpf),
				nr_cpf,
				substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,100),
				substr(obter_nome_usuario(nm_usuario_p),1,100),
				substr(obter_desc_cargo(obter_dados_usuario_opcao(nm_usuario_p,'R')),1,80),
				nm_pessoa_fisica,
				ds_senha,
				CASE WHEN  'N'='N' THEN '' WHEN  'N'='S' THEN wheb_mensagem_pck.get_texto(299108, 'DS_SENHA=' || ds_senha) END
			into STRICT	nr_cpf_editado_w,
				nr_cpf_w,
				ds_estabelecimento_w,
				nm_usuario_w,
				ds_cargo_w,
				nm_pessoa_fisica_w,
				ds_senha_acesso_w,
				ds_senha_w
			from	pessoa_fisica
			where	cd_pessoa_fisica = cd_cgc_p;
		end if;
	end if;
	
	open C01;
	loop
	fetch C01 into	
		ds_itens_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_lista_materiais_w := substr(ds_lista_materiais_w || ds_itens_w || chr(13) || chr(10),1,4000);
		end;
	end loop;
	close C01;
	
	select	obter_dados_pf_pj(null,obter_cgc_estabelecimento(cd_estabelecimento),'WS')
	into STRICT	ds_site_estab_w
	from	cot_compra
	where	nr_cot_compra = nr_documento_p;
	
	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@data',PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_retorno_prev_w,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE));
	ds_assunto_w := replace_macro(ds_assunto_w,'@cotacao',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj_editado',cd_cnpj_editado_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj_cpf_editado',coalesce(cd_cnpj_editado_w,nr_cpf_editado_w));
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj',cd_cnpj_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cpf_cnpj_fornec',coalesce(cd_cnpj_w,nr_cpf_w));
	ds_assunto_w := replace_macro(ds_assunto_w,'@fantasia_pj',nm_fantasia_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fantasia_pessoa',coalesce(nm_fantasia_w,nm_pessoa_fisica_w));
	ds_assunto_w := replace_macro(ds_assunto_w,'@razao_pj',nm_razao_social_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@razao_pessoa',coalesce(nm_razao_social_w,nm_pessoa_fisica_w));
	ds_assunto_w := replace_macro(ds_assunto_w,'@site_fornec',ds_site_fornec_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@senha_acesso',ds_senha_acesso_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@site_estab',ds_site_estab_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@itens',ds_lista_materiais_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@estabelecimento',ds_estabelecimento_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@senha',ds_senha_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@url',ds_url_cotacao_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nm_usuario',nm_usuario_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@usuario',nm_usuario_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cargo',ds_cargo_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fone',nr_telefone_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ramal',nr_ramal_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@email',ds_email_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);	
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@data',PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_retorno_prev_w,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE)),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cotacao',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj_editado',cd_cnpj_editado_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj_cpf_editado',coalesce(cd_cnpj_editado_w,nr_cpf_editado_w)),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj',cd_cnpj_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cpf_cnpj_fornec',coalesce(cd_cnpj_w,nr_cpf_w)),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fantasia_pj',nm_fantasia_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fantasia_pessoa',coalesce(nm_fantasia_w,nm_pessoa_fisica_w)),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@razao_pj',nm_razao_social_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@razao_pessoa',coalesce(nm_razao_social_w,nm_pessoa_fisica_w)),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@site_fornec',ds_site_fornec_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@senha_acesso',ds_senha_acesso_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@site_estab',ds_site_estab_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@itens',ds_lista_materiais_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@estabelecimento',ds_estabelecimento_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@senha',ds_senha_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@url',ds_url_cotacao_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nm_usuario',nm_usuario_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@usuario',nm_usuario_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cargo',ds_cargo_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fone',nr_telefone_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ramal',nr_ramal_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@email',ds_email_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);	
	
	select	max(ds_email),
		max(nm_guerra)
	into STRICT	ds_email_comprador_w,
		ds_usuario_comprador_w
	from	comprador
	where	cd_pessoa_fisica = cd_comprador_w
	and	cd_estabelecimento = cd_estabelecimento_p;
	
	end;	
elsif (ie_tipo_mensagem_p = 7) and (nr_sequencia_w > 0) then
	begin
	select	count(*)
	into STRICT	qt_consignado_w
	from	cot_compra_item
	where	nr_cot_compra = nr_documento_p
	and	substr(obter_se_mat_consignado(cd_material),1,1) in ('1','2');

	select	cd_comprador
	into STRICT	cd_comprador_w
	from	cot_compra
	where	nr_cot_compra = nr_documento_p;
	
	if (coalesce(cd_cgc_p,'X') <> 'X') and (coalesce(nm_usuario_p,'X') <> 'X') then

		select	coalesce(max(ie_alterar_senha),'N')
		into STRICT	ie_alterar_senha_w
		from	pessoa_juridica
		where	cd_cgc = cd_cgc_p;		
		
		if (ie_usuario_w = 'O') then --Comprador			
			select	max(ds_email),
				max(nr_telefone)
			into STRICT	ds_email_w,
				nr_telefone_w
			from	comprador
			where	cd_pessoa_fisica 	= cd_comprador_w
			and	cd_estabelecimento	= cd_estabelecimento_p;
		end if;

		select	obter_cgc_cpf_editado(cd_cgc) cd_cnpj_editado,
			cd_cgc,
			substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,100),
			substr(obter_nome_usuario(nm_usuario_p),1,100),
			substr(obter_desc_cargo(obter_dados_usuario_opcao(nm_usuario_p,'R')),1,80),
			substr(obter_dados_usuario_opcao(nm_usuario_p,'M'),1,8),
			substr(obter_dados_usuario_opcao(nm_usuario_p,'E'),1,255),
			substr(obter_dados_pf_pj(null,obter_cgc_estabelecimento(cd_estabelecimento_p),'T'),1,15),
			nm_fantasia,
			ds_razao_social,
			CASE WHEN ie_alterar_senha_w='N' THEN '' WHEN ie_alterar_senha_w='S' THEN wheb_mensagem_pck.get_texto(299108, 'DS_SENHA=' || ds_senha) END
		into STRICT	cd_cnpj_editado_w,
			cd_cnpj_w,
			ds_estabelecimento_w,
			nm_usuario_w,
			ds_cargo_w,
			nr_ramal_w,
			ds_email_w,
			nr_telefone_w,
			nm_fantasia_w,
			nm_razao_social_w,
			ds_senha_w
		from	pessoa_juridica
		where	cd_cgc = cd_cgc_p;
	end if;
	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@data',PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_retorno_prev_w,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE));
	ds_assunto_w := replace_macro(ds_assunto_w,'@cotacao',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj_editado',cd_cnpj_editado_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj',cd_cnpj_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fantasia_pj',nm_fantasia_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@razao_pj',nm_razao_social_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@estabelecimento',ds_estabelecimento_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@senha',ds_senha_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@url',ds_url_cotacao_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nm_usuario',nm_usuario_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@usuario',nm_usuario_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cargo',ds_cargo_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fone',nr_telefone_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ramal',nr_ramal_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@email',ds_email_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@data',PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_retorno_prev_w,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE)),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cotacao',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj_editado',cd_cnpj_editado_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj',cd_cnpj_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fantasia_pj',nm_fantasia_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@razao_pj',nm_razao_social_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@estabelecimento',ds_estabelecimento_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@senha',ds_senha_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@url',ds_url_cotacao_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nm_usuario',nm_usuario_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@usuario',nm_usuario_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cargo',ds_cargo_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fone',nr_telefone_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ramal',nr_ramal_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@email',ds_email_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);	

	select	max(ds_email),
		max(nm_guerra)
	into STRICT	ds_email_comprador_w,
		ds_usuario_comprador_w
	from	comprador
	where	cd_pessoa_fisica = cd_comprador_w
	and	cd_estabelecimento = cd_estabelecimento_p;
	
	end;
elsif (ie_tipo_mensagem_p in (8,9,11,26,27)) and (nr_sequencia_w > 0) then
	begin
	
	select	count(*)
	into STRICT	qt_consignado_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_documento_p
	and	substr(obter_se_mat_consignado(cd_material),1,1) in ('1','2');

	select	coalesce(max(a.cd_cgc_fornecedor),'X'),
		coalesce(max(b.nr_cot_compra),0),
		max(cd_comprador)
	into STRICT	cd_cgc_fornecedor_w,
		nr_cot_compra_w,
		cd_comprador_w
	from	ordem_compra a,
		ordem_compra_item b
	where	a.nr_ordem_compra = b.nr_ordem_compra
	and	a.nr_ordem_compra = nr_documento_p;
	
	if (cd_cgc_fornecedor_w <> 'X') then	
	
		if (ie_usuario_w = 'O') then --Comprador
			select	max(ds_email),
				max(nr_telefone)
			into STRICT	ds_email_w,
				nr_telefone_w
			from	comprador
			where	cd_pessoa_fisica 	= cd_comprador_w
			and	cd_estabelecimento	= cd_estabelecimento_p;
		end if;
		
		select	obter_cgc_cpf_editado(cd_cgc) cd_cnpj_editado,
			cd_cgc,
			substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,100),
			substr(obter_nome_usuario(nm_usuario_p),1,100),
			substr(obter_desc_cargo(obter_dados_usuario_opcao(nm_usuario_p,'R')),1,80),
			nm_fantasia,
			ds_razao_social
		into STRICT	cd_cnpj_editado_w,
			cd_cnpj_w,
			ds_estabelecimento_w,
			nm_usuario_w,
			ds_cargo_w,
			nm_fantasia_w,
			nm_razao_social_w
		from	pessoa_juridica
		where	cd_cgc = cd_cgc_fornecedor_w;
	end if;

	select	campo_mascara_virgula_casas(coalesce(sum(obter_valor_liquido_ordem(nr_ordem_compra)),0),4)
	into STRICT	vl_total_ordem_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;

	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@ordem',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cotacao',nr_cot_compra_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj_editado',cd_cnpj_editado_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj',cd_cnpj_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fantasia_pj',nm_fantasia_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@razao_pj',nm_razao_social_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@estabelecimento',ds_estabelecimento_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nm_usuario',nm_usuario_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@usuario',nm_usuario_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cargo',ds_cargo_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fone',nr_telefone_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ramal',nr_ramal_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@email',ds_email_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@vl_ordem',vl_total_ordem_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);	
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ordem',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cotacao',nr_cot_compra_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj_editado',cd_cnpj_editado_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj',cd_cnpj_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fantasia_pj',nm_fantasia_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@razao_pj',nm_razao_social_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@estabelecimento',ds_estabelecimento_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nm_usuario',nm_usuario_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@usuario',nm_usuario_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cargo',ds_cargo_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fone',nr_telefone_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ramal',nr_ramal_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@email',ds_email_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@vl_ordem',vl_total_ordem_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);	

	select	max(ds_email),
		max(nm_guerra)
	into STRICT	ds_email_comprador_w,
		ds_usuario_comprador_w
	from	comprador
	where	cd_pessoa_fisica = cd_comprador_w
	and	cd_estabelecimento = cd_estabelecimento_p;
	
	end;
elsif (ie_tipo_mensagem_p in (21,32)) and (nr_sequencia_w > 0) then
	begin
	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@cotacao',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@url',ds_url_cotacao_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@data', PKG_DATE_FORMATERS_TZ.TO_VARCHAR(clock_timestamp(),'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE));
	ds_assunto_w := substr(ds_assunto_w,1,255);
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cotacao',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@url',ds_url_cotacao_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@data',PKG_DATE_FORMATERS_TZ.TO_VARCHAR(clock_timestamp(),'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE)),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);
	
	select	cd_comprador
	into STRICT	cd_comprador_w
	from	cot_compra
	where	nr_cot_compra = nr_documento_p;

	select	max(ds_email),
		max(nm_guerra)
	into STRICT	ds_email_comprador_w,
		ds_usuario_comprador_w
	from	comprador
	where	cd_pessoa_fisica = cd_comprador_w
	and	cd_estabelecimento = cd_estabelecimento_p;
	
	end;
elsif (ie_tipo_mensagem_p in (33,46)) and (nr_sequencia_w > 0) then
	begin
	
	ds_assunto_w	:= null;
	ds_mensagem_padrao_w	:= null;
	
	select	substr(obter_nome_pf(cd_pessoa_solicitante),1,100),
		substr(obter_nome_pf(obter_dados_parametro_compras(cd_estabelecimento, 16)),1,100),
		cd_local_estoque,
		substr(obter_desc_local_estoque(cd_local_estoque),1,100),
		cd_centro_custo,
		substr(obter_desc_centro_custo(cd_centro_custo),1,100)
	into STRICT	nm_pessoa_solicitante_w,
		nm_responsavel_compras_w,
		cd_local_estoque_w,
		ds_local_estoque_w,
		cd_centro_custo_w,
		ds_centro_custo_w
	from	solic_compra
	where	nr_solic_compra = nr_documento_p;
		
	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@solicitacao',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@solicitante',nm_pessoa_solicitante_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@comprador',nm_responsavel_compras_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cd_local',cd_local_estoque_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ds_local',ds_local_estoque_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cd_centro_custo',cd_centro_custo_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ds_centro_custo',ds_centro_custo_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);	
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitacao',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitante',nm_pessoa_solicitante_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@comprador',nm_responsavel_compras_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cd_local',cd_local_estoque_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ds_local',ds_local_estoque_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cd_centro_custo',cd_centro_custo_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ds_centro_custo',ds_centro_custo_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);	
	
	select	coalesce(max(ds_email),''),
		coalesce(max(nm_guerra),'')
	into STRICT	ds_email_comprador_w,
		ds_usuario_comprador_w
	from	comprador
	where	cd_pessoa_fisica = obter_dados_parametro_compras(cd_estabelecimento, 16)
	and	cd_estabelecimento = cd_estabelecimento_p;
	
	end;	
--Minha altercao 75
elsif (ie_tipo_mensagem_p in (75)) and (nr_sequencia_w > 0) then
	begin

	select	b.cd_centro_custo,
		substr(obter_desc_centro_custo(b.cd_centro_custo),1,100) ds_centro_custo,
		sum(coalesce(b.vl_rateio,0))
	into STRICT	cd_centro_custo_w,
		ds_centro_custo_w,
		vl_rateio_w		
	from	solic_compra a,
		solic_compra_item_rateio b
	where	a.nr_solic_compra = b.nr_solic_compra
	and	a.nr_solic_compra = nr_documento_p
	group by b.cd_centro_custo;
	
	
	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@solicitacao',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@vl_rateio',campo_mascara_virgula_casas(vl_rateio_w,2));
	ds_assunto_w := replace_macro(ds_assunto_w,'@cd_centro_custo',cd_centro_custo_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ds_centro_custo',ds_centro_custo_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);	
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitacao',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@vl_rateio',campo_mascara_virgula_casas(vl_rateio_w,2)),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cd_centro_custo',cd_centro_custo_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ds_centro_custo',ds_centro_custo_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);	
	
	select	coalesce(max(ds_email),''),
		coalesce(max(nm_guerra),'')
	into STRICT	ds_email_comprador_w,
		ds_usuario_comprador_w
	from	comprador
	where	cd_pessoa_fisica = obter_dados_parametro_compras(cd_estabelecimento, 16)
	and	cd_estabelecimento = cd_estabelecimento_p;
	
	end;	
	
-- Minha altercao	
elsif (ie_tipo_mensagem_p = 22) and (nr_sequencia_w > 0) then
	begin
	
	select	max(obter_cgc_cpf_editado(a.cd_cgc_fornecedor)) cd_cnpj_editado,
		coalesce(max(a.cd_cgc_fornecedor),'X'),
		max(substr(obter_dados_pf_pj(null,a.cd_cgc_fornecedor,'F'),1,100)) nm_fantasia,
		max(substr(obter_dados_pf_pj(null,a.cd_cgc_fornecedor,'N'),1,100)) nm_razao_social,
		max(substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,100)) ds_estabelecimento,
		max(substr(obter_nome_usuario(nm_usuario_p),1,100)) nm_usuario,
		max(substr(obter_desc_cargo(obter_dados_usuario_opcao(nm_usuario_p,'R')),1,80)) ds_cargo,
		coalesce(max(b.nr_cot_compra),0),
		max(cd_comprador),
		max(a.dt_entrega),
		max(substr(obter_cgc_cpf_editado(obter_cgc_estabelecimento(cd_estabelecimento_p)),1,20)),
		max(substr(obter_dados_estab(cd_estabelecimento_p,1),1,255)),
		max(substr(obter_dados_pf_pj(null,obter_cgc_estabelecimento(cd_estabelecimento_p),'N'),1,100))
	into STRICT	cd_cnpj_editado_w,
		cd_cgc_fornecedor_w,
		nm_fantasia_w,
		nm_razao_social_w,
		ds_estabelecimento_w,
		nm_usuario_w,
		ds_cargo_w,
		nr_cot_compra_w,
		cd_comprador_w,
		dt_entrega_w,
		cd_cgc_estab_w,
		nm_fantasia_estab_w,
		nm_razao_social_estab_w
	from	ordem_compra a,
		ordem_compra_item b
	where	a.nr_ordem_compra = b.nr_ordem_compra
	and	a.nr_ordem_compra = nr_documento_p;
	
	select	campo_mascara_virgula_casas(coalesce(sum(obter_valor_liquido_ordem(nr_ordem_compra)),0),4)
	into STRICT	vl_total_ordem_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;
	
	if (ie_usuario_w = 'O') then --Comprador			
		select	max(ds_email),
			max(nr_telefone)
		into STRICT	ds_email_w,
			nr_telefone_w
		from	comprador
		where	cd_pessoa_fisica 	= cd_comprador_w
		and	cd_estabelecimento	= cd_estabelecimento_p;
	end if;


	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@ordem',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cotacao',nr_cot_compra_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj_editado',cd_cnpj_editado_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj',cd_cgc_fornecedor_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fantasia_pj',nm_fantasia_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@razao_pj',nm_razao_social_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@estabelecimento',ds_estabelecimento_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nm_usuario',nm_usuario_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@url',ds_url_cotacao_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@usuario',nm_usuario_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cargo',ds_cargo_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fone',nr_telefone_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ramal',nr_ramal_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@email',ds_email_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@dt_entrega',dt_entrega_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cgc_estab',cd_cgc_estab_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fantasia_estab',nm_fantasia_estab_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@vl_ordem_compra',vl_total_ordem_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@razao_estab',nm_razao_social_estab_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);	
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ordem',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cotacao',nr_cot_compra_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj_editado',cd_cnpj_editado_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj',cd_cgc_fornecedor_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fantasia_pj',nm_fantasia_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@razao_pj',nm_razao_social_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@url',ds_url_cotacao_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@estabelecimento',ds_estabelecimento_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nm_usuario',nm_usuario_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@usuario',nm_usuario_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cargo',ds_cargo_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fone',nr_telefone_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ramal',nr_ramal_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@email',ds_email_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@dt_entrega',dt_entrega_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cgc_estab',cd_cgc_estab_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fantasia_estab',nm_fantasia_estab_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@vl_ordem_compra',vl_total_ordem_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@razao_estab',nm_razao_social_estab_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);	
	
	select	cd_comprador
	into STRICT	cd_comprador_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;

	select	max(ds_email),
		max(nm_guerra)
	into STRICT	ds_email_comprador_w,
		ds_usuario_comprador_w
	from	comprador
	where	cd_pessoa_fisica = cd_comprador_w
	and	cd_estabelecimento = cd_estabelecimento_p;
	
	end;	
elsif (ie_tipo_mensagem_p in (12,13,14,15,36)) and (nr_sequencia_w > 0) then
	begin
	select	obter_tipo_documento_compras(nr_documento_p, '0'),
		obter_tipo_documento_compras(nr_documento_p, '1')
	into STRICT	ie_tipo_documento_w,
		ds_tipo_documento_w
	;	
	
	if (ie_tipo_documento_w = 'O') then

		select	max(substr(obter_nome_pf_pj(a.cd_pessoa_solicitante, null),1,80)),
			max(a.cd_cgc_fornecedor),
			max(b.nr_cot_compra),
			max(cd_comprador)
		into STRICT	nm_pessoa_solicitante_w,
			cd_cgc_fornecedor_w,
			nr_cot_compra_w,
			cd_comprador_w
		from	ordem_compra a,
			ordem_compra_item b
		where	a.nr_ordem_compra = b.nr_ordem_compra
		and	a.nr_ordem_compra = nr_documento_p;
		
		if (ie_usuario_w = 'O') then --Comprador			
			select	max(ds_email),
				max(nr_telefone)
			into STRICT	ds_email_w,
				nr_telefone_w
			from	comprador
			where	cd_pessoa_fisica 	= cd_comprador_w
			and	cd_estabelecimento	= cd_estabelecimento_p;
		end if;		

		select	obter_cgc_cpf_editado(cd_cgc) cd_cnpj_editado,
			cd_cgc,
			substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,100),
			substr(obter_nome_usuario(nm_usuario_p),1,100),
			substr(obter_desc_cargo(obter_dados_usuario_opcao(nm_usuario_p,'R')),1,80),
			nm_fantasia,
			ds_razao_social,
			ds_senha
		into STRICT	cd_cnpj_editado_w,
			cd_cnpj_w,
			ds_estabelecimento_w,
			nm_usuario_w,
			ds_cargo_w,
			nm_fantasia_w,
			nm_razao_social_w,
			ds_senha_w
		from	pessoa_juridica
		where	cd_cgc = cd_cgc_fornecedor_w;

		select	ds_assunto,
			substr(ds_mensagem_padrao,1,4000)
		into STRICT	ds_assunto_w,
			ds_mensagem_padrao_w
		from	regra_envio_email_compra
		where	nr_sequencia = nr_sequencia_w;
		
		ds_assunto_w := replace_macro(ds_assunto_w,'@documento',nr_documento_p);
		ds_assunto_w := replace_macro(ds_assunto_w,'@tipo_documento', ds_tipo_documento_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@solicitante', nm_pessoa_solicitante_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@cotacao',nr_cot_compra_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj_editado',cd_cnpj_editado_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj',cd_cnpj_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@url',ds_url_cotacao_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@fantasia_pj',nm_fantasia_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@razao_pj',nm_razao_social_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@estabelecimento',ds_estabelecimento_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@nm_usuario',nm_usuario_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@usuario',nm_usuario_p);
		ds_assunto_w := replace_macro(ds_assunto_w,'@senha',ds_senha_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@cargo',ds_cargo_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@fone',nr_telefone_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@ramal',nr_ramal_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@email',ds_email_w);
		ds_assunto_w := substr(ds_assunto_w,1,255);		
		
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@documento',nr_documento_p),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@tipo_documento', ds_tipo_documento_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitante', nm_pessoa_solicitante_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cotacao',nr_cot_compra_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj_editado',cd_cnpj_editado_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj',cd_cnpj_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fantasia_pj',nm_fantasia_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@razao_pj',nm_razao_social_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@estabelecimento',ds_estabelecimento_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@url',ds_url_cotacao_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nm_usuario',nm_usuario_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@senha',ds_senha_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@usuario',nm_usuario_p),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cargo',ds_cargo_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fone',nr_telefone_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ramal',nr_ramal_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@email',ds_email_w),1,4000);
		ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);		

		select	max(ds_email),
			max(nm_guerra)
		into STRICT	ds_email_comprador_w,
			ds_usuario_comprador_w
		from	comprador
		where	cd_pessoa_fisica = cd_comprador_w
		and	cd_estabelecimento = cd_estabelecimento_p;

	elsif (ie_tipo_documento_w = 'S') then
		select	substr(obter_nome_pf_pj(cd_pessoa_solicitante, null),1,80),
			cd_comprador_w
		into STRICT	nm_pessoa_solicitante_w,
			cd_comprador_w
		from	solic_compra
		where	nr_solic_compra = nr_documento_p;

		select	ds_assunto,
			substr(ds_mensagem_padrao,1,4000)
		into STRICT	ds_assunto_w,
			ds_mensagem_padrao_w
		from	regra_envio_email_compra
		where	nr_sequencia = nr_sequencia_w;
		
		ds_assunto_w := replace_macro(ds_assunto_w,'@documento',nr_documento_p);
		ds_assunto_w := replace_macro(ds_assunto_w,'@tipo_documento', ds_tipo_documento_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@solicitante', nm_pessoa_solicitante_w);
		ds_assunto_w := substr(ds_assunto_w,1,255);
		
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@documento',nr_documento_p),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@tipo_documento',ds_tipo_documento_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitante',nm_pessoa_solicitante_w),1,4000);
		ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);
		
		if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') or (cd_comprador_padrao_w IS NOT NULL AND cd_comprador_padrao_w::text <> '') then
		
			select	max(ds_email),
				max(nm_guerra)
			into STRICT	ds_email_comprador_w,
				ds_usuario_comprador_w
			from	comprador
			where	cd_pessoa_fisica = coalesce(cd_comprador_w,cd_comprador_padrao_w)
			and	cd_estabelecimento = cd_estabelecimento_p;
		end if;	

	elsif (ie_tipo_documento_w = 'C') then

		select	substr(obter_nome_pf_pj(cd_pessoa_solicitante, null),1,80),
			cd_comprador_w
		into STRICT	nm_pessoa_solicitante_w,
			cd_comprador_w
		from	cot_compra
		where	nr_cot_compra = nr_documento_p;

		select	ds_assunto,
			substr(ds_mensagem_padrao,1,4000)
		into STRICT	ds_assunto_w,
			ds_mensagem_padrao_w
		from	regra_envio_email_compra
		where	nr_sequencia = nr_sequencia_w;
		
		ds_assunto_w := replace_macro(ds_assunto_w,'@documento',nr_documento_p);
		ds_assunto_w := replace_macro(ds_assunto_w,'@tipo_documento', ds_tipo_documento_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@solicitante', nm_pessoa_solicitante_w);
		ds_assunto_w := substr(ds_assunto_w,1,255);
		
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@documento',nr_documento_p),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@tipo_documento', ds_tipo_documento_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitante', nm_pessoa_solicitante_w),1,4000);
		ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);

		if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') or (cd_comprador_padrao_w IS NOT NULL AND cd_comprador_padrao_w::text <> '') then
		
			select	max(ds_email),
				max(nm_guerra)
			into STRICT	ds_email_comprador_w,
				ds_usuario_comprador_w
			from	comprador
			where	cd_pessoa_fisica = coalesce(cd_comprador_w,cd_comprador_padrao_w)
			and	cd_estabelecimento = cd_estabelecimento_p;
		end if;
	elsif (ie_tipo_documento_w = 'R') then
		begin
		select	substr(obter_nome_pf_pj(cd_pessoa_solicitante, null),1,80)
		into STRICT	nm_pessoa_solicitante_w
		from	requisicao_material
		where	nr_requisicao = nr_documento_p;

		select	ds_assunto,
			substr(ds_mensagem_padrao,1,4000)
		into STRICT	ds_assunto_w,
			ds_mensagem_padrao_w
		from	regra_envio_email_compra
		where	nr_sequencia = nr_sequencia_w;
		
		ds_assunto_w := replace_macro(ds_assunto_w,'@documento',nr_documento_p);
		ds_assunto_w := replace_macro(ds_assunto_w,'@tipo_documento', ds_tipo_documento_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@solicitante', nm_pessoa_solicitante_w);
		ds_assunto_w := substr(ds_assunto_w,1,255);

		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@documento',nr_documento_p),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@tipo_documento', ds_tipo_documento_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitante', nm_pessoa_solicitante_w),1,4000);
		ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);
			
		end;
	end if;
	end;
elsif (ie_tipo_mensagem_p in (28)) and (nr_sequencia_w > 0) then
	
	select	count(*)
	into STRICT	qt_consignado_w
	from	cot_compra_item
	where	nr_cot_compra = nr_documento_p
	and	substr(obter_se_mat_consignado(cd_material),1,1) in ('1','2');
	
	select	substr(obter_nome_pf_pj(cd_responsavel_compras,null),1,100),
		substr(obter_nome_usuario(nm_usuario_p),1,100)
	into STRICT	nm_responsavel_compras_w,
		nm_usuario_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_p;	
		
	open C02;
	loop
	fetch C02 into	
		nr_ordem_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		ds_lista_ordem_w := substr(ds_lista_ordem_w || nr_ordem_compra_w || ', ',1,255);
		end;
	end loop;
	close C02;

	ds_lista_ordem_w := substr(ds_lista_ordem_w, 1, length(ds_lista_ordem_w) -2);
	
	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@ordens',ds_lista_ordem_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@resp_compra', nm_responsavel_compras_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cotacao', nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@data',clock_timestamp());
	ds_assunto_w := replace_macro(ds_assunto_w,'@usuario',nm_usuario_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ordens',ds_lista_ordem_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@resp_compra', nm_responsavel_compras_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cotacao', nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@data',clock_timestamp()),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@usuario',nm_usuario_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);
		
elsif (ie_tipo_mensagem_p in (30)) and (nr_sequencia_w > 0) then
	begin
	select	coalesce(max(ie_urgente), 'N'),
		max(substr(obter_nome_pf_pj(cd_pessoa_solicitante,null),1,255))
	into STRICT	ie_urgente_w,
		nm_solicitante_w
	from	solic_compra
	where	nr_solic_compra = nr_documento_p;
	
	if (ie_urgente_w = 'S') then
	
		open C06;
		loop
		fetch C06 into	
			ds_item_w,
			ds_descricao_compl_w,
			ds_estrutura_w,
			dt_entrega_w,
			ds_item_qt_preco_w;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			begin
			ds_item_ww		:= substr(ds_item_ww 		|| ds_item_w || chr(13),1,2000);
			ds_descricao_compl_ww	:= substr(ds_descricao_compl_ww	|| ds_item_w || chr(13),1,2000);
			ds_estrutura_ww		:= substr(ds_estrutura_ww 	|| ds_estrutura_w || chr(13),1,2000);
			dt_entrega_ww		:= substr(dt_entrega_ww 	|| dt_entrega_w || chr(13),1,2000);
			ds_item_qt_preco_ww	:= substr(ds_item_qt_preco_ww 	|| ds_item_qt_preco_w || chr(13),1,2000);
			end;
		end loop;
		close C06;
		
		select	ds_assunto,
			substr(ds_mensagem_padrao,1,4000)
		into STRICT	ds_assunto_w,
			ds_mensagem_padrao_w
		from	regra_envio_email_compra
		where	nr_sequencia = nr_sequencia_w;
		
		ds_assunto_w := replace_macro(ds_assunto_w,'@solicitacao',nr_documento_p);
		ds_assunto_w := replace_macro(ds_assunto_w,'@solicitante',nm_solicitante_w);
		ds_assunto_w := replace_macro(ds_assunto_w,'@materiais',ds_item_ww);
		ds_assunto_w := replace_macro(ds_assunto_w,'@mat_complementar',ds_descricao_compl_ww);
		ds_assunto_w := replace_macro(ds_assunto_w,'@data_entrega',dt_entrega_ww);
		ds_assunto_w := replace_macro(ds_assunto_w,'@mat_estrutura',ds_estrutura_ww);
		ds_assunto_w := replace_macro(ds_assunto_w,'@mat_qtd_preco',ds_item_qt_preco_ww);
		ds_assunto_w := substr(ds_assunto_w,1,255);
		
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitacao',nr_documento_p),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitante',nm_solicitante_w),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@materiais',ds_item_ww),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_complementar',ds_descricao_compl_ww),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@data_entrega',dt_entrega_ww),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_estrutura',ds_estrutura_ww),1,4000);
		ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_qtd_preco',ds_item_qt_preco_ww),1,4000);
		ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);
		
		select	count(*)
		into STRICT	qt_consignado_w
		from	solic_compra_item
		where	nr_solic_compra = nr_documento_p
		and	substr(obter_se_mat_consignado(cd_material),1,1) in ('1','2');
		
		select	cd_comprador_resp
		into STRICT	cd_comprador_w
		from	solic_compra
		where	nr_solic_compra = nr_documento_p;
		
		if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') or (cd_comprador_padrao_w IS NOT NULL AND cd_comprador_padrao_w::text <> '') then
			select	max(ds_email),
				max(nm_guerra)
			into STRICT	ds_email_comprador_w,
				ds_usuario_comprador_w
			from	comprador
			where	cd_pessoa_fisica = coalesce(cd_comprador_w,cd_comprador_padrao_w)
			and	cd_estabelecimento = cd_estabelecimento_p;
		end if;	
	end if;
	end;
elsif (ie_tipo_mensagem_p  = 39) and (nr_sequencia_w > 0) then
	begin	
	
	select	substr(obter_nome_pf_pj(cd_pessoa_solicitante,null),1,255)
	into STRICT	nm_solicitante_w
	from	solic_compra
	where	nr_solic_compra = nr_documento_p;

	open C06;
	loop
	fetch C06 into	
		ds_item_w,
		ds_descricao_compl_w,
		ds_estrutura_w,
		dt_entrega_w,
		ds_item_qt_preco_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */
		begin
		ds_item_ww		:= substr(ds_item_ww 		|| ds_item_w || chr(13),1,2000);
		ds_descricao_compl_ww	:= substr(ds_descricao_compl_ww	|| ds_descricao_compl_w || chr(13),1,2000);
		ds_estrutura_ww		:= substr(ds_estrutura_ww 	|| ds_estrutura_w || chr(13),1,2000);
		dt_entrega_ww		:= substr(dt_entrega_ww 	|| dt_entrega_w || chr(13),1,2000);
		ds_item_qt_preco_ww	:= substr(ds_item_qt_preco_ww 	|| ds_item_qt_preco_w || chr(13),1,2000);
		end;
	end loop;
	close C06;

	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@solicitacao',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@solicitante',nm_solicitante_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@materiais',ds_item_ww);
	ds_assunto_w := replace_macro(ds_assunto_w,'@mat_complementar',ds_descricao_compl_ww);
	ds_assunto_w := replace_macro(ds_assunto_w,'@data_entrega',dt_entrega_ww);
	ds_assunto_w := replace_macro(ds_assunto_w,'@mat_estrutura',ds_estrutura_ww);
	ds_assunto_w := replace_macro(ds_assunto_w,'@mat_qtd_preco',ds_item_qt_preco_ww);
	ds_assunto_w := substr(ds_assunto_w,1,255);	
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitacao',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitante',nm_solicitante_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@materiais',ds_item_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_complementar',ds_descricao_compl_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@data_entrega',dt_entrega_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_estrutura',ds_estrutura_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_qtd_preco',ds_item_qt_preco_ww),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);	

	select	count(*)
	into STRICT	qt_consignado_w
	from	solic_compra_item
	where	nr_solic_compra = nr_documento_p
	and	substr(obter_se_mat_consignado(cd_material),1,1) in ('1','2');

	select	cd_comprador_resp
	into STRICT	cd_comprador_w
	from	solic_compra
	where	nr_solic_compra = nr_documento_p;

	if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') or (cd_comprador_padrao_w IS NOT NULL AND cd_comprador_padrao_w::text <> '') then
		select	max(ds_email),
			max(nm_guerra)
		into STRICT	ds_email_comprador_w,
			ds_usuario_comprador_w
		from	comprador
		where	cd_pessoa_fisica = coalesce(cd_comprador_w,cd_comprador_padrao_w)
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;
	end;
end if;


if (ie_tipo_mensagem_p = 63)and (nr_sequencia_w > 0) then
	open C05;
	loop
	fetch C05 into	
	     ds_item_solic_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin
		ds_lista_mat_solic_w := substr(ds_lista_mat_solic_w || ds_item_solic_w || chr(13) || chr(10),1,4000);
		end;
	end loop;
	close C05;
	select	substr(replace_macro(ds_assunto,'@solicitacao',nr_documento_p),1,255),
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;	
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitacao',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@descricao',ds_lista_mat_solic_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);
	
	select	count(*)
	into STRICT	qt_consignado_w
	from	solic_compra_item
	where	nr_solic_compra = nr_documento_p
	and	substr(obter_se_mat_consignado(cd_material),1,1) in ('1','2');
	
	if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') or (cd_comprador_padrao_w IS NOT NULL AND cd_comprador_padrao_w::text <> '') then
		select	max(ds_email),
			max(nm_guerra)
		into STRICT	ds_email_comprador_w,
			ds_usuario_comprador_w
		from	comprador
		where	cd_pessoa_fisica = coalesce(cd_comprador_w,cd_comprador_padrao_w)
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;
end if;

if (ie_tipo_mensagem_p = 70)and (nr_sequencia_w > 0) then
	begin

	open C09;
	loop
	fetch C09 into	
		ds_item_w,
		ds_descricao_compl_w,
		ds_estrutura_w;
	EXIT WHEN NOT FOUND; /* apply on C09 */
		begin
		ds_item_ww				:= substr(ds_item_ww 		|| ds_item_w || chr(13),1,2000);
		ds_descricao_compl_ww	:= substr(ds_descricao_compl_ww	|| ds_descricao_compl_w || chr(13),1,2000);
		ds_estrutura_ww			:= substr(ds_estrutura_ww 	|| ds_estrutura_w || chr(13),1,2000);
		end;
	end loop;
	close C09;
	
	select	coalesce(a.ds_usuario,b.nm_usuario_lib)
	into STRICT	nm_pessoa_lib_w
	from	usuario a,
		ordem_compra b
	where	b.nr_ordem_compra = nr_documento_p
	and	a.nm_usuario = b.nm_usuario_lib;	

	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@nr_ordem_compra',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nm_pessoa_lib',nm_pessoa_lib_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nr_ordem_compra',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nm_pessoa_lib',nm_pessoa_lib_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@materiais',ds_item_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_complementar',ds_descricao_compl_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_estrutura',ds_estrutura_ww),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);

	select	count(*)
	into STRICT	qt_consignado_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_documento_p
	and	substr(obter_se_mat_consignado(cd_material),1,1) in ('1','2');

	select	cd_comprador
	into STRICT	cd_comprador_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;

	if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') or (cd_comprador_padrao_w IS NOT NULL AND cd_comprador_padrao_w::text <> '') then
		select	max(ds_email),
			max(nm_guerra)
		into STRICT	ds_email_comprador_w,
			ds_usuario_comprador_w
		from	comprador
		where	cd_pessoa_fisica = coalesce(cd_comprador_w,cd_comprador_padrao_w)
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;

	end;
	
elsif (ie_tipo_mensagem_p in (72)) and (nr_sequencia_w > 0) then
	ds_material_req_ww	:= '';
	ds_mat_est_req_ww	:= '';
	open c07;
	loop
	fetch c07 into
		ds_material_req_w,
		ds_mat_est_req_w;
	EXIT WHEN NOT FOUND; /* apply on c07 */
		begin
		ds_material_req_ww	:= substr(ds_material_req_ww	|| ds_material_req_w	|| chr(13) || chr(10),1,3000);
		ds_mat_est_req_ww	:= substr(ds_mat_est_req_ww	|| ds_mat_est_req_w	|| chr(13) || chr(10),1,3000);
		end;
	end loop;
	close c07;
	
	select	nr_requisicao,
		substr(obter_nome_pessoa_fisica(cd_pessoa_requisitante,null),1,255) nm_pessoa_requisitante,
		substr(obter_nome_pf(cd_pessoa_solicitante),1,255) nm_pessoa_solicitante,
		CASE WHEN ie_urgente='S' THEN wheb_mensagem_pck.get_texto(275172)  ELSE wheb_mensagem_pck.get_texto(275173) END ,
		substr(obter_desc_operacao_estoque(cd_operacao_estoque),1,40) ds_operacao_estoque,
		substr(obter_desc_local_estoque(cd_local_estoque),1,40) ds_local_estoque,
		substr(obter_desc_local_estoque(cd_local_estoque_destino),1,40) ds_local_est_dest,
		substr(obter_desc_centro_custo(cd_centro_custo),1,80) ds_centro_custo
	into STRICT	nr_requisicao_w,
		nm_requisitante_w,
		nm_solicitante_req_w,
		ie_urgente_req_w,
		ds_operacao_estoque_w,
		ds_local_estoque_req_w,
		ds_local_est_dest_w,
		ds_centro_custo_req_w
	from	requisicao_material
	where	nr_requisicao = nr_documento_p;
	
	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@nr_requisicao',nr_requisicao_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nome_requisitante',nm_requisitante_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nome_solicitante',nm_solicitante_req_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@data_liberacao_requisicao',clock_timestamp());
	ds_assunto_w := replace_macro(ds_assunto_w,'@requisicao_urgente',ie_urgente_req_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@desc_operacao_estoque',ds_operacao_estoque_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@desc_local_estoque',ds_local_estoque_req_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@desc_local_estoque_destino',ds_local_est_dest_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@desc_centro_custo',ds_centro_custo_req_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@desc_materiais_requisicao',ds_material_req_ww);
	ds_assunto_w := replace_macro(ds_assunto_w,'@desc_materiais_qt_estoque',ds_mat_est_req_ww);
	ds_assunto_w := substr(ds_assunto_w,1,255);
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nr_requisicao',nr_requisicao_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nome_requisitante',nm_requisitante_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nome_solicitante',nm_solicitante_req_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@data_liberacao_requisicao',clock_timestamp()),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@requisicao_urgente',ie_urgente_req_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@desc_operacao_estoque',ds_operacao_estoque_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@desc_local_estoque',ds_local_estoque_req_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@desc_local_estoque_destino',ds_local_est_dest_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@desc_centro_custo',ds_centro_custo_req_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@desc_materiais_requisicao',ds_material_req_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@desc_materiais_qt_estoque',ds_mat_est_req_ww),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);	
	
elsif (ie_tipo_mensagem_p = 73)and (nr_sequencia_w > 0) then

	select	nr_ordem_compra
	into STRICT	nr_ordem_compra_w
	from	ordem_compra b
	where	b.nr_ordem_compra = nr_documento_p;

	
	open C09;
	loop
	fetch C09 into	
		ds_item_w,
		ds_descricao_compl_w,
		ds_estrutura_w;
	EXIT WHEN NOT FOUND; /* apply on C09 */
		begin
		ds_item_ww				:= substr(ds_item_ww 		|| ds_item_w || chr(13),1,2000);
		ds_descricao_compl_ww	:= substr(ds_descricao_compl_ww	|| ds_descricao_compl_w || chr(13),1,2000);
		ds_estrutura_ww			:= substr(ds_estrutura_ww 	|| ds_estrutura_w || chr(13),1,2000);
		end;
	end loop;
	close C09;
	
	select	substr(replace_macro(ds_assunto,'@nr_ordem_compra',nr_ordem_compra_w),1,255),
		substr(ds_mensagem_padrao,1,4000)			
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nr_ordem_compra',nr_ordem_compra_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@materiais',ds_item_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_complementar',ds_descricao_compl_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_estrutura',ds_estrutura_ww),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);

elsif (ie_tipo_mensagem_p = 82)and (nr_sequencia_w > 0) then
	
	if (coalesce(cd_cgc_p,'X') <> 'X') then
		select	obter_cgc_cpf_editado(cd_cgc) cd_cnpj_editado,
			substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,100),
			nm_fantasia,
			ds_razao_social
		into STRICT	cd_cnpj_editado_w,
			ds_estabelecimento_w,
			nm_fantasia_w,
			nm_razao_social_w
		from	pessoa_juridica
		where	cd_cgc = cd_cgc_p;
	end if;
	
	select	max(nr_solic_compra)
	into STRICT	nr_solic_compra_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_documento_p;

	select	coalesce(dt_liberacao,clock_timestamp()),
		ds_observacao,
		cd_comprador_resp
	into STRICT	dt_liberacao_w,
		ds_observacao_ww,
		cd_comprador_w
	from	solic_compra
	where	nr_solic_compra = nr_solic_compra_w;

	if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') or (cd_comprador_padrao_w IS NOT NULL AND cd_comprador_padrao_w::text <> '') then
		select	max(ds_email),
			max(nm_guerra)
		into STRICT	ds_email_comprador_w,
			ds_usuario_comprador_w
		from	comprador
		where	cd_pessoa_fisica = coalesce(cd_comprador_w,cd_comprador_padrao_w)
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;

	open c09;
	loop
	fetch c09 into	
		ds_item_w,
		ds_descricao_compl_w,
		ds_estrutura_w;
	EXIT WHEN NOT FOUND; /* apply on c09 */
		begin
		ds_item_ww	:= substr(ds_item_ww 		|| ds_item_w || chr(13),1,2000);
		end;
	end loop;
	close c09;

	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@ordem',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@solicitacao',nr_solic_compra_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@materiais',ds_item_ww);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj_editado',cd_cnpj_editado_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fantasia_pj',nm_fantasia_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@razao_pj',nm_razao_social_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@estabelecimento',ds_estabelecimento_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fone',nr_telefone_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@dt_liberacao',dt_liberacao_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@obs_solic',ds_observacao_ww);
	ds_assunto_w := substr(ds_assunto_w,1,255);
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ordem',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@solicitacao',nr_solic_compra_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@materiais',ds_item_ww),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@cnpj_editado',cd_cnpj_editado_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fantasia_pj',nm_fantasia_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@razao_pj',nm_razao_social_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@estabelecimento',ds_estabelecimento_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fone',nr_telefone_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@dt_liberacao',dt_liberacao_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@obs_solic',ds_observacao_ww),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);	
	
elsif (ie_tipo_mensagem_p = 85)and (nr_sequencia_w > 0) then

	select	nr_nota_fiscal,
		dt_emissao,
		substr(obter_nome_pf_pj(null,cd_cgc_emitente),1,80),
		obter_dados_ordem_compra(nr_ordem_compra,'C')
	into STRICT	nr_nota_fiscal_w,
		dt_emissao_w,
		ds_fornecedor_w,
		cd_comprador_w
	from	nota_fiscal
	where	nr_sequencia = nr_documento_p;

	if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') or (cd_comprador_padrao_w IS NOT NULL AND cd_comprador_padrao_w::text <> '') then
		select	max(ds_email),
			max(nm_guerra)
		into STRICT	ds_email_comprador_w,
			ds_usuario_comprador_w
		from	comprador
		where	cd_pessoa_fisica = coalesce(cd_comprador_w,cd_comprador_padrao_w)
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;

	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@nota_fiscal',nr_nota_fiscal_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@dt_nota',dt_emissao_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fornecedor',ds_fornecedor_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nota_fiscal',nr_nota_fiscal_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@dt_nota',dt_emissao_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@fornecedor',ds_fornecedor_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);

elsif (ie_tipo_mensagem_p = 86)and (nr_sequencia_w > 0) then

	open c10;
	loop
	fetch c10 into	
		ds_motivo_devolucao_w,
		ds_item_w;
	EXIT WHEN NOT FOUND; /* apply on c10 */
		begin
		if (ds_motivo_devolucao_w IS NOT NULL AND ds_motivo_devolucao_w::text <> '') then
			ds_item_ww := substr(ds_item_ww || ds_item_w || ' - ' || wheb_mensagem_pck.get_texto(280436) || ds_motivo_devolucao_w || chr(10) || chr(13),1,2000);
		else
			ds_item_ww := substr(ds_item_ww || ds_item_w || chr(10) || chr(13),1,2000);
		end if;
		end;
	end loop;
	close c10;

	open C11;
	loop
	fetch C11 into	
		nr_ordem_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C11 */
		begin
		ds_lista_ordem_w := substr(ds_lista_ordem_w || nr_ordem_compra_w || ', ',1,255);	
		end;
	end loop;
	close C11;
	
	ds_lista_ordem_w := substr(ds_lista_ordem_w, 1, length(ds_lista_ordem_w) -2);

	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@nr_ordem_compra',ds_lista_ordem_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nr_inspecao',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@mat_mtvo_dev',ds_item_ww);
	ds_assunto_w := substr(ds_assunto_w,1,255);
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nr_ordem_compra',ds_lista_ordem_w),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nr_inspecao',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@mat_mtvo_dev',ds_item_ww),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);
	
elsif (ie_tipo_mensagem_p = 105)and (nr_sequencia_w > 0) then

	if (ie_tipo_registro_p = 'S') then	
		open C13;
		loop
		fetch C13 into	
			ds_itens_w;
		EXIT WHEN NOT FOUND; /* apply on C13 */
			begin
			ds_lista_materiais_w := substr(ds_lista_materiais_w || ds_itens_w || chr(13) || chr(10),1,4000);
			end;
		end loop;
		close C13;
	elsif (ie_tipo_registro_p = 'T') then		
		open C14;
		loop
		fetch C14 into	
			ds_itens_w;
		EXIT WHEN NOT FOUND; /* apply on C14 */
			begin
			ds_lista_materiais_w := substr(ds_lista_materiais_w || ds_itens_w || chr(13) || chr(10),1,4000);
			end;
		end loop;
		close C14;			
	elsif (ie_tipo_registro_p = 'E') then		
	
		open C15;
		loop
		fetch C15 into	
			ds_itens_w;
		EXIT WHEN NOT FOUND; /* apply on C15 */
			begin
			ds_lista_materiais_w := substr(ds_lista_materiais_w || ds_itens_w || chr(13) || chr(10),1,4000);
			end;
		end loop;
		close C15;			
	end if;
	
	select	ds_assunto,
		substr(ds_mensagem_padrao,1,4000)
	into STRICT	ds_assunto_w,
		ds_mensagem_padrao_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@nr_sequencia',nr_documento_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nr_registro',nr_seq_registro_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ie_tipo_registro',ie_tipo_registro_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ds_lista_itens',ds_lista_materiais_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);
	
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nr_sequencia',nr_documento_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@nr_registro',nr_seq_registro_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ie_tipo_registro', ie_tipo_registro_p),1,4000);
	ds_mensagem_padrao_w := substr(replace_macro(ds_mensagem_padrao_w,'@ds_lista_itens',ds_lista_materiais_w),1,4000);
	ds_mensagem_padrao_w := substr(ds_mensagem_padrao_w,1,4000);	

end if;

if (ie_usuario_w = 'U') then --Usuario
	select	ds_email,
		nm_usuario
	into STRICT	ds_email_origem_w,
		ds_usuario_origem_w
	from	usuario
	where	nm_usuario = nm_usuario_p;
elsif (ie_usuario_w = 'C') then --Setor compras
	select	ds_email
	into STRICT	ds_email_origem_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_p;
	
	select	coalesce(ds_fantasia,ds_razao_social)
	into STRICT	ds_usuario_origem_w
	from	estabelecimento_v
	where	cd_estabelecimento = cd_estabelecimento_p;	
elsif (ie_usuario_w = 'O') then --Comprador
	ds_email_origem_w	:= ds_email_comprador_w;
	ds_usuario_origem_w	:= ds_usuario_comprador_w;
end if;

if (ds_email_remetente_w <> 'X') then
	ds_email_origem_w	:= ds_email_remetente_w;
end if;

if (ie_consignado_w in ('S')) and (qt_consignado_w = 0) then
	nr_sequencia_w	:= 0;
elsif (ie_consignado_w in ('N')) and (qt_consignado_w > 0) then
	nr_sequencia_w	:= 0;
end if;


if (ie_retorno_p = 'S') then
	return	nr_sequencia_w;
elsif (ie_retorno_p = 'M') then
	return	ds_mensagem_padrao_w;
elsif (ie_retorno_p = 'A') then
	return ds_assunto_w;
elsif (ie_retorno_p = 'E') then
	return ie_usuario_w;
elsif (ie_retorno_p = 'O') then
	return ds_email_origem_w;
elsif (ie_retorno_p = 'U') then
	return ds_usuario_origem_w;
elsif (ie_retorno_p = 'D') then
	return ds_email_adicional_w;
elsif (ie_retorno_p = 'P') then
	return 	cd_perfil_disparar_w;
elsif (ie_retorno_p = 'G') then
	return	ie_momento_envio_w;
elsif (ie_retorno_p = 'ED') then
	return	ie_envia_pessoa_deleg_w;
elsif (ie_retorno_p = 'SH') then
	return ds_senha_remetente_w;
elsif (ie_retorno_p = 'RF') then
	return 	ds_remetente_fixo_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_regra_email_compra (ie_tipo_mensagem_p bigint, cd_estabelecimento_p bigint, nr_documento_p bigint, ie_retorno_p text, dt_retorno_prev_p timestamp, nm_usuario_p text, cd_cgc_p text, ie_tipo_registro_p text default 'S', nr_seq_registro_p bigint default 0, nr_seq_regra_p bigint default 0) FROM PUBLIC;

