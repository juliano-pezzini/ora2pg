-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_permite_adm_item ( ie_tipo_item_p text, cd_perfil_p bigint, cd_setor_p bigint, nm_usuario_p text, ie_palm_p text, nr_seq_proc_interno_p bigint, cd_item_p bigint, ie_origem_proced_p bigint) RETURNS varchar AS $body$
DECLARE


ie_administrar_w		varchar(10):= 'S';
cd_pessoa_fisica_w		varchar(50);
cd_area_procedimento_w	bigint;
cd_especialidade_w		bigint;
cd_grupo_proc_w			bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
cd_material_w			integer;

c01 CURSOR FOR
SELECT	coalesce(ie_permite_adm,'S')
from	adep_regra_administracao a
where	ie_tipo_item = ie_tipo_item_p
and	coalesce(ie_palm,'N') = ie_palm_p
and	coalesce(nr_seq_proc_interno,coalesce(nr_seq_proc_interno_p,0)) = coalesce(nr_seq_proc_interno_p,0)
and	((not exists (	select	1
			from	adep_regra_adm_perfil b
			where	a.nr_sequencia	= b.nr_seq_regra)) or (exists (	select	1
			from	adep_regra_adm_perfil b
			where	a.nr_sequencia	= b.nr_seq_regra
			and	b.cd_perfil	= cd_perfil_p)))
and	((coalesce(cd_setor_atendimento::text, '') = '') or (cd_setor_atendimento = cd_setor_p))
and	coalesce(cd_procedimento,coalesce(cd_procedimento_w,0)) = coalesce(cd_procedimento_w,0)
and	((coalesce(cd_perfil::text, '') = '') or (cd_perfil	= cd_perfil_p))
and	((coalesce(cd_pessoa_fisica::text, '') = '') or (cd_pessoa_fisica	= cd_pessoa_fisica_w))
and	coalesce(cd_grupo_proc, coalesce(cd_grupo_proc_w,0))					= coalesce(cd_grupo_proc_w,0)
and	coalesce(cd_especialidade, coalesce(cd_especialidade_w,0))			= coalesce(cd_especialidade_w,0)
and	coalesce(cd_area_procedimento, coalesce(cd_area_procedimento_w,0))	= coalesce(cd_area_procedimento_w,0)
and	((coalesce(cd_material,coalesce(cd_material_w,0))						= coalesce(cd_material_w,0)) or (ie_tipo_item_p not in ('M', 'IAH')))
order by coalesce(nr_seq_proc_interno,0),
	coalesce(cd_material,0),
	coalesce(cd_setor_atendimento,0),
	coalesce(cd_perfil,0),
	coalesce(cd_pessoa_fisica,0),
	coalesce(ie_permite_adm,'S') desc;

BEGIN

cd_pessoa_fisica_w	:= obter_pessoa_fisica_usuario(nm_usuario_p,'C');

if (ie_tipo_item_p	in ('G','C','P','L','SADT')) then

	if (coalesce(nr_seq_proc_interno_p,0) <> 0) then
		SELECT * FROM obter_proc_tab_interno(nr_seq_proc_interno_p, null, null, null, cd_procedimento_w, ie_origem_proced_w, cd_setor_p, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
	else
		cd_procedimento_w	:= cd_item_p;
		ie_origem_proced_w	:= ie_origem_proced_p;
	end if;

	select	max(cd_area_procedimento),
			max(cd_especialidade),
			max(cd_grupo_proc)
	into STRICT	cd_area_procedimento_w,
			cd_especialidade_w,
			cd_grupo_proc_w
	from	estrutura_procedimento_v
	where	cd_procedimento 	= cd_procedimento_w
	and		ie_origem_proced 	= ie_origem_proced_w;

elsif (ie_tipo_item_p	in ('M', 'IAH')) then
	cd_material_w	:= cd_item_p;
end if;

open C01;
loop
fetch C01 into
	ie_administrar_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	ie_administrar_w	:= ie_administrar_w;
end loop;
close C01;

return	ie_administrar_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_permite_adm_item ( ie_tipo_item_p text, cd_perfil_p bigint, cd_setor_p bigint, nm_usuario_p text, ie_palm_p text, nr_seq_proc_interno_p bigint, cd_item_p bigint, ie_origem_proced_p bigint) FROM PUBLIC;

