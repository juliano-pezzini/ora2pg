-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_se_centro_usuario ( cd_centro_custo_p bigint, cd_empresa_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


cd_estabelecimento_w			estabelecimento.cd_estabelecimento%type;
ie_atualizacao_w			varchar(01);
cd_perfil_w				perfil.cd_perfil%type;


BEGIN

cd_perfil_w := wheb_usuario_pck.get_cd_perfil;

begin
		select	max(cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	centro_custo
		where	cd_centro_custo	= cd_centro_custo_p;
	
exception when others then
	cd_estabelecimento_w := 0;
	/* Erro ao obter o estabelecimento */

	CALL wheb_mensagem_pck.exibir_mensagem_abort(242213);
end;

select	x.ie_atualizacao
into STRICT	ie_atualizacao_w
from	(
	SELECT	a.ie_atualizacao,
		CASE WHEN ie_atualizacao='N' THEN 1 WHEN ie_atualizacao='V' THEN 2  ELSE 3 END  ie_ordem_permissao,
		a.cd_classif_centro,
		a.nm_usuario_lib,
		a.cd_perfil,
		a.cd_estabelecimento,
		1 ie_ordem
	from	centro_custo b,
		ctb_lib_orcamento a
	where	a.cd_empresa		= cd_empresa_p
	and	b.cd_centro_custo	= cd_centro_custo_p
	and	((a.nm_usuario_lib	= nm_usuario_p) or (coalesce(a.nm_usuario_lib::text, '') = ''))
	and	((a.cd_perfil 		= cd_perfil_w) or (coalesce(a.cd_perfil::text, '') = ''))
	and	coalesce(a.cd_estabelecimento,coalesce(cd_estabelecimento_w,b.cd_estabelecimento)) = coalesce(cd_estabelecimento_w,b.cd_estabelecimento)
	and	b.cd_classificacao like a.cd_classif_centro||'%'
	
union all

	SELECT	'N' ie_atualizacao,
		1 ie_ordem_permissao,
		null cd_classif_centro,
		null nm_usuario_lib,
		null cd_perfil,
		null cd_estabelecimento,
		2 ie_ordem
	
	order by
		ie_ordem,
		cd_classif_centro desc,
		nm_usuario_lib,
		cd_perfil,
		cd_estabelecimento,
		ie_ordem_permissao
	) x LIMIT 1;

return ie_atualizacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_se_centro_usuario ( cd_centro_custo_p bigint, cd_empresa_p bigint, nm_usuario_p text) FROM PUBLIC;

