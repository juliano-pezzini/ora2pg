-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tipo_nota_fiscal_card ( nr_sequencia_p nota_fiscal.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


  ds_retorno_w          varchar(100);
  nr_interno_conta_w    nota_fiscal.nr_interno_conta%type;
  nr_seq_adiantamento_w nota_fiscal.nr_seq_adiantamento%type;
  nr_seq_nf_gerada_w    nf_credito.nr_seq_nf_gerada%type;
  nr_seq_far_venda_w    nota_fiscal.nr_seq_far_venda%type;
  nf_complemento_pag_w  nota_fiscal.nr_sequencia%type;

BEGIN

    select
        max(nf.nr_interno_conta),
        max(nf.nr_seq_adiantamento),
        max(nf.nr_seq_far_venda)
    into STRICT 
        nr_interno_conta_w,
        nr_seq_adiantamento_w,
        nr_seq_far_venda_w
    from nota_fiscal nf
    where nf.nr_sequencia = nr_sequencia_p;


    select    max(nfcr.nr_seq_nf_gerada)
    into STRICT      nr_seq_nf_gerada_w
    from      nf_credito nfcr
    where       nfcr.nr_seq_nf_gerada = nr_sequencia_p;


    select max(nr_sequencia)
    into STRICT nf_complemento_pag_w
    from (
        SELECT a.nr_sequencia
        from nota_fiscal a
        where (a.nr_seq_baixa_tit IS NOT NULL AND a.nr_seq_baixa_tit::text <> '')
        and (a.NR_SEQUENCIA_REF IS NOT NULL AND a.NR_SEQUENCIA_REF::text <> '')
        and a.nr_sequencia = nr_sequencia_p
        
union
 
        SELECT b.nr_sequencia
        from nota_fiscal_item b
        where (b.NR_SEQ_TIT_REC IS NOT NULL AND b.NR_SEQ_TIT_REC::text <> '')
        and (b.NR_TITULO IS NOT NULL AND b.NR_TITULO::text <> '')
        and b.nr_sequencia = nr_sequencia_p
    ) alias5 LIMIT 1;

    if (nr_interno_conta_w > 0) then
        ds_retorno_w := 'CP';

    elsif (nr_seq_nf_gerada_w > 0) then
        ds_retorno_w := 'NC';

    elsif (nr_seq_adiantamento_w > 0) then
        ds_retorno_w := 'AD';

    elsif (nf_complemento_pag_w > 0) then
        ds_retorno_w := 'COP';

    elsif (nr_seq_far_venda_w > 0) then
        ds_retorno_w := 'VP';

    else
        ds_retorno_w := 'MI';
    end if;
return dominio_pck.Obter_Valor_Dominio(10718, ds_retorno_w);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tipo_nota_fiscal_card ( nr_sequencia_p nota_fiscal.nr_sequencia%type) FROM PUBLIC;

