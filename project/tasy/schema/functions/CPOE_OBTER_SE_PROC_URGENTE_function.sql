-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_se_proc_urgente (nr_seq_proc_interno_p integer, nr_atendimento_p integer, nr_seq_rotina_p integer default null) RETURNS varchar AS $body$
DECLARE


ie_urgente_w				varchar(10);
ie_urgente_ww				varchar(10);
cd_grupo_proc_w				integer;
cd_especialidade_w			integer;
cd_area_procedimento_w		integer;
qt_regra_w					integer;
cd_procedimento_w			Proc_interno.Cd_Procedimento%type;
Ie_Origem_Proced_w			Proc_interno.Ie_Origem_Proced%type;
cd_setor_atendimento_w		setor_atendimento.cd_setor_atendimento%type;
cd_setor_entrega_w			setor_atendimento.cd_setor_atendimento%type;
cd_estabelecimento_w		integer;
nr_seq_exame_w				prescr_procedimento.nr_seq_exame%type;
ie_tipo_atendimento_w		atendimento_Paciente.ie_tipo_atendimento%type;
nr_seq_grupo_exame_lab_w	integer;

c01 CURSOR FOR
SELECT	'S' ie_urgente,
	nr_sequencia nr_sequencia_regra
from	proc_urgente_prescr a
where	ie_situacao	= 'A'
and	coalesce(a.cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0)) 	= coalesce(cd_setor_atendimento_w,0)
and	coalesce(a.cd_setor_entrega,coalesce(cd_setor_entrega_w,0)) 			= coalesce(cd_setor_entrega_w,0)
and	coalesce(cd_procedimento, coalesce(cd_procedimento_w,0))				= coalesce(cd_procedimento_w,0)
and	((coalesce(ie_origem_proced::text, '') = '') or (ie_origem_proced = Ie_Origem_Proced_w))
and	coalesce(cd_area_procedimento, coalesce(cd_area_procedimento_w,0))	= coalesce(cd_area_procedimento_w,0)
and	coalesce(cd_especialidade, coalesce(cd_especialidade_w,0))			= coalesce(cd_especialidade_w,0)
and	coalesce(cd_grupo_proc, coalesce(cd_grupo_proc_w,0))					= coalesce(cd_grupo_proc_w,0)
and	coalesce(nr_seq_proc_interno, coalesce(nr_seq_proc_interno_p,0))		= coalesce(nr_seq_proc_interno_p,0)
and coalesce(nr_seq_exame, coalesce(nr_seq_exame_w,0)) 					= coalesce(nr_seq_exame_w,0)
and	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_w)				= ie_tipo_atendimento_w
and	coalesce(nr_seq_grupo_exame, coalesce(nr_seq_grupo_exame_lab_w,0))	= coalesce(nr_seq_grupo_exame_lab_w,0)
and (coalesce(a.ie_rotina,'N')	= CASE WHEN coalesce(nr_seq_rotina_p::text, '') = '' THEN  'N'  ELSE 'S' END  or (CASE WHEN coalesce(nr_seq_rotina_p::text, '') = '' THEN  'N'  ELSE 'S' END  = 'S'))


order	by coalesce(cd_procedimento, 0),
	coalesce(cd_grupo_proc, 0),
	coalesce(cd_especialidade, 0),
	coalesce(cd_area_procedimento, 0),
	coalesce(nr_seq_proc_interno,0),
	coalesce(nr_seq_exame,0),
	coalesce(cd_setor_atendimento, 0);

BEGIN
begin
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
ie_tipo_atendimento_w := obter_tipo_atendimento(nr_atendimento_p);

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	Select 	Substr(Obter_Setor_Atendimento(nr_atendimento_p),1,20)
	into STRICT	cd_setor_atendimento_w
	;
end if;

Select 	Max(Cd_Procedimento),
		max(Ie_Origem_Proced),
		max(nr_seq_exame_lab)
into STRICT	cd_procedimento_w,
		Ie_Origem_Proced_w,
		nr_seq_exame_w
From	Proc_interno
where 	nr_sequencia = nr_seq_proc_interno_p;

select	max(cd_grupo_proc),
		max(cd_especialidade),
		max(cd_area_procedimento)
into STRICT	cd_grupo_proc_w,
		cd_especialidade_w,
		cd_area_procedimento_w
from	estrutura_procedimento_v
where	cd_procedimento		= cd_procedimento_w
and		ie_origem_proced	= Ie_Origem_Proced_w;

cd_setor_entrega_w := obter_setor_entrega_proc(cd_procedimento_w, nr_seq_proc_interno_p);

if (nr_seq_rotina_p IS NOT NULL AND nr_seq_rotina_p::text <> '') then
	select max(a.nr_seq_exame)
	into STRICT nr_seq_exame_w
	from exame_lab_rotina a
	where a.nr_sequencia =  nr_seq_rotina_p;
end if;	

if (coalesce(nr_seq_exame_w::text, '') = '') then
	select max(a.nr_seq_exame)
	into STRICT nr_seq_exame_w
	from exame_laboratorio a
	where coalesce(a.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
	and	a.nr_seq_proc_interno = nr_seq_proc_interno_p;	
end if;	

select	max(nr_seq_grupo)
into STRICT	nr_seq_grupo_exame_lab_w
from	exame_laboratorio
where	nr_seq_exame	= nr_seq_exame_w;

ie_urgente_w	:= 'N';

FOR c01_W IN c01
LOOP
	ie_urgente_w	:= c01_W.ie_urgente;
	
	if ((ie_urgente_w = 'S') and (coalesce(c01_W.nr_sequencia_regra,0) > 0)) then		
		select  count(*)
		into STRICT	qt_regra_w
		from 	proc_urgente_perfil
		where   nr_seq_proc_urg = c01_W.nr_sequencia_regra
		and     coalesce(cd_perfil, coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0);
		
		if (coalesce(qt_regra_w,0) > 0) then
			select  coalesce(max('S'),'N')
			into STRICT	ie_urgente_ww
			from    proc_urgente_perfil
			where   nr_seq_proc_urg 	= c01_W.nr_sequencia_regra
			and		coalesce(ie_urgente,'N') = 'S'
			and		coalesce(cd_perfil, coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0);
			ie_urgente_w	:= ie_urgente_ww;
		end if;
	end if;
END LOOP c01;

exception
when others then
	null;
end;

return ie_urgente_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_se_proc_urgente (nr_seq_proc_interno_p integer, nr_atendimento_p integer, nr_seq_rotina_p integer default null) FROM PUBLIC;

