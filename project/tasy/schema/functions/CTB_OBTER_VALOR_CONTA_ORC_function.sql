-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_valor_conta_orc ( nr_seq_mes_ref_p bigint, cd_conta_contabil_p text, cd_estabelecimento_p bigint, nr_seq_unid_neg_p bigint, ie_opcao_p text, nr_seq_demo_p bigint default null) RETURNS bigint AS $body$
DECLARE





ds_comando_w			varchar(4000);
ds_conta_w			varchar(4000);
vl_conta_w			double precision;
vl_orcado_w			double precision;
vl_result_w			double precision;
cd_conta_w			varchar(40);
cd_centro_w			varchar(40);
ie_pos_mais_w			integer;
ie_pos_menos_w			integer;
ie_pos_w			integer;
ie_pos_cc_w			integer;
ie_pos_tipo_cc_w		integer;
ie_sinal_w			varchar(01)	:= '+';
ie_opcao_w			varchar(8);
ie_tipo_custo_w			varchar(40);
cd_classif_w			varchar(40);
dt_referencia_w			timestamp;
ie_tipo_w			varchar(01);
cd_classificacao_w		varchar(40);
qt_tam_w			bigint;
cd_empresa_w			bigint;
cd_empresa_mes_w		bigint;
ie_pos_estab_w			integer;
cd_estab_w			integer;
nr_seq_grupo_emp_w		integer;
nr_seq_tipo_w			ctb_demonstrativo.nr_seq_tipo%type;
ds_oper_estab_w			ctb_modelo_relat.ds_oper_estab%type;
ds_oper_centro_custo_w		ctb_modelo_relat.ds_oper_centro_custo%type;
ds_oper_tipo_centro_w		ctb_modelo_relat.ds_oper_tipo_centro%type;

/* Opcoes
	'OM'	- Orcamento do mes
	'OA'	- Orcamento do anota no mes
*/
BEGIN

select	max(cd_empresa)
into STRICT	cd_empresa_w
from	estabelecimento
where	cd_estabelecimento	= cd_estabelecimento_p;

ds_conta_w			:= cd_conta_contabil_p;
ds_conta_w			:= replace(ds_conta_w,' ','');
vl_result_w			:= 0;
ie_opcao_w			:= coalesce(ie_opcao_p,'S');

select	max(dt_referencia),
	max(cd_empresa)
into STRICT	dt_referencia_w,
	cd_empresa_mes_w
from	ctb_mes_ref
where	nr_sequencia		= nr_seq_mes_ref_p;

cd_empresa_w	:= coalesce(cd_empresa_w,cd_empresa_mes_w);

begin
select	nr_seq_grupo_emp,
	nr_seq_tipo
into STRICT	nr_seq_grupo_emp_w,
	nr_seq_tipo_w
from	ctb_demonstrativo
where	nr_sequencia	= nr_seq_demo_p;
exception
when others then
        nr_seq_grupo_emp_w := null;
	nr_seq_tipo_w := null;
end;

begin
select 	ds_oper_estab,
	ds_oper_centro_custo,
	ds_oper_tipo_centro
into STRICT 	ds_oper_estab_w,
	ds_oper_centro_custo_w,
	ds_oper_tipo_centro_w
from	ctb_modelo_relat
where 	nr_sequencia = nr_seq_tipo_w;
exception
when others then
	ds_oper_estab_w := null;
	ds_oper_centro_custo_w := null;
	ds_oper_tipo_centro_w := null;
end;

while(length(ds_conta_w) > 0)  loop
	cd_conta_w		:= null;
	ie_pos_mais_w 	:= position('+' in ds_conta_w);
	ie_pos_menos_w 	:= position('-' in ds_conta_w);
	if (ie_pos_mais_w = 0) and (ie_pos_menos_w = 0) then
		ie_pos_w	:= 0;
	elsif (ie_pos_menos_w > 0) and
		((ie_pos_menos_w < ie_pos_mais_w) or (ie_pos_mais_w = 0)) then
		ie_Pos_w	:= ie_pos_menos_w;
	else
		ie_Pos_w	:= ie_pos_mais_w;
	end if;
	if (ie_pos_w > 0) then
		cd_conta_w	:= substr(ds_conta_w,1, ie_pos_w - 1);
		ds_conta_w	:= substr(ds_conta_w, ie_pos_w, 4000);
	else
		cd_conta_w	:= ds_conta_w;
		ds_conta_w	:= null;
	end if;
	
	ie_pos_estab_w 		:= position(coalesce(trim(both ds_oper_estab_w),'@') in cd_conta_w);
	if (ie_pos_estab_w > 0) then
		cd_estab_w	:= substr(cd_conta_w, 1, ie_pos_estab_w - 1);
		cd_conta_w	:= substr(cd_conta_w, ie_pos_estab_w + LENGTH(coalesce(trim(both ds_oper_estab_w),'@')), 20);
	end if;

	cd_centro_w		:= '';
	ie_pos_cc_w 	:= position(coalesce(trim(both ds_oper_centro_custo_w),'#') in cd_conta_w);
	if (ie_pos_cc_w > 0) then
		cd_centro_w	:= substr(cd_conta_w, ie_pos_cc_w + LENGTH(coalesce(trim(both ds_oper_centro_custo_w),'#')), 20);
		cd_conta_w	:= substr(cd_conta_w, 1, ie_pos_cc_w - 1);
	end if;

	ie_tipo_custo_w		:= '';
	ie_pos_tipo_cc_w	:= position(coalesce(trim(both ds_oper_tipo_centro_w), 'T') in cd_conta_w);
	if (ie_pos_tipo_cc_w > 0) then	
		ie_tipo_custo_w	:= substr(cd_conta_w, ie_pos_tipo_cc_w + LENGTH(coalesce(trim(both ds_oper_tipo_centro_w),'T')), 20);
		cd_conta_w	:= substr(cd_conta_w, 1, ie_pos_tipo_cc_w - 1);
	end if;
	
	vl_orcado_w		:= 0;
	if (cd_conta_w IS NOT NULL AND cd_conta_w::text <> '') then

		select	ie_tipo,
			substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_referencia_w),1,40)
		into STRICT	ie_tipo_w,
			cd_classificacao_w
		from	conta_contabil
		where	cd_conta_contabil	= cd_conta_w;
		qt_tam_w	:= length(cd_classificacao_w);

		if (nr_seq_grupo_emp_w is  null) then
			select sum(vl_orcado)
			into STRICT	vl_orcado_w
			from	centro_custo b,
				ctb_orcamento a
			where	nr_seq_mes_ref	in (
				SELECT nr_seq_mes_ref_p
				
				where ie_opcao_w = 'OM'
				
union

				SELECT	nr_sequencia
				from	ctb_mes_ref
				where	dt_referencia	between trunc(dt_referencia_w,'year') and dt_referencia_w
				and	cd_empresa	= cd_empresa_w
				and	ie_opcao_w = 'OA' )
			and	cd_conta_contabil	in ( 
				select cd_conta_w cd_conta_contabil
				
				where	ie_tipo_w	= 'A'
				
union all

				select	cd_conta_contabil
				from	conta_contabil
				where	ie_tipo_w	= 'T'
				and	ie_tipo	= 'A'
				and	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_referencia_w),1, qt_tam_w) = cd_classificacao_w
				and	cd_empresa	= cd_empresa_w)
	--		and	(nvl(cd_centro_w, a.cd_centro_custo)	= a.cd_centro_custo) --Anderson 30/03/2007 - OS 53321 (troquei pela linha abaixo)
			and	(((cd_centro_w IS NOT NULL AND cd_centro_w::text <> '') and (cd_centro_w = substr(b.cd_classificacao,1, length(cd_centro_w)))) or (coalesce(cd_centro_w::text, '') = ''))
			and	a.cd_centro_custo	= b.cd_centro_custo
			and	((coalesce(ie_tipo_custo_w::text, '') = '') or b.ie_tipo_custo = ie_tipo_custo_w)
			and	((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
                        and	((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (
                                select	cd_estabelecimento
                                from	estabelecimento
                                where	nr_seq_unid_neg = nr_seq_unid_neg_p)))
			and	coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;
		else
			select sum(vl_orcado)
			into STRICT	vl_orcado_w
			from	centro_custo b,
				ctb_orcamento a
			where	nr_seq_mes_ref	in (
                                        SELECT  a.nr_sequencia
                                        from    ctb_mes_ref a,
                                                grupo_empresa_v b
                                        where   a.dt_referencia = ctb_obter_mes_ref(nr_seq_mes_ref_p)
                                        and	a.cd_empresa	= b.cd_empresa
                                        and     b.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
                                        and     holding_pck.get_grupo_emp_estrut_vigente(a.cd_empresa) = nr_seq_grupo_emp_w
                                        and     ie_opcao_w = 'OM'

union

                                        SELECT	nr_sequencia
                                        from	ctb_mes_ref c,
                                                grupo_empresa_v d
                                        where	dt_referencia	between trunc(dt_referencia_w,'year') and dt_referencia_w
                                        and	c.cd_empresa	= d.cd_empresa
                                        and     d.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
                                        and     holding_pck.get_grupo_emp_estrut_vigente(c.cd_empresa) = nr_seq_grupo_emp_w
                                        and	ie_opcao_w = 'OA')
			and	cd_conta_contabil	in (
                                        select  a.cd_conta_contabil
                                        from    conta_contabil a,
                                                grupo_empresa_v b
                                        where   coalesce(a.CD_CONTA_REFERENCIA, a.cd_conta_contabil) = cd_conta_w
                                        and	a.cd_empresa	= b.cd_empresa
                                        and     b.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
                                        and	ie_tipo_w	= 'A'                            
                                        
union all

                                        select	cd_conta_contabil
                                        from	conta_contabil e,
                                                grupo_empresa_v f
                                        where	ie_tipo_w	= 'T'
                                        and	ie_tipo	= 'A'
                                        and	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_referencia_w),1, qt_tam_w) = cd_classificacao_w
                                        and 	f.nr_seq_grupo_empresa = nr_seq_grupo_emp_w
                                        and 	f.cd_empresa = e.cd_empresa)
	--		and	(nvl(cd_centro_w, a.cd_centro_custo)	= a.cd_centro_custo) --Anderson 30/03/2007 - OS 53321 (troquei pela linha abaixo)
			and	(((cd_centro_w IS NOT NULL AND cd_centro_w::text <> '') and (cd_centro_w = substr(b.cd_classificacao,1, length(cd_centro_w)))) or (coalesce(cd_centro_w::text, '') = ''))
			and	a.cd_centro_custo	= b.cd_centro_custo
			and	((coalesce(ie_tipo_custo_w::text, '') = '') or b.ie_tipo_custo = ie_tipo_custo_w)
			and	((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
                        and	((coalesce(nr_seq_unid_neg_p::text, '') = '') or (a.cd_estabelecimento in (
                                select	cd_estabelecimento
                                from	estabelecimento
                                where	nr_seq_unid_neg = nr_seq_unid_neg_p)))
			and	coalesce(cd_estab_w, a.cd_estabelecimento) = a.cd_estabelecimento;
		end if;
	end if;

	vl_conta_w				:= coalesce(vl_orcado_w,0);
	
	if (ie_sinal_w = '-') then
		vl_result_w			:= vl_result_w - vl_conta_w;
	else
		vl_result_w			:= vl_result_w + vl_conta_w;
	end if;
	if (ds_conta_w IS NOT NULL AND ds_conta_w::text <> '') and
		((substr(ds_conta_w,1,1) = '+') or (substr(ds_conta_w,1,1) = '-')) then
		ie_sinal_w			:= substr(ds_conta_w,1,1);
		ds_conta_w			:= substr(ds_conta_w,2,4000);
	end if;
end loop;
return	vl_result_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_valor_conta_orc ( nr_seq_mes_ref_p bigint, cd_conta_contabil_p text, cd_estabelecimento_p bigint, nr_seq_unid_neg_p bigint, ie_opcao_p text, nr_seq_demo_p bigint default null) FROM PUBLIC;

