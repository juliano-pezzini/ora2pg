-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_arquivo ( nr_sequencia_p bigint, ie_opcao_p text, ie_tipo_aplicacao_p text default 'D', nr_seq_imagem_laudo_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w				varchar(255);
qt_reg_w				varchar(255);

nr_sequencia_w				pep_pac_ci.nr_sequencia%type;	
nr_seq_imagem_w				pep_pac_ci_anexo.nr_sequencia%type;
ds_arquivo_w				pep_pac_ci_anexo.ds_arquivo%type;
ds_arquivo_alt_w			pep_pac_ci_anexo.ds_arquivo%type;

nr_sequencia_laudo_w		laudo_paciente.nr_sequencia%type;	
nr_seq_imagem_laudo_w		laudo_paciente_imagem.nr_sequencia%type;
ds_arquivo_laudo_w			laudo_paciente_imagem.ds_arquivo_imagem%type;
ds_arquivo_laudo_alt_w		laudo_paciente_imagem.ds_arquivo_imagem%type;

			

BEGIN

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	begin
	
	if ( ie_opcao_p	= 'LAUDO') then
	
		SELECT  max(a.nr_sequencia),
				max(b.nr_seq_imagem), 
				max(b.ds_arquivo_imagem) 
		into STRICT	nr_sequencia_laudo_w,
				nr_seq_imagem_laudo_w,
				ds_arquivo_laudo_w
        FROM	laudo_paciente a,
                laudo_paciente_imagem  b
		WHERE	a.nr_sequencia = b.nr_sequencia
		and		b.nr_sequencia = nr_sequencia_p
        and nr_seq_imagem = nr_seq_imagem_laudo_p;
		
		Select  regexp_substr(ds_arquivo_imagem,'[?]+.+[a-z]')		
		into STRICT	qt_reg_w
		from 	laudo_paciente_imagem
		where	nr_sequencia =  nr_sequencia_p
        and nr_seq_imagem = nr_seq_imagem_laudo_p;
		
		
		if (qt_reg_w IS NOT NULL AND qt_reg_w::text <> '') then
			
				Select substr(substr(ds_arquivo_laudo_w,(position('?' in ds_arquivo_laudo_w)+1),length(ds_arquivo_laudo_w)),1,instr(substr(ds_arquivo_laudo_w,(position('?' in ds_arquivo_laudo_w)+1),length(ds_arquivo_laudo_w)),'.')-1)
				into STRICT   ds_arquivo_laudo_alt_w
				;
				
				ds_retorno_w := nr_sequencia_laudo_w||'_'||nr_seq_imagem_laudo_w||'_'||ds_arquivo_laudo_alt_w;
			
			
		else
		
			ds_retorno_w := nr_sequencia_laudo_w||'_'||nr_seq_imagem_laudo_w||'_'||ds_arquivo_laudo_w;
		
		end if;
			
	
	elsif ( ie_opcao_p	= 'CONSENTIMENTO') then
	
	
		SELECT  max(a.nr_sequencia),
				max(b.nr_sequencia), 
				max(b.ds_arquivo) 
		into STRICT	nr_sequencia_w,
				nr_seq_imagem_w,
				ds_arquivo_w
        FROM	pep_pac_ci a,
                pep_pac_ci_anexo b 
		WHERE	b.nr_seq_pac_ci = a.nr_sequencia
		and		b.nr_sequencia = nr_sequencia_p;
		
		
		Select  regexp_substr(ds_arquivo,'[?]+.+[a-z]')		
		into STRICT	qt_reg_w
		from 	pep_pac_ci_anexo
		where	nr_sequencia =  nr_sequencia_p;
		
		
		if (qt_reg_w IS NOT NULL AND qt_reg_w::text <> '') then
			
				Select substr(substr(ds_arquivo_w,(position('?' in ds_arquivo_w)+1),length(ds_arquivo_w)),1,instr(substr(ds_arquivo_w,(position('?' in ds_arquivo_w)+1),length(ds_arquivo_w)),'.')-1)
				into STRICT   ds_arquivo_alt_w
				;
				
				ds_retorno_w := nr_sequencia_w||'_'||nr_seq_imagem_w||'_'||ds_arquivo_alt_w;
			
			
		else
		
			ds_retorno_w := nr_sequencia_w||'_'||nr_seq_imagem_w||'_'||ds_arquivo_w;
		end if;
		
	elsif ( ie_opcao_p	= 'GED') then
	
	
		SELECT  max(a.nr_sequencia),
				max(a.ds_arquivo)
		into STRICT	nr_sequencia_w,
				ds_arquivo_w
        FROM	ged_atendimento a
		WHERE	a.nr_sequencia = nr_sequencia_p;
		
		
		Select  regexp_substr(ds_arquivo,'[?]+.+[a-z]')		
		into STRICT	qt_reg_w
		from 	ged_atendimento
		where	nr_sequencia =  nr_sequencia_p;
		
		
		if (qt_reg_w IS NOT NULL AND qt_reg_w::text <> '') then
			
				Select substr(substr(ds_arquivo_w,(position('?' in ds_arquivo_w)+1),length(ds_arquivo_w)),1,instr(substr(ds_arquivo_w,(position('?' in ds_arquivo_w)+1),length(ds_arquivo_w)),'.')-1)
				into STRICT   ds_arquivo_alt_w
				;
				
				ds_retorno_w := nr_sequencia_w||'_'||ds_arquivo_alt_w;
			
			
		else
		
			ds_retorno_w := nr_sequencia_w||'_'||ds_arquivo_w;
		end if;
	
	
	
	end if;
	
	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_arquivo ( nr_sequencia_p bigint, ie_opcao_p text, ie_tipo_aplicacao_p text default 'D', nr_seq_imagem_laudo_p bigint default null) FROM PUBLIC;

