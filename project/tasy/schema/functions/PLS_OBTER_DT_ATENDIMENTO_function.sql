-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dt_atendimento ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_tipo_guia_p pls_conta.ie_tipo_guia%type, dt_alta_p pls_conta.dt_alta%type, dt_emissao_p pls_conta.dt_emissao%type, ie_desc_item_glosa_atend_p pls_parametros.ie_desc_item_glosa_atend%type default null) RETURNS timestamp AS $body$
DECLARE


dt_item_w	timestamp := null;
dt_item_mat_w	timestamp := null;
--Retorna a data do ultimo procedimento da conta(Rotina chamada quando o tipo de guia for 4 ou 6, pois nesse caso, a data
--do ultimo procedimento que é considerada a data de atendimento da conta)
C01 CURSOR(	nr_seq_conta_pc pls_conta.nr_sequencia%type)is
	with query_tmp as(
			select	coalesce(a.dt_procedimento,a.dt_procedimento_imp) dt_procedimento
	 		from	pls_conta_proc a
			where	a.nr_seq_conta = nr_seq_conta_p
			and		((a.dt_procedimento IS NOT NULL AND a.dt_procedimento::text <> '') or (a.dt_procedimento_imp IS NOT NULL AND a.dt_procedimento_imp::text <> ''))
			and		a.ie_status	not in ('D', 'M')
			and	(((ie_desc_item_glosa_atend_p = 'S') and (coalesce(ie_glosa,'N') = 'N')) or (coalesce(ie_desc_item_glosa_atend_p,'N') = 'N'))
			order by dt_procedimento desc
	)
	select	dt_procedimento
	into STRICT	dt_item_w
	from	query_tmp LIMIT 1;

--Retorna a data do ultimo material da conta (Rotina chamada quando o tipo de guia for 4 ou 6 e não ter encontrado procedimento algum, pois nesse caso, a data
--do ultimo material que é considerada a data de atendimento da conta)
C02 CURSOR(	nr_seq_conta_pc pls_conta.nr_sequencia%type)is
	with query_tmp as(
			select	coalesce(a.dt_atendimento, a.dt_atendimento_imp) dt_atendimento
	 		from	pls_conta_mat a
			where	a.nr_seq_conta = nr_seq_conta_p
			and	((a.dt_atendimento IS NOT NULL AND a.dt_atendimento::text <> '') or (a.dt_atendimento_imp IS NOT NULL AND a.dt_atendimento_imp::text <> ''))
			and	a.ie_status	not in ('D', 'M')
			and	(((ie_desc_item_glosa_atend_p = 'S') and (coalesce(ie_glosa,'N') = 'N')) or (coalesce(ie_desc_item_glosa_atend_p,'N') = 'N'))
			order by dt_atendimento desc
	)
	select	dt_atendimento
	into STRICT	dt_item_w
	from	query_tmp LIMIT 1;
BEGIN

--Guia de resumo de internação
if (ie_tipo_guia_p = '5') then
	dt_item_w := dt_alta_p;
elsif ( ie_tipo_guia_p in ('3', '4', '6', '11')) then
	--Guia de SADT e guia de honorario individual
	for	r_C01_w in C01(nr_seq_conta_p) loop

		dt_item_w := r_C01_w.dt_procedimento;
	end loop;

end if;

--Guias de SP/SADT podem ter apenas mat/med, apesar de não ser algo comum. Nesses casos, busca por
--data no materiais.
if ( ie_tipo_guia_p in ('3', '4', '6', '11')) then

	--Guia de SADT e guia de honorario individual
	for	r_C02_w in C02(nr_seq_conta_p) loop
		dt_item_mat_w := r_C02_w.dt_atendimento;
	end loop;

	if (dt_item_w	< dt_item_mat_w) or (coalesce(dt_item_w::text, '') = '') then
		dt_item_w := dt_item_mat_w;
	end if;
end if;


if (coalesce(dt_item_w::text, '') = '') then
	dt_item_w := dt_emissao_p;
end if;

return	dt_item_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dt_atendimento ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_tipo_guia_p pls_conta.ie_tipo_guia%type, dt_alta_p pls_conta.dt_alta%type, dt_emissao_p pls_conta.dt_emissao%type, ie_desc_item_glosa_atend_p pls_parametros.ie_desc_item_glosa_atend%type default null) FROM PUBLIC;

