-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_aniversario_paciente (cd_pessoa_fisica_p text) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w	varchar(255);
ie_sexo_w	varchar(1);
ds_paciente_w	varchar(255);
dt_atual_w	timestamp;
ds_ano_w	varchar(255);
dt_nascimento_w	varchar(5);
dt_aniversario_w	varchar(255);


BEGIN 
 
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then 
	begin 
	 
	ie_sexo_w	:= Obter_Sexo_PF(cd_pessoa_fisica_p, 'C');
	 
	if (ie_sexo_w = 'M') then 
		ds_paciente_w	:= Wheb_mensagem_pck.get_texto(309780); --'O paciente'; 
	elsif (ie_sexo_w = 'F') then
		ds_paciente_w	:= Wheb_mensagem_pck.get_texto(309781); --'A paciente'; 
	else
		ds_paciente_w	:= Wheb_mensagem_pck.get_texto(309782); --'Paciente'; 
	end if;
	 
	select	clock_timestamp(), 
		to_char(clock_timestamp(),'yyyy'), 
		substr(obter_dados_pf(cd_pessoa_fisica_p, 'DN'),1,5) 
	into STRICT	dt_atual_w, 
		ds_ano_w, 
		dt_nascimento_w 
	;
	 
	if (dt_nascimento_w IS NOT NULL AND dt_nascimento_w::text <> '') then 
		if (dt_nascimento_w = '29/02') and (substr(obter_se_ano_bisexto(clock_timestamp()),1,1) = 'N') then 
			dt_nascimento_w := '01/03';
		end if;	
		 
		dt_aniversario_w	:= dt_nascimento_w || '/' || ds_ano_w;
 
		if (to_date(dt_aniversario_w, 'dd/mm/yyyy') > dt_atual_w) then 
			ds_retorno_w		:= ds_paciente_w || ' ' || Wheb_mensagem_pck.get_texto(309783) || ' ' /*' fará aniversário no dia '*/ || dt_aniversario_w;
		elsif (to_date(dt_aniversario_w, 'dd/mm/yyyy') < dt_atual_w) then 
			ds_retorno_w		:= ds_paciente_w || ' ' || Wheb_mensagem_pck.get_texto(309784) || ' ' /*' fez aniversário no dia '*/ || dt_aniversario_w;
		else 
			ds_retorno_w		:= ds_paciente_w || ' ' || Wheb_mensagem_pck.get_texto(309786); --' está de aniversário hoje'; 
		end if;
	else 
		ds_retorno_w			:= ds_paciente_w || ' ' || Wheb_mensagem_pck.get_texto(309787); --' sem data de nascimento'; 
	end if;
	 
	end;
end if;
 
RETURN ds_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_aniversario_paciente (cd_pessoa_fisica_p text) FROM PUBLIC;

