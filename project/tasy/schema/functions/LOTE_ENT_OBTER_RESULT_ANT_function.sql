-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lote_ent_obter_result_ant ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_resultado_p bigint, nr_seq_exame_p bigint, ie_opcao_p bigint, ie_trigger_p text default null, qt_resultado_p bigint default null, pr_resultado_p bigint default null) RETURNS varchar AS $body$
DECLARE


resultado_w				varchar(255);
qt_repeticoes_w			bigint;
ds_resultado_p_w		varchar(255);
ds_resultado_s_w		varchar(255);
ds_resultado_t_w		varchar(255);
ds_resultado_q_w		varchar(255);
ds_resultado_qq_w		varchar(255);
ds_resultado_se_w		varchar(255);
qt_resultado_media_w	double precision;
qt_result_item_w		double precision;

rep_resultado_1_w		varchar(255);
rep_resultado_2_w		varchar(255);
rep_resultado_3_w		varchar(255);

resultado_result1_w		varchar(255);
resultado_result2_w		varchar(255);
resultado_result3_w		varchar(255);

qt_rep_1_w				bigint;
qt_rep_2_w				bigint;
qt_rep_3_w				bigint;


ds_repeticao_1_w		varchar(255);
ds_repeticao_2_w 		varchar(255);
ds_repeticao_3_w		varchar(255);
ds_repeticao_4_w		varchar(255);
ds_repeticao_5_w		varchar(255);
ds_repeticao_6_w		varchar(255);

ds_repeticao_aux_w		varchar(255);
vl_media_calc_w			lote_ent_res_ant_repet.vl_media_calc%type;

/*ie_opcao_p é utilizado para definir o resultado de qual repetição que deverá retornar
Primeiro resultado = 1
Segundo resultado = 2
Terceiro resultado = 3
Quarto resultado = 4
Quinto resultado = 5
Sexto resultado = 6

Método do primeiro resultado = 11
Método do segundo resultado = 12
Método do terceiro resultado = 13
Método do quarto resultado = 14
Método do quinto resultado = 15
Método do sexto resultado = 16

Média calc = 98
Média = 99
*/
BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_prescr_p IS NOT NULL AND nr_seq_prescr_p::text <> '') and (nr_seq_resultado_p IS NOT NULL AND nr_seq_resultado_p::text <> '') and (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') then

	select 	coalesce(max(nr_repeticao),0),
			max(vl_media_calc)
	into STRICT	qt_repeticoes_w,
			vl_media_calc_w
	from	lote_ent_res_ant_repet
	where	nr_prescricao = nr_prescricao_p
	and		nr_seq_prescr = nr_seq_prescr_p
	and		nr_seq_resultado = nr_seq_resultado_p
	and		nr_seq_exame = nr_seq_exame_p;

	ds_repeticao_aux_w := '';

	if (ie_opcao_p = 1) then

		select	CASE WHEN SUBSTR(CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ,1,1)=',' THEN ('0'||CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END )  ELSE (CASE WHEN coalesce(coalesce(qt_result_ant,pr_result_ant),0)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ) END
		into STRICT	ds_repeticao_1_w
		from	lote_ent_res_ant_repet
		where	nr_prescricao = nr_prescricao_p
		and		nr_seq_prescr = nr_seq_prescr_p
		and		nr_seq_resultado = nr_seq_resultado_p
		and		nr_seq_exame = nr_seq_exame_p
		and		nr_repeticao = 1;

		if (SUBSTR(ds_repeticao_1_w,1,1) = '.') then
			select ('0'||ds_repeticao_1_w)
			into STRICT	ds_repeticao_aux_w
			;

			ds_repeticao_1_w	:= ds_repeticao_aux_w;

		end if;

		resultado_w := ds_repeticao_1_w;

	elsif (ie_opcao_p = 2) then


		select	CASE WHEN SUBSTR(CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ,1,1)=',' THEN ('0'||CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END )  ELSE (CASE WHEN coalesce(coalesce(qt_result_ant,pr_result_ant),0)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ) END
		into STRICT	ds_repeticao_2_w
		from	lote_ent_res_ant_repet
		where	nr_prescricao = nr_prescricao_p
		and		nr_seq_prescr = nr_seq_prescr_p
		and		nr_seq_resultado = nr_seq_resultado_p
		and		nr_seq_exame = nr_seq_exame_p
		and		nr_repeticao = 2;

		if (SUBSTR(ds_repeticao_2_w,1,1) = '.') then
			select ('0'||ds_repeticao_2_w)
			into STRICT	ds_repeticao_aux_w
			;

			ds_repeticao_2_w	:= ds_repeticao_aux_w;

		end if;


		resultado_w := ds_repeticao_2_w;

	elsif (ie_opcao_p = 3) then

		select	CASE WHEN SUBSTR(CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ,1,1)=',' THEN ('0'||CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END )  ELSE (CASE WHEN coalesce(coalesce(qt_result_ant,pr_result_ant),0)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ) END
		into STRICT	ds_repeticao_3_w
		from	lote_ent_res_ant_repet
		where	nr_prescricao = nr_prescricao_p
		and		nr_seq_prescr = nr_seq_prescr_p
		and		nr_seq_resultado = nr_seq_resultado_p
		and		nr_seq_exame = nr_seq_exame_p
		and		nr_repeticao = 3;


		if (SUBSTR(ds_repeticao_3_w,1,1) = '.') then
			select ('0'||ds_repeticao_3_w)
			into STRICT	ds_repeticao_aux_w
			;

			ds_repeticao_3_w	:= ds_repeticao_aux_w;

		end if;


		resultado_w := ds_repeticao_3_w;

	elsif (ie_opcao_p = 4) then

		select	CASE WHEN SUBSTR(CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ,1,1)=',' THEN ('0'||CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END )  ELSE (CASE WHEN coalesce(coalesce(qt_result_ant,pr_result_ant),0)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ) END
		into STRICT	ds_repeticao_4_w
		from	lote_ent_res_ant_repet
		where	nr_prescricao = nr_prescricao_p
		and		nr_seq_prescr = nr_seq_prescr_p
		and		nr_seq_resultado = nr_seq_resultado_p
		and		nr_seq_exame = nr_seq_exame_p
		and		nr_repeticao = 4;

		if (SUBSTR(ds_repeticao_4_w,1,1) = '.') then
			select ('0'||ds_repeticao_4_w)
			into STRICT	ds_repeticao_aux_w
			;

			ds_repeticao_4_w	:= ds_repeticao_aux_w;

		end if;


		resultado_w := ds_repeticao_4_w;

	elsif (ie_opcao_p = 5) then

		select	CASE WHEN SUBSTR(CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ,1,1)=',' THEN ('0'||CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END )  ELSE (CASE WHEN coalesce(coalesce(qt_result_ant,pr_result_ant),0)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ) END
		into STRICT	ds_repeticao_5_w
		from	lote_ent_res_ant_repet
		where	nr_prescricao = nr_prescricao_p
		and		nr_seq_prescr = nr_seq_prescr_p
		and		nr_seq_resultado = nr_seq_resultado_p
		and		nr_seq_exame = nr_seq_exame_p
		and		nr_repeticao = 5;

		if (SUBSTR(ds_repeticao_5_w,1,1) = '.') then
			select ('0'||ds_repeticao_5_w)
			into STRICT	ds_repeticao_aux_w
			;

			ds_repeticao_5_w	:= ds_repeticao_aux_w;

		end if;


		resultado_w := ds_repeticao_5_w;

	elsif (ie_opcao_p = 6) then

		select	CASE WHEN SUBSTR(CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ,1,1)=',' THEN ('0'||CASE WHEN coalesce(qt_result_ant,pr_result_ant)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END )  ELSE (CASE WHEN coalesce(coalesce(qt_result_ant,pr_result_ant),0)=0 THEN coalesce(ds_result_ant,'0')  ELSE coalesce(qt_result_ant,pr_result_ant) END ) END
		into STRICT	ds_repeticao_6_w
		from	lote_ent_res_ant_repet
		where	nr_prescricao = nr_prescricao_p
		and		nr_seq_prescr = nr_seq_prescr_p
		and		nr_seq_resultado = nr_seq_resultado_p
		and		nr_seq_exame = nr_seq_exame_p
		and		nr_repeticao = 6;

		if (SUBSTR(ds_repeticao_6_w,1,1) = '.') then
			select ('0'||ds_repeticao_6_w)
			into STRICT	ds_repeticao_aux_w
			;

			ds_repeticao_6_w	:= ds_repeticao_aux_w;

		end if;


		resultado_w := ds_repeticao_6_w;

	--VERIFICAR OS METODOS ANTERIORES
	elsif (ie_opcao_p = 11) then

			/*select	SUBSTR(obter_descricao_padrao('METODO_EXAME_LAB','DS_METODO', NR_SEQ_METODO),1,200) ds_metodo
			into	resultado_w
			from	exame_lab_result_item
			where	nr_seq_resultado = nr_seq_resultado_p
			and		nr_seq_prescr = nr_seq_prescr_p
			and		nr_seq_exame = nr_seq_exame_p
			AND 	nr_seq_material IS NOT NULL;*/
			SELECT 	SUBSTR(obter_descricao_padrao('METODO_EXAME_LAB','DS_METODO', NR_SEQ_METODO),1,200) ds_metodo
			INTO STRICT   	resultado_w
			FROM   	lote_ent_res_ant_repet
			WHERE  	nr_prescricao = nr_prescricao_p
			AND	   	nr_seq_prescr = nr_seq_prescr_p
			AND	   	nr_seq_resultado = nr_seq_resultado_p
			and		nr_seq_exame = nr_seq_exame_p
			AND	   	nr_repeticao = 1;

	elsif (ie_opcao_p = 12) then

			SELECT 	SUBSTR(obter_descricao_padrao('METODO_EXAME_LAB','DS_METODO', NR_SEQ_METODO),1,200) ds_metodo
			INTO STRICT   	resultado_w
			FROM   	lote_ent_res_ant_repet
			WHERE  	nr_prescricao = nr_prescricao_p
			AND	   	nr_seq_prescr = nr_seq_prescr_p
			AND	   	nr_seq_resultado = nr_seq_resultado_p
			and		nr_seq_exame = nr_seq_exame_p
			AND	   	nr_repeticao = 2;

	elsif (ie_opcao_p = 13) then

			SELECT 	SUBSTR(obter_descricao_padrao('METODO_EXAME_LAB','DS_METODO', NR_SEQ_METODO),1,200) ds_metodo
			INTO STRICT   	resultado_w
			FROM   	lote_ent_res_ant_repet
			WHERE  	nr_prescricao = nr_prescricao_p
			AND	   	nr_seq_prescr = nr_seq_prescr_p
			AND	   	nr_seq_resultado = nr_seq_resultado_p
			and		nr_seq_exame = nr_seq_exame_p
			AND	   	nr_repeticao = 3;

	elsif (ie_opcao_p = 14) then

			SELECT 	SUBSTR(obter_descricao_padrao('METODO_EXAME_LAB','DS_METODO', NR_SEQ_METODO),1,200) ds_metodo
			INTO STRICT   	resultado_w
			FROM   	lote_ent_res_ant_repet
			WHERE  	nr_prescricao = nr_prescricao_p
			AND	   	nr_seq_prescr = nr_seq_prescr_p
			AND	   	nr_seq_resultado = nr_seq_resultado_p
			and		nr_seq_exame = nr_seq_exame_p
			AND	   	nr_repeticao = 4;

	elsif (ie_opcao_p = 15) then

			SELECT 	SUBSTR(obter_descricao_padrao('METODO_EXAME_LAB','DS_METODO', NR_SEQ_METODO),1,200) ds_metodo
			INTO STRICT   	resultado_w
			FROM   	lote_ent_res_ant_repet
			WHERE  	nr_prescricao = nr_prescricao_p
			AND	   	nr_seq_prescr = nr_seq_prescr_p
			AND	   	nr_seq_resultado = nr_seq_resultado_p
			and		nr_seq_exame = nr_seq_exame_p
			AND	   	nr_repeticao = 5;

	elsif (ie_opcao_p = 16) then

			SELECT 	SUBSTR(obter_descricao_padrao('METODO_EXAME_LAB','DS_METODO', NR_SEQ_METODO),1,200) ds_metodo
			INTO STRICT   	resultado_w
			FROM   	lote_ent_res_ant_repet
			WHERE  	nr_prescricao = nr_prescricao_p
			AND	   	nr_seq_prescr = nr_seq_prescr_p
			AND	   	nr_seq_resultado = nr_seq_resultado_p
			and		nr_seq_exame = nr_seq_exame_p
			AND	   	nr_repeticao = 6;

	end if;


	if (ie_opcao_p = 98) then
		resultado_w := replace(to_char( ''||vl_media_calc_w||'','fm9,990.00'),'.',',');
	end if;

	if (ie_opcao_p = 99) then

		if (ie_trigger_p = 'S') then

			select 	coalesce(qt_resultado_p, pr_resultado_p,0)
			into STRICT 	qt_result_item_w
			;

		else
			select 	coalesce(coalesce(qt_resultado,pr_resultado),0)
			into STRICT	qt_result_item_w
			from	exame_lab_result_item
			where	nr_seq_resultado = nr_seq_resultado_p
			and		nr_seq_prescr = nr_seq_prescr_p
			and		nr_seq_exame = nr_seq_exame_p
			and		(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');
		end if;

		if (qt_result_item_w > 0) then

			SELECT coalesce((SELECT coalesce(coalesce(qt_result_ant,pr_result_ant),0)
						FROM   lote_ent_res_ant_repet
						WHERE  nr_prescricao = nr_prescricao_p
						AND	   nr_seq_prescr = nr_seq_prescr_p
						AND	   nr_seq_resultado = nr_seq_resultado_p
						and		nr_seq_exame = nr_seq_exame_p
						AND	   nr_repeticao = qt_repeticoes_w),0)
			INTO STRICT   /*ds_resultado_s_w */
 ds_resultado_p_w
			;

			SELECT coalesce((SELECT coalesce(coalesce(qt_result_ant,pr_result_ant),0)
						FROM   lote_ent_res_ant_repet
						WHERE  nr_prescricao = nr_prescricao_p
						AND	   nr_seq_prescr = nr_seq_prescr_p
						AND	   nr_seq_resultado = nr_seq_resultado_p
						and		nr_seq_exame = nr_seq_exame_p
						AND	   nr_repeticao = (qt_repeticoes_w - 1)),0)
			INTO STRICT   /*ds_resultado_t_w*/
 ds_resultado_s_w
			;

			SELECT coalesce((SELECT coalesce(coalesce(qt_result_ant,pr_result_ant),0)
						FROM   lote_ent_res_ant_repet
						WHERE  nr_prescricao = nr_prescricao_p
						AND	   nr_seq_prescr = nr_seq_prescr_p
						AND	   nr_seq_resultado = nr_seq_resultado_p
						and		nr_seq_exame = nr_seq_exame_p
						AND	   nr_repeticao = (qt_repeticoes_w - 2)),0)
			INTO STRICT   /*ds_resultado_q_w*/
 ds_resultado_t_w
			;

			SELECT coalesce((SELECT coalesce(coalesce(qt_result_ant,pr_result_ant),0)
						FROM   lote_ent_res_ant_repet
						WHERE  nr_prescricao = nr_prescricao_p
						AND	   nr_seq_prescr = nr_seq_prescr_p
						AND	   nr_seq_resultado = nr_seq_resultado_p
						and		nr_seq_exame = nr_seq_exame_p
						AND	   nr_repeticao = (qt_repeticoes_w - 3)),0)
			INTO STRICT   /*ds_resultado_qq_w*/
 ds_resultado_q_w
			;

			SELECT coalesce((SELECT coalesce(coalesce(qt_result_ant,pr_result_ant),0)
						FROM   lote_ent_res_ant_repet
						WHERE  nr_prescricao = nr_prescricao_p
						AND	   nr_seq_prescr = nr_seq_prescr_p
						AND	   nr_seq_resultado = nr_seq_resultado_p
						and		nr_seq_exame = nr_seq_exame_p
						AND	   nr_repeticao = (qt_repeticoes_w - 4)),0)
			INTO STRICT  /*ds_resultado_se_w*/
 ds_resultado_qq_w
			;

			SELECT coalesce((SELECT coalesce(coalesce(qt_result_ant,pr_result_ant),0)
						FROM   lote_ent_res_ant_repet
						WHERE  nr_prescricao = nr_prescricao_p
						AND	   nr_seq_prescr = nr_seq_prescr_p
						AND	   nr_seq_resultado = nr_seq_resultado_p
						and		nr_seq_exame = nr_seq_exame_p
						AND	   nr_repeticao = (qt_repeticoes_w - 5)),0)
			INTO STRICT  ds_resultado_se_w
			;


			if (qt_repeticoes_w = 1) then

				select	((coalesce((coalesce(ds_resultado_p_w,0))::numeric ,0) + coalesce((coalesce(ds_resultado_s_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_t_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_q_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_qq_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_se_w,'0'))::numeric ,0)) / 1)
				into STRICT	qt_resultado_media_w
				;

			elsif (qt_repeticoes_w = 2) then

				select	((coalesce((coalesce(ds_resultado_p_w,0))::numeric ,0) + coalesce((coalesce(ds_resultado_s_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_t_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_q_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_qq_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_se_w,'0'))::numeric ,0)) / 2)
				into STRICT	qt_resultado_media_w
				;

			elsif (qt_repeticoes_w = 3) then

				select	((coalesce((coalesce(ds_resultado_p_w,0))::numeric ,0) + coalesce((coalesce(ds_resultado_s_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_t_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_q_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_qq_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_se_w,'0'))::numeric ,0)) / 3)
				into STRICT	qt_resultado_media_w
				;

			elsif (qt_repeticoes_w = 4) then

				select	((coalesce((coalesce(ds_resultado_p_w,0))::numeric ,0) + coalesce((coalesce(ds_resultado_s_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_t_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_q_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_qq_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_se_w,'0'))::numeric ,0)) / 4)
				into STRICT	qt_resultado_media_w
				;

			elsif (qt_repeticoes_w = 5) then

				select	((coalesce((coalesce(ds_resultado_p_w,0))::numeric ,0) + coalesce((coalesce(ds_resultado_s_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_t_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_q_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_qq_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_se_w,'0'))::numeric ,0)) / 5)
				into STRICT	qt_resultado_media_w
				;

			elsif (qt_repeticoes_w >= 6) then

				select	((coalesce((coalesce(ds_resultado_p_w,0))::numeric ,0) + coalesce((coalesce(ds_resultado_s_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_t_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_q_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_qq_w,'0'))::numeric ,0) + coalesce((coalesce(ds_resultado_se_w,'0'))::numeric ,0)) / 6)
				into STRICT	qt_resultado_media_w
				;

			end if;

			if (qt_resultado_media_w > 0) then

				resultado_w := replace(to_char( ''||qt_resultado_media_w||'','fm9,990.00'),'.',',');

			end if;

		end if;

	end if;

end if;

return	resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lote_ent_obter_result_ant ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_resultado_p bigint, nr_seq_exame_p bigint, ie_opcao_p bigint, ie_trigger_p text default null, qt_resultado_p bigint default null, pr_resultado_p bigint default null) FROM PUBLIC;

