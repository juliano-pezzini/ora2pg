-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function mob_format_comunicado_html as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE FUNCTION mob_format_comunicado_html ( nr_seq_comunic_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

	v_ret	varchar;
BEGIN
	v_query := 'SELECT * FROM mob_format_comunicado_html_atx ( ' || quote_nullable(nr_seq_comunic_p) || ',' || quote_nullable(nm_usuario_p) || ' )';
	SELECT * INTO v_ret FROM dblink(v_conn_str, v_query) AS p (ret varchar);
	RETURN v_ret;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE FUNCTION mob_format_comunicado_html_atx ( nr_seq_comunic_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


nr_seq_tasy_conversao_rtf_w	tasy_conversao_rtf.nr_sequencia%type;
ds_retorno_w			varchar(2000);
ie_contem_rtf_w			varchar(1);
BEGIN


	select	OBTER_SE_LONG_CONTEM_TEXTO(	'COMUNIC_INTERNA',
										'DS_COMUNICADO',
										'WHERE NR_SEQUENCIA = :NR_SEQUENCIA',
										'NR_SEQUENCIA='||nr_seq_comunic_p,'{\rtf') ie_contem_texto
	into STRICT	ie_contem_rtf_w
	;

	if (ie_contem_rtf_w = 'S') then

		nr_seq_tasy_conversao_rtf_w := converte_rtf_html2('select ds_comunicado from COMUNIC_INTERNA where nr_sequencia = :nr_sequencia_p', to_char(nr_seq_comunic_p), nm_usuario_p, nr_seq_tasy_conversao_rtf_w);

		select	substr( ds_texto_clob, 2000, 1 )
		into STRICT	ds_retorno_w
		from	tasy_conversao_rtf
		where	nr_sequencia = nr_seq_tasy_conversao_rtf_w;

	else
		select	ds_comunicado
		into STRICT	ds_retorno_w
		from	comunic_interna
		where	nr_sequencia = nr_seq_comunic_p
		and	nm_usuario = nm_usuario_p;
	end if;



return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION mob_format_comunicado_html ( nr_seq_comunic_p bigint, nm_usuario_p text) FROM PUBLIC; -- REVOKE ALL ON FUNCTION mob_format_comunicado_html_atx ( nr_seq_comunic_p bigint, nm_usuario_p text) FROM PUBLIC;

