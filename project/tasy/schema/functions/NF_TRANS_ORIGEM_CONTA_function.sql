-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nf_trans_origem_conta (nr_sequencia_nf_p bigint) RETURNS varchar AS $body$
DECLARE

						
nr_sequencia_w			nota_fiscal.nr_sequencia%type;
nr_sequencia_origem_w  	 	nota_fiscal.nr_sequencia%type;
nr_conta_origem_w 	        conta_paciente.nr_interno_conta%type;
nr_interno_conta_w		conta_paciente.nr_interno_conta%type;	
nr_atendimento_w		conta_paciente.nr_atendimento%type;

c01 CURSOR FOR
SELECT 	nr_conta_origem
from 	matpaci_conta_log
where 	nr_atendimento = nr_atendimento_w
and 	nr_interno_conta = nr_interno_conta_w	

union

select 	nr_conta_origem
from 	propaci_conta_log
where 	nr_atendimento = nr_atendimento_w
and 	nr_interno_conta = nr_interno_conta_w;


BEGIN
	nr_sequencia_w := null;
	
	if (nr_sequencia_nf_p IS NOT NULL AND nr_sequencia_nf_p::text <> '') then
		
		select	b.nr_interno_conta,
			b.nr_atendimento
		into STRICT	nr_interno_conta_w,
			nr_atendimento_w
		from	nota_fiscal a,
			conta_paciente b
		where	a.nr_interno_conta = b.nr_interno_conta
		and	nr_sequencia = nr_sequencia_nf_p
		and	(a.nr_interno_conta IS NOT NULL AND a.nr_interno_conta::text <> '')
		and 	(b.nr_atendimento IS NOT NULL AND b.nr_atendimento::text <> '');
		
		if (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '' AND nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		
			open c01;
			loop
			fetch c01
			into nr_conta_origem_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				begin
				   if (nr_conta_origem_w IS NOT NULL AND nr_conta_origem_w::text <> '') then
					nr_sequencia_origem_w := obter_nf_conta(nr_conta_origem_w,1);
					
					if (nr_sequencia_origem_w IS NOT NULL AND nr_sequencia_origem_w::text <> '') then
						nr_sequencia_w := nf_canc_origem_conta(nr_sequencia_origem_w);
					end if;
				   end if;
				end;
			end loop;
			close c01;
			
		end if;

	end if;
	  
return nr_sequencia_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nf_trans_origem_conta (nr_sequencia_nf_p bigint) FROM PUBLIC;

