-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_regra_estagio_autor (nr_seq_agenda_p bigint, cd_agenda_p bigint default null) RETURNS varchar AS $body$
DECLARE

			
ds_retorno_w		varchar(1);
qt_regra_w		bigint;
nr_atendimento_w	bigint;
ie_interno_agenda_w	varchar(5);
cd_tipo_agenda_w	bigint;
ie_agenda_serv_w	varchar(1);
ie_agenda_cons_w	varchar(1);
ie_agenda_exame_w	agenda_regra_estagio_autor.ie_agenda_exame%type;


BEGIN

if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then

	select obter_tipo_agenda(cd_agenda_p)
	into STRICT  cd_tipo_agenda_w
	;
	
	if (cd_tipo_agenda_w in (3,4,5)) then
	        select 	max(nr_atendimento)
		into STRICT	nr_atendimento_w
		from	agenda_consulta
		where	nr_sequencia = nr_seq_agenda_p;

		select	max(b.ie_interno)
  		into STRICT	ie_interno_agenda_w
  		from	estagio_autorizacao b,
			autorizacao_convenio a
  		where	a.nr_seq_estagio = b.nr_sequencia
  		and 	a.nr_seq_agenda_consulta = nr_seq_agenda_p;
  	else
  		select 	max(nr_atendimento)
	  	into STRICT	nr_atendimento_w
	  	from	agenda_paciente
	  	where	nr_sequencia = nr_seq_agenda_p;

		select	max(b.ie_interno)
  		into STRICT	ie_interno_agenda_w
	  	from	estagio_autorizacao b,
			autorizacao_convenio a
	  	where	a.nr_seq_estagio = b.nr_sequencia
	  	and 	a.nr_seq_agenda = nr_seq_agenda_p;
	end if;
	
	select	coalesce(max(ie_agenda_servico), 'S'),
			coalesce(max(ie_agenda_consulta), 'N'),
			coalesce(max(ie_agenda_exame), 'N')
	into STRICT	ie_agenda_serv_w,
			ie_agenda_cons_w,
			ie_agenda_exame_w
	from	agenda_regra_estagio_autor
	where	ie_interno = ie_interno_agenda_w
	and		ie_situacao = 'A';
	
	select	count(*)
	into STRICT	qt_regra_w
	from	agenda_regra_estagio_autor
	where	ie_interno = ie_interno_agenda_w
	and		ie_situacao = 'A';

end if;

if (qt_regra_w > 0) and (coalesce(nr_atendimento_w::text, '') = '') then
	if((cd_tipo_agenda_w = 3) or (cd_tipo_agenda_w = 4)) and (coalesce(ie_agenda_cons_w, 'N') = 'S') then
		ds_retorno_w := 'S';
	elsif (cd_tipo_agenda_w = 5) and (coalesce(ie_agenda_serv_w, 'S') = 'S') then
		ds_retorno_w := 'S';
	elsif (cd_tipo_agenda_w = 2) and (coalesce(ie_agenda_exame_w, 'N') = 'S') then
		ds_retorno_w := 'S';
	else
		ds_retorno_w := 'N';
	end if;
else
	ds_retorno_w := 'N';
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_regra_estagio_autor (nr_seq_agenda_p bigint, cd_agenda_p bigint default null) FROM PUBLIC;

