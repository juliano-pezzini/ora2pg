-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_indice_constraint ( ds_dono_p text, nm_tabela_p text, nm_integridade_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(254);
ds_virgula_w		varchar(01);
nr_posicao_w		bigint;
nm_atributo_w		varchar(50);
nm_indice_w		varchar(50);
qt_coluna_w		bigint;

C01 CURSOR FOR
	SELECT	nm_indice
	from	Indice a
	where	upper(ie_opcao_p)	= 'D'
	and	nm_tabela		= nm_tabela_p
	and	exists (
		SELECT	1
		from	indice_atributo b,
			integridade_atributo c
		where	a.nm_tabela	= b.nm_tabela
		and	a.nm_tabela	= c.nm_tabela
		and	c.nm_integridade_referencial	= nm_integridade_p
		and	b.nm_indice	= a.nm_indice
		and	b.nm_atributo	= c.nm_atributo
		and	b.nr_sequencia= c.ie_sequencia_criacao)
	and	obter_se_col_igual(upper(ds_dono_p), nm_tabela_p, nm_integridade_p,
		a.nm_indice, ie_opcao_p) = 'S'
	
union all

	select	index_name
	from	user_indexes a
	where	ie_opcao_p		= 'B'
	and	table_owner		= upper(ds_dono_p)
	and	table_name		= nm_tabela_p
	and	exists (
		select	1
		from	user_ind_columns b,
			user_cons_columns c
		where	a.table_name		= b.table_name
		and	a.table_name		= c.table_name
		and	c.constraint_name	= nm_integridade_p
		and	a.index_name		= b.index_name
		and	b.column_name		= c.column_name
		and	b.column_position	= c.position)
	and	obter_se_col_igual(upper(ds_dono_p), nm_tabela_p, nm_integridade_p,
		a.index_name, ie_opcao_p) = 'S'
		order by 1;


BEGIN

ds_retorno_w		:= '';
ds_virgula_w		:= '';

OPEN C01;
LOOP
FETCH C01 into
	nm_indice_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ds_retorno_w	:= ds_retorno_w || ds_virgula_w || nm_indice_w;
	ds_virgula_w	:= ',';
END LOOP;
CLOSE C01;

return	ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_indice_constraint ( ds_dono_p text, nm_tabela_p text, nm_integridade_p text, ie_opcao_p text) FROM PUBLIC;

