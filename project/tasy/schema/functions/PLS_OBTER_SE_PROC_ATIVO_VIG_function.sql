-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_proc_ativo_vig ( cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, dt_procedimento_p timestamp) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Essa function foi criada para atender a validão 68()validar vigência do item,
pois autilizar apenas a pls_obter_se_proc_ativo, não cinsidera váido os casos onde o
procedimento esta ativo, porém não tem registro de vigência e nesta validação, é desta a maneira
que se esperava funcionar.
*/
ds_retorno_w	varchar(1) := 'S';
qt_proc_w	integer;
qt_vigencias_w	integer;

C01 CURSOR(	cd_procedimento_w	procedimento.cd_procedimento%type,
		ie_origem_proced_w	procedimento.ie_origem_proced%type,
		dt_procedimento_w	timestamp) FOR
	SELECT	trunc(a.dt_inicio_vigencia) dt_inicio_vigencia,
		trunc(a.dt_fim_vigencia) dt_fim_vigencia
	from	pls_procedimento_vigencia a
	where	a.cd_procedimento = cd_procedimento_w
	and	a.ie_origem_proced = ie_origem_proced_w;

BEGIN

/*Se não encontrar nenhum registro de vigência para o procedimento, então o considera vigente.
Rotina que faz chamada a essa, já verifica se o procedimento esta ativo.
*/
for r_C01_w in C01(cd_procedimento_p, ie_origem_proced_p, dt_procedimento_p) loop

	--Se encontrar um registro de vigência para o procedimento(Vigência válida) já retorna como válido
	if	((dt_procedimento_p >= r_C01_w.dt_inicio_vigencia) and
		 ((coalesce(r_C01_w.dt_fim_vigencia::text, '') = '') or (dt_procedimento_p < r_C01_w.dt_fim_vigencia)))then
		ds_retorno_w	:= 'S';
		exit;
	else
		ds_retorno_w := 'N';
	end if;

end loop;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_proc_ativo_vig ( cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, dt_procedimento_p timestamp) FROM PUBLIC;

