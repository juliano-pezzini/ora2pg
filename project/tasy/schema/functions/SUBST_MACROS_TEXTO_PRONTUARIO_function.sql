-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION subst_macros_texto_prontuario ( nr_seq_agenda_p bigint, cd_pessoa_fisica_p text, nr_atendimento_p bigint, ds_texto_p text ) RETURNS text AS $body$
DECLARE


ds_texto_ret_w      pep_pac_ci.ds_texto%type;
nm_atributo_w       macro_prontuario.nm_atributo%type;
nm_macro_w          macro_prontuario.nm_macro%type;
vl_atributo_w       varchar(50);
vl_substituir_w     varchar(4000);

c01 CURSOR FOR
	SELECT nm_atributo,
		   nm_macro
	from   macro_prontuario
	order by
	       nm_macro;


BEGIN

ds_texto_ret_w := ds_texto_p;

open c01;
loop
fetch c01 into
	nm_atributo_w,
	nm_macro_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
		if (upper(nm_atributo_w) = 'CD_PESSOA_FISICA') then
			vl_atributo_w := cd_pessoa_fisica_p;
		elsif (upper(nm_atributo_w) = 'NR_ATENDIMENTO') then
			if (coalesce(nr_atendimento_p::text, '') = '') then
				vl_atributo_w := '0';
			else
				vl_atributo_w := nr_atendimento_p;
			end if;
		elsif (upper(nm_atributo_w) = 'CD_PESSOA_USUARIO') then
			vl_atributo_w := obter_pessoa_fisica_usuario(obter_usuario_ativo, 'C');		
		elsif (upper(nm_atributo_w) = 'NR_SEQ_AGENDA') then
			vl_atributo_w := nr_seq_agenda_p;		
		end if;
		
		vl_substituir_w := substituir_macro_texto_tasy(upper(nm_macro_w), nm_atributo_w, vl_atributo_w);
		nm_macro_w := replace(nm_macro_w,'[','\[');
		nm_macro_w := replace(nm_macro_w,']','\]');
		ds_texto_ret_w := replace_macro_long(ds_texto_ret_w, nm_macro_w, vl_substituir_w);
	end;
end loop;
close c01;

return ds_texto_ret_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION subst_macros_texto_prontuario ( nr_seq_agenda_p bigint, cd_pessoa_fisica_p text, nr_atendimento_p bigint, ds_texto_p text ) FROM PUBLIC;

