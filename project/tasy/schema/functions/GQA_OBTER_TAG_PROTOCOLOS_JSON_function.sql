-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gqa_obter_tag_protocolos_json (cd_pessoa_fisica_p text, nr_atendimento_p bigint, ie_tag_tipo_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w          varchar(4000);
qtd bigint        := 0;

c01 CURSOR FOR
  SELECT
          a.nr_sequencia nr_seq_protocolo,
          (gqa_obter_protocolo_tag_atual(a.nr_sequencia, 'SEQUENCIA'))::numeric  nr_seq_etapa,
          gqa_obter_protocolo_tag_atual(a.nr_sequencia, 'TAG') ds_tag,
          gqa_obter_protocolo_tag_atual(a.nr_sequencia, 'COR') ds_cor,
          gqa_obter_protocolo_tag_atual(a.nr_sequencia, 'NOME') ds_etapa,
          gqa_obter_protocolo_tag_atual(a.nr_sequencia, 'ICONE') ds_icon,
          gqa_obter_protocolo_tag_atual(a.nr_sequencia, 'PATH') ds_icon_path,
          coalesce(gqa_obter_se_etapa_tag_lib(ie_tag_tipo_p, a.nr_sequencia), 'S') ie_mostrar_tag
  from gqa_protocolo_pac a
  where (a.nr_atendimento = nr_atendimento_p 
          or (coalesce(nr_atendimento_p::text, '') = '' and a.cd_pessoa_fisica = cd_pessoa_fisica_p))
  and a.ie_situacao = 'A'
  and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
  and coalesce(a.dt_termino::text, '') = ''
  and coalesce(a.dt_inativacao::text, '') = ''
  and (gqa_obter_protocolo_tag_atual(a.nr_sequencia, 'TAG') IS NOT NULL AND (gqa_obter_protocolo_tag_atual(a.nr_sequencia, 'TAG'))::text <> '');

BEGIN

  ds_retorno_w := '[';
  for item in c01 loop
    ds_retorno_w := ds_retorno_w || '{';
    ds_retorno_w := ds_retorno_w || '"NR_SEQ_PROTOCOLO":"' || item.nr_seq_protocolo || '"';
    ds_retorno_w := ds_retorno_w || ',"NR_SEQ_ETAPA":"' || item.nr_seq_etapa || '"';
    ds_retorno_w := ds_retorno_w || ',"DS_TAG":"' || item.ds_tag || '"';
    ds_retorno_w := ds_retorno_w || ',"DS_COR":"' || item.ds_cor || '"';
    ds_retorno_w := ds_retorno_w || ',"DS_ETAPA":"' || item.ds_etapa || '"';
    ds_retorno_w := ds_retorno_w || ',"DS_ICON":"' || item.ds_icon || '"';
    ds_retorno_w := ds_retorno_w || ',"DS_ICON_PATH":"' || item.ds_icon_path || '"';
    ds_retorno_w := ds_retorno_w || ',"IE_MOSTRAR_TAG":"' || item.ie_mostrar_tag || '"';
    ds_retorno_w := ds_retorno_w || '},';

    qtd := qtd + 1;
  end loop;

  if (qtd > 0) then --remover ultima virgula
    ds_retorno_w := SUBSTR(ds_retorno_w, 0, LENGTH(ds_retorno_w) - 1);
  end if;

  ds_retorno_w := ds_retorno_w || ']';

  return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gqa_obter_tag_protocolos_json (cd_pessoa_fisica_p text, nr_atendimento_p bigint, ie_tag_tipo_p text) FROM PUBLIC;

