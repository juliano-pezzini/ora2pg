-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION qt_consistir_bloq_medic_sim ( dt_agenda_p timestamp, nr_seq_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ie_dia_semana_w		integer;
qt_bloqueio_w		integer;
ds_Retorno_w		varchar(1)	:= 'N';
cd_material_w		bigint;
ie_Feriado_w		varchar(1);
cd_classe_material_w	integer;
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
ie_bloquear_w		varchar(1);

C01 CURSOR FOR
	SELECT	cd_material,
		Obter_estrutura_material(cd_material,'C'),
		Obter_estrutura_material(cd_material,'G'),
		Obter_estrutura_material(cd_material,'S')
	from	paciente_atend_medic_sim
	where	nr_seq_atendimento	= nr_seq_atendimento_p
	--and	ds_Retorno_w		= 'N'
	order by 1;


C02 CURSOR FOR
	SELECT	coalesce(ie_bloquear,'S')
	from	qt_bloqueio_medic
	where	coalesce(cd_material,cd_material_w)				= cd_material_w
	and	coalesce(cd_classe_material,cd_classe_material_w)		= cd_classe_material_w
	and	coalesce(cd_grupo_material,cd_grupo_material_w)		= cd_grupo_material_w
	and	coalesce(cd_subgrupo_material,cd_subgrupo_material_w)	= cd_subgrupo_material_w
	and (dt_agenda_p 	>= coalesce(dt_inicial, dt_agenda_p))
	and (dt_agenda_p	<= coalesce(dt_final, dt_agenda_p))
	and	((dt_agenda_p between to_date(to_char(dt_agenda_p,'dd/mm/yyyy') ||' '|| to_char(hr_inicial_bloqueio,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
			and (to_date(to_char(dt_agenda_p,'dd/mm/yyyy') ||' '|| to_char(hr_final_bloqueio,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') - 1/1440))
	or (coalesce(hr_inicial_bloqueio::text, '') = ''	and	coalesce(hr_final_bloqueio::text, '') = ''))
	and	((coalesce(ie_dia_semana, ie_dia_semana_w)	= ie_dia_semana_w) or (ie_dia_Semana = 9))
	and	((ie_feriado_w	<> 'S' and coalesce(ie_feriado,'N') = 'N') or (coalesce(ie_feriado, 'N') = 'S' and ie_feriado_w = 'S'))
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p)	= cd_estabelecimento_p
	order by coalesce(cd_material,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_subgrupo_material,0);


BEGIN

ie_dia_semana_w	:= obter_cod_dia_semana(dt_agenda_p);

select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_feriado_w
from 	feriado a
where 	a.cd_estabelecimento = cd_estabelecimento_p
and	a.dt_feriado = trunc(dt_agenda_p);

open C01;
loop
fetch C01 into
	cd_material_w,
	cd_classe_material_w,
	cd_grupo_material_w,
	cd_subgrupo_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	open C02;
	loop
	fetch C02 into
		ie_bloquear_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		ds_Retorno_w	:= ie_bloquear_w;
		end;
	end loop;
	close C02;

	end;
end loop;
close C01;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION qt_consistir_bloq_medic_sim ( dt_agenda_p timestamp, nr_seq_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

