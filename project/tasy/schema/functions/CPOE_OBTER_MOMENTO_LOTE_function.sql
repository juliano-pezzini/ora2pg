-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_momento_lote (ie_motivo_prescricao_p text, cd_setor_prescr_p bigint, cd_estabelecimento_p bigint, ie_quimio_p text default 'N', nm_tabela_p text default null, nr_sequencia_p bigint default null, ie_tipo_dieta_p text default null, ie_controle_tempo_p cpoe_material.ie_controle_tempo%type default null, ie_material_p cpoe_material.ie_material%type default null, ie_urgencia_p text default null, nr_ocorrencia_p bigint default null, ie_dose_ataque_p text default null) RETURNS varchar AS $body$
DECLARE


ie_momento_lote_w		regra_disp_lote_farm.ie_momento_lote%type;
ie_proced_agora_w		regra_disp_lote_farm.ie_proced_agora%type;
ie_regra_agora_w		regra_disp_lote_farm.ie_regra_agora%type;
ie_rec_agora_w          regra_disp_lote_farm.ie_rec_agora%type;
ie_regra_dose_esp_w     regra_disp_lote_farm.ie_regra_dose_esp%type;
ie_tipo_item_w			varchar(4);
ie_tipo_dieta_w			cpoe_dieta.ie_tipo_dieta%type;
ie_controle_tempo_w		cpoe_material.ie_controle_tempo%type;
ie_material_w			cpoe_material.ie_material%type;
nr_seq_procedimento_w	cpoe_material.nr_seq_procedimento%type;
nr_seq_prot_glic_w		cpoe_procedimento.nr_seq_prot_glic%type;
nr_seq_proc_interno_w	cpoe_procedimento.nr_seq_proc_interno%type;
nr_seq_exame_lab_w		proc_interno.nr_seq_exame_lab%type;
ie_lib_farm_w			prescr_medica.ie_lib_farm%type;
ie_existe_prescr_w		varchar(1);
dt_liberacao_w          cpoe_procedimento.dt_liberacao%type;
dt_liberacao_enf_w      cpoe_procedimento.dt_liberacao_enf%type;
dt_liberacao_farm_w     cpoe_procedimento.dt_liberacao_farm%type;
ie_possui_medic_assoc_w bigint;
ie_possui_mat_assoc_w   bigint;
ie_param_127_w          varchar(1);
nm_ususario_presc_w     cpoe_material.nm_usuario_nrec%type;
cd_perfil_prescr_w      cpoe_material.cd_perfil_ativo%type;
cd_setor_atend_regra_w  cpoe_material.cd_setor_atendimento%type;
nr_seq_regra_w          regra_disp_lote_farm.nr_sequencia%type;
qt_registro_w           bigint;
ie_se_necessario_w      regra_momento_lib_item.ie_se_necessario%type;
ie_acm_w                regra_momento_lib_item.ie_acm%type;
ie_urgente_w            regra_momento_lib_item.ie_agora%type;
cd_material_w           cpoe_material.cd_material%type;
cd_intervalo_w          cpoe_material.cd_intervalo%type;
ie_tipo_interv_w        varchar(5);

/*
CCG 						= G 		X
Dieta oral 					= D 		X
Exames laboratoriais 		= E 		X
Gasoterapia 				= GAS 	X
Itens associados ao procedimento 	= IA 		X
Jejum 					= J 		X
Lactario 					= L 		X
Materiais 					= MAT 	X
Medicamentos 				= M		X
Procedimentos 				= P 		X
Recomendacoes				= R 		X
Solucoes					= S 		X
Suplementos				= SUP	X
Suporte nutricional Enteral		= SNE 	X
*/
C01 CURSOR FOR
	SELECT	ie_momento_lote ie_momento_lote_w,
			ie_rec_agora	ie_rec_agora_w,
			ie_regra_agora  ie_regra_agora_w,
			ie_proced_agora ie_proced_agora_w,
			ie_regra_dose_esp ie_regra_dose_esp_w,
            cd_setor_atendimento cd_setor_atend_regra_w,
            nr_sequencia    nr_seq_regra_w
	from	regra_disp_lote_farm
	where	((ie_motivo_prescricao = ie_motivo_prescricao_p) or (coalesce(ie_motivo_prescricao::text, '') = ''))
	and		((cd_setor_atendimento = cd_setor_prescr_p) or (coalesce(cd_setor_atendimento::text, '') = ''))
	and		((cd_estabelecimento = cd_estabelecimento_p) or (coalesce(cd_estabelecimento::text, '') = ''))
	and		((ie_tipo_item = ie_tipo_item_w) or (coalesce(ie_tipo_item::text, '') = ''))
	and		coalesce(ie_situacao,'A') = 'A'
	and		((clock_timestamp() between to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||to_char(coalesce(dt_hora_inicio,clock_timestamp()),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') and
							to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||to_char(coalesce(dt_hora_fim,clock_timestamp()),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')) or ((dt_hora_fim IS NOT NULL AND dt_hora_fim::text <> '') and
			  dt_hora_fim < coalesce(dt_hora_inicio,clock_timestamp())) and (clock_timestamp() between to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||to_char(coalesce(dt_hora_inicio,clock_timestamp()),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') and
							   to_date(to_char(clock_timestamp() + interval '1 days','dd/mm/yyyy')||' '||to_char(coalesce(dt_hora_fim,clock_timestamp()),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')))
	and		pkg_date_utils.start_of(clock_timestamp(),'DD',0) between pkg_date_utils.start_of(dt_inicio_vigencia,'DD',0) and pkg_date_utils.start_of(coalesce(dt_fim_vigencia,clock_timestamp()),'DD',0)
	and 	((coalesce(ie_quimio_p,'N') <> 'S' and coalesce(ie_quimioterapicas,'N') <> 'S') or (coalesce(ie_quimio_p,'N') = 'S'))
	order by CASE WHEN ie_quimioterapicas='S' THEN 'Z'  ELSE CASE WHEN ie_quimioterapicas='N' THEN 'C'  ELSE 'B' END  END ,
			coalesce(cd_setor_atendimento,0),
			coalesce(ie_motivo_prescricao,0);

BEGIN

if (nm_tabela_p	= 'CPOE_PROCEDIMENTO') then
	begin
	    select	max(nr_seq_prot_glic),
				max(nr_seq_proc_interno),
                max(dt_liberacao),
                max(dt_liberacao_enf),
                max(dt_liberacao_farm)
		into STRICT	nr_seq_prot_glic_w,
				nr_seq_proc_interno_w,
                dt_liberacao_w,
                dt_liberacao_enf_w,
                dt_liberacao_farm_w
		from	cpoe_procedimento
		where	nr_sequencia = nr_sequencia_p;

		select	max(nr_seq_exame_lab)
		into STRICT	nr_seq_exame_lab_w
		from	proc_interno
		where	nr_sequencia = nr_seq_proc_interno_w;

	    if (nr_seq_prot_glic_w IS NOT NULL AND nr_seq_prot_glic_w::text <> '') then
			ie_tipo_item_w	:= 'G'; --CCG
		elsif (nr_seq_exame_lab_w IS NOT NULL AND nr_seq_exame_lab_w::text <> '') then
			ie_tipo_item_w	:= 'E'; --L
		else
			ie_tipo_item_w	:= 'P';
	    end if;
	end;
elsif (nm_tabela_p	= 'CPOE_ANATOMIA_PATOLOGICA') then
	ie_tipo_item_w	:= 'P';
elsif (nm_tabela_p	= 'CPOE_DIETA') then
	begin
		if (coalesce(ie_tipo_dieta_p::text, '') = '') then
			select	max(ie_tipo_dieta)
			into STRICT	ie_tipo_dieta_w
			from	cpoe_dieta
			where	nr_sequencia	= nr_sequencia_p;
		else
			ie_tipo_dieta_w := ie_tipo_dieta_p;
		end if;
		if (coalesce(ie_tipo_dieta_w,'XP') <> 'I') and (coalesce(ie_tipo_dieta_w,'XP') <> 'P') then
			case	ie_tipo_dieta_w
				when 'O' then
					ie_tipo_item_w	:= 'D';
				when 'J' then
					ie_tipo_item_w	:= 'J';
				when 'E' then
					ie_tipo_item_w	:= 'SNE';
				when 'L' then
					ie_tipo_item_w	:= 'L';
				when 'S' then
					ie_tipo_item_w	:= 'SUP';
				--else ie_tipo_item_w := 'XX';
			end case;
		end if;
	end;
elsif (nm_tabela_p	= 'CPOE_MATERIAL') then
	begin
		
        select	max(ie_controle_tempo),
                max(ie_material),
                max(nr_seq_procedimento),
                max(nm_usuario_nrec),
                max(cd_perfil_ativo),
                max(cd_material),
                max(cd_intervalo),
                CASE WHEN max(IE_ADMINISTRACAO) ='N' THEN 'SN' WHEN max(IE_ADMINISTRACAO) ='C' THEN 'ACM'  ELSE 'N' END
        into STRICT	ie_controle_tempo_w,
                ie_material_w,
                nr_seq_procedimento_w,
                nm_ususario_presc_w,
                cd_perfil_prescr_w,
                cd_material_w,
                cd_intervalo_w,
                ie_tipo_interv_w
        from	cpoe_material
        where	nr_sequencia = nr_sequencia_p;

		if (nr_seq_procedimento_w IS NOT NULL AND nr_seq_procedimento_w::text <> '')  then
			ie_tipo_item_w	:= 'IA';
		elsif (ie_material_w	= 'S') then
			ie_tipo_item_w	:= 'MAT';
		elsif (ie_controle_tempo_w	= 'S') then
			ie_tipo_item_w	:= 'S';
		elsif (ie_controle_tempo_w	= 'N') then
			ie_tipo_item_w	:= 'M';
		end if;
	end;
elsif (nm_tabela_p	= 'CPOE_GASOTERAPIA') then
	ie_tipo_item_w	:= 'GAS';
elsif (nm_tabela_p	= 'CPOE_RECOMENDACAO') then
	ie_tipo_item_w	:= 'R';
end if;

for c01_w in C01
	loop
	ie_momento_lote_w	   := c01_w.ie_momento_lote_w;
	ie_rec_agora_w	 	   := c01_w.ie_rec_agora_w;
	ie_regra_agora_w  	   := c01_w.ie_regra_agora_w;
	ie_proced_agora_w 	   := c01_w.ie_proced_agora_w;
	ie_regra_dose_esp_w	   := c01_w.ie_regra_dose_esp_w;
    cd_setor_atend_regra_w := c01_w.cd_setor_atend_regra_w;
    nr_seq_regra_w         := c01_w.nr_seq_regra_w;
end loop;

if (ie_tipo_item_w in ('M','MAT','S')) then
	if ((ie_regra_agora_w = 'S' and ie_urgencia_p in ('0', '10', '15') and nr_ocorrencia_p = 1) or (ie_regra_dose_esp_w = 'S' and ie_dose_ataque_p = 'S'and nr_ocorrencia_p = 1)) then
		ie_momento_lote_w := 'N';
	end if;
elsif (ie_tipo_item_w in ('P','G','E')) then
	if (ie_proced_agora_w = 'S' and ie_urgencia_p in ('0', '10', '15') and nr_ocorrencia_p = 1) then
		ie_momento_lote_w := 'N';
	end if;
elsif (ie_tipo_item_w = 'R') then
	if (ie_rec_agora_w = 'S' and ie_urgencia_p in ('0', '10', '15') and nr_ocorrencia_p = 1) then
		ie_momento_lote_w := 'N';
	end if;
end if;

if (nm_tabela_p = 'CPOE_PROCEDIMENTO' and ie_momento_lote_w <> 'N') then
    if ((ie_momento_lote_w  = 'M' and (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '')) or (ie_momento_lote_w = 'E' and (dt_liberacao_enf_w IS NOT NULL AND dt_liberacao_enf_w::text <> '')) or (ie_momento_lote_w = 'F' and (dt_liberacao_farm_w IS NOT NULL AND dt_liberacao_farm_w::text <> ''))) then

        select count(1) 
          into STRICT ie_possui_medic_assoc_w 
          from cpoe_procedimento 
         where nr_sequencia = nr_sequencia_p
          and ((cd_mat_proc1 IS NOT NULL AND cd_mat_proc1::text <> '') or (cd_mat_proc2 IS NOT NULL AND cd_mat_proc2::text <> '') or (cd_mat_proc3 IS NOT NULL AND cd_mat_proc3::text <> '')
            or (cd_mat_proc4 IS NOT NULL AND cd_mat_proc4::text <> '') or (cd_mat_proc5 IS NOT NULL AND cd_mat_proc5::text <> '')
            or (cd_mat_proc6 IS NOT NULL AND cd_mat_proc6::text <> '') or (cd_mat_proc7 IS NOT NULL AND cd_mat_proc7::text <> ''));

        if (ie_possui_medic_assoc_w > 0) then
            ie_tipo_item_w := 'IA';
        else
            select count(1)
              into STRICT ie_possui_mat_assoc_w
              from cpoe_material
             where nr_seq_procedimento = nr_sequencia_p;

             if (ie_possui_mat_assoc_w > 0) then
                ie_tipo_item_w := 'IA';
            end if;
        end if;

        if (ie_tipo_item_w = 'IA') then
            for c01_w in C01
                loop
                ie_momento_lote_w	:= c01_w.ie_momento_lote_w;
                ie_rec_agora_w	 	:= c01_w.ie_rec_agora_w;
                ie_regra_agora_w  	:= c01_w.ie_regra_agora_w;
                ie_proced_agora_w 	:= c01_w.ie_proced_agora_w;
                ie_regra_dose_esp_w	:= c01_w.ie_regra_dose_esp_w;
                cd_setor_atend_regra_w := c01_w.cd_setor_atend_regra_w;
                nr_seq_regra_w         := c01_w.nr_seq_regra_w;
            end loop;
        end if;
    end if;
end if;

ie_param_127_w := obter_valor_param_usuario(924,127, cd_perfil_prescr_w, nm_ususario_presc_w, obter_estabelecimento_ativo);

if (coalesce(ie_momento_lote_w,'E') = 'F') then

    select  count(nr_seq_regra)
    into STRICT    qt_registro_w
    from    regra_momento_lib_item
    where   nr_seq_regra = nr_seq_regra_w  LIMIT 1;

    if (qt_registro_w > 0) then
        ie_se_necessario_w := 'N';
        ie_acm_w := 'N';
        ie_urgente_w := 'N';

        if (ie_tipo_interv_w = 'SN') then
            ie_se_necessario_w := 'S';
        elsif (ie_tipo_interv_w = 'ACM') then
            ie_acm_w := 'S';
        end if;
        if (ie_urgencia_p in ('0', '10', '15')) then
            ie_urgente_w := 'S';
        end if;

     
        ie_momento_lote_w :=  Obter_momento_lib_item( nr_seq_regra_w, 
                                cd_material_w,
                                cd_setor_prescr_p,
                                cd_intervalo_w,
                                ie_acm_w,
                                ie_se_necessario_w,
                                'N',
                                ie_urgente_w,
                                'F');
    end if;

                
	select	CASE WHEN count(a.nr_prescricao)=0 THEN  'N'  ELSE 'S' END 
	into STRICT	ie_existe_prescr_w
	from	prescr_medica a
	where	a.nr_prescricao = obter_prescr_item_cpoe(nr_sequencia_p, ie_tipo_item_w)
	and		(coalesce(a.dt_liberacao_medico, a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico, a.dt_liberacao))::text <> '')
	and		coalesce(a.dt_liberacao_farmacia::text, '') = '';

    if (ie_param_127_w = 'T' and (cd_setor_atend_regra_w = cd_setor_prescr_p or coalesce(cd_setor_atend_regra_w::text, '') = '')) then        
        return ie_momento_lote_w;

	elsif (ie_existe_prescr_w = 'S') then
		select	coalesce(max(a.ie_lib_farm),'N')
		into STRICT	ie_lib_farm_w
		from	prescr_medica a
		where	a.nr_prescricao = obter_prescr_item_cpoe(nr_sequencia_p, ie_tipo_item_w)
		and		(coalesce(a.dt_liberacao_medico, a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico, a.dt_liberacao))::text <> '')
		and		coalesce(a.dt_liberacao_farmacia::text, '') = '';

		if (ie_lib_farm_w = 'N') then
			ie_momento_lote_w := 'N';
		end if;
	end if;
end if;

return	coalesce(ie_momento_lote_w,'E');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_momento_lote (ie_motivo_prescricao_p text, cd_setor_prescr_p bigint, cd_estabelecimento_p bigint, ie_quimio_p text default 'N', nm_tabela_p text default null, nr_sequencia_p bigint default null, ie_tipo_dieta_p text default null, ie_controle_tempo_p cpoe_material.ie_controle_tempo%type default null, ie_material_p cpoe_material.ie_material%type default null, ie_urgencia_p text default null, nr_ocorrencia_p bigint default null, ie_dose_ataque_p text default null) FROM PUBLIC;

