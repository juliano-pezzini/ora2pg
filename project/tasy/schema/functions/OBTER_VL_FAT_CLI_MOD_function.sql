-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_vl_fat_cli_mod ( nr_seq_cliente_p bigint, dt_mes_ref_p timestamp, ie_mod_p text) RETURNS bigint AS $body$
DECLARE


vl_nota_w	double precision;


/*
* CDU - Manutenção do CDU
* PAR - Parcelamento da licensa do CDU
* LUT- Pagamento LUT
*/
BEGIN

select	sum(coalesce(vl_nota,0))
into STRICT	vl_nota_w
from	(
SELECT	sum(d.VL_MANUT_MENSAL) vl_nota
from	com_cliente b,
		com_cli_neg_lic c,
		com_cli_neg_lic_item d,
		com_modalidade_lic e
where	b.nr_sequencia = c.nr_seq_cliente
and		c.nr_sequencia = d.NR_SEQ_NEG_LIC
and		d.NR_SEQ_MOD_LICENC = e.nr_sequencia
and		e.ie_modalidade = 'CDU'
and	    'CDU' = ie_mod_p
AND 	c.nr_sequencia  in (SELECT nr_sequencia FROM com_cli_neg_lic WHERE TRUNC(c.dt_assinatura,'year') = TRUNC(dt_mes_ref_p, 'year'))
and		trunc(d.DT_INICIO_VENC_MANUT,'month') <= (trunc(dt_mes_ref_p,'month'))
and		b.nr_sequencia = nr_Seq_cliente_p

union all

select	sum(d.vl_parcela) vl_nota
from	com_cliente b,
		com_cli_neg_lic c,
		com_cli_neg_lic_parc d
where	b.nr_sequencia = c.nr_seq_cliente
and		c.nr_sequencia = d.NR_SEQ_NEGOC_LIC
and		d.ie_origem_valor = '1'
and	    'PAR' = ie_mod_p
AND 	c.nr_sequencia  in (SELECT nr_sequencia FROM com_cli_neg_lic WHERE TRUNC(c.dt_assinatura,'year') = TRUNC(dt_mes_ref_p, 'year'))
and		trunc(d.DT_vencimento,'month') = (trunc(dt_mes_ref_p,'month'))
and		b.nr_sequencia = nr_Seq_cliente_p

union all
 /* Valores de lut */
select	sum(d.vl_total) vl_nota
from	com_cliente b,
		com_cli_neg_lic c,
		com_cli_neg_lic_item d,
		com_modalidade_lic e
where	b.nr_sequencia = c.nr_seq_cliente
and		c.nr_sequencia = d.NR_SEQ_NEG_LIC
and		d.NR_SEQ_MOD_LICENC = e.nr_sequencia
and		e.ie_modalidade = 'LUT'
and	    'LUT' = ie_mod_p
AND 	c.nr_sequencia  in (SELECT nr_sequencia FROM com_cli_neg_lic WHERE TRUNC(c.dt_assinatura,'year') = TRUNC(dt_mes_ref_p, 'year'))
and		trunc(d.DT_INICIO_VENC,'month') <= (trunc(dt_mes_ref_p,'month'))
and		b.nr_sequencia = nr_Seq_cliente_p) alias23;

return	vl_nota_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_vl_fat_cli_mod ( nr_seq_cliente_p bigint, dt_mes_ref_p timestamp, ie_mod_p text) FROM PUBLIC;

