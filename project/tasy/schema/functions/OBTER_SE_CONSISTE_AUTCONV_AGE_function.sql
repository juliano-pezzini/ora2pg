-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_consiste_autconv_age ( nr_seq_origem_p bigint, nm_usuario_p text ) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(1)	:= 'N';			
nm_usuario_origem_w	varchar(15);
dt_agendamento_w	timestamp;
ie_ok_w			varchar(01) := 'S';
nr_seq_proc_interno_w	bigint;		
cd_procedimento_w	bigint;		
ie_origem_proced_w	bigint;		
qt_total_secao_w	smallint;		
nr_secao_w		smallint;		
cd_medico_solic_w	varchar(10);		
nr_seq_agepaci_w	bigint;		
ie_liberado_w		varchar(1):= 'S';	
ie_permite_sessao_w	varchar(1):= 'N';	
cd_estabelecimento_w	smallint;		
nr_seq_agenda_sessao_w	            agenda_consulta.nr_sequencia%type;
qt_autorizada_w		integer;
nr_atendimento_w	bigint;


BEGIN

select	cd_medico_solic,
	nr_atendimento,
	nr_seq_proc_interno,
	cd_procedimento,
	ie_origem_proced,
	qt_total_secao,
	CASE WHEN coalesce(nr_seq_agenda_sessao::text, '') = '' THEN  nr_sequencia  ELSE nr_seq_agenda_sessao END
into STRICT	cd_medico_solic_w,
	nr_atendimento_w,
	nr_seq_proc_interno_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	qt_total_secao_w,
	nr_seq_agenda_sessao_w
from	agenda_consulta
where	nr_sequencia		= nr_seq_origem_p;

select	coalesce(max(obter_valor_param_usuario(866, 21, obter_perfil_ativo, nm_usuario_p,0)),'N')
into STRICT	ie_permite_sessao_w
;

if (ie_permite_sessao_w		= 'N') then /* Oraci em 17/09/2007 OS68280 */
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') and
		((cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '' AND ie_origem_proced_w IS NOT NULL AND ie_origem_proced_w::text <> '') or (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '')) and (cd_medico_solic_w IS NOT NULL AND cd_medico_solic_w::text <> '') and (qt_total_secao_w IS NOT NULL AND qt_total_secao_w::text <> '') then

		select	max(nr_secao) + 1
		into STRICT	nr_secao_w
		from	agenda_consulta
		where	ie_status_agenda	<> 'C'
		and	nr_atendimento	= nr_atendimento_w
		and	((cd_procedimento 	= cd_procedimento_w AND ie_origem_proced 	= ie_origem_proced_w) or (nr_seq_proc_interno	= nr_seq_proc_interno_w));
	else
		qt_total_secao_w	:= null;
		nr_secao_w	 	:= null;
	end if;
elsif (ie_permite_sessao_w		= 'S') then

	if	((cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '' AND ie_origem_proced_w IS NOT NULL AND ie_origem_proced_w::text <> '') or (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '')) and (cd_medico_solic_w IS NOT NULL AND cd_medico_solic_w::text <> '') and (qt_total_secao_w IS NOT NULL AND qt_total_secao_w::text <> '') then

		select	max(nr_secao) + 1
		into STRICT	nr_secao_w
		from	agenda_consulta
		where	ie_status_agenda	<> 'C'
		and	nr_sequencia		= nr_seq_origem_p
		and	((cd_procedimento 	= cd_procedimento_w AND ie_origem_proced 	= ie_origem_proced_w) or (nr_seq_proc_interno	= nr_seq_proc_interno_w));
	else
		qt_total_secao_w	:= null;
		nr_secao_w	 	:= null;
	end if;
end if;

qt_autorizada_w	:= obter_qt_autconv_atend_agecons(nr_atendimento_w, nr_seq_agenda_sessao_w);

if (nr_secao_w	> 1) and (qt_autorizada_w	< nr_secao_w) then
	ds_retorno_w	:= 'S';
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_consiste_autconv_age ( nr_seq_origem_p bigint, nm_usuario_p text ) FROM PUBLIC;

