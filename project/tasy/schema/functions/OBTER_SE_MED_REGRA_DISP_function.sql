-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_med_regra_disp ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_unid_med_dose_p text, ie_via_aplicacao_p text, cd_intervalo_p text, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


cd_unid_med_solic_w		varchar(30);
cd_unid_med_estoque_w	varchar(30);
cd_convenio_w			integer := 0;
cd_setor_atendimento_w	integer := 0;
ie_acm_w			varchar(1);
ie_se_necessario_w		varchar(1);
IE_MOTIVO_PRESCRICAO_w	varchar(3);
qt_regra_w				integer;
cd_material_estoque_w   integer;


BEGIN

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

	select	substr(obter_dados_material_estab(cd_material_p,cd_estabelecimento_p,'UMS'),1,30),
			substr(obter_dados_material_estab(cd_material_p,cd_estabelecimento_p,'UME'),1,30),
			substr(obter_dados_material(cd_material_p,'EST'),1,30)
	into STRICT	cd_unid_med_solic_w,
			cd_unid_med_estoque_w,
			cd_material_estoque_w
	;

	if (coalesce(nr_atendimento_p,0) > 0) then
		select	coalesce(max(cd_convenio),0),
				coalesce(max(cd_setor_atendimento),0)
		into STRICT	cd_convenio_w,
				cd_setor_atendimento_w
		from	atendimento_paciente_v
		where	nr_atendimento = nr_atendimento_p;
	end if;

	select	coalesce(max(ie_acm),'N'),
		coalesce(max(ie_se_necessario),'N')
	into STRICT	ie_acm_w,
		ie_se_necessario_w
	from	prescr_material
	where	nr_prescricao 	= nr_prescricao_p
	and	nr_sequencia 	= nr_sequencia_p;

	select	max(IE_MOTIVO_PRESCRICAO)
	into STRICT	IE_MOTIVO_PRESCRICAO_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	select	count(*)
	into STRICT	qt_regra_w
	from	material_regra_disp
	where	cd_estabelecimento	= cd_estabelecimento_p
	and		((coalesce(cd_unidade_medida::text, '') = '') or
			 ((ie_unidade_medida = 1) and (coalesce(cd_unid_med_solic_w,cd_unidade_medida) = cd_unidade_medida)) or
			 ((ie_unidade_medida = 2) and (coalesce(cd_unid_med_dose_p,cd_unidade_medida) = cd_unidade_medida)) or
			 ((ie_unidade_medida = 3) and (coalesce(cd_unid_med_estoque_w,cd_unidade_medida) = cd_unidade_medida)))
	and		(((coalesce(cd_material, cd_material_p)	= cd_material_p) and (coalesce(ie_material_estoque,'N') = 'N')) or
			((coalesce(cd_material, cd_material_estoque_w)	= cd_material_estoque_w) and (coalesce(ie_material_estoque,'N') = 'S')))
	and		coalesce(cd_convenio, cd_convenio_w)		= cd_convenio_w
	and		coalesce(cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
	and		coalesce(cd_perfil, coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
	and		coalesce(cd_unid_med_estoque, cd_unid_med_estoque_w) = cd_unid_med_estoque_w
	and		((coalesce(ie_via_aplicacao::text, '') = '') or (coalesce(ie_via_aplicacao_p, ie_via_aplicacao) = ie_via_aplicacao))
	and		((coalesce(cd_intervalo::text, '') = '') or (coalesce(cd_intervalo_p, cd_intervalo) = cd_intervalo))
	and		((coalesce(nr_seq_estrut_int::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrut_int,cd_material_p) = 'S'))
	and		(((coalesce(ie_acm_sn,'X') = 'N') and (ie_acm_w = 'N') and (ie_se_necessario_w = 'N')) or
			 ((coalesce(ie_acm_sn,'X') = 'S') and
				  ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S'))) or (coalesce(ie_acm_sn,'X') = 'X'))
	and 	(IE_MOTIVO_PRESCRICAO IS NOT NULL AND IE_MOTIVO_PRESCRICAO::text <> '');

	if (qt_regra_w > 0) then
		return 'S';
	else
		return 'N';
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_med_regra_disp ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_unid_med_dose_p text, ie_via_aplicacao_p text, cd_intervalo_p text, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

