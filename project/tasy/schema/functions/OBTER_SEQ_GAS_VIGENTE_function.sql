-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_seq_gas_vigente ( nr_seq_gas_cpoe_p cpoe_gasoterapia.nr_sequencia%type, ie_alteracao_p text) RETURNS bigint AS $body$
DECLARE


/*Obter a sequencia correta da prescricao da gasoterapia
quando houve acao de copia da CPOE*/
						
nr_seq_gasoterapia_w		prescr_gasoterapia.nr_sequencia%type;
ie_status_requerido_w		varchar(10);
qt_hor_pendente_w           bigint;
nr_prescricao_vig_w         prescr_medica.nr_prescricao%type;


BEGIN

case ie_alteracao_p
	when 'I' then ie_status_requerido_w := 'N,TE';
	when 'IN' then ie_status_requerido_w := 'I,R';
	when 'R' then ie_status_requerido_w := 'IN';
	when 'T' then ie_status_requerido_w := 'IN,I,R';
	when 'V' then ie_status_requerido_w := 'I,R';
	when 'S' then ie_status_requerido_w := 'I,R,N,P,IN';
	else ie_status_requerido_w := null;
end case;

if (ie_status_requerido_w IS NOT NULL AND ie_status_requerido_w::text <> '') then
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_gasoterapia_w
	from	prescr_gasoterapia	a
	where	a.nr_seq_gas_cpoe	= nr_seq_gas_cpoe_p
	and		obter_status_gasoterapia(a.nr_sequencia,'C') in (	SELECT	x.cd_registro
																from 	table(lista_pck.obter_lista_char(ie_status_requerido_w,',')) x)
	and (obter_se_prescr_vigente(a.nr_prescricao) = 'S' or (ie_alteracao_p in ('IN','R','T')));

    if (coalesce(nr_seq_gasoterapia_w::text, '') = '') then
        select  max(a.nr_prescricao)
        into STRICT    nr_prescricao_vig_w
        from    prescr_medica a,
                prescr_gasoterapia b,
                cpoe_gasoterapia c
        where   a.nr_prescricao = b.nr_prescricao
        and     b.nr_seq_gas_cpoe = c.nr_sequencia
        and     b.nr_seq_gas_cpoe = nr_seq_gas_cpoe_p
        and     a.dt_inicio_prescr < clock_timestamp()
        and     a.dt_validade_prescr > clock_timestamp();

        select  max(a.nr_sequencia)
        into STRICT    nr_seq_gasoterapia_w
        from    prescr_gasoterapia a,
                cpoe_gasoterapia b
        where   b.nr_sequencia = a.nr_seq_gas_cpoe
        and     a.nr_seq_gas_cpoe = nr_seq_gas_cpoe_p
        and     obter_status_gasoterapia(a.nr_sequencia,'C') in (   SELECT  x.cd_registro 
                                                                    from    table(lista_pck.obter_lista_char(ie_status_requerido_w,',')) x)
        and     b.dt_liberacao < clock_timestamp()
        and     a.nr_prescricao > nr_prescricao_vig_w;

         if (coalesce(nr_seq_gasoterapia_w::text, '') = '') then
          	select	max(b.nr_sequencia)
            into STRICT nr_seq_gasoterapia_w
            from     prescr_gasoterapia_hor a,
                    prescr_gasoterapia b
            where b.nr_prescricao = a.nr_prescricao
            and b.nr_seq_gas_cpoe = nr_seq_gas_cpoe_p
            and obter_status_etapa_gas(b.nr_sequencia,a.nr_etapa,a.dt_fim_horario,a.dt_suspensao) in ('I','R','V','IN');

        end if;
    end if;
elsif (ie_alteracao_p = 'RV') then
	select	max(a.nr_seq_gasoterapia)
	into STRICT	nr_seq_gasoterapia_w
	from	prescr_gasoterapia_evento a
	where	a.nr_seq_gas_cpoe		= nr_seq_gas_cpoe_p
	and		coalesce(a.ie_evento_valido,'S') = 'S'	
	and		a.nr_sequencia				= (	SELECT	max(b.nr_sequencia)
											from	prescr_gasoterapia_evento b
											where	b.nr_seq_gas_cpoe	= nr_seq_gas_cpoe_p
											and		coalesce(b.ie_evento_valido,'S') = 'S');
end if;
	
return	nr_seq_gasoterapia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_seq_gas_vigente ( nr_seq_gas_cpoe_p cpoe_gasoterapia.nr_sequencia%type, ie_alteracao_p text) FROM PUBLIC;

