-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION eis_obter_ocup_tipo_acomod ( cd_tipo_acomodacao_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint ) RETURNS bigint AS $body$
DECLARE


qt_leitos_w			bigint;
qt_leitos_ocupados_w		bigint;
ie_calculo_padronizado_w	varchar(1);


BEGIN

ie_calculo_padronizado_w := obter_dados_param_atend(cd_estabelecimento_p,'TO');

if (ie_calculo_padronizado_w = 'S')
and (coalesce(cd_tipo_acomodacao_p::text, '') = '') then
	return	coalesce(eis_obter_ocup_censo(dt_inicial_p, dt_final_p, cd_estabelecimento_p),0);
else
	select	sum(CASE WHEN ie_temp='S' THEN nr_leitos_ocupados  ELSE nr_unidades_setor END )
	into STRICT	qt_leitos_w
	from	eis_ocupacao_setor_v a
	where	dt_referencia between dt_inicial_p and dt_final_p
	and	ie_periodo = 'D'
	and	cd_estabelecimento = cd_estabelecimento_p;

	select	sum(nr_leitos_ocupados)
	into STRICT	qt_leitos_ocupados_w
	from	eis_ocupacao_setor_v a
	where	dt_referencia between dt_inicial_p and dt_final_p
	and	ie_periodo = 'D'
	and	cd_estabelecimento = cd_estabelecimento_p
	and	((cd_tipo_acomodacao = cd_tipo_acomodacao_p) or (coalesce(cd_tipo_acomodacao_p::text, '') = ''));

	return	dividir((qt_leitos_ocupados_w * 100),qt_leitos_w);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eis_obter_ocup_tipo_acomod ( cd_tipo_acomodacao_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint ) FROM PUBLIC;

