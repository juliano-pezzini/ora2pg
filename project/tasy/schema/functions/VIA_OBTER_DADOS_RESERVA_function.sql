-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION via_obter_dados_reserva (nr_sequencia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
nr_sequencia_w		bigint;
ie_tipo_reserva_w		varchar(1);
nm_hotel_w		varchar(100);
ds_meio_transp_w		varchar(80);
nr_reserva_w		varchar(80);
nm_veiculo_w		varchar(40);
dt_reserva_w		timestamp;
dt_saida_prev_w		timestamp;
dt_retorno_prev_w		timestamp;
dt_entrada_hotel_w		timestamp;
dt_saida_hotel_w		timestamp;
vl_reserva_w		double precision;
ds_loc_origem_w		varchar(240);
ds_loc_destino_w		varchar(240);
ds_retorno_w		varchar(255);
nr_sequencia_via_w	bigint;
nm_pessoa_w		varchar(60);
ds_destino_w		varchar(255);
		
/* 	TR - Tipo_Reserva 
	NH - Nome Hotel 
	MT - Meio Transporte 
	NR - Número Reserva 
	NV - Nome Veículo 
	DR - Data Reserva 
	DSP - Data Saída Prevista 
	DRP - Data Retorno Previsto 
	DEH - Data Entrada Hotel 
	DSH - Data Saída Hotel 
	VR - Valor Reserva 
	LO - Local Origem 
	LD - Local Destino 
	NRV - Nr. Sequencia via 
	NMP - Nome da pessoa 
	NMC - Nome do cliente 
*/
 
	 

BEGIN 
 
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then 
	select	a.nr_sequencia, 
		a.ie_tipo_reserva, 
		substr(obter_nome_hotel(a.nr_seq_hotel),1,100) nm_hotel, 
		substr(Obter_Desc_Meio_Transp(c.nr_seq_meio_transp),1,80) ds_meio_transp, 
		a.nr_reserva, 
		substr(obter_nome_veiculo(c.nr_seq_veiculo),1,40) nm_veiculo, 
		a.dt_reserva, 
		a.dt_saida_prev, 
		a.dt_retorno_prev, 
		a.dt_entrada_hotel, 
		a.dt_saida_hotel, 
		a.vl_reserva, 
		substr(Obter_Desc_Loc(c.nr_seq_loc_origem),1,240) DS_LOC_ORIGEM, 
		substr(Obter_Desc_Loc(c.nr_seq_loc_destino),1,240) DS_LOC_DESTINO, 
		campo_numerico(obter_dados_viagem(a.nr_seq_viagem,'SQ')) nr_sequencia_via, 
		substr(obter_dados_viagem(a.nr_seq_viagem,'NP'),1,240) nm_pessoa, 
		substr(obter_destino_viagem(a.nr_seq_viagem),1,240) ds_destino 
	into STRICT	nr_sequencia_w, 
		ie_tipo_reserva_w, 
		nm_hotel_w, 
		ds_meio_transp_w, 
		nr_reserva_w, 
		nm_veiculo_w, 
		dt_reserva_w, 
		dt_saida_prev_w, 
		dt_retorno_prev_w, 
		dt_entrada_hotel_w, 
		dt_saida_hotel_w, 
		vl_reserva_w, 
		ds_loc_origem_w, 
		ds_loc_destino_w, 
		nr_sequencia_via_w, 
		nm_pessoa_w, 
		ds_destino_w 
	from  via_reserva a, 
		via_reserva_transporte b, 
		via_transporte c 
	where 	a.nr_sequencia = b.nr_seq_reserva 
	and   c.nr_sequencia = b.nr_seq_transporte 
	and 	a.nr_sequencia = nr_sequencia_p 
	order by a.dt_reserva;	
	 
	if (coalesce(ie_opcao_p, 'TR') = 'TR') then 
		ds_retorno_w	:= ie_tipo_reserva_w;
	elsif (coalesce(ie_opcao_p, 'TR') = 'NH') then 
		ds_retorno_w	:= nm_hotel_w;
	elsif (coalesce(ie_opcao_p, 'TR') = 'MT') then 
		ds_retorno_w	:= ds_meio_transp_w;
	elsif (coalesce(ie_opcao_p, 'TR') = 'NR') then 
		ds_retorno_w	:= nr_reserva_w;
	elsif (coalesce(ie_opcao_p, 'TR') = 'NV') then 
		ds_retorno_w	:= nm_veiculo_w;
	elsif (coalesce(ie_opcao_p, 'TR') = 'DR') then 
		ds_retorno_w	:= to_char(dt_reserva_w,'dd/mm/yyyy hh24:mi:ss');
	elsif (coalesce(ie_opcao_p, 'TR') = 'DSP') then 
		ds_retorno_w	:= to_char(dt_saida_prev_w,'dd/mm/yyyy hh24:mi:ss');
	elsif (coalesce(ie_opcao_p, 'TR') = 'DRP') then 
		ds_retorno_w	:= to_char(dt_retorno_prev_w,'dd/mm/yyyy hh24:mi:ss');
	elsif (coalesce(ie_opcao_p, 'TR') = 'DEH') then 
		ds_retorno_w	:= to_char(dt_entrada_hotel_w,'dd/mm/yyyy hh24:mi:ss');
	elsif (coalesce(ie_opcao_p, 'TR') = 'DSH') then 
		ds_retorno_w  := to_char(dt_saida_hotel_w,'dd/mm/yyyy hh24:mi:ss');
	elsif (coalesce(ie_opcao_p, 'TR') = 'VR') then 
		ds_retorno_w	:= vl_reserva_w;
	elsif (coalesce(ie_opcao_p, 'TR') = 'LO') then 
		ds_retorno_w	:= ds_loc_origem_w;
	elsif (coalesce(ie_opcao_p, 'TR') = 'LD') then 
		ds_retorno_w	:= ds_loc_destino_w;
	elsif (coalesce(ie_opcao_p, 'TR') = 'NRV') then 
		ds_retorno_w	:= nr_sequencia_via_w;
	elsif (coalesce(ie_opcao_p, 'TR') = 'NMP') then 
		ds_retorno_w	:= nm_pessoa_w;
	elsif (coalesce(ie_opcao_p, 'TR') = 'NMC') then 
		ds_retorno_w	:= ds_destino_w;
	end if;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION via_obter_dados_reserva (nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

