-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_tasklist ( nr_seq_regra_p wl_regra_item.nr_seq_regra%type, dt_inicio_p wl_worklist.dt_inicial%type, dt_final_prev_p wl_worklist.dt_final_previsto%type, dt_final_real_p wl_worklist.dt_final_real%type, ie_opcao_p wl_worklist.ie_tipo_item_cpoe%type, nr_seq_item_cpoe_p wl_horarios_atrasados_v.nr_seq_mat_cpoe%type default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w  		varchar(4000);
qt_tempo_atraso_w	wl_regra_item.qt_tempo_atraso%type;
cd_categoria_w		wl_item.cd_categoria%type;
dt_horario_w		wl_regra_item.dt_atualizacao%type;

ie_return_w	varchar(10);
cd_return_w	bigint;

/*
A - Atrasa/Delayed
T - Em tempo/On time
C - Concluido/Done

ie_opcao_p
D - Description
C - Code
*/
BEGIN
	select	max(a.qt_tempo_atraso),
		obter_categoria_worklist(max(b.nr_seq_item))
	into STRICT	qt_tempo_atraso_w,
		cd_categoria_w
	from	wl_regra_item a,
		wl_regra_worklist b
	where	a.nr_sequencia = nr_seq_regra_p
	and	a.nr_seq_regra = b.nr_sequencia;

	if (cd_categoria_w = 'D') then
		select	min(dt_horario)
		into STRICT	dt_horario_w
		from	wl_horarios_atrasados_v
		where	nr_seq_mat_cpoe = nr_seq_item_cpoe_p;
		
		if (dt_horario_w IS NOT NULL AND dt_horario_w::text <> '') then
			if ((qt_tempo_atraso_w IS NOT NULL AND qt_tempo_atraso_w::text <> '') and qt_tempo_atraso_w > 0) then
				if (clock_timestamp() > (dt_horario_w + (qt_tempo_atraso_w/24))) then
					ie_return_w	:= 'A';
					cd_return_w	:= 302651; -- delayed
				else
					ie_return_w	:= 'D';
					cd_return_w	:= 560323; -- in progress
				end if;
			else
				ie_return_w	:= 'A';
				cd_return_w	:= 302651; -- delayed
			end if;
		else
			ie_return_w	:= 'C';
			cd_return_w	:= 654443; --Done
		end if;

	elsif (coalesce(qt_tempo_atraso_w::text, '') = '') then
		if (coalesce(dt_final_real_p::text, '') = '' and clock_timestamp() > dt_final_prev_p) then
			ie_return_w	:= 'A';
			cd_return_w	:= 302651; -- delayed
		elsif (coalesce(dt_final_real_p::text, '') = '' and dt_inicio_p <= dt_final_prev_p) then
			ie_return_w	:= 'D';
			cd_return_w	:= 560323; -- in progress
		elsif (dt_final_real_p IS NOT NULL AND dt_final_real_p::text <> '') then
			ie_return_w	:= 'C';
			cd_return_w	:= 654443; --Done
		end if;

	else
		if (coalesce(dt_final_real_p::text, '') = '' and clock_timestamp() > (dt_inicio_p+(qt_tempo_atraso_w/24))) then
			ie_return_w	:= 'A';
			cd_return_w	:= 302651; -- delayed
		elsif (coalesce(dt_final_real_p::text, '') = '' and dt_inicio_p <= dt_final_prev_p) then
			ie_return_w	:= 'D';
			cd_return_w	:= 560323; -- in progress
		elsif (dt_final_real_p IS NOT NULL AND dt_final_real_p::text <> '') then
			ie_return_w	:= 'C';
			cd_return_w	:= 654443; --Done
		end if;
	end if;

	if (ie_opcao_p = 'D') then
		ds_retorno_w := obter_desc_expressao(cd_return_w);
	else
		ds_retorno_w := ie_return_w;
	end if;
	return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_tasklist ( nr_seq_regra_p wl_regra_item.nr_seq_regra%type, dt_inicio_p wl_worklist.dt_inicial%type, dt_final_prev_p wl_worklist.dt_final_previsto%type, dt_final_real_p wl_worklist.dt_final_real%type, ie_opcao_p wl_worklist.ie_tipo_item_cpoe%type, nr_seq_item_cpoe_p wl_horarios_atrasados_v.nr_seq_mat_cpoe%type default null) FROM PUBLIC;

