-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_valida_acesso_atend_pep ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_paciente_p pessoa_fisica.cd_pessoa_fisica%type, nm_usuario_p usuario.nm_usuario%type, dt_logon_p timestamp ) RETURNS varchar AS $body$
DECLARE


ie_permite_w                    varchar(1) := 'S';
cd_pessoa_fisica_w	        pessoa_fisica.cd_pessoa_fisica%type;
cd_medico_resp_w	        varchar(10);
ie_existe_regra_w		smallint;
ie_libera_regra_w		smallint;


BEGIN

begin
select	cd_pessoa_fisica
into STRICT 	cd_pessoa_fisica_w
from 	usuario
where 	nm_usuario = nm_usuario_p;
exception
when no_data_found then
	cd_pessoa_fisica_w := null;
end;

select 	count(1)
into STRICT 	ie_existe_regra_w
from 	pep_autor_acesso
where 	cd_paciente     = cd_paciente_p  LIMIT 1;

if ( ie_existe_regra_w > 0 ) and ( nr_atendimento_p > 0 ) then
		
        ie_permite_w := 'N';

        select	count(*)
        into STRICT	ie_libera_regra_w
        from	pep_autor_acesso
        where	cd_paciente		= cd_paciente_p
        and	cd_pessoa_fisica	= cd_pessoa_fisica_w
        and (clock_timestamp()	        between	coalesce( dt_inicio, to_date('01/01/1900','dd/mm/yyyy') )
                                        and     coalesce( dt_fim,    to_date('01/01/2900','dd/mm/yyyy') ) )
        and coalesce(dt_inativacao::text, '') = '';

        if ( ie_libera_regra_w > 0 ) then
                ie_permite_w := 'S';
        else
                begin
                select	cd_medico_resp
                into STRICT	cd_medico_resp_w
                from	atendimento_paciente
                where	nr_atendimento	= nr_atendimento_p;
                exception
                when no_data_found then
                        cd_pessoa_fisica_w := null;
                end;
                if ( cd_medico_resp_w = cd_pessoa_fisica_w ) then
                        ie_permite_w := 'S';
                end if;
        end if;
end if;

return ie_permite_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_valida_acesso_atend_pep ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_paciente_p pessoa_fisica.cd_pessoa_fisica%type, nm_usuario_p usuario.nm_usuario%type, dt_logon_p timestamp ) FROM PUBLIC;

