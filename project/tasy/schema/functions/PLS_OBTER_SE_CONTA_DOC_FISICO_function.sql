-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_conta_doc_fisico ( nr_seq_analise_p bigint, nr_seq_conta_p bigint, cd_guia_p text) RETURNS varchar AS $body$
DECLARE

			 
ds_retorno_w			varchar(255)	:= null;
qt_registro_w			bigint	:= 0;
qt_exige_doc_liberado_w		bigint	:= 0;
nr_seq_conta_w			bigint;
nr_seq_grupo_pre_analise_w	bigint;
cd_estabelecimento_w		smallint;


BEGIN 
if (nr_seq_analise_p IS NOT NULL AND nr_seq_analise_p::text <> '') and (cd_guia_p IS NOT NULL AND cd_guia_p::text <> '') then 
	select	max(a.nr_sequencia), 
		max(a.cd_estabelecimento) 
	into STRICT	nr_seq_conta_w, 
		cd_estabelecimento_w 
	from	pls_conta	a 
	where	a.nr_seq_analise	= nr_seq_analise_p 
	and	a.cd_guia		= cd_guia_p;
	 
	nr_seq_conta_w := coalesce(nr_seq_conta_p,nr_seq_conta_w);
		 
	/* Verifica se a conta esta na analise (itens) */
 
	if (nr_seq_conta_w IS NOT NULL AND nr_seq_conta_w::text <> '') then 
		select	count(1) 
		into STRICT	qt_registro_w 
		from	pls_ocorrencia_benef	a 
		where	a.nr_seq_conta	= nr_seq_conta_w 
		and	coalesce(a.ie_documento_fisico,'N') = 'S'  LIMIT 1;
		 
		/* Se houver documento fisico para a conta */
 
		if (qt_registro_w > 0) then 
			select	max(a.nr_seq_grupo_pre_analise) 
			into STRICT	nr_seq_grupo_pre_analise_w 
			from	pls_parametros	a 
			where	a.cd_estabelecimento	= cd_estabelecimento_w;
		 
			select	count(1) 
			into STRICT	qt_exige_doc_liberado_w 
			from	pls_analise_glo_ocor_grupo	a, 
				pls_ocorrencia_benef		b 
			where	a.ie_status		in ('L') 
			and	a.nr_seq_analise	= nr_seq_analise_p 
			and	b.nr_sequencia		= a.nr_seq_ocor_benef 
			and	b.nr_seq_conta		= nr_seq_conta_w 
			and	((a.nr_seq_grupo = nr_seq_grupo_pre_analise_w) or (coalesce(nr_seq_grupo_pre_analise_w::text, '') = '')) 
			and	exists (SELECT	1 
					from	pls_ocorrencia	x 
					where	coalesce(x.ie_documento_fisico, 'N')	= 'S' 
					and	x.nr_sequencia			= b.nr_seq_ocorrencia 
					and	x.ie_situacao			= 'A');
		 
			 
			/* Se houver ocorrencias que exige documento, ae retorna se a ocorrencia esta liberada (DL) ou nÃ£o liberedo (DN) */
 
			if (qt_exige_doc_liberado_w > 0) then 
				ds_retorno_w := 'DL';
			else 
				ds_retorno_w := 'DN';
			end if;
		end if;
	end if;	
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_conta_doc_fisico ( nr_seq_analise_p bigint, nr_seq_conta_p bigint, cd_guia_p text) FROM PUBLIC;

