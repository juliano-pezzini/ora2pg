-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_processamento_conta (nr_interno_conta_p bigint) RETURNS varchar AS $body$
DECLARE


nr_interno_conta_w	conta_paciente.nr_interno_conta%type;
ie_status_acerto_w	conta_paciente.ie_status_acerto%type;

cd_estabelecimento_w	conta_paciente.cd_estabelecimento%type;
cd_convenio_w		conta_paciente.cd_convenio_parametro%type;
dt_periodo_inicial_w	conta_paciente.dt_periodo_inicial%type;
nr_seq_conta_des_w	conta_paciente.nr_interno_conta%type;
ie_status_destino_w	conta_paciente.ie_status_acerto%type;
nr_seq_regra_deducao_w	conv_regra_deducao.nr_sequencia%type;

ds_retorno_w		varchar(1);

c01 CURSOR FOR
SELECT	a.nr_interno_conta
from	conta_log_processamento a,
		conta_paciente b
where	a.nr_interno_conta_base = nr_interno_conta_p
and		a.nr_interno_conta = b.nr_interno_conta
and		coalesce(b.ie_cancelamento::text, '') = '';


BEGIN

ds_retorno_w	:= 'N';

select	max(cd_estabelecimento),
	max(cd_convenio_parametro),
	max(dt_periodo_inicial)
into STRICT	cd_estabelecimento_w,
	cd_convenio_w,
	dt_periodo_inicial_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_p;

nr_seq_regra_deducao_w	:= coalesce(obter_regra_deducao_conv(cd_estabelecimento_w, cd_convenio_w, null, dt_periodo_inicial_w),0);

if (nr_seq_regra_deducao_w > 0) then

	select	max(nr_seq_conta_des)
	into STRICT	nr_seq_conta_des_w
	from	conta_pac_deducao_conv
	where	nr_seq_conta_orig = nr_interno_conta_p
	and	(dt_processamento IS NOT NULL AND dt_processamento::text <> '');

	if (coalesce(nr_seq_conta_des_w,0) > 0) then
		ds_retorno_w	:= 'P';

		select	ie_status_acerto
		into STRICT	ie_status_acerto_w
		from	conta_paciente
		where	nr_interno_conta = nr_interno_conta_p;

		select	max(ie_status_acerto)
		into STRICT	ie_status_destino_w
		from	conta_paciente
		where	nr_interno_conta = nr_seq_conta_des_w;

		if	((ie_status_acerto_w = 2) or (ie_status_destino_w = 2)) then
			ds_retorno_w	:= 'D';
		end if;
	end if;

else

	open c01;
	loop
		fetch	c01
		into	nr_interno_conta_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		ds_retorno_w	:= 'P';

		select	ie_status_acerto
		into STRICT	ie_status_acerto_w
		from	conta_paciente
		where	nr_interno_conta = nr_interno_conta_w;

		if (ie_status_acerto_w = 2) then
			ds_retorno_w	:= 'D';
		end if;

		exit when ds_retorno_w = 'D';
	end loop;
	close c01;

end if;

return  ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_processamento_conta (nr_interno_conta_p bigint) FROM PUBLIC;

