-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_procedure_rule (cd_setor_atendimento_p bigint, nr_atendimento_p bigint, ie_tipo_atendimento_p text, nr_seq_cpoe_order_unit_p bigint ) RETURNS timestamp AS $body$
DECLARE

                                               
cd_classif_setor_w          setor_atendimento.cd_classif_setor%type;
nr_seq_cpoe_tipo_pedido_p   cpoe_order_unit.NR_SEQ_CPOE_TIPO_PEDIDO%type;
dt_horario_p                cpoe_procedimento.dt_inicio%type;
nr_qt_dias_p                regra_horario_proc.nr_qt_dias%type;


BEGIN
		begin
			select coalesce(obter_classif_setor(obter_setor_atendimento(a.nr_atendimento)), null)
			into STRICT cd_classif_setor_w
			from atendimento_paciente a
			where a.nr_atendimento = nr_atendimento_p;
		exception when no_data_found or too_many_rows then
			cd_classif_setor_w := null;
		end;

        select max(nr_seq_cpoe_tipo_pedido)
        into STRICT nr_seq_cpoe_tipo_pedido_p
        from  cpoe_order_unit
        where nr_sequencia = nr_seq_cpoe_order_unit_p;

        select max(dt_horario) dt_horario,
               max(nr_qt_dias) nr_qt_dias
        into STRICT dt_horario_p,
             nr_qt_dias_p
        from   regra_horario_proc
        where (cd_setor_atendimento =  coalesce(cd_setor_atendimento_p,cd_setor_atendimento) or coalesce(cd_setor_atendimento::text, '') = '')
        and (cd_classif_setor = coalesce(cd_classif_setor_w,cd_classif_setor) or coalesce(cd_classif_setor::text, '') = '')        
        and (cd_tipo_atendimento = coalesce(ie_tipo_atendimento_p,cd_tipo_atendimento) or coalesce(cd_tipo_atendimento::text, '') = '')        
        and nr_seq_tipo_pedido = nr_seq_cpoe_tipo_pedido_p;

        if (coalesce(nr_qt_dias_p::text, '') = '') then
            nr_qt_dias_p := 0;
        end if;

        if (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') then
            
            select PKG_DATE_UTILS.get_Time(clock_timestamp()+nr_qt_dias_p, PKG_DATE_UTILS.extract_field('HOUR', dt_horario_p) 
            || ':' || PKG_DATE_UTILS.extract_field('MINUTE', dt_horario_p))
            into STRICT dt_horario_p
;

        end if;

        if (dt_horario_p < clock_timestamp()) then
            dt_horario_p := clock_timestamp();
        end if;

        return dt_horario_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_procedure_rule (cd_setor_atendimento_p bigint, nr_atendimento_p bigint, ie_tipo_atendimento_p text, nr_seq_cpoe_order_unit_p bigint ) FROM PUBLIC;

