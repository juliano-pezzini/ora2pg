-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_oru_r01_laudo ( nr_prescricao_p prescr_procedimento.nr_prescricao%TYPE, nr_seq_prescricao_p prescr_procedimento.nr_sequencia%TYPE) RETURNS varchar AS $body$
DECLARE


cd_pessoa_fisica_w 			pessoa_fisica.cd_pessoa_fisica%TYPE;
nm_paciente_w               pessoa_fisica.nm_pessoa_fisica%TYPE;
nr_acesso_dicom_w           prescr_procedimento.nr_acesso_dicom%TYPE;
cd_procedimento_w           prescr_procedimento.cd_procedimento%TYPE;
ds_procedimento_w           procedimento.ds_procedimento%TYPE;
cd_medico_w                 pessoa_fisica.cd_pessoa_fisica%TYPE;
nm_medico_w                 pessoa_fisica.nm_pessoa_fisica%TYPE;
nr_crm_w                    medico.nr_crm%TYPE;
uf_crm_w                    medico.uf_crm%TYPE;
nr_seq_interno_w            prescr_procedimento.nr_seq_interno%TYPE;
cd_externo_laudo_w          laudo_paciente.cd_laudo_externo%TYPE;
dt_laudo_w                  laudo_paciente.dt_laudo%TYPE;
ds_pedido_ext_w             prescr_medica.ds_pedido_ext%TYPE;
DS_MESSAGE_W                text;
JSON_ORU_W                  PHILIPS_JSON := PHILIPS_JSON();


BEGIN
    SELECT a.cd_pessoa_fisica,
        obter_dados_pf(a.cd_pessoa_fisica, 'PNC'),
        b.nr_acesso_dicom,
        b.cd_procedimento,
        obter_desc_procedimento(b.cd_procedimento, b.ie_origem_proced),
        a.cd_medico_resp,
        obter_dados_pf(a.cd_medico_resp, 'PNC'),
        obter_dados_medico(a.cd_medico_resp, 'CRM'),
        obter_dados_medico(a.cd_medico_resp, 'UFCRM'),
        b.nr_seq_interno,
        a.dt_laudo,
        c.ds_pedido_ext
    INTO STRICT
        cd_pessoa_fisica_w,
        nm_paciente_w,
        nr_acesso_dicom_w,
        cd_procedimento_w,
        ds_procedimento_w,
        cd_medico_w,
        nm_medico_w,
        nr_crm_w,
        uf_crm_w,
        nr_seq_interno_w,
        dt_laudo_w,
        ds_pedido_ext_w
    FROM laudo_paciente a,
         prescr_procedimento b,
         prescr_medica c
    WHERE a.nr_prescricao = nr_prescricao_p
        and a.nr_seq_prescricao = nr_seq_prescricao_p
        and a.nr_prescricao = b.nr_prescricao
        and a.nr_seq_prescricao = b.nr_sequencia
        and b.nr_prescricao = c.nr_prescricao;

    SELECT nextval('tie_integra_laudo_hl7_seq')
    INTO STRICT cd_externo_laudo_w
;

    JSON_ORU_W.PUT(PAIR_NAME => 'CD_PESSOA_FISICA',     PAIR_VALUE => cd_pessoa_fisica_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'NM_PACIENTE',          PAIR_VALUE => nm_paciente_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'NR_ACESSO_DICOM',      PAIR_VALUE => nr_acesso_dicom_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'CD_PROCEDIMENTO',      PAIR_VALUE => cd_procedimento_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'DS_PROCEDIMENTO',      PAIR_VALUE => ds_procedimento_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'CD_MEDICO_RESP',       PAIR_VALUE => cd_medico_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'NM_MEDICO',            PAIR_VALUE => nm_medico_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'NR_CRM',               PAIR_VALUE => nr_crm_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'UF_CRM',               PAIR_VALUE => uf_crm_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'NR_SEQ_INTERNO',       PAIR_VALUE => nr_seq_interno_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'CD_LAUDO_EXTERNO',     PAIR_VALUE => cd_externo_laudo_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'DT_LAUDO',             PAIR_VALUE => TO_CHAR(dt_laudo_w, 'MM/DD/YYYY HH24:MI:SS'));
    JSON_ORU_W.PUT(PAIR_NAME => 'NR_PRESCRICAO',        PAIR_VALUE => ds_pedido_ext_w);
    JSON_ORU_W.PUT(PAIR_NAME => 'NR_SEQ_PRESCRICAO',    PAIR_VALUE => nr_seq_prescricao_p);

    DBMS_LOB.CREATETEMPORARY(DS_MESSAGE_W, TRUE);
    JSON_ORU_W.(DS_MESSAGE_W);

    RETURN DS_MESSAGE_W;

EXCEPTION WHEN no_data_found THEN RETURN null;
          WHEN too_many_rows THEN RAISE;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_oru_r01_laudo ( nr_prescricao_p prescr_procedimento.nr_prescricao%TYPE, nr_seq_prescricao_p prescr_procedimento.nr_sequencia%TYPE) FROM PUBLIC;

