-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_regra_inf_pep ( nr_seq_regra_p bigint) RETURNS char AS $body$
DECLARE


ie_existe_w		char(1);
cd_perfil_w		perfil.cd_perfil%type;
nm_usuario_w	usuario.nm_usuario%type;
ie_visualizar_w	char(1);
ds_sql_cursor_w	varchar(300);

cCursor REFCURSOR;


BEGIN

if (nr_seq_regra_p IS NOT NULL AND nr_seq_regra_p::text <> '') then
	select	coalesce(max('S'),'N')
	into STRICT	ie_existe_w
	from	pep_regra_informacao_lib where		nr_seq_regra	= nr_seq_regra_p LIMIT 1;

	if (ie_existe_w = 'S') then

		ds_sql_cursor_w	:=	' select * from ( select	coalesce(ie_visualizar,''S'') ' ||
							' from		pep_regra_informacao_lib ' ||
							' where		nr_seq_regra = '||nr_seq_regra_p||' ';

		cd_perfil_w	:= coalesce(obter_perfil_ativo,0);
		if (cd_perfil_w = 0) then
			ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and		cd_perfil is null ';
		else
			ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and		cd_perfil = '||cd_perfil_w||' ';
		end if;

		nm_usuario_w := coalesce(obter_usuario_ativo,'XPTO');

		if (nm_usuario_w = 'XPTO') then
			ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and		nm_usuario_param is null ';
		else
			ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and		nvl(nm_usuario_param, '''||nm_usuario_w||''')  = '''||nm_usuario_w||''' ';
		end if;

		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' order by  nm_usuario_param, coalesce(cd_perfil,0)) where rownum = 1 ';

		open cCursor for EXECUTE ds_sql_cursor_w;
		loop
		fetch cCursor into
			ie_visualizar_w;
		EXIT WHEN NOT FOUND; /* apply on cCursor */
		end loop;
		close cCursor;

		return coalesce(ie_visualizar_w,'N');
	end if;
end if;

return	'S';

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_regra_inf_pep ( nr_seq_regra_p bigint) FROM PUBLIC;

