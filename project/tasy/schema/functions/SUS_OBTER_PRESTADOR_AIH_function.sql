-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_prestador_aih ( nr_sequencia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
 
cd_estabelecimento_w		smallint;
cd_medico_executor_w		varchar(10);
cd_cgc_prestador_w		varchar(14);
ie_doc_executor_w			smallint;
ds_retorno_w			varchar(20);
cd_cnes_w			varchar(7);
ie_exporta_cnes_w			varchar(1)	:= 'N';
ie_exporta_cnes_hosp_w		varchar(1)	:= 'N';
ie_exporta_cnes_setor_w		varchar(1)	:= 'N';
cd_setor_atendimento_w		integer;


BEGIN 
 
select	c.cd_estabelecimento, 
	p.cd_cgc_prestador, 
	coalesce(p.cd_medico_executor,p.cd_pessoa_fisica), 
	coalesce(p.ie_doc_executor,5), 
	cd_setor_atendimento 
into STRICT	cd_estabelecimento_w, 
	cd_cgc_prestador_w, 
	cd_medico_executor_w, 
	ie_doc_executor_w, 
	cd_setor_atendimento_w 
from	procedimento_paciente p, 
	conta_paciente c 
where	p.nr_interno_conta	= c.nr_interno_conta 
and	p.nr_sequencia		= nr_sequencia_p;
 
select	coalesce(max(substr(lpad(cd_cnes_hospital,7,'0'),1,7)),''), 
	coalesce(max(ie_exporta_cnes),'N'), 
	coalesce(max(ie_exporta_cnes_hosp),'N'), 
	coalesce(max(ie_exporta_cnes_setor),'N') 
into STRICT	cd_cnes_w, 
	ie_exporta_cnes_w, 
	ie_exporta_cnes_hosp_w, 
	ie_exporta_cnes_setor_w 
from	sus_parametros_aih 
where	cd_estabelecimento	= cd_estabelecimento_w;
 
if (ie_doc_executor_w	= 1) then 
	ds_retorno_w		:= Obter_Cpf_Pessoa_Fisica(cd_medico_executor_w);
elsif (ie_doc_executor_w	= 3) then 
	ds_retorno_w		:= cd_cgc_prestador_w;
elsif (ie_doc_executor_w	= 5) then 
	ds_retorno_w		:= Obter_cnes_estab(cd_estabelecimento_w);
elsif (ie_doc_executor_w	= 6) then 
	select	max(cd_cnes) 
	into STRICT	ds_retorno_w 
	from	pessoa_juridica 
	where	cd_cgc		= cd_cgc_prestador_w;
	 
	if (ie_exporta_cnes_hosp_w	= 'S')	and (ie_exporta_cnes_setor_w 	= 'N')	then 
		ds_retorno_w	:= cd_cnes_w;
	end if;	
	 
	if (ie_exporta_cnes_setor_w = 'S') then 
	begin 
 
	begin 
	select	substr(coalesce(max(cd_cnes),ds_retorno_w),1,7) 
	into STRICT	ds_retorno_w 
	from	setor_atendimento 
	where	cd_setor_atendimento	= cd_setor_atendimento_w;
	exception 
		when others then 
		ds_retorno_w 	:= ds_retorno_w;
		end;
 
	end;
end if;
	 
end if;
 
return ds_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_prestador_aih ( nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

