-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nut_obter_se_card_escolha (nr_seq_cardapio_p bigint, nr_seq_servico_dia_p bigint, ie_tipo_campo_p text, ie_especial_p text, nr_seq_acompanhante_p bigint, cd_acompanhante_p text, nr_seq_cardapio_dia_p bigint) RETURNS varchar AS $body$
DECLARE

		
/* Tipo campo
	'S' - Selecionado S/N
	'L' - Liberado S/N */
nr_seq_opcao_w			bigint;
nr_seq_servico_w		bigint;
nr_seq_receita_w		bigint;
ie_retorno_w			varchar(01)	:= 'N';
ie_selecionado_w		varchar(01)	:= 'N';
ie_liberado_w			varchar(01)	:= 'N';
ie_producao_terceiro_w		varchar(1);
nr_seq_refeicao_w		bigint;
	

BEGIN

select	coalesce(max(ie_producao_terceiro),'N')
into STRICT	ie_producao_terceiro_w
from	parametros_nutricao
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

if (ie_producao_terceiro_w = 'S') then
	select	max(b.nr_seq_opcao),
		max(b.nr_seq_servico),
		max(a.nr_seq_refeicao)
	into STRICT	nr_seq_opcao_w,
		nr_seq_servico_w,
		nr_seq_refeicao_w
	from	nut_cardapio_dia b,
		nut_cardapio_refeicao a
	where	a.nr_seq_cardapio_dia	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_cardapio_p;
else
	select	coalesce(max(b.nr_seq_opcao),max(a.nr_seq_opcao)),
		max(b.nr_seq_servico),
		max(a.nr_seq_receita)
	into STRICT	nr_seq_opcao_w,
		nr_seq_servico_w,
		nr_seq_receita_w
	from	nut_cardapio_dia b,
		nut_cardapio a
	where	a.nr_seq_card_dia	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_cardapio_p;
end if;

if (nr_seq_cardapio_dia_p = 0) then
	begin
	if (ie_especial_p = 'S') then
		select	coalesce(CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END ,'N')
		into STRICT	ie_selecionado_w
		from	nut_pac_opcao_rec a
		where 	nr_seq_servico_dia	= nr_seq_servico_dia_p
		and	ie_receita_especial	= 'S'
		AND	(((cd_acompanhante_p = '0') AND (cd_acompanhante = '0' or coalesce(cd_acompanhante::text, '') = '')) OR (cd_acompanhante_p <> '0' AND cd_acompanhante = cd_acompanhante_p))
		AND	(((nr_seq_acompanhante_p = 0) AND (nr_seq_acompanhante = 0 or coalesce(nr_seq_acompanhante::text, '') = '')) OR (nr_seq_acompanhante_p <> 0 AND nr_seq_acompanhante = nr_seq_acompanhante_p));
	else
		select	coalesce(max('S'), 'N')
		into STRICT	ie_selecionado_w
		from	nut_pac_opcao_rec a
		where 	nr_seq_servico_dia	= nr_seq_servico_dia_p
		and	((((a.nr_seq_receita	= nr_seq_receita_w) or (a.nr_seq_receita = 0 and coalesce(nr_seq_receita_w::text, '') = '')) and ie_producao_terceiro_w = 'N')
		or	(((a.nr_seq_refeicao	= nr_seq_refeicao_w) or (a.nr_seq_refeicao = 0 and coalesce(nr_seq_refeicao_w::text, '') = '')) and ie_producao_terceiro_w = 'S'))
		and	a.nr_seq_opcao_sel	= nr_seq_opcao_w
		AND	(((cd_acompanhante_p = '0') AND (cd_acompanhante = '0' or coalesce(cd_acompanhante::text, '') = '')) OR (cd_acompanhante_p <> '0' AND cd_acompanhante = cd_acompanhante_p))
		AND	(((nr_seq_acompanhante_p = 0)   AND (nr_seq_acompanhante = 0 or coalesce(nr_seq_acompanhante::text, '') = '')) OR (nr_seq_acompanhante_p <> 0 AND nr_seq_acompanhante = nr_seq_acompanhante_p))	
		and	ie_receita_especial	= 'N';
	end if;

	select	coalesce(MAX(CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'N'  ELSE 'S' END ),'N')
	into STRICT	ie_liberado_w
	from	nut_pac_opcao_rec a
	where 	nr_seq_servico_dia		= nr_seq_servico_dia_p
	and (ie_receita_especial	= ie_especial_p or (coalesce(ie_receita_especial::text, '') = '' and ie_especial_p = 'N'))
	AND	(((cd_acompanhante_p = '0') AND (cd_acompanhante = '0' or coalesce(cd_acompanhante::text, '') = '')) OR (cd_acompanhante_p <> '0' AND cd_acompanhante = cd_acompanhante_p))
	AND	(((nr_seq_acompanhante_p = 0)   AND (coalesce(nr_seq_acompanhante,0) = 0)) OR ((nr_seq_acompanhante_p <> 0) AND (coalesce(nr_seq_acompanhante,0) = nr_seq_acompanhante_p)));
	end;
else
	begin
	if (ie_especial_p = 'S') then
		select	coalesce(CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END ,'N')
		into STRICT	ie_selecionado_w
		from	nut_pac_opcao_rec a
		where 	nr_seq_cardapio_dia	= nr_seq_cardapio_dia_p
		and	ie_receita_especial	= 'S';
	else
		select	coalesce(max('S'), 'N')
		into STRICT	ie_selecionado_w
		from	nut_pac_opcao_rec a
		where 	nr_seq_cardapio_dia	= nr_seq_cardapio_dia_p
		and	((((a.nr_seq_receita	= nr_seq_receita_w) or (a.nr_seq_receita = 0 and coalesce(nr_seq_receita_w::text, '') = '')) and ie_producao_terceiro_w = 'N')
		or	(((a.nr_seq_refeicao	= nr_seq_refeicao_w) or (a.nr_seq_refeicao = 0 and coalesce(nr_seq_refeicao_w::text, '') = '')) and ie_producao_terceiro_w = 'S'))
		and	a.nr_seq_opcao_sel	= nr_seq_opcao_w
		and	ie_receita_especial	= 'N';
	end if;

	select	coalesce(MAX(CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'N'  ELSE 'S' END ),'N')
	into STRICT	ie_liberado_w
	from	nut_pac_opcao_rec a
	where 	nr_seq_cardapio_dia		= nr_seq_cardapio_dia_p
	and (ie_receita_especial = ie_especial_p or (coalesce(ie_receita_especial::text, '') = '' and ie_especial_p = 'N'));
	end;
end if;
	

if (ie_tipo_campo_p	= 'S') then
	ie_retorno_w		:= ie_selecionado_w;
else
	ie_retorno_w		:= ie_liberado_w;
end if;	

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION nut_obter_se_card_escolha (nr_seq_cardapio_p bigint, nr_seq_servico_dia_p bigint, ie_tipo_campo_p text, ie_especial_p text, nr_seq_acompanhante_p bigint, cd_acompanhante_p text, nr_seq_cardapio_dia_p bigint) FROM PUBLIC;

