-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION retorna_posicao_rel_australia (nr_seq_caixa_rec_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


vl_especie_w        double precision;
vl_cartao_w         double precision;
vl_cheque_w         double precision;
vl_direto_w         double precision;
posicao1_w          varchar(100);
posicao2_w          varchar(100);
posicao3_w          varchar(100);
posicao4_w          varchar(100);
texto1_w            varchar(100);
texto2_w            varchar(100);
texto3_w            varchar(100);
texto4_w            varchar(100);
nr_recibo_w         varchar(100);
pessoa_recibo_w     varchar(400);


BEGIN

    select
        obter_valores_caixa_rec(cr.nr_sequencia,'VE') as vl_especie,
        obter_valores_caixa_rec(cr.nr_sequencia,'VCA') as vl_cartao,
        obter_valores_caixa_rec(cr.nr_sequencia,'VCH') as vl_cheque,
        cr.vl_deposito_direto as vl_direto,
        (select max(pf.nr_prontuario) from pessoa_fisica pf where pf.cd_pessoa_fisica = cr.cd_pessoa_fisica) as recibo_nr_mrn,
        coalesce(obter_dados_pf_pj(null, cr.cd_cgc, 'N'), obter_dados_pf(cr.cd_pessoa_fisica,'PNC')) as pessoa_recibo_nm
    into STRICT
        vl_especie_w,
        vl_cartao_w,
        vl_cheque_w,
        vl_direto_w,
        nr_recibo_w,
        pessoa_recibo_w
    from caixa_receb cr
    where cr.nr_sequencia = nr_seq_caixa_rec_p;

    if (vl_especie_w > 0) then
        posicao1_w := campo_mascara_virgula(vl_especie_w);
        texto1_w := 'Cash';
    end if;

    if (vl_direto_w > 0) then
        if (coalesce(posicao1_w::text, '') = '') then
            posicao1_w := campo_mascara_virgula(vl_direto_w);
            texto1_w := 'Direct Deposit';
        else
            posicao2_w := campo_mascara_virgula(vl_direto_w);
            texto2_w := 'Direct Deposit';
        end if;
    end if;

    if (vl_cartao_w > 0) then
        if (coalesce(posicao1_w::text, '') = '') then
            posicao1_w := campo_mascara_virgula(vl_cartao_w);
            texto1_w := 'Eftpos';
        elsif (coalesce(posicao2_w::text, '') = '') then
            posicao2_w := campo_mascara_virgula(vl_cartao_w);
            texto2_w := 'Eftpos';
        else
            posicao3_w := campo_mascara_virgula(vl_cartao_w);
            texto3_w := 'Eftpos';
        end if;
    end if;

    if (vl_cheque_w > 0) then
        if (coalesce(posicao1_w::text, '') = '') then
            posicao1_w := campo_mascara_virgula(vl_cheque_w);
            texto1_w := 'Cheque';
        elsif (coalesce(posicao2_w::text, '') = '') then
            posicao2_w := campo_mascara_virgula(vl_cheque_w);
            texto2_w := 'Cheque';
        elsif (coalesce(posicao3_w::text, '') = '') then
            posicao3_w := campo_mascara_virgula(vl_cheque_w);
            texto3_w := 'Cheque';
        else
            posicao4_w := campo_mascara_virgula(vl_cheque_w);
            texto4_w := 'Cheque';
        end if;
    end if;
    
    if (ie_opcao_p = 'P1') then
        return posicao1_w;
    elsif (ie_opcao_p = 'P2') then
        return posicao2_w;
    elsif (ie_opcao_p = 'P3') then
        return posicao3_w;
    elsif (ie_opcao_p = 'P4') then
        return posicao4_w;
    elsif (ie_opcao_p = 'T1') then
        return texto1_w;
    elsif (ie_opcao_p = 'T2') then
        return texto2_w;
    elsif (ie_opcao_p = 'T3') then
        return texto3_w;
    elsif (ie_opcao_p = 'T4') then
        return texto4_w;
    elsif (ie_opcao_p = 'R1') then
        if (posicao1_w IS NOT NULL AND posicao1_w::text <> '') then
            return nr_recibo_w;
        end if;
    elsif (ie_opcao_p = 'R2') then
        if (posicao2_w IS NOT NULL AND posicao2_w::text <> '') then
            return nr_recibo_w;
        end if;
    elsif (ie_opcao_p = 'R3') then
        if (posicao3_w IS NOT NULL AND posicao3_w::text <> '') then
            return nr_recibo_w;
        end if;
    elsif (ie_opcao_p = 'R4') then
        if (posicao4_w IS NOT NULL AND posicao4_w::text <> '') then
            return nr_recibo_w;
        end if;
    elsif (ie_opcao_p = 'PR1') then
        if (posicao1_w IS NOT NULL AND posicao1_w::text <> '') then
            return pessoa_recibo_w;
        end if;
    elsif (ie_opcao_p = 'PR2') then
        if (posicao2_w IS NOT NULL AND posicao2_w::text <> '') then
            return pessoa_recibo_w;
        end if;
    elsif (ie_opcao_p = 'PR3') then
        if (posicao3_w IS NOT NULL AND posicao3_w::text <> '') then
            return pessoa_recibo_w;
        end if;
    elsif (ie_opcao_p = 'PR4') then
        if (posicao4_w IS NOT NULL AND posicao4_w::text <> '') then
            return pessoa_recibo_w;
        end if;
    end if;

    return null;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION retorna_posicao_rel_australia (nr_seq_caixa_rec_p bigint, ie_opcao_p text) FROM PUBLIC;

