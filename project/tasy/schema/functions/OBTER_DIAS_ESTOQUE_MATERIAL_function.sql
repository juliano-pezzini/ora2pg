-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dias_estoque_material ( cd_estabelecimento_p bigint, cd_material_p bigint, nm_usuario_p text default 'Tasy') RETURNS bigint AS $body$
DECLARE

 
qt_estoque_w			double precision := 0;
qt_estoque_ww			double precision := 0;
qt_emprestimo_w			double precision := 0;
qt_consumo_mensal_w		double precision;
qt_dias_estoque_w		bigint;
cd_local_estoque_w		bigint;
dt_mesano_referencia_w	  	timestamp;
ie_saldo_requisicao_w		varchar(1);
ie_material_saldo_ressup_w	varchar(1);
ie_consumo_ressup_w		varchar(15);

 
c01 CURSOR FOR 
SELECT	distinct b.cd_local_estoque 
from	local_estoque b, 
	saldo_estoque a 
where	cd_material = cd_material_p 
and	dt_mesano_referencia >= dt_mesano_referencia_w 
and	a.cd_local_estoque = b.cd_local_estoque 
and	a.cd_estabelecimento = cd_estabelecimento_p 
and	b.ie_proprio = 'S' 
and (substr(obter_se_considera_ressup(a.cd_estabelecimento,a.cd_local_estoque, a.cd_material),1,1) = 'S') 
and not exists (	SELECT	1 
		from	w_loc_estoque_ressup x 
		where	x.cd_local_estoque = a.cd_local_estoque 
		and	x.nm_usuario = nm_usuario_p) 
and	dt_mesano_referencia = (select	max(c.dt_mesano_referencia) 
				from	saldo_estoque c 
				where	c.cd_material = a.cd_material 
				and	c.cd_estabelecimento = a.cd_estabelecimento 
				and	c.cd_local_estoque = a.cd_local_estoque 
				and	dt_mesano_referencia >= dt_mesano_referencia_w);


BEGIN 
 
select	pkg_date_utils.start_of(max(dt_mesano_vigente),'MONTH',0), 
	coalesce(max(ie_saldo_requisicao),'C') 
into STRICT	dt_mesano_referencia_w, 
	ie_saldo_requisicao_w 
from	parametro_estoque 
where	cd_estabelecimento = cd_estabelecimento_p;
 
select	coalesce(max(ie_material_saldo_ressup), 'N'), 
	coalesce(max(ie_consumo_ressup),'S') 
into STRICT	ie_material_saldo_ressup_w, 
	ie_consumo_ressup_w 
from	parametro_compras 
where	cd_estabelecimento = cd_estabelecimento_p;
 
 
/* Qt Estoque */
 
 
select	coalesce(sum(qt_estoque),0) 
into STRICT	qt_estoque_w 
from	local_estoque b, 
	saldo_estoque a 
where	cd_material = cd_material_p 
and	dt_mesano_referencia >= dt_mesano_referencia_w 
and	a.cd_local_estoque = b.cd_local_estoque 
and	a.cd_estabelecimento = cd_estabelecimento_p 
and	b.ie_proprio = 'S' 
and (substr(obter_se_considera_ressup(a.cd_estabelecimento,a.cd_local_estoque, a.cd_material),1,1) = 'S')	 
and not exists (	SELECT	1 
		from	w_loc_estoque_ressup x 
		where	x.cd_local_estoque = a.cd_local_estoque 
		and	x.nm_usuario = nm_usuario_p) 
and	dt_mesano_referencia = (select	max(c.dt_mesano_referencia) 
				from	saldo_estoque c 
				where	c.cd_material = a.cd_material 
				and	c.cd_estabelecimento = a.cd_estabelecimento 
				and	c.cd_local_estoque = a.cd_local_estoque 
				and	dt_mesano_referencia >= dt_mesano_referencia_w);
 
if (coalesce(ie_saldo_requisicao_w, 'C') = 'D') then 
		 
	qt_estoque_w	:= 0;
	qt_estoque_ww	:= 0;
		 
	open C01;
	loop 
	fetch C01 into	 
		cd_local_estoque_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		qt_estoque_ww := obter_saldo_disp_estoque( 
					cd_estabelecimento_p, 
					cd_material_p, 
					cd_local_estoque_w, 
					pkg_date_utils.start_of(clock_timestamp(),'MONTH',0));
		qt_estoque_w := qt_estoque_w + qt_estoque_ww;
		end;
	end loop;
	close C01;		
end if;
	 
 
if (coalesce(ie_saldo_requisicao_w, 'C') = 'E') then 
	begin 
	select	coalesce(sum(qt_material),0) 
	into STRICT	qt_emprestimo_w 
	from	emprestimo c, 
		emprestimo_material b			 
	where	b.nr_emprestimo	= c.nr_emprestimo 
	and	c.ie_tipo		= 'S' 
	and	c.ie_situacao		<> 'I' 
	and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '') 
	and	b.qt_material	> 0 
	and	exists ( 
		SELECT 1 from material a 
		where	a.cd_material_estoque	= cd_material_p 
		and	a.cd_material 		= b.cd_material);
 
	qt_estoque_w	:= qt_estoque_w	- qt_emprestimo_w;
	end;
end if;	
 
/* Consumo Mensal */
 
 
select	CASE WHEN ie_consumo_ressup_w='N' THEN c.qt_consumo_mensal_ressup  ELSE c.qt_consumo_mensal END  
into STRICT	qt_consumo_mensal_w 
from	material_estab c, 
	material a 
where	c.cd_material = a.cd_material 
and	c.cd_estabelecimento = cd_estabelecimento_p 
and	a.ie_situacao = 'A' 
and (coalesce(c.ie_ressuprimento, 'S') = 'S') 
and	a.cd_material = coalesce(a.cd_material_estoque, a.cd_material) 
and	a.cd_material = cd_material_p 
and	((exists ( 
		SELECT	1 
		from	saldo_estoque b 
		where	a.cd_material	= b.cd_material 
		and	b.dt_mesano_referencia >= pkg_date_utils.add_month(dt_mesano_referencia_w, -3,0) 
		and	b.cd_estabelecimento = cd_estabelecimento_p) and ie_material_saldo_ressup_w = 'N') or (ie_material_saldo_ressup_w = 'S'));
 
/* Qt Dias Estoque */
 
 
qt_dias_estoque_w := trunc(dividir(qt_estoque_w, dividir(qt_consumo_mensal_w, 30)));
 
return	qt_dias_estoque_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dias_estoque_material ( cd_estabelecimento_p bigint, cd_material_p bigint, nm_usuario_p text default 'Tasy') FROM PUBLIC;

