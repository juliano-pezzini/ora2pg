-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sl_obter_status_unidade ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, dt_referencia_p timestamp) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(90);
nr_atendimento_w	bigint;
dt_alta_w		timestamp;
dt_saida_real_w		timestamp;
NR_SEQ_INTERNO_w	bigint;
ie_status_serv_w	varchar(15);
qt_setor_regra_w	bigint;
ie_evento_w		varchar(15);
qt_check_list_w		bigint;
nr_seq_unid_atend_w	bigint;
ie_status_unidade_w	varchar(15);
nr_atendimento_atual_w 	bigint;
ie_pac_isolado_w	varchar(1);
qt_status_isolado_w	bigint;

BEGIN
 
select	max(NR_SEQ_INTERNO), 
	max(nr_atendimento) 
into STRICT	NR_SEQ_INTERNO_w, 
	nr_atendimento_atual_w 
from	unidade_atendimento 
where	cd_setor_atendimento 	= cd_setor_atendimento_p 
and	cd_unidade_basica 	= cd_unidade_basica_p 
and	cd_unidade_compl	= cd_unidade_compl_p;
 
 
select 	max(nr_sequencia) 
into STRICT	nr_seq_unid_atend_w 
from	sl_unid_atend 
where	nr_seq_unidade	= NR_SEQ_INTERNO_w 
and	trunc(dt_prevista) 	= trunc(dt_referencia_p);
 
 
select	max(ie_status_serv), 
	coalesce(max(ie_evento),'X') 
into STRICT	ie_status_serv_w, 
	ie_evento_w 
from	sl_unid_atend 
where	nr_sequencia = nr_seq_unid_atend_w;
 
select	count(*) 
into STRICT	qt_check_list_w 
from	SL_CHECK_LIST_UNID 
where	NR_SEQ_SL_UNID = nr_seq_unid_atend_w;
 
select	count(*) 
into STRICT	qt_setor_regra_w 
from	HIGIENIZACAO_SETOR_REGRA 
where	cd_setor_atendimento 	= cd_setor_atendimento_p;
 
select	obter_ult_atend_unidade(cd_setor_atendimento_p,cd_unidade_basica_p,cd_unidade_compl_p) 
into STRICT	nr_atendimento_w
;
 
select	max(IE_STATUS_UNIDADE) 
into STRICT	ie_status_unidade_w 
from	unidade_atendimento 
where	cd_setor_atendimento 	= cd_setor_atendimento_p 
and	cd_unidade_basica 	= cd_unidade_basica_p 
and	cd_unidade_compl	= cd_unidade_compl_p;
 
select	dt_alta, 
	dt_saida_real, 
	coalesce(ie_paciente_isolado,'N') 
into STRICT	dt_alta_w, 
	dt_saida_real_w, 
	ie_pac_isolado_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_w;
 
select 	count(*) 
into STRICT	qt_status_isolado_w 
from 	SL_STATUS_HIGIENIZACAO 
where  ie_status_higienizacao = 'PI';
 
ds_retorno_w	:= 'L';
 
if (nr_atendimento_atual_w > 0) then 
	ds_retorno_w	:= 'LCP';
end if;
if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') and (coalesce(dt_saida_real_w::text, '') = '') then 
	ds_retorno_w	:= 'ACP';
end if;
 
if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') and (dt_saida_real_w IS NOT NULL AND dt_saida_real_w::text <> '') and (ie_status_serv_w = 'P') and (qt_setor_regra_w = 0) and (ie_evento_w <> 'LL') then 
	ds_retorno_w	:= 'ASP';
end if;	
 
if (ie_status_unidade_w = 'I') then 
	ds_retorno_w	:= 'LI';
end if;
 
if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') and 
	--(dt_saida_real_w is not null) and 
	(ie_status_serv_w = 'P') and (qt_setor_regra_w > 0) and (ie_evento_w <> 'LL') then 
	ds_retorno_w	:= 'LU';
end if;	
 
if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') and 
	--(dt_saida_real_w is not null) and 
	(ie_status_serv_w = 'P') and (ie_evento_w = 'LL') then 
	ds_retorno_w	:= 'AL';
end if;	
 
if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') and 
	--(dt_saida_real_w is not null) and 
	(ie_status_serv_w = 'EE') then 
	ds_retorno_w	:= 'EM';
end if;	
 
if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') and 
--	(dt_saida_real_w is not null) and 
	(ie_status_serv_w = 'E') and (qt_check_list_w = 0) then 
	ds_retorno_w	:= 'ACL';
end if;	
 
if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') and 
	--(dt_saida_real_w is not null) and 
	(ie_status_serv_w = 'A') then	 
	ds_retorno_w	:= 'L';
	 
	 
end if;	
 
if (coalesce(dt_alta_w::text, '') = '') and 
	--(dt_saida_real_w is not null) and 
	(nr_atendimento_atual_w > 0) and (qt_status_isolado_w > 0) and (ie_pac_isolado_w = 'S') then	 
	ds_retorno_w	:= 'PI';
		 
end if;	
 
	 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sl_obter_status_unidade ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, dt_referencia_p timestamp) FROM PUBLIC;

