-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_enable_qt_total_dias ( nr_dia_util_p bigint, qt_total_dias_lib_p bigint, ie_dias_util_medic_p text, nr_prescricao_p bigint, cd_material_p bigint) RETURNS varchar AS $body$
DECLARE

					
ie_enable_w						varchar(1);
ie_dias_validade_w				varchar(1);
ie_atb_pessoa_w					varchar(1);
ie_mesma_vigencia_w				varchar(1);
nr_atendimento_w				prescr_medica.nr_atendimento%type;
dt_validade_prescr_w			prescr_medica.dt_validade_prescr%type;
cd_estabelecimento_w			prescr_medica.cd_estabelecimento%type;
cd_pessoa_fisica_w				prescr_medica.cd_pessoa_fisica%type;
ie_controle_medico_w			material.ie_controle_medico%type;
					

BEGIN	

cd_estabelecimento_w := coalesce(obter_estabelecimento_ativo,1);

select	coalesce(max(a.ie_controle_medico),0)
into STRICT	ie_controle_medico_w
from	material a,
	material_estab b
where	a.cd_material    = b.cd_material
and	a.cd_material		 = cd_material_p
and	b.cd_estabelecimento = cd_estabelecimento_w;

if (ie_controle_medico_w <> 0) then
	if	((ie_dias_util_medic_p = 'S' AND nr_dia_util_p > 1) or
		 (ie_dias_util_medic_p = 'O' AND nr_dia_util_p > 0)) then
			if (qt_total_dias_lib_p > 0) then
				if (ie_dias_util_medic_p = 'O') then
					if (nr_dia_util_p < qt_total_dias_lib_p) then
						ie_enable_w := 'N';
					else
						if (nr_dia_util_p - qt_total_dias_lib_p = 0) then
							ie_enable_w := 'S';
						else
							ie_enable_w := 'N';
						end if;	
					end if;
				elsif (ie_dias_util_medic_p = 'S') then
					if (nr_dia_util_p <= qt_total_dias_lib_p) then
						ie_enable_w := 'N';
					else
						if (nr_dia_util_p - qt_total_dias_lib_p = 1) then
							ie_enable_w := 'S';
						else
							ie_enable_w := 'N';
						end if;	
					end if;		
				end if;
			else
				ie_enable_w := 'N';
			end if;	
	else

		select	max(dt_validade_prescr),
				max(cd_estabelecimento),
				max(nr_atendimento),
				max(cd_pessoa_fisica)
		into STRICT	dt_validade_prescr_w,
				cd_estabelecimento_w,
				nr_atendimento_w,
				cd_pessoa_fisica_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;

		select	coalesce(max(ie_dias_validade),'S'),
			coalesce(max(ie_atb_pessoa),'N')
		into STRICT	ie_dias_validade_w,
			ie_atb_pessoa_w
		from	parametro_medico
		where	cd_estabelecimento	= cd_estabelecimento_w;

		select coalesce(max('S'),'N')
		into STRICT	ie_mesma_vigencia_w
		from	prescr_medica a
		where	a.dt_validade_prescr = dt_validade_prescr_w
		and	coalesce(ie_dias_validade_w,'S') <> 'S'
		and	exists (SELECT 1
					   from  prescr_material b
					   where b.cd_material 	 = cd_material_p
					   and	 b.nr_prescricao = a.nr_prescricao
					   and	 coalesce(b.ie_suspenso,'N') <> 'S')
		and	a.nr_prescricao <> nr_prescricao_p
		and 	((a.nr_atendimento = nr_atendimento_w and ie_atb_pessoa_w = 'N') or (a.cd_pessoa_fisica = cd_pessoa_fisica_w and ie_atb_pessoa_w = 'S'));
		
		if (ie_mesma_vigencia_w = 'N') then
			ie_enable_w := 'S';
		else
			ie_enable_w := 'N';
		end if;
	end if;
else
	ie_enable_w := 'N';
end if;

return ie_enable_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_enable_qt_total_dias ( nr_dia_util_p bigint, qt_total_dias_lib_p bigint, ie_dias_util_medic_p text, nr_prescricao_p bigint, cd_material_p bigint) FROM PUBLIC;

