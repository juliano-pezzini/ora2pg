-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_hora_agenda_cons (cd_agenda_p bigint, dt_agenda_p timestamp) RETURNS varchar AS $body$
DECLARE


ds_horarios_w		varchar(4000);
ie_status_hora_w	varchar(05);
i			integer;
hr_inicial_w		timestamp;
hr_final_w		timestamp;
qt_agenda_w		bigint;
qt_livres_w		bigint;
qt_ocup_w		bigint;
qt_bloq_w		bigint;
qt_reserv_w		bigint;
qt_exec_w		bigint;
qt_confirmado_w	bigint;


BEGIN

select	to_date(to_char(trunc(dt_agenda_p, 'dd'),'dd/mm/yyyy') || ' 00:00:01',
			'dd/mm/yyyy hh24:mi:ss'),
	to_date(to_char(trunc(dt_agenda_p, 'dd'),'dd/mm/yyyy') || ' 00:59:59',
			'dd/mm/yyyy hh24:mi:ss')
into STRICT	hr_inicial_w,
	hr_final_w
;

for	i in 0 .. 23 loop
	begin

	select	count(*)
	into STRICT	qt_agenda_w
	from	agenda_consulta
	where	cd_agenda	= cd_agenda_p
	and	dt_agenda between hr_inicial_w and hr_final_w;

	if (qt_agenda_w = 0)  then
		ie_status_hora_w	:= 'S';
	else
		begin

		select	count(*)
		into STRICT	qt_confirmado_w
		from	agenda_consulta
		where	cd_agenda		= cd_agenda_p
		and	(dt_confirmacao IS NOT NULL AND dt_confirmacao::text <> '')
		and	dt_agenda between hr_inicial_w and hr_final_w;

		select	count(*)
		into STRICT	qt_livres_w
		from	agenda_consulta
		where	cd_agenda		= cd_agenda_p
		and	ie_status_agenda	in ('L','LF')
		and	dt_agenda between hr_inicial_w and hr_final_w;

		select	count(*)
		into STRICT	qt_reserv_w
		from	agenda_consulta
		where	cd_agenda		= cd_agenda_p
		and	ie_status_agenda	= 'R'
		and	dt_agenda between hr_inicial_w and hr_final_w;

		select	count(*)
		into STRICT	qt_bloq_w
		from	agenda_consulta
		where	cd_agenda		= cd_agenda_p
		and	ie_status_agenda	= 'B'
		and	dt_agenda between hr_inicial_w and hr_final_w;

		select	count(*)
		into STRICT	qt_exec_w
		from	agenda_consulta
		where	cd_agenda		= cd_agenda_p
		and	ie_status_agenda	= 'E'
		and	dt_agenda between hr_inicial_w and hr_final_w;



		if (qt_agenda_w = qt_confirmado_w) then
			ie_status_hora_w	:= 'F';
		elsif (qt_agenda_w = qt_exec_w) then
			ie_status_hora_w	:= 'E';
		elsif (qt_agenda_w = qt_reserv_w) then
			ie_status_hora_w	:= 'R';
		elsif (qt_agenda_w = qt_bloq_w) then
			ie_status_hora_w	:= 'B';
		elsif (qt_agenda_w = qt_livres_w) then
			ie_status_hora_w	:= 'L';
		elsif (qt_livres_w > 0) then
			ie_status_hora_w	:= 'N';
		elsif (qt_livres_w = 0) then
			ie_status_hora_w	:= 'O';
		end if;
		end;

	end if;


	ds_horarios_w	:= ds_horarios_w || to_char(i) || '=' || ie_status_hora_w || ';';

	if (i = 0) then
		select	to_date(to_char(trunc(dt_agenda_p, 'dd'),'dd/mm/yyyy') || ' 00:00:00',
				'dd/mm/yyyy hh24:mi:ss'),
		to_date(to_char(trunc(dt_agenda_p, 'dd'),'dd/mm/yyyy') || ' 00:59:59',
				'dd/mm/yyyy hh24:mi:ss')
		into STRICT	hr_inicial_w,
			hr_final_w
		;
	end if;


	select	to_date(to_char(trunc(hr_inicial_w, 'dd'),'dd/mm/yyyy') || ' ' || to_char(hr_inicial_w + 3600/86400, 'hh24:mi:ss'),
				'dd/mm/yyyy hh24:mi:ss'),
		to_date(to_char(trunc(hr_final_w, 'dd'),'dd/mm/yyyy') || ' ' || to_char(hr_final_w + 3600/86400, 'hh24:mi:ss'),
				'dd/mm/yyyy hh24:mi:ss')
	into STRICT	hr_inicial_w,
		hr_final_w
	;

	end;
end loop;

return ds_horarios_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_hora_agenda_cons (cd_agenda_p bigint, dt_agenda_p timestamp) FROM PUBLIC;

