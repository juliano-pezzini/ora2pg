-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION san_obter_qt_estoque ( cd_estabelecimento_p bigint, nr_seq_derivado_p bigint, nm_usuario_p text) RETURNS bigint AS $body$
DECLARE

 
ie_hemocomp_prod_fim_w	varchar(1);
ie_hemocomp_liberados_w	varchar(1);
qt_estoque_w		bigint;


BEGIN 
 
/* Hemoterapia - Parâmetro [230] - Considerar hemocomponentes como em estoque apenas após o recebimento do pré-estoque */
 
ie_hemocomp_prod_fim_w := obter_param_usuario(450, 230, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_hemocomp_prod_fim_w);
/* Hemoterapia - Parâmetro [47] - Visualizar Hemocomponentes liberados */
 
ie_hemocomp_liberados_w := obter_param_usuario(450, 47, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_hemocomp_liberados_w);
 
	SELECT 	COUNT(*) 
	INTO STRICT	qt_estoque_w 
	FROM 	san_producao_consulta_v a 
	WHERE 	coalesce(a.nr_seq_emp_saida::text, '') = '' 
	AND	coalesce(a.nr_seq_transfusao::text, '') = '' 
	AND	coalesce(a.nr_seq_inutil::text, '') = '' 
	AND	a.nr_seq_derivado = coalesce(nr_seq_derivado_p,a.nr_seq_derivado) 
	AND	coalesce(a.ie_encaminhado,'N') = 'N' 
	AND	(	(ie_hemocomp_prod_fim_w = 'N') OR 
			(	(ie_hemocomp_prod_fim_w = 'S') AND 
				(	(a.dt_recebimento IS NOT NULL AND a.dt_recebimento::text <> '' AND dt_liberacao_bolsa IS NOT NULL AND dt_liberacao_bolsa::text <> '') OR ((a.nr_seq_emp_ent IS NOT NULL AND a.nr_seq_emp_ent::text <> '') AND (coalesce(a.dt_inicio_prod_emprestimo::text, '') = '' OR (a.dt_fim_prod_emprestimo IS NOT NULL AND a.dt_fim_prod_emprestimo::text <> ''))) 
				) 
			) 
		) 
	AND	NOT EXISTS (SELECT	1 
				FROM	san_envio_derivado_val x, 
					san_envio_derivado z 
				WHERE	z.nr_sequencia		= x.nr_seq_envio 
				AND	x.nr_seq_producao	= a.nr_sequencia 
				AND	coalesce(x.dt_recebimento::text, '') = '') 
	AND	NOT EXISTS (SELECT	1 
				FROM	san_controle_qualidade x, 
					san_controle_qual_prod y 
				WHERE	x.nr_sequencia		= y.nr_seq_qualidade 
				AND	y.nr_seq_producao	= a.nr_sequencia 
				AND	coalesce(x.dt_liberacao::text, '') = '') 
	AND	a.ie_pai_reproduzido <> 'S' 
	AND	(	(ie_hemocomp_liberados_w = 'N') OR 
			(ie_hemocomp_liberados_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')) 
	AND	((coalesce(a.cd_estab_atual, coalesce(a.cd_estab_producao,a.cd_estabelecimento)) = cd_estabelecimento_p) OR (cd_estabelecimento_p = '0')) 
	;
 
 
RETURN	qt_estoque_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION san_obter_qt_estoque ( cd_estabelecimento_p bigint, nr_seq_derivado_p bigint, nm_usuario_p text) FROM PUBLIC;

