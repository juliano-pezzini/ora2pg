-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_glosa_proc (nr_seq_propaci_p bigint) RETURNS bigint AS $body$
DECLARE

 
vl_glosa_w		  double precision;
pr_glosa_w		  double precision;
qt_reg_regra_w	  bigint;
nr_interno_conta_w	  bigint;
vl_procedimento_w	  double precision;
cd_convenio_w		  bigint;
ie_tipo_atendimento_w smallint;
dt_alta_w		  timestamp;


BEGIN 
 
SELECT	nr_interno_conta, 
	vl_procedimento 
INTO STRICT	nr_interno_conta_w, 
	vl_procedimento_w 
FROM	procedimento_paciente 
WHERE	nr_sequencia	= nr_seq_propaci_p;
 
SELECT	COUNT(*) 
INTO STRICT	qt_reg_regra_w 
FROM	convenio_regra_glosa;
IF (qt_reg_regra_w > 0) THEN 
	BEGIN 
	SELECT	coalesce(MAX(a.cd_convenio_parametro),0), 
		MAX(b.ie_tipo_atendimento), 
		MAX(coalesce(dt_alta,clock_timestamp())) 
	INTO STRICT	cd_convenio_w, 
		ie_tipo_atendimento_w, 
		dt_alta_w 
	FROM 	atendimento_paciente b, 
		conta_paciente a 
	WHERE	a.nr_atendimento 	= b.nr_atendimento 
	AND	a.nr_interno_conta 	= nr_interno_conta_w;
	IF (cd_convenio_w > 0) THEN 
		BEGIN 
		SELECT	Obter_Perc_Glosa_Convenio(cd_convenio_w, ie_tipo_atendimento_w, dt_alta_w) 
		INTO STRICT	pr_glosa_w 
		;
		IF (pr_glosa_w	<> 0) THEN 
			vl_glosa_w	:= (coalesce(vl_procedimento_w,0)) * pr_glosa_w / 100;
		END IF;
		END;
	END IF;
	END;
END IF;
RETURN vl_glosa_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_glosa_proc (nr_seq_propaci_p bigint) FROM PUBLIC;

