-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_saldo_retorno ( NR_SEQ_RETORNO_P bigint, IE_CONSISTIR_P integer) RETURNS bigint AS $body$
DECLARE


vl_saldo_titulo_w		double precision := 0;


BEGIN

select sum(vl_saldo_titulo)
into STRICT vl_saldo_titulo_w
from (     SELECT sum(c.vl_saldo_titulo) vl_saldo_titulo
   from    titulo_receber c,
           conta_paciente b,
           convenio_retorno_item a
   where a.nr_interno_conta = b.nr_interno_conta
     and b.nr_seq_protocolo = c.nr_seq_protocolo
     and b.nr_interno_conta = c.nr_interno_conta
     and a.nr_seq_retorno = nr_seq_retorno_p

union all

   SELECT sum(c.vl_saldo_titulo) vl_saldo_titulo
   from    titulo_receber c,
           conta_paciente b,
           convenio_retorno_item a
   where a.nr_interno_conta = b.nr_interno_conta
     and b.nr_seq_protocolo = c.nr_seq_protocolo
     and coalesce(c.nr_interno_conta::text, '') = ''
     and a.nr_seq_retorno = nr_seq_retorno_p
   
union all

   select sum(c.vl_saldo_titulo) vl_saldo_titulo
   from    titulo_receber c,
           conta_paciente b,
           convenio_retorno_item a
   where a.nr_interno_conta = b.nr_interno_conta
     and a.nr_interno_conta = c.nr_interno_conta
     and coalesce(c.nr_seq_protocolo::text, '') = ''
     and a.nr_seq_retorno = nr_seq_retorno_p
   
union all

   select sum(b.vl_saldo_titulo) vl_saldo_titulo
   from    titulo_receber b,
           convenio_retorno_item a
   where a.nr_titulo = b.nr_titulo
     and a.nr_seq_retorno = nr_seq_retorno_p
     and coalesce(a.nr_interno_conta::text, '') = ''
	
union all
 --Incluido por lhalves em 22/01/2014 OS 653703 - Considerar o saldo do título gerado para o lote de protocolo
	select sum(c.vl_saldo_titulo) vl_saldo_titulo
	from    titulo_receber c,
		conta_paciente b,
		convenio_retorno_item a,
		protocolo_convenio d
	where 	a.nr_interno_conta 	= b.nr_interno_conta
	and	b.nr_seq_protocolo	= d.nr_seq_protocolo
	and	d.nr_seq_lote_protocolo	= c.nr_seq_lote_prot
	and	coalesce(c.nr_interno_conta::text, '') = ''
	and	coalesce(c.nr_seq_protocolo::text, '') = ''
	and 	a.nr_seq_retorno 	= nr_seq_retorno_p) alias11;

if (ie_consistir_p = 0) and (vl_saldo_titulo_w = 0) then
	-- Título baixado ou inexistente !
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266891);
end if;

RETURN vl_saldo_titulo_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_saldo_retorno ( NR_SEQ_RETORNO_P bigint, IE_CONSISTIR_P integer) FROM PUBLIC;

