-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_shoppingcart_medic_duplic (nr_sequencia_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p text, cd_material_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) RETURNS varchar AS $body$
DECLARE


ie_continuo_w	varchar(1) := 'N';
ds_retorno_w	varchar(1) := 'N';


BEGIN

if ((nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (dt_inicio_p IS NOT NULL AND dt_inicio_p::text <> '')) then

	if (dt_fim_p IS NOT NULL AND dt_fim_p::text <> '') then
		ie_continuo_w := 'S';
	end if;

	select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END  ie_duplicado
	into STRICT	ds_retorno_w
	from (
		SELECT 	a.dt_inicio,
				a.dt_fim dt_fim,
				a.ie_retrogrado,
				a.dt_liberacao
		from	cpoe_material_vig_v a
		where 	a.nr_sequencia <> coalesce(nr_sequencia_p,0)
		and		coalesce(a.ie_material,'N') = 'N'
		and		a.cd_material = cd_material_p
		and		a.cd_pessoa_fisica = cd_pessoa_fisica_p
		and		obter_se_cpoe_regra_duplic(a.ie_tipo_item, wheb_usuario_pck.get_cd_perfil, cd_setor_atendimento_p, cd_material_p) = 'S'
		and 	coalesce(obter_se_prescricao_cirurgia(obter_prescr_item_cpoe(a.nr_sequencia,a.ie_tipo_item, a.nr_atendimento, a.cd_pessoa_fisica)), 'N') <> 'S'
		and 	(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') OR (a.nm_usuario = wheb_usuario_pck.get_nm_usuario))
				and (obtain_user_locale(wheb_usuario_pck.get_nm_usuario) <> 'ja_JP' or (get_nr_seq_order_unit(nr_sequencia_p) <> get_nr_seq_order_unit(a.nr_sequencia))))
		and		a.ie_tipo_item not in ('MDIL', 'MRECONS', 'MRED')
		
union

		SELECT 	a.dt_inicio,
				a.dt_fim dt_fim,
				a.ie_retrogrado,
				a.dt_liberacao
		from	cpoe_material_vig_v a,	
				material b,
				material d
		where 	a.nr_sequencia <> coalesce(nr_sequencia_p,0)
		and		b.cd_material = a.cd_material
		and		coalesce(a.ie_material,'N') = 'N'
		and		a.cd_material <> cd_material_p
		and		d.cd_material = cd_material_p
		and		b.nr_seq_ficha_tecnica = d.nr_seq_ficha_tecnica
		and		a.cd_pessoa_fisica = cd_pessoa_fisica_p
		and		obter_se_cpoe_regra_duplic(a.ie_tipo_item, wheb_usuario_pck.get_cd_perfil, cd_setor_atendimento_p, cd_material_p) = 'S'
		and 	coalesce(obter_se_prescricao_cirurgia(obter_prescr_item_cpoe(a.nr_sequencia,a.ie_tipo_item, a.nr_atendimento, a.cd_pessoa_fisica)), 'N') <> 'S'
		and 	(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') OR (a.nm_usuario = wheb_usuario_pck.get_nm_usuario))
				and (obtain_user_locale(wheb_usuario_pck.get_nm_usuario) <> 'ja_JP' or (get_nr_seq_order_unit(nr_sequencia_p) <> get_nr_seq_order_unit(a.nr_sequencia))))
		and		a.ie_tipo_item not in ('MDIL', 'MRECONS', 'MRED')) x
	where 	((x.dt_inicio between dt_inicio_p and dt_fim_p) or (x.dt_fim between dt_inicio_p and dt_fim_p) or (coalesce(x.dt_fim::text, '') = '' and x.dt_inicio <= dt_inicio_p) or (x.dt_fim > coalesce(dt_fim_p,dt_inicio_p) and x.dt_inicio < dt_inicio_p) or
			 (((x.dt_inicio >  dt_inicio_p) and (coalesce(ie_continuo_w,'N') = 'S')) or ((coalesce(ie_continuo_w,'N') = 'N') 
			 and (dt_inicio_p <= x.dt_inicio)  and dt_fim_p > x.dt_inicio)) or (x.ie_retrogrado = 'S' and coalesce(x.dt_liberacao::text, '') = ''));
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_shoppingcart_medic_duplic (nr_sequencia_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p text, cd_material_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) FROM PUBLIC;

