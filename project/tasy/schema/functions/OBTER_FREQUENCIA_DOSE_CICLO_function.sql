-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_frequencia_dose_ciclo (nr_seq_paciente_p bigint, nr_ciclo_p bigint, cd_material_p bigint, cd_material_trat_p bigint default null, cd_intervalo_p text default null) RETURNS bigint AS $body$
DECLARE

			
qt_frequencia_w		integer := 0;	

cd_material_w		material.cd_material%type;		


BEGIN

cd_material_w := coalesce(cd_material_trat_p,cd_material_p);

select	count(1)
into STRICT	qt_frequencia_w
from	autorizacao_convenio a,
	material_autorizado m
where	a.nr_sequencia		= m.nr_sequencia_autor
and	m.cd_material		= cd_material_p
and	a.nr_seq_paciente_setor = nr_seq_paciente_p
and	(a.nr_seq_paciente IS NOT NULL AND a.nr_seq_paciente::text <> '')
and	a.nr_ciclo		= nr_ciclo_p
and ((cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') and m.cd_intervalo_medic_quimio = cd_intervalo_p);

if (qt_frequencia_w = 0) then

	select	count(1)
	into STRICT	qt_frequencia_w
	from	paciente_atend_medic a,
		paciente_atendimento m
	where	m.nr_seq_paciente		= nr_seq_paciente_p
	and	a.cd_material			= cd_material_w
	and	a.nr_seq_atendimento	  	= m.nr_seq_atendimento
	and	m.nr_ciclo			= nr_ciclo_p
	and ((cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') and a.cd_intervalo = cd_intervalo_p)
	and	exists (SELECT	1
			from	autorizacao_convenio x,
				material_autorizado y
			where	x.nr_ciclo = m.nr_ciclo
			and	y.nr_sequencia_autor 	= x.nr_sequencia
			and	y.cd_material  		= cd_material_p
			and	x.nr_seq_paciente_setor = m.nr_seq_paciente
			and	coalesce(x.nr_seq_paciente::text, '') = ''
			and ((cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') and y.cd_intervalo_medic_quimio = cd_intervalo_p));
end if;



return	qt_frequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_frequencia_dose_ciclo (nr_seq_paciente_p bigint, nr_ciclo_p bigint, cd_material_p bigint, cd_material_trat_p bigint default null, cd_intervalo_p text default null) FROM PUBLIC;

