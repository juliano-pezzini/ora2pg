-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_correcao_monet ( cd_moeda_p moeda.cd_moeda%type, vl_recebido_p titulo_receber_liq.vl_recebido%type, dt_vencimento_p titulo_receber.dt_pagamento_previsto%type, dt_recebimento_p titulo_receber_liq.dt_recebimento%type) RETURNS bigint AS $body$
DECLARE


/*OS 1811433
- Função criada para calcular e retornar o valor de correcao monetaria com base nos indices cadastrados para a moeda, e com base no período.
- A pedido do cliente, o cálculo ocorrerá sempre considerando o mês anterior ao mes da data de recebimento, pois o índice é publicado no meio do mês, e recebimentos efetuados no antes dessa publicação poderiam ter problemas no cálculo. Diante disso, foi
  acordado junto ao cliente que sempre será considerado o mês anterior ao mês do recebimento. 
*/
									
									   
vl_correcao_monetaria_w			titulo_receber_liq.vl_correcao_monetaria%type;	
vl_cotacao_w					cotacao_moeda.vl_cotacao%type;	
vl_cotacao_venc_w				cotacao_moeda.vl_cotacao%type;	
dt_vencimento_w					timestamp;
dt_recebimento_w				timestamp;
vl_total_cotacao_w				cotacao_moeda.vl_cotacao%type;

C01 CURSOR FOR
	SELECT	a.vl_cotacao
	from	cotacao_moeda a
	where	cd_moeda = cd_moeda_p
	and		trunc(a.dt_cotacao, 'month') = trunc(dt_vencimento_w,'month')
	order by a.dt_cotacao asc;			
									

BEGIN

dt_vencimento_w 	:=  dt_vencimento_p;
dt_recebimento_w	:=	dt_recebimento_p;

while(trunc(dt_vencimento_w,'month') < trunc(dt_recebimento_w,'month')) loop

	/*Cursor para pegar o valor da cotacao da maior data de cotacao para a moeda*/

	vl_cotacao_w := null;
	open C01;
	loop
	fetch C01 into	
		vl_cotacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		vl_cotacao_w := vl_cotacao_w;
		end;
	end loop;
	close C01;

	vl_total_cotacao_w	:= coalesce(vl_total_cotacao_w,0) + vl_cotacao_w;
	dt_vencimento_w 	:= add_months(dt_vencimento_w,1);

end loop;

vl_total_cotacao_w := coalesce(vl_recebido_p,0) * (vl_total_cotacao_w / 100);

return	vl_total_cotacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_correcao_monet ( cd_moeda_p moeda.cd_moeda%type, vl_recebido_p titulo_receber_liq.vl_recebido%type, dt_vencimento_p titulo_receber.dt_pagamento_previsto%type, dt_recebimento_p titulo_receber_liq.dt_recebimento%type) FROM PUBLIC;

