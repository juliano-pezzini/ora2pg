-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_agendas_lib_user_ageserv ( ds_agenda_lista_p text, nm_usuario_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ie_estab_user_w	varchar(1);
ie_perfil_usuario_w	varchar(1);
ie_setor_user_w	varchar(1);
ds_sql_w		varchar(4000);
ds_parametros_w	varchar(2000);
ds_retorno_w	varchar(2000);


BEGIN

ds_sql_w		:= '';
ds_parametros_w	:= '';

ds_sql_w	:= ds_sql_w || ' select	a.cd_agenda ';
ds_sql_w	:= ds_sql_w || ' from	agenda a ';
ds_sql_w	:= ds_sql_w || ' where	a.ie_situacao = '|| chr(39) || 'A' || chr(39);

/* Agenda de Servicos - Parametro [22] - Exibir somente as agendas do estabelecimento do usuario */

ie_estab_user_w := obter_param_usuario(866, 22, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_estab_user_w);

if (ie_estab_user_w = 'S') then
	begin
	ds_sql_w		:= ds_sql_w || ' and a.cd_estabelecimento = :cd_estabelecimento_p ';
	ds_parametros_w	:= ds_parametros_w || 'cd_estabelecimento_p=' || cd_estabelecimento_p;
	end;
else
	begin
	ds_sql_w		:= ds_sql_w || ' and a.cd_estabelecimento in (select x.cd_estabelecimento from usuario_estabelecimento x where x.nm_usuario_param = :nm_usuario_p) ';
	ds_parametros_w	:= ds_parametros_w || 'nm_usuario_p=' || nm_usuario_p;
	end;
end if;

/* Agenda de Servicos - Parametro [87] - Exibir somente as agendas do perfil do usuario */

ie_perfil_usuario_w := obter_param_usuario(866, 87, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_perfil_usuario_w);

if (ie_perfil_usuario_w = 'S') then
	begin
	ds_sql_w		:= ds_sql_w || ' and a.cd_perfil_exclusivo in (select x.cd_perfil from usuario_perfil x where x.nm_usuario = :nm_usuario_p) ';
	ds_parametros_w	:= ds_parametros_w || ';nm_usuario_p=' || nm_usuario_p;
	end;
end if;

/* Agenda de Servicos - Parametro [46] - Forma de exibir as agendas */

ie_setor_user_w := obter_param_usuario(866, 46, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_setor_user_w);

if (ie_setor_user_w = 'S') then
	begin
	ds_sql_w		:= ds_sql_w || ' and a.cd_setor_exclusivo in (select x.cd_perfil from usuario_perfil x where x.nm_usuario = :nm_usuario_p) ';
	ds_parametros_w	:= ds_parametros_w || ';nm_usuario_p=' || nm_usuario_p;
	end;
elsif (ie_setor_user_w = 'N') then
	ds_sql_w		:= ds_sql_w || ' and a.cd_setor_exclusivo is null ';
end if;

ds_sql_w		:= ds_sql_w || ' and substr(obter_se_contido(a.cd_agenda, ' || chr(39) || ds_agenda_lista_p || chr(39) || '), 1,1) = ' || chr(39) || 'S' || chr(39);

ds_retorno_w	:= obter_select_concatenado_bv(ds_sql_w, ds_parametros_w, ',');

return	ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_agendas_lib_user_ageserv ( ds_agenda_lista_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

