-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gel_obter_envelope_exame ( nr_seq_prescricao_p bigint, nr_prescricao_p bigint, nr_seq_exame_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

/*
ie_opcao_p
 E - Sequência do envelope
 L - Sequência do laudo no envelope
*/
nr_sequencia_w			bigint;
nr_seq_envelope_w		bigint;
ie_anatomia_w			varchar(1) := 'N';


BEGIN

if (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') then

	select 	max(coalesce(ie_anatomia_patologica,'N'))
	into STRICT	ie_anatomia_w
	from	exame_laboratorio
	where 	nr_seq_exame = nr_seq_exame_p;
end if;

if (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') and (ie_anatomia_w <> 'S') then
	select	max(a.nr_seq_envelope),
		max(a.nr_sequencia)
	into STRICT	nr_seq_envelope_w,
		nr_sequencia_w
	from	envelope_laudo_item a,
		result_laboratorio c
	where	a.nr_seq_result_lab = c.nr_sequencia
	and	c.nr_seq_prescricao = nr_seq_prescricao_p
	and	c.nr_prescricao = nr_prescricao_p;
else
	/*
	select	max(a.nr_seq_envelope),
		max(a.nr_sequencia)
	into	nr_seq_envelope_w,
		nr_sequencia_w
	from	envelope_laudo_item a,
		laudo_paciente c
	where	a.nr_seq_laudo = c.nr_sequencia
	and	c.nr_seq_prescricao = nr_seq_prescricao_p
	and	c.nr_prescricao = nr_prescricao_p;
	*/
	select	max(a.nr_seq_envelope),
		max(a.nr_sequencia)
	into STRICT	nr_seq_envelope_w,
		nr_sequencia_w
	from	envelope_laudo_item a
	where	a.nr_seq_prescr = nr_seq_prescricao_p
	and	a.nr_prescricao = nr_prescricao_p
	and	(a.nr_seq_laudo IS NOT NULL AND a.nr_seq_laudo::text <> '')
	and	coalesce(a.nr_seq_result_lab::text, '') = '';


end if;

if (ie_opcao_p = 'E') then
	return nr_seq_envelope_w;
else
	return	nr_sequencia_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gel_obter_envelope_exame ( nr_seq_prescricao_p bigint, nr_prescricao_p bigint, nr_seq_exame_p bigint, ie_opcao_p text) FROM PUBLIC;

