-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_horarios_compativeis ( nr_seq_agenda_p bigint, cd_pessoa_fisica_p bigint, dt_agenda_p timestamp, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

ie_agenda_tre_w	 bigint;
ds_retorno_w	 varchar(1) := 'S';

BEGIN

select	count(*)
into STRICT	ie_agenda_tre_w
from	tre_inscrito b,
		tre_evento c,
		tre_agenda_turno d,
		tre_agenda e
where	b.nr_seq_evento = c.nr_sequencia
and		d.nr_seq_agenda_tre = e.nr_sequencia
and		e.nr_sequencia = c.nr_seq_agenda
and		coalesce(b.DT_DESISTENCIA::text, '') = ''
and		b.cd_pessoa_fisica = cd_pessoa_fisica_p
and		((tre_valida_se_dia_curso(c.nr_sequencia,fim_dia(dt_agenda_p)) = 'S') or ((tre_obter_dados_pac_dia(b.nr_sequencia,dt_agenda_p,'CA'))::numeric  > 0))
and (substr(tre_obter_se_data_fim_valida(dt_agenda_p,c.nr_sequencia,c.dt_fim_real,c.dt_fim),1,1) = 'S')
and		fim_dia(dt_agenda_p) >= c.dt_inicio
and (obter_se_feriado(c.cd_estabelecimento, dt_agenda_p) = 0)
and		not exists (	SELECT	1
						from	tre_agenda v
						where	v.nr_sequencia = c.nr_seq_agenda
						and	(v.dt_cancelamento IS NOT NULL AND v.dt_cancelamento::text <> ''))
and		((d.ie_dia_semana = Obter_Cod_Dia_Semana(dt_agenda_p)) or (d.ie_dia_semana = 9 and Obter_Cod_Dia_Semana(dt_agenda_p) not in (7,1)))
and		to_date('30/12/1899 '|| to_char(dt_agenda_p,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') between d.hr_inicial and d.hr_final
and		((dt_agenda_p between d.dt_inicio_vigencia and fim_dia(d.dt_fim_vigencia)) or ((coalesce(d.dt_inicio_vigencia::text, '') = '') or (coalesce(d.dt_fim_vigencia::text, '') = '')));

if (ie_agenda_tre_w > 0) then
	if (ie_opcao_p = 'C') then
		ds_retorno_w:= 'N';
	else
		if (ie_opcao_p = 'P')then
			ds_retorno_w:= 'N';
		end if;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_horarios_compativeis ( nr_seq_agenda_p bigint, cd_pessoa_fisica_p bigint, dt_agenda_p timestamp, ie_opcao_p text) FROM PUBLIC;

