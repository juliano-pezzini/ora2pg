-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION plt_obter_se_item_periodo ( dt_inicio_val_p timestamp, dt_fim_val_p timestamp, ie_filtro_plano_p text, dt_plano_p text, dt_horario_p timestamp, dt_inicio_hor_p timestamp, dt_fim_hor_p timestamp, ie_prescr_usuario_p text, nm_usuario_p text, ie_estendidos_p bigint, dt_referencia_p timestamp, ie_edicao_p text, ie_exibir_suspensos_p text, dt_suspensao_p timestamp, ie_tipo_item_p text, nr_seq_item_p bigint, nr_prescricao_p bigint, ie_tipo_p text) RETURNS varchar AS $body$
DECLARE


/*
ie_tipo_p
O - cursor do obter_item
H - cursor do obter_horarios
S - cursor do sincronizar
*/
						
						
ie_exibe_w				varchar(1) := 'N';
ie_acm_sn_w				varchar(1) := 'N';
dt_rep_pt_w				timestamp;
dt_rep_pt2_w			timestamp;
dt_inicio_prescr_w		timestamp;
dt_validade_prescr_w	timestamp;
dt_liberacao_medico_w	timestamp;
dt_liberacao_w			timestamp;
dt_liberacao_farmacia_w	timestamp;
ie_hemodialise_w		varchar(15);
nm_usuario_original_w	varchar(15);
dt_extensao_w			timestamp;
ie_status_w				varchar(10) := 'X';
ie_urgencia_w			varchar(1) := 'N';
ie_horario_urgente_w	varchar(1) := 'N';
dt_prescricao_w			timestamp;
ie_horario_adm_w		varchar(1) := 'N';
cd_pessoa_usuario_w		varchar(10);
ie_emergencia_w			varchar(1)	:= 'N';
ie_cartao_emergencia_w	varchar(1)	:= 'N';
cd_medico_w				varchar(10)	:= '';
ie_dose_especial_w		varchar(1)	:= 'N';
ie_dose_espec_agora_w	varchar(1)	:= 'N';
ie_prescritor_aux_w		varchar(1)	:= 'N';
ie_inicio_w				prescr_gasoterapia.ie_inicio%type;
hr_prim_horario_w		nut_pac.hr_prim_horario%type;


BEGIN

select	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_usuario_w
from	usuario
where	nm_usuario	= nm_usuario_p;

if (ie_tipo_item_p	= 'E') then

	select	max(dt_rep_pt),
		max(dt_rep_pt2),
		max(dt_inicio_prescr),
		max(dt_validade_prescr),
		max(dt_liberacao),
		max(dt_liberacao),
		max(dt_liberacao),
		max(nm_usuario_nrec),
		max(dt_prescricao)
	into STRICT	dt_rep_pt_w,
		dt_rep_pt2_w,
		dt_inicio_prescr_w,
		dt_validade_prescr_w,
		dt_liberacao_w,
		dt_liberacao_medico_w,
		dt_liberacao_farmacia_w,
		nm_usuario_original_w,
		dt_prescricao_w
	from	pe_prescricao
	where	nr_sequencia	= nr_prescricao_p;

else

	select	max(dt_rep_pt),
		max(dt_rep_pt2),
		max(dt_inicio_prescr),
		coalesce(max(dt_validade_prescr),max(dt_inicio_prescr)),
		max(dt_liberacao),
		max(dt_liberacao_medico),
		max(dt_liberacao_farmacia),
		max(nm_usuario_original),
		max(dt_prescricao),
		max(ie_hemodialise),
		coalesce(max(ie_emergencia),'N'),
		coalesce(max(ie_cartao_emergencia),'N'),
		max(cd_medico),
		coalesce(max(ie_prescritor_aux),'N')
	into STRICT	dt_rep_pt_w,
		dt_rep_pt2_w,
		dt_inicio_prescr_w,
		dt_validade_prescr_w,
		dt_liberacao_w,
		dt_liberacao_medico_w,
		dt_liberacao_farmacia_w,
		nm_usuario_original_w,
		dt_prescricao_w,
		ie_hemodialise_w,
		ie_emergencia_w,
		ie_cartao_emergencia_w,
		cd_medico_w,
		ie_prescritor_aux_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;

end if;

if (ie_tipo_item_p	in ('IAG','IA','MAT','M','SNE','S','LD')) then

	select	max(obter_se_acm_sn(ie_acm, ie_se_necessario)),
		max(dt_extensao),
		coalesce(max(ie_urgencia),'N'),
		max(obter_se_possui_hor_adm(nr_prescricao,nr_sequencia,ie_tipo_item_p)),
		coalesce(max(ie_dose_espec_agora),'N')
	into STRICT	ie_acm_sn_w,
		dt_extensao_w,
		ie_urgencia_w,
		ie_horario_adm_w,
		ie_dose_espec_agora_w
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;
	
	ie_horario_urgente_w	:= 'N';
	
	if (ie_urgencia_w	= 'S') then
		select	coalesce(max('S'),'N')
		into STRICT	ie_horario_urgente_w
		from	prescr_mat_hor
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_material = nr_seq_item_p
		and	dt_horario	between dt_inicio_hor_p and dt_fim_hor_p
		and	coalesce(ie_horario_especial,'N') = 'N'
		and	ie_urgente = 'S'
		and	ie_urgencia_w = 'S';
	end if;
	
	ie_dose_especial_w	:= 'N';
	
	if (ie_dose_espec_agora_w	= 'S') then
	
		select	coalesce(max('S'),'N')
		into STRICT	ie_dose_especial_w
		from	prescr_mat_hor
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_material = nr_seq_item_p
		and	dt_horario	between dt_inicio_hor_p and dt_fim_hor_p
		and	coalesce(ie_horario_especial,'N') = 'N'
		and	ie_dose_especial = 'S'
		and	ie_dose_espec_agora_w = 'S';	
	
	end if;
	
elsif (ie_tipo_item_p	in ('G','C','HM','I','P','L')) then

	select	max(obter_se_acm_sn(ie_acm, ie_se_necessario)),
		max(dt_extensao),
		max(ie_status),
		coalesce(max(ie_urgencia),'N'),
		max(obter_se_possui_hor_adm(nr_prescricao,nr_sequencia,ie_tipo_item_p))
	into STRICT	ie_acm_sn_w,
		dt_extensao_w,
		ie_status_w,
		ie_urgencia_w,
		ie_horario_adm_w
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;
	
	ie_horario_urgente_w	:= 'N';
	
	if (ie_urgencia_w	= 'S') then
	
		select	coalesce(max('S'),'N')
		into STRICT	ie_horario_urgente_w
		from	prescr_proc_hor
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_procedimento = nr_seq_item_p
		and	dt_horario	between dt_inicio_hor_p and dt_fim_hor_p
		and	coalesce(ie_horario_especial,'N') = 'N'
		and	ie_urgente = 'S'
		and	ie_urgencia_w = 'S';	
	
	end if;
	
elsif (ie_tipo_item_p	in ('DI','SOL')) then

	select	max(obter_se_acm_sn(ie_acm, ie_se_necessario)),
		max(dt_extensao),
		max(ie_status),
		coalesce(max(ie_urgencia),'N'),
		max(obter_se_possui_hor_adm(nr_prescricao,nr_seq_solucao,ie_tipo_item_p))
	into STRICT	ie_acm_sn_w,
		dt_extensao_w,
		ie_status_w,
		ie_urgencia_w,
		ie_horario_adm_w
	from	prescr_solucao
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_solucao	= nr_seq_item_p;
	
	ie_horario_urgente_w	:= 'N';
	
	if (ie_urgencia_w	= 'S') then
	
		select	coalesce(max('S'),'N')
		into STRICT	ie_horario_urgente_w
		from	prescr_mat_hor
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_solucao = nr_seq_item_p
		and	dt_horario	between dt_inicio_hor_p and dt_fim_hor_p
		and	coalesce(ie_horario_especial,'N') = 'N'
		and	ie_urgente = 'S'
		and	ie_urgencia_w = 'S';	
	end if;
	
elsif (ie_tipo_item_p	in ('D')) then

	select	max(dt_extensao),
		coalesce(max(ie_urgencia),'N'),
		max(obter_se_possui_hor_adm(nr_prescricao,nr_sequencia,ie_tipo_item_p))
	into STRICT	dt_extensao_w,
		ie_urgencia_w,
		ie_horario_adm_w
	from	prescr_dieta
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;
	
elsif (ie_tipo_item_p	in ('O')) then

	select	max(dt_extensao),
			max(ie_inicio)
	into STRICT	dt_extensao_w,
			ie_inicio_w
	from	prescr_gasoterapia
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;

	if (ie_inicio_w in ('ACM','D')) then
		ie_acm_sn_w := 'S';
	end if;
	
elsif (ie_tipo_item_p	in ('J')) then

	select	max(dt_extensao)
	into STRICT	dt_extensao_w
	from	rep_jejum
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;
	
elsif (ie_tipo_item_p	in ('R')) then

	select	max(obter_se_acm_sn(ie_acm, ie_se_necessario)),
		max(dt_extensao),
		coalesce(max(ie_urgencia),'N'),
		max(obter_se_possui_hor_adm(nr_prescricao,nr_sequencia,ie_tipo_item_p))
	into STRICT	ie_acm_sn_w,
		dt_extensao_w,
		ie_urgencia_w,
		ie_horario_adm_w
	from	prescr_recomendacao
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;
	
elsif (ie_tipo_item_p	in ('NAN','NPN','NPP')) then

	select	max(dt_extensao),
			max(ie_status),
			max(hr_prim_horario)
	into STRICT	dt_extensao_w,
			ie_status_w,
			hr_prim_horario_w
	from	nut_pac
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;
	
end if;	

if (coalesce(dt_extensao_w::text, '') = '') then
	dt_extensao_w := dt_validade_prescr_w;
end if;

if	((dt_validade_prescr_w	between dt_inicio_val_p and dt_fim_val_p) or (ie_tipo_item_p	= 'SOL') or (ie_hemodialise_w in ('S','E'))) and
	((((coalesce(dt_liberacao_medico_w,dt_liberacao_w) IS NOT NULL AND (coalesce(dt_liberacao_medico_w,dt_liberacao_w))::text <> '')) and (ie_prescr_usuario_p	= 'N')) or (nm_usuario_original_w	= nm_usuario_p) or
	 ((cd_medico_w		= cd_pessoa_usuario_w) and
	  ((ie_emergencia_w	= 'S') or (ie_cartao_emergencia_w = 'S') or (ie_prescritor_aux_w = 'S')))) and
	(((ie_estendidos_p = 0) and (PLT_obter_se_estendido(dt_extensao_w,dt_referencia_p) = 'S')) or
	 ((ie_estendidos_p = 1) and (PLT_obter_se_estendido(dt_extensao_w,dt_referencia_p) = 'N')) or (ie_estendidos_p = 2) or (ie_tipo_item_p	in ('E','DI'))) and
	(((ie_edicao_p = 'S') and (plt_obter_se_liberado(dt_liberacao_medico_w,dt_liberacao_w,dt_liberacao_farmacia_w) = 'N')) or (ie_edicao_p = 'N')) and
	((ie_exibir_suspensos_p = 'S') or (coalesce(dt_suspensao_p::text, '') = '') or
	 (ie_exibir_suspensos_p = 'A' AND ie_horario_adm_w	= 'S')) then
	begin
	
	if (ie_tipo_item_p		in ('HM','NAN','NPP','SNE','SOL')) and (ie_status_w		in ('INT','I')) and (ie_tipo_p		<> 'H') then

		ie_exibe_w	:= 'S';
	
	elsif (coalesce(ie_acm_sn_w,'N')	= 'S') and (ie_tipo_p		<> 'H') and
		  ((obter_se_prescr_vig_adep(dt_inicio_prescr_w,coalesce(dt_validade_prescr_w,clock_timestamp()),dt_inicio_hor_p,dt_fim_hor_p) = 'S') or (ie_tipo_item_p = 'O')) then
	
		ie_exibe_w	:= 'S';	
	
	elsif (coalesce(ie_acm_sn_w,'N')	= 'N') or (ie_tipo_p		= 'H') then
	
		if (ie_filtro_plano_p	= 'R') and (ie_tipo_p <> 'H') and
			((to_char(dt_rep_pt_w,'dd/mm/yyyy') = dt_plano_p) or (to_char(dt_rep_pt2_w,'dd/mm/yyyy') = dt_plano_p) or (ie_dose_especial_w = 'S') or (ie_horario_urgente_w = 'S')) then
		
			ie_exibe_w	:= 'S';
				
		elsif	((ie_filtro_plano_p	= 'S') or (ie_tipo_p		= 'H')) and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') and
			    (((dt_horario_p	between dt_inicio_hor_p and dt_fim_hor_p) or
				  ((ie_tipo_item_p in ('NPN','NAN')) and (ie_status_w in ('T')) and (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') and (pkg_date_utils.get_time(dt_inicio_prescr_w,hr_prim_horario_w) between dt_inicio_hor_p and dt_fim_hor_p))) or (ie_urgencia_w	= 'S') or (ie_dose_especial_w = 'S') or (ie_tipo_item_p in ('O','P'))) then

			if (ie_filtro_plano_p	= 'R') then
				
				if	((to_char(dt_rep_pt_w,'dd/mm/yyyy') = dt_plano_p) or (to_char(dt_rep_pt2_w,'dd/mm/yyyy') = dt_plano_p) or
					 ((ie_tipo_p		= 'H') and (dt_horario_p	between dt_prescricao_w and dt_fim_hor_p) and
					  ((ie_urgencia_w	= 'S') or (ie_dose_especial_w = 'S') or (ie_tipo_item_p	in ('O','P','SOL'))))) then
					
					ie_exibe_w	:= 'S';
					
				end if;	
				
			elsif	((dt_horario_p	between dt_inicio_hor_p and dt_fim_hor_p) or
					 ((ie_tipo_item_p in ('NPN','NAN')) and (ie_status_w in ('T')) and (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') and (pkg_date_utils.get_time(dt_inicio_prescr_w,hr_prim_horario_w) between dt_inicio_hor_p and dt_fim_hor_p))) then
			
				ie_exibe_w	:= 'S';

			end if;	
			
		elsif (ie_status_w	not in ('N','T')) and (ie_tipo_item_p	in ('DI')) and (ie_tipo_p	<> 'H') then
			
			ie_exibe_w	:= 'S';
		
		elsif (ie_tipo_item_p	= 'O') and (coalesce(dt_horario_p::text, '') = '') then
		
			ie_exibe_w	:= 'S';		
		
		elsif (ie_tipo_item_p	= 'SOL') then
		
			select	CASE WHEN count(nr_sequencia)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_exibe_w
			from	prescr_mat_hor
			where	nr_prescricao	= nr_prescricao_p
			and	nr_seq_solucao	= nr_seq_item_p
			and	dt_horario	between dt_inicio_hor_p and dt_fim_hor_p;
			
		elsif (ie_tipo_item_p	= 'HM') then
			
			select	CASE WHEN count(nr_sequencia)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_exibe_w
			from	prescr_proc_hor
			where	nr_prescricao = nr_prescricao_p
			and		nr_seq_procedimento = nr_seq_item_p
			and		dt_horario	between dt_inicio_hor_p and dt_fim_hor_p;			
		
		end if;
	
	end if;
	
	end;
end if;

return	ie_exibe_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION plt_obter_se_item_periodo ( dt_inicio_val_p timestamp, dt_fim_val_p timestamp, ie_filtro_plano_p text, dt_plano_p text, dt_horario_p timestamp, dt_inicio_hor_p timestamp, dt_fim_hor_p timestamp, ie_prescr_usuario_p text, nm_usuario_p text, ie_estendidos_p bigint, dt_referencia_p timestamp, ie_edicao_p text, ie_exibir_suspensos_p text, dt_suspensao_p timestamp, ie_tipo_item_p text, nr_seq_item_p bigint, nr_prescricao_p bigint, ie_tipo_p text) FROM PUBLIC;

