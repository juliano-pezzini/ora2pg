-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_descricao_rps ( cd_estabelecimento_p bigint, nr_seq_nota_p bigint, ds_atributo_p text, ie_ponto_virgula_p text default 'V', qtd_casas_decimais_p bigint default 2, nr_seq_item_p bigint default 0) RETURNS varchar AS $body$
DECLARE


/*
ds_atributo_p =  o atributo do arquivo que corresponde a descricao, hoje tratamento somente o ds_servicos

Dom - 2706:
1 - CD_ITEM
2 - DS_ITEM
3 - QT_ITEM
4 - DS_OBS_NOTA
5 - DS_PERIODO_CONTA
6 - DS_CONTAS_PROTOCOLO
7 - NR_SEQ_PROTOCOLO
8 - NM_PACIENTE
9 - DS_SETOR_ATENDIMENTO
10 - NR_CPF
11 - NR_PROTOCOLO
12 - DS_COMPL_ITEM_NF
13 - NR_NOTA_FISCAL
14 - VL_ITEM
15 - DT_ENTRADA (ATENDIMENTO_PACIENTE)
16 - NR_INTERNO_CONTA
17 - NR_ATENDIMENTO
18 - NM_PESSOA_ATENDIMENTO
19 - DT_NASCIMENTO_PACIENTE
20 - VL_TOTAL_ITEM_NF
21 - NM_PAGADOR
22 - NR_CPF_PAGADOR
23 - NR_CNPJ_PAGADOR
24 - DT_VENCIMENTO
25 - NM_MEDICO
26 - DS_ESPECIALIDADE
27 - NR_CRM
28 - VL_TOTAL_NOTA
29 - DS_PROCON
30 - VL_LIQUIDO	-- criado por mhbarth
31 - DS_TEXTO_PADRAO
32 - VL_ATO_COOPERADO_PRINCIPAL
33 - VL_ATO_COOPERADO_AUXILIAR
56 - NR_TITULO (Ttulo da conta paciente)
34 - DS_TRIBUTO
61 - DS_OBS_PROTOCOLO_CONVENIO
62 - DS_TRIBUTO_CSLL
63 - VL_TRIBUTO_CSLL
64 - TX_TRIBUTO_CSLL
65 - VL_SALDO_TIT_RECEBER
66 - PR_FONTE_IBPT
67 - VL_FONTE_IBPT
73 - VL_FONTE_IBPT_FED
74 - VL_FONTE_IBPT_EST
75 - VL_FONTE_IBPT_MUN
76 - PR_FONTE_IBPT_FED
77 - PR_FONTE_IBPT_EST
78 - PR_FONTE_IBPT_MUN
79 - NR_FATURA
80 - VL_BASE_CALCULO_IR
81 - TX_TRIBUTO_ITEM_ISS
82 - VL_COPARTICIPACAO
*/
qt_existe_w			integer;
ds_retorno_w			varchar(2000)	:= '';
ds_regra_w			varchar(15);
ds_item_w			varchar(255);
cd_item_w			bigint;
qt_item_w			double precision;
vl_item_w			double precision;
vl_total_item_nf_w		double precision;
ie_ordem_w			integer;
nr_seq_protocolo_w		bigint;
cd_convenio_w			integer;
ds_contas_protocolo_w		varchar(2000);
nm_paciente_w			varchar(255);
qt_regra_convenio_w		bigint	:=0;
qt_regra_cgc_w			bigint	:=0;
qt_regra_operacao_nf_w		bigint	:=0;
ds_setor_atendimento_w		varchar(255);
ie_caracter_ant_w		varchar(255);
ie_caracter_pos_w		varchar(255);
nr_cpf_w			varchar(11);
nr_protocolo_w			varchar(40);
ds_complemento_w		varchar(255);
nr_nota_fiscal_w		varchar(255);
nr_interno_conta_w		bigint;
nr_atendimento_w		bigint;
nm_pessoa_atendimento_w		varchar(255);
dt_nascimento_paciente_w	varchar(255);
nm_pagador_w			varchar(255);
nr_cpf_pagador_w		varchar(20);
nr_cnpj_pagador_w		varchar(20);
dt_vencimento_w			timestamp;
nm_medico_w			varchar(255);
ds_especialidade_w		varchar(255);
nr_crm_w			varchar(255);
vl_total_nota_w			double precision;
vl_descontos_w			double precision;
vl_descontos_item_w		double precision;
ds_periodo_conta_w		varchar(255);
ds_observacao_w			varchar(2000);
dt_periodo_inicial_w		varchar(80);
dt_periodo_final_w		varchar(80);
ds_procom_w			varchar(1000);
vl_liquido_w			double precision;
ds_texto_padrao_w		varchar(1000);
vl_ato_principal_w		double precision;
vl_ato_auxiliar_w		double precision;
qt_nr_atendimento_w		bigint;
ds_tributo_pis_w		varchar(40);
vl_tributo_pis_w		double precision;
tx_tributo_pis_w		double precision;
ds_tributo_cofins_w		varchar(40);
vl_tributo_cofins_w		double precision;
tx_tributo_cofins_w		double precision;
ds_tributo_icms_w		varchar(40);
vl_tributo_icms_w		double precision;
tx_tributo_icms_w		double precision;
ds_tributo_iss_w		varchar(40);
vl_tributo_iss_w		double precision;
tx_tributo_iss_w		double precision;
ds_tributo_ir_w			varchar(40);
vl_tributo_ir_w			double precision;
tx_tributo_ir_w			double precision;
ds_tributo_inss_w		varchar(40);
vl_tributo_inss_w		double precision;
tx_tributo_inss_w		double precision;
vl_base_calculo_inss_w		double precision;
nr_seq_mensalidade_w		bigint;
ie_tipo_lote_mens_w		varchar(2);
vl_ato_nao_coop_w		double precision;
nr_protocolo_ans_w		varchar(20);
ds_plano_w			varchar(80);
vl_total_tributos_w		double precision;
tx_total_tributos_w		double precision;
vl_total_item_trib_w		double precision;
tx_total_item_trib_w		double precision;
vl_total_trib_percent_w		double precision;
ds_obs_prot_convenio_w		varchar(800);
ds_tributo_csll_w		varchar(40);
vl_tributo_csll_w		double precision;
tx_tributo_csll_w		double precision;
vl_saldo_tit_receber_w		double precision;
vl_total_ibpt_w			double precision;
cd_cgc_w			nota_fiscal.cd_cgc%type;
ie_saldo_tit_maior_zero_w	regra_descricao_rps.ie_saldo_tit_maior_zero%type;
ie_exporta_trib_inf_adic_w	regra_descricao_rps.ie_exporta_trib_inf_adic%type;
cd_proc_item_w			nota_fiscal_item.cd_procedimento%type;
ie_orig_proc_w	 		nota_fiscal_item.ie_origem_proced%type;
nr_seq_servico_item_w		grupo_servico_item.nr_sequencia%type;
pr_fonte_ibpt_w			grupo_servico_item.pr_fonte_ibpt%type;
vl_total_bruto_nota_w		nota_fiscal.vl_mercadoria%type;
ie_retem_pis_w			nota_fiscal_trib.ie_retencao%type;
ie_retem_cofins_w		nota_fiscal_trib.ie_retencao%type;
ie_retem_icms_w			nota_fiscal_trib.ie_retencao%type;
ie_retem_iss_w			nota_fiscal_trib.ie_retencao%type;
ie_retem_ir_w			nota_fiscal_trib.ie_retencao%type;
ie_retem_inss_w			nota_fiscal_trib.ie_retencao%type;
ie_retem_csll_w			nota_fiscal_trib.ie_retencao%type;
cd_operacao_nf_w		operacao_nota.cd_operacao_nf%type;
ie_txt_inf_adic_w		regra_descricao_rps.ie_txt_inf_adic%type;
dt_competencia_mens_w		timestamp;
nr_titulo_mensalidade_w		varchar(50);
nr_sequencia_w			regra_descricao_rps.nr_sequencia%type;
vl_base_calculo_ir_w		nota_fiscal_trib.vl_base_calculo%type;
tx_tributo_item_iss_w		nota_fiscal_item_trib.tx_tributo%type;
nr_item_nf_w			nota_fiscal_item.nr_item_nf%type;
vl_coparticipacao_w		pls_mensalidade.vl_coparticipacao%type;
nr_seq_lote_w			pls_mensalidade.nr_seq_lote%type;
contract_number_w         pls_contrato.nr_sequencia%type;
contract_company_code_w   pls_contrato.cd_operadora_empresa%type;
vl_vinculado_w                nota_fiscal_adiant_pago.vl_vinculado %type;
senha_atendimento_w           atendimento_paciente.ds_senha_qmatic%type;
classificacao_atendimento_w   classificacao_atendimento.ds_classificacao%type;
dt_alta_w                     atendimento_paciente.dt_alta%type;
nr_prontuario_w               pessoa_fisica.nr_prontuario%type;
generated_items_w             boolean := false;
regra_contract_number_w       varchar(15) := '83';
regra_contract_company_code_w varchar(15) := '84';
regra_vl_vinculado_w          varchar(15) := '85';
regra_senha_atendimento_w     varchar(15) := '86';
regra_classif_atendimento_w   varchar(15) := '87';
regra_regra_dt_alta_w         varchar(15) := '88';
regra_nr_prontuario_w         varchar(15) := '89';

c01 CURSOR FOR
	/*Listar as regras gerais ou busca a regra geral se no existe regra para o convenio da nota e nem para Pessoa Jurdica */

	SELECT	/*distinct*/
		ds_regra,
		ie_ordem ie_ordem,
		coalesce(max(ie_saldo_tit_maior_zero),'N') ie_saldo_tit_maior_zero,
		coalesce(substr(max(ie_caractere_ant),1,255),'') caracter_ant,
		coalesce(substr(max(ie_caractere_fim),1,255),'') caracter_pos,
		coalesce(max(ie_exporta_trib_inf_adic),'N'),
		max(nr_sequencia)
	from	regra_descricao_rps
	where	cd_estabelecimento = cd_estabelecimento_p
	and	((coalesce(cd_convenio_w::text, '') = '' and coalesce(cd_convenio::text, '') = '') or ((cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') and coalesce(cd_convenio::text, '') = '' and qt_regra_convenio_w = 0))
	and	((coalesce(cd_cgc_w::text, '') = '' and coalesce(cd_cnpj::text, '') = '') or ((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and coalesce(cd_cnpj::text, '') = '' and qt_regra_cgc_w = 0))
	and	((coalesce(cd_operacao_nf_w::text, '') = '' and coalesce(cd_operacao_nf::text, '') = '') or ((cd_operacao_nf_w IS NOT NULL AND cd_operacao_nf_w::text <> '') and coalesce(cd_operacao_nf::text, '') = '' and qt_regra_operacao_nf_w = 0))
	and	((coalesce(ie_mensalidade,'N') = 'S' and (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '')) or (coalesce(ie_mensalidade,'N') = 'M' and coalesce(nr_seq_mensalidade_w::text, '') = '') or (coalesce(ie_mensalidade,'N') = 'N'))
	and	((ie_tipo_lote_mensalidade = ie_tipo_lote_mens_w) or (coalesce(ie_tipo_lote_mensalidade::text, '') = ''))
	and 	ds_regra <> '31'
	and 	coalesce(ie_situacao,'A') = 'A'
	group by ds_regra, ie_ordem
	
union all

	/*Listar somente a regra para o conveno da nota*/

	SELECT	/*distinct*/
		ds_regra,
		ie_ordem ie_ordem,
		coalesce(max(ie_saldo_tit_maior_zero),'N') ie_saldo_tit_maior_zero,
		coalesce(substr(max(ie_caractere_ant),1,255),'') caracter_ant,
		coalesce(substr(max(ie_caractere_fim),1,255),'') caracter_pos,
		coalesce(max(ie_exporta_trib_inf_adic),'N'),
		max(nr_sequencia)
	from	regra_descricao_rps
	where	cd_estabelecimento = cd_estabelecimento_p
	and	(cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '')
	and	cd_convenio = cd_convenio_w
	and 	coalesce(ie_situacao,'A') = 'A'
	and	coalesce(cd_cnpj::text, '') = ''
	and 	ds_regra <> '31'
	group by ds_regra, ie_ordem
	
union all

	/*Listar somente a regra para Pessoa Jurdica da nota*/

	select	/*distinct*/
		ds_regra,
		ie_ordem ie_ordem,
		coalesce(max(ie_saldo_tit_maior_zero),'N') ie_saldo_tit_maior_zero,
		coalesce(substr(max(ie_caractere_ant),1,255),'') caracter_ant,
		coalesce(substr(max(ie_caractere_fim),1,255),'') caracter_pos,
		coalesce(max(ie_exporta_trib_inf_adic),'N'),
		max(nr_sequencia)
	from	regra_descricao_rps
	where	cd_estabelecimento = cd_estabelecimento_p
	and	(cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
	and	cd_cnpj = cd_cgc_w
	and 	coalesce(ie_situacao,'A') = 'A'
	and	coalesce(cd_convenio::text, '') = ''
	and	((cd_operacao_nf = cd_operacao_nf_w) or (coalesce(cd_operacao_nf::text, '') = ''))
	and 	ds_regra <> '31'
	group by ds_regra, ie_ordem
	
union all

	/* Listar somente a regra para Operao da Nota Fiscal */

	select	/*distinct*/
		ds_regra,
		ie_ordem ie_ordem,
		coalesce(max(ie_saldo_tit_maior_zero),'N') ie_saldo_tit_maior_zero,
		coalesce(substr(max(ie_caractere_ant),1,255),'') caracter_ant,
		coalesce(substr(max(ie_caractere_fim),1,255),'') caracter_pos,
		coalesce(max(ie_exporta_trib_inf_adic),'N'),
		max(nr_sequencia)
	from	regra_descricao_rps
	where	cd_estabelecimento = cd_estabelecimento_p
	and	(cd_operacao_nf_w IS NOT NULL AND cd_operacao_nf_w::text <> '')
	and	cd_operacao_nf = cd_operacao_nf_w
	and 	coalesce(ie_situacao,'A') = 'A'
	and	coalesce(cd_convenio::text, '') = ''
	and	coalesce(cd_cnpj::text, '') = ''
	and 	ds_regra <> '31'
	group by ds_regra, ie_ordem
	
union all

	select	/*distinct*/
		ds_regra,
		ie_ordem,
		coalesce(ie_saldo_tit_maior_zero,'N') ie_saldo_tit_maior_zero,
		coalesce(substr(ie_caractere_ant,1,255),'') caracter_ant,
		coalesce(substr(ie_caractere_fim,1,255),'') caracter_pos,
		coalesce(ie_exporta_trib_inf_adic,'N'),
		nr_sequencia
	from	regra_descricao_rps
	where	cd_estabelecimento = cd_estabelecimento_p
	and	((coalesce(cd_convenio_w::text, '') = '' and coalesce(cd_convenio::text, '') = '') or ((cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') and coalesce(cd_convenio::text, '') = '' and qt_regra_convenio_w = 0))
	and	((coalesce(cd_cgc_w::text, '') = '' and coalesce(cd_cnpj::text, '') = '') or ((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and coalesce(cd_cnpj::text, '') = '' and qt_regra_cgc_w = 0))
	and	((coalesce(cd_operacao_nf_w::text, '') = '' and coalesce(cd_operacao_nf::text, '') = '') or ((cd_operacao_nf_w IS NOT NULL AND cd_operacao_nf_w::text <> '') and coalesce(cd_operacao_nf::text, '') = '' and qt_regra_operacao_nf_w = 0))
	and	((coalesce(ie_mensalidade,'N') = 'S' and (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '')) or (coalesce(ie_mensalidade,'N') = 'M' and coalesce(nr_seq_mensalidade_w::text, '') = '') or (coalesce(ie_mensalidade,'N') = 'N'))
	and	((ie_tipo_lote_mensalidade = ie_tipo_lote_mens_w) or (coalesce(ie_tipo_lote_mensalidade::text, '') = ''))
	and 	ds_regra = '31'
	and 	coalesce(ie_situacao,'A') = 'A'
	
union all

	select	/*distinct*/
		ds_regra,
		ie_ordem,
		coalesce(ie_saldo_tit_maior_zero,'N') ie_saldo_tit_maior_zero,
		coalesce(substr(ie_caractere_ant,1,255),'') caracter_ant,
		coalesce(substr(ie_caractere_fim,1,255),'') caracter_pos,
		coalesce(ie_exporta_trib_inf_adic,'N'),
		nr_sequencia
	from	regra_descricao_rps
	where	cd_estabelecimento = cd_estabelecimento_p
	and	(((cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '')
		and (coalesce(cd_cnpj::text, '') = '')
		and (cd_convenio = cd_convenio_w))
		or	((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
			and (cd_cnpj = cd_cgc_w)
			and (coalesce(cd_convenio::text, '') = '')
			and	((cd_operacao_nf = cd_operacao_nf_w) or (coalesce(cd_operacao_nf::text, '') = '')))
			or 	((cd_operacao_nf_w IS NOT NULL AND cd_operacao_nf_w::text <> '')
				and (cd_operacao_nf = cd_operacao_nf_w)
				and (coalesce(cd_convenio::text, '') = '')
				and (coalesce(cd_cnpj::text, '') = '')))
	and 	coalesce(ie_situacao,'A') = 'A'
	and 	ds_regra = '31'
	order by ie_ordem;

c02 CURSOR FOR   -- Apenas regra sem PJ e Convnio
	SELECT	ds_regra,
		ie_ordem,
		substr(ie_caractere_ant,1,255) caracter_ant,
		substr(ie_caractere_fim,1,255) caracter_pos
	from	regra_descricao_rps
	where	cd_estabelecimento = cd_estabelecimento_p
	and	((coalesce(cd_convenio_w::text, '') = '' and coalesce(cd_convenio::text, '') = '') or ((cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') and coalesce(cd_convenio::text, '') = '' and qt_regra_convenio_w = 0))
	and	((coalesce(cd_cgc_w::text, '') = '' and coalesce(cd_cnpj::text, '') = '') or ((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and coalesce(cd_cnpj::text, '') = '' and qt_regra_cgc_w = 0))
	and	((coalesce(cd_operacao_nf_w::text, '') = '' and coalesce(cd_operacao_nf::text, '') = '') or ((cd_operacao_nf_w IS NOT NULL AND cd_operacao_nf_w::text <> '') and coalesce(cd_operacao_nf::text, '') = '' and qt_regra_operacao_nf_w = 0))
	and	ds_regra in ('1','2','3','12','14','20','30','57','81')
	and 	coalesce(ie_situacao,'A') = 'A'
	group by  ds_regra, ie_ordem, ie_caractere_ant, ie_caractere_fim
	
union all
   -- union que traz regra por Convni
	SELECT	ds_regra,
		ie_ordem,
		substr(ie_caractere_ant,1,255) caracter_ant,
		substr(ie_caractere_fim,1,255) caracter_pos
	from	regra_descricao_rps
	where	cd_estabelecimento = cd_estabelecimento_p
	and	(cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '')
	and	cd_convenio = cd_convenio_w
	and	ds_regra in ('1','2','3','12','14','20','30','57','81')
	and 	coalesce(ie_situacao,'A') = 'A'
	and	coalesce(cd_cnpj::text, '') = ''
	and	coalesce(cd_operacao_nf::text, '') = ''
	group by  ds_regra, ie_ordem, ie_caractere_ant, ie_caractere_fim
	
union all
    -- union que traz regra por PJ
	select	ds_regra,
		ie_ordem,
		substr(max(ie_caractere_ant),1,255) caracter_ant,
		substr(max(ie_caractere_fim),1,255) caracter_pos
	from	regra_descricao_rps
	where	cd_estabelecimento = cd_estabelecimento_p
	and	(cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
	and	cd_cnpj = cd_cgc_w
	and	ds_regra in ('1','2','3','12','14','20','30','57','81')
	and 	coalesce(ie_situacao,'A') = 'A'
	and	coalesce(cd_convenio::text, '') = ''
	and	coalesce(cd_operacao_nf::text, '') = ''
	group by  ds_regra, ie_ordem, ie_caractere_ant, ie_caractere_fim
	
union all
  --union que traz a regra por operacao da nota
	select	ds_regra,
		ie_ordem,
		substr(max(ie_caractere_ant),1,255) caracter_ant,
		substr(max(ie_caractere_fim),1,255) caracter_pos
	from	regra_descricao_rps
	where	cd_estabelecimento = cd_estabelecimento_p
	and	(cd_operacao_nf_w IS NOT NULL AND cd_operacao_nf_w::text <> '')
	and	cd_operacao_nf = cd_operacao_nf_w
	and	ds_regra in ('1','2','3','12','14','20','30','57','81')
	and 	coalesce(ie_situacao,'A') = 'A'
	and	coalesce(cd_convenio::text, '') = ''
	and	coalesce(cd_cnpj::text, '') = ''
	group by  ds_regra, ie_ordem, ie_caractere_ant, ie_caractere_fim
	order by ie_ordem;

c03 CURSOR FOR
	SELECT	coalesce(cd_material, cd_procedimento) cd_item,
		qt_item_nf,
		vl_unitario_item_nf,
		vl_total_item_nf,
		vl_liquido,
		coalesce(substr(obter_desc_material(cd_material),1,255),
		substr(obter_descricao_procedimento(cd_procedimento, ie_origem_proced),1,255)) ds_item,
		coalesce(substr(ds_complemento,1,255),'') ds_complemento,
		vl_desconto,
		nr_item_nf
	from	nota_fiscal_item
	where	nr_sequencia	= nr_seq_nota_p
  and   ((nr_seq_item_p = 0) or (nr_item_nf = nr_seq_item_p));

c04 CURSOR FOR
	SELECT	dt_vencimento
	from	nota_fiscal_venc
	where 	nr_sequencia = nr_seq_nota_p;

c05 CURSOR FOR
	SELECT	coalesce(sum(vl_ato_cooperado),0),
		coalesce(sum(vl_ato_auxiliar),0),
		coalesce(sum(vl_ato_nao_cooperado),0)
	from (SELECT	coalesce(a.vl_ato_cooperado,0) vl_ato_cooperado,
			coalesce(a.vl_ato_auxiliar,0) vl_ato_auxiliar,
			coalesce(a.vl_ato_nao_cooperado,0) vl_ato_nao_cooperado
		from	pls_mensalidade_ato_coop	a,
			pls_mensalidade			b,
			nota_fiscal			c
		where	c.nr_sequencia		= nr_seq_nota_p
		and	c.nr_seq_mensalidade	= b.nr_sequencia
		and	b.nr_sequencia		= a.nr_seq_mensalidade
		
union all

		select	coalesce(b.vl_ato_princ,0) vl_ato_cooperado,
			coalesce(b.vl_ato_aux,0) vl_ato_auxiliar,
			coalesce(b.vl_ato_secundario,0) vl_ato_nao_cooperado
		from	pls_fatura			b,
			nota_fiscal			a
		where	a.nr_sequencia		= nr_seq_nota_p
		and	a.nr_seq_fatura		= b.nr_sequencia
		and	(a.nr_seq_fatura IS NOT NULL AND a.nr_seq_fatura::text <> '')) alias13;

c06 CURSOR FOR
	SELECT	max(ds_pis) ds_pis,
		max(vl_pis) vl_pis,
		max(tx_pis) tx_pis,
		max(ds_cofins) ds_cofins,
		max(vl_cofins) vl_cofins,
		max(tx_cofins) tx_cofins,
		max(ds_icms) ds_icms,
		max(vl_icms) vl_icms,
		max(tx_icms) tx_icms,
		max(ds_iss) ds_iss,
		max(vl_iss) vl_iss,
		max(tx_iss) tx_iss,
		max(ds_ir) ds_ir,
		max(vl_ir) vl_ir,
		max(tx_ir) tx_ir,
		max(vl_base_calculo_ir) vl_base_calculo_ir,
		max(ds_inss) ds_inss,
		max(vl_inss) vl_inss,
		max(tx_inss) tx_inss,
		max(vl_base_calculo_inss) vl_base_calculo_inss,
		max(ds_csll) ds_csll,
		max(vl_csll) vl_csll,
		max(tx_csll) tx_csll
	from (
		SELECT	b.ds_tributo	ds_pis,
			a.vl_tributo	vl_pis,
			a.tx_tributo	tx_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			''			ds_csll,
			null		vl_csll,
			null		tx_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'PIS'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			b.ds_tributo	ds_cofins,
			a.vl_tributo	vl_cofins,
			a.tx_tributo	tx_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			''			ds_csll,
			null		vl_csll,
			null		tx_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'COFINS'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			b.ds_tributo	ds_icms,
			a.vl_tributo	vl_icms,
			a.tx_tributo	tx_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			''			ds_csll,
			null		vl_csll,
			null		tx_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'ICMS'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			b.ds_tributo	ds_iss,
			a.vl_tributo	vl_iss,
			a.tx_tributo	tx_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			''			ds_csll,
			null		vl_csll,
			null		tx_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'ISS'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			b.ds_tributo	ds_ir,
			a.vl_tributo	vl_ir,
			a.tx_tributo	tx_ir,
			a.vl_base_calculo vl_base_calculo_ir,			
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			''			ds_csll,
			null		vl_csll,
			null		tx_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'IR'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			b.ds_tributo	ds_inss,
			a.vl_tributo	vl_inss,
			a.tx_tributo	tx_inss,
			a.vl_base_calculo vl_base_calculo_inss,
			''			ds_csll,
			null		vl_csll,
			null		tx_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'INSS'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			b.ds_tributo	ds_csll,
			a.vl_tributo	vl_csll,
			a.tx_tributo	tx_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'CSLL') alias23;

c07 CURSOR FOR
	SELECT	max(ds_pis) ds_pis,
		max(vl_pis) vl_pis,
		max(tx_pis) tx_pis,
		max(ie_retem_pis) ie_retem_pis,
		max(ds_cofins) ds_cofins,
		max(vl_cofins) vl_cofins,
		max(tx_cofins) tx_cofins,
		max(ie_retem_cofins) ie_retem_cofins,
		max(ds_icms) ds_icms,
		max(vl_icms) vl_icms,
		max(tx_icms) tx_icms,
		max(ie_retem_icms) ie_retem_icms,
		max(ds_iss) ds_iss,
		max(vl_iss) vl_iss,
		max(tx_iss) tx_iss,
		max(ie_retem_iss) ie_retem_iss,
		max(ds_ir) ds_ir,
		max(vl_ir) vl_ir,
		max(tx_ir) tx_ir,
		max(vl_base_calculo_ir) vl_base_calculo_ir,		
		max(ie_retem_ir) ie_retem_ir,
		max(ds_inss) ds_inss,
		max(vl_inss) vl_inss,
		max(tx_inss) tx_inss,
		max(vl_base_calculo_inss) vl_base_calculo_inss,
		max(ie_retem_inss) ie_retem_inss,
		max(ds_csll) ds_csll,
		max(vl_csll) vl_csll,
		max(tx_csll) tx_csll,
		max(ie_retem_csll) ie_retem_csll
	from (
		SELECT	b.ds_tributo	ds_pis,
			a.vl_tributo	vl_pis,
			a.tx_tributo	tx_pis,
			a.ie_retencao	ie_retem_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			''		ie_retem_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			''		ie_retem_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			''		ie_retem_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			''		ie_retem_ir,
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			''		ie_retem_inss,
			''		ds_csll,
			null		vl_csll,
			null		tx_csll,
			''		ie_retem_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'PIS'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			''		ie_retem_pis,
			b.ds_tributo	ds_cofins,
			a.vl_tributo	vl_cofins,
			a.tx_tributo	tx_cofins,
			a.ie_retencao	ie_retem_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			''		ie_retem_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			''		ie_retem_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			''		ie_retem_ir,
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			''		ie_retem_inss,
			''		ds_csll,
			null		vl_csll,
			null		tx_csll,
			''		ie_retem_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'COFINS'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			''		ie_retem_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			''		ie_retem_cofins,
			b.ds_tributo	ds_icms,
			a.vl_tributo	vl_icms,
			a.tx_tributo	tx_icms,
			a.ie_retencao	ie_retem_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			''		ie_retem_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			''		ie_retem_ir,
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			''		ie_retem_inss,
			''		ds_csll,
			null		vl_csll,
			null		tx_csll,
			''		ie_retem_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'ICMS'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			''		ie_retem_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			''		ie_retem_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			''		ie_retem_icms,
			b.ds_tributo	ds_iss,
			a.vl_tributo	vl_iss,
			a.tx_tributo	tx_iss,
			a.ie_retencao	ie_retem_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			''		ie_retem_ir,
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			''		ie_retem_inss,
			''		ds_csll,
			null		vl_csll,
			null		tx_csll,
			''		ie_retem_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'ISS'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			''		ie_retem_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			''		ie_retem_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			''		ie_retem_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			''		ie_retem_iss,
			b.ds_tributo	ds_ir,
			a.vl_tributo	vl_ir,
			a.tx_tributo	tx_ir,
			a.vl_base_calculo vl_base_calculo_ir,			
			a.ie_retencao	ie_retem_ir,
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			''		ie_retem_inss,
			''		ds_csll,
			null		vl_csll,
			null		tx_csll,
			''		ie_retem_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'IR'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			''		ie_retem_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			''		ie_retem_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			''		ie_retem_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			''		ie_retem_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			''		ie_retem_ir,
			b.ds_tributo	ds_inss,
			a.vl_tributo	vl_inss,
			a.tx_tributo	tx_inss,
			a.vl_base_calculo vl_base_calculo_inss,
			a.ie_retencao	ie_retem_inss,
			''		ds_csll,
			null		vl_csll,
			null		tx_csll,
			''		ie_retem_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'INSS'
		
union all

		select	''		ds_pis,
			null		vl_pis,
			null		tx_pis,
			''		ie_retem_pis,
			''		ds_cofins,
			null		vl_cofins,
			null		tx_cofins,
			''		ie_retem_cofins,
			''		ds_icms,
			null		vl_icms,
			null		tx_icms,
			''		ie_retem_icms,
			''		ds_iss,
			null		vl_iss,
			null		tx_iss,
			''		ie_retem_iss,
			''		ds_ir,
			null		vl_ir,
			null		tx_ir,
			null		vl_base_calculo_ir,
			''		ie_retem_ir,
			''		ds_inss,
			null		vl_inss,
			null		tx_inss,
			null		vl_base_calculo_inss,
			''		ie_retem_inss,
			b.ds_tributo	ds_csll,
			a.vl_tributo	vl_csll,
			a.tx_tributo	tx_csll,
			a.ie_retencao	ie_retem_csll
		from	nota_fiscal_trib a,
			tributo b
		where	a.cd_tributo	= b.cd_tributo
		and	nr_sequencia	= nr_seq_nota_p
		and	b.ie_tipo_tributo = 'CSLL') alias30;

c08 CURSOR FOR
	SELECT	distinct nr_seq_item_serv
	from (SELECT	nr_item_nf,
			coalesce(obter_item_servico_proced(coalesce(cd_procedimento,0),coalesce(ie_origem_proced,0),cd_estabelecimento),0) nr_seq_item_serv
		from	nota_fiscal_item
		where	nr_sequencia = nr_seq_nota_p
		and	(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')
		and 	coalesce(obter_item_servico_proced(coalesce(cd_procedimento,0),coalesce(ie_origem_proced,0),cd_estabelecimento),0) <> 0
		order by nr_item_nf) alias9;

vet08	c08%rowtype;


BEGIN

select	count(*)
into STRICT	qt_existe_w
from	regra_descricao_rps
where	cd_estabelecimento	= cd_estabelecimento_p
and 	coalesce(ie_situacao,'A') = 'A';

select	obter_convenio_nf(nr_seq_nota_p)
into STRICT	cd_convenio_w
;

begin
select	max(cd_cgc)
into STRICT	cd_cgc_w
from	nota_fiscal
where	nr_sequencia = nr_seq_nota_p;
exception
	when no_data_found then
		cd_cgc_w := null;
end;

select	max(cd_operacao_nf)
into STRICT	cd_operacao_nf_w
from	nota_fiscal
where	nr_sequencia = nr_seq_nota_p;

select	count(*)
into STRICT	qt_regra_convenio_w
from	regra_descricao_rps
where	cd_estabelecimento	= cd_estabelecimento_p
and	cd_convenio		= coalesce(cd_convenio_w,0)
and 	coalesce(ie_situacao,'A') = 'A';

select	count(*)
into STRICT	qt_regra_cgc_w
from	regra_descricao_rps
where	cd_estabelecimento	= cd_estabelecimento_p
and	cd_cnpj			= coalesce(cd_cgc_w,0)
and 	coalesce(ie_situacao,'A') = 'A';

select	count(*)
into STRICT	qt_regra_operacao_nf_w
from	regra_descricao_rps
where	cd_estabelecimento	= cd_estabelecimento_p
and	cd_operacao_nf		= cd_operacao_nf_w
and	ie_situacao 		= 'A';

select	substr(obter_select_concatenado_bv('
		select	nr_interno_conta
		from	conta_paciente
		where	nr_seq_protocolo = :nr_seq_protocolo',
		'nr_seq_protocolo='|| nr_seq_protocolo || ';',', '),1,2000)
into STRICT	ds_contas_protocolo_w
from	nota_fiscal
where	nr_sequencia = nr_seq_nota_p;

select  sum(coalesce(vl_vinculado, 0)) vl_vinculado 
into STRICT    vl_vinculado_w
from    nota_fiscal_adiant_pago 
where   nr_sequencia_nf = nr_seq_nota_p;

select      max(a.ds_senha_qmatic) senha_atendimento,
            max(select ca.ds_classificacao from classificacao_atendimento ca where ca.nr_sequencia = a.nr_seq_classificacao) classificacao_atendimento,
            max(a.dt_alta) dt_alta
into STRICT        senha_atendimento_w,
            classificacao_atendimento_w,
            dt_alta_w
from        conta_paciente c
inner join  atendimento_paciente a
      on    a.nr_atendimento = c.nr_atendimento
inner join  nota_fiscal n
      on    n.nr_interno_conta = c.nr_interno_conta  
where       n.nr_sequencia = nr_seq_nota_p;

select     max(p.nr_prontuario)
into STRICT       nr_prontuario_w
from       nota_fiscal n
inner join pessoa_fisica p
        on n.cd_pessoa_fisica = p.cd_pessoa_fisica
where      n.nr_sequencia = nr_seq_nota_p;

if (qt_existe_w > 0) then
	begin
	if (ds_atributo_p = 'DS_SERVICOS') then
		begin

		select	n.nr_seq_protocolo,
			n.nr_nota_fiscal,
			coalesce(n.vl_total_nota,0),
			n.nr_interno_conta,
			obter_nr_atendimento_nota(n.nr_sequencia),
			substr(elimina_acentuacao(obter_pessoa_atendimento(obter_nr_atendimento_nota(n.nr_sequencia), 'N')), 1, 80),
			coalesce(obter_pagador_atend(coalesce(obter_nr_atendimento_nota(n.nr_sequencia), 0)), coalesce(obter_pessoa_atendimento(obter_nr_atendimento_nota(n.nr_sequencia), 'N'),'')),
			substr(obter_Cpf_Pessoa_Fisica(Obter_pessoa_Pagador_Atend(obter_nr_atendimento_nota(n.nr_sequencia))),1, 20),
			CASE WHEN(length(substr(Obter_pessoa_Pagador_Atend(obter_nr_atendimento_nota(n.nr_sequencia)),1, 20)))=14 THEN  Obter_pessoa_Pagador_Atend(obter_nr_atendimento_nota(n.nr_sequencia))  ELSE '' END ,
			n.nr_seq_mensalidade,
			n.vl_descontos,
			(((select f.vl_base_calculo from nota_fiscal_trib f where f.nr_sequencia = n.nr_sequencia  LIMIT 1) / 100) * Obter_Valor_Tributo_Nota(n.nr_sequencia, 'X')), -- Alterado por apapandini OS 622531
			Obter_Valor_Tributo_Nota(n.nr_sequencia, 'X'),		-- Alterado por apapandini OS 622531
			obter_tot_trib_nf(n.nr_sequencia,'V'),
			obter_tot_trib_nf(n.nr_sequencia,'X'),
			CASE WHEN coalesce(nr_seq_mensalidade::text, '') = '' THEN null  ELSE dt_competencia END
		into STRICT	nr_seq_protocolo_w,
			nr_nota_fiscal_w,
			vl_total_nota_w,
			nr_interno_conta_w,
			nr_atendimento_w,
			nm_pessoa_atendimento_w,
			nm_pagador_w,
			nr_cpf_pagador_w,
			nr_cnpj_pagador_w,
			nr_seq_mensalidade_w,
			vl_descontos_w,
			vl_total_tributos_w,
			tx_total_tributos_w,
			vl_total_item_trib_w,
			tx_total_item_trib_w,
			dt_competencia_mens_w
		from	nota_fiscal n
		where	n.nr_sequencia	= nr_seq_nota_p;

		if (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '') then
			
			begin
			
			select	coalesce(a.vl_coparticipacao, 0),
				coalesce(a.nr_seq_lote, 0)
			into STRICT	vl_coparticipacao_w,
				nr_seq_lote_w
			from	pls_mensalidade a
			where	a.nr_sequencia	= nr_seq_mensalidade_w;
			
			exception
			when others then
				vl_coparticipacao_w	:= null;
				nr_seq_lote_w		:= null;
			end;
			
			if (coalesce(nr_seq_lote_w, 0) <> 0) then
				select	max(ie_tipo_lote)
				into STRICT	ie_tipo_lote_mens_w
				from	pls_lote_mensalidade b
				where	b.nr_sequencia = nr_seq_lote_w;
			end if;

			select	max(nr_titulo)
			into STRICT	nr_titulo_mensalidade_w
			from	pls_mensalidade_wcp_v
			where	nr_sequencia_nf = nr_seq_nota_p;			
			
		end if;

		select	coalesce(max(b.nr_protocolo),'0'),
				max(b.ds_observacao)
		into STRICT	nr_protocolo_w,
				ds_obs_prot_convenio_w
		from	nota_fiscal a,
			protocolo_convenio b
		where	a.nr_seq_protocolo	= nr_seq_protocolo_w
		and	a.nr_seq_protocolo	= b.nr_seq_protocolo
		and	a.nr_sequencia		= nr_seq_nota_p;

		if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
			begin
			select	substr(obter_dados_atendimento(nr_atendimento_w ,'NMR'),1,255),
				substr(obter_dados_medico(obter_dados_atendimento(nr_atendimento_w ,'MR'), 'CRM'),1,255),
				substr(obter_especialidade_medico(obter_dados_atendimento(nr_atendimento_w ,'MR'), 'DV'),1,255)
			into STRICT	nm_medico_w,
				nr_crm_w,
				ds_especialidade_w
			;
			end;
		end if;

		if (coalesce(nr_seq_protocolo_w::text, '') = '') then
			begin
			select	substr((select	substr(obter_nome_pf(a.cd_pessoa_fisica),1,150)
							from	atendimento_paciente a,
									conta_paciente c
							where	a.nr_atendimento = c.nr_atendimento
							and		c.nr_interno_conta = n.nr_interno_conta),1,2000)
			into STRICT	nm_paciente_w
			from	nota_fiscal n
			where	n.nr_sequencia = nr_seq_nota_p;

			select	substr((select substr(obter_dados_pf(a.cd_pessoa_fisica, 'DN'),1,30)
							from	atendimento_paciente a,
									conta_paciente c
							where	a.nr_atendimento = c.nr_atendimento
							and	c.nr_interno_conta = n.nr_interno_conta),1,30)
			into STRICT	dt_nascimento_paciente_w
			from	nota_fiscal n
			where	n.nr_sequencia	= nr_seq_nota_p;

			select	substr((select substr(obter_dados_pf(a.cd_pessoa_fisica,'CPF'),1,11)
							from	atendimento_paciente a,
									conta_paciente c
							where	a.nr_atendimento = c.nr_atendimento
							and		c.nr_interno_conta = n.nr_interno_conta),1,2000)
			into STRICT	nr_cpf_w
			from	nota_fiscal n
			where	n.nr_sequencia		= nr_seq_nota_p;

			select	max(substr(obter_nome_setor(obter_setor_atendimento(c.nr_atendimento)),1,255))
			into STRICT	ds_setor_atendimento_w
			from	conta_paciente c,
				nota_fiscal n
			where	n.nr_sequencia		= nr_seq_nota_p
			and	c.nr_interno_conta	= n.nr_interno_conta;
			end;
		else
			begin
			select	count(l.nr_atendimento)
			into STRICT	qt_nr_atendimento_w
			from (SELECT	nr_atendimento
					from	nota_fiscal_item
					where	nr_sequencia = nr_seq_nota_p
					group by nr_atendimento) l;

			if (qt_nr_atendimento_w = 1) then
				begin
				select	substr((select substr(obter_nome_pf(a.cd_pessoa_fisica),1,150)
						from	atendimento_paciente a,
								conta_paciente c
						where	a.nr_atendimento = c.nr_atendimento
						and	c.nr_interno_conta = n.nr_interno_conta),1,2000)
				into STRICT	nm_paciente_w
				from	nota_fiscal n
				where	n.nr_sequencia = nr_seq_nota_p;

				select	substr((select substr(obter_dados_pf(a.cd_pessoa_fisica, 'DN'),1,30)
						from	atendimento_paciente a,
								conta_paciente c
						where	a.nr_atendimento = c.nr_atendimento
						and	c.nr_interno_conta = n.nr_interno_conta),1,30)
				into STRICT	dt_nascimento_paciente_w
				from	nota_fiscal n
				where	n.nr_sequencia = nr_seq_nota_p;

				select	substr((select substr(obter_dados_pf(a.cd_pessoa_fisica,'CPF'),1,11)
						from	atendimento_paciente a,
								conta_paciente c
						where	a.nr_atendimento = c.nr_atendimento
						and	c.nr_interno_conta = n.nr_interno_conta),1,2000)
				into STRICT	nr_cpf_w
				from	nota_fiscal n
				where	n.nr_sequencia = nr_seq_nota_p;

				select	max(substr(obter_nome_setor(obter_setor_atendimento(c.nr_atendimento)),1,255))
				into STRICT	ds_setor_atendimento_w
				from	conta_paciente c,
					nota_fiscal n
				where	n.nr_sequencia = nr_seq_nota_p
				and	c.nr_interno_conta = n.nr_interno_conta;
				end;
			end if;
			end;
		end if;

		open c01;
		loop
		fetch c01 into
			ds_regra_w,
			ie_ordem_w,
			ie_saldo_tit_maior_zero_w,
			ie_caracter_ant_w,
			ie_caracter_pos_w,
			ie_exporta_trib_inf_adic_w,
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			
			if (ds_regra_w = '8') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nm_paciente_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '10') then
				begin
				ds_retorno_w	:= substr(ds_retorno_w || ie_caracter_ant_w || nr_cpf_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '16') then
				begin
				ds_retorno_w	:= substr(ds_retorno_w || ie_caracter_ant_w || nr_interno_conta_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '17') then
				begin
				ds_retorno_w	:= substr(ds_retorno_w || ie_caracter_ant_w || nr_atendimento_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '18') then
				begin
				ds_retorno_w	:= substr(ds_retorno_w || ie_caracter_ant_w || nm_pessoa_atendimento_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '19') then
				begin
				ds_retorno_w	:= substr(ds_retorno_w || ie_caracter_ant_w || dt_nascimento_paciente_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '21') and (nm_pagador_w IS NOT NULL AND nm_pagador_w::text <> '') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nm_pagador_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '22') and (nr_cpf_pagador_w IS NOT NULL AND nr_cpf_pagador_w::text <> '') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_cpf_pagador_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '23') and (nr_cnpj_pagador_w IS NOT NULL AND nr_cnpj_pagador_w::text <> '') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_cnpj_pagador_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '25') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nm_medico_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '26') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_especialidade_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '27') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_crm_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '5') then
				begin
					if (coalesce(ie_caracter_ant_w::text, '') = '') then
						ie_caracter_ant_w := '  ' || wheb_mensagem_pck.get_texto(308666);--'Perodo de fechamento ';
					else
						ie_caracter_ant_w := ie_caracter_ant_w;
					end if;

					if (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') then
						select	to_char(c.dt_periodo_inicial, 'dd/mm/yyyy'),
							to_char(c.dt_periodo_final, 'dd/mm/yyyy')
						into STRICT	dt_periodo_inicial_w,
							dt_periodo_final_w
						from	atendimento_paciente a,
							conta_paciente c
						where	a.nr_atendimento = c.nr_atendimento
						and	c.nr_interno_conta = nr_interno_conta_w;

						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || dt_periodo_inicial_w || ' a ' || dt_periodo_final_w || ie_caracter_pos_w,1,2000);
					end if;
				end;
			elsif (ds_regra_w = '15') then
				begin
					select	substr(ds_retorno_w || ie_caracter_ant_w || dt_entrada || ie_caracter_pos_w,1,2000)
					into STRICT	ds_retorno_w
					from	nota_fiscal n,
						atendimento_paciente a,
						conta_paciente c
					where	a.nr_atendimento = c.nr_atendimento
					and	c.nr_interno_conta = n.nr_interno_conta
					and	n.nr_sequencia = nr_seq_nota_p;
				end;
			elsif (ds_regra_w = '56') then
				begin
					select	substr(ds_retorno_w || ie_caracter_ant_w || max(obter_titulo_conta_protocolo(0,n.nr_interno_conta)) || ie_caracter_pos_w,1,2000)
					into STRICT	ds_retorno_w
					from	nota_fiscal n
					where	n.nr_sequencia = nr_seq_nota_p;
				end;
			elsif (ds_regra_w = '79') then
				begin
					select	substr(ds_retorno_w || ie_caracter_ant_w || max(b.nr_titulo) || ie_caracter_pos_w,1,2000)
					into STRICT	ds_retorno_w
					from	pls_fatura			b,
						nota_fiscal			a
					where	a.nr_sequencia		= nr_seq_nota_p
					and	a.nr_seq_fatura		= b.nr_sequencia;
				end;
			elsif (ds_regra_w = '4') then
				begin
					if (coalesce(ie_caracter_ant_w::text, '') = '') then
						ie_caracter_ant_w := ' ';
					else
						ie_caracter_ant_w := ie_caracter_ant_w;
					end if;
					select	substr(ds_observacao, 1, 1000)
					into STRICT	ds_observacao_w
					from	nota_fiscal
					where	nr_sequencia	= nr_seq_nota_p;

					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_observacao_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '6') and ((trim(both ds_contas_protocolo_w) IS NOT NULL AND (trim(both ds_contas_protocolo_w))::text <> '')) then
				begin
					if (coalesce(ie_caracter_ant_w::text, '') = '') then
						ds_retorno_w := substr(ds_retorno_w || wheb_mensagem_pck.get_texto(308669) || ds_contas_protocolo_w,1,2000);
					else
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_contas_protocolo_w || ie_caracter_pos_w,1,2000);
					end if;
				end;
			elsif (ds_regra_w = '7') and (nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') then
				begin
				if (coalesce(ie_caracter_ant_w::text, '') = '') then
					ds_retorno_w := substr(ds_retorno_w || wheb_mensagem_pck.get_texto(308671) || nr_seq_protocolo_w,1,2000);
				else
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_seq_protocolo_w || ie_caracter_pos_w,1,2000);
				end if;
				end;
			elsif (ds_regra_w = '11') and (nr_protocolo_w IS NOT NULL AND nr_protocolo_w::text <> '') then
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_protocolo_w || ie_caracter_pos_w,1,2000);
			elsif (ds_regra_w = '9') and (ds_setor_atendimento_w IS NOT NULL AND ds_setor_atendimento_w::text <> '') then
				begin
				if (coalesce(ie_caracter_ant_w::text, '') = '') then
					ds_retorno_w := substr(ds_retorno_w || wheb_mensagem_pck.get_texto(308674) || ds_setor_atendimento_w,1,2000);
				else
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_setor_atendimento_w || ie_caracter_pos_w,1,2000);
				end if;
				end;
			elsif (ds_regra_w = '29') then
				begin
				--ds_procom_w := 'PROCON RJ - PROGRAMA DE ORIENTAO E PROTEO AO CONSUMIDOS Postos de Atendimento: -PROCON NITEROI - Rua Visconde de Sepeptiba, 519 - Trreo -Posto PROCON Rio Simples - Carioca - Rua da Ajuda, 05 - Subsolo -Posto PROCON Rio Simples - Central do Brasil, Pa Cristiano Ottoni, subsolo, s/n- Ed. D. Pedro II Telefone: 151 www.procon.rj.gov.br <http://www.procon.rj.gov.br> COMISSO DE DEFESA DO CONSUMIDOR DA ASSEMBLEIA LEGISLATIVA DO ESTADO DO RIO DE JANEIRO - CODECON Rua da Alfndega, n 8 -  - Centro - Rio de Janeiro - RJ Telefone: 0800-2827060 ';
				ds_procom_w := wheb_mensagem_pck.get_texto(308676);
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_procom_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '13') and (nr_nota_fiscal_w IS NOT NULL AND nr_nota_fiscal_w::text <> '') then
				begin
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_nota_fiscal_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '28') and (vl_total_nota_w IS NOT NULL AND vl_total_nota_w::text <> '') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || vl_total_nota_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '58') and (vl_descontos_w IS NOT NULL AND vl_descontos_w::text <> '') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_descontos_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '31') then
				begin
				/*
				select	ds_texto_padrao
				into	ds_texto_padrao_w
				from	regra_descricao_rps
				where	cd_estabelecimento	= cd_estabelecimento_p
				and 	nr_sequencia		= nr_sequencia_w
				*/

				/*and	((cd_convenio = cd_convenio_w) or (cd_convenio is null))
				and	((cd_cnpj = cd_cgc_w) or (cd_cnpj is null))
				and	((nvl(ie_mensalidade,'N') = 'S' and nr_seq_mensalidade_w is not null) or (nvl(ie_mensalidade,'N') = 'M' and nr_seq_mensalidade_w is null) or (nvl(ie_mensalidade,'N') = 'N'))
				and	((cd_operacao_nf = cd_operacao_nf_w) or ((cd_operacao_nf is null) and ((select count(1)
														from	regra_descricao_rps x
														where	x.cd_estabelecimento	= cd_estabelecimento_p
														and	((x.cd_convenio = cd_convenio_w) or (x.cd_convenio is null))
														and	((x.cd_cnpj = cd_cgc_w) or (x.cd_cnpj is null))
														and	cd_operacao_nf = cd_operacao_nf_w
														) <= 0)))*/

				/*
				and	ds_regra = 31
				and 	nvl(ie_situacao,'A') = 'A'
				and	rownum < 2
				order by cd_convenio,nr_sequencia;
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_texto_padrao_w || ie_caracter_pos_w,1,2000);
				*/
				
				select 	ds_texto_padrao,
						coalesce(ie_txt_inf_adic,'N')
				into STRICT 	ds_texto_padrao_w,
						ie_txt_inf_adic_w
				from 	regra_descricao_rps
				where 	cd_estabelecimento  = cd_estabelecimento_p
				and 	nr_sequencia = nr_sequencia_w
				and 	ds_regra = 31
				and 	coalesce(ie_situacao,'A') = 'A'
				order by cd_convenio, nr_sequencia LIMIT 1;
				
				if (ie_txt_inf_adic_w = 'S') then
				    begin
					    ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_texto_padrao_w || ie_caracter_pos_w,1,2000);
				    end;
			    end if;				
				
				end;
				
			elsif (ds_regra_w = '24') then
				open C04;
				loop
				fetch C04 into
					dt_vencimento_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin
					if (dt_vencimento_w IS NOT NULL AND dt_vencimento_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || dt_vencimento_w || ie_caracter_pos_w,1,2000);
						end;
					end if;
					end;
				end loop;
				close C04;
			elsif (ds_regra_w = '54') then
				begin
				select	max(d.nr_protocolo_ans)
				into STRICT	nr_protocolo_ans_w
				from	pls_segurado			e,
					pls_plano			d,
					pls_mensalidade_segurado	c,
					pls_mensalidade			b,
					nota_fiscal			a
				where	a.nr_sequencia		= nr_seq_nota_p
				and	a.nr_seq_mensalidade	= b.nr_sequencia
				and	b.nr_sequencia		= c.nr_seq_mensalidade
				and	e.nr_sequencia		= c.nr_seq_segurado
				and	d.nr_sequencia		= e.nr_seq_plano;

				if (nr_protocolo_ans_w IS NOT NULL AND nr_protocolo_ans_w::text <> '') then
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_protocolo_ans_w || ie_caracter_pos_w,1,2000);
				end if;
				end;
			elsif (ds_regra_w = '55') then
				begin
				select	max(d.ds_plano)
				into STRICT	ds_plano_w
				from	pls_segurado			e,
					pls_plano			d,
					pls_mensalidade_segurado	c,
					pls_mensalidade			b,
					nota_fiscal			a
				where	a.nr_sequencia		= nr_seq_nota_p
				and	a.nr_seq_mensalidade	= b.nr_sequencia
				and	b.nr_sequencia		= c.nr_seq_mensalidade
				and	e.nr_sequencia		= c.nr_seq_segurado
				and	d.nr_sequencia		= e.nr_seq_plano;

				if (ds_plano_w IS NOT NULL AND ds_plano_w::text <> '') then
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_plano_w || ie_caracter_pos_w,1,2000);
				end if;
				end;
			elsif (ds_regra_w = '59') and (vl_total_tributos_w IS NOT NULL AND vl_total_tributos_w::text <> '') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_total_tributos_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '60') and (tx_total_tributos_w IS NOT NULL AND tx_total_tributos_w::text <> '') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_total_tributos_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '61') and (ds_obs_prot_convenio_w IS NOT NULL AND ds_obs_prot_convenio_w::text <> '') then
				begin
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_obs_prot_convenio_w || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '68') and (vl_total_item_trib_w IS NOT NULL AND vl_total_item_trib_w::text <> '') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_total_item_trib_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '69') and (tx_total_item_trib_w IS NOT NULL AND tx_total_item_trib_w::text <> '') then
				begin
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_total_item_trib_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
				end;
			elsif (ds_regra_w = '70') and (vl_total_item_trib_w IS NOT NULL AND vl_total_item_trib_w::text <> '') then
				begin

				vl_total_ibpt_w	:= 0;

				select	coalesce(max(vl_mercadoria),0)
				into STRICT	vl_total_bruto_nota_w
				from	nota_fiscal n
				where	n.nr_sequencia	= nr_seq_nota_p;

				if	(vl_total_item_trib_w > 0 AND vl_total_bruto_nota_w > 0) then
					begin

					vl_total_ibpt_w := (vl_total_item_trib_w / vl_total_bruto_nota_w) * 100;

					end;
				end if;

				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_total_ibpt_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);

				end;
			elsif (ds_regra_w = '71') and (dt_competencia_mens_w IS NOT NULL AND dt_competencia_mens_w::text <> '') then
				begin

				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || to_char(dt_competencia_mens_w, 'dd/mm/yyyy') || ie_caracter_pos_w,1,2000);

				end;
			elsif (ds_regra_w = '72') and (nr_titulo_mensalidade_w IS NOT NULL AND nr_titulo_mensalidade_w::text <> '') then
				begin

				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_titulo_mensalidade_w || ie_caracter_pos_w,1,2000);

				end;
			elsif (ds_regra_w in ('1','2','3','12','14','20','30','57','81')) and (generated_items_w = false) then
				open c03;
				loop
				fetch c03 into
					cd_item_w,
					qt_item_w,
					vl_item_w,
					vl_total_item_nf_w,
					vl_liquido_w,
					ds_item_w,
					ds_complemento_w,
					vl_descontos_item_w,
					nr_item_nf_w;
				EXIT WHEN NOT FOUND; /* apply on c03 */
          begin
            open c02;
            loop
            fetch c02 into
              ds_regra_w,
              ie_ordem_w,
              ie_caracter_ant_w,
              ie_caracter_pos_w;
            EXIT WHEN NOT FOUND; /* apply on c02 */
              begin				
                if (ds_regra_w = '1') then
                  begin
                  if (coalesce(ie_caracter_ant_w::text, '') = '') then
                    begin
                      if (coalesce(ds_retorno_w::text, '') = '') then
                        ds_retorno_w := substr('Cd.: ' || cd_item_w,1,2000);
                      else
                        ds_retorno_w := substr(ds_retorno_w || ' Cd.: ' || cd_item_w,1,2000);
                      end if;
                    end;
                  else
                    ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || cd_item_w || ie_caracter_pos_w,1,2000);
                  end if;
                  end;
                elsif (ds_regra_w = '2') then
                  begin
                  if (coalesce(ie_caracter_ant_w::text, '') = '') then
                    begin
                      if (coalesce(ds_retorno_w::text, '') = '') then
                        ds_retorno_w := substr(ds_item_w,1,2000);
                      else
                        ds_retorno_w := substr(ds_retorno_w || '  ' || ds_item_w,1,2000);
                      end if;
                    end;
                  else
                    ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_item_w || ie_caracter_pos_w,1,2000);
                  end if;
                  end;
                elsif (ds_regra_w = '3') then
                  begin
                  if (coalesce(ie_caracter_ant_w::text, '') = '') then
                    begin
                      if (coalesce(ds_retorno_w::text, '') = '') then
                        ds_retorno_w := substr('Qtde.: ' || qt_item_w,1,2000);
                      else
                        ds_retorno_w := substr(ds_retorno_w || ' Qtde.: ' || qt_item_w,1,2000);
                      end if;
                    end;
                  else
                    ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || qt_item_w || ie_caracter_pos_w,1,2000);
                  end if;
                  end;
                elsif (ds_regra_w = '14') then
                  begin
                    if (coalesce(ie_caracter_ant_w::text, '') = '') then
                      begin
                        if (coalesce(ds_retorno_w::text, '') = '') then
                          ds_retorno_w := substr('Vl.: ' || fis_nfe_campo_mascara(vl_item_w, qtd_casas_decimais_p, ie_ponto_virgula_p),1,2000);
                        else
                          ds_retorno_w := substr(ds_retorno_w || ' Vl.: ' || fis_nfe_campo_mascara(vl_item_w, qtd_casas_decimais_p, ie_ponto_virgula_p),1,2000);
                        end if;
                      end;
                    else
                      ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_item_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
                    end if;
                  end;
                elsif (ds_regra_w = '20') then
                  begin
                    if (coalesce(ie_caracter_ant_w::text, '') = '') then
                      begin
                        if (coalesce(ds_retorno_w::text, '') = '') then
                          ds_retorno_w := substr('Vl.: ' || fis_nfe_campo_mascara(vl_total_item_nf_w, qtd_casas_decimais_p, ie_ponto_virgula_p),1,2000);
                        else
                          ds_retorno_w := substr(ds_retorno_w || ' Vl.: ' || fis_nfe_campo_mascara(vl_total_item_nf_w, qtd_casas_decimais_p, ie_ponto_virgula_p),1,2000);
                        end if;
                      end;
                    else
                      ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_total_item_nf_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
                    end if;
                  end;
                elsif (ds_regra_w = '30') then
                  begin
                    if (coalesce(ie_caracter_ant_w::text, '') = '') then
                      begin
                        if (coalesce(ds_retorno_w::text, '') = '') then
                          ds_retorno_w := substr('Vl.: ' || fis_nfe_campo_mascara(vl_liquido_w, qtd_casas_decimais_p, ie_ponto_virgula_p),1,2000);
                        else
                          ds_retorno_w := substr(ds_retorno_w || ' Vl.: ' || fis_nfe_campo_mascara(vl_liquido_w, qtd_casas_decimais_p, ie_ponto_virgula_p),1,2000);
                        end if;
                      end;
                    else
                      ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_liquido_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
                    end if;
                  end;
                elsif (ds_regra_w = '57') and (vl_descontos_item_w IS NOT NULL AND vl_descontos_item_w::text <> '') then
                  begin
                    if (coalesce(ie_caracter_ant_w::text, '') = '') then
                      begin
                        if (coalesce(ds_retorno_w::text, '') = '') then
                          ds_retorno_w := substr('Vl.: ' || fis_nfe_campo_mascara(vl_descontos_item_w, qtd_casas_decimais_p, ie_ponto_virgula_p),1,2000);
                        else
                          ds_retorno_w := substr(ds_retorno_w || ' Vl.: ' || fis_nfe_campo_mascara(vl_descontos_item_w, qtd_casas_decimais_p, ie_ponto_virgula_p),1,2000);
                        end if;
                      end;
                    else
                      ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_descontos_item_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
                    end if;
                  end;
                elsif (ds_regra_w = '12') then
                  begin
                  ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_complemento_w || ie_caracter_pos_w,1,2000);
                  end;
                elsif (ds_regra_w = '81') then
                  begin

                  tx_tributo_item_iss_w:= 0;

                  begin
                  
                  select	coalesce(max(tx_tributo),0)
                  into STRICT	tx_tributo_item_iss_w
                  from	nota_fiscal_item_trib a,
                    tributo b
                  where	a.cd_tributo		= b.cd_tributo
                  and	b.ie_tipo_tributo 	= 'ISS'
                  and 	a.nr_sequencia		= nr_seq_nota_p
                  and 	a.nr_item_nf		= nr_item_nf_w;

                  exception
                  when others then
                    tx_tributo_item_iss_w:= 0;
                  end;

                  ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || tx_tributo_item_iss_w || ie_caracter_pos_w,1,2000);

                  end;
                end if;
              end;
            end loop;
            close c02;
          end;
				end loop;
				close c03;
        generated_items_w := true;
			elsif (ds_regra_w in ('32','33','53')) then
				open C05;
				loop
				fetch C05 into
					vl_ato_principal_w,
					vl_ato_auxiliar_w,
					vl_ato_nao_coop_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					begin
					if (ds_regra_w = '32') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || wheb_mensagem_pck.get_texto(308678) || fis_nfe_campo_mascara(vl_ato_principal_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '33') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || wheb_mensagem_pck.get_texto(308679) || fis_nfe_campo_mascara(vl_ato_auxiliar_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '53') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || wheb_mensagem_pck.get_texto(308680) || fis_nfe_campo_mascara(vl_ato_nao_coop_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					end if;
					end;
				end loop;
				close C05;
			elsif (ds_regra_w in ('34','35','36','37','38','39','40','41',
						'42','43','44','45','46','47','48','49','50','51','52','62','63','64','80')) then
				open C06;
				loop
				fetch C06 into
					ds_tributo_pis_w,
					vl_tributo_pis_w,
					tx_tributo_pis_w,
					ds_tributo_cofins_w,
					vl_tributo_cofins_w,
					tx_tributo_cofins_w,
					ds_tributo_icms_w,
					vl_tributo_icms_w,
					tx_tributo_icms_w,
					ds_tributo_iss_w,
					vl_tributo_iss_w,
					tx_tributo_iss_w,
					ds_tributo_ir_w,
					vl_tributo_ir_w,
					tx_tributo_ir_w,
					vl_base_calculo_ir_w,
					ds_tributo_inss_w,
					vl_tributo_inss_w,
					tx_tributo_inss_w,
					vl_base_calculo_inss_w,
					ds_tributo_csll_w,
					vl_tributo_csll_w,
					tx_tributo_csll_w;
				EXIT WHEN NOT FOUND; /* apply on C06 */
					begin
					-- PIS
					if (ds_regra_w = '34') and (ds_tributo_pis_w IS NOT NULL AND ds_tributo_pis_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_pis_w || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '35') and (vl_tributo_pis_w IS NOT NULL AND vl_tributo_pis_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_tributo_pis_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '36') and (tx_tributo_pis_w IS NOT NULL AND tx_tributo_pis_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_tributo_pis_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					-- COFINS
					elsif (ds_regra_w = '37') and (ds_tributo_cofins_w IS NOT NULL AND ds_tributo_cofins_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_cofins_w || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '38') and (vl_tributo_cofins_w IS NOT NULL AND vl_tributo_cofins_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_tributo_cofins_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '39') and (tx_tributo_cofins_w IS NOT NULL AND tx_tributo_cofins_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_tributo_cofins_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					-- ICMS
					elsif (ds_regra_w = '40') and (ds_tributo_icms_w IS NOT NULL AND ds_tributo_icms_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_icms_w || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '41') and (vl_tributo_icms_w IS NOT NULL AND vl_tributo_icms_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_tributo_icms_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '42') and (tx_tributo_icms_w IS NOT NULL AND tx_tributo_icms_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_tributo_icms_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					-- ISS
					elsif (ds_regra_w = '43') and (ds_tributo_iss_w IS NOT NULL AND ds_tributo_iss_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_iss_w || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '44') and (vl_tributo_iss_w IS NOT NULL AND vl_tributo_iss_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_tributo_iss_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '45') and (tx_tributo_iss_w IS NOT NULL AND tx_tributo_iss_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_tributo_iss_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					-- IR
					elsif (ds_regra_w = '46') and (ds_tributo_ir_w IS NOT NULL AND ds_tributo_ir_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_ir_w || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '47') and (vl_tributo_ir_w IS NOT NULL AND vl_tributo_ir_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_tributo_ir_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '48') and (tx_tributo_ir_w IS NOT NULL AND tx_tributo_ir_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_tributo_ir_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					-- INSS
					elsif (ds_regra_w = '49') and (ds_tributo_inss_w IS NOT NULL AND ds_tributo_inss_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_inss_w || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '50') and (vl_tributo_inss_w IS NOT NULL AND vl_tributo_inss_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_tributo_inss_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '51') and (tx_tributo_inss_w IS NOT NULL AND tx_tributo_inss_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_tributo_inss_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					elsif (ds_regra_w = '52') and (vl_base_calculo_inss_w IS NOT NULL AND vl_base_calculo_inss_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_base_calculo_inss_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;
					-- CSLL
					elsif (ds_regra_w = '62') and (ds_tributo_csll_w IS NOT NULL AND ds_tributo_csll_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_csll_w || ie_caracter_pos_w ,1,2000);
						end;
					elsif (ds_regra_w = '63') and (vl_tributo_csll_w IS NOT NULL AND vl_tributo_csll_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_tributo_csll_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
						end;
					elsif (ds_regra_w = '64') and (tx_tributo_csll_w IS NOT NULL AND tx_tributo_csll_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_tributo_csll_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
						end;
					elsif (ds_regra_w = '80') and (vl_base_calculo_ir_w IS NOT NULL AND vl_base_calculo_ir_w::text <> '') then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_base_calculo_ir_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
						end;						
					end if;
					end;
				end loop;
				close C06;

			elsif (ds_regra_w in ('65')) then
				begin
				-- VL_SALDO_TIT_RECEBER
				select	coalesce(sum(obter_saldo_titulo_receber(nr_titulo,trunc(clock_timestamp(),'dd'))),0)
				into STRICT	vl_saldo_tit_receber_w
				from	titulo_receber
				where	nr_seq_nf_saida = nr_seq_nota_p;

				if (coalesce(ie_saldo_tit_maior_zero_w,'N') = 'S') then
					begin

					if (coalesce(vl_saldo_tit_receber_w,0) > 0) then
						begin
						ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_saldo_tit_receber_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
						end;
					end if;

					end;
				else
					ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_saldo_tit_receber_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
				end if;
				end;

			elsif (ds_regra_w in ('66')) then
				begin
				--PR_FONTE_IBPT
				select	coalesce(max(cd_procedimento),0),
					coalesce(max(ie_origem_proced),0)
				into STRICT	cd_proc_item_w,
					ie_orig_proc_w
				from	nota_fiscal_item
				where	nr_sequencia = nr_seq_nota_p;

				pr_fonte_ibpt_w := 0;

				if (cd_proc_item_w > 0) then
					begin

					select	coalesce(obter_item_servico_proced(cd_proc_item_w,ie_orig_proc_w,cd_estabelecimento_p),0)
					into STRICT	nr_seq_servico_item_w
					;

					if (nr_seq_servico_item_w > 0) then
						begin

						select	coalesce(obter_dados_grupo_servico_item(nr_seq_servico_item_w,'IBPT'),0)
						into STRICT	pr_fonte_ibpt_w
						;

						end;
					end if;

					end;
				end if;


				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(pr_fonte_ibpt_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
				end;
			elsif (ds_regra_w in ('67')) then
				begin
				--VL_FONTE_IBPT
				select	coalesce(max(cd_procedimento),0),
					coalesce(max(ie_origem_proced),0)
				into STRICT	cd_proc_item_w,
					ie_orig_proc_w
				from	nota_fiscal_item
				where	nr_sequencia = nr_seq_nota_p;

				select	coalesce(vl_total_nota,0)
				into STRICT	vl_total_nota_w
				from	nota_fiscal n
				where	n.nr_sequencia	= nr_seq_nota_p;

				pr_fonte_ibpt_w := 0;
				vl_total_ibpt_w	:= 0;

				if (cd_proc_item_w > 0) then
					begin

					select	coalesce(obter_item_servico_proced(cd_proc_item_w,ie_orig_proc_w,cd_estabelecimento_p),0)
					into STRICT	nr_seq_servico_item_w
					;

					if (nr_seq_servico_item_w > 0) then
						begin

						select	coalesce(obter_dados_grupo_servico_item(nr_seq_servico_item_w,'IBPT'),0)
						into STRICT	pr_fonte_ibpt_w
						;

						end;
					end if;

					end;
				end if;

				select	coalesce(max(vl_mercadoria),0)
				into STRICT	vl_total_bruto_nota_w
				from	nota_fiscal n
				where	n.nr_sequencia	= nr_seq_nota_p;

				if	(pr_fonte_ibpt_w > 0 AND vl_total_bruto_nota_w > 0) then
					begin

					vl_total_ibpt_w := (vl_total_bruto_nota_w * (pr_fonte_ibpt_w / 100));

					end;
				end if;

				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_total_ibpt_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
				end;
			elsif (ds_regra_w in ('73','74','75','76','77','78')) then
				begin
				--VL_FONTE_IBPT_FED - 73

				--VL_FONTE_IBPT_EST - 74

				--VL_FONTE_IBPT_MUN - 75

				--PR_FONTE_IBPT_FED - 76

				--PR_FONTE_IBPT_EST - 77

				--PR_FONTE_IBPT_MUN - 78
				select	coalesce(max(vl_mercadoria),0)
				into STRICT	vl_total_bruto_nota_w
				from	nota_fiscal n
				where	n.nr_sequencia	= nr_seq_nota_p;

				open C08;
				loop
				fetch C08 into
					vet08;
				EXIT WHEN NOT FOUND; /* apply on C08 */
					begin

					if (vet08.nr_seq_item_serv > 0) then
						begin
						
						vl_total_ibpt_w := 0;

						if (ds_regra_w in ('73')) then
							begin
							select	coalesce(obter_dados_grupo_servico_item(vet08.nr_seq_item_serv,'IBPTFED'),0)
							into STRICT	pr_fonte_ibpt_w
							;

							if	(pr_fonte_ibpt_w > 0 AND vl_total_bruto_nota_w > 0) then
								begin

								vl_total_ibpt_w := (vl_total_bruto_nota_w * (pr_fonte_ibpt_w / 100));

								end;
							end if;

							ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_total_ibpt_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
							end;
						elsif (ds_regra_w in ('74')) then
							begin
							select	coalesce(obter_dados_grupo_servico_item(vet08.nr_seq_item_serv,'IBPTEST'),0)
							into STRICT	pr_fonte_ibpt_w
							;

							if	(pr_fonte_ibpt_w > 0 AND vl_total_bruto_nota_w > 0) then
								begin

								vl_total_ibpt_w := (vl_total_bruto_nota_w * (pr_fonte_ibpt_w / 100));

								end;
							end if;

							ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_total_ibpt_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
							end;
						elsif (ds_regra_w in ('75')) then
							begin
							select	coalesce(obter_dados_grupo_servico_item(vet08.nr_seq_item_serv,'IBPTMUN'),0)
							into STRICT	pr_fonte_ibpt_w
							;

							if	(pr_fonte_ibpt_w > 0 AND vl_total_bruto_nota_w > 0) then
								begin

								vl_total_ibpt_w := (vl_total_bruto_nota_w * (pr_fonte_ibpt_w / 100));

								end;
							end if;

							ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_total_ibpt_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
							end;	
						elsif (ds_regra_w in ('76')) then
							begin
							select	coalesce(obter_dados_grupo_servico_item(vet08.nr_seq_item_serv,'IBPTFED'),0)
							into STRICT	pr_fonte_ibpt_w
							;

							ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(pr_fonte_ibpt_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
							end;
						elsif (ds_regra_w in ('77')) then
							begin
							select	coalesce(obter_dados_grupo_servico_item(vet08.nr_seq_item_serv,'IBPTEST'),0)
							into STRICT	pr_fonte_ibpt_w
							;

							ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(pr_fonte_ibpt_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
							end;		
						elsif (ds_regra_w in ('78')) then
							begin
							select	coalesce(obter_dados_grupo_servico_item(vet08.nr_seq_item_serv,'IBPTMUN'),0)
							into STRICT	pr_fonte_ibpt_w
							;

							ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(pr_fonte_ibpt_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
							end;
						end if;

						end;
					end if;
					end;
				end loop;
				close C08;
				end;
			elsif (ds_regra_w = 82) then
				begin
				
				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_coparticipacao_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w,1,2000);
				
				end;
      elsif (ds_regra_w = regra_contract_company_code_w or ds_regra_w = regra_contract_number_w) then
        begin
          select max((select distinct max(pls_obter_dados_contrato(ms.nr_seq_contrato, 'N'))
            from    pls_mensalidade_segurado ms,
                    pls_contrato c,
                    pls_mensalidade m,
                    pls_segurado s
            where   ms.nr_seq_lote = (select  (substr(pls_obter_dados_mensalidade(a.nr_seq_mensalidade, 'L'), 1, 10))::numeric
                                    from  titulo_receber a 
                                    where a.nr_seq_nf_saida = n.nr_sequencia)
            and m.nr_sequencia	= ms.nr_seq_mensalidade
            and	s.nr_sequencia	= ms.nr_seq_segurado
            and	c.nr_sequencia	= s.nr_seq_contrato
            and (c.ie_situacao = 2 or c.ie_situacao = 3)
            and ms.nr_seq_mensalidade = n.nr_seq_mensalidade))
          into STRICT   contract_number_w                      
          from   nota_fiscal n
          where  n.nr_sequencia = nr_seq_nota_p;

          select  max(cd_operadora_empresa)
          into STRICT    contract_company_code_w
          from    pls_contrato
          where   nr_sequencia = contract_number_w;

          if (ds_regra_w = regra_contract_number_w) then
            begin
              ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || contract_number_w || ie_caracter_pos_w, 1, 2000);
            end;
          elsif (ds_regra_w = regra_contract_company_code_w) then
            begin
              ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || contract_company_code_w || ie_caracter_pos_w, 1, 2000);
            end;
          end if;
        end;
			elsif (ds_regra_w = regra_vl_vinculado_w) then
				begin
  				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || vl_vinculado_w || ie_caracter_pos_w, 1, 2000);
				end;
			elsif (ds_regra_w = regra_senha_atendimento_w) then
				begin
  				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || senha_atendimento_w || ie_caracter_pos_w, 1, 2000);
				end;
			elsif (ds_regra_w = regra_classif_atendimento_w) then
				begin
  				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || classificacao_atendimento_w || ie_caracter_pos_w, 1, 2000);
				end;
			elsif (ds_regra_w = regra_regra_dt_alta_w) then
				begin
  				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || dt_alta_w || ie_caracter_pos_w, 1, 2000);
				end;
			elsif (ds_regra_w = regra_nr_prontuario_w) then
				begin
  				ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_prontuario_w || ie_caracter_pos_w, 1, 2000);
				end;
			end if;
			end;
		end loop;
		close c01;
		end;
	elsif (ds_atributo_p = 'DS_INF_ADIC') then
		begin

		open c01;
		loop
		fetch c01 into
			ds_regra_w,
			ie_ordem_w,
			ie_saldo_tit_maior_zero_w,
			ie_caracter_ant_w,
			ie_caracter_pos_w,
			ie_exporta_trib_inf_adic_w,
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

				if (ds_regra_w in ('31','34','35','36','37','38','39','40','41',
						'42','43','44','45','46','47','48','49','50','51','52','62','63','64','80','83','84')) then
					begin
					open C07;
					loop
					fetch C07 into
						ds_tributo_pis_w,
						vl_tributo_pis_w,
						tx_tributo_pis_w,
						ie_retem_pis_w,
						ds_tributo_cofins_w,
						vl_tributo_cofins_w,
						tx_tributo_cofins_w,
						ie_retem_cofins_w,
						ds_tributo_icms_w,
						vl_tributo_icms_w,
						tx_tributo_icms_w,
						ie_retem_icms_w,
						ds_tributo_iss_w,
						vl_tributo_iss_w,
						tx_tributo_iss_w,
						ie_retem_iss_w,
						ds_tributo_ir_w,
						vl_tributo_ir_w,
						tx_tributo_ir_w,
						vl_base_calculo_ir_w,
						ie_retem_ir_w,
						ds_tributo_inss_w,
						vl_tributo_inss_w,
						tx_tributo_inss_w,
						vl_base_calculo_inss_w,
						ie_retem_inss_w,
						ds_tributo_csll_w,
						vl_tributo_csll_w,
						tx_tributo_csll_w,
						ie_retem_csll_w;
					EXIT WHEN NOT FOUND; /* apply on C07 */
						begin
						-- PIS
						if (ds_regra_w = '34') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_pis_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_pis_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_pis_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_pis_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_pis_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '35') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_pis_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_pis_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_pis_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_pis_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_pis_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '36') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_pis_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_pis_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_pis_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_pis_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_pis_w,1,2000);
								end if;
								end;
							end if;

							end;
						-- COFINS
						elsif (ds_regra_w = '37') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_cofins_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_cofins_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_cofins_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_cofins_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_cofins_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '38') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_cofins_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_cofins_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_cofins_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_cofins_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_cofins_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '39') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_cofins_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_cofins_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_cofins_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_cofins_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_cofins_w,1,2000);
								end if;
								end;
							end if;

							end;
						-- ICMS
						elsif (ds_regra_w = '40') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_icms_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_icms_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_icms_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_icms_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_icms_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '41') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_icms_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_icms_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_icms_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_icms_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_icms_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '42') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_icms_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_icms_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_icms_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_icms_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_icms_w,1,2000);
								end if;
								end;
							end if;

							end;
						-- ISS
						elsif (ds_regra_w = '43') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_iss_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_iss_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_iss_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_iss_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_iss_w,1,2000);
								end if;
								end;
							end if;


							end;
						elsif (ds_regra_w = '44') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_iss_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_iss_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_iss_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_iss_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_iss_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '45') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_iss_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_iss_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_iss_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_iss_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_iss_w,1,2000);
								end if;
								end;
							end if;

							end;
						-- IR
						elsif (ds_regra_w = '46') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_ir_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_ir_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_ir_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_ir_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_ir_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '47') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_ir_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_ir_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_ir_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_ir_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_ir_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '48') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_ir_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_ir_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_ir_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_ir_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_ir_w,1,2000);
								end if;
								end;
							end if;

							end;
						-- INSS
						elsif (ds_regra_w = '49') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_inss_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_inss_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_inss_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_inss_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || ds_tributo_inss_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '50') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_inss_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_inss_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_inss_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_inss_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || vl_tributo_inss_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '51') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_inss_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_inss_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_inss_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_inss_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || tx_tributo_inss_w,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '52') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || vl_base_calculo_inss_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_inss_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || vl_base_calculo_inss_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_inss_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || vl_base_calculo_inss_w,1,2000);
								end if;
								end;
							end if;

							end;
						-- CSLL
						elsif (ds_regra_w = '62') and (ds_tributo_csll_w IS NOT NULL AND ds_tributo_csll_w::text <> '') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_csll_w || ie_caracter_pos_w ,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_csll_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_csll_w || ie_caracter_pos_w ,1,2000);							end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_csll_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_tributo_csll_w || ie_caracter_pos_w ,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '63') and (vl_tributo_csll_w IS NOT NULL AND vl_tributo_csll_w::text <> '') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_tributo_csll_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_csll_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_tributo_csll_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);							
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_csll_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(vl_tributo_csll_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
								end if;
								end;
							end if;

							end;
						elsif (ds_regra_w = '64') and (tx_tributo_csll_w IS NOT NULL AND tx_tributo_csll_w::text <> '') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_tributo_csll_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_csll_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_tributo_csll_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);							
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_csll_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || fis_nfe_campo_mascara(tx_tributo_csll_w, qtd_casas_decimais_p, ie_ponto_virgula_p) || ie_caracter_pos_w ,1,2000);
								end if;
								end;
							end if;


							end;
						elsif (ds_regra_w = '80') then
							begin

							if (ie_exporta_trib_inf_adic_w = 'T') then
								begin
								ds_retorno_w := substr(ds_retorno_w || vl_base_calculo_ir_w,1,2000);
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'Z') then
								begin
								if (ie_retem_inss_w = 'N') then
								ds_retorno_w := substr(ds_retorno_w || vl_base_calculo_ir_w,1,2000);
								end if;
								end;
							elsif (ie_exporta_trib_inf_adic_w = 'R') then
								begin
								if (ie_retem_inss_w = 'S') then
								ds_retorno_w := substr(ds_retorno_w || vl_base_calculo_ir_w,1,2000);
								end if;
								end;
							end if;

							end;							
							
						end if;
						end;
					end loop;
					close C07;

          if (ds_regra_w = regra_contract_company_code_w or ds_regra_w = regra_contract_number_w) then
            begin
              select max((select distinct max(pls_obter_dados_contrato(ms.nr_seq_contrato, 'N'))
                from    pls_mensalidade_segurado ms,
                        pls_contrato c,
                        pls_mensalidade m,
                        pls_segurado s
                where   ms.nr_seq_lote = (select  (substr(pls_obter_dados_mensalidade(a.nr_seq_mensalidade, 'L'), 1, 10))::numeric
                                        from  titulo_receber a 
                                        where a.nr_seq_nf_saida = n.nr_sequencia)
                and m.nr_sequencia	= ms.nr_seq_mensalidade
                and	s.nr_sequencia	= ms.nr_seq_segurado
                and	c.nr_sequencia	= s.nr_seq_contrato
                and (c.ie_situacao = 2 or c.ie_situacao = 3)
                and ms.nr_seq_mensalidade = n.nr_seq_mensalidade))
              into STRICT   contract_number_w                      
              from   nota_fiscal n
              where  n.nr_sequencia = nr_seq_nota_p;

              select  max(cd_operadora_empresa)
              into STRICT    contract_company_code_w
              from    pls_contrato
              where   nr_sequencia = contract_number_w;

              if (ds_regra_w = regra_contract_number_w) then
                begin
                  ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || contract_number_w || ie_caracter_pos_w, 1, 2000);
                end;
              elsif (ds_regra_w = regra_contract_company_code_w) then
                begin
                  ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || contract_company_code_w || ie_caracter_pos_w, 1, 2000);
                end;
              end if;
            end;
          elsif (ds_regra_w = regra_vl_vinculado_w) then
            begin
              ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || vl_vinculado_w || ie_caracter_pos_w, 1, 2000);
            end;
          elsif (ds_regra_w = regra_senha_atendimento_w) then
            begin
              ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || senha_atendimento_w || ie_caracter_pos_w, 1, 2000);
            end;
          elsif (ds_regra_w = regra_classif_atendimento_w) then
            begin
              ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || classificacao_atendimento_w || ie_caracter_pos_w, 1, 2000);
            end;
          elsif (ds_regra_w = regra_regra_dt_alta_w) then
            begin
              ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || dt_alta_w || ie_caracter_pos_w, 1, 2000);
            end;
          elsif (ds_regra_w = regra_nr_prontuario_w) then
            begin
              ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || nr_prontuario_w || ie_caracter_pos_w, 1, 2000);
            end;
          end if;

					if (ds_regra_w = '31') then
						begin


						select	ds_texto_padrao,
							coalesce(ie_txt_inf_adic,'N')
						into STRICT	ds_texto_padrao_w,
							ie_txt_inf_adic_w
						from	regra_descricao_rps
						where	cd_estabelecimento	= cd_estabelecimento_p
						and 	nr_sequencia		= nr_sequencia_w
						/*and	((cd_convenio = cd_convenio_w) or (cd_convenio is null))
						and	((cd_cnpj = cd_cgc_w) or (cd_cnpj is null))
						and	((cd_operacao_nf = cd_operacao_nf_w) or ((cd_operacao_nf is null) and ((select count(1)
																from	regra_descricao_rps x
																where	x.cd_estabelecimento	= cd_estabelecimento_p
																and	((x.cd_convenio = cd_convenio_w) or (x.cd_convenio is null))
																and	((x.cd_cnpj = cd_cgc_w) or (x.cd_cnpj is null))
																and	cd_operacao_nf = cd_operacao_nf_w
																) <= 0)))*/
						and	ds_regra = 31
						and 	coalesce(ie_situacao,'A') = 'A'
						order by cd_convenio,nr_sequencia LIMIT 1;

						if (ie_txt_inf_adic_w = 'S') then
							begin
							ds_retorno_w := substr(ds_retorno_w || ie_caracter_ant_w || ds_texto_padrao_w || ie_caracter_pos_w,1,2000);
							end;
						end if;


						end;
					end if;
					end;

				end if;
			end;
		end loop;
		close c01;
		end;
	end if;

	select	substr(nfe_elimina_caractere_especial(ds_retorno_w),1,2000)
	into STRICT	ds_retorno_w
	;

	end;
else
	begin
	select 	nfe_elimina_caractere_especial(CASE WHEN coalesce(nr_seq_protocolo::text, '') = '' THEN		substr((select substr(obter_nome_pf(a.cd_pessoa_fisica),1,150)		from	atendimento_paciente a,			conta_paciente c		where	a.nr_atendimento = c.nr_atendimento		and	c.nr_interno_conta = n.nr_interno_conta) ||  '   ' ||		(select	substr(obter_dados_pf(a.cd_pessoa_fisica,'CPF'),1,11)		from	atendimento_paciente a,			conta_paciente c		where	a.nr_atendimento = c.nr_atendimento		and	c.nr_interno_conta = n.nr_interno_conta) || ' '  ||			substr(obter_select_concatenado( 'select decode(a.cd_material, null,
				substr(obter_descricao_procedimento(a.cd_procedimento, ie_origem_proced),1,240),
				substr(obter_desc_material(a.cd_material),1,100)) || chr(32) || b.ds_observacao
				from nota_fiscal_item a, nota_fiscal b where a.nr_sequencia = b.nr_sequencia and a.nr_sequencia = '|| n.nr_sequencia,null,' '),1,1000) || '   ' ||		'Perodo de fechamento '||		(select	c.dt_periodo_inicial		from	atendimento_paciente a,			conta_paciente c		where	a.nr_atendimento = c.nr_atendimento		and	c.nr_interno_conta = n.nr_interno_conta) || 'a '  ||		(select	c.dt_periodo_final		from	atendimento_paciente a,			conta_paciente c		where	a.nr_atendimento = c.nr_atendimento		and	c.nr_interno_conta = n.nr_interno_conta),1,1000)  ELSE substr(obter_select_concatenado(		'select decode(a.cd_material, null,
	substr(obter_descricao_procedimento(a.cd_procedimento, ie_origem_proced),1,240),
	substr(obter_desc_material(a.cd_material),1,100)) || chr(32)  || b.ds_observacao
		from nota_fiscal_item a, nota_fiscal b where a.nr_sequencia = b.nr_sequencia and a.nr_sequencia = ' || n.nr_sequencia,null,' '),1,1000) END ) ds_servicos
	into STRICT	ds_retorno_w
	from	nota_fiscal n
	where	n.nr_sequencia = nr_seq_nota_p;
	end;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_descricao_rps ( cd_estabelecimento_p bigint, nr_seq_nota_p bigint, ds_atributo_p text, ie_ponto_virgula_p text default 'V', qtd_casas_decimais_p bigint default 2, nr_seq_item_p bigint default 0) FROM PUBLIC;

