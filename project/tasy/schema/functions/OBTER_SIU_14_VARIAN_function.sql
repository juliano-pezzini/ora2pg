-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_siu_14_varian (nr_seq_agenda_p bigint) RETURNS text AS $body$
BEGIN
declare
json_aux_w   philips_json;
ds_message_w text;
nr_minuto_duracao_w		bigint;
nr_atendimento_w		bigint;
data_evento_w			varchar(15);
dt_agenda_w			varchar(15);
cd_equip_externo_w		varchar(30);
cd_pessoa_fisica_w		varchar(15);
family_name_patient_w		varchar(100);
given_name_patient_w		varchar(100);
middleinitialorname_patient_w	varchar(100);
dt_message_w                	varchar(14);
hl7_itens_varian_seq_w		numeric(38);
family_name_mother_w          	varchar(100);
dt_nascimento_w			varchar(14);
nr_prontuario_w			bigint;
cd_doenca_cid_w			varchar(15);
nr_seq_can_loco_regional_w	bigint;
ds_doenca_cid_w			varchar(50);
dt_atualizacao_loco_reg_w	varchar(15);
dt_liberacao_w			varchar(15);

begin
json_aux_w := philips_json();

select	nr_minuto_duracao,
	nr_atendimento,
	to_char(clock_timestamp(), 'YYYYMMDDHH24MISS'),
	to_char(dt_agenda, 'YYYYMMDDHH24MISS'),
	obter_rxt_equip_externo(nr_seq_equipamento)
into STRICT	nr_minuto_duracao_w,
	nr_atendimento_w,
	data_evento_w,
	dt_agenda_w,
	cd_equip_externo_w
from	rxt_agenda
where	nr_sequencia = nr_seq_agenda_p;

select	max(a.cd_doenca_cid),
	max(a.nr_sequencia),
	max(obter_desc_cid(a.cd_doenca_cid)),
	max(to_char(a.dt_atualizacao_nrec, 'YYYYMMDDHH24MISS')),
	max(to_char(a.dt_liberacao, 'YYYYMMDDHH24MISS')) 
into STRICT	cd_doenca_cid_w,
	nr_seq_can_loco_regional_w,
	ds_doenca_cid_w,
	dt_atualizacao_loco_reg_w, 
	dt_liberacao_w
from	can_loco_regional a,
	rxt_tumor b,
	rxt_tratamento c,
	rxt_agenda d
where	d.nr_seq_tratamento = c.nr_sequencia
and	c.nr_seq_tumor = b.nr_sequencia
and	b.nr_seq_loco_regional = a.nr_sequencia
and	d.nr_sequencia = nr_seq_agenda_p;

select 	obter_cd_pes_fis_atend(nr_atendimento_w)
into STRICT 	cd_pessoa_fisica_w
;

select	to_char(clock_timestamp(), 'YYYYMMDDHH24MISS')
into STRICT	dt_message_w
;

select	nextval('hl7_itens_varian_seq')
into STRICT	hl7_itens_varian_seq_w
;

select	max(nr_prontuario)
into STRICT	nr_prontuario_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_w;

select	to_char(obter_data_nascto_pf(cd_pessoa_fisica_w), 'YYYYMMDDHH24MISS'),
	substr(elimina_acentuacao(obter_parte_nome_pf(obter_nome_pf(cd_pessoa_fisica_w),'sobrenome')), 1, 100) family_name_patient,
	substr(elimina_acentuacao(obter_parte_nome_pf(obter_nome_pf(cd_pessoa_fisica_w),'nome')), 1, 100) given_name_patient, 
	substr(elimina_acentuacao(obter_parte_nome_pf(obter_nome_pf(cd_pessoa_fisica_w),'restonome')), 1, 100) middleinitialorname_patient,
	substr(elimina_acentuacao(obter_parte_nome_pf(obter_nome_mae_pf(cd_pessoa_fisica_w),'sobrenome')), 1, 100) family_name_mother
into STRICT	dt_nascimento_w,
	family_name_patient_w,
	given_name_patient_w,
	middleinitialorname_patient_w,
	family_name_mother_w
;

json_aux_w.put('NR_MINUTO_DURACAO',coalesce(nr_minuto_duracao_w,''));
json_aux_w.put('CD_PESSOA_FISICA',coalesce(cd_pessoa_fisica_w,''));		
json_aux_w.put('DATA_EVENTO',coalesce(data_evento_w,''));
json_aux_w.put('DT_AGENDA',coalesce(dt_agenda_w,''));
json_aux_w.put('CD_EQUIP_EXTERNO',coalesce(cd_equip_externo_w,''));
json_aux_w.put('FAMILY_NAME_PATIENT',family_name_patient_w);				
json_aux_w.put('GIVEN_NAME_PATIENT',given_name_patient_w);	
json_aux_w.put('MIDDLEINITIALORNAME_PATIENT',middleinitialorname_patient_w);	
json_aux_w.put('MESSAGECONTROLID', hl7_itens_varian_seq_w);
json_aux_w.put('DT_MESSAGE', dt_message_w);
json_aux_w.put('FAMILY_NAME_MOTHER',family_name_mother_w);
json_aux_w.put('NR_PRONTUARIO', nr_prontuario_w);		
json_aux_w.put('CD_DOENCA_CID', CD_DOENCA_CID_w);		
json_aux_w.put('NR_SEQ_CAN_LOCO_REGIONAL', nr_Seq_can_loco_regional_w);		
json_aux_w.put('DS_DOENCA_CID', ds_doenca_cid_w);		
json_aux_w.put('DT_LIBERACAO', dt_liberacao_w);		
json_aux_w.put('DT_ATUALIZACAO_LOCO_REG', dt_atualizacao_loco_reg_w);		

dbms_lob.createtemporary(ds_message_w, TRUE);
json_aux_w.(ds_message_w);

return ds_message_w;
end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_siu_14_varian (nr_seq_agenda_p bigint) FROM PUBLIC;

