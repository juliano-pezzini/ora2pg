-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regulated_price ( ie_informacao_p text, cd_material_p rule_regulated_price.cd_material%type) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(255)  := null;
/*
ie_informacao_p
	MR  -> Se material regulado / If regulated material
	MRV -> Se material regulado - venda / If regulated material - sale
	VMC -> Valor maximo de compra / Maximum purchase amount
	VMV -> Valor maximo de venda / Maximum sale amount
	NAT -> Nacionalidade / Nationality
*/
BEGIN

	if (ie_informacao_p = 'MR') then
		select	(CASE WHEN (max(nr_sequencia) IS NOT NULL AND (max(nr_sequencia))::text <> '') THEN 'S' ELSE 'N' END)
		into STRICT	ds_retorno_w
		from	rule_regulated_price
		where	cd_material = cd_material_p
		and		(vl_max_purchase IS NOT NULL AND vl_max_purchase::text <> '')
		and		trunc(clock_timestamp(), 'dd') between coalesce(dt_start_purchase, trunc(clock_timestamp(), 'dd')) and coalesce(dt_end_purchase, trunc(clock_timestamp(), 'dd'));

	elsif (ie_informacao_p = 'MRV') then
		select	(CASE WHEN (max(nr_sequencia) IS NOT NULL AND (max(nr_sequencia))::text <> '') THEN 'S' ELSE 'N' END)
		into STRICT	ds_retorno_w
		from	rule_regulated_price
		where	cd_material = cd_material_p
		and		(vl_max_sale IS NOT NULL AND vl_max_sale::text <> '')
		and		trunc(clock_timestamp(), 'dd') between coalesce(dt_start_sale, trunc(clock_timestamp(), 'dd')) and coalesce(dt_end_sale, trunc(clock_timestamp(), 'dd'));

	elsif (ie_informacao_p = 'VMC') then
		select	max(vl_max_purchase)
		into STRICT	ds_retorno_w
		from	rule_regulated_price
		where	cd_material = cd_material_p
		and		(vl_max_purchase IS NOT NULL AND vl_max_purchase::text <> '')
		and		trunc(clock_timestamp(), 'dd') between coalesce(dt_start_purchase, trunc(clock_timestamp(), 'dd')) and coalesce(dt_end_purchase, trunc(clock_timestamp(), 'dd'));

	elsif (ie_informacao_p = 'VMV') then
		select	max(vl_max_sale)
		into STRICT	ds_retorno_w
		from	rule_regulated_price
		where	cd_material = cd_material_p
		and		(vl_max_sale IS NOT NULL AND vl_max_sale::text <> '')
		and		trunc(clock_timestamp(), 'dd') between coalesce(dt_start_sale, trunc(clock_timestamp(), 'dd')) and coalesce(dt_end_sale, trunc(clock_timestamp(), 'dd'));
	
	elsif (ie_informacao_p = 'NAT') then
		select	max(cd_nationality)
		into STRICT	ds_retorno_w
		from	rule_regulated_price
		where	cd_material = cd_material_p
		and		(cd_nationality IS NOT NULL AND cd_nationality::text <> '');

	end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regulated_price ( ie_informacao_p text, cd_material_p rule_regulated_price.cd_material%type) FROM PUBLIC;

