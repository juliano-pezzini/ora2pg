-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_guia_digitacao_web ( nr_seq_usu_prest_p bigint, cd_guia_p text) RETURNS varchar AS $body$
DECLARE


qt_registros_w          bigint;
qt_reg_conta_w          bigint := 0;
qt_reg_conta_compl_w    bigint := 0;
ie_retorno_w            varchar(1) := 'L';
nr_seq_guia_w           bigint;
qt_registro_guia_w      bigint;
ie_retorno_reg_bloq_w   varchar(10);

/*
ie_retorno_w =
    'N'     : Não encontrada
    'C'     : Já apresentada
    'L'     : OK
*/
BEGIN

if (cd_guia_p IS NOT NULL AND cd_guia_p::text <> '') then

        select  max(nr_sequencia)
        into STRICT    nr_seq_guia_w
        from    pls_guia_plano
        where   cd_guia = cd_guia_p
        and     ie_status = 1;

        if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then

		ie_retorno_w := 'N';

			select  count(1)
			into STRICT    qt_reg_conta_w
			from    pls_conta
			where   nr_seq_guia = nr_seq_guia_w
			and     ie_status not in ('C','U');

			-- não pode solicitar para uma guia que já está apresentada
			if ( qt_reg_conta_w > 0 ) then
				ie_retorno_w := 'C';
			end if;

			if (ie_retorno_w = 'N') then

				--verifica se o usuário prestador, tem o prestador da guia
				select  count(1)
				into STRICT    qt_registro_guia_w
				from    pls_guia_plano a
				where   a.nr_sequencia = nr_seq_guia_w
				and (coalesce(a.nr_seq_prestador::text, '') = '' or
				exists ( 	SELECT 1
							from 	pls_usuario_web u,
									pls_prestador_usuario_web p
							where   u.ie_situacao         	= 'A'
							and     p.ie_situacao         	= 'A'
							and     u.nr_sequencia         	= p.nr_seq_usuario
							and     p.nr_seq_usuario		= nr_seq_usu_prest_p
							and     p.nr_seq_prestador      = a.nr_seq_prestador));

				if ( qt_registro_guia_w > 0 ) then
					ie_retorno_w := 'L';
				end if;

			end if;

        end if;

end if;

return    ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_guia_digitacao_web ( nr_seq_usu_prest_p bigint, cd_guia_p text) FROM PUBLIC;

