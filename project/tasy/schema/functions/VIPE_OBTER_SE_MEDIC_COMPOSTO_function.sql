-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION vipe_obter_se_medic_composto ( nr_prescricao_p bigint, nr_seq_material_p bigint, nr_agrupamento_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ie_medic_composto_w	varchar(1);
ds_retorno_w		varchar(255);
nr_seq_ficha_tecnica_w	bigint;
cont_w			bigint;


BEGIN
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') and (nr_agrupamento_p IS NOT NULL AND nr_agrupamento_p::text <> '') then

	if (ie_opcao_p = 'A') then
		select	CASE WHEN count(*)=0 THEN ''  ELSE 'S' END
		into STRICT	ie_medic_composto_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	<> nr_seq_material_p
		and	nr_agrupamento	= nr_agrupamento_p
		and	ie_agrupador	= 1
		and	coalesce(cd_kit_material::text, '') = ''
		and	coalesce(nr_seq_substituto::text, '') = '';

		ds_retorno_w	:= ie_medic_composto_w;
	elsif (ie_opcao_p = 'P') then
		select	max(a.nr_seq_ficha_tecnica)
		into STRICT	nr_seq_ficha_tecnica_w
		from	material a,
			prescr_material b
		where	a.cd_material	= b.cd_material
		and	b.nr_prescricao	= nr_prescricao_p
		and	b.nr_sequencia	= nr_seq_material_p;

		select	CASE WHEN count(*)=0 THEN ''  ELSE 'P' END
		into STRICT	ie_medic_composto_w
		from	material b,
			prescr_material a
		where	a.cd_material		= b.cd_material
		and	a.nr_prescricao		= nr_prescricao_p
		and	a.nr_sequencia		<> nr_seq_material_p
		and	a.nr_agrupamento	= nr_agrupamento_p
		and	b.nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w
		and	a.ie_agrupador		= 1
		and	coalesce(a.cd_kit_material::text, '') = '';

		if (coalesce(ie_medic_composto_w::text, '') = '') then
			select	CASE WHEN count(*)=0 THEN ''  ELSE 'S' END
			into STRICT	ie_medic_composto_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	<> nr_seq_material_p
			and	nr_agrupamento	= nr_agrupamento_p
			and	ie_agrupador	= 1
			and	coalesce(cd_kit_material::text, '') = '';
		end if;

		ds_retorno_w	:= ie_medic_composto_w;
	elsif (ie_opcao_p = 'D') then
		ds_retorno_w	:= '';
		select	max(a.nr_seq_ficha_tecnica)
		into STRICT	nr_seq_ficha_tecnica_w
		from	material a,
			prescr_material b
		where	a.cd_material	= b.cd_material
		and	b.nr_prescricao	= nr_prescricao_p
		and	b.nr_sequencia	= nr_seq_material_p;

		if (obter_se_medic_do_paciente(nr_prescricao_p,nr_seq_material_p) = 'S') then

			select	count(*)
			into STRICT	cont_w
			from	material b,
				prescr_material a
			where	a.cd_material		= b.cd_material
			and	a.nr_prescricao		= nr_prescricao_p
			and	a.nr_sequencia		<> nr_seq_material_p
			and	a.nr_agrupamento	= nr_agrupamento_p
			and	b.nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w
			and	a.ie_agrupador		= 1
			and	coalesce(a.cd_kit_material::text, '') = '';

			if (cont_w > 0) then
				select	substr(max(coalesce(CASE WHEN coalesce(a.ds_medic_nao_padrao::text, '') = '' THEN null  ELSE a.ds_medic_nao_padrao || ' ' || wheb_mensagem_pck.get_texto(494867) END , b.ds_reduzida)),1,254)
				into STRICT	ds_retorno_w
				from	material b,
					prescr_material a
				where	a.cd_material		= b.cd_material
				and	a.nr_prescricao		= nr_prescricao_p
				and	a.nr_sequencia		= nr_seq_material_p;
			end if;

			if (coalesce(ds_retorno_w::text, '') = '') then
				select	substr(max(CASE WHEN coalesce(a.ds_medic_nao_padrao::text, '') = '' THEN null  ELSE a.ds_medic_nao_padrao || ' ' || wheb_mensagem_pck.get_texto(494867) END ),1,254)
				into STRICT	ds_retorno_w
				from	material b,
					prescr_material a
				where	a.cd_material		= b.cd_material
				and	a.nr_prescricao		= nr_prescricao_p
				and	a.nr_sequencia		= nr_seq_material_p;

				if (coalesce(ds_retorno_w::text, '') = '') then
					select	substr(max(coalesce(CASE WHEN coalesce(a.ie_medicacao_paciente, 'N') ='N' THEN null  ELSE b.ds_material || ' ' || wheb_mensagem_pck.get_texto(494867) END , b.ds_material)),1,254)
					into STRICT	ds_retorno_w
					from	material b,
						prescr_material a
					where	a.cd_material		= b.cd_material
					and	a.nr_prescricao		= nr_prescricao_p
					and	a.nr_sequencia		= nr_seq_material_p;
				end if;
			end if;

		else

			select	substr(max(coalesce(a.ds_medic_nao_padr, b.ds_material)),1,254)
			into STRICT	ds_retorno_w
			from	material b,
					prescr_material a
			where	a.cd_material	= b.cd_material
			and		a.nr_prescricao	= nr_prescricao_p
			and		a.nr_sequencia	= nr_seq_material_p;

		end if;
	end if;
end if;
ds_retorno_w	:= substr(ds_retorno_w,1,240);
return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION vipe_obter_se_medic_composto ( nr_prescricao_p bigint, nr_seq_material_p bigint, nr_agrupamento_p bigint, ie_opcao_p text) FROM PUBLIC;

