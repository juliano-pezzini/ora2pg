-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_estoque_lote_obg ( cd_material_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ie_obg_estoque_lote_w	varchar(1) := 'N';
nr_regras_w		integer;
cd_grupo_material_w	smallint;
cd_subgrupo_w		smallint;
cd_classe_material_w	integer;
nr_seq_familia_w		bigint;

c01 CURSOR FOR
SELECT	coalesce(ie_obg_estoque_lote,'N')
from	regra_nf_lote_fornec
where	coalesce(cd_grupo_material, cd_grupo_material_w)	= cd_grupo_material_w
and	coalesce(cd_subgrupo_material, cd_subgrupo_w)	= cd_subgrupo_w
and	coalesce(cd_classe_material, cd_classe_material_w)	= cd_classe_material_w
and	coalesce(nr_seq_familia, nr_seq_familia_w)		= nr_seq_familia_w
and	coalesce(cd_material, cd_material_p)		= cd_material_p
and	coalesce(cd_estab_regra, cd_estabelecimento_p) 	= cd_estabelecimento_p
order by	cd_material desc,
	cd_classe_material desc,
	cd_subgrupo_material desc,
	cd_grupo_material desc;


BEGIN

begin
select	1
into STRICT	nr_regras_w
from	regra_nf_lote_fornec
where	coalesce(cd_estab_regra, cd_estabelecimento_p) = cd_estabelecimento_p  LIMIT 1;
exception
when others then
	nr_regras_w	:= 0;
end;

if (nr_regras_w	= 0) then
	ie_obg_estoque_lote_w		:= 'N';
else
	begin
	
	/* OS 2005249 - Removida a utilização da view estrutura_material_v pois esta function é chamada pela trigger 
	   MATERIAL_ESTAB_ATUAL. Como a view está consultando a própria tabela MATERIAL_ESTAB, estava gerando erro. */
	Select max(d.cd_grupo_material),
           max(c.cd_subgrupo_material),
           max(b.cd_classe_material),
           coalesce(max(a.nr_seq_familia),0)
      into STRICT cd_grupo_material_w,
           cd_subgrupo_w,
           cd_classe_material_w,
           nr_seq_familia_w
      FROM grupo_material d, subgrupo_material c, classe_material b, material a
LEFT OUTER JOIN material_familia e ON (a.nr_seq_familia = e.nr_sequencia)
WHERE a.cd_classe_material	  = b.cd_classe_material and b.cd_subgrupo_material	= c.cd_subgrupo_material and c.cd_grupo_material	  = d.cd_grupo_material  and a.cd_material          = cd_material_p;

	open c01;
	loop
	fetch c01 into	
		ie_obg_estoque_lote_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */		
	end loop;
	close c01;
	end;
end if;

return coalesce(ie_obg_estoque_lote_w, 'N');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_estoque_lote_obg ( cd_material_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

