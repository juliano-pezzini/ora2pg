-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nosso_numero_pagador ( nr_seq_pagador_p bigint, nr_titulo_p bigint) RETURNS varchar AS $body$
DECLARE



ds_retorno_w			varchar(255);
ie_regra_w			varchar(3);
nr_fixo_w			bigint;
ds_rotina_digito_w		varchar(15);
nr_digito_w			bigint;
ds_digito_w			varchar(3);
nr_atual_w			bigint;
qt_dig_numero_w			bigint;
qt_dig_verif_w			bigint;
cd_estabelecimento_w		smallint;

nr_seq_conta_banco_w		bigint;
cd_agencia_w			varchar(20);
cd_banco_w			varchar(20);
cd_conta_w			varchar(20);
cd_carteira_w			varchar(20);
cd_carteira_tit_w		varchar(20);
nr_numero_calculo_w		varchar(40);


BEGIN

select	coalesce(nr_seq_conta_banco,0)
into STRICT	nr_seq_conta_banco_w
from	pls_contrato_pagador_fin
where	nr_seq_pagador = nr_seq_pagador_p
and	coalesce(dt_fim_vigencia::text, '') = '';

if (nr_seq_conta_banco_w <> 0) then
	select	cd_banco
	into STRICT	cd_banco_w
	from	banco_estabelecimento
	where	nr_sequencia = nr_seq_conta_banco_w;
else
	select	cd_banco
	into STRICT	cd_banco_w
	from	pls_contrato_pagador_fin
	where	nr_seq_pagador = nr_seq_pagador_p
	and	coalesce(dt_fim_vigencia::text, '') = '';
end if;

-- Obter a regra para o estabelecimento do título
select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	titulo_receber
where	nr_titulo = nr_titulo_p;

select	ie_regra,
	nr_fixo,
	ds_rotina_digito,
	nr_Atual,
	coalesce(qt_dig_numero,length(nr_titulo_p)),
	coalesce(qt_dig_verif,1)
into STRICT	ie_regra_w,
	nr_fixo_w,
	ds_rotina_digito_w,
	nr_atual_w,
	qt_dig_numero_w,
	qt_dig_verif_w
from	banco_regra_numero
where	cd_banco		= cd_banco_w
and	cd_estabelecimento	= cd_estabelecimento_w;

/* Busca a carteira pelo título quando título está prorrogado - OS 871693*/

select	substr(max(b.cd_carteira),1,20)
into STRICT	cd_carteira_tit_w
from	banco_carteira b,
	titulo_receber a
where	b.nr_sequencia  = a.nr_seq_carteira_cobr
and	a.nr_titulo 	= nr_titulo_p
and	to_char(a.dt_pagamento_previsto,'dd/mm/yyyy') > to_char(a.dt_vencimento,'dd/mm/yyyy');

if (ie_regra_w	= 'T') then
	ds_retorno_w	:= nr_titulo_p;
elsif (ie_regra_w	= 'FT') then
	if (qt_dig_numero_w > 0) then
		ds_retorno_w	:= to_char(nr_fixo_w) || lpad(nr_titulo_p,qt_dig_numero_w - length(nr_fixo_w),0);
	else
		ds_retorno_w	:= to_char(nr_fixo_w) || nr_titulo_p;
	end if;
elsif (ie_regra_w	= 'FTD') then
	begin

	select	Calcula_Digito(ds_rotina_digito_w, (to_char(nr_fixo_w) || nr_titulo_p)::numeric )
	into STRICT	nr_digito_w
	;

	ds_retorno_w	:= to_char(nr_fixo_w) || nr_titulo_p || nr_digito_w;

	end;
elsif (ie_regra_w = 'S') then
	ds_retorno_w	:= to_char(nr_atual_w);
elsif (ie_regra_w = 'TD') then
	begin
	if (cd_banco_w = 237) then
		select	max(a.cd_carteira)
		into STRICT	cd_carteira_w
		from	banco_estabelecimento a
		where	a.nr_sequencia	= nr_seq_conta_banco_w;

		ds_digito_w	:=	Calcula_Digito(ds_rotina_digito_w, cd_carteira_w || lpad(to_char(nr_titulo_p),qt_dig_numero_w - qt_dig_verif_w,'0'));
		if (ds_digito_w = '-1') then
			ds_digito_w	:= 'P';
		end if;

		ds_retorno_w	:= 	lpad(to_char(nr_titulo_p),qt_dig_numero_w - qt_dig_verif_w,'0') || '-' || lpad(to_char(ds_digito_w),qt_dig_verif_w,'0');
	else
		nr_digito_w	:=	Calcula_Digito(ds_rotina_digito_w,lpad(to_char(nr_titulo_p),qt_dig_numero_w - qt_dig_verif_w,'0'));
		ds_retorno_w	:= 	lpad(to_char(nr_titulo_p),qt_dig_numero_w - qt_dig_verif_w,'0') || lpad(to_char(nr_digito_w),qt_dig_verif_w,'0');
	end if;

	end;

/* Francisco - OS 228238 - 13/08/2010 */

/* Padrão Itaú */

elsif (ie_regra_w = 'ACC') then
	select	max(nr_seq_conta_banco)
	into STRICT	nr_seq_conta_banco_w
	from	titulo_receber a
	where	a.nr_titulo	= nr_titulo_p;

	if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') then
		select	a.cd_agencia_bancaria,
			a.cd_conta,
			coalesce(cd_carteira_tit_w,a.cd_carteira) /* jbneto - OS 871693 - Coloca carteira do título, caso não tenha coloca a carteira padrão do banco*/
		into STRICT	cd_agencia_w,
			cd_conta_w,
			cd_carteira_w
		from	banco_estabelecimento a
		where	a.nr_sequencia	= nr_seq_conta_banco_w;

		nr_numero_calculo_w	:= lpad(cd_agencia_w,4,'0') || cd_conta_w || lpad(cd_carteira_w,3,'0') || lpad(to_char(nr_titulo_p),qt_dig_numero_w,'0');
		nr_digito_w		:= calcula_digito('MODULO10',nr_numero_calculo_w);

		ds_retorno_w	:= lpad(cd_carteira_w,3,'0') || '/' || lpad(to_char(nr_titulo_p),qt_dig_numero_w,'0') || '-' || nr_digito_w;

	else
		ds_retorno_w	:= null;
	end if;
elsif (ie_regra_w = 'ACS') then
	select	max(nr_seq_conta_banco)
	into STRICT	nr_seq_conta_banco_w
	from	titulo_receber a
	where	a.nr_titulo	= nr_titulo_p;

	if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') then
		select	a.cd_agencia_bancaria,
			a.cd_conta,
			a.cd_carteira
		into STRICT	cd_agencia_w,
			cd_conta_w,
			cd_carteira_w
		from	banco_estabelecimento a
		where	a.nr_sequencia	= nr_seq_conta_banco_w;

		nr_numero_calculo_w	:= lpad(cd_agencia_w,4,'0') || cd_conta_w || lpad(cd_carteira_w,3,'0') || lpad(to_char(nr_atual_w),qt_dig_numero_w,'0');
		nr_digito_w		:= calcula_digito('MODULO10',nr_numero_calculo_w);

		ds_retorno_w	:= lpad(cd_carteira_w,3,'0') || '/' || lpad(to_char(nr_atual_w),qt_dig_numero_w,'0') || '-' || nr_digito_w;

	else
		ds_retorno_w	:= null;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nosso_numero_pagador ( nr_seq_pagador_p bigint, nr_titulo_p bigint) FROM PUBLIC;

