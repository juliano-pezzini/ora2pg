-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION plt_obter_item_plano_atual ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_tabela_p text, ie_opcao_p text, ie_periodo_p text, dt_inicial_p timestamp, dt_final_p timestamp) RETURNS bigint AS $body$
DECLARE

/*
ie_opcao
P - nr_prescricao
S - nr_sequencia
*/
nr_prescr_atual_w		bigint;
nr_seq_atual_w			bigint;
nr_prescr_orig_w		bigint;
nr_seq_orig_w			bigint;
cd_pessoa_fisica_w		varchar(10);
nr_atendimento_w		bigint;
ie_suspenso_w			varchar(1);


BEGIN

nr_prescr_orig_w	:= PLT_obter_item_orig(nr_prescricao_p, nr_sequencia_p, upper(nm_tabela_p),'P');
nr_seq_orig_w		:= PLT_obter_item_orig(nr_prescricao_p, nr_sequencia_p, upper(nm_tabela_p),'S');

select	max(cd_pessoa_fisica),
	max(nr_atendimento)
into STRICT	cd_pessoa_fisica_w,
	nr_atendimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescr_orig_w;

if (upper(nm_tabela_p) = 'PRESCR_MATERIAL') then

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

		select	coalesce(max('S'),'N')
		into STRICT	ie_suspenso_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_sequencia_p
		and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '');

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_material a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w		= 'S'))
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias18;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	prescr_material a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w		= 'S'))
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias18;

	else

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_material a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias14;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	prescr_material a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias14;

	end if;

elsif (upper(nm_tabela_p) = 'PRESCR_DIETA') then

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

		select	coalesce(max('S'),'N')
		into STRICT	ie_suspenso_w
		from	prescr_dieta
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_sequencia_p
		and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '');

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_dieta a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w		= 'S'))
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias18;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	prescr_dieta a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w		= 'S'))
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias18;

	else

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_dieta a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias14;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	prescr_dieta a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias14;

	end if;

elsif (upper(nm_tabela_p) = 'REP_JEJUM') then

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

		select	coalesce(ie_suspenso,'N')
		into STRICT	ie_suspenso_w
		from	rep_jejum
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_sequencia_p;

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	rep_jejum a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and	((coalesce(a.ie_suspenso,'N') <> 'S') or (ie_suspenso_w		= 'S'))
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias18;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	rep_jejum a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and	((coalesce(a.ie_suspenso,'N') <> 'S') or (ie_suspenso_w		= 'S'))
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias18;

	else

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	rep_jejum a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias14;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	rep_jejum a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias14;

	end if;

elsif (upper(nm_tabela_p) = 'NUT_PAC') then

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

		select	coalesce(max('S'),'N')
		into STRICT	ie_suspenso_w
		from	nut_pac
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_sequencia_p
		and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '');

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	nut_pac a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w		= 'S'))
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias18;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	nut_pac a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w		= 'S'))
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias18;

	else

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	nut_pac a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias14;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	nut_pac a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias14;

	end if;

elsif (upper(nm_tabela_p) = 'PRESCR_SOLUCAO') then

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

		select	coalesce(max('S'),'N')
		into STRICT	ie_suspenso_w
		from	prescr_solucao
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_solucao	= nr_sequencia_p
		and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '');


		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_solucao a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_seq_solucao))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and 	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w = 'S'))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias18;

		select	min(nr_seq_solucao)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_seq_solucao
			from	prescr_solucao a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_seq_solucao))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and 	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w = 'S'))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias18;

	else

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_solucao a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_seq_solucao))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias14;

		select	min(nr_seq_solucao)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_seq_solucao
			from	prescr_solucao a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_seq_solucao))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias14;

	end if;

elsif (upper(nm_tabela_p) = 'PRESCR_GASOTERAPIA') then

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

		select	coalesce(max('S'),'N')
		into STRICT	ie_suspenso_w
		from	prescr_gasoterapia
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_sequencia_p
		and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '');

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_gasoterapia a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and 	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w = 'S'))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias18;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	prescr_gasoterapia a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and 	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w = 'S'))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias18;

	else

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_gasoterapia a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias14;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	prescr_gasoterapia a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_seq_anterior		= nr_seq_orig_w) or (nr_seq_orig_w			= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias14;

	end if;

elsif (upper(nm_tabela_p) = 'PRESCR_PROCEDIMENTO') then

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

		select	coalesce(max('S'),'N')
		into STRICT	ie_suspenso_w
		from	prescr_procedimento
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_sequencia_p
		and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '');


		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_procedimento a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and 	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w = 'S'))
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias18;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	prescr_procedimento a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and 	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w = 'S'))
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias18;

	else

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_procedimento a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and	((a.nr_prescricao_original	= nr_prescr_orig_w) or
				 ((nr_prescr_orig_w		= a.nr_prescricao) and (coalesce(a.nr_prescricao_original::text, '') = '')))
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias20;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	prescr_procedimento a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			and	((a.nr_prescricao_original	= nr_prescr_orig_w) or
				 ((nr_prescr_orig_w		= a.nr_prescricao) and (coalesce(a.nr_prescricao_original::text, '') = '')))
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias20;

	end if;

elsif (upper(nm_tabela_p) = 'PRESCR_RECOMENDACAO') then

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

		select	coalesce(max('S'),'N')
		into STRICT	ie_suspenso_w
		from	prescr_recomendacao
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_sequencia_p
		and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '');

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_recomendacao a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and 	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w = 'S'))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias18;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	prescr_recomendacao a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.nr_atendimento		= nr_atendimento_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and 	((coalesce(a.dt_suspensao::text, '') = '') or (ie_suspenso_w = 'S'))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias18;

	else

		select	min(nr_prescricao)
		into STRICT	nr_prescr_atual_w
		from	(SELECT	a.nr_prescricao
			from	prescr_recomendacao a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_prescricao_p nr_prescricao
			) alias14;

		select	min(nr_sequencia)
		into STRICT	nr_seq_atual_w
		from	(SELECT	a.nr_sequencia
			from	prescr_recomendacao a,
				prescr_medica b
			where	a.nr_prescricao			= b.nr_prescricao
			and	a.nr_prescricao			= nr_prescr_atual_w
			and	((a.nr_prescricao_original	= nr_prescr_orig_w AND a.nr_seq_anterior		= nr_seq_orig_w) or
				 (nr_prescr_orig_w		= a.nr_prescricao AND nr_seq_orig_w		= a.nr_sequencia))
			and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w
			and	(((clock_timestamp()	between b.dt_prescricao_original and b.dt_validade_prescr) and (ie_periodo_p	= 'N')) or
				 ((obter_se_prescr_vig_adep(b.dt_inicio_prescr,b.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') and (ie_periodo_p	= 'S')))
			and	coalesce(b.ie_prescr_emergencia,'N') <> 'S'
			
union all

			SELECT	nr_sequencia_p	nr_sequencia
			) alias14;

	end if;

end if;

if (ie_opcao_p	= 'P') then
	return	nr_prescr_atual_w;
else
	return	nr_seq_atual_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION plt_obter_item_plano_atual ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_tabela_p text, ie_opcao_p text, ie_periodo_p text, dt_inicial_p timestamp, dt_final_p timestamp) FROM PUBLIC;

