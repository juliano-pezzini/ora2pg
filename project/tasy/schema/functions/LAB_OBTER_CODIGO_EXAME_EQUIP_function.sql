-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_codigo_exame_equip ( cd_sigla_equip_p text, nr_seq_exame_p bigint, ie_tipo_atendimento_p bigint, ie_urgente_p text, nr_seq_material_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


Resultado_w	 		varchar(50);
cd_exame_integr_w		varchar(50);

/* Opções
	CEX - Código do Exame
	CEXE - Código do Exame Exclusivo ()somente busca do cadastro do equipamento
*/
C01 CURSOR FOR
	SELECT	coalesce((b.cd_exame_equip),null)
	from 	equipamento_lab a,
		lab_exame_equip b
       where 	a.cd_equipamento	= b.cd_equipamento
	 and 	a.ds_sigla 		= cd_sigla_equip_p
	 and 	b.nr_seq_exame 		= nr_seq_exame_p
	 and 	((b.nr_seq_material 	=  coalesce(nr_seq_material_p,b.nr_seq_material)) or (coalesce(nr_seq_material::text, '') = ''))
	 and 	((b.ie_tipo_atendimento	=  coalesce(ie_tipo_atendimento_p,b.ie_tipo_atendimento)) or (coalesce(b.ie_tipo_atendimento::text, '') = ''))
	 and (b.ie_urgente		=  coalesce(ie_urgente_p,b.ie_urgente) or coalesce(b.ie_urgente::text, '') = '')
       order by coalesce(b.ie_tipo_atendimento,0), coalesce(b.nr_seq_material,0);


BEGIN

resultado_w :=  null;

OPEN C01;
LOOP
FETCH C01 into cd_exame_integr_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if ((ie_opcao_p = 'CEX') or (ie_opcao_p = 'CEXE')) then
		resultado_w := cd_exame_integr_w;
	end if;

END LOOP;
CLOSE C01;

if (ie_opcao_p <> 'CEXE') and (coalesce(resultado_w::text, '') = '') then
	select	coalesce(cd_exame_integracao, cd_exame)
	into STRICT	resultado_w
	from	exame_laboratorio
	where	nr_seq_exame = nr_seq_exame_p;
end if;

RETURN resultado_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_codigo_exame_equip ( cd_sigla_equip_p text, nr_seq_exame_p bigint, ie_tipo_atendimento_p bigint, ie_urgente_p text, nr_seq_material_p bigint, ie_opcao_p text) FROM PUBLIC;

