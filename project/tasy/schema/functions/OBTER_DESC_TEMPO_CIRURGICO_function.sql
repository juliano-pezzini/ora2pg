-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_tempo_cirurgico ( nr_seq_evento_p bigint, nr_cirurgia_p bigint, nr_seq_evento_cir_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_descricao_w	varchar(150);
nr_sequencia_w	bigint;
nr_seq_evento_w	bigint;
duracao_w	varchar(20);
dt_registro_w	timestamp;
ie_estrutura_pepo_w	varchar(1);
ds_tempo_w		varchar(255);
ds_texto_aux_w	varchar(255);
ds_texto_duracao_w	varchar(255);

BEGIN
	
ie_estrutura_pepo_w := obter_param_usuario(872, 158, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_estrutura_pepo_w);
ds_texto_duracao_w := '  '|| wheb_mensagem_pck.get_texto(457105) ||': '; /*Duração:*/
	
if (coalesce(ie_estrutura_pepo_w,'N') = 'S') then
	ds_texto_aux_w := wheb_mensagem_pck.get_texto(457106) || ': ';/*Inicio: */

	/* OBTER SE O EVENTO É INICIO DE ALGUM TEMPO */

	select 	max(ds_texto_aux_w || substr(ds_tempo,1,150))
	into STRICT	   ds_tempo_w
	from	   tempo_cirurgico_cirurgia a,
            tempo_cirurgico b
	where	   a.nr_seq_tempo 	= b.nr_sequencia
	and	   nr_seq_evento	   = nr_seq_evento_p
	and 	   ((nr_seq_pepo = nr_cirurgia_p) or (nr_cirurgia = nr_cirurgia_p));

	ds_descricao_w	:= ds_tempo_w;
	
	ds_texto_aux_w := wheb_mensagem_pck.get_texto(457107) || ': '; /*Fim: */

	/* OBTER SE O EVENTO É FIM DE ALGUM TEMPO */

	select 	max(ds_texto_aux_w || substr(ds_tempo,1,150) || ds_texto_duracao_w || substr(obter_dif_data(dt_inicio,dt_fim, null),1,50))
	into STRICT	   ds_tempo_w
	from	   tempo_cirurgico_cirurgia a,
            tempo_cirurgico b
	where	   a.nr_seq_tempo		= b.nr_sequencia
	and	   nr_seq_evento_dif	= nr_seq_evento_p
	and 	   ((nr_seq_pepo = nr_cirurgia_p) or (nr_cirurgia = nr_cirurgia_p));

	ds_descricao_w	:= ds_tempo_w || '  ' || ds_descricao_w;	
	
end if;

if (coalesce(ie_estrutura_pepo_w,'N') = 'N')  then
	select 	max(nr_seq_evento)
	into STRICT	   nr_seq_evento_w
	from	   tempo_cirurgico
	where	   nr_sequencia = (  SELECT 	max(nr_sequencia)
                              from 	   tempo_cirurgico
                              where	   nr_seq_evento_dif = nr_seq_evento_p);		
		
	if (nr_seq_evento_w IS NOT NULL AND nr_seq_evento_w::text <> '') then
      if (coalesce(nr_seq_evento_cir_p,0) > 0) then
         select 	max(dt_registro)
         into STRICT	   dt_registro_w
         from	   evento_cirurgia_paciente
         where	   nr_seq_evento = nr_seq_evento_p
         and	   coalesce(ie_situacao,'A') = 'A'
         and	   ((nr_cirurgia  = nr_cirurgia_p) or (nr_seq_pepo = nr_cirurgia_p))
         and      nr_sequencia   = nr_seq_evento_cir_p;

         select   obter_dif_data(max(dt_registro), dt_registro_w, null)
         into STRICT	   duracao_w
         from	   evento_cirurgia_paciente
         where	   nr_seq_evento = nr_seq_evento_w
         and	   coalesce(ie_situacao,'A') = 'A'
         and	   ((nr_cirurgia = nr_cirurgia_p) or (nr_seq_pepo = nr_cirurgia_p))
         and      dt_registro < dt_registro_w;
      else
         select 	max(dt_registro)
         into STRICT	   dt_registro_w
         from	   evento_cirurgia_paciente
         where	   nr_seq_evento = nr_seq_evento_p
         and	   coalesce(ie_situacao,'A') = 'A'
         and	   ((nr_cirurgia = nr_cirurgia_p) or (nr_seq_pepo = nr_cirurgia_p));

         select   max(obter_dif_data(dt_registro, dt_registro_w, null))
         into STRICT	   duracao_w
         from	   evento_cirurgia_paciente
         where	   nr_seq_evento = nr_seq_evento_w
         and	   coalesce(ie_situacao,'A') = 'A'
         and	   ((nr_cirurgia = nr_cirurgia_p) or (nr_seq_pepo = nr_cirurgia_p));		
      end if;
			
		ds_descricao_w := ds_descricao_w || ds_texto_duracao_w || duracao_w;
	
	end if;
end if;

return  ds_descricao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_tempo_cirurgico ( nr_seq_evento_p bigint, nr_cirurgia_p bigint, nr_seq_evento_cir_p bigint default null) FROM PUBLIC;

