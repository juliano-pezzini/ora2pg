-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tws_get_exam_laboratory ( nr_prescription_p bigint, nr_sequence_p bigint, vl_param_status_exam_p bigint, ie_type_p text, nm_user_p text) RETURNS varchar AS $body$
DECLARE


/*
Parameter ie_type_p:
S - Description status
V - Dominio value status
D - Status date
N - Name

Variable: ie_type_status_w
P - Processing
A - Available
R - Ready

ie_date_type_w:
1 -  Collection date
2 - Approval date
3 - Release date
*/
ie_status_w			prescr_procedimento.ie_status_atend%type;
ds_result_w			varchar(80) := '';
ie_restricts_w		varchar(1);
ie_type_status_w	varchar(1);
ie_date_type_w		smallint := 0;
dt_status_w			timestamp;
vl_param_approv_w	varchar(2);
vl_approv_status_w	varchar(2);


BEGIN

if (nr_prescription_p IS NOT NULL AND nr_prescription_p::text <> '') and (nr_sequence_p IS NOT NULL AND nr_sequence_p::text <> '') then

	select	max(ie_status_atend)
	into STRICT	ie_status_w
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescription_p
	and		nr_sequencia	= nr_sequence_p;

	if (vl_param_status_exam_p = 35) then

		if (ie_status_w < 35) then
			ie_type_status_w := 'P';
			ie_date_type_w := 1;
		else
			ie_type_status_w := 'A';
			ie_date_type_w := 2;
		end if;

	elsif (vl_param_status_exam_p = 40) then

		if (ie_status_w < 40) then
			ie_type_status_w := 'P';
			ie_date_type_w := 1;
		else
			ie_type_status_w := 'A';
			ie_date_type_w := 3;
		end if;

	end if;
	
	if (ie_type_status_w = 'A') then

		select	substr(obter_se_exame_bloqueado(nr_sequence_p,nr_prescription_p),1,1)
		into STRICT	ie_restricts_w
		;
		
		if (ie_restricts_w = 'S') then
			ie_type_status_w := 'R';
		end if;

	end if;

	if (ie_type_status_w = 'A') then
		vl_param_approv_w := tws_obter_param_tipo_login('1', 9114, 8);
		
		if (vl_param_approv_w = 'S') then
			vl_approv_status_w := tws_get_exam_approval_status(nr_prescription_p, nr_sequence_p, null, null, null, 'S');
			
			if (vl_approv_status_w <> 'S') then
				ie_type_status_w := 'R';
				
			end if;
		end if;
	end if;
	
	if (ie_type_p = 'V') then

		ds_result_w := ie_type_status_w;

	elsif (ie_type_p = 'S') then

		select	substr(WSUITE_UTIL_PCK.GET_WSUITE_EXPRESSION(cd_exp_valor_dominio),1,80)
		into STRICT	ds_result_w
		from	valor_dominio
		where	cd_dominio 	= 8310
		and		vl_dominio	= ie_type_status_w;

	elsif (ie_type_p = 'D') then

		if (ie_date_type_w = 1) then

			select	dt_coleta
			into STRICT	dt_status_w
			from	prescr_procedimento
			where	nr_prescricao	= nr_prescription_p
			and		nr_sequencia	= nr_sequence_p;

		elsif (ie_date_type_w = 2) then

			select	obter_data_aprov_lab(nr_prescricao,nr_sequencia)
			into STRICT	dt_status_w
			from	prescr_procedimento
			where	nr_prescricao	= nr_prescription_p
			and		nr_sequencia	= nr_sequence_p;

		elsif (ie_date_type_w = 3) then

			select	lab_obter_dt_liberacao_exame(nr_prescricao,nr_sequencia)
			into STRICT	dt_status_w
			from	prescr_procedimento
			where	nr_prescricao	= nr_prescription_p
			and		nr_sequencia	= nr_sequence_p;

		end if;
		
		if (dt_status_w IS NOT NULL AND dt_status_w::text <> '') then

			ds_result_w :=  pkg_date_formaters.to_varchar(dt_status_w, 'yyyy-MM-dd HH:mm:ss','NLS_DATE_LANGUAGE=portuguese');

		end if;

	elsif (ie_type_p = 'N') then

		select	a.nm_exame
		into STRICT	ds_result_w
		from	exame_laboratorio a,
				prescr_procedimento b
		where	b.nr_seq_exame	= a.nr_seq_exame
		and		b.nr_prescricao	= nr_prescription_p
		and		b.nr_sequencia	= nr_sequence_p;

	end if;

end if;

return ds_result_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tws_get_exam_laboratory ( nr_prescription_p bigint, nr_sequence_p bigint, vl_param_status_exam_p bigint, ie_type_p text, nm_user_p text) FROM PUBLIC;

