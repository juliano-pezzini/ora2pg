-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_exibe_lote_processo ( nr_lote_producao_p bigint, nr_processo_p bigint, nr_seq_area_prep_p bigint) RETURNS varchar AS $body$
DECLARE


qt_medicamentos_w	bigint;
qt_materiais_w		bigint;
qt_lote_producao_w	bigint;
vl_param_67		varchar(1);

ie_exibe_w		varchar(1) := 'N';


BEGIN

vl_param_67 := Obter_param_Usuario(-1113, 67, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1), vl_param_67);

/* Medicamentos */

select	count(distinct b.cd_material)
into STRICT	qt_medicamentos_w
from (SELECT	c.nr_seq_ficha_tecnica,
		a.qt_unitaria qt_material,
		a.qt_dose_ficha_tecnica,
		a.cd_unid_med_ficha_tecnica,
		a.cd_material,
		a.cd_local_estoque
	from	material c,
		lote_producao_comp a
	where	a.nr_lote_producao 	= nr_lote_producao_p
	and	a.cd_material		= c.cd_material) a,
	(select c.cd_material, c.nr_seq_ficha_tecnica,
	        ceil(sum(coalesce(qt_dispensar_hor,0))) qt_material,
	        b.nr_seq_lote_fornec nr_seq_lf,
	        a.dt_suspensao,
		a.nr_sequencia,
		sum(coalesce(a.qt_dose,0)) qt_dose_comp,
		a.cd_unidade_medida_dose,
		d.cd_local_estoque
	from    material c,
		prescr_material b,
	        prescr_mat_hor a,
	        adep_processo d
	where   b.nr_prescricao            = a.nr_prescricao
	and     b.nr_sequencia             = a.nr_seq_material
	and     d.nr_sequencia             = a.nr_seq_processo
	and	c.cd_material		   = a.cd_material
	and     coalesce(b.dt_suspensao::text, '') = ''
	and     coalesce(a.dt_suspensao::text, '') = ''
	and     coalesce(b.ie_regra_disp,'X')   <> 'N'
	and     a.nr_seq_processo          = nr_processo_p
	and	c.ie_tipo_material in ('2','3','6')
	and     ((nr_seq_area_prep_p = 0) or (a.nr_seq_area_prep = nr_seq_area_prep_p))
	group by a.dt_suspensao, b.nr_seq_lote_fornec, a.nr_sequencia,c.nr_seq_ficha_tecnica, c.cd_material, a.cd_unidade_medida_dose, d.cd_local_estoque
	
union

	SELECT  c.cd_material, c.nr_seq_ficha_tecnica,
	        0 qt,
	        b.nr_seq_lote_fornec nr_seq_lf,
	        a.dt_suspensao,
		a.nr_sequencia,
		sum(coalesce(a.qt_dose,0)) qt_dose_comp,
		a.cd_unidade_medida_dose,
		d.cd_local_estoque
	from    material c,
		prescr_material b,
	        prescr_mat_hor a,
	        adep_processo d
	where   b.nr_prescricao            = a.nr_prescricao
	and     b.nr_sequencia             = a.nr_seq_material
	and     d.nr_sequencia             = a.nr_seq_processo
	and	c.cd_material		   = a.cd_material
	and     coalesce(b.dt_suspensao::text, '') = ''
	and     coalesce(a.dt_suspensao::text, '') = ''
	and     coalesce(b.ie_regra_disp,'X')   = 'N'
	and     a.nr_seq_processo          = nr_processo_p
	and	c.ie_tipo_material in ('2','3','6')
	and     ((nr_seq_area_prep_p = 0) or (a.nr_seq_area_prep = nr_seq_area_prep_p))
	and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	group by a.dt_suspensao, b.nr_seq_lote_fornec, a.nr_sequencia,c.nr_seq_ficha_tecnica, c.cd_material, a.cd_unidade_medida_dose, d.cd_local_estoque) b
where	a.nr_seq_ficha_tecnica		=	b.nr_seq_ficha_tecnica
and	obter_conversao_unid_med_cons(a.cd_material, a.cd_unid_med_ficha_tecnica, a.qt_dose_ficha_tecnica)		=
			obter_conversao_unid_med_cons(b.cd_material,b.cd_unidade_medida_dose, b.qt_dose_comp)
and (vl_param_67 = 'N' or a.cd_local_estoque = b.cd_local_estoque);

/* Materiais */

select	count(*)
into STRICT	qt_materiais_w
from (SELECT	c.cd_material,
		a.qt_unitaria qt_material,
		a.qt_dose_ficha_tecnica,
		a.cd_local_estoque
	from	material c,
		lote_producao_comp a
	where	a.nr_lote_producao 	= nr_lote_producao_p
	and	a.cd_material		= c.cd_material) a,
	(select c.cd_material,
	        ceil(sum(coalesce(qt_dispensar_hor,0))) qt_material,
	        b.nr_seq_lote_fornec nr_seq_lf,
	        a.dt_suspensao,
		sum(a.qt_dose) qt_dose_comp,
	        d.cd_local_estoque
	from    material c,
		prescr_material b,
	        prescr_mat_hor a,
	        adep_processo d
	where   b.nr_prescricao            = a.nr_prescricao
	and     b.nr_sequencia             = a.nr_seq_material
	and     d.nr_sequencia             = a.nr_seq_processo
	and	c.cd_material		   = a.cd_material
	and     coalesce(b.dt_suspensao::text, '') = ''
	and     coalesce(a.dt_suspensao::text, '') = ''
	and     coalesce(b.ie_regra_disp,'X')   <> 'N'
	and     a.nr_seq_processo          = nr_processo_p
	and	c.ie_tipo_material in ('1')
	and     ((nr_seq_area_prep_p = 0) or (a.nr_seq_area_prep = nr_seq_area_prep_p))
	and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	group by a.dt_suspensao, b.nr_seq_lote_fornec, a.nr_sequencia, c.cd_material, d.cd_local_estoque
	
union

	SELECT  c.cd_material,
	        0 qt,
	        b.nr_seq_lote_fornec nr_seq_lf,

	        a.dt_suspensao,
	        0,
	        d.cd_local_estoque
	from    material c,
		prescr_material b,
	        prescr_mat_hor a,
	        adep_processo d
	where   b.nr_prescricao            = a.nr_prescricao
	and     b.nr_sequencia             = a.nr_seq_material
	and     d.nr_sequencia             = a.nr_seq_processo
	and	c.cd_material		   = a.cd_material
	and     coalesce(b.dt_suspensao::text, '') = ''
	and     coalesce(a.dt_suspensao::text, '') = ''
	and     coalesce(b.ie_regra_disp,'X')   = 'N'
	and     a.nr_seq_processo          = nr_processo_p
	and	c.ie_tipo_material in ('1')
	and     ((nr_seq_area_prep_p = 0) or (a.nr_seq_area_prep = nr_seq_area_prep_p))
	and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	group by a.dt_suspensao, b.nr_seq_lote_fornec, a.nr_sequencia, c.cd_material, d.cd_local_estoque) b
where	a.cd_material			=	b.cd_material
and	a.qt_dose_ficha_tecnica		=	b.qt_dose_comp
and (vl_param_67 = 'N' or a.cd_local_estoque = b.cd_local_estoque);

select	count(*)
into STRICT	qt_lote_producao_w
from	lote_producao_comp a
where	a.nr_lote_producao = nr_lote_producao_p;

if	((qt_medicamentos_w + qt_materiais_w) = qt_lote_producao_w) then
	ie_exibe_w := 'S';
end if;

return ie_exibe_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_exibe_lote_processo ( nr_lote_producao_p bigint, nr_processo_p bigint, nr_seq_area_prep_p bigint) FROM PUBLIC;

