-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION prescr_obter_momento_lote (ie_motivo_prescricao_p prescr_medica.ie_motivo_prescricao%type, cd_setor_prescr_p atend_paciente_unidade.cd_setor_atendimento%type, cd_estabelecimento_p prescr_medica.cd_estabelecimento%type, nr_seq_atend_p prescr_medica.nr_seq_atend%type default null, ie_tipo_item_p text default null, ie_urgencia_p prescr_material.ie_urgencia%type default null, nr_ocorrencia_p prescr_material.nr_ocorrencia%type default null, ie_dose_ataque_p prescr_material.ie_dose_espec_agora%type default null) RETURNS varchar AS $body$
DECLARE


ie_momento_lote_w		regra_disp_lote_farm.ie_momento_lote%type;
ie_proced_agora_w		regra_disp_lote_farm.ie_proced_agora%type;
ie_regra_agora_w		regra_disp_lote_farm.ie_regra_agora%type;
ie_rec_agora_w			regra_disp_lote_farm.ie_rec_agora%type;
ie_regra_dose_esp_w		regra_disp_lote_farm.ie_regra_dose_esp%type;

/*
CCG 									= G 		X
Dieta oral 								= D 		X
Exames laboratoriais 					= E 		X
Gasoterapia 							= GAS 		X
Itens associados ao procedimento 		= IA 		X
Jejum 									= J 		X
Lactário 								= L 		X
Materiais 								= MAT 		X
Medicamentos 							= M 		X
Procedimentos 							= P 		X
Recomendações							= R 		X
Soluções								= S 		X
Suplementos								= SUP		X
Suporte nutricional Enteral				= SNE 		X
*/
C01 CURSOR FOR
	SELECT	ie_momento_lote,
			ie_rec_agora,
			ie_regra_agora,
			ie_proced_agora,
			ie_regra_dose_esp
	from	regra_disp_lote_farm
	where	((ie_motivo_prescricao = ie_motivo_prescricao_p) or (coalesce(ie_motivo_prescricao::text, '') = ''))
	and		((cd_setor_atendimento = cd_setor_prescr_p) or (coalesce(cd_setor_atendimento::text, '') = ''))
	and		((cd_estabelecimento = cd_estabelecimento_p) or (coalesce(cd_estabelecimento::text, '') = ''))
	and		((ie_tipo_item = ie_tipo_item_p) or (coalesce(ie_tipo_item::text, '') = ''))
	and		coalesce(ie_situacao,'A') = 'A'
	and		clock_timestamp() between to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||to_char(coalesce(dt_hora_inicio,clock_timestamp()),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
	and		to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||to_char(coalesce(dt_hora_fim,clock_timestamp()),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
	and		pkg_date_utils.start_of(clock_timestamp(),'DD',0) between pkg_date_utils.start_of(dt_inicio_vigencia,'DD',0) and pkg_date_utils.start_of(coalesce(dt_fim_vigencia,clock_timestamp()),'DD',0)
	and		((CASE WHEN coalesce(nr_seq_atend_p::text, '') = '' THEN 'N'  ELSE 'S' END  <> 'S' and coalesce(ie_quimioterapicas,'N') <> 'S') or (CASE WHEN coalesce(nr_seq_atend_p::text, '') = '' THEN 'N'  ELSE 'S' END  = 'S'))
	order by CASE WHEN ie_quimioterapicas='S' THEN 'Z'  ELSE CASE WHEN ie_quimioterapicas='N' THEN 'C'  ELSE 'B' END  END ,
			coalesce(cd_setor_atendimento,0),
			coalesce(ie_motivo_prescricao,0);

BEGIN
	for r_c01_w in c01
	loop
		ie_momento_lote_w := r_c01_w.ie_momento_lote;
		ie_rec_agora_w := r_c01_w.ie_rec_agora;
		ie_regra_agora_w := r_c01_w.ie_regra_agora;
		ie_proced_agora_w := r_c01_w.ie_proced_agora;
		ie_regra_dose_esp_w := r_c01_w.ie_regra_dose_esp;		
	end loop;

	if (ie_tipo_item_p in ('M','MAT','S'))then
		if((ie_regra_agora_w = 'S' and ie_urgencia_p = 'S' and nr_ocorrencia_p = 1) or (ie_regra_dose_esp_w = 'S' and ie_dose_ataque_p = 'S' and nr_ocorrencia_p = 1)) then
			ie_momento_lote_w := 'N';
		end if;
	elsif (ie_tipo_item_p in ('P','G','E'))then
		if (ie_proced_agora_w = 'S' and ie_urgencia_p = 'S' and nr_ocorrencia_p = 1)then
			ie_momento_lote_w := 'N';
		end if;
	elsif (ie_tipo_item_p = 'R')then
		if (ie_rec_agora_w = 'S' and ie_urgencia_p = 'S' and nr_ocorrencia_p = 1)then
			ie_momento_lote_w := 'N';
		end if;
	end if;

	return coalesce(ie_momento_lote_w,'E');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION prescr_obter_momento_lote (ie_motivo_prescricao_p prescr_medica.ie_motivo_prescricao%type, cd_setor_prescr_p atend_paciente_unidade.cd_setor_atendimento%type, cd_estabelecimento_p prescr_medica.cd_estabelecimento%type, nr_seq_atend_p prescr_medica.nr_seq_atend%type default null, ie_tipo_item_p text default null, ie_urgencia_p prescr_material.ie_urgencia%type default null, nr_ocorrencia_p prescr_material.nr_ocorrencia%type default null, ie_dose_ataque_p prescr_material.ie_dose_espec_agora%type default null) FROM PUBLIC;

