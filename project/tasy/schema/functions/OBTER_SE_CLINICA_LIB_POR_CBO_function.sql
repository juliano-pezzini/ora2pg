-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_clinica_lib_por_cbo ( cd_pessoa_fisica_p text, ie_clinica_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(1) := 'N';
nr_seq_cbo_saude_w	bigint;
cd_estabelecimento_w	smallint;
qt_cbo_clinica_w		bigint;
qt_total_cbo_clinica_w	bigint;

C01 CURSOR FOR
	SELECT	nr_seq_cbo_saude,
		0
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_p
	
union

	SELECT	nr_seq_cbo_saude,
		cd_estabelecimento
	from	pessoa_fisica_cbo_saude
	where	cd_pessoa_fisica = cd_pessoa_fisica_p
	and	coalesce(cd_estabelecimento,cd_estabelecimento_p) = cd_estabelecimento_p
	order by 1;


BEGIN


select	count(*)
into STRICT	qt_cbo_clinica_w
from	cbo_clinica_atendimento
where	coalesce(cd_estabelecimento,cd_estabelecimento_p) = cd_estabelecimento_p;

if (qt_cbo_clinica_w = 0) then
	ds_retorno_w := 'S';
else
	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (ie_clinica_p IS NOT NULL AND ie_clinica_p::text <> '') then
		qt_total_cbo_clinica_w := 0;

		open C01;
		loop
		fetch C01 into
			nr_seq_cbo_saude_w,
			cd_estabelecimento_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			select 	count(*)
			into STRICT	qt_cbo_clinica_w
			from	cbo_clinica_atendimento
			where	nr_seq_cbo_saude = nr_seq_cbo_saude_w
			and		((coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w) or (coalesce(cd_estabelecimento_w, 0) = 0))
			and		ie_clinica = ie_clinica_p;

			end;

		qt_total_cbo_clinica_w := qt_total_cbo_clinica_w + qt_cbo_clinica_w;

		end loop;
		close C01;

		if (qt_total_cbo_clinica_w > 0) then
			ds_retorno_w := 'S';
		else
			ds_retorno_w := 'N';
		end if;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_clinica_lib_por_cbo ( cd_pessoa_fisica_p text, ie_clinica_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

