-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION eup_obter_situacao_benef ( cd_pessoa_fisica_p text, cd_usuario_convenio_p text, cd_estabelecimento_p bigint, nr_atendimento_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(5);
cd_mae_paciente_w	pessoa_fisica.cd_pessoa_fisica%type;
qt_dias_w		varchar(50);
ie_valida_resp_rn_w		varchar(1);
nr_atendimento_mae_w		bigint;
cd_pessoa_responsavel_w 	atendimento_paciente.cd_pessoa_responsavel%type;



BEGIN

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (cd_usuario_convenio_p IS NOT NULL AND cd_usuario_convenio_p::text <> '') and (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then
	begin
	
	qt_dias_w	:= obter_idade_pf(cd_pessoa_fisica_p,clock_timestamp(),'DIA');

	if (qt_dias_w <= 30) then
		begin
		
		ie_valida_resp_rn_w := obter_param_usuario(916, 1190, obter_perfil_ativo, obter_usuario_ativo, cd_estabelecimento_p, ie_valida_resp_rn_w);
		
		select	coalesce(max(nr_atendimento_mae),0)
		into STRICT	nr_atendimento_mae_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
		
		if (nr_atendimento_mae_w > 0) then
			select	coalesce(a.cd_pessoa_mae,obter_pessoa_atendimento(nr_atendimento_mae_w,'C'))
			into STRICT	cd_mae_paciente_w
			from	pessoa_fisica a
			where	a.cd_pessoa_fisica = cd_pessoa_fisica_p;
		else
			select	coalesce(max(a.cd_pessoa_mae),'0')
			into STRICT	cd_mae_paciente_w
			from	pessoa_fisica a
			where	a.cd_pessoa_fisica = cd_pessoa_fisica_p;
		end if;
	
		ds_retorno_w	:= pls_obter_situacao_benef(cd_pessoa_fisica_p, cd_usuario_convenio_p, cd_estabelecimento_p);
		
		if (ie_valida_resp_rn_w = 'S') and (( ds_retorno_w = 'ERRO') or ( ds_retorno_w <> 'A')) then
			select max(cd_pessoa_responsavel)
			into STRICT	cd_pessoa_responsavel_w
			from 	atendimento_paciente
			where 	nr_atendimento = nr_atendimento_p;
			
			ds_retorno_w	:= pls_obter_situacao_benef(cd_pessoa_responsavel_w, cd_usuario_convenio_p, cd_estabelecimento_p);
		end if;
		
		if	((( ds_retorno_w = 'ERRO') or ( ds_retorno_w <> 'A')) and (cd_mae_paciente_w IS NOT NULL AND cd_mae_paciente_w::text <> '')) then
			ds_retorno_w	:= pls_obter_situacao_benef(cd_mae_paciente_w, cd_usuario_convenio_p, cd_estabelecimento_p);
		end if;		
		end;
	else
		ds_retorno_w	:= pls_obter_situacao_benef( cd_pessoa_fisica_p, cd_usuario_convenio_p, cd_estabelecimento_p );		
	end if;
	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eup_obter_situacao_benef ( cd_pessoa_fisica_p text, cd_usuario_convenio_p text, cd_estabelecimento_p bigint, nr_atendimento_p bigint default null) FROM PUBLIC;

