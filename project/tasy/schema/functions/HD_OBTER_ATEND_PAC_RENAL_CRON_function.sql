-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hd_obter_atend_pac_renal_cron (cd_pessoa_fisica_p text) RETURNS bigint AS $body$
DECLARE


nr_atendimento_w	bigint;
cd_unid_dialise_w	bigint;
cd_estabelecimento_w	smallint;

C01 CURSOR FOR
	SELECT	ie_tipo_atend_tiss,
		cd_procedimento_tuss,
		cd_procedencia,
		nr_seq_queixa
	FROM	HD_REGRA_ATEND_EXAME
	WHERE	coalesce(ie_situacao,'A') = 'A';

c01_w c01%ROWTYPE;



BEGIN

IF (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') THEN

	cd_unid_dialise_w := campo_numerico(hd_obter_unidade_prc(cd_pessoa_fisica_p,'C'));

	IF (cd_unid_dialise_w > 0) THEN
		SELECT	coalesce(cd_estabelecimento,0)
		INTO STRICT	cd_estabelecimento_w
		FROM	hd_unidade_dialise
		WHERE	nr_sequencia	= cd_unid_dialise_w;

		IF (cd_estabelecimento_w > 0) THEN
			nr_atendimento_w	:= 0;

			OPEN C01;
			LOOP
			FETCH C01 INTO	c01_w;
			EXIT WHEN NOT FOUND OR nr_atendimento_w <> 0;  /* apply on C01 */
				BEGIN
				SELECT	coalesce(MAX(nr_atendimento),0)
				INTO STRICT	nr_atendimento_w
				FROM	atendimento_paciente a
				WHERE	cd_pessoa_fisica	= cd_pessoa_fisica_p
				AND 	coalesce(a.dt_cancelamento::text, '') = ''
				AND		cd_estabelecimento	= cd_estabelecimento_w
				AND		a.cd_procedencia = coalesce(c01_w.cd_procedencia, a.cd_procedencia)
				AND		ie_fim_conta		<> 'F'
				AND		coalesce(dt_alta::text, '') = ''
				AND (a.nr_seq_queixa	= c01_w.nr_seq_queixa or coalesce(c01_w.nr_seq_queixa::text, '') = '')
				AND		((EXISTS (SELECT 1 FROM procedimento_paciente p
						WHERE 	p.nr_atendimento = a.nr_atendimento
						AND		p.cd_procedimento_tuss = c01_w.cd_procedimento_tuss)) OR (coalesce(c01_w.cd_procedimento_tuss::text, '') = ''))
				AND (a.ie_tipo_atend_tiss = c01_w.ie_tipo_atend_tiss OR coalesce(c01_w.ie_tipo_atend_tiss::text, '') = '');

				END;
			END LOOP;
			CLOSE C01;

			IF (nr_atendimento_w = 0) THEN
				/*tratameno realizado para a OS 320221, para verificar se h?? atendimento de APAC com o procedimento 305010107*/

			SELECT	coalesce(MAX(nr_atendimento),0)
			INTO STRICT	nr_atendimento_w
			FROM	atendimento_paciente a
			WHERE	cd_pessoa_fisica	= cd_pessoa_fisica_p
			AND	cd_estabelecimento	= cd_estabelecimento_w
			AND	ie_fim_conta		<> 'F'
			AND	coalesce(dt_alta::text, '') = ''
			AND 	coalesce(a.dt_cancelamento::text, '') = ''
			AND EXISTS (	SELECT 	1 FROM SUS_APAC_UNIF x
					WHERE 	a.nr_atendimento = x.nr_atendimento
					AND	x.cd_procedimento = 305010107);

			END IF;

			IF (nr_atendimento_w = 0) THEN
				SELECT	coalesce(MAX(nr_atendimento),0)
				INTO STRICT	nr_atendimento_w
				FROM	atendimento_paciente a
				WHERE	cd_pessoa_fisica	= cd_pessoa_fisica_p
				AND	cd_estabelecimento	= cd_estabelecimento_w
				AND	ie_fim_conta		<> 'F'
				AND	coalesce(dt_alta::text, '') = ''
				AND 	coalesce(a.dt_cancelamento::text, '') = ''
				AND	EXISTS (SELECT 1 FROM HD_LOG_GERACAO_ATEND x WHERE a.nr_atendimento = x.NR_ATENDIMENTO_NOV);
			END IF;

			IF (nr_atendimento_w = 0) THEN
				SELECT	coalesce(MAX(nr_atendimento),0)
				INTO STRICT	nr_atendimento_w
				FROM	atendimento_paciente
				WHERE	cd_pessoa_fisica	= cd_pessoa_fisica_p
				AND	cd_estabelecimento	= cd_estabelecimento_w
				AND	ie_fim_conta		<> 'F'
				AND	coalesce(dt_alta::text, '') = ''
				AND 	coalesce(dt_cancelamento::text, '') = '';

			END IF;
		END IF;
	END IF;
END IF;

RETURN	nr_atendimento_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hd_obter_atend_pac_renal_cron (cd_pessoa_fisica_p text) FROM PUBLIC;

