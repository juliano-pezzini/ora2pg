-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_data_conta_mat ( nr_seq_prestador_exec_p pls_conta_v.nr_seq_prestador_exec%type, dt_atendimento_mat_p pls_conta_mat.dt_atendimento%type, dt_atendimento_conta_p pls_conta_v.dt_atendimento%type, dt_protocolo_p pls_protocolo_conta.dt_protocolo%type, dt_mes_competencia_p pls_protocolo_conta.dt_mes_competencia%type) RETURNS timestamp AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Obter a data do material olhando a regra cadastrada para o prestador executor da conta,
	onde é possível informar de onde deve ser buscada a data do item.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

SEMPRE QUE FOR ALTERAR ESTA FUNCTION VERIFICAR SE É NECESSÁRIO ALTERAR TAMBÉM A FUNCTION PLS_OBTER_DATA_CONTA_PROC!

 Se o prestador não for informado ou se não for encontrado dado da regra para o mesmo então será olhado por padrão na data da do material,
se esta não tiver informada olha para a data da conta.

Alterações:
-------------------------------------------------------------------------------------------------------------------
jjung OS 589337 09/07/2013 - Criação da function.
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
dt_retorno_w		timestamp;
ie_regra_data_preco_w	pls_prestador.ie_regra_data_preco_mat%type;


BEGIN

ie_regra_data_preco_w := null;

-- Se o prestador não for informado ou não tiver regra de data para ele entra por padrão na primeira verificacao do item.
if (nr_seq_prestador_exec_p IS NOT NULL AND nr_seq_prestador_exec_p::text <> '') then

	select	max(a.ie_regra_data_preco_mat)
	into STRICT	ie_regra_data_preco_w
	from	pls_prestador a
	where	a.nr_sequencia = nr_seq_prestador_exec_p;
end if;

-- Se for informado a data do Item ou se não tiver regra ou prestador informado então verifica primeiro a data do item, se não
-- tiver informada verifica a data da conta.
if (ie_regra_data_preco_w = 'E') or (coalesce(ie_regra_data_preco_w::text, '') = '') then

	-- Se a data do item não for informada então retorna a data da conta.
	if (dt_atendimento_mat_p IS NOT NULL AND dt_atendimento_mat_p::text <> '') then

		dt_retorno_w := dt_atendimento_mat_p;
	else
		dt_retorno_w := dt_atendimento_conta_p;
	end if;

-- Se for informado para usar a data da conta então retorna a data da conta.
elsif (ie_regra_data_preco_w = 'X') then

	dt_retorno_w := dt_atendimento_conta_p;

-- Se for informado para usar a data do protocolo então se dá preferencia a data do protocolo, caso não for informada retorna a data de competencia do mesmo.
elsif (ie_regra_data_preco_w = 'P') then

	-- Se a data do protocolo não for informado então retorna a data de competencia.
	if (dt_protocolo_p IS NOT NULL AND dt_protocolo_p::text <> '') then

		dt_retorno_w := dt_protocolo_p;
	else
		dt_retorno_w := dt_mes_competencia_p;
	end if;
end if;

return	dt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_data_conta_mat ( nr_seq_prestador_exec_p pls_conta_v.nr_seq_prestador_exec%type, dt_atendimento_mat_p pls_conta_mat.dt_atendimento%type, dt_atendimento_conta_p pls_conta_v.dt_atendimento%type, dt_protocolo_p pls_protocolo_conta.dt_protocolo%type, dt_mes_competencia_p pls_protocolo_conta.dt_mes_competencia%type) FROM PUBLIC;

