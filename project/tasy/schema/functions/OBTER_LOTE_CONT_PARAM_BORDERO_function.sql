-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_lote_cont_param_bordero ( nr_bordero_p bigint, dt_baixa_p timestamp, cd_empresa_w bigint, cd_estabelecimento_w bigint) RETURNS bigint AS $body$
DECLARE


nr_seq_conta_banco_w		bordero_pagamento.nr_seq_conta_banco%type;
nr_seq_classif_w			banco_estabelecimento.nr_seq_classif%type;
qt_retorno_w				bigint;


BEGIN

if (nr_bordero_p IS NOT NULL AND nr_bordero_p::text <> '') then

	select	max(a.nr_seq_conta_banco)
	into STRICT	nr_seq_conta_banco_w
	from	bordero_pagamento a
	where	a.nr_bordero = nr_bordero_p;

	select	max(a.nr_seq_classif)
	into STRICT	nr_seq_classif_w
	from	banco_estabelecimento a
	where	a.nr_sequencia = nr_seq_conta_banco_w;

	select	count(*)
	into STRICT	qt_retorno_w
	from	lote_contabil a
	where  	obter_empresa_estab(a.cd_estabelecimento)   = cd_empresa_w
	and    	a.cd_estabelecimento                        = cd_estabelecimento_w
	and    	trunc(a.dt_referencia, 'dd')				= trunc(dt_baixa_p,'dd')
	and    	a.cd_tipo_lote_contabil                     = 18 -- Lote de Controle Bancário
	and	   	exists (  SELECT   1
					 from     movimento_contabil z
	                 where    z.nr_lote_contabil   = a.nr_lote_contabil)
	and		exists (  SELECT   1
					 from	  lote_contabil_parametro x
					 where	  x.nr_lote_contabil   = a.nr_lote_contabil
					 and	  x.nr_seq_parametro   = 2 -- Fixo 2 pois se refere a Classificação da conta bancária no cadastro da contabilidade.
					 and	  x.vl_parametro	   = nr_seq_classif_w);

end if;

return	qt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_lote_cont_param_bordero ( nr_bordero_p bigint, dt_baixa_p timestamp, cd_empresa_w bigint, cd_estabelecimento_w bigint) FROM PUBLIC;

