-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_med_regulaco_receita (nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE



nr_seq_receita_amb_w	bigint;
nr_seq_reg_w			bigint;
cd_material_w			bigint;
ds_retorno_w			varchar(4000);
ds_material_w			varchar(255);
virgula_w				varchar(2);


C01 CURSOR FOR
	SELECT	substr(obter_desc_material(b.cd_material),1,255) ds_material
	from	fa_receita_farmacia a,
			fa_receita_farmacia_item b,
			regulacao_atend c
	where	 c.nr_seq_receita_amb =  a.nr_sequencia
	and   	a.nr_sequencia = b.nr_seq_receita
	and   	b.nr_sequencia = c.nr_seq_receita_item
	and   	a.nr_sequencia = nr_seq_receita_amb_w
	and		obter_status_regulacao(c.nr_seq_receita_amb, 'RF') in ('AE','EN','CA','AN','RP','PS','LE','AG','NG');

BEGIN

select	max(nr_seq_receita_amb)
into STRICT	nr_seq_receita_amb_w
from 	fa_entrega_medicacao
where	nr_sequencia = nr_sequencia_p;

if (nr_seq_receita_amb_w IS NOT NULL AND nr_seq_receita_amb_w::text <> '')then
	
	 for material_farmacia in C01 loop
        ds_material_w := material_farmacia.ds_material;
			
		ds_retorno_w := ds_retorno_w || virgula_w || ds_material_w;
		
		if ( coalesce(virgula_w::text, '') = '')then
			virgula_w := ',';
		end if;

    end loop;

end if;


return	coalesce( ds_retorno_w, '');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_med_regulaco_receita (nr_sequencia_p bigint) FROM PUBLIC;

