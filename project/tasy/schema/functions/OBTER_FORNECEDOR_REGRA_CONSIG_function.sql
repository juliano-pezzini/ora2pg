-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_fornecedor_regra_consig ( cd_estabelecimento_p bigint, cd_material_p bigint, ie_informacao_p text, cd_local_estoque_p bigint default null) RETURNS varchar AS $body$
DECLARE


/*ie_informacao_p
	1	= CGC
	2	= Fornecedor
	3	= Estoque*/
ie_regra_lookup_consig_w	varchar(1);
cd_cgc_w		varchar(14);
ds_razao_social_w		pessoa_juridica.ds_razao_social%type;
qt_estoque_w		double precision;
ds_retorno_w		varchar(80);
cd_local_estoque_w	local_estoque.cd_local_estoque%type;


BEGIN

select	substr(coalesce(max(obter_regra_lookup_consignado(cd_estabelecimento_p)),'0'),1,1)
into STRICT	ie_regra_lookup_consig_w
;

if (coalesce(cd_local_estoque_p, 0) > 0) then
	begin
	cd_local_estoque_w := cd_local_estoque_p;
	end;
end if;

if (ie_regra_lookup_consig_w = '1') then

	begin
	select	cd_fornecedor,
		ds_razao_social,
		qt_estoque
	into STRICT	cd_cgc_w,
		ds_razao_social_w,
		qt_estoque_w
	from (	SELECT	distinct a.cd_fornecedor,
			b.ds_razao_social,
			0 qt_estoque,
			row_number() OVER () AS ie_linha
		from	pessoa_juridica b,
			fornecedor_mat_consignado a,
			material m
		where	a.cd_fornecedor = b.cd_cgc
		and	a.cd_material   = m.cd_material_estoque
		and	m.cd_material   = cd_material_p
		and	b.ie_situacao = 'A'
		and	a.cd_local_estoque = coalesce(cd_local_estoque_w, a.cd_local_estoque)
		and	a.cd_estabelecimento = cd_estabelecimento_p
		order by 2) alias2 LIMIT 1;
	exception when no_data_found then
		qt_estoque_w	:= 0;
	end;

elsif (ie_regra_lookup_consig_w = '2') then

	begin
	select	cd_fornecedor,
		ds_razao_social,
		qt_estoque
	into STRICT	cd_cgc_w,
		ds_razao_social_w,
		qt_estoque_w
	from (	SELECT	distinct a.cd_fornecedor,
			b.ds_razao_social,
			0 qt_estoque,
			row_number() OVER () AS ie_linha
		from	pessoa_juridica b,
			fornecedor_mat_consignado a,
			Material m
		where	a.cd_fornecedor = b.cd_cgc
		and	a.cd_material   = m.cd_material_estoque
		and	m.cd_material   = cd_material_p
		and	b.ie_situacao = 'A'
		and	a.dt_mesano_referencia = PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0)
		and	a.cd_local_estoque = coalesce(cd_local_estoque_w, a.cd_local_estoque)
		and	a.cd_estabelecimento = cd_estabelecimento_p
		and	qt_estoque > 0
		order by 2) alias4 LIMIT 1;
	exception when no_data_found then
		qt_estoque_w	:= 0;
	end;

elsif (ie_regra_lookup_consig_w = '3') then

	begin
	select	cd_fornecedor,
		ds_razao_social,
		qt_estoque
	into STRICT	cd_cgc_w,
		ds_razao_social_w,
		qt_estoque_w
	from (	SELECT	distinct a.cd_fornecedor,
			b.ds_razao_social,
			a.qt_estoque,
			row_number() OVER () AS ie_linha
		from	pessoa_juridica b,
			fornecedor_mat_consignado a,
			Material m
		where	a.cd_fornecedor	= b.cd_cgc
		and	a.cd_material	= m.cd_material_estoque
		and	m.cd_material	= cd_material_p
		and	b.ie_situacao	= 'A'
		and	a.dt_mesano_referencia = PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0)
		and	a.cd_local_estoque = coalesce(cd_local_estoque_w, a.cd_local_estoque)
		and	a.cd_estabelecimento = cd_estabelecimento_p
		order by qt_estoque desc) alias4 LIMIT 1;
	exception when no_data_found then
		qt_estoque_w	:= 0;
	end;

end if;

if (ie_informacao_p = '1') then
	ds_retorno_w	:= cd_cgc_w;
elsif (ie_informacao_p = '2') then
	ds_retorno_w	:= ds_razao_social_w;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_fornecedor_regra_consig ( cd_estabelecimento_p bigint, cd_material_p bigint, ie_informacao_p text, cd_local_estoque_p bigint default null) FROM PUBLIC;

