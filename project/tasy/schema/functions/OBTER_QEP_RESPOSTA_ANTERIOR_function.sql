-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qep_resposta_anterior ( nr_seq_que_atend_questao_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*
ie_opcao_p:
RESP 	= Retorna as respostas da questão anterior
RESPDIF 	= Retorna as respostas da questão anterior caso forem diferentes da atual

OBS 	= Retorna a observação da questão anterior
OBSDIF 	= Retorna a observação da questão anterior caso for diferente da atual

DIFSN 	= Se as respostas ou a observação forem diferentes da anterior, retorna 'S', senão retorna 'N'.
DIFSNRESP= Se as respostas diferentes da anterior, retorna 'S', senão retorna 'N'.
DIFSNOBS	= Se a observação for diferente da anterior, retorna 'S', senão retorna 'N'.
*/
ds_campo_null_w					varchar(16) := ')#_NULL_field_#(';
ie_tipo_resposta_w				que_questao.ie_tipo_resposta%type;
nr_atendimento_w				atendimento_paciente.nr_atendimento%type;
cd_setor_atendimento_w				setor_atendimento.cd_setor_atendimento%type;
nr_seq_questao_w				que_questao.nr_sequencia%type;
ds_observacao_atual_w				que_atendimento_questao.ds_observacao%type;
ds_observacao_ant_w				que_atendimento_questao.ds_observacao%type;
ds_respostas_ant_w				varchar(2000);

ie_respostas_diferentes_w			varchar(1);
ie_observacoes_diferentes_w			varchar(1);
qt_reg_w					bigint;


BEGIN

--busca o atendimento e o setor do questionário da questão passada por parâmetro
select	d.nr_atendimento,
	d.cd_setor_atendimento,
	a.nr_seq_questao,
	b.ie_tipo_resposta,
	a.ds_observacao
into STRICT	nr_atendimento_w,
	cd_setor_atendimento_w,
	nr_seq_questao_w,
	ie_tipo_resposta_w,
	ds_observacao_atual_w
from	que_atendimento_questao a,
	que_questao b,
	que_questionario c,
	que_atendimento d
where	a.nr_seq_questao = b.nr_sequencia
and	c.nr_sequencia = b.nr_seq_questionario
and	a.nr_seq_que_atendimento = d.nr_sequencia
and	a.nr_sequencia = nr_seq_que_atend_questao_p;


select	max(obter_qep_respostas(a.nr_sequencia, 'D', b.ie_tipo_resposta)),
	max(a.ds_observacao),
	count(1)
into STRICT	ds_respostas_ant_w,
	ds_observacao_ant_w,
	qt_reg_w
from	que_atendimento_questao a,
	que_questao b,
	que_questionario c,
	que_atendimento d
where	a.nr_sequencia < nr_seq_que_atend_questao_p
and	a.nr_seq_questao = b.nr_sequencia
and	c.nr_sequencia = b.nr_seq_questionario
and	a.nr_seq_que_atendimento = d.nr_sequencia
and	a.nr_seq_questao = nr_seq_questao_w
and	d.nr_atendimento = nr_atendimento_w
and	d.cd_setor_atendimento = cd_setor_atendimento_w;

ie_respostas_diferentes_w	:= 'N';
if (qt_reg_w > 0) and (coalesce(ds_respostas_ant_w,ds_campo_null_w) <> coalesce(obter_qep_respostas(nr_seq_que_atend_questao_p, 'D', ie_tipo_resposta_w),ds_campo_null_w)) then
	ie_respostas_diferentes_w	:= 'S';
end if;

ie_observacoes_diferentes_w	:= 'N';
if (qt_reg_w > 0) and (coalesce(ds_observacao_ant_w,ds_campo_null_w) <> coalesce(ds_observacao_atual_w,ds_campo_null_w)) then
	ie_observacoes_diferentes_w	:= 'S';
end if;

if (upper(ie_opcao_p) = 'RESP') then
	return	ds_respostas_ant_w;
elsif (upper(ie_opcao_p) = 'OBS') then
	return	ds_observacao_ant_w;
elsif (upper(ie_opcao_p) = 'RESPDIF') and (ie_respostas_diferentes_w = 'S') then
	return	ds_respostas_ant_w;
elsif (upper(ie_opcao_p) = 'OBSDIF') and (ie_observacoes_diferentes_w = 'S') then
	return	ds_observacao_ant_w;
elsif (upper(ie_opcao_p) = 'DIFRESP') then
	if (ie_respostas_diferentes_w = 'S') then
		return	'S';
	else
		return	'N';
	end if;
elsif (upper(ie_opcao_p) = 'DIFOBS') then
	if (ie_observacoes_diferentes_w = 'S') then
		return	'S';
	else
		return	'N';
	end if;
elsif (upper(ie_opcao_p) = 'DIF') then
	if (ie_respostas_diferentes_w = 'S') or (ie_observacoes_diferentes_w = 'S') then
		return	'S';
	else
		return	'N';
	end if;
else
	return '';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qep_resposta_anterior ( nr_seq_que_atend_questao_p bigint, ie_opcao_p text) FROM PUBLIC;

