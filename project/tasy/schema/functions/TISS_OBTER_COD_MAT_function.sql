-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tiss_obter_cod_mat (cd_material_convenio_p text, cd_estabelecimento_p bigint, cd_material_p bigint, dt_material_p timestamp, ie_origem_preco_tiss_p text, cd_convenio_p bigint) RETURNS varchar AS $body$
DECLARE


ie_cod_tiss_brasindice_w	varchar(255) := '';
ds_retorno_w			varchar(255) := '';
cd_material_brasindice_w	varchar(255) := '';
cd_laboratorio_w		varchar(255) := '';
cd_medicamento_w		varchar(255) := '';
cd_apresentacao_w		varchar(255) := '';


BEGIN

select	coalesce(max(IE_COD_TISS_BRASINDICE), 'N')
into STRICT	ie_cod_tiss_brasindice_w
from	tiss_parametros_convenio
where	cd_convenio		= cd_convenio_p
and	cd_estabelecimento	= cd_estabelecimento_p;

if (coalesce(cd_material_convenio_p,'0') <> '0') and (cd_material_convenio_p <> to_char(cd_material_p)) then
	ds_retorno_w		:= cd_material_convenio_p;
elsif (ie_origem_preco_tiss_p = '05') then

	cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_p, cd_material_p, dt_material_p, cd_convenio_p);
	cd_laboratorio_w		:= substr(cd_material_brasindice_w,1,3);
	cd_medicamento_w		:= substr(cd_material_brasindice_w,5,5);
	cd_apresentacao_w		:= substr(cd_material_brasindice_w,11,4);
	if (ie_cod_tiss_brasindice_w = 'N') then
		ds_retorno_w			:= tiss_obter_cod_brasindice(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w);
	elsif (ie_cod_tiss_brasindice_w = 'B') then
		cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_p, cd_material_p, dt_material_p, cd_convenio_p);
		ds_retorno_w			:= replace(cd_material_brasindice_w,';','');
	end if;

	if (coalesce(ds_retorno_w,'0') = '0') then
		ds_retorno_w		:= replace(cd_medicamento_w,';','');
	end if;

elsif (ie_origem_preco_tiss_p = '12') then
	select	Obter_Codigo_Simpro(cd_material_p)
	into STRICT	ds_retorno_w
	;
end if;

ds_retorno_w		:= coalesce(ds_retorno_w, cd_material_p);
if (length(ds_retorno_w) < 8) then
	ds_retorno_w	:= lpad(ds_retorno_w,8,'0');
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_obter_cod_mat (cd_material_convenio_p text, cd_estabelecimento_p bigint, cd_material_p bigint, dt_material_p timestamp, ie_origem_preco_tiss_p text, cd_convenio_p bigint) FROM PUBLIC;

