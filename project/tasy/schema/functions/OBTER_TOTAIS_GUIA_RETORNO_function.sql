-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_totais_guia_retorno (nr_seq_retorno_p bigint, ie_tipo_p text) RETURNS bigint AS $body$
DECLARE


vl_retorno_w		double precision;
Ie_Valor_Adic_Vinc_w	varchar(1) := 'S';
ie_outros_valores_w	varchar(1) := 'N';
vl_pago_w		convenio_retorno_item.vl_pago%type;
vl_adic_w		convenio_retorno_item.vl_adicional%type;
vl_amenor_w		convenio_retorno_item.vl_amenor%type;
vl_desconto_w		convenio_retorno_item.vl_desconto%type;
vl_glosado_w		convenio_retorno_item.vl_glosado%type;
vl_outros_valores_w	double precision := 0;
/*
ie_tipo_p
V - VALOR A VINCULAR
B - Valor a baixar
O - Outros valores
*/
BEGIN

select	coalesce(sum(a.vl_pago),0),
	coalesce(sum(a.vl_adicional),0),
	coalesce(sum(a.vl_amenor),0),
	coalesce(sum(a.vl_desconto),0),
	coalesce(sum(a.vl_glosado),0)
into STRICT	vl_pago_w,
	vl_adic_w,
	vl_amenor_w,
	vl_desconto_w,
	vl_glosado_w
from	convenio_retorno_item a
where	a.nr_seq_retorno = nr_seq_retorno_p;



if (ie_tipo_p = 'V') then
	Ie_Valor_Adic_Vinc_w := Obter_Param_Usuario(27, 223, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, Ie_Valor_Adic_Vinc_w);
	ie_outros_valores_w := Obter_Param_Usuario(27, 265, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_outros_valores_w);

	if (coalesce(ie_outros_valores_w,'N') = 'S') then

		select	coalesce(sum(x.vl_adicional),0)
		into STRICT	vl_outros_valores_w
		from	convenio_ret_item_valor x,
			convenio_Retorno_item i
		where 	x.nr_Seq_ret_item = i.nr_sequencia
		and	i.nr_seq_retorno = nr_seq_retorno_p;

	end if;


	if (coalesce(Ie_Valor_Adic_Vinc_w,'S') = 'S') then
		vl_retorno_w := vl_pago_w + vl_adic_w + vl_outros_valores_w;
	else
		vl_retorno_w := vl_pago_w + vl_outros_valores_w;
	end if;
elsif (ie_tipo_p = 'B') then


	vl_retorno_w := vl_pago_w + vl_glosado_w + vl_desconto_w;

elsif (ie_tipo_p = 'O') then


	select	coalesce(sum(x.vl_adicional),0)
	into STRICT	vl_retorno_w
	from	convenio_ret_item_valor x,
		convenio_Retorno_item i
	where 	x.nr_Seq_ret_item = i.nr_sequencia
	and	i.nr_seq_retorno = nr_seq_retorno_p;

end if;



return	VL_RETORNO_W;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_totais_guia_retorno (nr_seq_retorno_p bigint, ie_tipo_p text) FROM PUBLIC;

