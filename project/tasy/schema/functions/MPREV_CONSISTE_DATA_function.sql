-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION mprev_consiste_data (nm_data_inicio_p text, dt_inclusao_p timestamp, nm_data_fim_p text, dt_exclusao_p timestamp, nm_tabela_ref_p text, nm_atributo_ref_p text, nr_seq_referencia_p bigint, nm_atributo_consist_p text, nr_seq_consist_p bigint, nr_seq_atual_p bigint, nr_seq_msg_p bigint) RETURNS varchar AS $body$
DECLARE


ds_sql_w	varchar(4000);
dt_inclusao_w	timestamp;
dt_exclusao_w	timestamp;
nr_seq_w	bigint	:= null;
ds_retorno_w	varchar(10);
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Consistir datas de acordo com os parametros passados, impedindo a criação de um registro com datas sobrepostas.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
nm_data_inicio_p	- Nome da data de inclusao na tabela selecionada.
dt_inclusao_p	- Data de inclusão do registro a ser cadastrado.
nm_data_fim_p	- Noma da data de exclusao na tabela selecionada.
dt_exclusao_p	- Data de exclusão do registro a ser cadastado.
nm_tabela_ref_p	- Nome da tabela de referencia.
nm_atributo_ref_p	- Nome do atributo de restrição referenta a tabela superior.
nr_seq_referencia_p	- Valor da sequencia da tabela superior. (NR_SEQUENCIA tabela superior)
nm_atributo_consist_p	- Nome do atributo de consistencia, atributo que
nr_seq_consist_p	- Valor do atributo de consistencia, para restringir pela data.
nr_seq_atual_p	- NR_SEQUENCIA do registro a ser inserido/modificado, para verificar caso o atributo de consistencia seja o mesmo devido ao fato do registro ter sido modificado.
nr_seq_msg_p	- Valor do texto a ser retornado junto das datas de inserção e exclusão. Ex: " Esse profissional já está inserido para a equipe selecionada no período informado. Data de inclusão #@DT_INCLUSAO#@, Data de exclusão #@DT_EXCLUSAO#@."
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
BEGIN
if (dt_exclusao_p IS NOT NULL AND dt_exclusao_p::text <> '') then
	/* Datas entre o período */

	ds_sql_w := '   select	max(nr_sequencia)
			from	' || nm_tabela_ref_p || '
			where	' || nm_atributo_ref_p || ' = :nr_seq_referencia_p
			and	:nr_seq_atual_p <> nr_sequencia
			and	(((:dt_inclusao_p between ' || nm_data_inicio_p || ' and ' || nm_data_fim_p || ') or
				(:dt_exclusao_p between ' || nm_data_inicio_p || ' and ' || nm_data_fim_p || ') or
				(' || nm_data_inicio_p || ' between :dt_inclusao_p and :dt_exclusao_p) or
				(' || nm_data_fim_p || ' between :dt_inclusao_p and :dt_exclusao_p)) and
				(trunc(' || nm_data_fim_p || ',''dd'') > :dt_inclusao_p))
			and	' || nm_data_fim_p || ' is not null';
	if (nm_atributo_consist_p IS NOT NULL AND nm_atributo_consist_p::text <> '') then
		ds_sql_w := ds_sql_w  || ' and	' || nm_atributo_consist_p || ' = ' || nr_seq_consist_p;
	end if;

	EXECUTE ds_sql_w into STRICT nr_seq_w using nr_seq_referencia_p, nr_seq_atual_p, dt_inclusao_p, dt_exclusao_p,
							dt_inclusao_p, dt_exclusao_p, dt_inclusao_p, dt_exclusao_p, dt_inclusao_p;

	/* ((dt_inclusao_p >= dt_inclusao and dt_exclusao_p <= dt_exclusao) or
		(dt_inclusao_p >= dt_inclusao and dt_exclusao_p >= dt_exclusao) or
		(dt_inclusao_p <= dt_inclusao and dt_exclusao_p >= dt_exclusao))*/
	if (coalesce(nr_seq_w::text, '') = '') then
		/* Se não achou, procurar para os casos onde tem só data de inclusão */

	ds_sql_w := '	select	max(nr_sequencia)
			from	' || nm_tabela_ref_p || '
			where	' || nm_atributo_ref_p || ' = :nr_seq_referencia_p
			and	:nr_seq_atual_p <> nr_sequencia
			and	(:dt_inclusao_p >= ' || nm_data_inicio_p || ' or :dt_exclusao_p >= ' || nm_data_inicio_p || ')
			and	' || nm_data_fim_p || ' is null';
	if (nm_atributo_consist_p IS NOT NULL AND nm_atributo_consist_p::text <> '') then
		ds_sql_w := ds_sql_w  || ' and	' || nm_atributo_consist_p || ' = ' || nr_seq_consist_p;
	end if;

	EXECUTE ds_sql_w into STRICT nr_seq_w using nr_seq_referencia_p, nr_seq_atual_p, dt_inclusao_p, dt_exclusao_p;

	end if;
else
	/* Se foi informada no novo registro apenas a data de inclusão */

	/* Neste caso a data de inclusão tem que ser obrigatoriamente maior que a data de exclusão*/

	ds_sql_w := '	select	max(nr_sequencia)
			from	' || nm_tabela_ref_p || '
			where	' || nm_atributo_ref_p || ' = :nr_seq_referencia_p
			and	:nr_seq_atual_p <> nr_sequencia
			and	(
				(trunc(' || nm_data_fim_p || ',''dd'') > :dt_inclusao_p) or
				(' || nm_data_fim_p || ' is null)
				)';

	if (nm_atributo_consist_p IS NOT NULL AND nm_atributo_consist_p::text <> '') then
		ds_sql_w := ds_sql_w  || ' and	' || nm_atributo_consist_p || ' = ' || nr_seq_consist_p;
	end if;

	EXECUTE ds_sql_w into STRICT nr_seq_w using nr_seq_referencia_p, nr_seq_atual_p, dt_inclusao_p;

end if;

if (nr_seq_w IS NOT NULL AND nr_seq_w::text <> '') then
	ds_sql_w := '	select ' || nm_data_inicio_p || '
			from	' || nm_tabela_ref_p  || '
			where	nr_sequencia = :nr_seq_w';

	EXECUTE ds_sql_w into STRICT dt_inclusao_w using nr_seq_w;

	ds_sql_w := '	select ' || nm_data_fim_p || '
			from	' || nm_tabela_ref_p || '
			where nr_sequencia = :nr_seq_w';

	EXECUTE ds_sql_w into STRICT dt_exclusao_w using nr_seq_w;

	if (nr_seq_msg_p IS NOT NULL AND nr_seq_msg_p::text <> '') then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(nr_seq_msg_p, 'DT_INCLUSAO=' || to_char(dt_inclusao_w) || ';DT_EXCLUSAO=' || coalesce(to_char(dt_exclusao_w),lower(wheb_mensagem_pck.get_texto(795417))));
	else
		ds_retorno_w := 'S';
	end if;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION mprev_consiste_data (nm_data_inicio_p text, dt_inclusao_p timestamp, nm_data_fim_p text, dt_exclusao_p timestamp, nm_tabela_ref_p text, nm_atributo_ref_p text, nr_seq_referencia_p bigint, nm_atributo_consist_p text, nr_seq_consist_p bigint, nr_seq_atual_p bigint, nr_seq_msg_p bigint) FROM PUBLIC;

