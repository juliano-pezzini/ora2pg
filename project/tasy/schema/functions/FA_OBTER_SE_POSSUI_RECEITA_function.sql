-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION fa_obter_se_possui_receita (cd_material_p bigint, cd_Pessoa_fisica_p text, nr_atendimento_p bigint, dt_inicio_p timestamp, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


ie_possui_w		varchar(1);
cd_classe_material_w	integer;
param40_w		varchar(1);


BEGIN

if (obtain_user_locale(wheb_usuario_pck.get_nm_usuario) <> 'en_AU') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

	param40_w := obter_param_usuario(10015, 40, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, param40_w);

	SELECT 	max(cd_classe_material)
	into STRICT	cd_classe_material_w
	FROM 	material
	WHERE 	cd_material = cd_material_p;

	select  coalesce(max('S'),'N')
	into STRICT	ie_possui_w
	from	fa_receita_farmacia_item b,
		fa_receita_farmacia a,
		material c
	where 	a.nr_sequencia = b.nr_seq_receita
	and	b.cd_material = c.cd_material
	and	((b.cd_material = cd_material_p) OR (param40_w ='C' AND c.cd_classe_material = cd_classe_material_w))
	and 	((a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (a.nr_atendimento = nr_atendimento_p))
	and 	dt_inicio_p between b.dt_inicio_receita and b.dt_validade_receita
	and	b.nr_sequencia <> coalesce(nr_sequencia_p,0)
	and 	coalesce(a.dt_cancelamento::text, '') = '';
end if;

return	ie_possui_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION fa_obter_se_possui_receita (cd_material_p bigint, cd_Pessoa_fisica_p text, nr_atendimento_p bigint, dt_inicio_p timestamp, nr_sequencia_p bigint) FROM PUBLIC;

