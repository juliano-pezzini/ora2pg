-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_vl_amenor_tit ( nr_titulo_p bigint, ie_opcao_p text, dt_referencia_p timestamp) RETURNS bigint AS $body$
DECLARE

/* 
ie_opcao_p 
A - Ambos 
N - Não 
P - Pendente 
*/
 
 
vl_amenor_w        	double precision;
vl_saldo_titulo_w		double precision;
nr_interno_conta_w		bigint;
cd_autorizacao_w		varchar(20);
vl_guia_w			double precision;
vl_retorno_w			double precision;
vl_grg_w			double precision;
vl_saldo_w			double precision;
vl_total_amenor_w		double precision;
vl_posterior_w			double precision;
ds_nao_informada_w		varchar(100) := wheb_mensagem_pck.Get_Texto(281290);
c01 CURSOR FOR
SELECT	distinct 
	a.cd_autorizacao 
from	lote_audit_hist b, 
	lote_audit_hist_guia a 
where	b.nr_sequencia		= 
	(SELECT	max(x.nr_sequencia) 
	from	lote_audit_hist x 
	where (coalesce(dt_referencia_p::text, '') = '' or trunc(x.dt_lote,'dd') <= dt_referencia_p) 
	and	x.nr_seq_lote_audit	= b.nr_seq_lote_audit) 
and (coalesce(dt_referencia_p::text, '') = '' or trunc(b.dt_lote,'dd') <= dt_referencia_p) 
and	a.nr_seq_lote_hist	= b.nr_sequencia 
and	a.nr_interno_conta	= nr_interno_conta_w;

c02 CURSOR FOR 
SELECT	a.nr_interno_conta 
from	titulo_receber a 
where	a.nr_titulo		= nr_titulo_p 

union all
 
SELECT	a.nr_interno_conta 
from	conta_paciente a, 
	titulo_receber b 
where	a.nr_seq_protocolo	= b.nr_seq_protocolo 
and	b.nr_titulo		= nr_titulo_p;


BEGIN 
 
select	max(obter_saldo_titulo_receber(a.nr_titulo,coalesce(dt_referencia_p,clock_timestamp()))) 
into STRICT	vl_saldo_titulo_w 
from	titulo_receber a 
where	a.nr_titulo			= nr_titulo_p;
 
if (vl_saldo_titulo_w = 0) then	/* se o título não tem saldo, não terá valor de reapresentação */
 
 
	vl_total_amenor_w	:= 0;
 
else 
 
	vl_total_amenor_w	:= 0;
 
	open C02;
	loop 
	fetch C02 into	 
		nr_interno_conta_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
 
		/* ahoffelder - OS 381374 - 10/11/2011 
		substituí o selecr por este cursor por causa da performance. A function OBTER_SALDO_CONPACI chama a 
		OBTER_TITULO_CONTA_GUIA que tem baixa performance */
 
		open	c01;
		loop 
		fetch	c01 into 
			cd_autorizacao_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
 
			select	coalesce(max(a.vl_guia),0) 
			into STRICT	vl_guia_w 
			from	conta_paciente_guia a 
			where	a.nr_interno_conta	= nr_interno_conta_w 
			and	coalesce(a.cd_autorizacao,ds_nao_informada_w) = coalesce(cd_autorizacao_w,ds_nao_informada_w);
 
			select	coalesce(sum(a.vl_pago),0) + coalesce(sum(a.vl_desconto),0) + coalesce(sum(a.vl_perdas),0) + coalesce(sum(a.vl_nota_credito),0) + coalesce(sum(a.vl_glosado),0) 
			into STRICT	vl_retorno_w 
			from	convenio_retorno b, 
				convenio_retorno_item a 
			where (coalesce(dt_referencia_p::text, '') = '' or trunc(coalesce(b.dt_baixa_cr,clock_timestamp()),'dd') <= dt_referencia_p) 
			and	b.ie_status_retorno		= 'F' 
			and	a.nr_seq_retorno		= b.nr_sequencia 
			and	coalesce(a.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_w,a.cd_autorizacao),'0') 
			and	a.nr_interno_conta		= nr_interno_conta_w;
 
			select	coalesce(sum(a.vl_glosa),0) + coalesce(sum(a.vl_pago),0) 
			into STRICT	vl_grg_w 
			FROM lote_audit_hist c, lote_audit_hist_item a, lote_audit_hist_guia b
LEFT OUTER JOIN convenio_retorno d ON (b.nr_seq_retorno = d.nr_sequencia)
WHERE b.nr_sequencia			= a.nr_seq_guia and (coalesce(dt_referencia_p::text, '') = '' or trunc(coalesce(d.dt_retorno,c.dt_lote),'dd') <= dt_referencia_p) and (coalesce(d.dt_retorno,c.dt_lote) IS NOT NULL AND (coalesce(d.dt_retorno,c.dt_lote))::text <> '')  and b.nr_seq_lote_hist		= c.nr_sequencia and coalesce(b.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_w,b.cd_autorizacao),'0') and b.nr_interno_conta		= nr_interno_conta_w;
 
			if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then 
 
				/* valor de glosa que foi baixado com data maior do que a do filtro 
				entra no cálculo porque, antes da data de recebimento, era considerado como reapresentação */
 
				select	coalesce(sum(c.vl_glosa),0) 
				into STRICT	vl_posterior_w 
				FROM titulo_receber_liq c, lote_audit_hist b, lote_audit_hist_guia a
LEFT OUTER JOIN convenio_retorno d ON (a.nr_seq_retorno = d.nr_sequencia)
WHERE c.dt_recebimento		> trunc(dt_referencia_p,'dd') and a.nr_sequencia			= c.nr_seq_lote_hist_guia and trunc(coalesce(d.dt_retorno,b.dt_lote),'dd')		<= dt_referencia_p and (coalesce(d.dt_retorno,b.dt_lote) IS NOT NULL AND (coalesce(d.dt_retorno,b.dt_lote))::text <> '')  and a.nr_seq_lote_hist		= b.nr_sequencia and coalesce(a.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_w,a.cd_autorizacao),'0') and a.nr_interno_conta		= nr_interno_conta_w;
 
			end if;
 
			vl_saldo_w	:= coalesce(vl_guia_w,0) - coalesce(vl_retorno_w,0) - coalesce(vl_grg_w,0) + coalesce(vl_posterior_w,0);
 
			if (vl_saldo_w <> 0) then 
 
				select	sum(c.vl_amenor) 
				into STRICT	vl_amenor_w 
				FROM lote_audit_hist_item c, lote_audit_hist b, lote_audit_hist_guia a
LEFT OUTER JOIN convenio_retorno d ON (a.nr_seq_retorno = d.nr_sequencia)
WHERE a.nr_sequencia		= c.nr_seq_guia and (coalesce(dt_referencia_p::text, '') = '' or trunc(coalesce(d.dt_retorno,b.dt_lote),'dd') <= dt_referencia_p)  and b.nr_sequencia		= 
					(SELECT	max(x.nr_sequencia) 
					FROM lote_audit_hist x, lote_audit_hist_guia y
LEFT OUTER JOIN convenio_retorno z ON (y.nr_seq_retorno = z.nr_sequencia)
WHERE (coalesce(dt_referencia_p::text, '') = '' or trunc(coalesce(z.dt_retorno,x.dt_lote),'dd') <= dt_referencia_p)  and coalesce(y.cd_autorizacao,'0')	= coalesce(a.cd_autorizacao,'0') and y.nr_interno_conta	= a.nr_interno_conta and x.nr_sequencia		= y.nr_seq_lote_hist and x.nr_seq_lote_audit	= b.nr_seq_lote_audit ) and a.nr_seq_lote_hist	= b.nr_sequencia and coalesce(a.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_w,a.cd_autorizacao),'0') and a.nr_interno_conta		= nr_interno_conta_w;
 
				vl_total_amenor_w	:= coalesce(vl_total_amenor_w,0) + coalesce(vl_amenor_w,0) + coalesce(vl_posterior_w,0);
 
			end if;
 
		end	loop;
		close	c01;
 
	end loop;
	close C02;
 
	if (coalesce(vl_total_amenor_w,0) = 0) then	/* se o título ainda não foi tratado na GRG, busca do retorno */
 
 
		select	coalesce(sum(a.vl_amenor),0) vl_amenor 
		into STRICT	vl_total_amenor_w 
		from	convenio_retorno_item a, 
			convenio_retorno b 
		where	not exists (SELECT	1 
			from	convenio_retorno y, 
				convenio_retorno_item x 
			where (coalesce(dt_referencia_p::text, '') = '' or trunc(coalesce(y.dt_baixa_cr,clock_timestamp()),'dd') <= dt_referencia_p) 
			and	y.nr_sequencia			> b.nr_sequencia 
			and	x.nr_seq_retorno		= y.nr_sequencia 
			and	coalesce(x.cd_autorizacao,'0')	= coalesce(a.cd_autorizacao,'0') 
			and	x.nr_interno_conta		= a.nr_interno_conta) 
		and	a.nr_seq_retorno	= b.nr_sequencia 
		and	a.nr_titulo		= nr_titulo_p 
		/*and	((ie_opcao_p = 'A' and a.ie_glosa in ('N','P')) or 
			a.ie_glosa		= ie_opcao_p) linhas retiradas por orientação do Ronaldo Alves.  *ldsantos**/
 
		and (coalesce(dt_referencia_p::text, '') = '' or trunc(coalesce(b.dt_baixa_cr,clock_timestamp()),'dd') <= dt_referencia_p) 
		and	b.ie_status_retorno	= 'F';
 
	end if;
 
end if;
 
return	vl_total_amenor_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_vl_amenor_tit ( nr_titulo_p bigint, ie_opcao_p text, dt_referencia_p timestamp) FROM PUBLIC;

