-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_cardapio_paciente (nr_atendimento_p bigint, cd_setor_atendimento_p bigint, dt_referencia_p timestamp, nr_seq_servico_p bigint, nr_seq_acompanhante_p bigint, cd_acompanhante_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(4000);
nr_seq_opcao_w		bigint;
nr_seq_composicao_w	bigint;
nr_seq_receita_w	bigint;
ds_composicao_w		varchar(60);
ds_receita_w		varchar(255);
ds_abreviado_w		varchar(40);
nr_seq_apres_w		bigint;
ie_producao_terceiro_w	varchar(1);
ds_refeicao_w		varchar(80);

/*Cursor	C01 is
	select	nr_seq_composicao,
		nr_seq_receita,
		Obter_Apres_Serv_Nut(nr_seq_servico_p, nr_seq_composicao) nr_seq_apres
	from	nut_pac_opcao_rec a,
		nut_atend_serv_dia b
	where	a.nr_seq_servico_dia	= b.nr_sequencia
	and	a.nr_seq_servico_dia	= nr_seq_opcao_w
	and	b.nr_seq_servico	= nr_seq_servico_p
	order by 3;*/
C01 CURSOR FOR
	SELECT	a.nr_seq_composicao,
		a.nr_seq_receita,
		Obter_Apres_Serv_Nut(nr_seq_servico_p, a.nr_seq_composicao) nr_seq_apres
	FROM	nut_pac_opcao_rec a,
		nut_atend_serv_dia b,
		nut_receita c
	WHERE	a.nr_seq_servico_dia	= b.nr_sequencia
	and	a.nr_seq_receita = c.nr_sequencia
	and	c.ie_situacao = 'A'
	AND	b.cd_setor_atendimento	= cd_setor_atendimento_p
	AND	b.nr_atendimento	= nr_atendimento_p
	AND	TRUNC(b.DT_SERVICO)	= TRUNC(dt_referencia_p)
	AND	b.nr_seq_servico	= nr_seq_servico_p
	AND	(((cd_acompanhante_p = 0) 	AND (coalesce(cd_acompanhante,0) = 0))     OR ((cd_acompanhante_p <> 0)     AND (coalesce(cd_acompanhante,0)     = cd_acompanhante_p)))
	AND	(((nr_seq_acompanhante_p = 0)   AND (coalesce(nr_seq_acompanhante,0) = 0)) OR ((nr_seq_acompanhante_p <> 0) AND (coalesce(nr_seq_acompanhante,0) = nr_seq_acompanhante_p)))
	order by 3;

C02 CURSOR FOR
	SELECT	c.ds_refeicao
	FROM	nut_pac_opcao_rec a,
		nut_atend_serv_dia b,
		nut_refeicao c
	WHERE	a.nr_seq_servico_dia	= b.nr_sequencia
	and	a.nr_seq_refeicao 	= c.nr_sequencia
	and	c.ie_situacao = 'A'
	AND	b.cd_setor_atendimento	= cd_setor_atendimento_p
	AND	b.nr_atendimento	= nr_atendimento_p
	AND	TRUNC(b.dt_servico)	= TRUNC(dt_referencia_p)
	AND	b.nr_seq_servico	= nr_seq_servico_p
	AND	(((cd_acompanhante_p = 0) 	AND (coalesce(cd_acompanhante,0) = 0))     OR ((cd_acompanhante_p <> 0)     AND (coalesce(cd_acompanhante,0)     = cd_acompanhante_p)))
	AND	(((nr_seq_acompanhante_p = 0)   AND (coalesce(nr_seq_acompanhante,0) = 0)) OR ((nr_seq_acompanhante_p <> 0) AND (coalesce(nr_seq_acompanhante,0) = nr_seq_acompanhante_p)))
	order by 1;


BEGIN

--nr_seq_opcao_w := obter_nut_atend_serv_dia(nr_atendimento_p,cd_setor_atendimento_p,dt_referencia_p, 0, nr_seq_servico_p, 0);
ds_retorno_w	:= '';

select	coalesce(max(ie_producao_terceiro),'N')
into STRICT	ie_producao_terceiro_w
from	parametros_nutricao
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

if (ie_producao_terceiro_w = 'S') then
	begin
	open C02;
	loop
	fetch C02 into
		ds_refeicao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		ds_retorno_w	:= ds_retorno_w || ds_refeicao_w || chr(10) || chr(13);

		end;
	end loop;
	close C02;

	end;
else
	begin
	open C01;
	loop
	fetch C01 into
		nr_seq_composicao_w,
		nr_seq_receita_w,
		nr_seq_apres_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	max(DS_ABREVIADO)
		into STRICT	ds_abreviado_w
		from	nut_comp_servico
		where 	nr_seq_servico		= nr_seq_servico_p
		and	nr_seq_composicao	= nr_seq_composicao_w;

		select	max(ds_composicao)
		into STRICT	ds_composicao_w
		from	nut_composicao
		where	nr_sequencia		= nr_seq_composicao_w;

		select	max(ds_receita)
		into STRICT	ds_receita_w
		from	nut_receita
		where	nr_sequencia		= nr_seq_receita_w;

		ds_retorno_w	:= ds_retorno_w || coalesce(ds_abreviado_w, ds_composicao_w) || ': ' || ds_receita_w || chr(10) || chr(13);

		end;
	end loop;
	close C01;

	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_cardapio_paciente (nr_atendimento_p bigint, cd_setor_atendimento_p bigint, dt_referencia_p timestamp, nr_seq_servico_p bigint, nr_seq_acompanhante_p bigint, cd_acompanhante_p text) FROM PUBLIC;

