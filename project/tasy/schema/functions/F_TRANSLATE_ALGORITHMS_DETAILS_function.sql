-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION f_translate_algorithms_details (descricao_p text) RETURNS varchar AS $body$
DECLARE


descricao_traduzida_w           varchar(32000);
identificador_w                 varchar(50);
identificador_numero_w          varchar(50);
chave_atual_w                   varchar(50);
valor_atual_w                   varchar(50);
formato_data_w                  varchar(50);
expressao_w                     varchar(50);
user_locale_w                   varchar(10);
indice_inicio_w                 bigint;
indice_fim_w                    bigint;



BEGIN

    descricao_traduzida_w:= descricao_p;

    BEGIN
        SELECT ds_locale into STRICT user_locale_w FROM USER_LOCALE WHERE nm_user = wheb_usuario_pck.get_nm_usuario;

    EXCEPTION WHEN OTHERS THEN
        user_locale_w:= null;
    END;

    if (user_locale_w IS NOT NULL AND user_locale_w::text <> '') then

        indice_inicio_w:= position('{' in descricao_p);
        indice_fim_w:= position('}' in descricao_p);

        WHILE(indice_inicio_w > 0 AND
            indice_fim_w > 0 AND
            indice_fim_w > indice_inicio_w) LOOP

            chave_atual_w:= substr(descricao_traduzida_w, indice_inicio_w, (indice_fim_w - indice_inicio_w) + 1);
            identificador_w:= substr(chave_atual_w, 2, 1);
            identificador_numero_w:= substr(chave_atual_w, 2, 2);

            if (identificador_w = '#') then
                valor_atual_w:= substr(chave_atual_w, 3, position('}' in chave_atual_w) - 3);

                descricao_traduzida_w:= replace(descricao_traduzida_w, chave_atual_w, valor_atual_w);
            elsif (identificador_w = '@') then
                valor_atual_w:= substr(chave_atual_w, 3, position('}' in chave_atual_w) - 3);

                if (LENGTH(valor_atual_w) = 10) then
                    BEGIN
                        SELECT ds_localized_mask INTO STRICT formato_data_w FROM locale_formats WHERE id_locale = user_locale_w AND id_mask = 'shortDate';

                    EXCEPTION WHEN OTHERS THEN
                        formato_data_w:= null;
                    END;

                    IF (formato_data_w IS NOT NULL AND formato_data_w::text <> '') THEN
                        valor_atual_w:= TO_CHAR(TO_DATE(valor_atual_w, 'mm/dd/yyyy hh24:mi'), formato_data_w);
                    END IF;
                elsif (LENGTH(valor_atual_w) = 16) then
                    BEGIN
                        SELECT ds_localized_mask INTO STRICT formato_data_w FROM locale_formats WHERE id_locale = user_locale_w AND id_mask = 'short';

                    EXCEPTION WHEN OTHERS THEN
                        formato_data_w:= null;
                    END;

                    IF (formato_data_w IS NOT NULL AND formato_data_w::text <> '') THEN
                        valor_atual_w:= TO_CHAR(TO_DATE(valor_atual_w, 'mm/dd/yyyy hh24:mi'), formato_data_w);
                    END IF;
                end if;

                descricao_traduzida_w:= replace(descricao_traduzida_w, chave_atual_w, valor_atual_w);
            elsif (identificador_numero_w = '~p') then
                valor_atual_w:= LTRIM(substr(chave_atual_w, 4, position('}' in chave_atual_w) - 4), 0);

                descricao_traduzida_w:= replace(descricao_traduzida_w, chave_atual_w, valor_atual_w);
            else
                valor_atual_w:= substr(chave_atual_w, 2, position('}' in chave_atual_w) - 2);

                BEGIN
                    SELECT e.ds_expressao 
                    INTO STRICT expressao_w
                    FROM VALOR_DOMINIO d, 
                        DIC_EXPRESSAO_IDIOMA e 
                    WHERE d.CD_EXP_VALOR_DOMINIO = e.cd_expressao AND 
                        d.CD_DOMINIO = 9959 AND 
                        e.ds_locale = user_locale_w AND 
                        d.VL_DOMINIO = valor_atual_w;

                EXCEPTION WHEN OTHERS THEN
                    expressao_w:= null;
                END;

                IF (expressao_w IS NOT NULL AND expressao_w::text <> '') THEN
                    descricao_traduzida_w:= replace(descricao_traduzida_w, chave_atual_w, expressao_w);
                ELSE
                    descricao_traduzida_w:= replace(descricao_traduzida_w, chave_atual_w, valor_atual_w);
                END IF;
            end if;

            indice_inicio_w:= position('{' in descricao_traduzida_w);
            indice_fim_w:= position('}' in descricao_traduzida_w);
        END LOOP;

    end if;

    RETURN descricao_traduzida_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION f_translate_algorithms_details (descricao_p text) FROM PUBLIC;

