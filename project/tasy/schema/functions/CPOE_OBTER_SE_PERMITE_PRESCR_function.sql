-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_se_permite_prescr ( cd_perfil_p bigint, cd_setor_prescr_p bigint, nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


i_cont_w		smallint;
cd_setor_w		bigint;
ie_permite_w	varchar(10) := 'S';

c01 CURSOR FOR
	SELECT	coalesce(ie_cpoe, 'S') ie_permite
	from	regra_prescr_setor
	where	nr_sequencia > 0
	and 	coalesce(cd_perfil, cd_perfil_p) = cd_perfil_p
	and		coalesce(cd_setor_atendimento, CASE WHEN coalesce(ie_tipo_setor, 'P')='P' THEN  cd_setor_Prescr_p  ELSE cd_setor_w END ) = CASE WHEN coalesce(ie_tipo_setor, 'P')='P' THEN  cd_setor_Prescr_p  ELSE cd_setor_w END
	order by coalesce(cd_perfil, 0),
			 coalesce(cd_setor_atendimento, 0);

type twrow_c01 is table of c01%rowtype index by integer;
row_c01_w	twrow_c01;
i			integer := 1;


BEGIN
	select 	count(*)
	into STRICT	i_cont_w
	from 	regra_prescr_setor
	where 	nr_sequencia > 0;

	if (i_cont_w > 0) then
		select	max(Obter_Setor_Atendimento(nr_atendimento_p))
		into STRICT	cd_setor_w
		;

		open c01;
			loop
			fetch c01 bulk collect into row_c01_w limit 100;
			exit when row_c01_w.count = 0;
				for i in 1..row_c01_w.count
				loop
				  ie_permite_w := row_c01_w[i].ie_permite;
				end loop;
			end loop;
		close c01;
	end if;

	return coalesce(ie_permite_w, 'S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_se_permite_prescr ( cd_perfil_p bigint, cd_setor_prescr_p bigint, nr_atendimento_p bigint) FROM PUBLIC;

