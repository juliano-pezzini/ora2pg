-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_hrs_residuais_port (nr_seq_port_p bigint, dt_ref_p timestamp) RETURNS bigint AS $body$
DECLARE


qt_hr_residuais_retorno_w	double precision;
qt_total_hrs_crono_w		double precision;
pr_realizacao_w				double precision;


BEGIN


select  max(p.pr_realizacao)
into STRICT 	pr_realizacao_w
from    proj_portifolio pf,
		proj_programa pr,
		proj_projeto p,
		proj_cronograma c,
		proj_cron_etapa e
where	pf.nr_sequencia = pr.nr_seq_portifolio
and		pr.nr_sequencia = p.nr_seq_programa
and		p.nr_sequencia = c.nr_seq_proj
and     c.nr_sequencia = e.nr_seq_cronograma
and     c.ie_situacao  = 'A'
and 	pf.nr_sequencia = nr_seq_port_p
and	(c.dt_aprovacao IS NOT NULL AND c.dt_aprovacao::text <> '')
and  	not exists (SELECT 1 from proj_cron_etapa xx where xx.nr_seq_superior =  e.nr_sequencia);

if (coalesce(pr_realizacao_w,0) < 100
	and dt_ref_p > trunc(clock_timestamp()))then
	goto final;
end if;


/*Pega o total de horas previstas de todos os cronogramas deste portifolio*/

select	sum(e.qt_hora_prev)
into STRICT 	qt_total_hrs_crono_w
from 	proj_portifolio pf,
	proj_programa pr,
	proj_projeto p,
	proj_cronograma c,
	proj_cron_etapa e
where pf.nr_sequencia = pr.nr_seq_portifolio
	and	pr.nr_sequencia = p.nr_seq_programa
	and	p.nr_sequencia = c.nr_seq_proj
	and c.nr_sequencia = e.nr_seq_cronograma
	and c.ie_situacao = 'A'
	and c.ie_classificacao = 'D'
	and	(c.dt_aprovacao IS NOT NULL AND c.dt_aprovacao::text <> '')
	and  not exists (SELECT 1 from proj_cron_etapa xx where xx.nr_seq_superior =  e.nr_sequencia)
	and pf.nr_sequencia = nr_seq_port_p;

--horas residuais = (total de hrs  previstas do cronograma) - (Soma das hrs previstas de todas atividades realizadas que contém a dt fim real até a data específica)
select	CASE WHEN max(e.qt_hora_real)=0 THEN  qt_total_hrs_crono_w  ELSE qt_total_hrs_crono_w - sum(e.qt_hora_prev) END
into STRICT 	qt_hr_residuais_retorno_w
from	proj_portifolio pf,
	proj_programa pr,
	proj_projeto p,
	proj_cronograma c,
	proj_cron_etapa e
where pf.nr_sequencia = pr.nr_seq_portifolio
	and pr.nr_sequencia = p.nr_seq_programa
	and p.nr_sequencia = c.nr_seq_proj
	and c.nr_sequencia = e.nr_seq_cronograma
	and c.ie_situacao = 'A'
	and	(c.dt_aprovacao IS NOT NULL AND c.dt_aprovacao::text <> '')
	and c.ie_classificacao = 'D'
	and  not exists (SELECT 1 from proj_cron_etapa xx where xx.nr_seq_superior =  e.nr_sequencia)
	and (e.dt_fim_real IS NOT NULL AND e.dt_fim_real::text <> '')
	and e.dt_fim_real <= pkg_date_utils.end_of(dt_ref_p	, 'DAY')
	and pf.nr_sequencia = nr_seq_port_p;


/*Se o valor estiver nulo neste ponto, provavelmente não houve atividades realizadas ainda. Neste caso deve retornar o valor total das horas do cronograma*/

if (coalesce(qt_hr_residuais_retorno_w::text, '') = '')then
	qt_hr_residuais_retorno_w := coalesce(qt_total_hrs_crono_w, 0);
end if;

<<final>>

return	qt_hr_residuais_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_hrs_residuais_port (nr_seq_port_p bigint, dt_ref_p timestamp) FROM PUBLIC;

