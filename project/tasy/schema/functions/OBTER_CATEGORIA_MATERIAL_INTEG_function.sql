-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_categoria_material_integ ( ie_sistema_externo_p text, cd_material_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
/* Sistema Externo 
B = Bionexo 
*/
 
 
cd_grupo_material_w		smallint;
cd_subgrupo_material_w		smallint;
cd_classe_material_w		integer;
cd_estrutura_w			integer;
nm_tabela_w			varchar(30);
nm_atributo_w			varchar(30);
ie_estrutura_integ_material_w	varchar(1)	:= 'G';
cd_externo_w			varchar(40);

c01 CURSOR FOR 
SELECT	cd_externo 
from	conversao_meio_externo 
where	upper(nm_tabela)				= upper(nm_tabela_w) 
and	upper(nm_atributo)			= upper(nm_atributo_w) 
and	cd_interno				= to_char(cd_estrutura_w) 
and	coalesce(ie_sistema_externo,ie_sistema_externo_p)	= ie_sistema_externo_p 
order by	coalesce(ie_sistema_externo,'9999') desc;


BEGIN 
 
if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then 
	begin 
 
	select	cd_grupo_material, 
		cd_subgrupo_material, 
		cd_classe_material 
	into STRICT	cd_grupo_material_w, 
		cd_subgrupo_material_w, 
		cd_classe_material_w 
	from	estrutura_material_v 
	where	cd_material = cd_material_p;
 
	begin 
	select	coalesce(ie_estrutura_integ_material,'G') 
	into STRICT	ie_estrutura_integ_material_w 
	from	parametro_compras 
	where	cd_estabelecimento = cd_estabelecimento_p;
	exception 
	when others then 
		select	coalesce(max(ie_estrutura_integ_material),'G') 
		into STRICT	ie_estrutura_integ_material_w 
		from	parametro_compras;
	end;
 
	if (ie_estrutura_integ_material_w = 'C') then 
	 
		cd_estrutura_w	:= cd_classe_material_w;
		nm_tabela_w	:= 'CLASSE_MATERIAL';
		nm_atributo_w	:= 'CD_CLASSE_MATERIAL';
	 
	elsif (ie_estrutura_integ_material_w = 'S') then 
 
		cd_estrutura_w	:= cd_subgrupo_material_w;
		nm_tabela_w	:= 'SUBGRUPO_MATERIAL';
		nm_atributo_w	:= 'CD_SUBGRUPO_MATERIAL';
 
	else 
 
		cd_estrutura_w	:= cd_grupo_material_w;
		nm_tabela_w	:= 'GRUPO_MATERIAL';
		nm_atributo_w	:= 'CD_GRUPO_MATERIAL';
 
	end if;
 
	open c01;
	loop 
	fetch c01 into 
		cd_externo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	end loop;
	close c01;
 
	if (coalesce(cd_externo_w::text, '') = '') or (cd_externo_w = '') then 
		cd_externo_w	:= cd_estrutura_w;
	end if;
 
	end;
end if;
 
return	cd_externo_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_categoria_material_integ ( ie_sistema_externo_p text, cd_material_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

