-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_estagio_ordem_compra ( nr_ordem_compra_p bigint, nr_item_oci_p bigint) RETURNS varchar AS $body$
DECLARE

 
 
ie_oc_aprovada_w			varchar(1);
ie_oc_liberada_w			varchar(1);
ie_oc_inspecao_w			varchar(1);
ie_nota_fiscal_w			varchar(1);
ie_nota_fiscal_calc_w		varchar(1);
ie_item_pendente_calc_w 		varchar(1);
ds_retorno_w			varchar(2);


BEGIN 
 
select	distinct 
	max(substr(CASE WHEN to_char(a.dt_liberacao,'dd/mm/yyyy')='' THEN 'N'  ELSE 'S' END ,1,1)) ie_oc_liberada, 
	max(substr(CASE WHEN to_char(a.dt_aprovacao,'dd/mm/yyyy')='' THEN 'N'  ELSE 'S' END ,1,1)) ie_oc_aprovada 
into STRICT	ie_oc_liberada_w, 
	ie_oc_aprovada_w 
from	ordem_compra a, 
	ordem_compra_item b 
where	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
and	a.nr_ordem_compra	= b.nr_ordem_compra 
and	b.nr_item_oci	= nr_item_oci_p 
and	a.nr_ordem_compra	= nr_ordem_compra_p;
 
select	distinct 
	coalesce(max(substr(CASE WHEN to_char(a.dt_recebimento,'dd/mm/yyyy')='' THEN 'N'  ELSE 'S' END ,1,1)),'N') ie_oc_inspecao 
into STRICT	ie_oc_inspecao_w 
from	inspecao_recebimento a, 
	ordem_compra_item b 
where	a.nr_ordem_compra	= nr_ordem_compra_p 
and	a.nr_item_oci		= nr_item_oci_p 
and	b.nr_ordem_compra	= a.nr_ordem_compra;
 
select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
into STRICT	ie_nota_fiscal_w 
from 	nota_fiscal a, 
	nota_fiscal_item b 
where	a.nr_sequencia	= b.nr_sequencia				 	 
and	b.nr_ordem_compra	= nr_ordem_compra_p 
and	b.nr_item_oci	= nr_item_oci_p 
and	coalesce(a.dt_atualizacao_estoque::text, '') = '';
 
select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
into STRICT	ie_nota_fiscal_calc_w 
from 	nota_fiscal a, 
	nota_fiscal_item b 
where	a.nr_sequencia	= b.nr_sequencia				 	 
and	b.nr_ordem_compra	= nr_ordem_compra_p 
and	b.nr_item_oci	= nr_item_oci_p 
and	(a.dt_atualizacao_estoque IS NOT NULL AND a.dt_atualizacao_estoque::text <> '');
 
select	coalesce(max(ie_nota_fiscal_calc),'N') 
into STRICT	ie_item_pendente_calc_w 
from ( 
SELECT 	max(substr(CASE WHEN a.nr_seq_nota_fiscal='' THEN 'N'  ELSE 'S' END ,1,1)) ie_nota_fiscal_calc 
from 	inspecao_recebimento a, 
	nota_fiscal_v n, 
	ordem_compra_item_entrega e, 
	ordem_compra_item i 
where 	a.nr_ordem_compra	= n.nr_ordem_compra 
and	i.nr_ordem_compra	= a.nr_ordem_compra 
and	a.nr_ordem_compra	= nr_ordem_compra_p 
and	e.nr_ordem_compra	= a.nr_ordem_compra 
and 	i.nr_item_oci	= e.nr_item_oci 
and	i.nr_item_oci	= nr_item_oci_p 
and	n.ie_situacao	= '1' 
and	(n.dt_atualizacao_estoque IS NOT NULL AND n.dt_atualizacao_estoque::text <> '') 
having sum(e.qt_prevista_entrega - coalesce(e.qt_real_entrega,0)) > 0) alias7;
 
if (coalesce(ie_item_pendente_calc_w,'N') = 'N') then 
	select	coalesce(max(ie_nota_fiscal_calc),'N') 
	into STRICT	ie_item_pendente_calc_w 
	from ( 
		SELECT 	max(substr(CASE WHEN a.nr_sequencia='' THEN 'N'  ELSE 'S' END ,1,1)) ie_nota_fiscal_calc 
		from 	nota_fiscal a, 
			nota_fiscal_item b, 
			ordem_compra_item i, 
			ordem_compra_item_entrega e 
		where	a.nr_sequencia	= b.nr_sequencia 
		and	b.nr_ordem_compra	= i.nr_ordem_compra 
		and	b.nr_item_oci	= i.nr_item_oci 
		and	i.nr_ordem_compra	= e.nr_ordem_compra 
		and	i.nr_item_oci	= e.nr_item_oci 	 
		and	i.nr_ordem_compra	= nr_ordem_compra_p 
		and	i.nr_item_oci	= nr_item_oci_p 
		and	a.ie_situacao	= '1' 
		and	(a.dt_atualizacao_estoque IS NOT NULL AND a.dt_atualizacao_estoque::text <> '') 
		having	sum(e.qt_prevista_entrega - coalesce(e.qt_real_entrega,0)) > 0) alias9;
end if;
 
if (ie_item_pendente_calc_w = 'S') then 
	ds_retorno_w := 'CP';
elsif (ie_nota_fiscal_calc_w = 'S') then 
	ds_retorno_w := 'CA';
elsif (ie_nota_fiscal_w = 'S') then 
	ds_retorno_w := 'NC';
elsif (ie_oc_inspecao_w = 'S') then 
	ds_retorno_w := 'IN';
elsif (ie_oc_aprovada_w = 'S') then 
	ds_retorno_w := 'AP';
elsif (ie_oc_liberada_w = 'S') then 
	ds_retorno_w := 'LI';
elsif (ie_oc_liberada_w = 'N') then 
	ds_retorno_w := 'NL';
end if;
 
return	ds_retorno_w;
 
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_estagio_ordem_compra ( nr_ordem_compra_p bigint, nr_item_oci_p bigint) FROM PUBLIC;

