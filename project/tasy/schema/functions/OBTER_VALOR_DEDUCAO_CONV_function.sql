-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_deducao_conv ( nr_interno_conta_p bigint, nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, ie_tipo_calculo_p text, ie_base_calculo_p text) RETURNS bigint AS $body$
DECLARE


/* This function can be used to a unique item of patient account or entire account

only NR_INTERNO_CONTA_P - Will retrieve the total value of patient account
NR_SEQ_PROPACI_P or NR_SEQ_MATPACI_P - Will retrive the value just for that item

If informed IE_TIPO_CALCULO_P will consider just that type of calculation

IE_BASE_CALCULO_P
	CI - With Taxes
	SI - Without taxes
	T - All
	I - Taxes
*/
nr_interno_conta_w	conta_paciente.nr_interno_conta%type;
vl_retorno_w		conta_pac_ded_conv_item.vl_rateio%type;

nr_interno_conta_dest_w	conta_paciente.nr_interno_conta%type;
nr_seq_propaci_dest_w	procedimento_paciente.nr_sequencia%type;
nr_seq_matpaci_dest_w	material_atend_paciente.nr_sequencia%type;


BEGIN
nr_interno_conta_w	:= nr_interno_conta_p;
if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') and (coalesce(nr_seq_propaci_p::text, '') = '') and (coalesce(nr_seq_matpaci_p::text, '') = '') then

	if (coalesce(ie_base_calculo_p,'T') <> 'I') then
		select	coalesce(sum(vl_rateio),0)
		into STRICT	vl_retorno_w
		from (/* Origin */
				SELECT	coalesce(sum(CASE WHEN ie_base_calculo_p='CI' THEN b.vl_rateio_com_imp WHEN ie_base_calculo_p='SI' THEN b.vl_rateio_sem_imp  ELSE b.vl_rateio END ),0) vl_rateio
				from	conta_pac_ded_conv_item b,
						conta_pac_deducao_conv a
				where	a.nr_sequencia	= b.nr_seq_deducao_conv
				and		a.nr_seq_conta_orig	= nr_interno_conta_w
				and (a.ie_tipo_calculo	= ie_tipo_calculo_p or coalesce(ie_tipo_calculo_p::text, '') = '')
				
union all

				/* Destination */

				SELECT	coalesce(sum(CASE WHEN ie_base_calculo_p='CI' THEN b.vl_rateio_com_imp WHEN ie_base_calculo_p='SI' THEN b.vl_rateio_sem_imp  ELSE b.vl_rateio END ),0) vl_rateio
				from	conta_pac_ded_conv_item b,
						conta_pac_deducao_conv a
				where	a.nr_sequencia	= b.nr_seq_deducao_conv
				and		a.nr_seq_conta_des	= nr_interno_conta_w
				and (a.ie_tipo_calculo	= ie_tipo_calculo_p or coalesce(ie_tipo_calculo_p::text, '') = '')
				) alias17;
	else
		select	max(a.nr_seq_conta_des)
		into STRICT	nr_interno_conta_dest_w
		from	conta_pac_deducao_conv a
		where	a.nr_seq_conta_orig	= nr_interno_conta_w;

		if (coalesce(nr_interno_conta_dest_w::text, '') = '') then
			nr_interno_conta_dest_w	:= nr_interno_conta_w;
		end if;

		if (nr_interno_conta_dest_w IS NOT NULL AND nr_interno_conta_dest_w::text <> '') then

			select	coalesce(sum(vl_imposto),0)
			into STRICT	vl_retorno_w
			from (SELECT	coalesce(sum(x.pr_imposto/100 * z.vl_rateio),0) vl_imposto
					from	conta_pac_deducao_conv dc,
							conta_pac_ded_conv_item z,
							propaci_imposto x,
							procedimento_paciente y
					where	y.nr_sequencia = x.nr_seq_propaci
					and		z.nr_seq_propaci_dest = y.nr_sequencia
					and		dc.nr_sequencia	= z.nr_seq_deducao_conv
					and (dc.ie_tipo_calculo = ie_tipo_calculo_p or coalesce(ie_tipo_calculo_p::text, '') = '')
					and		y.nr_interno_conta	= nr_interno_conta_dest_w
					
union all

					SELECT	coalesce(sum(x.pr_imposto/100 * z.vl_rateio),0) vl_imposto
					from	conta_pac_deducao_conv dc,
							conta_pac_ded_conv_item z,
							matpaci_imposto x,
							material_atend_paciente y
					where	y.nr_sequencia = x.nr_seq_matpaci
					and		z.nr_seq_matpaci_dest = y.nr_sequencia
					and		dc.nr_sequencia = z.nr_seq_deducao_conv
					and (dc.ie_tipo_calculo = ie_tipo_calculo_p or coalesce(ie_tipo_calculo_p::text, '') = '')
					and		y.nr_interno_conta	= nr_interno_conta_dest_w
					) alias11;
		end if;
	end if;
elsif (nr_seq_propaci_p IS NOT NULL AND nr_seq_propaci_p::text <> '') then
	if (coalesce(nr_interno_conta_p::text, '') = '') then
		select	a.nr_interno_conta
		into STRICT	nr_interno_conta_w
		from	procedimento_paciente a
		where	a.nr_sequencia	= nr_seq_propaci_p;
	end if;

	if (coalesce(ie_base_calculo_p,'T') <> 'I') then
		select	coalesce(sum(vl_rateio),0) vl_rateio
		into STRICT	vl_retorno_w
		from (/* Origin*/
				SELECT	coalesce(sum(CASE WHEN ie_base_calculo_p='CI' THEN b.vl_rateio_com_imp WHEN ie_base_calculo_p='SI' THEN b.vl_rateio_sem_imp  ELSE b.vl_rateio END ),0) vl_rateio
				from	conta_pac_ded_conv_item b,
						conta_pac_deducao_conv a
				where	a.nr_sequencia	= b.nr_seq_deducao_conv
				and		a.nr_seq_conta_orig	= nr_interno_conta_w
				and		b.nr_seq_propaci_origem	= nr_seq_propaci_p
				and (a.ie_tipo_calculo	= ie_tipo_calculo_p or coalesce(ie_tipo_calculo_p::text, '') = '')
				
union all

				/* Destination */

				SELECT	coalesce(sum(CASE WHEN ie_base_calculo_p='CI' THEN b.vl_rateio_com_imp WHEN ie_base_calculo_p='SI' THEN b.vl_rateio_sem_imp  ELSE b.vl_rateio END ),0) vl_rateio
				from	conta_pac_ded_conv_item b,
						conta_pac_deducao_conv a
				where	a.nr_sequencia	= b.nr_seq_deducao_conv
				and		a.nr_seq_conta_des	= nr_interno_conta_w
				and		b.nr_seq_propaci_dest	= nr_seq_propaci_p
				and (a.ie_tipo_calculo	= ie_tipo_calculo_p or coalesce(ie_tipo_calculo_p::text, '') = '')
				) alias12;
	else
		select	max(b.nr_seq_propaci_dest)
		into STRICT	nr_seq_propaci_dest_w
		from	conta_pac_ded_conv_item b,
				conta_pac_deducao_conv a
		where	b.nr_seq_deducao_conv = a.nr_sequencia
		and		a.nr_seq_conta_orig	= nr_interno_conta_w
		and		b.nr_seq_propaci_origem = nr_seq_propaci_p;

		if (coalesce(nr_seq_propaci_dest_w::text, '') = '') then
				select	max(b.nr_seq_propaci_dest)
				into STRICT	nr_seq_propaci_dest_w
				from	conta_pac_ded_conv_item b,
						conta_pac_deducao_conv a
				where	b.nr_seq_deducao_conv = a.nr_sequencia
				and		a.nr_seq_conta_des	= nr_interno_conta_w
				and		b.nr_seq_propaci_dest = nr_seq_propaci_p;
		end if;

		if (nr_seq_propaci_dest_w IS NOT NULL AND nr_seq_propaci_dest_w::text <> '') then
			select	coalesce(sum(x.pr_imposto/100 * z.vl_rateio),0)
			into STRICT	vl_retorno_w
			from	conta_pac_deducao_conv dc,
					conta_pac_ded_conv_item z,
					propaci_imposto x,
					procedimento_paciente y
			where	y.nr_sequencia = x.nr_seq_propaci
			and		z.nr_seq_propaci_dest = y.nr_sequencia
			and		dc.nr_sequencia	= z.nr_seq_deducao_conv
			and (dc.ie_tipo_calculo = ie_tipo_calculo_p or coalesce(ie_tipo_calculo_p::text, '') = '')
			and		y.nr_sequencia	= nr_seq_propaci_dest_w;
		end if;
	end if;
elsif (nr_seq_matpaci_p IS NOT NULL AND nr_seq_matpaci_p::text <> '') then
	if (coalesce(nr_interno_conta_p::text, '') = '') then
		select	a.nr_interno_conta
		into STRICT	nr_interno_conta_w
		from	material_atend_paciente a
		where	a.nr_sequencia	= nr_seq_matpaci_p;
	end if;

	if (coalesce(ie_base_calculo_p,'T') <> 'I') then
		select	coalesce(sum(vl_rateio),0)
		into STRICT	vl_retorno_w
		from (/* Origin*/
				SELECT	coalesce(sum(CASE WHEN ie_base_calculo_p='CI' THEN b.vl_rateio_com_imp WHEN ie_base_calculo_p='SI' THEN b.vl_rateio_sem_imp  ELSE b.vl_rateio END ),0) vl_rateio
				from	conta_pac_ded_conv_item b,
						conta_pac_deducao_conv a
				where	a.nr_sequencia	= b.nr_seq_deducao_conv
				and		a.nr_seq_conta_orig	= nr_interno_conta_w
				and		b.nr_seq_matpaci_origem	= nr_seq_matpaci_p
				and (a.ie_tipo_calculo	= ie_tipo_calculo_p or coalesce(ie_tipo_calculo_p::text, '') = '')
				
union all

				/* Destination */

				SELECT	coalesce(sum(CASE WHEN ie_base_calculo_p='CI' THEN b.vl_rateio_com_imp WHEN ie_base_calculo_p='SI' THEN b.vl_rateio_sem_imp  ELSE b.vl_rateio END ),0) vl_rateio
				from	conta_pac_ded_conv_item b,
						conta_pac_deducao_conv a
				where	a.nr_sequencia	= b.nr_seq_deducao_conv
				and		a.nr_seq_conta_des	= nr_interno_conta_w
				and		b.nr_seq_matpaci_dest	= nr_seq_matpaci_p
				and (a.ie_tipo_calculo	= ie_tipo_calculo_p or coalesce(ie_tipo_calculo_p::text, '') = '')
				) alias12;
	else
		select	max(b.nr_seq_matpaci_dest)
		into STRICT	nr_seq_matpaci_dest_w
		from	conta_pac_ded_conv_item b,
				conta_pac_deducao_conv a
		where	b.nr_seq_deducao_conv = a.nr_sequencia
		and		a.nr_seq_conta_orig	= nr_interno_conta_w
		and		b.nr_seq_matpaci_origem = nr_seq_matpaci_p;

		if (nr_seq_matpaci_dest_w IS NOT NULL AND nr_seq_matpaci_dest_w::text <> '') then
			select	max(b.nr_seq_matpaci_dest)
			into STRICT	nr_seq_matpaci_dest_w
			from	conta_pac_ded_conv_item b,
					conta_pac_deducao_conv a
			where	b.nr_seq_deducao_conv = a.nr_sequencia
			and		a.nr_seq_conta_des	= nr_interno_conta_w
			and		b.nr_seq_matpaci_dest = nr_seq_matpaci_p;
		end if;

		if (nr_seq_matpaci_dest_w IS NOT NULL AND nr_seq_matpaci_dest_w::text <> '') then
			select	coalesce(sum(x.pr_imposto/100 * z.vl_rateio),0)
			into STRICT	vl_retorno_w
			from	conta_pac_deducao_conv dc,
					conta_pac_ded_conv_item z,
					matpaci_imposto x,
					material_atend_paciente y
			where	y.nr_sequencia = x.nr_seq_matpaci
			and		z.nr_seq_matpaci_dest = y.nr_sequencia
			and		dc.nr_sequencia = z.nr_seq_deducao_conv
			and (dc.ie_tipo_calculo = ie_tipo_calculo_p or coalesce(ie_tipo_calculo_p::text, '') = '')
			and		y.nr_sequencia	= nr_seq_matpaci_dest_w;
		end if;
	end if;
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_deducao_conv ( nr_interno_conta_p bigint, nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, ie_tipo_calculo_p text, ie_base_calculo_p text) FROM PUBLIC;

