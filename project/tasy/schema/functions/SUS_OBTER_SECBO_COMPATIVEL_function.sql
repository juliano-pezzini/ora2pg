-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_secbo_compativel ( cd_profissional_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_procedimento_p timestamp default clock_timestamp(), cd_cbo_p text DEFAULT NULL, ie_funcao_p bigint DEFAULT NULL) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(1)	:= 'N';
qt_cbo_anest_w		bigint	:= 0;
qt_cbo_proc_w		bigint	:= 0;
cd_estabelecimento_w	integer 	:= coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);
dt_procedimento_w	procedimento_paciente.dt_procedimento%type;


BEGIN

begin
dt_procedimento_w := establishment_timezone_utils.startOfMonth(dt_procedimento_p);
exception
when others then
	dt_procedimento_w := clock_timestamp();
end;

select	count(1)
into STRICT	qt_cbo_proc_w
from	sus_procedimento_cbo x
where	x.cd_procedimento 	= cd_procedimento_p
and	x.ie_origem_proced	= ie_origem_proced_p  LIMIT 1;

/* Esse cddigo nao possui CBO compativel mas e exigido CBO pelo SUS. portanto pode ser enviado qualquer CBO do medico. */

if (cd_procedimento_p = 0802020011) then
	begin

	select	coalesce(max('S'),'N')
	into STRICT	ie_retorno_w
	from	sus_cbo_pessoa_fisica	a
	where	a.cd_pessoa_fisica	= cd_profissional_p
	and	a.cd_cbo		= cd_cbo_p
	and	dt_procedimento_w between coalesce(a.dt_inicio_vigencia,dt_procedimento_w) and coalesce(a.dt_fim_vigencia,dt_procedimento_w)
	and	coalesce(a.cd_estab_exclusivo,cd_estabelecimento_w) = cd_estabelecimento_w;

	end;
elsif (qt_cbo_proc_w > 0) then
	begin
	
	if (establishment_timezone_utils.startOfMonth(dt_procedimento_w) < establishment_timezone_utils.startOfDay(to_date('01/07/2013','dd/mm/yyyy'))) then
		begin
		select	coalesce(max('S'),'N')
		into STRICT	ie_retorno_w
		from	sus_cbo_pessoa_fisica	a
		where	a.cd_pessoa_fisica	= cd_profissional_p
		and	a.cd_cbo		= cd_cbo_p
		and	dt_procedimento_w between coalesce(a.dt_inicio_vigencia,dt_procedimento_w) and coalesce(a.dt_fim_vigencia,dt_procedimento_w)
		and	coalesce(a.cd_estab_exclusivo,cd_estabelecimento_w) = cd_estabelecimento_w
		and	exists (SELECT	1
				from	sus_procedimento_cbo x
				where	x.cd_cbo 		= a.cd_cbo
				and	x.cd_procedimento 	= cd_procedimento_p
				and	x.ie_origem_proced	= ie_origem_proced_p);		
		end;
	else
		begin
		select	coalesce(max('S'),'N')
		into STRICT	ie_retorno_w
		from	sus_cbo_pessoa_fisica	a
		where	a.cd_pessoa_fisica	= cd_profissional_p
		and	a.cd_cbo		= cd_cbo_p
		and	dt_procedimento_w between coalesce(a.dt_inicio_vigencia,dt_procedimento_w) and coalesce(a.dt_fim_vigencia,dt_procedimento_w)
		and	coalesce(a.cd_estab_exclusivo,cd_estabelecimento_w) = cd_estabelecimento_w
		and (exists (SELECT	1
				from	sus_procedimento_cbo x
				where	x.cd_cbo 		= a.cd_cbo
				and	x.cd_procedimento 	= cd_procedimento_p
				and	x.ie_origem_proced	= ie_origem_proced_p) or (coalesce(sus_obter_cbo_proc_med_comp(cd_procedimento_p,ie_origem_proced_p,a.cd_cbo,dt_procedimento_p),'N') = 'S'));		
		end;
	end if;

	end;
else
	ie_retorno_w := 'S';
end if;

/* Felipe - OS 81487 O SUS Informou que nos meses Janeiro  / Favereiro e Marco so sera advertido quanto ao CBO incorreto,
por isso estou fazendo o Tasy exportar qualquer CBO do medico caso o mesmo nao tenha CBO compativel */
if (ie_retorno_w = 'N') and (clock_timestamp() < to_date('30/03/2008', 'dd/mm/yyyy')) then
	select	coalesce(max('E'),'N')
	into STRICT	ie_retorno_w
	from	sus_cbo_pessoa_fisica	a
	where	a.cd_pessoa_fisica	= cd_profissional_p
	and	a.cd_cbo		= cd_cbo_p
	and	dt_procedimento_w between coalesce(a.dt_inicio_vigencia,dt_procedimento_w) and coalesce(a.dt_fim_vigencia,dt_procedimento_w)
	and	coalesce(a.cd_estab_exclusivo,cd_estabelecimento_w) = cd_estabelecimento_w;
end if;

if (sus_obter_indicador_equipe(ie_funcao_p) = 6) and (cd_cbo_p 	in ('223104','225151')) then

	select	count(1)
	into STRICT	qt_cbo_anest_w
	from	sus_cbo_pessoa_fisica
	where	cd_pessoa_fisica	= cd_profissional_p
	and	dt_procedimento_w between coalesce(dt_inicio_vigencia,dt_procedimento_w) and coalesce(dt_fim_vigencia,dt_procedimento_w)
	and	cd_cbo		in ('223104','225151')  LIMIT 1;	

	if (qt_cbo_anest_w > 0 ) then
		ie_retorno_w := 'S';
	end if;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_secbo_compativel ( cd_profissional_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_procedimento_p timestamp default clock_timestamp(), cd_cbo_p text DEFAULT NULL, ie_funcao_p bigint DEFAULT NULL) FROM PUBLIC;

