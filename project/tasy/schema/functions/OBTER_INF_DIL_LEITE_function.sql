-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_dil_leite ( nr_prescricao_p prescr_material.nr_prescricao%type, nr_seq_item_p prescr_material.nr_sequencia%type, nr_agrupamento_p prescr_material.nr_agrupamento%type, qt_vel_infusao_p prescr_leite_deriv.qt_vel_infusao%type, ie_via_aplicacao_p prescr_leite_deriv.ie_via_aplicacao%type, qt_volume_total_p prescr_leite_deriv.qt_volume_total%type, qt_volume_oral_p prescr_leite_deriv.qt_volume_oral%type, qt_volume_sonda_p prescr_leite_deriv.qt_volume_sonda%type, nr_seq_disp_succao_p prescr_leite_deriv.nr_seq_disp_succao%type, cd_intervalo_p prescr_material.cd_intervalo%type ) RETURNS varchar AS $body$
DECLARE


ds_justificativa_w 	cpoe_material.ds_justificativa%type;
obter_compostos_w	varchar(1000);
ds_disp_succao_w	varchar(40);
ds_retorno_w		varchar(4000);
ds_intervalo_w		varchar(50);
ds_observacao_w     cpoe_material.ds_observacao%type;
ds_leite_derivado_w		varchar(2000);
ds_leite_derivado_ww	varchar(2000);
ie_acm_w			cpoe_material.ie_acm%type;
ie_se_necessario_w	cpoe_material.ie_se_necessario%type;


BEGIN

select	max(x.ie_acm),
		max(x.ie_se_necessario),
		max(coalesce(d.nm_produto,y.ds_material))
into STRICT	ie_acm_w,
		ie_se_necessario_w,
		ds_leite_derivado_w
from	prescr_material x,
		nutricao_leite_deriv d,
		material y
where	x.nr_prescricao	= nr_prescricao_p
and		x.cd_material = y.cd_material
and		y.cd_material = d.cd_material
and		x.nr_agrupamento = nr_agrupamento_p
and		x.ie_agrupador	= 16;

ds_leite_derivado_ww := substr(ds_leite_derivado_w || ' ' || adep_obter_um_dosagem_prescr(nr_prescricao_p, nr_seq_item_p, ie_acm_w, ie_se_necessario_w),1,2000);
obter_compostos_w := plt_obter_compostos(nr_prescricao_p, nr_seq_item_p, nr_agrupamento_p,'LD');
ds_disp_succao_w := substr(Obter_desc_disp_succao(nr_seq_disp_succao_p),1,40);
ds_justificativa_w := obter_justificativa_item(nr_prescricao_p, nr_seq_item_p, 'S');
ds_observacao_w := obter_observacao_item_prescr('S', nr_prescricao_p, nr_seq_item_p);

if (ds_leite_derivado_w IS NOT NULL AND ds_leite_derivado_w::text <> '') then
	ds_retorno_w := substr(ds_leite_derivado_ww,1,2000) || chr(10);
end if;

if (obter_compostos_w IS NOT NULL AND obter_compostos_w::text <> '') then
	ds_retorno_w := substr(ds_retorno_w || obter_compostos_w,1,2000) || chr(10);
end if;

if (qt_vel_infusao_p IS NOT NULL AND qt_vel_infusao_p::text <> '') then

	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || chr(10) || /* Veloc (ml/h) */
 wheb_mensagem_pck.get_texto(1091740) || qt_vel_infusao_p ,1,1900);
	else
		ds_retorno_w := substr(/* Veloc (ml/h) */
 wheb_mensagem_pck.get_texto(1091740) || qt_vel_infusao_p ,1,1900);
	end if;
	
end if;

if (ds_disp_succao_w IS NOT NULL AND ds_disp_succao_w::text <> '') then

	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || chr(10) || /* Dispositivo:  */
 wheb_mensagem_pck.get_texto(1091741) || Obter_desc_disp_succao(nr_seq_disp_succao_p),1,1900);
	else
		ds_retorno_w := substr(/* Dispositivo:  */
 wheb_mensagem_pck.get_texto(1091741) || Obter_desc_disp_succao(nr_seq_disp_succao_p),1,1900);
	end if;
	
end if;

if (qt_volume_total_p IS NOT NULL AND qt_volume_total_p::text <> '') then

	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || chr(10) || /* Administrar */
 wheb_mensagem_pck.get_texto(306859) || ' ' || qt_volume_total_p || ' ' || /* Mililitros */
 wheb_mensagem_pck.get_texto(1091746),1,1900);
	else
		ds_retorno_w := substr(/* Administrar */
 wheb_mensagem_pck.get_texto(306859) || ' ' || qt_volume_total_p || ' ' || /* Mililitros */
 wheb_mensagem_pck.get_texto(1091746),1,1900);
	end if;
	
	if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
		select	max(ds_prescricao)
		into STRICT	ds_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo	= cd_intervalo_p;
	end if;

	if (ds_intervalo_w IS NOT NULL AND ds_intervalo_w::text <> '') then
		ds_retorno_w := ds_retorno_w || ' (' || ds_intervalo_w || ') ';
	end if;
	
	if (ie_via_aplicacao_p = 'O') then
		ds_retorno_w := ds_retorno_w || ' ' || /* Via oral */
 wheb_mensagem_pck.get_texto(1091743);
	elsif (ie_via_aplicacao_p = 'S') then
		ds_retorno_w := ds_retorno_w || ' ' || /* Via sonda */
 wheb_mensagem_pck.get_texto(1091744);
	else
		ds_retorno_w := ds_retorno_w || ' ' || /* , sendo #@qt_volume_oral#@ ml(via oral) e #@qt_volume_sonda#@ ml(via sonda) */ wheb_mensagem_pck.get_texto(1091745, 'qt_volume_oral=' || qt_volume_oral_p || ';' || 'qt_volume_sonda=' || qt_volume_sonda_p);
	end if;

end if;

if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then

	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || chr(10) || ds_observacao_w,1,1900);
    	else
		ds_retorno_w := substr(ds_observacao_w,1,1900);
	end if;
	
end if;

if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then

	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || chr(10) || /* Justificativa: #@DS_JUSTIFICATIVA#@ */
 wheb_mensagem_pck.get_texto(1091527,'DS_JUSTIFICATIVA=' || ds_justificativa_w),1,1900);
    	else
		ds_retorno_w := substr(/* Justificativa: #@DS_JUSTIFICATIVA#@ */
 wheb_mensagem_pck.get_texto(1091527,'DS_JUSTIFICATIVA=' || ds_justificativa_w),1,1900);
	end if;

end if;


return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_dil_leite ( nr_prescricao_p prescr_material.nr_prescricao%type, nr_seq_item_p prescr_material.nr_sequencia%type, nr_agrupamento_p prescr_material.nr_agrupamento%type, qt_vel_infusao_p prescr_leite_deriv.qt_vel_infusao%type, ie_via_aplicacao_p prescr_leite_deriv.ie_via_aplicacao%type, qt_volume_total_p prescr_leite_deriv.qt_volume_total%type, qt_volume_oral_p prescr_leite_deriv.qt_volume_oral%type, qt_volume_sonda_p prescr_leite_deriv.qt_volume_sonda%type, nr_seq_disp_succao_p prescr_leite_deriv.nr_seq_disp_succao%type, cd_intervalo_p prescr_material.cd_intervalo%type ) FROM PUBLIC;

