-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_edicao_proc_2 ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, dt_conta_p timestamp, cd_procedimento_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
ie_prioridade_edicao_w		varchar(2);
cd_edicao_amb_w			integer;
dt_inicio_vigencia_w		timestamp;
vl_ch_honorarios_w		double precision := 1;
vl_ch_custo_oper_w		double precision := 1;
vl_m2_filme_w			double precision := 0;
tx_ajuste_geral_w		double precision;
ds_retorno_w			varchar(255);
nr_Seq_cbhpm_edicao_w		bigint;


BEGIN 
 
select	coalesce(max(ie_prioridade_edicao_amb), 'N') 
into STRICT	ie_prioridade_edicao_w 
from	parametro_faturamento 
where	cd_estabelecimento	= cd_estabelecimento_p;
 
if (ie_prioridade_edicao_w	= 'N') then 
	begin 
	select 	cd_edicao_amb, 
    		CASE WHEN coalesce(vl_ch_honorarios::text, '') = '' THEN 1 WHEN vl_ch_honorarios=0 THEN 1  ELSE vl_ch_honorarios END , 
    		CASE WHEN coalesce(vl_ch_custo_oper::text, '') = '' THEN 1 WHEN vl_ch_custo_oper=0 THEN 1  ELSE vl_ch_custo_oper END , 
	    	coalesce(vl_filme,0), 
		dt_inicio_vigencia 
	into STRICT  	cd_edicao_amb_w, 
	    	vl_ch_honorarios_w, 
    		vl_ch_custo_oper_w, 
    		vl_m2_filme_w, 
		dt_inicio_vigencia_w 
	from 	convenio_amb 
	where (cd_estabelecimento   = cd_estabelecimento_p) 
	and (cd_convenio      = cd_convenio_p) 
	and (cd_categoria      = cd_categoria_p) 
	and (coalesce(ie_situacao,'A')	= 'A') 
	and 	(dt_inicio_vigencia   = 
			(SELECT	max(dt_inicio_vigencia) 
    			from 	convenio_amb a 
			where (a.cd_estabelecimento = cd_estabelecimento_p) 
	and (a.cd_convenio     = cd_convenio_p) 
	and (a.cd_categoria    = cd_categoria_p) 
	and (coalesce(a.ie_situacao,'A')= 'A') 
	and (a.dt_inicio_vigencia <= dt_conta_p)));
	exception 
		when 	others then 
			begin 
			cd_edicao_amb_w 		:= 0;
			vl_ch_honorarios_w	:= 0;
			vl_ch_custo_oper_w	:= 0;
			vl_m2_filme_w		:= 0;
		end;
	end;
	 
else 
	SELECT * FROM obter_edicao_proc_conv(	cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, dt_conta_p, cd_procedimento_p, cd_edicao_amb_w, vl_ch_honorarios_w, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_Seq_cbhpm_edicao_w) INTO STRICT cd_edicao_amb_w, vl_ch_honorarios_w, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_Seq_cbhpm_edicao_w;
				 
end if;
 
 
if (ie_opcao_p = 'D') then 
	ds_retorno_w	:= obter_desc_edicao_amb(cd_edicao_amb_w);
else 
	ds_retorno_w	:= cd_edicao_amb_w;
end if;
 
 
return	 ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_edicao_proc_2 ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, dt_conta_p timestamp, cd_procedimento_p bigint, ie_opcao_p text) FROM PUBLIC;

