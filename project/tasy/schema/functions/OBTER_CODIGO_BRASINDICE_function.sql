-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_codigo_brasindice ( CD_ESTABELECIMENTO_P bigint, CD_MATERIAL_P bigint, DT_VIGENCIA_P timestamp, CD_CONVENIO_P bigint, NR_SEQ_MARCA_P bigint DEFAULT 0) RETURNS varchar AS $body$
DECLARE



cd_laboratorio_w		varchar(06);
cd_medicamento_w		varchar(06);
cd_apresentacao_w		varchar(06);
dt_vigencia_w			timestamp;
cd_brasindice_w			varchar(255);
ie_tipo_convenio_w		smallint;
ie_ordem_relac_bras_w		varchar(1);

C01 CURSOR FOR
	SELECT	CD_LABORATORIO,
		CD_MEDICAMENTO,
		CD_APRESENTACAO
	FROM	MATERIAL_BRASINDICE
	WHERE	CD_MATERIAL			= CD_MATERIAL_P
	and	coalesce(IE_SITUACAO, 'A')	= 'A'
	--and	nvl(dt_vigencia,dt_vigencia_w)	<= dt_vigencia_w
	and 	dt_vigencia_w between coalesce(dt_vigencia, dt_vigencia_w) and coalesce(dt_final_vigencia, dt_vigencia_w)
	and	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p, 0)) = coalesce(cd_estabelecimento_p, 0)
	and 	coalesce(cd_convenio, coalesce(cd_convenio_p,0)) = coalesce(cd_convenio_p,0)
	and	coalesce(ie_tipo_convenio, coalesce(ie_tipo_convenio_w,0)) = coalesce(ie_tipo_convenio_w,0)
	and	coalesce(nr_seq_marca,coalesce(nr_seq_marca_p,0)) 	= coalesce(nr_seq_marca_p,0)
	order by coalesce(dt_vigencia,clock_timestamp() - interval '1000 days'),
		coalesce(cd_convenio,0),
		coalesce(ie_tipo_convenio,0),
		coalesce(cd_estabelecimento,0),
		coalesce(nr_seq_marca, 0);

C02 CURSOR FOR
	SELECT	CD_LABORATORIO,
		CD_MEDICAMENTO,
		CD_APRESENTACAO
	FROM	MATERIAL_BRASINDICE
	WHERE	CD_MATERIAL			= CD_MATERIAL_P
	and	coalesce(IE_SITUACAO, 'A')	= 'A'
	--and	nvl(dt_vigencia,dt_vigencia_w)	<= dt_vigencia_w
	and 	dt_vigencia_w between coalesce(dt_vigencia, dt_vigencia_w) and coalesce(dt_final_vigencia, dt_vigencia_w)
	and	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p, 0)) = coalesce(cd_estabelecimento_p, 0)
	and 	coalesce(cd_convenio, coalesce(cd_convenio_p,0)) = coalesce(cd_convenio_p,0)
	and	coalesce(ie_tipo_convenio, coalesce(ie_tipo_convenio_w,0)) = coalesce(ie_tipo_convenio_w,0)
	and	coalesce(nr_seq_marca,coalesce(nr_seq_marca_p,0)) 	= coalesce(nr_seq_marca_p,0)
	order by	coalesce(cd_convenio,0),
		coalesce(ie_tipo_convenio,0),
		coalesce(cd_estabelecimento,0),
		coalesce(dt_vigencia,clock_timestamp() - interval '10000 days'),
		coalesce(nr_seq_marca, 0);


BEGIN


DT_VIGENCIA_W 	:= coalesce(DT_VIGENCIA_P,clock_timestamp());

if (coalesce(cd_convenio_p,0) > 0) then
	select	coalesce(max(ie_tipo_convenio),0)
	into STRICT	ie_tipo_convenio_w
	from	convenio
	where	cd_convenio = cd_convenio_p;
end if;

select	coalesce(max(ie_ordem_relac_bras),'N')
into STRICT	ie_ordem_relac_bras_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_p;


if (ie_ordem_relac_bras_w = 'S') then

	OPEN C02;
	LOOP
	FETCH C02 into
			cd_laboratorio_w,
			cd_medicamento_w,
			cd_apresentacao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
			cd_laboratorio_w	:= cd_laboratorio_w;
	END LOOP;
	CLOSE C02;

else

	OPEN C01;
	LOOP
	FETCH C01 into
			cd_laboratorio_w,
			cd_medicamento_w,
			cd_apresentacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
			cd_laboratorio_w	:= cd_laboratorio_w;
	END LOOP;
	CLOSE C01;

end if;

cd_brasindice_w	:= cd_laboratorio_w || ';' || cd_medicamento_w || ';' || cd_apresentacao_w;

if (cd_brasindice_w	= ';;') then
	cd_brasindice_w	:= '';
end if;


Return cd_brasindice_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_codigo_brasindice ( CD_ESTABELECIMENTO_P bigint, CD_MATERIAL_P bigint, DT_VIGENCIA_P timestamp, CD_CONVENIO_P bigint, NR_SEQ_MARCA_P bigint DEFAULT 0) FROM PUBLIC;

