-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_processar_regra_un_min_mat ( nr_seq_contrato_p pls_segurado.nr_seq_contrato%type, nr_seq_intercambio_p pls_segurado.nr_seq_intercambio%type, nr_seq_ops_congenere_p pls_segurado.nr_seq_ops_congenere%type, nr_seq_grupo_intercambio_p pls_segurado.nr_seq_grupo_intercambio%type, dt_atendimento_p pls_conta_mat.dt_atendimento%type, nr_seq_material_p pls_conta_mat.nr_seq_material%type ) RETURNS PLS_REGRA_CONV_UM_MAT.NR_SEQUENCIA%TYPE AS $body$
DECLARE


nr_contrato_w			pls_contrato.nr_contrato%type;
ie_regra_valida_w		varchar(1);
nr_seq_regra_obtida_w	pls_regra_conv_um_mat.nr_sequencia%type;
ie_tipo_despesa_w		pls_material.ie_tipo_despesa%type;

C01 CURSOR FOR
	SELECT	a.nr_contrato,
			a.nr_sequencia
	from	pls_regra_conv_um_mat a
	where	( (coalesce(a.nr_seq_contrato::text, '') = '') or (a.nr_seq_contrato = nr_seq_contrato_p))
	and		( (coalesce(a.nr_seq_intercambio::text, '') = '') or (a.nr_seq_intercambio = nr_seq_intercambio_p))
	and		( (coalesce(a.nr_seq_ops_congenere::text, '') = '') or (a.nr_seq_ops_congenere = nr_seq_ops_congenere_p))
	and 	( (coalesce(a.nr_seq_grupo_intercambio::text, '') = '') or ( a.nr_seq_grupo_intercambio= nr_seq_grupo_intercambio_p))
	and		( (coalesce(a.nr_seq_ops_congenere::text, '') = '') or (a.nr_seq_ops_congenere = nr_seq_ops_congenere_p))
	and		((a.ie_tipo_despesa is  null) or (a.ie_tipo_despesa = ie_tipo_despesa_w))
	and		((coalesce(a.nr_seq_grupo_contrato::text, '') = '') or (	(SELECT	count(1)
													from	table(pls_grupos_pck.obter_contrato_grupo(a.nr_seq_grupo_contrato, nr_seq_contrato_p, nr_seq_intercambio_p ))) > 0))
	and 	( (coalesce(a.dt_inicio_vigencia::text, '') = '') or (dt_atendimento_p >= a.dt_inicio_vigencia))
	and 	( (coalesce(a.dt_fim_vigencia::text, '') = '') or (dt_atendimento_p <= a.dt_fim_vigencia ));


BEGIN

	select	max(ie_tipo_despesa)
	into STRICT	ie_tipo_despesa_w
	from	pls_material
	where 	nr_sequencia	= nr_seq_material_p;

	ie_regra_valida_w := 'N';
	for r_c01_w in C01 loop

		if (ie_regra_valida_w = 'N') then
			ie_regra_valida_w := 'S';
			if (r_c01_w.nr_contrato IS NOT NULL AND r_c01_w.nr_contrato::text <> '') then

				ie_regra_valida_w := 'N';
				if (coalesce(nr_contrato_w::text, '') = '') then
					select 	coalesce(max(nr_contrato), -999)
					into STRICT	nr_contrato_w
					from	pls_contrato
					where	nr_sequencia = nr_seq_contrato_p;
				end if;

				if ( r_c01_w.nr_contrato = nr_contrato_w) then
					ie_regra_valida_w := 'S';

				end if;
			end if;

			if (ie_regra_valida_w = 'S') then
				nr_seq_regra_obtida_w := r_c01_w.nr_sequencia;
			end if;
		end if;

	end loop;

	return nr_seq_regra_obtida_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_processar_regra_un_min_mat ( nr_seq_contrato_p pls_segurado.nr_seq_contrato%type, nr_seq_intercambio_p pls_segurado.nr_seq_intercambio%type, nr_seq_ops_congenere_p pls_segurado.nr_seq_ops_congenere%type, nr_seq_grupo_intercambio_p pls_segurado.nr_seq_grupo_intercambio%type, dt_atendimento_p pls_conta_mat.dt_atendimento%type, nr_seq_material_p pls_conta_mat.nr_seq_material%type ) FROM PUBLIC;

