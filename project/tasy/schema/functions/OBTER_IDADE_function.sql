-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_idade ( dt_nascimento_p timestamp, dt_atual_p timestamp, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/* ie_opcao_p
	E	-	Faixa etaria
	S	-	Anos/Meses/Dias
	SNOVO       - 	Criado na O.S. 769049 pelo motivo ao qual a opcao "S" estava trazendo a conta errada de quantidades de dias/Meses/Anos
	AM	-	Anos/Meses
	A	-	Anos
	D	-	Anos descritivo
	M	- 	Meses da idade total
	MM	-	Meses no ano
	DI	-	Dias no mes
	DIA	-	Dias da idade total
	AMD	- 	Anos/Meses/Dias
	EI	-	Faixa Etaria padrao IBGE
	MAD     -       Meses/Anos/Dias
*/
ds_idade_w			varchar(50);
dt_rotina_w			timestamp;
dt_atual_w			timestamp;
dt_nascimento_w			timestamp;
qt_anos_w			integer	:= 0;
qt_meses_w			bigint	:= 0;
qt_meses_ww			bigint	:= 0;
qt_dias_w			bigint	:= 0;
ds_dia_w			varchar(3);
ie_dia_zero_w			varchar(1);


BEGIN
if (coalesce(dt_atual_p::text, '') = '') then
	dt_atual_w		:= clock_timestamp();
else
	dt_atual_w		:= dt_atual_p;
end if;

dt_atual_w	:= trunc(dt_atual_w);--Truncar a data para forcar o determinismo
if (coalesce(dt_nascimento_p::text, '') = '') then
	dt_nascimento_w	:= clock_timestamp();
else
	dt_nascimento_w	:= dt_nascimento_p;
end if;

dt_nascimento_w	:= trunc(dt_nascimento_w);--Truncar a data para forcar o determinismo
ie_dia_zero_w := Obter_Param_Usuario(0, 90, 0, '', 0, ie_dia_zero_w);
if (ie_dia_zero_w = 'S') then
	dt_nascimento_w	:= dt_nascimento_w - 1;
end if;

if (ie_opcao_p <> 'E') then  /*  Faixa Etaria */
	begin
		
	qt_meses_w	:= pkg_date_utils.get_DiffDate(dt_nascimento_w, dt_atual_w, 'MONTH%');
	qt_anos_w	:= trunc(pkg_date_utils.get_DiffDate(dt_nascimento_w, dt_atual_w, 'YEAR'));
	
	qt_dias_w			:= (PKG_DATE_UTILS.extract_field('DAY',dt_atual_w) - PKG_DATE_UTILS.extract_field('DAY',dt_nascimento_w))::numeric;
	if (qt_dias_w < 0) then
		ds_dia_w		:= PKG_DATE_UTILS.extract_field('DAY',dt_nascimento_w);

		if (PKG_DATE_UTILS.extract_field('DAY',pkg_date_utils.end_of(pkg_date_utils.add_month(dt_atual_w,-1,0),'MONTH',0)) < ds_dia_w) then
			ds_dia_w := PKG_DATE_UTILS.extract_field('DAY',pkg_date_utils.end_of(pkg_date_utils.add_month(dt_atual_w,-1,0),'MONTH',0));
		end if;

		ds_dia_w := ds_dia_w || '/';

		qt_dias_w		:= obter_dias_entre_datas(to_date(ds_dia_w||to_char(pkg_date_utils.add_month(dt_atual_w,-1,0),'mm/yyyy'),'dd/mm/yyyy'),dt_atual_w);
	end if;
	end;
end if;
if (ie_opcao_p = 'A') then
	ds_idade_w		:= qt_anos_w;
elsif (ie_opcao_p = 'C') then
	begin
	ds_idade_w		:= '';
	if (qt_anos_w = 1) then
		ds_idade_w 	:= '1 ' || lower(wheb_mensagem_pck.get_texto(308338)); -- ano
	end if;
	if (qt_anos_w > 1) then
		ds_idade_w 	:= qt_anos_w || ' ' || wheb_mensagem_pck.get_texto(308339); -- anos
	end if;
	if (qt_meses_w > 0) then
		begin
		if (qt_anos_w > 0) then
			ds_idade_w 	:= ds_idade_w || ' ' || wheb_mensagem_pck.get_texto(308340) || ' '; -- e
		end if;
		if (qt_meses_w = 1) then	
			ds_idade_w	:= ds_idade_w || '1 ' || lower(wheb_mensagem_pck.get_texto(308341)); -- mes
		end if;
		if (qt_meses_w > 1) then	
			ds_idade_w	:= ds_idade_w || qt_meses_w || ' ' || lower(wheb_mensagem_pck.get_texto(308342)); -- meses
		end if;
		end;
	end if;
	if (qt_meses_w < 1) and (qt_anos_w < 1) then	
		ds_idade_w	:= ds_idade_w || qt_meses_w || ' ' || lower(wheb_mensagem_pck.get_texto(308341)); -- mes
	end if;	
	end;
elsif (ie_opcao_p = 'S') or (ie_opcao_p = 'AM') then
	begin
	ds_idade_w			:= '';
	if (qt_anos_w = 1) then
		ds_idade_w 		:= '1' || wheb_mensagem_pck.get_texto(308343); -- a
	end if;
	if (qt_anos_w > 1) then
		ds_idade_w 		:= qt_anos_w || wheb_mensagem_pck.get_texto(308343); --  a
	end if;
        -- Tratamento para casos como 31/05 a 30/06 -> 0m 29d

	--                            30/05 a 30/06 -> 1m

	--                            31/05 a 30/06 -> 0m 30d 			      

	--                            05/05/1987 a 04/07/2016 -> 29a 1m 29d	
	if (PKG_DATE_UTILS.extract_field('DAY',dt_nascimento_p) = '31') and (PKG_DATE_UTILS.extract_field('DAY',dt_atual_p) = '30') and
	--if	(PKG_DATE_UTILS.extract_field('DAY',dt_nascimento_p) = PKG_DATE_UTILS.extract_field('DAY', PKG_DATE_UTILS.END_OF(dt_nascimento_p, 'MONTH'))) and  

	--		(PKG_DATE_UTILS.extract_field('DAY',dt_atual_p) = PKG_DATE_UTILS.extract_field('DAY', PKG_DATE_UTILS.END_OF(dt_nascimento_p, 'MONTH') -1 )) and 
		(qt_meses_w = 1)  then
		qt_meses_w := qt_meses_w - 1;
	end if;

	if (qt_meses_w > 0) then
		begin
		if (qt_anos_w > 0) then
			ds_idade_w 	:= ds_idade_w || ' ';
		end if;
		if (qt_meses_w = 1) then	
			ds_idade_w	:= ds_idade_w || '1' || wheb_mensagem_pck.get_texto(308345); -- m
		end if;
		
	
		if (qt_meses_w > 1) then	
			ds_idade_w	:= ds_idade_w || qt_meses_w || wheb_mensagem_pck.get_texto(308345); -- m
		end if;
		end;
	end if;	
	if (qt_meses_w < 1) and (qt_anos_w < 1) then
		ds_idade_w	:= ds_idade_w || qt_meses_w || wheb_mensagem_pck.get_texto(308345); -- m
	end if;
	
	if (qt_dias_w > 0) and (ie_opcao_p = 'S') then
		ds_idade_w	:= ds_idade_w ||' '||qt_dias_w|| wheb_mensagem_pck.get_texto(308346); -- d
	end if;
	
	if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') in ('de_DE', 'de_AT')) then
		ds_idade_w	:= upper(ds_idade_w);
	end if;

  if (lower(ds_idade_w) = '0m') then 
    ds_idade_w := obter_desc_expressao(344145, wheb_usuario_pck.get_nr_seq_idioma);
  end if;
	
	end;
elsif (ie_opcao_p	= 'D') then
	begin
	ds_idade_w			:= '';
	
	if (qt_anos_w = 1) then
		ds_idade_w 		:= '1 ' || lower(wheb_mensagem_pck.get_texto(308338)); -- ano
	elsif (qt_anos_w > 1) then
		ds_idade_w 		:= qt_anos_w || ' ' || wheb_mensagem_pck.get_texto(308339); -- anos
	elsif (qt_meses_w > 0) then
		begin
		if (qt_meses_w = 1) then	
			ds_idade_w	:= '1 ' || lower(wheb_mensagem_pck.get_texto(308341)); -- mes
		elsif (qt_meses_w > 1) then	
			ds_idade_w	:= qt_meses_w || ' ' || lower(wheb_mensagem_pck.get_texto(308342)); -- meses
		end if;
		end;
	elsif (qt_dias_w > 0) then
		begin
		if (qt_dias_w = 1) then	
			ds_idade_w	:= '1 ' || lower(wheb_mensagem_pck.get_texto(307265)); -- dia
		elsif (qt_dias_w > 1) then	
			ds_idade_w	:= qt_dias_w || ' ' || wheb_mensagem_pck.get_texto(308347); -- dias
		end if;
		end;
	end if;
	if (qt_meses_w < 1) and (qt_anos_w < 1) and (qt_dias_w < 1) then	
		ds_idade_w	:= ds_idade_w || qt_dias_w || ' ' || wheb_mensagem_pck.get_texto(308347); -- dias
	end if;
	end;
elsif (ie_opcao_p	= 'T') then
	begin
	ds_idade_w			:= '';
	
	if (qt_anos_w = 1) then
		ds_idade_w 		:= '1 ' || wheb_mensagem_pck.get_texto(308343); -- a
	elsif (qt_anos_w > 1) then
		ds_idade_w 		:= qt_anos_w || ' ' || wheb_mensagem_pck.get_texto(308343); -- a
	elsif (qt_meses_w > 0) then
		begin
		if (qt_meses_w = 1) then	
			ds_idade_w	:= '1 ' || lower(wheb_mensagem_pck.get_texto(308341)); -- mes
		elsif (qt_meses_w > 1) then	
			ds_idade_w	:= qt_meses_w || ' ' || wheb_mensagem_pck.get_texto(308345); -- m
		end if;
		end;
	end if;
	if (qt_meses_w < 1) and (qt_anos_w < 1) then	
		ds_idade_w	:= ds_idade_w || qt_meses_w || ' ' || wheb_mensagem_pck.get_texto(308345); -- m
	end if;
	end;
elsif (ie_opcao_p	= 'MAD') then
	begin
		ds_idade_w			:= '';
		-- Tratamento para casos como 31/05 a 30/06 -> 0M 29D

		--                            30/05 a 30/06 -> 1M

		--                            31/05 a 30/06 -> 0M 30D  

		--                            05/05/1987 a 04/07/2016 -> 29a 1m 29d	

		--if	(PKG_DATE_UTILS.extract_field('DAY',dt_nascimento_p) = '31') and 

		--	(PKG_DATE_UTILS.extract_field('DAY',dt_atual_p) = '30') and 		
		if (PKG_DATE_UTILS.extract_field('DAY',dt_nascimento_p) = PKG_DATE_UTILS.extract_field('DAY', PKG_DATE_UTILS.END_OF(dt_nascimento_p, 'MONTH'))) and (PKG_DATE_UTILS.extract_field('DAY',dt_atual_p) = PKG_DATE_UTILS.extract_field('DAY', PKG_DATE_UTILS.END_OF(dt_nascimento_p, 'MONTH') -1 )) and (qt_meses_w >= 1)  then
			qt_meses_w := qt_meses_w - 1;
		end if;
		
		if (qt_meses_w > 0) then
			begin

			if (qt_meses_w = 1) then	
				ds_idade_w	:= ds_idade_w || '1' || upper(wheb_mensagem_pck.get_texto(308345)); -- M
			end if;
			if (qt_meses_w > 1) then	
				ds_idade_w	:= ds_idade_w || qt_meses_w || upper(wheb_mensagem_pck.get_texto(308345)); -- M
			end if;
			end;
		end if;	
		if (qt_meses_w < 1) and (qt_anos_w < 1) then
			ds_idade_w	:= ds_idade_w || qt_meses_w || upper(wheb_mensagem_pck.get_texto(308345)); -- M
		end if;

		if (qt_anos_w = 1) then
			ds_idade_w 		:= '1' || upper(wheb_mensagem_pck.get_texto(308343)); -- A
		end if;
		if (qt_anos_w > 1) then
			ds_idade_w 		:= ds_idade_w||' '||qt_anos_w || upper(wheb_mensagem_pck.get_texto(308343)); -- A
		end if;
		
		if (qt_dias_w > 0) then
			ds_idade_w	:= ds_idade_w ||' '||qt_dias_w|| upper(wheb_mensagem_pck.get_texto(308346)); -- D
		end if;
	end;	
elsif (ie_opcao_p = 'E') then  /*  Faixa Etaria */
	ds_idade_w 	:= to_char( Trunc(PKG_DATE_UTILS.get_DiffDate(dt_nascimento_w, dt_atual_w, 'YEAR')/5)* 5,'000')||
			   to_char((Trunc(PKG_DATE_UTILS.get_DiffDate(dt_nascimento_w, dt_atual_w, 'YEAR')/5)* 5)+5,'000');
elsif (ie_opcao_p = 'M') then
	qt_meses_ww	:= pkg_date_utils.get_DiffDate(dt_nascimento_w, dt_atual_w, 'MONTH');
	ds_idade_w	:= qt_meses_ww;
elsif (ie_opcao_p = 'MM') then
	ds_idade_w	:= qt_meses_w;
elsif (ie_opcao_p = 'DI') then
	ds_idade_w	:= qt_dias_w;
elsif (ie_opcao_p = 'AMD') then
	ds_idade_w	:= lpad(qt_anos_w,3,0)|| upper(wheb_mensagem_pck.get_texto(308343)) ||lpad(qt_meses_w,2,0)|| upper(wheb_mensagem_pck.get_texto(308345)) ||lpad(qt_dias_w,2,0)|| upper(wheb_mensagem_pck.get_texto(308346)); -- A	M	D
elsif (ie_opcao_p = 'AMD2') then
	ds_idade_w	:= lpad(qt_anos_w,3,0)||lpad(qt_meses_w,2,0)||lpad(qt_dias_w,2,0);
elsif (ie_opcao_p = 'DIA') then
	ds_idade_w	:= to_char(dt_atual_w - dt_nascimento_w);
elsif (ie_opcao_p = 'SEM') then
	ds_idade_w	:= to_char(trunc((dt_atual_w - dt_nascimento_w)/ 7));
elsif (ie_opcao_p = 'DIAS') then
	ds_idade_w	:= to_char(trunc(dt_atual_w - dt_nascimento_w));
elsif (ie_opcao_p = 'SNOVO') then
	ds_idade_w	:= obter_data_upaciente(dt_nascimento_w ,'#aA mM dD',dt_atual_w);
elsif (ie_opcao_p = 'EI') then
	if (qt_anos_w between 0 and 14) then
		ds_idade_w := '1';
	elsif (qt_anos_w between 15 and 19) then
		ds_idade_w := '2';
	elsif (qt_anos_w between 20 and 24) then
		ds_idade_w := '3';
	elsif (qt_anos_w between 25 and 64) then
		ds_idade_w := '4';
	elsif (qt_anos_w > 64) then
		ds_idade_w := '5';
	end if;
end if;

return ds_idade_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_idade ( dt_nascimento_p timestamp, dt_atual_p timestamp, ie_opcao_p text) FROM PUBLIC;

