-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_glosa_item_procmat ( nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, ie_opcao_p bigint, nr_seq_partic_p bigint default null) RETURNS bigint AS $body$
DECLARE

vl_glosa_w	double precision	:= 0;
vl_glosado_w	double precision	:= 0;
ie_acao_w	smallint;

C01 CURSOR FOR
	SELECT	d.ie_acao,
		coalesce(b.vl_glosa,0)
	from	convenio_retorno_item a,
		convenio_retorno_glosa b,
		conta_paciente_ret_hist c,
		hist_audit_conta_paciente d
	where	a.nr_sequencia			= b.nr_seq_ret_item
	  and	b.nr_seq_conpaci_ret_hist	= c.nr_sequencia
	  and	c.nr_seq_hist_audit		= d.nr_sequencia
	  and	b.nr_seq_propaci		= nr_seq_propaci_p
	
union

	SELECT	d.ie_acao,
		coalesce(b.vl_glosa,0)
	from	convenio_retorno_item a,
		convenio_retorno_glosa b,
		conta_paciente_ret_hist c,
		hist_audit_conta_paciente d
	where	a.nr_sequencia			= b.nr_seq_ret_item
	  and	b.nr_seq_conpaci_ret_hist	= c.nr_sequencia
	  and	c.nr_seq_hist_audit		= d.nr_sequencia
	  and	b.nr_seq_matpaci		= nr_seq_matpaci_p;


BEGIN

if (ie_opcao_p = 1) then
	if (nr_seq_propaci_p IS NOT NULL AND nr_seq_propaci_p::text <> '') then
		SELECT	coalesce(SUM(a.vl_glosa),0)
		INTO STRICT	vl_glosado_w
		FROM	motivo_glosa c,
			convenio_retorno_glosa a,
			convenio_retorno_item b
		WHERE	b.nr_sequencia		= a.nr_seq_ret_item
		AND	a.nr_seq_propaci	= nr_seq_propaci_p
		AND	coalesce(a.ie_acao_glosa,c.ie_acao_glosa) = 'A'
		AND	a.cd_motivo_glosa	= c.cd_motivo_glosa;
	else
		SELECT	coalesce(SUM(a.vl_glosa),0)
		INTO STRICT	vl_glosado_w
		FROM	motivo_glosa c,
			convenio_retorno_glosa a,
			convenio_retorno_item b
		WHERE	b.nr_sequencia		= a.nr_seq_ret_item
		AND	a.nr_seq_matpaci	= nr_seq_matpaci_p
		AND	coalesce(a.ie_acao_glosa,c.ie_acao_glosa) = 'A'
		AND	a.cd_motivo_glosa	= c.cd_motivo_glosa;
	end if;
end if;

if (ie_opcao_p = 2) then

	open c01;
	loop
	fetch C01 into	ie_acao_w,
			vl_glosa_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

	if (ie_acao_w IS NOT NULL AND ie_acao_w::text <> '') and (ie_acao_w in (1,3)) then

		vl_glosado_w	:= vl_glosado_w + vl_glosa_w;

	end if;
	end loop;
	close c01;
end if;


if (ie_opcao_p = 3) then
	if (nr_seq_propaci_p IS NOT NULL AND nr_seq_propaci_p::text <> '') THEN
		SELECT	coalesce(SUM(a.vl_glosa),0)
		INTO STRICT	vl_glosado_w
		FROM	convenio_retorno_glosa a,
			convenio_retorno_item b
		WHERE	b.nr_sequencia		= a.nr_seq_ret_item
		--and	nvl(a.nr_seq_partic,0)	= nvl(nr_seq_partic_p,0)
		AND	a.nr_seq_propaci	= nr_seq_propaci_p;
	else
		SELECT	coalesce(SUM(a.vl_glosa),0)
		INTO STRICT	vl_glosado_w
		FROM	convenio_retorno_glosa a,
			convenio_retorno_item b
		WHERE	b.nr_sequencia		= a.nr_seq_ret_item
		AND	a.nr_seq_matpaci	= nr_seq_matpaci_p;
	end if;
end if;

if (ie_opcao_p = 4) then
	if (nr_seq_propaci_p IS NOT NULL AND nr_seq_propaci_p::text <> '') then
		SELECT	coalesce(SUM(a.vl_glosa),0)
		INTO STRICT	vl_glosado_w
		FROM convenio_retorno_glosa a
LEFT OUTER JOIN motivo_glosa c ON (a.cd_motivo_glosa = c.cd_motivo_glosa)
WHERE coalesce(coalesce(a.ie_acao_glosa,c.ie_acao_glosa), 'A')	= 'A'  and coalesce(a.nr_seq_partic,0)		= coalesce(nr_seq_partic_p,0) AND a.nr_seq_propaci		= nr_seq_propaci_p;
	else
		SELECT	coalesce(SUM(a.vl_glosa),0)
		INTO STRICT	vl_glosado_w
		FROM convenio_retorno_glosa a
LEFT OUTER JOIN motivo_glosa c ON (a.cd_motivo_glosa = c.cd_motivo_glosa)
WHERE coalesce(coalesce(a.ie_acao_glosa,c.ie_acao_glosa), 'A')	= 'A'  and a.nr_seq_matpaci		= nr_seq_matpaci_p;
	end if;
end if;

if (ie_opcao_p = 5) then
	if (nr_seq_propaci_p IS NOT NULL AND nr_seq_propaci_p::text <> '') THEN
		SELECT	coalesce(SUM(a.vl_glosa),0)
		INTO STRICT	vl_glosado_w
		FROM	convenio_retorno_glosa a,
			convenio_retorno_item b
		WHERE	b.nr_sequencia		= a.nr_seq_ret_item
		and	coalesce(a.nr_seq_partic,0)	= coalesce(nr_seq_partic_p,0)
		AND	a.nr_seq_propaci	= nr_seq_propaci_p;
	else
		SELECT	coalesce(SUM(a.vl_glosa),0)
		INTO STRICT	vl_glosado_w
		FROM	convenio_retorno_glosa a,
			convenio_retorno_item b
		WHERE	b.nr_sequencia		= a.nr_seq_ret_item
		AND	a.nr_seq_matpaci	= nr_seq_matpaci_p;
	end if;
end if;

return	coalesce(vl_glosado_w,0);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_glosa_item_procmat ( nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, ie_opcao_p bigint, nr_seq_partic_p bigint default null) FROM PUBLIC;

