-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_data_utc (dt_referencia_p timestamp default clock_timestamp(), ie_formato_p text default null) RETURNS varchar AS $body$
DECLARE


ie_utc_w	varchar(15);
ie_horario_verao_w	varchar(10) := null;

ie_formato_w varchar(5);


BEGIN

begin
	select	ie_utc
	into STRICT	ie_utc_w
	from	estab_horario_verao
	where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
	and	dt_referencia_p between dt_inicial and dt_final;

exception
when others then
	ie_utc_w	:= null;
end;


if (pkg_i18n.get_user_locale() = 'pt_BR') then
	ie_formato_W := 'P';
END IF;

if (coalesce(ie_utc_w::text, '') = '') then
	begin
		select	ie_utc
		into STRICT	ie_utc_w
		from	estabelecimento
		where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;	
	exception
	when others then
		ie_utc_w	:= TO_CHAR(CURRENT_TIMESTAMP,'TZR');
	end;
else
	ie_horario_verao_w := ' BRST';
end	if;

if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then	
	if (ie_formato_W = 'P') then -- Formatacao Padrao
		return to_char(dt_referencia_p, 'dd/mm/yyyy hh24:mi:ss') || ie_utc_w;
	elsif (ie_formato_W = 'HV') then -- Horario Verao
		return to_char(dt_referencia_p, 'dd/mm/yyyy') || 'T' || to_char(dt_referencia_p, 'hh24:mi:ss') || ie_utc_w || ie_horario_verao_w;
	elsif (ie_formato_W = 'S') then  --Reduzido
		return to_char(dt_referencia_p, 'yyyy-mm-dd');
	elsif (ie_formato_W = 'NOM') then  -- Formato NOM - Mexico
		return to_char(dt_referencia_p, 'yyyymmddhh24miss') || replace(ie_utc_w, ':', '');
	else
		return to_char(dt_referencia_p, 'yyyy-mm-dd') || 'T' || to_char(dt_referencia_p, 'hh24:mi:ss') || ie_utc_w;
	end	if;
else
	return '';
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_data_utc (dt_referencia_p timestamp default clock_timestamp(), ie_formato_p text default null) FROM PUBLIC;

