-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_cod_empresa_cart ( cd_usuario_plano_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(255);
cd_cooperativa_w	varchar(10);
cd_empresa_w		varchar(10);
cd_cgc_w		varchar(14);	
qt_incial_cooperativa_w	bigint;
nr_seq_congenere_w	bigint;
qt_posicao_inicial_w	bigint;
qt_posicao_final_w	bigint;
qt_final_empresa_w	bigint;

C01 CURSOR FOR
	SELECT	qt_posicao_inicial,
		qt_posicao_final
	from	pls_regra_congenere_emp
	where	trunc(clock_timestamp()) between trunc(dt_inicio_vigencia) and trunc(coalesce(dt_fim_vigencia, clock_timestamp() + interval '1 days'))
	and	((nr_seq_congenere = nr_seq_congenere_w) or (coalesce(nr_seq_congenere::text, '') = ''))
	order by coalesce(nr_seq_congenere,0),
		CASE WHEN coalesce(qt_posicao_inicial::text, '') = '' THEN +1  ELSE -1 END;


BEGIN
ds_retorno_w	:= null;

select	CASE WHEN length(cd_usuario_plano_p)=16 THEN 1  ELSE 2 END
into STRICT	qt_incial_cooperativa_w
;

cd_cooperativa_w	:= substr(cd_usuario_plano_p,qt_incial_cooperativa_w,3);

begin
select	max(nr_sequencia)
into STRICT	nr_seq_congenere_w
from	pls_congenere
where	(cd_cooperativa)::numeric 	= (cd_cooperativa_w)::numeric
and	ie_tipo_congenere	= 'CO';
exception
when data_exception then
	nr_seq_congenere_w := null;
end;

if (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '') then
	open C01;
	loop
	fetch C01 into	
		qt_posicao_inicial_w,
		qt_posicao_final_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;
	
	if (qt_posicao_inicial_w IS NOT NULL AND qt_posicao_inicial_w::text <> '') and (qt_posicao_final_w IS NOT NULL AND qt_posicao_final_w::text <> '') then
		qt_final_empresa_w	:= (qt_posicao_final_w - qt_posicao_inicial_w) + 1;
		/*Busca o codigo da empresa da carteira do beneficiario*/

		cd_empresa_w		:= substr(cd_usuario_plano_p,qt_posicao_inicial_w,qt_final_empresa_w);
		
		ds_retorno_w	:= cd_empresa_w;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_cod_empresa_cart ( cd_usuario_plano_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

