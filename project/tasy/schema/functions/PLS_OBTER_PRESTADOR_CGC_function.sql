-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_prestador_cgc ( cd_cgc_prestador_p text, nr_seq_guia_p pls_conta.nr_seq_guia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type default null) RETURNS bigint AS $body$
DECLARE

				
qt_prestador_w		integer;
nr_seq_prestador_w	pls_conta.nr_seq_prestador%type;
nr_seq_prestador_guia_w	pls_guia_plano.nr_seq_prestador%type;
cd_cgc_prestador_guia_w	pls_prestador.cd_cgc%type;

BEGIN

if (cd_cgc_prestador_p IS NOT NULL AND cd_cgc_prestador_p::text <> '') then
	select 	sum(t.contador)
	into STRICT	qt_prestador_w
        from (       SELECT  count(1) contador
                        from	pls_prestador
                        where	cd_cgc	= cd_cgc_prestador_p
                        and (ie_prestador_matriz	= 'S' or coalesce(ie_prestador_matriz::text, '') = '')
                        and     coalesce(cd_estabelecimento_p::text, '') = ''

union all

                        SELECT  count(1) contador
                        from	pls_prestador
                        where	cd_cgc	= cd_cgc_prestador_p
                        and (ie_prestador_matriz	= 'S' or coalesce(ie_prestador_matriz::text, '') = '')
                        and     (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '')
                        and     cd_estabelecimento      = cd_estabelecimento_p) t;
	
	if (qt_prestador_w	= 1) then
                select  max(t.nr_sequencia)
                into STRICT	nr_seq_prestador_w
                from (       SELECT 	nr_sequencia
                                from	pls_prestador
                                where	cd_cgc	= cd_cgc_prestador_p
                                and (ie_prestador_matriz	= 'S' or coalesce(ie_prestador_matriz::text, '') = '')
                                and     coalesce(cd_estabelecimento_p::text, '') = ''

union all

                                SELECT 	nr_sequencia
                                from	pls_prestador
                                where	cd_cgc	= cd_cgc_prestador_p
                                and (ie_prestador_matriz	= 'S' or coalesce(ie_prestador_matriz::text, '') = '')
                                and     (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '')
                                and     cd_estabelecimento      = cd_estabelecimento_p) t;
	elsif (qt_prestador_w	> 1) then
		select 	sum(t.contador)
		into STRICT	qt_prestador_w	
                from (       SELECT  count(1) contador
                                from	pls_prestador
                                where	cd_cgc		= cd_cgc_prestador_p
                                and	ie_situacao 	= 'A'
                                and (ie_prestador_matriz	= 'S' or coalesce(ie_prestador_matriz::text, '') = '')
                                and     coalesce(cd_estabelecimento_p::text, '') = ''

union all

                                SELECT  count(1) contador
                                from	pls_prestador
                                where	cd_cgc		= cd_cgc_prestador_p
                                and	ie_situacao 	= 'A'
                                and (ie_prestador_matriz	= 'S' or coalesce(ie_prestador_matriz::text, '') = '')
                                and     (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '')
                                and     cd_estabelecimento      = cd_estabelecimento_p) t;
		
		if (qt_prestador_w	= 1) then
			select 	max(t.nr_sequencia)
			into STRICT	nr_seq_prestador_w
                        from (       SELECT  nr_sequencia
                                        from	pls_prestador
                                        where	cd_cgc		= cd_cgc_prestador_p
                                        and	ie_situacao 	= 'A'
                                        and (ie_prestador_matriz	= 'S' or coalesce(ie_prestador_matriz::text, '') = '')
                                        and     coalesce(cd_estabelecimento_p::text, '') = ''

union all

                                        SELECT  nr_sequencia
                                        from	pls_prestador
                                        where	cd_cgc		= cd_cgc_prestador_p
                                        and	ie_situacao 	= 'A'
                                        and (ie_prestador_matriz	= 'S' or coalesce(ie_prestador_matriz::text, '') = '')
                                        and     (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '')
                                        and     cd_estabelecimento      = cd_estabelecimento_p) t;


		elsif (qt_prestador_w	> 1) then
			select	max(nr_seq_prestador)
			into STRICT	nr_seq_prestador_guia_w
			from	pls_guia_plano
			where	nr_sequencia	= nr_seq_guia_p;

			if (nr_seq_prestador_guia_w IS NOT NULL AND nr_seq_prestador_guia_w::text <> '') then
				select	max(cd_cgc)
				into STRICT	cd_cgc_prestador_guia_w
				from	pls_prestador
				where	nr_sequencia	= nr_seq_prestador_guia_w;
				
				if (cd_cgc_prestador_guia_w = cd_cgc_prestador_p) then
					nr_seq_prestador_w	:= nr_seq_prestador_guia_w;
				end if;
			end if;
			
			if (coalesce(nr_seq_prestador_w::text, '') = '') then
				select	min(t.nr_sequencia)
				into STRICT	nr_seq_prestador_w
                                from (       SELECT  nr_sequencia
                                                from	pls_prestador
                                                where	cd_cgc		= cd_cgc_prestador_p
                                                and	ie_situacao	= 'A'
                                                and (ie_prestador_matriz	= 'S' or coalesce(ie_prestador_matriz::text, '') = '')
                                                and     coalesce(cd_estabelecimento_p::text, '') = ''

union all

                                                SELECT  nr_sequencia
                                                from	pls_prestador
                                                where	cd_cgc		= cd_cgc_prestador_p
                                                and	ie_situacao	= 'A'
                                                and (ie_prestador_matriz	= 'S' or coalesce(ie_prestador_matriz::text, '') = '')
                                                and     (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '')
                                                and     cd_estabelecimento      = cd_estabelecimento_p) t;
			end if;
			
		end if;

		if (coalesce(nr_seq_prestador_w::text, '') = '') then
			select	min(t.nr_sequencia)
			into STRICT	nr_seq_prestador_w
                        from (       SELECT  nr_sequencia
                                        from	pls_prestador
                                        where	cd_cgc		= cd_cgc_prestador_p
                                        and	ie_situacao	= 'A'
                                        and     coalesce(cd_estabelecimento_p::text, '') = ''

union all

                                        SELECT  nr_sequencia
                                        from	pls_prestador
                                        where	cd_cgc		= cd_cgc_prestador_p
                                        and	ie_situacao	= 'A'
                                        and     (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '')
                                        and     cd_estabelecimento      = cd_estabelecimento_p) t;
		end if;
	end if;
	
	if (coalesce(nr_seq_prestador_w::text, '') = '') then
		select	min(t.nr_sequencia)
		into STRICT	nr_seq_prestador_w
                from (       SELECT  nr_sequencia
                                from	pls_prestador
                                where	cd_cgc		= cd_cgc_prestador_p
                                and	ie_situacao 	= 'A'
                                and     coalesce(cd_estabelecimento_p::text, '') = ''

union all

                                SELECT  nr_sequencia
                                from	pls_prestador
                                where	cd_cgc		= cd_cgc_prestador_p
                                and	ie_situacao 	= 'A'
                                and     (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '')
                                and     cd_estabelecimento      = cd_estabelecimento_p) t;
		
		if (coalesce(nr_seq_prestador_w::text, '') = '') then
			select	min(t.nr_sequencia)
			into STRICT	nr_seq_prestador_w
                        from (       SELECT nr_sequencia
                                        from	pls_prestador
                                        where	cd_cgc		= cd_cgc_prestador_p
                                        and     coalesce(cd_estabelecimento_p::text, '') = ''

union all

                                        SELECT nr_sequencia
                                        from	pls_prestador
                                        where	cd_cgc		= cd_cgc_prestador_p
                                        and     (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '')
                                        and     cd_estabelecimento      = cd_estabelecimento_p) t;
		end if;
	end if;
end if;

return	nr_seq_prestador_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_prestador_cgc ( cd_cgc_prestador_p text, nr_seq_guia_p pls_conta.nr_seq_guia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type default null) FROM PUBLIC;

