-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION qt_enable_cancel_cycle_sche ( nr_sequencia_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ie_retorno_w 			varchar(1) := 'N';
dt_agenda_w				timestamp;
ie_agendado_w			varchar(1);
nr_prescricao_w			bigint;
dt_falta_consistencia_w	timestamp;
qt_tempo_cancel_w		bigint;
dt_parametro_w			timestamp := clock_timestamp();
ie_permite_cancel_dia_w	varchar(1);
ie_permite_cancel_prescr_w varchar(1);
ie_permite_cancel_tratamento_w	varchar(1);


BEGIN

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	select	dt_real,
			Qt_Obter_Se_Dia_Agendado(nr_seq_atendimento, coalesce(dt_real, dt_prevista)),
			nr_prescricao,
			qt_obter_data_status('A',nr_seq_atendimento)
	into STRICT	dt_agenda_w,
			ie_agendado_w,
			nr_prescricao_w,
			dt_falta_consistencia_w
	from	paciente_atendimento
	where	nr_seq_atendimento = nr_sequencia_p;

	qt_tempo_cancel_w := OBTER_PARAM_FUNCAO_HTML5(865, 99);
	ie_permite_cancel_dia_w := OBTER_PARAM_FUNCAO_HTML5(865, 121);
	ie_permite_cancel_prescr_w := OBTER_PARAM_FUNCAO_HTML5(865, 191);
	ie_permite_cancel_tratamento_w := OBTER_PARAM_FUNCAO_HTML5(865, 190);

	if (qt_tempo_cancel_w > 0) then

		dt_parametro_w := dt_agenda_w - qt_tempo_cancel_w/24;

	end if;

	if (ie_agendado_w = 'S') and (dt_agenda_w >= dt_parametro_w) and (ie_permite_cancel_dia_w = 'S' or ( ie_permite_cancel_dia_w = 'N' and coalesce(dt_falta_consistencia_w::text, '') = '')) and (ie_permite_cancel_prescr_w = 'S' or coalesce(nr_prescricao_w::text, '') = '') and (ie_permite_cancel_tratamento_w = 'S') then

			ie_retorno_w := 'S';

	end if;

end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION qt_enable_cancel_cycle_sche ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

