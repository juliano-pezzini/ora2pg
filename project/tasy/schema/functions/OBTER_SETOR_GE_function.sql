-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_setor_ge ( ie_opcao_p text, nr_prescricao_p bigint, nr_atendimento_p bigint, ie_retorno_p text) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(100);
nr_seq_unidade_w	bigint;
cd_setor_w			bigint;

/* ie_opcao_p 
 
N - Não traz nenhum setor 
S - Setor atual do paciente 
P - Setor da prescricao 
E - Setor de entrega prescricao 
 
*/
 
 
 
/* ie_retorno_p 
 
D - Descrição 
 
C - Código 
 
*/
 
 

BEGIN 
 
if (ie_opcao_p = 'N') then 
	ds_retorno_w	:= '';
elsif (ie_opcao_p = 'S') then 
 
	select 	Obter_AtePacu_Paciente(nr_atendimento_p,'IAA') 
	into STRICT	nr_seq_unidade_w 
	;
	 
	 
	select	max(ds_setor_atendimento || ' (' || a.cd_unidade_basica || '-' || cd_unidade_compl || ')'), 
			max(b.cd_setor_atendimento) 
	into STRICT	ds_retorno_w, 
			cd_setor_w 
	from 	atend_paciente_unidade a, 
		setor_atendimento b	 
	where	a.cd_setor_atendimento = b.cd_setor_atendimento 
	and	a.nr_seq_interno = nr_seq_unidade_w;
 
 
	--select	substr(obter_setor_atepacu(nr_seq_unidade_w,1),1,100) 
	--into	ds_retorno_w 
	--from	dual; 
	 
	 
	 
elsif (ie_opcao_p = 'P') then 
	select	substr(obter_setor_prescricao(nr_prescricao_p,'D'),1,100), 
			substr(obter_setor_prescricao(nr_prescricao_p,'C'),1,100) 
	into STRICT	ds_retorno_w, 
			cd_setor_w 
	;
elsif (ie_opcao_p = 'E') then 
	select	substr(obter_setor_entrega_prescr(nr_prescricao_p,'D'),1,100), 
			substr(obter_setor_entrega_prescr(nr_prescricao_p,'C'),1,100) 
	into STRICT	ds_retorno_w, 
			cd_setor_w 
	;
elsif (ie_opcao_p = 'CC') then 
	 
	select 	max(Obter_AtePacu_Paciente(nr_atendimento_p,'IAC')) 
	into STRICT	nr_seq_unidade_w 
	;	
	 
	select	max(ds_setor_atendimento || ' (' || a.cd_unidade_basica || '-' || cd_unidade_compl || ')'), 
			max(b.cd_setor_atendimento) 
	into STRICT	ds_retorno_w, 
			cd_setor_w 
	from 	atend_paciente_unidade a, 
		setor_atendimento b	 
	where	a.cd_setor_atendimento = b.cd_setor_atendimento 
	and	a.nr_seq_interno = nr_seq_unidade_w;
end if;
 
 
if (ie_retorno_p = 'C') then 
	ds_retorno_w := cd_setor_w;
end if;
 
return	ds_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_setor_ge ( ie_opcao_p text, nr_prescricao_p bigint, nr_atendimento_p bigint, ie_retorno_p text) FROM PUBLIC;

