-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION aacd_obter_saldo_conpaci (nr_interno_conta_p bigint, cd_autorizacao_p text) RETURNS bigint AS $body$
DECLARE

 
vl_saldo_w		double precision;
vl_conta_w		double precision;
vl_retorno_w		double precision;
vl_grg_w		double precision;
vl_saldo_titulo_w	double precision;
vl_saldo_guia_w		double precision;
vl_glosa_w		double precision;
vl_pago_w		double precision;
nr_titulo_w		bigint;
nr_seq_guia_w		bigint;
vl_saldo_original_w	double precision;

c01 CURSOR FOR 
SELECT	coalesce(sum(a.vl_glosa),0) vl_glosa, 
	coalesce(sum(a.vl_pago),0) vl_pago, 
	coalesce(b.vl_saldo_guia,0) vl_saldo_guia, 
	coalesce(b.vl_saldo_original,coalesce(b.vl_saldo_guia,0)), 
	b.nr_sequencia 
from	lote_audit_hist c, 
	lote_audit_hist_item a, 
	lote_audit_hist_guia b 
where	b.nr_sequencia			= a.nr_seq_guia 
and	coalesce(b.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_p,b.cd_autorizacao),'0') 
and	b.nr_interno_conta		= nr_interno_conta_p 
and	b.nr_seq_lote_hist		= c.nr_sequencia 
and ((b.dt_baixa_glosa IS NOT NULL AND b.dt_baixa_glosa::text <> '') or c.nr_sequencia <> (obter_ultima_analise(c.nr_seq_lote_audit))::numeric ) 
group by	b.nr_sequencia, 
	b.vl_saldo_guia, 
	b.vl_saldo_original;


BEGIN 
if (coalesce(cd_autorizacao_p::text, '') = '') then 
 
	select	coalesce(max(a.vl_conta),0), 
		max((obter_titulo_conta_guia(a.nr_interno_conta,null,null,null))::numeric ) 
	into STRICT	vl_conta_w, 
		nr_titulo_w 
	from	conta_paciente a 
	where	a.nr_interno_conta	= nr_interno_conta_p;
 
else 
 
	select	coalesce(max(a.vl_guia),0), 
		max((obter_titulo_conta_guia(a.nr_interno_conta,cd_autorizacao_p,null,null))::numeric ) 
	into STRICT	vl_conta_w, 
		nr_titulo_w 
	from	conta_paciente_guia a 
	where	a.nr_interno_conta	= nr_interno_conta_p 
	and	a.cd_autorizacao	= cd_autorizacao_p;
 
end if;
 
select	max(a.vl_saldo_titulo) 
into STRICT	vl_saldo_titulo_w 
from	titulo_receber a 
where	a.nr_titulo	= nr_titulo_w;
 
select	coalesce(sum(a.vl_pago),0) + coalesce(sum(a.vl_desconto),0) + coalesce(sum(a.vl_perdas),0) + coalesce(sum(a.vl_nota_credito),0) + coalesce(sum(a.vl_glosado),0) 
into STRICT	vl_retorno_w 
from	convenio_retorno b, 
	convenio_retorno_item a 
where	a.nr_interno_conta		= nr_interno_conta_p 
and	coalesce(a.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_p,a.cd_autorizacao),'0') 
and	a.nr_seq_retorno		= b.nr_sequencia 
and	b.ie_status_retorno		= 'F';
 
open	c01;
loop 
fetch	c01 into 
	vl_glosa_w, 
	vl_pago_w, 
	vl_saldo_guia_w, 
	vl_saldo_original_w, 
	nr_seq_guia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	/* quando for glosa posterior, o sistema gera uma nota de crédito, 
	  portanto o valor da glosa posterior não deve ser deduzido do saldo da guia */
 
		 
	if (vl_glosa_w	> vl_saldo_guia_w) then 
		vl_grg_w	:= coalesce(vl_grg_w,0) + vl_saldo_guia_w + vl_pago_w;
	else 
		vl_grg_w	:= coalesce(vl_grg_w,0) + vl_glosa_w + vl_pago_w;
	end if;
 
end	loop;
close	c01;
 
vl_saldo_w	:= coalesce(vl_conta_w,0) - coalesce(vl_retorno_w,0) - coalesce(vl_grg_w,0);
 
RETURN vl_saldo_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION aacd_obter_saldo_conpaci (nr_interno_conta_p bigint, cd_autorizacao_p text) FROM PUBLIC;

