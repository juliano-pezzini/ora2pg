-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_afecciones_sinan ( nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


ds_afecciones_sinan_w	varchar(2000) := NULL;
nr_atendimento_w 		bigint;
ds_cid_doenca_w 		varchar(250);
cd_doenca_w				varchar(10);

c01 CURSOR FOR
SELECT dd.nr_atendimento, trim(both SUBSTR(obter_desc_cid(dd.CD_DOENCA),1, 250)) DS_CID_DOENCA, cc1.cd_doenca
FROM diagnostico_doenca dd,
	 cid_doenca cc1
WHERE dd.nr_atendimento = nr_atendimento_p
AND	dd.cd_doenca = cc1.cd_doenca_cid
AND ((CC1.CD_CATEGORIA_CID LIKE('%T%') OR CC1.CD_CATEGORIA_CID LIKE('%S%') OR CC1.CD_CATEGORIA_CID LIKE('%F%')) OR (CC1.CD_DOENCA_CID IN ('O04','O05','O06','','O07','O20','O267','O267','O429','O468','O469','O68','O710','O713','O714','O715','O716','O717','O718','O719','O95','O9')))
AND (dd.dt_liberacao IS NOT NULL AND dd.dt_liberacao::text <> '');


BEGIN
	OPEN c01;
	LOOP
	FETCH c01 INTO
		nr_atendimento_w,
		ds_cid_doenca_w,
		cd_doenca_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		BEGIN
		IF (coalesce(ds_afecciones_sinan_w::text, '') = '') THEN
			ds_afecciones_sinan_w	:= nr_atendimento_w || '#'  || ds_cid_doenca_w || '#' || cd_doenca_w;
		ELSE
			ds_afecciones_sinan_w	:= ds_afecciones_sinan_w||'&'|| nr_atendimento_w || '#'  || ds_cid_doenca_w || '#' || cd_doenca_w;
		END IF;
		END;
	END LOOP;
	CLOSE c01;

RETURN ds_afecciones_sinan_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_afecciones_sinan ( nr_atendimento_p bigint) FROM PUBLIC;

