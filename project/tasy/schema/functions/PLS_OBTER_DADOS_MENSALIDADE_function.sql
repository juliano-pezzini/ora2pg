-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_mensalidade ( nr_seq_mensalidade_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

/* ie_opcao_p
	C - Contrato
	D - Data de referência
	P - Parcela
	L - Lote mensalidade
	CO - Coparticipação
	VS - Valor das SCA's da mensalidade
	VB - Valor das bonificações da mensalidade
	VRF - Valor dos reajustes de faixa etária da mensalidade
	VRV - Valor dos reajustes de variação de preço da mensalidade
	VT - Valor total
	T - Titulo
	LT - Liquidação do título
	PP - Pagamento Previsto
	EC - Estipulante do contrato
	PG - Pagador
	SP - Sequencia pagador
	ST - Tipo situação do título
	CDP - Código Portador do título
	DSP - Descrição Portador do título
*/
ds_retorno_w			varchar(255);
nr_seq_contrato_w		bigint;
nr_parcela_w			bigint;
nr_seq_lote_w			bigint;
vl_coparticipacao_w		double precision;
vl_item_sca_w			double precision;
vl_item_bonific_w		double precision;
vl_item_faixa_w			double precision;
vl_item_variacao_w		double precision;
vl_item_total_w			double precision;
nr_titulo_w			bigint;
nr_seq_pagador_w		bigint;
dt_liquidacao_w			timestamp;
dt_pagamento_previsto_w		timestamp;
dt_referencia_w			timestamp;
cd_portador_w 			titulo_receber.cd_portador%type;


BEGIN

select	nr_seq_contrato,
	nr_seq_pagador,
	nr_parcela,
	nr_seq_lote,
	vl_coparticipacao,
	dt_referencia
into STRICT	nr_seq_contrato_w,
	nr_seq_pagador_w,
	nr_parcela_w,
	nr_seq_lote_w,
	vl_coparticipacao_w,
	dt_referencia_w
from	pls_mensalidade
where	nr_sequencia	= nr_seq_mensalidade_p;

if (ie_opcao_p = 'C') then
	ds_retorno_w	:= to_char(nr_seq_contrato_w);
elsif (ie_opcao_p = 'NC') then
	select	max(a.nr_contrato)
	into STRICT	ds_retorno_w
	from	pls_contrato		a,
		pls_contrato_pagador	b
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.nr_sequencia	= nr_seq_pagador_w;
elsif (ie_opcao_p = 'SC') then
	select (select	substr(ds_valor_dominio,1,50)
		from 	valor_dominio
		where	cd_dominio	= 1733
		and	vl_dominio	= a.ie_situacao)
	into STRICT	ds_retorno_w
	from	pls_contrato		a,
		pls_contrato_pagador	b
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.nr_sequencia	= nr_seq_pagador_w;
elsif (ie_opcao_p = 'P') then
	ds_retorno_w	:= to_char(nr_parcela_w);
elsif (ie_opcao_p = 'L') then
	ds_retorno_w	:= to_char(nr_seq_lote_w);
elsif (ie_opcao_p = 'CO') then
	ds_retorno_w	:= to_char(vl_coparticipacao_w);
elsif (ie_opcao_p = 'VS') then
	select	sum(vl_item)
	into STRICT	vl_item_sca_w
	from	pls_mensalidade			a,
		pls_mensalidade_segurado	b,
		pls_mensalidade_seg_item	c
	where	c.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= a.nr_sequencia
	and	c.ie_tipo_item			= '15'
	and	a.nr_sequencia			= nr_seq_mensalidade_p;
	ds_retorno_w	:= to_char(vl_item_sca_w);
elsif (ie_opcao_p = 'VB') then
	select	sum(vl_item)
	into STRICT	vl_item_bonific_w
	from	pls_mensalidade			a,
		pls_mensalidade_segurado	b,
		pls_mensalidade_seg_item	c
	where	c.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= a.nr_sequencia
	and	c.ie_tipo_item			= '14'
	and	a.nr_sequencia			= nr_seq_mensalidade_p;
	ds_retorno_w	:= to_char(vl_item_bonific_w);
elsif (ie_opcao_p = 'VRF') then
	select	sum(vl_item)
	into STRICT	vl_item_faixa_w
	from	pls_mensalidade			a,
		pls_mensalidade_segurado	b,
		pls_mensalidade_seg_item	c
	where	c.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= a.nr_sequencia
	and	c.ie_tipo_item			= '5'
	and	a.nr_sequencia			= nr_seq_mensalidade_p;
	ds_retorno_w	:= to_char(vl_item_faixa_w);
elsif (ie_opcao_p = 'VRV') then
	select	sum(vl_item)
	into STRICT	vl_item_variacao_w
	from	pls_mensalidade			a,
		pls_mensalidade_segurado	b,
		pls_mensalidade_seg_item	c
	where	c.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= a.nr_sequencia
	and	c.ie_tipo_item			= '4'
	and	a.nr_sequencia			= nr_seq_mensalidade_p;
	ds_retorno_w	:= to_char(vl_item_variacao_w);
elsif (ie_opcao_p = 'VT') then
	select	sum(vl_item)
	into STRICT	vl_item_total_w
	from	pls_mensalidade			a,
		pls_mensalidade_segurado	b,
		pls_mensalidade_seg_item	c
	where	c.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= a.nr_sequencia
	and	c.ie_tipo_item			<> '14'
	and	a.nr_sequencia			= nr_seq_mensalidade_p;
	ds_retorno_w	:= to_char(vl_item_total_w);
elsif (ie_opcao_p = 'T') then
	select	max(a.nr_titulo)
	into STRICT	nr_titulo_w
	from	titulo_receber	a,
		pls_mensalidade	b
	where	a.nr_seq_mensalidade	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_mensalidade_p;
	ds_retorno_w	:= to_char(nr_titulo_w);
elsif (ie_opcao_p = 'LT') then
	select	max(a.dt_liquidacao)
	into STRICT	dt_liquidacao_w
	from	titulo_receber	a,
		pls_mensalidade	b
	where	a.nr_seq_mensalidade	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_mensalidade_p;
	ds_retorno_w	:= to_char(dt_liquidacao_w,'dd/mm/yyyy');
elsif (ie_opcao_p = 'PP') then
	select	max(a.dt_pagamento_previsto)
	into STRICT	dt_pagamento_previsto_w
	from	titulo_receber	a,
		pls_mensalidade	b
	where	a.nr_seq_mensalidade	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_mensalidade_p;
	ds_retorno_w	:= to_char(dt_pagamento_previsto_w,'dd/mm/yyyy');
elsif (ie_opcao_p = 'D') then
	ds_retorno_w	:= to_char(dt_referencia_w,'dd/mm/yyyy');
elsif (ie_opcao_p = 'PG') then
	select	pls_obter_dados_pagador(a.nr_seq_pagador,'D')
	into STRICT	ds_retorno_w
	from	pls_mensalidade a
	where	a.nr_sequencia = nr_seq_mensalidade_p;
elsif (ie_opcao_p = 'EC') then
	select	b.nr_seq_contrato
	into STRICT	nr_seq_contrato_w
	from	pls_contrato_pagador b,
		pls_mensalidade a
	where	a.nr_seq_pagador	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_mensalidade_p;

	ds_retorno_w	:= pls_obter_dados_contrato(nr_seq_contrato_w,'E');
elsif (ie_opcao_p = 'ST') then
	select	max(a.ie_situacao)
	into STRICT	ds_retorno_w
	from	titulo_receber	a,
		pls_mensalidade	b
	where	a.nr_seq_mensalidade	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_mensalidade_p;
elsif (ie_opcao_p = 'SP') then
	select	a.nr_seq_pagador
	into STRICT	ds_retorno_w
	from	pls_mensalidade a
	where	a.nr_sequencia = nr_seq_mensalidade_p;
elsif (ie_opcao_p in ('CDP', 'DSP')) then
	select	max(a.cd_portador)
	into STRICT	cd_portador_w
	from	titulo_receber	a,
		pls_mensalidade	b
	where	b.nr_sequencia		= nr_seq_mensalidade_p
	and 	a.nr_seq_mensalidade	= b.nr_sequencia;

	if (ie_opcao_p = 'DSP') then
		select	max(ds_portador)
		into STRICT 	ds_retorno_w
		from	portador
		where	cd_portador    = cd_portador_w;
	else
		ds_retorno_w := cd_portador_w;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_mensalidade ( nr_seq_mensalidade_p bigint, ie_opcao_p text) FROM PUBLIC;

