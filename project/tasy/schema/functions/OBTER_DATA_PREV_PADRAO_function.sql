-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_data_prev_padrao ( dt_inicio_prescr_p timestamp, cd_setor_atendimento_p bigint, cd_medico_p bigint) RETURNS varchar AS $body$
DECLARE

 
dt_horario_w		timestamp;
dt_retorno_w		varchar(20) := '';


BEGIN 
 
if (dt_inicio_prescr_p IS NOT NULL AND dt_inicio_prescr_p::text <> '') then 
 
	select 	min(to_date(to_char(dt_inicio_prescr_p,'dd/mm/yyyy') ||''|| to_char(a.ds_hora,'hh24:mi'), 'dd/mm/yyyy hh24:mi')) 
	into STRICT	dt_horario_w 
	FROM rep_hor_padrao_rotina a
LEFT OUTER JOIN rep_hor_padrao_filtro b ON (a.nr_sequencia = b.nr_seq_regra)
WHERE ((((b.cd_setor_atendimento = cd_setor_atendimento_p) or (coalesce(b.cd_setor_atendimento::text, '') = '')) and 
     	 ((b.cd_especialidade in (obter_especialidade_medico(cd_medico_p, 'CD'))) or (coalesce(b.cd_especialidade::text, '') = '')) and (b.ie_aplicar = 'S')) or (a.nr_sequencia not in (SELECT nr_seq_regra from rep_hor_padrao_filtro))) and to_char(a.ds_hora,'hh24:mi') >= to_char(dt_inicio_prescr_p, 'hh24:mi');
 
	if (coalesce(dt_horario_w::text, '') = '') then 
	 
		select 	min(to_date(to_char(dt_inicio_prescr_p + 1,'dd/mm/yyyy') ||''|| to_char(a.ds_hora,'hh24:mi'), 'dd/mm/yyyy hh24:mi')) 
		into STRICT	dt_horario_w 
		FROM rep_hor_padrao_rotina a
LEFT OUTER JOIN rep_hor_padrao_filtro b ON (a.nr_sequencia = b.nr_seq_regra)
WHERE ((((b.cd_setor_atendimento = cd_setor_atendimento_p) or (coalesce(b.cd_setor_atendimento::text, '') = '')) and		 
				 ((b.cd_especialidade in (obter_especialidade_medico(cd_medico_p, 'CD'))) or (coalesce(b.cd_especialidade::text, '') = '')) and (b.ie_aplicar = 'S')) or (a.nr_sequencia not in (SELECT nr_seq_regra from rep_hor_padrao_filtro)));
		 
	end if;
	 
end if;
 
if (dt_horario_w IS NOT NULL AND dt_horario_w::text <> '') then 
	dt_retorno_w := to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi');
end if;
 
return	dt_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_data_prev_padrao ( dt_inicio_prescr_p timestamp, cd_setor_atendimento_p bigint, cd_medico_p bigint) FROM PUBLIC;

