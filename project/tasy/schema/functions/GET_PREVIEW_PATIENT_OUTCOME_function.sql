-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_preview_patient_outcome (nr_seq_etapa_p bigint, ie_count_p text DEFAULT 'N', ie_nome_amigavel_p text DEFAULT 'N') RETURNS varchar AS $body$
DECLARE


    c1 CURSOR FOR
        SELECT coalesce(
                    CASE WHEN ie_nome_amigavel_p='S' THEN  c.ds_resultado_paciente  ELSE c.ds_resultado END , c.ds_resultado
                ) DS_RESULTADO
          FROM
               PROTOCOLO_INT_PAC_ETAPA  b,
               PROTOCOLO_INT_PAC_RESUL  c
        WHERE  b.nr_sequencia = c.nr_seq_etapa
          AND b.nr_sequencia = nr_seq_etapa_p
          AND c.ie_situacao = 'A'
          AND coalesce(b.ie_evento_sumario,'N') = 'N'
        ORDER BY c.nr_ordem_apresentacao;

    c2 CURSOR FOR
        SELECT COUNT(c.nr_sequencia)
          FROM
               PROTOCOLO_INT_PAC_ETAPA  b,
               PROTOCOLO_INT_PAC_RESUL  c
        WHERE  b.nr_sequencia = c.nr_seq_etapa
          AND b.nr_sequencia = nr_seq_etapa_p
          AND c.ie_situacao = 'A'
          AND coalesce(b.ie_evento_sumario,'N') = 'N';

	count_w bigint := 0;
	outcomes_w varchar(2000) := '';

BEGIN

    IF ie_count_p = 'S' THEN
        OPEN c2;
        FETCH c2 INTO count_w;
        CLOSE c2;

        RETURN to_char(count_w);
    END IF;

    FOR outcome IN c1 LOOP
        outcomes_w := outcomes_w || ' ' || outcome.ds_resultado || ',';
    END LOOP;
        outcomes_w := SUBSTR(outcomes_w, 0, LENGTH(outcomes_w) - 1);
    RETURN outcomes_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_preview_patient_outcome (nr_seq_etapa_p bigint, ie_count_p text DEFAULT 'N', ie_nome_amigavel_p text DEFAULT 'N') FROM PUBLIC;

