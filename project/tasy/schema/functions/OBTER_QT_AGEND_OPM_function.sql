-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function obter_qt_agend_opm as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE FUNCTION obter_qt_agend_opm ( nr_seq_opm_p bigint, dt_agendamento_p timestamp, nr_sequencia_p bigint, ie_acao_p text) RETURNS bigint AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

	v_ret	bigint;
BEGIN
	v_query := 'SELECT * FROM obter_qt_agend_opm_atx ( ' || quote_nullable(nr_seq_opm_p) || ',' || quote_nullable(dt_agendamento_p) || ',' || quote_nullable(nr_sequencia_p) || ',' || quote_nullable(ie_acao_p) || ' )';
	SELECT * INTO v_ret FROM dblink(v_conn_str, v_query) AS p (ret bigint);
	RETURN v_ret;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE FUNCTION obter_qt_agend_opm_atx ( nr_seq_opm_p bigint, dt_agendamento_p timestamp, nr_sequencia_p bigint, ie_acao_p text) RETURNS bigint AS $body$
DECLARE
nr_conta_w bigint;

BEGIN
  IF ie_acao_p = ('AEAG') THEN
    SELECT COUNT(*)
    INTO STRICT nr_conta_w
    FROM agenda_consulta ac
    WHERE ac.IE_STATUS_AGENDA <> 'E'
    AND ac.NR_SEQ_OPM         = nr_seq_opm_p
    AND establishment_timezone_utils.startofday(ac.dt_Agenda)          = establishment_timezone_utils.startofday(dt_agendamento_p)
    AND ac.nr_sequencia      <> nr_sequencia_p;
  elsif ie_acao_p = ( 'CLE') THEN
    SELECT COUNT(*)
    INTO STRICT nr_conta_w
    FROM AGENDA_LISTA_ESPERA al
    WHERE al.IE_STATUS_ESPERA <> 'C'
    AND al.NR_SEQ_OPM          = nr_seq_opm_p
    AND establishment_timezone_utils.startofday(al.dt_Agendamento)      = establishment_timezone_utils.startofday(dt_agendamento_p)
    AND al.nr_sequencia       <> nr_sequencia_p;
  END IF;
RETURN nr_conta_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_agend_opm ( nr_seq_opm_p bigint, dt_agendamento_p timestamp, nr_sequencia_p bigint, ie_acao_p text) FROM PUBLIC; -- REVOKE ALL ON FUNCTION obter_qt_agend_opm_atx ( nr_seq_opm_p bigint, dt_agendamento_p timestamp, nr_sequencia_p bigint, ie_acao_p text) FROM PUBLIC;

