-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tasy_uptime (dt_referencia_p timestamp ) RETURNS varchar AS $body$
DECLARE

ds_retorno_w	varchar(255);

BEGIN
-- PERCENTUAL UPTIME POR MES
select  -- a.mes,
        -- UP TIME = 100% - %DOWNTIME (TEMPO DE OS COM SEVERIDADE DE SISTEMA PARADO)
        100 - trunc (  ( b.tempo_philips / ( a.qt_cliente * a.up_time_por_cliente) ) * 100 ,2) perc_up_time
into	ds_retorno_w
from
        
        (   SELECT      trunc(to_date(dt_referencia_p),'MM') mes,
                        count(a.nr_sequencia) qt_cliente,
                        ( 1440 * obter_dias_entre_datas(trunc(to_date(dt_referencia_p),'MM'), fim_mes(to_date(dt_referencia_p)))) up_time_por_cliente
            from        com_cliente a
            where       1 = 1 
            and ((dt_aprov_duplic IS NOT NULL AND dt_aprov_duplic::text <> '') or coalesce(ie_etapa_duplic::text, '') = '') 
            and         ie_situacao = 'A' 
            and         ie_produto in ('O', 'P') 
            and         ie_classificacao = 'C' 
            and         cd_empresa = '1'
            and         cd_cnpj <> '01950338000177'  --Philips
            group by    trunc(to_date(dt_referencia_p),'MM'),
                        ( 1440 * obter_dias_entre_datas(trunc(to_date(dt_referencia_p),'MM'), fim_mes(to_date(dt_referencia_p))))
        )   a,
        
        (   SELECT  trunc(to_date(dt_referencia_p),'MM') mes,
                    coalesce((   select      sum(trunc(man_obter_tempo_estagio(b.nr_sequencia, b.nr_seq_ordem, 'M')/60,2)) tempo_philips
                            from        man_ordem_servico_v a,
                                        man_ordem_serv_estagio b,
                                        man_estagio_processo c
                            where       a.nr_sequencia = b.nr_seq_ordem
                            and         c.nr_sequencia =  b.nr_seq_estagio
                            and         a.nr_seq_severidade_wheb = 2 -- 2 = Sistema Parado
                            and         a.ie_terceiro = 'S'
                            and         trunc(a.dt_ordem_servico,'MM') = trunc(to_date(dt_referencia_p),'MM')
                        ),0
                    ) tempo_philips
            
        ) b
where   a.mes = b.mes;

return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tasy_uptime (dt_referencia_p timestamp ) FROM PUBLIC;

