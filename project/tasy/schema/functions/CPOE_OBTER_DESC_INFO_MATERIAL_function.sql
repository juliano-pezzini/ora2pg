-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_desc_info_material ( cd_material_p bigint, cd_mat_comp1_p bigint, qt_dose_comp1_p bigint, cd_unid_med_dose_comp1_p text, cd_mat_comp2_p bigint, qt_dose_comp2_p bigint, cd_unid_med_dose_comp2_p text, cd_mat_comp3_p bigint, qt_dose_comp3_p bigint, cd_unid_med_dose_comp3_p text, cd_mat_dil_p bigint, qt_dose_dil_p bigint, cd_unid_med_dose_dil_p text, cd_mat_red_p bigint, qt_dose_red_p bigint, cd_unid_med_dose_red_p text, dt_liberacao_p timestamp default null, qt_dose_p bigint default null, cd_unidade_medida_p text default null, ie_via_aplicacao_p text default null, cd_intervalo_p text default null, dt_lib_suspensao_p timestamp default null, dt_suspensao_p timestamp default null, ie_administracao_p text default null, nr_seq_ataque_p cpoe_material.nr_seq_ataque%type default null, nr_seq_procedimento_p cpoe_material.nr_seq_procedimento%type default null, nr_seq_adicional_p cpoe_material.nr_seq_adicional%type default null, nr_seq_hemotherapy_p cpoe_material.nr_seq_hemoterapia%type default null, ds_dose_diferenciada_p text default null, ds_dose_diferenciada_dil_p text default null, ds_dose_diferenciada_red_p text default null, ds_dose_diferenciada_comp1_p text default null, ds_dose_diferenciada_comp2_p text default null, ds_dose_diferenciada_comp3_p text default null, cd_mat_comp4_p bigint default null, qt_dose_comp4_p bigint default null, cd_unid_med_dose_comp4_p text default null, ds_dose_diferenciada_comp4_p text default null, cd_mat_comp5_p bigint default null, qt_dose_comp5_p bigint default null, cd_unid_med_dose_comp5_p text default null, ds_dose_diferenciada_comp5_p text default null, cd_mat_comp6_p bigint default null, qt_dose_comp6_p bigint default null, cd_unid_med_dose_comp6_p text default null, ds_dose_diferenciada_comp6_p text default null, dt_inicio_p timestamp default null, dt_fim_p timestamp default null, dt_fim_cih_p timestamp default null, nr_dia_util_p bigint default null, ie_antibiotico_p text default null, ie_tipo_solucao_p text default null, cd_mat_comp7_p bigint default null, qt_dose_comp7_p bigint default null, cd_unid_med_dose_comp7_p text default null, ds_dose_diferenciada_comp7_p text default null, ie_oncologia_p text default 'N', cd_mat_recons_p bigint default null, qt_dose_recons_p bigint default null, cd_unid_med_dose_recons_p text default null, ds_dose_diferenciada_rec_p text default null, ds_titulo_p text default null, ie_duracao_p text default null, ie_ref_calculo_p cpoe_material.ie_ref_calculo%type default null, nr_etapas_p cpoe_material.nr_etapas%type default null, ie_controle_tempo_p text default null, qt_dias_solicitado_p bigint default null, qt_dias_liberado_p bigint default null, nr_atendimento_p bigint default null, ie_baixado_por_alta_p cpoe_material.ie_baixado_por_alta%type default null, dt_alta_medico_p cpoe_material.dt_alta_medico%type default null, ie_exibe_dil_p text default 'S', ie_adep_p text default 'N', nr_seq_cpoe_p bigint default null, ds_horarios_p text default null, ie_tipo_item_p text default null, ie_reset_atb_p text default null, nr_seq_cpoe_anterior_p bigint default null, ds_calc_therap_dose_p text default null, ie_exibir_dt_fim_p text default 'N', qt_final_concentration_p text default null, ie_um_final_conc_pca_p text default null, qt_dose_range_min_p bigint default null, qt_dose_range_max_p bigint default null, ie_dose_range_p text default 'N', ds_medic_nao_padrao_p cpoe_material.ds_medic_nao_padrao%type default null, ie_medicacao_paciente_p cpoe_material.ie_medicacao_paciente%type default null, ie_cpoe_p text default 'N', qt_dose_dia_p bigint default null, dt_reference_p timestamp default null, qt_dose_maxima_p bigint default null, dt_fim_grid_p timestamp default null, ie_revalidacao_p text default 'N', ie_tpm_p text default 'N', cd_funcao_origem_p text default null) RETURNS varchar AS $body$
DECLARE


ds_material_w			varchar(100);
ds_mat_comp1_w			varchar(100);
ds_mat_comp2_w			varchar(100);
ds_mat_comp3_w			varchar(100);
ds_mat_red_w			varchar(100);
ds_mat_dil_w			varchar(100);
ds_retorno_w			varchar(2000);
ds_param17_w			varchar(1);
ds_param19_w			varchar(1);
ds_param567_w			varchar(1);
cd_intervalo_w  	intervalo_prescricao.cd_intervalo%type;
ds_indentific_mat_w	varchar(30);-- NAO REMOVER - Verfificar OS: 979988
ds_vol_etapa_w		varchar(255);
nr_seq_sol_w		prescr_material.nr_sequencia_solucao%type;
ie_exibe_dil_medic_w	varchar(1);
nr_prescricao_w			prescr_medica.nr_prescricao%type;
dt_fim_w		timestamp;
ds_exp_termino_w	varchar(100);
ds_date_mask_w  	varchar(30);
ds_termina_em_w 	varchar(50);
dt_start_w		timestamp;
dt_end_w		timestamp;
ds_withheld_w		varchar(255);
ds_start_w		varchar(255);
ds_end_w		varchar(255);
ds_totalDose_w               varchar(100);
IE_VIA_APLICACAO_W          varchar(100);
IE_FORMATO_ADMINISTRACAO_w via_aplicacao.IE_FORMATO_ADMINISTRACAO%type;
ds_tempo_adm_grid_w			varchar(100);
ds_param181_w     varchar(1);
ie_double_check_w	varchar(1);
ds_proc_assoc_w   varchar(250);
ds_retorno_tag_w varchar(1000);
ds_class_tag_w   varchar(5);
ie_needs_ackn_interface_w 	varchar(2);
ie_confirm_ackn_interface_w	varchar(2);
rule_quantity_w			integer;
ie_param_67_w           funcao_param_usuario.vl_parametro%type;
ie_tipo_material_w      material.ie_tipo_material%type;
ds_substancia_w         medic_ficha_tecnica.ds_substancia%type;
ds_retorno_medic_com_w  medic_ficha_tecnica.ds_substancia%type;
ie_dbcheck_mat_comp1_w	varchar(1);
ie_dbcheck_mat_comp2_w	varchar(1);
ie_dbcheck_mat_comp3_w	varchar(1);
ie_dbcheck_mat_comp4_w	varchar(1);
ie_dbcheck_mat_comp5_w	varchar(1);
ie_dbcheck_mat_comp6_w	varchar(1);
ie_dbcheck_mat_comp7_w	varchar(1);
ie_double_check_dil_w	varchar(1);
ie_double_check_red_w	varchar(1);
ie_double_check_recons_w	varchar(1);
ds_param68_w            funcao_param_usuario.vl_parametro%type;
ds_retorno_param68_w    varchar(5000);

function valida_param_68_cpoe(ds_mat_p in text) return text is;
BEGIN
    ds_param68_w := obter_param_usuario(2314, 68, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ds_param68_w);
    if (ds_param68_w = 'S') then
        if ( (coalesce(ds_dose_diferenciada_p::text, '') = '' AND (cd_mat_dil_p IS NOT NULL AND cd_mat_dil_p::text <> '') AND (qt_final_concentration_p IS NOT NULL AND qt_final_concentration_p::text <> '')) OR (ds_mat_p IS NOT NULL AND ds_mat_p::text <> '' AND qt_final_concentration_p IS NOT NULL AND qt_final_concentration_p::text <> '')
         ) then
            ds_retorno_param68_w := ' <br> ' || cpoe_add_span(obter_desc_expressao(669527, null) || ': ' ||qt_final_concentration_p || Obter_Valor_Dominio(9633,ie_um_final_conc_pca_p));
        end if;
    else
        if (coalesce(ie_adep_p, 'N') = 'S' and (ds_mat_p IS NOT NULL AND ds_mat_p::text <> '') and (qt_final_concentration_p IS NOT NULL AND qt_final_concentration_p::text <> '')) then
            ds_retorno_param68_w := ' <br> ' || cpoe_add_span(obter_desc_expressao(669527, null) || ': ' ||qt_final_concentration_p || Obter_Valor_Dominio(9633,ie_um_final_conc_pca_p));
        end if;
    end if;
    return ds_retorno_param68_w;
end;

function regra_medic_comerc_simil(cd_material_p in varchar2) return varchar2 is
begin
    ds_retorno_medic_com_w := null;
    ie_param_67_w := obter_parametro_funcao(2314, 67, wheb_usuario_pck.get_nm_usuario);
    if (ie_param_67_w <> 'N') then
        begin
            select a.ie_tipo_material, b.ds_substancia
            into STRICT ie_tipo_material_w, ds_substancia_w
            from material a, medic_ficha_tecnica b
            where a.cd_material = cd_material_p
            and a.NR_SEQ_FICHA_TECNICA = b.nr_sequencia;
        exception when no_data_found then
            ie_tipo_material_w := null;
            ds_substancia_w := null;
        end;
        if (ie_param_67_w = 'S' AND ie_tipo_material_w in (2,3,9) OR ie_param_67_w = 'T' AND ie_tipo_material_w in (0,2,3,6,9)) then
            ds_retorno_medic_com_w := '<span class="ds-substancia"> [' || ds_substancia_w || ']</span>';
        end if;
    end if;
    return ds_retorno_medic_com_w;
end;

	function get_UoM( ds_valor_p varchar2) return varchar2 is
	begin
		if (ds_valor_p = 'ml') and (pkg_i18n.get_user_locale() = 'en_AU') then
			return 'mL';
		else
			return ds_valor_p;
		end if;
	end;

	function cpoe_add_span_adic_info(ds_informacao_p	varchar2, ds_style_adic_p varchar2) return  varchar2 is
	ds_span_w	varchar2(2000);
	begin
		if ((trim(both ds_informacao_p) IS NOT NULL AND (trim(both ds_informacao_p))::text <> '')) then
			begin
			ds_span_w	:= '<span class=''material-adic-info '|| ds_style_adic_p ||'''> '||ds_informacao_p||'</span>';
			end;
		end if;
		return ds_span_w;

	end;

	function bold( ds_valor_p varchar2) return varchar2 is
	begin
		return '<strong '||ds_indentific_mat_w||' >' ||ds_valor_p||'</strong>';
	end;

	function obter_proc_assoc return varchar2 is
	begin

	if (ie_adep_p = 'S') then
		select	max(coalesce(substr(CASE WHEN coalesce(ds_param181_w, 'N')='N' THEN coalesce(c.ds_proc_exame,d.ds_procedimento)  ELSE coalesce(b.ds_rotina,coalesce(c.ds_proc_exame,d.ds_procedimento)) END , 1,240),''))
		into STRICT	ds_proc_assoc_w
		from	cpoe_procedimento a,
				prescr_procedimento b,
				proc_interno c,
				procedimento d
		where	a.nr_sequencia = b.nr_seq_proc_cpoe
		and		b.nr_seq_proc_interno = c.nr_sequencia
		and		c.cd_procedimento =  d.cd_procedimento
		and		c.ie_origem_proced = d.ie_origem_proced
		and		a.nr_sequencia = nr_seq_procedimento_p;

		ds_class_tag_w := 'adep';
	else
		select  max(substr(coalesce(b.ds_rotina, c.ds_proc_exame, d.ds_procedimento), 1, 240))
		into STRICT	ds_proc_assoc_w
		from	cpoe_procedimento a,
				prescr_procedimento b,
				proc_interno c,
				procedimento d
		where	a.nr_sequencia = b.nr_seq_proc_cpoe
		and		b.nr_seq_proc_interno = c.nr_sequencia
		and		c.cd_procedimento =  d.cd_procedimento
		and		c.ie_origem_proced = d.ie_origem_proced
		and		a.nr_sequencia = nr_seq_procedimento_p;

		ds_class_tag_w := 'gpt';
	end if;

    ds_retorno_tag_w := '</div><div class="legend-cell-status-text-' || ds_class_tag_w || '" style="cursor: default; flex-wrap: wrap;">
                <div class="legend-cell-content-tag-' || ds_class_tag_w || '" style="cursor: default;">';



    if (ie_adep_p = 'S') then
      ds_retorno_tag_w := ds_retorno_tag_w || '<div class="legend-cell-tag-gpt" style="background-color: #D6D6D6; cursor: default; margin-top: 4px;"';
    else
      ds_retorno_tag_w := ds_retorno_tag_w || '<div class="legend-cell-tag-adep cpoe_color_gray" style="cursor: default; margin-top: 4px;"';
    end if;

    ds_retorno_tag_w := ds_retorno_tag_w || ' onmouseenter="wTooltipService.showTooltip(event.target,''' || ds_proc_assoc_w ||''')" onmouseout="wTooltipService.hideTooltip()">
                      ' || wheb_mensagem_pck.get_texto(332043, null) || '
                  </div>
              </div>
          </div><div style="display:none">';

    return ds_retorno_tag_w;
	end;

	function italic_bold( ds_valor_p varchar2) return varchar2 is
	begin
		return '<em class=''ds-material-adic''><strong class=''ds-material-adic''>' || ds_valor_p || '</strong></em>';
	end;

	function obter_tipo_item return varchar2 is
	begin

		if (nr_seq_ataque_p IS NOT NULL AND nr_seq_ataque_p::text <> '')  then
			--- Attack dose
			ds_retorno_tag_w := cpoe_add_span_adic_info('['||wheb_mensagem_pck.get_texto(332044, null)||']',' ');

		elsif (nr_seq_adicional_p IS NOT NULL AND nr_seq_adicional_p::text <> '')  then
			--- Additional dose
			ds_retorno_tag_w := cpoe_add_span_adic_info('['||wheb_mensagem_pck.get_texto(332788, null)||']',' ');

		elsif ((nr_seq_procedimento_p IS NOT NULL AND nr_seq_procedimento_p::text <> '') and ie_tpm_p = 'N') then
			--- Item Associado
      if (ie_cpoe_p = 'G') then
			  ds_retorno_tag_w := cpoe_add_span_adic_info('['||wheb_mensagem_pck.get_texto(332043, null)||']',' ');
      end if;

      if (ie_adep_p = 'S') then
        ds_retorno_tag_w := ' ';
      end if;

      if (ie_cpoe_p = 'N') then
        ds_retorno_tag_w := obter_proc_assoc;
      end if;

		elsif (nr_seq_hemotherapy_p IS NOT NULL AND nr_seq_hemotherapy_p::text <> '') then
			--- Associate Item Hemotherapy
			ds_retorno_tag_w := cpoe_add_span_adic_info('['||wheb_mensagem_pck.get_texto(333812, null)||']',' ');
		end if;

		return ds_retorno_tag_w;
	end;

	function obter_tipo_solucao return varchar2 is
	begin

		if (ie_tipo_solucao_p IS NOT NULL AND ie_tipo_solucao_p::text <> '')  then
			return cpoe_obter_ds_tipo_solucao(ie_tipo_solucao_p);
		end if;

		return '';

	end;

    function get_dose_description(
        ds_dose_diferenciada_p varchar2,
        ie_display_p           varchar2,
        ie_tipo_item_p         varchar2 )
      return varchar2
    is
      ds_returno_desc varchar2(100);
    begin
      if (ds_dose_diferenciada_p IS NOT NULL AND ds_dose_diferenciada_p::text <> '') then
        if (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '')then
          if (ie_tipo_item_p      ='SOL' and ie_display_p ='N') then
            ds_returno_desc     :='['||trim(both obter_desc_expressao_idioma(288235,null,wheb_usuario_pck.get_nr_seq_idioma))||']';
          elsif (ie_tipo_item_p   ='SOL' and ie_display_p ='S') then
            ds_returno_desc     := '';
          else
            ds_returno_desc :='['||trim(both obter_desc_expressao_idioma(288235,null,wheb_usuario_pck.get_nr_seq_idioma))||']';
          end if;
        elsif (ie_display_p ='N') then
          ds_returno_desc :='['||trim(both obter_desc_expressao_idioma(288235,null,wheb_usuario_pck.get_nr_seq_idioma))||']';
        else
          ds_returno_desc := '';
        end if;
      else
        ds_returno_desc := '';
      end if;
      return ds_returno_desc;
    end;

	function get_dose_range_description(
        ds_dose_min_p         varchar2,
        ds_dose_max_p         varchar2,
		ds_dose_maxima_p      varchar2,
        cd_unidade_medida_p		varchar2,
        ie_dose_range_p       varchar2 default 'N')
      return varchar2
    is
      ds_returno_desc varchar2(100);
    begin
     if (ie_dose_range_p = 'S' and (ds_dose_min_p IS NOT NULL AND ds_dose_min_p::text <> '') and (ds_dose_max_p IS NOT NULL AND ds_dose_max_p::text <> '') and (ds_dose_maxima_p IS NOT NULL AND ds_dose_maxima_p::text <> '')) then
		ds_returno_desc := '['||trim(both obter_desc_expressao_idioma(690435,null,wheb_usuario_pck.get_nr_seq_idioma))||' - '||
							trim(both obter_desc_expressao_idioma(305061,null,wheb_usuario_pck.get_nr_seq_idioma))||
							': '|| ds_dose_min_p || ' ' || get_UoM(cd_unidade_medida_p) || ' | ' ||
							trim(both obter_desc_expressao_idioma(293017,null,wheb_usuario_pck.get_nr_seq_idioma))||
							': ' || ds_dose_max_p || ' ' || get_UoM(cd_unidade_medida_p) || ' | ' ||
							trim(both obter_desc_expressao_idioma(969767,null,wheb_usuario_pck.get_nr_seq_idioma))||
							': ' || ds_dose_maxima_p || ' ' || get_UoM(cd_unidade_medida_p) || ']';
	elsif (ie_dose_range_p = 'S' and (ds_dose_min_p IS NOT NULL AND ds_dose_min_p::text <> '') and (ds_dose_max_p IS NOT NULL AND ds_dose_max_p::text <> '')) then
		ds_returno_desc := '['||trim(both obter_desc_expressao_idioma(690435,null,wheb_usuario_pck.get_nr_seq_idioma))||' - '||
							trim(both obter_desc_expressao_idioma(305061,null,wheb_usuario_pck.get_nr_seq_idioma))||
							': '|| ds_dose_min_p || ' ' || get_UoM(cd_unidade_medida_p) || ' | ' ||
							trim(both obter_desc_expressao_idioma(293017,null,wheb_usuario_pck.get_nr_seq_idioma))||
							': ' || ds_dose_max_p || ' ' || get_UoM(cd_unidade_medida_p) || ']';
      else
        ds_returno_desc := '';
      end if;
      return ds_returno_desc;
    end;

	function obter_etapas_item return varchar2 is
	begin

	if (ie_ref_calculo_p = 'NE'
		and ie_controle_tempo_p = 'S' 
		and (ie_tipo_solucao_p <> 'V' or ie_administracao_p <> 'C'))  then
      if ( nr_etapas_p > 1) then
        return nr_etapas_p||' '||obter_desc_expressao(289637);
      else
        return nr_etapas_p||' '||obter_desc_expressao(935588);
      end if;
	end if;
	return '';
	end;

	function dose_unidade_medida(qt_dose_p				number,
								 ds_dose_diferenciada_p	varchar2,
								 cd_unidade_medida_p	varchar2) return varchar2 is
		qt_dose_w		   varchar2(50);
	begin
		if (coalesce(ds_dose_diferenciada_p::text, '') = '') then
			qt_dose_w := cpoe_dose_formatada(qt_dose_p);

			if (substr(replace(qt_dose_w,',','.'),1,1) = '.') then
				qt_dose_w	:= '0' || qt_dose_w;
			end if;

			return ' ' || qt_dose_w || ' ' || get_UoM(cd_unidade_medida_p) || ' ';
		else
			--Colocar '0' antes da virgula
			qt_dose_w := cpoe_get_differential_dose(ds_dose_diferenciada_p);

			if (substr(ds_dose_diferenciada_p,1,1) = ',') then
				qt_dose_w	:= '0' || ds_dose_diferenciada_p;

			qt_dose_w	:= replace(qt_dose_w,'.',',');
			end if;

			if (substr(ds_dose_diferenciada_p,1,1) = '.') then
				qt_dose_w	:= '0' || ds_dose_diferenciada_p;
			end if;

			return ' ' || qt_dose_w || ' ' || get_UoM(cd_unidade_medida_p) || ' ';
		end if;
	end;	

	function cpoe_add_dose(	qt_dose_p		number,
				ds_dose_diferenciada_p	varchar2,
				cd_unidade_medida_p	varchar2,
				ie_subitem_p		varchar2 default 'N') return varchar2 is
		ds_dose_w		varchar2(2000);
		qt_dose_w 		number;
	begin
		if (pkg_i18n.get_user_locale() = 'en_AU') then

			select 	count(1)
			into STRICT	qt_dose_w
			from 	cpoe_variable_dose
			where 	nr_seq_mat_cpoe = nr_seq_cpoe_p;

			if (qt_dose_w > 0) then
				select 	coalesce(max(qt_dose_adm),0)
				into STRICT	qt_dose_w
				from 	cpoe_variable_dose
				where 	nr_seq_mat_cpoe = nr_seq_cpoe_p
				and 	coalesce(ie_awaiting_result, 'N') = 'N'
				and 	trunc(dt_dose) = trunc(dt_reference_p);

				if (qt_dose_w > 0) then
					ds_dose_w := 	cpoe_add_span(obter_desc_expressao(863724)) || ' ' ||
						italic_bold(dose_unidade_medida(qt_dose_w, ds_dose_diferenciada_p, cd_unidade_medida_p));
				else
					ds_dose_w := 	cpoe_add_span(obter_desc_expressao(863724) || ': ' || obter_desc_expressao(320680));
				end if;
			else
				ds_dose_w := 	cpoe_add_span(obter_desc_expressao(863724)) || ' ' ||
						italic_bold(dose_unidade_medida(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p));
			end if;

			if (ie_subitem_p = 'N') then
				return ds_dose_w || cpoe_add_span(obter_desc_expressao(317230));
			else
				return ds_dose_w;
			end if;
		else
			return cpoe_add_span(dose_unidade_medida(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p));
		end if;
	end;

	function adep_dose_unidade_medida(	qt_dose_p				number,
										ds_dose_diferenciada_p	varchar2,
										cd_unidade_medida_p		varchar2) return varchar2 is
		qt_dose_w		varchar2(50 char);
	begin
		if (coalesce(ds_dose_diferenciada_p::text, '') = '') then
			qt_dose_w := cpoe_dose_formatada(qt_dose_p);

			if (substr(qt_dose_w,1,1) = '.') then
				qt_dose_w	:= '0' || qt_dose_w;
			end if;

			return ' ' || qt_dose_w || ' ' || Obter_Desc_Unid_Med(cd_unidade_medida_p) || ' ';
		else
			--Colocar '0' antes da virgula
			qt_dose_w := cpoe_get_differential_dose(ds_dose_diferenciada_p);

			if (substr(ds_dose_diferenciada_p,1,1) = ',') then
				qt_dose_w	:= '0' || ds_dose_diferenciada_p;
				qt_dose_w	:= replace(qt_dose_w,'.',',');
			end if;

			if (substr(ds_dose_diferenciada_p,1,1) = '.') then
				qt_dose_w	:= '0' || ds_dose_diferenciada_p;
			end if;

			return ' ' || qt_dose_w || ' ' || Obter_Desc_Unid_Med(cd_unidade_medida_p) || ' ';
		end if;
	end;

	function add_div_item(ds_conteudo_p varchar2) return varchar2 is
		start_html varchar2(100);
		end_html varchar2(50);
	begin
		start_html := '<br> ';
		end_html := '';

		if (ie_cpoe_p = 'S') then
			start_html := '<div class="cpoe-div-item-comp">';
			end_html := '</div>';
		end if;

		return start_html || ds_conteudo_p || end_html;
	end;

	function obter_descricao_subitem(	cd_material_p			number,
										qt_dose_p				number,
										cd_unidade_medida_p		varchar2,
										ds_dose_diferenciada_p	varchar2 )
	 				return varchar2 is
	begin
		return 	cpoe_add_span_mat_comp( substr(obter_desc_material(cd_material_p),1,80) ) || regra_medic_comerc_simil(cd_material_p) ||
				cpoe_add_dose(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p, 'S');
	end;

	function adep_obter_descricao_subitem(	cd_material_p			number,
											qt_dose_p				number,
											cd_unidade_medida_p		varchar2,
											ds_dose_diferenciada_p	varchar2 )
	 				return varchar2 is
	begin
		return ' <br> ' ||
				adep_add_span_mat_comp( substr(obter_desc_material(cd_material_p),1,80) ) || regra_medic_comerc_simil(cd_material_p) ||
				cpoe_add_span( adep_dose_unidade_medida(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p));
	end;


  function tag_nao_padrozinado(	cd_estabelecimento_p in prescr_medica.cd_estabelecimento%type,
									cd_material_p in prescr_material.cd_material%type) return varchar2 is
    ds_tag_ret_w  varchar2(2000 char);
	begin

    if (ie_cpoe_p = 'S' and obter_se_material_padronizado(cd_estabelecimento_p, cd_material_p) = 'N') then
		  ds_tag_ret_w := cpoe_add_span_adic_info(wheb_mensagem_pck.get_texto(311538, null), 'cpoe_text_legend cpoe_color_gray');	
    else
      ds_tag_ret_w := ' ';
    end if;

    return ds_tag_ret_w;
	end;

	function obter_alto_risco(	cd_material_pp number) return varchar2 is
	begin

	if (obter_se_medicam_alto_risco(cd_material_pp) = 'S') and (ie_cpoe_p <> 'N') then

		if (ie_cpoe_p = 'S') then
		    return cpoe_add_span_adic_info(wheb_mensagem_pck.get_texto(391170, null), 'cpoe_text_legend cpoe_color_red');
		elsif (ie_cpoe_p = 'G') then
			return cpoe_add_span_adic_info('['||wheb_mensagem_pck.get_texto(391170, null)||']', 'high-vigilance-item');
		end if;

	end if;
	return '';

	end;

	function get_ds_alternative_route(	nr_seq_mat_cpoe_p number) return varchar2 is

	ds_return_w 	varchar2(600) := '';

	begin

	if (nr_seq_mat_cpoe_p IS NOT NULL AND nr_seq_mat_cpoe_p::text <> '') then

		select 	obter_desc_material(cd_material) || ' - ' || obter_desc_via(ie_via_aplicacao)
		into STRICT	ds_return_w
		from	cpoe_alternative_route
		where	nr_seq_mat_cpoe = nr_seq_mat_cpoe_p;

	end if;

	return ds_return_w;

	end;

	function add_alternative_route(	nr_seq_cpoe_pp number) return varchar2 is
	begin

	if (get_if_alternative_route(nr_seq_cpoe_pp) = 'S') then

		if (ie_cpoe_p = 'S') or (ie_adep_p = 'S') then
		    return add_div_item(cpoe_add_span_adic_info(wheb_mensagem_pck.get_texto(1146171, null), 'cpoe_text_legend cpoe_color_gray') || cpoe_add_span(get_ds_alternative_route(nr_seq_cpoe_pp)));
		end if;

	end if;
	return '';

	end;

  function obter_margem_terap_estreita(	cd_material_pp	number) return varchar2 is
	begin
	if (ie_cpoe_p = 'S' and obter_medic_marg_terap_estreit(cd_material_pp) = 'S')then
		return cpoe_add_span_adic_info(wheb_mensagem_pck.get_texto(983931, null), 'cpoe_text_legend cpoe_color_red');
	end if;
	return '';

	end;

	function obter_se_item_oncologia(ie_oncologia_p varchar2) return varchar2 is
		begin
			if (coalesce(ie_oncologia_p,'N') = 'S') then
				return cpoe_add_span_adic_info('['||wheb_mensagem_pck.get_texto(997864, null)||']', 'high-vigilance-item');
			end if;
		return '';
	end;

	function obter_total_dias(dt_inicio_p date, dt_fim_p date, dt_suspensao_p date , dt_lib_suspensao_p date ) return number is
	begin
		if	(((dt_fim_p IS NOT NULL AND dt_fim_p::text <> '') and (establishment_timezone_utils.startofday(dt_fim_p) > establishment_timezone_utils.startofday(clock_timestamp())) and ((coalesce(dt_lib_suspensao_p::text, '') = '') or (establishment_timezone_utils.startofday(dt_suspensao_p) > establishment_timezone_utils.startofday(dt_fim_p)))) or
			 ((dt_lib_suspensao_p IS NOT NULL AND dt_lib_suspensao_p::text <> '') and (establishment_timezone_utils.startofday(dt_suspensao_p) > establishment_timezone_utils.startofday(clock_timestamp())))) then

			if ((dt_suspensao_p IS NOT NULL AND dt_suspensao_p::text <> '') and (dt_lib_suspensao_p IS NOT NULL AND dt_lib_suspensao_p::text <> '') and
				((coalesce(dt_fim_p::text, '') = '') or (dt_fim_p > dt_suspensao_p))) then
				return obter_tempo_entre_datas(establishment_timezone_utils.startofday(dt_inicio_p), establishment_timezone_utils.startofday(dt_suspensao_p), 'D');
			else
				return obter_tempo_entre_datas(establishment_timezone_utils.startofday(dt_inicio_p), establishment_timezone_utils.startofday(dt_fim_p), 'D');
			end if;
		end if;
		return 1;
	end;

	function obter_desc_dias(nr_dia_util_p number, dt_inicio_p date, dt_fim_p date, dt_suspensao_p date , dt_lib_suspensao_p date , ie_antibiotico_p varchar2 ) return varchar2 is
		qt_dias_w				number(10);
		begin
			if (nr_dia_util_p IS NOT NULL AND nr_dia_util_p::text <> '') and (ie_duracao_p IS NOT NULL AND ie_duracao_p::text <> '') and (coalesce(ie_antibiotico_p::text, '') = '' or ie_antibiotico_p <> 'S') and (coalesce(ie_controle_tempo_p,'S') = 'N') then
			begin
				if (ie_duracao_p = 'P') then
					qt_dias_w := obter_total_dias(dt_inicio_p, dt_fim_p, dt_suspensao_p, dt_lib_suspensao_p);
					return obter_desc_expressao(312099, '')||' '||nr_dia_util_p||'/'||qt_dias_w;
				else
					return obter_desc_expressao(312099, '')||' '||nr_dia_util_p;
				end if;
			end;
			end if;
		return '';
	end;

	function obter_desc_contagem_dias(ie_desc_dias_p varchar2) return varchar2 is
		ds_ret_w  varchar2(1000) := '';
	begin
		if ((ie_desc_dias_p = 'N') and (coalesce(ie_antibiotico_p, 'N') = 'S') and (coalesce(nr_dia_util_p, -1) >= 0)) then
			ds_ret_w := obter_desc_expressao(312099, '') ||' '|| nr_dia_util_p || '/'|| (obter_tempo_entre_datas(establishment_timezone_utils.startofday(cpoe_obter_inicio_cih(cd_material_p, clock_timestamp(), dt_fim_p, dt_fim_cih_p, dt_suspensao_p, dt_lib_suspensao_p, to_char(dt_inicio_p, 'hh24:mi'), nr_dia_util_p, nr_atendimento_p, ie_reset_atb_p, nr_seq_cpoe_anterior_p, dt_inicio_p)), establishment_timezone_utils.startofday(coalesce(dt_fim_cih_p, dt_fim_p)), 'D'));
		elsif ((ie_desc_dias_p = 'S') and (coalesce(ie_antibiotico_p, 'N') = 'N') and (coalesce(nr_dia_util_p, -1) >= 0)) then
			ds_ret_w := obter_desc_dias(nr_dia_util_p, dt_inicio_p, dt_fim_p, dt_suspensao_p, dt_lib_suspensao_p, ie_antibiotico_p);
		end if;

		return ds_ret_w;
	end;

	function obter_dose_diaria(qt_dose_dia_p number, ds_dose_diferenciada_p	varchar2, cd_unidade_medida_p varchar2) return varchar2 is
	begin
		if ((qt_dose_dia_p IS NOT NULL AND qt_dose_dia_p::text <> '') and (pkg_i18n.get_user_locale() = 'ja_JP')) then
                        return  cpoe_add_span(obter_desc_expressao(1034544, '')) || ' ( ' || cpoe_add_span( dose_unidade_medida(qt_dose_dia_p, ds_dose_diferenciada_p, cd_unidade_medida_p)) || cpoe_add_span(obter_desc_expressao(296060, '')) || ' )';		
		end if;
		return null;
	end;

	function cpoe_add_desc_item_param19 return varchar2 is
	begin
		if (pkg_i18n.get_user_locale() = 'en_AU') then
			return 	add_div_item(obter_descricao_subitem(cd_material_p, qt_dose_p, cd_unidade_medida_p, ds_dose_diferenciada_p));
		else
			return 	cpoe_add_span_mat_comp( ds_material_w ) || regra_medic_comerc_simil(cd_material_p) ||
				cpoe_add_span( dose_unidade_medida(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p));
		end if;
	end;

	function cpoe_add_desc_item_comp(nr_seq_cpoe_p cpoe_material.nr_sequencia%type,ds_param19_w varchar2,ie_tipo_item_p varchar2, ie_adep_jp_p varchar2) return varchar2 is

	ds_return_jp_w 			varchar2(1900) := '';
	cd_material_jp_w		cpoe_material.cd_material%type;
	cd_unidade_medida_jp_w	cpoe_material.cd_unidade_medida%type;
	qt_dose_jp_w			cpoe_material.qt_dose%type;

	c_add_comp CURSOR FOR
		SELECT	cd_material,
			cd_unidade_medida, 
			qt_dose		
		from	cpoe_material_add_comp 
		where	nr_seq_cpoe_material = nr_seq_cpoe_p
		order by	nr_additional;

	begin

		if (ie_adep_jp_p = 'N') then
			for cap_w in c_add_comp loop
				ds_return_jp_w	:= substr(ds_return_jp_w || add_div_item(obter_descricao_subitem( cap_w.cd_material, cap_w.qt_dose, cap_w.cd_unidade_medida, null) || obter_alto_risco(cap_w.cd_material) ||
					obter_margem_terap_estreita(cap_w.cd_material) || cpoe_add_span(get_dose_description(null,ds_param19_w,ie_tipo_item_p)) || tag_nao_padrozinado(wheb_usuario_pck.get_cd_estabelecimento, cap_w.cd_material)),1,1900);		
			end loop;
		else
			for cap_w in c_add_comp loop
				ds_return_jp_w := substr(ds_return_jp_w || adep_obter_descricao_subitem( cap_w.cd_material, cap_w.qt_dose, cap_w.cd_unidade_medida, null),1,1900);	
			end loop;
		end if;		

		return ds_return_jp_w;

	end;

	function obter_se_item_futuro(nr_seq_cpoe_p cpoe_material.nr_sequencia%type, ie_revalidacao_p varchar2)  return varchar2 is
	begin
		if (coalesce(ie_revalidacao_p,'N') = 'S') then
			select max(CPOE_obter_prox_adm_grid_ang(nr_sequencia, 'M',					
												nm_usuario, nr_atendimento, 			
												ie_administracao, cd_intervalo,			
												coalesce(dt_prox_geracao, clock_timestamp()),			
												dt_inicio, dt_fim,						
												'prescr_material',  'nr_seq_mat_cpoe', 	
												'prescr_mat_hor', 'nr_seq_material', null, dt_fim_grid_p, obter_funcao_ativa, ie_revalidacao_p)) ds_tempo_adm_grid
			into STRICT ds_tempo_adm_grid_w
			from cpoe_material				
			where nr_sequencia = nr_seq_cpoe_p 
			and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 		 
			and coalesce(dt_lib_suspensao::text, '') = '';

			if (ds_tempo_adm_grid_w IS NOT NULL AND ds_tempo_adm_grid_w::text <> '') then
				return cpoe_add_span_adic_info(ds_tempo_adm_grid_w, 'cpoe_color_yellow cpoe_text_legend');
			end if;
		end if;
		return null;
	end;

	function obter_desc_reconst_adic(seq_comp_item_p number,
									 nr_seq_cpoe_p cpoe_material.nr_sequencia%type, 
									 ie_adep_p varchar2,
									 ds_param19_p varchar2,
									 ie_tipo_item_p varchar2) return varchar2 is

		sql_w 						varchar2(500);
		cd_mat_recons_w 			cpoe_material.cd_mat_recons%type;
		qt_dose_recons_w 			cpoe_material.qt_dose_recons%type;
		cd_unid_med_dose_recons_w 	cpoe_material.cd_unid_med_dose_recons%type;
		ds_dose_diferenciada_rec_w	cpoe_material.ds_dose_diferenciada_rec%type;

	begin

		if (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then
			sql_w		:= substr(
				' select  cd_mat_recons'||seq_comp_item_p||', '||
				'  		  qt_dose_recons'||seq_comp_item_p||', '||
				'		  cd_unid_med_dose_recons'||seq_comp_item_p||', '||
				'         ds_dose_diferenciada_rec'||seq_comp_item_p||
				' from cpoe_material '||
				' where nr_sequencia = ' || nr_seq_cpoe_p ,1,500);

			begin
				EXECUTE sql_w into STRICT cd_mat_recons_w, qt_dose_recons_w, cd_unid_med_dose_recons_w, ds_dose_diferenciada_rec_w;
			exception when others then
				cd_mat_recons_w := null;
				qt_dose_recons_w := null;
				cd_unid_med_dose_recons_w := null;
				ds_dose_diferenciada_rec_w := null;
			end;

			if (coalesce(cd_mat_recons_w,0) > 0) then
				if (ie_adep_p = 'N') then
					return 	obter_descricao_subitem( cd_mat_recons_w, qt_dose_recons_w, cd_unid_med_dose_recons_w, ds_dose_diferenciada_rec_w) || obter_alto_risco(cd_mat_recons_w) ||
							obter_margem_terap_estreita(cd_mat_recons_w) || cpoe_add_span(get_dose_description(cd_unid_med_dose_recons_w,ds_param19_p,ie_tipo_item_p)) || tag_nao_padrozinado(wheb_usuario_pck.get_cd_estabelecimento, cd_mat_recons_w);
				else
					return 	adep_obter_descricao_subitem( cd_mat_recons_w, qt_dose_recons_w, cd_unid_med_dose_recons_w, ds_dose_diferenciada_rec_w);
				end if;
			end if;
		end if;

		return null;
	end;

	function get_order_interface(	ie_tipo_item_p in varchar2,
									nr_sequencia_p in number) return varchar2 is

	begin
		ie_needs_ackn_interface_w := cpoe_integracao_count(ie_tipo_item_p, nr_sequencia_p, 'BTN');
		ie_confirm_ackn_interface_w := cpoe_integracao_count(ie_tipo_item_p, nr_sequencia_p, 'TAG');

		if (ie_adep_p = 'S') then
			ds_class_tag_w := 'adep';
		else
			ds_class_tag_w := 'gpt';
		end if;

		ds_retorno_tag_w := '</div><div class="legend-cell-status-text-' || ds_class_tag_w ||'" style="cursor: default; flex-wrap: wrap;">
                <div class="legend-cell-content-tag-' || ds_class_tag_w ||'" style="cursor: default;">';



		if (ie_adep_p = 'S') then
			ds_retorno_tag_w := ds_retorno_tag_w || '<div class="legend-cell-tag-adep" style="background-color: #FFE9AB; cursor: default; margin-top: 4px;"</div>';			
		else
			ds_retorno_tag_w := ds_retorno_tag_w || '<div class="legend-cell-tag-gpt" style="background-color: #FFE9AB; cursor: default; margin-top: 4px;" </div>';
		end if;

		if (ie_needs_ackn_interface_w = 'S') then
			ds_retorno_tag_w :=  ds_retorno_tag_w || obter_desc_expressao_idioma(1000214, null, wheb_usuario_pck.get_nr_seq_idioma)
			|| ' </div>
              </div>
          </div><div style="display:none">;';
		elsif (ie_confirm_ackn_interface_w = 'S') then
			ds_retorno_tag_w :=  ds_retorno_tag_w || obter_desc_expressao_idioma(1012943, null, wheb_usuario_pck.get_nr_seq_idioma)
			|| ' </div>
              </div>
          </div><div style="display:none">;';
    else
      ds_retorno_tag_w := null;
		end if;

		return ds_retorno_tag_w;
	end;

    function cpoe_ds_linked_kits(nr_seq_cpoe_p in number,
                                 ie_adep_p in varchar2) return varchar2 is

    ds_linked_kits_w 			varchar2(2000) := ' ';
        c_kits CURSOR FOR
                SELECT  distinct a.ds_kit_material
                        from    kit_material a,
                                        cpoe_kit_medic b
                        where   a.cd_kit_material = b.cd_kit_material
                        and     b.nr_seq_cpoe_material = nr_seq_cpoe_p;
    begin


    for r_kits in c_kits loop
        if ((ds_linked_kits_w = ' ' and (ie_adep_p = 'S' or ie_tpm_p = 'S'))
                or (ds_linked_kits_w <> ' ')) then
            ds_linked_kits_w := ds_linked_kits_w || '<br>';
        end if;

        ds_linked_kits_w := ds_linked_kits_w || r_kits.ds_kit_material;
    end loop;

    return ds_linked_kits_w;
    end;
	
	function verifyDoubleCheckItem(	ie_double_check_w in varchar2) return varchar2 is

	begin

		ds_class_tag_w := 'adep';

		ds_retorno_tag_w := '</div><div class="legend-cell-status-text-' || ds_class_tag_w ||'" style="cursor: default; flex-wrap: wrap;">
                <div class="legend-cell-content-tag-' || ds_class_tag_w ||'" style="cursor: default;">';

		ds_retorno_tag_w := ds_retorno_tag_w || '<div class="legend-cell-tag-adep" style="background-color: #97B326; cursor: default; margin-top: 4px;"</div>';
		
		if (ie_double_check_w = 'S') then
			ds_retorno_tag_w :=  ds_retorno_tag_w || obter_desc_expressao_idioma(729215, null, wheb_usuario_pck.get_nr_seq_idioma)
			|| ' </div>
              </div>';
		else
			ds_retorno_tag_w := null;
		end if;

		return ds_retorno_tag_w;
	end;

begin
ds_param17_w := obter_param_usuario(2314, 17, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ds_param17_w);
ds_param19_w := obter_param_usuario(2314, 19, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ds_param19_w);
ds_param567_w := obter_param_usuario(1113, 567, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ds_param567_w);
ds_param567_w := obter_param_usuario(1113, 567, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ds_param567_w);
ds_param181_w := obter_param_usuario(1113, 181, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ds_param181_w);

ds_indentific_mat_w := 'class='''||'DS_MAT_IDENTIFIC'||''''; -- NAO REMOVER - Verfificar OS: 979988
--ds_indentific_mat := '<div class='''||'DS_MAT_IDENTIFIC'||'''>'; -- NAO REMOVER - Verfificar OS: 979988
cd_intervalo_w := cd_intervalo_p;
--Buscar a descricao do material conforme parametro
if (ds_medic_nao_padrao_p IS NOT NULL AND ds_medic_nao_padrao_p::text <> '') then
	ds_material_w := substr(ds_medic_nao_padrao_p, 1, 80);
elsif ((cd_material_p IS NOT NULL AND cd_material_p::text <> '') and ds_param17_w = 'S') then
	ds_material_w := coalesce(Obter_Desc_Redu_Material(cd_material_p), substr(obter_desc_material(cd_material_p),1,80));
else
	ds_material_w := substr(obter_desc_material(cd_material_p),1,80);
end if;

if (nr_seq_ataque_p IS NOT NULL AND nr_seq_ataque_p::text <> '') or (nr_seq_adicional_p IS NOT NULL AND nr_seq_adicional_p::text <> '') then
	cd_intervalo_w := null;
end if;

--verifica quais valores serem apresentados para o usuario
if (coalesce(ie_adep_p, 'N') = 'S' and (ds_material_w IS NOT NULL AND ds_material_w::text <> '')) then
	begin
	if ((ds_titulo_p IS NOT NULL AND ds_titulo_p::text <> '') and ds_param567_w = 'S') then
		ds_material_w := ds_titulo_p;
	end if;
	ds_retorno_w :=
		bold(ds_material_w) ||
        regra_medic_comerc_simil(cd_material_p) ||
        cpoe_add_span( adep_dose_unidade_medida(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p)) ||
		cpoe_add_span(obter_dose_diaria(qt_dose_dia_p, ds_dose_diferenciada_p, cd_unidade_medida_p)) ||
		cpoe_add_span(obter_desc_via(ie_via_aplicacao_p)) ||
		cpoe_add_span(Obter_desc_interv_prescr(cd_intervalo_w)) ||
		cpoe_add_span(ds_horarios_p) ||
		cpoe_add_span(obter_tipo_solucao) ||
		cpoe_obter_sigla_tipo_adm(ie_administracao_p) || obter_tipo_item ||
		cpoe_add_span(obter_etapas_item) ||
		cpoe_add_span(get_dose_description(ds_dose_diferenciada_p,'N'));

	if (ds_calc_therap_dose_p IS NOT NULL AND ds_calc_therap_dose_p::text <> '') then
		ds_retorno_w := ds_retorno_w || ' <br> ' || cpoe_add_span(obter_desc_expressao(325449, '') || ': ' ||ds_calc_therap_dose_p);
	end if;

	if (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then
		begin
			select	x.nr_sequencia_solucao,
				x.nr_prescricao
			into STRICT	nr_seq_sol_w,
				nr_prescricao_w
			from (
				SELECT	a.nr_sequencia_solucao,
					a.nr_prescricao
				from	prescr_material	a
				where	a.nr_seq_mat_cpoe = nr_seq_cpoe_p
				order by nr_prescricao desc)	x LIMIT 1;

		exception
		when others then
			nr_prescricao_w	:= null;
			nr_seq_sol_w	:= null;
		end;


		if (nr_seq_sol_w IS NOT NULL AND nr_seq_sol_w::text <> '' AND nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
			select	obter_desc_vol_etapa_adep2(nr_prescricao,nr_sequencia_solucao,ie_acm,ie_se_necessario)
			into STRICT	ds_vol_etapa_w
			from	prescr_material	a
			where	a.nr_seq_mat_cpoe 		= nr_seq_cpoe_p
			and	a.nr_prescricao			= nr_prescricao_w
			and	a.nr_sequencia_solucao	= nr_seq_sol_w  LIMIT 1;

			if (ds_vol_etapa_w IS NOT NULL AND ds_vol_etapa_w::text <> '') then
				ds_retorno_w := bold(ds_material_w);
                if (coalesce(ds_titulo_p::text, '') = '' or ds_param567_w = 'N') then
                    ds_retorno_w := ds_retorno_w || regra_medic_comerc_simil(cd_material_p);
                end if;
				if (ds_calc_therap_dose_p IS NOT NULL AND ds_calc_therap_dose_p::text <> '') then
					ds_retorno_w := ds_retorno_w || ' <br> ' || cpoe_add_span(obter_desc_expressao(325449, '') || ': ' ||ds_calc_therap_dose_p);
				 end if;
				 ds_retorno_w := ds_retorno_w ||
								cpoe_add_span(adep_dose_unidade_medida(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p)) ||
								cpoe_add_span(ds_vol_etapa_w);
			end if;
		end if;
	end if;

	ds_retorno_w := ds_retorno_w || valida_param_68_cpoe(ds_material_w);

	end;
elsif (coalesce(ds_titulo_p, 'XPTO') <> 'XPTO' and ds_param19_w = 'S') then
	begin
	ds_retorno_w :=
		bold(ds_titulo_p) ||
		cpoe_add_span(ie_via_aplicacao_p) ||
		cpoe_add_span(Obter_desc_interv_prescr(cd_intervalo_w)) ||
		cpoe_add_span(ds_horarios_p) ||
		cpoe_add_span(obter_tipo_solucao) ||
		cpoe_add_span(obter_desc_contagem_dias('N')) ||
		cpoe_obter_sigla_tipo_adm(ie_administracao_p) || obter_tipo_item || obter_se_item_oncologia(ie_oncologia_p) || cpoe_add_span(obter_desc_dias(nr_dia_util_p, dt_inicio_p, dt_fim_p, dt_suspensao_p, dt_lib_suspensao_p, ie_antibiotico_p))
		|| cpoe_add_span( get_dose_description(ds_dose_diferenciada_p,'N'))
		|| ' <br> ' ||
		cpoe_add_desc_item_param19() ||
		obter_alto_risco(cd_material_p) || obter_margem_terap_estreita(cd_material_p) ||
		obter_se_item_futuro(nr_seq_cpoe_p, ie_revalidacao_p) ||
		cpoe_add_span(obter_etapas_item) || tag_nao_padrozinado(wheb_usuario_pck.get_cd_estabelecimento, cd_material_p);

	ds_retorno_w := ds_retorno_w || valida_param_68_cpoe(ds_material_w);

	if (ie_cpoe_p = 'S') then
		ds_retorno_w := '<div class="cpoe_div_item_princ">' || ds_retorno_w || '</div>';
	end if;

	end;
elsif (ds_material_w IS NOT NULL AND ds_material_w::text <> '') then
	begin
	ds_retorno_w :=		
		bold(ds_material_w) ||
        regra_medic_comerc_simil(cd_material_p) ||
        cpoe_add_dose(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p) ||
        cpoe_add_span(obter_dose_diaria(qt_dose_dia_p, ds_dose_diferenciada_p, cd_unidade_medida_p) ) ||
		cpoe_add_span(get_dose_range_description(qt_dose_range_min_p, qt_dose_range_max_p, qt_dose_maxima_p, cd_unidade_medida_p, ie_dose_range_p)) ||
		cpoe_add_span(ie_via_aplicacao_p) ||
		cpoe_add_span(Obter_desc_interv_prescr(cd_intervalo_w)) ||
		cpoe_add_span(ds_horarios_p) ||
		cpoe_add_span(obter_tipo_solucao) ||
		cpoe_add_span(obter_desc_contagem_dias('N')) ||
		cpoe_obter_sigla_tipo_adm(ie_administracao_p) ||
		obter_tipo_item || obter_alto_risco(cd_material_p) || obter_se_item_oncologia(ie_oncologia_p) ||obter_margem_terap_estreita(cd_material_p) ||
		obter_se_item_futuro(nr_seq_cpoe_p, ie_revalidacao_p) ||
		cpoe_add_span(obter_desc_contagem_dias('S')) ||
		cpoe_add_span(obter_etapas_item) ||
		cpoe_add_span( get_dose_description(ds_dose_diferenciada_p,'N') ) || tag_nao_padrozinado(wheb_usuario_pck.get_cd_estabelecimento, cd_material_p);
	if (ds_calc_therap_dose_p IS NOT NULL AND ds_calc_therap_dose_p::text <> '') then
		ds_retorno_w := ds_retorno_w || ' <br> ' || cpoe_add_span(obter_desc_expressao(325449, '') || ': ' ||ds_calc_therap_dose_p);
	end if;

	ds_retorno_w := ds_retorno_w || valida_param_68_cpoe(ds_material_w);

	if (ie_cpoe_p = 'S') then
		ds_retorno_w := '<div class="cpoe_div_item_princ">' || ds_retorno_w || '</div>';
	end if;
	end;
end if;

if (coalesce(ie_adep_p, 'N') = 'N') then
	ds_retorno_w := ds_retorno_w || add_alternative_route(nr_seq_cpoe_p);

	if (ie_exibe_dil_p = 'S') then		
		if (cd_mat_dil_p IS NOT NULL AND cd_mat_dil_p::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_descricao_subitem( cd_mat_dil_p, qt_dose_dil_p, cd_unid_med_dose_dil_p, ds_dose_diferenciada_dil_p) || obter_alto_risco(cd_mat_dil_p) ||
				obter_margem_terap_estreita(cd_mat_dil_p) || cpoe_add_span(get_dose_description(ds_dose_diferenciada_dil_p,ds_param19_w,ie_tipo_item_p) || tag_nao_padrozinado(wheb_usuario_pck.get_cd_estabelecimento, cd_mat_dil_p))),1,1900);
		end if;
		if (cd_mat_red_p IS NOT NULL AND cd_mat_red_p::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_descricao_subitem( cd_mat_red_p, qt_dose_red_p, cd_unid_med_dose_red_p, ds_dose_diferenciada_red_p) || obter_alto_risco(cd_mat_red_p) ||
			obter_margem_terap_estreita(cd_mat_red_p) || cpoe_add_span(get_dose_description(ds_dose_diferenciada_red_p,ds_param19_w,ie_tipo_item_p)) || tag_nao_padrozinado(wheb_usuario_pck.get_cd_estabelecimento, cd_mat_red_p)),1,1900);
		end if;

		if (cd_mat_recons_p IS NOT NULL AND cd_mat_recons_p::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_descricao_subitem( cd_mat_recons_p, qt_dose_recons_p, cd_unid_med_dose_recons_p, ds_dose_diferenciada_rec_p) || obter_alto_risco(cd_mat_recons_p) ||
				obter_margem_terap_estreita(cd_mat_recons_p) || cpoe_add_span(get_dose_description(ds_dose_diferenciada_rec_p,ds_param19_w,ie_tipo_item_p)) || tag_nao_padrozinado(wheb_usuario_pck.get_cd_estabelecimento, cd_mat_recons_p)),1,1900);
		end if;
	end if;

	if (cd_mat_comp1_p IS NOT NULL AND cd_mat_comp1_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_descricao_subitem( cd_mat_comp1_p, qt_dose_comp1_p, cd_unid_med_dose_comp1_p, ds_dose_diferenciada_comp1_p) || obter_alto_risco(cd_mat_comp1_p) ||
			obter_margem_terap_estreita(cd_mat_comp1_p) || cpoe_add_span(get_dose_description(ds_dose_diferenciada_comp1_p,ds_param19_w,ie_tipo_item_p)) || tag_nao_padrozinado(wheb_usuario_pck.get_cd_estabelecimento, cd_mat_comp1_p)),1,1900);

		if (coalesce(ie_oncologia_p,'N') = 'S') then

			ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_desc_reconst_adic(1, nr_seq_cpoe_p, 'N', ds_param19_w, ie_tipo_item_p)),1,1900);
		end if;
	end if;

	if (cd_mat_comp2_p IS NOT NULL AND cd_mat_comp2_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_descricao_subitem( cd_mat_comp2_p, qt_dose_comp2_p, cd_unid_med_dose_comp2_p, ds_dose_diferenciada_comp2_p)),1,1900);

		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_desc_reconst_adic(2, nr_seq_cpoe_p, 'N', ds_param19_w, ie_tipo_item_p)),1,1900);
		end if;
	end if;

	if (cd_mat_comp3_p IS NOT NULL AND cd_mat_comp3_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_descricao_subitem( cd_mat_comp3_p, qt_dose_comp3_p, cd_unid_med_dose_comp3_p, ds_dose_diferenciada_comp3_p)),1,1900);

		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_desc_reconst_adic(3, nr_seq_cpoe_p, 'N', ds_param19_w, ie_tipo_item_p)),1,1900);
		end if;
	end if;

	if (cd_mat_comp4_p IS NOT NULL AND cd_mat_comp4_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_descricao_subitem( cd_mat_comp4_p, qt_dose_comp4_p, cd_unid_med_dose_comp4_p, ds_dose_diferenciada_comp4_p)),1,1900);

		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_desc_reconst_adic(4, nr_seq_cpoe_p, 'N', ds_param19_w, ie_tipo_item_p)),1,1900);
		end if;
	end if;

	if (cd_mat_comp5_p IS NOT NULL AND cd_mat_comp5_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_descricao_subitem( cd_mat_comp5_p, qt_dose_comp5_p, cd_unid_med_dose_comp5_p, ds_dose_diferenciada_comp5_p)),1,1900);

		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_desc_reconst_adic(5, nr_seq_cpoe_p, 'N', ds_param19_w, ie_tipo_item_p)),1,1900);
		end if;
	end if;

	if (cd_mat_comp6_p IS NOT NULL AND cd_mat_comp6_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_descricao_subitem( cd_mat_comp6_p, qt_dose_comp6_p, cd_unid_med_dose_comp6_p, ds_dose_diferenciada_comp6_p)),1,1900);

		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_desc_reconst_adic(6, nr_seq_cpoe_p, 'N', ds_param19_w, ie_tipo_item_p)),1,1900);
		end if;
	end if;

	if (cd_mat_comp7_p IS NOT NULL AND cd_mat_comp7_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_descricao_subitem( cd_mat_comp7_p, qt_dose_comp7_p, cd_unid_med_dose_comp7_p, ds_dose_diferenciada_comp7_p)),1,1900);

		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || add_div_item(obter_desc_reconst_adic(7, nr_seq_cpoe_p, 'N', ds_param19_w, ie_tipo_item_p)),1,1900);
		end if;
	end if;

	ds_retorno_w := substr(ds_retorno_w || cpoe_add_desc_item_comp(nr_seq_cpoe_p,ds_param19_w,ie_tipo_item_p,'N'),1,1900);	

else

	ie_exibe_dil_medic_w := Obter_Param_Usuario(1113, 41, Obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_exibe_dil_medic_w);
	
	ie_double_check_w := obter_se_medic_dupla_chec(cd_material_p, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w);

	if ((ds_titulo_p IS NOT NULL AND ds_titulo_p::text <> '') and ds_param567_w = 'S') then
		ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem( cd_material_p, qt_dose_p, cd_unidade_medida_p, ds_dose_diferenciada_p),1,1900);
	end if;

	ds_retorno_w := ds_retorno_w || add_alternative_route(nr_seq_cpoe_p);

	if (ie_exibe_dil_p = 'S' and (coalesce(ie_exibe_dil_medic_w,'N') = 'S' or ie_tipo_item_p <> 'M')) then
		if (cd_mat_dil_p IS NOT NULL AND cd_mat_dil_p::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem( cd_mat_dil_p, qt_dose_dil_p, cd_unid_med_dose_dil_p, ds_dose_diferenciada_dil_p),1,1900);
			ie_double_check_dil_w := obter_se_medic_dupla_chec(cd_mat_dil_p, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w);
		end if;
		if (cd_mat_red_p IS NOT NULL AND cd_mat_red_p::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem( cd_mat_red_p, qt_dose_red_p, cd_unid_med_dose_red_p, ds_dose_diferenciada_red_p),1,1900);
			ie_double_check_red_w := obter_se_medic_dupla_chec(cd_mat_red_p, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w);
		end if;

		if (cd_mat_recons_p IS NOT NULL AND cd_mat_recons_p::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem( cd_mat_recons_p, qt_dose_recons_p, cd_unid_med_dose_recons_p, ds_dose_diferenciada_rec_p),1,1900);
			ie_double_check_recons_w := obter_se_medic_dupla_chec(cd_mat_recons_p, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w);
		end if;
	end if;

	if (cd_mat_comp1_p IS NOT NULL AND cd_mat_comp1_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem( cd_mat_comp1_p, qt_dose_comp1_p, cd_unid_med_dose_comp1_p, ds_dose_diferenciada_comp1_p),1,1900);
		ie_dbcheck_mat_comp1_w := obter_se_medic_dupla_chec(cd_mat_comp1_p, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w);
		
		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || obter_desc_reconst_adic(1, nr_seq_cpoe_p,'S', null, null),1,1900);
		end if;
	end if;

	if (cd_mat_comp2_p IS NOT NULL AND cd_mat_comp2_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem( cd_mat_comp2_p, qt_dose_comp2_p, cd_unid_med_dose_comp2_p, ds_dose_diferenciada_comp2_p),1,1900);
		ie_dbcheck_mat_comp2_w := obter_se_medic_dupla_chec(cd_mat_comp2_p, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w);
		
		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || obter_desc_reconst_adic(2, nr_seq_cpoe_p,'S', null, null),1,1900);
		end if;
	end if;

	if (cd_mat_comp3_p IS NOT NULL AND cd_mat_comp3_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem( cd_mat_comp3_p, qt_dose_comp3_p, cd_unid_med_dose_comp3_p, ds_dose_diferenciada_comp3_p),1,1900);
		ie_dbcheck_mat_comp3_w := obter_se_medic_dupla_chec(cd_mat_comp3_p, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w);

		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || obter_desc_reconst_adic(3, nr_seq_cpoe_p,'S', null, null),1,1900);
		end if;
	end if;

	if (cd_mat_comp4_p IS NOT NULL AND cd_mat_comp4_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem( cd_mat_comp4_p, qt_dose_comp4_p, cd_unid_med_dose_comp4_p, ds_dose_diferenciada_comp4_p),1,1900);
		ie_dbcheck_mat_comp4_w := obter_se_medic_dupla_chec(cd_mat_comp4_p, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w);

		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || obter_desc_reconst_adic(4, nr_seq_cpoe_p,'S', null, null),1,1900);
		end if;
	end if;

	if (cd_mat_comp5_p IS NOT NULL AND cd_mat_comp5_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem( cd_mat_comp5_p, qt_dose_comp5_p, cd_unid_med_dose_comp5_p, ds_dose_diferenciada_comp5_p),1,1900);
		ie_dbcheck_mat_comp5_w := obter_se_medic_dupla_chec(cd_mat_comp5_p, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w);

		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || obter_desc_reconst_adic(5, nr_seq_cpoe_p,'S', null, null),1,1900);
		end if;
	end if;

	if (cd_mat_comp6_p IS NOT NULL AND cd_mat_comp6_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem( cd_mat_comp6_p, qt_dose_comp6_p, cd_unid_med_dose_comp6_p, ds_dose_diferenciada_comp6_p),1,1900);
		ie_dbcheck_mat_comp6_w := obter_se_medic_dupla_chec(cd_mat_comp6_p, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w);

		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || obter_desc_reconst_adic(6, nr_seq_cpoe_p,'S', null, null),1,1900);
		end if;
	end if;

	if (cd_mat_comp7_p IS NOT NULL AND cd_mat_comp7_p::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem( cd_mat_comp7_p, qt_dose_comp7_p, cd_unid_med_dose_comp7_p, ds_dose_diferenciada_comp7_p),1,1900);
		ie_dbcheck_mat_comp7_w := obter_se_medic_dupla_chec(cd_mat_comp7_p, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w);

		if (coalesce(ie_oncologia_p,'N') = 'S') then
			ds_retorno_w := substr(ds_retorno_w || obter_desc_reconst_adic(7, nr_seq_cpoe_p,'S', null, null),1,1900);
		end if;
	end if;

	ds_retorno_w := substr(ds_retorno_w || cpoe_add_desc_item_comp(nr_seq_cpoe_p,ds_param19_w,ie_tipo_item_p,'S'),1,1900);		

end if;

if (ie_tipo_item_p = 'M' and ie_exibir_dt_fim_p = 'S') then
	dt_fim_w := coalesce(dt_fim_p, dt_fim_cih_p);

	if (dt_fim_w IS NOT NULL AND dt_fim_w::text <> '') then
		ds_exp_termino_w := obter_desc_expressao_idioma(cd_expressao_p => 969106,
								ds_expressao_p => null,
								nr_seq_idioma_p => wheb_usuario_pck.get_nr_seq_idioma);
		ds_date_mask_w :=  pkg_date_formaters.localize_mask(ds_mask => 'short',
								    lang_tag => pkg_date_formaters.getUserLanguageTag(cd_estabelcimento_p => wheb_usuario_pck.get_cd_estabelecimento,
														      nm_usuario_p => wheb_usuario_pck.get_nm_usuario));
		ds_termina_em_w := pkg_date_formaters.to_varchar(date_p => dt_fim_w,
								 ds_mask => ds_date_mask_w,
								 ds_calendar => null);
		ds_retorno_w := substr(ds_retorno_w || ' ' || bold(ds_exp_termino_w || ' '  || ds_termina_em_w), 1, 1900);
	end if;
end if;

if (ie_cpoe_p = 'S') and (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then

	select	max(a.dt_start) dt_start,
		max(a.dt_end) dt_end
	into STRICT	dt_start_w,
		dt_end_w
	from	cpoe_susp_medication a
	where	a.nr_seq_mat_cpoe = nr_seq_cpoe_p
	and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(dt_reference_p, clock_timestamp())) <= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_end)
	and	coalesce(a.dt_inactive::text, '') = '';

	if (dt_start_w IS NOT NULL AND dt_start_w::text <> '') and (dt_end_w IS NOT NULL AND dt_end_w::text <> '') then
		ds_withheld_w := obter_desc_expressao_idioma(	cd_expressao_p => 1031464,
								ds_expressao_p => null,
								nr_seq_idioma_p => wheb_usuario_pck.get_nr_seq_idioma);

		ds_date_mask_w :=  pkg_date_formaters.localize_mask(ds_mask => 'short',
								    lang_tag => pkg_date_formaters.getUserLanguageTag(cd_estabelcimento_p => wheb_usuario_pck.get_cd_estabelecimento,
														      nm_usuario_p => wheb_usuario_pck.get_nm_usuario));
		ds_start_w :=	obter_desc_expressao_idioma(	cd_expressao_p => 863172,
								ds_expressao_p => null,
								nr_seq_idioma_p => wheb_usuario_pck.get_nr_seq_idioma) || ' ' ||
				pkg_date_formaters.to_varchar(	date_p => dt_start_w,
								ds_mask => ds_date_mask_w,
								ds_calendar => null);

		ds_end_w :=	obter_desc_expressao_idioma(	cd_expressao_p => 863183,
								ds_expressao_p => null,
								nr_seq_idioma_p => wheb_usuario_pck.get_nr_seq_idioma) || ' ' ||
				pkg_date_formaters.to_varchar(	date_p => dt_end_w,
								ds_mask => ds_date_mask_w,
								ds_calendar => null);

		ds_retorno_w := substr(ds_retorno_w || add_div_item(ds_withheld_w || ' '  || ds_start_w || ' '  || ds_end_w), 1, 1900);
	end if;
end if;

if ((dt_lib_suspensao_p IS NOT NULL AND dt_lib_suspensao_p::text <> '') and (dt_suspensao_p IS NOT NULL AND dt_suspensao_p::text <> '') and (dt_suspensao_p <=clock_timestamp()) and (coalesce(ie_adep_p, 'N') <> 'S') or ((coalesce(dt_lib_suspensao_p::text, '') = '') and (coalesce(dt_fim_cih_p,dt_fim_p) <= clock_timestamp()) and ie_cpoe_p = 'S')) or
	((coalesce(dt_lib_suspensao_p::text, '') = '') and (dt_fim_p < clock_timestamp()) and ie_adep_p = 'N' and cd_funcao_origem_p = 998) then

	if (ie_cpoe_p = 'S')then
		ds_retorno_w	:= '<div class="cpoe-item-suspenso">'||ds_retorno_w|| '</div>';
	else
		ds_retorno_w	:= '<del>'||ds_retorno_w|| '</del>';
	end if;

end if;

begin
    select b.IE_FORMATO_ADMINISTRACAO into STRICT IE_FORMATO_ADMINISTRACAO_w from cpoe_material a, via_aplicacao b
        where a.IE_VIA_APLICACAO = b.IE_VIA_APLICACAO and a.nr_sequencia = nr_seq_cpoe_p;
    exception
        when no_data_found then
        return ds_retorno_w;
end;
    if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then
        if (IE_FORMATO_ADMINISTRACAO_w = 'TD') then
        ds_retorno_w :=ds_retorno_w|| '(' || WHEB_MENSAGEM_PCK.get_texto(1153579) || ')';
        end if;
    end if;

if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then
        ds_retorno_w := ds_retorno_w || cpoe_ds_linked_kits(nr_seq_cpoe_p, ie_adep_p);
		ds_retorno_w := handle_material_name(cd_material_p, ds_retorno_w);
end if;

if ((ie_adep_p = 'S' or ie_tpm_p = 'S') AND nr_seq_procedimento_p IS NOT NULL AND nr_seq_procedimento_p::text <> '') then

ds_retorno_w := ds_retorno_w || obter_proc_assoc;

end if;

if (ie_adep_p = 'S' and (ie_dbcheck_mat_comp1_w = 'S' or
	ie_dbcheck_mat_comp2_w = 'S' or
	ie_dbcheck_mat_comp3_w = 'S' or
	ie_dbcheck_mat_comp4_w = 'S' or
	ie_dbcheck_mat_comp5_w = 'S' or
	ie_dbcheck_mat_comp6_w = 'S' or
	ie_dbcheck_mat_comp7_w = 'S' or
	ie_double_check_dil_w = 'S' or
	ie_double_check_red_w = 'S' or
	ie_double_check_recons_w= 'S' or
	ie_double_check_w = 'S')) then
	ds_retorno_w := ds_retorno_w || verifyDoubleCheckItem('S');
end if;

select	count(*)
into STRICT	rule_quantity_w
from	cpoe_regra_ator LIMIT 1;

if (rule_quantity_w > 0 and ie_cpoe_p = 'N') then
	ds_retorno_w := ds_retorno_w || get_order_interface(ie_tipo_item_p,nr_seq_cpoe_p);
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_desc_info_material ( cd_material_p bigint, cd_mat_comp1_p bigint, qt_dose_comp1_p bigint, cd_unid_med_dose_comp1_p text, cd_mat_comp2_p bigint, qt_dose_comp2_p bigint, cd_unid_med_dose_comp2_p text, cd_mat_comp3_p bigint, qt_dose_comp3_p bigint, cd_unid_med_dose_comp3_p text, cd_mat_dil_p bigint, qt_dose_dil_p bigint, cd_unid_med_dose_dil_p text, cd_mat_red_p bigint, qt_dose_red_p bigint, cd_unid_med_dose_red_p text, dt_liberacao_p timestamp default null, qt_dose_p bigint default null, cd_unidade_medida_p text default null, ie_via_aplicacao_p text default null, cd_intervalo_p text default null, dt_lib_suspensao_p timestamp default null, dt_suspensao_p timestamp default null, ie_administracao_p text default null, nr_seq_ataque_p cpoe_material.nr_seq_ataque%type default null, nr_seq_procedimento_p cpoe_material.nr_seq_procedimento%type default null, nr_seq_adicional_p cpoe_material.nr_seq_adicional%type default null, nr_seq_hemotherapy_p cpoe_material.nr_seq_hemoterapia%type default null, ds_dose_diferenciada_p text default null, ds_dose_diferenciada_dil_p text default null, ds_dose_diferenciada_red_p text default null, ds_dose_diferenciada_comp1_p text default null, ds_dose_diferenciada_comp2_p text default null, ds_dose_diferenciada_comp3_p text default null, cd_mat_comp4_p bigint default null, qt_dose_comp4_p bigint default null, cd_unid_med_dose_comp4_p text default null, ds_dose_diferenciada_comp4_p text default null, cd_mat_comp5_p bigint default null, qt_dose_comp5_p bigint default null, cd_unid_med_dose_comp5_p text default null, ds_dose_diferenciada_comp5_p text default null, cd_mat_comp6_p bigint default null, qt_dose_comp6_p bigint default null, cd_unid_med_dose_comp6_p text default null, ds_dose_diferenciada_comp6_p text default null, dt_inicio_p timestamp default null, dt_fim_p timestamp default null, dt_fim_cih_p timestamp default null, nr_dia_util_p bigint default null, ie_antibiotico_p text default null, ie_tipo_solucao_p text default null, cd_mat_comp7_p bigint default null, qt_dose_comp7_p bigint default null, cd_unid_med_dose_comp7_p text default null, ds_dose_diferenciada_comp7_p text default null, ie_oncologia_p text default 'N', cd_mat_recons_p bigint default null, qt_dose_recons_p bigint default null, cd_unid_med_dose_recons_p text default null, ds_dose_diferenciada_rec_p text default null, ds_titulo_p text default null, ie_duracao_p text default null, ie_ref_calculo_p cpoe_material.ie_ref_calculo%type default null, nr_etapas_p cpoe_material.nr_etapas%type default null, ie_controle_tempo_p text default null, qt_dias_solicitado_p bigint default null, qt_dias_liberado_p bigint default null, nr_atendimento_p bigint default null, ie_baixado_por_alta_p cpoe_material.ie_baixado_por_alta%type default null, dt_alta_medico_p cpoe_material.dt_alta_medico%type default null, ie_exibe_dil_p text default 'S', ie_adep_p text default 'N', nr_seq_cpoe_p bigint default null, ds_horarios_p text default null, ie_tipo_item_p text default null, ie_reset_atb_p text default null, nr_seq_cpoe_anterior_p bigint default null, ds_calc_therap_dose_p text default null, ie_exibir_dt_fim_p text default 'N', qt_final_concentration_p text default null, ie_um_final_conc_pca_p text default null, qt_dose_range_min_p bigint default null, qt_dose_range_max_p bigint default null, ie_dose_range_p text default 'N', ds_medic_nao_padrao_p cpoe_material.ds_medic_nao_padrao%type default null, ie_medicacao_paciente_p cpoe_material.ie_medicacao_paciente%type default null, ie_cpoe_p text default 'N', qt_dose_dia_p bigint default null, dt_reference_p timestamp default null, qt_dose_maxima_p bigint default null, dt_fim_grid_p timestamp default null, ie_revalidacao_p text default 'N', ie_tpm_p text default 'N', cd_funcao_origem_p text default null) FROM PUBLIC;

