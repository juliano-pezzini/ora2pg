-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_benef_sca ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_operadora_p pls_congenere.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


ie_abrangencia_w	pls_plano.ie_abrangencia%type;
ie_area_coberta_w	varchar(1)	:= 'N';

-- Verificar se o beneficiário possui SCA
C_sca CURSOR FOR
	SELECT	nr_seq_plano
	from	pls_sca_vinculo
	where	nr_seq_segurado	= nr_seq_segurado_p
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	clock_timestamp()		between	dt_inicio_vigencia and fim_dia(dt_fim_vigencia);

-- Área de atuação do SCA
C_area_sca CURSOR(nr_seq_plano_pc	pls_plano.nr_sequencia%type) FOR
	SELECT	cd_municipio_ibge,
		sg_estado,
		nr_seq_regiao
	from	pls_plano_area
	where	nr_seq_plano	= nr_seq_plano_pc;

-- Área de atuação da Operadora
C_area_oper CURSOR FOR
	SELECT	cd_municipio_ibge,
		sg_estado,
		nr_seq_regiao
	from	pls_cooperativa_area
	where	nr_seq_cooperativa	= nr_seq_operadora_p;
BEGIN

for r_c_sca_w in C_sca loop
	begin
		select	coalesce(ie_abrangencia,'X')
		into STRICT	ie_abrangencia_w
		from	pls_plano
		where	nr_sequencia	= r_c_sca_w.nr_seq_plano
		and	coalesce(ie_abrangencia_sca_intercambio,'S') = 'S';
	exception
	when others then
		ie_abrangencia_w := 'X';
	end;

	if (ie_abrangencia_w	= 'N') then
		ie_area_coberta_w	:= 'S';
	elsif (ie_abrangencia_w	<> 'N') and (ie_abrangencia_w	<> 'X') then
		for r_c_area_sca_w in C_area_sca(r_c_sca_w.nr_seq_plano) loop
			for r_c_area_oper_w in C_area_oper loop
				if (ie_abrangencia_w	= 'E') then
					if (r_c_area_sca_w.sg_estado = r_c_area_oper_w.sg_estado) then
						ie_area_coberta_w	:= 'S';
						exit;
					end if;
				elsif (ie_abrangencia_w	= 'M') then
					if (r_c_area_sca_w.cd_municipio_ibge = r_c_area_oper_w.cd_municipio_ibge) then
						ie_area_coberta_w	:= 'S';
						exit;
					end if;
				elsif (ie_abrangencia_w	= 'GM') then
					if (r_c_area_sca_w.nr_seq_regiao = r_c_area_oper_w.nr_seq_regiao) then
						ie_area_coberta_w	:= 'S';
						exit;
					elsif (pls_obter_se_mun_uf_regiao(r_c_area_sca_w.cd_municipio_ibge, null, r_c_area_oper_w.nr_seq_regiao) = 'S') then
						ie_area_coberta_w	:= 'S';
						exit;
					elsif (pls_obter_se_mun_uf_regiao(r_c_area_oper_w.cd_municipio_ibge, null, r_c_area_sca_w.nr_seq_regiao) = 'S') then
						ie_area_coberta_w	:= 'S';
						exit;
					elsif (pls_obter_se_municipio_em_uf(r_c_area_sca_w.cd_municipio_ibge, r_c_area_oper_w.sg_estado)	= 'S') then
						ie_area_coberta_w	:= 'S';
						exit;
					elsif (pls_obter_se_municipio_em_uf(r_c_area_oper_w.cd_municipio_ibge, r_c_area_sca_w.sg_estado)	= 'S') then
						ie_area_coberta_w	:= 'S';
						exit;
					end if;
				end if;
			end loop;
		end loop;
	end if;
end loop;

return	ie_area_coberta_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_benef_sca ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_operadora_p pls_congenere.nr_sequencia%type) FROM PUBLIC;

