-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION qt_obter_taxa_mapa_ocup ( dt_parametro_p timestamp, nr_seq_agrup_p bigint, cd_estab_p bigint) RETURNS bigint AS $body$
DECLARE


qt_marcados_w	double precision;
qt_total_w	double precision;
qt_tempo_w	bigint;
qt_tempo_ww	varchar(10);
ds_retorno_w	double precision := 0;


BEGIN

if (dt_parametro_p IS NOT NULL AND dt_parametro_p::text <> '') then
	select	obter_valor_param_usuario(865,3,obter_perfil_ativo,obter_usuario_ativo,obter_estabelecimento_ativo)
	into STRICT	qt_tempo_ww
	;

	if (qt_tempo_ww IS NOT NULL AND qt_tempo_ww::text <> '') then
		qt_tempo_w	:= (qt_tempo_ww)::numeric;
	else
		qt_tempo_w	:= 15;
	end if;

	select	sum(obter_min_entre_datas(dt_agenda,(dt_agenda + (nr_minuto_duracao/1440)),1)) / coalesce(qt_tempo_w,15)
	into STRICT	qt_marcados_w
	from 	agenda_quimio
	where 	trunc(dt_agenda) 	= trunc(dt_parametro_p)
	and	ie_status_agenda	<> 'C'
	and (nr_seq_local 		= coalesce(nr_seq_agrup_p,0) or coalesce(nr_seq_agrup_p,0) = 0)
	and (cd_estabelecimento 	= coalesce(cd_estab_p,0) 	or coalesce(cd_estab_p,0) 	 = 0);

	select 	sum(obter_min_entre_datas(a.hr_inicial,a.hr_final,1) / 30)
	into STRICT	qt_total_w
	from   	qt_local_turno a,
		qt_local b
	where  	b.nr_sequencia 		= a.nr_seq_local
	and (b.nr_sequencia 	= coalesce(nr_seq_agrup_p,0) or coalesce(nr_seq_agrup_p,0) = 0)
	and (b.cd_estabelecimento 	= coalesce(cd_estab_p,0) 	or coalesce(cd_estab_p,0) 	 = 0)
	and	((dt_dia_semana 	= obter_cod_dia_semana(dt_parametro_p)) or ((dt_dia_semana = 9) and (obter_cod_dia_semana(dt_parametro_p) not in (7,1))))
	and	((CASE WHEN obter_se_feriado(b.cd_estabelecimento,dt_parametro_p)=0 THEN 'N'  ELSE 'S' END  <> 'S' and
		coalesce(ie_feriado,'N') = 'N') or (coalesce(ie_feriado, 'N') = 'S' and CASE WHEN obter_se_feriado(b.cd_estabelecimento,dt_parametro_p)=0 THEN 'N'  ELSE 'S' END  = 'S'));

	if (coalesce(qt_marcados_w,0) > 0) and (coalesce(qt_total_w,0) > 0) then
		select	round(((coalesce(qt_marcados_w,0) / coalesce(qt_total_w,0)) * 100),2)
		into STRICT	ds_retorno_w
		;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION qt_obter_taxa_mapa_ocup ( dt_parametro_p timestamp, nr_seq_agrup_p bigint, cd_estab_p bigint) FROM PUBLIC;

