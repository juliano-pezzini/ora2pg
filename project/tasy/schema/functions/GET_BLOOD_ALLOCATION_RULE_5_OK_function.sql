-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_blood_allocation_rule_5_ok (nr_seq_mensagem_p bigint, nr_seq_producao_p bigint) RETURNS bigint AS $body$
DECLARE


ie_retorno_w    bigint := 0;
qt_exame_w bigint := 0;
qt_exame_reserv_w san_reserva_prod.NR_SEQ_PRODUCAO%type := 0;

C01 CURSOR FOR
    SELECT nr_sequencia from san_exame where CD_TIPO_RESULTADO = 10053;

c01_w           c01%rowtype;

BEGIN
    OPEN c01;
    LOOP
        FETCH c01 INTO c01_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
        BEGIN
            IF ( nr_seq_mensagem_p = 1 ) THEN
                SELECT
                    COUNT(c.nr_seq_exame)
                INTO STRICT qt_exame_w
                FROM
                    san_producao         a,
                    san_exame_lote       b,
                    san_exame_realizado  c
                WHERE
                        a.nr_sequencia = nr_seq_producao_p
                    AND a.nr_sequencia = b.nr_seq_producao
                    AND c.nr_seq_exame_lote = b.nr_sequencia
                    AND c.nr_seq_exame = c01_w.nr_sequencia
                    AND (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
                    AND ( c.cd_exp_resultado = 291833
                          OR coalesce(c.cd_exp_resultado::text, '') = '' );

                IF ( qt_exame_w > 0 ) THEN
                    ie_retorno_w := ie_retorno_w + 1;
                ELSIF ( qt_exame_w = 0 ) THEN
                    SELECT
                        COUNT(c.nr_seq_exame)
                    INTO STRICT qt_exame_reserv_w
                    FROM
                        san_reserva_prod     a,
                        san_exame_lote       b,
                        san_exame_realizado  c
                    WHERE
                            a.nr_seq_producao = nr_seq_producao_p
                        AND a.nr_sequencia = b.nr_seq_res_prod
                        AND c.nr_seq_exame_lote = b.nr_sequencia
                        AND c.nr_seq_exame = c01_w.nr_sequencia
                        AND (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
                        AND ( c.cd_exp_resultado = 291833
                              OR coalesce(c.cd_exp_resultado::text, '') = '' );

                    IF ( qt_exame_reserv_w > 0 ) THEN
                        ie_retorno_w := ie_retorno_w + 1;
                    END IF;
                END IF;

            ELSIF ( nr_seq_mensagem_p = 2 ) THEN
                SELECT
                    COUNT(c.nr_seq_exame)
                INTO STRICT qt_exame_w
                FROM
                    san_producao         a,
                    san_exame_lote       b,
                    san_exame_realizado  c
                WHERE
                        a.nr_sequencia = nr_seq_producao_p
                    AND a.nr_sequencia = b.nr_seq_producao
                    AND c.nr_seq_exame_lote = b.nr_sequencia
                    AND c.nr_seq_exame = c01_w.nr_sequencia
                    AND (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
                    and c.cd_exp_resultado = 291820;

                IF ( qt_exame_w > 0 ) THEN
                    ie_retorno_w := ie_retorno_w + 1;
                ELSIF ( qt_exame_w = 0 ) THEN
                    SELECT
                        COUNT(c.nr_seq_exame)
                    INTO STRICT qt_exame_reserv_w
                    FROM
                        san_reserva_prod     a,
                        san_exame_lote       b,
                        san_exame_realizado  c
                    WHERE
                            a.nr_seq_producao = nr_seq_producao_p
                        AND a.nr_sequencia = b.nr_seq_res_prod
                        AND c.nr_seq_exame_lote = b.nr_sequencia
                        AND c.nr_seq_exame = c01_w.nr_sequencia
                        AND (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
                        and c.cd_exp_resultado = 291820;

                    IF ( qt_exame_reserv_w > 0 ) THEN
                        ie_retorno_w := ie_retorno_w + 1;
                    END IF;
                END IF;

            END IF;

        END;

    END LOOP;

    CLOSE c01;
    RETURN ie_retorno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_blood_allocation_rule_5_ok (nr_seq_mensagem_p bigint, nr_seq_producao_p bigint) FROM PUBLIC;

