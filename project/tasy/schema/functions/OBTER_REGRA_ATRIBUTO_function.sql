-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_atributo (cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, nm_tabela_p text, nm_atributo_p text, ie_regra_p text, ds_regra_p text, nr_seq_regra_p bigint, nr_seq_visao_p bigint, cd_funcao_p bigint, dt_executavel_p timestamp DEFAULT null, cd_setor_atendimento_p bigint DEFAULT null) RETURNS varchar AS $body$
DECLARE



-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--		C U I D A D O    A O  A L T E R A R   E S T A  F U N C T I O N
-- SE  FOR  ADICIONAR  UM NOVO PARÂMETRO DE RETORNO DEVE-SE SINCRONIZAR A ALTERAÇÂO COM O JAVA
-- O DBPanel do JAVA CONTEM UM TRATAMENTO FIXO PELO NÙMERO DE PARÂMETROS DE RETORNO PARA GARANTIR O FUNCIONAMENTO
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
/* o campo ds_regra por enquanto não é utilizado */

ie_tabstop_w	varchar(255);
ie_readonly_w	varchar(1);
ie_enable_w		varchar(255);
qt_seq_inicio_w	bigint;
ie_obrigatorio_w	varchar(255);
ie_nullable_w	varchar(255);
vl_default_w	varchar(2000);
qt_registro_w	bigint	:= 0;
ie_sequence_w	varchar(255);
ds_retorno_w	varchar(4000);
cd_perfil_w		bigint;
cd_funcao_w		bigint;
ie_repetir_valor_w	varchar(255);
ie_padrao_nulo_w	varchar(255);
vl_minimo_w		double precision;
vl_maximo_w		double precision;
vl_minimo_permitido_w	double precision;
vl_maximo_permitido_w	double precision;
ds_regra_w		varchar(100);
ds_versao_w		varchar(10);
ie_gerar_log_w		varchar(1);
nr_tabstop_w            varchar(4);
cd_setor_atendimento_w	integer;
nr_sequencia_w		bigint;

C01 CURSOR FOR
	SELECT	coalesce(ie_tabstop, ie_tabStop_w),
			coalesce(ie_enable, ie_enable_w),
			coalesce(ie_obrigatorio, ie_obrigatorio_w),
			coalesce(vl_default, vl_default_w),
			coalesce(ie_repetir_valor, 'N'),
			coalesce(ie_padrao_nulo,'N'),
			vl_minimo,
			vl_maximo,
			vl_minimo_permitido,
			vl_maximo_permitido,
			CASE WHEN ie_readonly_w='S' THEN 'S'  ELSE coalesce(ie_readonly,'N') END ,
			ds_regra,
			ie_gerar_log,
			nr_tabstop,
			nr_sequencia
	FROM	tabela_atrib_regra
	WHERE 	nm_tabela 				= nm_tabela_p
	  AND 	nm_atributo 			= nm_atributo_p
	  AND   coalesce(cd_estabelecimento,cd_estabelecimento_p)		= cd_estabelecimento_p
AND	coalesce(cd_perfil, 			cd_perfil_w)		= cd_perfil_w
AND 	coalesce(cd_setor_atendimento, 	cd_setor_atendimento_w)	= cd_setor_atendimento_w
	  AND 	coalesce(cd_funcao, cd_funcao_w)	= cd_funcao_w
	  AND 	coalesce(nr_seq_visao, nr_seq_visao_p)  = nr_seq_visao_p
	  AND 	coalesce(nr_seq_regra_funcao, nr_seq_regra_p)  = nr_seq_regra_p
	  AND 	coalesce(nm_usuario_param, nm_usuario_p) 	= nm_usuario_p
	  AND	consiste_hor_regra_atrib(hr_inicio,hr_fim,ie_dia_semana) = 'S'
	ORDER BY coalesce(nm_usuario_param,'AAAAAAAA'),coalesce(cd_perfil,0),coalesce(cd_setor_atendimento,0),coalesce(cd_estabelecimento,0), coalesce(cd_funcao,0), coalesce(nr_seq_visao,0), coalesce(nr_seq_regra_funcao,0);

BEGIN
cd_funcao_w	:= coalesce(cd_funcao_p,0);
cd_perfil_w	:= coalesce(cd_perfil_p,0);
cd_setor_atendimento_w := coalesce(cd_setor_atendimento_p,0);
ds_retorno_w 	:= '';
ie_sequence_w	:= '';
ie_nullable_w	:= 'N';
ie_enable_w		:= 'S';
SELECT	coalesce(ie_tabstop,'S'),
		coalesce(ie_readonly,'N'),
		coalesce(ie_obrigatorio,'N'),
		vl_default,
		qt_seq_inicio
INTO STRICT
		ie_tabstop_w,
		ie_readonly_w,
		ie_obrigatorio_w,
		vl_default_w,
		qt_seq_inicio_w
FROM		tabela_atributo
WHERE 		nm_tabela 		= nm_tabela_p
  AND 		nm_atributo 		= nm_atributo_p;
IF (coalesce(nr_seq_visao_p,0) > 0) THEN
	SELECT		coalesce(MAX(ie_tabstop), 	ie_tabstop_w),
			coalesce(MAX(ie_readonly), 	ie_readonly_w),
			MAX(vl_padrao),
			coalesce(MAX(CASE WHEN ie_obrigatorio_w='S' THEN 'S'  ELSE ie_obrigatorio END ),ie_obrigatorio_w)
	INTO STRICT
			ie_tabstop_w,
			ie_readonly_w,
			vl_default_w,
			ie_obrigatorio_w
	FROM	Tabela_visao_atributo
	WHERE	nm_atributo 		= nm_atributo_p
	  AND	nr_sequencia		= nr_seq_visao_p;
END IF;
IF (ie_regra_p = 'T') OR (ie_regra_p = 'O') THEN
	SELECT coalesce(MAX(nullable),'S')
	INTO STRICT ie_nullable_w
	FROM user_tab_columns
	WHERE table_name 	= nm_tabela_p
	  AND column_name = nm_atributo_p;
END IF;
OPEN C01;
LOOP
	FETCH C01 INTO	ie_tabstop_w,
			ie_enable_w,
			ie_obrigatorio_w,
			vl_default_w,
			ie_repetir_valor_w,
			ie_padrao_nulo_w,
			vl_minimo_w,
			vl_maximo_w,
			vl_minimo_permitido_w,
			vl_maximo_permitido_w,
			ie_readonly_w,
			ds_regra_w,
			ie_gerar_log_w,
			nr_tabstop_w,
			nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		qt_registro_w	:= qt_registro_w + 1;
END LOOP;
CLOSE C01;
IF (nm_atributo_p = 'DT_ATUALIZACAO') AND (coalesce(vl_default_w::text, '') = '') THEN
	vl_default_w	:= 'SYSDATE';
END IF;
IF (nm_atributo_p = 'NM_USUARIO') AND (coalesce(vl_default_w::text, '') = '') THEN
	vl_default_w	:= nm_usuario_p;
END IF;
IF (qt_seq_inicio_w > 0) THEN
	ie_sequence_w	:= '@Sequence';
END IF;
IF (ie_nullable_w = 'N') THEN
	ie_obrigatorio_w	:= 'S';
END IF;
IF (ie_regra_p = 'V') THEN
	ds_retorno_w := vl_default_w;
ELSIF (ie_regra_p = 'S') THEN
	ds_retorno_w := ie_tabstop_w;
ELSIF (ie_regra_p = 'O') THEN
	ds_retorno_w := ie_obrigatorio_w;
ELSIF (ie_regra_p = 'E') THEN
	ds_retorno_w := ie_enable_w;
ELSIF (ie_regra_p = 'R') THEN
	ds_retorno_w := ie_readonly_w;
ELSIF (ie_regra_p = 'N') THEN
	ds_retorno_w := nr_sequencia_w;

ELSIF (ie_regra_p = 'M') AND (vl_minimo_w IS NOT NULL AND vl_minimo_w::text <> '') AND (vl_maximo_w IS NOT NULL AND vl_maximo_w::text <> '') THEN
	ds_retorno_w := vl_minimo_w || ';' || vl_maximo_w  || ';' ||
			vl_minimo_permitido_w || ';' || vl_maximo_permitido_w;
ELSIF (ie_regra_p = 'T') THEN
	IF (coalesce(dt_executavel_p::text, '') = '') then
		SELECT	SUBSTR(client_info,position('Versao=' in client_info)+7,LENGTH(client_info))
		INTO STRICT	ds_versao_w
		FROM	v$session
		WHERE	audsid = USERENV('sessionid');
	end if;

	IF	((dt_executavel_p >= TO_DATE('29/06/2010','dd/mm/yyyy')) OR
		((ds_versao_w >= '2.2.572') OR (coalesce(ds_versao_w::text, '') = ''))) THEN
		ds_retorno_w := 	substr(
					ie_tabstop_w || '|?&' ||
					ie_enable_w || '|?&' ||
			          	ie_obrigatorio_w || '|?&' ||
					coalesce(ie_repetir_valor_w,'N') || '|?&' ||
					coalesce(ie_padrao_nulo_w,'N') || '|?&' ||
					ie_readonly_w ||'|?&'||
					coalesce(ds_regra_w,' ') || '|?&' ||
					coalesce(vl_default_w || ie_sequence_w,'null') || '|?&' ||
					coalesce(ie_gerar_log_w, 'N') || '|?&' ||
					coalesce(nr_tabstop_w,'null'), 1, 4000);
	ELSE
		ds_retorno_w := 	substr(
					ie_tabstop_w || ',' ||
					ie_enable_w || ',' ||
		          		ie_obrigatorio_w || ',' ||
					coalesce(ie_repetir_valor_w,'N') || ',' ||
					coalesce(ie_padrao_nulo_w,'N') || ',' ||
					ie_readonly_w ||','||
					vl_default_w || ie_sequence_w, 1, 4000);
	END IF;
END IF;
RETURN ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_atributo (cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, nm_tabela_p text, nm_atributo_p text, ie_regra_p text, ds_regra_p text, nr_seq_regra_p bigint, nr_seq_visao_p bigint, cd_funcao_p bigint, dt_executavel_p timestamp DEFAULT null, cd_setor_atendimento_p bigint DEFAULT null) FROM PUBLIC;

