-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_agenda_2500 ( nr_seq_tratamento_pac_p bigint, nr_seq_modelo_p bigint, nr_seq_modelo_pac_p bigint, hr_horario_p timestamp, ie_dia_semana_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

/* 
ie_opcao_p 
M = Modelos 
I = Individual 
T = Treinamento 
*/
 
			 
ds_retorno_w	varchar(255);
ds_agenda_w	varchar(100);

 
C01 CURSOR FOR 
	SELECT	substr(obter_desc_agenda(a.cd_agenda),1,50) 
	from	rp_item_modelo_agenda a, 
		rp_pac_modelo_agendamento c, 
		rp_pac_modelo_agend_item d 
	where	a.nr_sequencia		= d.nr_seq_item_modelo 
	and	c.nr_sequencia		= d.nr_seq_modelo_pac 
	and	coalesce(d.dt_fim_tratamento::text, '') = '' 
	and	c.nr_seq_pac_reab	= nr_seq_tratamento_pac_p 
	and	a.nr_seq_modelo		= nr_seq_modelo_p 
	and	c.nr_sequencia		= nr_seq_modelo_pac_p 
	and	a.ie_dia_semana		= ie_dia_semana_p 
	and	to_char(a.hr_horario,'hh24:mi') = to_char( hr_horario_p,'hh24:mi');
	
C02 CURSOR FOR 
	SELECT	substr(OBTER_DESC_AGENDA(a.cd_agenda),1,90) ds_agenda 
	from	rp_pac_agend_individual a 
	where	a.nr_seq_pac_reab	= nr_seq_tratamento_pac_p 
	and	coalesce(a.dt_fim_tratamento::text, '') = '' 
	and	a.ie_dia_semana		= ie_dia_semana_p 
	and	to_char(a.dt_horario,'hh24:mi') = to_char( hr_horario_p,'hh24:mi');
					
C03 CURSOR FOR 
	SELECT	a.ds_curso 
	from  	tre_curso a, 
		tre_agenda b, 
		TRE_AGENDA_TURNO c, 
		TRE_INSCRITO d, 
		tre_evento e 
	where 	a.nr_sequencia	= b.nr_seq_curso 
	and	d.nr_seq_evento = e.nr_sequencia 
	and	e.nr_seq_agenda = b.nr_sequencia 
	and	e.dt_fim_real > clock_timestamp() 
	and	c.nr_seq_agenda_tre	= b.nr_sequencia 
	and	d.cd_pessoa_fisica	= substr(nr_seq_tratamento_pac_p,1,255) 
	and	c.ie_dia_semana	= ie_dia_semana_p 
	and	to_char(hr_inicial,'hh24:mi') = to_char( hr_horario_p,'hh24:mi')			 
	and ((hr_horario_p between c.dt_inicio_vigencia and fim_dia(c.dt_fim_vigencia)) or ((coalesce(c.dt_inicio_vigencia::text, '') = '') or (coalesce(c.dt_fim_vigencia::text, '') = '')));			

BEGIN 
ds_retorno_w := '';
if ((coalesce( nr_seq_tratamento_pac_p, 0) > 0) and (coalesce( nr_seq_modelo_p, 0) > 0) and (coalesce( nr_seq_modelo_pac_p, 0) > 0)) then 
	 
	begin 
	 
	if (ie_opcao_p = 'M') then 
		begin 
		open C01;
		loop 
		fetch C01 into	 
			ds_agenda_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			 
			ds_retorno_w	:= ds_retorno_w || ds_agenda_w || chr(13);
			 
			end;
		end loop;
		close C01;
		end;
	end if;
	if (ie_opcao_p = 'I') then 
		begin 
		open C02;
		loop 
		fetch C02 into	 
			ds_agenda_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			 
			ds_retorno_w	:= ds_retorno_w || ds_agenda_w || chr(13);
			 
			end;
		end loop;
		close C02;
		end;
	end if;
	if (ie_opcao_p = 'T') then 
		begin 
		open C03;
		loop 
		fetch C03 into 
			ds_agenda_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
			 
			ds_retorno_w	:= ds_retorno_w || ds_agenda_w || chr(13);
			 
			end;
		end loop;
		close C03;
		end;
	end if;
	 
	ds_retorno_w	:= substr(ds_retorno_w,1,length(ds_retorno_w)-1);
	end;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_agenda_2500 ( nr_seq_tratamento_pac_p bigint, nr_seq_modelo_p bigint, nr_seq_modelo_pac_p bigint, hr_horario_p timestamp, ie_dia_semana_p text, ie_opcao_p text) FROM PUBLIC;

