-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_regra_cor_orcamento (cd_classif_conta_p text, cd_conta_contabil_p text, ie_conta_inferior_p text, vl_variacao_p bigint, pr_variacao_p bigint, cd_estabelecimento_p bigint, ie_fundo_fonte_p bigint) RETURNS varchar AS $body$
DECLARE

/*
IE_FUNDO_FONTE

Fonte:	0
Fundo:	1

*/
pr_variacao_w		double precision;
vl_variacao_w		double precision;
cd_classif_conta_w		varchar(40);
cd_conta_contabil_w	varchar(20);
ds_cor_w			varchar(255);
ds_cor_fundo_w		varchar(255);
ds_cor_retorno_w		varchar(255);
ie_conta_inferior_w		varchar(1);
qt_reg_w			bigint;


BEGIN

pr_variacao_w			:= coalesce(abs(pr_variacao_p), 0);
vl_variacao_w			:= coalesce(abs(vl_variacao_p), 0);
cd_conta_contabil_w		:= coalesce(cd_conta_contabil_p, '0');
cd_classif_conta_w			:= coalesce(cd_classif_conta_p, 0);
ds_cor_retorno_w			:= '';
ie_conta_inferior_w			:= coalesce(ie_conta_inferior_p, 'N');

if ( pr_variacao_w <> 0 ) then
begin
	select sum(cont)
	into STRICT qt_reg_w
	from (
		SELECT	count(1) cont
		from	ctb_regra_orcamento
		where	cd_classif_conta = cd_classif_conta_w
		and ( pr_limite_acima < pr_variacao_w or (pr_limite_abaixo * -1) > pr_variacao_w )
		and	coalesce(ie_conta_inferior,'N')	= 'N'
	
union all

		SELECT	count(1) cont
		from	ctb_regra_orcamento
		where	coalesce(cd_classif_conta::text, '') = ''
		and ( pr_limite_acima < pr_variacao_w or (pr_limite_abaixo * -1) > pr_variacao_w )
		and	coalesce(ie_conta_inferior,'N')	= 'N' 
		 LIMIT 1) alias11;
end;
else
	qt_reg_w := 0;
end if;

if (qt_reg_w = 0) then
	begin

if ( pr_variacao_w <> 0 ) then
begin
	select	count(1)
	into STRICT	qt_reg_w
	from	ctb_regra_orcamento
	where	substr(ctb_obter_se_conta_classif_sup(cd_conta_contabil_w, cd_classif_conta),1,1) = 'S'
	and ( pr_limite_acima < pr_variacao_w	or (pr_limite_abaixo * -1)	> pr_variacao_w )
	and	coalesce(ie_conta_inferior, 'N')	= 'S'  LIMIT 1;
end;
else
	qt_reg_w := 0;
end if;

	if (qt_reg_w > 0) then
		ie_conta_inferior_w		:= 'S';
	end if;

	end;
end if;

if (qt_reg_w > 0) then
	begin

	if (ie_conta_inferior_w = 'N') then
		begin
		if (pr_variacao_w > 0) then

			select	coalesce(max(ds_cor), ''),
				coalesce(max(ds_cor_fundo), '')
			into STRICT	ds_cor_w,
				ds_cor_fundo_w
			from	ctb_regra_orcamento
			where	coalesce(cd_classif_conta, cd_classif_conta_w) = cd_classif_conta_w
			and	ie_conta_inferior		= 'N'
			and	cd_estabelecimento	= coalesce(cd_estabelecimento_p, cd_estabelecimento)
			and	pr_limite_acima = (
						SELECT	max(pr_limite_acima)
						from	ctb_regra_orcamento
						where	coalesce(cd_classif_conta, cd_classif_conta_w) = cd_classif_conta_w
						and	pr_limite_acima		<= pr_variacao_w
						and	ie_conta_inferior		= 'N'
						and	coalesce(vl_limite_acima, vl_variacao_w) <= vl_variacao_w
						and	cd_estabelecimento	= coalesce(cd_estabelecimento_p, cd_estabelecimento)
						);
		else

			select	coalesce(max(ds_cor), ''),
				coalesce(max(ds_cor_fundo), '')
			into STRICT	ds_cor_w,
				ds_cor_fundo_w
			from	ctb_regra_orcamento
			where	coalesce(cd_classif_conta, cd_classif_conta_w) = cd_classif_conta_w
			and	ie_conta_inferior	= 'N'
			and	cd_estabelecimento	= coalesce(cd_estabelecimento_p, cd_estabelecimento)
			and	pr_limite_abaixo	=	(
							SELECT	max(pr_limite_abaixo)
							from	ctb_regra_orcamento
							where	coalesce(cd_classif_conta, cd_classif_conta_w) = cd_classif_conta_w
							and	pr_limite_abaixo		<= (pr_variacao_w * -1)
							and	ie_conta_inferior		= 'N'
							and	coalesce(vl_limite_abaixo,(vl_variacao_w * -1)) <= (vl_variacao_w * -1)
							and	cd_estabelecimento	= coalesce(cd_estabelecimento_p, cd_estabelecimento)
						);
		end if;
		end;
	elsif (ie_conta_inferior_w = 'S') then
		begin
		if (pr_variacao_w > 0) then
			select	coalesce(max(ds_cor), ''),
				coalesce(max(ds_cor_fundo), '')
			into STRICT	ds_cor_w,
				ds_cor_fundo_w
			from	ctb_regra_orcamento
			where	substr(ctb_obter_se_conta_classif_sup(cd_conta_contabil_w, cd_classif_conta),1,1) = 'S'
			and	cd_estabelecimento	= coalesce(cd_estabelecimento_p, cd_estabelecimento)
			and	ie_conta_inferior	= 'S'
			and	pr_limite_acima	= (
							SELECT	max(pr_limite_acima)
							from	ctb_regra_orcamento
							where	substr(ctb_obter_se_conta_classif_sup(cd_conta_contabil_w, cd_classif_conta),1,1) = 'S'
							and	pr_limite_acima		<= pr_variacao_w
							and	ie_conta_inferior		= 'S'
							and	coalesce(vl_limite_acima,vl_variacao_w) <= vl_variacao_w
							and	cd_estabelecimento	= coalesce(cd_estabelecimento_p, cd_estabelecimento)
						);

		else
			select	coalesce(max(ds_cor), ''),
				coalesce(max(ds_cor_fundo), '')
			into STRICT	ds_cor_w,
				ds_cor_fundo_w
			from	ctb_regra_orcamento
			where	substr(ctb_obter_se_conta_classif_sup(cd_conta_contabil_w, cd_classif_conta),1,1) = 'S'
			and	cd_estabelecimento	= coalesce(cd_estabelecimento_p, cd_estabelecimento)
			and	ie_conta_inferior	= 'S'
			and	pr_limite_abaixo	= (
							SELECT	max(pr_limite_abaixo)
							from	ctb_regra_orcamento
							where	substr(ctb_obter_se_conta_classif_sup(cd_conta_contabil_w, cd_classif_conta),1,1) = 'S'
							and	pr_limite_abaixo		<= (pr_variacao_w * -1)
							and	ie_conta_inferior		= 'S'
							and	coalesce(vl_limite_abaixo,(vl_variacao_w * -1)) <= (vl_variacao_w * -1)
							and	cd_estabelecimento	= coalesce(cd_estabelecimento_p, cd_estabelecimento)
						);
		end if;
		end;
	end if;
	end;
end if;

if (ie_fundo_fonte_p = 0) then

	ds_cor_retorno_w	:= ds_cor_w || ';';
elsif (ie_fundo_fonte_p = 1) then

	ds_cor_retorno_w	:= ds_cor_fundo_w || ';';
end if;

return	ds_cor_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_regra_cor_orcamento (cd_classif_conta_p text, cd_conta_contabil_p text, ie_conta_inferior_p text, vl_variacao_p bigint, pr_variacao_p bigint, cd_estabelecimento_p bigint, ie_fundo_fonte_p bigint) FROM PUBLIC;

