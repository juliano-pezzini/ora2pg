-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_formula_med_laudo (nr_Seq_medida_p bigint) RETURNS varchar AS $body$
DECLARE


ds_formula_w		varchar(10000);
nr_seq_medida_w		bigint;
ds_medida_w		varchar(2000);

ie_formula_ok_w		numeric(20);
ds_formula_aux_w	varchar(10000);
ie_tamanho_w		numeric(20);
i			numeric(30);

nr_medida_w		bigint;


BEGIN

select 	ds_formula
into STRICT	ds_formula_w
from	medida_exame_laudo
where	nr_sequencia = nr_Seq_medida_p;

if (ds_formula_w IS NOT NULL AND ds_formula_w::text <> '') then

	ds_formula_w		:= replace(ds_formula_w, ';', ',');
	ie_formula_ok_w	:= position('@' in ds_formula_w);

	if (ie_formula_ok_w > 0) then
		ds_formula_aux_w 	:= ds_formula_w;
		while(position('@' in ds_formula_aux_w) > 0) loop
			ie_formula_ok_w := position('@' in ds_formula_aux_w);
			ie_tamanho_w := 0;

			for i in ie_formula_ok_w..length(ds_formula_aux_w) + 1 loop
				if	((substr(ds_formula_aux_w, i, 1) in (' ','/','*','+','-','(',')','@',',')) or (i = length(ds_formula_aux_w) + 1)) and
					(i > (ie_formula_ok_w + 1)) then
					ie_tamanho_w := i;
					exit;
				end if;
			end loop;

			begin
			nr_medida_w	:= to_number(substr(ds_formula_aux_w, ie_formula_ok_w + 1,
					ie_tamanho_w - (ie_formula_ok_w + 1)));
			exception
				when others then
					nr_medida_w	:= to_number(replace(substr(ds_formula_aux_w,
						ie_formula_ok_w + 1, ie_tamanho_w - (ie_formula_ok_w +  1)),',','.'));
			end;

			select	coalesce(max(ds_medida),null)
			into STRICT	ds_medida_w
			from	medida_exame_laudo
			where	nr_sequencia	= nr_medida_w;

			ds_formula_aux_w := replace((replace(ds_formula_aux_w, '@' || nr_medida_w, ds_medida_w)),' ','');
			ds_formula_w 	 := ds_formula_aux_w;

		end loop;
	end if;
end if;

return substr(ds_formula_w,1,2000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_formula_med_laudo (nr_Seq_medida_p bigint) FROM PUBLIC;

