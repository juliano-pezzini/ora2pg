-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_legenda_disp (nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


ie_sucesso_w varchar(1);
ie_disp_alta_w varchar(1);
dt_alta_w timestamp;
dt_retirada_w timestamp;
dt_retirada_prev_w timestamp;
ds_retorno_w varchar(2) := 'EA';

/*
AC - ADEP DISPOSITIVO - alta com dispositivo
AE -  ADEP DISPOSITIVO - a expirar
EX - ADEP DISPOSITIVO - expirado
SS - ADEP DISPOSITIVO - sem sucesso
EA - ADEP DISPOSITIVO - em andamento
*/
BEGIN

if (coalesce(nr_sequencia_p,0) > 0) then

		select	a.ie_sucesso,
			CASE WHEN a.ie_acao='A' THEN 'S'  ELSE 'N' END  ie_disp_alta,
			(select max(b.dt_alta) from atendimento_paciente b where b.nr_atendimento = a.nr_atendimento) dt_alta ,
			a.dt_retirada,
			a.dt_retirada_prev
		into STRICT	ie_sucesso_w,
			ie_disp_alta_w,
			dt_alta_w,
			dt_retirada_w,
			dt_retirada_prev_w
		from atend_pac_dispositivo a
		where a.nr_sequencia = nr_sequencia_p;

		if ((dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') and ie_disp_alta_w = 'S')  then
			ds_retorno_w := 'AC';
		elsif (coalesce(dt_retirada_w::text, '') = '' and (dt_retirada_prev_w IS NOT NULL AND dt_retirada_prev_w::text <> '') and dt_retirada_prev_w between clock_timestamp() and (clock_timestamp() + interval '3 days'/24)) then
			ds_retorno_w := 'AE';
		elsif (coalesce(dt_retirada_w::text, '') = '' and (dt_retirada_prev_w IS NOT NULL AND dt_retirada_prev_w::text <> '') and dt_retirada_prev_w < clock_timestamp()) then
			ds_retorno_w := 'EX';
		elsif (ie_sucesso_w = 'N') then
			ds_retorno_w := 'SS';
		elsif (coalesce(dt_retirada_w::text, '') = '')	 then
			ds_retorno_w := 'EA';
		end if;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_legenda_disp (nr_sequencia_p bigint) FROM PUBLIC;

