-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_proc_atend (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_procedimentos_w		varchar(255);WITH RECURSIVE cte AS (



BEGIN 
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
	SELECT LTRIM(DS_PROCEDIMENTO,', ') 
	into STRICT	ds_procedimentos_w 
	FROM ( 
	SELECT 	coalesce(SUBSTR(Obter_Desc_Prescr_Proc(c.CD_PROCEDIMENTO,c.IE_ORIGEM_PROCED,c.NR_SEQ_PROC_INTERNO),1,255), '') DS_PROCEDIMENTO, 
	row_number() over (ORDER BY coalesce(SUBSTR(Obter_Desc_Prescr_Proc(c.CD_PROCEDIMENTO,c.IE_ORIGEM_PROCED,c.NR_SEQ_PROC_INTERNO),1,255), '')) AS fila 
	FROM prescr_medica b, atendimento_paciente a, prescr_procedimento c
LEFT OUTER JOIN proc_interno m ON (c.NR_SEQ_PROC_INTERNO = M.NR_SEQUENCIA)
WHERE b.nr_atendimento = a.nr_atendimento AND a.nr_atendimento = nr_atendimento_p AND c.NR_PRESCRICAO = b.nr_prescricao AND SUBSTR(GEL_OBTER_ENVELOPE_EXAME(c.NR_SEQUENCIA,c.NR_PRESCRICAO,c.NR_SEQ_EXAME,'E'),1,10) IS NULL AND coalesce(M.IE_EXAME_GESTAO_ENTREGA,'S') = 'S'  AND coalesce(c.IE_SUSPENSO,'N')	<> 'S' AND (b.DT_LIBERACAO IS NOT NULL AND b.DT_LIBERACAO::text <> '') ORDER BY 1) alias16 WHERE fila = 1
  UNION ALL

 

BEGIN 
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
	SELECT c.ds_procedimentos_w || ', ' || LTRIM(DS_PROCEDIMENTO,', ') 
	into STRICT	ds_procedimentos_w 
	FROM ( 
	SELECT 	coalesce(SUBSTR(Obter_Desc_Prescr_Proc(c.CD_PROCEDIMENTO,c.IE_ORIGEM_PROCED,c.NR_SEQ_PROC_INTERNO),1,255), '') DS_PROCEDIMENTO, 
	row_number() over (ORDER BY coalesce(SUBSTR(Obter_Desc_Prescr_Proc(c.CD_PROCEDIMENTO,c.IE_ORIGEM_PROCED,c.NR_SEQ_PROC_INTERNO),1,255), '')) AS fila 
	FROM prescr_medica b, atendimento_paciente a, prescr_procedimento c
LEFT OUTER JOIN proc_interno m ON (c.NR_SEQ_PROC_INTERNO = M.NR_SEQUENCIA)
WHERE b.nr_atendimento = a.nr_atendimento AND a.nr_atendimento = nr_atendimento_p AND c.NR_PRESCRICAO = b.nr_prescricao AND SUBSTR(GEL_OBTER_ENVELOPE_EXAME(c.NR_SEQUENCIA,c.NR_PRESCRICAO,c.NR_SEQ_EXAME,'E'),1,10) IS NULL AND coalesce(M.IE_EXAME_GESTAO_ENTREGA,'S') = 'S'  AND coalesce(c.IE_SUSPENSO,'N')	<> 'S' AND (b.DT_LIBERACAO IS NOT NULL AND b.DT_LIBERACAO::text <> '') ORDER BY 1) JOIN cte c ON (c.fila = alias16.(fila-1))

) SELECT * FROM cte WHERE connect_by_isleaf = 1;
;
end if;
 
RETURN ds_procedimentos_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_proc_atend (nr_atendimento_p bigint) FROM PUBLIC;

