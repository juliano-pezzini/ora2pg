-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_valor_estrut_orc ( cd_estabelecimento_p bigint, cd_centro_custo_p bigint, nr_seq_estrutura_p bigint, nr_seq_mes_ref_p bigint, nr_seq_cenario_p bigint, ie_valor_p text, nm_atributo_p text, nm_usuario_p text) RETURNS bigint AS $body$
DECLARE


cd_conta_contabil_w		varchar(20);
cd_classif_centro_w		varchar(40);
cd_empresa_w			bigint;
ds_comando_w			varchar(4000);
ds_origem_w			varchar(4000);
ds_valores_w			varchar(4000);
i				integer;
ie_caracter_w			varchar(1);
ie_origem_valor_w		varchar(15);
ie_pos_par_esq_w		bigint;
ie_pos_par_dir_w		bigint;
inicial_w			integer;
nm_objeto_w			varchar(30);
vl_retorno_w			double precision;
vl_retorno_ww			varchar(255);
ds_retorno_w			varchar(500);


BEGIN

begin

select	cd_classificacao
into STRICT	cd_classif_centro_w
from	centro_custo
where	cd_centro_custo	= cd_centro_custo_p;

select	ds_origem,
	ie_origem_valor
into STRICT	ds_origem_w,
	ie_origem_valor_w
from	ctb_estrutura_orc
where	nr_sequencia	= nr_seq_estrutura_p;
exception when no_data_found then
	--'Falta informar a origem da estrutura');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(225449);
end;

if (ie_origem_valor_w = 'E') then

	/*Obs> Não se deve colocar espaço antes da cláusula Select(Motivo: Tratamento da obter_valor_dinamico_bv)*/

	ds_comando_w	:= 	substr(	'select	nvl(sum(' || nm_atributo_p || '), 0) ' ||
					' from	w_ctb_orcamento_vis a ' ||
					' where	a.nm_usuario		= :nm_usuario '||
					' and	a.cd_conta_contabil is null '||
					' and	a.cd_centro_custo	= :cd_centro_custo ' ||
					' and	a.nr_seq_estrutura	= :nr_seq_estrutura ', 1 , 4000);

elsif (ie_origem_valor_w = 'FR') then
	ds_comando_w	:= 	substr(	'select	nvl(sum(' || nm_atributo_p || '), 0) ' ||
					' from	w_ctb_orcamento_vis a ' ||
					' where	a.nm_usuario		= :nm_usuario '||
					' and	a.cd_centro_custo	= :cd_centro_custo ' ||
					' and	a.nr_seq_estrutura	= :nr_seq_estrutura ', 1 , 4000);

end if;

select	max(cd_empresa)
into STRICT	cd_empresa_w
from	ctb_mes_ref
where	nr_sequencia	= nr_seq_mes_ref_p;

vl_retorno_w		:= 0;
ds_origem_w		:= replace(ds_origem_w,' ','');
ds_valores_w		:= '';
cd_conta_contabil_w	:= '';

if (ie_origem_valor_w = 'FR') then
	begin
	ie_pos_par_esq_w	:= position('(' in ds_origem_w);
	nm_objeto_w		:= substr(ds_origem_w,1,ie_pos_par_esq_w-1);
	ds_valores_w		:= nm_objeto_w || '(';
	ds_origem_w		:= substr(ds_origem_w,ie_pos_par_esq_w+1,4000);
	ie_pos_par_dir_w	:= position(')' in ds_origem_w);
	ds_origem_w		:= substr(ds_origem_w,1,ie_pos_par_dir_w-1);

	end;
end if;

i			:= 1;
while(ds_origem_w IS NOT NULL AND ds_origem_w::text <> '') loop
	begin
		ie_caracter_w	:= substr(ds_origem_w,i,1);
		if (i > length(ds_origem_w))then
			begin
			exit;
			end;
		end if;	
		if (ie_caracter_w in ('+','-','/','*','(',')',',')) then
			begin
			i			:= i + 1;
			if (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') then
				begin

				if (ie_origem_valor_w = 'C') then
					begin
					vl_retorno_w	:= coalesce(ctb_obter_orc_centro_agrup(	cd_empresa_w,
											nr_seq_mes_ref_p,
											cd_estabelecimento_p,
											nr_seq_cenario_p,
											cd_centro_custo_p,
											cd_conta_contabil_w,
											ie_valor_p),0);
					end;
				elsif (ie_origem_valor_w in ('E','FR')) then
					vl_retorno_w := obter_valor_dinamico_bv(ds_comando_w, 'nm_usuario=' 		|| nm_usuario_p || ';' ||
					'cd_centro_custo=' 	|| cd_centro_custo_p || ';' ||
					'nr_seq_estrutura=' 	|| cd_conta_contabil_w, vl_retorno_w);

					vl_retorno_w	:= coalesce(vl_retorno_w,0);

				end if;

				ds_origem_w		:= substr(ds_origem_w,i,4000);

				vl_retorno_ww		:= substr(replace(to_char(vl_retorno_w), ',', '.'),1,255);
				if (vl_retorno_w < 0) then
					vl_retorno_ww		:= substr('(' || replace(to_char(vl_retorno_w), ',', '.') || ')',1,255);
				end if;
				ds_valores_w		:= substr(ds_valores_w || vl_retorno_ww || ie_caracter_w, 1, 4000);
				cd_conta_contabil_w	:= '';
				i			:= 1;

				end;
			end if;
			end;
		else
			begin
			cd_conta_contabil_w	:= cd_conta_contabil_w || ie_caracter_w;
			if (i = length(ds_origem_w)) and (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') then

				if (ie_origem_valor_w = 'C') then
					begin
					vl_retorno_w	:= coalesce(ctb_obter_orc_centro_agrup(	cd_empresa_w,
											nr_seq_mes_ref_p,
											cd_estabelecimento_p,
											nr_seq_cenario_p,
											cd_centro_custo_p,
											cd_conta_contabil_w,
											ie_valor_p),0);
					end;
				elsif (ie_origem_valor_w in ('E','FR')) then
					begin
					vl_retorno_w := obter_valor_dinamico_bv(ds_comando_w, 'nm_usuario=' 		|| nm_usuario_p || ';' ||
					'cd_centro_custo=' 	|| cd_centro_custo_p || ';' ||
					'nr_seq_estrutura=' 	|| cd_conta_contabil_w, vl_retorno_w);

					vl_retorno_w	:= coalesce(vl_retorno_w,0);
					end;
				end if;

				ds_origem_w		:= '';
				vl_retorno_ww		:= replace(to_char(vl_retorno_w), ',', '.');
				if (vl_retorno_w < 0) then
					vl_retorno_ww		:= '(' || replace(to_char(vl_retorno_w), ',', '.') || ')';
				end if;
				ds_valores_w		:= substr(ds_valores_w || vl_retorno_ww, 1, 4000);
				cd_conta_contabil_w	:= '';
			end if;
			i			:= i + 1;
			end;
		end if;
	end;
end loop;

vl_retorno_w	:= 0;

if (ie_origem_valor_w = 'M') then
	begin
	if (ie_valor_p	= 'O')and (coalesce(nr_seq_cenario_p::text, '') = '')then
		begin

		select	coalesce(max(qt_metrica_orc),0)
		into STRICT	vl_retorno_w
		from	centro_custo b,
			ctb_orcamento a
		where	a.cd_centro_custo		= b.cd_centro_custo
		and	a.cd_estabelecimento		= coalesce(cd_estabelecimento_p, a.cd_estabelecimento)
		and	a.cd_centro_custo		= cd_centro_custo_p
		and	a.nr_seq_mes_ref		= nr_seq_mes_ref_p
		and	(a.nr_seq_metrica IS NOT NULL AND a.nr_seq_metrica::text <> '');

		end;
	elsif (ie_valor_p	= 'R') then
		begin

		select	coalesce(max(qt_metrica_real),0)
		into STRICT	vl_retorno_w
		from	centro_custo b,
			ctb_metrica_real a
		where	a.cd_centro_custo		= b.cd_centro_custo
		and	a.cd_estabelecimento	= coalesce(cd_estabelecimento_p, a.cd_estabelecimento)
		and	a.cd_centro_custo		= cd_centro_custo_p
		and	a.nr_seq_mes_ref		= nr_seq_mes_ref_p
		and	(a.nr_seq_metrica IS NOT NULL AND a.nr_seq_metrica::text <> '');

		end;
	elsif (ie_valor_p	= 'O') and (nr_seq_cenario_p IS NOT NULL AND nr_seq_cenario_p::text <> '') 	 then
	      begin

		select	coalesce(max(a.qt_metrica),0)
		into STRICT	vl_retorno_w
		from	ctb_cen_metrica a
		where	a.cd_centro_custo		= cd_centro_custo_p
		and	a.cd_estabelecimento 		= coalesce(cd_estabelecimento_p, a.cd_estabelecimento)
		and	a.cd_centro_custo		= cd_centro_custo_p
		and	a.nr_seq_mes_ref		= nr_seq_mes_ref_p
		and	a.nr_seq_cenario		= nr_seq_cenario_p
		and	(a.nr_seq_metrica IS NOT NULL AND a.nr_seq_metrica::text <> '');

	      end;

	end if;

	end;
elsif (ie_origem_valor_w = 'TM') then
	begin

	select	coalesce(sum(CASE WHEN ie_valor_p='O' THEN  a.vl_ticket_medio_orc WHEN ie_valor_p='R' THEN  a.vl_ticket_medio_real END ),0)
	into STRICT	vl_retorno_w
	from	centro_custo b,
		ctb_orcamento a
	where	a.cd_centro_custo		= b.cd_centro_custo
	and	a.cd_estabelecimento	= coalesce(cd_estabelecimento_p, a.cd_estabelecimento)
	and	a.cd_centro_custo		= cd_centro_custo_p
	and	a.nr_seq_mes_ref		= nr_seq_mes_ref_p
	and	exists (	SELECT	1
			from	w_ctb_orcamento_vis y
			where	y.nm_usuario		= nm_usuario_p
			and	y.cd_centro_custo		= a.cd_centro_custo
			and	y.cd_conta_contabil	= a.cd_conta_contabil);

	end;
end if;
if (ie_origem_valor_w = 'FR') then
	ds_valores_w := ds_valores_w||')';
end if;

if (ds_valores_w IS NOT NULL AND ds_valores_w::text <> '') then
	vl_retorno_w := obter_valor_dinamico('select ' || ds_valores_w || ' from dual', vl_retorno_w);

end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_valor_estrut_orc ( cd_estabelecimento_p bigint, cd_centro_custo_p bigint, nr_seq_estrutura_p bigint, nr_seq_mes_ref_p bigint, nr_seq_cenario_p bigint, ie_valor_p text, nm_atributo_p text, nm_usuario_p text) FROM PUBLIC;

