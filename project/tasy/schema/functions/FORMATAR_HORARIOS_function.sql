-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION formatar_horarios (nr_prescricao_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE

ds_horarios_w           varchar(2000);
ds_horarios_aux_w       varchar(2000);
auxiliar_w                      varchar(2000);
dt_suspensao_w          varchar(2000);
dt_administrado_w       varchar(2000);
dt_hor_w		varchar(2000);
contador_w		bigint := 0;
posini_w                        bigint := 0;
posfim_w                        bigint := 0;
fim_hor_w                       bigint := 0;
contador_reverso_w      bigint := 0;
dt_fim_horario_w	timestamp;
dt_susp_w		timestamp;

c01 CURSOR FOR
SELECT  to_char(dt_horario,'hh24:mi'),
	dt_fim_horario,
	dt_suspensao
from    prescr_mat_hor
where   nr_prescricao   = nr_prescricao_p
and	nr_seq_material = nr_sequencia_p
and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';


BEGIN

select  max(ds_horarios)
into STRICT    ds_horarios_w
from    prescr_material
where   nr_sequencia	= nr_sequencia_p
and     nr_prescricao   = nr_prescricao_p;

open C01;
loop
fetch C01 into
	dt_hor_w,
	dt_fim_horario_w,
	dt_susp_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ds_horarios_w <> 'SN') and (ds_horarios_w <> 'ACM') then
		begin
		if (dt_susp_w IS NOT NULL AND dt_susp_w::text <> '') then
			ds_horarios_aux_w := ds_horarios_aux_w ||'#'||dt_hor_w ||'#S'||' ';
		elsif (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') then
			ds_horarios_aux_w := ds_horarios_aux_w||'#'||dt_hor_w ||'#K#P'||' ';
		else
			ds_horarios_aux_w := ds_horarios_aux_w||'#'||dt_hor_w||' ';
		end if;
		end;
	end if;

	end;
end loop;
close C01;

return ds_horarios_aux_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION formatar_horarios (nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

