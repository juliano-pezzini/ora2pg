-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_contrato_ressup ( cd_material_p bigint, cd_estabelecimento_p bigint, ie_opcao_p text ) RETURNS varchar AS $body$
DECLARE


/*ie_opcao_p
V - Valor do contrato
FM - Valor faturamento monimo
S - Sequencia do contrato
PJ - Codigo da pessoa juridica
NPJ - Nome da pessoa juridica
PF - Codigo da pessoa fisica
NPF - Nome da pessoa fisica
QTDE - Dias de entrega do contrato
*/
vl_total_contrato_w contrato.vl_total_contrato%type;
vl_fatur_minimo_w contrato.vl_fatur_minimo%type;
nr_sequencia_w contrato.nr_sequencia%type;
cd_cgc_contratado_w contrato.cd_cgc_contratado%type;
cd_pessoa_contratada_w contrato.cd_pessoa_contratada%type;
ds_razao_social_w pessoa_juridica.ds_razao_social%type;
nm_pessoa_contratada_w pessoa_fisica.nm_pessoa_fisica%type;
qt_dias_entrega_w  contrato_regra_nf.qt_dias_entrega%type;
vl_retorno_w varchar(255);


BEGIN

select max(b.nr_sequencia)
into STRICT   nr_sequencia_w
from   contrato_regra_nf a,
       contrato b
where  a.nr_seq_contrato = b.nr_sequencia
and    coalesce(a.cd_material, cd_material_p) = cd_material_p
and    substr(obter_dados_pf_pj(null,b.cd_cgc_contratado,'S'),1,1) = 'A'
and    ((coalesce(a.dt_inicio_vigencia::text, '') = '') or (trunc(a.dt_inicio_vigencia,'dd') <= trunc(clock_timestamp(),'dd')))
and    ((coalesce(a.dt_fim_vigencia::text, '') = '') or (trunc(a.dt_fim_vigencia,'dd') >= trunc(clock_timestamp(),'dd')))
and (coalesce(a.ie_situacao::text, '') = '' or a.ie_situacao = 'A')
and    coalesce(cd_pessoa_contratada::text, '') = ''
and    coalesce(b.ie_situacao,'A') = 'A'
and (trunc(b.dt_inicio) <= trunc(clock_timestamp()))
and    coalesce(trunc(b.dt_fim), trunc(clock_timestamp())) >= trunc(clock_timestamp())
and    coalesce(b.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p
and    ((coalesce(a.cd_estab_regra, cd_estabelecimento_p) = cd_estabelecimento_p)
        or (exists (	SELECT	1
			from	contrato_regra_nf_estab x
			where	x.cd_estab_regra = cd_estabelecimento_p
			and	x.nr_seq_regra_nf = a.nr_sequencia)));

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

        select  b.vl_total_contrato,
                b.cd_cgc_contratado,
                b.cd_pessoa_contratada,
                b.vl_fatur_minimo,
                coalesce(a.qt_dias_entrega,0)
        into STRICT    vl_total_contrato_w,
                cd_cgc_contratado_w,
                cd_pessoa_contratada_w,
                vl_fatur_minimo_w,
                qt_dias_entrega_w
        from    contrato_regra_nf a,
                contrato b where     a.nr_seq_contrato = b.nr_sequencia
        and     b.nr_sequencia = nr_sequencia_w
        and     coalesce(a.cd_material, cd_material_p) = cd_material_p
        and     ((coalesce(a.dt_inicio_vigencia::text, '') = '') or (trunc(a.dt_inicio_vigencia,'dd') <= trunc(clock_timestamp(),'dd')))
        and     ((coalesce(a.dt_fim_vigencia::text, '') = '') or (trunc(a.dt_fim_vigencia,'dd') >= trunc(clock_timestamp(),'dd')))
        and (coalesce(a.ie_situacao::text, '') = '' or a.ie_situacao = 'A')
        and     ((coalesce(a.cd_estab_regra, cd_estabelecimento_p) = cd_estabelecimento_p)
                  or (exists (	SELECT	1
				from	contrato_regra_nf_estab x
				where	x.cd_estab_regra = cd_estabelecimento_p
				and	x.nr_seq_regra_nf = a.nr_sequencia))) LIMIT 1;

        if (ie_opcao_p = 'V') and (vl_total_contrato_w > 0) then
                vl_retorno_w := vl_total_contrato_w;
        elsif (ie_opcao_p = 'FM') and (vl_fatur_minimo_w > 0) then
                vl_retorno_w := vl_fatur_minimo_w;
        elsif (ie_opcao_p = 'S') and (nr_sequencia_w > 0) then
                vl_retorno_w := nr_sequencia_w;
        elsif (ie_opcao_p = 'PJ') then
                vl_retorno_w := cd_cgc_contratado_w;
        elsif (ie_opcao_p = 'PF') then
                vl_retorno_w := cd_pessoa_contratada_w;
        elsif (ie_opcao_p = 'NPJ') then

                select obter_nome_pf_pj(null,cd_cgc_contratado_w)
                into STRICT   ds_razao_social_w
;

                vl_retorno_w := ds_razao_social_w;

        elsif (ie_opcao_p = 'NPF') then

                select obter_nome_pf_pj(cd_pessoa_contratada_w,null)
                into STRICT   nm_pessoa_contratada_w
;

                vl_retorno_w := nm_pessoa_contratada_w;
											
        elsif (ie_opcao_p = 'QTDE') then
                vl_retorno_w := qt_dias_entrega_w;
        end if;

end if;

return vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_contrato_ressup ( cd_material_p bigint, cd_estabelecimento_p bigint, ie_opcao_p text ) FROM PUBLIC;

