-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_pps ( dt_inicio_p timestamp, dt_final_p timestamp, cd_setor_p bigint, ie_sexo_p text, ie_faixa_p text, ie_tipo_atendimento_p bigint, ds_filtro_p text default null) RETURNS bigint AS $body$
DECLARE

 
nr_atendimento_w	bigint;
nr_seq_inicial_w	bigint;
nr_seq_ultimo_w		bigint;	
qt_avaliacao_inicial_w	double precision;
qt_avaliacao_ultima_w	double precision;
qt_total_inicial_w	double precision	:= 0;
qt_total_ultimo_w	double precision	:= 0;
qt_total_w		double precision	:= 0;

C01 CURSOR FOR 
	SELECT	distinct(a.nr_atendimento) 
	from	escala_pps a, 
		resumo_atendimento_paciente_v b, 
		pessoa_fisica c 
	where	a.nr_atendimento = b.nr_atendimento 
	and	b.cd_pessoa_fisica = c.cd_pessoa_fisica 
	and	coalesce(a.dt_inativacao::text, '') = '' 
	and	trunc(a.dt_avaliacao) between trunc(dt_inicio_p) and trunc(coalesce(dt_final_p,dt_inicio_p)) 
	and	b.cd_setor_atendimento = coalesce(cd_setor_p,b.cd_setor_atendimento) 
	and	c.ie_sexo = coalesce(ie_sexo_p,c.ie_sexo) 
	and	obter_idade(c.dt_nascimento,coalesce(c.dt_obito,clock_timestamp()),'E') = coalesce(ie_faixa_p,obter_idade(c.dt_nascimento,coalesce(c.dt_obito,clock_timestamp()),'E')) 
	and	b.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,b.ie_tipo_atendimento) 
	and	((	SELECT	count(*) 
			from	escala_pps x, 
				resumo_atendimento_paciente_v y, 
				pessoa_fisica z 
			where	x.nr_atendimento = y.nr_atendimento 
			and	y.cd_pessoa_fisica = z.cd_pessoa_fisica 
			and	x.nr_atendimento = a.nr_atendimento 
			and	trunc(x.dt_avaliacao) between trunc(dt_inicio_p) and trunc(coalesce(dt_final_p,dt_inicio_p)) 
			and	y.cd_setor_atendimento = coalesce(cd_setor_p,y.cd_setor_atendimento) 
			and	c.ie_sexo = coalesce(ie_sexo_p,c.ie_sexo) 
			and	obter_idade(z.dt_nascimento,coalesce(z.dt_obito,clock_timestamp()),'E') = coalesce(ie_faixa_p,obter_idade(z.dt_nascimento,coalesce(z.dt_obito,clock_timestamp()),'E')) 
			and	y.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,y.ie_tipo_atendimento) 
			and	coalesce(x.dt_inativacao::text, '') = '') >= 2) 
	order by a.nr_atendimento;
	

BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nr_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	min(nr_sequencia), 
		max(nr_sequencia) 
	into STRICT	nr_seq_inicial_w, 
		nr_seq_ultimo_w 
	from	escala_pps a, 
		resumo_atendimento_paciente_v b, 
		pessoa_fisica c 
	where	a.nr_atendimento = b.nr_atendimento 
	and	b.cd_pessoa_fisica = c.cd_pessoa_fisica 
	and	coalesce(a.dt_inativacao::text, '') = '' 
	and	trunc(a.dt_avaliacao) between trunc(dt_inicio_p) and trunc(coalesce(dt_final_p,dt_inicio_p)) 
	and	b.cd_setor_atendimento = coalesce(cd_setor_p,b.cd_setor_atendimento) 
	and	c.ie_sexo = coalesce(ie_sexo_p,c.ie_sexo) 
	and	obter_idade(c.dt_nascimento,coalesce(c.dt_obito,clock_timestamp()),'E') = coalesce(ie_faixa_p,obter_idade(c.dt_nascimento,coalesce(c.dt_obito,clock_timestamp()),'E')) 
	and	b.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,b.ie_tipo_atendimento) 
	and	a.nr_atendimento = nr_atendimento_w;
	 
	select	coalesce(qt_score,0) 
	into STRICT	qt_avaliacao_inicial_w	 
	from	escala_pps a, 
		atendimento_paciente b 
	where	a.nr_atendimento = b.nr_atendimento	 
	and	a.nr_sequencia = nr_seq_inicial_w;
	 
	select	coalesce(qt_score,0) 
	into STRICT	qt_avaliacao_ultima_w	 
	from	escala_pps a, 
		atendimento_paciente b 
	where	a.nr_atendimento = b.nr_atendimento	 
	and	a.nr_sequencia = nr_seq_ultimo_w;
	 
	qt_total_inicial_w 	:= qt_total_inicial_w + qt_avaliacao_inicial_w;
	qt_total_ultimo_w 	:= qt_total_ultimo_w + qt_avaliacao_ultima_w;
	 
	end;
end loop;
close C01;
 
qt_total_w	:= dividir((qt_total_ultimo_w - qt_total_inicial_w),100);	
 
return	qt_total_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_pps ( dt_inicio_p timestamp, dt_final_p timestamp, cd_setor_p bigint, ie_sexo_p text, ie_faixa_p text, ie_tipo_atendimento_p bigint, ds_filtro_p text default null) FROM PUBLIC;

