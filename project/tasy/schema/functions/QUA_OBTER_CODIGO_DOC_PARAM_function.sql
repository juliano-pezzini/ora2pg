-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION qua_obter_codigo_doc_param ( nr_seq_tipo_doc_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_sequencia_p bigint default null, cd_setor_resp_p bigint default null, nr_seq_loc_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(20);
ie_forma_codigo_doc_w		varchar(255);
ds_formato_codigo_doc_w		varchar(255);
ds_sigla_tipo_doc_w		varchar(20);
cd_documento_w			varchar(20);
ds_curta_setor_w			varchar(100);
ds_sigla_local_w			varchar(20);
qt_zeros_w			integer;


BEGIN
ie_forma_codigo_doc_w := obter_param_usuario(4000, 240, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_forma_codigo_doc_w);
ds_formato_codigo_doc_w := obter_param_usuario(4000, 241, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_formato_codigo_doc_w);

if (coalesce(ie_forma_codigo_doc_w,'N') <> 'N') and (coalesce(ds_formato_codigo_doc_w,'X') <> 'X') then
	begin
	if (ie_forma_codigo_doc_w = 'S') then
		begin
		select	substr(coalesce(max(somente_numero(a.cd_documento)),0) + 1,1,20)
		into STRICT	cd_documento_w
		from	qua_documento a
		where	a.nr_sequencia <> coalesce(nr_sequencia_p,0);
		end;
	elsif (ie_forma_codigo_doc_w = 'T') then
		begin
		if (coalesce(nr_seq_tipo_doc_p,0) > 0) then
			begin
			select	substr(coalesce(max(somente_numero(a.cd_documento)),0) + 1,1,20)
			into STRICT	cd_documento_w
			from	qua_documento a
			where	a.nr_seq_tipo = nr_seq_tipo_doc_p
			and	a.nr_sequencia <> coalesce(nr_sequencia_p,0);
			end;
		end if;
		end;
	elsif (ie_forma_codigo_doc_w = 'E') then
		begin
		if (coalesce(cd_estabelecimento_p,0) > 0) then
			begin
			select	substr(coalesce(max(somente_numero(a.cd_documento)),0) + 1,1,20)
			into STRICT	cd_documento_w
			from	qua_documento a
			where	a.cd_estabelecimento = cd_estabelecimento_p
			and	a.nr_sequencia <> coalesce(nr_sequencia_p,0);
			end;
		end if;
		end;
	elsif (ie_forma_codigo_doc_w = 'X') then
		begin
		if (coalesce(nr_seq_tipo_doc_p,0) > 0) and (coalesce(cd_estabelecimento_p,0) > 0) then
			begin
			select	substr(coalesce(max(somente_numero(a.cd_documento)),0) + 1,1,20)
			into STRICT	cd_documento_w
			from	qua_documento a
			where	a.nr_seq_tipo = nr_seq_tipo_doc_p
			and	a.cd_estabelecimento = cd_estabelecimento_p
			and	a.nr_sequencia <> coalesce(nr_sequencia_p,0);
			end;
		end if;
		end;
	elsif (ie_forma_codigo_doc_w = 'D') then
		begin
		if (coalesce(nr_sequencia_p,0) > 0) then
			begin
			cd_documento_w := nr_sequencia_p;
			end;
		end if;
		end;
	elsif (ie_forma_codigo_doc_w = 'O') then
		begin
		if (coalesce(nr_seq_tipo_doc_p,0) > 0) and (coalesce(cd_setor_resp_p,0) > 0) then
			begin
			select	substr(coalesce(max(somente_numero(a.cd_documento)),0) + 1,1,20)
			into STRICT	cd_documento_w
			from	qua_documento a
			where	a.nr_seq_tipo = nr_seq_tipo_doc_p
			and		a.cd_setor_atendimento = cd_setor_resp_p
			and		a.nr_sequencia <> coalesce(nr_sequencia_p,0);
			end;
		end if;
		end;
	end if;

	if (coalesce(cd_documento_w,'0') <> '0') then
		begin
		if (coalesce(nr_seq_tipo_doc_p,0) > 0) then
			begin
			select	ds_sigla_tipo_doc
			into STRICT	ds_sigla_tipo_doc_w
			from	qua_tipo_doc
			where	nr_sequencia = nr_seq_tipo_doc_p;
			exception
			when others then
				ds_sigla_tipo_doc_w := null;
			end;
		end if;

		if (coalesce(cd_setor_resp_p,0) > 0) then
			begin
			select	ds_descricao
			into STRICT	ds_curta_setor_w
			from	setor_atendimento
			where	cd_setor_atendimento = cd_setor_resp_p;
			exception
			when others then
				ds_curta_setor_w := null;
			end;
		end if;

		if (coalesce(nr_seq_loc_p,0) > 0) then
			begin
			select	ds_sigla
			into STRICT	ds_sigla_local_w
			from	qua_loc_doc
			where	nr_sequencia = nr_seq_loc_p;
			exception
			when others then
				ds_sigla_local_w := null;
			end;
		end if;

		ds_formato_codigo_doc_w := substr(replace(ds_formato_codigo_doc_w, '@sigla', ds_sigla_tipo_doc_w),1,255);
		ds_formato_codigo_doc_w := substr(replace(ds_formato_codigo_doc_w, '@ds_curta_setor', ds_curta_setor_w),1,255);
		ds_formato_codigo_doc_w := substr(replace(ds_formato_codigo_doc_w, '@sg_local', ds_sigla_local_w),1,255);

		if (position('@seqZerosEsq(' in ds_formato_codigo_doc_w) > 0) then
			begin
			qt_zeros_w 		:= substr(somente_numero(substr(ds_formato_codigo_doc_w,position('(' in ds_formato_codigo_doc_w) + 1,position(')' in ds_formato_codigo_doc_w) - (position('(' in ds_formato_codigo_doc_w) + 1))),1,5);
			cd_documento_w 		:= substr(coalesce(lpad(cd_documento_w,qt_zeros_w,0),1),1,20);

			ds_formato_codigo_doc_w := substr(replace(replace(ds_formato_codigo_doc_w, 'ZerosEsq(', ''), ')', ''),1,255);
			ds_formato_codigo_doc_w := substr(replace(ds_formato_codigo_doc_w,to_char(qt_zeros_w),''),1,255);
			ds_formato_codigo_doc_w := substr(replace(ds_formato_codigo_doc_w, '@seq', cd_documento_w),1,255);
			end;
		elsif (position('@seqZerosDir(' in ds_formato_codigo_doc_w) > 0) then
			begin
			qt_zeros_w 		:= substr(somente_numero(substr(ds_formato_codigo_doc_w,position('(' in ds_formato_codigo_doc_w) + 1,position(')' in ds_formato_codigo_doc_w) - (position('(' in ds_formato_codigo_doc_w) + 1))),1,5);
			cd_documento_w 		:= substr(coalesce(rpad(cd_documento_w,qt_zeros_w,0),1),1,20);

			ds_formato_codigo_doc_w := substr(replace(replace(ds_formato_codigo_doc_w, 'ZerosDir(', ''), ')', ''),1,255);
			ds_formato_codigo_doc_w := substr(replace(ds_formato_codigo_doc_w,to_char(qt_zeros_w),''),1,255);
			ds_formato_codigo_doc_w := substr(replace(ds_formato_codigo_doc_w, '@seq', cd_documento_w),1,255);
			end;
		else
			ds_formato_codigo_doc_w := substr(replace(ds_formato_codigo_doc_w, '@seq', cd_documento_w),1,255);
		end if;

		ds_retorno_w := substr(ds_formato_codigo_doc_w,1,20);
		exception
		when others then
			ds_retorno_w := null;
		end;
	end if;
	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION qua_obter_codigo_doc_param ( nr_seq_tipo_doc_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_sequencia_p bigint default null, cd_setor_resp_p bigint default null, nr_seq_loc_p bigint default null) FROM PUBLIC;

