-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_resumo_odontologia ( nr_seq_odont_consulta_p bigint, ie_tipo_p text) RETURNS varchar AS $body$
 -- P Procedimento - H Historico
DECLARE


	c01 CURSOR FOR
		SELECT	dt_procedimento,
				nr_seq_local,
				substr(obter_valor_dominio(8753,nr_seq_local),1,255) ds_local,
				nr_seq_dente,
				substr(obter_valor_dominio(8754,nr_seq_dente),1,255) ds_dente,
				nr_seq_face,
				substr(obter_valor_dominio(5099,nr_seq_face),1,255) ds_face,
				ie_raiz,
				substr(obter_desc_expressao(719927),1,255) ds_raiz_sim,
				nr_seq_sextante,
				substr(obter_valor_dominio(8755,nr_seq_sextante),1,255) ds_sext,
				nr_seq_arcada,
				substr(obter_valor_dominio(8757,nr_seq_arcada),1,255) ds_arcada,
				nr_seq_tratamento,
				substr(obter_valor_dominio(8758,nr_seq_tratamento),1,255) ds_tratamento,
				nr_seq_proc_interno,
				substr(Obter_Descricao_Procedimento(cd_procedimento,ie_origem_proced),1,255) ds_procedimento,
				qt_procedimento,
				ds_observacao
		from	odont_procedimento
		where	nr_seq_consulta = nr_seq_odont_consulta_p;

	c01_w c01%rowtype;

	c02 CURSOR FOR
		SELECT	dt_historico,
				nr_seq_local,
				substr(obter_valor_dominio(8753,nr_seq_local),1,255) ds_local,
				nr_seq_dente,
				substr(obter_valor_dominio(8754,nr_seq_dente),1,255) ds_dente,
				nr_seq_face,
				substr(obter_valor_dominio(5099,nr_seq_face),1,255) ds_face,
				ie_raiz,
				substr(obter_desc_expressao(719927),1,255) ds_raiz_sim,
				nr_seq_sextante,
				substr(obter_valor_dominio(8755,nr_seq_sextante),1,255) ds_sext,
				nr_seq_arcada,
				substr(obter_valor_dominio(8757,nr_seq_arcada),1,255) ds_arcada,
				nr_seq_tratamento,
				substr(obter_valor_dominio(8758,nr_seq_tratamento),1,255) ds_tratamento,
				ie_status_area,
				substr(obter_valor_dominio(8762,IE_STATUS_AREA),1,255) ds_status_area,
				ds_observacao
		from	odont_historico
		where 	nr_seq_consulta = nr_seq_odont_consulta_p;

	c02_w c02%rowtype;

	ds_lbl_local_odonto_w	varchar(255);
	ds_lbl_dente_w			varchar(255);
	ds_lbl_face_w			varchar(255);
	ds_lbl_raiz_dente_w		varchar(255);
	ds_lbl_sextante_w		varchar(255);
	ds_lbl_arcada_w			varchar(255);
	ds_lbl_tratamento_w		varchar(255);
	ds_lbl_dt_proc_w		varchar(255);
	ds_lbl_procedimento_w	varchar(255);
	ds_lbl_quantidade_w		varchar(255);
	ds_lbl_observacao_w		varchar(255);
	ds_lbl_dt_hist_w		varchar(255);
	ds_lbl_caracteristica_w	varchar(255);

	retorno_w	varchar(4000) := '';

	quebra_linha_w	varchar(50) := chr(13) || chr(10);


BEGIN

	select	obter_desc_expressao(864139) local_odonto,
			obter_desc_expressao(340678) dente,
			obter_desc_expressao(313362) face,
			obter_desc_expressao(864878) raiz_dente,
			obter_desc_expressao(864063) sextante,
			obter_desc_expressao(864065) arcada,
			obter_desc_expressao(300444) tratamento,
			obter_desc_expressao(286812) dt_proc,
			obter_desc_expressao(327207) procedimento,
			obter_desc_expressao(297049) quantidade,
			obter_desc_expressao(294639) observacao,
			obter_desc_expressao(286938) dt_hist,
			obter_desc_expressao(558659) caracteristica
	into STRICT	ds_lbl_local_odonto_w,
	        ds_lbl_dente_w,
	        ds_lbl_face_w,
	        ds_lbl_raiz_dente_w,
	        ds_lbl_sextante_w,
	        ds_lbl_arcada_w,
	        ds_lbl_tratamento_w,
	        ds_lbl_dt_proc_w,
	        ds_lbl_procedimento_w,
	        ds_lbl_quantidade_w,
	        ds_lbl_observacao_w,
	        ds_lbl_dt_hist_w,
	        ds_lbl_caracteristica_w
	;


	if (ie_tipo_p = 'P') then
		open c01;
		loop
		fetch c01 into c01_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

				if (retorno_w IS NOT NULL AND retorno_w::text <> '') then
					retorno_w := retorno_w || quebra_linha_w;
				end if;

				if (c01_w.ds_local IS NOT NULL AND c01_w.ds_local::text <> '') then
					retorno_w := retorno_w || ds_lbl_local_odonto_w || ': ' || c01_w.ds_local || quebra_linha_w;
				end if;

				if (c01_w.nr_seq_local = 'D') then
					retorno_w := retorno_w || ds_lbl_dente_w || ': ' || c01_w.ds_dente || quebra_linha_w;
					if (c01_w.nr_seq_face IS NOT NULL AND c01_w.nr_seq_face::text <> '') then
						retorno_w := retorno_w || ds_lbl_face_w || ': ' || c01_w.ds_face || quebra_linha_w;
					elsif (c01_w.ie_raiz = 'S') then
						retorno_w := retorno_w || ds_lbl_raiz_dente_w || ': ' || c01_w.ds_raiz_sim || quebra_linha_w;
					end if;
				elsif (c01_w.nr_seq_local = 'A') then
					retorno_w := retorno_w || ds_lbl_arcada_w || ': ' || c01_w.ds_arcada || quebra_linha_w;
				elsif (c01_w.nr_seq_local = 'S') then
					retorno_w := retorno_w || ds_lbl_sextante_w || ': ' || c01_w.ds_sext || quebra_linha_w;
				elsif (c01_w.nr_seq_local = 'T') then
					retorno_w := retorno_w || ds_lbl_tratamento_w || ': ' || c01_w.ds_tratamento || quebra_linha_w;
				elsif (c01_w.nr_seq_local = 'O' or coalesce(c01_w.nr_seq_local::text, '') = '') then
					if (c01_w.nr_seq_dente IS NOT NULL AND c01_w.nr_seq_dente::text <> '') then
						retorno_w := retorno_w || ds_lbl_dente_w || ': ' || c01_w.ds_dente || quebra_linha_w;
						if (c01_w.nr_seq_face IS NOT NULL AND c01_w.nr_seq_face::text <> '') then
							retorno_w := retorno_w || ds_lbl_face_w || ': ' || c01_w.ds_face || quebra_linha_w;
						elsif (c01_w.ie_raiz = 'S') then
							retorno_w := retorno_w || ds_lbl_raiz_dente_w || ': ' || c01_w.ds_raiz_sim || quebra_linha_w;
						end if;
					end if;
					if (c01_w.nr_seq_sextante IS NOT NULL AND c01_w.nr_seq_sextante::text <> '') then
						retorno_w := retorno_w || ds_lbl_sextante_w || ': ' || c01_w.ds_sext || quebra_linha_w;
					end if;
					if (c01_w.nr_seq_arcada IS NOT NULL AND c01_w.nr_seq_arcada::text <> '') then
						retorno_w := retorno_w || ds_lbl_arcada_w || ': ' || c01_w.ds_arcada || quebra_linha_w;
					end if;
					if (c01_w.nr_seq_tratamento IS NOT NULL AND c01_w.nr_seq_tratamento::text <> '') then
						retorno_w := retorno_w || ds_lbl_tratamento_w || ': ' || c01_w.ds_tratamento || quebra_linha_w;
					end if;
				end if;

				if (c01_w.nr_seq_proc_interno IS NOT NULL AND c01_w.nr_seq_proc_interno::text <> '') then
					retorno_w := retorno_w || ds_lbl_procedimento_w || ': ' ||  c01_w.ds_procedimento || quebra_linha_w;
					if (c01_w.qt_procedimento IS NOT NULL AND c01_w.qt_procedimento::text <> '') then
						retorno_w := retorno_w || ds_lbl_quantidade_w || ': ' ||  c01_w.qt_procedimento || quebra_linha_w;
					end if;
				end if;

				if (c01_w.ds_observacao IS NOT NULL AND c01_w.ds_observacao::text <> '') then
					retorno_w := retorno_w || ds_lbl_observacao_w || ': ' ||  c01_w.ds_observacao || quebra_linha_w;
				end if;

			end;
		end loop;
		close c01;
	elsif (ie_tipo_p = 'H') then
		open c02;
		loop
		fetch c02 into c02_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin

				if (retorno_w IS NOT NULL AND retorno_w::text <> '') then
					retorno_w := retorno_w || quebra_linha_w;
				end if;

				if (c02_w.ds_local IS NOT NULL AND c02_w.ds_local::text <> '') then
					retorno_w := retorno_w || ds_lbl_local_odonto_w || ': ' || c02_w.ds_local || quebra_linha_w;
				end if;

				if (c02_w.nr_seq_local = 'D') then
					retorno_w := retorno_w || ds_lbl_dente_w || ': ' || c02_w.ds_dente || quebra_linha_w;
					if (c02_w.nr_seq_face IS NOT NULL AND c02_w.nr_seq_face::text <> '') then
						retorno_w := retorno_w || ds_lbl_face_w || ': ' || c02_w.ds_face || quebra_linha_w;
					elsif (c02_w.ie_raiz = 'S') then
						retorno_w := retorno_w || ds_lbl_raiz_dente_w || ': ' || c02_w.ds_raiz_sim || quebra_linha_w;
					end if;
				elsif (c02_w.nr_seq_local = 'A') then
					retorno_w := retorno_w || ds_lbl_arcada_w || ': ' || c02_w.ds_arcada || quebra_linha_w;
				elsif (c02_w.nr_seq_local = 'S') then
					retorno_w := retorno_w || ds_lbl_sextante_w || ': ' || c02_w.ds_sext || quebra_linha_w;
				elsif (c02_w.nr_seq_local = 'T') then
					retorno_w := retorno_w || ds_lbl_tratamento_w || ': ' || c02_w.ds_tratamento || quebra_linha_w;
				elsif (c02_w.nr_seq_local = 'O' or coalesce(c02_w.nr_seq_local::text, '') = '') then
					if (c02_w.nr_seq_dente IS NOT NULL AND c02_w.nr_seq_dente::text <> '') then
						retorno_w := retorno_w || ds_lbl_dente_w || ': ' || c02_w.ds_dente || quebra_linha_w;
						if (c02_w.nr_seq_face IS NOT NULL AND c02_w.nr_seq_face::text <> '') then
							retorno_w := retorno_w || ds_lbl_face_w || ': ' || c02_w.ds_face || quebra_linha_w;
						elsif (c02_w.ie_raiz = 'S') then
							retorno_w := retorno_w || ds_lbl_raiz_dente_w || ': ' || c02_w.ds_raiz_sim || quebra_linha_w;
						end if;
					end if;
					if (c02_w.nr_seq_sextante IS NOT NULL AND c02_w.nr_seq_sextante::text <> '') then
						retorno_w := retorno_w || ds_lbl_sextante_w || ': ' || c02_w.ds_sext || quebra_linha_w;
					end if;
					if (c02_w.nr_seq_arcada IS NOT NULL AND c02_w.nr_seq_arcada::text <> '') then
						retorno_w := retorno_w || ds_lbl_arcada_w || ': ' || c02_w.ds_arcada || quebra_linha_w;
					end if;
					if (c02_w.nr_seq_tratamento IS NOT NULL AND c02_w.nr_seq_tratamento::text <> '') then
						retorno_w := retorno_w || ds_lbl_tratamento_w || ': ' || c02_w.ds_tratamento || quebra_linha_w;
					end if;
				end if;

				if (c02_w.ie_status_area IS NOT NULL AND c02_w.ie_status_area::text <> '') then
					retorno_w := retorno_w || ds_lbl_caracteristica_w || ': ' ||  c02_w.ds_status_area || quebra_linha_w;
				end if;

				if (c02_w.ds_observacao IS NOT NULL AND c02_w.ds_observacao::text <> '') then
					retorno_w := retorno_w || ds_lbl_observacao_w || ': ' ||  c02_w.ds_observacao || quebra_linha_w;
				end if;




			end;
		end loop;
		close c02;
	end if;

	return retorno_w;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_resumo_odontologia ( nr_seq_odont_consulta_p bigint, ie_tipo_p text) FROM PUBLIC;

