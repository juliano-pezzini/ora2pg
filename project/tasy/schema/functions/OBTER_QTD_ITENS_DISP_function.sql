-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qtd_itens_disp (nr_prescricao_p bigint, nr_seq_lote_p bigint, cd_estabelecimento_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w              text := '';
ie_enviar_horarios_disp_w varchar(1);


BEGIN

  select coalesce(max(ie_enviar_horarios_disp), 'N')
  into STRICT ie_enviar_horarios_disp_w
  from parametros_farmacia
  where cd_estabelecimento = coalesce(wheb_usuario_pck.get_cd_estabelecimento, cd_estabelecimento_p);

  select count(1)
  into STRICT ds_retorno_w
  from    prescr_mat_hor a,
    prescr_medica b,
    prescr_material c,
    estrutura_material_v s,
    material e
  where  (a.nr_seq_lote IS NOT NULL AND a.nr_seq_lote::text <> '')
  and  a.cd_material = s.cd_material
  and  a.nr_prescricao = b.nr_prescricao
  and  c.nr_prescricao = b.nr_prescricao
  and  a.nr_seq_material = c.nr_sequencia
  and  a.nr_prescricao = nr_prescricao_p
  and  a.cd_material = e.cd_material
  and  c.ie_suspenso <> 'S'
  and  coalesce(a.dt_suspensao::text, '') = ''
  and  exists(  SELECT  1
      from  ap_lote x,
        classif_lote_disp_far y
      where  x.nr_sequencia = a.nr_seq_lote
      and x.nr_sequencia = nr_seq_lote_p
      and  y.nr_sequencia = x.nr_seq_classif
      and	((ie_enviar_horarios_disp_w = 'S') or (y.ie_classif_urgente = 'A'))
      and  coalesce(x.dt_atend_farmacia::text, '') = '')
  and  exists(  SELECT  1
      from   regra_local_dispensacao x
      where   x.cd_estabelecimento  = b.cd_estabelecimento
      and  x.cd_setor_atendimento  = b.cd_setor_atendimento
      and  x.nr_sequencia   = coalesce(a.nr_regra_local_disp, c.nr_seq_regra_local)
      and   coalesce(x.nr_seq_classif,a.nr_seq_classif) = a.nr_seq_classif
      and   ((x.cd_material   = s.cd_material) or (x.cd_grupo_material  = s.cd_grupo_material) or (x.cd_subgrupo_material = s.cd_subgrupo_material) or (x.cd_classe_material  = s.cd_classe_material) or ((x.nr_seq_estrut_int IS NOT NULL AND x.nr_seq_estrut_int::text <> '') and consistir_se_mat_contr_estrut(x.nr_seq_estrut_int, s.cd_material) = 'S')));

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qtd_itens_disp (nr_prescricao_p bigint, nr_seq_lote_p bigint, cd_estabelecimento_p bigint default null) FROM PUBLIC;

