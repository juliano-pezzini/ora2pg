-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_recommendation_time ( nr_sequencia_p bigint, ie_option_p text ) RETURNS bigint AS $body$
DECLARE


dt_recommendation_time cpoe_recomendacao.dt_liberacao%type;


BEGIN

  if (ie_option_p = 'R') then
    -- R status maps to duration from when request has been raised
    select a.dt_liberacao 
    into STRICT dt_recommendation_time
    from cpoe_recomendacao a
    where a.nr_sequencia   = nr_sequencia_p;
 elsif (ie_option_p = 'S') then
	-- S status maps to duration from when recommendation has been started
    select dt_start_time 
    into STRICT dt_recommendation_time 
    from (
      SELECT c.dt_horario dt_start_time
      from cpoe_recomendacao a, 
         prescr_recomendacao b, 
         prescr_rec_hor c
      where a.nr_sequencia  = nr_sequencia_p 
      and   a.nr_sequencia  = b.nr_seq_rec_cpoe
      and   b.nr_sequencia  = c.nr_seq_recomendacao
      and   b.nr_prescricao = c.nr_prescricao
      order by c.nr_sequencia desc ) alias1 LIMIT 1;
 end if;

  if (dt_recommendation_time IS NOT NULL AND dt_recommendation_time::text <> '') then
    return round((clock_timestamp() - dt_recommendation_time) * 24 * 60);
  else
    return 0;
  end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_recommendation_time ( nr_sequencia_p bigint, ie_option_p text ) FROM PUBLIC;

