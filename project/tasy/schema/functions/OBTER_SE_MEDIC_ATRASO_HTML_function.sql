-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_medic_atraso_html ( ie_tipo_item_p text, nr_atendimento_p text, nr_prescricao_p bigint, ie_pendente_liberacao_p text, nr_seq_cpoe_p bigint, cd_item_p text, qt_minutos_p bigint, dt_filtro_p timestamp, nr_seq_item_p bigint, qt_hora_adicional_p bigint, qt_item_p bigint, cd_intervalo_p text) RETURNS varchar AS $body$
DECLARE

										
ds_retorno_w	varchar(1) := 'N';
				
		

BEGIN

if (ie_tipo_item_p = 'M') then

		if (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (qt_minutos_p IS NOT NULL AND qt_minutos_p::text <> '') then
			
			
			
					SELECT  coalesce(max('S'),'N')
					into STRICT	ds_retorno_w
					FROM	 prescr_mat_hor a,
								prescr_material b  
					WHERE  ie_tipo_item_p = 'M'   
					AND	 a.nr_seq_material = b.nr_sequencia
					AND	 a.cd_material = b.cd_material   
					AND	 b.nr_prescricao = a.nr_prescricao   					   
					AND ((nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '')  AND	b.nr_seq_mat_cpoe = nr_seq_cpoe_p)   
					AND	 a.nr_atendimento = nr_atendimento_p   
					AND	 a.dt_horario < (clock_timestamp() - (qt_minutos_p / 1440))   
					AND	 a.dt_horario between  dt_filtro_p 	AND	(dt_filtro_p  + (qt_hora_adicional_p / 24))    
					AND	 coalesce(a.dt_fim_horario::text, '') = ''    
					AND	 coalesce(a.dt_interrupcao::text, '') = ''    
					AND	 (a.dt_lib_horario IS NOT NULL AND a.dt_lib_horario::text <> '')    
					AND	 coalesce(ie_pendente_liberacao_p::text, '') = ''    
					AND	 coalesce(a.dt_recusa::text, '') = ''    
					AND	 coalesce(a.dt_suspensao::text, '') = ''  
					AND  a.ie_agrupador = 1		
					AND  b.qt_dose = qt_item_p
					AND  b.cd_intervalo = cd_intervalo_p
					AND	 coalesce(a.ie_horario_especial,'N') = 'N';	
			

		elsif (cd_item_p IS NOT NULL AND cd_item_p::text <> '') then 	
		
			
					SELECT coalesce(max('S'),'N')
					into STRICT	ds_retorno_w
					FROM	prescr_mat_hor a,
						    prescr_material b
					WHERE  ie_tipo_item_p = 'M'  
					AND	 a.nr_seq_material = b.nr_sequencia 
					AND	 a.cd_material = b.cd_material  
					AND	 b.nr_prescricao = a.nr_prescricao  					 					
					AND (b.cd_material = cd_item_p)   
					AND	 a.nr_atendimento = nr_atendimento_p   
					AND	 a.dt_horario < (clock_timestamp() - (qt_minutos_p / 1440))   
					AND	 a.dt_horario between  dt_filtro_p 	AND	(dt_filtro_p  + (qt_hora_adicional_p / 24))    
					AND	 coalesce(a.dt_fim_horario::text, '') = ''    
					AND	 coalesce(a.dt_interrupcao::text, '') = ''    
					AND	 (a.dt_lib_horario IS NOT NULL AND a.dt_lib_horario::text <> '')    
					AND	 coalesce(ie_pendente_liberacao_p::text, '') = ''    
					AND	 coalesce(a.dt_recusa::text, '') = ''    
					AND	 coalesce(a.dt_suspensao::text, '') = ''    
					AND  a.ie_agrupador = 1		
					AND  b.qt_dose = qt_item_p
					AND  b.cd_intervalo = cd_intervalo_p
					AND	 b.nr_prescricao = nr_prescricao_p
					AND	 coalesce(a.ie_horario_especial,'N') = 'N';
 		end if;

elsif (ie_tipo_item_p = 'SOL') then		
		
		if (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (qt_minutos_p IS NOT NULL AND qt_minutos_p::text <> '') then
			
			
				SELECT coalesce(max('S'),'N')
				into STRICT	ds_retorno_w
				FROM  	prescr_mat_hor a,
						prescr_material b,
						prescr_medica c
        		WHERE	ie_tipo_item_p = 'SOL'   
				AND  	a.nr_seq_material = b.nr_sequencia 
		  	AND		a.cd_material = b.cd_material 
		  	AND		b.nr_prescricao = a.nr_prescricao
				AND		b.nr_prescricao = c.nr_prescricao					
		   	AND ((nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') AND b.nr_seq_mat_cpoe = nr_seq_cpoe_p) 
		 		AND   a.nr_atendimento = nr_atendimento_p 
		 		AND 	a.dt_horario < (clock_timestamp() - (qt_minutos_p / 1440))  
				AND	  a.dt_horario between  dt_filtro_p 	AND	(dt_filtro_p  + (qt_hora_adicional_p / 24))    
				AND		coalesce(obter_status_solucao_prescr(1, a.nr_prescricao, a.nr_seq_solucao),'N') in ('N','P')				
		  	AND 	coalesce(a.dt_fim_horario::text, '') = ''    
		  	AND 	coalesce(a.dt_interrupcao::text, '') = ''    
		   	AND 	(a.dt_lib_horario IS NOT NULL AND a.dt_lib_horario::text <> '')    
		   	AND   coalesce(ie_pendente_liberacao_p::text, '') = ''    
		   	AND 	coalesce(a.dt_recusa::text, '') = ''    
		   	AND 	coalesce(a.dt_suspensao::text, '') = ''    
		   	AND 	coalesce(a.ie_horario_especial,'N') = 'N' 
				AND   a.ie_agrupador = 4				
				AND   a.nr_seq_solucao = nr_seq_item_p;
				
			

		elsif (cd_item_p IS NOT NULL AND cd_item_p::text <> '') then
		
				SELECT  coalesce(max('S'),'N')
				into STRICT	ds_retorno_w
				FROM	prescr_mat_hor a,
						prescr_material b,
						prescr_medica c	 
				WHERE 	ie_tipo_item_p = 'SOL' 
				AND  	a.nr_seq_material = b.nr_sequencia
				AND		a.cd_material = b.cd_material 
				AND		b.nr_prescricao = a.nr_prescricao
				AND		b.nr_prescricao = c.nr_prescricao				
				AND (b.cd_material = cd_item_p) 
				AND   a.nr_atendimento = nr_atendimento_p 
				AND 	a.dt_horario < (clock_timestamp() - (qt_minutos_p / 1440))  
				AND	  a.dt_horario between  dt_filtro_p 	AND	(dt_filtro_p  + (qt_hora_adicional_p / 24))    
				AND		coalesce(obter_status_solucao_prescr(1, a.nr_prescricao, a.nr_seq_solucao),'N') in ('N','P')
				AND 	coalesce(a.dt_fim_horario::text, '') = ''   
				AND 	coalesce(a.dt_interrupcao::text, '') = ''   
				AND 	(a.dt_lib_horario IS NOT NULL AND a.dt_lib_horario::text <> '')   
				AND   coalesce(ie_pendente_liberacao_p::text, '') = ''   
				AND 	coalesce(a.dt_recusa::text, '') = ''   
				AND 	coalesce(a.dt_suspensao::text, '') = ''   
				AND 	coalesce(a.ie_horario_especial,'N') = 'N'
				AND   a.ie_agrupador = 4
				AND   a.nr_seq_solucao = nr_seq_item_P;	
		
		end if;
		

end if;		

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_medic_atraso_html ( ie_tipo_item_p text, nr_atendimento_p text, nr_prescricao_p bigint, ie_pendente_liberacao_p text, nr_seq_cpoe_p bigint, cd_item_p text, qt_minutos_p bigint, dt_filtro_p timestamp, nr_seq_item_p bigint, qt_hora_adicional_p bigint, qt_item_p bigint, cd_intervalo_p text) FROM PUBLIC;

