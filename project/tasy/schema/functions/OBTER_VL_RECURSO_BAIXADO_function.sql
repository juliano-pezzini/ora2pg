-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_vl_recurso_baixado ( nm_usuario_p text, cd_estabelecimento_p bigint, cd_empresa_p bigint, ie_restringe_estab_p text, cd_conta_financ_cre_p bigint, ie_tit_rec_canc_p text, ie_data_tit_adiant_rec_p text, dt_referencia_p timestamp, ie_movto_bco_pend_p text, ie_adiant_receb_p text, ie_titulo_caixa_p text, ie_trans_fin_conta_p text, ie_tit_pagar_transf_p text, cd_conta_financ_baixa_p bigint) RETURNS bigint AS $body$
DECLARE


ie_filtro_fluxo_w		varchar(1);
ie_filtro_fluxo_proj_w		varchar(1);
nr_seq_liq_w			bigint;
vl_recurso_w			titulo_receber_liq.vl_recurso%type;
vl_total_recurso_w		titulo_receber_liq.vl_recurso%type;
dt_referencia_w			timestamp;
nr_titulo_w			titulo_receber.nr_titulo%type;

c010 CURSOR FOR
SELECT	nr_titulo,
	nr_seq_liq
from (select	nr_titulo,
		nr_seq_liq
	from (select	a.nr_titulo nr_titulo,
			a.nr_sequencia nr_seq_liq
		FROM estabelecimento k, tipo_recebimento d, titulo_receber b, titulo_receber_liq a
LEFT OUTER JOIN titulo_receber_classif c ON (a.nr_titulo = c.nr_titulo)
LEFT OUTER JOIN movto_trans_financ f ON (a.nr_seq_movto_trans_fin = f.nr_sequencia)
LEFT OUTER JOIN adiantamento e ON (a.nr_adiantamento = e.nr_adiantamento)
WHERE (ie_restringe_estab_p = 'N' or substr(obter_se_conta_financ_estab(coalesce(c.cd_conta_financ, cd_conta_financ_cre_p), cd_estabelecimento_p,ie_restringe_estab_p),1,1) = 'S')  and k.cd_empresa			= cd_empresa_p and b.cd_estabelecimento		= k.cd_estabelecimento and d.ie_fluxo_passado		= 'S' and a.cd_tipo_recebimento		= d.cd_tipo_recebimento and (ie_filtro_fluxo_proj_w = 'N' or substr(obter_se_proj_filtro_fluxo(b.nr_seq_proj_rec, nm_usuario_p),1,1) = 'S') and not exists (select	1
			from	fluxo_caixa_excecao x
			where	x.ie_integracao		= 'TR'
			and	x.ie_origem_titulo_rec	= b.ie_origem_titulo
			and	x.ie_tipo_fluxo		= 'P') and (ie_restringe_estab_p = 'N' or (ie_restringe_estab_p = 'E' and b.cd_estabelecimento = cd_estabelecimento_p) or (ie_restringe_estab_p = 'S' and (b.cd_estabelecimento	= cd_estabelecimento_p or b.cd_estab_financeiro = cd_estabelecimento_p))) and (b.ie_situacao <> '3' or ie_tit_rec_canc_p = 'S') and b.ie_situacao			<> '5' and a.nr_titulo			= b.nr_titulo and (ie_filtro_fluxo_w = 'N' or substr(obter_se_filtro_fluxo_estab(coalesce(a.nr_seq_conta_banco,e.nr_seq_conta_banco), null, a.nr_seq_caixa_rec, nm_usuario_p, f.nr_seq_caixa, cd_estabelecimento_p),1,1) = 'S')  and CASE WHEN ie_data_tit_adiant_rec_p='S' THEN coalesce(e.dt_adiantamento,a.dt_recebimento)  ELSE a.dt_recebimento END = dt_referencia_w  and (ie_movto_bco_pend_p in ('N','A','TP') or
			not exists (select	1
			from	movto_banco_pend_baixa x
			where	x.nr_titulo	= a.nr_titulo
			and	x.nr_seq_baixa	= a.nr_sequencia)) and not exists (select	1
			from	movto_trans_financ x
			where ((x.nr_seq_movto_cartao IS NOT NULL AND x.nr_seq_movto_cartao::text <> '') or (x.nr_seq_cheque IS NOT NULL AND x.nr_seq_cheque::text <> ''))
			and	coalesce(x.nr_seq_titulo_receber::text, '') = ''
			and	x.nr_sequencia		= a.nr_seq_movto_trans_fin) and (ie_adiant_receb_p in ('A','TR') or coalesce(a.nr_adiantamento::text, '') = '') and (coalesce(a.nr_seq_retorno::text, '') = '' or obter_vl_recurso_baixa(b.nr_titulo,a.nr_sequencia,0,trunc(CASE WHEN ie_data_tit_adiant_rec_p='S' THEN coalesce(e.dt_adiantamento,a.dt_recebimento)  ELSE a.dt_recebimento END )) > 0) and coalesce(a.ie_lib_caixa, 'S')	= 'S' and (coalesce(ie_titulo_caixa_p,'S') = 'S' or
			not exists (select	1
			from	caixa y,
				movto_trans_financ x
			where	x.vl_transacao	<> 0
			and	coalesce(x.nr_seq_titulo_receber::text, '') = ''
			and	coalesce(y.ie_movto_fluxo,'S') = 'S'
			and	x.nr_seq_caixa		= y.nr_sequencia
			and	x.nr_seq_caixa_rec	= a.nr_seq_caixa_rec)) and coalesce(obter_conta_financ_tit_rec(b.nr_titulo,a.nr_sequencia,c.cd_conta_financ),coalesce(obter_conta_transacao(CASE WHEN ie_trans_fin_conta_p='M' THEN f.nr_seq_trans_financ  ELSE a.nr_seq_trans_fin END ),cd_conta_financ_cre_p)) = cd_conta_financ_baixa_p ) alias44
	
union all

	SELECT	nr_titulo,
		nr_seq_liq
	from (select	a.nr_titulo nr_titulo,
			a.nr_sequencia nr_seq_liq
		FROM estabelecimento k, tipo_recebimento d, titulo_receber b, titulo_receber_liq a
LEFT OUTER JOIN titulo_receber_classif c ON (a.nr_titulo = c.nr_titulo)
LEFT OUTER JOIN movto_trans_financ f ON (a.nr_seq_movto_trans_fin = f.nr_sequencia)
LEFT OUTER JOIN adiantamento e ON (a.nr_adiantamento = e.nr_adiantamento)
WHERE (ie_restringe_estab_p = 'N' or substr(obter_se_conta_financ_estab(coalesce(c.cd_conta_financ,cd_conta_financ_cre_p),cd_estabelecimento_p,ie_restringe_estab_p),1,1) = 'S')  and (ie_filtro_fluxo_w = 'N' or substr(obter_se_filtro_fluxo_estab(coalesce(a.nr_seq_conta_banco,e.nr_seq_conta_banco),null,a.nr_seq_caixa_rec,nm_usuario_p,f.nr_seq_caixa, cd_estabelecimento_p),1,1) = 'S')  and k.cd_empresa			= cd_empresa_p and b.cd_estabelecimento		= k.cd_estabelecimento and (ie_filtro_fluxo_proj_w = 'N' or substr(obter_se_proj_filtro_fluxo(b.nr_seq_proj_rec,nm_usuario_p),1,1) = 'S') and (ie_restringe_estab_p = 'N' or (ie_restringe_estab_p = 'E' and b.cd_estabelecimento = cd_estabelecimento_p) or (ie_restringe_estab_p = 'S' and (b.cd_estabelecimento = cd_estabelecimento_p or b.cd_estab_financeiro = cd_estabelecimento_p))) and b.ie_situacao			= '5' and not exists (select	1
			from	fluxo_caixa_excecao x
			where	x.ie_integracao		= 'TR'
			and	x.ie_origem_titulo_rec	= b.ie_origem_titulo
			and	x.ie_tipo_fluxo		= 'P') and a.nr_titulo			= b.nr_titulo and CASE WHEN ie_data_tit_adiant_rec_p='S' THEN coalesce(e.dt_adiantamento,a.dt_recebimento)  ELSE a.dt_recebimento END  = dt_referencia_w  and d.ie_fluxo_passado		= 'S' and a.cd_tipo_recebimento		= d.cd_tipo_recebimento and (ie_movto_bco_pend_p in ('N','A','TP') or
			not exists (select	1
			from	movto_banco_pend_baixa x
			where	x.nr_titulo	= a.nr_titulo
			and	x.nr_seq_baixa	= a.nr_sequencia)) and (ie_adiant_receb_p in ('A','TR') or coalesce(a.nr_adiantamento::text, '') = '') and not exists (select	1
			from	movto_trans_financ x
			where ((x.nr_seq_movto_cartao IS NOT NULL AND x.nr_seq_movto_cartao::text <> '') or (x.nr_seq_cheque IS NOT NULL AND x.nr_seq_cheque::text <> ''))
			and	coalesce(x.nr_seq_titulo_receber::text, '') = ''
			and	x.nr_sequencia		= a.nr_seq_movto_trans_fin) and (coalesce(a.nr_seq_retorno::text, '') = '' or obter_vl_recurso_baixa(b.nr_titulo,a.nr_sequencia,0,trunc(CASE WHEN ie_data_tit_adiant_rec_p='S' THEN coalesce(e.dt_adiantamento,a.dt_recebimento)  ELSE a.dt_recebimento END )) > 0) and coalesce(a.ie_lib_caixa, 'S')	= 'S' and ie_tit_pagar_transf_p		= 'S' and (coalesce(ie_titulo_caixa_p,'S') = 'S' or
			not exists (select	1
			from	caixa y,
				movto_trans_financ x
			where	x.vl_transacao	<> 0
			and	coalesce(x.nr_seq_titulo_receber::text, '') = ''
			and	coalesce(y.ie_movto_fluxo,'S') = 'S'
			and	x.nr_seq_caixa		= y.nr_sequencia
			and	x.nr_seq_caixa_rec	= a.nr_seq_caixa_rec)) and obter_conta_financ_tit_rec(b.nr_titulo,a.nr_sequencia,coalesce(c.cd_conta_financ,coalesce(Obter_conta_transacao(CASE WHEN ie_trans_fin_conta_p='M' THEN f.nr_seq_trans_financ  ELSE a.nr_seq_trans_fin END ),cd_conta_financ_cre_p))) = cd_conta_financ_baixa_p ) alias88
	) alias89
group by	nr_titulo,
		nr_seq_liq;


BEGIN

vl_total_recurso_w	:= 0;

dt_referencia_w	:= trunc(dt_referencia_p,'dd');

select	coalesce(max('S'),'N')
into STRICT	ie_filtro_fluxo_w
from	w_filtro_fluxo
where	nm_usuario	= nm_usuario_p
and	coalesce(nr_seq_proj_rec::text, '') = '';

select	coalesce(max('S'),'N')
into STRICT	ie_filtro_fluxo_proj_w
from	w_filtro_fluxo
where	nm_usuario	= nm_usuario_p
and	(nr_seq_proj_rec IS NOT NULL AND nr_seq_proj_rec::text <> '');

open c010;
loop
fetch c010 into
	nr_titulo_w,
	nr_seq_liq_w;
EXIT WHEN NOT FOUND; /* apply on c010 */
	select	coalesce(max(a.vl_recurso),0)
	into STRICT	vl_recurso_w
	from	transacao_financeira b,
		titulo_receber_liq a
	where	(b.cd_conta_financ IS NOT NULL AND b.cd_conta_financ::text <> '')
	and	a.nr_seq_trans_fin	= b.nr_sequencia
	and	not exists (SELECT	1
		from	titulo_receber_liq x
		where	x.nr_seq_liq_origem	= a.nr_sequencia
		and	x.nr_titulo		= a.nr_titulo)
	and	coalesce(a.nr_seq_liq_origem::text, '') = ''
	and	coalesce(a.vl_recurso,0)	<> 0
	and	trunc(dt_recebimento,'dd')	< dt_referencia_w
	and	a.nr_titulo		= nr_titulo_w;

	vl_total_recurso_w	:= vl_total_recurso_w + vl_recurso_w;
end loop;
close c010;

return	vl_total_recurso_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_vl_recurso_baixado ( nm_usuario_p text, cd_estabelecimento_p bigint, cd_empresa_p bigint, ie_restringe_estab_p text, cd_conta_financ_cre_p bigint, ie_tit_rec_canc_p text, ie_data_tit_adiant_rec_p text, dt_referencia_p timestamp, ie_movto_bco_pend_p text, ie_adiant_receb_p text, ie_titulo_caixa_p text, ie_trans_fin_conta_p text, ie_tit_pagar_transf_p text, cd_conta_financ_baixa_p bigint) FROM PUBLIC;

