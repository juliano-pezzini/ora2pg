-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_problema_arvore ( nr_seq_problema_p bigint, ie_tipo_p text) RETURNS varchar AS $body$
DECLARE


	
ds_retorno_w		varchar(4000) := '';
nr_sequencia_w		bigint;
nr_seq_cadastro_w	bigint;

ie_informacao_w		cadastro_problema_apres.ie_informacao%type;

ds_problema_w		lista_problema_pac.ds_problema%type;
dt_inicio_w		lista_problema_pac.dt_inicio%type;
dt_fim_w		lista_problema_pac.dt_fim%type;
ds_complemento_w	lista_problema_pac.ds_complemento%type;
ds_duracao_w		varchar(255);
ds_intensidade_w	varchar(255);
ds_status_w			varchar(255);
ds_nivel_cuidado_w	varchar(255);


C01 CURSOR FOR
	SELECT	nr_sequencia
	from	cadastro_problema_arvore
	where	ie_tipo = ie_tipo_p
	order by nr_sequencia;
	
C02 CURSOR FOR
	SELECT	ie_informacao
	from	cadastro_problema_apres
	where	nr_seq_cad_problema = nr_seq_cadastro_w
	order by nr_seq_apresentacao;	


BEGIN


If (nr_seq_problema_p IS NOT NULL AND nr_seq_problema_p::text <> '') then

	Select 	max(ds_problema),
			max(obter_tempo_problema_ativo(nr_sequencia)),
			max(dt_inicio),
                        max(dt_fim),
			max(obter_desc_radio_group((SELECT MAX(b.CD_EXP_VALORES) FROM tabela_visao_atributo b WHERE nr_sequencia = 72876 AND NM_ATRIBUTO = 'IE_INTENSIDADE'), ie_intensidade)),
			max(obter_valor_dominio(8221,IE_STATUS)),
			max(ds_complemento),
			max(obter_desc_nivel_atencao(IE_NIVEL_ATENCAO))
	into STRICT	ds_problema_w,
			ds_duracao_w,
			dt_inicio_w,
                        dt_fim_w,
			ds_intensidade_w,
			ds_status_w,
			ds_complemento_w,
			ds_nivel_cuidado_w
	from	lista_problema_pac
	where	nr_sequencia = nr_seq_problema_p;
	
	open C01;
	loop
	fetch C01 into	
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin			
		nr_seq_cadastro_w :=  nr_sequencia_w;
		end;
	end loop;
	close C01;
	
	if ( nr_seq_cadastro_w > 0) then		
		
		open C02;
		loop
		fetch C02 into	
			ie_informacao_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			
			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			
				ds_retorno_w := ds_retorno_w||'; ';
			
			end if;
			
			if (ie_informacao_w = 'PROP') then
			
				ds_retorno_w := substr(ds_retorno_w ||ds_problema_w,1,4000);
				
			elsif (ie_informacao_w = 'DURA') then
			
				ds_retorno_w := substr(ds_retorno_w ||ds_duracao_w,1,4000);
				
			elsif (ie_informacao_w = 'DATI') then
			
				ds_retorno_w := substr(ds_retorno_w ||to_date(dt_inicio_w,'dd/mm/yyyy'),1,4000);
			
                        elsif (ie_informacao_w = 'DAFI') then
			
				ds_retorno_w := substr(ds_retorno_w ||to_date(dt_fim_w,'dd/mm/yyyy'),1,4000);
								
			elsif (ie_informacao_w = 'INTE') then
			
				ds_retorno_w := substr(ds_retorno_w ||ds_intensidade_w,1,4000);
				
			elsif (ie_informacao_w = 'STAT') then
			
				ds_retorno_w := substr(ds_retorno_w ||ds_status_w,1,4000);
				
			elsif (ie_informacao_w = 'COMP') then
			
				ds_retorno_w := substr(ds_retorno_w ||ds_complemento_w,1,4000);
				
			elsif (ie_informacao_w = 'CUID') then
			
				ds_retorno_w := substr(ds_retorno_w ||ds_nivel_cuidado_w,1,4000);
			
			end if;
			
			end;
		end loop;
		close C02;
	
	end if;	
	
	if ( coalesce(ds_retorno_w::text, '') = '' ) then
	
		ds_retorno_w := substr(ds_problema_w||'; '||ds_duracao_w,1,4000);
	
	end if;


end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_problema_arvore ( nr_seq_problema_p bigint, ie_tipo_p text) FROM PUBLIC;

