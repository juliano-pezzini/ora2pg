-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_turno_departamento (nr_seq_agenda_p bigint, cd_departamento_medico_p bigint) RETURNS varchar AS $body$
DECLARE
	

cd_agenda_w			bigint;
hr_inicio_w			timestamp;	
ie_dia_semana_w		bigint;	
ie_liberado_w		varchar(01) := 'S';
		

BEGIN

select	max(cd_agenda),
		max(hr_inicio)
into STRICT	cd_agenda_w,
		hr_inicio_w
from	agenda_paciente
where	nr_sequencia	= nr_seq_agenda_p;

select 	pkg_date_utils.get_WeekDay(hr_inicio_w)
into STRICT	ie_dia_semana_w
;

select	coalesce(max('S'),'N')
into STRICT	ie_liberado_w
from 	agenda_horario ah,
		agenda a
where	a.cd_agenda	= cd_agenda_w
AND		a.cd_agenda = ah.cd_agenda
and		((dt_dia_semana	= ie_dia_semana_w) or (dt_dia_semana	= 9 and ie_dia_semana_w	not in (1,7)))
AND (ah.cd_departamento_medico = cd_departamento_medico_p OR (coalesce(ah.cd_departamento_medico::text, '') = '' AND a.cd_departamento_medico = cd_departamento_medico_p))
and		get_composite_date_time(clock_timestamp(), hr_inicio_w) between get_composite_date_time(clock_timestamp(), hr_inicial) and get_composite_date_time(clock_timestamp(), hr_final);
		
return	ie_liberado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_turno_departamento (nr_seq_agenda_p bigint, cd_departamento_medico_p bigint) FROM PUBLIC;

