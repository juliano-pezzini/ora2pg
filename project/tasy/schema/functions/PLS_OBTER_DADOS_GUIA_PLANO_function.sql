-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_guia_plano ( nr_seq_guia_p bigint, cd_guia_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*ie_opcao_p =
	DA - Data autorizacao
	P - Seq prestador
	N - Nome do prestador
	S - Seq segurado
	NS - Nome do segurado
	CR - Carteira do segurado
	G - Codigo da guia
	DA - Data da autorizacao
	PO - Seq protocolo
	ST - Status da guia
	DST - Descricao do status da guia
	ES - Estagio da guia
	DES - Descricao do Estagio da guia
	IA - Indicacao de Acidente
	TP!- Tipo Processo
	TA - Tipo Atendimento
	DTA - Descricao do Tipo Atendimento
	RA - Regime de atendimento
	DRA - Descricao do regime de atendimento
	SO - Saude ocupacional
	DSO - Descricao da saude ocupacional
*/
ds_retorno_w			varchar(255);
cd_guia_w			varchar(20);
nr_seq_segurado_w		bigint;
nr_seq_prestador_w		bigint;
nr_seq_protocolo_w		bigint;
ie_status_w			varchar(2);
ie_estagio_w			bigint;
ie_tipo_atend_tiss_w		pls_guia_plano.ie_tipo_atend_tiss%type;
ie_regime_atendimento_w		pls_conta.ie_regime_atendimento%type;
ds_regime_atendimento_w		dominio.ds_dominio%type;
ie_saude_ocupacional_w		pls_conta.ie_saude_ocupacional%type;
ds_saude_ocupacional_w		dominio.ds_dominio%type;

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_protocolo_conta	a
	where	nr_sequencia in (SELECT	x.nr_seq_protocolo
				from	pls_conta	x
				where	x.cd_guia	= cd_guia_w);


BEGIN
if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
	select	a.nr_seq_segurado,
		a.nr_seq_prestador,
		a.cd_guia,
		a.ie_status,
		a.ie_estagio,
		a.ie_tipo_atend_tiss,
		a.ie_regime_atendimento,
		obter_valor_dominio(10631, a.ie_regime_atendimento),
		a.ie_saude_ocupacional,
		obter_valor_dominio(10632, a.ie_saude_ocupacional)
	into STRICT	nr_seq_segurado_w,
		nr_seq_prestador_w,
		cd_guia_w,
		ie_status_w,
		ie_estagio_w,
		ie_tipo_atend_tiss_w,
		ie_regime_atendimento_w,
		ds_regime_atendimento_w,
		ie_saude_ocupacional_w,
		ds_saude_ocupacional_w
	from	pls_guia_plano a
	where	a.nr_sequencia = nr_seq_guia_p;
	
	if (ie_opcao_p = 'P') then
		ds_retorno_w	:= nr_seq_prestador_w;
	elsif (ie_opcao_p = 'NP') then
		ds_retorno_w	:= substr(pls_obter_dados_prestador(nr_seq_prestador_w,'N'),1,255);
	elsif (ie_opcao_p = 'S') then
		ds_retorno_w	:= nr_seq_segurado_w;
	elsif (ie_opcao_p = 'NS') then
		ds_retorno_w	:= substr(pls_obter_dados_segurado(nr_seq_segurado_w,'N'),1,255);
	elsif (ie_opcao_p = 'CR') then
		ds_retorno_w	:= substr(pls_obter_dados_segurado(nr_seq_segurado_w,'CR'),1,255);
	elsif (ie_opcao_p = 'G') then
		ds_retorno_w	:= cd_guia_w;
	elsif (ie_opcao_p	= 'DA') then
		select	max(to_char(dt_autorizacao, 'dd/mm/yyyy'))
		into STRICT	ds_retorno_w
		from	pls_guia_plano
		where	nr_sequencia = nr_seq_guia_p;
	elsif (ie_opcao_p = 'PO') then
		open C01;
		loop
		fetch C01 into
			nr_seq_protocolo_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			ds_retorno_w	:= substr(ds_retorno_w || to_char(nr_seq_protocolo_w) || ', ',1,255);
			end;
		end loop;
		close C01;
		ds_retorno_w	:= substr(ds_retorno_w,1,length(ds_retorno_w)-2);
	elsif (ie_opcao_p = 'ST') then
		ds_retorno_w	:= ie_status_w;
	elsif (ie_opcao_p = 'DST') then
		ds_retorno_w	:= substr(obter_valor_dominio(1747,ie_status_w),1,255);
	elsif (ie_opcao_p = 'ES') then
		ds_retorno_w	:= ie_estagio_w;
	elsif (ie_opcao_p = 'DES') then
		ds_retorno_w	:= substr(obter_valor_dominio(2055,ie_estagio_w),1,255);
	elsif (ie_opcao_p = 'IA') then
		select	max(a.ie_indicacao_acidente)
		into STRICT	ds_retorno_w
		from	pls_conta a
		where	a.nr_seq_guia = nr_seq_guia_p;
	elsif (ie_opcao_p = 'TP') then
		select	max(ie_tipo_processo)
		into STRICT	ds_retorno_w
		from	pls_guia_plano
		where	nr_sequencia = nr_seq_guia_p;
	elsif (ie_opcao_p = 'TA') then
		ds_retorno_w	:= ie_tipo_atend_tiss_w;
	elsif (ie_opcao_p = 'DTA') then
		ds_retorno_w	:= substr(obter_valor_dominio(1761,ie_tipo_atend_tiss_w),1,255);
	elsif (ie_opcao_p = 'RA') then
		ds_retorno_w	:= ie_regime_atendimento_w;
	elsif (ie_opcao_p = 'DRA') then
		ds_retorno_w	:= ds_regime_atendimento_w;
	elsif (ie_opcao_p = 'SO') then
		ds_retorno_w	:= ie_saude_ocupacional_w;
	elsif (ie_opcao_p = 'DSO') then
		ds_retorno_w	:= ds_saude_ocupacional_w;
	end if;	
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_guia_plano ( nr_seq_guia_p bigint, cd_guia_p text, ie_opcao_p text) FROM PUBLIC;

