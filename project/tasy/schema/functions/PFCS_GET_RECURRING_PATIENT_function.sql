-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_recurring_patient ( nr_seq_patient_p bigint, ie_frequent_flyer_p text default 'S') RETURNS varchar AS $body$
DECLARE



recurring_days_w        varchar(10)  := ' ';
recurring_year_w        varchar(10)  := ' ';
recurring_year_ed_w     varchar(10)  := ' ';
recurring_details_w     varchar(255) := '';


BEGIN
if (ie_frequent_flyer_p = 'S') then
    -- Number of days since last encounter
    select max(nr_value) into STRICT recurring_days_w FROM (
            SELECT obs_com.nr_value
            from pfcs_observation obs,
            pfcs_observ_component obs_com
            where obs_com.nr_seq_observation = obs.nr_sequencia
            and obs_com.cd_code = 'FreqFlyer-Red30'
            and obs.nr_seq_patient = nr_seq_patient_p
            order by obs_com.dt_atualizacao desc
        ) alias2 LIMIT 1;

    -- Recurring last year (inpatient)
    select max(nr_value) into STRICT recurring_year_w FROM (
            SELECT obs_com.nr_value
            from pfcs_observation obs,
            pfcs_observ_component obs_com
            where obs_com.nr_seq_observation = obs.nr_sequencia
            and obs_com.cd_code = 'FreqFlyer-inpatient_visits'
            and obs.nr_seq_patient = nr_seq_patient_p
            order by obs_com.dt_atualizacao desc
        ) alias1 LIMIT 1;

    -- Recurring last year (Emergency)
    select max(nr_value) into STRICT recurring_year_ed_w
    	FROM (
    	    SELECT obs_com.nr_value
            from pfcs_observation obs,
            pfcs_observ_component obs_com
            where obs_com.nr_seq_observation = obs.nr_sequencia
            and obs_com.cd_code = 'FreqFlyer-ed_visits'
            and obs.nr_seq_patient = nr_seq_patient_p
    		order by obs_com.dt_atualizacao desc
    	) alias1 LIMIT 1;

    if (length(recurring_days_w) > 0) then
        recurring_details_w := recurring_details_w || concat(obter_desc_expressao(1051623) || ': ', recurring_days_w) || ';';
    end if;

    if (length(recurring_year_w) > 0) then
        recurring_details_w := recurring_details_w || concat(obter_desc_expressao(1046402) || ': ', recurring_year_w) || ';';
    end if;

    if (length(recurring_year_ed_w) > 0) then
        recurring_details_w := recurring_details_w || concat(obter_desc_expressao(1046404) || ': ', recurring_year_ed_w) || ';';
    end if;

    if (length(recurring_details_w) > 1) then
        recurring_details_w := substr(recurring_details_w, 1, length(recurring_details_w)-1);
    end if;
end if;
RETURN recurring_details_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_recurring_patient ( nr_seq_patient_p bigint, ie_frequent_flyer_p text default 'S') FROM PUBLIC;

