-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pharm_obter_saldo_disp_estoque (cd_material_p bigint, cd_local_estoque_p bigint, cd_estabelecimento_p bigint, nr_seq_lote_p bigint default null) RETURNS bigint AS $body$
DECLARE

				
qt_estoque_w			double precision;
ie_consignado_w			material.ie_consignado%type;
ie_tipo_saldo_w			varchar(1);
cd_cgc_fornec_w			material_lote_fornec.cd_cgc_fornec%type;
dt_mesano_ref_saldo_w	timestamp;
qt_estoque_consig_w     double precision := 0;


BEGIN

qt_estoque_w := 0;
ie_tipo_saldo_w := 'X';

select	coalesce(max(ie_consignado),'0')
into STRICT	
	ie_consignado_w
from	material
where	cd_material = cd_material_p;

if (ie_consignado_w = '2') then	
	begin
		begin
		select	max(f.dt_mesano_referencia)
		into STRICT	dt_mesano_ref_saldo_w
		from	fornecedor_mat_consignado f
		where	f.cd_estabelecimento = cd_estabelecimento_p
		and		f.cd_local_estoque = coalesce(cd_local_estoque_p,  f.cd_local_estoque)
		and		f.cd_material = cd_material_p;
		exception
			when others then
				dt_mesano_ref_saldo_w := PKG_DATE_UTILS.start_of(clock_timestamp(), 'MONTH', 0);
		end;
		begin
		select 	sum(f.qt_estoque)
		into STRICT	qt_estoque_consig_w
		from 	fornecedor_mat_consignado f
		where 	f.cd_estabelecimento = cd_estabelecimento_p
		and 	f.cd_material = cd_material_p
		and 	f.cd_local_estoque = coalesce(cd_local_estoque_p, f.cd_local_estoque)
		and 	f.dt_mesano_referencia = dt_mesano_ref_saldo_w;
		exception
			when others then
				qt_estoque_consig_w := 0;
		end;
		
		qt_estoque_w := obter_saldo_estoque(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0), qt_estoque_w);

		qt_estoque_w := coalesce(qt_estoque_w + coalesce(qt_estoque_consig_w, 0),0);
				
	end;
elsif (ie_consignado_w = '1') then
	begin
		begin
		select	max(f.dt_mesano_referencia)
		into STRICT	dt_mesano_ref_saldo_w
		from	fornecedor_mat_consignado f
		where	f.cd_estabelecimento = cd_estabelecimento_p
		and		f.cd_local_estoque = coalesce(cd_local_estoque_p,  f.cd_local_estoque)
		and		f.cd_material = cd_material_p;
		exception
			when others then
				dt_mesano_ref_saldo_w := PKG_DATE_UTILS.start_of(clock_timestamp(), 'MONTH', 0);
		end;
		begin
		select 	sum(f.qt_estoque)
		into STRICT	qt_estoque_consig_w
		from 	fornecedor_mat_consignado f
		where 	f.cd_estabelecimento = cd_estabelecimento_p
		and 	f.cd_material = cd_material_p
		and 	f.cd_local_estoque = coalesce(cd_local_estoque_p, f.cd_local_estoque)
		and 	f.dt_mesano_referencia = dt_mesano_ref_saldo_w;
		exception
			when others then
				qt_estoque_consig_w := 0;
		end;	
		qt_estoque_w := coalesce(qt_estoque_consig_w,0);
	end;
elsif (ie_consignado_w = '0') then
	begin
		qt_estoque_w :=	coalesce(obter_saldo_disp_estoque(
			cd_estabelecimento_p	=> cd_estabelecimento_p,
			cd_material_p		=> cd_material_p,
			cd_local_estoque_p	=> cd_local_estoque_p,
			dt_mesano_referencia_p	=> PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0)),0);
	end;
end if;

return qt_estoque_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pharm_obter_saldo_disp_estoque (cd_material_p bigint, cd_local_estoque_p bigint, cd_estabelecimento_p bigint, nr_seq_lote_p bigint default null) FROM PUBLIC;

