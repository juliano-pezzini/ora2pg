-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tiss_atualiza_cod_brasindice ( nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


cd_estabelecimento_w	bigint;
cd_convenio_w		bigint;
nr_interno_conta_w	bigint;
cd_material_w		bigint;
cd_tab_preco_material_w	bigint;
cd_material_brasindice_w	varchar(100);
cd_laboratorio_w		varchar(100);
cd_medicamento_w	varchar(100);
cd_apresentacao_w	varchar(100);
cd_material_convenio_w	varchar(100);
ie_origem_tiss_w		varchar(100);
cd_grupo_material_w	bigint;
cd_subgrupo_material_w	bigint;
cd_classe_material_w	bigint;
nr_seq_tiss_tabela_w	bigint;
ie_codigo_material_w	varchar(100);
ie_origem_preco_w	varchar(100);
cd_adicional_w		varchar(10);
cd_categoria_w		varchar(100);
ie_cod_tiss_brasindice_w	varchar(100);
ie_conversao_externa_w	varchar(100);
cd_material_tiss_w		varchar(100);
CD_TABELA_XML_w	varchar(100);
dt_material_w		timestamp;
dt_entrada_w		timestamp;
ie_data_ref_tab_mat_w	varchar(255);
vl_unitario_mat_w	double precision := 0;
nr_seq_familia_w			material.nr_seq_familia%type;
ie_tipo_material_w			material.ie_tipo_material%type;
nr_seq_lote_fornec_w		material_lote_fornec.nr_sequencia%type;
nr_seq_marca_w 			material_lote_fornec.nr_seq_marca%type;

c02 CURSOR FOR
SELECT	a.nr_seq_tiss_tabela,
	coalesce(a.ie_cod_material, 'T'),
	coalesce(a.ie_conversao_externa, 'S'),
	a.cd_adicional
from 	tiss_regra_tabela_mat a
where	a.cd_estabelecimento = cd_estabelecimento_w
and	a.cd_convenio = cd_convenio_w
and	coalesce(a.cd_categoria, cd_categoria_w) = cd_categoria_w
and	coalesce(a.cd_material, cd_material_w) = cd_material_w
and	coalesce(a.cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
and	coalesce(a.cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
and	coalesce(a.cd_classe_material, cd_classe_material_w) = cd_classe_material_w
and	coalesce(CASE WHEN ie_data_ref_tab_mat_w='D' THEN  dt_material_w  ELSE dt_entrada_w END , clock_timestamp()) between trunc(a.dt_inicio_vigencia, 'dd') and trunc(coalesce(a.dt_final_vigencia,coalesce(CASE WHEN ie_data_ref_tab_mat_w='D' THEN  dt_material_w  ELSE dt_entrada_w END , clock_timestamp())+1)) + 89399/89400
and	coalesce(a.ie_situacao,'A') = 'A'
and	coalesce(a.nr_seq_familia, coalesce(nr_seq_familia_w,0))			= coalesce(nr_seq_familia_w,0)
and 	coalesce(a.ie_tipo_material, coalesce(ie_tipo_material_w, '0')) = coalesce(ie_tipo_material_w, '0')
and	((coalesce(cd_tab_preco_material, coalesce(cd_tab_preco_material_w,'00')) = coalesce(cd_tab_preco_material_w,'00')) or
	 ((cd_tab_preco_material_w = '00') and (coalesce(cd_tab_preco_material::text, '') = '')))
and	((coalesce(vl_unitario_mat_w,0) >= coalesce(a.vl_inicial,0)) and (coalesce(vl_unitario_mat_w,0) <= coalesce(a.vl_final,999999999)))	
order	by ie_prioridade desc,
	coalesce(cd_material, 0),
	coalesce(cd_classe_material, 0),
	coalesce(cd_subgrupo_material, 0),
	coalesce(cd_grupo_material, 0),
	coalesce(a.vl_inicial,0),
	a.dt_inicio_vigencia,
	coalesce(a.nr_seq_familia,0),
	coalesce(a.ie_tipo_material,'0');


BEGIN

select	max(b.cd_estabelecimento),
	max(b.nr_interno_conta),
	max(a.cd_material),
	max(a.cd_material_convenio),
	max(a.ie_origem_preco),
	max(b.cd_convenio_parametro),
	max(b.cd_categoria_parametro),
	max(a.dt_conta),
	max(tiss_obter_origem_preco_mat(a.ie_origem_preco,
					a.cd_material,
					b.cd_estabelecimento,
					b.cd_convenio_parametro,
					b.cd_categoria_parametro,
					a.cd_tab_preco_material,
					a.dt_conta,
					a.cd_setor_atendimento,
					'X',
					a.nr_seq_proc_pacote,
					a.nr_sequencia,
					a.cd_material_tuss)),
	max(cd_tab_preco_material),
	max(to_date(obter_dados_atendimento(b.nr_atendimento,'DET'))),
	coalesce(max(a.vl_unitario),0),
	max(e.nr_seq_familia),
	max(a.nr_seq_lote_fornec)
into STRICT	cd_estabelecimento_w,
	nr_interno_conta_w,		
	cd_material_w,
	cd_material_convenio_w,
	ie_origem_preco_w,
	cd_convenio_w,
	cd_categoria_w,
	dt_material_w,
	ie_origem_tiss_w,
	cd_tab_preco_material_w,
	dt_entrada_w,
	vl_unitario_mat_w,
	nr_seq_familia_w,
	nr_seq_lote_fornec_w
FROM atend_categoria_convenio x, material e, atendimento_paciente d, estabelecimento c, conta_paciente b, material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_convenio f ON (a.nr_sequencia = f.nr_seq_material)
WHERE b.cd_estabelecimento	= c.cd_estabelecimento and a.nr_interno_conta		= b.nr_interno_conta and x.nr_atendimento		= d.nr_atendimento and b.nr_atendimento		= d.nr_atendimento  and a.cd_material		= e.cd_material and a.nr_sequencia		= nr_sequencia_p;

select 	max(b.cd_grupo_material),
	max(b.cd_subgrupo_material),
	max(b.cd_classe_material),	
	coalesce(max(a.ie_tipo_material),'0')
into STRICT	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	ie_tipo_material_w
from	estrutura_material_v b,
	material a
where 	a.cd_material		= b.cd_material
and	a.cd_material		= cd_material_w;

select	coalesce(max(ie_cod_tiss_brasindice),'N'),
	coalesce(max(ie_data_ref_tab_mat),'D')
into STRICT	ie_cod_tiss_brasindice_w,
	ie_data_ref_tab_mat_w
from	tiss_parametros_convenio
where	cd_convenio		= cd_convenio_w
and	cd_estabelecimento	= cd_estabelecimento_w;

nr_seq_tiss_tabela_w	:= null;

open c02;
loop
fetch c02 into
	nr_seq_tiss_tabela_w,
	ie_codigo_material_w,
	ie_conversao_externa_w,
	cd_adicional_w;
EXIT WHEN NOT FOUND; /* apply on c02 */

end loop;
close c02;

cd_material_tiss_w			:= null;

if (coalesce(ie_conversao_externa_w, 'S') = 'S') then
	if	((cd_material_convenio_w IS NOT NULL AND cd_material_convenio_w::text <> '') and (cd_material_convenio_w <> to_char(cd_material_w))) then
		cd_material_tiss_w		:= cd_material_convenio_w;
	end if;
elsif (ie_conversao_externa_w = 'N') then
	cd_material_tiss_w		:= cd_material_w;
end if;

if (coalesce(cd_material_tiss_w::text, '') = '') then

	nr_seq_marca_w := 0;
	if (coalesce(nr_seq_lote_fornec_w,0) > 0) then
		select	max(coalesce(nr_seq_marca,0))
		into STRICT	nr_seq_marca_w
		from	material_lote_fornec
		where	nr_sequencia = nr_seq_lote_fornec_w;
	end if;
	
	if (coalesce(ie_codigo_material_w, 'O') = 'O') then
		if (ie_origem_preco_w = 1) or (ie_origem_tiss_w = '05') then
			cd_material_brasindice_w	:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_material_w,cd_convenio_w, nr_seq_marca_w);
			cd_laboratorio_w			:= substr(cd_material_brasindice_w,1,3);
			cd_medicamento_w			:= substr(cd_material_brasindice_w,5,5);
			cd_apresentacao_w			:= substr(cd_material_brasindice_w,11,4);
			if (ie_cod_tiss_brasindice_w = 'N') then
				cd_material_tiss_w		:= tiss_obter_cod_brasindice(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w);
			elsif (ie_cod_tiss_brasindice_w = 'B') then
				cd_material_tiss_w		:= replace(obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_material_w,cd_convenio_w, nr_seq_marca_w), ';','');
			end if;
			if (coalesce(cd_material_tiss_w,'0') = '0') then
				cd_material_tiss_w		:= replace(cd_medicamento_w,';','');
			end if;

		elsif (ie_origem_preco_w = 4) or (ie_origem_tiss_w	= '12') then
			select	max(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w))
			into STRICT	cd_material_tiss_w
			;
		end if;
	elsif (ie_codigo_material_w = 'T') then

		select	CD_TABELA_XML
		into STRICT	CD_TABELA_XML_w
		from	tiss_tipo_tabela
		where	nr_sequencia	= nr_seq_tiss_tabela_w;

		if (CD_TABELA_XML_w = '05') then
			cd_material_brasindice_w		:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_material_w,cd_convenio_w, nr_seq_marca_w);
			cd_laboratorio_w			:= substr(cd_material_brasindice_w,1,3);
			cd_medicamento_w			:= substr(cd_material_brasindice_w,5,5);
			cd_apresentacao_w			:= substr(cd_material_brasindice_w,11,4);

			if (ie_cod_tiss_brasindice_w = 'N') then
				cd_material_tiss_w		:= tiss_obter_cod_brasindice(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w);
			elsif (ie_cod_tiss_brasindice_w = 'B') then
				cd_material_tiss_w		:= replace(obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_material_w,cd_convenio_w, nr_seq_marca_w),';','');
			end if;

			if (coalesce(cd_material_tiss_w, '0') = '0') then
				cd_material_tiss_w		:= replace(cd_medicamento_w, ';','');
			end if;
		elsif (CD_TABELA_XML_w = '12') then
		
			select	max(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_material_w))
			into STRICT	cd_material_tiss_w
			;
		end if;
	end if;
end if;

if (cd_material_tiss_w IS NOT NULL AND cd_material_tiss_w::text <> '') then
	cd_material_tiss_w	:= cd_adicional_w || cd_material_tiss_w;
end if;

return cd_material_tiss_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_atualiza_cod_brasindice ( nr_sequencia_p bigint) FROM PUBLIC;

