-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_seq_interno_painel ( nr_atendimento_p bigint ) RETURNS bigint AS $body$
DECLARE

    nr_seq_interno_w   atend_paciente_unidade.nr_seq_interno%TYPE;
    nr_atendimento_w   atend_paciente_unidade.nr_atendimento%TYPE := nr_atendimento_p;

    classif_cirur_w constant setor_atendimento.cd_classif_setor%type := 2;
    classif_intern_w constant setor_atendimento.cd_classif_setor%type := 3;
    classif_terap_w constant setor_atendimento.cd_classif_setor%type := 4;
    classif_hcare_w constant setor_atendimento.cd_classif_setor%type := 8;
    classif_sala_esp_w constant setor_atendimento.cd_classif_setor%type := 12;

    situacao_ativa_w constant setor_atendimento.ie_situacao%type := 'A';
    qt_sum_dias_w constant setor_atendimento.qt_tempo_passagem%type := 9999;


BEGIN
    << get_nr_seq_interno >> BEGIN
        SELECT
            nr_seq_interno
        INTO STRICT nr_seq_interno_w
        FROM (
                SELECT
                    a.nr_seq_interno
                FROM
                    setor_atendimento        c
                    JOIN atend_paciente_unidade   a ON a.cd_setor_atendimento = c.cd_setor_atendimento
                    JOIN unidade_atendimento      b ON b.cd_setor_atendimento = a.cd_setor_atendimento
                                                  AND b.cd_unidade_basica = a.cd_unidade_basica
                                                  AND b.cd_unidade_compl = a.cd_unidade_compl
                WHERE
                    a.nr_atendimento = nr_atendimento_w
                    AND c.cd_classif_setor IN (
                        classif_cirur_w,
                        classif_intern_w,
                        classif_terap_w,
                        classif_hcare_w,
                        classif_sala_esp_w
                    )
                    AND c.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
                    AND coalesce(c.ie_situacao, situacao_ativa_w) = situacao_ativa_w
                    AND coalesce(b.ie_situacao, situacao_ativa_w) = situacao_ativa_w
                ORDER BY
                    coalesce(a.dt_saida_unidade, a.dt_entrada_unidade + qt_sum_dias_w) DESC
            ) alias4 LIMIT 1;

    END;

    RETURN nr_seq_interno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_seq_interno_painel ( nr_atendimento_p bigint ) FROM PUBLIC;

