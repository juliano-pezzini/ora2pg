-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_seq_icone_api ( nr_prescricao_p bigint, nr_seq_material_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(4000);
nr_seq_icone_w		bigint;
ds_API_available_w	varchar(255);

--when 'A'    then 'Drug interactions';

--when 'B' 	then 'Drug Disease ICD10';

--when 'C'    then 'Duplicate Therapy';

--when 'D'    then 'Drug Dose Contraindications';

--when 'E'    then 'Route ContraIndications';

--when 'F'    then 'Age Contraindications';

--when 'G'    then 'Genre ContraIndications';					

--when 'H'    then 'Pregnancy ContraIndications';

--when 'I'    then 'Lactation ContraIndications';
					
c01 CURSOR FOR
	SELECT 	a.cd_api,
			count(a.nr_sequencia) qt_total_item,
			CASE a.cd_api
				WHEN 'A' THEN 10 	-- Drug
				WHEN 'C' THEN 20 	-- Duplication
				WHEN 'D' THEN 30 	-- Drug Dose
				WHEN 'B' THEN 40  	-- Drug Disease
				WHEN 'DDC' THEN 40	-- Drug Disease
				WHEN 'E' THEN 50 	-- Route
				WHEN 'F' THEN 60	-- Age
				WHEN 'G' THEN 70	-- Gender
				WHEN 'H' THEN 80	-- Pregnancy
				WHEN 'I' THEN 90	-- Lactation
				WHEN 'PE' THEN 110	-- Patient Education
				ELSE 999
			END nr_order_type			
	from 	alerta_api a,
			table(lista_pck.obter_lista_char(ds_API_available_w)) x
	where 	x.cd_registro = a.cd_api
	and		a.nr_prescricao 	= nr_prescricao_p
	and 	a.nr_seq_material 	= nr_seq_material_p
	and 	coalesce(a.ie_status_requisicao::text, '') = ''
	group by cd_api,
			 CASE a.cd_api WHEN 'A' THEN 10 WHEN 'C' THEN 20 WHEN 'D' THEN 30 WHEN 'B' THEN 40 WHEN 'DDC' THEN 40 WHEN 'E' THEN 50 WHEN 'F' THEN 60 WHEN 'G' THEN 70 WHEN 'H' THEN 80 WHEN 'I' THEN 90 WHEN 'PE' THEN 110 ELSE 999 END
	order by nr_order_type;

BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then
	
	select max(get_list_API_available(a.nr_atendimento, a.cd_pessoa_fisica, 'N'))
	  into STRICT ds_API_available_w
	  from prescr_medica a
	 where a.nr_prescricao = nr_prescricao_p;
	
	for c01_w in c01
	loop
		if c01_w.qt_total_item > 0 then
			case c01_w.cd_api
				when 'A'    then nr_seq_icone_w := 1025;
				when 'B' 	then nr_seq_icone_w := 1026;
				when 'C'    then nr_seq_icone_w := 1027;
				when 'D'    then nr_seq_icone_w := 1028;
				when 'E'    then nr_seq_icone_w := 1029;
				when 'F'    then nr_seq_icone_w := 1030;
				when 'G'    then nr_seq_icone_w := 4131;
				when 'H'    then nr_seq_icone_w := 1031;
				when 'I'    then nr_seq_icone_w := 1032;
			else nr_seq_icone_w := 0;
			end case;
		
			if nr_seq_icone_w > 0 then
				if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
					ds_retorno_w := ds_retorno_w || ',' || nr_seq_icone_w;
				else
					ds_retorno_w := nr_seq_icone_w;
				end if;
			end if;
		end if;
	end loop;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_seq_icone_api ( nr_prescricao_p bigint, nr_seq_material_p bigint) FROM PUBLIC;

