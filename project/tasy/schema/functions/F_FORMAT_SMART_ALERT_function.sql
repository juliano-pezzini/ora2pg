-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION f_format_smart_alert ( nr_seq_alerta_p bigint default null, nr_atendimento_p bigint default null, ie_tipo_alerta_p text default null, ie_origem_p text default null) RETURNS varchar AS $body$
DECLARE


alertas	            varchar(1000);
ie_tipo_alerta_w    SMART_ALERT.ie_tipo_alerta%TYPE;
nr_sequencia_w      SMART_ALERT.nr_sequencia%TYPE;
ie_origem_w         SMART_ALERT.ie_origem%TYPE;
ie_tendencia_w      SMART_ALERT.ie_tendencia%TYPE;
ie_level_w          SMART_ALERT.ie_level%TYPE;
nr_alertas          bigint;

alertas_c CURSOR(cd_alerta_c bigint) FOR
    SELECT  IE_TIPO_COMPONENTE,
        NR_LIMITE,
        NR_VALOR
    FROM smart_alert_component
    WHERE nr_seq_smart_alert = cd_alerta_c
    ORDER BY IE_TIPO_COMPONENTE asc;

BEGIN

if coalesce(nr_seq_alerta_p::text, '') = '' then
  select nr_sequencia, ie_tipo_alerta, ie_origem, ie_tendencia, ie_level
  into STRICT nr_sequencia_w, ie_tipo_alerta_w, ie_origem_w, ie_tendencia_w, ie_level_w
  from SMART_ALERT
  where nr_atendimento = nr_atendimento_p
  and ie_tipo_alerta = ie_tipo_alerta_p
  and ie_origem = ie_origem_p
  and dt_alerta = (SELECT max(dt_alerta)
                      from SMART_ALERT
                      where nr_atendimento = nr_atendimento_p
                      and ie_tipo_alerta = ie_tipo_alerta_p
                      and ie_origem = ie_origem_p);
else
  select nr_sequencia, ie_tipo_alerta, ie_origem, ie_tendencia, ie_level
  into STRICT nr_sequencia_w, ie_tipo_alerta_w, ie_origem_w, ie_tendencia_w, ie_level_w
  from SMART_ALERT
  where nr_sequencia = nr_seq_alerta_p;
end if;

alertas := ie_tipo_alerta_w;

IF ie_origem_w = 'T' THEN
    IF ie_tendencia_w = 'I' THEN
        alertas := alertas || ' - ' || CHR(38) || '#9650;';
    ELSIF ie_tendencia_w = 'D' THEN
        alertas := alertas || ' - ' || CHR(38) || '#x25BC;';
    END IF;
ELSIF ie_origem_w = 'L' AND (ie_tipo_alerta_w != 'O2S/RR' AND ie_tipo_alerta_w != 'HR/MAP') THEN
    alertas := alertas || '-' || ie_level_w;
END IF;

alertas := alertas || ': ';

SELECT  count(*)
into STRICT    nr_alertas
FROM    smart_alert_component
WHERE   nr_seq_smart_alert = nr_sequencia_w;

FOR alerta IN alertas_c(nr_sequencia_w) LOOP
    alertas := alertas || alerta.IE_TIPO_COMPONENTE || ' ';
    IF (alerta.NR_LIMITE IS NOT NULL AND alerta.NR_LIMITE::text <> '') THEN
        alertas := alertas || '[' || alerta.NR_LIMITE || '] ';
    END IF;

    alertas := alertas || alerta.NR_VALOR;

    IF alertas_c%rowcount != nr_alertas THEN
        alertas := alertas || ', ';
    end if;
END LOOP;

RETURN alertas;

EXCEPTION
  WHEN no_data_found THEN
    RETURN '';

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION f_format_smart_alert ( nr_seq_alerta_p bigint default null, nr_atendimento_p bigint default null, ie_tipo_alerta_p text default null, ie_origem_p text default null) FROM PUBLIC;

