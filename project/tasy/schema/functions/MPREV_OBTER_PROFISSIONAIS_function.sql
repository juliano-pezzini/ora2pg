-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION mprev_obter_profissionais ( nr_seq_partic_ciclo_item_p bigint) RETURNS varchar AS $body$
DECLARE


cd_lista_responsaveis_w		varchar(255);WITH RECURSIVE cte AS (



BEGIN
if (coalesce(nr_seq_partic_ciclo_item_p,0) > 0) then
		-- 1º ¿ Reponsáveis pelo atendimento previsto
		select	max(ltrim(cd_prof,','))
		into STRICT	cd_lista_responsaveis_w
		from 	(
			SELECT	cd_prof, row_number() OVER () AS fila from
			(
				SELECT	distinct
					coalesce(a.cd_profissional,b.cd_pessoa_responsavel) cd_prof
				FROM mprev_part_cic_item_resp a
LEFT OUTER JOIN mprev_equipe b ON (a.nr_seq_equipe = b.nr_sequencia)
WHERE ((b.cd_pessoa_responsavel IS NOT NULL AND b.cd_pessoa_responsavel::text <> '') or (a.cd_profissional IS NOT NULL AND a.cd_profissional::text <> ''))  and a.nr_seq_partic_ciclo_item =  nr_seq_partic_ciclo_item_p
					 ) alias9
				) alias10 WHERE fila = 1
  UNION ALL



BEGIN
if (coalesce(nr_seq_partic_ciclo_item_p,0) > 0) then
		
		select	c.cd_lista_responsaveis_w || ',' || max(ltrim(cd_prof,','))
		into STRICT	cd_lista_responsaveis_w
		from 	(
			SELECT	cd_prof, row_number() OVER () AS fila from
			(
				SELECT	distinct
					coalesce(a.cd_profissional,b.cd_pessoa_responsavel) cd_prof
				FROM mprev_part_cic_item_resp a
LEFT OUTER JOIN mprev_equipe b ON (a.nr_seq_equipe = b.nr_sequencia)
WHERE ((b.cd_pessoa_responsavel IS NOT NULL AND b.cd_pessoa_responsavel::text <> '') or (a.cd_profissional IS NOT NULL AND a.cd_profissional::text <> ''))  and a.nr_seq_partic_ciclo_item =  nr_seq_partic_ciclo_item_p
					 ) alias9
				) JOIN cte c ON (c.prior fila = alias10.(fila-1))

) SELECT * FROM cte WHERE connect_by_isleaf = 1;
;WITH RECURSIVE cte AS (

		
		-- 2º ¿ Responsáveis pelo programa do participante
		if (coalesce(cd_lista_responsaveis_w::text, '') = '') then
			select	max(ltrim(cd_prof,','))
			into STRICT	cd_lista_responsaveis_w
			from 	(
				SELECT	cd_prof, row_number() OVER () AS fila from
				(
					SELECT	distinct coalesce(b.cd_profissional,c.cd_pessoa_responsavel) cd_prof
					FROM mprev_partic_ciclo_item_v a, mprev_prog_partic_prof b
LEFT OUTER JOIN mprev_equipe c ON (b.nr_seq_equipe = c.nr_sequencia)
WHERE a.nr_seq_prog_partic = b.nr_seq_programa_partic and (b.nr_seq_participante IS NOT NULL AND b.nr_seq_participante::text <> '')  and b.dt_inicio_acomp <= clock_timestamp() and (coalesce(b.dt_fim_acomp::text, '') = '' or b.dt_fim_acomp >= clock_timestamp()) and a.nr_sequencia =  nr_seq_partic_ciclo_item_p and ((b.cd_profissional IS NOT NULL AND b.cd_profissional::text <> '') or (c.cd_pessoa_responsavel IS NOT NULL AND c.cd_pessoa_responsavel::text <> ''))
						 ) alias14
					) alias15 WHERE fila = 1
  UNION ALL

		
		
		if (coalesce(cd_lista_responsaveis_w::text, '') = '') then
			select	c.cd_lista_responsaveis_w || ',' || max(ltrim(cd_prof,','))
			into STRICT	cd_lista_responsaveis_w
			from 	(
				SELECT	cd_prof, row_number() OVER () AS fila from
				(
					SELECT	distinct coalesce(b.cd_profissional,c.cd_pessoa_responsavel) cd_prof
					FROM mprev_partic_ciclo_item_v a, mprev_prog_partic_prof b
LEFT OUTER JOIN mprev_equipe c ON (b.nr_seq_equipe = c.nr_sequencia)
WHERE a.nr_seq_prog_partic = b.nr_seq_programa_partic and (b.nr_seq_participante IS NOT NULL AND b.nr_seq_participante::text <> '')  and b.dt_inicio_acomp <= clock_timestamp() and (coalesce(b.dt_fim_acomp::text, '') = '' or b.dt_fim_acomp >= clock_timestamp()) and a.nr_sequencia =  nr_seq_partic_ciclo_item_p and ((b.cd_profissional IS NOT NULL AND b.cd_profissional::text <> '') or (c.cd_pessoa_responsavel IS NOT NULL AND c.cd_pessoa_responsavel::text <> ''))
						 ) alias14
					) JOIN cte c ON (c.prior fila = alias15.(fila-1))

) SELECT * FROM cte WHERE connect_by_isleaf = 1;
;
		end if;WITH RECURSIVE cte AS (

		
		-- 3º ¿ Responsável do programa
		if (coalesce(cd_lista_responsaveis_w::text, '') = '') then
			select	max(ltrim(cd_prof,','))
			into STRICT	cd_lista_responsaveis_w
			from 	(
				SELECT	cd_prof, row_number() OVER () AS fila from
				(
					SELECT	c.cd_pessoa_responsavel cd_prof
					from	mprev_programa a,
							mprev_prog_equipe b,
							mprev_equipe c,
							mprev_programa_partic e,
							mprev_partic_ciclo_item f
					where 	a.nr_sequencia = b.nr_seq_programa
					and	c.nr_sequencia = b.nr_seq_equipe
					and	a.nr_sequencia = e.nr_seq_programa
					and	e.nr_sequencia = f.nr_seq_programa_partic
					and	f.nr_sequencia =  nr_seq_partic_ciclo_item_p
					and	trunc(coalesce(b.dt_inclusao,clock_timestamp())) <= trunc(clock_timestamp())
					and	((coalesce(b.dt_exclusao::text, '') = '') or trunc(b.dt_exclusao) > trunc(clock_timestamp()))
						) alias16
					) alias17 WHERE fila = 1
  UNION ALL

		
		
		if (coalesce(cd_lista_responsaveis_w::text, '') = '') then
			select	c.cd_lista_responsaveis_w || ',' || max(ltrim(cd_prof,','))
			into STRICT	cd_lista_responsaveis_w
			from 	(
				SELECT	cd_prof, row_number() OVER () AS fila from
				(
					SELECT	c.cd_pessoa_responsavel cd_prof
					from	mprev_programa a,
							mprev_prog_equipe b,
							mprev_equipe c,
							mprev_programa_partic e,
							mprev_partic_ciclo_item f
					where 	a.nr_sequencia = b.nr_seq_programa
					and	c.nr_sequencia = b.nr_seq_equipe
					and	a.nr_sequencia = e.nr_seq_programa
					and	e.nr_sequencia = f.nr_seq_programa_partic
					and	f.nr_sequencia =  nr_seq_partic_ciclo_item_p
					and	trunc(coalesce(b.dt_inclusao,clock_timestamp())) <= trunc(clock_timestamp())
					and	((coalesce(b.dt_exclusao::text, '') = '') or trunc(b.dt_exclusao) > trunc(clock_timestamp()))
						) alias16
					) JOIN cte c ON (c.prior fila = alias17.(fila-1))

) SELECT * FROM cte WHERE connect_by_isleaf = 1;
;
		end if;
end if;	
return	cd_lista_responsaveis_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION mprev_obter_profissionais ( nr_seq_partic_ciclo_item_p bigint) FROM PUBLIC;

