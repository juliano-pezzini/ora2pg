-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_exibe_prescr_gpe ( nr_prescricao_p bigint, ie_retrograda_p text, --[81] 
 ie_liberacao_p text, ie_lib_farm_p text, ie_sem_atendimento_p text, --[95] 
 cd_setor_atendimento_p bigint, ie_dispensacao_p bigint, ie_revisao_p bigint, ie_itens_p bigint, ie_consiste_alta_p text, --[40] 
 ie_restringe_estab_p text, --[71] 
 cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
ie_exibe_w			varchar(1)	:= 'N';
ie_prescr_emergencia_w 		prescr_medica.ie_prescr_emergencia%type;
dt_liberacao_w			prescr_medica.dt_liberacao%type;
dt_liberacao_farmacia_w		prescr_medica.dt_liberacao_farmacia%type;
cd_setor_atendimento_w		prescr_medica.cd_setor_atendimento%type;
cd_pessoa_fisica_w		prescr_medica.cd_pessoa_fisica%type;
nr_atendimento_w		prescr_medica.nr_atendimento%type;
dt_revisao_w			prescr_medica.dt_revisao%type;
cd_estabelecimento_w		prescr_medica.cd_estabelecimento%type;
ie_disp_w			varchar(1);
ie_itens_w			varchar(1)	:= 'N';
ds_itens_prescr_w		varchar(2000);
dt_alta_w			timestamp;


BEGIN 
 
select	coalesce(max(ie_prescr_emergencia),'N'), 
	max(dt_liberacao), 
	max(dt_liberacao_farmacia), 
	max(cd_setor_atendimento), 
	max(cd_pessoa_fisica), 
	max(nr_atendimento), 
	max(dt_revisao), 
	max(obter_itens_prescr(nr_prescricao,DS_ITENS_PRESCR)), 
	max(cd_estabelecimento) 
into STRICT	ie_prescr_emergencia_w, 
	dt_liberacao_w, 
	dt_liberacao_farmacia_w, 
	cd_setor_atendimento_w, 
	cd_pessoa_fisica_w, 
	nr_atendimento_w, 
	dt_revisao_w, 
	ds_itens_prescr_w, 
	cd_estabelecimento_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_p;
 
select	max(dt_alta) 
into STRICT	dt_alta_w 
from	atendimento_paciente 
where	nr_atendimento	= nr_atendimento_w;
 
if (coalesce(nr_atendimento_w::text, '') = '') and (coalesce(cd_setor_atendimento_w::text, '') = '') then 
	cd_setor_atendimento_w	:= obter_cd_setor_pf(cd_pessoa_fisica_w);
end if;
 
if (ie_dispensacao_p	= 0) then 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_disp_w 
	from	prescr_material 
	where	nr_prescricao = nr_prescricao_p 
	and	ie_regra_disp = 'U';
elsif (ie_dispensacao_p	= 1) then 
	select	coalesce(max('N'),'S') 
	into STRICT	ie_disp_w 
	from	prescr_material 
	where	nr_prescricao = nr_prescricao_p 
	and	ie_regra_disp = 'U';
else 
	ie_disp_w	:= 'S';
end if;
 
if (ie_itens_p	= 0) then 
	if (position(obter_desc_expressao(293051)/*'Medic'*/
 in ds_itens_prescr_w) > 0) then 
		ie_itens_w	:= 'S';
	end if;
elsif (ie_itens_p	= 1) then 
	if (position('Sol' in ds_itens_prescr_w)	> 0) then 
		ie_itens_w	:= 'S';
	end if;
elsif (ie_itens_p	= 2) then 
	if (position('Proc' in ds_itens_prescr_w) > 0) then 
		ie_itens_w	:= 'S';
	end if;
elsif (ie_itens_p	= 3) then 
	if (position('Rec' in ds_itens_prescr_w)	> 0) then 
		ie_itens_w	:= 'S';
	end if;
elsif (ie_itens_p	= 4) then 
	if (position(obter_desc_expressao(298038)/*'Sangue'*/
 in ds_itens_prescr_w) > 0) then 
		ie_itens_w	:= 'S';
	end if;
else 
	ie_itens_w	:= 'S';
end if;
 
if	((ie_retrograda_p = 'S')	or (ie_prescr_emergencia_w	= 'N')) and 
	((ie_liberacao_p = 0) or 
	 (ie_liberacao_p = 1 AND dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') or 
	 ((ie_liberacao_p = 2) and (coalesce(dt_liberacao_w::text, '') = ''))) and 
	((ie_lib_farm_p = 0) or 
	 (ie_lib_farm_p = 1 AND dt_liberacao_farmacia_w IS NOT NULL AND dt_liberacao_farmacia_w::text <> '') or 
	 ((ie_lib_farm_p = 2) and (coalesce(dt_liberacao_farmacia_w::text, '') = ''))) and 
	((ie_sem_atendimento_p = 'S') or (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '')) and 
	((coalesce(cd_setor_atendimento_p::text, '') = '') or (cd_setor_atendimento_p = cd_setor_atendimento_w)) and (ie_disp_w	= 'S') and 
	((ie_revisao_p	= 2) or 
	 ((ie_revisao_p	= 0) and (coalesce(dt_revisao_w::text, '') = '')) or 
	 (ie_revisao_p = 1 AND dt_revisao_w IS NOT NULL AND dt_revisao_w::text <> '')) and (ie_itens_w	= 'S') and 
	((ie_consiste_alta_p	= 'S') or ((ie_consiste_alta_p	= 'N') and (coalesce(dt_alta_w::text, '') = ''))) and 
	((ie_restringe_estab_p	= 'N') or (ie_restringe_estab_p = 'S' AND cd_estabelecimento_w	= cd_estabelecimento_p)) 
	 then 
	ie_exibe_w	:= 'S';
end if;
 
return	ie_exibe_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_exibe_prescr_gpe ( nr_prescricao_p bigint, ie_retrograda_p text, ie_liberacao_p text, ie_lib_farm_p text, ie_sem_atendimento_p text, cd_setor_atendimento_p bigint, ie_dispensacao_p bigint, ie_revisao_p bigint, ie_itens_p bigint, ie_consiste_alta_p text, ie_restringe_estab_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

