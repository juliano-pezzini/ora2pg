-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_operation_shift_catagory ( DT_SURGERY_P AGREG_PAT_OPERATION_ROOM.DT_SURGERY_START%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) RETURNS AGREG_PAT_OPERATION_ROOM.NR_SEQ_SHIFT_CATEGORY%TYPE AS $body$
DECLARE


NR_SEQUENCIA_W	AGREG_PAT_OPERATION_ROOM.NR_SEQ_SHIFT_CATEGORY%type;
ie_holiday_w	AGREG_PAT_OPERATION_ROOM.NR_SEQ_SHIFT_CATEGORY%type;
ie_week_day_w	AGREG_PAT_OPERATION_ROOM.NR_SEQ_SHIFT_CATEGORY%type;		

BEGIN
if (DT_SURGERY_P IS NOT NULL AND DT_SURGERY_P::text <> '') then
ie_holiday_w :=obter_se_feriado(cd_estabelecimento_p,trunc(DT_SURGERY_P,'dd'));
ie_week_day_w :=PKG_DATE_UTILS.get_WeekDay(trunc(DT_SURGERY_P,'dd'));

SELECT MAX(NR_SEQUENCIA) into STRICT NR_SEQUENCIA_W
FROM (SELECT *
  FROM (SELECT PSR.NR_SEQUENCIA,
      CASE PSR.IE_HOLIDAY
        WHEN 'S' THEN CASE WHEN ie_holiday_w=0 THEN 3  ELSE 2 END
        WHEN 'N' THEN CASE WHEN ie_holiday_w=0 THEN 1  ELSE 0 END 
      END AS row_priority
    FROM PAN_SHIFT_DAILY_REPORT PSR
    WHERE DT_SURGERY_P BETWEEN pkg_date_utils.get_time(DT_SURGERY_P, pkg_date_utils.EXTRACT_FIELD('HOUR',PSR.DT_START_TIME), pkg_date_utils.EXTRACT_FIELD('MINUTE',PSR.DT_START_TIME) ) AND pkg_date_utils.get_time(DT_SURGERY_P, pkg_date_utils.EXTRACT_FIELD('HOUR',PSR.DT_END_TIME), pkg_date_utils.EXTRACT_FIELD('MINUTE',PSR.DT_END_TIME) )
    AND PSR.IE_SITUACAO ='A'
    AND PSR.IE_SUNDAY   =CASE WHEN ie_week_day_w=1 THEN 'S'  ELSE IE_SUNDAY END 
    AND PSR.IE_MONDAY   =CASE WHEN ie_week_day_w=2 THEN 'S'  ELSE IE_MONDAY END 
    AND PSR.IE_TUESDAY  =CASE WHEN ie_week_day_w=3 THEN 'S'  ELSE IE_TUESDAY END 
    AND PSR.IE_WEDNESDAY=CASE WHEN ie_week_day_w=4 THEN 'S'  ELSE IE_WEDNESDAY END 
    AND PSR.IE_THURSDAY =CASE WHEN ie_week_day_w=5 THEN 'S'  ELSE IE_THURSDAY END 
    AND PSR.IE_FRIDAY   =CASE WHEN ie_week_day_w=6 THEN 'S'  ELSE IE_FRIDAY END 
    AND PSR.IE_SATURDAY =CASE WHEN ie_week_day_w=7 THEN 'S'  ELSE IE_SATURDAY END 
    ) alias7
  WHERE row_priority<=2
  ORDER BY row_priority DESC
  ) alias8 LIMIT 1;


end if;

return NR_SEQUENCIA_W;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_operation_shift_catagory ( DT_SURGERY_P AGREG_PAT_OPERATION_ROOM.DT_SURGERY_START%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

