-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_gera_req_protocolo ( nr_seq_protocolo_req_p bigint) RETURNS varchar AS $body$
DECLARE




ie_gerar_w	varchar(1);
ie_retorno_w	varchar(1);
ie_ordem_w	integer;

ds_horarios_w	prot_requisicao_regra.ds_horarios%type;
ds_horarios_aux_w	prot_requisicao_regra.ds_horarios%type;
pos		integer;
ds_horario_w	varchar(20);
dt_horario_w	timestamp;

dt_inicio_w	timestamp := PKG_DATE_UTILS.start_of(clock_timestamp(),'dd', 0);
dt_fim_w		timestamp := PKG_DATE_UTILS.END_OF(clock_timestamp(), 'DAY', 0);
dt_ultima_exec_w	timestamp;

c01 CURSOR FOR
SELECT	1 ie_ordem,
	ie_gerar,
	ds_horarios
from	prot_requisicao_regra
where	nr_seq_prot_requisicao	= nr_seq_protocolo_req_p
and	coalesce(ie_dia_semana::text, '') = ''

union all

select	9 ie_ordem,
	ie_gerar,
	ds_horarios
from	prot_requisicao_regra
where	nr_seq_prot_requisicao	= nr_seq_protocolo_req_p
and	ie_dia_semana		= obter_cod_dia_semana(clock_timestamp())
order by
	1;


BEGIN

ie_retorno_w	:= 'S';

select	max(dt_ultima_exec)
into STRICT	dt_ultima_exec_w
from	prot_requisicao
where	nr_sequencia = nr_seq_protocolo_req_p;

open	c01;
loop
fetch	c01 into
	ie_ordem_w,
	ie_gerar_w,
	ds_horarios_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ie_retorno_w	:= ie_gerar_w;
end loop;
close 	c01;

if (ie_retorno_w = 'S') then
	begin
	if (coalesce(ds_horarios_w,'X') = 'X') then
		ie_retorno_w	:= 'S';
	else
		begin
		ie_retorno_w		:= 'N';
		ds_horarios_aux_w	:= ds_horarios_w;
		dt_horario_w		:= clock_timestamp();

		while(dt_horario_w IS NOT NULL AND dt_horario_w::text <> '') and (ie_retorno_w = 'N') loop
			begin
			dt_horario_w	:= null;
			pos		:= position(',' in ds_horarios_aux_w);

			if (pos > 0) then
				begin
				ds_horario_w	:= substr(ds_horarios_aux_w,1,pos-1);
				ds_horarios_aux_w	:= substr(ds_horarios_aux_w,pos+1,length(ds_horarios_aux_w));
				begin
				ds_horario_w	:= to_char(dt_inicio_w,'dd/mm/yyyy') || ' ' || trim(both ds_horario_w);
				dt_horario_w	:= to_date(ds_horario_w,'dd/mm/yyyy hh24:mi:ss');
				exception
				when others then
					dt_horario_w	:= null;
				end;
				end;
			end if;

			if (coalesce(dt_horario_w::text, '') = '') and (coalesce(ds_horarios_aux_w,'X') <> 'X') then
				begin
				ds_horario_w	:= to_char(dt_inicio_w,'dd/mm/yyyy') || ' ' || trim(both ds_horarios_aux_w);
				dt_horario_w	:= to_date(ds_horario_w,'dd/mm/yyyy hh24:mi:ss');
				ds_horarios_aux_w	:= null;
				exception
				when others then
					dt_horario_w	:= null;
				end;
			end if;

			if (dt_horario_w IS NOT NULL AND dt_horario_w::text <> '') and (dt_horario_w < clock_timestamp()) and
				((coalesce(dt_ultima_exec_w::text, '') = '') or (dt_horario_w > dt_ultima_exec_w)) then
				begin
				select	'N'
				into STRICT	ie_retorno_w
				from	requisicao_material
				where	nr_seq_protocolo = nr_seq_protocolo_req_p
				and	dt_solicitacao_requisicao between dt_horario_w and dt_fim_w  LIMIT 1;
				exception
				when others then
					ie_retorno_w	:= 'S';
				end;
			end if;
			end;
		end loop;
		end;
	end if;
	end;
end if;

return ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_gera_req_protocolo ( nr_seq_protocolo_req_p bigint) FROM PUBLIC;

