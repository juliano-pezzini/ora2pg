-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_consistencia_prest ( nr_seq_prestador_p pls_prestador.nr_sequencia%type, ie_consistencia_p text, dt_consistencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_nivel_exclusao_p pls_consist_dados_prest.ie_nivel_exclusao_ptu%type) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(255);
dt_consistencia_w		timestamp;
nr_seq_tipo_prestador_w		pls_tipo_prestador.nr_sequencia%type;
nr_seq_classificacao_w		pls_prestador.nr_seq_classificacao%type;
ie_publica_ans_w		pls_prestador.ie_publica_ans%type;
ie_guia_medico_w		pls_prestador.ie_guia_medico%type;

C01 CURSOR FOR
	SELECT	ie_consistencia_prest ie_consistencia,
		nr_seq_tipo_prestador,
		nr_seq_classificacao,
		ie_guia_medico,
		ie_publica_ans
	from	pls_consist_dados_prest
	where	1 = 1
	--and	ie_consistencia_prest	= ie_consistencia_p
	and	cd_estabelecimento	= cd_estabelecimento_p
	and (nr_seq_tipo_prestador	= nr_seq_tipo_prestador_w or coalesce(nr_seq_tipo_prestador::text, '') = '')
	and (nr_seq_classificacao	= nr_seq_classificacao_w or coalesce(nr_seq_classificacao::text, '') = '')
	and	((coalesce(ie_guia_medico::text, '') = '') or (ie_guia_medico		= ie_guia_medico_w))
	and	((coalesce(ie_publica_ans::text, '') = '') or (ie_publica_ans		= ie_publica_ans_w))
	and	dt_consistencia_w between trunc(dt_inicio_vigencia) and fim_dia(coalesce(dt_fim_vigencia,clock_timestamp()))
	and	((coalesce(ie_nivel_exclusao_ptu::text, '') = '') or (ie_nivel_exclusao_p	= ie_nivel_exclusao_ptu))
	order by
		nr_seq_tipo_prestador desc,
		nr_seq_classificacao,
		ie_guia_medico,
		ie_publica_ans;

BEGIN
dt_consistencia_w := trunc(coalesce(dt_consistencia_p,clock_timestamp()));

if (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '') then
	select	nr_seq_tipo_prestador,
		ie_publica_ans,
		nr_seq_classificacao,
		ie_guia_medico
	into STRICT	nr_seq_tipo_prestador_w,
		ie_publica_ans_w,
		nr_seq_classificacao_w,
		ie_guia_medico_w
	from	pls_prestador
	where	nr_sequencia	= nr_seq_prestador_p;
end if;

for r_c01_w in C01 loop
	begin
	ds_retorno_w := r_c01_w.ie_consistencia;
	end;
end loop;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_consistencia_prest ( nr_seq_prestador_p pls_prestador.nr_sequencia%type, ie_consistencia_p text, dt_consistencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_nivel_exclusao_p pls_consist_dados_prest.ie_nivel_exclusao_ptu%type) FROM PUBLIC;

