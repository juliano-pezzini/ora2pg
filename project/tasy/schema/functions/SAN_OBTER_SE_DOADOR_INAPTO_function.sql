-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION san_obter_se_doador_inapto ( nr_seq_doacao_p bigint, cd_pessoa_fisica_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(1);
ie_sexo_w			varchar(1);
nr_sequencia_w			bigint;
qt_dias_ult_doacao_w		bigint;
qt_doacao_ano_w			bigint;
dt_doacao_w			timestamp;
qt_doa_ano_w			bigint;
ie_tipo_doacao_ant_reg_w 	smallint;
ie_tipo_doacao_reg_w		smallint;
nr_seq_doacao_anterior_w	bigint;
ie_tipo_coleta_ant_w		smallint;
ie_considera_tipo_bolsa_w	varchar(1);
qt_bolsa_simples_w		bigint;
qt_bolsa_dupla_w		bigint;
ie_tipo_coleta_w		san_doacao.ie_tipo_coleta%type;
dt_anterior_w			timestamp;
nr_seq_derivado_ant_w         san_doacao.nr_seq_derivado%type;
nr_seq_derivado_w                san_doacao.nr_seq_derivado%type;


BEGIN

ds_retorno_w := 'N';
dt_anterior_w := clock_timestamp() - interval '365 days';

IF (nr_seq_doacao_p IS NOT NULL AND nr_seq_doacao_p::text <> '') and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') THEN

	SELECT	MAX(ie_sexo)
	INTO STRICT	ie_sexo_w
	FROM 	pessoa_fisica
	WHERE	cd_pessoa_fisica = cd_pessoa_fisica_p;

	SELECT 	MAX(nr_sequencia)
	INTO STRICT	nr_seq_doacao_anterior_w
	FROM   	san_doacao
	WHERE 	cd_pessoa_fisica = cd_pessoa_fisica_p
	AND 	(dt_coleta IS NOT NULL AND dt_coleta::text <> '')
	AND	nr_sequencia < nr_seq_doacao_p;

	SELECT 	max(ie_tipo_coleta),
		MAX(nr_seq_derivado)
	INTO STRICT	ie_tipo_coleta_ant_w,
		nr_seq_derivado_ant_w
	FROM   	san_doacao
	WHERE 	nr_sequencia = nr_seq_doacao_anterior_w;
	
	SELECT 	max(ie_tipo_coleta),
		max(nr_seq_derivado)
	INTO STRICT	ie_tipo_coleta_w,
		nr_seq_derivado_w
	FROM   	san_doacao
	WHERE 	nr_sequencia = nr_seq_doacao_p;

	--Verificar as regras de doação cadastradas
	IF (ie_tipo_coleta_ant_w IS NOT NULL AND ie_tipo_coleta_ant_w::text <> '') THEN

		SELECT	MAX(nr_sequencia),
			MAX(qt_dias_ult_dia),
			MAX(qt_doacao_ano),
			MAX(nr_tipo_doacao),
			MAX(nr_tipo_doacao_anterior),
			MAX(ie_considerar_tipo_bolsa)
		INTO STRICT	nr_sequencia_w,
			qt_dias_ult_doacao_w,
			qt_doacao_ano_w,
			ie_tipo_doacao_reg_w,
			ie_tipo_doacao_ant_reg_w,
			ie_considera_tipo_bolsa_w
		FROM	san_regra_doacao
		WHERE	ie_sexo = ie_sexo_w
		AND  	coalesce(nr_tipo_doacao,99) 		= coalesce(ie_tipo_coleta_w,99)
		AND	coalesce(nr_tipo_doacao_anterior,99) = coalesce(ie_tipo_coleta_ant_w,99)
		AND (nr_seq_derivado = nr_seq_derivado_w or coalesce(nr_seq_derivado::text, '') = '')
		AND (nr_seq_derivado_ant = nr_seq_derivado_ant_w or coalesce(nr_seq_derivado_ant::text, '') = '');

	END IF;

	IF (coalesce(nr_sequencia_w::text, '') = '') THEN

		SELECT	MAX(nr_sequencia),
			MAX(qt_dias_ult_dia),
			MAX(qt_doacao_ano),
			MAX(nr_tipo_doacao),
			MAX(nr_tipo_doacao_anterior),
			MAX(ie_considerar_tipo_bolsa)
		INTO STRICT	nr_sequencia_w,
			qt_dias_ult_doacao_w,
			qt_doacao_ano_w,
			ie_tipo_doacao_reg_w,
			ie_tipo_doacao_ant_reg_w,
			ie_considera_tipo_bolsa_w
		FROM	san_regra_doacao
		WHERE	ie_sexo = ie_sexo_w
		AND 	coalesce(nr_tipo_doacao,99) = coalesce(ie_tipo_coleta_w,99)
		AND	coalesce(nr_tipo_doacao_anterior::text, '') = ''
		AND (nr_seq_derivado = nr_seq_derivado_w or coalesce(nr_seq_derivado::text, '') = '')
		AND (nr_seq_derivado_ant = nr_seq_derivado_ant_w or coalesce(nr_seq_derivado_ant::text, '') = '');

	END IF;

	--Se não exisitir regra por tipo (aférese/Sangue total) e nem por doação mista, pegar a regra normal
	IF (coalesce(nr_sequencia_w::text, '') = '') THEN

		SELECT	MAX(nr_sequencia),
			MAX(qt_dias_ult_dia),
			MAX(qt_doacao_ano)
		INTO STRICT	nr_sequencia_w,
			qt_dias_ult_doacao_w,
			qt_doacao_ano_w
		FROM	san_regra_doacao
		WHERE	ie_sexo = ie_sexo_w
		AND	coalesce(ie_tipo_bolsa::text, '') = ''
		AND	coalesce(nr_tipo_doacao_anterior::text, '') = ''
		AND	coalesce(nr_tipo_doacao_anterior::text, '') = ''
		AND (nr_seq_derivado = nr_seq_derivado_w or coalesce(nr_seq_derivado::text, '') = '')
		AND (nr_seq_derivado_ant = nr_seq_derivado_ant_w or coalesce(nr_seq_derivado_ant::text, '') = '');

	END IF;

	IF (nr_sequencia_w > 0) THEN

		IF (qt_dias_ult_doacao_w > 0) THEN

			SELECT	MAX(dt_doacao)
			INTO STRICT 	dt_doacao_w
			FROM	san_doacao
			WHERE	cd_pessoa_fisica = cd_pessoa_fisica_p
 			AND 	(dt_coleta IS NOT NULL AND dt_coleta::text <> '')
			AND	nr_sequencia = nr_seq_doacao_p;

			IF	(dt_doacao_w > (clock_timestamp() - qt_dias_ult_doacao_w)) THEN
				ds_retorno_w := 'S';
			END IF;
		END IF;

		IF (qt_doacao_ano_w > 0) AND (coalesce(ie_considera_tipo_bolsa_w,'N') = 'N') THEN

			SELECT	COUNT(1)
			INTO STRICT	qt_doa_ano_w
			FROM	san_doacao
			WHERE	dt_doacao > dt_anterior_w
			AND	cd_pessoa_fisica = cd_pessoa_fisica_p
 			AND 	(dt_coleta IS NOT NULL AND dt_coleta::text <> '');

			IF (qt_doa_ano_w >= qt_doacao_ano_w) THEN
				ds_retorno_w := 'S';
			END IF;

		ELSIF (qt_doacao_ano_w > 0) AND (coalesce(ie_considera_tipo_bolsa_w,'N') = 'S') THEN

			SELECT (COUNT(1) * 2)
			INTO STRICT	qt_bolsa_simples_w
			FROM	san_doacao
			WHERE	dt_doacao > dt_anterior_w
			AND	cd_pessoa_fisica = cd_pessoa_fisica_p
 			AND 	(dt_coleta IS NOT NULL AND dt_coleta::text <> '')
			AND	ie_tipo_coleta = ie_tipo_coleta_w
			AND	ie_tipo_bolsa 	= '1';

			SELECT	COUNT(1)
			INTO STRICT	qt_bolsa_dupla_w
			FROM	san_doacao
			WHERE	dt_doacao > dt_anterior_w
			AND	cd_pessoa_fisica = cd_pessoa_fisica_p
 			AND 	(dt_coleta IS NOT NULL AND dt_coleta::text <> '')
			AND	ie_tipo_coleta  = ie_tipo_coleta_w
			AND	ie_tipo_bolsa 	= '2';

			qt_doa_ano_w := qt_bolsa_simples_w + qt_bolsa_dupla_w;

			IF (qt_doa_ano_w >= qt_doacao_ano_w ) THEN
				ds_retorno_w := 'S';
			END IF;

		END IF;
		
	END IF;

END IF;

return ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION san_obter_se_doador_inapto ( nr_seq_doacao_p bigint, cd_pessoa_fisica_p text) FROM PUBLIC;

