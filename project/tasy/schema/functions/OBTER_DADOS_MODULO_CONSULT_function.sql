-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_modulo_consult ( cd_consultor_p bigint, nr_seq_modulo_p bigint, cd_funcao_p bigint, opcao text) RETURNS bigint AS $body$
DECLARE


/*opcao  1 - conhecimento por funcao
                2 - conhecimento por modulo (
*/
pr_con_funcao_w		bigint;
pr_con_modulo_w		bigint;
qt_funcao_mod_w		bigint;
qt_sum_tl_mod_w		bigint;



BEGIN

	SELECT 		COUNT(cd_funcao)
	into STRICT		qt_funcao_mod_w
	FROM (SELECT   DISTINCT(v.cd_funcao) cd_funcao
			FROM 	  COM_CONS_GEST_CON_MOD u,
		                  COM_CONS_GEST_CON_FUN v
			WHERE	  u.nr_sequencia = v.nr_seq_conhecimento
			AND	  (v.pr_conhecimento IS NOT NULL AND v.pr_conhecimento::text <> '')
			and 	  v.cd_funcao > 0
			AND	  u.nr_seq_mod_impl = nr_seq_modulo_p) alias3;

	SELECT	        max(f.pr_conhecimento)
	into STRICT		pr_con_funcao_w
	FROM		com_canal_consultor c,
			COM_CONS_GEST_CON_MOD m,
			COM_CONS_GEST_CON_FUN f
	WHERE		c.nr_sequencia = m.nr_seq_consultor
	AND		m.nr_sequencia = f.nr_seq_conhecimento
	AND		(f.pr_conhecimento IS NOT NULL AND f.pr_conhecimento::text <> '')
	AND 		coalesce(m.nr_seq_gest_con::text, '') = ''
	AND		m.nr_seq_mod_impl = nr_seq_modulo_p
	AND		f.cd_funcao = cd_funcao_p
	AND		c.cd_pessoa_fisica = cd_consultor_p;


	SELECT	  	SUM(f.pr_conhecimento)
	into STRICT		qt_sum_tl_mod_w
	FROM		com_canal_consultor c,
			COM_CONS_GEST_CON_MOD m,
			COM_CONS_GEST_CON_FUN f
	WHERE		c.nr_sequencia = m.nr_seq_consultor
	AND		m.nr_sequencia = f.nr_seq_conhecimento
	AND		m.nr_seq_mod_impl = nr_seq_modulo_p
	AND		c.cd_pessoa_fisica = cd_consultor_p;

	pr_con_modulo_w := qt_sum_tl_mod_w / qt_funcao_mod_w;


	if (opcao = '1') then
		return pr_con_funcao_w;
	end if;
	if (opcao = '2') then
		return pr_con_modulo_w;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_modulo_consult ( cd_consultor_p bigint, nr_seq_modulo_p bigint, cd_funcao_p bigint, opcao text) FROM PUBLIC;

