-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_solic_material ( cd_material_p bigint, cd_estabelecimento_p bigint, ie_retorno_p text) RETURNS varchar AS $body$
DECLARE


/* ie_retorno_p
	C = Aviso chegada
	A = Aviso aprovação
	U = Urgente
	L = Permite Liberar
	I - Permite incluir  */
cd_perfil_w		integer;
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w	integer;
qt_regra_w		integer;
ie_aviso_chegada_w	varchar(1);
ie_aviso_aprov_oc_w	varchar(1);
ie_urgente_w		varchar(1);
ie_permite_liberar_w	varchar(1);
ie_permite_incluir_w		varchar(1);
ie_consignado_w			varchar(1);

c01 CURSOR FOR
SELECT	ie_aviso_chegada,
	ie_aviso_aprov_oc,
	ie_urgente,
	ie_permite_liberar,
	ie_permite_incluir
from	regra_solicitacao_material
where	cd_estabelecimento = cd_estabelecimento_p
and	coalesce(cd_perfil, cd_perfil_w) = cd_perfil_w
and	coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
and	coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
and	coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
and	((coalesce(ie_consignado, ie_consignado_w) = ie_consignado_w) or (coalesce(ie_consignado::text, '') = ''))
and (coalesce(cd_material, cd_material_p) = cd_material_p or cd_material_p = 0)
order by
	coalesce(ie_consignado,0),
	coalesce(cd_perfil,0),
	coalesce(cd_grupo_material, 0),
	coalesce(cd_subgrupo_material, 0),
	coalesce(cd_classe_material, 0),
	coalesce(cd_material, 0);



BEGIN

select	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	ie_consignado
into STRICT	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	ie_consignado_w
from	estrutura_material_v
where	cd_material = cd_material_p;

cd_perfil_w := obter_perfil_ativo;

select	count(*)
into STRICT	qt_regra_w
from	regra_solicitacao_material;

if (qt_regra_w > 0) then
	begin
	open c01;
	loop
	fetch c01 into
		ie_aviso_chegada_w,
                ie_aviso_aprov_oc_w,
                ie_urgente_w,
		ie_permite_liberar_w,
		ie_permite_incluir_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	end loop;
	close c01;
	end;
end if;

if (ie_retorno_p = 'C') then
	return ie_aviso_chegada_w;
elsif (ie_retorno_p = 'A') then
	return  ie_aviso_aprov_oc_w;
elsif (ie_retorno_p = 'U') then
	return  ie_urgente_w;
elsif (ie_retorno_p = 'L') then
	return  ie_permite_liberar_w;
elsif (ie_retorno_p = 'I') then
	return  ie_permite_incluir_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_solic_material ( cd_material_p bigint, cd_estabelecimento_p bigint, ie_retorno_p text) FROM PUBLIC;

