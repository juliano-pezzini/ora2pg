-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tempo_espera_agenda ( NR_SEQ_AGENDA_P bigint, IE_TIPO_ESPERA_P bigint ) RETURNS varchar AS $body$
DECLARE


	/* IE_TIPO_ESPERA_P
	 * 1 - Tempo decorrido desde a recepcao
	 * 2 - Tempo decorrido desde a chegada
	 * - - SELECT * FROM VALOR_DOMINIO WHERE CD_DOMINIO = 10047;
	 */
	NR_SEQ_ULTIMO_RESET_W	bigint;
	QT_TEMPO_RETORNO_W		varchar(100);

BEGIN
	SELECT
		COALESCE(MAX(NR_SEQUENCIA), 0)
	INTO STRICT
		NR_SEQ_ULTIMO_RESET_W
	FROM
		AG_CONS_TEMPO_DECOR
	WHERE
		NR_SEQ_AGENDA	= NR_SEQ_AGENDA_P
	AND IE_TIPO_ESPERA 	= IE_TIPO_ESPERA_P
	AND IE_ACAO_FINAL 	= 3 -- RESET
;
	
	SELECT
		TO_CHAR(COALESCE(SUM(
			CASE
				WHEN NR_SEQUENCIA > NR_SEQ_ULTIMO_RESET_W AND IE_ACAO_FINAL IN (1, 2) THEN OBTER_DIF_DATA(DT_INICIO, COALESCE(DT_FIM, clock_timestamp()), 'TM')
				ELSE '0'
			END
			), 0))
	INTO STRICT
		QT_TEMPO_RETORNO_W
	FROM
		AG_CONS_TEMPO_DECOR
	WHERE
		NR_SEQ_AGENDA	= NR_SEQ_AGENDA_P
	AND IE_TIPO_ESPERA 	= IE_TIPO_ESPERA_P
	AND IE_ACAO_FINAL 	<> 3 -- RESET
	;

	SELECT
	   TO_CHAR(TRUNC((QT_TEMPO_RETORNO_W * 60) / 3600), 'FM9900') || ':' ||
	   TO_CHAR(TRUNC(MOD((QT_TEMPO_RETORNO_W * 60), 3600) / 60), 'FM00') AS MIN_TO_HOUR
    INTO STRICT
        QT_TEMPO_RETORNO_W
	
	;

	RETURN QT_TEMPO_RETORNO_W;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tempo_espera_agenda ( NR_SEQ_AGENDA_P bigint, IE_TIPO_ESPERA_P bigint ) FROM PUBLIC;

