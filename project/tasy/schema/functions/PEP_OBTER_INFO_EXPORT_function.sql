-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pep_obter_info_export ( ie_item_p text) RETURNS varchar AS $body$
DECLARE


-- Constantes
ConstEvolucao    varchar(20) := 'EVOLUCAO';
ConstSumarioAlta varchar(20) := 'ATEND_SUMARIO_ALTA';
ConstDadosDemograficos varchar(20) := 'PESSOA_FISICA';
ConstHistAlergias varchar(20) := 'PACIENTE_ALERGIA';
ConstHistCirurgias varchar(100) := 'HISTORICO_SAUDE_CIRURGIA';
ConstHistMedicUso varchar(50) := 'PACIENTE_MEDIC_USO';
ConstHistExamesDoPac varchar(20) := 'PACIENTE_EXAME';
ConstDiagnosticos varchar(50) := 'DIAGNOSTICO_DOENCA';

ds_retorno_w     varchar(32000);


BEGIN

    case ie_item_p

        when ConstEvolucao then
          ds_retorno_w :=
            'SELECT  a.*, ' ||
            '        substr(obter_nome_pessoa_fisica(cd_pessoa_fisica, null),1,200) nm_pessoa_fisica, ' ||
            '        substr(obter_nome_pessoa_fisica(cd_medico, null),1,200) nm_medico, ' ||
            '        substr(obter_valor_dominio(72, ie_tipo_evolucao),1,200) ds_tipo_evolucao, ' ||
            '        substr(obter_desc_espec_medica(cd_especialidade),1,50) ds_especialidade, ' ||
            '        substr(obter_desc_espec_medica(cd_especialidade_medico),1,50) ds_especialidade_prof, ' ||
            '        substr(obter_nome_pessoa_fisica(cd_medico_parecer, null),1,200) nm_medico_parecer, ' ||
            '        substr(obter_nome_setor(cd_setor_atendimento),1,40) ds_setor_atendimento, ' ||
            '        substr(obter_desc_cido_topografia(cd_topografia),1,100) ds_topografia, ' ||
            '        substr(obter_cor_tipo_evolucao(ie_evolucao_clinica),1,15) ds_cor_tipo_evolucao, ' ||
            '        SUBSTR(obter_descricao_padrao(''CAN_ESTADO_DOENCA'',''DS_ESTADO'',a.cd_estado_doenca),1,255) ds_estado_doenca, ' ||
            '        SUBSTR(obter_descricao_padrao(''CAN_ESTADO_PACIENTE'',''DS_ESTADO'',a.ie_estado_pac_fim_trat),1,255) ds_estado_pac_fim_trat ' ||
            'FROM evolucao_paciente a  ' ||
            'WHERE   exists  ' ||
            '        ( ' ||
            '        select x.cd_evolucao  ' ||
            '        from   evolucao_paciente x  ' ||
            '        where  x.nr_atendimento = :nr_atendimento ' ||
            '        and    x.cd_evolucao = a.cd_evolucao ' ||
            '        and    dt_inativacao is null ' ||
            '        and    dt_liberacao is not null ' ||
            '        ) ';

        when ConstSumarioAlta then
          ds_retorno_w :=
            ' SELECT  *  ' ||
            ' FROM   atend_sumario_alta a, ' ||
            '        atend_sumario_alta_resumo b ' ||
            ' WHERE  b.nr_seq_atend_sumario = a.nr_sequencia  ' ||
            ' AND    a.nr_atendimento = :nr_atendimento ' ||
            ' AND    a.dt_inativacao is null ' ||
            ' AND    a.dt_liberacao is not null';

	when ConstDadosDemograficos then
          ds_retorno_w :=
		' select * '||
		'	from pessoa_fisica '||
		'	where cd_pessoa_fisica = ( '||
		'	select max(cd_pessoa_fisica) '||
		'	from atendimento_paciente '||
		'	where nr_atendimento = :nr_atendimento '||
		'	) ';

	when ConstHistAlergias then
          ds_retorno_w :=
		' select a.* '||
		' from paciente_alergia a '||
		' where a.nr_atendimento = :nr_atendimento '||
		' and    a.dt_inativacao is null '||
		' and    a.dt_liberacao is not null '||
		' order by dt_registro desc ';

	when ConstHistCirurgias then
          ds_retorno_w :=
		' select a.*, '||
		' substr(Obter_Desc_Procedimento(CD_PROCEDIMENTO, IE_ORIGEM_PROCED), 1, 255) DS_PROCEDIMENTO '||
		' from historico_saude_cirurgia a '||
		' where a.nr_atendimento = :nr_atendimento '||
		' and    a.dt_inativacao is null '||
		' and    a.dt_liberacao is not null '||
		' order by dt_cirurgia desc ';

	when ConstHistMedicUso then
          ds_retorno_w :=
		' select a.*, '||
		' substr(nvl(NVL(obter_desc_material(a.CD_MATERIAL), a.DS_MEDICAMENTO), a.DS_MEDICAMENTO), 1, 100) EXP_MATERIAL_TASY_DESC '||
		' from paciente_medic_uso a '||
		' where a.nr_atendimento = :nr_atendimento '||
		' and    a.dt_inativacao is null '||
		' and    a.dt_liberacao is not null '||
		' order by dt_registro desc ';

	when ConstHistExamesDoPac then
          ds_retorno_w :=
		' select a.* '||
		' from paciente_exame a '||
		' where a.cd_pessoa_fisica = ( '||
		' select max(cd_pessoa_fisica) '||
		' from atendimento_paciente '||
		' where nr_atendimento = :nr_atendimento) '||
		' and a.dt_inativacao is null '||
		' and a.dt_liberacao is not null '||
		' order by dt_atualizacao desc ';

	when ConstDiagnosticos then
          ds_retorno_w :=
		' select a.*, '||
		' substr(obter_desc_cid(CD_DOENCA), 1, 200) DS_CID_DOENCA '||
		' from diagnostico_doenca a '||
		' where a.nr_atendimento = :nr_atendimento '||
		' and    a.dt_inativacao is null '||
		' and    a.dt_liberacao is not null '||
		' order by dt_diagnostico desc ';

    end case;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pep_obter_info_export ( ie_item_p text) FROM PUBLIC;

