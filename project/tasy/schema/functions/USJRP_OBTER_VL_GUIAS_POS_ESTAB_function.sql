-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION usjrp_obter_vl_guias_pos_estab (nr_seq_fatura_p pls_fatura.nr_sequencia%type, ie_tipo_opcao_p text) RETURNS bigint AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Retornar os valores de pos estabelecidos por guia, separados por distribuição.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [ x ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
--	IE_OPCAO
-- CHMC	- Consultas e honorários médicos cooperados
-- CHMN	- Consultas e honorários médicos contratados
-- ETC	- Exames e terapias cooperados
-- ETN	- Exames e terapias contratados
-- ETR	- Exames e terapias rede própria
-- IRP	- Internações Rede própria
-- IRC	- Internações Rede contratada
--	 IE_TIPO_GUIA_W - Dominio 1746
-- 	IE_TIPO_RELACAO_W - Dominio 1668
nr_seq_conta_w		pls_conta.nr_sequencia%type;
nr_seq_prestador_exec_w pls_prestador.nr_sequencia%type;
ie_tipo_guia_w		pls_conta.ie_tipo_guia%type;
vl_retorno_w		pls_conta_pos_estabelecido.vl_beneficiario%type;
ie_opcao_w		varchar(20);
nr_nota_fiscal_w	nota_fiscal.nr_sequencia%type;
ie_nf_w			varchar(2);


BEGIN
--inicializando variaveis
vl_retorno_w 		:= 0;
nr_seq_conta_w		:= 0;
nr_seq_prestador_exec_w := 0;
ie_tipo_guia_w		:= 0;
ie_opcao_w 		:= upper(ie_tipo_opcao_p);

begin
select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_nf_w
from	pls_fatura	b
where	b.nr_sequencia	= nr_seq_fatura_p
and	exists (SELECT	1
		from	nota_fiscal c
		where	c.nr_seq_fatura	= b.nr_sequencia);
exception
when others then
	ie_nf_w := 'N';
end;

--buscar a conta principal para achar a guia principal
if (nr_seq_fatura_p IS NOT NULL AND nr_seq_fatura_p::text <> '') and (ie_nf_w = 'N') then
	select	max(pls_obter_conta_principal(d.cd_guia, d.nr_seq_analise, d.nr_seq_segurado, d.nr_seq_prestador)) nr_seq_conta_principal
	into STRICT	nr_seq_conta_w
	from	pls_conta		d,
		pls_fatura_conta	c,
		pls_fatura_evento	b,
		pls_fatura		a
	where	a.nr_sequencia 		=	b.nr_seq_fatura
	and	b.nr_sequencia		=	c.nr_seq_fatura_evento
	and   	c.nr_seq_conta		=	d.nr_sequencia
	and	a.nr_sequencia		=	nr_seq_fatura_p;
end if;

--pego o tipo da guia principal pois no caso de Internação todas as guias serão tratadas como internação.
if (nr_seq_conta_w > 0) and (ie_nf_w = 'N') then
	select 	ie_tipo_guia,
		nr_seq_prestador_exec
	into STRICT	ie_tipo_guia_w,
		nr_seq_prestador_exec_w
	from	pls_conta
	where	nr_sequencia = nr_seq_conta_w;
end if;

if (ie_tipo_guia_w > 0) or (ie_nf_w = 'S') then
	if (nr_seq_prestador_exec_w IS NOT NULL AND nr_seq_prestador_exec_w::text <> '') and (ie_nf_w = 'N') then
		if (ie_tipo_guia_w = 5) then
			if (ie_opcao_w = 'IRP') then
				select	sum(f.vl_beneficiario) vl_item
				into STRICT	vl_retorno_w
				from	pls_conta_pos_estabelecido f,
					pls_prestador		e,
					pls_conta		d,
					pls_fatura_conta	c,
					pls_fatura_evento	b,
					pls_fatura		a
				where	a.nr_sequencia 		= b.nr_seq_fatura
				and	b.nr_sequencia		= c.nr_seq_fatura_evento
				and     c.nr_seq_conta		= d.nr_sequencia
				and	d.nr_seq_prestador_exec = e.nr_sequencia
				and     d.nr_sequencia    	= f.nr_seq_conta
				and	a.nr_sequencia		= nr_seq_fatura_p
				and     e.ie_tipo_relacao 	= 'P'
				and	f.ie_status_faturamento	= 'L';
			elsif (ie_opcao_w = 'IRC') then
				select	sum(f.vl_beneficiario) vl_item
				into STRICT	vl_retorno_w
				from	pls_conta_pos_estabelecido f,
					pls_prestador		e,
					pls_conta		d,
					pls_fatura_conta	c,
					pls_fatura_evento	b,
					pls_fatura		a
				where	a.nr_sequencia 		= b.nr_seq_fatura
				and	b.nr_sequencia		= c.nr_seq_fatura_evento
				and     c.nr_seq_conta		= d.nr_sequencia
				and	d.nr_seq_prestador_exec = e.nr_sequencia
				and     d.nr_sequencia    	= f.nr_seq_conta
				and	a.nr_sequencia		= nr_seq_fatura_p
				and	f.ie_status_faturamento	= 'L'
				and     e.ie_tipo_relacao in ('C', 'D', 'I', 'F');
			end if;
		elsif (ie_tipo_guia_w = 4) then
			if (ie_opcao_w = 'ETC') then
				select	sum(f.vl_beneficiario) vl_item
				into STRICT	vl_retorno_w
				from	pls_conta_pos_estabelecido f,
					pls_prestador		e,
					pls_conta		d,
					pls_fatura_conta	c,
					pls_fatura_evento	b,
					pls_fatura		a
				where	a.nr_sequencia 		= b.nr_seq_fatura
				and	b.nr_sequencia		= c.nr_seq_fatura_evento
				and     c.nr_seq_conta		= d.nr_sequencia
				and	d.nr_seq_prestador_exec = e.nr_sequencia
				and     d.nr_sequencia    	= f.nr_seq_conta
				and	a.nr_sequencia		= nr_seq_fatura_p
				and     e.ie_tipo_relacao 	= 'C'
				and	f.ie_status_faturamento	= 'L';
			elsif (ie_opcao_w = 'ETN') then
				select	sum(f.vl_beneficiario) vl_item
				into STRICT	vl_retorno_w
				from	pls_conta_pos_estabelecido f,
					pls_prestador		e,
					pls_conta		d,
					pls_fatura_conta	c,
					pls_fatura_evento	b,
					pls_fatura		a
				where	a.nr_sequencia 		= b.nr_seq_fatura
				and	b.nr_sequencia		= c.nr_seq_fatura_evento
				and     c.nr_seq_conta		= d.nr_sequencia
				and	d.nr_seq_prestador_exec = e.nr_sequencia
				and     d.nr_sequencia    	= f.nr_seq_conta
				and	a.nr_sequencia		= nr_seq_fatura_p
				and	f.ie_status_faturamento	= 'L'
				and     e.ie_tipo_relacao in ('F', 'D', 'I');
			elsif (ie_opcao_w = 'ETR') then
				select	sum(f.vl_beneficiario) vl_item
				into STRICT	vl_retorno_w
				from	pls_conta_pos_estabelecido f,
					pls_prestador		e,
					pls_conta		d,
					pls_fatura_conta	c,
					pls_fatura_evento	b,
					pls_fatura		a
				where	a.nr_sequencia 		= b.nr_seq_fatura
				and	b.nr_sequencia		= c.nr_seq_fatura_evento
				and     c.nr_seq_conta		= d.nr_sequencia
				and	d.nr_seq_prestador_exec = e.nr_sequencia
				and     d.nr_sequencia    	= f.nr_seq_conta
				and	a.nr_sequencia		= nr_seq_fatura_p
				and     e.ie_tipo_relacao 	= 'P'
				and	f.ie_status_faturamento	= 'L';
			end if;
		elsif (ie_tipo_guia_w	= 3) then
			if (ie_opcao_w = 'CHMC') then
				select	sum(f.vl_beneficiario) vl_item
				into STRICT	vl_retorno_w
				from	pls_conta_pos_estabelecido f,
					pls_prestador		e,
					pls_conta		d,
					pls_fatura_conta	c,
					pls_fatura_evento	b,
					pls_fatura		a
				where	a.nr_sequencia 		= b.nr_seq_fatura
				and	b.nr_sequencia		= c.nr_seq_fatura_evento
				and     c.nr_seq_conta		= d.nr_sequencia
				and	d.nr_seq_prestador_exec = e.nr_sequencia
				and     d.nr_sequencia    	= f.nr_seq_conta
				and	a.nr_sequencia		= nr_seq_fatura_p
				and     e.ie_tipo_relacao 	= 'C'
				and	f.ie_status_faturamento	= 'L';
			elsif (ie_opcao_w = 'CHMN') then
				select	sum(f.vl_beneficiario) vl_item
				into STRICT	vl_retorno_w
				from	pls_conta_pos_estabelecido f,
					pls_prestador		e,
					pls_conta		d,
					pls_fatura_conta	c,
					pls_fatura_evento	b,
					pls_fatura		a
				where	a.nr_sequencia 		= b.nr_seq_fatura
				and	b.nr_sequencia		= c.nr_seq_fatura_evento
				and     c.nr_seq_conta		= d.nr_sequencia
				and	d.nr_seq_prestador_exec = e.nr_sequencia
				and     d.nr_sequencia    	= f.nr_seq_conta
				and	a.nr_sequencia		= nr_seq_fatura_p
				and	f.ie_status_faturamento	= 'L'
				and     e.ie_tipo_relacao in ('F', 'D', 'I', 'P');
			end if;
		end if;
	elsif (coalesce(nr_seq_prestador_exec_w::text, '') = '') or (ie_nf_w = 'S') then
		if (ie_tipo_guia_w = 4) and (ie_nf_w = 'N') then
			if (ie_opcao_w = 'ETC') then
				select	coalesce(vl_fatura + vl_total_ndc, 0) vl_item
				into STRICT	vl_retorno_w
				from	pls_fatura
				where	nr_sequencia = nr_seq_fatura_p;
			end if;
		elsif (ie_tipo_guia_w = 3) and (ie_nf_w = 'N') then
			if (ie_opcao_w = 'CHMC') then
				select	coalesce(vl_fatura + vl_total_ndc, 0) vl_item
				into STRICT	vl_retorno_w
				from	pls_fatura
				where	nr_sequencia = nr_seq_fatura_p;
			end if;
		elsif (ie_tipo_guia_w = 5) or (ie_nf_w = 'S') then
			-- 4 - ie_origem_proced
			-- 53001 - Consultas e H.M. Cooperados
			-- 53002 - Consultas e H.M. Contratados
			-- 53003 - Exames e Terapias Cooperados
			-- 53004 - Exames e Terapias Rede Própria
			-- 53005 - Exames e Terapias Contratados
			-- 53006 - Internações Rede Própria
			-- 53007 - Internações Rede Contratada
			select	max(nr_sequencia)
			into STRICT	nr_nota_fiscal_w
			from	nota_fiscal
			where	nr_seq_fatura = nr_seq_fatura_p;

			if (nr_nota_fiscal_w IS NOT NULL AND nr_nota_fiscal_w::text <> '') then
				if (ie_opcao_w = 'CHMN') then	-- Consultas e H.M. Cooperados
					select	sum(vl_liquido)
					into STRICT	vl_retorno_w
					from	nota_fiscal_item
					where	nr_sequencia = nr_nota_fiscal_w
					and	cd_procedimento = 53001
					and	ie_origem_proced = 4;
				elsif (ie_opcao_w = 'CHMC') then 	-- Consultas e H.M. Contratados
					select	sum(vl_liquido)
					into STRICT	vl_retorno_w
					from	nota_fiscal_item
					where	nr_sequencia = nr_nota_fiscal_w
					and	cd_procedimento = 53002
					and	ie_origem_proced = 4;
				elsif (ie_opcao_w = 'ETN') then	-- Exames e terapias contratados
					select	sum(vl_liquido)
					into STRICT	vl_retorno_w
					from	nota_fiscal_item
					where	nr_sequencia = nr_nota_fiscal_w
					and	cd_procedimento = 53005
					and	ie_origem_proced = 4;
				elsif (ie_opcao_w = 'ETC') then	-- Exames e Terapias Cooperados
					select	sum(vl_liquido)
					into STRICT	vl_retorno_w
					from	nota_fiscal_item
					where	nr_sequencia = nr_nota_fiscal_w
					and	cd_procedimento = 53003
					and	ie_origem_proced = 4;
				elsif (ie_opcao_w = 'ETR') then	-- Exames e terapias rede própria
					select	sum(vl_liquido)
					into STRICT	vl_retorno_w
					from	nota_fiscal_item
					where	nr_sequencia = nr_nota_fiscal_w
					and	cd_procedimento = 53004
					and	ie_origem_proced = 4;
				elsif (ie_opcao_w = 'IRC') then	-- Internações Rede contratada
					select	sum(vl_liquido)
					into STRICT	vl_retorno_w
					from	nota_fiscal_item
					where	nr_sequencia = nr_nota_fiscal_w
					and	cd_procedimento = 53007
					and	ie_origem_proced = 4;
				elsif (ie_opcao_w = 'IRP') then	-- Internações Rede própria
					select	sum(vl_liquido)
					into STRICT	vl_retorno_w
					from	nota_fiscal_item
					where	nr_sequencia = nr_nota_fiscal_w
					and	cd_procedimento = 53006
					and	ie_origem_proced = 4;
				end if;
			end if;
		end if;
	end if;
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION usjrp_obter_vl_guias_pos_estab (nr_seq_fatura_p pls_fatura.nr_sequencia%type, ie_tipo_opcao_p text) FROM PUBLIC;

