-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_leucometria_calculo ( nr_seq_doacao_p bigint, nr_sequencia_p bigint, ie_tipo_p text) RETURNS bigint AS $body$
DECLARE

VL_RETORNO_W		double precision;


BEGIN

if (nr_seq_doacao_p IS NOT NULL AND nr_seq_doacao_p::text <> '') and (ie_tipo_p IS NOT NULL AND ie_tipo_p::text <> '') then
	if (ie_tipo_p ='CN_ML') then

		select  round((qt_leucometria_c1/power(10,3)),2)
		into STRICT	VL_RETORNO_W
		from	san_leucometria
		where	nr_seq_doacao = nr_seq_doacao_p
		AND	nr_sequencia	= nr_sequencia_p;

	elsif (ie_tipo_p ='TCN') then

		SELECT  round(((b.qt_coletada*(a.qt_leucometria_c1*power(10,3)))/power(10,10)),2)
		INTO STRICT	VL_RETORNO_W
		FROM	san_leucometria a,
			san_doacao b
		WHERE	b.nr_sequencia =  a.nr_seq_doacao
		AND	a.nr_seq_doacao = nr_seq_doacao_p
		AND	a.nr_sequencia	= nr_sequencia_p;

	elsif (ie_tipo_p ='CN_KG') then

		SELECT  ROUND((ROUND(b.qt_coletada*(a.qt_leucometria_c1*POWER(10,3))/b.qt_peso)/POWER(10,8)),2)
		INTO STRICT	VL_RETORNO_W
		FROM	san_leucometria a,
			san_doacao b
		WHERE	b.nr_sequencia = a.nr_seq_doacao
		AND	a.nr_seq_doacao = nr_seq_doacao_p
		AND	a.nr_sequencia	= nr_sequencia_p;

	elsif (ie_tipo_p ='VH') then
		SELECT 	round(((b.qt_coletada*a.qt_volume_globular)/100))
		INTO STRICT	VL_RETORNO_W
		FROM	san_leucometria a,
			san_doacao b
		WHERE	b.nr_sequencia = a.nr_seq_doacao
		AND	(a.qt_volume_globular IS NOT NULL AND a.qt_volume_globular::text <> '')
		AND	a.nr_seq_doacao = nr_seq_doacao_p
		AND	a.nr_sequencia	= nr_sequencia_p;

	elsif (ie_tipo_p ='CD34_KG') then

		SELECT  ROUND((((((b.qt_coletada * (a.qt_leucometria_c1*POWER(10,3)))/b.qt_peso)*a.cd_34_percent)/100)/POWER(10,6)),4)
		INTO STRICT	VL_RETORNO_W
		FROM	san_leucometria a,
			san_doacao b
		WHERE	b.nr_sequencia = a.nr_seq_doacao
		AND	a.nr_seq_doacao = nr_seq_doacao_p
		AND	a.nr_sequencia	= nr_sequencia_p;

	elsif (ie_tipo_p ='V2') then

		SELECT	round((dividir((a.qt_coletada*b.qt_leucometria_c1),450))::numeric,2)
		INTO STRICT	VL_RETORNO_W
		FROM	san_doacao a,
			san_leucometria b
		WHERE	a.nr_sequencia = b.nr_seq_doacao
		AND	b.nr_seq_doacao = nr_seq_doacao_p
		AND	b.nr_sequencia	= nr_sequencia_p;

	end if;
end if;
return	VL_RETORNO_W;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_leucometria_calculo ( nr_seq_doacao_p bigint, nr_sequencia_p bigint, ie_tipo_p text) FROM PUBLIC;

