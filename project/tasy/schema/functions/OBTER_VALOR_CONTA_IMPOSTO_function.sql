-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_conta_imposto ( nr_interno_conta_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/*ie_opcao_p

1	vl_base_sem_imposto
2	vl_base_com_imposto
3	vl_imposto
4	vl_total
*/
vl_procedimento_w	double precision;
vl_material_w		double precision;
vl_base_sem_imposto_w	double precision;
vl_base_com_imposto_w	double precision;
vl_imposto_w		double precision;


BEGIN

if (ie_opcao_p in (1,4)) then
	begin
	select	sum(coalesce(vl_procedimento,0))
	into STRICT	vl_procedimento_w
	from	procedimento_paciente a
	where	a.nr_interno_conta = nr_interno_conta_p
	and	coalesce(a.nr_seq_proc_pacote::text, '') = ''
	and	not exists (	SELECT	1
				from	propaci_imposto x
				where	x.nr_seq_propaci = a.nr_sequencia);

	select	sum(coalesce(vl_material,0)) vl_material
	into STRICT	vl_material_w
	from	material_atend_paciente a
	where	a.nr_interno_conta = nr_interno_conta_p
	and	coalesce(a.nr_seq_proc_pacote::text, '') = ''
	and	not exists (	SELECT	1
				from	matpaci_imposto x
				where	x.nr_seq_matpaci = a.nr_sequencia);

	vl_base_sem_imposto_w	:= coalesce(vl_material_w,0) + coalesce(vl_procedimento_w,0);
	end;
end if;

if (ie_opcao_p in (2,4)) then
	begin

	select	sum(coalesce(vl_procedimento,0))
	into STRICT	vl_procedimento_w
	from	procedimento_paciente x
	where	x.nr_interno_conta 	= nr_interno_conta_p
	and	exists (	SELECT	1
			from	propaci_imposto y
			where	y.nr_seq_propaci = x.nr_sequencia);

	select	sum(coalesce(vl_material,0))
	into STRICT	vl_material_w
	from	material_atend_paciente x
	where	x.nr_interno_conta	= nr_interno_conta_p
	and	exists (	SELECT	1
			from	matpaci_imposto y
			where	y.nr_seq_matpaci = x.nr_sequencia);

	vl_base_com_imposto_w	:= coalesce(vl_material_w,0) + coalesce(vl_procedimento_w,0);
	end;
end if;

if (ie_opcao_p in (3,4)) then
	begin

	select	sum(coalesce(a.vl_imposto_proc,0)) + sum(coalesce(a.vl_imposto_mat,0))
	into STRICT	vl_imposto_w
	from (SELECT	sum(coalesce(vl_imposto,0)) vl_imposto_proc,
			0 vl_imposto_mat
		from	procedimento_paciente x,
			propaci_imposto y
		where	x.nr_interno_conta 	= nr_interno_conta_p
		and	y.nr_seq_propaci 	= x.nr_sequencia
		
union all

		SELECT	0 vl_imposto_proc,
			sum(coalesce(vl_imposto,0)) vl_imposto_mat
		from	material_atend_paciente x,
			matpaci_imposto y
		where	x.nr_interno_conta 	= nr_interno_conta_p
		and	y.nr_seq_matpaci 	= x.nr_sequencia) a;
	end;
end if;



if (ie_opcao_p = 1) then

	return 	vl_base_sem_imposto_w;

elsif (ie_opcao_p = 2) then

	return	vl_base_com_imposto_w;

elsif (ie_opcao_p = 3) then

	return	vl_imposto_w;

elsif (ie_opcao_p = 4) then

	return	vl_base_sem_imposto_w + vl_base_com_imposto_w + vl_imposto_w;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_conta_imposto ( nr_interno_conta_p bigint, ie_opcao_p text) FROM PUBLIC;

