-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_contrato_plan_inter ( nr_seq_contrato_p bigint, nr_seq_intercambio_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
/* 
ie_opcao_p 
E - Estipulante 
D - Data do contrato 
CO - Congênere 
DR - Data Rescisão 
TE - Tipo de estipulante 
C - Código do estipulante (CPF ou CNPJ) 
EST - Estabelecimento 
CD - Código da empresa na operada 
CA - Código anterior 
*/
 
 
ds_retorno_w			varchar(255);
nm_estipulante_w		varchar(255);
dt_contrato_w			timestamp;
nr_seq_congenere_w		bigint;
ds_congenere_w			varchar(255);
dt_rescisao_contrato_w		timestamp;
cd_estipulante_w		varchar(14);
cd_estabelecimento_w		varchar(4);
cd_operadora_empresa_w		bigint;
cd_cod_anterior_w		varchar(20);
ie_tipo_estipulante_w		varchar(20);


BEGIN 
 
if (ie_opcao_p = 'E') then 
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then 
		ds_retorno_w	:= pls_obter_dados_contrato(nr_seq_contrato_p,'S');
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then 
		select	substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc),1,200) 
		into STRICT	ds_retorno_w 
		from	pls_intercambio 
		where	nr_sequencia	= nr_seq_intercambio_p;
	end if;
elsif (ie_opcao_p = 'D') then 
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then 
		select	to_char(dt_contrato,'dd/mm/yyyy') 
		into STRICT	ds_retorno_w 
		from	pls_contrato 
		where	nr_sequencia	= nr_seq_contrato_p;
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then 
		select	to_char(dt_inclusao,'dd/mm/yyyy') 
		into STRICT	ds_retorno_w 
		from	pls_intercambio 
		where	nr_sequencia	= nr_seq_intercambio_p;
	end if;
elsif (ie_opcao_p = 'CO') then 
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then 
		select	nr_seq_congenere 
		into STRICT	nr_seq_congenere_w 
		from	pls_contrato 
		where	nr_sequencia	= nr_seq_contrato_p;
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then 
		select	CASE WHEN coalesce(nr_seq_congenere::text, '') = '' THEN nr_seq_oper_congenere  ELSE nr_seq_congenere END  
		into STRICT	nr_seq_congenere_w 
		from	pls_intercambio 
		where	nr_sequencia	= nr_seq_intercambio_p;
	end if;
	 
	if (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '') then 
		select	substr(obter_nome_pf_pj(null,cd_cgc),1,255) 
		into STRICT	ds_retorno_w 
		from	pls_congenere 
		where	nr_sequencia = nr_seq_congenere_w;
	end if;
elsif (ie_opcao_p = 'DR') then 
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then 
		select	to_char(dt_rescisao_contrato,'dd/mm/yyyy') 
		into STRICT	ds_retorno_w 
		from	pls_contrato 
		where	nr_sequencia	= nr_seq_contrato_p;
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then 
		select	to_char(dt_exclusao,'dd/mm/yyyy') 
		into STRICT	ds_retorno_w 
		from	pls_intercambio 
		where	nr_sequencia	= nr_seq_intercambio_p;
	end if;
elsif (ie_opcao_p = 'TE') then 
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then 
		select	CASE WHEN coalesce(cd_pf_estipulante::text, '') = '' THEN  'PJ'  ELSE 'PF' END  
		into STRICT	ds_retorno_w 
		from	pls_contrato 
		where	nr_sequencia	= nr_seq_contrato_p;
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then 
		select	CASE WHEN coalesce(cd_pessoa_fisica::text, '') = '' THEN  'PJ'  ELSE 'PF' END  
		into STRICT	ds_retorno_w 
		from	pls_intercambio 
		where	nr_sequencia	= nr_seq_intercambio_p;
	end if;
elsif (ie_opcao_p = 'C') then 
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then 
		select	CASE WHEN coalesce(cd_pf_estipulante::text, '') = '' THEN  cd_cgc_estipulante  ELSE cd_pf_estipulante END  
		into STRICT	ds_retorno_w 
		from	pls_contrato 
		where	nr_sequencia	= nr_seq_contrato_p;
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then 
		select	CASE WHEN coalesce(cd_pessoa_fisica::text, '') = '' THEN  cd_cgc  ELSE cd_pessoa_fisica END  
		into STRICT	ds_retorno_w 
		from	pls_intercambio 
		where	nr_sequencia	= nr_seq_intercambio_p;
	end if;
elsif (ie_opcao_p = 'EST') then 
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then 
		select	cd_estabelecimento 
		into STRICT	ds_retorno_w 
		from	pls_contrato 
		where	nr_sequencia	= nr_seq_contrato_p;
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then 
		select	cd_estabelecimento 
		into STRICT	ds_retorno_w 
		from	pls_intercambio 
		where	nr_sequencia	= nr_seq_intercambio_p;
	end if;
elsif (ie_opcao_p = 'CD') then 
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then 
		select	cd_operadora_empresa 
		into STRICT	ds_retorno_w 
		from	pls_contrato 
		where	nr_sequencia	= nr_seq_contrato_p;
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then 
		select	cd_operadora_empresa 
		into STRICT	ds_retorno_w 
		from	pls_intercambio 
		where	nr_sequencia	= nr_seq_intercambio_p;
	end if;
elsif (ie_opcao_p = 'CA') then 
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then 
		select	cd_cod_anterior 
		into STRICT	ds_retorno_w 
		from	pls_contrato 
		where	nr_sequencia	= nr_seq_contrato_p;
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then 
		select	cd_sistema_anterior 
		into STRICT	ds_retorno_w 
		from	pls_intercambio 
		where	nr_sequencia	= nr_seq_intercambio_p;
	end if;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_contrato_plan_inter ( nr_seq_contrato_p bigint, nr_seq_intercambio_p bigint, ie_opcao_p text) FROM PUBLIC;

