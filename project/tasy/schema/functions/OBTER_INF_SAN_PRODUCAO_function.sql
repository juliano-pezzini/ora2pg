-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_san_producao ( nr_seq_prod_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(255);
nr_seq_doacao_w		bigint;
cd_pessoa_fisica_w	varchar(14);
nm_pessoa_fisica_w	varchar(100);	
dt_doacao_w		timestamp;
pr_hematocrito_w	bigint;
dt_vencimento_w		varchar(110);
nr_sangue_w		varchar(20);
qt_volume_w       smallint;
dt_producao_w		varchar(110);
ie_irradiado_w		varchar(1);
nr_seq_derivado_w	bigint;
ie_existe_w		varchar(1);
ds_derivado_w		varchar(50);
ds_tipo_sangue_w	varchar(20);

 
 

BEGIN 
 
if (nr_seq_prod_p IS NOT NULL AND nr_seq_prod_p::text <> '') then 
 
 
	select 	max(nr_seq_doacao), 
		max(to_char(dt_vencimento,'dd/mm/yyyy')), 
		max(qt_volume), 
		max(to_char(dt_producao,'dd/mm/yyyy')), 
		max(ie_irradiado), 
		max(nr_seq_derivado), 
		max(nr_sangue), 
		max(ds_derivado) 
	into STRICT	nr_seq_doacao_w, 
		dt_vencimento_w, 
		qt_volume_w, 
		dt_producao_w, 
		ie_irradiado_w, 
		nr_seq_derivado_w, 
		nr_sangue_w, 
		ds_derivado_w 
	from	san_producao_v 
	where	nr_sequencia	= nr_seq_prod_p;
	 
	 
	select CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
	into STRICT	ie_existe_w		 
	from 	san_doacao 
	where	nr_sequencia = nr_seq_doacao_w;
 
	if (ie_existe_w = 'S') then 
	 
		select	max(cd_pessoa_fisica), 
			obter_nome_pf(max(cd_pessoa_fisica)), 
			max(dt_doacao), 
			max(pr_hematocrito), 
			max(nr_sangue) 
		into STRICT	cd_pessoa_fisica_w, 
			nm_pessoa_fisica_w, 
			dt_doacao_w, 
			pr_hematocrito_w, 
			nr_sangue_w 
		from  	san_doacao 
		where 	nr_sequencia = nr_seq_doacao_w;
		 
	end if;
	 
	if (ie_opcao_p = 'C') then 
		ds_retorno_w:=	cd_pessoa_fisica_w;
	elsif (ie_opcao_p = 'D') then 
		ds_retorno_w:= to_char(dt_doacao_w,'dd/mm/yyyy hh24:mi:ss');	
	elsif (ie_opcao_p = 'P') then 
		ds_retorno_w:= pr_hematocrito_w;
	elsif (ie_opcao_p = 'INI') then 
		ds_retorno_w:= obter_iniciais_nome(cd_pessoa_fisica_w,NULL);
	elsif (ie_opcao_p = 'DV') then 
		ds_retorno_w:= dt_vencimento_w;
	elsif (ie_opcao_p = 'S') then 
		ds_retorno_w:= nr_sangue_w;
	elsif (ie_opcao_p = 'N') then 
		ds_retorno_w:= nr_seq_doacao_w;
	elsif (ie_opcao_p = 'M') then 
		ds_retorno_w:= nm_pessoa_fisica_w;
	elsif (ie_opcao_p = 'V') then 
		ds_retorno_w:= qt_volume_w;
	elsif (ie_opcao_p = 'DP') then 
		ds_retorno_w:= dt_producao_w;
	elsif (ie_opcao_p = 'IR') then 
		ds_retorno_w:= ie_irradiado_w;
	elsif (ie_opcao_p = 'DS') then 
		ds_retorno_w:= ds_derivado_w;
	else 
		ds_retorno_w:= nm_pessoa_fisica_w;
	end if;
	 
	 
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_san_producao ( nr_seq_prod_p bigint, ie_opcao_p text) FROM PUBLIC;

