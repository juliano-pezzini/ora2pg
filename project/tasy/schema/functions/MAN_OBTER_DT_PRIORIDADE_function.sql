-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_dt_prioridade ( nr_seq_equipamento_p bigint, ie_prioridade_p text, dt_conclusao_p timestamp, dt_prioridade_p timestamp, nr_seq_grupo_trab_p bigint, nr_seq_grupo_planej_p bigint) RETURNS timestamp AS $body$
DECLARE


dt_varchar_w			varchar(20);
nr_seq_tipo_equip_w		bigint;
qt_dias_w			smallint;
qt_horas_w			double precision;
ie_regra_dia_w			varchar(15);
cd_estabelecimento_w		smallint	:= wheb_usuario_pck.get_cd_estabelecimento;
dt_retorno_w			timestamp;

c01 CURSOR FOR
	SELECT	a.qt_dias,
		a.qt_horas,
		coalesce(a.ie_regra_dia,'C')
	FROM man_regra_dias_prioridade a
LEFT OUTER JOIN man_regra_dias_prior_lib b ON (a.nr_sequencia = b.nr_seq_regra_dia_prior)
WHERE coalesce(b.nr_seq_equipamento,coalesce(nr_seq_equipamento_p,0))		= coalesce(nr_seq_equipamento_p,0) and coalesce(b.nr_seq_tipo_equipamento,coalesce(nr_seq_tipo_equip_w,0))	= coalesce(nr_seq_tipo_equip_w,0) and coalesce(b.nr_seq_grupo_trabalho,coalesce(nr_seq_grupo_trab_p,0)) 	= coalesce(nr_seq_grupo_trab_p,0) and coalesce(a.ie_prioridade,coalesce(ie_prioridade_p,0)) 			= coalesce(ie_prioridade_p,0) and coalesce(b.nr_seq_grupo_planej,coalesce(nr_seq_grupo_planej_p,0))		= coalesce(nr_seq_grupo_planej_p,0) and coalesce(a.ie_situacao,'A')						= 'A' order by
		coalesce(b.nr_seq_equipamento,0),
		coalesce(b.nr_seq_tipo_equipamento,0),
		coalesce(b.nr_seq_grupo_trabalho,0),
		coalesce(b.nr_seq_grupo_planej,0);


BEGIN
select	coalesce(nr_seq_tipo_equip,0)
into STRICT	nr_seq_tipo_equip_w
from	man_equipamento
where	nr_sequencia	= nr_seq_equipamento_p;

open C01;
loop
fetch C01 into
	qt_dias_w,
	qt_horas_w,
	ie_regra_dia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	null;
	end;
end loop;
close C01;

dt_retorno_w	:= dt_conclusao_p;

if (coalesce(qt_horas_w,0) = 0) then	/*Se for por dias*/
	begin
	if (ie_regra_dia_w = 'U') then	/*Se dias úteis*/
		begin
		if (ie_prioridade_p = 'E') then
			begin
			if (coalesce(qt_dias_w,0) <> 0) then
				dt_retorno_w	:= obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,0));
			else
				dt_varchar_w	:= substr(to_char(dt_prioridade_p, 'dd/mm/yyyy'),1,10) || ' ' || '18:00:00';
				dt_retorno_w	:= to_date(dt_varchar_w,'dd/mm/yyyy hh24:mi:ss');

				if (dt_prioridade_p > dt_retorno_w) then
					dt_varchar_w	:= substr(to_char(dt_prioridade_p+1, 'dd/mm/yyyy'),1,10) || ' ' || '18:00:00';
					dt_retorno_w	:= to_date(dt_varchar_w,'dd/mm/yyyy hh24:mi:ss');
				end if;
			end if;
			end;
		elsif (ie_prioridade_p = 'A') then
			dt_retorno_w	:= obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,7));
		elsif (ie_prioridade_p = 'M') then
			dt_retorno_w	:= obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,14));
		elsif (ie_prioridade_p = 'B') then
			dt_retorno_w	:= obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,30));
		elsif (ie_prioridade_p = 'U') then
			dt_retorno_w	:= obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,3));
		elsif (ie_prioridade_p = 'S') and (coalesce(qt_dias_w,0) <> 0) then
			dt_retorno_w	:= obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,0));
		end if;

		dt_varchar_w	:= substr(to_char(dt_retorno_w, 'dd/mm/yyyy'),1,10) || ' ' || substr(to_char(dt_prioridade_p,'dd/mm/yyyy hh24:mi:ss'),12,8);
		dt_retorno_w	:= to_date(dt_varchar_w,'dd/mm/yyyy hh24:mi:ss');
		end;
	elsif (ie_regra_dia_w = 'R') then	/* Regra Horários de trabalho da manutenção */
		begin
		if (ie_prioridade_p = 'E') then
			begin
			if (coalesce(qt_dias_w,0) <> 0) then
				dt_retorno_w	:= man_obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,0));
			else
				dt_varchar_w	:= substr(to_char(dt_prioridade_p, 'dd/mm/yyyy'),1,10) || ' ' || '18:00:00';
				dt_retorno_w	:= to_date(dt_varchar_w,'dd/mm/yyyy hh24:mi:ss');

				if (dt_prioridade_p > dt_retorno_w) then
					dt_varchar_w	:= substr(to_char(dt_prioridade_p+1, 'dd/mm/yyyy'),1,10) || ' ' || '18:00:00';
					dt_retorno_w	:= to_date(dt_varchar_w,'dd/mm/yyyy hh24:mi:ss');
				end if;
			end if;
			end;
		elsif (ie_prioridade_p = 'A') then
			dt_retorno_w	:= man_obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,7));
		elsif (ie_prioridade_p = 'M') then
			dt_retorno_w	:= man_obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,14));
		elsif (ie_prioridade_p = 'B') then
			dt_retorno_w	:= man_obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,30));
		elsif (ie_prioridade_p = 'U') then
			dt_retorno_w	:= man_obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,3));
		elsif (ie_prioridade_p = 'S') and (coalesce(qt_dias_w,0) <> 0) then
			dt_retorno_w	:= man_obter_dia_util_periodo(cd_estabelecimento_w, dt_prioridade_p, coalesce(qt_dias_w,0));
		end if;

		dt_varchar_w	:= substr(to_char(dt_retorno_w, 'dd/mm/yyyy'),1,10) || ' ' || substr(to_char(dt_prioridade_p,'dd/mm/yyyy hh24:mi:ss'),12,8);
		dt_retorno_w	:= to_date(dt_varchar_w,'dd/mm/yyyy hh24:mi:ss');
		end;
	else	/*Se dias corridos ou sem regra*/
		begin
		if (ie_prioridade_p = 'E') then
			begin
			if (coalesce(qt_dias_w,0) <> 0) then
				dt_retorno_w	:= dt_prioridade_p + coalesce(qt_dias_w,0);
			else
				dt_varchar_w	:= substr(to_char(dt_prioridade_p, 'dd/mm/yyyy'),1,10) || ' ' || '18:00:00';
				dt_retorno_w	:= to_date(dt_varchar_w,'dd/mm/yyyy hh24:mi:ss');

				if (dt_prioridade_p > dt_retorno_w) then
					dt_varchar_w	:= substr(to_char(dt_prioridade_p+1, 'dd/mm/yyyy'),1,10) || ' ' || '18:00:00';
					dt_retorno_w	:= to_date(dt_varchar_w,'dd/mm/yyyy hh24:mi:ss');
				end if;
			end if;
			end;
		elsif (ie_prioridade_p = 'A') then
			dt_retorno_w	:= dt_prioridade_p + coalesce(qt_dias_w,7);
		elsif (ie_prioridade_p = 'M') then
			dt_retorno_w	:= dt_prioridade_p + coalesce(qt_dias_w,14);
		elsif (ie_prioridade_p = 'B') then
			dt_retorno_w	:= dt_prioridade_p + coalesce(qt_dias_w,30);
		elsif (ie_prioridade_p = 'U') then
			dt_retorno_w	:= dt_prioridade_p + coalesce(qt_dias_w,3);
		elsif (ie_prioridade_p = 'S') and (coalesce(qt_dias_w,0) <> 0) then
			dt_retorno_w	:= dt_prioridade_p + coalesce(qt_dias_w,0);
		end if;
		end;
	end if;
	end;
else	/*Se for por horas*/
	begin
	if (ie_regra_dia_w = 'R') then
		dt_retorno_w	:= man_obter_data_por_hora(dt_prioridade_p,qt_horas_w,nr_seq_grupo_planej_p,nr_seq_grupo_trab_p);
	else
		begin
		if (ie_prioridade_p <> 'E') then
			dt_retorno_w	:= dt_prioridade_p + ((qt_horas_w / 1440) * 60);
		end if;

		if (ie_prioridade_p = 'E') then
			begin
			if (coalesce(qt_horas_w,0) <> 0) then
				dt_retorno_w	:= dt_prioridade_p + ((qt_horas_w / 1440) * 60);
			else
				dt_varchar_w	:= substr(to_char(dt_prioridade_p, 'dd/mm/yyyy'),1,10) || ' ' || '18:00:00';
				dt_retorno_w	:= to_date(dt_varchar_w,'dd/mm/yyyy hh24:mi:ss');

				if (dt_prioridade_p > dt_retorno_w) then
					dt_varchar_w	:= substr(to_char(dt_prioridade_p+1, 'dd/mm/yyyy'),1,10) || ' ' || '18:00:00';
					dt_retorno_w	:= to_date(dt_varchar_w,'dd/mm/yyyy hh24:mi:ss');
				end if;
			end if;
			end;
		end if;
		end;
	end if;
	end;
end if;

return dt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_dt_prioridade ( nr_seq_equipamento_p bigint, ie_prioridade_p text, dt_conclusao_p timestamp, dt_prioridade_p timestamp, nr_seq_grupo_trab_p bigint, nr_seq_grupo_planej_p bigint) FROM PUBLIC;

