-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dado_proc_laudo ( nr_sequencia_p bigint, ie_opcao_p bigint) RETURNS varchar AS $body$
DECLARE


nr_seq_proc_w			bigint;
nr_prescricao_w			bigint;
nr_seq_prescricao_w		integer;
cd_tipo_proc_W			smallint;
dt_procedimento_w		timestamp;
nr_seq_interno_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ds_retorno_w			varchar(20);
nr_seq_proc_interno_w		bigint;
nr_seq_exame_w			bigint;

/*
ie_opcao_p
  1 - Tipo de procedimento
  2 - Data do procedimento
  3 - Sequencia interna prescr_procedimento
  4 - CD_PROCEDIMENTO
  5 - IE_ORIGEM_PROCED
  6 - Procedimento interno
  7 - Exame
*/
BEGIN

select	coalesce(max(nr_seq_proc),0) nr_seq_proc,
	coalesce(max(nr_prescricao),0) nr_prescricao,
	coalesce(max(nr_seq_prescricao),0) nr_seq_prescricao
into STRICT	nr_seq_proc_w,
	nr_prescricao_w,
	nr_seq_prescricao_w
from	laudo_paciente
where	nr_sequencia = nr_sequencia_p;

if (nr_seq_proc_w <> 0) then
	select	coalesce(max(b.cd_tipo_procedimento),0) cd_tipo_procedimento,
		coalesce(max(a.dt_procedimento),clock_timestamp()),
		coalesce(max(nr_prescricao),0),
		coalesce(max(nr_sequencia_prescricao),0),
		coalesce(max(a.cd_procedimento),0),
		coalesce(max(a.ie_origem_proced),0),
		coalesce(max(a.nr_seq_proc_interno),0),
		coalesce(max(a.nr_seq_exame),0)
	into STRICT	cd_tipo_proc_W,
		dt_procedimento_w,
		nr_prescricao_w,
		nr_seq_prescricao_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		nr_seq_proc_interno_w,
		nr_seq_exame_w
	from	procedimento b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	a.nr_sequencia	= nr_seq_proc_w;
elsif (nr_prescricao_w <> 0) and (nr_seq_prescricao_w <> 0) then
	select	coalesce(max(b.cd_tipo_procedimento),0) cd_tipo_procedimento,
		coalesce(max(a.dt_procedimento),clock_timestamp()),
		coalesce(max(a.cd_procedimento),0),
		coalesce(max(a.ie_origem_proced),0),
		coalesce(max(a.nr_seq_proc_interno),0),
		coalesce(max(a.nr_seq_exame),0)
	into STRICT	cd_tipo_proc_W,
		dt_procedimento_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		nr_seq_proc_interno_w,
		nr_seq_exame_w
	from	procedimento b,
		procedimento_paciente a
	where	a.cd_procedimento  = b.cd_procedimento
	and	a.ie_origem_proced = b.ie_origem_proced
	and	a.nr_sequencia_prescricao = nr_seq_prescricao_w
	and	a.nr_prescricao    = nr_prescricao_w;
end if;

if (ie_opcao_p = 1) then
	ds_retorno_w := cd_tipo_proc_w;
elsif (ie_opcao_p = 2) then
	ds_retorno_w := to_char(dt_procedimento_w, 'dd/mm/yyyy hh24:mi:ss');
elsif (ie_opcao_p = 3) then
	select	coalesce(max(nr_seq_interno),0)
	into STRICT	nr_seq_interno_w
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_w
	  and	nr_sequencia	= nr_seq_prescricao_w;
	ds_retorno_w := nr_seq_interno_w;
elsif (ie_opcao_p = 4) then
	ds_retorno_w := cd_procedimento_w;
elsif (ie_opcao_p = 5) then
	ds_retorno_w := ie_origem_proced_w;
elsif (ie_opcao_p = 6) then
	ds_retorno_w := nr_seq_proc_interno_w;
elsif (ie_opcao_p = 7) then
	ds_retorno_w := nr_seq_exame_w;
end if;

return	ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dado_proc_laudo ( nr_sequencia_p bigint, ie_opcao_p bigint) FROM PUBLIC;

