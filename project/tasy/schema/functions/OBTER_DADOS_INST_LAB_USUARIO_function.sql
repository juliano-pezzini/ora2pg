-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_inst_lab_usuario ( nm_usuario_p text, nm_instituto_p text, ie_opcao_p text, cd_estabelecimento_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(400);
ie_encontrou_w			varchar(1);
cd_estabelecimento_w	smallint;
ds_email_w				varchar(400);
ds_email_cursor_w		varchar(400);

C01 CURSOR FOR
	SELECT	ds_email_contingencia
	from	lab_regra_usuario_integr
	where	nm_usuario_tasy = nm_usuario_p
	and		nm_instituto	= nm_instituto_p
	and		coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
	and		ie_opcao_p = 'E';

C02 CURSOR FOR
	SELECT	ds_email_contingencia
	from	lab_regra_usuario_integr
	where	coalesce(nm_usuario_tasy::text, '') = ''
	and		nm_instituto	= nm_instituto_p
	and		coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
	and		ie_opcao_p = 'E';


BEGIN

-- IE_OPCAO_P  --
-- U = Usu√°rio
-- S = Senha
-- E = Email
cd_estabelecimento_w := coalesce(cd_estabelecimento_p,1);

select  CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_encontrou_w
from 	lab_regra_usuario_integr
where 	nm_usuario_tasy = nm_usuario_p
and		nm_instituto	= nm_instituto_p
and		coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w;


if (ie_encontrou_w = 'S') then

	select  CASE WHEN ie_opcao_p='U' THEN max(nm_usuario_integr) WHEN ie_opcao_p='S' THEN max(ds_senha_usuario_integr)  ELSE max(ds_email_contingencia) END
	into STRICT	ds_retorno_w
	from 	lab_regra_usuario_integr
	where 	nm_usuario_tasy = nm_usuario_p
	and		nm_instituto	= nm_instituto_p
	and		coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w;

	open C01;
	loop
	fetch c01 into
		ds_email_cursor_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		ds_email_w := ds_email_w||ds_email_cursor_w||';';

	end loop;
	close c01;

	if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then
		ds_retorno_w := substr(ds_email_w,1,(length(ds_email_w) -1));
	end if;

else

	select  CASE WHEN ie_opcao_p='U' THEN max(nm_usuario_integr) WHEN ie_opcao_p='S' THEN max(ds_senha_usuario_integr)  ELSE max(ds_email_contingencia) END
	into STRICT	ds_retorno_w
	from 	lab_regra_usuario_integr
	where 	nm_instituto	= nm_instituto_p
	and	coalesce(nm_usuario_tasy::text, '') = ''
	and	coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w;

	open C02;
	loop
	fetch c02 into
		ds_email_cursor_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		ds_email_w := ds_email_w||ds_email_cursor_w||';';

	end loop;
	close c02;

	if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then
		ds_retorno_w := substr(ds_email_w,1,(length(ds_email_w) -1));
	end if;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_inst_lab_usuario ( nm_usuario_p text, nm_instituto_p text, ie_opcao_p text, cd_estabelecimento_p bigint default null) FROM PUBLIC;

