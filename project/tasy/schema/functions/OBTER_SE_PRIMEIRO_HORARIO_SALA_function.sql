-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_primeiro_horario_sala ( dt_inicial_p timestamp default null, dt_final_p timestamp default null, hr_inicio_p timestamp default null, hr_final_p timestamp default null, nr_sequencia_p agenda_paciente.nr_sequencia%type DEFAULT NULL) RETURNS varchar AS $body$
DECLARE

ie_primeiro_w       varchar(2);
hr_inicio_w         agenda_paciente.hr_inicio%type;
cd_agenda_w         agenda_paciente.cd_agenda%type;
ds_hora_inicio_w    varchar(60);
ds_hora_final_w     varchar(60);
ds_inicio_w         varchar(60);
ds_final_w          varchar(60);
mascara_horas_w     varchar(60);
mascara_data_w      varchar(60);
mascara_completa_w  varchar(60);
dt_inicio_w         timestamp;
dt_final_w          timestamp;


BEGIN

mascara_horas_w     := 'hh24:mi:ss';
mascara_data_w      := 'dd/mm/yyyy';
mascara_completa_w  := mascara_data_w|| ' ' || mascara_horas_w;

-- Dados da agenda
select  hr_inicio,
        cd_agenda
into STRICT    hr_inicio_w,
        cd_agenda_w
from    agenda_paciente
where   nr_sequencia = nr_sequencia_p;

-- Pegar horas
if (coalesce(hr_inicio_p::text, '') = '')then
    ds_hora_inicio_w:= '00:00:00';
else
    ds_hora_inicio_w:= to_char(hr_inicio_p, mascara_horas_w);
end if;

if (coalesce(hr_final_p::text, '') = '')then
    ds_hora_final_w:= '23:59:00';
else
    ds_hora_final_w:= to_char(hr_final_p, mascara_horas_w);
end if;

-- Tratar data completa
ds_inicio_w := to_char(coalesce(dt_inicial_p, clock_timestamp()), mascara_data_w) || ' ' || ds_hora_inicio_w;
dt_inicio_w := to_date(ds_inicio_w, mascara_completa_w);

ds_final_w := to_char(coalesce(dt_final_p, clock_timestamp()), mascara_data_w) || ' ' || ds_hora_final_w;
dt_final_w := to_date(ds_final_w, mascara_completa_w);

-- Verificar se primeiro
select CASE WHEN to_char(hr_inicio_w, mascara_horas_w)=(   select  to_char(min(x.hr_inicio), mascara_horas_w)                                                        from    agenda_paciente x                                                        where	1 = 1                                                        and (x.dt_agenda between dt_inicio_w and dt_final_w)                                                        and     x.cd_agenda = cd_agenda_w) THEN  'S' WHEN to_char(hr_inicio_w, mascara_horas_w)=to_char(hr_inicio_w, mascara_horas_w) THEN  'N' END
into STRICT ie_primeiro_w
;

-- Retorno
return ie_primeiro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_primeiro_horario_sala ( dt_inicial_p timestamp default null, dt_final_p timestamp default null, hr_inicio_p timestamp default null, hr_final_p timestamp default null, nr_sequencia_p agenda_paciente.nr_sequencia%type DEFAULT NULL) FROM PUBLIC;

