-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gqa_validar_pontos_etapa (nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


  ie_permite_proxima_etapa_w gqa_pendencia_regra.ie_permite_proxima_etapa%TYPE;
  dt_fim_w                   gqa_protocolo_etapa_pac.dt_fim%TYPE;
  qt_resultado_w             gqa_protocolo_etapa_pac.qt_resultado%TYPE;
  qt_ponto_min_etapa_w       gqa_protocolo_etapa_pac.qt_ponto_min_etapa%TYPE;
  qt_ponto_max_etapa_w       gqa_protocolo_etapa_pac.qt_ponto_max_etapa%TYPE;
  nr_seq_etapa_sup_w         gqa_protocolo_etapa_pac.nr_seq_etapa_sup%TYPE;
  nr_seq_etapa_prot_sup_w    gqa_protocolo_etapa_pac.nr_seq_etapa_prot_sup%TYPE;
  nr_seq_etapa_w             gqa_protocolo_etapa_pac.nr_seq_etapa%TYPE;
  return_w                   varchar(1) := 'N';


BEGIN
  BEGIN
    SELECT t.qt_ponto_min_etapa
          ,t.qt_ponto_max_etapa
          ,t.nr_seq_etapa_sup
          ,t.nr_seq_etapa_prot_sup
          ,t.nr_seq_etapa
      INTO STRICT qt_ponto_min_etapa_w
          ,qt_ponto_max_etapa_w
          ,nr_seq_etapa_sup_w
          ,nr_seq_etapa_prot_sup_w
          ,nr_seq_etapa_w
      FROM gqa_protocolo_etapa_pac t
     WHERE t.nr_sequencia = nr_sequencia_p;

    SELECT t.ie_permite_proxima_etapa
      INTO STRICT ie_permite_proxima_etapa_w
      FROM gqa_pendencia_regra t
     WHERE t.nr_sequencia = nr_seq_etapa_w;
  EXCEPTION
    WHEN no_data_found THEN
      NULL;
  END;

  IF ie_permite_proxima_etapa_w = 'S' THEN
    BEGIN
      SELECT t.dt_fim
            ,t.qt_resultado
        INTO STRICT dt_fim_w
            ,qt_resultado_w
        FROM gqa_protocolo_etapa_pac t
       WHERE t.nr_sequencia = nr_seq_etapa_prot_sup_w;
    EXCEPTION
      WHEN no_data_found THEN
        NULL;
    END;

    IF (dt_fim_w IS NOT NULL AND dt_fim_w::text <> '') THEN
      IF coalesce(qt_resultado_w,0) BETWEEN qt_ponto_min_etapa_w AND qt_ponto_max_etapa_w THEN
        return_w := 'S';
      ELSE
        return_w := 'N';
      END IF;
    ELSE
      return_w := 'N';
    END IF;
  ELSIF coalesce(nr_seq_etapa_sup_w::text, '') = '' THEN
    return_w := 'S';
  ELSE
    return_w := 'N';
  END IF;

  RETURN return_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gqa_validar_pontos_etapa (nr_sequencia_p bigint) FROM PUBLIC;

