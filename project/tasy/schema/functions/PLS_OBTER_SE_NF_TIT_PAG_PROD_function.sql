-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_nf_tit_pag_prod ( nr_titulo_p bigint, ie_local_p text) RETURNS varchar AS $body$
DECLARE


nr_seq_pls_pag_prest_w		varchar(10);
cd_estabelecimento_w		integer;
nr_seq_nota_fiscal_w		bigint;
ie_exige_nf_baixa_titulo_w	varchar(2);
ie_retorno_w			varchar(1)	:= 'S';
cd_pessoa_fisica_w		varchar(10);
cd_cgc_w			varchar(14);
ie_exige_nf_pag_escrit_w	varchar(1);
ie_exige_nf_bordero_w		varchar(1);

/*
ie_local_p
B - Border√¥
P - Pagamento escritural
*/
BEGIN

select	max(nr_seq_pls_pag_prest)
into STRICT	nr_seq_pls_pag_prest_w
from	titulo_pagar
where	nr_titulo 	= nr_titulo_p
and	ie_tipo_titulo 	<> '4';

if (nr_seq_pls_pag_prest_w IS NOT NULL AND nr_seq_pls_pag_prest_w::text <> '') then
	select	max(cd_estabelecimento),
		max(nr_seq_nota_fiscal),
		max(cd_pessoa_fisica),
		max(cd_cgc)
	into STRICT	cd_estabelecimento_w,
		nr_seq_nota_fiscal_w,
		cd_pessoa_fisica_w,
		cd_cgc_w
	from	titulo_pagar
	where	nr_titulo	= nr_titulo_p;

	select	coalesce(max(ie_exige_nf_baixa_titulo),'N'),
		coalesce(max(ie_exige_nf_pag_escrit),'N'),
		coalesce(max(ie_exige_nf_bordero), 'N')
	into STRICT	ie_exige_nf_baixa_titulo_w,
		ie_exige_nf_pag_escrit_w,
		ie_exige_nf_bordero_w
	from	pls_parametro_pagamento
	where	cd_estabelecimento	= cd_estabelecimento_w;

	if	(ie_exige_nf_pag_escrit_w = 'S' AND ie_local_p = 'P') or
		(ie_exige_nf_bordero_w = 'S' AND ie_local_p = 'B') then

		if	((ie_exige_nf_baixa_titulo_w = 'S') or
			(ie_exige_nf_baixa_titulo_w = 'PF' AND cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or
			(ie_exige_nf_baixa_titulo_w = 'PJ' AND cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')) and (coalesce(nr_seq_nota_fiscal_w::text, '') = '') then
			ie_retorno_w	:= 'N';
		end if;
	end if;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_nf_tit_pag_prod ( nr_titulo_p bigint, ie_local_p text) FROM PUBLIC;

