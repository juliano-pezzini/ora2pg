-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION plt_obter_nr_seq_item ( nr_seq_item_p bigint, ie_tipo_item_p text, nr_sequencia_p bigint, nr_prescricao_p bigint, qt_item_p bigint, cd_item_p text, cd_intervalo_p text, nr_seq_leite_deriv_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, nr_seq_prot_glic_p bigint, ie_acm_sn_p text, ds_dose_diferenciada_p text) RETURNS bigint AS $body$
DECLARE


nm_tabela_w	varchar(30)	:= '';
nr_seq_item_w	bigint;

BEGIN
if (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') then
	begin
	if (ie_tipo_item_p = 'IAG') or (ie_tipo_item_p = 'IA') or (ie_tipo_item_p = 'MAT') or (ie_tipo_item_p = 'M') or (ie_tipo_item_p = 'ME') or (ie_tipo_item_p = 'SNE') or (ie_tipo_item_p = 'LD') or (ie_tipo_item_p = 'S') then
		begin
		nm_tabela_w	:= 'PRESCR_MATERIAL';
		end;
	elsif (ie_tipo_item_p = 'G') or (ie_tipo_item_p = 'C') or (ie_tipo_item_p = 'L') or (ie_tipo_item_p = 'HM') or (ie_tipo_item_p = 'I') or (ie_tipo_item_p = 'P') then
		begin
		nm_tabela_w	:= 'PRESCR_PROCEDIMENTO';
		end;
	elsif (ie_tipo_item_p = 'D') then
		begin
		nm_tabela_w	:= 'PRESCR_DIETA';
		end;
	elsif (ie_tipo_item_p = 'O') then
		begin
		nm_tabela_w	:= 'PRESCR_GASOTERAPIA';
		end;
	elsif (ie_tipo_item_p = 'E') then
		begin
		nm_tabela_w	:= 'PE_PRESCR_PROC_HOR';
		end;
	elsif (ie_tipo_item_p = 'J') then
		begin
		nm_tabela_w	:= 'REP_JEJUM';
		end;
	elsif (ie_tipo_item_p = 'NAN') or (ie_tipo_item_p = 'NPN') then
		begin
		nm_tabela_w	:= 'NUT_PAC';
		end;
	elsif (ie_tipo_item_p = 'B') then
		begin
		nm_tabela_w	:= 'PRESCR_MEDICA_ORDEM';
		end;
	elsif (ie_tipo_item_p = 'R') then
		begin
		nm_tabela_w	:= 'PRESCR_RECOMENDACAO';
		end;
	elsif (ie_tipo_item_p = 'SOL') or (ie_tipo_item_p = 'DI') then
		begin
		nm_tabela_w	:= 'PRESCR_SOLUCAO';
		end;
	end if;

	end;
end if;

if (coalesce(ie_tipo_item_p::text, '') = '') then
	begin
	nr_seq_item_w	:= null;
	end;
elsif (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
	begin
	nr_seq_item_w	:= nr_seq_item_p;
	end;
else
	begin
	if ('PRESCR_MATERIAL' = nm_tabela_w) then
		begin
		if ('LD' <> ie_tipo_item_p) then
			begin
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_item_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_p
			and	((coalesce(qt_dose,0) = coalesce(qt_item_p,coalesce(qt_dose,0)))
				or (ds_dose_diferenciada = ds_dose_diferenciada_p))
			and	cd_material	= cd_item_p
			and	coalesce(cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO');
			end;
		else
			begin
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_item_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_p
			and (coalesce(qt_dose,0) = coalesce(qt_item_p,coalesce(qt_dose,0)))
			and	cd_material	= cd_item_p
			and	coalesce(cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
			and     nr_seq_leite_deriv = nr_seq_leite_deriv_p;
			end;
		end if;
		end;
	elsif ('PRESCR_PROCEDIMENTO' = nm_tabela_w) then
		begin
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_item_w
		from	prescr_procedimento
		where	nr_prescricao		= nr_prescricao_p
		and	qt_procedimento 	= qt_item_p
		and	cd_procedimento 	= cd_item_p
		and	ie_origem_proced	= ie_origem_proced_p
		and     ((nr_seq_proc_interno = nr_seq_proc_interno_p) or
				((coalesce(nr_seq_proc_interno::text, '') = '') and (coalesce(nr_seq_proc_interno_p,0) = 0)))
		and     ((nr_seq_prot_glic = nr_seq_prot_glic_p) or
			((coalesce(nr_seq_prot_glic::text, '') = '') and (coalesce(nr_seq_prot_glic_p,0) = 0)))
		and     coalesce(cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO');
		end;
	elsif ('PRESCR_RECOMENDACAO' = nm_tabela_w) then
		begin
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_item_w
		from	prescr_recomendacao
		where	nr_prescricao		= nr_prescricao_p
		and	coalesce(qt_recomendacao,0) = coalesce(qt_item_p,coalesce(qt_recomendacao,0))
		and	coalesce(to_char(cd_recomendacao),ds_recomendacao) = cd_item_p
		and     coalesce(cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO');
		end;
	elsif ('PRESCR_GASOTERAPIA' = nm_tabela_w) then
		begin
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_item_w
		from	prescr_gasoterapia
		where	nr_prescricao		 = nr_prescricao_p
		and	coalesce(qt_gasoterapia,0)	 = coalesce(qt_item_p,coalesce(qt_gasoterapia,0))
		and	to_char(nr_seq_gas)	 = cd_item_p
		and     coalesce(cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO');
		end;
	elsif ('PE_PRESCR_PROC_HOR' = nm_tabela_w) then
		begin
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_item_w
		from	pe_prescr_proc
		where	nr_seq_prescr	= nr_prescricao_p
		and	obter_se_acm_sn(null,ie_se_necessario) = ie_acm_sn_p
		and	nr_seq_proc	= cd_item_p
		and     cd_intervalo	= cd_intervalo_p;
		end;
	else
		begin
		nr_seq_item_w	:= null;
		end;
	end if;
	end;
end if;
return	nr_seq_item_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION plt_obter_nr_seq_item ( nr_seq_item_p bigint, ie_tipo_item_p text, nr_sequencia_p bigint, nr_prescricao_p bigint, qt_item_p bigint, cd_item_p text, cd_intervalo_p text, nr_seq_leite_deriv_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, nr_seq_prot_glic_p bigint, ie_acm_sn_p text, ds_dose_diferenciada_p text) FROM PUBLIC;

