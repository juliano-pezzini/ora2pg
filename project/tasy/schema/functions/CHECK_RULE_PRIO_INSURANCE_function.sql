-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION check_rule_prio_insurance ( nr_atendimento_p atend_categoria_convenio.nr_atendimento%type) RETURNS bigint AS $body$
DECLARE


nr_atendimento_w 	atend_categoria_convenio.nr_atendimento%type;
nr_atendimento_ret_w	atend_categoria_convenio.nr_atendimento%type;
qt_insurance_without_fee_w smallint;

c_Insurances CURSOR FOR
SELECT  acc.cd_convenio     cd_convenio,
        acc.nr_prioridade   nr_prioridade,
        acc.nr_seq_interno  nr_seq_interno
from    atend_categoria_convenio acc
where   acc.nr_atendimento = nr_atendimento_p
and     coalesce(acc.nr_prioridade, 9999) <> 0;

BEGIN

nr_atendimento_w := 0;

if ((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and coalesce(pkg_i18n.get_user_locale,'pt_BR') in ('de_DE', 'de_AT'))then

	select 	count(1)
	into STRICT 	qt_insurance_without_fee_w
	from 	atend_categoria_convenio acc,
			convenio con,
			atendimento_paciente ap
	where 	ap.nr_atendimento = nr_atendimento_p
	and 	acc.nr_atendimento 	= ap.nr_atendimento
	and   	acc.cd_convenio 	= con.cd_convenio
	and 	ap.ie_tipo_atendimento = 1
	and	  	not exists (SELECT 1
					from pessoa_fisica_taxa pft
					where pft.nr_atendimento 	= acc.nr_atendimento
					and pft.nr_seq_atecaco		= acc.nr_seq_interno
					and (pft.ie_obriga_pag_adicional = 'S' or (pft.ie_obriga_pag_adicional = 'N'
										and (pft.nr_seq_justificativa IS NOT NULL AND pft.nr_seq_justificativa::text <> ''))))
	and   	obter_regra_taxa_convenio(con.ie_tipo_convenio, con.cd_convenio) = 'S';
	
	if (qt_insurance_without_fee_w > 0) then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(1076247);
	end if;

	for c_Insurances_w in c_Insurances loop
	
		if (coalesce(c_Insurances_w.nr_prioridade::text, '') = '') then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(1097429);
		end if;
		
		 nr_atendimento_ret_w	:= consisty_rule_prio_insurance(nr_atendimento_p,
									c_Insurances_w.cd_convenio, 
									c_Insurances_w.nr_prioridade, 
									c_Insurances_w.nr_seq_interno);
		if (nr_atendimento_ret_w <> 0) then						
			nr_atendimento_w := nr_atendimento_ret_w;
		end if;
	end loop;

end if;

return nr_atendimento_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION check_rule_prio_insurance ( nr_atendimento_p atend_categoria_convenio.nr_atendimento%type) FROM PUBLIC;

