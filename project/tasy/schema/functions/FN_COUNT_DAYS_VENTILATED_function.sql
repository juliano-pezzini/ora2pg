-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION fn_count_days_ventilated (PR_NR_ATENDIMENTO bigint) RETURNS bigint AS $body$
DECLARE
 vr_days_ventilated bigint;

    cr_patient CURSOR FOR
    SELECT amr.IE_RESPIRACAO
          ,amr.DT_MONITORIZACAO
      FROM atendimento_monit_resp amr
     WHERE amr.ie_situacao = 'A'
       AND coalesce(amr.dt_inativacao::text, '') = ''
       AND amr.nr_atendimento = PR_NR_ATENDIMENTO
  ORDER BY amr.DT_MONITORIZACAO DESC;

    vr_last_register varchar(20) := NULL;
    vr_last_date timestamp := NULL;


BEGIN 

    vr_days_ventilated := 0;

    FOR cr IN cr_patient LOOP
      IF vr_last_register = cr.IE_RESPIRACAO OR (cr.IE_RESPIRACAO NOT IN ('ESPONT','VMNI') AND (cr.IE_RESPIRACAO IS NOT NULL AND cr.IE_RESPIRACAO::text <> '')) THEN
        IF vr_last_date = cr.DT_MONITORIZACAO THEN
          GOTO end_loop;
        END IF;
        vr_days_ventilated := vr_days_ventilated + 1;
      ELSE
        EXIT;
      END IF;
      vr_last_date := cr.DT_MONITORIZACAO;
      vr_last_register := cr.IE_RESPIRACAO;
      <<end_loop>>
      NULL;
    END LOOP;

    RETURN(vr_days_ventilated);

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION fn_count_days_ventilated (PR_NR_ATENDIMENTO bigint) FROM PUBLIC;

