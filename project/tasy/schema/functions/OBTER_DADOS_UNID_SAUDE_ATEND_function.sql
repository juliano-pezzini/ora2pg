-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_unid_saude_atend ( nr_seq_sismama_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

					 
ds_retorno_w		varchar(255) := '';
cd_cgc_unidade_saude_w	varchar(14);
nr_seq_unidade_saude_w	bigint;
cd_estabelecimento_w	integer;
cd_cnpj_w		varchar(14);
cd_cnes_w		integer;
ds_unidade_w		varchar(255);

/*IE_OPCAO_P: 
UF; 
CDM - código do município IBGE + o sétimo digito; 
CNES; 
NM - nome da Unidade de Saúde; 
*/
 
 

BEGIN 
 
select	coalesce(max(cd_cgc_unidade_saude),''), 
	coalesce(max(nr_seq_unidade_saude),0), 
	coalesce(max(cd_estabelecimento),0) 
into STRICT	cd_cgc_unidade_saude_w, 
    nr_seq_unidade_saude_w, 
	cd_estabelecimento_w 
from	sismama_atendimento 
where	nr_sequencia = 	nr_seq_sismama_p;
 
if (nr_seq_unidade_saude_w <> 0)	then 
	begin 
		begin 
		select	max(cd_cnes), 
			max(cd_cnpj), 
			max(ds_unidade_saude) 
		into STRICT	cd_cnes_w, 
			cd_cnpj_w, 
			ds_unidade_w 
		from	sus_unidade_saude 
		where	nr_sequencia = nr_seq_unidade_saude_w;
		exception 
			when others then 
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(279133);
			end;
	 
	if (ie_opcao_p = 'UF') then 
		select	substr(obter_dados_pf_pj(null,cd_cnpj_w,'UF'),1,2) 
		into STRICT	ds_retorno_w 
		;
	elsif (ie_opcao_p = 'CDM') then 
		select	substr(obter_dados_pf_pj(null,cd_cnpj_w,'CDM')||Calcula_Digito('MODULO10',obter_dados_pf_pj(null,cd_cnpj_w,'CDM')),1,7) 
		into STRICT	ds_retorno_w 
		;
	elsif (ie_opcao_p = 'CNES') then 
		ds_retorno_w	:= cd_cnes_w;
	elsif (ie_opcao_p = 'NM') then 
		ds_retorno_w	:= ds_unidade_w;
	end if;
	end;
elsif (cd_cgc_unidade_saude_w <> '') 	then 
	begin 
	if (ie_opcao_p = 'UF') then 
		select	substr(obter_dados_pf_pj(null,cd_cgc_unidade_saude_w,'UF'),1,2) 
		into STRICT	ds_retorno_w 
		;
	elsif (ie_opcao_p = 'CDM') then 
		select	substr(obter_dados_pf_pj(null,cd_cgc_unidade_saude_w,'CDM')||Calcula_Digito('MODULO10',obter_dados_pf_pj(null,cd_cgc_unidade_saude_w,'CDM')),1,7) 
		into STRICT	ds_retorno_w 
		;
	elsif (ie_opcao_p = 'CNES') then 
		select	substr(obter_cnes_estab(cd_estabelecimento_w),1,7) 
		into STRICT	ds_retorno_w 
		;
	elsif (ie_opcao_p = 'NM') then 
		select	substr(obter_nome_pf_pj(null,cd_cgc_unidade_saude_w),1,40) 
		into STRICT	ds_retorno_w 
		;
	end if;
	end;
elsif (cd_estabelecimento_w <> 0) then 
	begin 
	if (ie_opcao_p = 'UF') then 
		select	substr(obter_dados_pf_pj(null,obter_cgc_estabelecimento(cd_estabelecimento_w),'UF'),1,2) 
		into STRICT	ds_retorno_w 
		;
	elsif (ie_opcao_p = 'CDM') then 
		select	substr(obter_dados_pf_pj(null,obter_cgc_estabelecimento(cd_estabelecimento_w),'CDM')||Calcula_Digito('MODULO10',obter_dados_pf_pj(null,obter_cgc_estabelecimento(cd_estabelecimento_w),'CDM')),1,7) 
		into STRICT	ds_retorno_w 
		;
	elsif (ie_opcao_p = 'CNES') then 
		select	substr(obter_cnes_estab(cd_estabelecimento_w),1,7) 
		into STRICT	ds_retorno_w 
		;
	elsif (ie_opcao_p = 'NM') then 
		select	substr(obter_nome_pf_pj(null,obter_cgc_estabelecimento(cd_estabelecimento_w)),1,40) 
		into STRICT	ds_retorno_w 
		;
	end if;
	end;
end if;
     
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_unid_saude_atend ( nr_seq_sismama_p bigint, ie_opcao_p text) FROM PUBLIC;

