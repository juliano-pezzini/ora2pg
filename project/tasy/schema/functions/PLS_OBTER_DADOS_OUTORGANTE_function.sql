-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_outorgante ( cd_estabelecimento_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*	ie_opcao
	ANS - Código na ANS
	N - Nome operadora
	C - CNPJ
	EC - Endereço Completo
	F - Telefone
	EM - Email 
	S - Site
	M - Municipio	
	NF  - Nome fantasia operadora 
	CDC - Código da cooperativa  
	UF - UF do outorgante*/
ds_retorno_w			varchar(255);
nm_operadora_w			varchar(255);
cd_ans_w			varchar(20);
cd_cgc_outorgante_w		varchar(14);
cd_estabelecimento_w		bigint;


BEGIN
select	max(cd_cgc_outorgante)
into STRICT	cd_cgc_outorgante_w
from	pls_outorgante
where	cd_estabelecimento	= cd_estabelecimento_p;

if (coalesce(cd_cgc_outorgante_w::text, '') = '') then
	select	min(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	pls_outorgante;
	
	select	max(cd_cgc_outorgante)
	into STRICT	cd_cgc_outorgante_w
	from	pls_outorgante
	where	cd_estabelecimento	= cd_estabelecimento_w;
else
	cd_estabelecimento_w	:= cd_estabelecimento_p;
end if;

if (ie_opcao_p = 'ANS') then
	begin
		select	cd_ans
		into STRICT	cd_ans_w
		from	pls_outorgante
		where	cd_estabelecimento	= cd_estabelecimento_w;
	exception
	when others then
		cd_ans_w := null;
	end;

	ds_retorno_w	:= cd_ans_w;
elsif (ie_opcao_p = 'C') then
	ds_retorno_w	:= cd_cgc_outorgante_w;
elsif (ie_opcao_p = 'EC') then
	begin
		select	substr(ds_endereco,1,40) ||', '|| substr(nr_endereco,1,10) ||' '|| substr(ds_complemento,1,10) ||' - '||
			substr(ds_bairro,1,40) ||' - '|| substr(ds_municipio,1,40) ||'/'|| substr(sg_estado,1,2) || ' - CEP '||
			substr(cd_cep,1,15)
		into STRICT	ds_retorno_w
		from 	pessoa_juridica
		where	cd_cgc	= cd_cgc_outorgante_w;
	exception
	when others then
		ds_retorno_w := null;
	end;
elsif (ie_opcao_p = 'M') then
	begin
		select	substr(ds_municipio,1,40)
		into STRICT	ds_retorno_w
		from 	pessoa_juridica
		where	cd_cgc	= cd_cgc_outorgante_w;
	exception
	when others then
		ds_retorno_w := null;
	end;
elsif (ie_opcao_p = 'F') then
	begin
		select	'('|| substr(nr_ddd_telefone,1,3) ||') '|| substr(nr_telefone,1,15)
		into STRICT	ds_retorno_w
		from 	pessoa_juridica
		where	cd_cgc	= cd_cgc_outorgante_w;
	exception
	when others then
		ds_retorno_w := null;
	end;
elsif (ie_opcao_p = 'S') then
	begin
		select	substr(ds_site_internet,1,255)
		into STRICT	ds_retorno_w
		from 	pessoa_juridica
		where	cd_cgc	= cd_cgc_outorgante_w;
	exception
	when others then
		ds_retorno_w := null;
	end;
elsif (ie_opcao_p = 'EM') then
	begin
		select	substr(ds_email,1,40)
		into STRICT	ds_retorno_w
		from 	pessoa_juridica_compl
		where	cd_cgc	= cd_cgc_outorgante_w;
	exception
	when others then
		ds_retorno_w := null;
	end;
elsif (ie_opcao_p = 'N') then
	begin
		select	distinct obter_nome_pf_pj(null, cd_cgc_outorgante_w)
		into STRICT	ds_retorno_w
		from	pls_outorgante
		where	cd_estabelecimento	= cd_estabelecimento_w;
	exception
	when others then
		ds_retorno_w := null;
	end;
elsif (ie_opcao_p = 'NF') then
	begin
		select	substr(obter_dados_pf_pj(null, cd_cgc_outorgante_w, 'F'),1,255)
		into STRICT	ds_retorno_w
		from	pls_outorgante
		where	cd_estabelecimento	= cd_estabelecimento_p;
	exception
	when others then
		ds_retorno_w := null;
	end;
		
elsif (ie_opcao_p = 'CDC') then
	begin
	select	cd_cooperativa
	into STRICT	ds_retorno_w
	from	pls_congenere
	where	cd_cgc = cd_cgc_outorgante_w;
	exception
	when others then
		ds_retorno_w := null;
	end;
	
elsif (ie_opcao_p = 'UF') then
	begin
	select	substr(max(obter_dados_pf_pj(null, cd_cgc_outorgante_w, 'UF')),1,255)
	into STRICT	ds_retorno_w
	;
	exception
	when others then
		ds_retorno_w := null;
	end;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_outorgante ( cd_estabelecimento_p bigint, ie_opcao_p text) FROM PUBLIC;

