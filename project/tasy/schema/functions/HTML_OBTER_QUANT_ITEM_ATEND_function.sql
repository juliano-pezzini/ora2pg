-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION html_obter_quant_item_atend ( nr_atendimento_p bigint, ie_liberacao_p text) RETURNS varchar AS $body$
DECLARE

							 
qt_item_w				bigint;
ds_itens_retorno_w		varchar(4000);

	function obter_texto(	nr_mensagem_p		text) return text is 
	;
BEGIN
		return substr(obter_texto_tasy(nr_mensagem_p,wheb_usuario_pck.get_nr_seq_idioma), 1, 255);
	end;
	 
	procedure seta_valor_item( 
						nr_desc_item_p		number, 
						qt_valor_item_p		number) is 
						 
	begin 
	if (nr_desc_item_p > 0) and (qt_valor_item_p > 0) then 
		ds_itens_retorno_w := ds_itens_retorno_w || obter_texto(nr_desc_item_p) || ' ' || qt_valor_item_p || ' ';
	end if;
	 
	end;
							 
begin 
 
--- Procedimento 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_procedimento 	a, 
		prescr_procedimento b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_proc_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'P', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'P', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 309515, qt_item_w);
qt_item_w := 0;
 
--- Medicamento 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_material 	a, 
		prescr_material b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_mat_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'M', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'M', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		b.ie_agrupador = 1 
and		coalesce(a.ie_controle_tempo,'N') = 'N' 
and		coalesce(a.ie_material,'N') = 'N' 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 309525, qt_item_w);
qt_item_w := 0;
 
--- Dieta Enteral 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_dieta 		a, 
		prescr_material b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_dieta_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'SNE', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'SNE', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		b.ie_agrupador = 8 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 309526, qt_item_w);
qt_item_w := 0;
 
--- Suplemento Oral 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_dieta 		a, 
		prescr_material b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_dieta_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'SNE', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'SNE', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		b.ie_agrupador = 12 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 309528, qt_item_w);
qt_item_w := 0;
 
--- Soluções 
select	count(*) 
into STRICT	qt_item_w 
from	prescr_solucao 
where	nr_prescricao	in (	SELECT	distinct c.nr_prescricao 
								from	cpoe_material 	a, 
										prescr_material b, 
										prescr_medica 	c 
								where	a.nr_sequencia = b.nr_seq_mat_cpoe 
								and		obter_prescr_item_cpoe(a.nr_sequencia,'MAT', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
								and		obter_prescr_item_cpoe(a.nr_sequencia,'MAT', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
								and		a.nr_atendimento = c.nr_atendimento 
								and		b.nr_prescricao = c.nr_prescricao 
								and		b.ie_agrupador = 4 
								and		coalesce(a.ie_controle_tempo,'N') = 'S' 
								and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
								and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
								and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
								and		a.nr_atendimento = nr_atendimento_p);	
								 
seta_valor_item( 309531, qt_item_w);
qt_item_w := 0;
 
--- Hemodiálise 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_dialise 	a, 
		hd_prescricao b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_dialise_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'DI', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'DI', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and 	a.ie_tipo_dialise = 'DI' 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 439780, qt_item_w);
qt_item_w := 0;
 
--- Diálise Peritoneal 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_dialise 	a, 
		hd_prescricao b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_dialise_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'DI', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'DI', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and 	a.ie_tipo_dialise = 'DP' 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 439835, qt_item_w);
qt_item_w := 0;
 
--- Dieta Oral 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_dieta 		a, 
		prescr_dieta	b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_dieta_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'D', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'D', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 309539, qt_item_w);
qt_item_w := 0;
 
--- Jejum 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_dieta 		a, 
		rep_jejum		b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_dieta_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'J', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'J', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 309541, qt_item_w);
qt_item_w := 0;
 
--- Recomendação 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_recomendacao 	a, 
		prescr_recomendacao b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_rec_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'R', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'R', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 309544, qt_item_w);
qt_item_w := 0;
 
--- Hemoterapia 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_hemoterapia 	a, 
		prescr_solic_bco_sangue b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_hemo_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'HM', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'HM', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 309547, qt_item_w);
qt_item_w := 0;
 
--- Leites e Derivados 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_dieta 		a, 
		prescr_leite_deriv	b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_dieta_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'LD', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'LD', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 309548, qt_item_w);
qt_item_w := 0;
 
--- Gasoterapia 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_gasoterapia 	a, 
		prescr_gasoterapia	b, 
		prescr_medica 		c 
where	a.nr_sequencia = b.nr_seq_gas_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'O', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'O', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 309550, qt_item_w);
qt_item_w := 0;
 
--- Material 
select	count(*) 
into STRICT	qt_item_w 
from	cpoe_material 	a, 
		prescr_material b, 
		prescr_medica 	c 
where	a.nr_sequencia = b.nr_seq_mat_cpoe 
and		obter_prescr_item_cpoe(a.nr_sequencia,'MAT', a.nr_atendimento, a.cd_pessoa_fisica) = b.nr_prescricao 
and		obter_prescr_item_cpoe(a.nr_sequencia,'MAT', a.nr_atendimento, a.cd_pessoa_fisica) = c.nr_prescricao 
and		a.nr_atendimento = c.nr_atendimento 
and		b.nr_prescricao = c.nr_prescricao 
and		b.ie_agrupador = 2 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= trunc(clock_timestamp(),'mi'))) 
and		CASE WHEN ie_liberacao_p='E' THEN  c.dt_liberacao  ELSE c.dt_liberacao_farmacia coalesce(END::text, '') = '' 
and		a.nr_atendimento = nr_atendimento_p;
 
seta_valor_item( 309562, qt_item_w);
qt_item_w := 0;
 
 
return ds_itens_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION html_obter_quant_item_atend ( nr_atendimento_p bigint, ie_liberacao_p text) FROM PUBLIC;

