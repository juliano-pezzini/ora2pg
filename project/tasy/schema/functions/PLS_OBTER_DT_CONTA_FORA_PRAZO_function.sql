-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dt_conta_fora_prazo (nr_seq_conta_p pls_conta.nr_sequencia%type) RETURNS timestamp AS $body$
DECLARE


ie_tipo_guia_w			pls_conta.ie_tipo_guia%type;
dt_inicio_faturamento_w		pls_conta.dt_inicio_faturamento%type;
dt_entrada_w			pls_conta.dt_entrada%type;
dt_atendimento_w		pls_conta.dt_atendimento%type;
dt_emissao_w			pls_conta.dt_emissao%type;
cd_guia_ok_w			pls_conta.cd_guia_ok%type;
nr_seq_segurado_w		pls_conta.nr_seq_segurado%type;
ie_conta_fechada_w		pls_regra_faturamento.ie_conta_fechada%type;
dt_alta_w			pls_conta.dt_alta%type;
nr_seq_lote_fat_w		pls_conta_pos_estabelecido.nr_seq_lote_fat%type;
dt_retorno_w			timestamp;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ie_novo_pos_estab_w		pls_visible_false.ie_novo_pos_estab%type := 'N';
ie_apresentacao_w		pls_protocolo_conta.ie_apresentacao%type;


BEGIN
begin
select	a.ie_tipo_guia,
	a.dt_inicio_faturamento,
	a.dt_entrada,
	coalesce(coalesce(b.dt_atendimento,a.dt_atendimento),a.dt_atendimento_referencia),
	a.dt_emissao,
	a.cd_guia_ok,
	CASE WHEN coalesce(b.nr_sequencia::text, '') = '' THEN  a.nr_seq_segurado  ELSE b.nr_seq_segurado END ,
	a.cd_estabelecimento,
	c.ie_apresentacao
into STRICT	ie_tipo_guia_w,
	dt_inicio_faturamento_w,
	dt_entrada_w,
	dt_atendimento_w,
	dt_emissao_w,
	cd_guia_ok_w,
	nr_seq_segurado_w,
	cd_estabelecimento_w,
	ie_apresentacao_w
FROM pls_protocolo_conta c, pls_conta a
LEFT OUTER JOIN pls_conta_pos_cabecalho b ON (a.nr_sequencia = b.nr_seq_conta)
WHERE c.nr_sequencia		= a.nr_seq_protocolo and a.nr_sequencia		= nr_seq_conta_p and ((b.nr_seq_discussao IS NOT NULL AND b.nr_seq_discussao::text <> '')
or	not exists (SELECT	1
			from	pls_conta_pos_cabecalho z
			where	z.nr_seq_conta = b.nr_seq_conta
			and	(z.nr_seq_discussao IS NOT NULL AND z.nr_seq_discussao::text <> '')));
exception
when others then
	null;
end;

select	coalesce(max(ie_novo_pos_estab), 'N')
into STRICT	ie_novo_pos_estab_w
from	pls_visible_false
where	cd_estabelecimento = cd_estabelecimento_w;

select	max(nr_seq_lote_fat)
into STRICT	nr_seq_lote_fat_w
from (	SELECT	nr_seq_lote_fat
	from	pls_conta_pos_estabelecido
	where	nr_seq_conta = nr_seq_conta_p
	and	ie_novo_pos_estab_w = 'N'
	and 	ie_status_faturamento <> 'A' -- diferente de aviso de cobranca
	
union all

	SELECT	nr_seq_lote_fat
	from	pls_conta_pos_proc
	where	nr_seq_conta = nr_seq_conta_p
	and	ie_novo_pos_estab_w = 'S'
	
union all

	select	nr_seq_lote_fat
	from	pls_conta_pos_mat
	where	nr_seq_conta = nr_seq_conta_p
	and	ie_novo_pos_estab_w = 'S') alias1;
	
begin
	select	coalesce(b.ie_conta_fechada,'N')
	into STRICT	ie_conta_fechada_w
	from	pls_regra_faturamento	b,
		pls_lote_faturamento	a
	where	b.nr_sequencia		= a.nr_seq_regra_fat
	and	a.nr_sequencia		= nr_seq_lote_fat_w;
exception
when others then
	ie_conta_fechada_w := 'N';
end;

if (dt_atendimento_w IS NOT NULL AND dt_atendimento_w::text <> '') then
	dt_retorno_w	:= dt_atendimento_w;
elsif (dt_emissao_w IS NOT NULL AND dt_emissao_w::text <> '') then
	dt_retorno_w	:= dt_emissao_w;
end if;

if (ie_conta_fechada_w = 'S') and (ie_apresentacao_w = 'A') then
	if (cd_guia_ok_w IS NOT NULL AND cd_guia_ok_w::text <> '') then
		select	max(dt_alta)
		into STRICT	dt_alta_w
		from	pls_conta
		where	nr_seq_segurado	= nr_seq_segurado_w
		and	cd_guia_ok	= cd_guia_ok_w
		and	ie_tipo_guia	= '5';
	end if;
else
	if (ie_tipo_guia_w = '5') then
		if (dt_inicio_faturamento_w IS NOT NULL AND dt_inicio_faturamento_w::text <> '') then
			dt_retorno_w	:= dt_inicio_faturamento_w;
		elsif (dt_atendimento_w IS NOT NULL AND dt_atendimento_w::text <> '') then
			dt_retorno_w	:= dt_atendimento_w;
		end if;
	end if;
end if;

if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') then
	dt_retorno_w := dt_alta_w;
end if;

return	dt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dt_conta_fora_prazo (nr_seq_conta_p pls_conta.nr_sequencia%type) FROM PUBLIC;

