-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_conta_nivel ( cd_conta_contabil_p text, qt_nivel_p bigint, dt_vigencia_p timestamp) RETURNS varchar AS $body$
DECLARE


cd_classificacao_w	varchar(40);
cd_classif_w		varchar(40);
cd_conta_contabil_w	varchar(40);
i			integer;
k			integer;
cd_empresa_w		integer;
qt_classif_w		integer;
qt_w			integer;
dt_vigencia_w		timestamp;
ie_separador_conta_w	empresa.ie_sep_classif_conta_ctb%type;


BEGIN

ie_separador_conta_w	:= philips_contabil_pck.get_separador_conta;

dt_vigencia_w	:= trunc(dt_vigencia_p,'dd');

select	max(cd_classificacao),
	max(cd_empresa)
into STRICT	cd_classificacao_w,
	cd_empresa_w
from	conta_contabil
where	cd_conta_contabil	= cd_conta_contabil_p;

cd_classificacao_w	:= ctb_obter_classif_conta(cd_conta_contabil_p, cd_classificacao_w, coalesce(dt_vigencia_p, clock_timestamp()));

i			:= 0;
if (cd_classificacao_w IS NOT NULL AND cd_classificacao_w::text <> '') then
	i			:= 1;
	FOR k in 1..length(cd_classificacao_w) LOOP
		if (substr(cd_classificacao_w,k,1) = ie_separador_conta_w) then
			i	:= i + 1;
		end if;
	END LOOP;
end if;

if (i = 0) then
	cd_conta_contabil_w	:= null;
elsif (i <= qt_nivel_p) then
	cd_conta_contabil_w	:= cd_conta_contabil_p;
else
	begin
	i			:= 0;
	FOR k in 1..length(cd_classificacao_w) LOOP
		if (substr(cd_classificacao_w,k,1) = ie_separador_conta_w) then
			i	:= i + 1;
		end if;
		if (i = qt_nivel_p) then
			cd_classif_w	:= substr(cd_classificacao_w,1, k -1);

		/*	Alterações para melhoria de performance OS 317032
			select	count(*)
			into	qt_w
			from	conta_contabil
			where	ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, nvl(dt_vigencia_p, sysdate))	= cd_classif_w
			and	cd_empresa		= cd_empresa_w
			and	substr(obter_se_conta_vigente2(cd_conta_contabil, dt_inicio_vigencia, dt_fim_vigencia,dt_vigencia_w),1,1) = 'S';*/
			select	coalesce(max(1),0)
			into STRICT	qt_w
			
			where	exists (	SELECT	1
					from	conta_contabil_classif x
					where	x.cd_classificacao	= cd_classif_w
					and	x.dt_inicio_vigencia <= dt_vigencia_w
					and	coalesce(x.dt_fim_vigencia, clock_timestamp()) >= dt_vigencia_w
					and	substr(obter_se_conta_vigente(x.cd_conta_contabil, dt_vigencia_w),1,1) = 'S');

			if (qt_w = 0) then

				select	coalesce(max(1),0)
				into STRICT	qt_w
				
				where	exists (	SELECT	1
						from	conta_contabil b
						where	b.cd_classificacao	= cd_classif_w
						and	substr(obter_se_conta_vigente2(b.cd_conta_contabil, b.dt_inicio_vigencia, b.dt_fim_vigencia,dt_vigencia_w),1,1) = 'S'
						and	b.cd_empresa		= cd_empresa_w);
			end if;

			if (qt_w = 0) then
				select	ctb_obter_classif_conta_sup(cd_classif_w, dt_vigencia_w, cd_empresa_w)
				into STRICT	cd_classif_w
				;
			end if;

			exit;
		end if;
	END LOOP;

	begin
	select	x.cd_conta_contabil
	into STRICT	cd_conta_contabil_w
	from    conta_contabil_classif x
	where   x.cd_classificacao      = cd_classif_w
	and     x.dt_inicio_vigencia <= dt_vigencia_w
	and     coalesce(x.dt_fim_vigencia, clock_timestamp()) >= dt_vigencia_w
	and	substr(obter_se_conta_vigente(x.cd_Conta_contabil,dt_vigencia_w),1,1) = 'S';
	exception when others then
		cd_conta_contabil_w	:= '';
	end;

	if (coalesce(cd_conta_contabil_w,'X') = 'X') then

		select	max(cd_conta_contabil)
		into STRICT	cd_conta_contabil_w
		from	conta_contabil
		where	cd_classificacao	= cd_classif_w
		and	cd_empresa		= cd_empresa_w
		and	substr(obter_se_conta_vigente2(cd_conta_contabil, dt_inicio_vigencia, dt_fim_vigencia,dt_vigencia_w),1,1) = 'S';

	end if;

	/*select	max(b.cd_conta_contabil)
	into	cd_conta_contabil_w
	from	conta_contabil b,
		conta_contabil_classif x
	where	b.cd_conta_contabil	= x.cd_conta_contabil(+)
	and	nvl(x.cd_classificacao, b.cd_classificacao)	= cd_classif_w
	and	x.dt_inicio_vigencia <= dt_vigencia_w
	and	nvl(x.dt_fim_vigencia, sysdate) >= dt_vigencia_w
	and	substr(obter_se_conta_vigente2(b.cd_conta_contabil, b.dt_inicio_vigencia, b.dt_fim_vigencia,dt_vigencia_w),1,1) = 'S'
	and	b.cd_empresa		= cd_empresa_w);*/
	end;
end if;

return cd_conta_contabil_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_conta_nivel ( cd_conta_contabil_p text, qt_nivel_p bigint, dt_vigencia_p timestamp) FROM PUBLIC;

