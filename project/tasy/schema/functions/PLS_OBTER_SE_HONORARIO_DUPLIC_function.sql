-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_honorario_duplic ( nr_seq_conta_p bigint, ie_evento_p text) RETURNS varchar AS $body$
DECLARE


cd_guia_referencia_w		varchar(20);
cd_guia_w			varchar(20);
cd_guia_referencia_imp_w	varchar(20);
cd_guia_imp_w			varchar(20);
cd_medico_w			bigint;
nr_seq_grau_partic_w		integer;
ie_tipo_guia_w			varchar(2);
ds_retorno_w			varchar(1) := 'N';
qt_reg_w			bigint;
nr_seq_segurado_w		bigint;
nr_seq_protocolo_w		bigint;
cd_usuario_plano_imp_w		varchar(30);


BEGIN

select	cd_guia_referencia,
	cd_guia,
	cd_guia_solic_imp,
	cd_guia_imp,
	cd_medico_executor,
	nr_seq_grau_partic,
	ie_tipo_guia,
	nr_seq_segurado,
	nr_seq_protocolo,
	cd_usuario_plano_imp
into STRICT	cd_guia_referencia_w,
	cd_guia_w,
	cd_guia_referencia_imp_w,
	cd_guia_imp_w,
	cd_medico_w,
	nr_seq_grau_partic_w,
	ie_tipo_guia_w,
	nr_seq_segurado_w,
	nr_seq_protocolo_w,
	cd_usuario_plano_imp_w
from	pls_conta
where	nr_sequencia = nr_seq_conta_p;

if (ie_evento_p = 'IA') then
	cd_medico_w		:= pls_obter_dados_gerar_conta(nr_seq_conta_p, 'M');
	nr_seq_grau_partic_w	:= pls_obter_dados_gerar_conta(nr_seq_conta_p, 'G');
	cd_guia_referencia_w 	:= cd_guia_referencia_imp_w;
	cd_guia_w		:= cd_guia_imp_w;
	cd_usuario_plano_imp_w	:= elimina_caracteres_especiais(cd_usuario_plano_imp_w);

	/*	Localizar prestador contratado */

	select	coalesce(max(nr_seq_segurado),0)
	into STRICT	nr_seq_segurado_w
	from	pls_segurado_carteira
	where	cd_usuario_plano	= cd_usuario_plano_imp_w;
end if;

if (ie_tipo_guia_w = '6') then
	if (ie_evento_p = 'CC') then
		select	count(*)
		into STRICT	qt_reg_w
		from	pls_conta
		where	nr_sequencia		<> nr_seq_conta_p
		and	cd_guia_referencia	= cd_guia_referencia_w
		and	cd_guia			<> cd_guia_w
		and	cd_medico_executor	= cd_medico_w
		and	nr_seq_grau_partic	= nr_seq_grau_partic_w
		and	nr_seq_segurado		= nr_seq_segurado_w
		and	nr_seq_protocolo	= nr_seq_protocolo_w;
	elsif (ie_evento_p = 'IA') then
		select	count(*)
		into STRICT	qt_reg_w
		from	pls_conta
		where	nr_sequencia		<> nr_seq_conta_p
		and	cd_guia_solic_imp	= cd_guia_referencia_w
		and	cd_guia_imp		<> cd_guia_w
		and	pls_obter_dados_gerar_conta(nr_sequencia, 'M')	= cd_medico_w
		and	pls_obter_dados_gerar_conta(nr_sequencia, 'G')	= nr_seq_grau_partic_w
		and	nr_seq_segurado		= nr_seq_segurado_w
		and	nr_seq_protocolo	= nr_seq_protocolo_w;
	end if;

	if (qt_reg_w > 0) then
		ds_retorno_w := 'S';
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_honorario_duplic ( nr_seq_conta_p bigint, ie_evento_p text) FROM PUBLIC;

