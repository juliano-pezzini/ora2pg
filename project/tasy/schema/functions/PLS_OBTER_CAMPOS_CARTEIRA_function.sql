-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_campos_carteira ( cd_usuario_plano_p text, nr_seq_emissor_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(255);
cd_usuario_plano_w		varchar(255);
qt_tamanho_w			bigint;
i				bigint;

ie_tipo_campo_w			varchar(5);
ds_mascara_w			varchar(30);
ie_posicao_campo_w		bigint	:= 1;
ie_campo_variavel_w		varchar(2)	:= 'N';
ds_campo_w			varchar(255);
qt_posicao_campo_w		bigint	:= 0;

ie_tipo_campo_ww		varchar(5);
ds_mascara_ww			varchar(30);
ie_posicao_campo_ww		bigint	:= 1;
ie_campo_variavel_ww		varchar(2)	:= 'N';
ds_campo_ww			varchar(255);
qt_posicao_campo_ww		bigint	:= 0;

ie_tipo_campo_var_ww		varchar(5);
ds_mascara_var_ww		varchar(30);

nr_seq_titular_w		varchar(10);
ie_titularidade_w		varchar(5);
nr_seq_produto_w		varchar(10);
nr_sequencial_w			varchar(30);
ie_dig_verific_11_w		varchar(1);
nr_seq_contrato_w		varchar(10);
cd_sistema_anterior_w		varchar(30);
cd_benef_ant_w			varchar(20);
nr_seq_interno_seg_w		varchar(10);
ie_dig_verific_10_w		varchar(1);
cd_empresa_w			varchar(10);
cd_matricula_familiar_w		varchar(10);
cd_cooperativa_ww		varchar(10);
nr_contrato_w			varchar(10);
cd_sistema_coop_w		varchar(10);
nr_seq_regra_carteira_w		bigint;

C01 CURSOR FOR
	SELECT	ie_tipo_campo,
		ds_mascara
	from	pls_regra_carteira_campo
	where	nr_seq_regra_carteira	= nr_seq_regra_carteira_w
	order by nr_seq_apresentacao;

C02 CURSOR FOR
	SELECT	ie_tipo_campo,
		ds_mascara
	from	pls_regra_carteira_campo
	where	nr_seq_regra_carteira	= nr_seq_regra_carteira_w
	and	ie_campo_variavel_w	= 'S'
	order by nr_seq_apresentacao desc;


BEGIN

/*aaschlote 06/02/2012 - 402949*/

select	max(nr_sequencia)
into STRICT	nr_seq_regra_carteira_w
from	pls_regra_carteira
where	nr_seq_emissor	= nr_seq_emissor_p;

open C01;
loop
fetch C01 into
	ie_tipo_campo_w,
	ds_mascara_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (ie_campo_variavel_w = 'N') then	/* Se tiver algum campo variável, não da pra saber o tamanho */
		if (position('_' in ds_mascara_w) > 0) then
			ie_campo_variavel_w	:= 'S';
			ie_tipo_campo_var_ww	:= ie_tipo_campo_w;
			ds_mascara_var_ww	:= ds_mascara_w;
		else
			qt_posicao_campo_w	:= coalesce(qt_posicao_campo_w,0) + length(ds_mascara_w);

			select	substr(cd_usuario_plano_p,ie_posicao_campo_w,length(ds_mascara_w))
			into STRICT	ds_campo_w
			;

			/* Dom 1829	T - Sequência do titular
					TI - Titularidade
					A - Sequência do produto
					S - Sequencial
					V - Dígito verificador (Módulo 11 - Padrão CNPJ da SRF)
					E - Sequência do contrato
					CA - Código do contrato no sistema anterior
					BA - Código do beneficiario no sistema anterior
					I - Sequencia interna do beneficiário no contrato
					VD - Dígito verificador (Módulo 10)
					CE - Código de controle de empresa na OPS
					MA - Código da matrícula da família do beneficiário
					CM - Código da cooperativa médica
					NC - Número do contrato
					SC - Código do sistema cooperativista */
			if (ie_tipo_campo_w = 'T') then
				nr_seq_titular_w	:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'TI') then
				ie_titularidade_w	:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'A') then
				nr_seq_produto_w	:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'S') then
				nr_sequencial_w		:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'V') then
				ie_dig_verific_11_w	:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'E') then
				nr_seq_contrato_w	:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'CA') then
				cd_sistema_anterior_w	:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'BA') then
				cd_benef_ant_w		:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'I') then
				nr_seq_interno_seg_w	:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'VD') then
				ie_dig_verific_10_w	:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'CE') then
				cd_empresa_w		:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'MA') then
				cd_matricula_familiar_w	:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'CM') then
				cd_cooperativa_ww	:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'NC') then
				nr_contrato_w		:= ds_campo_w;
			elsif (ie_tipo_campo_w = 'SC') then
				cd_sistema_coop_w	:= ds_campo_w;
			end if;
		end if;
	end if;

	ie_posicao_campo_w	:= coalesce(ie_posicao_campo_w,0) + length(ds_mascara_w);
	end;
end loop;
close C01;

if (ie_campo_variavel_w	= 'S') then
	qt_tamanho_w       	:= Length(cd_usuario_plano_p);
	if (qt_tamanho_w > 0) then
		FOR i IN REVERSE qt_tamanho_w..1 LOOP
			cd_usuario_plano_w	:= cd_usuario_plano_w || substr(cd_usuario_plano_p,i,1);
		END LOOP;
	end if;

	open C02;
	loop
	fetch C02 into
		ie_tipo_campo_ww,
		ds_mascara_ww;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		if (ie_campo_variavel_ww = 'N') then	/* Se tiver algum campo variável, não da pra saber o tamanho */
			if (position('_' in ds_mascara_ww) > 0) then
				ie_campo_variavel_ww	:= 'S';
			else
				qt_posicao_campo_ww	:= coalesce(qt_posicao_campo_ww,0) + length(ds_mascara_ww);

				select	substr(cd_usuario_plano_w,ie_posicao_campo_ww,length(ds_mascara_ww))
				into STRICT	ds_campo_ww
				;

				if (ie_tipo_campo_ww = 'T') then
					nr_seq_titular_w	:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'TI') then
					ie_titularidade_w	:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'A') then
					nr_seq_produto_w	:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'S') then
					nr_sequencial_w		:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'V') then
					ie_dig_verific_11_w	:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'E') then
					nr_seq_contrato_w	:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'CA') then
					cd_sistema_anterior_w	:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'BA') then
					cd_benef_ant_w		:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'I') then
					nr_seq_interno_seg_w	:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'VD') then
					ie_dig_verific_10_w	:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'CE') then
					cd_empresa_w		:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'MA') then
					cd_matricula_familiar_w	:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'CM') then
					cd_cooperativa_ww	:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'NC') then
					nr_contrato_w		:= ds_campo_ww;
				elsif (ie_tipo_campo_ww = 'SC') then
					cd_sistema_coop_w	:= ds_campo_ww;
				end if;
			end if;
		end if;

		ie_posicao_campo_ww	:= coalesce(ie_posicao_campo_ww,0) + length(ds_mascara_ww);

		end;
	end loop;
	close C02;

	select	substr(cd_usuario_plano_p,qt_posicao_campo_w + 1,length(cd_usuario_plano_p) - qt_posicao_campo_w - qt_posicao_campo_ww)
	into STRICT	ds_campo_ww
	;

	if (ie_tipo_campo_var_ww = 'T') then
		nr_seq_titular_w	:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'TI') then
		ie_titularidade_w	:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'A') then
		nr_seq_produto_w	:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'S') then
		nr_sequencial_w		:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'V') then
		ie_dig_verific_11_w	:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'E') then
		nr_seq_contrato_w	:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'CA') then
		cd_sistema_anterior_w	:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'BA') then
		cd_benef_ant_w		:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'I') then
		nr_seq_interno_seg_w	:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'VD') then
		ie_dig_verific_10_w	:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'CE') then
		cd_empresa_w		:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'MA') then
		cd_matricula_familiar_w	:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'CM') then
		cd_cooperativa_ww	:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'NC') then
		nr_contrato_w		:= ds_campo_ww;
	elsif (ie_tipo_campo_var_ww = 'SC') then
		cd_sistema_coop_w	:= ds_campo_ww;
	end if;
end if;

if (ie_opcao_p = 'T') then
	ds_retorno_w	:= nr_seq_titular_w;
elsif (ie_opcao_p = 'TI') then
	ds_retorno_w	:= ie_titularidade_w;
elsif (ie_opcao_p = 'A') then
	ds_retorno_w	:= nr_seq_produto_w;
elsif (ie_opcao_p = 'S') then
	ds_retorno_w	:= nr_sequencial_w;
elsif (ie_opcao_p = 'V') then
	ds_retorno_w	:= ie_dig_verific_11_w;
elsif (ie_opcao_p = 'E') then
	ds_retorno_w	:= nr_seq_contrato_w;
elsif (ie_opcao_p = 'CA') then
	ds_retorno_w	:= cd_sistema_anterior_w;
elsif (ie_opcao_p = 'BA') then
	ds_retorno_w	:= cd_benef_ant_w;
elsif (ie_opcao_p = 'I') then
	ds_retorno_w	:= nr_seq_interno_seg_w;
elsif (ie_opcao_p = 'VD') then
	ds_retorno_w	:= ie_dig_verific_10_w;
elsif (ie_opcao_p = 'CE') then
	ds_retorno_w	:= cd_empresa_w;
elsif (ie_opcao_p = 'MA') then
	ds_retorno_w	:= cd_matricula_familiar_w;
elsif (ie_opcao_p = 'CM') then
	ds_retorno_w	:= cd_cooperativa_ww;
elsif (ie_opcao_p = 'NC') then
	ds_retorno_w	:= nr_contrato_w;
elsif (ie_opcao_p = 'SC') then
	ds_retorno_w	:= cd_sistema_coop_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_campos_carteira ( cd_usuario_plano_p text, nr_seq_emissor_p bigint, ie_opcao_p text) FROM PUBLIC;

