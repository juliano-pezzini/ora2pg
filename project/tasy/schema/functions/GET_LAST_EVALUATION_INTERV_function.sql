-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_last_evaluation_interv ( nr_seq_item_sae_p prescr_mat_alteracao.nr_seq_item_sae%type, ie_option_p text, dt_format_p text default null) RETURNS varchar AS $body$
DECLARE

    /*
      Options
      L = Level of intervention
      D = Date of evaluation
      U = Name of evaluator
    */
    ie_alteration_w      prescr_mat_alteracao.ie_alteracao%type;
    dt_alteration_w      prescr_mat_alteracao.dt_alteracao%type;
    nm_user_w            prescr_mat_alteracao.nm_usuario%type;
    ds_return_w          varchar(255);

BEGIN
    begin
    select  ie_alteracao,
            dt_alteracao,
            nm_usuario
    into STRICT ie_alteration_w,
         dt_alteration_w,
         nm_user_w
    from (
            SELECT  obter_valor_dominio(1620, pma.ie_alteracao) ie_alteracao,
                    pma.dt_alteracao,
                    pma.nm_usuario
            from    prescr_mat_alteracao pma
            where   pma.nr_seq_item_sae = nr_seq_item_sae_p
            and     pma.ie_alteracao in (3, 5)
            order by
                    pma.nr_sequencia desc
    ) alias2 LIMIT 1;
   exception when others then
    ds_return_w:= null;
   end;

   if (ie_option_p = 'L') then
    ds_return_w := ie_alteration_w;
  elsif (ie_option_p = 'D') then
    ds_return_w := to_char(dt_alteration_w, dt_format_p);
  elsif (ie_option_p = 'U') then
    ds_return_w := obter_desc_usuario(nm_user_w);
  end if;
  
  return ds_return_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_last_evaluation_interv ( nr_seq_item_sae_p prescr_mat_alteracao.nr_seq_item_sae%type, ie_option_p text, dt_format_p text default null) FROM PUBLIC;

