-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consistir_qt_exame_convenio ( nr_atendimento_p bigint, nr_sequencia_regra_p bigint) RETURNS varchar AS $body$
DECLARE


cd_procedimento_w		bigint;
ie_origem_proced_w		varchar(10);
cd_convenio_w			bigint;
cd_area_procedimento_w	regra_Convenio_Plano.cd_area_procedimento%type;
cd_especialidade_w		regra_Convenio_Plano.cd_especialidade_proc%type;
cd_grupo_proc_w		regra_Convenio_Plano.cd_grupo_proc%type;
ie_tipo_atendimento_w	bigint;
ds_retorno_w			varchar(4000);
ds_retorno_2_w			varchar(4000);
cd_setor_atendimento_w	bigint;
nr_seq_forma_org_w		bigint := 0;
nr_seq_grupo_w			bigint := 0;
nr_seq_subgrupo_w		bigint := 0;
cd_tipo_acomodacao_w	bigint;
cd_plano_w				varchar(40);		
qt_pedido_aberto_w		bigint;
qt_max_solicitacao_w	bigint;
qt_min_solicitacao_w	bigint;
cd_grupo_regra_w		bigint;
qt_exames_grupo_w		bigint;
ie_regra_w				varchar(10);
qt_registros_w			bigint;
qt_contador_w			bigint := 0;
ds_retorno_grupo_w		varchar(4000);

nr_seq_exame_w			bigint;
nr_seq_exame_lab_w		bigint;
nr_proc_interno_w		bigint;
cd_material_exame_w		varchar(20);
nr_seq_item_w			bigint;
ds_nome_exame_w			varchar(255);

qt_pedido_total_w		bigint := 0;	


		
C01 CURSOR FOR
	SELECT	qt_maximo,
			qt_minimo,
			cd_grupo_proc,
			ie_regra
	from 	regra_Convenio_Plano
	where	cd_convenio													= cd_convenio_w
	and		coalesce(cd_plano, coalesce(cd_plano_w,0))							= coalesce(cd_plano_w,0)
	and		coalesce(cd_procedimento, coalesce(cd_procedimento_w,0))				= coalesce(cd_procedimento_w,0)
	and		coalesce(cd_area_procedimento, coalesce(cd_area_procedimento_w,0))	= coalesce(cd_area_procedimento_w,0)
	and		coalesce(cd_especialidade_proc, coalesce(cd_especialidade_w,0))		= coalesce(cd_especialidade_w,0)
	and		coalesce(cd_grupo_proc, coalesce(cd_grupo_proc_w,0))					= coalesce(cd_grupo_proc_w,0)
	and		coalesce(nr_seq_forma_org, coalesce(nr_seq_forma_org_w,0))			= coalesce(nr_seq_forma_org_w,0) 	
	and		coalesce(nr_seq_subgrupo, coalesce(nr_seq_subgrupo_w,0))				= coalesce(nr_seq_subgrupo_w,0)
	and		coalesce(nr_seq_grupo, coalesce(nr_seq_grupo_w,0))					= coalesce(nr_seq_grupo_w,0)
	and		coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))		= coalesce(ie_tipo_atendimento_w,0)
	and		coalesce(cd_tipo_acomodacao, coalesce(cd_tipo_acomodacao_w,0))		= coalesce(cd_tipo_acomodacao_w,0)
	and		coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0)) 	= coalesce(cd_setor_atendimento_w,0)
	and		coalesce(ie_situacao,'A') = 'A'
	and 	ie_regra = '9'
	and (clock_timestamp() between
			coalesce(dt_inicio_vigencia,to_date('01/01/1900','dd/mm/yyyy')) and 
			coalesce(dt_fim_vigencia,to_date('31/12/2099','dd/mm/yyyy')))
	order 	by coalesce(ie_tipo_atendimento,0),
			coalesce(cd_procedimento,0),
			coalesce(ie_origem_proced,ie_origem_proced_w),
			coalesce(cd_grupo_proc,0),
			coalesce(cd_especialidade_proc,0),
			coalesce(cd_area_procedimento,0);			

C02 CURSOR FOR
		SELECT	a.nr_seq_exame,
				a.nr_seq_exame_lab,
				a.nr_proc_interno,
				a.cd_procedimento,
				a.ie_origem_proced,
				a.cd_material_exame,
				a.nr_sequencia
		from	pedido_exame_externo_item a,
				pedido_exame_externo b
		where	b.nr_sequencia = a.nr_seq_pedido
		and		b.nr_sequencia = nr_sequencia_regra_p
		and 	b.dt_liberacao is  null
		and 	coalesce(b.dt_inativacao::text, '') = ''
		and		coalesce(trim(both b.ds_justificativa)::text, '') = '';
			

BEGIN


select	Obter_Convenio_Atendimento(nr_atendimento_p),
		Obter_Setor_Atendimento(nr_atendimento_p),	
		Obter_Tipo_Atendimento(nr_atendimento_p)
into STRICT 	cd_convenio_w,
		cd_setor_atendimento_w,
		ie_tipo_atendimento_w
;

	
select	coalesce(max(a.cd_tipo_acomodacao), 0),
		coalesce(max(a.cd_plano_convenio),0)
into STRICT	cd_tipo_acomodacao_w,
		cd_plano_w
from	atend_categoria_convenio a
where	a.nr_atendimento	= nr_atendimento_p
and		a.cd_convenio		= cd_convenio_w
and		a.dt_inicio_vigencia	=
			(SELECT	max(x.dt_inicio_vigencia)
			from	atend_categoria_convenio x
			where	x.nr_atendimento	= a.nr_atendimento
			and	x.cd_convenio		= a.cd_convenio);
	
	
open C02;
loop
fetch C02 into	
		nr_seq_exame_w,	
		nr_seq_exame_lab_w,	
		nr_proc_interno_w,	
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_material_exame_w,
		nr_seq_item_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	
		select	max(cd_grupo_proc),
				max(cd_especialidade),
				max(cd_area_procedimento)
		into STRICT	cd_grupo_proc_w,
				cd_especialidade_w,
				cd_area_procedimento_w
		from	estrutura_procedimento_v
		where	cd_procedimento		= cd_procedimento_w
		and		ie_origem_proced	= ie_origem_proced_w;
		
		
		select	coalesce(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, 'C', 'S'),'S'),1,10),0),
				coalesce(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, 'C', 'F'),'F'),1,10),0),
				coalesce(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, 'C', 'G'),'G'),1,10),0)
		into STRICT	nr_seq_subgrupo_w,
				nr_seq_forma_org_w,
				nr_seq_grupo_w
		;
		
		open C01;
		loop
		fetch C01 into	
			qt_max_solicitacao_w,
			qt_min_solicitacao_w,
			cd_grupo_regra_w,
			ie_regra_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin	

		select	sum(qt_exame)
		into STRICT 	qt_pedido_aberto_w
		from	pedido_exame_externo_item a,
				pedido_exame_externo b
		where	b.nr_sequencia = a.nr_seq_pedido
		and		b.nr_sequencia = nr_sequencia_regra_p
		and 	b.dt_liberacao is  null
		and 	coalesce(b.dt_inativacao::text, '') = ''
		and		coalesce(trim(both b.ds_justificativa)::text, '') = ''
		and		coalesce(a.nr_seq_exame,0) = 	coalesce(nr_seq_exame_w,0)
		and		coalesce(a.nr_seq_exame_lab,0) = coalesce(nr_seq_exame_lab_w,0)
		and		coalesce(a.nr_proc_interno,0) = 	coalesce(nr_proc_interno_w,0)
		and		coalesce(a.cd_procedimento,0) = 	coalesce(cd_procedimento_w,0)
		and		coalesce(a.ie_origem_proced,0) = coalesce(ie_origem_proced_w,0)
		and		coalesce(a.cd_material_exame,0) = coalesce(cd_material_exame_w,0);
		
		select	Obter_Med_Exame_Externo(nr_seq_item_w)
		into STRICT	ds_nome_exame_w		
		;	
		
		if (coalesce(cd_grupo_regra_w,0) > 0) and (ie_regra_w = '9') then

			select	sum(qt_exame),
					count(1)
			into STRICT 	qt_exames_grupo_w,
					qt_registros_w
			from	pedido_exame_externo_item a,
					pedido_exame_externo b,
					estrutura_procedimento_v c
			where	b.nr_sequencia = a.nr_seq_pedido
			and		a.cd_procedimento = c.cd_procedimento
			and		a.ie_origem_proced = c.ie_origem_proced
			and		b.nr_sequencia = nr_sequencia_regra_p
			and		c.cd_grupo_proc = cd_grupo_regra_w
			and 	b.dt_liberacao is  null
			and 	coalesce(b.dt_inativacao::text, '') = ''
			and		coalesce(trim(both b.ds_justificativa)::text, '') = '';
			
			if((qt_exames_grupo_w < qt_min_solicitacao_w or  qt_exames_grupo_w > qt_max_solicitacao_w) AND qt_registros_w > 1) then
			
				ds_retorno_grupo_w := '     -> '||ds_nome_exame_w ||' ' ||obter_desc_expressao(309173)||': '||qt_pedido_aberto_w||'.' ||chr(13) || chr(10);
				
				qt_contador_w := qt_contador_w + 1;
				
				if (qt_contador_w = qt_registros_w) then
				
					ds_retorno_grupo_w := ds_retorno_grupo_w||obter_desc_expressao(948338)||
					coalesce(qt_min_solicitacao_w,0)||' '||obter_desc_expressao(793183)||' '||qt_max_solicitacao_w||'.'||chr(13) || chr(10)||chr(13) || chr(10);
					
					qt_contador_w := 0;
					
				end if;
				
			elsif (qt_exames_grupo_w < qt_min_solicitacao_w or  qt_exames_grupo_w > qt_max_solicitacao_w) then

				ds_retorno_2_w := ds_nome_exame_w||' ' ||obter_desc_expressao(309173)||': '||qt_pedido_aberto_w||'.' ||chr(13) || chr(10);

			end if;
			
		else
		
		ds_retorno_2_w := ds_nome_exame_w||' ' ||obter_desc_expressao(309173)||':'||qt_pedido_aberto_w||'.' ||chr(13) || chr(10);
		
		end if;
		
		if(((qt_max_solicitacao_w IS NOT NULL AND qt_max_solicitacao_w::text <> '') and qt_max_solicitacao_w < qt_pedido_aberto_w) or ((qt_min_solicitacao_w IS NOT NULL AND qt_min_solicitacao_w::text <> '') and qt_min_solicitacao_w > qt_pedido_aberto_w)) or (qt_exames_grupo_w < qt_min_solicitacao_w or  qt_exames_grupo_w > qt_max_solicitacao_w) then
				 			
				if(ds_retorno_grupo_w IS NOT NULL AND ds_retorno_grupo_w::text <> '' AND qt_registros_w > 1) then

					ds_retorno_w := ds_retorno_w||ds_retorno_grupo_w;
					ds_retorno_grupo_w := '';

				elsif (ds_retorno_2_w IS NOT NULL AND ds_retorno_2_w::text <> '') then

					ds_retorno_w := ds_retorno_w|| '     -> '||ds_retorno_2_w|| obter_desc_expressao(297109)||' '||obter_desc_expressao(763609)||' '||coalesce(qt_min_solicitacao_w,0)||' '||obter_desc_expressao(793183)||' '||						qt_max_solicitacao_w||'.'||chr(13) || chr(10)||chr(13) || chr(10);
					
				end if;
			end if;
			
			end;
		end loop;
		close C01;	
		
	end;
end loop;
close C02;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consistir_qt_exame_convenio ( nr_atendimento_p bigint, nr_sequencia_regra_p bigint) FROM PUBLIC;

