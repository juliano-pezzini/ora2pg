-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_tele_time ( nr_sequencia_p bigint, ie_option_p text ) RETURNS bigint AS $body$
DECLARE


	dt_tele_time 		pfcs_service_request.dt_authored_on%type;
	ds_note_w			varchar(50) := 'Association';
	ie_requested		varchar(5) := 'R';
	ie_started			varchar(5) := 'S';


BEGIN

	if (ie_option_p = ie_requested) then

		select sr.dt_authored_on into STRICT dt_tele_time
		from pfcs_service_request sr
		where sr.nr_sequencia = nr_sequencia_p;

	elsif (ie_option_p = ie_started) then

	  select dt_time into STRICT dt_tele_time
	  from (
			SELECT note.dt_time
			from
				pfcs_device_note note
			where note.nr_seq_device = nr_sequencia_p
				and note.ds_note = ds_note_w
			order by note.dt_time desc) alias1 LIMIT 1;

	end if;

	return round ((clock_timestamp() - dt_tele_time) * 24 * 60);
	
	exception
		-- If there are no records found
		when no_data_found then
		  return 0;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_tele_time ( nr_sequencia_p bigint, ie_option_p text ) FROM PUBLIC;

