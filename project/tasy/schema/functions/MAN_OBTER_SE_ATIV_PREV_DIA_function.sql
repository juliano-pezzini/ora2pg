-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_se_ativ_prev_dia ( nr_ordem_servico_p bigint, dt_dia_p timestamp, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(1) := 'N';
qt_sla_w		bigint;
qt_duvida_w		bigint;
qt_encerrada_w		bigint;
qt_solic_w		bigint;
qt_origem_w		bigint;
cd_pessoa_fisica_w	varchar(10);
nr_ordem_servico_w 	bigint;
qt_doc_def_w		bigint;

c01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	man_ordem_servico a
	where	a.nr_seq_origem = nr_ordem_servico_p;


BEGIN

/* Verificar primeiro se é SLA ou dúvida */

select	count(*)
into STRICT	qt_sla_w
from  	man_ordem_servico a,
      	man_ordem_serv_sla b
where 	a.nr_sequencia = b.nr_seq_ordem
and	b.nr_seq_ordem	= nr_ordem_servico_p;

select 	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_fisica_w
from	usuario
where	nm_usuario	= nm_usuario_p;

select	count(*)
into STRICT	qt_solic_w
from	man_ordem_servico  a
where	a.cd_pessoa_solicitante = cd_pessoa_fisica_w
and	a.nr_sequencia	= nr_ordem_servico_p;

select	count(*)
into STRICT	qt_duvida_w
from	man_ordem_servico  a
where	a.ie_classificacao = 'D'
and	a.nr_sequencia	= nr_ordem_servico_p;

select	count(*)
into STRICT	qt_encerrada_w
from	man_ordem_servico  a
where	a.nr_seq_estagio = 9
and	a.nr_sequencia	= nr_ordem_servico_p;

select	count(*)
into STRICT	qt_doc_def_w
from	man_doc_erro a
where	a.nr_seq_ordem = nr_ordem_servico_p
and	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

if (qt_encerrada_w > 0) or (qt_solic_w > 0) or (qt_sla_w > 0) or (qt_duvida_w > 0) or (qt_doc_def_w > 0) then
	ie_retorno_w	:= 'S';
end if;

if (ie_retorno_w <> 'S') then
	open c01;
	loop
	fetch c01 into
	nr_ordem_servico_w;
	EXIT WHEN NOT FOUND or ie_retorno_w = 'S';  /* apply on c01 */
	begin
		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_retorno_w
		from	man_ordem_ativ_prev a
		where	nr_seq_ordem_serv = nr_ordem_servico_w
		and 	nm_usuario_prev = nm_usuario_p
		and 	dt_prevista between trunc(dt_dia_p,'dd') and fim_dia(dt_dia_p);
	end;
	end loop;
	close c01;

	if (ie_retorno_w <> 'S') then
		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_retorno_w
		from	man_ordem_ativ_prev a
		where	nr_seq_ordem_serv = nr_ordem_servico_p
		and 	nm_usuario_prev = nm_usuario_p
		and 	dt_prevista between trunc(dt_dia_p,'dd') and fim_dia(dt_dia_p);
	end if;
end if;


return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_se_ativ_prev_dia ( nr_ordem_servico_p bigint, dt_dia_p timestamp, nm_usuario_p text) FROM PUBLIC;

