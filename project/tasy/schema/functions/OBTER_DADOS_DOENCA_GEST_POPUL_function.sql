-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_doenca_gest_popul ( cd_pessoa_fisica_p text, ie_opcao_p text, ie_tipo_doenca_p text default null, cd_ciap_p text default null, cd_doenca_p text default null, nr_seq_problema_p bigint default null, ie_cronico_p text default null, ie_intensidade_p text default null) RETURNS varchar AS $body$
DECLARE

 
/*Descrição 				ie_opcao_p 
Foco de doença				FD 
Problema					P 
Problema Crônico				PC 
*/
 
 
ds_retorno_w				varchar(2000) := '';
ds_doenca_w					varchar(255) := '';

C01 CURSOR FOR 
	SELECT 	distinct(substr(obter_valor_dominio(4111,ie_tipo_doenca),1,255)) ds 
	from  	cih_doenca_compulsoria a, 
			lista_problema_pac b 
	where 	b.cd_doenca = a.cd_doenca_cid 
	and  	coalesce(b.ie_situacao,'A') = 'A' 
	and  	coalesce(a.ie_situacao,'A') = 'A' 
	and		coalesce(b.dt_fim::text, '') = '' 
	and		b.ie_nivel_atencao = 'P' 
	and		b.cd_pessoa_fisica = cd_pessoa_fisica_p 
	and		coalesce(a.ie_tipo_doenca,'XPTO') = coalesce(ie_tipo_doenca_p,coalesce(a.ie_tipo_doenca,'XPTO')) 
	and		coalesce(b.cd_ciap,0) = coalesce(cd_ciap_p,coalesce(b.cd_ciap,0)) 
	and		coalesce(b.cd_doenca,0) = coalesce(cd_doenca_p,coalesce(b.cd_doenca,0)) 
	and		coalesce(b.nr_seq_cad_problema,0) = coalesce(nr_seq_problema_p,coalesce(b.nr_seq_cad_problema,0)) 
	and (coalesce(ie_cronico_p,'N') = 'N' or b.ie_status in ('2','3')) 
	and (coalesce(ie_intensidade_p,'T') = 'T' or b.ie_intensidade = ie_intensidade_p) 
	
union all
 
	SELECT 	distinct(substr(obter_valor_dominio(4111,c.ie_tipo_doenca),1,255)) ds 
	from	diagnostico_doenca a, 
			atendimento_paciente b, 
			cih_doenca_compulsoria c 
	where  c.cd_doenca_cid = a.cd_doenca 
	and		c.ie_tipo_doenca = ie_tipo_doenca_p 
	and		coalesce(a.ie_situacao,'A') = 'A' 
	and  	coalesce(c.ie_situacao,'A') = 'A' 
	and		a.ie_nivel_atencao = 'P' 
	and		b.ie_nivel_atencao = 'P' 
	and		b.nr_atendimento = a.nr_atendimento 
	and		b.cd_pessoa_fisica = cd_pessoa_fisica_p 
	and		coalesce(nr_seq_problema_p::text, '') = '' 
	and		coalesce(ie_cronico_p::text, '') = '' 
	and		coalesce(ie_intensidade_p::text, '') = '' 
	and		coalesce(a.cd_doenca,0) = coalesce(cd_doenca_p,coalesce(a.cd_doenca,0)) 
	and		coalesce(a.dt_fim,clock_timestamp()) >= clock_timestamp() 
	order by ds;
	

BEGIN 
 
if (ie_opcao_p = 'FD') then 
 
	open C01;
	loop 
	fetch C01 into	 
		ds_doenca_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		if (coalesce(trim(both ds_retorno_w)::text, '') = '') then 
			ds_retorno_w := ds_doenca_w;
		else 
			ds_retorno_w := ds_retorno_w||', '||ds_doenca_w;
		end if;
		 
		end;
	end loop;
	close C01;
	 
elsif ( ie_opcao_p = 'PC') then 
 
		Select 	coalesce(max('S'),'N') 
		into STRICT	ds_retorno_w 
		from  	lista_problema_pac b 
		where 	coalesce(b.ie_situacao,'A') = 'A' 
		and		b.ie_nivel_atencao = 'P' 
		and		coalesce(b.dt_fim::text, '') = '' 
		and		b.cd_pessoa_fisica = cd_pessoa_fisica_p 
		and		b.ie_status in ('2','3');
		 
elsif (ie_opcao_p = 'P') then 
 
	ds_retorno_w := 'S';
 
	if (nr_seq_problema_p IS NOT NULL AND nr_seq_problema_p::text <> '' AND ie_tipo_doenca_p IS NOT NULL AND ie_tipo_doenca_p::text <> '') then 
	 
		 
	 
		Select 	coalesce(max('S'),'N') 
		into STRICT	ds_retorno_w 
		from  	cih_doenca_compulsoria a, 
				lista_problema_pac b 
		where 	b.cd_doenca = a.cd_doenca_cid 
		and  	coalesce(b.ie_situacao,'A') = 'A' 
		and		b.ie_nivel_atencao = 'P' 
		and		coalesce(b.dt_fim::text, '') = '' 
		and		b.cd_pessoa_fisica = cd_pessoa_fisica_p 
		and		coalesce(a.ie_tipo_doenca,'XPTO') = coalesce(ie_tipo_doenca_p,coalesce(a.ie_tipo_doenca,'XPTO')) 
		and		coalesce(b.cd_ciap,0) = coalesce(cd_ciap_p,coalesce(b.cd_ciap,0)) 
		and		coalesce(b.cd_doenca,0) = coalesce(cd_doenca_p,coalesce(b.cd_doenca,0)) 
		and		coalesce(b.nr_seq_cad_problema,0) = coalesce(nr_seq_problema_p,coalesce(b.nr_seq_cad_problema,0)) 
		and (coalesce(ie_cronico_p,'N') = 'N' or b.ie_status in ('2','3')) 
		and (coalesce(ie_intensidade_p,'T') = 'T' or b.ie_intensidade = ie_intensidade_p);
		 
		 
	elsif (nr_seq_problema_p IS NOT NULL AND nr_seq_problema_p::text <> '') then 
	 
		 
		 
		Select 	coalesce(max('S'),'N') 
		into STRICT	ds_retorno_w 
		from  lista_problema_pac b 
		where  coalesce(b.ie_situacao,'A') = 'A' 
		and		b.ie_nivel_atencao = 'P' 
		and		coalesce(b.dt_fim::text, '') = '' 
		and		b.cd_pessoa_fisica = cd_pessoa_fisica_p	 
		and		coalesce(b.cd_ciap,0) = coalesce(cd_ciap_p,coalesce(b.cd_ciap,0)) 
		and		coalesce(b.cd_doenca,0) = coalesce(cd_doenca_p,coalesce(b.cd_doenca,0)) 
		and		coalesce(b.nr_seq_cad_problema,0) = coalesce(nr_seq_problema_p,coalesce(b.nr_seq_cad_problema,0)) 
		and (coalesce(ie_cronico_p,'N') = 'N' or b.ie_status in ('2','3')) 
		and (coalesce(ie_intensidade_p,'T') = 'T' or b.ie_intensidade = ie_intensidade_p);
				 
  else 
	 
		if (cd_ciap_p IS NOT NULL AND cd_ciap_p::text <> '') then 
		 
			 
		 
			Select coalesce(max('S'),'N') 
			into STRICT	ds_retorno_w 
			from	ciap_atendimento 
			where  coalesce(ie_situacao,'A') = 'A' 
			and		cd_pessoa_fisica = cd_pessoa_fisica_p 
			and		cd_ciap = cd_ciap_p;
		 
			if ( ds_retorno_w = 'N' ) then		 
				goto Fim;
			end if;
		 
		 
		end if;
			 
		if (cd_doenca_p IS NOT NULL AND cd_doenca_p::text <> '') then 
		 
			 
		 
			Select coalesce(max('S'),'N') 
			into STRICT	ds_retorno_w 
			from	diagnostico_doenca a, 
					atendimento_paciente b				 
			where  coalesce(a.ie_situacao,'A') = 'A' 
			and		b.ie_nivel_atencao = 'P'			 
			and		b.nr_atendimento = a.nr_atendimento 
			and		b.cd_pessoa_fisica = cd_pessoa_fisica_p 
			and		coalesce(a.dt_fim,clock_timestamp()) >= clock_timestamp() 
			and		a.cd_doenca = cd_doenca_p;
 
			if ( ds_retorno_w = 'N' ) then		 
				goto Fim;
			end if;
			 
		 
		end if;
 
		if (ie_tipo_doenca_p IS NOT NULL AND ie_tipo_doenca_p::text <> '') then 
		 
			Select coalesce(max('S'),'N') 
			into STRICT	ds_retorno_w 
			from	diagnostico_doenca a, 
					atendimento_paciente b, 
					cih_doenca_compulsoria c 
			where  c.cd_doenca_cid = a.cd_doenca 
			and		c.ie_tipo_doenca = ie_tipo_doenca_p 
			and		coalesce(a.ie_situacao,'A') = 'A' 
			and  	coalesce(c.ie_situacao,'A') = 'A' 
			and		b.ie_nivel_atencao = 'P' 
			and		a.ie_nivel_atencao = 'P' 
			and		b.nr_atendimento = a.nr_atendimento 
			and		b.cd_pessoa_fisica = cd_pessoa_fisica_p 
			and		coalesce(a.dt_fim,clock_timestamp()) >= clock_timestamp();
		 
			if (ds_retorno_w = 'N') then 
		 
		 
				Select coalesce(max('S'),'N') 
				into STRICT	ds_retorno_w 
				from  	cih_doenca_compulsoria a, 
						lista_problema_pac b 
				where 	b.cd_doenca = a.cd_doenca_cid 
				and  	coalesce(b.ie_situacao,'A') = 'A' 
				and  	coalesce(a.ie_situacao,'A') = 'A' 
				and		a.ie_tipo_doenca = ie_tipo_doenca_p 
				and		coalesce(b.dt_fim::text, '') = '' 
				and		b.ie_nivel_atencao = 'P' 
				and		b.cd_pessoa_fisica = cd_pessoa_fisica_p 
				and		b.ie_nivel_atencao = 'P';
 
			end if;
						 
		 
		end if;	
		 
	 
	 
	end if;
 
		 
end if;
 
	<<Fim>> 
	ds_retorno_w	:= ds_retorno_w;	
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_doenca_gest_popul ( cd_pessoa_fisica_p text, ie_opcao_p text, ie_tipo_doenca_p text default null, cd_ciap_p text default null, cd_doenca_p text default null, nr_seq_problema_p bigint default null, ie_cronico_p text default null, ie_intensidade_p text default null) FROM PUBLIC;

