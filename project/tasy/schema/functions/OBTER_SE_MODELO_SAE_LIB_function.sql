-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_modelo_sae_lib ( nr_seq_pe_sae_model_p bigint, cd_pessoa_fisica_p text default null, nr_atendimento_p bigint default 0) RETURNS varchar AS $body$
DECLARE


qt_itens_w					 bigint;
ie_sexo_w					 varchar(1);
qt_idade_w					 integer;
ie_inserir_w				 varchar(2);
ie_tipo_evolucao_w			 varchar(4);
cd_estabelecimento_usuario_w bigint;
cd_setor_atendimento_w       integer := 0;

C01 CURSOR FOR
	SELECT coalesce(a.ie_inserir,'S')
	from   pe_sae_modelo_perfil a,
		   pe_sae_modelo b
	where  a.nr_seq_pe_sae_model = nr_seq_pe_sae_model_p
	and	   a.nr_seq_pe_sae_model = b.nr_sequencia
	and	   coalesce(a.cd_perfil,obter_perfil_ativo) = obter_perfil_ativo	
	and	   coalesce(b.cd_estabelecimento, cd_estabelecimento_usuario_w) = cd_estabelecimento_usuario_w
	and	   coalesce(a.ie_tipo_evolucao,ie_tipo_evolucao_w) = ie_tipo_evolucao_w
	and    coalesce(a.cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
	and    coalesce(a.cd_estabelecimento,coalesce(cd_estabelecimento_usuario_w,0)) = coalesce(cd_estabelecimento_usuario_w,0)
	and	   ((coalesce(a.ie_sexo::text, '') = '') or (coalesce(ie_sexo_w::text, '') = '') or (a.ie_sexo = ie_sexo_w))
	and	   ((coalesce(a.qt_idade_min::text, '') = '') or (coalesce(a.qt_idade_max::text, '') = '') or (coalesce(qt_idade_w::text, '') = '') or (qt_idade_w between a.qt_idade_min and a.qt_idade_max))
	order by coalesce(a.cd_perfil,0),
		 coalesce(a.ie_tipo_evolucao,'0');
	

BEGIN

if (nr_atendimento_p > 0) then
	cd_setor_atendimento_w := obter_setor_atendimento(nr_atendimento_p);
end if;

select	coalesce(max(ie_tipo_evolucao),'XPTO')
into STRICT	ie_tipo_evolucao_w
from	usuario
where	nm_usuario =  wheb_usuario_pck.get_nm_usuario;

cd_estabelecimento_usuario_w := wheb_usuario_pck.get_cd_estabelecimento;

select	count(*)
into STRICT	qt_itens_w
from	pe_sae_modelo_perfil
where	nr_seq_pe_sae_model	=	nr_seq_pe_sae_model_p;



if (qt_itens_w = 0) then
	return 'S';
else
	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
		select max(ie_sexo),
			   max(obter_idade(dt_nascimento, clock_timestamp(), 'A'))
		into STRICT   ie_sexo_w,
			   qt_idade_w
		from   pessoa_fisica
		where  cd_pessoa_fisica = cd_pessoa_fisica_p;
	end if;
	
	open C01;
	loop
	fetch C01 into	
		ie_inserir_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;
	
	return	coalesce(ie_inserir_w,'N');

end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_modelo_sae_lib ( nr_seq_pe_sae_model_p bigint, cd_pessoa_fisica_p text default null, nr_atendimento_p bigint default 0) FROM PUBLIC;

