-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION verifica_procedimento_onco ( nr_atendimento_p bigint, nr_seq_paciente_p bigint) RETURNS varchar AS $body$
DECLARE


  cd_protocolo_w           paciente_setor.cd_protocolo%type;
  nr_seq_medicacao_w       paciente_setor.nr_seq_medicacao%type;
  cd_convenio_w            atend_categoria_convenio.cd_convenio%type;
  nr_seq_proc_w            bigint;
  nr_agrupamento_proced_w  bigint;
  ds_registro_w            varchar(1);
  count_w                  bigint;

BEGIN

  ds_registro_w := 'N';
  begin
    select atend_categoria_convenio.cd_convenio
      into STRICT cd_convenio_w
      from atend_categoria_convenio
     where atend_categoria_convenio.nr_atendimento = nr_atendimento_p;
  exception
    when others then
      cd_convenio_w := null;
  end;
  
  begin
    select cd_protocolo,
           nr_seq_medicacao
      into STRICT cd_protocolo_w,
           nr_seq_medicacao_w
      from paciente_setor
     where nr_seq_paciente = nr_seq_paciente_p;
  exception
    when others then
      cd_protocolo_w := null;
      nr_seq_medicacao_w := null;
  end;
  
  begin
    select count(1)
      into STRICT count_w
      from regra_procedimento_onc
     where ((regra_procedimento_onc.cd_estabelecimento =
           wheb_usuario_pck.get_cd_estabelecimento) or (coalesce(regra_procedimento_onc.cd_estabelecimento::text, '') = ''))
       and coalesce(regra_procedimento_onc.cd_protocolo, coalesce(cd_protocolo_w, 0)) =
           coalesce(cd_protocolo_w, 0)
       and coalesce(regra_procedimento_onc.cd_convenio, coalesce(cd_convenio_w, 0)) =
           coalesce(cd_convenio_w, 0)
       and coalesce(regra_procedimento_onc.nr_seq_medicacao,
               coalesce(nr_seq_medicacao_w, 0)) = coalesce(nr_seq_medicacao_w, 0)
       and coalesce(regra_procedimento_onc.ie_situacao,'A') = 'A';
  exception
    when others then
      count_w := 0;
  end;

  if coalesce(count_w,0) > 0 then
    ds_registro_w := 'S';
  end if;

  return ds_registro_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION verifica_procedimento_onco ( nr_atendimento_p bigint, nr_seq_paciente_p bigint) FROM PUBLIC;

