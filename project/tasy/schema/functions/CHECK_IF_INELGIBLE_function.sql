-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION check_if_inelgible ( nr_atendimento_p bigint DEFAULT NULL) RETURNS varchar AS $body$
DECLARE

    ie_eligivel_w varchar(5);

BEGIN
    IF ( coalesce(nr_atendimento_p::text, '') = '' ) THEN
        ie_eligivel_w := 'CI';
    ELSIF (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') THEN
        SELECT
            coalesce(MAX('CI'), 'N')
        INTO STRICT ie_eligivel_w
        FROM
            nursing_care_encounter enr
        WHERE
            enr.nr_atendimento = nr_atendimento_p
            AND enr.dt_atualizacao = (
                SELECT
                    MAX(enm.dt_atualizacao)
                FROM
                    nursing_care_encounter enm
                WHERE
                    enm.nr_atendimento = nr_atendimento_p
                    AND enm.nr_seq_justificativa IN (
                        3,
                        4,
                        6
                    )
                    AND enm.nr_sequencia = (
                        SELECT
                            MAX(seq.nr_sequencia)
                        FROM
                            nursing_care_encounter seq
                        WHERE
                            seq.nr_atendimento = nr_atendimento_p
                    )
            );

    END IF;

    IF ( ie_eligivel_w <> 'CI' ) THEN
        SELECT
            coalesce(MAX('PI'), 'N')
        INTO STRICT ie_eligivel_w
        FROM
            nursing_care_encounter nce
        WHERE
            nce.nr_atendimento = nr_atendimento_p
            AND (nce.nr_seq_justificativa IS NOT NULL AND nce.nr_seq_justificativa::text <> '');

    END IF;

    RETURN ie_eligivel_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION check_if_inelgible ( nr_atendimento_p bigint DEFAULT NULL) FROM PUBLIC;

