-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pesquisa_satisf_obter_se_resp ( nr_seq_pergunta_p pesquisa_satisf_pergunta.nr_sequencia%type, ds_periodicidade_p text, dt_atualizacao_nrec_p timestamp) RETURNS varchar AS $body$
DECLARE


--dt_atualizacao_nrec_p data da ultima resposta do usuario a pergunta
ds_retorno_w		varchar(1) := 'N';
qt_registros_w		bigint;
dia_semana_hoje_w	bigint;
dia_mes_hoje_w		bigint;
ds_periodicidade_w	varchar(1);


BEGIN
  ds_periodicidade_w := coalesce(ds_periodicidade_p, 'D');

--W: semanal
if (ds_periodicidade_w = 'W') then
	if (dt_atualizacao_nrec_p between obter_inicio_fim_semana(clock_timestamp(), 'I') and obter_inicio_fim_semana(clock_timestamp(), 'F')) then
		ds_retorno_w	:= 'S';
	end if;

--M: mensal
elsif (ds_periodicidade_w = 'M') then
	if (dt_atualizacao_nrec_p between trunc(clock_timestamp(),'mm') and fim_mes(clock_timestamp()))then
		ds_retorno_w	:= 'S';
	end if;
	
--S: dias da semana: numeros de 1 a 7(domingo a sabado), separados por virgula. ex.: 2,4,6 (representando segundas, quartas e sextas)
elsif (ds_periodicidade_w = 'F') then
	if (trunc(dt_atualizacao_nrec_p) = trunc(clock_timestamp()))then
		ds_retorno_w	:= 'S';
	else
		dia_mes_hoje_w := (to_char(clock_timestamp(),'dd'))::numeric;
		dia_semana_hoje_w := pkg_date_utils.get_WeekDay(clock_timestamp());
				
		select count(1)
		into STRICT qt_registros_w 
		from pesquisa_satisf_dia_fixo 
		where nr_seq_pergunta = nr_seq_pergunta_p 
		and (nr_dia_mes = dia_mes_hoje_w or trunc(dt_dia_fixo) = trunc(clock_timestamp()) or nr_dia_semana = dia_semana_hoje_w);
		
		if (qt_registros_w > 0) then
			ds_retorno_w	:= 'N';
		else
			ds_retorno_w	:= 'S';
		end if;
	end if;

elsif (trunc(dt_atualizacao_nrec_p) = trunc(clock_timestamp())) then
	ds_retorno_w:= 'S';
end if;
   
return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pesquisa_satisf_obter_se_resp ( nr_seq_pergunta_p pesquisa_satisf_pergunta.nr_sequencia%type, ds_periodicidade_p text, dt_atualizacao_nrec_p timestamp) FROM PUBLIC;

