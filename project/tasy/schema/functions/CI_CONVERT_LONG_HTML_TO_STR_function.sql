-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ci_convert_long_html_to_str (nr_sequencia_p comunic_interna.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE

						
x 	varchar(4000) := null;
in_html boolean  := false;
s varchar(1);
ds_texto_w varchar(4000);

qt_lenght_w  bigint;
cursor_w integer := dbms_sql.open_cursor;
fetch_w  integer;

BEGIN
	
	begin
		dbms_sql.parse(cursor_w,'select ds_comunicado from comunic_interna where nr_sequencia = :nr_sequencia_p', dbms_sql.native);
		dbms_sql.bind_variable(cursor_w,'nr_sequencia_p', nr_sequencia_p);
		dbms_sql.define_column_long(cursor_w,1);

		fetch_w := dbms_sql.execute_and_fetch(cursor_w);

		dbms_sql.column_value_long(cursor_w,1,4000,0, ds_texto_w, qt_lenght_w);
		dbms_sql.close_cursor(cursor_w);
	exception
	when others then
      ds_texto_w := '';
	end;

	if (ds_texto_w IS NOT NULL AND ds_texto_w::text <> '') and (position('<html' in ds_texto_w) > 0) then
		
		for i in 1 .. length( ds_texto_w ) loop
			s := substr( ds_texto_w, i, 1 );
			
			if in_html then
				if s = '>' then
					in_html := false;
				end if;
			else
				if s = '<' then
					in_html := true;
				end if;
			end if;
			
			if not in_html and s != '>' then
				x := substr(x || s,1,4000);
			end if;
		end loop;
		
		return x;
	end if;	

	return ds_texto_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ci_convert_long_html_to_str (nr_sequencia_p comunic_interna.nr_sequencia%type) FROM PUBLIC;

