-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_total_atend ( nr_seq_ret_p bigint, cd_conv_p bigint, cd_mat_p bigint, nr_titulo_p bigint, nr_interno_conta_p bigint, ie_proc_p bigint default 0) RETURNS bigint AS $body$
DECLARE

				 
vl_material_w    	material_atend_paciente.vl_material%type;
ds_retorno_w    	material_atend_paciente.vl_material%type;
vl_percent_mat_w	double precision;
vl_imposto_w    	convenio_receb_adic.vl_adicional%type;
vl_titulo_w      	titulo_receber.vl_titulo%type;
vl_mat_w    	material_Atend_paciente.vl_material%type;
vl_percent_imposto_w  double precision;
vl_tit_w      	double precision;


BEGIN 
select	vl_titulo     
into STRICT	vl_titulo_w     
from	titulo_receber    
where	nr_titulo = nr_titulo_p;
 
select	coalesce(sum(a.vl_adicional),0)  
into STRICT	vl_imposto_w     
from	convenio_receb_adic a,     
	convenio_receb b,    
	convenio_ret_receb c   
where	a.nr_seq_Receb		= b.nr_sequencia 
and	c.nr_seq_receb   	= b.nr_sequencia 
and	c.nr_seq_retorno= nr_seq_ret_p;
 
vl_percent_imposto_w := dividir((vl_imposto_w * 100), vl_titulo_w);
 
vl_tit_w := dividir((vl_titulo_w * vl_percent_imposto_w),100);
 
 
if (coalesce(ie_proc_p,0) = 0) then    
	select	coalesce(sum(vl_material),0)   
	into STRICT	vl_mat_w 
	from	material_atend_paciente   
	where	cd_material		= cd_mat_p   
	and	nr_interno_Conta 	= nr_interno_conta_p;
 
	select	coalesce(sum(f.vl_material),0) 
	into STRICT  vl_material_w  
	from  convenio_retorno a, 
		convenio_retorno_item b,    
		conta_paciente d,  
		atendimento_paciente e, 
		material_atend_paciente f    
	where  b.nr_seq_retorno	= a.nr_sequencia  
	and 	b.nr_interno_conta	= d.nr_interno_conta   
	and 	d.nr_atendimento	= e.nr_atendimento 
	and 	f.nr_interno_conta   = d.nr_interno_conta   
	and 	a.nr_sequencia   	= nr_seq_ret_p 
	and 	(f.cd_material IS NOT NULL AND f.cd_material::text <> '')    
	and 	a.cd_convenio 		= cd_conv_p;
else 
	select	coalesce(sum(vl_procedimento),0) 
	into STRICT  vl_mat_w 
	from  procedimento_paciente    
	where	cd_procedimento 	= cd_mat_p 
	and  	nr_interno_Conta 	= nr_interno_conta_p;
 
	select	coalesce(sum(f.vl_procedimento),0)  
	into STRICT  vl_material_w  
	from  convenio_retorno a, 
		convenio_retorno_item b,    
		conta_paciente d,  
		atendimento_paciente e, 
		procedimento_paciente f 
	where  b.nr_seq_retorno	= a.nr_sequencia  
	and	b.nr_interno_conta	= d.nr_interno_conta   
	and	d.nr_atendimento	= e.nr_atendimento 
	and	f.nr_interno_conta	= d.nr_interno_conta   
	and	a.nr_sequencia   	= nr_seq_ret_p 
	and	(f.cd_procedimento IS NOT NULL AND f.cd_procedimento::text <> '')    
	and	a.cd_convenio 		= cd_conv_p;
end if;
 
ds_retorno_w := dividir((vl_mat_w * vl_tit_w),vl_material_w);
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_total_atend ( nr_seq_ret_p bigint, cd_conv_p bigint, cd_mat_p bigint, nr_titulo_p bigint, nr_interno_conta_p bigint, ie_proc_p bigint default 0) FROM PUBLIC;

