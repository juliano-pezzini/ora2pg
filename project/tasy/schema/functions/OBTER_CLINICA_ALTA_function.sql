-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_clinica_alta ( nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


dt_nascimento_w		timestamp;
dt_entrada_w			timestamp;
dt_alta_w			timestamp;
qt_anos_w			integer;
qt_Dias_w			bigint;
qt_cirurgia_w			integer;
ie_clinica_w			varchar(1);
qt_cid_w			integer;


BEGIN

select	dt_nascimento,
	dt_entrada,
	dt_alta,
	Campo_Numerico(obter_idade(dt_nascimento, coalesce(dt_alta, clock_timestamp()),'A')),
	trunc(coalesce(dt_alta, clock_timestamp()) - dt_nascimento)
into STRICT	dt_nascimento_w,
	dt_entrada_w,
	dt_alta_w,
	qt_anos_w,
	qt_dias_w
from	pessoa_fisica b,
	atendimento_paciente a
where	a.nr_atendimento	= nr_atendimento_p
and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica;

ie_clinica_w		:= '';
select count(*)
into STRICT	qt_cid_w
from	Diagnostico_doenca
where	nr_atendimento		= nr_atendimento_p
and	substr(cd_doenca,1,1)	= 'O'
and	campo_numerico(substr(cd_doenca,2,2)) between 00 and 99;
if (coalesce(ie_clinica_w::text, '') = '') and (qt_cid_w > 0) then
	ie_clinica_w	:= 'O'; /* Obstetricia */
end if;

select count(*)
into STRICT	qt_cid_w
from	Diagnostico_doenca
where	nr_atendimento		= nr_atendimento_p
and	substr(cd_doenca,1,1)	= 'N'
and	campo_numerico(substr(cd_doenca,2,2)) between 60 and 99;
if (coalesce(ie_clinica_w::text, '') = '') and (qt_cid_w > 0) then
	ie_clinica_w	:= 'G'; /* Ginecologia */
end if;

select count(*)
into STRICT	qt_cid_w
from	Diagnostico_doenca
where	nr_atendimento		= nr_atendimento_p
and	substr(cd_doenca,1,1)	= 'P'
and	campo_numerico(substr(cd_doenca,2,2)) between 00 and 96;
if (coalesce(ie_clinica_w::text, '') = '') and (qt_cid_w > 0) then
	ie_clinica_w	:= 'N'; /* Neomatologia */
end if;

select	count(*)
into STRICT	qt_cirurgia_w
from	cirurgia
where	nr_atendimento	= nr_atendimento_p;

if (coalesce(ie_clinica_w::text, '') = '') and (qt_cirurgia_w > 0) then
	ie_clinica_w	:= 'C'; /* Cirurgica */
end if;

if (coalesce(ie_clinica_w::text, '') = '') and
	((coalesce(dt_alta_w,clock_timestamp()) - dt_entrada_w) < 1) then
	ie_clinica_w	:= 'D'; /* Hospital dia */
end if;

if (coalesce(ie_clinica_w::text, '') = '') then
	if (qt_anos_w < 14) then
		ie_clinica_w	:= 'P'; /* Pediatria */
	else
		ie_clinica_w	:= 'L'; /* Clinica */
	end if;
end if;

Return ie_clinica_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_clinica_alta ( nr_atendimento_p bigint) FROM PUBLIC;

