-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_verifica_alergico (nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

										
ds_retorno_w	varchar(1) := 'N';
nr_atendimento_w  	varchar(10);
medic_susp_w	varchar(1);
medicamentos_adm_w	varchar(1);
mostrar_kit_w varchar(1);
cd_pessoa_fisica_w	varchar(10);
										

BEGIN

if (coalesce(nr_prescricao_p,0) > 0) then
	
if (obter_funcao_ativa = 252) then
	medic_susp_w := 'S';
	medicamentos_adm_w := 'N';
	mostrar_kit_w := 'S';
else
	medic_susp_w := obter_param_usuario(7010, 29, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, medic_susp_w);
	medicamentos_adm_w := obter_param_usuario(7010, 86, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, medicamentos_adm_w);
	mostrar_kit_w := obter_param_usuario(7010, 153, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, mostrar_kit_w);
end if;
	
	select 	max(a.nr_atendimento),
		max(a.cd_pessoa_fisica)
	into STRICT 	nr_atendimento_w,
		cd_pessoa_fisica_w
	from 	prescr_medica a
	where 	nr_prescricao = nr_prescricao_p;

	select 	coalesce(max('S'),'N')
	into STRICT 	ds_retorno_w
	from   	prescr_material a,
		material b
	where  	a.nr_prescricao = nr_prescricao_p
	and	a.cd_material	= b.cd_material
	and	coalesce(a.nr_sequencia_dieta::text, '') = ''
	and	coalesce(a.nr_sequencia_diluicao::text, '') = ''
	and 	a.ie_agrupador in (1,4,5)
	AND	b.ie_tipo_material IN ('0','2','3','6','9')
	and	Obter_Paciente_Alergico(cd_pessoa_fisica_w,a.cd_material) = 'S'
	AND 	((medic_susp_w = 'S') OR (coalesce(a.dt_suspensao::text, '') = ''))
	AND 	(((coalesce(medicamentos_adm_w, 'S') = 'S') AND (coalesce(a.ie_administrar,'S') = 'S')) OR (coalesce(medicamentos_adm_w, 'S') = 'N'))
	AND 	((mostrar_kit_w = 'S') OR ((mostrar_kit_w = 'N') AND (coalesce(a.nr_seq_kit::text, '') = '')))  LIMIT 1;
	
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_verifica_alergico (nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

