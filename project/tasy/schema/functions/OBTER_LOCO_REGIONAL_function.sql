-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_loco_regional ( cd_pessoa_fisica_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(255);
qt_peso_w			real;
qt_altura_w			smallint;
qt_redutor_sc_w			double precision;
qt_superf_corporea_w		double precision;
qt_auc_w			real;
qt_creatinina_w			real;
ie_l_dl_creatinina_w		smallint;
qt_clearance_creatinina_w	double precision;
qt_mg_carboplatina_w		double precision;
ds_cid_10_w			varchar(255);
ds_tnm_w			varchar(50);
ds_ptnm_w			varchar(50);


BEGIN

begin
select	qt_peso,
	qt_altura,
	qt_redutor_sc,
	obter_superficie_corp_red_ped(qt_peso, qt_altura, qt_redutor_sc, cd_pessoa_fisica, nm_usuario),
	qt_auc,
	qt_creatinina,
	ie_l_dl_creatinina,
	qt_clearance_creatinina,
	qt_mg_carboplatina
into STRICT	qt_peso_w,
	qt_altura_w,
	qt_redutor_sc_w,
	qt_superf_corporea_w,
	qt_auc_w,
	qt_creatinina_w,
	ie_l_dl_creatinina_w,
	qt_clearance_creatinina_w,
	qt_mg_carboplatina_w
from	paciente_setor
where	cd_pessoa_fisica	= cd_pessoa_fisica_p
and	nr_seq_paciente		= (	SELECT	max(nr_seq_paciente)
					from	paciente_setor
					where	cd_pessoa_fisica	= cd_pessoa_fisica_p);
exception
when others then
	qt_peso_w			:= null;
	qt_altura_w			:= null;
	qt_redutor_sc_w			:= null;
	qt_superf_corporea_w		:= null;
	qt_auc_w			:= null;
	qt_creatinina_w			:= null;
	ie_l_dl_creatinina_w		:= null;
	qt_clearance_creatinina_w	:= null;
	qt_mg_carboplatina_w		:= null;
end;



select	coalesce(qt_peso_w, qt_peso),
	coalesce(qt_altura_w, qt_altura),
	coalesce(qt_redutor_sc_w, qt_redutor_sc),
	coalesce(qt_superf_corporea_w, Obter_Superficie_Corporea_red(qt_altura, qt_peso, qt_redutor_sc)),
	coalesce(qt_auc_w, qt_auc),
	coalesce(qt_creatinina_w, qt_creatinina),
	coalesce(ie_l_dl_creatinina_w, ie_l_dl_creatinina),
	coalesce(qt_clearance_creatinina_w, qt_clearance_creatinina),
	coalesce(qt_mg_carboplatina_w, qt_mg_carboplatina),
	substr(cd_doenca_cid || ' - '|| obter_desc_cid(cd_doenca_cid),1,255),
	cd_tumor_primario || ' ' || cd_linfonodo_regional || ' ' || cd_metastase_distancia,
	cd_tumor_prim_pat || ' ' || cd_linfonodo_reg_pat || ' ' || cd_metastase_dist_pat
into STRICT	qt_peso_w,
	qt_altura_w,
	qt_redutor_sc_w,
	qt_superf_corporea_w,
	qt_auc_w,
	qt_creatinina_w,
	ie_l_dl_creatinina_w,
	qt_clearance_creatinina_w,
	qt_mg_carboplatina_w,
	ds_cid_10_w,
	ds_tnm_w,
	ds_ptnm_w
from	can_loco_regional
where	nr_sequencia = (	SELECT	max(nr_sequencia)
				from	can_loco_regional
				where	cd_pessoa_fisica	= cd_pessoa_fisica_p);


if (UPPER(ie_opcao_p) = obter_desc_expressao(350910)) then
	ds_retorno_w	:= qt_peso_w;
elsif (UPPER(ie_opcao_p) = obter_desc_expressao(350911)) then
	ds_retorno_w	:= qt_altura_w;
elsif (UPPER(ie_opcao_p) = 'REDSC') then
	ds_retorno_w	:= qt_redutor_sc_w;
elsif (UPPER(ie_opcao_p) = obter_desc_expressao(558624)) then
	ds_retorno_w	:= round((qt_superf_corporea_w)::numeric,3);
elsif (UPPER(ie_opcao_p) = obter_desc_expressao(284027)) then
	ds_retorno_w	:= qt_auc_w;
elsif (UPPER(ie_opcao_p) = 'CREATININA') and (coalesce(qt_creatinina_w,0) <> 0) then
	if (ie_l_dl_creatinina_w = 0) then
		--ds_retorno_w	:= qt_creatinina_w ||' mg/l';
		ds_retorno_w	:= qt_creatinina_w ||' '|| substr(obter_desc_expressao(726142,null),1,255);
	else
		--ds_retorno_w	:= qt_creatinina_w ||' mg/dl';
		ds_retorno_w	:= qt_creatinina_w ||' '|| substr(obter_desc_expressao(726144,null),1,255);
	end if;
elsif (UPPER(ie_opcao_p) = 'CLEARENCE') then
	ds_retorno_w	:= qt_clearance_creatinina_w;
elsif (UPPER(ie_opcao_p) = 'CARBOPLATINA') then
	ds_retorno_w	:= qt_mg_carboplatina_w;
elsif (UPPER(ie_opcao_p) = 'CID10') then
	ds_retorno_w	:= ds_cid_10_w;
elsif (UPPER(ie_opcao_p) = obter_desc_expressao(300134)) then
	ds_retorno_w	:= ds_tnm_w;
elsif (UPPER(ie_opcao_p) = obter_desc_expressao(296637)) then
	ds_retorno_w	:= ds_ptnm_w;
end if;

return ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_loco_regional ( cd_pessoa_fisica_p text, ie_opcao_p text) FROM PUBLIC;

