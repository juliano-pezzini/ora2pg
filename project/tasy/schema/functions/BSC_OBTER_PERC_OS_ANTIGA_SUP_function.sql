-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION bsc_obter_perc_os_antiga_sup ( dt_referencia_p timestamp, ie_area_p text) RETURNS bigint AS $body$
DECLARE


qt_retorno_w			double precision		:= 0;
qt_total_os_w			bigint		:= 0;
qt_total_os_antiga_w		bigint		:= 0;
dt_ref_mes_w			timestamp;


BEGIN

if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then
	dt_ref_mes_w	:= trunc(dt_referencia_p,'month');


	select 		sum(qt_os),
			sum(qt_mais_trinta)
	into STRICT		qt_total_os_w,
			qt_total_os_antiga_w
	from   		os_pend_suporte
	where  		trunc(dt_referencia,'month') = dt_ref_mes_w
	and		IE_AREA_P = 'SUP'
	and		pkg_date_utils.get_WeekDay(dt_referencia) not in (1,7)
	and		trunc(dt_referencia,'month') >= to_date('04/2017','mm/yyyy')
	and 		nr_seq_grupo <> 81
	and		coalesce(obter_se_feriado(wheb_usuario_pck.get_cd_estabelecimento, dt_referencia),0) = 0;


	qt_retorno_w	:= dividir(qt_total_os_antiga_w * 100, qt_total_os_w);
end if;


return	qt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION bsc_obter_perc_os_antiga_sup ( dt_referencia_p timestamp, ie_area_p text) FROM PUBLIC;

