-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_alt_qtd_regra_solic ( cd_material_p bigint, cd_local_estoque_p bigint, cd_opcao_p text) RETURNS varchar AS $body$
DECLARE

/*					
utilizado na função gestão de cirurgias - parâmetro [44]
	'900' gestão de cirurgias
Utilizado na função Atendimento da prescrição
	'36x'  Atendimento da prescrição	
*/
ie_alterar_quantidade_w	varchar(1);
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;

BEGIN
cd_estabelecimento_w		:= coalesce(wheb_usuario_pck.get_cd_estabelecimento,1);

if (cd_opcao_p = '900') then
	select	max(ie_alterar_quantidade)
	into STRICT	ie_alterar_quantidade_w
	from (	SELECT	coalesce(ie_alt_qtd_ges_cirurgia,'S') ie_alterar_quantidade
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	coalesce(ie_gestao_cirurgia,'N') = 'S'
		order by cd_local_estoque) alias7 LIMIT 1;
elsif (cd_opcao_p = '7029') then
	select	max(ie_alterar_quantidade)
	into STRICT	ie_alterar_quantidade_w
	from (	SELECT	coalesce(ie_alterar_quantidade,'S') ie_alterar_quantidade
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	coalesce(ie_atend_lote,'N') = 'S'
		order by cd_local_estoque) alias7 LIMIT 1;
elsif (cd_opcao_p	= '36x') then
	select	max(ie_alterar_quantidade)
	into STRICT	ie_alterar_quantidade_w
	from (	SELECT	coalesce(ie_alterar_quantidade,'S') ie_alterar_quantidade
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_prescricao_atend = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
elsif (cd_opcao_p	= '109') then
	select	max(ie_alterar_quantidade)
	into STRICT	ie_alterar_quantidade_w
	from (	SELECT	coalesce(ie_alterar_quantidade,'S') ie_alterar_quantidade
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_requisicao = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
elsif (cd_opcao_p in ('919x', '-109')) then
	select	max(ie_alterar_quantidade)
	into STRICT	ie_alterar_quantidade_w
	from (	SELECT	coalesce(ie_alterar_quantidade,'S') ie_alterar_quantidade
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_requisicao_transf = 'S'
		order by cd_local_estoque) alias7 LIMIT 1;
elsif (cd_opcao_p	= '389') then
	select	max(ie_alterar_quantidade)
	into STRICT	ie_alterar_quantidade_w
	from (	SELECT	coalesce(ie_alterar_quantidade,'S') ie_alterar_quantidade
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_atend_req_pda = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
elsif (cd_opcao_p = '24x') then
	select	max(ie_alterar_quantidade)
	into STRICT	ie_alterar_quantidade_w
	from (	SELECT	coalesce(ie_alterar_quantidade,'S') ie_alterar_quantidade
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	IE_EXECUCAO_DEV = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
end if;

RETURN	ie_alterar_quantidade_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_alt_qtd_regra_solic ( cd_material_p bigint, cd_local_estoque_p bigint, cd_opcao_p text) FROM PUBLIC;

