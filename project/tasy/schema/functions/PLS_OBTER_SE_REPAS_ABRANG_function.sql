-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_repas_abrang ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_operadora_atend_p pls_congenere.nr_sequencia%type, nm_usuario_p text, ie_tipo_conta_p pls_conta.ie_tipo_conta%type, dt_emissao_p timestamp) RETURNS varchar AS $body$
DECLARE

/*
Após retornar os dados, o sistema compara se a Unimed executora é a mesma Unimed para onde o usuário foi repassado.
Se o beneficiário foi repassado para a Unimed SJRP e está sendo atendido pela Unimed Litoral, irá glosar, ou seja,  irá retornar glosa.
*/
qt_repasse_w				integer;
qt_operadora_val_w			integer;
ie_tipo_repasse_w			pls_segurado_repasse.ie_tipo_repasse%type;
nr_seq_congenere_w			pls_congenere.nr_sequencia%type;
ie_atend_operadora_repasse_w		pls_regra_intercambio_aut.ie_unimed_repasse%type;
ie_area_coberta_w			varchar(1);

BEGIN

ie_area_coberta_w	:= 'N';

-- Verificação de tipo de repasse do beneficiário e da regra de autorização
select	max(ie_tipo_repasse)
into STRICT	ie_tipo_repasse_w
from	pls_segurado_repasse
where	nr_seq_segurado	= nr_seq_segurado_p;

-- Tipo unimed de repasse
select	max(ie_atend_operadora_repasse)
into STRICT	ie_atend_operadora_repasse_w
from	pls_regra_intercambio_aut
where	((ie_tipo_repasse	= ie_tipo_repasse_w)
or (coalesce(ie_tipo_repasse::text, '') = ''));

/*Se a regra de repasse for "Somente permitir atendimento pela operadora repassada"*/

if (ie_atend_operadora_repasse_w	= 'S') then
	-- verifica se a congenere do repasse é a mesma do atendimento
	select	count(1)
	into STRICT	qt_operadora_val_w
	from	pls_segurado_repasse
	where	nr_seq_segurado	= nr_seq_segurado_p
	and (nr_seq_congenere = nr_seq_operadora_atend_p or nr_seq_congenere_atend = nr_seq_operadora_atend_p)
	and 	((trunc(dt_emissao_p) between trunc(dt_repasse) and trunc(dt_fim_repasse))
	or (trunc(dt_emissao_p) >= trunc(dt_repasse) and coalesce(dt_fim_repasse::text, '') = ''));

	if (qt_operadora_val_w > 0)	then
		ie_area_coberta_w := 'S';
	end if;
end if;

return ie_area_coberta_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_repas_abrang ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_operadora_atend_p pls_congenere.nr_sequencia%type, nm_usuario_p text, ie_tipo_conta_p pls_conta.ie_tipo_conta%type, dt_emissao_p timestamp) FROM PUBLIC;

