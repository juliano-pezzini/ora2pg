-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION is_pbs_restricted (cd_pbs_p text, cd_mode_p text) RETURNS varchar AS $body$
DECLARE


/*
  cd_mode_p = 'TC_R' => DS_TREATMENT_CRITERIA based restriction
  cd_mode_p = 'SPL' => Linked to selected few specialities
*/
ds_return_w		PBS_BENF_TYPES.NR_SEQUENCIA%type;
ds_result_w		PBS_PROG_CODE_DESC.DS_PROGRAM%type;


BEGIN

	IF (cd_pbs_p IS NOT NULL AND cd_pbs_p::text <> '' AND cd_mode_p IS NOT NULL AND cd_mode_p::text <> '') THEN
		IF (cd_mode_p = 'TC_R') THEN
			select count(distinct(to_char(pr.DS_TREATMENT_CRITERIA)))
			into STRICT ds_return_w
			from
			PBS_RESTRICTIONS pr,
			PBS_BENF_TYPES pb,
			PBS_BENF_RESTR_MAPPING pbr
			WHERE
			pb.cd_pbs = cd_pbs_p
			and pb.nr_sequencia = pbr.NR_BENFTYPE_REF
			and pr.nr_sequencia = pbr.NR_RESTRICTIONS_REF
			and (DS_TREATMENT_CRITERIA IS NOT NULL AND DS_TREATMENT_CRITERIA::text <> '')
			and pr.IE_SITUACAO = 'A'
			and pb.IE_SITUACAO = 'A'
			and pbr.IE_SITUACAO = 'A';
		ELSIF (cd_mode_p = 'SPL') THEN
			select count(1)
			into STRICT ds_return_w
			from PBS_SPL_RESTRICTIONS
			where
			IE_SITUACAO= 'A' and CD_PBS = cd_pbs_p;
		END IF;
	END IF;

	IF (coalesce(ds_return_w, 0) = 0) THEN
		ds_result_w := 'N';
	ELSE
		ds_result_w := 'S';
	END IF;

RETURN ds_result_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION is_pbs_restricted (cd_pbs_p text, cd_mode_p text) FROM PUBLIC;

