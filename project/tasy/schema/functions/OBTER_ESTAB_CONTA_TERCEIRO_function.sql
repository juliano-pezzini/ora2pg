-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_estab_conta_terceiro ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_area_procedimento_p bigint, cd_especialidade_proc_p bigint, cd_grupo_proc_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, cd_plano_p text, cd_procedencia_p bigint, cd_medico_executor_p text, dt_vigencia_p timestamp, ie_clinica_p bigint, nr_seq_proc_interno_p bigint) RETURNS bigint AS $body$
DECLARE


cd_estab_conta_w			smallint;
cd_plano_w			varchar(10);
ie_pacote_w			varchar(1);
dt_vigencia_w			timestamp;
nr_seq_equipe_w			bigint;

C01 CURSOR FOR
	SELECT cd_estabelecimento_conta
	from	regra_conta_terceiro
	where	cd_estabelecimento					= cd_estabelecimento_p
	and	coalesce(cd_convenio,cd_convenio_p) 			= cd_convenio_p
	and	coalesce(cd_categoria,cd_categoria_p)			= cd_categoria_p
	and	coalesce(ie_tipo_atendimento,ie_tipo_atendimento_p)		= ie_tipo_atendimento_p
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_p)	= cd_setor_atendimento_p
	and	coalesce(cd_area_procedimento,cd_area_procedimento_p)	= cd_area_procedimento_p
	and	coalesce(cd_especialidade_proc,cd_especialidade_proc_p)	= cd_especialidade_proc_p
	and	coalesce(cd_grupo_proc,cd_grupo_proc_p)			= cd_grupo_proc_p
	and	coalesce(cd_procedimento,cd_procedimento_p) 		= cd_procedimento_p
	and	((coalesce(cd_procedimento::text, '') = '') or (coalesce(ie_origem_proced,ie_origem_proced_p) = ie_origem_proced_p))
	and	coalesce(cd_grupo_material,cd_grupo_material_p)		= cd_grupo_material_p
	and	coalesce(cd_subgrupo_material,cd_subgrupo_material_p)	= cd_subgrupo_material_p
	and	coalesce(cd_classe_material,cd_classe_material_p)		= cd_classe_material_p
	and	coalesce(cd_material,cd_material_p)				= cd_material_p
	and	coalesce(cd_plano, cd_plano_w)				= cd_plano_w
	and	coalesce(cd_procedencia,coalesce(cd_procedencia_p,0))		= coalesce(cd_procedencia_p,0)
	and	coalesce(cd_medico_executor, coalesce(cd_medico_executor_p,'0'))	= coalesce(cd_medico_executor_p,'0')
	and	coalesce(nr_seq_equipe, coalesce(nr_seq_equipe_w,0)) = coalesce(nr_seq_equipe_w,0)
	and	((coalesce(ie_pacote,'A') = 'A') or (coalesce(ie_pacote,'A') = coalesce(ie_pacote_w,'A')))
	and	dt_vigencia_w between pkg_date_utils.get_time(coalesce(dt_inicio_vigencia,dt_vigencia_w), 0,0,0) AND (pkg_date_utils.get_time(coalesce(dt_final_vigencia,dt_vigencia_w), 0,0,0) + 86399/86400)
	and	coalesce(ie_clinica, coalesce(ie_clinica_p,0)) 			= coalesce(ie_clinica_p,0)
	and	coalesce(nr_seq_proc_interno, coalesce(nr_seq_proc_interno_p,0))	= coalesce(nr_seq_proc_interno_p,0)
	and	coalesce(ie_situacao, 'A')		= 'A'
	order by
		coalesce(cd_material,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_procedimento,0),
		coalesce(nr_seq_proc_interno,0),
		coalesce(cd_grupo_proc,0),
		coalesce(cd_especialidade_proc,0),
		coalesce(cd_area_procedimento,0),
		coalesce(cd_setor_atendimento,0),
		coalesce(ie_tipo_atendimento,0),
		coalesce(cd_categoria,' '),
		coalesce(cd_convenio,0),
		coalesce(cd_medico_executor,'0'),
		coalesce(nr_seq_equipe, 0),
		coalesce(ie_clinica,0);


BEGIN

cd_estab_conta_w	:= 0;
ie_pacote_w		:= 'A';
dt_vigencia_w		:= coalesce(dt_vigencia_p,clock_timestamp());

select	coalesce(max(cd_plano_p),'0')
into STRICT	cd_plano_w
;

select 	coalesce(max('S'),'N')
into STRICT	ie_pacote_w
from 	pacote
where 	cd_estabelecimento = cd_estabelecimento_p
and 	cd_convenio	   = cd_convenio_p
and 	cd_proced_pacote   = cd_procedimento_p
and 	ie_origem_proced   = ie_origem_proced_p;

select	coalesce(max(a.nr_sequencia),0)
into STRICT	nr_seq_equipe_w
from	pf_equipe_partic b,
	pf_equipe a
where	a.nr_sequencia = b.nr_seq_equipe
and	((a.cd_pessoa_fisica = cd_medico_executor_p) or (b.cd_pessoa_fisica = cd_medico_executor_p));

OPEN C01;
LOOP
FETCH C01 into
		cd_estab_conta_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	cd_estab_conta_w	:= cd_estab_conta_w;
	end;
END LOOP;
CLOSE C01;

RETURN cd_estab_conta_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_estab_conta_terceiro ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_area_procedimento_p bigint, cd_especialidade_proc_p bigint, cd_grupo_proc_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, cd_plano_p text, cd_procedencia_p bigint, cd_medico_executor_p text, dt_vigencia_p timestamp, ie_clinica_p bigint, nr_seq_proc_interno_p bigint) FROM PUBLIC;

