-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pcs_obter_responsavel_politica (nr_seq_grupamento_p bigint, cd_estabelecimento_p bigint, cd_empresa_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ie_considera_w		varchar(1);
cd_responsavel_w	pcs_grupamentos.cd_responsavel%type;

/*
E - Estabelecimento
R - Regional
*/
BEGIN

begin
select	max(d.cd_responsavel) --Quando tiver política Primeira verificar a regra mais restritiva por estabelecimento
into STRICT	cd_responsavel_w
from	pcs_grupamentos a,
	pcs_segmento b,
	pcs_estrutura_segmento c,
	pcs_politicas_grupamento d
where	a.nr_sequencia = b.nr_seq_grupamento
and	a.nr_sequencia = c.nr_seq_grupamento
and	b.nr_sequencia = c.nr_seq_segmento
and	a.nr_sequencia = d.nr_seq_grupamento
and ((d.cd_estab_regra IS NOT NULL AND d.cd_estab_regra::text <> '') and d.cd_estab_regra = cd_estabelecimento_p)
and	(obter_usuario_ativo_pf(d.cd_responsavel) IS NOT NULL AND (obter_usuario_ativo_pf(d.cd_responsavel))::text <> '')
and	a.nr_sequencia = nr_seq_grupamento_p
and	(d.cd_responsavel IS NOT NULL AND d.cd_responsavel::text <> '');
exception
when others then
	cd_responsavel_w := null;
end;

if (coalesce(cd_responsavel_w::text, '') = '') then
	begin
	select	max(d.cd_responsavel) --Quando tiver política Primeira verificar a regra mais restritiva por estabelecimento
	into STRICT	cd_responsavel_w
	from	pcs_grupamentos a,
		pcs_segmento b,
		pcs_estrutura_segmento c,
		pcs_politicas_grupamento d
	where	a.nr_sequencia = b.nr_seq_grupamento
	and	a.nr_sequencia = c.nr_seq_grupamento
	and	b.nr_sequencia = c.nr_seq_segmento
	and	a.nr_sequencia = d.nr_seq_grupamento
	and (coalesce(d.cd_estab_regra::text, '') = '' and (d.nr_seq_regional IS NOT NULL AND d.nr_seq_regional::text <> '') and pcs_obter_se_estab_regional(cd_estabelecimento_p,d.nr_seq_regional) = 'S')
	and	(obter_usuario_ativo_pf(d.cd_responsavel) IS NOT NULL AND (obter_usuario_ativo_pf(d.cd_responsavel))::text <> '')
	and	a.nr_sequencia = nr_seq_grupamento_p
	and	(d.cd_responsavel IS NOT NULL AND d.cd_responsavel::text <> '');
	exception
	when others then
		cd_responsavel_w := null;
	end;

end if;


if (coalesce(cd_responsavel_w::text, '') = '') then
	select	max(a.cd_responsavel) --Quando tiver política Primeira verificar a regra mais restritiva por estabelecimento
	into STRICT	cd_responsavel_w
	from	pcs_grupamentos a
	where	a.nr_sequencia = nr_seq_grupamento_p
	and	cd_empresa = cd_empresa_p;
end if;

return	cd_responsavel_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pcs_obter_responsavel_politica (nr_seq_grupamento_p bigint, cd_estabelecimento_p bigint, cd_empresa_p bigint, nm_usuario_p text) FROM PUBLIC;

