-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_hrs_noturnas_rat (nr_seq_rat_p bigint ) RETURNS bigint AS $body$
DECLARE


nr_hr_w		bigint;
dt_inicio_w	timestamp;
dt_fim_w	timestamp;
dt_ini_alf_w	timestamp;
dt_fim_alf_w	timestamp;
qt_hrs_w	bigint;
hr_ini_w	timestamp;
hr_fim_w	timestamp;
result_w 	bigint;


c01 CURSOR FOR
	SELECT 	   l.dt_inicio_ativ,
		   l.dt_fim_ativ
	FROM       PROJ_RAT_ATIV l,
		   proj_rat g
	WHERE	   g.nr_sequencia = l.nr_seq_rat
	AND	   nr_seq_rat = nr_seq_rat_p
	and	(l.dt_fim_ativ IS NOT NULL AND l.dt_fim_ativ::text <> '')
	order by 1;



BEGIN
result_w:= 0;
open c01;
loop
fetch c01 into	dt_inicio_w,
		dt_fim_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
    begin



	if (dt_inicio_w <= TO_DATE(TO_CHAR(dt_inicio_w, 'dd/mm/yyyy') || ' 22:00:00','dd/mm/yyyy hh24:mi:ss')) and (dt_fim_w >= TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 22:00:00','dd/mm/yyyy hh24:mi:ss')) then

		hr_ini_w := TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 22:00:00','dd/mm/yyyy hh24:mi:ss');
		hr_fim_w     := dt_fim_w;

		result_w:= result_w + substr(obter_hora_entre_datas(hr_ini_w, hr_fim_w),1,5);


	end if;


	if (dt_inicio_w >= TO_DATE(TO_CHAR(dt_inicio_w, 'dd/mm/yyyy') || ' 22:00:00','dd/mm/yyyy hh24:mi:ss')) and (dt_fim_w >= TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 04:59:59','dd/mm/yyyy hh24:mi:ss')) then

		hr_fim_w := TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 04:59:59','dd/mm/yyyy hh24:mi:ss');
		hr_ini_w  := dt_inicio_w;

		result_w:= result_w + substr(obter_hora_entre_datas(hr_ini_w, hr_fim_w),1,5);


	end if;



	if (dt_inicio_w >= TO_DATE(TO_CHAR(dt_inicio_w, 'dd/mm/yyyy') || ' 22:00:00','dd/mm/yyyy hh24:mi:ss')) and (dt_fim_w <= TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 04:59:59','dd/mm/yyyy hh24:mi:ss')) and
		trunc(dt_fim_w) = trunc(dt_inicio_w + 1) then

		hr_fim_w     := dt_fim_w;
		hr_ini_w  := dt_inicio_w;

		result_w:= result_w + substr(obter_hora_entre_datas(hr_ini_w, hr_fim_w),1,5);

	end if;


	if (dt_inicio_w <= TO_DATE(TO_CHAR(dt_inicio_w, 'dd/mm/yyyy') || ' 22:00:00','dd/mm/yyyy hh24:mi:ss')) and (dt_fim_w >= TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 04:59:59','dd/mm/yyyy hh24:mi:ss')) and
		trunc(dt_fim_w) = trunc(dt_inicio_w + 1) then

		hr_fim_w     := TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 04:59:59','dd/mm/yyyy hh24:mi:ss');
		hr_ini_w  := TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 22:00:00','dd/mm/yyyy hh24:mi:ss');


		result_w:= result_w + substr(obter_hora_entre_datas(hr_ini_w, hr_fim_w),1,5);

	end if;


	if (dt_inicio_w <= TO_DATE(TO_CHAR(dt_inicio_w, 'dd/mm/yyyy') || ' 04:59:59','dd/mm/yyyy hh24:mi:ss')) and (dt_fim_w <= TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 04:59:59','dd/mm/yyyy hh24:mi:ss')) then

		hr_fim_w     := dt_fim_w;
		hr_ini_w  := dt_inicio_w;

		result_w:= result_w + substr(obter_hora_entre_datas(hr_ini_w, hr_fim_w),1,5);



	end if;


	if (dt_inicio_w <= TO_DATE(TO_CHAR(dt_inicio_w, 'dd/mm/yyyy') || ' 04:59:59','dd/mm/yyyy hh24:mi:ss')) and (dt_fim_w >= TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 04:59:59','dd/mm/yyyy hh24:mi:ss')) and
		trunc(dt_inicio_w) = trunc(dt_fim_w) then

		hr_fim_w     := TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 04:59:59','dd/mm/yyyy hh24:mi:ss');
		hr_ini_w     := dt_inicio_w;


		result_w:= result_w + substr(obter_hora_entre_datas(hr_ini_w, hr_fim_w),1,5);



	end if;




	if (dt_inicio_w <= TO_DATE(TO_CHAR(dt_inicio_w, 'dd/mm/yyyy') || ' 22:00:00','dd/mm/yyyy hh24:mi:ss')) and (dt_fim_w <= TO_DATE(TO_CHAR(dt_fim_w, 'dd/mm/yyyy') || ' 04:59:59','dd/mm/yyyy hh24:mi:ss')) and
		trunc(dt_inicio_w) < trunc(dt_fim_w) then

		hr_fim_w     := dt_fim_w;
		hr_ini_w     := TO_DATE(TO_CHAR(dt_inicio_w, 'dd/mm/yyyy') || ' 22:00:00','dd/mm/yyyy hh24:mi:ss');


		result_w:= result_w + substr(obter_hora_entre_datas(hr_ini_w, hr_fim_w),1,5);

	end if;



   end;

end loop;
close c01;

	return result_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_hrs_noturnas_rat (nr_seq_rat_p bigint ) FROM PUBLIC;

