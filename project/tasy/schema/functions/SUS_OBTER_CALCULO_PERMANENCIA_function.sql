-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_calculo_permanencia ( nr_aih_p bigint, nr_sequencia_p bigint, ie_opcao_p bigint) RETURNS bigint AS $body$
DECLARE

 
/* IE_OPCAO_P 
	1 - Longa permanencia liquida 
	2 - Qt dias permanencia proced 
*/
 
 
 
qt_retorno_w		bigint;
nr_atendimento_w	bigint;
nr_interno_conta_w	bigint;
qt_diarias_uti_w	bigint	:= 0;
qt_permanencia_w	bigint	:= 0;
qt_diarias_w		bigint	:= 0;
cd_proced_w		bigint	:= 0;
qt_longa_perm_w		bigint	:= 0;
nr_aih_w		bigint	:= 0;

 

BEGIN 
 
/* Obter o atendimento e a conta */
 
begin 
select	nr_atendimento, 
	nr_interno_conta 
into STRICT	nr_atendimento_w, 
	nr_interno_conta_w 
from	sus_aih 
where	nr_aih		= nr_aih_p 
and	nr_sequencia	= nr_sequencia_p;
exception 
	when others then 
		nr_atendimento_w	:= 0;
		nr_interno_conta_w	:= 0;
end;
 
/* Procedimentos de diaria de Uti */
 
begin 
select	coalesce(sum(qt_procedimento),0) 
into STRICT	qt_diarias_uti_w 
from	procedimento_paciente 
where	nr_atendimento		= nr_atendimento_w 
and	nr_interno_conta	= nr_interno_conta_w 
and	ie_origem_Proced	= 2 
and	coalesce(cd_motivo_exc_conta::text, '') = '' 
and	cd_procedimento in (96001020,96001038,96002026,96002034,96003014,96003022, 
					96003030,96004029,96004037,96005025,96005033,96006013, 
					96006030,96800038,96001011,96002018,96004010,96005017, 
					96006021,96800011);
exception 
	when others then 
		qt_diarias_uti_w := 0;
end;
 
SELECT * FROM CALCULAR_LONGA_PERMANENCIA(nr_atendimento_w, nr_interno_conta_w, cd_proced_w, qt_permanencia_w, qt_diarias_w, qt_longa_perm_w, nr_aih_w) INTO STRICT cd_proced_w, qt_permanencia_w, qt_diarias_w, qt_longa_perm_w, nr_aih_w;
 
qt_longa_perm_w	:= qt_permanencia_w - qt_diarias_w - qt_diarias_uti_w;
 
if (ie_opcao_p	= 1) then 
	qt_retorno_w	:= qt_longa_perm_w;
elsif (ie_opcao_p	= 2) then 
	qt_retorno_w	:= qt_permanencia_w;
end if;
 
return	qt_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_calculo_permanencia ( nr_aih_p bigint, nr_sequencia_p bigint, ie_opcao_p bigint) FROM PUBLIC;

