-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_exames_presc_aprov_ficha (nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE

				
ie_exames_aprovados_w	varchar(1) := 'N';				
qt_exames_prescricao_w	bigint;
qt_exames_aprovados_w	bigint;


BEGIN
    select 	count(*)
    into STRICT	qt_exames_prescricao_w
    from	lote_ent_sec_ficha a,
        prescr_procedimento b
    where   a.nr_prescricao = b.nr_prescricao
    and	coalesce(b.ie_exame_bloqueado,'N') = 'N'
    and	coalesce(b.ie_suspenso,'N') = 'N'
    and	(b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '')
    and	b.nr_prescricao = nr_prescricao_p;

    select 	count(*)
    into STRICT	qt_exames_aprovados_w
    from	lote_ent_sec_ficha a,
        prescr_procedimento b
    where   a.nr_prescricao = b.nr_prescricao
    and	coalesce(b.ie_exame_bloqueado,'N') = 'N'
    and	coalesce(b.ie_suspenso,'N') = 'N'
    and	b.nr_prescricao = nr_prescricao_p
    and	(b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '')
    and	b.ie_status_atend >= 35;

    if (qt_exames_prescricao_w > 0) and (qt_exames_aprovados_w = qt_exames_prescricao_w) then
        ie_exames_aprovados_w := 'S';
    end if;

    return	ie_exames_aprovados_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_exames_presc_aprov_ficha (nr_prescricao_p bigint) FROM PUBLIC;

