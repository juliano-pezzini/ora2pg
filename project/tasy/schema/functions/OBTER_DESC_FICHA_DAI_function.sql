-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_ficha_dai ( nr_sequencia_p bigint, ie_opcao_p text, dt_evento_p timestamp default null, dt_nascimento_p timestamp default null, dt_fim_evento_p timestamp default null) RETURNS varchar AS $body$
DECLARE

/* 
Faixa Etária					'E' 
Fator de risco					'F' 
Porcentagem Protocolo Preventivo			'PO' 
Porcentagem Protocolo Terapêutico			'PT' 
Porcentagem Protocolo Preventivo até data de alta	'PA' 
Máxima gravidade					'TG' 
*/
 
			 
dt_atual_w		timestamp;
dt_nascimento_w		timestamp;
qt_anos_w		bigint;
ds_retorno_w		varchar(255);
qt_prescrito_w		bigint;
qt_prescrito_adesao_w	bigint;
ie_porcentagem_w	double precision;
nr_seq_apresent_w	bigint;
	

BEGIN 
 
If (ie_opcao_p = 'E') then 
 
	if (coalesce(dt_evento_p::text, '') = '') then 
		dt_atual_w		:= clock_timestamp();
	else 
		dt_atual_w		:= dt_evento_p;
	end if;
 
	if (coalesce(dt_nascimento_p::text, '') = '') then 
		dt_nascimento_w	:= clock_timestamp();
	else 
		dt_nascimento_w	:= dt_nascimento_p;
	end if;
 
	qt_anos_w	:= trunc((dt_atual_w - dt_nascimento_w)/365);	
	 
	if (qt_anos_w between 0 and 3) then 
		ds_retorno_w := '00 03';
	elsif (qt_anos_w between 4 and 7) then 
		ds_retorno_w := '04 07';
	elsif (qt_anos_w between 8 and 14) then 
		ds_retorno_w := '08 14';
	elsif (qt_anos_w > 14) then 
		ds_retorno_w := 'Maior que 14';
	end if;
 
elsif (ie_opcao_p = 'F') then 
 
	select	max(substr(obter_descricao_item_EIF(nr_seq_item),1,255)) 
	into STRICT 	ds_retorno_w 
	from	escala_eif_item 
	where	nr_seq_item = nr_sequencia_p;	
	 
elsif (ie_opcao_p = 'PO') then 
 
	select 	count(*) 
	into STRICT	qt_prescrito_adesao_w 
	from	pe_prescricao a, 
		gqa_pendencia_pac b, 
		gqa_pendencia_regra c, 
		eif_escala d, 
		escala_eif e, 
		gqa_pend_pac_acao f 
	where	a.nr_atendimento = nr_sequencia_p 
	and	a.nr_seq_pend_pac_acao = f.nr_sequencia 
	and	f.nr_seq_pend_pac = b.nr_sequencia 
	and	b.nr_seq_pend_regra = c.nr_sequencia 
	and	c.nr_seq_score_flex = d.nr_Sequencia 
	and	e.nr_Atendimento = b.nr_atendimento 
	and	d.nr_sequencia = e.nr_seq_escala 
	and	UPPER(d.ds_escala) like UPPER('%dermatite%') 
	and	c.nr_seq_escala = 117 
	and	TRUNC(b.dt_atualizacao_nrec) = TRUNC(dt_evento_p) 
	and	(c.nr_seq_result IS NOT NULL AND c.nr_seq_result::text <> '') 
	and	TRUNC(e.dt_liberacao) = TRUNC(dt_evento_p) 
	and	obter_resultado_escala_eif(e.nr_sequencia,'R') = 'N';
	 
	select 	count(*) 
	into STRICT	qt_prescrito_w 
	from	gqa_pendencia_pac b, 
		gqa_pendencia_regra c, 
		eif_escala d, 
		escala_eif e 
	where	b.nr_atendimento = nr_sequencia_p 
	and	b.nr_seq_pend_regra = c.nr_sequencia 
	and	c.nr_seq_score_flex = d.nr_Sequencia 
	and	e.nr_Atendimento = b.nr_atendimento 
	and	d.nr_sequencia = e.nr_seq_escala 
	and	UPPER(d.ds_escala) like UPPER('%dermatite%') 
	and	c.nr_seq_escala = 117 
	and	TRUNC(b.dt_atualizacao_nrec) = TRUNC(dt_evento_p) 
	and	(c.nr_seq_result IS NOT NULL AND c.nr_seq_result::text <> '') 
	and	TRUNC(e.dt_liberacao) = TRUNC(dt_evento_p) 
	and	obter_resultado_escala_eif(e.nr_sequencia,'R') = 'N';
	 
	ie_porcentagem_w := (Dividir(qt_prescrito_adesao_w,qt_prescrito_w)*100);
	 
	if (ie_porcentagem_w >= 85) then 
		ds_retorno_w := 1;
	else	 
		ds_retorno_w := 0;
	end if;
	 
elsif (ie_opcao_p = 'PT') then 
	 
	select 	count(*) 
	into STRICT	qt_prescrito_adesao_w 
	from	pe_prescricao a, 
		gqa_pendencia_pac b, 
		gqa_pendencia_regra c, 
		eif_escala d, 
		escala_eif e, 
		gqa_pend_pac_acao f, 
		qua_evento_paciente g, 
		qua_evento_dermatite h		 
	where	a.nr_atendimento = nr_sequencia_p 
	and	a.nr_seq_pend_pac_acao = f.nr_sequencia 
	and	f.nr_seq_pend_pac = b.nr_sequencia 
	and	b.nr_seq_pend_regra = c.nr_sequencia 
	and	c.nr_seq_score_flex = d.nr_Sequencia 
	and	e.nr_Atendimento = b.nr_atendimento 
	and	g.nr_atendimento = a.nr_Atendimento 
	and	h.nr_seq_evento = g.nr_sequencia 
	and	h.ie_origem_dermatite = 'U'	 
	and	trunc(g.dt_evento) = TRUNC(dt_evento_p) 
	and	d.nr_sequencia = e.nr_seq_escala 
	and	UPPER(d.ds_escala) like UPPER('%dermatite%') 
	and	c.nr_seq_escala = 117 
	and	TRUNC(b.dt_atualizacao_nrec) = TRUNC(dt_evento_p) 
	and	(c.nr_seq_result IS NOT NULL AND c.nr_seq_result::text <> '') 
	and	TRUNC(e.dt_liberacao) = TRUNC(dt_evento_p) 
	and	obter_resultado_escala_eif(e.nr_sequencia,'R') = 'S';
	 
	select 	count(*) 
	into STRICT	qt_prescrito_w 
	from	gqa_pendencia_pac b, 
		gqa_pendencia_regra c, 
		eif_escala d, 
		escala_eif e, 
		qua_evento_paciente g, 
		qua_evento_dermatite h 
	where	b.nr_atendimento = nr_sequencia_p 
	and	b.nr_seq_pend_regra = c.nr_sequencia 
	and	c.nr_seq_score_flex = d.nr_Sequencia 
	and	e.nr_Atendimento = b.nr_atendimento 
	and	d.nr_sequencia = e.nr_seq_escala 
	and	g.nr_atendimento = b.nr_Atendimento 
	and	h.nr_seq_evento = g.nr_sequencia 
	and	h.ie_origem_dermatite = 'U'	 
	and	trunc(g.dt_evento) = TRUNC(dt_evento_p) 
	and	UPPER(d.ds_escala) like UPPER('%dermatite%') 
	and	c.nr_seq_escala = 117 
	and	TRUNC(b.dt_atualizacao_nrec) = TRUNC(dt_evento_p) 
	and	(c.nr_seq_result IS NOT NULL AND c.nr_seq_result::text <> '') 
	and	TRUNC(e.dt_liberacao) = TRUNC(dt_evento_p) 
	and	obter_resultado_escala_eif(e.nr_sequencia,'R') = 'S';
	 
	ie_porcentagem_w := (Dividir(qt_prescrito_adesao_w,qt_prescrito_w)*100);
	 
	if (ie_porcentagem_w >= 85) then 
		ds_retorno_w := 1;
	else	 
		ds_retorno_w := 0;
	end if;
	 
elsif (ie_opcao_p = 'PA') then 
 
	select 	count(*) 
	into STRICT	qt_prescrito_adesao_w 
	from	pe_prescricao a, 
		gqa_pendencia_pac b, 
		gqa_pendencia_regra c, 
		eif_escala d, 
		escala_eif e, 
		gqa_pend_pac_acao f 
	where	a.nr_atendimento = nr_sequencia_p 
	and	a.nr_seq_pend_pac_acao = f.nr_sequencia 
	and	f.nr_seq_pend_pac = b.nr_sequencia 
	and	b.nr_seq_pend_regra = c.nr_sequencia 
	and	c.nr_seq_score_flex = d.nr_Sequencia 
	and	e.nr_Atendimento = b.nr_atendimento 
	and	d.nr_sequencia = e.nr_seq_escala 
	and	UPPER(d.ds_escala) like UPPER('%dermatite%') 
	and	c.nr_seq_escala = 117 
	and	TRUNC(b.dt_atualizacao_nrec) = TRUNC(dt_evento_p) 
	and	(c.nr_seq_result IS NOT NULL AND c.nr_seq_result::text <> '') 
	and	TRUNC(e.dt_liberacao) = TRUNC(dt_evento_p) 
	and	obter_resultado_escala_eif(e.nr_sequencia,'R') = 'N' 
	and	not exists ( 	SELECT 	1 
				from	resumo_atendimento_paciente_v x, 
					qua_evento_paciente y, 
					qua_evento_dermatite z	 
				where	x.nr_atendimento = y.nr_atendimento 
				and	y.nr_atendimento = b.nr_atendimento 
				and	z.nr_seq_evento = y.nr_sequencia 
				and	trunc(y.dt_evento) <= trunc(coalesce(x.dt_alta,clock_timestamp())));
	 
	select 	count(*) 
	into STRICT	qt_prescrito_w 
	from	gqa_pendencia_pac b, 
		gqa_pendencia_regra c, 
		eif_escala d, 
		escala_eif e 
	where	b.nr_atendimento = nr_sequencia_p 
	and	b.nr_seq_pend_regra = c.nr_sequencia 
	and	c.nr_seq_score_flex = d.nr_Sequencia 
	and	e.nr_Atendimento = b.nr_atendimento 
	and	d.nr_sequencia = e.nr_seq_escala 
	and	UPPER(d.ds_escala) like UPPER('%dermatite%') 
	and	c.nr_seq_escala = 117 
	and	TRUNC(b.dt_atualizacao_nrec) = TRUNC(dt_evento_p) 
	and	(c.nr_seq_result IS NOT NULL AND c.nr_seq_result::text <> '') 
	and	TRUNC(e.dt_liberacao) = TRUNC(dt_evento_p) 
	and	obter_resultado_escala_eif(e.nr_sequencia,'R') = 'N' 
	and	not exists ( 	SELECT 	1 
				from	resumo_atendimento_paciente_v x, 
					qua_evento_paciente y, 
					qua_evento_dermatite z	 
				where	x.nr_atendimento = y.nr_atendimento 
				and	y.nr_atendimento = b.nr_atendimento 
				and	z.nr_seq_evento = y.nr_sequencia 
				and	trunc(y.dt_evento) <= trunc(coalesce(x.dt_alta,clock_timestamp())));
	 
	ie_porcentagem_w := (Dividir(qt_prescrito_adesao_w,qt_prescrito_w)*100);
	 
	if (ie_porcentagem_w >= 85) then 
		ds_retorno_w := 1;
	else	 
		ds_retorno_w := 0;
	end if;
 
elsif (ie_opcao_p = 'TG') then 
 
	Select 	max(nr_seq_apresent)	 
	into STRICT	nr_seq_apresent_w 
	from	qua_evento_paciente b, 
		qua_tipo_evento d, 
		qua_evento f, 
		qua_evento_dermatite a, 
		VALOR_DOMINIO c 
	where	coalesce(b.dt_inativacao::text, '') = '' 
	and	c.cd_dominio	= 4918 
	and	a.ie_gravidade = c.vl_dominio 
	and	a.nr_seq_evento = b.nr_sequencia 
	and	d.ie_tipo_evento = 'DAI' 
	and	d.nr_sequencia = f.nr_Seq_tipo 
	and	b.nr_Seq_evento = f.nr_sequencia 
	and	a.ie_origem_dermatite = 'U' 
	and	b.nr_atendimento = nr_sequencia_p 
	and	trunc(b.dt_Evento) between trunc(dt_evento_p) and coalesce(dt_fim_evento_p,dt_evento_p);
 
	Select 	vl_dominio 
	into STRICT	ds_retorno_w 
	from 	valor_dominio 
	where 	cd_dominio	= 4918 
	and	nr_seq_apresent = coalesce(nr_seq_apresent_w,1);
	 
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_ficha_dai ( nr_sequencia_p bigint, ie_opcao_p text, dt_evento_p timestamp default null, dt_nascimento_p timestamp default null, dt_fim_evento_p timestamp default null) FROM PUBLIC;

