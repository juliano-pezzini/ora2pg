-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION live_virus_contraindications ( array_in text ) RETURNS varchar AS $body$
DECLARE

  ds_vacina_w               varchar(80)   :=NULL;
  ds_vacina_contradiction_w varchar(2000) := NULL;
  ds_contraindications_w    varchar(2000) :=NULL;
  C02 CURSOR FOR
    SELECT ds_vacina,
      DS_CONTRADICTIONS
    FROM vacina
    WHERE IE_CONTRAINDICATIONS = 'S'
    AND ds_vacina IN (WITH RECURSIVE cte AS (
SELECT regexp_substr(array_in,'[^,]+', 1, level)

        (regexp_substr(array_in, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(array_in, '[^,]+', 1, level))::text <> '')
        UNION ALL
SELECT regexp_substr(array_in,'[^,]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
);

BEGIN
  OPEN C02;
  LOOP
    FETCH C02 INTO ds_vacina_w,ds_contraindications_w;
    EXIT WHEN NOT FOUND; /* apply on C02 */
    BEGIN
      IF (ds_contraindications_w IS NOT NULL AND ds_contraindications_w::text <> '') THEN
        ds_vacina_w             := upper(ds_vacina_w) || chr(13) || chr(36);
        ds_vacina_w               := ds_vacina_w || chr(10);
        ds_contraindications_w    := ds_vacina_w ||ds_contraindications_w || chr(13) || chr(10)||chr(36);
        ds_vacina_contradiction_w := ds_vacina_contradiction_w || ds_contraindications_w;
      END IF;
    END;
  END LOOP;
CLOSE C02;
RETURN(ds_vacina_contradiction_w);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION live_virus_contraindications ( array_in text ) FROM PUBLIC;

