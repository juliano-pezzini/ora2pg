-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_serv_zona_cinza (nr_seq_servico_p bigint, nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE

 
cd_setor_atendimento_w		integer;
ds_horario_w			varchar(5);
dt_horario_w			timestamp;
dt_inicio_prescr_w		timestamp;
dt_validade_prescr_w		timestamp;
nr_horas_validade_w		integer;
dt_fim_zona_cinza_w		timestamp;
ie_zona_cinza_w			varchar(1)	:= 'N';

c01 CURSOR FOR 
SELECT	distinct substr(ds_horarios,1,5) 
from	nut_servico_horario 
where	nr_seq_servico = nr_seq_servico_p 
and	(ds_horarios IS NOT NULL AND ds_horarios::text <> '') 
and	((cd_setor_atendimento = cd_setor_atendimento_w) or (coalesce(cd_setor_atendimento::text, '') = ''));
					

BEGIN 
 
select	coalesce(max(cd_setor_atendimento),max(obter_setor_atendimento(nr_atendimento))), 
	max(nr_horas_validade), 
	max(dt_inicio_prescr), 
	max(dt_validade_prescr) 
into STRICT	cd_setor_atendimento_w, 
	nr_horas_validade_w, 
	dt_inicio_prescr_w, 
	dt_validade_prescr_w 
from	prescr_medica 
where	nr_prescricao = nr_prescricao_p;
 
if (nr_horas_validade_w	> 24) then 
 
	dt_fim_zona_cinza_w	:= (dt_validade_prescr_w - 1);
 
	open C01;
	loop 
	fetch C01 into	 
		ds_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
 
		dt_horario_w	:= to_date(to_char(dt_inicio_prescr_w,'dd/mm/yyyy')||' '||ds_horario_w||':00','dd/mm/yyyy hh24:mi:ss');
		 
		if (dt_inicio_prescr_w	> dt_horario_w) then 
			dt_horario_w := dt_horario_w + 1;
		end if;
		 
		if (dt_horario_w	between dt_inicio_prescr_w and dt_fim_zona_cinza_w) then 
			ie_zona_cinza_w	:= 'S';
			exit;		
		end if;
		end;
	end loop;
	close C01;
	 
end if;
 
return	ie_zona_cinza_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_serv_zona_cinza (nr_seq_servico_p bigint, nr_prescricao_p bigint) FROM PUBLIC;

