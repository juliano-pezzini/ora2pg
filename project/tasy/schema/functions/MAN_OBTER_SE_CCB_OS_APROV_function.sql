-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_se_ccb_os_aprov ( nr_seq_ordem_serv_p bigint, ie_analise_impacto_p text default 'N', nm_usuario_p text default null) RETURNS varchar AS $body$
DECLARE


nr_seq_ordem_serv_w	man_ordem_serv_impacto.nr_seq_ordem_serv%type;
nr_seq_os_ccb_w		man_ordem_servico.nr_sequencia%type;

ie_cbb_aprovado_w	varchar(1);
ie_os_vinc_proj_w	varchar(1);
ie_os_filha_w		varchar(1);
ie_origem_w		varchar(1);
nr_seq_projeto_w	bigint;
qt_horas_w		smallint;
qt_horas_atual_w	smallint;
qt_hora_limite_inf_w	smallint := 8;
dt_liberacao_w		timestamp;
dt_referencia_w		timestamp := clock_timestamp();


BEGIN

ie_os_vinc_proj_w	:= obter_se_ordem_vinc_projeto(nr_seq_ordem_serv_p, '3');
ie_os_filha_w		:= man_obter_se_ordem_serv_filha(nr_seq_ordem_serv_p);

select	max(man_obter_os_ccb(nr_seq_ordem_serv_p))
into STRICT	nr_seq_os_ccb_w
;

if (ie_os_vinc_proj_w = 'S') then
	nr_seq_projeto_w := proj_obter_projeto_ordem_serv(nr_seq_ordem_serv_p);

	select	ie_origem
	into STRICT	ie_origem_w
	from	proj_projeto
	where	nr_sequencia = nr_seq_projeto_w;

	if (ie_origem_w = 'D') then
		nr_seq_ordem_serv_w := proj_obter_dados_projeto(nr_seq_projeto_w, 'OS');
	else
		nr_seq_ordem_serv_w := nr_seq_ordem_serv_p;
	end if;
elsif (ie_os_filha_w = 'S')	then
	select coalesce(man_obter_ordem_serv_pai(nr_seq_ordem_serv_p), nr_seq_ordem_serv_p)
	into STRICT nr_seq_ordem_serv_w
	;
elsif (nr_seq_os_ccb_w IS NOT NULL AND nr_seq_os_ccb_w::text <> '') then
	begin
		nr_seq_ordem_serv_w := nr_seq_os_ccb_w;
	end;
else
	nr_seq_ordem_serv_w := nr_seq_ordem_serv_p;
end if;

select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
into STRICT	ie_cbb_aprovado_w
from	man_ordem_serv_impacto imp
where	imp.nr_seq_ordem_serv = nr_seq_ordem_serv_w
and	(imp.dt_liberacao IS NOT NULL AND imp.dt_liberacao::text <> '')
and	not exists (	SELECT	1
			from	man_ordem_serv_aprov_ccb ccb
			where	ccb.nr_seq_impacto = imp.nr_sequencia
			and	ccb.ie_status in ('P', 'R')
		);

if (ie_cbb_aprovado_w = 'N') then

	select	max(dt_liberacao)
	into STRICT	dt_liberacao_w
	from	man_ordem_serv_tecnico
	where	nr_seq_ordem_serv = nr_seq_ordem_serv_p -- Considerar a OS corrente para historicos de urgencias de CCB em vez da OS do projeto
	and	nr_seq_tipo = 190; -- Excecao do CCB para urgencias fora do horario comercial
	if (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') then

		if (user = 'CORP') and (wheb_usuario_pck.get_cd_estabelecimento = 61) then -- Philips Bangalore
			qt_hora_limite_inf_w := 9;

			if (obter_se_horario_verao(dt_referencia_w) = 'S') then
				dt_liberacao_w := dt_liberacao_w + 7.50/24;
				dt_referencia_w := dt_referencia_w + 7.50/24;
			else
				dt_liberacao_w := dt_liberacao_w + 8.50/24;
				dt_referencia_w := dt_referencia_w + 8.50/24;
			end if;
		end if;

		if (trunc(dt_liberacao_w) = trunc(dt_referencia_w)) then

			qt_horas_w := (to_char(dt_liberacao_w, 'hh24'))::numeric;
			qt_horas_atual_w := (to_char(dt_referencia_w, 'hh24'))::numeric;

			if 	(qt_horas_w < qt_hora_limite_inf_w AND qt_horas_atual_w < qt_hora_limite_inf_w) or
				(qt_horas_w >= 18 AND qt_horas_atual_w >= 18) then
				ie_cbb_aprovado_w := 'S';
			end if;
		end if;
	end if;
end if;


if (ie_analise_impacto_p <> 'N') then
	begin
		if (Obter_Alteracao_Requisito_OS(nr_seq_ordem_serv_p) > 0) then	
			ie_cbb_aprovado_w := 'N';
		end if;
	end;
end if;

if (phi_check_internal_feature(nr_seq_ordem_serv_p, nm_usuario_p) > 0) then
	return 'S';
end if;

return ie_cbb_aprovado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_se_ccb_os_aprov ( nr_seq_ordem_serv_p bigint, ie_analise_impacto_p text default 'N', nm_usuario_p text default null) FROM PUBLIC;

