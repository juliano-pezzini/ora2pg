-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_horario_prescr (nr_atendimento_p bigint, ie_tipo_item_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint, dt_horario_p timestamp, nr_prescricoes_p text) RETURNS varchar AS $body$
DECLARE

 
ds_informacao_w		varchar(4000);
nr_prescricao_w		bigint;
nr_seq_item_w		bigint;
dt_prescricao_w		varchar(20);
dt_prim_horario_w	varchar(20);
nr_horas_validade_w	integer;
nm_prescritor_w		varchar(60);
nm_responsavel_w	varchar(60);
ds_solucao_w		varchar(240);
ds_item_w			varchar(240);
ds_observacao_w		varchar(4000);
ds_associados_w		varchar(255) := null;


BEGIN 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') then 
	/* obter prescrição */
 
	if (coalesce(nr_prescricao_p,0) > 0) then 
		nr_prescricao_w	:= nr_prescricao_p;
		nr_seq_item_w	:= nr_seq_item_p;
	else 
		select	obter_prescricao_horario(nr_seq_horario_p, ie_tipo_item_p, 'P') nr_prescricao, 
			obter_prescricao_horario(nr_seq_horario_p, ie_tipo_item_p, 'I') nr_seq_item 
		into STRICT	nr_prescricao_w, 
			nr_seq_item_w 
		;
	end if;
 
	/* obter informações x prescrição conforme tipo item */
 
	if (ie_tipo_item_p <> 'E') then 
		select	to_char(dt_prescricao,'dd/mm/yyyy hh24:mi'), 
			to_char(dt_prescricao,'dd/mm/yyyy') || ' ' || to_char(dt_primeiro_horario,'hh24:mi'), 
			nr_horas_validade, 
			substr(obter_nome_pf(cd_prescritor),1,60) 
		into STRICT	dt_prescricao_w, 
			dt_prim_horario_w, 
			nr_horas_validade_w, 
			nm_prescritor_w 
		from	prescr_medica 
		where	nr_prescricao = nr_prescricao_w;
 
		/* obter reconstituição x diluição */
 
		select	substr(obter_diluicao_medic(nr_seq_item_w, nr_prescricao_w),1,240) 
		into STRICT	ds_solucao_w 
		;	
	else 
		select	to_char(dt_prescricao,'dd/mm/yyyy hh24:mi'), 
			to_char(dt_prescricao,'dd/mm/yyyy hh24:mi'), 
			24, 
			substr(obter_nome_pf(cd_prescritor),1,60) 
		into STRICT	dt_prescricao_w, 
			dt_prim_horario_w, 
			nr_horas_validade_w, 
			nm_prescritor_w 
		from	pe_prescricao 
		where	nr_sequencia = nr_prescricao_w;
	end if;
 
	/* obter informações x atendimento */
 
	select	substr(coalesce(obter_resp_atend_data(nr_atendimento_p, dt_horario_p), obter_desc_expressao(327119)/*'Não informado'*/
),1,60) 
	into STRICT	nm_responsavel_w 
	;
 
	/* obter nome item conforme tipo */
 
	if (ie_tipo_item_p = 'M') then 
		select	substr(obter_desc_material(cd_material),1,100) ds_item 
		into STRICT	ds_item_w 
		from	prescr_material 
		where	nr_prescricao = nr_prescricao_w 
		and	nr_sequencia = nr_seq_item_w;
	elsif (ie_tipo_item_p = 'P') then 
		select	substr(obter_desc_prescr_proc(cd_procedimento, ie_origem_proced, nr_seq_proc_interno),1,240) ds_item 
		into STRICT	ds_item_w 
		from	prescr_procedimento 
		where	nr_prescricao = nr_prescricao_w 
		and	nr_sequencia = nr_seq_item_w;
 
		select	substr(obter_mat_med_assoc_proc(nr_prescricao_w,nr_seq_item_w, 'S'),1,240) 
		into STRICT	ds_associados_w 
		;
 
	elsif (ie_tipo_item_p = 'R') then 
		select	substr(obter_rec_prescricao(nr_sequencia, nr_prescricao),1,240) ds_item 
		into STRICT	ds_item_w 
		from	prescr_recomendacao 
		where	nr_prescricao = nr_prescricao_w 
		and	nr_sequencia = nr_seq_item_w;
	elsif (ie_tipo_item_p = 'E') then 
		select	substr(obter_desc_intervencoes(nr_seq_proc),1,240) ds_item 
		into STRICT	ds_item_w 
		from	pe_prescr_proc 
		where	nr_seq_prescr = nr_prescricao_w 
		and	nr_sequencia = nr_seq_item_w;
	end if;
 
	/* obter observação item */
 
	select	obter_observacao_item_prescr(ie_tipo_item_p, nr_prescricao_w, nr_seq_item_w) 
	into STRICT	ds_observacao_w 
	;
 
	/* montar mensagem informações */
 
	if (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') then 
		ds_informacao_w :=	ds_item_w || chr(13) || chr(13) || chr(10) || 
					obter_desc_expressao(291428)||': ' || to_char(dt_horario_p,'dd/mm/yyyy hh24:mi') || CHR(13) || CHR(13) || CHR(10) || 
					obter_desc_expressao(325814)/*'Prescrição: '*/
 || nr_prescricao_w 	|| CHR(10) || 
					obter_desc_expressao(327202)/*'Data'*/
|| dt_prescricao_w 		|| CHR(10) || 
					obter_desc_expressao(648277)/*'Início: '*/
 || dt_prim_horario_w		|| CHR(10) || 
					obter_desc_expressao(296217)/*'Prescitor'*/
||': ' || nm_prescritor_w 	|| CHR(10) || 
					obter_desc_expressao(330022)/*'Responsável: '*/
 || nm_responsavel_w	|| CHR(10);
	else 
		ds_informacao_w :=	ds_item_w || chr(13) || chr(13) || chr(10) || 
					obter_desc_expressao(325814)/*'Prescrição: '*/
 || nr_prescricao_w 	|| CHR(10) || 
					obter_desc_expressao(327202)/*'Data'*/
|| dt_prescricao_w 		|| CHR(10) || 
					obter_desc_expressao(648277)/*'Início: '*/
 || dt_prim_horario_w		|| CHR(10) || 
					obter_desc_expressao(296217)/*'Prescitor'*/
||': ' || nm_prescritor_w 	|| CHR(10);
	end if;
		 
 
	/* gerar reconstituição x diluição */
 
	if (ds_solucao_w IS NOT NULL AND ds_solucao_w::text <> '') then 
		ds_informacao_w := ds_informacao_w || CHR(10) || obter_desc_expressao(297355)/*'Reconst/diluição: '*/
 ||': '|| ds_solucao_w || chr(10);
	end if;
 
	/* gerar associados */
 
	if (ds_associados_w IS NOT NULL AND ds_associados_w::text <> '') then 
		ds_informacao_w := ds_informacao_w || chr(10) || 'MatMed associados:' || chr(10) || ds_associados_w || chr(10);
	end if;
 
	/* gerar observação */
 
	if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then 
		ds_informacao_w := ds_informacao_w || CHR(10) || obter_desc_expressao(329252)/*'Observação: '*/
 || ds_observacao_w || chr(10);
	end if;
 
	/* gerar prescrições mmensagem */
 
	ds_informacao_w := ds_informacao_w || chr(10) || obter_desc_expressao(323185)/*'Prescrições relacionadas: '*/
 || chr(10) || '- ' || nr_prescricoes_p;
end if;
 
return ds_informacao_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_horario_prescr (nr_atendimento_p bigint, ie_tipo_item_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint, dt_horario_p timestamp, nr_prescricoes_p text) FROM PUBLIC;

