-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_material_reval (nr_seq_lote_p bigint, cd_material_p bigint) RETURNS varchar AS $body$
DECLARE


cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_setor_atendimento_w		setor_atendimento.cd_setor_atendimento%type;
cd_perfil_w					perfil.cd_perfil%type;
nm_usuario_w				usuario.nm_usuario%type;
dt_validacao_w				cpoe_revalidation_events.dt_validacao%type;
ds_retorno_w				varchar(4000);
ie_valida_regra_w			varchar(1);
nr_seq_mat_hor_w    prescr_mat_hor.nr_sequencia%type;
dt_horario_w    prescr_mat_hor.dt_horario%type;
nr_seq_mat_cpoe_w   prescr_material.nr_seq_mat_cpoe%type;
nm_material_w   material.ds_material%type;


BEGIN

ds_retorno_w := '';
cd_setor_atendimento_w := wheb_usuario_pck.get_cd_setor_atendimento;
cd_perfil_w := wheb_usuario_pck.get_cd_perfil;
nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

select	coalesce(max('S'),'N') ie_valida_regra
into STRICT	ie_valida_regra_w
from	cpoe_revalidation_rule a
where	coalesce(a.ie_situacao, 'A') = 'A'
and 	((coalesce(a.cd_setor_atendimento::text, '') = '') or (a.cd_setor_atendimento = cd_setor_atendimento_w))
and		((coalesce(a.cd_perfil::text, '') = '') or (a.cd_perfil = cd_perfil_w))
and		((coalesce(a.nm_usuario_regra::text, '') = '') or (a.nm_usuario_regra = nm_usuario_w))
and     ((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_w))
and atePacLP_se_dupla_reval(a.NR_SEQUENCIA, cd_material_p) = 'S';

if (ie_valida_regra_w = 'S') then


  select max(NR_SEQUENCIA)
  into STRICT nr_seq_mat_hor_w
  from prescr_mat_hor 
  where NR_SEQ_LOTE = nr_seq_lote_p
  and CD_MATERIAL = cd_material_p;

  if (nr_seq_mat_hor_w IS NOT NULL AND nr_seq_mat_hor_w::text <> '') then
    select	a.dt_horario dt_horario,
      b.nr_seq_mat_cpoe nr_seq_mat_cpoe,
      obter_desc_material(a.cd_material) nm_material
    into STRICT dt_horario_w,
      nr_seq_mat_cpoe_w,
      nm_material_w
    from	prescr_mat_hor a,
        prescr_material b
    where	a.nr_prescricao = b.nr_prescricao
    and		a.nr_seq_material = b.nr_sequencia
    and		a.NR_SEQUENCIA = nr_seq_mat_hor_w
    and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';

    select	max(a.dt_validacao)
    into STRICT	dt_validacao_w
    from	cpoe_revalidation_events a
    where	a.nr_seq_material = nr_seq_mat_cpoe_w;

    if ((dt_validacao_w IS NOT NULL AND dt_validacao_w::text <> '') and
      dt_horario_w > dt_validacao_w) then
        ds_retorno_w := substr(obter_desc_expressao(963816, '') || chr(10) ||
					nm_material_w || chr(10) || obter_desc_expressao(963818, ''),1,2000);
    end if;
  end if;

end if;


return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_material_reval (nr_seq_lote_p bigint, cd_material_p bigint) FROM PUBLIC;

