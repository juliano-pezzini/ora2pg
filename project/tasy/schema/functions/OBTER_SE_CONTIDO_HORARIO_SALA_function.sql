-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_contido_horario_sala (nr_sequencia_p agenda_paciente.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


cd_agenda_w                 agenda_paciente.cd_agenda%type;
dt_dia_semana_w             agenda_horario.dt_dia_semana%type;
nr_seq_regra_dia_w          agenda_horario.nr_sequencia%type;
nr_seq_regra_dia_util_w     agenda_horario.nr_sequencia%type;
nr_seq_regra_final_w        agenda_horario.nr_sequencia%type;
ie_dia_trabalho_w           varchar(2);
hora_inicio_agendamento_w   timestamp;
hora_final_agenda_w         timestamp;
mascara_horas_w             varchar(60);
nr_duracao_agendamento_w    agenda_paciente.nr_minuto_duracao%TYPE;
nr_duracao_agenda_w         agenda_horario.nr_minuto_intervalo%TYPE;
hora_fim_agendamento_w      timestamp;
hr_fim_agenda_duracao_w     timestamp;


BEGIN
mascara_horas_w     := 'hh24:mi:ss';

-- Dados da agenda
select  to_date(to_char(trunc(hr_inicio,'mi'), mascara_horas_w), mascara_horas_w),
        cd_agenda,
        pkg_date_utils.get_WeekDay(dt_agenda),
        nr_minuto_duracao,
        to_date(to_char(trunc(hr_inicio, 'mi') + (nr_minuto_duracao / (24 * 60)), 'hh24:mi:ss'), 'hh24:mi:ss') hr_fim
into STRICT    hora_inicio_agendamento_w,
        cd_agenda_w,
        dt_dia_semana_w,
        nr_duracao_agendamento_w,
        hora_fim_agendamento_w
from    agenda_paciente
where   nr_sequencia = nr_sequencia_p;

ie_dia_trabalho_w   := obter_se_dia_trabalho(dt_dia_semana_w);

-- Verifica se tem regra para o dia especifico
select  max(nr_sequencia)
into STRICT    nr_seq_regra_dia_w
from    agenda_horario
where   cd_agenda = cd_agenda_w
and     dt_dia_semana = dt_dia_semana_w
and     coalesce(nr_seq_schedule_cycle::text, '') = '';

-- Verifica se tem regra pra dias uteis
select  max(nr_sequencia)
into STRICT    nr_seq_regra_dia_util_w
from    agenda_horario
where   cd_agenda = cd_agenda_w
and     dt_dia_semana = 9
and     coalesce(nr_seq_schedule_cycle::text, '') = '';

if (nr_seq_regra_dia_w IS NOT NULL AND nr_seq_regra_dia_w::text <> '') then
    nr_seq_regra_final_w := nr_seq_regra_dia_w;
elsif (ie_dia_trabalho_w = 'S' and (nr_seq_regra_dia_util_w IS NOT NULL AND nr_seq_regra_dia_util_w::text <> '')) then
    nr_seq_regra_final_w := nr_seq_regra_dia_util_w;
end if;

-- Verifica se dentro da regra do dia especifico
if (nr_seq_regra_final_w IS NOT NULL AND nr_seq_regra_final_w::text <> '') then
    select  to_date(to_char(trunc(hr_final,'mi'), mascara_horas_w), mascara_horas_w),
            nr_minuto_intervalo,
            to_date(to_char(trunc(hr_final, 'mi') + (nr_minuto_intervalo / (24 * 60)), 'hh24:mi:ss'), 'hh24:mi:ss') hora_final_duracao
    into STRICT    hora_final_agenda_w,
            nr_duracao_agenda_w,
            hr_fim_agenda_duracao_w
    from    agenda_horario
    where   nr_sequencia = nr_seq_regra_final_w;

    if (hora_inicio_agendamento_w > hora_final_agenda_w)then
        return 'N';
    elsif (hora_inicio_agendamento_w = hora_final_agenda_w) then
        if (hora_fim_agendamento_w > hr_fim_agenda_duracao_w) then
            return 'N';
        end if;
    elsif (hora_fim_agendamento_w > hora_final_agenda_w)then
        return 'N';
    end if;
end if;

return 'S';

exception when others then
return 'E';

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_contido_horario_sala (nr_sequencia_p agenda_paciente.nr_sequencia%type) FROM PUBLIC;

