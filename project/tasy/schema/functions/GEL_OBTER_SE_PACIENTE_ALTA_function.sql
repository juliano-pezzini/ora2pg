-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gel_obter_se_paciente_alta (cd_pessoa_fisica_p text, nr_prescricao_p bigint, cd_envelope_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w	varchar(255) := 'N';
qnt_registros_w integer := 0;
nr_atend_prescr_w integer := 0;
nr_atend_env_w integer := 0;


BEGIN 
	IF (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') OR (cd_envelope_p <> 0) OR (nr_prescricao_p <> 0) THEN 
 
 
    IF (nr_prescricao_p <> 0) THEN 
      SELECT MAX(coalesce(nr_atendimento,0)) 
 	    INTO STRICT  nr_atend_prescr_w 
	    FROM  prescr_medica 
      WHERE nr_prescricao = nr_prescricao_p;
    END IF;
 
    IF (cd_envelope_p <> 0) THEN 
	    SELECT MAX(coalesce(nr_atendimento,0)) 
	    INTO STRICT	nr_atend_env_w 
	    FROM	malote_envelope_item a, 
		      envelope_laudo_item b, 
			    prescr_procedimento c, 
			    prescr_medica d 
	    WHERE	b.nr_seq_envelope	= a.nr_seq_envelope 
	    AND	  b.nr_prescricao 	= c.nr_prescricao 
	    AND	  b.nr_seq_prescr 	= c.nr_sequencia 
	    AND	  c.nr_prescricao 	= d.nr_prescricao 
	    AND	  b.nr_seq_envelope 	= cd_envelope_p;
	  END IF;
 
		SELECT COUNT(*) 
	  INTO STRICT qnt_registros_w 
	  FROM atendimento_paciente 
	  WHERE cd_pessoa_fisica = CASE WHEN cd_pessoa_fisica_p='' THEN cd_pessoa_fisica  ELSE cd_pessoa_fisica_p END  
	  AND  nr_atendimento = CASE WHEN nr_atend_prescr_w=0 THEN nr_atendimento  ELSE nr_atend_prescr_w END  
	  AND  nr_atendimento = CASE WHEN nr_atend_env_w=0 THEN nr_atendimento  ELSE nr_atend_env_w END  
 	  AND  coalesce(dt_alta::text, '') = '';
 
	  IF (qnt_registros_w > 0) THEN 
      ds_retorno_w := 'N';
	  ELSE 
	    ds_retorno_w := Wheb_mensagem_pck.get_texto(308443); --'Paciente est√° em alta'; 
	  END IF;
	END IF;
 
RETURN	ds_retorno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gel_obter_se_paciente_alta (cd_pessoa_fisica_p text, nr_prescricao_p bigint, cd_envelope_p bigint) FROM PUBLIC;

