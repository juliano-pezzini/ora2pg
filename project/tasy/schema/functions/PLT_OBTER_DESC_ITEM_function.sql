-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION plt_obter_desc_item ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

/*
ie_opcao_p
---------------
I - Item
T - Tipo
*/
ds_item_w		varchar(255) := '';
ds_tipo_w		varchar(255) := '';


BEGIN

if (ie_tipo_item_p = 'J') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309541); -- Jejum
	select	max(substr(b.ds_tipo,1,255))
	into STRICT	ds_item_w
	from	rep_tipo_jejum b,
		rep_jejum a
	where	a.nr_seq_tipo	= b.nr_sequencia
	and	a.nr_prescricao	= nr_prescricao_p
	and	a.nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p = 'D') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309809); -- Dieta oral
	select	max(substr(b.nm_dieta,1,255))
	into STRICT	ds_item_w
	from	dieta b,
		prescr_dieta a
	where	a.cd_dieta	= b.cd_dieta
	and	a.nr_prescricao	= nr_prescricao_p
	and	a.nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p = 'S') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(308914); -- Suplemento oral
elsif (ie_tipo_item_p = 'SOL') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(308555); -- Solução
	select	max(substr(coalesce(ds_solucao,obter_prim_comp_sol(nr_prescricao,nr_seq_solucao)),1,255))
	into STRICT	ds_item_w
	from	prescr_solucao
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_solucao	= nr_seq_item_p;

elsif (ie_tipo_item_p = 'SNE') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(286021); -- Suporte nutricional enteral
elsif (ie_tipo_item_p = 'NAN') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(308552); -- NPT Adulta
	select	max(substr(CASE WHEN b.ie_forma='P' THEN  wheb_mensagem_pck.get_texto(308606) || ' ' || a.ds_npt  ELSE obter_valor_dominio(1988,b.ie_forma) END ,1,255)) -- Protocolo
	into STRICT	ds_item_w
	FROM nut_pac b
LEFT OUTER JOIN protocolo_npt a ON (b.nr_seq_protocolo = a.nr_sequencia)
WHERE b.nr_prescricao	  = nr_prescricao_p and b.nr_sequencia	  = nr_seq_item_p;

elsif (ie_tipo_item_p = 'NPN') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(308551); -- NPT Neonatal
	select	max(substr(wheb_mensagem_pck.get_texto(308551) || ' ' || hr_prim_horario,1,255)) -- NPT Neonatal
	into STRICT	ds_item_w
	from	nut_pac
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p = 'NPP') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(305649); -- NPT Pediátrica
	select	max(substr(wheb_mensagem_pck.get_texto(305649) || ' ' || hr_prim_horario,1,255)) -- NPT Pediátrica
	into STRICT	ds_item_w
	from	nut_pac
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p = 'HM') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309810); -- Hemoterapia
	select	max(substr(CASE WHEN coalesce(b.ie_util_hemocomponente::text, '') = '' THEN null  ELSE '('|| substr(obter_valor_dominio(2247,b.ie_util_hemocomponente),1,20) ||') ' END ||coalesce(a.ds_derivado,substr(Obter_Desc_Prescr_Proc(b.cd_procedimento,b.ie_origem_proced, b.nr_seq_proc_interno),1,240)),1,255))
	into STRICT	ds_item_w
	FROM prescr_procedimento b
LEFT OUTER JOIN san_derivado a ON (b.nr_seq_derivado = a.nr_sequencia)
WHERE b.nr_prescricao	= nr_prescricao_p and b.nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p = 'M') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(308901); -- Medicamento
elsif (ie_tipo_item_p = 'MAT') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309811); -- Material
elsif (ie_tipo_item_p = 'P') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(286020); -- Procedimento
elsif (ie_tipo_item_p = 'IA') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309812); -- Itens associados
elsif (ie_tipo_item_p = 'C') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309813); -- Controle de Glicemia
	select	max(substr(a.ds_valor_dominio,1,255))
	into STRICT	ds_item_w
	from	valor_dominio a,
		proc_interno b,
		prescr_procedimento c
	where	b.nr_sequencia	= c.nr_seq_proc_interno
	and	a.vl_dominio	= b.ie_ctrl_glic
	and	a.cd_dominio 	= 1903
	and	c.nr_prescricao	= nr_prescricao_p
	and	c.nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p = 'G') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309813); -- Controle de Glicemia
	select	max(substr(a.ds_protocolo,1,255))
	into STRICT	ds_item_w
	from	pep_protocolo_glicemia a,
		prescr_procedimento b
	where	a.nr_sequencia	= b.nr_seq_prot_glic
	and	b.nr_prescricao	= nr_prescricao_p
	and	b.nr_sequencia	= nr_seq_item_p;


elsif (ie_tipo_item_p = 'IAG') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309814); -- Controle de glicemia - Medicamentos associados
elsif (ie_tipo_item_p = 'I') then

	ds_tipo_w := 'IVC';

elsif (ie_tipo_item_p = 'L') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309815);	-- Coleta
	select	max(substr(adep_obter_desc_exame_lab(b.ie_acm,b.ie_se_necessario,a.nm_exame),1,255))
	into STRICT	ds_item_w
	from	exame_laboratorio a,
		prescr_procedimento b
	where	a.nr_seq_exame	= b.nr_seq_exame
	and	b.nr_prescricao	= nr_prescricao_p
	and	b.nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p = 'O') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309816); -- Gasoterapia
	select	max(substr(a.ds_gas,1,255))
	into STRICT	ds_item_w
	from	gas a,
		prescr_gasoterapia b
	where	a.nr_sequencia	= b.nr_seq_gas
	and	b.nr_prescricao	= nr_prescricao_p
	and	b.nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p = 'R') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309817); -- Recomendação
	select	max(substr(coalesce(a.ds_tipo_recomendacao,b.ds_recomendacao),1,255))
	into STRICT	ds_item_w
	FROM prescr_recomendacao b
LEFT OUTER JOIN tipo_recomendacao a ON (b.cd_recomendacao = a.cd_tipo_recomendacao)
WHERE b.nr_prescricao	= nr_prescricao_p and b.nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p = 'E') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309818); -- SAE
	select	max(substr(a.ds_procedimento,1,255))
	into STRICT	ds_item_w
	from	pe_procedimento a,
		pe_prescr_proc b
	where	a.nr_sequencia	= b.nr_seq_proc
	and	b.nr_seq_prescr	= nr_prescricao_p
	and	b.nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p = 'GM') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309819); -- Supl/SNE/Medic/Mat
elsif (ie_tipo_item_p = 'GP') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309820); -- Hemot/Proc/CIG/CCG/IVC/Coleta
elsif (ie_tipo_item_p = 'LD') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309821);	-- Leites e Derivados
elsif (ie_tipo_item_p = 'SADT') then

	ds_tipo_w := wheb_mensagem_pck.get_texto(309822); -- Exame SADT
end if;

if (ie_tipo_item_p	in ('S','SNE','M','MAT', 'IA', 'IAG','LD')) then

	select	max(b.ds_material)
	into STRICT	ds_item_w
	from	material b,
		prescr_material a
	where	a.cd_material	= b.cd_material
	and	a.nr_prescricao	= nr_prescricao_p
	and	a.nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p	in ('IVC','P','SADT')) then

	select	max(substr(obter_desc_prescr_proc(cd_procedimento, ie_origem_proced, nr_seq_proc_interno),1,255))
	into STRICT	ds_item_w
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;

elsif (ie_tipo_item_p	= 'DI') then

	select max(substr(coalesce(obter_desc_prot_npt(nr_seq_protocolo),obter_prim_comp_sol(nr_prescricao,nr_seq_solucao)),1,240))
	into STRICT ds_item_w
	from prescr_solucao
	where nr_prescricao = nr_prescricao_p
	and   nr_seq_solucao = nr_seq_item_p;

end if;

if (ie_opcao_p	= 'I') then
	return	ds_item_w;
else
	return	ds_tipo_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION plt_obter_desc_item ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, ie_opcao_p text) FROM PUBLIC;

