-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_saldo_caixa_banco ( dt_inicio_p timestamp, cd_estabelecimento_p text, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/*
ie_opcao_p	TE = Tesouraria,
		CB = Controle Bancário
		TT = Total (Tesouraria + Controle Bancário)
*/
vl_retorno_w	double precision;


BEGIN

if (ie_opcao_p = 'TE') then
	select	coalesce(sum(CASE WHEN trunc(a.dt_saldo,'dd')=trunc(dt_inicio_p,'dd') THEN a.vl_saldo_inicial  ELSE a.vl_saldo END ),0)
	into STRICT	vl_retorno_w
	from	caixa b,
		caixa_saldo_diario a
	where	a.nr_seq_caixa	= b.nr_sequencia
	and	b.ie_situacao	= 'A'
	and	a.dt_saldo = 	(SELECT	max(dt_saldo)
				from	caixa_saldo_diario x
				where	x.nr_seq_caixa	= a.nr_seq_caixa
				and	trunc(x.dt_saldo,'dd') <= trunc(dt_inicio_p,'dd'))
	and (b.cd_estabelecimento	= cd_estabelecimento_p);
elsif (ie_opcao_p = 'CB') then
	select	coalesce(sum(obter_saldo_banco_diario(b.nr_sequencia, fim_dia(trunc(dt_inicio_p,'dd') -1))),0)
	into STRICT	vl_retorno_w
	from	banco_saldo b,
		banco_estabelecimento a
	where	b.nr_seq_conta		= a.nr_sequencia
	and	a.ie_tipo_relacao	in ('C', 'ECC')
	and	a.ie_situacao = 'A'
	and	b.dt_referencia =	(SELECT	max(dt_referencia)
					from	banco_saldo x
					where	x.nr_seq_conta	= b.nr_seq_conta
					and	trunc(x.dt_referencia,'dd') <= trunc(dt_inicio_p,'dd'))
	and (a.cd_estabelecimento	= cd_estabelecimento_p);
elsif (ie_opcao_p = 'TT') then
	select	sum(vl_saldo)
	into STRICT	vl_retorno_w
	from	(SELECT	coalesce(sum(CASE WHEN trunc(a.dt_saldo,'dd')=trunc(dt_inicio_p,'dd') THEN a.vl_saldo_inicial  ELSE a.vl_saldo END ),0) vl_saldo
		from	caixa b,
			caixa_saldo_diario a
		where	a.nr_seq_caixa	= b.nr_sequencia
		and	b.ie_situacao	= 'A'
		and	a.dt_saldo = 	(select	max(dt_saldo)
					from	caixa_saldo_diario x
					where	x.nr_seq_caixa	= a.nr_seq_caixa
					and	trunc(x.dt_saldo,'dd') <= trunc(dt_inicio_p,'dd'))
		and (b.cd_estabelecimento	= cd_estabelecimento_p)
		
UNION

		SELECT	coalesce(sum(obter_saldo_banco_diario(b.nr_sequencia, fim_dia(trunc(dt_inicio_p,'dd') -1))),0) vl_saldo
		from	banco_saldo b,
			banco_estabelecimento a
		where	b.nr_seq_conta		= a.nr_sequencia
		and	a.ie_tipo_relacao	in ('C', 'ECC')
		and	a.ie_situacao = 'A'
		and	b.dt_referencia =	(select	max(dt_referencia)
						from	banco_saldo x
						where	x.nr_seq_conta	= b.nr_seq_conta
						and	trunc(x.dt_referencia,'dd') <= trunc(dt_inicio_p,'dd'))
		and (a.cd_estabelecimento	= cd_estabelecimento_p)) alias22;
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_saldo_caixa_banco ( dt_inicio_p timestamp, cd_estabelecimento_p text, ie_opcao_p text) FROM PUBLIC;

