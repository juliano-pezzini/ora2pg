-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION contem_prescr_care_plan (nr_prescricoes_p text) RETURNS bigint AS $body$
DECLARE


TYPE table_cods IS TABLE OF bigint INDEX BY integer;
cod_ table_cods;

nr_prescricoes_w                    varchar(2000);
nr_prescricao_w                     PE_PRESCRICAO.NR_SEQUENCIA%type := 0;
pos_arr                             PE_PRESCRICAO.NR_SEQUENCIA%type;
loop_max                            PE_PRESCRICAO.NR_SEQUENCIA%type;
qtd_itens_w                         PE_PRESCRICAO.NR_SEQUENCIA%type;
BEGIN

    select (length(nr_prescricoes_p) - length(replace(nr_prescricoes_p,',',null)) + 1) into STRICT loop_max;

    nr_prescricoes_w := replace(nr_prescricoes_p, ' ', null);

    begin
      for indice in 1..loop_max loop
        pos_arr := position(',' in nr_prescricoes_w) - 1;
        if (pos_arr = -1) then
            pos_arr := length(nr_prescricoes_w);
        end if;
        cod_(indice) := substr(nr_prescricoes_w,0,pos_arr);
        nr_prescricoes_w := regexp_replace(nr_prescricoes_w,cod_(indice),null,1,1);--tirando prescricao encontrada da string
        nr_prescricoes_w := regexp_replace(nr_prescricoes_w,',',null,1,1);--tirando primeira virgula encontrada da string
      end loop;

      for i in 1..loop_max loop
        if cod_(i) > nr_prescricao_w then
           nr_prescricao_w := cod_(i);
        end if;
      end loop;

      select count(*) 
        into STRICT qtd_itens_w 
        from PE_PRESCRICAO 
        where NR_SEQUENCIA = nr_prescricao_w and IE_TIPO = 'CP'
        and (nr_prescricao IS NOT NULL AND nr_prescricao::text <> '');

    exception
    when PROGRAM_ERROR then
        qtd_itens_w := 0;
    end;

    return qtd_itens_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION contem_prescr_care_plan (nr_prescricoes_p text) FROM PUBLIC;

