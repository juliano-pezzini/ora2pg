-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_terminal_inf_cpoe_act_log ( ds_sigla_tabela_p text, nr_sequencia_p text, nm_usuario_p text, dt_atualizacao_p text) RETURNS varchar AS $body$
DECLARE
	
    nm_tabela_w varchar(200);
    ds_retorno_w varchar(2000);
    ds_descricao_w varchar(2000);
    nr_seq_equipamento_w bigint;
	
BEGIN
	
        ds_retorno_w    :=  '';
        SELECT case when(ds_sigla_tabela_p = 'N') then 'CPOE_DIETA'
        when(ds_sigla_tabela_p = 'M') then 'CPOE_MATERIAL' 
        when(ds_sigla_tabela_p = 'G') then 'CPOE_GASOTERAPIA' 
        when(ds_sigla_tabela_p = 'P') then 'CPOE_PROCEDIMENTO' 
        when(ds_sigla_tabela_p = 'R') then 'CPOE_RECOMENDACAO' 
        when(ds_sigla_tabela_p = 'H') then 'CPOE_HEMOTERAPIA' 
        when(ds_sigla_tabela_p = 'D') then 'CPOE_DIALISE'
        when(ds_sigla_tabela_p = 'AP') then 'CPOE_ANATOMIA_PATOLOGICA'
        ELSE
        ''
        END INTO STRICT nm_tabela_w;

        SELECT max(SUBSTR(ds_descricao,1,255))
        INTO STRICT ds_descricao_w
        FROM    tasy_log_alteracao
        WHERE NM_TABELA = nm_tabela_w
        AND DS_CHAVE_SIMPLES = nr_sequencia_p
        AND DT_ATUALIZACAO >= TO_DATE(dt_atualizacao_p)
        AND NM_USUARIO = nm_usuario_p
        AND position('Equipamento :' in DS_DESCRICAO)>0
        ORDER BY NR_SEQUENCIA DESC LIMIT 1;

        if (length(ds_descricao_w) > 0) then
            select cast(substr(ds_descricao_w,position('Equipamento :' in ds_descricao_w)+14, position('Terminal :' in ds_descricao_w)-position('Equipamento :' in ds_descricao_w)-14) as bigint)
            into STRICT    nr_seq_equipamento_w 
;

            select  max(coalesce( '<b>' || obter_desc_expressao(929060)|| ':</b>' || obter_nome_usuario(nm_usuario_p) ||
                            ' <b>' || obter_desc_expressao(311718)||':</b> '||e.DS_EQUIPAMENTO ||
                            ' <b>' || obter_desc_expressao(629943)||':</b> '||ds_hostname ||
                            ' <b>' || obter_desc_expressao(289242)||':</b> '||m.ds_ipv4 ||
                            ' <b>' || obter_desc_expressao(292721)||':</b> '||coalesce(l.ds_localizacao, ''), ''))
            into STRICT ds_retorno_w
            from man_equipamento_terminal m 
            inner join man_equipamento e on e.nr_sequencia = m.nr_seq_equipamento 
            left join man_localizacao l on l.nr_sequencia = e.nr_seq_local
            where m.nr_seq_equipamento = nr_seq_equipamento_w  order by m.nr_sequencia desc LIMIT 1;
        end if;
		return ds_retorno_w;
	end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_terminal_inf_cpoe_act_log ( ds_sigla_tabela_p text, nr_sequencia_p text, nm_usuario_p text, dt_atualizacao_p text) FROM PUBLIC;

