-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_bomba_e_local (nr_prescricao_p bigint, nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


  ds_desc_w varchar(500);

  nr_seq_equipamento_w bomba_infusao.nr_seq_equipamento%type;
  nr_seq_canal_bomba_w bomba_infusao.nr_seq_canal_bomba%type;

  ds_canal_bomba_w man_equipamento_bomba.ds_descricao%type;


BEGIN

  select a.nr_seq_equipamento, a.nr_seq_canal_bomba
    into STRICT nr_seq_equipamento_w, nr_seq_canal_bomba_w
    from bomba_infusao a
   where a.ie_ativo = 'S'
     and a.nr_prescricao = nr_prescricao_p
     and a.nr_atendimento = nr_atendimento_p
     and a.nr_sequencia =
         (SELECT max(b.nr_sequencia)
            from bomba_infusao b
           where a.nr_seq_equipamento = b.nr_seq_equipamento
             and coalesce(a.NR_SEQ_CANAL_BOMBA, 0) = coalesce(b.NR_SEQ_CANAL_BOMBA, 0))  LIMIT 1;

  if (nr_seq_equipamento_w IS NOT NULL AND nr_seq_equipamento_w::text <> '') then

    if (nr_seq_canal_bomba_w IS NOT NULL AND nr_seq_canal_bomba_w::text <> '') then
      select ' - ' || a.ds_descricao
        into STRICT ds_canal_bomba_w
        from man_equipamento_bomba a
       where a.nr_sequencia = nr_seq_canal_bomba_w
         and a.nr_equipamento = nr_seq_equipamento_w;
    end if;

    select a.ds_equipamento || ds_canal_bomba_w || ' - ' desc_bomba
      into STRICT ds_desc_w
      from man_equipamento a
     where a.nr_sequencia = nr_seq_equipamento_w;

  end if;

  return(ds_desc_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_bomba_e_local (nr_prescricao_p bigint, nr_atendimento_p bigint) FROM PUBLIC;

