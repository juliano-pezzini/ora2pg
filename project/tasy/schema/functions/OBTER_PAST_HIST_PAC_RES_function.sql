-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_past_hist_pac_res (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


	cd_pessoa_fisica_w 	pessoa_fisica.cd_pessoa_fisica%type;

	ds_resumo_c01_w	varchar(32000);
	ds_resumo_c02_w	varchar(32000);
	ds_resumo_c03_w	varchar(32000);

	ds_retorno_w	varchar(16000);

	c01_ant_clinico CURSOR FOR
		SELECT	cd_doenca,
				substr(obter_desc_cid(cd_doenca),1,255) ds_doenca_cid,
				ds_doenca,
				ds_observacao
		from	paciente_antec_clinico
		where	cd_pessoa_fisica = cd_pessoa_fisica_w
		and ((cd_doenca IS NOT NULL AND cd_doenca::text <> '')
			or	(ds_doenca IS NOT NULL AND ds_doenca::text <> '')
			or	(ds_observacao IS NOT NULL AND ds_observacao::text <> ''));

	c02_medic_uso CURSOR FOR
		SELECT	coalesce(obter_desc_material(cd_material),ds_medicamento) ds_medicamento_uso
		from	paciente_medic_uso
		where	cd_pessoa_fisica = cd_pessoa_fisica_w
		and ((cd_material IS NOT NULL AND cd_material::text <> '')
			or	(ds_medicamento IS NOT NULL AND ds_medicamento::text <> ''));

	c03_hist_cirur CURSOR FOR
		SELECT	coalesce(obter_descricao_procedimento(cd_procedimento, ie_origem_proced), ds_procedimento_inf) ds_cirurgia_hist
		from	historico_saude_cirurgia
		where	cd_pessoa_fisica = cd_pessoa_fisica_w
		and ((cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')
			or	(ds_procedimento_inf IS NOT NULL AND ds_procedimento_inf::text <> ''));

	C01_w c01_ant_clinico%rowtype;
	C02_w c02_medic_uso%rowtype;
	C03_w c03_hist_cirur%rowtype;

	ds_doenca_lbl	varchar(255);
	ds_obs_lbl	varchar(255);

	ds_medicamento_uso_lbl varchar(255);

	ds_cirurgia_lbl varchar(255);


BEGIN

	select	OBTER_PESSOA_ATENDIMENTO(nr_atendimento_p,'C')
	into STRICT	cd_pessoa_fisica_w
	;

	select	obter_desc_expressao(284928),
			obter_desc_expressao(294639),
			obter_desc_expressao(305010),
			obter_desc_expressao(296438)
	into STRICT	ds_doenca_lbl,
			ds_obs_lbl,
			ds_medicamento_uso_lbl,
			ds_cirurgia_lbl
	;


	open c01_ant_clinico;
	loop
	fetch c01_ant_clinico into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01_ant_clinico */
		begin
		if (coalesce(ds_resumo_c01_w::text, '') = '') then
			ds_resumo_c01_w := obter_desc_expressao(314080);
		end if;
			ds_resumo_c01_w := ds_resumo_c01_w || CHR(13)||CHR(10) || ds_doenca_lbl || ': '||c01_w.cd_doenca || ' - ' || coalesce(c01_w.ds_doenca_cid, c01_w.ds_doenca);
			if (c01_w.ds_observacao IS NOT NULL AND c01_w.ds_observacao::text <> '') then
				ds_resumo_c01_w := ds_resumo_c01_w || '; ' || ds_obs_lbl || ': ' ||  trim(both c01_w.ds_observacao);
			end if;
		end;
	end loop;
	close c01_ant_clinico;


	open c02_medic_uso;
	loop
	fetch c02_medic_uso into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02_medic_uso */
		begin
		if (coalesce(ds_resumo_c02_w::text, '') = '') then
			ds_resumo_c02_w := obter_desc_expressao(293088);
		end if;
			ds_resumo_c02_w := ds_resumo_c02_w || CHR(13)||CHR(10) || ds_medicamento_uso_lbl || ': ' || c02_w.ds_medicamento_uso;
		end;
	end loop;
	close c02_medic_uso;

	open c03_hist_cirur;
	loop
	fetch c03_hist_cirur into
		c03_w;
	EXIT WHEN NOT FOUND; /* apply on c03_hist_cirur */
		begin
		if (coalesce(ds_resumo_c03_w::text, '') = '') then
			ds_resumo_c03_w := obter_desc_expressao(308038);
		end if;
			ds_resumo_c03_w := ds_resumo_c03_w || CHR(13)||CHR(10) || ds_cirurgia_lbl || ': ' || c03_w.ds_cirurgia_hist;
		end;
	end loop;
	close c03_hist_cirur;

	ds_retorno_w := substr(ds_resumo_c01_w || CHR(13) || CHR(10) || CHR(13) || CHR(10) || ds_resumo_c02_w || CHR(13) || CHR(10) || CHR(13) || CHR(10) || ds_resumo_c03_w,1,4000);

	return substr(ds_retorno_w,1,4000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_past_hist_pac_res (nr_atendimento_p bigint) FROM PUBLIC;

