-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dose_mov_musc ( cd_pessoa_fisica_p text, nr_seq_art_mov_musculo_p bigint, nr_seq_toxina_p bigint default 1) RETURNS bigint AS $body$
DECLARE


qt_retorno_w		double precision;
qt_idade_w		integer;
qt_peso_w		double precision;
ie_forma_calculo_w		varchar(3);
qt_conversao_w		double precision;
nr_seq_toxina_w		bigint;


BEGIN

select	max(obter_idade(dt_nascimento,clock_timestamp(),'A'))
into STRICT	qt_idade_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_p;

select	coalesce(max(qt_peso),0)
into STRICT	qt_peso_w
from	atendimento_sinal_vital
where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
			from	atendimento_sinal_vital
			where	(qt_peso IS NOT NULL AND qt_peso::text <> '')
			and	cd_paciente	= cd_pessoa_fisica_p
			and	ie_situacao = 'A'
			and	coalesce(IE_RN,'N')	= 'N');


select	max(a.qt_dose_padrao),
	max(ie_forma_calculo),
	max(nr_seq_toxina)
into STRICT	qt_retorno_w,
	ie_forma_calculo_w,
	nr_seq_toxina_w
from 	artic_mov_musculo_regra a
where 	a.nr_seq_art_mov_musculo = nr_seq_art_mov_musculo_p
and	qt_idade_w between a.qt_idade_min and a.qt_idade_max
and 	qt_peso_w between coalesce(a.qt_peso_min,0) and coalesce(a.qt_peso_max,999)
and	coalesce(a.nr_seq_toxina,nr_seq_toxina_p) = nr_seq_toxina_p;

if (nr_seq_toxina_w IS NOT NULL AND nr_seq_toxina_w::text <> '') then

	select  coalesce(max(qt_conversao),1)
	into STRICT	qt_conversao_w
	from	toxina_botulinica
	where	nr_Sequencia =	nr_seq_toxina_w;

end if;
 /*

if	(upper(ie_forma_calculo_w) = 'KG') then

qt_retorno_w := qt_retorno_w * qt_peso_w * nvl(qt_conversao_w,1);

end if;*/
return	qt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dose_mov_musc ( cd_pessoa_fisica_p text, nr_seq_art_mov_musculo_p bigint, nr_seq_toxina_p bigint default 1) FROM PUBLIC;

