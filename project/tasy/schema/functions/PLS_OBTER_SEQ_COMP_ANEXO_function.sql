-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_seq_comp_anexo ( nr_seq_composicao_p pls_pacote_composicao.nr_sequencia%type, nr_seq_regra_p pls_pacote_tipo_acomodacao.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, dt_vigencia_envio_p pls_pacote_comp_anexo.dt_vigencia_envio%type) RETURNS bigint AS $body$
DECLARE


ds_retorno_w    pls_pacote_comp_anexo.nr_sequencia%type;
qt_registro_w   integer;


BEGIN

ds_retorno_w := null;

-- obrigatorio informar a vigencia
if (dt_vigencia_envio_p IS NOT NULL AND dt_vigencia_envio_p::text <> '') then

        -- verifica se existe algum anexo na composicao
        select  count(1)
        into STRICT    qt_registro_w
        from    pls_pacote_comp_anexo   a
        where   a.nr_seq_pacote_composicao      = nr_seq_composicao_p
        and     a.dt_vigencia_envio             between trunc(dt_vigencia_envio_p, 'MONTH') and fim_dia(last_day(dt_vigencia_envio_p))
        and     a.ie_situacao                   = 'S';

        if (qt_registro_w > 0) then

                select  max(a.nr_sequencia)
                into STRICT    ds_retorno_w
                from    pls_pacote_comp_anexo   a
                where   a.nr_seq_pacote_composicao      = nr_seq_composicao_p
                and     a.nr_seq_prestador              = nr_seq_prestador_p
                and     a.dt_vigencia_envio             between trunc(dt_vigencia_envio_p, 'MONTH') and fim_dia(last_day(dt_vigencia_envio_p))
                and     a.ie_situacao                   = 'S';

                -- se nao achou por pertador, busca por regra
                if (coalesce(ds_retorno_w::text, '') = '') then

                        select  max(a.nr_sequencia)
                        into STRICT    ds_retorno_w
                        from    pls_pacote_comp_anexo   a
                        where   a.nr_seq_pacote_composicao      = nr_seq_composicao_p
                        and     a.nr_seq_tipo_acomodacao        = nr_seq_regra_p
                        and     a.dt_vigencia_envio             between trunc(dt_vigencia_envio_p, 'MONTH') and fim_dia(last_day(dt_vigencia_envio_p))
                        and     coalesce(a.nr_seq_prestador::text, '') = ''
                        and     a.ie_situacao                   = 'S';

                        -- se ainda nao achou, busca um da propria composicao
                        if (coalesce(ds_retorno_w::text, '') = '') then

                                select  max(a.nr_sequencia)
                                into STRICT    ds_retorno_w
                                from    pls_pacote_comp_anexo   a
                                where   a.nr_seq_pacote_composicao      = nr_seq_composicao_p
                                and     a.dt_vigencia_envio             between trunc(dt_vigencia_envio_p, 'MONTH') and fim_dia(last_day(dt_vigencia_envio_p))
                                and     coalesce(a.nr_seq_prestador::text, '') = ''
                                and     coalesce(a.nr_seq_tipo_acomodacao::text, '') = ''
                                and     a.ie_situacao                   = 'S';
                        end if;

                end if;

        end if;
end if; -- fim possui vigencia
return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_seq_comp_anexo ( nr_seq_composicao_p pls_pacote_composicao.nr_sequencia%type, nr_seq_regra_p pls_pacote_tipo_acomodacao.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, dt_vigencia_envio_p pls_pacote_comp_anexo.dt_vigencia_envio%type) FROM PUBLIC;

