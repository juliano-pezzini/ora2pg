-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_show_message_bonus (nr_atendimento_p bigint, cd_procedimento_p bigint, nr_seq_proc_interno_p bigint, ie_origem_proced_p bigint) RETURNS varchar AS $body$
DECLARE


retorno_w varchar(1) := 'N';
ie_valida_bonus_conv_w varchar(1);
cd_convenio_w bigint;
qt_bonus_w bigint;
qt_bonus_conv_apresentado_w bigint;


BEGIN
	select	coalesce(max(cd_convenio), 0)
	into STRICT	cd_convenio_w
	from	atend_categoria_convenio
	where	nr_seq_interno = obter_atecaco_atendimento(nr_atendimento_p);

	select	coalesce(max(ie_valida_bonus_conv), 'N')
	into STRICT	ie_valida_bonus_conv_w
	from	regra_convenio_plano
	where	cd_convenio = cd_convenio_w
	and		cd_procedimento = cd_procedimento_p
	and (coalesce(nr_seq_proc_interno::text, '') = '' or nr_seq_proc_interno = coalesce(nr_seq_proc_interno_p, 0))
	and (coalesce(ie_origem_proced::text, '') = '' or ie_origem_proced = coalesce(ie_origem_proced_p, 0));

	if (ie_valida_bonus_conv_w = 'S') then
		select	coalesce(max(qt_bonus), 0)
		into STRICT	qt_bonus_w
		from	procedimento_autorizado
		where	nr_atendimento = nr_atendimento_p
		and		cd_procedimento = cd_procedimento_p
		and (coalesce(ie_origem_proced::text, '') = '' or ie_origem_proced = coalesce(ie_origem_proced_p, 0))
		and (coalesce(nr_seq_proc_interno::text, '') = '' or nr_seq_proc_interno = coalesce(nr_seq_proc_interno_p, 0));

    if (qt_bonus_w = 0) then
      select	coalesce(max(qt_bonus), 0)
      into STRICT qt_bonus_w
      from	regra_convenio_plano
      where	cd_convenio = cd_convenio_w
      and		cd_procedimento = cd_procedimento_p
	    and (coalesce(nr_seq_proc_interno::text, '') = '' or nr_seq_proc_interno = coalesce(nr_seq_proc_interno_p, 0))
	    and (coalesce(ie_origem_proced::text, '') = '' or ie_origem_proced = coalesce(ie_origem_proced_p, 0));
    end if;

		if (qt_bonus_w IS NOT NULL AND qt_bonus_w::text <> '') then
			select	coalesce(max(qt_bonus_conv_apresentado), 0)
			into STRICT	qt_bonus_conv_apresentado_w
			from	atend_categoria_convenio
			where	nr_seq_interno = obter_atecaco_atendimento(nr_atendimento_p);

			if (coalesce(qt_bonus_conv_apresentado_w::text, '') = '' or qt_bonus_w > qt_bonus_conv_apresentado_w) then
				retorno_w := 'S';
			end if;
		end if;
	end if;
	return retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_show_message_bonus (nr_atendimento_p bigint, cd_procedimento_p bigint, nr_seq_proc_interno_p bigint, ie_origem_proced_p bigint) FROM PUBLIC;

