-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_alerta_desfecho ( nr_seq_regra_p bigint, NR_ATENDIMENTO_P bigint) RETURNS varchar AS $body$
DECLARE


ie_prescr_medic_w CONSISTENCIA_DESFECHO_Q.ie_prescr_medic%type;
ie_pedido_parecer_w CONSISTENCIA_DESFECHO_Q.ie_pedido_parecer%type;
ie_alerta_w varchar(1) := 'S';
ie_existe_consistencia varchar(1);
ie_lib_parecer_medico_w varchar(1);
ie_consiste_prescr_w varchar(1);
ie_consiste_parecer varchar(1);


BEGIN
    select coalesce(ie_lib_parecer_medico, 'N')
    into STRICT ie_lib_parecer_medico_w
    from parametro_medico
    where cd_estabelecimento = obter_estabelecimento_ativo;

    select coalesce(max('S'),'N')
    into STRICT   ie_existe_consistencia
    from CONSISTENCIA_DESFECHO_Q
    where NR_SEQ_CONSISTENCIA = nr_seq_regra_p
    and ie_situacao = 'A'
    and (ie_prescr_medic = 'S' or ie_pedido_parecer = 'S');

    if (ie_existe_consistencia = 'S') then
        select max(ie_prescr_medic),
              max(ie_pedido_parecer)
        into STRICT  ie_prescr_medic_w,
              ie_pedido_parecer_w
        from CONSISTENCIA_DESFECHO_Q
        where NR_SEQ_CONSISTENCIA = nr_seq_regra_p
        and ie_situacao = 'A';

        select    coalesce(max('S'),'N')
                into STRICT    ie_consiste_prescr_w
        from    prescr_material    b,
                    prescr_medica    a
            where    a.nr_atendimento        = nr_atendimento_p
            and    b.nr_prescricao            = a.nr_prescricao
            and    coalesce(b.cd_motivo_baixa,0)    = 0
            and    coalesce(a.dt_suspensao::text, '') = ''
            and    coalesce(b.dt_suspensao::text, '') = ''
            and    (a.DT_LIBERACAO IS NOT NULL AND a.DT_LIBERACAO::text <> '');

        select    coalesce(max('N'),'S')
            into STRICT   ie_consiste_parecer
            from   parecer_medico_req a
            where  a.nr_atendimento = nr_atendimento_p
                and    (((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_inativacao::text, '') = '')) or (ie_lib_parecer_medico_w = 'N'))
                and    not exists (SELECT 1
                    from     parecer_medico b
                    where    b.nr_parecer = a.nr_parecer
                        and    (((b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') and (coalesce(b.dt_inativacao::text, '') = '')) or (ie_lib_parecer_medico_w = 'N')));

        if (ie_consiste_prescr_w = 'S' or ie_consiste_parecer = 'N') then
        ie_alerta_w := 'N';
        end if;
end if;

   
return ie_alerta_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_alerta_desfecho ( nr_seq_regra_p bigint, NR_ATENDIMENTO_P bigint) FROM PUBLIC;

