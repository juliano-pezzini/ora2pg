-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION verify_jobs_working ( nm_usuario_p usuario.nm_usuario%type, cd_funcao_p bigint) RETURNS varchar AS $body$
DECLARE


ie_exibir_alerta_w	varchar(1) := 'N';
qt_count_acesso_w	integer;
qt_count_job_w		integer;
ie_job_parada_w		varchar(1);
qt_falha_w			integer;
ie_base_philips_w 	varchar(1);
nm_job_w			varchar(255) := '';
ie_cadastro_w 		varchar(1) := 'S';
ie_contador_w		integer := 0;

WORK_LIST	    	constant bigint := 357;
					

BEGIN
	if (cd_funcao_p = WORK_LIST) then
		nm_job_w := 'WL_GERAR_TAREFA';
		ie_contador_w := 1;

		select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
		into STRICT 	ie_cadastro_w
		from	WL_REGRA_ITEM
		where	IE_SITUACAO = 'A'
		and		IE_OPCAO_WL = 'D'
		and		QT_TEMPO_REGRA > 0;
	end if;

	if (coalesce(obter_se_base_wheb,'N') = 'S' or ie_cadastro_w = 'N') then
		return ie_exibir_alerta_w;
	end if;

	select	count(*)
	into STRICT	qt_count_acesso_w
	from	log_acesso_funcao
	where	cd_funcao = cd_funcao_p
	and		nm_usuario = nm_usuario_p
	and		dt_acesso >= pkg_date_utils.start_of(clock_timestamp(), 'DD');

	if (qt_count_acesso_w = 1) then
		select count(*),
			   max(coalesce(parada,'N')),
			   max(coalesce(falhas,0))
		into STRICT   qt_count_job_w,
			   ie_job_parada_w,
			   qt_falha_w
		from   job_v
		where  regexp_like(comando, nm_job_w, 'i');

		if (qt_count_job_w < ie_contador_w or ie_job_parada_w <> 'N' or qt_falha_w > 0) then
			ie_exibir_alerta_w := 'S';
		end if;
	end if;
	
	return ie_exibir_alerta_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION verify_jobs_working ( nm_usuario_p usuario.nm_usuario%type, cd_funcao_p bigint) FROM PUBLIC;

