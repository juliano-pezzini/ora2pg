-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nut_obter_cor_cardapio_padrao ( nr_prescr_oral_p bigint, dt_referencia_p timestamp, nr_seq_servico_p bigint, cd_setor_atendimento_p bigint, nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


qt_valida_w	bigint;			
ds_cor_w	varchar(15);
ie_local_comp_w	varchar(1);
ie_setor_comp_w	varchar(1);
ds_parametro_120_w  varchar(1);
			

BEGIN
if (nr_prescr_oral_p IS NOT NULL AND nr_prescr_oral_p::text <> '') then	
ds_parametro_120_w := obter_valor_param_usuario(1003,120,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
	
	select	count(distinct cd_dieta)
	into STRICT	qt_valida_w
	from	prescr_dieta
	where	nr_prescricao = nr_prescr_oral_p
	and	(cd_dieta IS NOT NULL AND cd_dieta::text <> '');
	
	if (qt_valida_w > 1) then
		ds_cor_w :=  obter_tasy_obter_cor(3364,obter_perfil_ativo,wheb_usuario_pck.get_cd_estabelecimento,'T');
	end if;

	
	if (coalesce(ds_cor_w::text, '') = '') then
	
		
		ie_setor_comp_w := nut_obter_se_setor_comp(cd_setor_atendimento_p, nr_atendimento_p, nr_seq_servico_p, dt_referencia_p);
		
		select	count(*)
		into STRICT	qt_valida_w
		from	prescr_dieta a,
			nut_cardapio_dia b
		where	a.nr_prescricao 	= nr_prescr_oral_p
		and	((b.cd_dieta 		= a.cd_dieta) or nut_obter_se_grupo_producao(b.nr_seq_grupo_producao,a.nr_prescricao,'P') = 'S')
		and	((ds_parametro_120_w = 'N' and dt_referencia_p between inicio_dia(b.dt_vigencia_inicial) and fim_dia(b.dt_vigencia_final))
		    or (ds_parametro_120_w = 'S' and coalesce(b.nr_seq_cycle,0) > 0 and get_cycle_day(dt_referencia_p, b.nr_seq_cycle) = b.nr_seq_cycle_day))
		and	b.nr_seq_servico 	= nr_seq_servico_p
		and	b.ie_cardapio_padrao 	= 'S'
		and	(( ie_setor_comp_w = 'S' and nut_obter_se_local_composicao(b.nr_seq_local) = 'S') or ( ie_setor_comp_w = 'N' and nut_obter_se_local_composicao(b.nr_seq_local) = 'N'));

		
		if (qt_valida_w = 0) then
			ds_cor_w := obter_tasy_obter_cor(3366,obter_perfil_ativo,wheb_usuario_pck.get_cd_estabelecimento,'T');		
		end if;
	end if;
end if;


return	ds_cor_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nut_obter_cor_cardapio_padrao ( nr_prescr_oral_p bigint, dt_referencia_p timestamp, nr_seq_servico_p bigint, cd_setor_atendimento_p bigint, nr_atendimento_p bigint) FROM PUBLIC;

