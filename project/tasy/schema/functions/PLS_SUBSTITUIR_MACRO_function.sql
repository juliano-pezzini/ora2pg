-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_substituir_macro ( ds_macro_p text, nm_atributo_p text, vl_atributo_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*ie_opcao_p
C - Contrato
P - Proposta de Adesao
O - Proposta Online
*/
nm_estipulante_w		varchar(255);
dt_nascimento_w			timestamp;
cd_pessoa_fisica_w		varchar(10);
dt_sistema_w			timestamp;
ds_resultado_w			varchar(255);
nm_plano_w			varchar(255);
cd_estipulante_w		varchar(20);
ds_endereco_estipulante_w	varchar(255);
dt_contrato_w			timestamp;
ds_filiacao_w			varchar(255);
dt_nasc_estipulante_w		timestamp;
ds_ident_estipulante_w		varchar(100);
ds_orgao_emissor_ci_w		pessoa_fisica.ds_orgao_emissor_ci%type;
nr_seq_contrato_w		bigint;
cd_cgc_estipulante_w		varchar(14);
nm_pessoa_contato_w		varchar(40);
ds_email_w			varchar(255);
nr_telefone_w			varchar(15);
nr_seq_plano_w			bigint;
vl_inscricao_w			double precision;
nr_seq_tabela_w			bigint;
vl_preco_atual_w		double precision;
uf_emissora_ctps_w		pessoa_fisica.uf_emissora_ctps%type;
nr_seq_proposta_w		bigint;
nm_fantasia_w			varchar(255);
ds_razao_social_w		varchar(255);
nr_protocolo_ans_w		varchar(20);
cd_estabelecimento_w		bigint;
cd_pf_estipulante_w		varchar(10);
ds_complemento_w		varchar(255);
nr_endereco_compl_w		bigint;
uf_estipulante_w		pessoa_juridica.sg_estado%type;
ds_uf_estipulante_w		varchar(255);
ds_bairro_compl_w		varchar(255);
ds_municipio_w			varchar(255);
cd_cep_w			varchar(15);
nr_inscricao_estadual_w		varchar(20);
cd_pessoa_resp_w		varchar(10);
cd_pessoa_fisica_ref_w		varchar(10);
cd_cargo_w			bigint;
ds_estado_civil_resp_1_w	varchar(20);
ds_estado_civil_resp_2_w	varchar(20);
ds_nacionalidade_resp_1_w	varchar(50);
ds_nacionalidade_resp_2_w	varchar(50);
ds_cargo_resp_1_w		varchar(50);
ds_cargo_resp_2_w		varchar(50);
ds_profissao_resp_1_w		varchar(50);
ds_profissao_resp_2_w		varchar(50);
nm_respresentante_1_w		varchar(255);
nm_respresentante_2_w		varchar(255);
nr_seq_pagador_w		bigint;
nr_seq_pagador_fin_w		bigint;
nr_dias_vencimento_w		bigint;
ds_dias_vencimento_w		varchar(255);
vl_via_adic_cartao_w		double precision;
vl_desconto_w			varchar(255);
vl_simul_w			varchar(255);
vl_simul_ext_w			varchar(255);
ds_via_adic_cartao_w		varchar(255);
ie_segmentacao_produto_w	varchar(255);
ds_estado_civil_w		varchar(255);
cd_profissao_estip_w		bigint;
tx_desconto_w			double precision;
nr_cpf_resp_1_w			varchar(11);
nr_identidade_resp_1_w		varchar(15);
ds_endereco_resp_1_w		varchar(255);
nr_endereco_resp_1_w		integer;
ds_bairro_resp_1_w		varchar(255);
ds_municipio_resp_1_w		varchar(255);
sg_emissora_ci_resp_1_w		pessoa_fisica.sg_emissora_ci%type;
ds_estado_resp_1_w		varchar(255);
ds_orgao_emissor_ci_resp_1_w	pessoa_fisica.ds_orgao_emissor_ci%type;
ds_endereco_pf_w		compl_pessoa_fisica.ds_endereco%type;
ds_endereco_pj_w		pessoa_juridica.ds_endereco%type;
ds_email_estipulante_w		varchar(255);

ds_macro_w				varchar(255);


BEGIN

ds_macro_w := ds_macro_p;

if (upper(nm_atributo_p)		= 'CD_PESSOA_FISICA') then
	begin
	select	nm_pessoa_fisica,
		dt_nascimento,
		cd_pessoa_fisica,
		substr(obter_valor_dominio(5,ie_estado_civil),1,255)
	into STRICT	nm_estipulante_w,
		dt_nascimento_w,
		cd_pessoa_fisica_w,
		ds_estado_civil_w
	from	pessoa_fisica
	where	cd_pessoa_fisica	= vl_atributo_p;
	if (ds_macro_w	= '@NOME') then
		ds_resultado_w	:= nm_estipulante_w;
	elsif (ds_macro_w	= '@ENDERECO') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'EC');
	elsif (ds_macro_w	= '@IDADE') then
		ds_resultado_w	:= obter_idade(dt_nascimento_w, clock_timestamp(), 'D');
	elsif (ds_macro_w	= '@PRONOME') then
		ds_resultado_w	:= obter_pronome_pf(cd_pessoa_fisica_w, 'N');
	elsif (ds_macro_w	= '@ARTIGO_PRONOME') then
		ds_resultado_w	:= obter_pronome_pf(cd_pessoa_fisica_w, 'S');
	elsif (ds_macro_w	= '@NASCIMENTO') then
		ds_resultado_w	:= to_char(dt_nascimento_w, 'dd/mm/yyyy');
	elsif (ds_macro_w	= '@PRIMEIRO_NOME') then
		ds_resultado_w	:= obter_nome_sobrenome_pessoa(cd_pessoa_fisica_w, 'P');
	elsif (ds_macro_w	= '@SOBRENOME') then
		ds_resultado_w	:= obter_nome_sobrenome_pessoa(cd_pessoa_fisica_w, 'S');
	elsif (ds_macro_w	= '@SEXO') then
		ds_resultado_w	:= substr(obter_sexo_pf(cd_pessoa_fisica_w,'D'),1,40);
	elsif (ds_macro_w	= '@NR_RESIDENCIA') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'NR');
	elsif (ds_macro_w	= '@CIDADE') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'CI');
	elsif (ds_macro_w	= '@BAIRRO') then
		ds_resultado_w	:= substr(obter_compl_pf(cd_pessoa_fisica_w, 1, 'B'),1,80);
	elsif (ds_macro_w	= '@ESTADO') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'UF');
	elsif (ds_macro_w	= '@RUA') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'EN');
	elsif (ds_macro_w	= '@ESTADO_CIVIL') then
		ds_resultado_w	:= ds_estado_civil_w;
	end if;
	end;
elsif (upper(nm_atributo_p)		= 'SISTEMA') then
	begin
	select	clock_timestamp()
	into STRICT	dt_sistema_w
	;

	if (ds_macro_w	= '@DATA_HORA') then
		ds_resultado_w	:= to_char(dt_sistema_w, 'dd/mm/yyyy HH24:MI:SS');
	elsif (ds_macro_w	= '@DATA_ATUAL') then
		ds_resultado_w	:= to_char(dt_sistema_w, 'dd/mm/yyyy');
	elsif (ds_macro_w	= '@DATA_SEM_HORA') then
		ds_resultado_w	:= to_char(dt_sistema_w, 'dd/mm/yyyy');
	elsif (ds_macro_w	= '@DATAEXT') then
		ds_resultado_w	:= obter_data_extenso(dt_sistema_w, 0);
	end if;
	end;
elsif (upper(nm_atributo_p)		= 'NR_SEQ_CONTRATO') then
	begin
	if (ie_opcao_p	= 'C') then
		begin
		select	substr(obter_nome_pf_pj(a.cd_pf_estipulante,a.cd_cgc_estipulante),1,255),
			CASE WHEN coalesce(a.cd_pf_estipulante::text, '') = '' THEN a.cd_cgc_estipulante  ELSE obter_dados_pf(a.cd_pf_estipulante,'CPF') END ,
			substr(obter_dados_pf_pj(a.cd_pf_estipulante,a.cd_cgc_estipulante,'EC'),1,255),
			a.dt_contrato,
			substr(obter_compl_pf(a.cd_pf_estipulante,4,'N'),1,127) || CASE WHEN coalesce(obter_compl_pf(a.cd_pf_estipulante,4,'N')::text, '') = '' THEN null  ELSE ' e ' END  || substr(obter_compl_pf(a.cd_pf_estipulante,5,'N'),1,127),
			b.dt_nascimento,
			substr(b.nr_identidade || CASE WHEN coalesce(b.sg_emissora_ci::text, '') = '' THEN ''  ELSE '/' || b.sg_emissora_ci END ,1,255),
			ds_orgao_emissor_ci,
			a.nr_contrato nr_seq_contrato,
			a.cd_cgc_estipulante,
			b.uf_emissora_ctps,
			a.nr_seq_proposta,
			a.cd_estabelecimento,
			a.cd_pf_estipulante,
			'',
			substr(obter_dados_pf_pj(a.cd_pf_estipulante,a.cd_cgc_estipulante,'M'),1,255)
		into STRICT	nm_estipulante_w,
			cd_estipulante_w,
			ds_endereco_estipulante_w,
			dt_contrato_w,
			ds_filiacao_w,
			dt_nasc_estipulante_w,
			ds_ident_estipulante_w,
			ds_orgao_emissor_ci_w,
			nr_seq_contrato_w,
			cd_cgc_estipulante_w,
			uf_emissora_ctps_w,
			nr_seq_proposta_w,
			cd_estabelecimento_w,
			cd_pf_estipulante_w,
			nr_inscricao_estadual_w,
			ds_email_estipulante_w
		FROM pls_contrato a
LEFT OUTER JOIN pessoa_fisica b ON (a.cd_pf_estipulante = b.cd_pessoa_fisica)
WHERE a.nr_sequencia = vl_atributo_p;

		select	max(substr(pls_obter_dados_produto(nr_seq_plano,'N'),1,255)),
			max(nr_seq_plano),
			max(nr_seq_tabela)
		into STRICT	nm_plano_w,
			nr_seq_plano_w,
			nr_seq_tabela_w
		from	pls_contrato_plano
		where	nr_seq_contrato = vl_atributo_p;

		select	max(substr(replace(to_char(c.nr_protocolo_ans, 'FM9990,999,99,9'),',','.'),1,4)||  substr(replace(to_char(c.nr_protocolo_ans, 'FM9990,999,99,9'),',','/'),5,6) || substr(replace(to_char(c.nr_protocolo_ans, 'FM9990,999,99,9'),',','-'),11,13)),
			max(ie_segmentacao)
		into STRICT	nr_protocolo_ans_w,
			ie_segmentacao_produto_w
		from	pls_plano		c,
			pls_contrato_plano	b,
			pls_contrato		a
		where	a.nr_sequencia	= b.nr_seq_contrato
		and	b.nr_seq_plano	= c.nr_sequencia
		and	a.nr_sequencia	= vl_atributo_p;

		select	max(a.tx_indice)
		into STRICT	tx_desconto_w
		from	pls_simulacao_perfil a,
			pls_proposta_adesao b,
			pls_contrato c
		where	a.nr_sequencia	= b.nr_seq_simul_perfil
		and	b.nr_sequencia	= c.nr_seq_proposta
		and	c.nr_contrato	= nr_seq_contrato_w;

		if (tx_desconto_w IS NOT NULL AND tx_desconto_w::text <> '')then
			tx_desconto_w := ((1 - tx_desconto_w)*100);
			if (tx_desconto_w < 0)then
				vl_desconto_w := obter_numero_extenso(substr(tx_desconto_w,2,3),'M');
			else
				vl_desconto_w := obter_numero_extenso(tx_desconto_w,'M');
			end if;
			if (tx_desconto_w < 0)then
				vl_simul_w := substr(tx_desconto_w,2,3);
				vl_simul_ext_w := wheb_mensagem_pck.get_texto(1112222,'VL_DESCONTO=' || lower(vl_desconto_w));
			elsif (tx_desconto_w > 0)then
				vl_simul_w := tx_desconto_w;
				vl_simul_ext_w := wheb_mensagem_pck.get_texto(1112223,'VL_DESCONTO=' || lower(vl_desconto_w));
			elsif (tx_desconto_w = 0 )then
				vl_simul_w := '0';
				vl_simul_ext_w := substr(obter_desc_expressao(965160),1,255);
			end if;
		end if;

		select	max(nr_sequencia)
		into STRICT	nr_seq_pagador_w
		from	pls_contrato_pagador
		where	nr_seq_contrato	= vl_atributo_p;

		if (nr_seq_pagador_w IS NOT NULL AND nr_seq_pagador_w::text <> '') then
			select	max(nr_sequencia)
			into STRICT	nr_seq_pagador_fin_w
			from	pls_contrato_pagador_fin
			where	nr_seq_pagador	= nr_seq_pagador_w
			and	trunc(dt_inicio_vigencia,'Month') >= trunc(dt_contrato_w,'Month');

			if (nr_seq_pagador_fin_w IS NOT NULL AND nr_seq_pagador_fin_w::text <> '') then
				select	dt_dia_vencimento
				into STRICT	nr_dias_vencimento_w
				from	pls_contrato_pagador_fin
				where	nr_sequencia	= nr_seq_pagador_fin_w;

				if (nr_dias_vencimento_w IS NOT NULL AND nr_dias_vencimento_w::text <> '') then
					ds_dias_vencimento_w	:= obter_numero_extenso(nr_dias_vencimento_w,'F') || ' dias';
				end if;
			end if;
		end if;

		end;
	elsif (ie_opcao_p	= 'P') then
		begin
		select	substr(obter_nome_pf_pj(a.cd_estipulante,a.cd_cgc_estipulante),1,255),
			CASE WHEN coalesce(a.cd_estipulante::text, '') = '' THEN a.cd_cgc_estipulante  ELSE obter_dados_pf(a.cd_estipulante,'CPF') END ,
			substr(obter_dados_pf_pj(a.cd_estipulante,a.cd_cgc_estipulante,'EC'),1,255),
			a.dt_inicio_proposta,
			substr(obter_compl_pf(a.cd_estipulante,4,'N'),1,127) || CASE WHEN coalesce(obter_compl_pf(a.cd_estipulante,4,'N')::text, '') = '' THEN null  ELSE ' e ' END  || substr(obter_compl_pf(a.cd_estipulante,5,'N'),1,127),
			b.dt_nascimento,
			substr(b.nr_identidade || CASE WHEN coalesce(b.sg_emissora_ci::text, '') = '' THEN ''  ELSE '/' || b.sg_emissora_ci END ,1,255),
			ds_orgao_emissor_ci,
			a.nr_seq_contrato nr_seq_contrato,
			a.cd_cgc_estipulante,
			b.uf_emissora_ctps,
			a.nr_sequencia,
			a.cd_estabelecimento,
			a.cd_estipulante,
			'',
			substr(obter_dados_pf_pj(a.cd_estipulante,a.cd_cgc_estipulante,'M'),1,255)
		into STRICT	nm_estipulante_w,
			cd_estipulante_w,
			ds_endereco_estipulante_w,
			dt_contrato_w,
			ds_filiacao_w,
			dt_nasc_estipulante_w,
			ds_ident_estipulante_w,
			ds_orgao_emissor_ci_w,
			nr_seq_contrato_w,
			cd_cgc_estipulante_w,
			uf_emissora_ctps_w,
			nr_seq_proposta_w,
			cd_estabelecimento_w,
			cd_pf_estipulante_w,
			nr_inscricao_estadual_w,
			ds_email_estipulante_w
		FROM pls_proposta_adesao a
LEFT OUTER JOIN pessoa_fisica b ON (a.cd_estipulante = b.cd_pessoa_fisica)
WHERE a.nr_sequencia = vl_atributo_p;

		select	max(substr(pls_obter_dados_produto(nr_seq_plano,'N'),1,255)),
			max(nr_seq_plano),
			max(nr_seq_tabela)
		into STRICT	nm_plano_w,
			nr_seq_plano_w,
			nr_seq_tabela_w
		from	pls_proposta_plano
		where	nr_seq_proposta = vl_atributo_p;

		select	max(substr(somente_numero(c.nr_protocolo_ans),1,3) || '.' || substr(somente_numero(c.nr_protocolo_ans),4,3) || '/' || substr(somente_numero(c.nr_protocolo_ans),7,2) || '-' || substr(somente_numero(c.nr_protocolo_ans),9,1)) nr_protocolo_ans,
			max(ie_segmentacao)
		into STRICT	nr_protocolo_ans_w,
			ie_segmentacao_produto_w
		from	pls_plano		c,
			pls_proposta_plano	b,
			pls_proposta_adesao	a
		where	a.nr_sequencia	= b.nr_Seq_proposta
		and	b.nr_seq_plano	= c.nr_sequencia
		and	a.nr_sequencia	= vl_atributo_p;

		select	max(a.tx_indice)
		into STRICT	tx_desconto_w
		from	pls_simulacao_perfil a,
			pls_proposta_adesao b
		where	a.nr_sequencia	= b.nr_seq_simul_perfil
		and	b.nr_sequencia	= vl_atributo_p;

		if (tx_desconto_w IS NOT NULL AND tx_desconto_w::text <> '')then
			tx_desconto_w := ((1 - tx_desconto_w)*100);
			if (tx_desconto_w < 0)then
				vl_desconto_w := obter_numero_extenso(substr(tx_desconto_w,2,3),'M');
			else
				vl_desconto_w := obter_numero_extenso(tx_desconto_w,'M');
			end if;
			if (tx_desconto_w < 0)then
				vl_simul_w := substr(tx_desconto_w,2,3);
				vl_simul_ext_w := wheb_mensagem_pck.get_texto(1112222,'VL_DESCONTO=' || lower(vl_desconto_w));
			elsif (tx_desconto_w > 0)then
				vl_simul_w := tx_desconto_w;
				vl_simul_ext_w := wheb_mensagem_pck.get_texto(1112223,'VL_DESCONTO=' || lower(vl_desconto_w));
			elsif (tx_desconto_w = 0 )then
				vl_simul_w := '0';
				vl_simul_ext_w := substr(obter_desc_expressao(965160),1,255);
			end if;
		end if;

		select	max(nr_sequencia)
		into STRICT	nr_seq_pagador_w
		from	pls_proposta_pagador
		where	nr_seq_proposta	= vl_atributo_p;

		if (nr_seq_pagador_w IS NOT NULL AND nr_seq_pagador_w::text <> '') then
			select	dt_dia_vencimento
			into STRICT	nr_dias_vencimento_w
			from	pls_proposta_pagador
			where	nr_sequencia	= nr_seq_pagador_w;

			if (nr_dias_vencimento_w IS NOT NULL AND nr_dias_vencimento_w::text <> '') then
				ds_dias_vencimento_w	:= obter_numero_extenso(nr_dias_vencimento_w,'F') || ' dias';
			end if;
		end if;

		end;
	elsif (ie_opcao_p = 'O') then
		cd_cgc_estipulante_w	:= null;
		
		select	substr(coalesce(obter_nome_pf(b.cd_pessoa_fisica),a.nm_pessoa_fisica),1,255),
			coalesce(b.nr_cpf,a.nr_cpf),
			substr(obter_dados_pf_pj(b.cd_pessoa_fisica,cd_cgc_estipulante_w,'EC'),1,255),
			c.dt_criacao,
			substr(coalesce(obter_compl_pf(b.cd_pessoa_fisica,4,'N'),a.nm_pai),1,127) || CASE WHEN coalesce(obter_compl_pf(b.cd_pessoa_fisica,4,'N'),a.nm_pai) IS NULL THEN null  ELSE ' e ' END  || substr(coalesce(obter_compl_pf(b.cd_pessoa_fisica,5,'N'),a.nm_mae),1,127),
			coalesce(b.dt_nascimento,a.dt_nascimento),
			substr(CASE WHEN coalesce(b.nr_identidade::text, '') = '' THEN (a.nr_identidade || CASE WHEN coalesce(a.sg_emissora_ci::text, '') = '' THEN ''  ELSE '/' || a.sg_emissora_ci END )  ELSE (b.nr_identidade || CASE WHEN coalesce(b.sg_emissora_ci::text, '') = '' THEN ''  ELSE '/' || b.sg_emissora_ci END ) END  ,1,255),
			coalesce(b.ds_orgao_emissor_ci,a.ds_orgao_emissor_ci),
			(select	max(x.nr_contrato)
			from	pls_contrato x
			where	a.nr_sequencia = x.nr_seq_prop_online),
			b.uf_emissora_ctps,
			a.nr_sequencia,
			c.cd_estabelecimento,
			b.cd_pessoa_fisica,
			substr(coalesce(obter_dados_pf_pj(b.cd_pessoa_fisica,cd_cgc_estipulante_w,'M'),a.ds_email),1,255),
			c.nr_seq_plano,
			c.nr_seq_tabela,
			(select	max(x.ds_plano)
			from	pls_plano x
			where	x.nr_sequencia = c.nr_seq_plano),
			(select	max(x.ie_segmentacao)
			from	pls_plano x
			where	x.nr_sequencia = c.nr_seq_plano),
			(select	max(substr(somente_numero(x.nr_protocolo_ans),1,3) || '.' || substr(somente_numero(x.nr_protocolo_ans),4,3) || '/' || substr(somente_numero(x.nr_protocolo_ans),7,2) || '-' || substr(somente_numero(x.nr_protocolo_ans),9,1))
			from	pls_plano x
			where	x.nr_sequencia = c.nr_seq_plano),
			obter_numero_extenso(c.nr_dia_vencimento,'F') || ' dias',
			pls_resumo_prop_online_pck.obter_valor_proposta(c.nr_sequencia, null),
			pls_resumo_prop_online_pck.obter_valor_proposta(c.nr_sequencia, null),
			a.cd_cep,
			a.ds_endereco,
			a.nr_endereco,
			a.ds_complemento,
			a.ds_bairro,
			obter_desc_municipio_ibge(a.cd_municipio_ibge),
			a.sg_estado,
			obter_valor_dominio(50,a.sg_estado),
			cd_profissao
		into STRICT	nm_estipulante_w,
			cd_estipulante_w,
			ds_endereco_estipulante_w,
			dt_contrato_w,
			ds_filiacao_w,
			dt_nasc_estipulante_w,
			ds_ident_estipulante_w,
			ds_orgao_emissor_ci_w,
			nr_seq_contrato_w,
			uf_emissora_ctps_w,
			nr_seq_proposta_w,
			cd_estabelecimento_w,
			cd_pf_estipulante_w,
			ds_email_estipulante_w,
			nr_seq_plano_w,
			nr_seq_tabela_w,
			nm_plano_w,
			ie_segmentacao_produto_w,
			nr_protocolo_ans_w,
			ds_dias_vencimento_w,
			vl_simul_w,
			vl_simul_ext_w,
			cd_cep_w,
			ds_endereco_pf_w,
			nr_endereco_compl_w,
			ds_complemento_w,
			ds_bairro_compl_w,
			ds_municipio_w,
			uf_estipulante_w,
			ds_uf_estipulante_w,
			cd_profissao_estip_w
		FROM pls_proposta_online c, pls_proposta_benef_online a
LEFT OUTER JOIN pessoa_fisica b ON (a.cd_pessoa_fisica = b.cd_pessoa_fisica)
WHERE c.nr_sequencia = a.nr_seq_prop_online and c.nr_sequencia = vl_atributo_p and a.ie_tipo_benef = 'T';
	end if;

	if (coalesce(cd_cgc_estipulante_w,'0') <> '0') then
		begin
		select	ds_nome_abrev,
			ds_email,
			nr_telefone,
			substr(nm_fantasia,1,255),
			substr(ds_razao_social,1,255),
			ds_complemento,
			nr_endereco,
			sg_estado,
			obter_dados_pf_pj(null, cd_cgc, 'DS_UF'),
			ds_bairro,
			ds_municipio,
			cd_cep,
			nr_inscricao_estadual,
			ds_endereco
		into STRICT	nm_pessoa_contato_w,
			ds_email_w,
			nr_telefone_w,
			nm_fantasia_w,
			ds_razao_social_w,
			ds_complemento_w,
			nr_endereco_compl_w,
			uf_estipulante_w,
			ds_uf_estipulante_w,
			ds_bairro_compl_w,
			ds_municipio_w,
			cd_cep_w,
			nr_inscricao_estadual_w,
			ds_endereco_pj_w
		from	pessoa_juridica
		where	cd_cgc	= cd_cgc_estipulante_w;
		exception
		when others then
			nm_pessoa_contato_w	:= '';
			ds_email_w		:= '';
			nr_telefone_w		:= null;
			ds_complemento_w	:= '';
			nr_endereco_compl_w	:= null;
			uf_estipulante_w	:= '';
			ds_uf_estipulante_w	:= '';
			ds_bairro_compl_w	:= '';
			ds_municipio_w		:= '';
			cd_cep_w		:= '';
			ds_endereco_pj_w	:= '';
		end;

		if (coalesce(cd_estabelecimento_w::text, '') = '') then
			select	max(cd_estabelecimento)
			into STRICT	cd_estabelecimento_w
			from	pls_contrato
			where	nr_sequencia = vl_atributo_p;
		end if;

		if (coalesce(ds_email_w::text, '') = '') then
			select	max(a.ds_email)
			into STRICT	ds_email_w
			from	pessoa_juridica_estab	a
			where	a.cd_cgc		= cd_cgc_estipulante_w
			and	a.cd_estabelecimento	= coalesce(cd_estabelecimento_w, a.cd_estabelecimento);
		end if;
		
		ds_email_estipulante_w	:= ds_email_w;
		
		begin
		select	cd_pessoa_fisica,
			cd_cargo
		into STRICT	cd_pessoa_resp_w,
			cd_cargo_w
		from (	SELECT	cd_pessoa_fisica,
					cd_cargo,
					row_number() OVER () AS ie_reg
				from	pessoa_jur_resp
				where	cd_cgc = cd_cgc_estipulante_w
				) alias0
		where	ie_reg	= 1;
		exception
		when others then
			cd_pessoa_resp_w	:= '';
			cd_cargo_w		:= '';
		end;

		if (cd_pessoa_resp_w <> ' ') then
			ds_estado_civil_resp_1_w	:= substr(obter_valor_dominio(5,obter_dados_pf(cd_pessoa_resp_w,'EC')),1,20);
			ds_nacionalidade_resp_1_w	:= substr(obter_dados_pf(cd_pessoa_resp_w,'N'),1,20);
			ds_cargo_resp_1_w		:= substr(obter_desc_cargo(cd_cargo_w),1,50);
			ds_profissao_resp_1_w		:= substr(obter_compl_pf(cd_pessoa_resp_w,1,'P'),1,50);
			nm_respresentante_1_w		:= substr(obter_nome_pf(cd_pessoa_resp_w),1,255);
			nr_cpf_resp_1_w			:= substr(obter_dados_pf(cd_pessoa_resp_w,'CPF'),1,11);
			nr_identidade_resp_1_w		:= substr(obter_dados_pf(cd_pessoa_resp_w,'RG'),1,15);
			sg_emissora_ci_resp_1_w		:= substr(obter_dados_pf(cd_pessoa_resp_w,'UFRG'),1,255);
			ds_orgao_emissor_ci_resp_1_w	:= substr(obter_dados_pf(cd_pessoa_resp_w,'O'),1,255);
			select	max(ds_endereco),
				max(nr_endereco),
				max(ds_bairro),
				max(ds_municipio)
			into STRICT	ds_endereco_resp_1_w,
				nr_endereco_resp_1_w,
				ds_bairro_resp_1_w,
				ds_municipio_resp_1_w
			from	compl_pessoa_fisica
			where	cd_pessoa_fisica	= cd_pessoa_resp_w
			and	ie_tipo_complemento	= 1;
			
			ds_estado_resp_1_w	:= substr(obter_compl_pf(cd_pessoa_resp_w, 1,'DS_UF'),1,255);
		end if;

		begin
		select	cd_pessoa_fisica,
			cd_cargo
		into STRICT	cd_pessoa_resp_w,
			cd_cargo_w
		from (	SELECT	cd_pessoa_fisica,
					cd_cargo,
					row_number() OVER () AS ie_reg
				from	pessoa_jur_resp
				where	cd_cgc = cd_cgc_estipulante_w) alias0
		where	ie_reg	= 2;
		exception
		when others then
			cd_pessoa_resp_w	:= '';
			cd_cargo_w		:= '';
		end;

		if (cd_pessoa_resp_w <> ' ') then
			ds_estado_civil_resp_2_w	:= substr(obter_valor_dominio(5,obter_dados_pf(cd_pessoa_resp_w,'EC')),1,20);
			ds_nacionalidade_resp_2_w	:= substr(obter_dados_pf(cd_pessoa_resp_w,'N'),1,20);
			ds_cargo_resp_2_w		:= substr(obter_desc_cargo(cd_cargo_w),1,50);
			ds_profissao_resp_2_w		:= substr(obter_compl_pf(cd_pessoa_resp_w,1,'P'),1,50);
			nm_respresentante_2_w		:= substr(obter_nome_pf(cd_pessoa_resp_w),1,255);
		end if;
	elsif (coalesce(cd_pf_estipulante_w,0) <> 0) then
		begin
		select	ds_complemento,
			nr_endereco,
			sg_estado,
			obter_compl_pf(cd_pessoa_fisica, 1,'DS_UF'),
			ds_bairro,
			ds_municipio,
			cd_cep,
			cd_profissao,
			ds_endereco,
			ds_email
		into STRICT	ds_complemento_w,
			nr_endereco_compl_w,
			uf_estipulante_w,
			ds_uf_estipulante_w,
			ds_bairro_compl_w,
			ds_municipio_w,
			cd_cep_w,
			cd_profissao_estip_w,
			ds_endereco_pf_w,
			ds_email_estipulante_w
		from	compl_pessoa_fisica
		where	cd_pessoa_fisica	= cd_pf_estipulante_w
		and	ie_tipo_complemento	= 1; -- residencial
		exception
		when others then
			ds_complemento_w	:= '';
			nr_endereco_compl_w	:= null;
			uf_estipulante_w	:= null;
			ds_uf_estipulante_w	:= null;
			ds_bairro_compl_w	:= '';
			ds_municipio_w		:= '';
			cd_cep_w		:= '';
			ds_endereco_pf_w	:= '';
		end;
	end if;

	select	max(vl_via_adicional)
	into STRICT	vl_via_adic_cartao_w
	from	pls_regra_segurado_cart
	where	clock_timestamp()	between dt_inicio_vigencia and fim_dia(dt_fim_vigencia)
	and	coalesce(nr_seq_contrato::text, '') = ''
	and	cd_estabelecimento	= cd_estabelecimento_w;

	if (coalesce(vl_via_adic_cartao_w::text, '') = '') then
		vl_via_adic_cartao_w	:= 0;
		ds_via_adic_cartao_w	:= 'Zero';
	else
		ds_via_adic_cartao_w	:= replace(obter_extenso(vl_via_adic_cartao_w),'.','');
	end if;

	if (ds_macro_w	= '@NR_CPF_RESP_1') then
		ds_resultado_w	:= nr_cpf_resp_1_w;
	elsif (ds_macro_w	= '@INDICE_SIMUL_CONTRATO') then
		ds_resultado_w	:= vl_simul_w;
	elsif (ds_macro_w	= '@INDICE_SIMUL_CONTR_EXT') then
		ds_resultado_w	:= vl_simul_ext_w;
	elsif (ds_macro_w	= '@NR_IDENTIDADE_RESP_1') then
		ds_resultado_w	:= nr_identidade_resp_1_w;
	elsif (ds_macro_w	= '@NR_ENDERECO_RESP_1') then
		ds_resultado_w	:= nr_endereco_resp_1_w;
	elsif (ds_macro_w	= '@DS_ENDERECO_RESP_1') then
		ds_resultado_w	:= ds_endereco_resp_1_w;
	elsif (ds_macro_w	= '@DS_BAIRRO_RESP_1') then
		ds_resultado_w	:= ds_bairro_resp_1_w;
	elsif (ds_macro_w	= '@DS_MUNICIPIO_RESP_1') then
		ds_resultado_w	:= ds_municipio_resp_1_w;
	elsif (ds_macro_w	= '@SG_EMISSORA_CI_RESP_1') then
		ds_resultado_w	:= sg_emissora_ci_resp_1_w;
	elsif (ds_macro_w	= '@DS_ESTADO_RESP_1') then
		ds_resultado_w	:= ds_estado_resp_1_w;
	elsif (ds_macro_w	= '@DS_ORGAO_EMIS_CI_RESP_1') then
		ds_resultado_w	:= ds_orgao_emissor_ci_resp_1_w;
	elsif (ds_macro_w	= '@ESTIPULANTE') then
		ds_resultado_w	:= nm_estipulante_w;
	elsif (ds_macro_w	= '@PRODUTO') then
		ds_resultado_w	:= nm_plano_w;
	elsif (ds_macro_w	= '@CGC_CPF_ESTIPULANTE') then
		ds_resultado_w	:= cd_estipulante_w;
	elsif (ds_macro_w	= '@ENDEREC_ESTIPULANTE') then
		ds_resultado_w	:= ds_endereco_estipulante_w;
	elsif (ds_macro_w	= '@DATA_CONTRATO') then
		ds_resultado_w	:= to_char(dt_contrato_w, 'dd/mm/yyyy');
	elsif (ds_macro_w	= '@FILIACAO_ESTIPULANT') then
		ds_resultado_w	:= ds_filiacao_w;
	elsif (ds_macro_w	= '@DT_NASC_ESTIPULANTE') then
		ds_resultado_w	:= to_char(dt_nasc_estipulante_w,'dd/mm/yyyy');
	elsif (ds_macro_w	= '@IDENT_ESTIPULANTE') then
		ds_resultado_w	:= ds_ident_estipulante_w;
	elsif (ds_macro_w	= '@ORGAO_EMISSOR_RG_ES') then
		ds_resultado_w	:= ds_orgao_emissor_ci_w || uf_emissora_ctps_w;
	elsif (ds_macro_w	= '@NR_CONTRATO') then
		ds_resultado_w	:= nr_seq_contrato_w;
	elsif (ds_macro_w	= '@NOME_REPRESENTANTE') then
		ds_resultado_w	:= nm_pessoa_contato_w;
	elsif (ds_macro_w	= '@FONE_REPRESENTANTE') then
		ds_resultado_w	:= nr_telefone_w;
	elsif (ds_macro_w	= '@EMAIL_REPRESENTANTE') then
		ds_resultado_w	:= ds_email_w;
	elsif	((ds_macro_w	= '@VL_INSCR_APROV_CONT') or (ds_macro_w = '@VL_INSCR_APROV_EXT')) then
		if (ie_opcao_p	= 'C') then
			select	coalesce(max(a.vl_inscricao),0)
			into STRICT	vl_inscricao_w
			from	pls_regra_inscricao a
			where	a.nr_seq_contrato	= vl_atributo_p
			and	a.dt_inicio_vigencia	= (	SELECT	max(x.dt_inicio_vigencia)
								from	pls_regra_inscricao x,
									pls_contrato y
								where	x.nr_seq_contrato = y.nr_sequencia
								and	x.nr_seq_contrato = vl_atributo_p
								and	trunc(x.dt_inicio_vigencia,'dd') <= trunc(y.dt_aprovacao,'dd'));

			if (coalesce(nr_seq_plano_w,0) <> 0) then
				if (coalesce(vl_inscricao_w,0) = 0) then
					select	coalesce(max(a.vl_inscricao),0)
					into STRICT	vl_inscricao_w
					from	pls_regra_inscricao a
					where	a.nr_seq_plano	= nr_seq_plano_w
					and	a.dt_inicio_vigencia	= (	SELECT	max(x.dt_inicio_vigencia)
										from	pls_regra_inscricao x,
											pls_contrato y
										where	x.nr_seq_contrato = y.nr_sequencia
										and	x.nr_seq_contrato = vl_atributo_p
										and	trunc(x.dt_inicio_vigencia,'dd') <= trunc(y.dt_aprovacao,'dd'));
				end if;
			end if;

			ds_resultado_w	:= Campo_Mascara_virgula(vl_inscricao_w);
			if (ds_macro_w = '@VL_INSCR_APROV_EXT') then /* valor por extenso */
				if (vl_inscricao_w <> 0) then
					ds_resultado_w	:= replace(obter_extenso(vl_inscricao_w),'.','');
				else
					ds_resultado_w	:= 'Zero';
				end if;
			end if;
		end if;
	elsif	((ds_macro_w	= '@VL_INSCR_LIB_CONTRA') or (ds_macro_w = '@VL_INSCR_LIB_EXTENS')) then
		if (ie_opcao_p	= 'C') then
			select	coalesce(max(a.vl_inscricao),0)
			into STRICT	vl_inscricao_w
			from	pls_regra_inscricao a
			where	a.nr_seq_contrato	= vl_atributo_p
			and	a.dt_inicio_vigencia	= (	SELECT	max(x.dt_inicio_vigencia)
								from	pls_regra_inscricao x,
									pls_contrato y
								where	x.nr_seq_contrato = y.nr_sequencia
								and	x.nr_seq_contrato = vl_atributo_p
								and	trunc(x.dt_inicio_vigencia,'dd') > trunc(y.dt_aprovacao,'dd'));

			if (coalesce(nr_seq_plano_w,0) <> 0) then
				if (coalesce(vl_inscricao_w,0) = 0) then
					select	coalesce(max(a.vl_inscricao),0)
					into STRICT	vl_inscricao_w
					from	pls_regra_inscricao a
					where	a.nr_seq_plano	= nr_seq_plano_w
					and	a.dt_inicio_vigencia	= (	SELECT	max(x.dt_inicio_vigencia)
										from	pls_regra_inscricao x,
											pls_contrato y
										where	x.nr_seq_contrato = y.nr_sequencia
										and	x.nr_seq_contrato = vl_atributo_p
										and	trunc(x.dt_inicio_vigencia,'dd') > trunc(y.dt_aprovacao,'dd'));
				end if;
			end if;

			ds_resultado_w	:= Campo_Mascara_virgula(vl_inscricao_w);
			if (ds_macro_w = '@VL_INSCR_LIB_EXTENS') then /* valor por extenso */
				if (vl_inscricao_w <> 0) then
					ds_resultado_w	:= replace(obter_extenso(vl_inscricao_w),'.','');
				else
					ds_resultado_w	:= 'Zero';
				end if;
			end if;
		end if;
	elsif	((ds_macro_w	= '@VL_MENS_ACIDEN_TRAB') or (ds_macro_w = '@VL_MENS_ACIDEN_EXT')) then
		if (ie_opcao_p	= 'C') then
			select	max(vl_preco_atual)
			into STRICT	vl_preco_atual_w
			from	pls_plano_preco a,
				pls_tabela_preco b,
				pls_contrato_plano c
			where	a.nr_seq_tabela	= b.nr_sequencia
			and	b.nr_sequencia	= c.nr_seq_tabela
			and	b.nr_sequencia	= nr_seq_tabela_w;

			ds_resultado_w	:= Campo_Mascara_virgula(vl_preco_atual_w);
			if (ds_macro_w = '@VL_MENS_ACIDEN_EXT') then /* valor por extenso */
				if (vl_preco_atual_w <> 0) then
					ds_resultado_w	:= replace(obter_extenso(vl_preco_atual_w),'.','');
				else
					ds_resultado_w	:= 'Zero';
				end if;
			end if;
		end if;
	elsif (ds_macro_w	= '@DT_VENC_PAG_PRINC') then
		if (ie_opcao_p	= 'C') then
			select	coalesce(max(b.dt_dia_vencimento),0)
			into STRICT	ds_resultado_w
			from	pls_contrato_pagador a,
				pls_contrato_pagador_fin b
			where	a.nr_sequencia		= b.nr_seq_pagador
			and	a.nr_seq_contrato	= vl_atributo_p
			and	a.ie_tipo_pagador	= 'P'
			and	coalesce(b.dt_fim_vigencia::text, '') = '';
		elsif (ie_opcao_p	= 'P') then
			select	coalesce(max(dt_dia_vencimento),0)
			into STRICT	ds_resultado_w
			from	pls_proposta_pagador
			where	nr_seq_proposta		= vl_atributo_p
			and	coalesce(dt_fim_vigencia::text, '') = '';
		end if;
	elsif (ds_macro_w	= '@NR_SEQ_PROPOSTA') then
		ds_resultado_w	:= to_char(nr_seq_proposta_w);
	elsif (ds_macro_w	= '@NOME_FANTASIA') then
		ds_resultado_w	:= nm_fantasia_w;
	elsif (ds_macro_w	= '@RAZAO_SOCIAL') then
		ds_resultado_w	:= ds_razao_social_w;
	elsif (ds_macro_w	= '@PROTOCOLO_ANS') then
		ds_resultado_w	:= nr_protocolo_ans_w;
	elsif (ds_macro_w	= '@ENDERE_BAIRRO_ESTIP') then
		if (cd_pf_estipulante_w IS NOT NULL AND cd_pf_estipulante_w::text <> '') then
			ds_resultado_w	:= substr(obter_compl_pf(cd_pf_estipulante_w,1,'ENCB'),1,255);
		elsif (cd_cgc_estipulante_w IS NOT NULL AND cd_cgc_estipulante_w::text <> '') then
			ds_resultado_w	:= substr(obter_compl_pj(cd_cgc_estipulante_w,1,'EC'),1,length(obter_compl_pj(cd_cgc_estipulante_w,1,'EC'))-4);
		end if;
	elsif (ds_macro_w	= '@CIDADE_ESTIPULANTE') then
		ds_resultado_w	:= ds_municipio_w;
	elsif (ds_macro_w	= '@CEP_ESTIPULANTE') then
		ds_resultado_w	:= coalesce(cd_cep_w,'N/D');
	elsif (ds_macro_w	= '@DS_COMPL_ESTIP') then
		ds_resultado_w	:= ds_complemento_w;
	elsif (ds_macro_w	= '@NR_LOG_ESTIPULANTE') then
		ds_resultado_w	:= nr_endereco_compl_w;
	elsif (ds_macro_w	= '@UF_ESTIPULANTE') then
		ds_resultado_w	:= uf_estipulante_w;
	elsif (ds_macro_w	= '@ESTADO_ESTIPULANTE') then
		ds_resultado_w	:= ds_uf_estipulante_w;
	elsif (ds_macro_w	= '@BAIRRO_ESTIPULANTE') then
		ds_resultado_w	:= ds_bairro_compl_w;
	elsif (ds_macro_w	= '@CD_CNPJ_ESTIP_MASC') then
		if (coalesce(cd_cgc_estipulante_w,'X') <> 'X') then
			ds_resultado_w := substr(cd_cgc_estipulante_w,1,2)||'.'||substr(cd_cgc_estipulante_w,3,3)||'.'||substr(cd_cgc_estipulante_w,6,3)||'/'||substr(cd_cgc_estipulante_w,9,4)||'-'||substr(cd_cgc_estipulante_w,13,2);
		else
			ds_resultado_w := '';
		end if;
	/*Utilizados apenas em contratos e propostas PJ*/

	elsif (ds_macro_w	= '@NR_INSC_ESTAD_ESTIP') then
		ds_resultado_w	:= nr_inscricao_estadual_w;
	elsif (ds_macro_w	= '@EST_CIVIL_RESP_1') then
		ds_resultado_w	:= ds_estado_civil_resp_1_w;
	elsif (ds_macro_w	= '@EST_CIVIL_RESP_2') then
		ds_resultado_w	:= ds_estado_civil_resp_2_w;
	elsif (ds_macro_w	= '@NACIONAL_RESP_1') then
		ds_resultado_w	:= ds_nacionalidade_resp_1_w;
	elsif (ds_macro_w	= '@NACIONAL_RESP_2') then
		ds_resultado_w	:= ds_nacionalidade_resp_2_w;
	elsif (ds_macro_w	= '@CARGO_RESP_1') then
		ds_resultado_w	:= ds_cargo_resp_1_w;
	elsif (ds_macro_w	= '@CARGO_RESP_2') then
		ds_resultado_w	:= ds_cargo_resp_2_w;
	elsif (ds_macro_w	= '@PROFISSAO_RESP_1') then
		ds_resultado_w	:= ds_profissao_resp_1_w;
	elsif (ds_macro_w	= '@PROFISSAO_RESP_2') then
		ds_resultado_w	:= ds_profissao_resp_2_w;
	elsif (UPPER(ds_macro_w)	= '@NM_REPRESEN_ESTIP_1') then
		ds_resultado_w	:= nm_respresentante_1_w;
	elsif (ds_macro_w	= '@NM_REPRESEN_ESTIP_2') then
		ds_resultado_w	:= nm_respresentante_2_w;
	elsif (ds_macro_w	= '@VENC_MENSAL_EXTENSO') then
		ds_resultado_w	:= nr_dias_vencimento_w || ' -' ||ds_dias_vencimento_w;
	elsif (ds_macro_w	= '@VL_VIA_ADIC_CARTAO') then
		ds_resultado_w	:= vl_via_adic_cartao_w || ' - ' ||ds_via_adic_cartao_w;
	elsif (ds_macro_w	= '@PROFISSAO_ESTIPULANTE') then
		ds_resultado_w	:= substr(Obter_Desc_profissao(cd_profissao_estip_w),1,255);
	elsif (ds_macro_w	= '@SEGMENTACAO_PRODUTO') then
		ds_resultado_w	:= substr(obter_valor_dominio(1665,ie_segmentacao_produto_w),1,255);
	elsif (ds_macro_w	= '@DATA_CONTRATO_EXTENSO') then
		ds_resultado_w	:= obter_data_extenso(dt_contrato_w,0);
	elsif (ds_macro_w	= '@RUA_ESTIPULANTE') then
		if (coalesce(cd_pf_estipulante_w, '0') <> '0') then
			ds_resultado_w	:= ds_endereco_pf_w;
		elsif (coalesce(cd_cgc_estipulante_w,'0') <> '0') then
			ds_resultado_w	:= ds_endereco_pj_w;
		else
			ds_resultado_w	:= ds_endereco_pf_w;
		end if;
	elsif (ds_macro_w	= '@EMAIL_ESTIPULANTE') then
		ds_resultado_w	:= ds_email_estipulante_w;
	end if;
	end;
end if;

return	ds_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_substituir_macro ( ds_macro_p text, nm_atributo_p text, vl_atributo_p text, ie_opcao_p text) FROM PUBLIC;

