-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prescricao_solucao_cpoe (nr_seq_cpoe_p prescr_solucao_evento.nr_seq_cpoe%type) RETURNS bigint AS $body$
DECLARE


nr_prescricao_w     	prescr_medica.nr_prescricao%type;
ie_troca_frasco_w		adep_motivo_interrupcao.ie_troca_frasco%type;
ie_status_solucao_w 	varchar(3);
nr_seq_evento_w			prescr_solucao_evento.nr_sequencia%type;
nr_seq_horario_w		prescr_mat_hor.nr_sequencia%type;
dt_susp_cpoe_w			cpoe_material.dt_suspensao%type;


BEGIN

ie_status_solucao_w := obter_status_solucao_cpoe(nr_seq_cpoe_p);

if (ie_status_solucao_w = 'INT') then
    select 	coalesce(obter_se_motivo_troca_frasco(max(nr_seq_motivo)),'N')
    into STRICT	ie_troca_frasco_w
    from 	prescr_solucao_evento
    where  	nr_sequencia = (SELECT  max(nr_sequencia)
							from 	prescr_solucao_evento
							where   nr_seq_cpoe = nr_seq_cpoe_p
							and     ie_alteracao = 2
							and		ie_evento_valido = 'S');
end if;

if (ie_status_solucao_w in ('I', 'R')) then
	select 	min(c.nr_sequencia)
    into STRICT   	nr_seq_horario_w
    from	prescr_solucao a,
			prescr_material b,
			prescr_mat_hor   c
    where	a.nr_prescricao	= b.nr_prescricao
    and     a.nr_seq_solucao = b.nr_sequencia_solucao
    and     a.nr_prescricao = b.nr_prescricao
	and     a.nr_prescricao = c.nr_prescricao
	and		b.nr_sequencia = c.nr_seq_material
	and		a.nr_seq_solucao = c.nr_seq_solucao
    and	    b.nr_seq_mat_cpoe = nr_seq_cpoe_p
	and		coalesce(c.dt_fim_horario::text, '') = ''
    and		coalesce(c.dt_suspensao::text, '') = ''
	and		(c.dt_inicio_horario IS NOT NULL AND c.dt_inicio_horario::text <> '')
	and		coalesce(c.ie_horario_especial, 'N') <> 'S'
	and		c.ie_agrupador = 4;
	
	if (coalesce(nr_seq_horario_w::text, '') = '') then
		select  max(a.nr_sequencia) nr_seq_evento
		into STRICT    nr_seq_evento_w
		from    prescr_solucao_evento a
		where   a.nr_seq_cpoe = nr_seq_cpoe_p
		and     a.ie_evento_valido = 'S'
		and     a.ie_alteracao not in (6 , 12);
		
		select  max(a.nr_prescricao)
		into STRICT    nr_prescricao_w
		from    prescr_solucao_evento a
		where   a.nr_sequencia = nr_seq_evento_w;
	else
		select 	max(a.nr_prescricao)
		into STRICT   	nr_prescricao_w
		from	prescr_mat_hor a
		where	a.nr_sequencia = nr_seq_horario_w;
	end if;
elsif (ie_status_solucao_w = 'INT' and
		ie_troca_frasco_w <> 'S') then
	select  max(a.nr_sequencia) nr_seq_evento
    into STRICT    nr_seq_evento_w
    from    prescr_solucao_evento a
    where   a.nr_seq_cpoe = nr_seq_cpoe_p
    and     a.ie_evento_valido = 'S'
    and     a.ie_alteracao not in (6 , 12);

    select  max(a.nr_prescricao)
    into STRICT    nr_prescricao_w
    from    prescr_solucao_evento a
    where   a.nr_sequencia = nr_seq_evento_w;
elsif (ie_status_solucao_w = 'T') then	
	select	max(a.nr_prescricao)
	into STRICT	nr_prescricao_w
	from	prescr_solucao_evento a
	where	a.nr_seq_cpoe = nr_seq_cpoe_p
	and		a.ie_alteracao = 4
	and		a.ie_evento_valido = 'S';
else
    select 	min(a.nr_prescricao)
    into STRICT   	nr_prescricao_w
    from	prescr_solucao a,
			prescr_material b,
			prescr_medica   c
    where	a.nr_prescricao	= b.nr_prescricao
    and     a.nr_seq_solucao = b.nr_sequencia_solucao
    and     a.nr_prescricao = b.nr_prescricao
	and     a.nr_prescricao = c.nr_prescricao
    and	    b.nr_seq_mat_cpoe = nr_seq_cpoe_p
    and (   SELECT	count(*)
                from	prescr_mat_hor b
                where	coalesce(b.dt_fim_horario::text, '') = ''
                and		coalesce(b.dt_suspensao::text, '') = ''
				and		coalesce(b.ie_horario_especial, 'N') <> 'S'
                and		b.nr_seq_solucao = b.nr_sequencia_solucao
                and		b.nr_prescricao = a.nr_prescricao
				and		b.ie_agrupador = 4
            ) > 0;

	if (coalesce(nr_prescricao_w::text, '') = '') then
		select  min(a.nr_prescricao)
		into STRICT    nr_prescricao_w
		from	prescr_solucao a,
				prescr_material b
		where	a.nr_prescricao	= b.nr_prescricao
		and     a.nr_seq_solucao = b.nr_sequencia_solucao
		and	    b.nr_seq_mat_cpoe = nr_seq_cpoe_p
		and     Obter_se_prescr_vigente(a.nr_prescricao) = 'S';
		
		if (coalesce(nr_prescricao_w::text, '') = '') then
			
			select  max(a.dt_suspensao)
			into STRICT    dt_susp_cpoe_w
			from	cpoe_material a
			where	a.nr_sequencia = nr_seq_cpoe_p
			and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
			and		a.dt_suspensao >= clock_timestamp();
			
			select  min(a.nr_prescricao)
			into STRICT    nr_prescricao_w
			from	prescr_solucao a,
					prescr_material b
			where	a.nr_prescricao	= b.nr_prescricao
			and     a.nr_seq_solucao = b.nr_sequencia_solucao
			and	    b.nr_seq_mat_cpoe = nr_seq_cpoe_p
			and ((dt_susp_cpoe_w IS NOT NULL AND dt_susp_cpoe_w::text <> '') or
					obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = 'S');
		end if;
	end if;
end if;

return nr_prescricao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prescricao_solucao_cpoe (nr_seq_cpoe_p prescr_solucao_evento.nr_seq_cpoe%type) FROM PUBLIC;

