-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_inspection_content (nr_seq_agenda_p agenda_paciente_auxiliar.nr_seq_agenda%type) RETURNS varchar AS $body$
DECLARE


nr_seq_proc_estrutura_w cpoe_procedimento.nr_seq_proc_estrutura%type;
ds_proc_exame_w         proc_interno.ds_proc_exame%type;
ds_techinique_w         cpoe_rule_proc_techiniques.ds_techinique%type;
ds_method_w             cpoe_rule_proc_method.ds_method%type;
ds_observacao_w         cpoe_procedimento.ds_observacao%type;
ds_retorno_w            varchar(4000);

nr_seq_proc_interno_w   cpoe_procedimento.nr_seq_proc_interno%type;
slip_node_w             pi_estrutura.ds_estrutura%type;
slip_type_w             pi_tipo_estrutura.ds_tipo_estrutura%type;
ds_nivel_w              varchar(4000);


BEGIN

        if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '')
        then

                ds_retorno_w := '';

                select
                proc.nr_seq_proc_estrutura,
                proc_i.ds_proc_exame,
                tech.ds_techinique as ds_techinique,
                meth.ds_method as ds_method,
                proc.ds_observacao,
                agenda_paciente.nr_seq_proc_interno
                into STRICT    nr_seq_proc_estrutura_w,
                        ds_proc_exame_w,
                        ds_techinique_w,
                        ds_method_w,
                        ds_observacao_w,
                        nr_seq_proc_interno_w    
                FROM agenda_paciente
LEFT OUTER JOIN agenda_paciente_auxiliar agenda_aux ON (agenda_paciente.nr_sequencia = agenda_aux.nr_seq_agenda)
LEFT OUTER JOIN cpoe_procedimento proc ON (agenda_paciente.nr_seq_proc_interno = proc.nr_seq_proc_interno)
LEFT OUTER JOIN cpoe_procedimento proc ON (agenda_aux.nr_seq_cpoe_procedimento = proc.nr_sequencia)
LEFT OUTER JOIN proc_interno proc_i ON (proc.nr_seq_proc_interno = proc_i.nr_sequencia)
LEFT OUTER JOIN cpoe_rule_proc_techiniques tech ON (proc.nr_seq_proc_techiniques = tech.nr_sequencia)
LEFT OUTER JOIN cpoe_rule_proc_method meth ON (proc.nr_seq_proc_method = meth.nr_sequencia)
WHERE agenda_paciente.nr_sequencia = nr_seq_agenda_p;

                if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') and (nr_seq_proc_estrutura_w IS NOT NULL AND nr_seq_proc_estrutura_w::text <> '')
                then 
                        select
                                distinct 
                                cpoe_obter_ds_estrutura_proc(' - ', pec.nr_seq_estrutura) as ds_nivel,
                                pe.ds_estrutura as slip_node,
                                pte.ds_tipo_estrutura as slip_type
                        into STRICT    ds_nivel_w,
                                slip_node_w,
                                slip_type_w 
                        from    pi_estrutura_cad pec, 
                                pi_estrutura pe ,  
                                pi_tipo_estrutura pte
                        where  pec.nr_seq_proc_int = nr_seq_proc_interno_w
                        and pec.nr_seq_estrutura = pe.nr_sequencia
                        and pe.nr_seq_tipo = pte.nr_sequencia
                        and (pec.nr_sequencia = nr_seq_proc_estrutura_w)  LIMIT 1;

                        if (slip_type_w IS NOT NULL AND slip_type_w::text <> '')
                        then
                                ds_retorno_w :=  slip_type_w || ' - ' ||
                                ds_nivel_w || ' - ' || ds_proc_exame_w;

                                if (ds_techinique_w IS NOT NULL AND ds_techinique_w::text <> '')
                                then
                                        ds_retorno_w := ds_retorno_w || ' - ' || ds_techinique_w;
                                end if;

                                if (ds_method_w IS NOT NULL AND ds_method_w::text <> '')
                                then
                                        ds_retorno_w := ds_retorno_w || ' - ' || ds_method_w;
                                end if;

                                if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '')
                                then
                                        ds_retorno_w := ds_retorno_w || ' - ' || ds_observacao_w;
                                end if;

                        end if;

                end if;

        end if;
        return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_inspection_content (nr_seq_agenda_p agenda_paciente_auxiliar.nr_seq_agenda%type) FROM PUBLIC;

