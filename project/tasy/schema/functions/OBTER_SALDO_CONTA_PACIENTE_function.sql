-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_saldo_conta_paciente ( nr_interno_conta_p bigint, nr_titulo_p bigint) RETURNS bigint AS $body$
DECLARE

vl_saldo_w		double precision;
vl_conta_w		double precision;
vl_recebido_w		double precision;
vl_descontos_w		double precision;
vl_glosa_w		double precision;
vl_alteracao_tit_w	double precision;
vl_perdas_w		double precision;
nr_seq_protocolo_w	double precision;
vl_pago_retorno_w	double precision;
vl_desconto_retorno_w	double precision;
vl_glosa_retorno_w	double precision;
vl_perdas_retorno_w	double precision;


BEGIN 
 
	select	max(vl_conta) 
	into STRICT	vl_conta_w 
	from	conta_Paciente 
	where	nr_interno_conta	= nr_interno_conta_p;
 
	select 	coalesce(sum((obter_dados_titulo_receber(nr_titulo,'VA'))::numeric ),0) 
	into STRICT	vl_alteracao_tit_w 
	from	titulo_receber 
	where	nr_titulo	= nr_titulo_p;
	 
	select	coalesce(sum(a.vl_recebido),0), 
		coalesce(sum(a.vl_descontos),0), 
		coalesce(sum(a.vl_glosa),0), 
		coalesce(sum(a.vl_perdas),0) 
	into STRICT	vl_recebido_w, 
		vl_descontos_w, 
		vl_glosa_w, 
		vl_perdas_w 
	from	titulo_receber_liq a	 
	where	a.nr_titulo		= nr_titulo_p 
	and	a.nr_seq_ret_item in (SELECT	x.nr_sequencia 
				from	convenio_retorno_item x 
				where	x.nr_interno_conta	= nr_interno_conta_p);
	 
	select	coalesce(sum(a.vl_Pago),0), 
		coalesce(sum(a.vl_desconto),0), 
		coalesce(sum(a.vl_glosado),0), 
		coalesce(sum(a.vl_perdas),0) 
	into STRICT	vl_pago_retorno_w, 
		vl_desconto_retorno_w, 
		vl_glosa_retorno_w, 
		vl_perdas_retorno_w 
	from	convenio_retorno b, 
		convenio_retorno_item a 
	where	b.ie_status_retorno	<> 'F' 
	and	a.nr_seq_retorno	= b.nr_sequencia 
	and	a.nr_interno_conta	= nr_interno_conta_P;
 
vl_saldo_w	:= coalesce(vl_conta_w,0) - coalesce(vl_recebido_w,0) - coalesce(vl_pago_retorno_w,0) - coalesce(vl_descontos_w,0) - coalesce(vl_desconto_retorno_w,0) - coalesce(vl_glosa_w,0) - coalesce(vl_glosa_retorno_w,0) + coalesce(vl_alteracao_tit_w,0) - coalesce(vl_perdas_w,0) - coalesce(vl_perdas_retorno_w,0);
return vl_saldo_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_saldo_conta_paciente ( nr_interno_conta_p bigint, nr_titulo_p bigint) FROM PUBLIC;

