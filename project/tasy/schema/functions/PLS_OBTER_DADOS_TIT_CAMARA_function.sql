-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_tit_camara ( nr_sequencia_p pls_titulo_lote_camara.nr_sequencia%type, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

/*	ie_opcao_p
	DOC1A	- DOC1 do titulo A Pagar, priorizando o A560 se tiver
	DOC2A	- DOC2 do titulo A Pagar, priorizando o A560 se tiver
	NFR	- NF do titulo a receber
	NFER	- NFE do titulo a receber
	NFRNDR	- NF do titulo a receber NDR
	NFERNDR	- NFE do titulo a receber NDR
*/
ds_retorno_w	varchar(500);

BEGIN

if (ie_opcao_p = 'DOC1A') or (ie_opcao_p = 'DOC2A') then

	-- tenta pegar do A560 primeiro
	select	max(CASE WHEN ie_opcao_p='DOC1A' THEN  e.nr_fatura  ELSE e.nr_nota_credito_debito_a500 END )
	into STRICT	ds_retorno_w
	from	pls_titulo_lote_camara	a,
		titulo_pagar		b,
		ptu_nota_deb_conclusao	c,
		ptu_nota_debito		d,
		ptu_camara_contestacao	e
	where	a.nr_titulo_pagar		= b.nr_titulo
	and	b.nr_seq_nota_deb_conclusao	= c.nr_sequencia
	and	c.nr_seq_nota_debito		= d.nr_sequencia
	and	d.nr_seq_camara_contest		= e.nr_sequencia
	and	a.nr_sequencia			= nr_sequencia_p;

	-- se n√£o encontrou, tenta pegar direto da fatura
	if (coalesce(ds_retorno_w::text, '') = '') then

		if (ie_opcao_p = 'DOC1A') then

			select	max(t.nr_fatura)
			into STRICT	ds_retorno_w
			from (	SELECT  max(b.nr_fatura) nr_fatura
				from	ptu_fatura		b,
					pls_titulo_lote_camara	a
				where	b.nr_titulo		= a.nr_titulo_pagar
				and	a.nr_sequencia		= nr_sequencia_p
				
union all

				SELECT  max(b.nr_fatura) nr_fatura
				from	ptu_fatura		b,
					pls_titulo_lote_camara	a
				where	b.nr_titulo_ndc		= a.nr_titulo_pagar
				and	a.nr_sequencia		= nr_sequencia_p) t;
		end if;

		if (ie_opcao_p = 'DOC2A') then

			select	max(t.nr_nota_credito_debito)
			into STRICT	ds_retorno_w
			from (	SELECT	max(b.nr_nota_credito_debito) nr_nota_credito_debito
				from	ptu_fatura		b,
					pls_titulo_lote_camara	a
				where	b.nr_titulo		= a.nr_titulo_pagar
				and	a.nr_sequencia		= nr_sequencia_p
				
union all

				SELECT	max(b.nr_nota_credito_debito) nr_nota_credito_debito
				from	ptu_fatura		b,
					pls_titulo_lote_camara	a
				where	b.nr_titulo_ndc		= a.nr_titulo_pagar
				and	a.nr_sequencia		= nr_sequencia_p) t;
		end if;
	end if;

elsif	((ie_opcao_p = 'NFR') or (ie_opcao_p = 'NFER')) then

	select	max(pls_obter_dados_pls_fatura(b.nr_sequencia,CASE WHEN ie_opcao_p='NFR' THEN  'NF'  ELSE 'NFE' END ))
	into STRICT	ds_retorno_w
	from	pls_titulo_lote_camara	a,
		pls_fatura		b
	where	b.nr_titulo		= a.nr_titulo_receber
	and	a.nr_sequencia		= nr_sequencia_p;

elsif	((ie_opcao_p = 'NFRNDR') or (ie_opcao_p = 'NFERNDR')) then

	select	max(pls_obter_dados_pls_fatura(b.nr_sequencia,CASE WHEN ie_opcao_p='NFRNDR' THEN  'NFN'  ELSE 'NFNE' END ))
	into STRICT	ds_retorno_w
	from	pls_titulo_lote_camara	a,
		pls_fatura		b
	where	b.nr_titulo_ndc		= a.nr_titulo_receber
	and	a.nr_sequencia		= nr_sequencia_p;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_tit_camara ( nr_sequencia_p pls_titulo_lote_camara.nr_sequencia%type, ie_opcao_p text) FROM PUBLIC;

