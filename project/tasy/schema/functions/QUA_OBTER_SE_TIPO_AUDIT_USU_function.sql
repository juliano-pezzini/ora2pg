-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION qua_obter_se_tipo_audit_usu ( nr_sequencia_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ds_resultado_w		varchar(1);
qt_reg_w			bigint;
cd_cargo_w		bigint;
cd_perfil_w		integer := wheb_usuario_pck.get_cd_perfil;


BEGIN
ds_resultado_w	:= 'N';

select	count(*)
into STRICT	qt_reg_w
from	qua_auditoria_tipo_lib
where	nr_seq_audit_tipo		= nr_sequencia_p;

/*Se nao tiver nenhuma regra, esta liberado*/

if (qt_reg_w = 0) then
	ds_resultado_w	:= 'S';
else

	/*Se tiver alguma regra em branco, esta liberado*/

	select	count(*)
	into STRICT	qt_reg_w
	from	qua_auditoria_tipo_lib
	where	nr_seq_audit_tipo	= nr_sequencia_p
	and	coalesce(cd_cargo::text, '') = ''
	and	coalesce(cd_setor_atendimento::text, '') = ''
	and	coalesce(cd_perfil::text, '') = ''
	and	coalesce(nm_usuario_lib::text, '') = '';
	if (qt_reg_w > 0) then
		ds_resultado_w	:= 'S';
	end if;

	begin
	select	b.cd_cargo
	into STRICT	cd_cargo_w
	from	usuario a,
		pessoa_fisica b
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.nm_usuario		= nm_usuario_p;
	exception when no_data_found then
		cd_cargo_w	:= 0;
	end;

	/*Se tiver regra para usuario ou cargo do usuario, esta liberado*/

	select	count(*)
	into STRICT	qt_reg_w
	from	qua_auditoria_tipo_lib
	where	nr_seq_audit_tipo	= nr_sequencia_p
	and (nm_usuario_lib	= nm_usuario_p or cd_cargo = cd_cargo_w);
	if (qt_reg_w > 0) then
		ds_resultado_w	:= 'S';
	else
		/*Se tiver regra para algum perfil liberado ao usuario, esta liberado*/

		select	count(*)
		into STRICT	qt_reg_w
		from	qua_auditoria_tipo_lib a
		where	a.nr_seq_audit_tipo		= nr_sequencia_p
		and	a.cd_perfil		= cd_perfil_w;
		if (qt_reg_w > 0) then
			ds_resultado_w	:= 'S';
		end if;
	end if;

	/*Se tiver regra para algum setore liberado ao usuario, esta liberado*/

	if (ds_resultado_w = 'N') then
		select	coalesce(max(obter_se_setor_usuario(a.cd_setor_atendimento, nm_usuario_p)), 'N')
		into STRICT	ds_resultado_w
		from	qua_auditoria_tipo_lib a
		where	nr_seq_audit_tipo = nr_sequencia_p
		and	(a.cd_setor_atendimento IS NOT NULL AND a.cd_setor_atendimento::text <> '');
	end if;
end if;

RETURN ds_resultado_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION qua_obter_se_tipo_audit_usu ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

