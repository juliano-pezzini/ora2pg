-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_horarios_aprazados (nr_prescricao_p bigint, nr_seq_material_p bigint) RETURNS varchar AS $body$
DECLARE


ds_horarios_w           varchar(255);
dt_horario_w            varchar(255);
ie_acm_w		varchar(255);
ie_se_necessario_w	varchar(255);
ds_horarios_ww		varchar(4000);

c01 CURSOR FOR
SELECT  to_char(a.dt_horario,'hh24:mi')
from    prescr_mat_hor a,
	prescr_material x
where   a.nr_prescricao   = nr_prescricao_p
and	x.nr_prescricao	= a.nr_prescricao
and	x.nr_sequencia	= a.nr_seq_material
and     a.nr_seq_material = nr_seq_material_p
and	(((to_char(a.dt_horario,'mi') <> '00') and
	  ((obter_se_contido_char(to_char(a.dt_horario,'hh24:mi'),replace(x.ds_horarios,' ',',')) = 'N')and (x.ds_horarios IS NOT NULL AND x.ds_horarios::text <> ''))) or
	 ((to_char(a.dt_horario,'mi') = '00') and
	  ((obter_se_contido_char(to_char(a.dt_horario,'hh24'),replace(x.ds_horarios,' ',',')) = 'N') and (x.ds_horarios IS NOT NULL AND x.ds_horarios::text <> ''))))
order by a.dt_horario;


BEGIN

select	max(ie_acm),
	max(ie_se_necessario),
	max(ds_horarios)
into STRICT	ie_acm_w,
	ie_se_necessario_w,
	ds_horarios_ww
from	prescr_material
where   nr_prescricao   = nr_prescricao_p
and     nr_sequencia = nr_seq_material_p;

open C01;
loop
fetch C01 into
        dt_horario_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
        ds_horarios_w   := ds_horarios_w || ' ' || dt_horario_w;
end loop;
close C01;

return  coalesce(ds_horarios_ww, ds_horarios_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_horarios_aprazados (nr_prescricao_p bigint, nr_seq_material_p bigint) FROM PUBLIC;

