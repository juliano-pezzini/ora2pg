-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_vl_conta_mat_item_oci ( nr_ordem_compra_p bigint, nr_item_oci_p bigint) RETURNS bigint AS $body$
DECLARE

 
vl_material_w		double precision := 0;
cd_estabelecimento_w	bigint;
nr_interno_conta_w		bigint;
nr_atendimento_w		bigint;
cd_material_w		bigint;
cd_convenio_w		bigint;
cd_categoria_w		bigint;
cd_plano_w		varchar(10);
cd_setor_w		bigint;
cd_material_conta_w	bigint;


BEGIN 
 
select	cd_estabelecimento, 
	coalesce(nr_atendimento,0), 
	obter_convenio_atendimento(nr_atendimento), 
	obter_cat_conv_atend(nr_atendimento,obter_convenio_atendimento(nr_atendimento)), 
	Obter_Plano_Convenio_Atend(nr_atendimento,'C'), 
	obter_setor_atendimento(nr_atendimento) 
into STRICT	cd_estabelecimento_w, 
	nr_atendimento_w, 
	cd_convenio_w, 
	cd_categoria_w, 
	cd_plano_w, 
	cd_setor_w 
from	ordem_compra 
where	nr_ordem_compra = nr_ordem_compra_p;
 
IF (nr_atendimento_w > 0) THEN 
 
	SELECT	cd_material 
	INTO STRICT	cd_material_w 
	FROM	ordem_compra_item 
	WHERE	nr_ordem_compra = nr_ordem_compra_p 
	AND	nr_item_oci = nr_item_oci_p;
 
	SELECT	coalesce(obter_material_conta(cd_estabelecimento_w, cd_convenio_w, cd_categoria_w, cd_material_w, cd_material_w, cd_material_w, cd_plano_w, cd_setor_w, clock_timestamp(), 0, 0),0) 
	INTO STRICT	cd_material_conta_w 
	;
 
	IF (cd_material_conta_w > 0) THEN 
		 
		SELECT	coalesce(MAX(nr_interno_conta),0) 
		INTO STRICT	nr_interno_conta_w 
		FROM	material_atend_paciente 
		WHERE	nr_atendimento = nr_atendimento_w 
		AND	cd_material_exec = cd_material_conta_w;
 
		IF (nr_interno_conta_w > 0) THEN		 
		 
			SELECT	MAX(vl_unitario) 
			INTO STRICT	vl_material_w 
			FROM	material_atend_paciente 
			WHERE	nr_atendimento = nr_atendimento_w 
			AND	nr_interno_conta = nr_interno_conta_w 
			AND	cd_material_exec = cd_material_conta_w;		
			 
		else 
			SELECT	coalesce(MAX(nr_interno_conta),0) 
			INTO STRICT	nr_interno_conta_w 
			FROM	material_atend_paciente 
			WHERE	nr_atendimento = nr_atendimento_w 
			AND	cd_material_exec = cd_material_w;
 
			IF (nr_interno_conta_w > 0) THEN			 
			 
				SELECT	MAX(vl_unitario) 
				INTO STRICT	vl_material_w 
				FROM	material_atend_paciente 
				WHERE	nr_atendimento = nr_atendimento_w 
				AND	nr_interno_conta = nr_interno_conta_w 
				AND	cd_material_exec = cd_material_w;
			end if;			
 
		END IF;
	END IF;
END IF;
 
RETURN	vl_material_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_vl_conta_mat_item_oci ( nr_ordem_compra_p bigint, nr_item_oci_p bigint) FROM PUBLIC;

