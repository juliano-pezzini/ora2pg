-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_conta_fin_cheque_estab ( nr_seq_cheque_p bigint, ie_status_cheque_p bigint, ie_restringe_estab_p text) RETURNS bigint AS $body$
DECLARE


cd_conta_financ_w		bigint := null;
cd_empresa_w		bigint;
cd_estabelecimento_w	bigint;
cd_banco_w		bigint;
nr_seq_produto_w		bigint;
ie_origem_cheque_w	varchar(100);
ie_regra_w		varchar(1);
/*
	0 - a vista
	1 - prÉ-datado
	2 - depositado
	3 - devolvido
	4 - reapresentado
	5 - segunda devolucao
	6 - devolucao paciente
	9 - segunda reapresentaÇÃo
	10 - terceira devoluÇao
*/
c01 CURSOR FOR
SELECT	a.cd_conta_financ
FROM conta_financ_regra_cheque a, conta_financeira b
LEFT OUTER JOIN estabelecimento c ON (b.cd_estabelecimento = c.cd_estabelecimento)
WHERE a.cd_conta_financ				= b.cd_conta_financ  and b.cd_empresa				= cd_empresa_w and coalesce(a.cd_banco, cd_banco_w)		= cd_banco_w and coalesce(a.ie_origem_cheque, ie_origem_cheque_w)	= ie_origem_cheque_w and coalesce(a.nr_seq_produto, nr_seq_produto_w)	= nr_seq_produto_w and coalesce(a.nr_seq_trans_fin_doc::text, '') = '' and (
	 (ie_cheque_avista	= 'S' AND ie_status_cheque_p = 0) or
	 (ie_cheque_pre	= 'S' AND ie_status_cheque_p = 1) or
	 (ie_cheque_deposito	= 'S' AND ie_status_cheque_p = 2) or
	 (ie_cheque_dev	= 'S' AND ie_status_cheque_p = 3) or
	 (ie_cheque_reap	= 'S' AND ie_status_cheque_p = 4) or
	 (ie_cheque_seg_dev	= 'S' AND ie_status_cheque_p = 5) or
	 (ie_cheque_dev_pac	= 'S' AND ie_status_cheque_p = 6) or
	 (ie_cheque_seg_reap	= 'S' AND ie_status_cheque_p = 9) or
	 (ie_cheque_terc_dev	= 'S' AND ie_status_cheque_p = 10)
	) and (ie_restringe_estab_p = 'N' or (ie_restringe_estab_p = 'S' and (coalesce(b.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w or c.cd_estab_financeiro = cd_estabelecimento_w)) or (ie_restringe_estab_p = 'E' and coalesce(b.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w)) order by	coalesce(a.cd_banco,0),
	coalesce(a.ie_origem_cheque,0),
	coalesce(a.nr_seq_produto,0);


BEGIN
begin
select	a.cd_estabelecimento,
	a.cd_banco,
	coalesce(a.ie_origem_cheque, 'X'),
	coalesce(a.nr_seq_produto,0)
into STRICT	cd_estabelecimento_w,
	cd_banco_w,
	ie_origem_cheque_w,
	nr_seq_produto_w
from	cheque_cr a
where	a.nr_seq_cheque		= nr_seq_cheque_p;

select	cd_empresa
into STRICT	cd_empresa_w
from	estabelecimento b
where	cd_estabelecimento  = cd_estabelecimento_w;
exception
when others then
	cd_empresa_w		:= 0;
	cd_estabelecimento_w	:= 0;
end;

begin
select	'S'
into STRICT	ie_regra_w
from	conta_financ_regra_cheque a
where	coalesce(a.ie_origem_cheque, ie_origem_cheque_w)	= ie_origem_cheque_w
and	coalesce(a.cd_banco, cd_banco_w)		= cd_banco_w
and	coalesce(a.nr_seq_produto, nr_seq_produto_w)	= nr_seq_produto_w
and	coalesce(nr_seq_trans_fin_doc::text, '') = ''  LIMIT 1;
exception
when others then
	ie_regra_w := 'N';
end;

cd_conta_financ_w	:= null;

ie_regra_w := 'S';

if (ie_regra_w = 'S') then
	begin
	open c01;
	loop
	fetch c01 into
		cd_conta_financ_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	end loop;
	close c01;
	end;
end if;

return	cd_conta_financ_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_conta_fin_cheque_estab ( nr_seq_cheque_p bigint, ie_status_cheque_p bigint, ie_restringe_estab_p text) FROM PUBLIC;

