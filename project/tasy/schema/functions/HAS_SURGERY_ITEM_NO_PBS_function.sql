-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION has_surgery_item_no_pbs ( NR_PRESCRICAO_P PRESCR_MATERIAL.NR_PRESCRICAO%TYPE, NR_CIRURGIA_P MATERIAL_ATEND_PACIENTE.NR_CIRURGIA%TYPE ) RETURNS varchar AS $body$
DECLARE

    COUNT_ITEMS   bigint;
    IE_RESULT_W   CONVENIO_PLANO.IE_EPS%TYPE;

BEGIN
  SELECT  coalesce(MAX(IS_HEALTH_INSURANCE_PLAN_EPS(A.NR_ATENDIMENTO)), 'N')
  INTO STRICT    IE_RESULT_W
  FROM    PRESCR_MEDICA A
  WHERE   A.NR_PRESCRICAO = NR_PRESCRICAO_P;

  IF (IE_RESULT_W = 'S') THEN
    SELECT  coalesce(SUM(HAS), 0)
    INTO STRICT    COUNT_ITEMS
    FROM (
      SELECT  1 HAS
      FROM    PRESCR_MATERIAL A,
              CIRURGIA B
      WHERE   B.NR_PRESCRICAO = A.NR_PRESCRICAO
      AND     A.NR_PRESCRICAO = NR_PRESCRICAO_P
      AND     coalesce(A.CD_MOTIVO_BAIXA, 0) > 0
      AND     IS_MATERIAL_NO_PBS(A.CD_MATERIAL) = 'S'
      AND     HAS_REGISTER_MIPRES(A.NR_PRESCRICAO, B.NR_CIRURGIA, A.NR_SEQUENCIA, 'MAT') = 'N'

UNION ALL

      SELECT  1 HAS
      FROM    MATERIAL_ATEND_PACIENTE A
      WHERE   A.NR_CIRURGIA = NR_CIRURGIA_P
      AND     coalesce(A.CD_MOTIVO_EXC_CONTA::text, '') = ''
      AND     A.QT_MATERIAL > 0
      AND     IS_MATERIAL_NO_PBS(A.CD_MATERIAL) = 'S'
      AND     HAS_REGISTER_MIPRES(A.NR_PRESCRICAO, A.NR_CIRURGIA, A.NR_SEQUENCIA_PRESCRICAO , 'MAT') = 'N'
    ) alias9;

    IF (COUNT_ITEMS = 0) THEN
      IE_RESULT_W := 'N';
    END IF;
  END IF;

  RETURN IE_RESULT_W;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION has_surgery_item_no_pbs ( NR_PRESCRICAO_P PRESCR_MATERIAL.NR_PRESCRICAO%TYPE, NR_CIRURGIA_P MATERIAL_ATEND_PACIENTE.NR_CIRURGIA%TYPE ) FROM PUBLIC;

