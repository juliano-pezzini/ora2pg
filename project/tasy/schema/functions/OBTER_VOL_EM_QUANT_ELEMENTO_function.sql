-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_vol_em_quant_elemento ( nr_seq_elemento_p bigint, nr_seq_elem_unid_med_p bigint, nr_seq_elem_mat_p bigint, qt_volume_informado_p bigint, ie_npt_p text) RETURNS bigint AS $body$
DECLARE


nr_seq_elem_unid_med_w	bigint;
nr_seq_elem_mat_w		bigint;
qt_conversao_ml_w		double precision;
qt_conv_unid_cons_w		double precision;
qt_retorno_w			double precision := 0;
qt_cadastro_w			bigint;

BEGIN

if (nr_seq_elemento_p IS NOT NULL AND nr_seq_elemento_p::text <> '') and (nr_seq_elem_unid_med_p IS NOT NULL AND nr_seq_elem_unid_med_p::text <> '') and (qt_volume_informado_p IS NOT NULL AND qt_volume_informado_p::text <> '') and (ie_npt_p IS NOT NULL AND ie_npt_p::text <> '') then

	if (ie_npt_p = 'NPA') then

		select	coalesce(max(a.qt_conversao_ml),0),
				coalesce(max(a.qt_conv_unid_cons),0)
		into STRICT	qt_conversao_ml_w,
				qt_conv_unid_cons_w
		from	nut_elemento_cadastro a,
				nut_elemento b
		where	a.nr_sequencia	= nr_seq_elem_mat_p;

		qt_retorno_w	:= dividir(qt_volume_informado_p * qt_conv_unid_cons_w, qt_conversao_ml_w);

	elsif (ie_npt_p in ('NPP', 'NPN')) then

		select	count(cd_material)
		into STRICT	qt_cadastro_w
		from	nut_elemento_cadastro
		where	nr_seq_elem_unid_med = nr_seq_elem_unid_med_p;

		if (qt_cadastro_w = 1) then

			select	max(nr_sequencia)
			into STRICT	nr_seq_elem_mat_w
			from	nut_elemento_cadastro
			where	nr_seq_elem_unid_med = nr_seq_elem_unid_med_p;

			if (nr_seq_elem_mat_w IS NOT NULL AND nr_seq_elem_mat_w::text <> '') then

				select	coalesce(max(a.qt_conversao_ml),0),
						coalesce(max(a.qt_conv_unid_cons),0)
				into STRICT	qt_conversao_ml_w,
						qt_conv_unid_cons_w
				from	nut_elemento_cadastro a,
						nut_elemento b
				where	a.nr_sequencia	= nr_seq_elem_mat_w;

				qt_retorno_w	:= dividir(qt_volume_informado_p * qt_conv_unid_cons_w, qt_conversao_ml_w);
			end if;

		end if;

	end if;

end if;

return qt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_vol_em_quant_elemento ( nr_seq_elemento_p bigint, nr_seq_elem_unid_med_p bigint, nr_seq_elem_mat_p bigint, qt_volume_informado_p bigint, ie_npt_p text) FROM PUBLIC;

