-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_fornec_venc_licitacao ( nr_seq_licitacao_p bigint, nr_seq_lic_item_p bigint) RETURNS bigint AS $body$
DECLARE


nr_seq_fornec_w	bigint;
qt_existe_w	bigint;
ie_param_20_w	varchar(1);

c01 CURSOR FOR
SELECT	a.nr_sequencia
from	reg_lic_fornec a,
	reg_lic_item_fornec b
where	a.nr_sequencia		= b.nr_seq_fornec
and	a.nr_seq_licitacao		= nr_seq_licitacao_p
and	b.nr_seq_lic_item		= nr_seq_lic_item_p
and	coalesce(a.ie_situacao, 'A')	<> 'I'
and	coalesce(b.ie_qualificado, 'S')	= 'S'
and	coalesce(b.ie_qualif_lance_fornec,'S')	= 'S'
and	CASE WHEN coalesce(b.vl_item,0)=0 THEN coalesce(b.vl_original,0)  ELSE coalesce(b.vl_item,0) END  > 0
and	(((qt_existe_w = 0) and (CASE WHEN coalesce(b.vl_item,0)=0 THEN coalesce(b.vl_original,0)  ELSE coalesce(b.vl_item,0) END  <= lic_obter_valor_edital(a.nr_seq_licitacao, b.nr_seq_lic_item))) or
	((qt_existe_w > 0) and (lic_obter_se_tem_lance_item(a.nr_sequencia, b.nr_seq_lic_item) = 'S') and
	(((ie_param_20_w = 'N') or (obter_se_empresa_reenserida(a.nr_sequencia, b.nr_seq_lic_item) = 'S')) or
	((ie_param_20_w = 'S') and (CASE WHEN coalesce(b.vl_item,0)=0 THEN coalesce(b.vl_original,0)  ELSE coalesce(b.vl_item,0) END  <= lic_obter_valor_edital(a.nr_seq_licitacao, b.nr_seq_lic_item))))))
order by
	CASE WHEN coalesce(b.vl_item,0)=0 THEN coalesce(b.vl_original,0)  ELSE coalesce(b.vl_item,0) END  desc,
	coalesce(lic_obter_prioridade_fornec(b.nr_seq_fornec,b.nr_seq_lic_item),99999) desc;



BEGIN

ie_param_20_w			:= coalesce(Obter_Valor_Param_Usuario(952,20, Obter_perfil_Ativo, wheb_usuario_pck.get_nm_usuario,0),'S');

select	coalesce(max(a.nr_sequencia), 0)
into STRICT	nr_seq_fornec_w
from	reg_lic_fornec a,
	reg_lic_item_fornec b
where	a.nr_sequencia		= b.nr_seq_fornec
and	a.nr_seq_licitacao		= nr_seq_licitacao_p
and	b.nr_seq_lic_item		= nr_seq_lic_item_p
and	coalesce(a.ie_situacao, 'A')	<> 'I'
and	coalesce(b.ie_vencedor, 'N')	= 'S'
and	coalesce(b.ie_qualificado, 'S')	= 'S'
and	coalesce(b.ie_qualif_lance_fornec,'S')	= 'S'
and	CASE WHEN coalesce(b.vl_item,0)=0 THEN coalesce(b.vl_original,0)  ELSE coalesce(b.vl_item,0) END  > 0;

select	count(*)
into STRICT	qt_existe_w
from	reg_lic_fornec_lance
where	nr_seq_licitacao = nr_seq_licitacao_p
and	nr_seq_lic_item = nr_seq_lic_item_p
and	coalesce(vl_item,0) > 0;

if (nr_seq_fornec_w = 0) then
	open c01;
	loop
	FETCH C01 into
		nr_seq_fornec_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		nr_seq_fornec_w	:= nr_seq_fornec_w;
	END LOOP;
	CLOSE C01;
end if;

return nr_seq_fornec_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_fornec_venc_licitacao ( nr_seq_licitacao_p bigint, nr_seq_lic_item_p bigint) FROM PUBLIC;

