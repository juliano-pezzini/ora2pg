-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_questiona_extensao (cd_perfil_p bigint, cd_setor_atendimento_p bigint, nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE



hr_inicio_w		varchar(5);
hr_fim_w		varchar(5);
dt_inicio_w		timestamp;
dt_fim_w		timestamp;
ie_questiona_w	varchar(1) := 'N';
ie_questionar_w	periodo_questiona_extensao.ie_questionar%type;
qt_prescr_w		smallint := 0;
qt_prescr_lib_w	smallint := 0;
hr_corte_w		timestamp;
hr_corte_c_w	varchar(20);


c01 CURSOR FOR
SELECT	hr_inicio,
		hr_fim,
		coalesce(ie_questionar,'N')
from	periodo_questiona_extensao
where	coalesce(cd_setor_atendimento,cd_setor_atendimento_p) = cd_setor_atendimento_p
and		coalesce(cd_perfil,cd_perfil_p) = cd_perfil_p;


BEGIN

if (cd_setor_atendimento_p > 0) then
	select	count(*)
	into STRICT	qt_prescr_w
	from	prescr_medica
	where	nr_atendimento = nr_atendimento_p
	and		cd_setor_atendimento = cd_setor_atendimento_p  LIMIT 1;

	if (qt_prescr_w > 0) then

		select	coalesce(Max(substr(PKG_DATE_FORMATERS.TO_VARCHAR(hr_inicio_prescricao,'shorTime', obter_estabelecimento_ativo, obter_usuario_ativo),12,19)),'00:00:00')
		into STRICT	hr_corte_c_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_atendimento_p;

		hr_corte_w := to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || hr_corte_c_w, 'dd/mm/yyyy hh24:mi:ss');

		if (clock_timestamp() between hr_corte_w and (hr_corte_w + 1)) then
			hr_corte_w := hr_corte_w + 1;
		end if;

		select	count(*)
		into STRICT	qt_prescr_lib_w
		from	prescr_medica
		where	nr_atendimento = nr_atendimento_p
		and		cd_setor_atendimento = cd_setor_atendimento_p
		and		dt_inicio_prescr between hr_corte_w and (hr_corte_w + 1)
		and		(coalesce(dt_liberacao, dt_liberacao_medico) IS NOT NULL AND (coalesce(dt_liberacao, dt_liberacao_medico))::text <> '')
		and		coalesce(dt_suspensao::text, '') = ''  LIMIT 1;

	end if;

end if;
open C01;
loop
fetch C01 into
	hr_inicio_w,
	hr_fim_w,
	ie_questionar_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ie_questionar_w = 'N'
		or (ie_questionar_w in ('F','A') and (qt_prescr_lib_w > 0))
		or (ie_questionar_w in ('P','A') and (qt_prescr_w = 0))) then

		dt_inicio_w	:= to_date(to_char(clock_timestamp(),'dd/mm/yyyy ') 	|| substr(hr_inicio_w,1,5) || ':00','dd/mm/yyyy hh24:mi:ss');
		dt_fim_w 	:= to_date(to_char(clock_timestamp(),'dd/mm/yyyy ') 	|| substr(hr_fim_w,1,5)    || ':00','dd/mm/yyyy hh24:mi:ss');


		if (dt_fim_w < dt_inicio_w) then
			dt_fim_w	:= dt_fim_w + 1;
		end if;
		if (clock_timestamp() between dt_inicio_w and dt_fim_w)	then
			ie_questiona_w := 'S';
		end if;

	end if;

	end;
end loop;
close C01;

return	ie_questiona_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_questiona_extensao (cd_perfil_p bigint, cd_setor_atendimento_p bigint, nr_atendimento_p bigint) FROM PUBLIC;

