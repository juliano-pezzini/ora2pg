-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nfse_obter_compl_pf (cd_pessoa_fisica_p text, ie_descricao_p text) RETURNS varchar AS $body$
DECLARE


ds_descricao_w          varchar(255)  := '';
cd_municipio_ibge_w	varchar(255);
ie_tipo_complemento_w	varchar(1);
nr_seq_tipo_compl_adic_w bigint;
qt_regra_w		bigint;
cd_estabelecimento_w	bigint;

/*
   t - telefone
   en - só endereco
   uf - estado
   cep - cep
   b - bairro
   m - email
   co - complemento
   nr - número
   cdm - código município
   cdmnf - Codigo do município NFe, NFSe ( Para cidades que não usam o código de municipio IBGE).
   ddt - numero ddd telefone
*/
BEGIN

cd_estabelecimento_w := obter_estabelecimento_ativo();

select	count(*)
into STRICT	qt_regra_w
from	nfse_regra a
where	a.cd_estabelecimento = cd_estabelecimento_w
and	coalesce(ie_tipo_endereco ,0) > 0;

if (qt_regra_w > 0) then

	select	ie_tipo_endereco
	into STRICT	nr_seq_tipo_compl_adic_w
	from	nfse_regra a
	where	a.cd_estabelecimento = cd_estabelecimento_w;

end if;

ie_tipo_complemento_w:= '1';
if (nr_seq_tipo_compl_adic_w IS NOT NULL AND nr_seq_tipo_compl_adic_w::text <> '') then
	ie_tipo_complemento_w:= '9';
end if;

if (ie_tipo_complemento_w > 0) then

	IF (ie_descricao_p = 'T') THEN

		select	substr(somente_numero(nr_telefone),1,15)
		into STRICT	ds_descricao_w
		from	(SELECT a.nr_telefone
				 from	compl_pessoa_fisica a
				 where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
				 order	by a.nr_sequencia desc) alias11 LIMIT 1;

	elsif (ie_descricao_p = 'UF') then

		select	sg_estado
		into STRICT	ds_descricao_w
		from	(SELECT a.sg_estado
				from	compl_pessoa_fisica a
				where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
				 order	by a.nr_sequencia desc) alias8 LIMIT 1;

	elsif (ie_descricao_p = 'CEP') then
		select	substr(cd_cep, 1, 8)
		into STRICT	ds_descricao_w
		from	(SELECT a.cd_cep
				from	compl_pessoa_fisica a
				where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
				 order	by a.nr_sequencia desc) alias9 LIMIT 1;

	elsif (ie_descricao_p = 'B') then

		select	tiss_eliminar_caractere(elimina_acentuacao(ds_bairro))
		into STRICT	ds_descricao_w
		from	(SELECT a.ds_bairro
				 from	compl_pessoa_fisica a
				 where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
				 order	by a.nr_sequencia desc) alias10 LIMIT 1;

	elsif (ie_descricao_p = 'M') then

		select	ds_email
		into STRICT	ds_descricao_w
		from	(SELECT a.ds_email
				 from	compl_pessoa_fisica a
				 where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
				 order	by a.nr_sequencia desc) alias8 LIMIT 1;

	elsif (ie_descricao_p = 'EN') then

		select	tiss_eliminar_caractere(elimina_acentuacao(endereco))
		into STRICT	ds_descricao_w
		from	(SELECT ds_endereco endereco
				 from	compl_pessoa_fisica a
				 where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
				 order	by a.nr_sequencia desc) alias10 LIMIT 1;

	elsif (ie_descricao_p = 'NR') then

		select	substr(somente_numero(nr_endereco),1,5)
		into STRICT	ds_descricao_w
		from	(SELECT a.nr_endereco
				 from	compl_pessoa_fisica a
				 where	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
				 order	by a.nr_sequencia desc) alias10 LIMIT 1;

	elsif (ie_descricao_p = 'CO') then

		select	tiss_eliminar_caractere(elimina_acentuacao(ds_complemento))
		into STRICT	ds_descricao_w
		from	(SELECT a.ds_complemento
				 from	compl_pessoa_fisica a
				 where	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
				 order	by a.nr_sequencia desc) alias10 LIMIT 1;

	elsif (ie_descricao_p = 'CDM') then
		select	cd_municipio_ibge
		into STRICT	ds_descricao_w
		from	(SELECT cd_municipio_ibge
				 from	compl_pessoa_fisica a
				 where	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
				 order	by a.nr_sequencia desc) alias8 LIMIT 1;

	elsif (ie_descricao_p = 'DM') then
		select	tiss_eliminar_caractere(elimina_acentuacao(ds_municipio))
		into STRICT	ds_descricao_w
		from	(SELECT b.ds_municipio
				 from	sus_municipio b,
					compl_pessoa_fisica a
				 where	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
				 and	b.cd_municipio_ibge		= a.cd_municipio_ibge
				 order	by a.nr_sequencia desc) alias10 LIMIT 1;

	elsif (ie_descricao_p = 'CDMDV') then

		select	cd_municipio_ibge
		into STRICT	cd_municipio_ibge_w
		from 	(SELECT	max(a.cd_municipio_ibge) cd_municipio_ibge
			from	compl_pessoa_fisica a
			where	a.cd_pessoa_fisica  = cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
			order	by a.cd_municipio_ibge desc) alias9 LIMIT 1;

		if (cd_municipio_ibge_w IS NOT NULL AND cd_municipio_ibge_w::text <> '') then
			case cd_municipio_ibge_w
			when '430587' then ds_descricao_w := '4305871';
			when '220191' then ds_descricao_w := '2201919';
			when '220225' then ds_descricao_w := '2202251';
			when '220198' then ds_descricao_w := '2201988';
			when '261153' then ds_descricao_w := '2611533';
			when '311783' then ds_descricao_w := '3117836';
			when '315213' then ds_descricao_w := '3152131';
			when '520393' then ds_descricao_w := '5203939';
			when '520396' then ds_descricao_w := '5203962';
			else ds_descricao_w := substr(cd_municipio_ibge_w || substr(calcula_digito('MODULO10',cd_municipio_ibge_w),1,1),1,255);
			end case;

		end if;

	elsif (ie_descricao_p = 'CDMNF') then
	begin
		select	cd_municipio_ibge
		into STRICT	cd_municipio_ibge_w
		from	(	SELECT	max(a.cd_municipio_ibge) cd_municipio_ibge
					from	compl_pessoa_fisica a
					where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
					and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
					order	by a.cd_municipio_ibge desc) alias9 LIMIT 1;

		if (cd_municipio_ibge_w IS NOT NULL AND cd_municipio_ibge_w::text <> '') then
			begin

			select	cd_municipio_nfe
			into STRICT	ds_descricao_w
			from	sus_municipio
			where	cd_municipio_ibge = cd_municipio_ibge_w;

			end;
		end if;
	end;

	elsif (ie_descricao_p = 'DDT') THEN

		select	nr_ddd_telefone
		into STRICT	ds_descricao_w
		from	(SELECT a.nr_ddd_telefone
				 from	compl_pessoa_fisica a
				 where	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p
				and	((coalesce(nr_seq_tipo_compl_adic_w,0) = a.nr_seq_tipo_compl_adic) or
					((coalesce(nr_seq_tipo_compl_adic_w,0) = 0) and (a.ie_tipo_complemento= '1')))
				 order	by a.nr_sequencia desc) alias8 LIMIT 1;
	end if;

end if;

return ds_descricao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nfse_obter_compl_pf (cd_pessoa_fisica_p text, ie_descricao_p text) FROM PUBLIC;

