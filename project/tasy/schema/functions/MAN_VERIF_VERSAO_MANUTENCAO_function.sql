-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_verif_versao_manutencao ( cd_versao_destino_p text) RETURNS varchar AS $body$
DECLARE


cd_versao_w			varchar(15);
ds_versao_w			varchar(200):= 'NOK';
ie_primeira_w		varchar(1):= 'S';
cd_versao_destino_w	varchar(500);
cd_cgc_w			varchar(500);
qt_registros		bigint;

C01 CURSOR FOR
	SELECT	cd_versao
	from	aplicacao_tasy_versao
	where	cd_aplicacao_tasy = 'Tasy'
	and		coalesce(IE_VERSAO_OFICIAL, 'N') = 'S'
	and		trunc(dt_versao) between clock_timestamp() - interval '50 days' and clock_timestamp()
	order by dt_versao desc;


BEGIN

/*
Function responsável por obter as versões que estão na extranet mas a versão do teste. Com isso comparamos a versão de destino do cliente e via webservice a rotina da atualização ira impedir atualização para versões antigas.
*/
cd_versao_destino_w:= cd_versao_destino_p;

if (coalesce(position('@' in cd_versao_destino_p),0) <> 0) then

	cd_versao_destino_w:= substr(cd_versao_destino_p,1,position('@' in cd_versao_destino_p)-1);
	cd_cgc_w:= substr(cd_versao_destino_p,position('@' in cd_versao_destino_p)+1,length(cd_versao_destino_p));

	select	count(*)
	into STRICT	qt_registros
	from	tasy_autorizacao_atualiza a
	where	somente_numero_char(a.cd_cnpj_cliente)  = somente_numero_char(cd_cgc_w)
	and		somente_numero_char(a.cd_versao) = somente_numero_char(cd_versao_destino_w)
	and		trunc(clock_timestamp()) between trunc(a.dt_ini_intervalo) and trunc(a.dt_fim_intervalo);

	if (qt_registros > 0) then
		ds_versao_w:= 'ok';
	end if;

end if;

open C01;
loop
fetch C01 into
	cd_versao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ds_versao_w <> 'ok') then

		if (ie_primeira_w = 'S') then
			ie_primeira_w:= 'N';
			ds_versao_w:= cd_versao_w;
		else
			ds_versao_w:= ds_versao_w || ', '||cd_versao_w;
		end if;

		if (cd_versao_destino_w = cd_versao_w) then
			ds_versao_w := 'ok';
		end if;

	end if;

	end;
end loop;
close C01;

if (cd_versao_destino_w = '2.2.1666')	 then
	ds_versao_w := 'ok';
end if;

return	ds_versao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_verif_versao_manutencao ( cd_versao_destino_p text) FROM PUBLIC;

