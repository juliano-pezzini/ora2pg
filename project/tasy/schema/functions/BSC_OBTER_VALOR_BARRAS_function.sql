-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION bsc_obter_valor_barras ( vl_limite_p bigint, vl_meta_p bigint, vl_real_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


vl_total_p	double precision;
ie_tratar_ext_w	varchar(3);


BEGIN

ie_tratar_ext_w	:= OBTER_VALOR_PARAM_USUARIO(7024, 73, Obter_perfil_Ativo,wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);

if (ie_opcao_p = 'MA') then
	vl_total_p := (vl_meta_p - (vl_meta_p - vl_limite_p)) + (vl_meta_p - vl_limite_p) + vl_limite_p;
	if (vl_real_p > vl_total_p) then
		return	vl_limite_p + (vl_real_p - vl_total_p);
	else
		if (vl_real_p < vl_limite_p) then
			return	vl_meta_p;			
		elsif (ie_tratar_ext_w = 'EXT') then
			begin
			if (vl_real_p > vl_meta_p) then	
				return	vl_limite_p + (vl_real_p - vl_total_p);
			else
				return(vl_real_p * 10) / 100;
			end	if;
			end;
		else
			return	vl_limite_p;
		end	if;
	end	if;
elsif (ie_opcao_p = 'ME') then
	vl_total_p := (vl_limite_p - (vl_limite_p - vl_meta_p)) + (vl_limite_p - vl_meta_p) + vl_meta_p;
	if (vl_real_p > vl_total_p) then
		return	vl_meta_p + (vl_real_p - vl_total_p);
	elsif (ie_tratar_ext_w = 'EXT') then
		begin
		if (vl_real_p > vl_total_p) then
			return	vl_meta_p + (vl_real_p - vl_total_p);
		elsif (vl_real_p < vl_meta_p) then
			return(vl_meta_p * 10) / 100;
		elsif (vl_real_p >= vl_limite_p) then		
			return	vl_real_p - vl_limite_p;
		else
			return	vl_meta_p;
		end	if;
		end;
	else
		return	vl_meta_p;
	end	if;
elsif (ie_opcao_p = 'N') then
	return coalesce(vl_real_p,0);
end	if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION bsc_obter_valor_barras ( vl_limite_p bigint, vl_meta_p bigint, vl_real_p bigint, ie_opcao_p text) FROM PUBLIC;

