-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_mensagem_quitacao_anual ( cd_pessoa_fisica_p text, dt_referencia_mens_p timestamp, cd_cgc_p text) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Obter as parcelas em aberto de um determinado pagador/beneficiário
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [X]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
Function utilizada no relatório CPLS-4370 (Unimed Litoral)
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
qt_titulo_aberto_w		bigint;
qt_titulos_w			bigint;
qt_titulos_liq_atrasado_w	bigint := 0;
ano_anterior_w			varchar(10);
ds_mensagem_quitacao_w		varchar(600);
dt_liquidacao_total_w		timestamp;


BEGIN

ano_anterior_w	:=	to_char( dt_referencia_mens_p , 'YYYY') -1;

-- Select que verifica se existe títulos pendentes de liquidação e em situação 'aberto' para a PF ou PJ.
select	count(1)
into STRICT	qt_titulo_aberto_w

where	exists (SELECT	1
		from	titulo_receber  b,
			pls_mensalidade a
		where	b.nr_seq_mensalidade	= 	a.nr_sequencia
		and (b.cd_pessoa_fisica	=	cd_pessoa_fisica_p
		or	b.cd_cgc		= 	cd_cgc_p)
		and 	b.ie_situacao 		= 	'1'
		and 	to_char(a.dt_referencia , 'YYYY') = ano_anterior_w
		and	to_char(b.dt_pagamento_previsto, 'YYYY') = ano_anterior_w
		and	coalesce(b.dt_liquidacao::text, '') = '');

--Select que verifica se existe títulos para a PF ou PJ no ano anterior.
select	count(1)
into STRICT	qt_titulos_w

where	exists (SELECT	1
		from	titulo_receber  b,
			pls_mensalidade a
		where	b.nr_seq_mensalidade 	= 	a.nr_sequencia
		and (b.cd_pessoa_fisica	=	cd_pessoa_fisica_p
		or	b.cd_cgc		= 	cd_cgc_p)
		and 	b.ie_situacao 		=	'2'
		and 	to_char(a.dt_referencia , 'YYYY') = ano_anterior_w
		and	to_char(b.dt_pagamento_previsto, 'YYYY') = ano_anterior_w);

if (to_char(dt_referencia_mens_p , 'mm') >= '05') then
	--Select que verifica se existe títulos para PF ou PJ pagos com atraso fora do ano de referencia do título.
	select	count(1)
	into STRICT	qt_titulos_liq_atrasado_w
	
	where	exists (SELECT	1
			from	titulo_receber  b,
				pls_mensalidade a
			where	b.nr_seq_mensalidade 	= 	a.nr_sequencia
			and (b.cd_pessoa_fisica	=	cd_pessoa_fisica_p
			or	b.cd_cgc		= 	cd_cgc_p)
			and 	b.ie_situacao 		= 	'2'
			and 	to_char(a.dt_referencia , 'YYYY') = ano_anterior_w
			and	to_char(b.dt_pagamento_previsto, 'YYYY') = ano_anterior_w
			and	to_char(b.dt_liquidacao, 'YYYY')  > ano_anterior_w);
end if;

--Select que pega a data de liquidação do título atrasado e coloca a mensagem no título do mês seguinte a liquidação.
select	max(b.dt_liquidacao)
into STRICT	dt_liquidacao_total_w
from	titulo_receber  b,
	pls_mensalidade a
where	b.nr_seq_mensalidade	= 	a.nr_sequencia
and (b.cd_pessoa_fisica	=	cd_pessoa_fisica_p
or	b.cd_cgc		= 	cd_cgc_p)
and 	to_char(a.dt_referencia , 'YYYY') = ano_anterior_w
and	to_char(b.dt_pagamento_previsto, 'YYYY') = ano_anterior_w
and 	b.ie_situacao 		= 	'2'
and	to_char(b.dt_liquidacao,'YYYY') >= to_char(dt_referencia_mens_p , 'YYYY');

--if para verificar quando a mensagem será impressa no título. Se todos os título do ano anterior
--da PF ou PJ estiverem liquidados no mesmo ano a mensagem será impressa no título do mês de maio do ano seguinte
--se os títulos do ano anterior não estiverem todos quitados e forem quitados no ano seguinte a mensagem será impressa no título seguinte a quitação total.
if (qt_titulo_aberto_w = 0) and (qt_titulos_w > 0) and
	(((qt_titulos_liq_atrasado_w >= 0) and (coalesce(dt_liquidacao_total_w, dt_referencia_mens_p) <= dt_referencia_mens_p)  and (to_char(dt_referencia_mens_p , 'mm') = '05')) or
	((qt_titulos_liq_atrasado_w > 0) and (to_char(dt_referencia_mens_p , 'mm') > '05') and (to_char(dt_liquidacao_total_w, 'mm') + 1 = to_char(dt_referencia_mens_p, 'mm')))) then

	ds_mensagem_quitacao_w	:=	'Em cumprimento a lei 12.007 de 29 de julho de 2009,' || chr(13) ||
					'declaramos para os devidos fins a QUITAÇÃO ANUAL DE' || chr(13) ||
					'DÉBITO, cumpre-nos informar que esta declaração substitui' || chr(13) ||
					'os comprovantes de pagamento referente ao ano de' || chr(13) ||
					ano_anterior_w||' e anteriores.';

end if;

return	ds_mensagem_quitacao_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_mensagem_quitacao_anual ( cd_pessoa_fisica_p text, dt_referencia_mens_p timestamp, cd_cgc_p text) FROM PUBLIC;

