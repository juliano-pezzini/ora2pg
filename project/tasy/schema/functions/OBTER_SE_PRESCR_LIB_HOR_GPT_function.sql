-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_prescr_lib_hor_gpt ( nr_prescricao_p prescr_medica.nr_prescricao%type) RETURNS varchar AS $body$
DECLARE

	ie_lib_hor_w	varchar(1);
	ie_item_existe_w		varchar(1);
	qt_hor_w		bigint;
	qt_lib_hor_w	bigint;
	
	procedure obter(index_p bigint) is
	;
BEGIN
		case(index_p)
			when 1 then	select	coalesce(max('S'),'N'),
								sum(1),
								sum(CASE WHEN coalesce(dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
						into STRICT	ie_item_existe_w,
								qt_hor_w,
								qt_lib_hor_w
						FROM prescr_material b
LEFT OUTER JOIN prescr_mat_hor c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_seq_material)
WHERE b.nr_prescricao = nr_prescricao_p and coalesce(b.dt_suspensao::text, '') = '';
			when 2 then	select	coalesce(max('S'),'N'),
								sum(CASE WHEN coalesce(c.dt_horario::text, '') = '' THEN  null  ELSE 1 END ),
								sum(CASE WHEN coalesce(dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
						into STRICT	ie_item_existe_w,
								qt_hor_w,
								qt_lib_hor_w
						FROM prescr_procedimento b
LEFT OUTER JOIN prescr_proc_hor c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_seq_procedimento)
WHERE b.nr_prescricao = nr_prescricao_p and coalesce(b.dt_suspensao::text, '') = '';
			when 3 then	select	coalesce(max('S'),'N'),
								sum(1),
								sum(CASE WHEN coalesce(dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
						into STRICT	ie_item_existe_w,
								qt_hor_w,
								qt_lib_hor_w
						FROM prescr_recomendacao b
LEFT OUTER JOIN prescr_rec_hor c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_seq_recomendacao)
WHERE b.nr_prescricao = nr_prescricao_p and coalesce(b.dt_suspensao::text, '') = '';
			when 4 then	select	coalesce(max('S'),'N'),
								sum(1),
								sum(CASE WHEN coalesce(dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
						into STRICT	ie_item_existe_w,
								qt_hor_w,
								qt_lib_hor_w
						FROM prescr_dieta b
LEFT OUTER JOIN prescr_dieta_hor c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_seq_dieta)
WHERE b.nr_prescricao = nr_prescricao_p and coalesce(b.dt_suspensao::text, '') = '';
			when 5 then	select	coalesce(max('S'),'N'),
								sum(1),
								sum(CASE WHEN coalesce(dt_lib_horario::text, '') = '' THEN  0  ELSE 1 END )
						into STRICT	ie_item_existe_w,
								qt_hor_w,
								qt_lib_hor_w
						FROM prescr_gasoterapia b
LEFT OUTER JOIN prescr_gasoterapia_hor c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_seq_gasoterapia)
WHERE b.nr_prescricao = nr_prescricao_p and coalesce(b.dt_suspensao::text, '') = '';
		end case;		
	end;
	
begin
	ie_item_existe_w := 'N';
	
	if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
		<<itens_loop>>
		for i in 1..5
		loop
			if ((ie_item_existe_w = 'N') or (ie_lib_hor_w = 'S')) then
				obter(i);
	
				if (ie_item_existe_w = 'S') then
					if (qt_hor_w = qt_lib_hor_w) then
						ie_lib_hor_w := 'S';
					else
						ie_lib_hor_w := 'N';
					end if;
				end if;
			end if;
			
			exit itens_loop when(ie_item_existe_w = 'S' and ie_lib_hor_w = 'N');
		end loop itens_loop;
		
		if ((ie_lib_hor_w = 'S') or (coalesce(ie_lib_hor_w::text, '') = '')) then
			-- NPTA, NPTI e Jejum
			select	coalesce(CASE WHEN sum(qt_item)=sum(qt_lib_item) THEN  'S'  ELSE 'N' END , ie_lib_hor_w)
			into STRICT	ie_lib_hor_w
			from (
				SELECT	sum(1) qt_item,
						sum(CASE WHEN obter_se_item_lib_hor_gpt(cpoe_obter_tipo_item('CPOE_DIETA',a.nr_seq_npt_cpoe),a.nr_seq_npt_cpoe)='S' THEN  1  ELSE 0 END ) qt_lib_item
				from	nut_pac a
				where	a.nr_prescricao = nr_prescricao_p
				and     coalesce(a.dt_suspensao::text, '') = ''
				and 	(a.nr_seq_npt_cpoe IS NOT NULL AND a.nr_seq_npt_cpoe::text <> '')
				
union all

				SELECT	sum(1) qt_item,
						sum(CASE WHEN obter_se_item_lib_hor_gpt(cpoe_obter_tipo_item('CPOE_DIETA',a.nr_seq_dieta_cpoe),a.nr_seq_dieta_cpoe)='S' THEN  1  ELSE 0 END ) qt_lib_item
				from	rep_jejum a
				where	a.nr_prescricao = nr_prescricao_p
				and 	(a.nr_seq_dieta_cpoe IS NOT NULL AND a.nr_seq_dieta_cpoe::text <> '')	
			) alias18;
		end if;
	end if;

	return coalesce(ie_lib_hor_w,'N');
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_prescr_lib_hor_gpt ( nr_prescricao_p prescr_medica.nr_prescricao%type) FROM PUBLIC;

