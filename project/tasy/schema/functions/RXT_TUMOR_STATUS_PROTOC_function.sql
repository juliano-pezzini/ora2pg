-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION rxt_tumor_status_protoc ( nr_seq_tumor_p rxt_tumor.nr_sequencia%type, vl_dominio_p valor_dominio.vl_dominio%type, sizeparams_p bigint ) RETURNS varchar AS $body$
DECLARE


  vl_dominio_w_table   dbms_sql.varchar2_table;
  nr_count_w           smallint;
  vl_dominio_w         varchar(10);
  i                    smallint;
  ds_return_w          varchar(10);

BEGIN
  vl_dominio_w_table := string_to_table_varchar(vl_dominio_p, ',');

  for i in 1..vl_dominio_w_table.count loop
    vl_dominio_w := vl_dominio_w_table(i);
    case( vl_dominio_w )
    -- Cancelado
      when 'C' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and (dt_suspensao IS NOT NULL AND dt_suspensao::text <> '');

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Interrompido
      when 'I' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and (dt_cancelamento IS NOT NULL AND dt_cancelamento::text <> '');

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Finalizado
      when 'F' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_finalizado(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Liberado
      when 'L' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Aguardando autorizacao
      when 'AA' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from  rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_ag_autorizacao(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Pendente agendamento de simulacao
      when 'PAS' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_pend_agend_simu(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Pendente simulacao
      when 'PS' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from
          rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_pend_simu(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Pendente de imagens
      when 'PI' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_pend_imagens(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Pendente prescricao medica
      when 'PPM' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_pend_prescr_med(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Aguardando planejamento do fisico
      when 'APF' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_ag_prim_fisico(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Aguardando aprovacao do medico
      when 'AAM' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_ag_aprov_med(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Aguardando planejamento do segundo fisico
      when 'APSF' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from
          rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_ag_seg_fisico(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Pendente checagem experimental (QA)
      when 'PCE' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_pend_qa(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Pendente elaboracao da ficha tecnica
      when 'PEFT' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_pend_ficha(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;

    -- Pendente customizacao do bloco
      when 'PCB' then
        select count(nr_sequencia)
        into STRICT nr_count_w
        from rxt_tratamento
        where nr_seq_tumor = nr_seq_tumor_p
        and rxt_tratamento_pend_bloco(nr_sequencia) = 'S';

        if ( nr_count_w > 0 ) then
          ds_return_w := 'S';
        else
          ds_return_w := 'N';
        end if;
    end case;

    if ds_return_w = 'S' then
      return ds_return_w;
    end if;
  end loop;

  return ds_return_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION rxt_tumor_status_protoc ( nr_seq_tumor_p rxt_tumor.nr_sequencia%type, vl_dominio_p valor_dominio.vl_dominio%type, sizeparams_p bigint ) FROM PUBLIC;

