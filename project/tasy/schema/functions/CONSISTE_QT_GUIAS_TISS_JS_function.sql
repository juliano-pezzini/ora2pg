-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_qt_guias_tiss_js ( cd_convenio_p bigint, cd_estabelecimento_p bigint, nr_inteno_conta_p bigint, nr_seq_protocolo_p bigint) RETURNS varchar AS $body$
DECLARE

 
ie_retorno_w		varchar(1);
qt_guias_permitidas_w	bigint;
qt_guias_protocolo_w 	bigint;
qt_guias_conta_w   	bigint;
				

BEGIN 
 
ie_retorno_w	:= 'S';
 
select 	coalesce(max(qt_guias_protocolo),0) 
into STRICT	qt_guias_permitidas_w 
from 	tiss_parametros_convenio 
where 	cd_convenio 		= cd_convenio_p 
and  	cd_estabelecimento 	= cd_estabelecimento_p;
 
if (qt_guias_permitidas_w > 0)then 
	begin 
	 
	qt_guias_protocolo_w	:= 0;
	qt_guias_conta_w	:= 0;
	 
	select 	count(*) 
	into STRICT	qt_guias_conta_w 
	from  	tiss_conta_guia a 
	where 	a.nr_interno_conta = nr_inteno_conta_p;
	 
	select 	count(*) 
	into STRICT	qt_guias_protocolo_w 
	from  	conta_paciente c, 
		tiss_conta_guia a 
	where 	c.nr_interno_conta 	= a.nr_interno_conta 
	and  	c.nr_seq_protocolo	= nr_seq_protocolo_p;
	 
	if	((qt_guias_protocolo_w + qt_guias_conta_w) > qt_guias_permitidas_w)then 
		begin 
		 
		ie_retorno_w	:= 'N';
		 
		end;
	end if;
	 
	end;
end if;
 
return	ie_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_qt_guias_tiss_js ( cd_convenio_p bigint, cd_estabelecimento_p bigint, nr_inteno_conta_p bigint, nr_seq_protocolo_p bigint) FROM PUBLIC;

