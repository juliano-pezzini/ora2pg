-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_tabname_histrotina ( ds_default_name_p text, nr_seq_schematic_object_p bigint, cd_establishment_p bigint, cd_profile_p bigint, nm_user_p text, nr_seq_pasta_p bigint) RETURNS varchar AS $body$
DECLARE

		
ds_return_w			obj_schem_estab.ds_cliente%type;
nr_seq_schematic_obj_param_w	objeto_schematic_param.nr_sequencia%type;

c_schematic_object_params CURSOR FOR
	SELECT	a.nr_sequencia
	from	objeto_schematic_param a
	where	a.nr_seq_obj_sch = nr_seq_schematic_object_p;

BEGIN

for r_c_schematic_object_params in c_schematic_object_params loop
	nr_seq_schematic_obj_param_w := r_c_schematic_object_params.nr_sequencia;
end loop;

select 	max(ds_cliente)
into STRICT	ds_return_w
from	obj_schem_usuario a
where	a.nr_seq_obj_schem_param = nr_seq_schematic_obj_param_w
and	coalesce(a.cd_estabelecimento, cd_establishment_p) = cd_establishment_p
and	a.nm_usuario_param = nm_user_p;

if (coalesce(ds_return_w::text, '') = '') then
	select 	max(ds_cliente)
	into STRICT	ds_return_w
	from	obj_schem_perfil a
	where	a.nr_seq_obj_schem_param = nr_seq_schematic_obj_param_w
	and	coalesce(a.cd_estabelecimento, cd_establishment_p) = cd_establishment_p
	and	a.cd_perfil = cd_profile_p;

	if (coalesce(ds_return_w::text, '') = '') then 	
		select 	max(ds_cliente)
		into STRICT	ds_return_w
		from	obj_schem_estab a
		where	a.nr_seq_obj_schem_param = nr_seq_schematic_obj_param_w
		and	a.cd_estabelecimento = cd_establishment_p;

		if (coalesce(ds_return_w::text, '') = '') then    
			select 	max(ds_cliente)
			into STRICT	ds_return_w
			from	obj_schem_order_usuario a, obj_schem_order b
			where	a.NR_SEQ_REGRA = b.NR_SEQUENCIA 
			and 	b.NR_SEQ_OBJ_SCHEMATIC = nr_seq_schematic_object_p
			and	a.NM_USUARIO_REGRA = nm_user_p;
	
			if (coalesce(ds_return_w::text, '') = '') then 
				select 	max(ds_cliente)
				into STRICT	ds_return_w
				from	obj_schem_order_perfil a, obj_schem_order b
				where	a.NR_SEQ_REGRA = b.NR_SEQUENCIA 
				and	b.NR_SEQ_OBJ_SCHEMATIC = nr_seq_schematic_object_p
				and	a.cd_perfil = cd_profile_p;
	
				if (coalesce(ds_return_w::text, '') = '') then	
					select 	max(ds_cliente)
					into STRICT	ds_return_w
					from	obj_schem_order_estab a, obj_schem_order b
					where	a.NR_SEQ_REGRA = b.NR_SEQUENCIA 
					and	b.NR_SEQ_OBJ_SCHEMATIC = nr_seq_schematic_object_p
					and	a.cd_estabelecimento = cd_establishment_p;
		
					if (coalesce(ds_return_w::text, '') = '' AND (nr_seq_pasta_p IS NOT NULL AND nr_seq_pasta_p::text <> '')) then	  
						select  max(coalesce(c.ds_pasta_instituicao, b.ds_caption_instituicao))
						into STRICT	ds_return_w
						from  	perfil_item_pront d,
							perfil_item_pront_pasta c,
							prontuario_item_pasta b,
							prontuario_pasta a
						where  	a.nr_sequencia = b.nr_seq_pasta
						and    	b.nr_sequencia = c.nr_seq_item_pasta
						and	d.nr_sequencia = c.nr_seq_item_perfil
						and	d.cd_perfil    = cd_profile_p
						and	b.nr_seq_pasta = nr_seq_pasta_p;	
					end if;
				end if;
			end if;
		end if;
	end if;
end if;

if (coalesce(ds_return_w::text, '') = '') then
	ds_return_w := ds_default_name_p;
end if;

return ds_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_tabname_histrotina ( ds_default_name_p text, nr_seq_schematic_object_p bigint, cd_establishment_p bigint, cd_profile_p bigint, nm_user_p text, nr_seq_pasta_p bigint) FROM PUBLIC;

