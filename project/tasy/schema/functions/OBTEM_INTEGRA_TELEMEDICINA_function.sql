-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obtem_integra_telemedicina (NR_SEQ_AGECONS_P integer, IE_ACAO_P text) RETURNS varchar AS $body$
DECLARE


IE_UTILIZA_TELEMEDICINA_W AGENDA_CLASSIF.IE_UTILIZA_TELEMEDICINA%TYPE;
IE_INTEGRA_TELEMEDICINA_W varchar(5) := 'N';


BEGIN
if (obter_se_util_integra(coalesce(wheb_usuario_pck.get_cd_estabelecimento,1), 'TELE') = 'S') then
   SELECT coalesce(MAX(B.IE_UTILIZA_TELEMEDICINA),'N')  IE_UTILIZA_TELEMEDICINA
   into STRICT IE_UTILIZA_TELEMEDICINA_W
   FROM AGENDA_CONSULTA A 
   INNER JOIN AGENDA_CLASSIF B ON A.IE_CLASSIF_AGENDA = B.CD_CLASSIFICACAO
    WHERE A.NR_SEQUENCIA = NR_SEQ_AGECONS_P
	AND (IE_STATUS_AGENDA NOT IN ('L','LF','B','F','I','R','C'));

    IF (IE_UTILIZA_TELEMEDICINA_W = 'S') THEN 
      
      IF (IE_ACAO_P = 'A') THEN
          SELECT (CASE WHEN (MAX(DS_URL_TELEMEDICINA) IS NOT NULL AND (MAX(DS_URL_TELEMEDICINA))::text <> '') THEN 'N' ELSE 'S' END) IE_INTEGRA_TELEMEDICINA
          INTO STRICT IE_INTEGRA_TELEMEDICINA_W
          FROM AGENDA_CONSULTA_ADIC A
          WHERE A.NR_SEQ_AGENDA = NR_SEQ_AGECONS_P;
      else
	  IE_INTEGRA_TELEMEDICINA_W := 'S';
      END IF;
    END IF;
end if;

  RETURN IE_INTEGRA_TELEMEDICINA_W;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obtem_integra_telemedicina (NR_SEQ_AGECONS_P integer, IE_ACAO_P text) FROM PUBLIC;

