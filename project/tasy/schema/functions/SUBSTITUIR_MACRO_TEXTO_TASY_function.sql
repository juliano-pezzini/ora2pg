-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION substituir_macro_texto_tasy (ds_macro_p text, nm_atributo_p text, vl_atributo_p text) RETURNS varchar AS $body$
DECLARE


ds_format_date_w        varchar(50)    := null;
ds_resultado_w			varchar(2000)  := null;
ds_checkup_w			varchar(1000)  := null;
qt_idade_w			varchar(20);
dt_nascimento_w			timestamp;
nm_paciente_w			varchar(80);
dt_sistema_w			timestamp;
ie_artigo_w			varchar(01);
cd_cid_w				varchar(10);
ds_doenca_w			varchar(2000);
cd_doenca_w			varchar(2000);
cd_pessoa_fisica_w		varchar(10);
dt_atual_w			timestamp;
dt_cirurgia_w			timestamp;
ds_doenca_prev_w			varchar(80);
nr_prescricao_w			bigint;
ds_procedimento_w			varchar(255);
ds_material_w			varchar(255);
ds_agente_w			varchar(255);
ds_medicamento_w			varchar(255);
ds_solucao_w			varchar(255);
ds_exames_w			varchar(255);
ds_dispositivo_w			varchar(255);
ie_exige_liberacao_w		varchar(3);
ds_medic_uso_w			varchar(2000);
ds_agente_alerg_w			varchar(2000);
ds_tipo_reacao_w			varchar(2000);
ds_observacao_w			varchar(2000);
ie_confirmacao_w			varchar(3);
ds_material_autor_w		varchar(255);
nr_seq_exame_w			bigint;
qt_result_w			double precision;
pr_result_w			double precision;
ds_sql_macro_w			varchar(1000);
nr_seq_proc_w			bigint;
ds_result_aux			varchar(2000);
nr_seq_solucao_w			bigint;
nr_sequencia_w			bigint;
nr_seq_person_name_w	bigint;
ie_via_aplicacao_w			varchar(5);
ds_result_data_w		timestamp;
nr_seq_segurado_w		bigint;
nr_seq_prescricao_w		bigint;
cd_pessoa_fisica_oft_w		varchar(10);
data_exame_w			timestamp;
dt_diagnostico_w		timestamp;
qt_periodo_orien_alta_w		bigint;
ie_periodo_orien_alta_w		varchar(10);
ds_proced_externo_w        varchar(350);
ds_proced_prescrito_w        varchar(350);
ie_paciente_biobanco_w		varchar(100);
nm_prim_medico_w		varchar(255);
nm_medico_w			varchar(255);

nr_seq_pe_prescricao_w		bigint;
nm_prescritor_pe_prescr_w	varchar(255);
dt_pe_prescricao		timestamp;
ds_pe_diagnostico_w		varchar(255);
ds_pe_evolucao_diag_w		varchar(255);
nr_pe_seq_diag_w		bigint;

nr_dia_w                        bigint;
ie_refracao_lib_w		varchar(1) := 'N';
ds_obervacao_atend_w    varchar(255);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ie_tipo_w			smallint;

nr_cirurgia_w			bigint;
ds_resumo_cirurgia_w		varchar(2000);
ds_diagnostico_w		varchar(2000);
ds_diagnostico_pos_w		varchar(2000);
ds_agente_terapia_w     varchar(255);
nr_case_w				bigint;
ds_cid_doenca_w			varchar(255);
ds_info_adic_diag_w		varchar(255);

ie_tipo_complemento_w	constant compl_pessoa_fisica.ie_tipo_complemento%TYPE := 2;
ie_descricao_w			constant varchar(2) := 'EC';

ds_macro_w		varchar(50);

C01 CURSOR FOR
SELECT	distinct(substr(obter_nome_pf(cd_medico),1,60))
from	evolucao_paciente
where	nr_atendimento		= vl_atributo_p
and	ie_evolucao_clinica	= 'AE';

c02 CURSOR FOR
SELECT	CASE WHEN pkg_i18n.get_user_locale='ja_JP' THEN get_desc_modify_disease_epc(nr_seq_disease_number,ie_side_modifier,nr_seq_jap_pref_1,nr_seq_jap_pref_2,nr_seq_jap_pref_3, nr_seq_jap_sufi_1,nr_seq_jap_sufi_2,nr_seq_jap_sufi_3,nr_seq_interno)  ELSE PERFORM obter_desc_cid_doenca(cd_doenca) END
from	diagnostico_doenca
where	nr_atendimento = vl_atributo_p
and	coalesce(ie_situacao,'A') = 'A';

c03 CURSOR FOR
SELECT	cd_doenca
from	diagnostico_doenca
where	nr_atendimento = vl_atributo_p
and	coalesce(ie_situacao,'A') = 'A';

c04 CURSOR FOR
SELECT	distinct CASE WHEN pkg_i18n.get_user_locale='ja_JP' THEN get_desc_modify_disease_epc(a.nr_seq_disease_number,a.ie_side_modifier,a.nr_seq_jap_pref_1,a.nr_seq_jap_pref_2,a.nr_seq_jap_pref_3,a.nr_seq_jap_sufi_1,a.nr_seq_jap_sufi_2,a.nr_seq_jap_sufi_3,a.nr_seq_interno)  ELSE PERFORM obter_desc_cid_doenca(cd_doenca) END
from	diagnostico_doenca a,
	atendimento_paciente b
where	a.nr_atendimento	=	b.nr_atendimento
and	b.cd_pessoa_fisica	=	vl_atributo_p;

c05 CURSOR FOR
	SELECT	substr(coalesce(substr(obter_desc_pe_doenca(NR_SEQ_DOENCA),1,80),DS_DOENCA),1,80)
	from	paciente_antec_clinico
	where	cd_pessoa_fisica	= vl_atributo_p
	and	coalesce(dt_inativacao::text, '') = ''
	and	coalesce(dt_fim::text, '') = ''
	and	((DS_DOENCA IS NOT NULL AND DS_DOENCA::text <> '') or (NR_SEQ_DOENCA IS NOT NULL AND NR_SEQ_DOENCA::text <> '') or (CD_DOENCA IS NOT NULL AND CD_DOENCA::text <> ''));

c06 CURSOR FOR
	SELECT	substr(obter_descricao_padrao('DISPOSITIVO','DS_DISPOSITIVO',NR_SEQ_DISPOSITIVO),1,100) || ' - ' ||
			substr(wheb_mensagem_pck.get_texto(307298) || ': ' || coalesce(qt_tentativas,0),1,50) -- Tentativas
	from   	atend_pac_dispositivo
	where  	nr_cirurgia = vl_atributo_p;

c07 CURSOR FOR
	SELECT 	substr(obter_desc_agente(nr_seq_agente),1,40)
	from   	cirurgia_agente_anestesico
	where  	ie_tipo = 4
	and    	nr_cirurgia = vl_atributo_p
	and	coalesce(ie_situacao,'A') = 'A';

c40 CURSOR FOR
  SELECT substr(obter_desc_prescr_proc(cd_procedimento, ie_origem_proced, nr_seq_proc_interno),1,240) ds_proc_adic
  from agenda_paciente_proc
  where nr_sequencia = CASE WHEN vl_atributo_p=0 THEN NULL  ELSE vl_atributo_p END;

c08 CURSOR FOR
	SELECT 	substr(obter_exame_agenda(cd_procedimento_princ, ie_origem_proced, nr_seq_proc_interno),1,240),
		1 ie_tipo
	from   	cirurgia
	where  	nr_cirurgia = vl_atributo_p
	
union

	SELECT 	substr(obter_desc_prescr_proc(a.cd_procedimento,a.ie_origem_proced, a.nr_seq_proc_interno),1,240),
		2 ie_tipo
	from   	prescr_procedimento a,
		cirurgia b
	where  	a.nr_prescricao = b.nr_prescricao
	and	b.nr_cirurgia 	= vl_atributo_p
	and	not exists (	select 	1
				from 	cirurgia x
				where	x.nr_cirurgia 		= vl_atributo_p
				and	x.cd_procedimento_princ	= a.cd_procedimento
				and	x.ie_origem_proced	= a.ie_origem_proced)
	order by 2;

c08_cod_procedimento CURSOR FOR
	SELECT 	substr(cd_procedimento_princ,1,240) cd_procedimento_w,
		1 ie_tipo_w
	from   	cirurgia
	where  	nr_cirurgia = vl_atributo_p
	
union

	SELECT 	substr(a.cd_procedimento,1,240) cd_procedimento_w,
		2 ie_tipo_w
	from   	prescr_procedimento a,
		cirurgia b
	where  	a.nr_prescricao = b.nr_prescricao
	and	b.nr_cirurgia 	= vl_atributo_p
	and	not exists (	select 	1
				from 	cirurgia x
				where	x.nr_cirurgia 		= vl_atributo_p
				and	x.cd_procedimento_princ	= a.cd_procedimento
				and	x.ie_origem_proced	= a.ie_origem_proced)
	order by 2;

c09 CURSOR FOR
SELECT substr(obter_desc_agente(nr_seq_agente),1,40)
from   cirurgia_agente_anestesico
where  ie_tipo = 1
and    nr_cirurgia = vl_atributo_p
and	coalesce(ie_situacao,'A') = 'A';

c10 CURSOR FOR
SELECT substr(obter_desc_agente(nr_seq_agente),1,40)
from   cirurgia_agente_anestesico
where  ie_tipo = 3
and    nr_cirurgia = vl_atributo_p
and	coalesce(ie_situacao,'A') = 'A';

C11 CURSOR FOR
	SELECT	distinct cd_doenca_cid ||' - ' ||
		obter_desc_cid_doenca(cd_doenca_cid)
	from	can_loco_regional
	where	cd_pessoa_fisica	= vl_atributo_p
	and	(cd_doenca_cid IS NOT NULL AND cd_doenca_cid::text <> '')
	and	coalesce(dt_inativacao::text, '') = '';

c12 CURSOR FOR
	SELECT	coalesce(a.ds_medicamento,substr(obter_desc_material(a.cd_material),1,100))
	from	paciente_medic_uso a,
		hist_saude_reconciliacao b
	where	b.nr_seq_pac_hist = a.nr_sequencia
	and	b.nr_atendimento = vl_atributo_p
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.dt_inativacao::text, '') = ''
	and	coalesce(a.dt_fim::text, '') = '';

c13 CURSOR FOR
	SELECT	coalesce(coalesce(coalesce(coalesce(coalesce(coalesce(obter_estrut_princ_ativo(nr_seq_ficha_tecnica),obter_desc_dcb(nr_seq_dcb)),obter_desc_dcb_mat(cd_material,'D')),obter_desc_material(cd_material)),obter_desc_classe_mat(cd_classe_mat)),ds_medic_nao_cad),CASE WHEN ie_nega_alergias='N' THEN substr(obter_desc_alergeno(nr_seq_tipo),1,80)  ELSE wheb_mensagem_pck.get_texto(307297) END ) ds_agente_alerg, -- Paciente nega alergias
		obter_desc_reacao_alergica(nr_seq_reacao) ds_reacao_alerg,
		ds_observacao,
		ie_confirmacao
	from	paciente_alergia a
	where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	coalesce(dt_inativacao::text, '') = ''
	and	((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim + 86399/86400))
	and	cd_pessoa_fisica = vl_atributo_p
	order by	ds_agente_alerg,
			ds_reacao_alerg;

c14 CURSOR FOR
	SELECT	c.ds_material ds_material, max(coalesce(a.NR_DIA_UTIL,0)) nr_dia
	from	material c,
		prescr_material a,
		prescr_medica b
	where	a.nr_prescricao = b.nr_prescricao
	and	a.cd_material = c.cd_material
	and	b.nr_atendimento = vl_atributo_p
	and	c.ie_controle_medico <> 0
	and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and	coalesce(b.dt_suspensao::text, '') = ''
	group by c.ds_material
	order by ds_material;

c15 CURSOR FOR
	SELECT	wheb_mensagem_pck.get_texto(307294) || ': ' || substr(obter_desc_material(b.cd_material),1,255) || ' ' || wheb_mensagem_pck.get_texto(307296) || ':' || b.qt_material  -- Material		Qtdade
	from	autorizacao_cirurgia a,
		material_autor_cirurgia b
	where	b.nr_seq_autorizacao = a.nr_sequencia
	and	a.nr_atendimento = vl_atributo_p;

c16 CURSOR FOR
	SELECT	distinct substr(obter_descricao_mat_prescr(b.cd_material),1,80)
	from	prescr_medica a,
		prescr_material b
	where	b.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = vl_atributo_p
	and	clock_timestamp() between a.dt_inicio_prescr and a.dt_validade_prescr
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	b.ie_agrupador = 1
	and	((a.ie_funcao_prescritor = 1) or (a.ie_prescr_farm = 'S'));

c17 CURSOR FOR
	SELECT	distinct substr(obter_descricao_mat_prescr(b.cd_material),1,80)
	from	prescr_medica a,
		prescr_material b
	where	b.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = vl_atributo_p
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	b.ie_agrupador = 1
	and	((a.ie_funcao_prescritor = 1) or (a.ie_prescr_farm = 'S'));

c18 CURSOR FOR
	SELECT 	b.qt_resultado,
		b.pr_resultado
	from 	exame_lab_result_item b,
		exame_lab_resultado a,
		prescr_procedimento x,
		prescr_medica c
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	a.nr_prescricao		= c.nr_prescricao
	and	x.nr_sequencia		= b.nr_seq_prescr
	and	x.nr_prescricao		= c.nr_prescricao
	and	b.nr_seq_exame		= nr_seq_exame_w
	and	c.nr_atendimento	= vl_atributo_p
	and	x.ie_status_atend	>= 35
	order by coalesce(b.dt_aprovacao,a.dt_resultado);

C19 CURSOR FOR
	SELECT  wheb_mensagem_pck.get_texto(307291) ||CHR(13)||CHR(10)||CHR(13)||CHR(10)|| -- Solucao
	        wheb_mensagem_pck.get_texto(307292) ||': '||b.qt_dosagem||'     '||b.ie_unid_vel_inf, -- Velocidade infusao
			nr_seq_solucao
	from    prescr_solucao b
	where   nr_prescricao  = nr_prescricao_w
	and		ie_hemodialise = 'S';

C20 CURSOR FOR
	SELECT  wheb_mensagem_pck.get_texto(307284, 'DS_PRODUTO=' || substr(obter_desc_material(c.cd_material),1,80) || ';' ||
												'DS_UNIDADE_MEDIDA=' || c.cd_unidade_medida_dose || ';' ||
												'QT_DOSE=' || c.qt_dose)
	from    prescr_material c
	where   c.nr_prescricao = nr_prescricao_w
	and     c.nr_sequencia_solucao = nr_seq_solucao_w
	and 	ie_agrupador = 13;

C21 CURSOR FOR
	SELECT 	substr(obter_desc_exame_lab(b.nr_seq_exame,null,null,null),1,80)||' '||wheb_mensagem_pck.get_texto(307281)||': '||coalesce(b.ds_resultado,b.qt_resultado) -- Resultado
	from 	exame_lab_result_item b,
		exame_lab_resultado a,
		prescr_procedimento x,
		prescr_medica c
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	a.nr_prescricao		= c.nr_prescricao
	and	x.nr_sequencia		= b.nr_seq_prescr
	and	x.nr_prescricao		= c.nr_prescricao
	and	c.nr_atendimento	= vl_atributo_p
	and	ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(a.dt_resultado) = ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(clock_timestamp())
	order by coalesce(b.dt_aprovacao,a.dt_resultado);

C22 CURSOR FOR
	SELECT  substr(obter_desc_expressao(299838) || ': '||substr(obter_valor_dominio(1472,b.ie_tipo_laudo_apac),1,80)||CHR(13)||CHR(10)||
		wheb_mensagem_pck.get_texto(307277) || ': '||substr(obter_descricao_procedimento(a.CD_PROCEDIMENTO, a.IE_ORIGEM_PROCED),1,240)||CHR(13)||CHR(10)|| -- Medicamento
		wheb_mensagem_pck.get_texto(307278) || ': '||obter_desc_intervalo(a.cd_intervalo_prescr)||chr(13)||chr(10)|| -- Intervalo
		wheb_mensagem_pck.get_texto(307279) || ': '||a.ds_posologia||chr(13)||chr(10)|| -- Posologia
		wheb_mensagem_pck.get_texto(307280) || ': '||Obter_Desc_via(a.ie_via_aplicacao),1,2000) -- Via aplicacao
	from    sus_laudo_medicamento a,
		sus_laudo_paciente b
	where   ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(b.dt_atualizacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(clock_timestamp())
	and     b.nr_atendimento = vl_atributo_p
	and     a.nr_seq_laudo_sus = b.nr_seq_interno;

c23 CURSOR FOR
   SELECT   distinct obter_desc_procedimento(b.cd_procedimento,b.ie_origem_proced)
   from     pedido_exame_externo a,
            pedido_exame_externo_item b
   where    b.nr_seq_pedido = a.nr_sequencia
   and      a.nr_atendimento = vl_atributo_p
   and      (b.cd_procedimento IS NOT NULL AND b.cd_procedimento::text <> '')
   and      (b.ie_origem_proced IS NOT NULL AND b.ie_origem_proced::text <> '')
   order    by 1;

c24 CURSOR FOR
   SELECT 	distinct obter_desc_procedimento(a.cd_procedimento,a.ie_origem_proced)
   from	   prescr_procedimento a,
            prescr_medica b
   where	   a.nr_prescricao = b.nr_prescricao
   and	   b.nr_atendimento = vl_atributo_p
   and      (a.cd_procedimento IS NOT NULL AND a.cd_procedimento::text <> '')
   and      (a.ie_origem_proced IS NOT NULL AND a.ie_origem_proced::text <> '')
   order    by 1;

C25 CURSOR FOR
	SELECT	x.ds_rotina
	from 	prescr_procedimento x,
		prescr_medica c
	where	x.nr_prescricao		= c.nr_prescricao
	and	c.nr_atendimento	= vl_atributo_p
	and	(x.nr_seq_exame IS NOT NULL AND x.nr_seq_exame::text <> '')
	and	coalesce(c.dt_suspensao::text, '') = ''
	and	coalesce(x.dt_suspensao::text, '') = ''
	and	ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(c.dt_prescricao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(clock_timestamp())
	order by 1;

C26 CURSOR FOR
	SELECT	distinct substr(Obter_Desc_Material_reduzido(b.cd_material),1,80) ds
	from	prescr_medica a,
		prescr_material b,
		prescr_mat_hor c
	where	b.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = vl_atributo_p
	and	b.nr_prescricao = c.nr_prescricao
	and	b.nr_sequencia = c.nr_seq_material
	and	c.nr_prescricao = a.nr_prescricao	
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	b.ie_agrupador = 1
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	and	obter_se_gerar_item_vipe('M',a.nr_prescricao,c.nr_seq_material,b.nr_agrupamento) = 'S'
	and	((coalesce(c.ie_situacao,'A') = 'A') or (coalesce(b.ie_administrar,'S') = 'N'))
	and	coalesce(c.ie_adep,'S') = 'S'
	
union

	SELECT 	distinct substr(coalesce(x.ds_solucao,obter_prim_comp_sol(a.nr_prescricao,x.nr_seq_solucao)),1,240) ds
	from	prescr_solucao x,
		prescr_medica a
	where	x.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = vl_atributo_p
	and	coalesce(x.nr_seq_dialise::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(x.dt_suspensao::text, '') = ''
	and	coalesce(x.ie_hemodialise,'N') = 'N'
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	order by	1;

C27 CURSOR FOR
	SELECT	a.ds_rotina
	from	prescr_procedimento a,
		prescr_medica b
	where	a.nr_prescricao = b.nr_prescricao
	and	b.nr_atendimento = vl_atributo_p
	and	(a.cd_procedimento IS NOT NULL AND a.cd_procedimento::text <> '')
	and	(a.ie_origem_proced IS NOT NULL AND a.ie_origem_proced::text <> '')
	and	coalesce(a.nr_seq_exame::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	order	by 1;

C28 CURSOR FOR
	SELECT	distinct substr(obter_descricao_mat_prescr(x.cd_material),1,80)
	from	prescr_material x,
		prescr_mat_hor c,
		prescr_medica a
	where	x.nr_prescricao = c.nr_prescricao
	and	x.nr_sequencia = c.nr_seq_material
	and	x.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = vl_atributo_p
	and	clock_timestamp() between a.dt_inicio_prescr and a.dt_validade_prescr
	and	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''))
	and	(c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> '')
	order	by 1;

C29 CURSOR FOR
	SELECT	distinct substr(coalesce(x.ds_solucao,obter_prim_comp_sol(a.nr_prescricao,x.nr_seq_solucao)),1,240)
	from	prescr_solucao x,
		prescr_mat_hor c,
		prescr_medica a
	where	x.nr_prescricao = c.nr_prescricao
	and	x.nr_seq_solucao = c.nr_seq_solucao
	and	x.nr_prescricao = a.nr_prescricao
	and	c.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = vl_atributo_p
	and	clock_timestamp() between a.dt_inicio_prescr and a.dt_validade_prescr
	and	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''))
	and	(c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> '')
	order	by 1;

C30 CURSOR FOR
	SELECT	distinct substr(adep_obter_desc_exame_lab(x.ie_acm,x.ie_se_necessario,z.nm_exame),1,240)
	from	exame_laboratorio z,
		procedimento y,
		prescr_procedimento x,
		prescr_proc_hor c,
		prescr_medica a
	where	z.nr_seq_exame = x.nr_seq_exame
	and	y.cd_procedimento = x.cd_procedimento
	and	y.ie_origem_proced = x.ie_origem_proced
	and	y.cd_procedimento = c.cd_procedimento
	and	y.ie_origem_proced = c.ie_origem_proced
	and	x.nr_prescricao = c.nr_prescricao
	and	x.nr_sequencia = c.nr_seq_procedimento
	and	x.nr_prescricao = a.nr_prescricao
	and	c.nr_prescricao = a.nr_prescricao
	and   	a.nr_atendimento = vl_atributo_p
	and	clock_timestamp() between a.dt_inicio_prescr and a.dt_validade_prescr
	and	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''))
	and	(c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> '')
	order	by 1;


c31 CURSOR FOR
	SELECT a.dt_prescricao,
	       a.nr_sequencia,
	       substr(obter_nome_pf(a.CD_PRESCRITOR),1,60)
	from   pe_prescricao a
	where  a.nr_atendimento = vl_atributo_p
	and    (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and    exists (	    SELECT 1
			    from pe_prescr_diag b
			    where a.nr_sequencia = b.nr_seq_prescr)
	order by dt_prescricao;


c32 CURSOR FOR
	SELECT	substr(pe_obter_desc_diag(nr_seq_diag,'DI'),1,120) ds,
		substr(obter_desc_sae_evolucao_diag(nr_seq_evolucao_diag),1,255),
		nr_seq_diag
	from	pe_prescr_diag
	where	nr_seq_prescr = nr_seq_pe_prescricao_w
	order by ds;
	
c34 CURSOR FOR
	SELECT 	substr(obter_desc_agente(nr_seq_agente),1,40)|| ' - ' ||substr(obter_desc_material(cd_material),1,80)
	from   	cirurgia_agente_anestesico
	where  	ie_tipo = 4
	and    	nr_cirurgia = vl_atributo_p
	and	coalesce(ie_situacao,'A') = 'A';

C35 CURSOR FOR
	SELECT	a.nr_cirurgia,
		substr(obter_exame_agenda(a.cd_procedimento_princ,a.ie_origem_proced,a.nr_seq_proc_interno),1,255),
		b.ds_resumo_cirurgia,
		b.ds_diagnostico,
		b.ds_diagnostico_pos
	from	cirurgia a,
		cirurgia_descricao b
	where	a.nr_cirurgia = b.nr_cirurgia
	and	a.nr_atendimento = vl_atributo_p
	order by a.dt_inicio_cirurgia desc;

c33 CURSOR FOR
	SELECT	coalesce(ds_medicamento,substr(obter_desc_material(cd_material),1,100))
	from	paciente_medic_uso
	where	nr_atendimento = vl_atributo_p
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	coalesce(dt_inativacao::text, '') = ''
	and	coalesce(dt_fim::text, '') = ''
	and	coalesce(ie_nega_medicamentos,'N') = 'N';

c36 CURSOR FOR
SELECT substr(obter_desc_agente(nr_seq_agente),1,40)
from   cirurgia_agente_anestesico
where  ie_tipo = 2
and    nr_cirurgia = vl_atributo_p
and	coalesce(ie_situacao,'A') = 'A';

c38 CURSOR FOR
	SELECT 	cd_doenca,
			cd_doenca||' - '|| substr(obter_desc_cid(CD_DOENCA),1,200)
	from 	diagnostico_doenca a,
			diag_doenca_inf_adic b
	where 	a.nr_seq_interno = nr_seq_diag_doenca
	and	  	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and	  	coalesce(a.dt_inativacao::text, '') = ''
	and	  	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
	and	  	coalesce(b.dt_inativacao::text, '') = ''
	and		(b.ds_titulo IS NOT NULL AND b.ds_titulo::text <> '')
	and 	coalesce(b.ie_revisado::text, '') = ''
	and (nr_atendimento in (	SELECT 	a.nr_atendimento 
									from 	atendimento_paciente a, 
											episodio_paciente b 
									where 	a.nr_Seq_episodio = b.nr_Sequencia 
									and 	b.nr_sequencia = nr_case_w)
	or nr_atendimento = vl_atributo_p)
	group by cd_doenca, cd_doenca||' - '|| substr(obter_desc_cid(CD_DOENCA),1,200);
								
c39 CURSOR FOR
	SELECT 	obter_desc_expressao(291926) || ': ' || ds_titulo
	from 	diag_doenca_inf_adic
	where 	nr_seq_diag_doenca in ( SELECT  a.nr_seq_interno
									from	diagnostico_doenca a,
											cid_doenca b
									where  	a.cd_doenca = b.cd_doenca_cid
									and     a.cd_doenca = cd_doenca_w
									and     obter_pessoa_atendimento(a.nr_atendimento,'C') = cd_pessoa_fisica_w)
	and	  	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	and	  	coalesce(dt_inativacao::text, '') = ''
	and 	coalesce(ie_revisado::text, '') = '';

c37 CURSOR FOR
	SELECT	coalesce(coalesce(coalesce(coalesce(coalesce(coalesce(obter_estrut_princ_ativo(nr_seq_ficha_tecnica),obter_desc_dcb(nr_seq_dcb)),obter_desc_dcb_mat(cd_material,'D')),obter_desc_material(cd_material)),obter_desc_classe_mat(cd_classe_mat)),ds_medic_nao_cad),CASE WHEN ie_nega_alergias='N' THEN substr(obter_desc_alergeno(nr_seq_tipo),1,80)  ELSE wheb_mensagem_pck.get_texto(307297) END ) ds_agente_alerg, -- Paciente nega alergias
		obter_desc_reacao_alergica(nr_seq_reacao) ds_reacao_alerg,
		ds_observacao,
		ie_confirmacao
	from	paciente_alergia a
	where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	coalesce(dt_inativacao::text, '') = ''
	and	((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim + 86399/86400))
	and	nr_atendimento = vl_atributo_p
	order by	ds_agente_alerg,
			ds_reacao_alerg;

	procedure gerar_result_macro_sql is
	;
BEGIN

	select	max(ds_sql)
	into STRICT	ds_sql_macro_w
	from	macro_prontuario
	where	upper(NM_MACRO)	= upper(ds_macro_p);

	ds_resultado_w	:= ' ';

	if (ds_sql_macro_w IS NOT NULL AND ds_sql_macro_w::text <> '') then
		begin
		if (nm_atributo_p	<> 'SISTEMA') then
			ds_resultado_w	:= substr(Obter_select_concatenado_bv(ds_sql_macro_w,'VL_ATRIBUTO='||vl_atributo_p||';',''),1,2000);
		else
			ds_resultado_w	:= substr(Obter_select_concatenado_bv(ds_sql_macro_w,'',''),1,2000);
		end if;

		end;
	end if;
	ds_resultado_w	:= coalesce(ds_resultado_w,' ');

        if (wheb_usuario_pck.get_cd_funcao = 9960) then
                begin
                ds_sql_macro_w  := ' ';

                select	max(ds_sql)
                into STRICT	ds_sql_macro_w
                from	carta_medica_macro
                where	upper(NM_MACRO)	   = upper(ds_macro_p)
                and     upper(NM_ATRIBUTO) = upper(nm_atributo_p);
                if (ds_sql_macro_w IS NOT NULL AND ds_sql_macro_w::text <> '') then
                        begin
                        if (nm_atributo_p	<> 'SISTEMA') then
                                ds_resultado_w	:= substr(Obter_select_concatenado_bv(ds_sql_macro_w,'VL_ATRIBUTO='||vl_atributo_p||';',''),1,2000);
                        else
                                ds_resultado_w	:= substr(Obter_select_concatenado_bv(ds_sql_macro_w,'',''),1,2000);
                        end if;
                        end;
                end if;
                ds_resultado_w	:= coalesce(ds_resultado_w,' ');

                end;
        end if;
	end;	
begin

if (obtain_user_locale(wheb_usuario_pck.get_nm_usuario) = 'de_DE')  then
    ds_format_date_w := 'shortDate';
end if;
ds_format_date_w := coalesce(ds_format_date_w, 'timestamp');

begin
	begin
		select ds_macro_philips
		into STRICT ds_macro_w
		from table(search_macros(null, ds_macro_p, null, 'R')) LIMIT 1;
	exception when others then
		ds_macro_w := ds_macro_p;
	end;
	ds_macro_w := upper(ds_macro_w);
if (nm_atributo_p		= 'CD_PESSOA_FISICA') then
	begin
	select	SUBSTR(OBTER_NOME_PF(CD_PESSOA_FISICA),0,80),
		dt_nascimento,
		cd_pessoa_fisica
	into STRICT	nm_paciente_w,
		dt_nascimento_w,
		cd_pessoa_fisica_w
	from	pessoa_fisica
	where	cd_pessoa_fisica	= vl_atributo_p;

	if (ds_macro_w	= '@NOME') then
		ds_resultado_w	:= nm_paciente_w;
	elsif (ds_macro_w	= '@ENDERECO') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'EC');
	elsif (ds_macro_w	= '@PFLEGEGRAD') then
		select  SUBSTR(obter_valor_dominio(8674,IE_PFLEGEGRAD),1,255)
		into STRICT	ds_resultado_w
		from    PACIENTE_PFLEGEGRAD
		where   cd_pessoa_fisica = vl_atributo_p
		and		nr_sequencia in (	SELECT 	max(nr_sequencia)
									from	PACIENTE_PFLEGEGRAD
									where   cd_pessoa_fisica = vl_atributo_p
									and     coalesce(IE_SITUACAO, 'A') = 'A'
									and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''));
	elsif (ds_macro_w	= '@END_SIMPLES_PAC') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'E');
	elsif (ds_macro_w	= '@RUA_PACIENTE') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'EN');
	elsif (ds_macro_w	= '@NUMERO_ENDERECO') then
		select 	max(ds_compl_end)
		into STRICT 	ds_resultado_w
		from 	compl_pessoa_fisica
		where 	cd_pessoa_fisica = cd_pessoa_fisica_w
		and   	ie_tipo_complemento = 1;
	elsif (ds_macro_w	= '@CIDADE_PAC') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'CI');
	elsif (ds_macro_w	= '@UF_PAC') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'UF');
	elsif (ds_macro_w	= '@FONE_PAC') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'T');
	elsif (ds_macro_w	= '@IDADE') then
		ds_resultado_w	:= obter_idade(dt_nascimento_w, clock_timestamp(), 'D');
	elsif (ds_macro_w	= '@IDADE_ANO_MES') then
		ds_resultado_w	:= obter_idade(dt_nascimento_w, clock_timestamp(), 'AM');
	elsif (ds_macro_w	= '@PRONOME') then
		ds_resultado_w	:= obter_pronome_pf(cd_pessoa_fisica_w, 'N');
	elsif (ds_macro_w = '@ARTIG_PRONOME') then
		ds_resultado_w	:= obter_pronome_pf(cd_pessoa_fisica_w, 'S');
	elsif (ds_macro_w	= '@NASCIMENTO') then
		ds_resultado_w	:= to_char(dt_nascimento_w, 'dd/mm/yyyy');
	elsif (ds_macro_w	= '@GIVEN_NAME') then
		if (person_name_enabled = 'S') then
			select 	max(nr_seq_person_name)
			into STRICT 	nr_seq_person_name_w
			from 	pessoa_fisica
			where 	cd_pessoa_fisica = cd_pessoa_fisica_w;

			select max(nm_pessoa_fisica)
			into STRICT ds_resultado_w
			from table(search_names_dev(null, null, nr_seq_person_name_w, 'givenName', 'social,main'));
		else
			ds_resultado_w	:= obter_nome_sobrenome_pessoa(cd_pessoa_fisica_w, 'P');
		end if;
	elsif (ds_macro_w	= '@FAMILY_NAME') then
		if (person_name_enabled = 'S') then
			select 	max(nr_seq_person_name)
			into STRICT 	nr_seq_person_name_w
			from 	pessoa_fisica
			where 	cd_pessoa_fisica = cd_pessoa_fisica_w;

			select max(nm_pessoa_fisica)
			into STRICT ds_resultado_w
			from table(search_names_dev(null, null, nr_seq_person_name_w, 'familyName', 'social,main'));
		else
			ds_resultado_w	:= obter_nome_sobrenome_pessoa(cd_pessoa_fisica_w, 'S');
		end if;
	elsif (ds_macro_w	= '@PREFIX_GER') then
		select 	max(DS_COMPONENT_NAME_1)
		into STRICT 	ds_resultado_w
		from   	person_name
		where 	nr_sequencia = (SELECT nr_seq_person_name
								from   pessoa_fisica
								where cd_pessoa_fisica = cd_pessoa_fisica_w);
	elsif (ds_macro_w	= '@SUFIX_GER') then
		select 	max(DS_COMPONENT_NAME_3)
		into STRICT 	ds_resultado_w
		from   	person_name
		where 	nr_sequencia = (SELECT nr_seq_person_name
								from   pessoa_fisica
								where cd_pessoa_fisica = cd_pessoa_fisica_w);
	elsif (ds_macro_w	= '@GET_METHOD_ARRIVAL') then
		select 	fc.ds_forma
		into STRICT 	ds_resultado_w
		from   	forma_chegada fc
		where 	fc.nr_sequencia = (SELECT max(api.NR_SEQ_FORMA_CHEGADA)
								from   ATENDIMENTO_PACIENTE_INF api
								where api.NR_ATENDIMENTO = vl_atributo_p);
	elsif (ds_macro_w	= '@TITULO_ACADEMICO') then
		select 	max(b.ds_forma_tratamento)
		into STRICT	ds_resultado_w
		from	pessoa_fisica a, PF_FORMA_TRATAMENTO b
		where 	cd_pessoa_fisica = cd_pessoa_fisica_w
		and 	a.nr_seq_forma_trat = b.nr_sequencia;
	elsif (ds_macro_w	= '@SAUDACAO_CARTA') then
		if (obter_sexo_pf(cd_pessoa_fisica_w, 'C') = 'M') then
			ds_resultado_w := obter_desc_expressao(890062);
		else
			ds_resultado_w := obter_desc_expressao(890060);
		end if;
	elsif (ds_macro_w	= '@NM_MEDICO_EXTERNO') then
		select	max(nm_medico)
		into STRICT	ds_resultado_w
		from (	SELECT	substr(obter_nome_pessoa_fisica(cd_medico,null),1,200) nm_medico
					from	PF_MEDICO_EXTERNO a
					where 	cd_pessoa_fisica = cd_pessoa_fisica_w
					and		NR_SEQ_TIPO_MEDICO = 1
					ORDER	BY a.nr_sequencia DESC) alias4 LIMIT 1;
	elsif (ds_macro_w	= '@DS_ENDERECO_MEDICO_EXTERNO') then
		select	max(endereco_medic_externo)
		into STRICT	ds_resultado_w
		from (	SELECT	substr(obter_compl_pf(cd_medico,2,'ES'),1,255) endereco_medic_externo
					from	pf_medico_externo a
				where 	cd_pessoa_fisica = cd_pessoa_fisica_w
				and		nr_seq_tipo_medico = 1
				order	by a.nr_sequencia desc) alias4 LIMIT 1;
	elsif (ds_macro_w	= '@DS_CIDADE_MEDICO_EXTERNO') then
		select	max(ds_cidade_medic_externo)
		into STRICT	ds_resultado_w
		from (	SELECT	substr(obter_compl_pf(cd_medico,2,'CI'),1,255)	 ds_cidade_medic_externo
					from	pf_medico_externo a
					where 	cd_pessoa_fisica = cd_pessoa_fisica_w
					and		nr_seq_tipo_medico = 1
					order	by a.nr_sequencia desc) alias4 LIMIT 1;
	elsif (ds_macro_w	= '@NR_ENDERECO_MEDICO_EXTERNO') then
		select	max(nr_endereco_medic_externo)
		into STRICT	ds_resultado_w
		from (	SELECT	substr(obter_compl_pf(cd_medico,2,'NREND'),1,255)	 nr_endereco_medic_externo
					from	pf_medico_externo a
					where 	cd_pessoa_fisica = cd_pessoa_fisica_w
					and		nr_seq_tipo_medico = 1
					order	by a.nr_sequencia desc) alias4 LIMIT 1;
	elsif (ds_macro_w	= '@DS_CEP_MEDICO_EXTERNO') then
		select	max(ds_cep_medic_externo)
		into STRICT	ds_resultado_w
		from (	SELECT	substr(obter_compl_pf(cd_medico,2,'CEP'),1,255)	 ds_cep_medic_externo
					from	pf_medico_externo a
					where 	cd_pessoa_fisica = cd_pessoa_fisica_w
					and		nr_seq_tipo_medico = 1
					order	by a.nr_sequencia desc) alias4 LIMIT 1;
	elsif (ds_macro_w	= '@PRIMEIRO_NOME') then
		ds_resultado_w	:= obter_nome_sobrenome_pessoa(cd_pessoa_fisica_w, 'P');
	elsif (ds_macro_w	= '@SOBRENOME') then
		ds_resultado_w	:= obter_nome_sobrenome_pessoa(cd_pessoa_fisica_w, 'S');
	elsif (ds_macro_w	= '@ARTIGO') then
		ds_resultado_w	:= obter_artigo_pf(cd_pessoa_fisica_w);
	elsif (ds_macro_w	= '@NM_PACIENTE') then
		ds_resultado_w	:= obter_nome_pf(cd_pessoa_fisica_w);	
	elsif (ds_macro_w	= '@SEXO') then
		ds_resultado_w	:= substr(obter_sexo_pf(cd_pessoa_fisica_w,'D'),1,40);
	elsif (ds_macro_w	= '@SEXO_CODIGO') then
		ds_resultado_w	:= substr(obter_sexo_pf(cd_pessoa_fisica_w,'C'),1,2);
	elsif (ds_macro_w	= '@ENDERECO_COMPLETO') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'ECCT');
	elsif (ds_macro_w	= '@SISTEMA_ANT') then
		ds_resultado_w	:= obter_dados_pf(cd_pessoa_fisica_w, 'CSA');
	elsif (ds_macro_w	= '@DATA_NASCIMENTO') then
		ds_resultado_w	:= PKG_DATE_FORMATERS.to_varchar(obter_data_nascto_pf(cd_pessoa_fisica_w), 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO);
	elsif (ds_macro_w	= '@NR_PRONTUARIO') then
		ds_resultado_w	:= coalesce(obter_prontuario_pf(wheb_usuario_pck.get_cd_estabelecimento,cd_pessoa_fisica_w),Obter_Prontuario_Paciente(cd_pessoa_fisica_w));
	elsif (ds_macro_w	= '@DT_INICIO_DIALISE') then
		ds_resultado_w	:= coalesce(to_char(obter_dt_inicio_trat_dialise(cd_pessoa_fisica_w, 0)),' ');
	elsif (ds_macro_w	= '@MAE') then
		ds_resultado_w	:= coalesce(to_char(obter_compl_pf(vl_atributo_p,5,'N')),' ');
	elsif (ds_macro_w	= '@PAI') then
		ds_resultado_w	:= coalesce(to_char(obter_compl_pf(vl_atributo_p,4,'N')),' ');
	elsif (ds_macro_w	= '@NACIONALIDADE') then
		ds_resultado_w	:= coalesce(obter_dados_pf(vl_atributo_p,'N'),' ');
	elsif (ds_macro_w	= '@ESTADO_CIVIL') then
		ds_resultado_w	:= coalesce(obter_valor_dominio(5,obter_dados_pf(vl_atributo_p,'EC')),' ');
	elsif (ds_macro_w	= '@DATA_ULT_CIRURGIA_PAC') then
		ds_resultado_w	:= Obter_dados_ult_cirurgia_pac(vl_atributo_p, 'DT');
	elsif (ds_macro_w	= '@DS_PROCED_ULT_CIRURGIA_PAC') then
		ds_resultado_w	:= Obter_dados_ult_cirurgia_pac(vl_atributo_p, 'P');
	elsif (ds_macro_w	= '@DS_PROC_ATEND_FUTURO') then
		ds_resultado_w	:= Obter_proc_atend_futuro(vl_atributo_p, 'D');
	elsif (ds_macro_w	= '@CD_PF') then
		ds_resultado_w	:= cd_pessoa_fisica_w;
	elsif (ds_macro_w	= '@CEP') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w,1, 'CEP');
	elsif (ds_macro_w	= '@MUNICIPIO') then
		ds_resultado_w	:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'DM');
	elsif (ds_macro_w	= '@CARGO') then
		ds_resultado_w	:= coalesce(obter_dados_pf(cd_pessoa_fisica_w, 'CR'),' ');
	elsif (ds_macro_w	= '@PROFISSAO') then
		ds_resultado_w	:= coalesce(obter_compl_pf(cd_pessoa_fisica_w, 1, 'P'),' ');
	elsif (ds_macro_w	= '@ULT_CID_LOCO_REGIONAL') then
		select 	max(cd_doenca_cid ||' - ' || obter_desc_cid_doenca(cd_doenca_cid))
		into STRICT	ds_resultado_w
		from	CAN_LOCO_REGIONAL a
		where	cd_pessoa_fisica	= vl_atributo_p
		and	nr_sequencia		= (	SELECT	max(b.nr_sequencia)
							from	can_loco_regional b
							where	b.cd_pessoa_fisica	= vl_atributo_p
							and	(cd_doenca_cid IS NOT NULL AND cd_doenca_cid::text <> ''));
	elsif (ds_macro_w	= '@TODO_CID_LOCO_REGIONAL') then

		open C11;
		loop
		fetch C11 into
			ds_doenca_w;
		EXIT WHEN NOT FOUND; /* apply on C11 */
			begin
			ds_resultado_w	:= ds_resultado_w || ds_doenca_w || chr(13) || chr(10);
			end;
		end loop;
		close C11;


	elsif (ds_macro_w	= '@DT_INICIO_TRATAMENTO_HD') then
		select	coalesce(to_char(max(dt_inicio_tratamento),'dd/mm/yyyy'), ' ')
		into STRICT	ds_resultado_w
		from	paciente_tratamento
		where	cd_pessoa_fisica	=	vl_atributo_p
		and	ie_tratamento	in ('HD','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF');
	elsif (ds_macro_w	= '@RG') then
		ds_resultado_w	:= coalesce(obter_dados_pf(cd_pessoa_fisica_w, 'RG'),' ');
	elsif (ds_macro_w	= '@CPF_PACIENTE') then
		ds_resultado_w	:= coalesce(obter_dados_pf(cd_pessoa_fisica_w,'CPF'),' ');
	elsif (ds_macro_w	= '@PACIENTE_TODOS_DIAGNOSTICOS') then
		begin
		open c04;
		loop
			fetch c04 into
				ds_doenca_w;
			EXIT WHEN NOT FOUND; /* apply on c04 */
			ds_resultado_w	:= ds_resultado_w || ds_doenca_w || chr(13) || chr(10);
		end loop;
		close c04;
		end;
	elsif (ds_macro_w	= '@DOENCAS_PREVIAS') then

		open C05;
		loop
		fetch C05 into
			ds_doenca_prev_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin
			ds_resultado_w	:= substr(ds_resultado_w || ds_doenca_prev_w || chr(13) || chr(10),1,2000);
			end;
		end loop;
		close C05;

	elsif (ds_macro_w	= '@ALERGIAS') then
		open C13;
		loop
			fetch C13 into
				ds_agente_alerg_w,
				ds_tipo_reacao_w,
				ds_observacao_w,
				ie_confirmacao_w;
			EXIT WHEN NOT FOUND; /* apply on C13 */

			if (ie_confirmacao_w = 'S') then
				ds_resultado_w 	:= ds_resultado_w || wheb_mensagem_pck.get_texto(307274) || ':  '; -- Suspeita
			end if;

			ds_resultado_w	:= ds_resultado_w || ds_agente_alerg_w;

			if (ds_tipo_reacao_w IS NOT NULL AND ds_tipo_reacao_w::text <> '') then
				ds_resultado_w	:= ds_resultado_w || ' (' || ds_tipo_reacao_w || ')';
			end if;

			if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
				ds_resultado_w	:= ds_resultado_w || ' - ' || ds_observacao_w;
			end if;

			ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10);
		end loop;
		close C13;
	
	elsif (ds_macro_w	= '@ALERGIA_SEM_OBS') then
		open C13;
		loop
			fetch C13 into
				ds_agente_alerg_w,
				ds_tipo_reacao_w,
				ds_observacao_w,
				ie_confirmacao_w;
			EXIT WHEN NOT FOUND; /* apply on C13 */

			if (ie_confirmacao_w = 'S') then
				ds_resultado_w 	:= ds_resultado_w || wheb_mensagem_pck.get_texto(307274) || ':  '; -- Suspeita
			end if;

			ds_resultado_w	:= ds_resultado_w || ds_agente_alerg_w;

			if (ds_tipo_reacao_w IS NOT NULL AND ds_tipo_reacao_w::text <> '') then
				ds_resultado_w	:= ds_resultado_w || ' (' || ds_tipo_reacao_w || ')';
			end if;

			ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10);
		end loop;
		close C13;
	elsif (ds_macro_w	= '@CLASSIF_PESSOA') then
		ds_resultado_w := substr(obter_lista_dados_classif(vl_atributo_p, 'D'), 1, 100);
	elsif (ds_macro_w	= '@PLS_CARTEIRA') then
			select	max(nr_sequencia)
			into STRICT	nr_seq_segurado_w
			from	pls_segurado
			where	cd_pessoa_fisica	= vl_atributo_p
			and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
			and		((coalesce(DT_RESCISAO::text, '') = '') or (DT_RESCISAO	<= clock_timestamp()));

			ds_resultado_w	:= coalesce(pls_obter_dados_segurado(nr_seq_segurado_w,'C'),' ');
	elsif (ds_macro_w	= '@PROC_LAUDO_SUS') then
		select	max(cd_procedimento_solic),
			max(ie_origem_proced)
		into STRICT	cd_procedimento_w,
			ie_origem_proced_w
		from	sus_laudo_paciente
		where	nr_seq_interno = (
			SELECT	max(nr_seq_interno)
			from	atendimento_paciente a,
				sus_laudo_paciente b
			where	a.nr_atendimento	= b.nr_atendimento
			and	a.cd_pessoa_fisica	= vl_atributo_p);
		
		if (cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '') then
			ds_resultado_w	:= to_char(cd_procedimento_w) || ' - '||substr(obter_descricao_procedimento(cd_procedimento_w, ie_origem_proced_w),1,240);
		end if;
	elsif (ds_macro_w = '@HS_MEDIC_USO') then
		begin
		select	CASE WHEN a.ie_nega_medicamentos='S' THEN wheb_mensagem_pck.get_texto(307271) WHEN a.ie_nega_medicamentos='D' THEN wheb_mensagem_pck.get_texto(307273)  ELSE a.ds_medicamento END  -- Nega medicamentos em uso		Desconhece medicamentos em uso
		into STRICT	ds_resultado_w
		from	paciente_medic_uso a
		where	a.nr_sequencia = (	SELECT	max(b.nr_sequencia)
					from	paciente_medic_uso b
					where	b.cd_pessoa_fisica = vl_atributo_p);
		end;
	elsif (ds_macro_w = '@HS_HABITOS') then
		begin
		select	CASE WHEN coalesce(a.ie_nega_habito,'N')='N' THEN substr(obter_valor_dominio(1335,a.ie_classificacao),1,60)  ELSE PERFORM wheb_mensagem_pck.get_texto(307270) END  -- Nega habitos
		into STRICT	ds_resultado_w
		from	paciente_habito_vicio a
		where	a.nr_sequencia = (	SELECT	max(b.nr_sequencia)
					from	paciente_habito_vicio b
					where	b.cd_pessoa_fisica = vl_atributo_p);
		end;
	elsif (ds_macro_w = '@HS_DOENCAS_PREV') then
		begin
		select	CASE WHEN a.ie_nega_doencas='S' THEN wheb_mensagem_pck.get_texto(307268)  ELSE coalesce(a.ds_doenca,coalesce(substr(obter_desc_cid(a.cd_doenca),1,200),substr(obter_desc_pe_doenca(a.nr_seq_doenca),1,80))) END  -- Nega doencas
		into STRICT	ds_resultado_w
		from	paciente_antec_clinico a
		where	a.nr_sequencia = (	SELECT	max(b.nr_sequencia)
					from	paciente_antec_clinico b
					where	b.cd_pessoa_fisica = vl_atributo_p);
		end;	
	elsif (position('@EXAME_LAB_PES[' in ds_macro_w) = 1) then
		begin
		nr_seq_exame_w	:= somente_numero(ds_macro_w);
		
		SELECT lab_obter_ult_resultado(vl_atributo_p, nr_seq_exame_w)
		into STRICT ds_resultado_w 
		;
		end;
	else
		gerar_result_macro_sql;
	end if;
	end;
elsif (nm_atributo_p		= 'SISTEMA') then
	begin
	select	clock_timestamp()
	into STRICT	dt_sistema_w
	;

	if (ds_macro_w	= '@DATA_HORA') then
		ds_resultado_w	:= PKG_DATE_FORMATERS.to_varchar(dt_sistema_w, 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO);
	elsif (ds_macro_w	= '@DATA_SEM_SEGUNDOS') then
		ds_resultado_w	:= to_char(dt_sistema_w, 'dd/mm/yyyy HH24:MI');
	elsif (ds_macro_w	= '@HORA_ATUAL') then
		ds_resultado_w	:= to_char(dt_sistema_w, 'HH24:MI:SS');
	elsif (ds_macro_w	= '@DATA') then
		ds_resultado_w	:= to_char(dt_sistema_w, 'dd/mm/yyyy');
	elsif (ds_macro_w	= '@DATA_SEM_HORA') then
		ds_resultado_w	:= to_char(dt_sistema_w, 'dd/mm/yyyy');
	elsif (ds_macro_w	= '@DATAEXT') then
		ds_resultado_w	:= obter_data_extenso(dt_sistema_w, 0);
	elsif (ds_macro_w	= '@DS_ESTABELECIMENTO') then
		ds_resultado_w	:= obter_nome_estabelecimento(wheb_usuario_pck.get_cd_estabelecimento);
        -- INICIO MACROS SOLICITACAO JAPAO
        elsif (ds_macro_w	= '@TODAY') then
                        ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@TODAY');
        elsif (ds_macro_w	= '@TOMORROW') then
                        ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@TOMORROW');
        elsif (ds_macro_w	= '@YESTERDAY') then
                        ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@YESTERDAY');
        -- FIM MACROS SOLICITACAO JAPAO                
	elsif (ds_macro_w	= '@CIDADE_ESTAB') then
		select max(obter_desc_municipio_ibge(cd_municipio_ibge))
		into STRICT ds_resultado_w
		from pessoa_juridica
		where CD_CGC = (SELECT CD_CGC
	  					from   estabelecimento
						where  cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento);
	elsif (ds_macro_w	= '@RUA_ESTAB') then
		select max(ds_endereco)
		into STRICT ds_resultado_w
		from pessoa_juridica
		where CD_CGC = (SELECT CD_CGC
	  					from   estabelecimento
						where  cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento);
	elsif (ds_macro_w	= '@NUMERO_END_ESTAB') then
		select max(nr_endereco)
		into STRICT ds_resultado_w
		from pessoa_juridica
		where CD_CGC = (SELECT CD_CGC
	  					from   estabelecimento
						where  cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento);
	elsif (ds_macro_w	= '@CEP_ESTAB') then
		select max(cd_cep)
		into STRICT ds_resultado_w
		from pessoa_juridica
		where CD_CGC = (SELECT CD_CGC
	  					from   estabelecimento
						where  cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento);
	elsif (ds_macro_w	= '@WEBPAGE_ESTAB') then
		select max(ds_site_internet)
		into STRICT ds_resultado_w
		from pessoa_juridica
		where CD_CGC = (SELECT CD_CGC
	  					from   estabelecimento
						where  cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento);
	elsif (ds_macro_w	= '@PRIMEIRO_NOME_DIRETOR') then
		ds_resultado_w :=  obter_dados_diretor(wheb_usuario_pck.get_cd_estabelecimento, 'GN');
	elsif (ds_macro_w	= '@SOBRENOME_DIRETOR') then
		ds_resultado_w :=  obter_dados_diretor(wheb_usuario_pck.get_cd_estabelecimento, 'FN');
	elsif (position('@FORMULA[' in ds_macro_w) = 1) then
		if (ds_macro_w = '@FORMULA[]') then
			ds_resultado_w := ' ';
		else
			ds_resultado_w	:= obter_valor_formula_macro(substr(ds_macro_w,10,length(ds_macro_w)-10));
			if (position(',' in ds_resultado_w) = 1) then
				ds_resultado_w := '0' || ds_resultado_w;
			end if;
		end if;
	else
		gerar_result_macro_sql;
	end if;
	end;
elsif (nm_atributo_p	= 'NR_ATENDIMENTO') then
	begin
	
	if (ds_macro_w	= '@CID') then
		begin
		select	Obter_Ultimo_Cid_Atend(vl_atributo_p,'P')
		into STRICT	ds_resultado_w
		;
		end;
	elsif (ds_macro_w = '@OBSERVACAO_SINAL_VITAL')then
		begin
		select 	max(b.ds_observacao)
		into STRICT	ds_resultado_w
		from   	atendimento_sinal_vital b
		where	b.nr_atendimento	= vl_atributo_p
		and  	b.nr_sequencia	= (	SELECT	max(a.nr_sequencia)
						from 	atendimento_sinal_vital a
						where 	a.nr_atendimento = b.nr_atendimento
						and	a.nr_atendimento = vl_atributo_p
						and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
						and	coalesce(a.dt_inativacao::text, '') = '');
		end;

	elsif (ds_macro_w = '@CLASSIFICACAO_TRIAGEM')then
		begin
			select *
			into STRICT ds_resultado_w
			from (
				SELECT (
					SELECT 
						clas.ds_classificacao ds 
					from 	triagem_classif_risco clas
					where 	clas.nr_sequencia = tri.nr_seq_classif)
				from TRIAGEM_PRONTO_ATEND tri 
				where tri.nr_atendimento = vl_atributo_p
				order by tri.nr_sequencia desc) alias2 LIMIT 1;
		end;
		
	elsif (ds_macro_w = '@DATA_CLASSIF_TRIAGEM')then
		begin
			select *
			into STRICT ds_resultado_w
			from (
				SELECT PKG_DATE_FORMATERS.to_varchar(DT_INICIO_TRIAGEM, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, wheb_usuario_pck.get_nm_usuario)
				from TRIAGEM_PRONTO_ATEND tri 
				where tri.nr_atendimento = vl_atributo_p
				order by tri.nr_sequencia desc) alias2 LIMIT 1;
		end;
		
	elsif (ds_macro_w = '@HORA_CLASSIF_TRIAGEM')then
		begin
			select *
			into STRICT ds_resultado_w
			from (
				SELECT PKG_DATE_FORMATERS.to_varchar(DT_INICIO_TRIAGEM, 'shortTime', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, wheb_usuario_pck.get_nm_usuario)
				from TRIAGEM_PRONTO_ATEND tri 
				where tri.nr_atendimento = vl_atributo_p
				order by tri.nr_sequencia desc) alias2 LIMIT 1;

		end;
		
		
	elsif (ds_macro_w = '@ESCALA_DOR_SINAL_VITAL')then
		begin
		select  obter_escala_dor_sinal_vital(b.nr_atendimento,'MAX')
		into STRICT	ds_resultado_w
		from   	atendimento_sinal_vital b
		where	b.nr_atendimento = vl_atributo_p
		and  	b.nr_sequencia	= (	SELECT	max(a.nr_sequencia)
						from 	atendimento_sinal_vital a
						where 	a.nr_atendimento = b.nr_atendimento
						and	a.nr_atendimento = vl_atributo_p
						and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
						and	coalesce(a.dt_inativacao::text, '') = '');
		end;
		
	elsif (ds_macro_w = '@PRIMEIRA_ESCALA_DOR_SV') then
		begin
		select  obter_escala_dor_sinal_vital(b.nr_atendimento,'MIN')
		into STRICT	ds_resultado_w
		from   	atendimento_sinal_vital b
		where	b.nr_atendimento = vl_atributo_p
		and  	b.nr_sequencia	= (	SELECT	min(a.nr_sequencia)
						from 	atendimento_sinal_vital a
						where 	a.nr_atendimento = b.nr_atendimento
						and	a.nr_atendimento = vl_atributo_p
						and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
						and	coalesce(a.dt_inativacao::text, '') = '');
		end;
		
	elsif (ds_macro_w	= '@BARTHEL') then
		begin
		select  max(a.qt_pontuacao||' - '||substr(obter_desc_escala_barthel(a.qt_pontuacao),1,255)) ds_resultado_w
		into STRICT	ds_resultado_w
		from    escala_barthel a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   escala_barthel b
					  where  nr_atendimento = vl_atributo_p
					  and	 (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	 coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w	= '@NR_CASE') then
		select max(ep.nr_episodio)
        into STRICT ds_resultado_w
        from episodio_paciente ep,
            atendimento_paciente ap
        where ap.nr_seq_episodio = ep.nr_sequencia
            and ap.nr_atendimento = vl_atributo_p;
	elsif (ds_macro_w	= '@NR_EXTERNAL_CASE') then
		select 	max(b.nr_episodio) nr_episodio
		into STRICT   	ds_resultado_w
		from 	atendimento_paciente a,
				episodio_paciente b
		where 	a.nr_Seq_episodio = b.nr_Sequencia
		and		a.nr_atendimento = vl_atributo_p;
	elsif (ds_macro_w = '@DT_DIAS_RETORNO_ORIENT_ALTA')then
		begin
		select 	coalesce(max(b.qt_periodo),30),
			coalesce(max(b.ie_periodo),'D')
		into STRICT	qt_periodo_orien_alta_w,
			ie_periodo_orien_alta_w
		from   	atendimento_alta b
		where	b.nr_atendimento	= vl_atributo_p
		and  	b.nr_sequencia	= (	SELECT	max(a.nr_sequencia)
						from 	atendimento_alta a, parametro_medico p
						where 	a.nr_atendimento = b.nr_atendimento
						and		a.nr_atendimento = vl_atributo_p
						and		coalesce(a.dt_inativacao::text, '') = ''
						and     p.cd_estabelecimento = obter_estabelecimento_ativo
						and     ((a.ie_tipo_orientacao <> 'P')
						or (coalesce(p.ie_liberar_desfecho,'N')  = 'N')
						or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')));

		if (ie_periodo_orien_alta_w = 'D') then
			ds_resultado_w := to_char((clock_timestamp() + qt_periodo_orien_alta_w),'dd/mm/yyyy hh24')||':00';
		elsif (ie_periodo_orien_alta_w = 'S') then
			ds_resultado_w := to_char((clock_timestamp() + (qt_periodo_orien_alta_w * 7)),'dd/mm/yyyy hh24')||':00';
		elsif (ie_periodo_orien_alta_w = 'M') then
			ds_resultado_w := to_char((clock_timestamp() + (qt_periodo_orien_alta_w * 30)),'dd/mm/yyyy hh24')||':00';
		elsif (ie_periodo_orien_alta_w = 'A') then
			ds_resultado_w := to_char((clock_timestamp() + (qt_periodo_orien_alta_w * 365)),'dd/mm/yyyy hh24')||':00';
		end if;

		end;
	elsif (ds_macro_w	= '@CD_USUARIO_CONVENIO') then
		select	max(CD_USUARIO_CONVENIO)
		into STRICT	ds_resultado_w
		from	atendimento_paciente_v
		where	nr_atendimento	= vl_atributo_p;

	elsif (ds_macro_w	= '@DS_TIPO_ATENDIMENTO') then
		select	max(DS_TIPO_ATENDIMENTO)
		into STRICT	ds_resultado_w
		from	atendimento_paciente_v
		where	nr_atendimento	= vl_atributo_p;

	elsif (ds_macro_w	= '@CLASSIFICACAO_ATEND') then

		ds_resultado_w	:= Obter_Classificacao_Atend(vl_atributo_p,'D');

	elsif (ds_macro_w	= '@DATA_ENTRADA') then
		begin
		select	obter_data_entrada(vl_atributo_p)
		into STRICT	ds_resultado_w
		;
		end;
	elsif (ds_macro_w	= '@DIAGNOSTICO') then
		begin
		select	obter_diagnostico_atendimento(vl_atributo_p)
		into STRICT	ds_resultado_w
		;
		end;

	elsif (ds_macro_w	= '@DIAGNOSTICO_CID') then
		begin
		if (obtain_user_locale(wheb_usuario_pck.get_nm_usuario) = 'de_DE' and obter_uso_case(wheb_usuario_pck.get_nm_usuario) = 'S') then
			select	max(dm.dt_diagnostico)
			into STRICT	dt_diagnostico_w
			from	diagnostico_medico dm
			where	dm.nr_atendimento	in (SELECT a.nr_atendimento
										from atendimento_paciente a, 
											 episodio_paciente b 
										where a.nr_seq_episodio = b.nr_sequencia 
										and b.nr_sequencia = obter_episodio_atendimento(vl_atributo_p))
			and		exists (select	1
							from	diagnostico_doenca dd
							where	dd.dt_diagnostico = dm.dt_diagnostico
							and		ie_tipo_diagnostico = 2
							and		coalesce(ie_situacao,'A') = 'A'
							and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''))
			and		dm.ie_tipo_diagnostico = 2;
			
			select	max(dd.cd_doenca)
			into STRICT	ds_resultado_w
			from	diagnostico_doenca dd
			where	dd.nr_atendimento	in (SELECT a.nr_atendimento
										from atendimento_paciente a, 
											 episodio_paciente b 
										where a.nr_seq_episodio = b.nr_sequencia 
										and b.nr_sequencia = obter_episodio_atendimento(vl_atributo_p))
			and		dd.dt_diagnostico	= dt_diagnostico_w
			and		dd.ie_classificacao_doenca = 'P';
			
		else
			select	obter_cid_atendimento(vl_atributo_p,2)
			into STRICT	ds_resultado_w
			;
		end if;
		end;
	elsif (ds_macro_w	= '@DATA_INTERNACAO') then
		begin
		select	PKG_DATE_FORMATERS.to_varchar(max(dt_entrada), 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO)
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@DATA_INTERN_SEM_HORA') then
		begin
		select	to_char(max(dt_entrada),'dd/mm/yyyy')
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@HORA_INTERNACAO') then
		begin
		select	to_char(max(dt_entrada),'hh24:mi:ss')
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w = '@DATA_LIBERACAO_MED') then	/*David em 02/08/2008 OS 102676*/
		begin
		select	coalesce(to_char(max(dt_lib_medico),'dd/mm/yyyy hh24:mi:ss'),' ')
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@DATA_ALTA') then
		begin
		select	PKG_DATE_FORMATERS.to_varchar(max(dt_alta), 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO)
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		if (coalesce(ds_resultado_w::text, '') = '') then
			ds_resultado_w := ' ';
		end if;
		end;
	elsif (ds_macro_w	= '@DIAS_INTERNACAO') then
		begin
		select	Obter_Dias_Internacao(vl_atributo_p)
		into STRICT	ds_resultado_w
		;
		end;
	elsif (ds_macro_w	= '@DIAS_UTI') then
		begin
		select	coalesce(obter_dias_internacao_uti(vl_atributo_p),0)
		into STRICT	ds_resultado_w
		;
		end;
	elsif (ds_macro_w	= '@DIAS_SETOR_UTI') then
		begin
		select	coalesce(obter_total_dias_uti_setor(vl_atributo_p),0)
		into STRICT	ds_resultado_w
		;
		end;
	elsif (ds_macro_w	= '@TOTAL_DIAS_UTI') then
		begin
		select	coalesce(obter_total_dias_intern_uti(vl_atributo_p),0)
		into STRICT	ds_resultado_w
		;
		end;
	elsif (ds_macro_w	= '@EQUIPE_CHECK-UP') then
		begin
		open C01;
		loop
			fetch C01 into
				ds_checkup_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
			ds_resultado_w	:= ds_resultado_w ||ds_checkup_w|| chr(13) || chr(10);
		end loop;
		close C01;
		end;
	elsif (ds_macro_w	= '@ATENDIMENTO') then
		begin
		ds_resultado_w	:= vl_atributo_p;
		end;
		
	elsif (ds_macro_w	= '@ALERGIA_ATEND_HS') then
		open C37;
		loop
			fetch C37 into
				ds_agente_alerg_w,
				ds_tipo_reacao_w,
				ds_observacao_w,
				ie_confirmacao_w;
			EXIT WHEN NOT FOUND; /* apply on C37 */

			if (ie_confirmacao_w = 'S') then
				ds_resultado_w 	:= ds_resultado_w || wheb_mensagem_pck.get_texto(307274) || ':  '; -- Suspeita
			end if;

			ds_resultado_w	:= ds_resultado_w || ds_agente_alerg_w;

			if (ds_tipo_reacao_w IS NOT NULL AND ds_tipo_reacao_w::text <> '') then
				ds_resultado_w	:= ds_resultado_w || ' (' || ds_tipo_reacao_w || ')';
			end if;

			if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
				ds_resultado_w	:= ds_resultado_w || ' - ' || ds_observacao_w;
			end if;

			ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10);
		end loop;
		close C37;
	
	elsif (ds_macro_w	= '@ALTA_MEDICA') then
		select	to_char(max(dt_alta_medico),'dd/mm/yyyy hh24:mi:ss')
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		if (coalesce(ds_resultado_w::text, '') = '') then
			ds_resultado_w := ' ';
		end if;
	elsif (ds_macro_w	= '@TODOS_DIAGNOSTICOS') then
		begin
		open c02;
		loop
			fetch c02 into
				ds_doenca_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			ds_resultado_w	:= ds_resultado_w || ds_doenca_w || chr(13) || chr(10);
		end loop;
		close c02;
		end;
	elsif (ds_macro_w	= '@TODOS_CID') then
		begin
		open c03;
		loop
			fetch c03 into
				ds_doenca_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w:= ds_doenca_w;
			else
				ds_resultado_w	:= ds_resultado_w || ' - ' || ds_doenca_w;
			end if;
		end loop;
		close c03;
		end;
	elsif (ds_macro_w	= '@NM_RESPONSAVEL') then
		begin
		select	substr(obter_nome_pessoa_fisica(CD_PESSOA_RESPONSAVEL, null),1,60)
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@ULTIMO_CID_LAUDO') then
		begin
		SELECT 	MAX(CD_CID_PRINCIPAL ||' - ' || obter_desc_cid_doenca(CD_CID_PRINCIPAL))
		into STRICT	ds_resultado_w
		FROM	sus_laudo_paciente a
		WHERE	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@RESPONSAVEL_CPF') then
		begin
		select	substr(obter_dados_pf(CD_PESSOA_RESPONSAVEL, 'CPF'),1,60)
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@RESPONSAVEL_RG') then
		begin
		select	substr(obter_dados_pf(CD_PESSOA_RESPONSAVEL, 'RG'),1,60)
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@RESPONSAVEL_FONE') then
		begin
		select	substr(obter_compl_pf(CD_PESSOA_RESPONSAVEL, 1, 'T'),1,60)
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@ATEND_PACIENTE_NM_RESPONSAVEL') then
		begin
		select	substr(obter_nome_pessoa_fisica(CD_PESSOA_RESPONSAVEL, null),1,60)
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		if (coalesce(ds_resultado_w::text, '') = '') then
			ds_resultado_w	:=	Obter_Dados_Responsavel(vl_atributo_p,'N');
		end if;
		end;
	elsif (ds_macro_w	= '@ATEND_PAC_END_RESPONSAVEL') then
		ds_resultado_w	:=	Obter_Dados_Responsavel(vl_atributo_p,'ES');
	elsif (ds_macro_w	= '@PRONO_RESPONSAVEL') then
		select	max(cd_pessoa_responsavel)
		into STRICT	cd_pessoa_fisica_w
		from	atendimento_paciente
		where	nr_atendimento	= vl_atributo_p;
		ds_resultado_w	:= obter_pronome_pf(cd_pessoa_fisica_w, 'N');
	elsif (ds_macro_w	= '@DATA_CIRURGIA') then

		select	pkg_date_formaters.to_varchar(max(dt_inicio_real), ds_format_date_w, wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario)
		into STRICT	ds_resultado_w
		from	cirurgia
		where	nr_atendimento	= vl_atributo_p;
		if (coalesce(ds_resultado_w::text, '') = '') then
			ds_resultado_w := ' ';
		end if;
	elsif (ds_macro_w	= '@ATEND_ANTE_PAC') then

		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_w
		from	atendimento_paciente
		where	nr_atendimento	= vl_atributo_p;

		select	coalesce(max(to_char(nr_atendimento)),' ')
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	nr_atendimento	< vl_atributo_p;

	elsif (ds_macro_w	= '@DT_ANTE_PAC') then

		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_w
		from	atendimento_paciente
		where	nr_atendimento	= vl_atributo_p;

		select	max(dt_entrada)
		into STRICT	ds_result_data_w
		from	atendimento_paciente
		where	cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	nr_atendimento	< vl_atributo_p;

		ds_resultado_w 	:= coalesce(to_char(ds_result_data_w,'dd/mm/yyyy hh24:mi:ss'),'');

	elsif (ds_macro_w	= '@DIAS_INTERNADO_CIRURGIA') then
		begin
		select	coalesce(max(dt_alta),clock_timestamp())
		into STRICT	dt_atual_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;

		select	coalesce(max(DT_INICIO_REAL),clock_timestamp())
		into STRICT	dt_cirurgia_w
		from	cirurgia
		where	nr_atendimento	= vl_atributo_p;

		ds_resultado_w	:= trunc(dt_atual_w - dt_cirurgia_w);
		end;
	elsif (ds_macro_w	= '@MED_ATEND') then
		begin
		select	obter_nome_medico(cd_medico_resp,'N')
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@MEDIC_ATEND') then
		begin
		select	obter_nome_medico(cd_medico_resp,'NC')
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@DEPARTAMENTO') then
		ds_resultado_w := obter_nome_departamento_medico(obter_departamento_data(vl_atributo_p));
	elsif (ds_macro_w	= '@DEPARTAMENTO_CURTO') then	
		ds_resultado_w := obter_nome_curto_depto_medico(obter_departamento_data(vl_atributo_p));
	elsif (ds_macro_w	= '@PESO') then
		begin
		ds_resultado_w := obter_sinal_vital(vl_atributo_p,'PESO');
		end;
	elsif (ds_macro_w	= '@ALTURA') then
		begin
		ds_resultado_w := obter_sinal_vital(vl_atributo_p,'ALTURA');
		end;
	elsif (ds_macro_w	= '@SC') then
		begin
		ds_resultado_w := obter_sinal_vital(vl_atributo_p,'SC');
		end;
	elsif (ds_macro_w	= '@GRAMAS_PESO') then
		begin
		ds_resultado_w := ((obter_sinal_vital(vl_atributo_p,'PESO'))::numeric *1000);
		end;
	elsif (ds_macro_w	= '@DOSE_PESO') then
		begin
		ds_resultado_w := round((obter_sinal_vital(vl_atributo_p,'PESO'))::numeric );
		exception
			when others then
			ds_resultado_w	:= null;
		end;
	-- INICIO HISTORICO DE PARTO
	elsif (ds_macro_w	= '@GESTACOES') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'GEST');
	elsif (ds_macro_w	= '@PARTOSNORMAIS') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'PANORMAL');
	elsif (ds_macro_w	= '@PARTOSCESARIOS') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'PACESARIANA');
	elsif (ds_macro_w	= '@ABORTOS') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'ABORTOS');
	elsif (ds_macro_w	= '@NMMAERN') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'NOMEDAMAE');
	elsif (ds_macro_w	= '@TIPOPARTO') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'TPPARTO');
	elsif (ds_macro_w	= '@HABITOSMAE') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'HABITOS');
	elsif (ds_macro_w	= '@SOROLOGIAS') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'SOROLOGIA');
	elsif (ds_macro_w	= '@TIPOSANGUEMAE') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'TPSANGUEMAE');
	elsif (ds_macro_w	= '@TIPOSANGUEPAI') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'TPSANGUEPAI');
	elsif (ds_macro_w	= '@FATORRHMAE') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'FATORRHMAE');
	elsif (ds_macro_w	= '@FATORRHPAI') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'FATORRHPAI');
	elsif (ds_macro_w	= '@IDGESTACIONAL') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'IDADEGESTACIONAL');
	elsif (ds_macro_w	= '@DTADMISSAOPARTO') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'DTADMISSAO');
	elsif (ds_macro_w	= '@ANTECPATOLOGICOS') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'ANTPATOLOGICOS');
	elsif (ds_macro_w	= '@LOCALPRENATAL') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'PRENATAL');
	elsif (ds_macro_w	= '@BOLSAAMNIOTICA') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'BOLSAAMNI');
	elsif (ds_macro_w	= '@BATIMENTOSRN') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'BCF');
	elsif (ds_macro_w	= '@APRESFETAL') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'APRESFETAL');
	elsif (ds_macro_w	= '@MEDICAMENTOS_PARTO') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'MEDICAMENTOS_PARTO');
	elsif (ds_macro_w	= '@DOENCASGESTACAO') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'DOENCASGESTACAO');
	elsif (ds_macro_w	= '@ALTURANASCIMENTO') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'ALTURANASCIMENTO');
	elsif (ds_macro_w	= '@PESONASCIMENTO') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'PESONASCIMENTO');
	elsif (ds_macro_w	= '@PARTODTNASCIMENTO') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'PARTODTNASCIMENTO');
	elsif (ds_macro_w	= '@PEDIATRA') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'PEDIATRA');
	elsif (ds_macro_w	= '@SEMANASGRAVIDEZ') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'SEMANASGRAVIDEZ');
	elsif (ds_macro_w	= '@PARTOANESTESISTA') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'PARTOANESTESISTA');
	elsif (ds_macro_w	= '@PARTOANESTESIA') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'PARTOANESTESIA');
	elsif (ds_macro_w	= '@TIPONASCIMENTOCOMPOSTO') then
		ds_resultado_w := obter_dados_parto_nascimento(vl_atributo_p,'TIPONASCIMENTOCOMPOSTO');

        elsif (ds_macro_w	= '@COMPRIM_CM') then
		SELECT max(QT_ALTURA)
		into STRICT ds_resultado_w
		FROM NASCIMENTO WHERE NR_ATENDIMENTO = vl_atributo_p;
	elsif (ds_macro_w	= '@PT_CM') then
		SELECT max(QT_PT)
		into STRICT ds_resultado_w
                FROM NASCIMENTO WHERE NR_ATENDIMENTO = vl_atributo_p;
        elsif (ds_macro_w	= '@PA_CM') then
		SELECT  max(QT_PA)
		into STRICT ds_resultado_w
		FROM NASCIMENTO WHERE NR_ATENDIMENTO = vl_atributo_p;
	elsif (ds_macro_w	= '@PC_CM') then
		SELECT  max(QT_PC)
		into STRICT ds_resultado_w
		FROM NASCIMENTO WHERE NR_ATENDIMENTO = vl_atributo_p;

	-- FIM HISTORICO DE PARTO
	elsif (ds_macro_w	= '@TEMPERATURA') then
		ds_resultado_w := obter_sinal_vital(vl_atributo_p,'Temp');
	elsif (ds_macro_w	= '@PA_MIN') then
		ds_resultado_w := obter_sinal_vital(vl_atributo_p,'PAMIN');
	elsif (ds_macro_w	= '@PA_MAX') then
		ds_resultado_w := obter_sinal_vital(vl_atributo_p,'PAMAX');
	elsif (ds_macro_w	= '@PAM') then
		ds_resultado_w := obter_sinal_vital(vl_atributo_p,'PAM');
	elsif (ds_macro_w	= '@FR') then
		ds_resultado_w := obter_sinal_vital(vl_atributo_p,'FR');
	elsif (ds_macro_w	= '@FC') then
		ds_resultado_w := obter_sinal_vital(vl_atributo_p,'FC');
	elsif (ds_macro_w	= '@IMC') then
		ds_resultado_w := obter_sinal_vital(vl_atributo_p,'IMC');
elsif (ds_macro_w	= '@ENCOUNTER_SPEC_CAT') then
		select (select max(b.DS_CLASSIFICACAO) from	CLASSIF_ESPECIAL_PACIENTE b where	b.NR_SEQUENCIA  = a.NR_SEQ_CLASSIF_ESP)
		into STRICT 	ds_resultado_w
		from	atendimento_paciente a
		where	a.nr_atendimento = vl_atributo_p;
	elsif (ds_macro_w	= '@TIPO_EPISODIO') then
		select max(c.ds_tipo)
		into STRICT 	ds_resultado_w
		from   atendimento_paciente a,
			   episodio_paciente b,
			   tipo_episodio c
		where  a.nr_seq_episodio = b.nr_sequencia
		and    b.nr_seq_tipo_episodio = c.nr_sequencia
		and    a.nr_atendimento = vl_atributo_p;
   elsif (ds_macro_w = '@SATURACAO')then
      ds_resultado_w := obter_sinal_vital(vl_atributo_p,'SAT');
	elsif (ds_macro_w	= '@QT_HORA_ENTRADA') then
		begin
		select	trunc(Obter_Hora_Entre_datas(coalesce(dt_alta, clock_timestamp()),obter_data_entrada(vl_atributo_p)))
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@QT_DIAS_INTERNADO') then
		begin
		select	obter_dias_entre_datas(dt_entrada, coalesce(dt_alta, clock_timestamp()))
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@NR_DECLARACAO_OBITO') then
		begin
		select	max(nr_declaracao)
		into STRICT	ds_resultado_w
		from	declaracao_obito
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@DT_OBITO_DECLARACAO') then
		begin
		select	to_char(max(dt_obito), 'dd/mm/yyyy hh24:mi:ss')
		into STRICT	ds_resultado_w
		from	declaracao_obito
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@CID_CAUSA_DIRETA_MORTE') then
		begin
		select	max(a.cd_cid_direta || ' - ' || b.ds_doenca_cid)
		into STRICT	ds_resultado_w
		from	declaracao_obito a,
				cid_doenca b
		where	a.nr_atendimento	=	vl_atributo_p
		and		a.cd_cid_direta		=	b.cd_doenca_cid;
		end;
	elsif (ds_macro_w	= '@CID_CAUSA_ANTECEDENTE1') then
		begin
		select	max(a.cd_cid_adic_1 || ' - ' || b.ds_doenca_cid)
		into STRICT	ds_resultado_w
		from	declaracao_obito a,
				cid_doenca b
		where	a.nr_atendimento	=	vl_atributo_p
		and		a.cd_cid_adic_1		=	b.cd_doenca_cid;
		end;
	elsif (ds_macro_w	= '@CID_CAUSA_ANTECEDENTE2') then
		begin
		select	max(a.cd_cid_adic_2 || ' - ' || b.ds_doenca_cid)
		into STRICT	ds_resultado_w
		from	declaracao_obito a,
				cid_doenca b
		where	a.nr_atendimento	=	vl_atributo_p
		and		a.cd_cid_adic_2		=	b.cd_doenca_cid;
		end;
	elsif (ds_macro_w	= '@CID_CAUSA_ANTECEDENTE3') then
		begin
		select	max(a.cd_cid_adic_3 || ' - ' || b.ds_doenca_cid)
		into STRICT	ds_resultado_w
		from	declaracao_obito a,
				cid_doenca b
		where	a.nr_atendimento	=	vl_atributo_p
		and		a.cd_cid_adic_3		=	b.cd_doenca_cid;
		end;
	elsif (ds_macro_w	= '@CID_CAUSA_CONTRIBUINTE1') then
		begin
		select	max(a.cd_cid_basica || ' - ' || b.ds_doenca_cid)
		into STRICT	ds_resultado_w
		from	declaracao_obito a,
				cid_doenca b
		where	a.nr_atendimento	=	vl_atributo_p
		and		a.cd_cid_basica		=	b.cd_doenca_cid;
		end;
	elsif (ds_macro_w	= '@CID_CAUSA_CONTRIBUINTE2') then
		begin
		select	max(a.cd_cid_adic_4 || ' - ' || b.ds_doenca_cid)
		into STRICT	ds_resultado_w
		from	declaracao_obito a,
				cid_doenca b
		where	a.nr_atendimento	=	vl_atributo_p
		and		a.cd_cid_adic_4		=	b.cd_doenca_cid;
		end;
	elsif (ds_macro_w	= '@TURNO_ATENDIMENTO') then
		begin
		select	max(obter_turno_atendimento(dt_entrada,cd_estabelecimento,'D'))
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@ATEND_PACIENTE_CID') then
		ds_resultado_w	:=	Obter_Ultimo_Cid_Atend_Pac(vl_atributo_p,'P','C');
	elsif (ds_macro_w	= '@ATEND_PACIENTE_DIAG') then
		ds_resultado_w	:=	Obter_Ultimo_Cid_Atend_Pac(vl_atributo_p,'','D');
	elsif (ds_macro_w = '@CONVENIO_ATENDIMENTO') then
		ds_resultado_w	:=	Obter_Nome_Convenio(obter_convenio_atendimento(vl_atributo_p));
	elsif (ds_macro_w = '@CD_PROCED_ULT_CIRURGIA_ATEND') then
		ds_resultado_w	:=	Obter_dados_ult_cirurgia_atend(vl_atributo_p, 'CP');
	elsif (ds_macro_w = '@DS_PROCED_ULT_CIRURGIA_ATEND') then
		ds_resultado_w	:=	Obter_dados_ult_cirurgia_atend(vl_atributo_p, 'P');
	elsif (ds_macro_w = '@SETOR_ULT_CIRURGIA_ATEND') then
		ds_resultado_w	:=	Obter_dados_ult_cirurgia_atend(vl_atributo_p, 'S');
	elsif (ds_macro_w = '@TIPO_ANEST_ULT_CIRURGIA_ATEND') then
		ds_resultado_w	:=	Obter_dados_ult_cirurgia_atend(vl_atributo_p, 'DTA');
	elsif (ds_macro_w = '@DURACAO_ULT_CIRURGIA_ATEND') then
		ds_resultado_w	:=	Obter_dados_ult_cirurgia_atend(vl_atributo_p, 'DUR');
	elsif (ds_macro_w = '@CD_DS_PROCS_ULT_CIRUR_ATEND') then
		ds_resultado_w	:=	Obter_dados_ult_cirurgia_atend(vl_atributo_p, 'CDTP');
	elsif (ds_macro_w = '@CD_DS_PROCS_ULT_CIRUR_CONV') then
		ds_resultado_w	:=	Obter_dados_ult_cirurgia_atend(vl_atributo_p, 'CDTPV');
	elsif (ds_macro_w = '@NM_CIRURGIAO_ULT_CIRUR_ATEND') then
		ds_resultado_w	:=	Obter_dados_ult_cirurgia_atend(vl_atributo_p, 'NM');
	elsif (ds_macro_w = '@NM_ANESTESIS_ULT_CIRUR_ATEND') then
		ds_resultado_w	:=	Obter_dados_ult_cirurgia_atend(vl_atributo_p, 'NA');
	elsif (ds_macro_w = '@DATA_ULT_CIRURGIA_ATEND') then
		ds_resultado_w	:=	Obter_dados_ult_cirurgia_atend(vl_atributo_p, 'DT');
	elsif (ds_macro_w = '@SENHA_ATENDIMENTO_CONVENIO') then
		ds_resultado_w	:=	obter_senha_atendimento(vl_atributo_p);
	elsif (ds_macro_w = '@BALANCO_HIDRICO_DIA_ANTERIOR') then
		select	coalesce(max(ie_liberar_ganho_perda),'N')
		into STRICT	ie_exige_liberacao_w
		from	parametro_medico
		where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

		select	coalesce(sum(CASE WHEN a.ie_perda_ganho='G' THEN  c.qt_volume  ELSE 0 END  - CASE WHEN a.ie_perda_ganho='P' THEN  c.qt_volume  ELSE 0 END ),0)
		into STRICT	ds_resultado_w
		from	tipo_perda_ganho b,
			grupo_perda_ganho a,
			atendimento_perda_ganho c
		where	c.nr_atendimento = vl_atributo_p
		and	b.nr_sequencia = c.nr_seq_tipo
		and	b.nr_seq_grupo = a.nr_sequencia
		and	coalesce(b.ie_soma_bh,'S') = 'S'
		and	((ie_exige_liberacao_w = 'N') or (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> ''))
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(c.dt_referencia,c.dt_medida)) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp() - interval '1 days');
	elsif (ds_macro_w = '@BALANCO_HIDRICO') then
		select	coalesce(max(ie_liberar_ganho_perda),'N')
		into STRICT	ie_exige_liberacao_w
		from	parametro_medico
		where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

		select	coalesce(sum(CASE WHEN a.ie_perda_ganho='G' THEN  c.qt_volume  ELSE 0 END  - CASE WHEN a.ie_perda_ganho='P' THEN  c.qt_volume  ELSE 0 END ),0)
		into STRICT	ds_resultado_w
		from	tipo_perda_ganho b,
			grupo_perda_ganho a,
			atendimento_perda_ganho c
		where	c.nr_atendimento = vl_atributo_p
		and	b.nr_sequencia = c.nr_seq_tipo
		and	b.nr_seq_grupo = a.nr_sequencia
		and	coalesce(b.ie_soma_bh,'S') = 'S'
		and	((ie_exige_liberacao_w = 'N') or (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> ''))
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(c.dt_referencia,c.dt_medida)) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());		
	elsif (ds_macro_w = '@MEDIC_USO_HS') then
		open c12;
		loop
			fetch c12 into
				ds_medic_uso_w;
			EXIT WHEN NOT FOUND; /* apply on c12 */
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w	:= ds_medic_uso_w;
			else
				ds_resultado_w	:= ds_resultado_w || ', ' || ds_medic_uso_w;
			end if;
		end loop;
		close c12;
	elsif (ds_macro_w = '@SETOR_ATENDIMENTO') then
		ds_resultado_w	:= coalesce(Obter_Unidade_Atendimento(vl_atributo_p, 'IA', 'S'),obter_nome_setor(Obter_Setor_Atendimento(vl_atributo_p)));
	elsif (ds_macro_w = '@DT_ENTRADA_SETOR_ATENDIMENTO') then
		--ds_resultado_w	:= Obter_Unidade_Atendimento(vl_atributo_p, 'IA', 'DT');
                select  to_char(max(dt_entrada_unidade),'dd/mm/yyyy hh24:mi:ss')
                into STRICT    ds_resultado_w
                from    atendimento_paciente_v
                where  nr_Atendimento = vl_atributo_p;
        elsif (ds_macro_w = '@HR_ENTRADA_SETOR_ATENDIMENTO') then
                select  to_char(max(dt_entrada_unidade),'hh24:mi')
                into STRICT    ds_resultado_w
                from    atendimento_paciente_v
                where  nr_Atendimento = vl_atributo_p;

	elsif (ds_macro_w = '@ANTIMICROBIANOS') then
		open c14;
		loop
			fetch c14 into
				ds_medic_uso_w,
				nr_dia_w;
			EXIT WHEN NOT FOUND; /* apply on c14 */
				ds_resultado_w	:= ds_resultado_w || ds_medic_uso_w || ' - ' || wheb_mensagem_pck.get_texto(307265) || ' '|| nr_dia_w || chr(13) || chr(10);
		end loop;
		close c14;
	elsif (ds_macro_w = '@MATERIAL_AUTORIZADO') then
		open C15;
		loop
		fetch C15 into
			ds_material_autor_w;
		EXIT WHEN NOT FOUND; /* apply on C15 */
			begin
			ds_resultado_w	:= ds_resultado_w || ds_material_autor_w || chr(13) || chr(10);
			end;
		end loop;
		close C15;
	elsif (ds_macro_w = '@MEDIC_MEDICO_INT_FARM_VIGENTE') then
		open C16;
		loop
		fetch C16 into
			ds_medicamento_w;
		EXIT WHEN NOT FOUND; /* apply on C16 */
			begin
			ds_resultado_w	:= ds_resultado_w || ds_medicamento_w || chr(13) || chr(10);
			end;
		end loop;
		close C16;
	elsif (ds_macro_w = '@MEDIC_MEDICO_INT_FARM_ATEND') then
		open C17;
		loop
		fetch C17 into
			ds_medicamento_w;
		EXIT WHEN NOT FOUND; /* apply on C17 */
			begin
			ds_resultado_w	:= ds_resultado_w || ds_medicamento_w || chr(13) || chr(10);
			end;
		end loop;
		close C17;
	elsif (ds_macro_w = '@MEDIC_Q_MEDICO_INT_FARM_ATEND') then
		open C17;
		loop
		fetch C17 into
			ds_medicamento_w;
		EXIT WHEN NOT FOUND; /* apply on C17 */
			begin
			ds_resultado_w	:= ds_resultado_w || ds_medicamento_w || ' \par ';
			end;
		end loop;
		close C17;
	elsif (ds_macro_w	= '@DT_VALIDADE_USUARIO_CONVENIO') then
		select	coalesce(to_char(max(dt_validade_carteira),'dd/mm/yyyy'), ' ')
		into STRICT	ds_resultado_w
		from	atendimento_paciente_v
		where	nr_atendimento	= vl_atributo_p;
	elsif (ds_macro_w	= '@PROCED_PRINC_ATEND_MEDICO') then

		select	substr(OBTER_PROC_PRINCIPAL(A.NR_ATENDIMENTO, a.CD_CONVENIO, a.IE_TIPO_ATENDIMENTO,0,'SEQ'),1,240)
		into STRICT	nr_seq_proc_w
		from	atendimento_paciente_v a
		where	nr_atendimento	= vl_atributo_p;


		select	coalesce(max(obter_nome_medico(CD_MEDICO_EXECUTOR,'N')),' ')
		into STRICT	ds_resultado_w
		from	procedimento_paciente
		where	nr_sequencia	= nr_seq_proc_w;
	elsif (ds_macro_w	= '@PROCED_PRINC_ATEND_CRM') then

		select	substr(OBTER_PROC_PRINCIPAL(A.NR_ATENDIMENTO, a.CD_CONVENIO, a.IE_TIPO_ATENDIMENTO,0,'SEQ'),1,240)
		into STRICT	nr_seq_proc_w
		from	atendimento_paciente_v a
		where	nr_atendimento	= vl_atributo_p;


		select	coalesce(max(obter_nome_medico(CD_MEDICO_EXECUTOR,'CRM')),' ')
		into STRICT	ds_resultado_w
		from	procedimento_paciente
		where	nr_sequencia	= nr_seq_proc_w;
	elsif (ds_macro_w	= '@PROC_PRINC_ATEND') then
		select	max(DS_PROC_PRINCIPAL)
		into STRICT	ds_resultado_w
		from	atendimento_paciente_v
		where	nr_atendimento	= vl_atributo_p;
	elsif (ds_macro_w	= '@DT_PROC_PRINC_ATEND') then

		select	substr(OBTER_PROC_PRINCIPAL(A.NR_ATENDIMENTO, a.CD_CONVENIO, a.IE_TIPO_ATENDIMENTO,0,'SEQ'),1,240)
		into STRICT	nr_seq_proc_w
		from	atendimento_paciente_v a
		where	nr_atendimento	= vl_atributo_p;


		select	coalesce(max(to_char(dt_procedimento,'dd/mm/yyyy hh24:mi:ss')),' ')
		into STRICT	ds_resultado_w
		from	procedimento_paciente
		where	nr_sequencia	= nr_seq_proc_w;

	elsif (ds_macro_w	= '@RN_PESO') then
		select	max(qt_peso)
		into STRICT	ds_resultado_w
		from	nascimento
		where	nr_atendimento = vl_atributo_p;
	elsif (position('@EXAME_LAB[' in ds_macro_w) = 1) then
		ds_resultado_w	:= ' ';
		nr_seq_exame_w	:= somente_numero(ds_macro_w);
		open C18;
		loop
		fetch C18 into
			qt_result_w,
			pr_result_w;
		EXIT WHEN NOT FOUND; /* apply on C18 */
			begin
			if (coalesce(qt_result_w,0) <> 0) then
				ds_resultado_w	:= to_char(qt_result_w);
			elsif (coalesce(pr_result_w,0) <> 0) then
				ds_resultado_w	:= to_char(pr_result_w);
			end if;
			if (position(',' in ds_resultado_w) = 1) then
				ds_resultado_w := substr('0' || ds_resultado_w,1,2000);
			end if;
			end;
		end loop;
		close C18;
	elsif (ds_macro_w	= '@PLANO_CONVENIO') then
		select	substr(obter_desc_plano(cd_convenio, cd_plano_convenio), 1, 100)
		into STRICT	ds_resultado_w
		from	atend_categoria_convenio
		where	nr_seq_interno	= obter_atecaco_atendimento(vl_atributo_p);
	elsif (ds_macro_w	= '@CATEGORIA_CONVENIO') then
		select	substr(obter_dados_categ_conv(vl_atributo_p, 'DC'), 1, 100)
		into STRICT	ds_resultado_w
		from	atend_categoria_convenio
		where	nr_seq_interno	= obter_atecaco_atendimento(vl_atributo_p);
	elsif (ds_macro_w	= '@TIPO_ATENDIMENTO') then
		select	substr(obter_valor_dominio(12, ie_tipo_atendimento), 1, 100)
		into STRICT	ds_resultado_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;
	elsif (ds_macro_w = '@GLICCAPILAR') then
		select	max(qt_glicemia_capilar)
		into STRICT	ds_resultado_w
		from	atendimento_sinal_vital	
		where	nr_sequencia = (SELECT	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	(qt_glicemia_capilar IS NOT NULL AND qt_glicemia_capilar::text <> '')
					and	nr_atendimento	= vl_atributo_p
					and	ie_situacao = 'A');
	elsif (ds_macro_w = '@HEMODIALISE') then
		begin
		select  max(a.nr_prescricao)
		into STRICT	nr_prescricao_w
		from    prescr_medica a,
		        hd_prescricao b
		where   a.nr_prescricao = b.nr_prescricao
		and     a.nr_atendimento = vl_atributo_p;

		select 	max(nr_sequencia)
		into STRICT	nr_sequencia_w
		from    hd_prescricao b
		where   b.nr_prescricao = nr_prescricao_w;

		select  wheb_mensagem_pck.get_texto(307262,	'DS_TIPO_HEM=' ||substr(obter_valor_dominio(1934,a.ie_tipo_hemodialise),1,255) || ';' ||
													'QT_FLUXO_SAN=' || a.qt_fluxo_sangue || ';' ||
													'QT_HORA=' || a.qt_hora_sessao || ';' ||
													'QT_MINUTO=' || a.qt_min_sessao || ';' ||
													'DS_MODELO=' || obter_desc_modelo_dialise(a.nr_seq_mod_dialisador) || ';' ||
													'QT_PESO=' || a.qt_peso_ideal || ';' ||
													'DS_ULTRAFILTRACAO=' || substr(obter_valor_dominio(1936,a.ie_ultrafiltracao),1,255) || ';' ||
													'QT_ULTRAFILTRACAO=' || a.qt_ultrafiltracao || ';' ||
													'NR_AGULHA=' || hd_obter_desc_diametro_agulha(a.nr_seq_diametro_agulha) || ';' ||
													'DS_PERFIL=' || a.nr_seq_perfil_sodio || ';' ||
													'QT_ZERO_UM=' || a.qt_zero_um || ';' ||
													'QT_UM_DOIS=' || a.qt_um_dois || ';' ||
													'QT_DOIS_TRES=' || a.qt_dois_tres || ';' ||
													'QT_TRES_QUATRO=' || a.qt_tres_quatro)
		into STRICT	ds_result_aux
		from    hd_prescricao a
		where   nr_prescricao = nr_prescricao_w
		and		nr_sequencia = nr_sequencia_w;

		ds_resultado_w	:= ds_result_aux;

		open C19;
		loop
		fetch C19 into
			ds_result_aux,
			nr_seq_solucao_w;
		EXIT WHEN NOT FOUND; /* apply on C19 */
			begin
			ds_resultado_w	:= ds_resultado_w ||chr(13)|| chr(13) || chr(10) ||ds_result_aux;

			open C20;
			loop
			fetch C20 into
				ds_result_aux;
			EXIT WHEN NOT FOUND; /* apply on C20 */
				begin
				ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10) ||ds_result_aux;
				end;
			end loop;
			close C20;

			end;
		end loop;
		close C19;
		end;

	elsif (ds_macro_w = '@EXAMES') then
		begin
		open C21;
		loop
		fetch C21 into
			ds_result_aux;
		EXIT WHEN NOT FOUND; /* apply on C21 */
			begin
			ds_resultado_w	:= substr(ds_resultado_w||ds_result_aux || chr(13) || chr(10),1,2000);
			end;
		end loop;
		close C21;
		end;

	elsif (ds_macro_w = '@LAUDOLME') then
		begin
		open C22;
		loop
		fetch C22 into
			ds_result_aux;
		EXIT WHEN NOT FOUND; /* apply on C22 */
			begin
			if (coalesce((length(ds_resultado_w)+length(ds_result_aux)),0) < 2000) then
				ds_resultado_w	:= ds_resultado_w || ds_result_aux || chr(13) || chr(10);
			else
				exit;
			end if;
			end;
		end loop;
		close C22;
		end;
	elsif (ds_macro_w = '@DEF_DIAGNOSTICO') then
		begin
		ds_resultado_w	:= Obter_Diagnostico_atend_def(vl_atributo_p);
		end;
	elsif (ds_macro_w = '@PRE_DIAGNOSTICO') then
		begin
		ds_resultado_w	:= Obter_Diagnostico_atend_Pre(vl_atributo_p);
		end;
	elsif (ds_macro_w = '@NHS') then
		begin
		select  max(qt_pontuacao||' - '||substr(obter_descr_escala_earq(qt_pontuacao),1,255))
		into STRICT	ds_resultado_w
		from    escala_earq a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   escala_earq b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@GLASGOW') then
		begin
		select  max(qt_glasgow||' - '||substr(obter_resultado_glasgow(qt_glasgow),1,100))
		into STRICT	ds_resultado_w
		from    atend_escala_indice a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   atend_escala_indice b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESCALA_KATZ') then
		begin
		select  max(QT_PONTUACAO||' - '||substr(OBTER_DESCR_ESCALA_KATZ(QT_PONTUACAO),1,255))
		into STRICT	ds_resultado_w
		from    escala_KATZ a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   escala_KATZ b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESCALA_KARNOFSKY') then
		begin
		select  max(ie_KARNOFSKY||' - '|| substr(obter_valor_dominio(1531,ie_KARNOFSKY),1,255))
		into STRICT	ds_resultado_w
		from     ESCALA_KARNOFSKY a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   ESCALA_KARNOFSKY b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESC_SAPS') then
		begin
		SELECT max(wheb_mensagem_pck.get_texto(307232) || ' ' || QT_PONTUACAO || ', ' || wheb_mensagem_pck.get_texto(307223) || ' ' || PR_RISCO || '%' ||  CASE WHEN coalesce(PR_RISCO_AMERICA_SUL::text, '') = '' THEN ''  ELSE ', '||wheb_mensagem_pck.get_texto(307234)||' ' || PR_RISCO_AMERICA_SUL || '%' END ) -- Pontuacao ..., Risco ...% Risco America do Sul
		into STRICT	ds_resultado_w
		FROM    ESCALA_SAPS3 a
		WHERE   a.nr_sequencia = (SELECT MAX(b.nr_sequencia)
					  FROM   ESCALA_SAPS3 b
					  WHERE  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		END;
	elsif (ds_macro_w = '@ESCALA_APACHE_II') then
		begin
		select  max(QT_APACHE_II)
		into STRICT	ds_resultado_w
		from    APACHE a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   APACHE b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESC_TEV') then
		begin
		SELECT  max(wheb_mensagem_pck.get_texto(307223) || ' '|| obter_valor_dominio(2900,IE_RISCO) || ', ' || DS_RESULTADO) -- Risco
		INTO STRICT	ds_resultado_w
		FROM    ESCALA_TEV a
		WHERE   a.nr_sequencia = (SELECT MAX(b.nr_sequencia)
					  FROM   ESCALA_TEV b
					  WHERE  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@CAM_ICU') then
		begin
		select  max(substr(obter_result_cam_icu(ie_alt_estado_mental,ie_comport_anormal,ie_focar_atencao,ie_distraido,ie_desorganizado,ie_consiencia),1,255))
		into STRICT	ds_resultado_w
		from    escala_cam_icu a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   escala_cam_icu b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESCALA_RASS') then
		begin
		select  max(ie_rass)
		into STRICT	ds_resultado_w
		from    ESCALA_RICHMOND a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   ESCALA_RICHMOND b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@LAST_PULS_SCORE') then
		begin
		select  max(coalesce(TO_CHAR(dt_avaliacao,'dd/mm/yyyy'), ' ') ||' - '|| IE_PULS || ' - ' || obter_valor_dominio(8637,IE_PULS))
			into STRICT	ds_resultado_w
			from    ESCALA_PULS a
			where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
						  from   ESCALA_PULS b
						  where  nr_atendimento = vl_atributo_p
						  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
						  and	coalesce(b.dt_inativacao::text, '') = '');
		end;	
	elsif (ds_macro_w = '@ESCALA_TENETTI') then
		begin
		select  max(qt_pontuacao)
		into STRICT	ds_resultado_w
		from    escala_tenetti a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   escala_tenetti b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@BRADEN') then
		begin
		select  max(qt_ponto||' - '||substr(obter_resultado_braden(qt_ponto),1,255))
		into STRICT	ds_resultado_w
		from    atend_escala_braden a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   atend_escala_braden b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESCALA_BRADEN') then
		begin
		select  max(substr(pkg_date_formaters.to_varchar(dt_avaliacao,'shortDate',1,wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario),1,255)||' - '||qt_ponto||' - '||substr(obter_resultado_braden(qt_ponto),1,255))
		into STRICT	ds_resultado_w
		from    atend_escala_braden a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   atend_escala_braden b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESCALA_CAPRINI') then
		begin
		--Tratamento especifico alemanha. Nao deve ser utilizado no Java/Delphi ate a resolucao da OS 1824270
		select  max(substr(pkg_date_formaters.to_varchar(dt_avaliacao,'shortDate',1,wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario),1,255)||' - '||qt_pontuacao||' - '||substr(obter_valor_dominio(8636,ie_risco),1,255)) || '<br/>'||
				max(ds_resultado)
		into STRICT	ds_resultado_w
		from    escala_caprini a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
								  from   escala_caprini b
								  where  nr_atendimento = vl_atributo_p
								  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
								  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESCALA_BARTHEL_ESTENDIDA') then
		begin
		select  max(substr(pkg_date_formaters.to_varchar(dt_avaliacao,'shortDate',1,wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario),1,255)||' - '||qt_pontuacao||' - '||substr(obter_desc_extended_barthel(qt_pontuacao),1,100))
		into STRICT	ds_resultado_w
		from    escala_barthel_modificada a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   escala_barthel_modificada b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESCALA_EARQ') then
		begin
		select  max(substr(pkg_date_formaters.to_varchar(dt_avaliacao,'shortDate',1,wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario),1,255)||' - '||qt_pontuacao||' - '||substr(obter_descr_escala_earq(qt_pontuacao),1,255))
		into STRICT	ds_resultado_w
		from    escala_earq a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   escala_earq b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESCALA_NRS_2002') then
		begin
		select  max(substr(pkg_date_formaters.to_varchar(dt_avaliacao,'shortDate',1,wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario),1,255)||' - '||qt_pontuacao||' - '||substr(Obter_Resul_nrs(qt_pontuacao),1,255))
		into STRICT	ds_resultado_w
		from    escala_nrs a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   escala_nrs b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESCALA_STRATIFY') then
		begin
		select  max(qt_score||' - '||substr(obter_desc_escala_stratify(qt_score),1,100))
		into STRICT	ds_resultado_w
		from    escala_stratify a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   escala_stratify b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESCALA_NAS') then
		begin
		select  max(qt_pontuacao)
		into STRICT	ds_resultado_w
		from    escala_nas a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   escala_nas b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@ESCALA_FLEBITE') then
		begin
		select  max(ie_intensidade ||' - '|| obter_valor_dominio(3341,ie_intensidade))
		into STRICT	ds_resultado_w
		from    escala_flebite a
		where   a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from   escala_flebite b
					  where  nr_atendimento = vl_atributo_p
					  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					  and	coalesce(b.dt_inativacao::text, '') = '');
		end;
	elsif (ds_macro_w = '@EXAME_RED') then
		begin
		open C25;
		loop
		fetch C25 into
			ds_result_aux;
		EXIT WHEN NOT FOUND; /* apply on C25 */
			begin
			ds_resultado_w	:= ds_resultado_w || ds_result_aux || ', ';
			end;
		end loop;
		close C25;
		end;
	elsif (ds_macro_w = '@PROC_SOLIC_RED') then
		begin
		open C27;
		loop
		fetch C27 into
			ds_proced_prescrito_w;
		EXIT WHEN NOT FOUND; /* apply on C27 */
			begin
			ds_resultado_w := substr(ds_resultado_w||ds_proced_prescrito_w||',',1,2000);
			end;
		end loop;
		close C27;
		end;
	elsif (ds_macro_w = '@MEDIC_MEDICO_INT_FARM_RED') then
		begin
		open C26;
		loop
		fetch C26 into
			ds_medicamento_w;
		EXIT WHEN NOT FOUND; /* apply on C26 */
			begin
			ds_resultado_w	:= ds_resultado_w || ds_medicamento_w || ', ';
			end;
		end loop;
		close C26;
		end;
	elsif (ds_macro_w = '@MEDIC_ADEP_CHECK_VIGENTE') then
		open C28;
		loop
		fetch C28 into
			ds_medicamento_w;
		EXIT WHEN NOT FOUND; /* apply on C28 */
			begin
			ds_resultado_w	:= ds_resultado_w || ds_medicamento_w || chr(13) || chr(10);
			end;
		end loop;
		close C28;
	elsif (ds_macro_w = '@SOLUC_ADEP_CHECK_VIGENTE') then
		open C29;
		loop
		fetch C29 into
			ds_solucao_w;
		EXIT WHEN NOT FOUND; /* apply on C29 */
			begin
			ds_resultado_w	:= ds_resultado_w || ds_solucao_w || chr(13) || chr(10);
			end;
		end loop;
		close C29;
	elsif (ds_macro_w = '@EXAM_ADEP_CHECK_VIGENTE') then
		open C30;
		loop
		fetch C30 into
			ds_exames_w;
		EXIT WHEN NOT FOUND; /* apply on C30 */
			begin
			ds_resultado_w	:= ds_resultado_w || ds_exames_w || chr(13) || chr(10);
			end;
		end loop;
		close C30;
	elsif (ds_macro_w = '@SAE_DIAG_ENFERMAGEM') then
		open C31;
		loop
		fetch C31 into
			dt_pe_prescricao,
			nr_seq_pe_prescricao_w,
			nm_prescritor_pe_prescr_w;
		EXIT WHEN NOT FOUND; /* apply on C31 */
			begin

			ds_resultado_w	:= ds_resultado_w || PKG_DATE_FORMATERS.to_varchar(dt_pe_prescricao, 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO) || chr(13) || chr(10);

			open C32;
			loop
			fetch C32 into
				ds_pe_diagnostico_w,
				ds_pe_evolucao_diag_w,
				nr_pe_seq_diag_w;
			EXIT WHEN NOT FOUND; /* apply on C32 */
				begin
				ds_resultado_w	:= ds_resultado_w || chr(09) ||ds_pe_diagnostico_w;

				if (ds_pe_evolucao_diag_w IS NOT NULL AND ds_pe_evolucao_diag_w::text <> '') then
					ds_resultado_w := ds_resultado_w ||' - ' || ds_pe_evolucao_diag_w || chr(13) || chr(10);
				else
					ds_resultado_w := ds_resultado_w ||chr(13) || chr(10);
				end if;

				end;
			end loop;
			close C32;
			end;
		end loop;
		close C31;
	elsif (ds_macro_w = '@PAC_BIOBANCO') then
		begin
		select	substr(CASE WHEN obter_se_paciente_biobanco(vl_atributo_p)='S' THEN  wheb_mensagem_pck.get_texto(307220) || ' ' || wheb_mensagem_pck.get_texto(307221) ||': ' || wheb_mensagem_pck.get_texto(307222)   ELSE ' ' END ,1,100) -- Paciente Biobanco: Sim
		into STRICT	ie_paciente_biobanco_w
		;

		ds_resultado_w :=  ds_resultado_w || ie_paciente_biobanco_w;
		end;
	elsif (ds_macro_w = '@MED_ATEND_PRIM') then
		begin
		select 	substr(Obter_Primeiro_Nome(Obter_medico_resp_atend(vl_atributo_p,'N')),1,255)
		into STRICT	nm_prim_medico_w
		;

		ds_resultado_w :=  ds_resultado_w || nm_prim_medico_w;
		end;
		
	elsif (ds_macro_w = '@MED_RESP') then
		begin
		select 	substr(OBTER_NOME_MEDICO(cd_medico_resp,'N'),1,255)
		into STRICT	nm_medico_w
		from	atendimento_paciente
		where	nr_atendimento = vl_atributo_p;

		ds_resultado_w :=  ds_resultado_w || nm_medico_w;
		end;

   elsif (ds_macro_w = '@PROC_PREVISTO') then
      begin
      open C24;
      loop
      fetch C24 into
      	ds_proced_prescrito_w;
      EXIT WHEN NOT FOUND; /* apply on C24 */
      	begin
      	ds_resultado_w := ds_resultado_w||ds_proced_prescrito_w||','||chr(10);
      	end;
      end loop;
      close C24;
      end;
   elsif (ds_macro_w = '@PROC_EXTERNO') then
      begin
      open C23;
      loop
      fetch C23 into
      	ds_proced_externo_w;
      EXIT WHEN NOT FOUND; /* apply on C23 */
      	begin
      	ds_resultado_w := ds_resultado_w||ds_proced_externo_w||','||chr(10);
      	end;
      end loop;
      close C23;
      end;
   elsif (ds_macro_w = '@OBS_ATENDIMENTO') then
	  begin
	  select max(ds_observacao)
	  into STRICT	ds_resultado_w
	  from	atendimento_paciente
	  where nr_atendimento = vl_atributo_p;
	  end;
   -- INICIO MACROS SOLICITACAO JAPAO
   elsif (ds_macro_w = '@EXAMUSERID') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@EXAMUSERID');
   elsif (ds_macro_w = '@EXAMUSERNAME') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@EXAMUSERNAME');
   elsif (ds_macro_w = '@EXAMNAME') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@EXAMNAME');
   elsif (ds_macro_w = '@EXAMKACD') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@EXAMKACD');
   elsif (ds_macro_w = '@EXAMTIME') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@EXAMTIME');
   elsif (ds_macro_w = '@EXAMDATE') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@EXAMDATE');
   elsif (ds_macro_w = '@USERSECTEL') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@USERSECTEL');
   elsif (ds_macro_w = '@USERSECFAX') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@USERSECFAX');
   elsif (ds_macro_w = '@INFECTIONS') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@INFECTIONS');
   elsif (ds_macro_w = '@ATTETINGNURSES') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@ATTETINGNURSES');
   elsif (ds_macro_w = '@ATTETINGDOCTORS') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@ATTETINGDOCTORS');
   elsif (ds_macro_w = '@CURINLEAVEPRES') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@CURINLEAVEPRES');
   elsif (ds_macro_w = '@CURINDISEASE') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@CURINDISEASE');
   elsif (ds_macro_w = '@SALAPACIENTE') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@SALAPACIENTE');
   elsif (ds_macro_w = '@HOSPNAME') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@HOSPNAME');
   elsif (ds_macro_w = '@HOSPCEO') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@HOSPCEO');
   elsif (ds_macro_w = '@HOSPCEONAME') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@HOSPCEONAME');
   elsif (ds_macro_w = '@HOSPADDR') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@HOSPADDR');
   elsif (ds_macro_w = '@HOSPFAX') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@HOSPFAX');
   elsif (ds_macro_w = '@HOSPTEL') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@HOSPTEL');
   elsif (ds_macro_w = '@HOSZIP') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@HOSZIP');
   elsif (ds_macro_w = '@NOMEPACIENTEKANA') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@NOMEPACIENTEKANA');
   elsif (ds_macro_w = '@CURINADMGDATE') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@CURINADMGDATE');
   elsif (ds_macro_w = '@CURINLEAVEGDATE') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@CURINLEAVEGDATE');
   elsif (ds_macro_w = '@BLOODTYPEABO') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@BLOODTYPEABO');
   elsif (ds_macro_w = '@BLOODTYPERH') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@BLOODTYPERH');
   elsif (ds_macro_w = '@FAMILYHISTORY') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@FAMILYHISTORY');
   elsif (ds_macro_w = '@SYSGDATE') then
      ds_resultado_w := OBTER_DADOS_SOLIC_JAPAO(vl_atributo_p,'@SYSGDATE');
   -- FIM MACROS SOLICITACAO JAPAO          
   elsif (ds_macro_w = '@DATA_INICIO_CIRURGIA') then
	  begin
	  select	coalesce(to_char(max(dt_inicio_real),'dd/mm/yyyy hh24:mi:ss'),' ')
	  into STRICT		ds_resultado_w
	  from		cirurgia
	  where		nr_cirurgia = (	SELECT	max(nr_cirurgia)
					from	cirurgia
					where	nr_atendimento = vl_atributo_p);
	  end;
   elsif (ds_macro_w = '@DATA_FIM_CIRURGIA') then
	  begin
	  select	coalesce(to_char(max(dt_termino),'dd/mm/yyyy hh24:mi:ss'),' ')
	  into STRICT		ds_resultado_w
	  from		cirurgia
	  where		nr_cirurgia = (	SELECT	max(nr_cirurgia)
					from	cirurgia
					where	nr_atendimento = vl_atributo_p);
	  end;

   elsif (ds_macro_w = '@RISCO_TEV') then
	  begin
	
	  select	max(obter_valor_dominio(2900,a.ie_risco))
	  into STRICT		ds_resultado_w

	  from		escala_tev a
	  where		a.nr_sequencia = (	SELECT	max(b.nr_sequencia)
									from	escala_tev b

									where	b.nr_atendimento = vl_atributo_p
									and		coalesce(b.ie_situacao,'A') = 'A');	
	  end;

   elsif (ds_macro_w = '@MEDIC_PACIENTE_USO_HS') then
		open c33;
		loop
			fetch c33 into
				ds_medic_uso_w;
			EXIT WHEN NOT FOUND; /* apply on c33 */
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w	:= ds_medic_uso_w;
			else
				ds_resultado_w	:= ds_resultado_w || ', ' || ds_medic_uso_w;
			end if;
		end loop;
		close c33;
	elsif (ds_macro_w = '@ATEND_PERDA') then
		begin
		select	coalesce(max(ie_liberar_ganho_perda),'N')
		into STRICT	ie_exige_liberacao_w
		from	parametro_medico
		where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

		select	sum(c.qt_volume)
		into STRICT	ds_resultado_w
		from	tipo_perda_ganho b,
				grupo_perda_ganho a,
				atendimento_perda_ganho c
		where	c.nr_atendimento = vl_atributo_p
		and		b.nr_sequencia = c.nr_seq_tipo
		and		a.ie_perda_ganho = 'P'
		and		b.nr_seq_grupo = a.nr_sequencia
		and		coalesce(b.ie_soma_bh,'S') = 'S'
		and		((ie_exige_liberacao_w = 'N') or (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> ''))
		and		coalesce(c.ie_situacao,'A') = 'A'
		and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(c.dt_referencia,c.dt_medida)) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());
		end;
	elsif (ds_macro_w = '@CIRURGIAS_ATEND') then
		begin
		open C35;
		loop
		fetch C35 into	
			nr_cirurgia_w,
			ds_procedimento_w,
			ds_resumo_cirurgia_w,
			ds_diagnostico_w,
			ds_diagnostico_pos_w;
		EXIT WHEN NOT FOUND; /* apply on C35 */
			begin
			ds_resultado_w := substr(ds_resultado_w || wheb_mensagem_pck.get_texto(344128) || ': ' || ds_procedimento_w || ' (' || nr_cirurgia_w || ')' || Chr(13) ||  Chr(10),1,2000);
			ds_resultado_w := substr(ds_resultado_w || wheb_mensagem_pck.get_texto(344129) || ': ' || ds_resumo_cirurgia_w || Chr(13) ||  Chr(10),1,2000);
			ds_resultado_w := substr(ds_resultado_w || wheb_mensagem_pck.get_texto(344130) || ': ' || ds_diagnostico_w || Chr(13) ||  Chr(10),1,2000);
			ds_resultado_w := substr(ds_resultado_w || wheb_mensagem_pck.get_texto(344131) || ': ' || ds_diagnostico_pos_w || Chr(13) ||  Chr(10) || Chr(13) ||  Chr(10),1,2000);
			end;
		end loop;
		close C35;
		end;
	elsif (ds_macro_w = '@ATEND_GANHO') then
		begin
		select	coalesce(max(ie_liberar_ganho_perda),'N')
		into STRICT	ie_exige_liberacao_w
		from	parametro_medico
		where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

		select	sum(c.qt_volume)
		into STRICT	ds_resultado_w
		from	tipo_perda_ganho b,
				grupo_perda_ganho a,
				atendimento_perda_ganho c
		where	c.nr_atendimento = vl_atributo_p
		and		b.nr_sequencia = c.nr_seq_tipo
		and		a.ie_perda_ganho = 'G'
		and		b.nr_seq_grupo = a.nr_sequencia
		and		coalesce(b.ie_soma_bh,'S') = 'S'
		and		((ie_exige_liberacao_w = 'N') or (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> ''))
		and		coalesce(c.ie_situacao,'A') = 'A'
		and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(c.dt_referencia,c.dt_medida)) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());
		end;
	elsif (ds_macro_w = '@INFO_ADIC_DIAG') then
		if (obter_uso_case(wheb_usuario_pck.get_nm_usuario) = 'S')then
			select 	nr_seq_episodio
			into STRICT 	nr_case_w
			from 	atendimento_paciente
			where	nr_atendimento = vl_atributo_p;
		end if;
		cd_pessoa_fisica_w := obter_pessoa_atendimento(vl_atributo_p,'C');
		open C38;
		loop
		fetch C38 into
			cd_doenca_w,
			ds_cid_doenca_w;
		EXIT WHEN NOT FOUND; /* apply on C38 */
		begin
			ds_resultado_w	:= ds_resultado_w || ds_cid_doenca_w || chr(13) || chr(10);
			open C39;
			loop
			fetch C39 into
				ds_info_adic_diag_w;
			EXIT WHEN NOT FOUND; /* apply on C39 */
			begin
				ds_resultado_w	:= ds_resultado_w || ds_info_adic_diag_w || chr(13) || chr(10);
			end;
			end loop;
			close C39;
			ds_resultado_w := ds_resultado_w || chr(13) || chr(10);
		end;
		end loop;
		close C38;
    else
		gerar_result_macro_sql;
	end if;
	end;
elsif (nm_atributo_p = 'CD_PESSOA_USUARIO') then
	begin
	if (ds_macro_w	= '@MEDICO') then
		ds_resultado_w	:= obter_nome_medico(vl_atributo_p,'P');
	elsif (ds_macro_w	= '@NM_MEDICO') then
		ds_resultado_w	:= obter_nome_medico(vl_atributo_p,'PS');
	elsif (ds_macro_w	= '@CRM') then
		ds_resultado_w	:= wheb_mensagem_pck.get_texto(307217) || ' ' || obter_nome_medico(vl_atributo_p,'CRM'); -- CRM
	elsif (ds_macro_w	= '@ACADEMICO') then
		ds_resultado_w	:= wheb_mensagem_pck.get_texto(307215) || ' ' || obter_nome_pf(vl_atributo_p); -- Ac.
	elsif (ds_macro_w	= '@NM_USUARIO') then
		ds_resultado_w	:=	obter_nome_usuario(coalesce(wheb_usuario_pck.get_nm_usuario,obter_usuario_pf(vl_atributo_p)));
	elsif (ds_macro_w	= '@CONSELHO') then
--		ds_resultado_w	:=	nvl(obter_dados_medico(vl_atributo_p,'SGCRM'),obter_dados_pf(vl_atributo_p,'CON')) || ' ' || obter_dados_medico(vl_atributo_p,'CRM');
		select	max(coalesce(obter_dados_medico(vl_atributo_p,'SGCRM'),obter_dados_pf(vl_atributo_p,'CON')) || ' ' ||
								coalesce(obter_dados_medico(vl_atributo_p,'CRM'),obter_dados_pf(vl_atributo_p,'CPR')))
		into STRICT	ds_resultado_w
		;
	elsif (ds_macro_w	= '@DS_CARGO_USUARIO') then
		ds_resultado_w	:= coalesce(obter_dados_pf(vl_atributo_p, 'CR'),' ');
	else
		gerar_result_macro_sql;
	end if;
	end;
elsif (nm_atributo_p		= 'NR_SEQ_AGENDA') then
	begin
	if (ds_macro_w	= '@EXECUTOR_AGENDA') then
		select	obter_nome_medico(cd_medico_exec,'PS')
		into STRICT	ds_resultado_w
		from	agenda_paciente
		where	nr_sequencia	= vl_atributo_p;
	elsif (ds_macro_w	= '@CIRURGIAO_AGENDA') then
		select	obter_nome_medico(cd_medico,'PS')
		into STRICT	ds_resultado_w
		from	agenda_paciente
		where	nr_sequencia	= vl_atributo_p;
	elsif (ds_macro_w	= '@PROC_PRINC_AG_EXAME') then
		select	substr(obter_exame_agenda(cd_procedimento, ie_origem_proced, nr_seq_proc_interno),1,255)
		into STRICT	ds_resultado_w
		from	agenda_paciente
		where	nr_sequencia	= vl_atributo_p;
	elsif (ds_macro_w  = '@CIRURGIA') then
		select  nr_cirurgia
		into STRICT	ds_resultado_w
		from	agenda_paciente
		where	nr_sequencia	= vl_atributo_p;
	elsif (ds_macro_w  = '@CRMCIRURGIAOAGENDA') then
		select  Obter_CRM_Medico(cd_medico)
		into STRICT	ds_resultado_w
		from	agenda_paciente
		where	nr_sequencia	= vl_atributo_p;
	elsif (ds_macro_w = '@PROCADICIONAIS') then
		for line in c40 loop
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w	:= line.ds_proc_adic;
			else
				ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10) || line.ds_proc_adic;
			end if;	
		end loop;
	else
		gerar_result_macro_sql;
	end if;
	end;
elsif (nm_atributo_p = 'CD_EVOLUCAO') then
	begin
	if (ds_macro_w	= '@ESPECIALIDADE_EVOLUCAO') then
		select	obter_especialidade_medico(cd_medico,'D')
		into STRICT	ds_resultado_w
		from	evolucao_paciente
		where	cd_evolucao = vl_atributo_p;
	else
		gerar_result_macro_sql;
	end if;
	end;
elsif (nm_atributo_p = 'NR_CIRURGIA') then
	begin
	if (ds_macro_w	= '@PROCEDIMENTO_CIRURGIA') then
		/*
		select 	substr(obter_exame_agenda(cd_procedimento_princ, ie_origem_proced, nr_seq_proc_interno),1,240),
		       	nr_prescricao
		into	ds_resultado_w,
			nr_prescricao_w
		from   	cirurgia
		where  	nr_cirurgia = vl_atributo_p;
		*/
		open c08;
		loop
		fetch c08 into
			ds_procedimento_w,
			ie_tipo_w;
		EXIT WHEN NOT FOUND; /* apply on c08 */
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w	:= ds_procedimento_w;
			else
				ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10) || ds_procedimento_w;
			end if;	
		end loop;
		close c08;
		
	elsif (ds_macro_w = '@COD_PROCEDIMENTO_CIRURGIA') then
		--c08_cod_procedimento
		for c08_cod_procedimento_w in c08_cod_procedimento loop
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w	:= c08_cod_procedimento_w.cd_procedimento_w;
			else
				ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10) || c08_cod_procedimento_w.cd_procedimento_w;
			end if;	
		end loop;
	elsif (ds_macro_w	= '@DISPOSITIVO_CIRURGIA') then
		open c06;
		loop
			fetch c06 into
				ds_dispositivo_w;
			EXIT WHEN NOT FOUND; /* apply on c06 */
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w	:= ds_dispositivo_w;
			else
				ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10) || ds_dispositivo_w;
			end if;
		end loop;
		close c06;
	elsif (ds_macro_w	= '@MATERIAS_CIRURGIA') then
		open c07;
		loop
			fetch c07 into
				ds_material_w;
			EXIT WHEN NOT FOUND; /* apply on c07 */
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w	:= ds_material_w;
			else
				ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10) || ds_material_w;
			end if;
		end loop;
		close c07;
	elsif (ds_macro_w	= '@MATERIAIS_CIRURGIA_COM_APRESENTACAO') then
		open c34;
		loop
			fetch c34 into
				ds_material_w;
			EXIT WHEN NOT FOUND; /* apply on c34 */
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w	:= substr(ds_material_w,1,2000);
			else
				ds_resultado_w	:= substr(ds_resultado_w || chr(13) || chr(10) || ds_material_w,1,2000);
			end if;
		end loop;
		close c34;	
	elsif (ds_macro_w	= '@AGENTES_CIRURGIA') then
		open c09;
		loop
			fetch c09 into
				ds_agente_w;
			EXIT WHEN NOT FOUND; /* apply on c09 */
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w	:= ds_agente_w;
			else
				ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10) || ds_agente_w;
			end if;
		end loop;
		close c09;
	elsif (ds_macro_w	= '@MEDICAMENTOS_CIRURGIA') then
		open c10;
		loop
			fetch c10 into
				ds_medicamento_w;
			EXIT WHEN NOT FOUND; /* apply on c10 */
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w	:= ds_medicamento_w;
			else
				ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10) || ds_medicamento_w;
			end if;
		end loop;
		close c10;
   elsif (ds_macro_w = '@TERAPIA_HIDRO_CIRURGIA') then
      open c36;
		loop
			fetch c36 into
				ds_agente_terapia_w;
			EXIT WHEN NOT FOUND; /* apply on c36 */
			if (coalesce(ds_resultado_w::text, '') = '') then
				ds_resultado_w	:= ds_agente_terapia_w;
			else
				ds_resultado_w	:= ds_resultado_w || chr(13) || chr(10) || ds_agente_terapia_w;
			end if;
		end loop;
		close c36;
	elsif (ds_macro_w = '@CIRURGIA') then
		ds_resultado_w := vl_atributo_p;
	else
		gerar_result_macro_sql;	
   end if;
	end;
elsif (nm_atributo_p = 'NR_LAUDO') then
	begin
	if (ds_macro_w	= '@NM_LAUDANTE_MED') then
		begin
		select	obter_nome_medico(cd_medico_resp,'N')
		into STRICT	ds_resultado_w
		from	laudo_paciente
		where	nr_sequencia = vl_atributo_p;
		end;

	elsif (ds_macro_w	= '@LAUDANTE_CRM_MED') then
		begin
		select	obter_nome_medico(cd_medico_resp,'CRM')
		into STRICT	ds_resultado_w
		from	laudo_paciente
		where	nr_sequencia = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@MED_SOLICITANTE') then		
		begin
	   	select   nm_medico_solicitante
	   	into STRICT	 ds_resultado_w
	   	from laudo_paciente		
	   	where	nr_sequencia = vl_atributo_p;
	   	end;
	elsif (ds_macro_w	= '@DS_TITULO_LAUDO') then
		begin
		select	substr(ds_titulo_laudo,1,255)
		into STRICT	ds_resultado_w
		from	laudo_paciente
		where	nr_sequencia = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@DT_LAUDO') then
		begin
		select	coalesce(to_char(max(dt_atualizacao),'dd/mm/yyyy'), ' ')
		into STRICT	ds_resultado_w
		from	laudo_paciente
		where	nr_sequencia = vl_atributo_p;
		end;
	elsif (ds_macro_w	= '@DT_LIBE_LAUDO') then
		begin
		select	coalesce(to_char(max(dt_liberacao),'dd/mm/yyyy'), ' ')
		into STRICT	ds_resultado_w
		from	laudo_paciente
		where	nr_sequencia = vl_atributo_p;
		end;
	elsif (ds_macro_w 	= '@NR_CONTROLE_EXT') then
		begin

		select	max(nr_prescricao) nr_prescricao,
			max(nr_seq_prescricao) nr_seq_prescricao
		into STRICT	nr_prescricao_w,
			nr_seq_prescricao_w
		from	laudo_paciente
		where	nr_sequencia = vl_atributo_p;

		select	max(nr_controle_ext)
		into STRICT	ds_resultado_w
		from	prescr_procedimento
		where	nr_prescricao = nr_prescricao_w
		and	nr_sequencia = nr_seq_prescricao_w;
		end;
	
	elsif (ds_macro_w 	= '@TIPO_PROCEDIMENTO') then
		begin
		select	max(nr_prescricao) nr_prescricao,
			    max(nr_seq_prescricao) nr_seq_prescricao
		into STRICT	nr_prescricao_w,
			    nr_seq_prescricao_w
		from	laudo_paciente
		where	nr_sequencia = vl_atributo_p;

		select	substr(Obter_Desc_Tipo_Procedimento(cd_procedimento, ie_origem_proced),1,240)
		into STRICT	ds_resultado_w
		from	prescr_procedimento
		where	nr_prescricao = nr_prescricao_w
		and     nr_sequencia = nr_seq_prescricao_w;
		end;	
	
	elsif (ds_macro_w = '@NR_ACESSO_DICOM') then
		begin
			select max(nr_acesso_dicom)
			into STRICT ds_resultado_w
			from laudo_paciente lp
			join procedimento_paciente proc on (lp.nr_seq_proc = proc.nr_sequencia)
			join prescr_procedimento pp ON (pp.nr_prescricao = proc.nr_prescricao and pp.nr_sequencia = proc.nr_sequencia_prescricao)
			where lp.nr_sequencia = vl_atributo_p;
		end;

    elsif (ds_macro_w = '@MAINRECIPIENT') then
        select  coalesce(substr(obter_nome_pf(cd_medico), 1, 60),nm_destinatario)
	    into STRICT    ds_resultado_w 
	    from    LAUDO_PACIENTE_RECIPIENT 
        where	nr_seq_laudo = vl_atributo_p
        and     ie_main_recipient = 'S'
        and     ie_situacao != 'I'  LIMIT 1;
    elsif (ds_macro_w = '@RECIPIENT') then
        select  coalesce(substr(obter_nome_pf(cd_medico), 1, 60),nm_destinatario)
	    into STRICT    ds_resultado_w
	    from    LAUDO_PACIENTE_RECIPIENT 
        where	nr_seq_laudo = vl_atributo_p
        and     ie_main_recipient <> 'S'
        and     ie_situacao != 'I'  LIMIT 1;
   elsif (ds_macro_w = '@ADRESSMAINRECIPIENT') then
        select  obter_compl_pf(cd_medico, ie_tipo_complemento_w, ie_descricao_w)
	    into STRICT    ds_resultado_w 
	    from    LAUDO_PACIENTE_RECIPIENT 
        where	nr_seq_laudo = vl_atributo_p
        and     ie_main_recipient = 'S'
        and     ie_situacao != 'I'  LIMIT 1;
   elsif (ds_macro_w = '@ADRESSRECIPIENT') then
        select  obter_compl_pf(cd_medico, ie_tipo_complemento_w, ie_descricao_w)
	    into STRICT    ds_resultado_w 
	    from    LAUDO_PACIENTE_RECIPIENT 
        where	nr_seq_laudo = vl_atributo_p
        and     ie_main_recipient <> 'S'
        and     ie_situacao <> 'I'  LIMIT 1;
	else
		gerar_result_macro_sql;		
	end if;
	end;
elsif (nm_atributo_p = 'NR_SEQ_CONSULTA') then
	begin
	ie_refracao_lib_w := Obter_Param_Usuario(3010, 112, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_refracao_lib_w);

	select max(b.cd_pessoa_fisica)
	into STRICT   cd_pessoa_fisica_oft_w
	from   atendimento_paciente b,
	       oft_consulta c
	where  c.nr_atendimento = b.nr_atendimento
	and    c.nr_sequencia = vl_atributo_p;


	if (ds_macro_w	= '@OFT_CID') then
		select 	substr(a.cd_doenca_cid,1,200)
		into STRICT  	ds_resultado_w
		from 	oft_diagnostico a
		where 	a.nr_seq_consulta = vl_atributo_p
		and 	a.dt_registro = (SELECT max(x.dt_registro)
					from   oft_diagnostico x
					where  a.nr_seq_consulta = x.nr_seq_consulta);

	elsif (ds_macro_w = '@VL_OD_PL_ARD_ESF') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OD_PL_ARD_ESF))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM        atendimento_paciente b,
					    oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');

	elsif (ds_macro_w = '@VL_OD_PL_ARD_CIL') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OD_PL_ARD_CIL))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM      atendimento_paciente b,
					   oft_consulta c,
					    OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PL_ARD_EIXO') then
		SELECT MAX(VL_OD_PL_ARD_EIXO)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM     atendimento_paciente b,
					   OFT_REFRACAO a,
					   oft_consulta c
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PL_ARD_AV_SC') then
		SELECT SUBSTR(obter_desc_tipo_acuidade(VL_OD_PL_ARD_AV_SC),1,255)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					oft_consulta c,
					OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_ADIC_AV') then
		SELECT SUBSTR(obter_desc_tipo_acuidade(VL_OD_ADIC_AV),1,255)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM    atendimento_paciente b,
					   OFT_REFRACAO a,
					   oft_consulta c
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				   AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PL_ARD_ESF') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OE_PL_ARD_ESF))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PL_ARD_CIL') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OE_PL_ARD_CIL))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b ,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PL_ARD_EIXO') then
		SELECT MAX(VL_OE_PL_ARD_EIXO)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  OFT_REFRACAO a,
					   atendimento_paciente b,
					   oft_consulta c
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PL_ARD_AV_SC') then
		SELECT SUBSTR(obter_desc_tipo_acuidade(VL_OE_PL_ARD_AV_SC),1,255)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM   atendimento_paciente b,
					   oft_consulta c,
					  OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
		elsif (ds_macro_w = '@VL_ADICAO') then
		SELECT MAX(VL_ADICAO)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM    atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_ADIC_AV') then
		SELECT SUBSTR(obter_desc_tipo_acuidade(VL_OE_ADIC_AV),1,255)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM    atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PP_ARD_ESF') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OD_PP_ARD_ESF))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PP_ARD_CIL') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OD_PP_ARD_CIL))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM   atendimento_paciente b,
					    oft_consulta c,
					  OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))

				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PP_ARD_EIXO') then
		SELECT MAX(VL_OD_PP_ARD_EIXO)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM    atendimento_paciente b ,
					  oft_consulta c,
					  OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PP_ARD_AV_SC') then
		SELECT SUBSTR(obter_desc_tipo_acuidade(VL_OD_PP_ARD_AV_SC),1,255)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM   atendimento_paciente b,
					   oft_consulta c,
                                         OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PP_ARD_ESF') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OE_PP_ARD_ESF))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PP_ARD_CIL') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OE_PP_ARD_CIL))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PP_ARD_EIXO') then
		SELECT MAX(VL_OE_PP_ARD_EIXO)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PP_ARD_AV_SC') then
		SELECT SUBSTR(obter_desc_tipo_acuidade(VL_OE_PP_ARD_AV_SC),1,255)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM    atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PL_ARE_ESF') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OD_PL_ARE_ESF))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PL_ARE_CIL') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OD_PL_ARE_CIL))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PL_ARE_EIXO') then
		SELECT MAX(VL_OD_PL_ARE_EIXO)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PL_ARE_AV_SC') then
		SELECT SUBSTR(obter_desc_tipo_acuidade(VL_OD_PL_ARE_AV_SC),1,255)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM    atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))

				  AND 	c.nr_atendimento = b.nr_atendimento
				   AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PL_ARE_ESF') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OE_PL_ARE_ESF))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PL_ARE_CIL') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OE_PL_ARE_CIL))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PL_ARE_EIXO') then
		SELECT MAX(VL_OE_PL_ARE_EIXO)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PL_ARE_AV_SC') then
		SELECT SUBSTR(obter_desc_tipo_acuidade(VL_OE_PL_ARE_AV_SC),1,255)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM    atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))

				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PP_ARE_ESF') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OD_PP_ARE_ESF))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PP_ARE_CIL') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OD_PP_ARE_CIL))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PP_ARE_EIXO') then
		SELECT MAX(VL_OD_PP_ARE_EIXO)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OD_PP_ARE_AV_SC') then
		SELECT SUBSTR(obter_desc_tipo_acuidade(VL_OD_PP_ARE_AV_SC),1,255)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM    atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))

				  AND 	c.nr_atendimento = b.nr_atendimento
				   AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PP_ARE_ESF') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OE_PP_ARE_ESF))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PP_ARE_CIL') then
		SELECT MAX(oft_obter_valor_com_sinal(VL_OE_PP_ARE_CIL))
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PP_ARE_EIXO') then
		SELECT MAX(VL_OE_PP_ARE_EIXO)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM  atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))

				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	elsif (ds_macro_w = '@VL_OE_PP_ARE_AV_SC') then
		SELECT SUBSTR(obter_desc_tipo_acuidade(VL_OE_PP_ARE_AV_SC),1,255)
		into STRICT   ds_resultado_w
		FROM  OFT_REFRACAO a
		WHERE ie_situacao = 'A'
		AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
		AND   dt_exame = (SELECT MAX(a.dt_exame)
	  		   	  FROM    atendimento_paciente b,
					   oft_consulta c,
					   OFT_REFRACAO a
				  WHERE a.ie_situacao = 'A'
				  AND   ((ie_refracao_lib_w = 'N') OR (ie_refracao_lib_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
				  AND 	c.nr_atendimento = b.nr_atendimento
				  AND	c.nr_sequencia = a.nr_seq_consulta
				  AND   b.cd_pessoa_fisica = cd_pessoa_fisica_oft_w
				  and		coalesce(c.dt_cancelamento::text, '') = '');
	end if;
	end;
elsif (nm_atributo_p = 'NR_SEQ_CONSENTIMENTO') then
	begin
	if (ds_macro_w	= '@PROCED_CONSENTIMENTO') then
		select	Obter_Desc_Proc_Interno(nr_seq_proc_interno)
		into STRICT	ds_resultado_w
		from	pep_pac_ci
		where	nr_sequencia = vl_atributo_p;
	elsif (ds_macro_w	= '@LADO_PROCED_CONSENTIMENTO') then
		select	Obter_Valor_Dominio(1372, ie_lado)
		into STRICT	ds_resultado_w
		from	pep_pac_ci
		where	nr_sequencia = vl_atributo_p;
	elsif (ds_macro_w	= '@AMB_PROCED_CONSENTIMENTO') then
		select	Obter_procedimento_proc_int(nr_seq_proc_interno)
		into STRICT	ds_resultado_w
		from	pep_pac_ci
		where	nr_sequencia = vl_atributo_p;
	else
		gerar_result_macro_sql;
	end if;
	end;
elsif (nm_atributo_p = 'NR_SEQ_ATESTADO') then
	begin
	gerar_result_macro_sql;
	end;
elsif (nm_atributo_p = 'NR_PRESCRICAO') then
	begin
	if (ds_macro_w	= '@DATA_PRESCRICAO') then
		select to_char(dt_prescricao, 'DD/MM/YYYY')
		into STRICT	ds_resultado_w
		from prescr_medica
		where nr_prescricao =  vl_atributo_p;
	elsif (ds_macro_w	= '@NR_PRESCRICAO') then
		select nr_prescricao
		into STRICT	ds_resultado_w
		from prescr_medica
		where nr_prescricao = vl_atributo_p;
	else
		gerar_result_macro_sql;
	end if;
	end;
end if;

exception
	when others then
	ds_resultado_w	:= null;
end;

if (nm_atributo_p	= 'IE_SUBS') then
	return	coalesce(ds_resultado_w,'');
end if;

return	coalesce(ds_resultado_w,' ');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION substituir_macro_texto_tasy (ds_macro_p text, nm_atributo_p text, vl_atributo_p text) FROM PUBLIC;

