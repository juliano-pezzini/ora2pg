-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_juros_multa_portal ( nr_titulo_p bigint, dt_referencia_p timestamp, ie_pagar_receber_p text, ie_juros_multa_p text, ie_portal_p text) RETURNS bigint AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:   Calcular juros e multa da 2ª via boleto no portal web
----------------------------------------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [ x ] Portal [  ] Relatórios [ ] Outros:
 ----------------------------------------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/ie_juros_multa_venc_orig_w	parametro_contas_receber.ie_juros_multa_venc_orig%type;
vl_juros_w			double precision;
vl_multa_w			double precision;
cd_estabelecimento_w		smallint;
ie_juros_multa_venc_portal_w	varchar(2);
ie_considera_saldo_w		varchar(1) := 'S';
dt_referencia_w			timestamp;
dt_venc_orig_w			timestamp;


BEGIN

select	max(ie_juros_multa_venc_portal)
into STRICT	ie_juros_multa_venc_portal_w
from	pls_web_param_geral;
ie_juros_multa_venc_portal_w	:= coalesce(ie_juros_multa_venc_portal_w,'R');

if (ie_juros_multa_venc_portal_w = 'R') then
	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	titulo_receber
	where	nr_titulo	= nr_titulo_p;

	select	max(ie_juros_multa_venc_orig)
	into STRICT	ie_juros_multa_venc_orig_w
	from	parametro_contas_receber
	where	cd_estabelecimento	= cd_estabelecimento_w;
	ie_juros_multa_venc_orig_w	:= coalesce(ie_juros_multa_venc_orig_w,'N');
elsif (ie_juros_multa_venc_portal_w = 'O') then
	ie_juros_multa_venc_orig_w	:= 'S';
elsif (ie_juros_multa_venc_portal_w = 'P') then
	ie_juros_multa_venc_orig_w	:= 'N';
end if;

dt_referencia_w	:= dt_referencia_p;

-- OS 617558 - wcbernardino - Quando tem alteração de vencimento, não deve somar o saldo de juros/multa caso utilize a data de vencimento original
if (ie_juros_multa_venc_orig_w = 'S') then
	ie_considera_saldo_w := 'N';
end if;

begin
select	a.dt_vencimento,
	a.cd_estabelecimento
into STRICT	dt_venc_orig_w,
	cd_estabelecimento_w
from	titulo_receber a
where	a.nr_titulo	= nr_titulo_p;
exception
	when others then
	dt_venc_orig_w	:= null;
end;

if (dt_venc_orig_w <> obter_proximo_dia_util(cd_estabelecimento_w,dt_venc_orig_w)) and (dt_referencia_p = obter_proximo_dia_util(cd_estabelecimento_w,dt_venc_orig_w)) then
	dt_referencia_w	:= dt_venc_orig_w;
end if;

	dt_referencia_w	:= obter_proximo_dia_util(cd_estabelecimento_w, dt_referencia_w);

if (ie_pagar_receber_p = 'P') then
	SELECT * FROM calcular_juro_multa_titulo(nr_titulo_p, null, dt_referencia_w, ie_considera_saldo_w, ie_juros_multa_venc_orig_w, vl_juros_w, vl_multa_w) INTO STRICT vl_juros_w, vl_multa_w;
elsif (ie_pagar_receber_p = 'R') then
	/*aaschlote 07/02/2013 - Alterei a data dt_referencia_w para dt_referencia_p, pois será a data de pagamento que o pagador planeja irá pagar o título e para não ter problema no calculo de juros e multa*/

	SELECT * FROM calcular_juro_multa_titulo(null, nr_titulo_p, dt_referencia_w, ie_considera_saldo_w, ie_juros_multa_venc_orig_w, vl_juros_w, vl_multa_w) INTO STRICT vl_juros_w, vl_multa_w;
end if;

if (ie_juros_multa_p = 'J') then
	return	coalesce(vl_juros_w,0);
elsif (ie_juros_multa_p = 'M') then
	return	coalesce(vl_multa_w,0);
elsif (ie_juros_multa_p = 'A') then
	return	coalesce(vl_juros_w,0) + coalesce(vl_multa_w,0);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_juros_multa_portal ( nr_titulo_p bigint, dt_referencia_p timestamp, ie_pagar_receber_p text, ie_juros_multa_p text, ie_portal_p text) FROM PUBLIC;

