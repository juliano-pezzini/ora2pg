-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION phi_obter_data_ofic_funcao (nr_seq_ordem_servico bigint) RETURNS timestamp AS $body$
DECLARE


nr_seq_cliente_w com_cliente.nr_sequencia%type;
nr_seq_localizacao_w	man_ordem_servico.nr_seq_localizacao%type;
cd_funcao_w funcao.cd_funcao%type;
dt_oficializacao_w timestamp;
cd_cnpj_cliente_w 	com_cliente.cd_cnpj%type;
ie_cnpj_philips_w 	varchar(1);


BEGIN

select  MAX(nr_seq_cliente), MAX(nr_seq_localizacao), MAX(cd_funcao)
into STRICT    nr_seq_cliente_w, nr_seq_localizacao_w, cd_funcao_w
from    man_ordem_servico
where nr_sequencia=nr_seq_ordem_servico;

if	coalesce(nr_seq_cliente_w::text, '') = '' then
	select max(b.nr_sequencia)
	into STRICT nr_seq_cliente_w
	from man_localizacao a
	inner join com_cliente b on b.cd_cnpj = a.cd_cnpj
	where a.nr_sequencia = nr_seq_localizacao_w;
end if;

select	max(cd_cnpj)
into STRICT	cd_cnpj_cliente_w
from	com_cliente
where	nr_sequencia = nr_seq_cliente_w;

select 	case when coalesce(cd_cnpj_cliente_w, cd_cnpj) = '01950338000177'
	then 'S' else 'N' end
into STRICT 	ie_cnpj_philips_w
from	man_localizacao
where 	nr_sequencia = nr_seq_localizacao_w;

if ( man_obter_se_loc_terceiro(nr_seq_localizacao_w) = 'N' or ie_cnpj_philips_w = 'S' ) then
	return null;
end if;

dt_oficializacao_w := OBTER_DATA_OFIC_FUNCAO(cd_cnpj_cliente_w, nr_seq_cliente_w, cd_funcao_w);

return dt_oficializacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION phi_obter_data_ofic_funcao (nr_seq_ordem_servico bigint) FROM PUBLIC;

