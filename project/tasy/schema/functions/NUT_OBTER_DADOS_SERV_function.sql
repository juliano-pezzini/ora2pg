-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nut_obter_dados_serv (dt_servico_p timestamp, nr_Atendimento_p bigint, cd_setor_atendimento_p bigint, nr_seq_servico_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
ds_resultado_w		varchar(255);
nr_prescricao_w		bigint;


BEGIN 
 
SELECT	MAX(b.nr_prescricao) 
INTO STRICT	ds_resultado_w 
FROM 	nut_atend_serv_dia a, 
	prescr_medica b 
WHERE	a.nr_Atendimento = b.nr_atendimento 
AND	(coalesce(b.dt_liberacao,b.dt_liberacao_medico) IS NOT NULL AND (coalesce(b.dt_liberacao,b.dt_liberacao_medico))::text <> '') 
AND	a.dt_Servico BETWEEN b.dt_inicio_prescr AND b.dt_validade_prescr 
and	coalesce(b.dT_suspensao::text, '') = '' 
AND	a.nr_Seq_Servico = nr_Seq_Servico_p 
AND	a.nr_atendimento = nr_Atendimento_p 
AND	a.cd_setor_Atendimento = cd_setor_Atendimento_p 
AND	a.dt_servico BETWEEN TRUNC(dt_servico_p) AND TRUNC(dt_servico_p) + 86399/86400 
AND	EXISTS (	SELECT	1 
		FROM 	prescr_dieta x 
		WHERE	coalesce(x.ie_suspenso,'N') = 'N' 
		AND	x.nr_prescricao = b.nr_prescricao 
		
UNION
 
		SELECT	1 
		FROM	prescr_material x 
		WHERE	x.ie_agrupador IN (8,12) 
		AND	coalesce(x.ie_suspenso,'N') = 'N' 
		AND	x.nr_prescricao = b.nr_prescricao);
 
 
if (ie_opcao_p = 'D') then 
 
	select	max(dt_prescricao) 
	into STRICT	ds_resultado_w 
	from	prescr_medica 
	where	nr_prescricao = ds_resultado_w;
	 
elsif (ie_opcao_p = 'MJ') then 
 
	select	substr(obter_nome_pf(max(cd_medico)),1,100) 
	into STRICT	ds_resultado_w 
	from	prescr_medica 
	where	nr_prescricao = ds_resultado_w;
end if;
		 
 
return	ds_resultado_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nut_obter_dados_serv (dt_servico_p timestamp, nr_Atendimento_p bigint, cd_setor_atendimento_p bigint, nr_seq_servico_p bigint, ie_opcao_p text) FROM PUBLIC;

