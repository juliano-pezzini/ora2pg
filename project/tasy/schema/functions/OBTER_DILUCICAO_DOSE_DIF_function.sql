-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dilucicao_dose_dif ( nr_sequencia_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint ) RETURNS varchar AS $body$
DECLARE

			
ds_retorno_w			varchar(2000);	
ds_material_w			varchar(255);
tam_lista_w				bigint;		
ie_pos_virgula_w		smallint;
ds_dose_w				varchar(255);
cont_w					numeric(38);
ie_esquema_alternado_w	prescr_solucao.ie_esquema_alternado%type;

c01 CURSOR FOR
SELECT 	substr(obter_descricao_mat_prescr(a.cd_material),1,80) ds_material,
		replace(a.ds_dose_diferenciada,'-',',')||',' ds_dose_diferenciada,
		CASE WHEN obter_se_mat_conv_ml(b.cd_material)='S' THEN  obter_conversao_ml(b.cd_material, b.qt_dose, b.cd_unidade_medida_dose)  ELSE b.qt_dose END  qt_dose,
		coalesce(a.nr_dia_util,0) nr_dia_util,
		a.cd_unidade_medida_dose unidade_dose,
		b.nr_etapa_sol nr_etapa_sol,
		b.dt_horario dt_horario
from   	prescr_material a,
		prescr_mat_hor b
where  	a.nr_prescricao  	 	= nr_prescricao_p
and		a.nr_sequencia_solucao  = nr_seq_solucao_p  
and 	a.nr_prescricao 		= b.nr_prescricao
and   	a.nr_sequencia 			= b.nr_seq_material
and		a.ie_agrupador 			= 4
order by b.dt_horario;

BEGIN

select	coalesce(max(ie_esquema_alternado),'N')
into STRICT	ie_esquema_alternado_w
from	prescr_solucao
where  	nr_prescricao  	 	=  nr_prescricao_p
and		nr_seq_solucao   	=  nr_seq_solucao_p;

if (ie_esquema_alternado_w = 'S') then

	cont_w := 0;
	
	for c01_w in c01 loop
	
		tam_lista_w		:= length(c01_w.ds_dose_diferenciada);
		ie_pos_virgula_w	:= position(',' in c01_w.ds_dose_diferenciada) - 1;
		
		while (c01_w.ds_dose_diferenciada IS NOT NULL AND c01_w.ds_dose_diferenciada::text <> '') loop
		begin
		
			ds_dose_w := substr(c01_w.ds_dose_diferenciada,1,ie_pos_virgula_w);
			ds_dose_w := replace(ds_dose_w, ',', '');
		
			if (ds_dose_w <> '0' and coalesce(ie_pos_virgula_w, 0) = coalesce(c01_w.nr_etapa_sol, 0)) then
				
				if (cont_w = 0) then
						cont_w := c01_w.nr_etapa_sol;
						ds_retorno_w := ds_retorno_w || chr(10) || chr(13) || chr(10) || chr(13) || to_char(c01_w.dt_horario, 'dd/mm hh24:mi');
				end if;
					
				if (coalesce(ds_retorno_w::text, '') = '') then
					if (c01_w.qt_dose = 0) then
						ds_retorno_w := '  ' || ds_dose_w || ' ' || c01_w.unidade_dose || '  ' || c01_w.ds_material || '  ' || '(' || obter_desc_expressao(959696)/*Dias utilizados: '*/ || ' ' || c01_w.nr_dia_util || ')';
					else
						ds_retorno_w := '  ' || c01_w.qt_dose || ' ' || 'ml' || '  ' || c01_w.ds_material || '  ' || '(' || obter_desc_expressao(959696)/*Dias utilizados '*/ || ' ' || c01_w.nr_dia_util || ')';	
					end if;
				else
					if (c01_w.qt_dose = 0) then
						ds_retorno_w := substr(ds_retorno_w || chr(10) || chr(13) || ' ' || ds_dose_w || '  ' || c01_w.unidade_dose || '  ' || c01_w.ds_material || '  ' || '('||obter_desc_expressao(959696)/*Dias utilizados: '*/||' '||c01_w.nr_dia_util ||')',1,2000);
					else
						ds_retorno_w := substr(ds_retorno_w || chr(10) || chr(13) ||  ' ' || c01_w.qt_dose || '  ' || 'ml' || '  ' || c01_w.ds_material || '  ' || '('||obter_desc_expressao(959696)/*Dias utilizados: '*/||' '||c01_w.nr_dia_util ||')',1,2000);
					end if;
				end if;
			end if;
		
			if (c01_w.nr_etapa_sol <> cont_w) then
				cont_w := 0;
			end if;
			
			ie_pos_virgula_w := ie_pos_virgula_w + 1;
			c01_w.ds_dose_diferenciada	:= substr(c01_w.ds_dose_diferenciada,ie_pos_virgula_w,tam_lista_w);

			end;
		end loop;
	end loop;
else
	select	ds_diluicao
	into STRICT	ds_retorno_w
	from  	w_adep_t
	where 	nr_sequencia = nr_sequencia_p;
	
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dilucicao_dose_dif ( nr_sequencia_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint ) FROM PUBLIC;

