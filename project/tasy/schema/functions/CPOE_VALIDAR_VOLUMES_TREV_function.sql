-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_validar_volumes_trev ( nr_sequencia_p cpoe_trev.nr_sequencia%type ) RETURNS varchar AS $body$
DECLARE


	ie_valido_w		varchar(1);
	ds_mensagem_w	varchar(2000);
	qt_vol_tot_w	double precision;
	ie_completar_w	cpoe_trev.ie_completar%type;
	qt_aporte_hidrico_diario_w	cpoe_trev.qt_aporte_hidrico_diario%type;

cElementos CURSOR FOR
	SELECT a.qt_volume,
		   a.qt_elem_kg_dia,
		   a.qt_diaria,
		   b.ds_elemento,
		   b.ie_tipo_elemento		
	  from nut_elemento b,
		   cpoe_trev_elem a
	 where a.nr_seq_cpoe_trev = nr_sequencia_p
	   and a.nr_seq_elemento = b.nr_sequencia;

cItensGlicose CURSOR FOR
	SELECT c.qt_volume,
		   obter_desc_material(d.cd_material) ds_material
	  from nut_elemento b,
		   cpoe_trev_elem a,
		   cpoe_trev_elem_mat c,
		   nut_elem_material d
	 where a.nr_seq_cpoe_trev = nr_sequencia_p
	   and a.nr_seq_elemento = b.nr_sequencia
	   and c.nr_seq_ele_cpoe = a.nr_sequencia
	   and d.nr_sequencia = c.nr_seq_elem_mat
	   and b.ie_tipo_elemento = 'C';
BEGIN
	ie_valido_w := 'S';
	ds_mensagem_w := '';

	if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

		select	coalesce(max(ie_completar), 'X'),
				coalesce(max(qt_aporte_hidrico_diario), 0)
		into STRICT	ie_completar_w,
				qt_aporte_hidrico_diario_w
		from	cpoe_trev
		where	nr_sequencia = nr_sequencia_p;

		/* Soma dos volumes */

		select sum(a.qt_volume)
		  into STRICT qt_vol_tot_w
		  from nut_elemento b,
			   cpoe_trev_elem a
		 where a.nr_seq_cpoe_trev = nr_sequencia_p
		   and a.nr_seq_elemento = b.nr_sequencia;

		/* Validacao do elemento glicose */

		if (ie_completar_w = 'G') then
			for cItensGlicose_w in cItensGlicose
			loop
				if (cItensGlicose_w.qt_volume < 0) then
					if (ie_valido_w = 'S') then
						ie_valido_w := 'N';
						ds_mensagem_w := wheb_mensagem_pck.get_texto(1157011);
					end if;
					
					ds_mensagem_w := ds_mensagem_w || chr(13) || chr(13) || cItensGlicose_w.ds_material;
				end if;
			end loop;
		end if;

		/* Se ainda nao tem mensagem faz a validacao do volume */

		if (ie_valido_w = 'S') then
			if (qt_vol_tot_w > qt_aporte_hidrico_diario_w) then
				ie_valido_w := 'N';
				ds_mensagem_w := wheb_mensagem_pck.get_texto(1157012);
			end if;

			for cElementos_w in cElementos
			loop
				if ((cElementos_w.qt_volume < 0) or (cElementos_w.qt_diaria < 0) or (cElementos_w.qt_elem_kg_dia < 0)) then
					if (ie_valido_w = 'S') then
						ie_valido_w := 'N';
						ds_mensagem_w := wheb_mensagem_pck.get_texto(1157012);
					end if;

					ds_mensagem_w := ds_mensagem_w || chr(13) || chr(13) || cElementos_w.ds_elemento;
				end if;
			end loop;
		end if;

	end if;

	return ds_mensagem_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_validar_volumes_trev ( nr_sequencia_p cpoe_trev.nr_sequencia%type ) FROM PUBLIC;

