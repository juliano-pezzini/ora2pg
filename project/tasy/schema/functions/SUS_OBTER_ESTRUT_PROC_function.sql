-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_estrut_proc ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_opcao_p text, ie_estrutura_p text) RETURNS varchar AS $body$
DECLARE


/* IE_OPCAO_P
C  - Codigo
D  - Descricao
CD - Código + Descrição
S - Sequencia
*/
/* IE_ESTRUTURA_P
        F - Forma organizacao
        S - SubGrupo
        G - Grupo
*/
cd_forma_organizacao_w		integer;
ds_forma_organizacao_w		varchar(100);
cd_subgrupo_w			smallint;
ds_subgrupo_w			varchar(100);
cd_grupo_w			smallint;
ds_grupo_w			varchar(100);
nr_seq_grupo_w			bigint;
nr_seq_subgrupo_w		bigint;
nr_seq_forma_org_w		bigint;


BEGIN

/* ESSA FUNCTION É UTILIZADA NA TABELA SUS_PROCEDIMENTO NO DICIONARIO DE DADOS */

if (ie_origem_proced_p = 7) then
	begin

	begin
	select	b.cd_forma_organizacao,
		b.ds_forma_organizacao,
		c.cd_subgrupo,
		c.ds_subgrupo,
		d.cd_grupo,
		d.ds_grupo,
		c.nr_seq_grupo,
		b.nr_seq_subgrupo,
		a.nr_seq_forma_org
	into STRICT	cd_forma_organizacao_w,
		ds_forma_organizacao_w,
		cd_subgrupo_w,
		ds_subgrupo_w,
		cd_grupo_w,
		ds_grupo_w,
		nr_seq_grupo_w,
		nr_seq_subgrupo_w,
		nr_seq_forma_org_w
	from	sus_procedimento a,
		sus_forma_organizacao b,
		sus_subgrupo c,
		sus_grupo d
	where	c.nr_seq_grupo		= d.nr_sequencia
	and	b.nr_seq_subgrupo	= c.nr_sequencia
	and	a.nr_seq_forma_org	= b.nr_sequencia
	and	a.cd_procedimento	= cd_procedimento_p
	and	a.ie_origem_proced	= ie_origem_proced_p  LIMIT 1;
	exception
	when others then
		cd_forma_organizacao_w	:= 0;
		ds_forma_organizacao_w	:= '';
		cd_subgrupo_w 		:= 0;
		ds_subgrupo_w 		:= '';
		cd_grupo_w 		:= 0;
		ds_grupo_w		:= '';
		nr_seq_grupo_w		:= 0;
		nr_seq_subgrupo_w	:= 0;
		nr_seq_forma_org_w	:= 0;
	end;

	if (coalesce(cd_forma_organizacao_w::text, '') = '') then
		begin

		cd_forma_organizacao_w	:= 0;
		ds_forma_organizacao_w	:= '';
		cd_subgrupo_w 		:= 0;
		ds_subgrupo_w 		:= '';
		cd_grupo_w 		:= 0;
		ds_grupo_w		:= '';
		nr_seq_grupo_w		:= 0;
		nr_seq_subgrupo_w	:= 0;
		nr_seq_forma_org_w	:= 0;

		end;
	end if;

	end;
else
	cd_forma_organizacao_w	:= 0;
	ds_forma_organizacao_w	:= '';
	cd_subgrupo_w 		:= 0;
	ds_subgrupo_w 		:= '';
	cd_grupo_w 		:= 0;
	ds_grupo_w		:= '';
	nr_seq_grupo_w		:= 0;
	nr_seq_subgrupo_w	:= 0;
	nr_seq_forma_org_w	:= 0;
end if;

if (ie_opcao_p     = 'C') then
	if (ie_estrutura_p = 'F') then
		return cd_forma_organizacao_w;
	elsif (ie_estrutura_p = 'S') then
		return cd_subgrupo_w;
	elsif (ie_estrutura_p = 'G') then
		return cd_grupo_w;
	end if;
elsif (ie_opcao_p     = 'D') then
	if (ie_estrutura_p = 'F') then
		return ds_forma_organizacao_w;
	elsif (ie_estrutura_p = 'S') then
		return ds_subgrupo_w;
	elsif (ie_estrutura_p = 'G') then
		return ds_grupo_w;
	end if;
elsif (ie_opcao_p     = 'CD') then
	if (cd_forma_organizacao_w = 0) then
		return null;
	elsif (ie_estrutura_p = 'F') then
		return cd_forma_organizacao_w || ' - '|| ds_forma_organizacao_w;
	elsif (ie_estrutura_p = 'S') then
		return cd_subgrupo_w || ' - ' || ds_subgrupo_w;
	elsif (ie_estrutura_p = 'G') then
		return cd_grupo_w || ' - ' || ds_grupo_w;
	end if;
elsif (ie_opcao_p     = 'S') then
	if (ie_estrutura_p = 'F') then
		return nr_seq_forma_org_w;
	elsif (ie_estrutura_p = 'S') then
		return nr_seq_subgrupo_w;
	elsif (ie_estrutura_p = 'G') then
		return nr_seq_grupo_w;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_estrut_proc ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_opcao_p text, ie_estrutura_p text) FROM PUBLIC;

