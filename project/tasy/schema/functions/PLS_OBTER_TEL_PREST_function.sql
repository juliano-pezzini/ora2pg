-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_tel_prest ( cd_pessoa_fisica_p text, cd_cgc_p text, ie_opcao_p text, ie_endereco_p text, nr_seq_compl_pj_p bigint default 0, nr_seq_compl_pf_p bigint default 0, NR_SEQ_TIPO_COMPL_ADIC_p bigint default 0) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(40);
qt_compl_w		bigint;
nr_ddi_telefone_w	varchar(3);
nr_ddd_telefone_w	varchar(3);
nr_telefone_w		varchar(40);


BEGIN 
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then 
	 
	if (coalesce(nr_seq_compl_pf_p,0) <> 0) and (ie_endereco_p = 'PFC') then 
		select	max(nr_telefone), 
			max(nr_ddi_telefone), 
			max(nr_ddd_telefone) 
		into STRICT	nr_telefone_w, 
			nr_ddi_telefone_w, 
			nr_ddd_telefone_w 
		from	compl_pf_tel_adic 
		where	nr_sequencia	= nr_seq_compl_pf_p;
	elsif (coalesce(NR_SEQ_TIPO_COMPL_ADIC_p,0) <> 0)and (ie_endereco_p = 'PFA') then 
		begin 
		select	nr_telefone, 
			nr_ddi_telefone, 
			nr_ddd_telefone 
		into STRICT	nr_telefone_w, 
			nr_ddi_telefone_w, 
			nr_ddd_telefone_w 
		from	compl_pessoa_fisica 
		where	cd_pessoa_fisica	= cd_pessoa_fisica_p 
		and	ie_tipo_complemento	= 9 
		and	nr_seq_tipo_compl_adic	= NR_SEQ_TIPO_COMPL_ADIC_p;
		exception 
		when others then 
			nr_telefone_w		:= '';
			nr_ddi_telefone_w	:= '';
			nr_ddd_telefone_w	:= '';
		end;
	else 
	 
		select	count(*) 
		into STRICT	qt_compl_w 
		from	compl_pessoa_fisica		a 
		where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p 
		and	a.ie_tipo_complemento = CASE WHEN ie_endereco_p='PFA' THEN  9 WHEN ie_endereco_p='PFC' THEN  2 WHEN ie_endereco_p='PFR' THEN  1 END;
		 
		if (qt_compl_w > 0) then 
			select	a.nr_ddi_telefone, 
				a.nr_ddd_telefone, 
				a.nr_telefone 
			into STRICT	nr_ddi_telefone_w, 
				nr_ddd_telefone_w, 
				nr_telefone_w	 
			from	compl_pessoa_fisica		a 
			where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p 
			and	a.nr_sequencia		= (	SELECT	max(a.nr_sequencia) -- PK composta, pode haver v√°rios registros, por isso do max - OS 707758 - wcbernardino 
								from	compl_pessoa_fisica a 
								where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p 
								and	a.ie_tipo_complemento 	= CASE WHEN ie_endereco_p='PFA' THEN  9 WHEN ie_endereco_p='PFC' THEN  2 WHEN ie_endereco_p='PFR' THEN  1 END );
		end if;
 
		 
		if (coalesce(nr_ddi_telefone_w::text, '') = '') and (coalesce(nr_ddd_telefone_w::text, '') = '') and (coalesce(nr_telefone_w::text, '') = '') then 
			select	a.nr_ddi_celular, 
				a.nr_ddd_celular, 
				a.nr_telefone_celular 
			into STRICT	nr_ddi_telefone_w, 
				nr_ddd_telefone_w, 
				nr_telefone_w	 
			from	pessoa_fisica		a 
			where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p;
		end if;	
	end if;
	 
	if (ie_opcao_p = 'DIT') then 
		ds_retorno_w	:= nr_ddi_telefone_w;
	elsif (ie_opcao_p = 'DDT') then 
		ds_retorno_w	:= nr_ddd_telefone_w;
	elsif (ie_opcao_p = 'T') then 
		ds_retorno_w	:= nr_telefone_w;
	end if;	
else 
	if (coalesce(ie_endereco_p, 'PJ') = 'PJ') then 
		select	max(a.nr_ddi_telefone), 
			max(a.nr_ddd_telefone), 
			max(a.nr_telefone) 
		into STRICT	nr_ddi_telefone_w, 
			nr_ddd_telefone_w, 
			nr_telefone_w	 
		from	pessoa_juridica a 
		where	a.cd_cgc		= cd_cgc_p;
	else 
		select	max(a.nr_ddd_telefone), 
			max(a.nr_telefone) 
		into STRICT	nr_ddd_telefone_w, 
			nr_telefone_w 
		from	pessoa_juridica_compl a 
		where	cd_cgc			= cd_cgc_p 
		and	a.nr_sequencia		= coalesce(nr_seq_compl_pj_p, a.nr_sequencia) 
		and	a.ie_tipo_complemento	= CASE WHEN ie_endereco_p='PJA' THEN  6 WHEN ie_endereco_p='PJC' THEN  1 WHEN ie_endereco_p='PJF' THEN  2 END;
	end if;	
	 
	if (ie_opcao_p = 'DIT') then 
		ds_retorno_w	:= nr_ddi_telefone_w;
	elsif (ie_opcao_p = 'DDT') then 
		ds_retorno_w	:= nr_ddd_telefone_w;
	elsif (ie_opcao_p = 'T') then 
		ds_retorno_w	:= nr_telefone_w;
	end if;
	 
	if (nr_seq_compl_pj_p = 0) then 
		ds_retorno_w 	:= obter_dados_pf_pj(null, cd_cgc_p, ie_opcao_p);
	end if;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_tel_prest ( cd_pessoa_fisica_p text, cd_cgc_p text, ie_opcao_p text, ie_endereco_p text, nr_seq_compl_pj_p bigint default 0, nr_seq_compl_pf_p bigint default 0, NR_SEQ_TIPO_COMPL_ADIC_p bigint default 0) FROM PUBLIC;

