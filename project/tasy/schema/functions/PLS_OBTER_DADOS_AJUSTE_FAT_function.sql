-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_ajuste_fat (nr_seq_ajuste_fat_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
/* 
SP	- Seq do pagador da fatura original 
NP	- Nome do pagador original 
MC	- Mês de competência 
VF	- Valor fatura original 
VC	- Valor das contas a ajustar 
VA	- Valor ajustado 
VFS	- Valor refaturado sem ajuste 
SFS	- Sequencia da fatura sem ajuste 
*/
 
 
ds_retorno_w		varchar(255);
nr_seq_pagador_w	bigint;


BEGIN 
 
select	max(b.nr_seq_pagador) 
into STRICT	nr_seq_pagador_w 
from	pls_fatura b, 
	pls_ajuste_fatura a 
where	a.nr_seq_fatura	= b.nr_sequencia 
and	a.nr_sequencia	= nr_seq_ajuste_fat_p;
 
if (ie_opcao_p	= 'SP') then 
	ds_retorno_w	:= nr_seq_pagador_w;
elsif (ie_opcao_p	= 'NP') then 
	ds_retorno_w	:= pls_obter_dados_pagador(nr_seq_pagador_w,'NF');
elsif (ie_opcao_p	= 'MC') then 
	select	max(c.dt_mesano_referencia) 
	into STRICT	ds_retorno_w 
	from	pls_lote_faturamento c, 
		pls_fatura b, 
		pls_ajuste_fatura a 
	where	a.nr_seq_fatura	= b.nr_sequencia 
	and	b.nr_seq_lote	= c.nr_sequencia 
	and	a.nr_sequencia	= nr_seq_ajuste_fat_p;
elsif (ie_opcao_p	= 'VF') then 
	select	coalesce(max(b.vl_fatura),0) + coalesce(max(b.vl_total_ndc),0) 
	into STRICT	ds_retorno_w 
	from	pls_fatura b, 
		pls_ajuste_fatura a 
	where	a.nr_seq_fatura	= b.nr_sequencia 
	and	a.nr_sequencia	= nr_seq_ajuste_fat_p;
elsif (ie_opcao_p	= 'VC') then 
	select	sum(b.vl_faturado + b.vl_faturado_ndc) 
	into STRICT	ds_retorno_w 
	from	pls_fatura_evento d, 
		pls_fatura_conta b, 
		pls_ajuste_fatura_conta a, 
		pls_ajuste_fatura c 
	where	c.nr_sequencia	= a.nr_seq_ajuste_fatura 
	and	a.nr_seq_conta	= b.nr_seq_conta 
	and	d.nr_sequencia	= b.nr_seq_fatura_evento 
	and	d.nr_seq_fatura	= c.nr_seq_fatura 
	and	c.nr_sequencia	= nr_seq_ajuste_fat_p;
elsif (ie_opcao_p	= 'VA') then 
	select	sum(b.vl_beneficiario) 
	into STRICT	ds_retorno_w 
	from	pls_conta_pos_estabelecido b, 
		pls_ajuste_fatura_conta a 
	where	a.nr_seq_conta	= b.nr_seq_conta 
	and	a.nr_seq_ajuste_fatura	= nr_seq_ajuste_fat_p 
	and	((b.ie_situacao		= 'A') or (coalesce(b.ie_situacao::text, '') = '')) 
	and	b.ie_status_faturamento in ('P','L');
elsif (ie_opcao_p	= 'VFS') then 
	select	max(e.vl_fatura) 
	into STRICT	ds_retorno_w 
	from	pls_fatura e, 
		pls_ajuste_fatura a 
	where	e.nr_seq_fatura_origem	= a.nr_seq_fatura 
	and	a.nr_sequencia		= nr_seq_ajuste_fat_p;
elsif (ie_opcao_p	= 'SFS') then 
	select	max(e.nr_sequencia) 
	into STRICT	ds_retorno_w 
	from	pls_fatura e, 
		pls_ajuste_fatura a 
	where	e.nr_seq_fatura_origem	= a.nr_seq_fatura 
	and	a.nr_sequencia		= nr_seq_ajuste_fat_p;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_ajuste_fat (nr_seq_ajuste_fat_p bigint, ie_opcao_p text) FROM PUBLIC;

