-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_result_anterior ( nr_prescricao_p bigint, nr_seq_exame_p bigint, ie_separador_p text, nr_seq_prescr_p bigint, ie_opcao_p bigint, ie_percent_p bigint default 0) RETURNS varchar AS $body$
DECLARE


/*
ie_opcao_p       		2 - Código unidade medida
			4 - somente ultima data aprovacao
			5 - somente ultimo Resultado
			6 - data coleta
			7 - metodo
			8 - prescrição
			9 - prescricao + data coleta +  resultado + unidade medida + metodo
			11 - Prescrição + data coleta +  resultado + unidade medida + método Quebra,
			13- descricao + unidade medida + observação
			14 -  Código unidade medida data de coleta
			15 - Prescrição + data coleta + método + resultado / UM Quebra
*/
/*
Quando existir valor numérico e percentual, definir a prioridade para retornar
ie_percent_p		0 - retorna valor numérico
			1 - retorna valor percentual

*/
cd_pessoa_fisica_w	varchar(10);
cd_unidade_medida_w	varchar(30);
dt_aprovacao_w		timestamp;

ds_unidade_medida_w	varchar(100);
ds_resultado_w		varchar(2000);

ds_retorno_w		varchar(2000);
cd_estabelecimento_w	smallint;
qt_exame_ant_w		integer;
qt_result_anterior_w	integer;
ie_recem_nato_w		varchar(1);

dt_coleta_w		varchar(30);
ds_metodo_w		varchar(60);
nr_prescricao_w		varchar(20);
nr_seq_prescr_w		bigint;
ie_material_result_ant_w smallint;
nr_seq_material_ex_w	bigint;
nm_exame_w		varchar(80);
dt_prescricao_w		timestamp;
dt_prescricao_exam_w	timestamp;
ie_separador_w		varchar(100);
ds_observacao_w		varchar(254);

qt_dias_prescr_w	bigint;

c01 CURSOR FOR
	SELECT	obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr) dt_aprovacao,
		substr(coalesce(coalesce(CASE WHEN c.ds_resultado='0' THEN ''  ELSE CASE WHEN d.ie_formato_resultado='V' THEN ''  ELSE c.ds_resultado END  END ,	coalesce(CASE WHEN ie_percent_p=1 THEN Campo_Mascara_casas(c.pr_resultado,coalesce(c.qt_decimais,0))  ELSE to_char(Campo_Mascara_casas(c.qt_resultado,coalesce(c.qt_decimais,0))) END ,to_char(CASE WHEN c.pr_resultado=0 THEN ''  ELSE Campo_Mascara_casas(c.pr_resultado,coalesce(c.qt_decimais,0)) END ))),c.ds_resultado),1,100),
		substr(CASE WHEN coalesce(c.nr_seq_unid_med::text, '') = '' THEN  c.ds_unidade_medida  ELSE substr(obter_lab_unid_med(c.nr_seq_unid_med,'C'),1,100) END ,1,100),
		substr(obter_lab_unid_med(c.nr_seq_unid_med,'D'),1,100),
		coalesce(to_char(c.dt_coleta,'dd/mm/yyyy'),Lab_obter_data_coleta(a.nr_prescricao,c.nr_seq_prescr)),
		substr(obter_metodo_exame_lab(c.nr_seq_metodo,2),1,60),
		to_char(b.nr_prescricao),
		d.nm_exame,
		a.dt_prescricao,
		substr(c.ds_observacao,1,254)
	from	exame_laboratorio d,
		exame_lab_result_item c,
		exame_lab_resultado b,
		prescr_medica a
	where	b.nr_seq_resultado	= c.nr_seq_resultado
	  and	d.nr_seq_exame 		= c.nr_seq_exame
	  and	b.nr_prescricao		= a.nr_prescricao
	  and 	a.nr_prescricao 	< nr_prescricao_p
	  and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
	  and 	c.nr_seq_exame		= nr_seq_exame_p
	  and	coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
	  --and	obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr) is not null
	  and 	exists (SELECT 1
		from	exame_lab_result_item z
		where	z.nr_seq_resultado = b.nr_seq_resultado
		and	z.nr_seq_prescr	   = c.nr_seq_prescr
		and 	(z.dt_aprovacao IS NOT NULL AND z.dt_aprovacao::text <> '')
		and coalesce(z.ie_restringe_resultado,'N') = 'N')
	  and	ie_material_result_ant_w = 1
	  and	((qt_dias_prescr_w = 0) or (a.dt_prescricao between(trunc(dt_prescricao_exam_w) - qt_dias_prescr_w) and dt_prescricao_exam_w))
	
union all

	select	obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr) dt_aprovacao,
		substr(coalesce(coalesce(CASE WHEN c.ds_resultado='0' THEN ''  ELSE CASE WHEN d.ie_formato_resultado='V' THEN ''  ELSE c.ds_resultado END  END ,	coalesce(CASE WHEN ie_percent_p=1 THEN Campo_Mascara_casas(c.pr_resultado,coalesce(c.qt_decimais,0))  ELSE to_char(Campo_Mascara_casas(c.qt_resultado,coalesce(c.qt_decimais,0))) END ,to_char(CASE WHEN c.pr_resultado=0 THEN ''  ELSE Campo_Mascara_casas(c.pr_resultado,coalesce(c.qt_decimais,0)) END ))),c.ds_resultado),1,100),
		substr(CASE WHEN coalesce(c.nr_seq_unid_med::text, '') = '' THEN  c.ds_unidade_medida  ELSE substr(obter_lab_unid_med(c.nr_seq_unid_med,'C'),1,100) END ,1,100),
		substr(obter_lab_unid_med(c.nr_seq_unid_med,'D'),1,100),
		coalesce(to_char(c.dt_coleta,'dd/mm/yyyy'),Lab_obter_data_coleta(a.nr_prescricao,c.nr_seq_prescr)),
		substr(obter_metodo_exame_lab(c.nr_seq_metodo,2),1,60),
		to_char(b.nr_prescricao),
		d.nm_exame,
		a.dt_prescricao,
		substr(c.ds_observacao,1,254)
	from	exame_laboratorio d,
		exame_lab_result_item c,
		exame_lab_resultado b,
		prescr_medica a,
		prescr_procedimento e
	where	b.nr_seq_resultado	= c.nr_seq_resultado
	  and	d.nr_seq_exame 		= c.nr_seq_exame
	  and	b.nr_prescricao		= a.nr_prescricao
	  and 	a.nr_prescricao 	< nr_prescricao_p
	  and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
	  and 	c.nr_seq_exame		= nr_seq_exame_p
	  and	coalesce(a.ie_recem_nato,'N') = ie_recem_nato_w
	  --and	obter_data_aprov_lab(b.nr_prescricao,c.nr_seq_prescr) is not null
	  and 	exists (select 1
		from	exame_lab_result_item z
		where	z.nr_seq_resultado = b.nr_seq_resultado
		and	z.nr_seq_prescr	   = c.nr_seq_prescr
		and 	(z.dt_aprovacao IS NOT NULL AND z.dt_aprovacao::text <> '')
		and coalesce(z.ie_restringe_resultado,'N') = 'N')
	  and	ie_material_result_ant_w = 2
	  and	e.nr_sequencia = nr_seq_prescr_w
	  and	e.nr_prescricao = nr_prescricao_p
	  and	coalesce(c.nr_seq_material,nr_seq_material_ex_w) = Obter_Material_Exame_Lab(null,e.cd_material_exame,1)
	  and	((qt_dias_prescr_w = 0) or (a.dt_prescricao between(trunc(dt_prescricao_exam_w) - qt_dias_prescr_w) and dt_prescricao_exam_w))
	order by dt_aprovacao desc;


BEGIN

select	cd_pessoa_fisica,
	cd_estabelecimento,
	coalesce(ie_recem_nato,'N'),
	dt_prescricao
into STRICT	cd_pessoa_fisica_w,
	cd_estabelecimento_w,
	ie_recem_nato_w,
	dt_prescricao_exam_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	coalesce(max(ie_material_result_ant),1),
	coalesce(max(qt_dias_res_ant),0)
into STRICT	ie_material_result_ant_w,
	qt_dias_prescr_w
from	lab_parametro
where	cd_estabelecimento = cd_estabelecimento_w;


nr_seq_prescr_w	:= nr_seq_prescr_p;
ie_separador_w  := ie_separador_p;

if (ie_separador_w = 'Q') then
	ie_separador_w := chr(13)||chr(10);
end if;


if (coalesce(nr_seq_prescr_w::text, '') = '') then

	select 	Lab_obter_seq_prescr(nr_prescricao_p,nr_seq_exame_p)
	into STRICT	nr_seq_prescr_w
	;

end if;


select	max(a.nr_Sequencia)
into STRICT	nr_seq_material_ex_w
from	material_exame_lab a,
	prescr_procedimento b
where	a.CD_MATERIAL_EXAME = b.CD_MATERIAL_EXAME
and	b.nr_prescricao	= nr_prescricao_p
and	b.nr_sequencia = nr_seq_prescr_w;


if (ie_opcao_p	in (4,5)) then
	select	1
	into STRICT	qt_result_anterior_w
	;
else

	select 	coalesce(max(qt_result_anterior),0)
	into STRICT	qt_result_anterior_w
	from	lab_parametro
	where	cd_estabelecimento = cd_estabelecimento_w;

end if;

qt_exame_ant_w := 0;
ds_retorno_w	:= null;

open c01;
loop
	fetch c01 into	dt_aprovacao_w,
			ds_resultado_w,
			cd_unidade_medida_w,
			ds_unidade_medida_w,
			dt_coleta_w,
			ds_metodo_w,
			nr_prescricao_w,
			nm_exame_w,
			dt_prescricao_w,
			ds_observacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	qt_exame_ant_w := qt_exame_ant_w +1;


	if ((qt_exame_ant_w <= qt_result_anterior_w) or (qt_result_anterior_w = 0)) and (coalesce(length(ds_retorno_w),0) < 1900) then

		if (position('.' in ds_resultado_w) = 1) then
			ds_resultado_w := replace(substr(ds_resultado_w,1,1),'.',',')||substr(ds_resultado_w,2,length(ds_resultado_w));
		end if;

		if (position(',' in ds_resultado_w) = 1) then
			ds_resultado_w := '0' || ds_resultado_w;
		end if;

	    if (obter_valor_param_usuario(722,190,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario,cd_estabelecimento_w) = 'S') then
			begin

			if ((ds_resultado_w)::numeric  <= 0) then
				ds_resultado_w := null;
			end if;

			exception
			when others then
				null;
			end;

		end if;

		if (ds_resultado_w IS NOT NULL AND ds_resultado_w::text <> '') then

			if (ie_opcao_p = 1) then
				ds_retorno_w := ds_retorno_w || dt_aprovacao_w || ': ' || ds_resultado_w || ie_separador_w;

			elsif (ie_opcao_p = 2) then
				ds_retorno_w := ds_retorno_w || dt_aprovacao_w || ': ' || ds_resultado_w || ' ' || cd_unidade_medida_w || ie_separador_w;

			elsif (ie_opcao_p = 3) then
				ds_retorno_w := ds_retorno_w || dt_aprovacao_w || ': ' || ds_resultado_w || ' ' || ds_unidade_medida_w || ie_separador_w;

			elsif (ie_opcao_p = 4) then
				ds_retorno_w := ds_retorno_w || dt_aprovacao_w;

			elsif (ie_opcao_p = 5) then
				ds_retorno_w := ds_retorno_w || ds_resultado_w;
			elsif (ie_opcao_p = 6) then
				ds_retorno_w := ds_retorno_w || dt_coleta_w || ie_separador_w;
			elsif (ie_opcao_p = 7) then
				ds_retorno_w := ds_retorno_w || ds_metodo_w || ie_separador_w;
			elsif (ie_opcao_p	= 8) then
				ds_retorno_w := ds_retorno_w || nr_prescricao_w || ie_separador_w;
			elsif (ie_opcao_p = 9) then
				ds_retorno_w := ds_retorno_w || nr_prescricao_w || ': '|| dt_coleta_w|| ': '||  ds_resultado_w || ' '|| cd_unidade_medida_w || ': '|| ds_metodo_w || ie_separador_w;
			elsif (ie_opcao_p = 10) then
				ds_retorno_w := ds_retorno_w || dt_aprovacao_w || ': ' || ds_resultado_w || ' ' || cd_unidade_medida_w || ie_separador_w;
			elsif (ie_opcao_p = 11) then
				ds_retorno_w := ds_retorno_w || rpad(nr_prescricao_w,10,' ') || '   '|| rpad(dt_coleta_w,18,' ') || '   '||  rpad(ds_resultado_w,20,' ') || '   '|| rpad(cd_unidade_medida_w,13,' ') || '   '|| rpad(ds_metodo_w,20,' ') || chr(13) || chr(10);
			elsif (ie_opcao_p = 12) then
				ds_retorno_w := ds_retorno_w || dt_prescricao_w || ': ' || ds_resultado_w || ie_separador_w;
			elsif (ie_opcao_p = 13) then
				ds_retorno_w := ds_retorno_w || dt_aprovacao_w || ': ' || ds_resultado_w || ' ' || ds_unidade_medida_w;
				if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
					ds_retorno_w := ds_retorno_w || chr(13)||chr(10) || wheb_mensagem_pck.get_texto(307890) || ' ' || ds_observacao_w || chr(13)||chr(10); -- Obs.:
				else
					ds_retorno_w := ds_retorno_w || ie_separador_w;
				end if;
			elsif (ie_opcao_p = 14) then
				ds_retorno_w := ds_retorno_w || dt_coleta_w || ': ' || ds_resultado_w || ' ' || cd_unidade_medida_w || ie_separador_w;
			elsif (ie_opcao_p = 15) then
				ds_retorno_w := ds_retorno_w || rpad(nr_prescricao_w,10,' ') || '   ' || rpad(dt_coleta_w,14,' ') || '   ' ||  rpad(ds_metodo_w,30,' ') || '   ' || rpad(ds_resultado_w || ' ' || cd_unidade_medida_w,50,' ') || chr(13) || chr(10);
			end if;
		end if;
	end if;

end loop;
close c01;
if (ie_opcao_p = 11) and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
	ds_retorno_w := wheb_mensagem_pck.get_texto(307891, 'DS_RETORNO_W=' || ds_retorno_w);
				/*
					Prescrição   Data de coleta       Resultado             UM               Método
					#@DS_RETORNO_W#@
				*/
elsif (ie_opcao_p = 15) and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
	ds_retorno_w := wheb_mensagem_pck.get_texto(380846) || chr(13) || chr(10) || ds_retorno_w;
end if;

if (ie_opcao_p = 10) and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
	ds_retorno_w := nm_exame_w || ' - '|| ds_retorno_w;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_result_anterior ( nr_prescricao_p bigint, nr_seq_exame_p bigint, ie_separador_p text, nr_seq_prescr_p bigint, ie_opcao_p bigint, ie_percent_p bigint default 0) FROM PUBLIC;

