-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_descricao_exames_laudo (nr_laudo_p bigint, opcao_p text) RETURNS varchar AS $body$
DECLARE


cd_exame_w varchar(30);
ds_exame_w varchar(255);
ds_retorno_w varchar(4000);

c00 CURSOR FOR
	SELECT	distinct prescr_proc.cd_procedimento,
		substr(coalesce(obter_desc_proc_interno(prescr_proc.nr_seq_proc_interno), obter_desc_procedimento(prescr_proc.cd_procedimento, prescr_proc.ie_origem_proced)), 1, 255)
	FROM prescr_procedimento prescr_proc
LEFT OUTER JOIN procedimento_paciente proc_pac ON (prescr_proc.nr_prescricao = proc_pac.nr_prescricao AND prescr_proc.nr_sequencia = proc_pac.nr_sequencia_prescricao)
WHERE proc_pac.nr_laudo = nr_laudo_p;


BEGIN

	ds_retorno_w := '';

	open c00;
	loop
	fetch c00 into
		cd_exame_w,
		ds_exame_w;
	EXIT WHEN NOT FOUND; /* apply on c00 */
		begin
			if opcao_p = 'C' then
				if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
					ds_retorno_w := ds_retorno_w || ', ';
				end if;

				ds_retorno_w := ds_retorno_w || cd_exame_w;
			end if;

			if opcao_p = 'D' then
				if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
					ds_retorno_w := ds_retorno_w || ', ';
				end if;

				ds_retorno_w := ds_retorno_w || ds_exame_w;
			end if;

			if opcao_p = 'A' then
				if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
					ds_retorno_w := ds_retorno_w || ', ';
				end if;

				ds_retorno_w := ds_retorno_w || cd_exame_w || '-' || ds_exame_w;
		  end if;

		end;
	end loop;
	close c00;

	return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_descricao_exames_laudo (nr_laudo_p bigint, opcao_p text) FROM PUBLIC;

