-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dose_regra_trat_onc ( cd_protocolo_p bigint, nr_seq_medicacao_p bigint, nr_seq_material_p bigint, nr_seq_paciente_p bigint default null, cd_unidade_medida_p text default null, qt_dose_p bigint default null, nm_atributo_p text default null, ie_pasta_p text default null, nr_seq_solucao_p bigint default null, cd_material_p bigint default null) RETURNS bigint AS $body$
DECLARE


dose_regra_w 			double precision;
retorno_w				double precision;
cd_unidade_med_sec_w	varchar(30);
qt_superf_corporea_w	double precision;
qt_peso_w				real;


BEGIN
retorno_w	:= 99999;

if ( coalesce(ie_pasta_p,'M') = 'S' ) then

	Select 	coalesce(max(qt_dose),retorno_w)
	into STRICT	dose_regra_w
	from   	protocolo_medic_material
	where  	cd_protocolo = cd_protocolo_p
	and    	nr_sequencia = nr_seq_medicacao_p
	and		nr_seq_solucao = nr_seq_solucao_p
	and 	cd_material = cd_material_p
	and    	ie_agrupador = 4;

else

	Select 	coalesce(max(qt_dose),retorno_w)
	into STRICT	dose_regra_w
	from   	protocolo_medic_material
	where  	cd_protocolo = cd_protocolo_p
	and    	nr_sequencia = nr_seq_medicacao_p
	and		nr_seq_material = nr_seq_material_p
	and    	ie_agrupador = 1;

end if;

if (coalesce(nm_atributo_p,'QT_DOSE') = 'QT_DOSE_PRESCR') then

	Select  coalesce(max(qt_peso),0)
	into STRICT	qt_peso_w
	from	paciente_setor
	where	nr_seq_paciente = nr_seq_paciente_p;

	select 	max(CD_UNIDADE_MED_SEC)
	into STRICT	cd_unidade_med_sec_w
	from 	UNIDADE_MEDIDA
	where 	CD_UNIDADE_MEDIDA = cd_unidade_medida_p
	AND 	CD_UNIDADE_MEDIDA <> CD_UNIDADE_MED_PRINC;


	if (cd_unidade_med_sec_w = 'm2') then


	   select 	round(obter_superficie_corp_red_ped(QT_PESO,QT_ALTURA, QT_REDUTOR_SC,cd_pessoa_fisica,nm_usuario,IE_FORMULA_SUP_CORPOREA),obter_numero_casas_sc)
	   into STRICT		qt_superf_corporea_w
	   from 	paciente_setor
	   where	nr_seq_paciente = nr_seq_paciente_p;

		if (qt_superf_corporea_w > 0) then

			dose_regra_w        := dose_regra_w * qt_superf_corporea_w;

		end if;

	elsif (cd_unidade_med_sec_w = 'kg') then

		if (qt_peso_w > 0) then
			 dose_regra_w        := dose_regra_w * qt_peso_w;
		end if;

	end if;

end if;

return	dose_regra_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dose_regra_trat_onc ( cd_protocolo_p bigint, nr_seq_medicacao_p bigint, nr_seq_material_p bigint, nr_seq_paciente_p bigint default null, cd_unidade_medida_p text default null, qt_dose_p bigint default null, nm_atributo_p text default null, ie_pasta_p text default null, nr_seq_solucao_p bigint default null, cd_material_p bigint default null) FROM PUBLIC;

