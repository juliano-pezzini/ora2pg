-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION emar_get_nr_seq_item ( nr_seq_cpoe_p bigint, ie_tipo_item_p text, ie_acm_sn_p text, nm_usuario_p text ) RETURNS bigint AS $body$
DECLARE


nr_prescricao_w			prescr_medica.nr_prescricao%type;
nr_seq_item_w			bigint;
ie_agrupar_acm_sn_w		varchar(1);
ie_desagrupa_proced_w	varchar(1);
ie_associados_w			varchar(1) := 'N';
ie_agrupar_associados_w	varchar(1);
ie_agrupa_rec_w			varchar(1);


BEGIN

nr_prescricao_w	:= obter_prescr_item_cpoe(nr_seq_cpoe_p, ie_tipo_item_p, null, null);
ie_agrupar_acm_sn_w := wheb_assist_pck.obterParametroFuncao(1113, 74, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
ie_desagrupa_proced_w := wheb_assist_pck.obterParametroFuncao(1113, 463, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
ie_agrupar_associados_w := wheb_assist_pck.obterParametroFuncao(1113, 139, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
ie_agrupa_rec_w := wheb_assist_pck.obterParametroFuncao(1113, 539, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

if (ie_tipo_item_p in ('IA', 'MAT', 'ME', 'S')) then

	select	max(nr_sequencia)
	into STRICT	nr_seq_item_w
	from	prescr_material
	where	nr_prescricao 	= nr_prescricao_w
	and		nr_seq_mat_cpoe	= nr_seq_cpoe_p
	and     ie_agrupador not in (3,7,9);

	if (coalesce(ie_acm_sn_p, 'N') = 'S') and (obter_se_agrupar_acm_sn_adep(nr_prescricao_w, nr_seq_item_w, ie_agrupar_acm_sn_w) = 'S') then
		return 0;
	else
		return nr_seq_item_w;
	end if;

elsif (ie_tipo_item_p = 'LD') then

	select	max(nr_sequencia)
	into STRICT	nr_seq_item_w
	from	prescr_leite_deriv
	where	nr_prescricao 		= nr_prescricao_w
	and		nr_seq_dieta_cpoe	= nr_seq_cpoe_p;

	if (coalesce(ie_acm_sn_p, 'N') = 'S') and (obter_se_agrupar_acm_sn_adep(nr_prescricao_w, nr_seq_item_w, ie_agrupar_acm_sn_w) = 'S') then
		return 0;
	else
		return nr_seq_item_w;
	end if;

elsif (ie_tipo_item_p in ('L', 'MP', 'P')) then

	select	max(nr_sequencia)
	into STRICT	nr_seq_item_w
	from	prescr_procedimento
	where 	nr_prescricao 		= nr_prescricao_w
	and		nr_seq_proc_cpoe	= nr_seq_cpoe_p
	and     coalesce(nr_seq_origem::text, '') = '';

	if (ie_tipo_item_p = 'L') then
		return nr_seq_item_w;
	end if;

	ie_associados_w := substr(obter_se_associado_dif(nr_prescricao_w, nr_seq_item_w),1,1);

	if (ie_desagrupa_proced_w = 'N') then
		if (obter_se_agrupar_proced_adep(nr_prescricao_w, nr_seq_item_w, ie_acm_sn_p, ie_agrupar_acm_sn_w, ie_associados_w, ie_agrupar_associados_w) = 'N') then
			if (ie_associados_w = 'N') then
				return nr_seq_item_w || nr_prescricao_w;
			else
				return nr_seq_item_w;
			end if;
		else
			return 0;
		end if;
	else
		return nr_seq_item_w || nr_prescricao_w;
	end if;

elsif (ie_tipo_item_p in ('C', 'G', 'I')) then

	select	max(nr_sequencia)
	into STRICT	nr_seq_item_w
	from	prescr_procedimento
	where 	nr_prescricao 		= nr_prescricao_w
	and		nr_seq_proc_cpoe	= nr_seq_cpoe_p;

	if (coalesce(ie_acm_sn_p, 'N') = 'S') and (obter_se_agrupar_acm_sn_adep(nr_prescricao_w, nr_seq_item_w, ie_agrupar_acm_sn_w) = 'S') then
		return 0;
	else
		return nr_seq_item_w;
	end if;

elsif (ie_tipo_item_p in ('IAG', 'M')) then

	select	max(nr_sequencia)
	into STRICT	nr_seq_item_w
	from 	prescr_material
	where	nr_prescricao 	= nr_prescricao_w
	and		nr_seq_mat_cpoe = nr_seq_cpoe_p
	and     ie_agrupador not in (3,7,9);

	if (coalesce(ie_acm_sn_p, 'N') = 'S') and (obter_se_agrupa_acm_sn_medic(nr_prescricao_w, nr_seq_item_w, ie_agrupar_acm_sn_w) = 'N') then
		return nr_seq_item_w;
	else
		return 0;
	end if;

elsif (ie_tipo_item_p = 'R') then

	select	max(nr_sequencia)
	into STRICT	nr_seq_item_w
	from	prescr_recomendacao
	where	nr_prescricao 	= nr_prescricao_w
	and		nr_seq_rec_cpoe	= nr_seq_cpoe_p;

	if (coalesce(ie_agrupa_rec_w, 'N') = 'S') and (ie_acm_sn_p = '') and (obter_se_agrupar_acm_sn_rec(nr_prescricao_w, nr_seq_item_w, ie_agrupar_acm_sn_w) = 'S') then
		return 0;
	end if;

	return nr_seq_item_w;

elsif (ie_tipo_item_p = 'SNE') then

	select	max(nr_sequencia)
	into STRICT	nr_seq_item_w
	from	prescr_material
	where	nr_prescricao 		= nr_prescricao_w
	and		nr_seq_dieta_cpoe	= nr_seq_cpoe_p
	and     ie_agrupador not in (3,7,9);

	return coalesce(nr_seq_item_w, 0);

end if;

return 0;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION emar_get_nr_seq_item ( nr_seq_cpoe_p bigint, ie_tipo_item_p text, ie_acm_sn_p text, nm_usuario_p text ) FROM PUBLIC;

