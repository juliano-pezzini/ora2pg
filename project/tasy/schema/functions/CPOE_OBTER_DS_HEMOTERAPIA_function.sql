-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_ds_hemoterapia ( nr_sequencia_p cpoe_hemoterapia.nr_sequencia%type, dt_liberacao_p cpoe_hemoterapia.dt_liberacao%type default null, ie_negrito_p text default 'N', dt_lib_suspensao_p cpoe_hemoterapia.dt_lib_suspensao%type default null, dt_suspensao_p cpoe_hemoterapia.dt_suspensao%type default null, ie_tipo_p cpoe_hemoterapia.ie_tipo%type default null, qt_procedimento_p cpoe_hemoterapia.qt_procedimento%type default null, ie_reserva_p cpoe_hemoterapia.ie_reserva%type default 'N', ie_baixado_por_alta_p cpoe_recomendacao.ie_baixado_por_alta%type default null, dt_alta_medico_p cpoe_recomendacao.dt_alta_medico%type default null, ie_adep_p text default 'N', ds_horarios_p text default null, ie_cpoe_p text default 'S', dt_fim_p timestamp default null) RETURNS varchar AS $body$
DECLARE

									
cd_mat_hem1_w			cpoe_hemoterapia.cd_mat_hem1%type;
qt_dose_hem1_w			cpoe_hemoterapia.qt_dose_hem1%type;
cd_unid_medida_dose_hem1_w	cpoe_hemoterapia.cd_unid_medida_dose_hem1%type;
cd_mat_hem2_w			cpoe_hemoterapia.cd_mat_hem2%type;
qt_dose_hem2_w			cpoe_hemoterapia.qt_dose_hem2%type;
cd_unid_medida_dose_hem2_w	cpoe_hemoterapia.cd_unid_medida_dose_hem2%type;
cd_mat_hem3_w			cpoe_hemoterapia.cd_mat_hem3%type;
qt_dose_hem3_w			cpoe_hemoterapia.qt_dose_hem3%type;
cd_unid_medida_dose_hem3_w	cpoe_hemoterapia.cd_unid_medida_dose_hem3%type;
cd_mat_hem4_w			cpoe_hemoterapia.cd_mat_hem4%type;
qt_dose_hem4_w			cpoe_hemoterapia.qt_dose_hem4%type;
cd_unid_medida_dose_hem4_w	cpoe_hemoterapia.cd_unid_medida_dose_hem4%type;
cd_mat_hem5_w			cpoe_hemoterapia.cd_mat_hem5%type;
qt_dose_hem5_w			cpoe_hemoterapia.qt_dose_hem5%type;
cd_unid_medida_dose_hem5_w	cpoe_hemoterapia.cd_unid_medida_dose_hem5%type;
ds_retorno_w   			varchar(4000);
ds_hemocomponente_w   		varchar(4000);
ds_dados_hemot_w		varchar(500);
ds_retorno_tag_w varchar(1000);
ds_class_tag_w   varchar(5);
ie_needs_ackn_interface_w 	varchar(2);
ie_confirm_ackn_interface_w	varchar(2);
rule_quantity_w		integer;
ie_dbcheck_mat_hem1_w	varchar(1);
ie_dbcheck_mat_hem2_w	varchar(1);
ie_dbcheck_mat_hem3_w	varchar(1);
ie_dbcheck_mat_hem4_w	varchar(1);
ie_dbcheck_mat_hem5_w	varchar(1);
	
	function bold( ds_valor_p text) return text is
	;
BEGIN
		return '<strong>' ||ds_valor_p||'</strong>';
	end;
	
	function dose_unidade_medida(qt_dose_p				number,
                                 ds_dose_diferenciada_p	varchar2,
                                 cd_unidade_medida_p	varchar2) return varchar2 is	
		qt_dose_w           varchar2(50);
	begin
		if (coalesce(ds_dose_diferenciada_p::text, '') = '') then
			--Colocar '0' antes da virgula			
			qt_dose_w := qt_dose_p;
			if (substr(qt_dose_p,1,1) = ',') then				
				qt_dose_w	:= '0' || qt_dose_p;
				
				qt_dose_w	:= replace(qt_dose_w,'.',',');			
			end if;			
			
			return ' ' || qt_dose_w || ' ' || cd_unidade_medida_p || ' ';
		else
			--Colocar '0' antes da virgula
			qt_dose_w := ds_dose_diferenciada_p;
			
			if (substr(ds_dose_diferenciada_p,1,1) = ',') then
				qt_dose_w	:= '0' || ds_dose_diferenciada_p;
				
			qt_dose_w	:= replace(qt_dose_w,'.',',');						
			end if;			
		
			return ' ' || qt_dose_w || ' ' || cd_unidade_medida_p || ' ';
		end if;		
	end;
	
	function obter_descricao_subitem(	cd_material_p			number,
										qt_dose_p				number,
										cd_unidade_medida_p		varchar2,
										ds_dose_diferenciada_p	varchar2 )
	 		    	return varchar2 is
	begin
		return ' <br> ' ||
				cpoe_add_span_mat_comp( substr(obter_desc_material(cd_material_p),1,80) ) ||
				cpoe_add_span( dose_unidade_medida(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p));
	end;
	
	function adep_dose_unidade_medida(	qt_dose_p				number,
										ds_dose_diferenciada_p	varchar2,
										cd_unidade_medida_p		varchar2) return varchar2 is	
		qt_dose_w           varchar2(50 char);
	begin
		if (coalesce(ds_dose_diferenciada_p::text, '') = '') then
			--Colocar '0' antes da virgula			
			qt_dose_w := qt_dose_p;
			if (substr(qt_dose_p,1,1) = ',') then				
				qt_dose_w	:= '0' || qt_dose_p;
				
				qt_dose_w	:= replace(qt_dose_w,'.',',');			
			end if;			
			
			return ' ' || qt_dose_w || ' ' || Obter_Desc_Unid_Med(cd_unidade_medida_p) || ' ';
		else
			--Colocar '0' antes da virgula
			qt_dose_w := ds_dose_diferenciada_p;
			
			if (substr(ds_dose_diferenciada_p,1,1) = ',') then
				qt_dose_w	:= '0' || ds_dose_diferenciada_p;
				
			qt_dose_w	:= replace(qt_dose_w,'.',',');						
			end if;			
		
			return ' ' || qt_dose_w || ' ' || Obter_Desc_Unid_Med(cd_unidade_medida_p) || ' ';
		end if;		
	end;
	
	function adep_obter_descricao_subitem(	cd_material_p			number,
											qt_dose_p				number,
											cd_unidade_medida_p		varchar2,
											ds_dose_diferenciada_p	varchar2 )
	 		    	return varchar2 is
	begin
		return ' <br> ' ||
				cpoe_add_span_mat_comp( substr(obter_desc_material(cd_material_p),1,80) ) ||
				cpoe_add_span( adep_dose_unidade_medida(qt_dose_p, ds_dose_diferenciada_p, cd_unidade_medida_p));
	end;
	
	function get_order_interface(	ie_tipo_item_p in varchar2,
									nr_sequencia_p in number) return varchar2 is
	
	begin
		ie_needs_ackn_interface_w := cpoe_integracao_count(ie_tipo_item_p, nr_sequencia_p, 'BTN');
		ie_confirm_ackn_interface_w := cpoe_integracao_count(ie_tipo_item_p, nr_sequencia_p, 'TAG');
		
		if (ie_adep_p = 'S') then
			ds_class_tag_w := 'adep';
		else
			ds_class_tag_w := 'gpt';
		end if;
		
		ds_retorno_tag_w := '</div><div class="legend-cell-status-text-' || ds_class_tag_w ||'" style="cursor: default; flex-wrap: wrap;">
                <div class="legend-cell-content-tag-' || ds_class_tag_w ||'" style="cursor: default;">';

                        
    
		if (ie_adep_p = 'S') then
			ds_retorno_tag_w := ds_retorno_tag_w || '<div class="legend-cell-tag-adep" style="background-color: #FFE9AB; cursor: default; margin-top: 4px;"</div>';			
		else
			ds_retorno_tag_w := ds_retorno_tag_w || '<div class="legend-cell-tag-gpt" style="background-color: #FFE9AB; cursor: default; margin-top: 4px;" </div>';
		end if;
		
		if (ie_needs_ackn_interface_w = 'S') then
			ds_retorno_tag_w :=  ds_retorno_tag_w || obter_desc_expressao_idioma(1000214, null, wheb_usuario_pck.get_nr_seq_idioma)
			|| ' </div>
              </div>
          </div><div style="display:none">;';
		elsif (ie_confirm_ackn_interface_w = 'S') then
			ds_retorno_tag_w :=  ds_retorno_tag_w || obter_desc_expressao_idioma(1012943, null, wheb_usuario_pck.get_nr_seq_idioma)
			|| ' </div>
              </div>
          </div><div style="display:none">;';
    else
      ds_retorno_tag_w := null;
		end if;

		return ds_retorno_tag_w;
	end;

begin

if (ie_tipo_p IS NOT NULL AND ie_tipo_p::text <> '') then
	if (ie_tipo_p = 1) then
		begin
			ds_hemocomponente_w := 	obter_desc_expressao(486941,null);
		end;
	elsif (ie_tipo_p = 2) then
		begin
			ds_hemocomponente_w := 	obter_desc_expressao(891572,null);
		end;
	elsif (ie_tipo_p = 3) then
		begin
			ds_hemocomponente_w := 	obter_desc_expressao(300867,null);			
		end;
	elsif (ie_tipo_p = 4) then
		begin
			ds_hemocomponente_w := 	obter_desc_expressao(289150,null);			
		end;
	end if;
end if;

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '')  then
	ds_retorno_w := cpoe_obter_desc_info_hemote(nr_sequencia_p);
end if;

if (ie_negrito_p = 'S') then
 ds_retorno_w := bold(ds_retorno_w);
end if;

if (qt_procedimento_p IS NOT NULL AND qt_procedimento_p::text <> '') then
	ds_retorno_w := ds_retorno_w || CPOE_ADD_SPAN(qt_procedimento_p) || CPOE_ADD_SPAN(obter_desc_expressao(729618,null));
end if;

if (ds_horarios_p IS NOT NULL AND ds_horarios_p::text <> '') then
	ds_retorno_w := ds_retorno_w || CPOE_ADD_SPAN(ds_horarios_p);
end if;

if (coalesce(ie_reserva_p,'N') = 'N') then
	ds_retorno_w := ds_retorno_w  || ' ' || CPOE_ADD_SPAN(ds_hemocomponente_w);
else
	ds_retorno_w := ds_retorno_w  || ' ' || CPOE_ADD_SPAN(obter_desc_expressao(297667,null));
end if;

select	cd_mat_hem1,
		qt_dose_hem1,
		cd_unid_medida_dose_hem1,
		cd_mat_hem2,
		qt_dose_hem2,
		cd_unid_medida_dose_hem2,
		cd_mat_hem3,
		qt_dose_hem3,
		cd_unid_medida_dose_hem3,
		cd_mat_hem4,
		qt_dose_hem4,
		cd_unid_medida_dose_hem4,
		cd_mat_hem5,
		qt_dose_hem5,
		cd_unid_medida_dose_hem5
into STRICT	cd_mat_hem1_w,
		qt_dose_hem1_w,
		cd_unid_medida_dose_hem1_w,
		cd_mat_hem2_w,
		qt_dose_hem2_w,
		cd_unid_medida_dose_hem2_w,
		cd_mat_hem3_w,
		qt_dose_hem3_w,
		cd_unid_medida_dose_hem3_w,
		cd_mat_hem4_w,
		qt_dose_hem4_w,
		cd_unid_medida_dose_hem4_w,
		cd_mat_hem5_w,
		qt_dose_hem5_w,
		cd_unid_medida_dose_hem5_w
from	cpoe_hemoterapia
where	nr_sequencia = nr_sequencia_p;

if (coalesce(ie_adep_p, 'N') = 'N') then

	if (cd_mat_hem1_w IS NOT NULL AND cd_mat_hem1_w::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || obter_descricao_subitem( cd_mat_hem1_w, qt_dose_hem1_w, cd_unid_medida_dose_hem1_w, null),1,4000);
	end if;

	RAISE NOTICE '%', cd_mat_hem2_w;
	RAISE NOTICE '%', obter_descricao_subitem(cd_mat_hem2_w, qt_dose_hem2_w, cd_unid_medida_dose_hem2_w, null);

	if (cd_mat_hem2_w IS NOT NULL AND cd_mat_hem2_w::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || obter_descricao_subitem(cd_mat_hem2_w, qt_dose_hem2_w, cd_unid_medida_dose_hem2_w, null),1,4000);
	end if;

	if (cd_mat_hem3_w IS NOT NULL AND cd_mat_hem3_w::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || obter_descricao_subitem( cd_mat_hem3_w, qt_dose_hem3_w, cd_unid_medida_dose_hem3_w, null),1,4000);
	end if;

	if (cd_mat_hem4_w IS NOT NULL AND cd_mat_hem4_w::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || obter_descricao_subitem( cd_mat_hem4_w, qt_dose_hem4_w, cd_unid_medida_dose_hem4_w, null),1,4000);
	end if;

	if (cd_mat_hem5_w IS NOT NULL AND cd_mat_hem5_w::text <> '') then
		ds_retorno_w := substr(ds_retorno_w || obter_descricao_subitem( cd_mat_hem5_w, qt_dose_hem5_w, cd_unid_medida_dose_hem5_w, null),1,4000);
	end if;

else
	if (pkg_i18n.get_user_locale() <> 'en_AU') then
		select	Obter_dados_prescr_hm(nr_prescricao,nr_sequencia,cd_procedimento)
		into STRICT	ds_dados_hemot_w
		from	prescr_procedimento
		where	nr_seq_proc_cpoe = nr_sequencia_p  LIMIT 1;

		if (ds_dados_hemot_w IS NOT NULL AND ds_dados_hemot_w::text <> '') then
			ds_retorno_w := ds_retorno_w||cpoe_add_span(ds_dados_hemot_w);
		end if;

		if (cd_mat_hem1_w IS NOT NULL AND cd_mat_hem1_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem(cd_mat_hem1_w, qt_dose_hem1_w, cd_unid_medida_dose_hem1_w, null),1,4000);
		end if;

		if (cd_mat_hem2_w IS NOT NULL AND cd_mat_hem2_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem(cd_mat_hem2_w, qt_dose_hem2_w, cd_unid_medida_dose_hem2_w, null),1,4000);
		end if;

		if (cd_mat_hem3_w IS NOT NULL AND cd_mat_hem3_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem(cd_mat_hem3_w, qt_dose_hem3_w, cd_unid_medida_dose_hem3_w, null),1,4000);
		end if;

		if (cd_mat_hem4_w IS NOT NULL AND cd_mat_hem4_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem(cd_mat_hem4_w, qt_dose_hem4_w, cd_unid_medida_dose_hem4_w, null),1,4000);
		end if;

		if (cd_mat_hem5_w IS NOT NULL AND cd_mat_hem5_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || adep_obter_descricao_subitem(cd_mat_hem5_w, qt_dose_hem5_w, cd_unid_medida_dose_hem5_w, null),1,4000);
		end if;
	end if;	

end if;

select	count(*)
into STRICT	rule_quantity_w
from	cpoe_regra_ator LIMIT 1;
		
if (rule_quantity_w > 0 and ie_cpoe_p = 'N') then
	ds_retorno_w := ds_retorno_w || get_order_interface('H',nr_sequencia_p);
end if;

if	((dt_lib_suspensao_p IS NOT NULL AND dt_lib_suspensao_p::text <> '') and (dt_suspensao_p IS NOT NULL AND dt_suspensao_p::text <> '') 	  and (dt_suspensao_p <=clock_timestamp()) 	  and (ie_adep_p <> 'S'))		  or
	((coalesce(dt_lib_suspensao_p::text, '') = '')     and (dt_fim_p <= clock_timestamp())             and 
	ie_adep_p = 'N')
	then
	ds_retorno_w := '<del> '||ds_retorno_w|| '</del>';
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_ds_hemoterapia ( nr_sequencia_p cpoe_hemoterapia.nr_sequencia%type, dt_liberacao_p cpoe_hemoterapia.dt_liberacao%type default null, ie_negrito_p text default 'N', dt_lib_suspensao_p cpoe_hemoterapia.dt_lib_suspensao%type default null, dt_suspensao_p cpoe_hemoterapia.dt_suspensao%type default null, ie_tipo_p cpoe_hemoterapia.ie_tipo%type default null, qt_procedimento_p cpoe_hemoterapia.qt_procedimento%type default null, ie_reserva_p cpoe_hemoterapia.ie_reserva%type default 'N', ie_baixado_por_alta_p cpoe_recomendacao.ie_baixado_por_alta%type default null, dt_alta_medico_p cpoe_recomendacao.dt_alta_medico%type default null, ie_adep_p text default 'N', ds_horarios_p text default null, ie_cpoe_p text default 'S', dt_fim_p timestamp default null) FROM PUBLIC;

