-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_code_status ( nr_seq_patient_p bigint, nr_seq_encounter_p bigint, ie_return_color text default PFCS_PCK_CONSTANTS.IE_NO) RETURNS varchar AS $body$
DECLARE



CD_DNR_W            CONSTANT varchar(3)    := 'DNR';
CD_DNI_W            CONSTANT varchar(3)    := 'DNI';
CD_FULL_W           CONSTANT varchar(4)    := 'FULL';
CD_OTHER_W          CONSTANT varchar(5)    := 'OTHER';
CD_CODE_STATUS_W    CONSTANT varchar(11)   := 'CODE_STATUS';

cd_flag_w           pfcs_patient_flag.cd_flag%type;
cd_color_w          pfcs_indicator_target.ds_cor_html%type;


BEGIN
    select nullif( coalesce(max(cd_flag),PFCS_PCK_CONSTANTS.IE_NO), PFCS_PCK_CONSTANTS.IE_NO )
    into STRICT cd_flag_w
    from (
        SELECT cd_flag
        from pfcs_patient_flag
        where nr_seq_patient = nr_seq_patient_p
            and nr_seq_encounter = nr_seq_encounter_p
            and (   upper(cd_flag) in (CD_DNR_W,CD_DNI_W,CD_FULL_W,CD_OTHER_W) or
                    upper(cd_category) in (CD_DNR_W,CD_CODE_STATUS_W)  )
        order by dt_atualizacao desc
    ) alias8 LIMIT 1;

    if (ie_return_color = PFCS_PCK_CONSTANTS.IE_YES_BR) then
        if (upper(cd_flag_w) in (CD_DNR_W,CD_DNI_W)) then
            cd_color_w := PFCS_PCK_CONSTANTS.CD_COLOR_CODE_STATUS;
        end if;
        cd_flag_w := concat(cd_flag_w,lower(PFCS_PCK_CONSTANTS.CD_COLOR)||cd_color_w);
    end if;

    return cd_flag_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_code_status ( nr_seq_patient_p bigint, nr_seq_encounter_p bigint, ie_return_color text default PFCS_PCK_CONSTANTS.IE_NO) FROM PUBLIC;

