-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_information_report (nr_atendimento_p bigint, ie_type_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(4000);
cd_doenca_list_w varchar(1000);
cd_procedimento_list_w varchar(1000);

C01 CURSOR FOR
	SELECT  string_agg(b.cd_doenca, ',' ORDER BY b.cd_doenca)
	from	DIAGNOSTICO_MEDICO a,
			DIAGNOSTICO_DOENCA b
	where	a.nr_Atendimento	= b.nr_atendimento
	and		a.dt_diagnostico	= b.dt_diagnostico
	and		a.nr_atendimento	= nr_atendimento_p;

C02 CURSOR FOR
SELECT  string_agg(p.cd_procedimento_loc, ',' ORDER BY p.cd_procedimento_loc)
FROM    procedimento_pac_medico ppm,
        procedimento p
where   ppm.cd_procedimento = p.cd_procedimento
and     ppm.ie_origem_proced = p.ie_origem_proced
and     ppm.nr_atendimento = nr_atendimento_p
and     ppm.ie_situacao = 'A';


BEGIN
if (ie_type_p = 'D') then
open c01;
  fetch c01 into cd_doenca_list_w;
  begin
      ds_retorno_w:=cd_doenca_list_w;
  end;
 close c01;

elsif (ie_type_p = 'P') then

open c02;

 fetch c02 into cd_procedimento_list_w;
  begin
      ds_retorno_w:=cd_procedimento_list_w;
  end;
close c02;

end if;
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_information_report (nr_atendimento_p bigint, ie_type_p text) FROM PUBLIC;

