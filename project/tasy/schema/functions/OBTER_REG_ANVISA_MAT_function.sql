-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_reg_anvisa_mat ( cd_estabelecimento_p bigint, cd_material_p bigint, nr_seq_marca_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/* ie_opcao_p

'RA' registro anvisa
'DV' data de validade
'IV' Vigente Anvisa
*/
ds_retorno_w			varchar(255)	:= null;
qt_reg_w			bigint;
nr_registro_marca_w		varchar(60)	:= null;
dt_validade_reg_anvisa_w	timestamp := null;
ie_vigente_anvisa_w			material_marca.ie_vigente_anvisa%type := null;

nr_registro_marca_ww		varchar(60)	:= null;
dt_validade_reg_anvisa_ww	timestamp := null;
ie_vigente_anvisa_ww		material_marca.ie_vigente_anvisa%type := null;

ds_motivo_isencao_anvisa_w	material_marca.ds_motivo_isencao_anvisa%type := null;


BEGIN

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
	
	select 	max('ISENTO'),
			max(ds_motivo_isencao_anvisa)
	into STRICT
			nr_registro_marca_w,
			ds_motivo_isencao_anvisa_w
	from material_estab 
	where cd_material = cd_material_p
	and cd_estabelecimento = cd_estabelecimento_p
	and ie_reg_anvisa_isento = 'S';
	
	if (coalesce(nr_registro_marca_w::text, '') = '') then
	
		select max('ISENTO'),
			   max(ds_motivo_isencao_anvisa)
		into STRICT
			nr_registro_marca_w,
			ds_motivo_isencao_anvisa_w 
		from material_marca 
		where cd_material = cd_material_p
		and cd_estabelecimento = cd_estabelecimento_p
		and ie_reg_anvisa_isento = 'S';
		
		if (coalesce(nr_registro_marca_w::text, '') = '') then
			if (nr_seq_marca_p IS NOT NULL AND nr_seq_marca_p::text <> '') then
				select	max(nr_registro_anvisa),
					max(dt_validade_reg_anvisa),
					max(ie_vigente_anvisa)
				into STRICT	nr_registro_marca_w,	
					dt_validade_reg_anvisa_w,
					ie_vigente_anvisa_w
				from	material_marca
				where	nr_sequencia		= nr_seq_marca_p
				and	cd_material		= cd_material_p
				and	coalesce(IE_SITUACAO,'A') = 'A'
				and (cd_estabelecimento	= cd_estabelecimento_p or coalesce(cd_estabelecimento::text, '') = '');
			end if;

			select	max(nr_registro_anvisa),
				max(dt_validade_reg_anvisa),
				max(ie_vigente_anvisa)
			into STRICT	nr_registro_marca_ww,
				dt_validade_reg_anvisa_ww,
				ie_vigente_anvisa_ww
			from	material_estab
			where	cd_material 		= cd_material_p
			and	cd_estabelecimento 	= cd_estabelecimento_p;
			
			nr_registro_marca_w 		:= coalesce(nr_registro_marca_w, nr_registro_marca_ww);
			dt_validade_reg_anvisa_w 	:= coalesce(dt_validade_reg_anvisa_w, dt_validade_reg_anvisa_ww);
			ie_vigente_anvisa_w 		:= coalesce(ie_vigente_anvisa_w, ie_vigente_anvisa_ww);
			
			/* Se ainda n√£o encontrou, buscar na tabela material */

			if (coalesce(nr_registro_marca_w::text, '') = '') and (coalesce(dt_validade_reg_anvisa_w::text, '') = '') then
				select	max(nr_registro_anvisa),
					max(dt_validade_reg_anvisa)
				into STRICT	nr_registro_marca_w,	
					dt_validade_reg_anvisa_w
				from	material
				where	cd_material	= cd_material_p;
			end if;	
		end if;
	end if;
	
	if (ie_opcao_p = 'RA') then
		ds_retorno_w := nr_registro_marca_w;
	elsif (ie_opcao_p = 'DV') then
		ds_retorno_w := dt_validade_reg_anvisa_w;
	elsif (ie_opcao_p = 'IV') then
		ds_retorno_w := coalesce(ie_vigente_anvisa_w, 'N');
	elsif (ie_opcao_p = 'DS') then
		ds_retorno_w := ds_motivo_isencao_anvisa_w;
	end if;	
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_reg_anvisa_mat ( cd_estabelecimento_p bigint, cd_material_p bigint, nr_seq_marca_p bigint, ie_opcao_p text) FROM PUBLIC;

