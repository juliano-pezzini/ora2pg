-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tributo_item_credito ( nr_sequencia_p bigint, nr_item_p bigint, ie_opcao_p text, origem_p text, ie_origem_proced_p bigint ) RETURNS bigint AS $body$
DECLARE


resultado_w		double precision;
vl_imposto_w	nota_fiscal_item_trib.vl_tributo%type := 0;	

BEGIN
	
	if (origem_p = 'NF') then
	
		select	coalesce(sum(a.vl_tributo),0)
		into STRICT		vl_imposto_w
		from		nota_fiscal_item_trib a,
					tributo b
		where	a.nr_sequencia = nr_sequencia_p
		and    	b.ie_soma_diminui = ie_opcao_p	
		and 		b.cd_tributo = a.cd_tributo
		and		a.nr_item_nf = nr_item_p
		and		a.ie_rateio = 'N';
		
	elsif (origem_p = 'MAPA') then
	
		select	coalesce(sum(b.vl_imposto),0)
		into STRICT		vl_imposto_w
		from		material_atend_paciente a,
					matpaci_imposto b,
					tributo c
		where	a.nr_sequencia = b.nr_seq_matpaci					
		and		a.nr_sequencia = nr_sequencia_p
		and 		c.cd_tributo   = b.cd_tributo
		and 		c.ie_soma_diminui = ie_opcao_p
		and		coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and		a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0);
	
	elsif (origem_p = 'PPA') then
	
		select	coalesce(sum(b.vl_imposto),0)
		into STRICT		vl_imposto_w
		from		procedimento_paciente a,
					propaci_imposto b,
					tributo c
		where	a.nr_sequencia = b.nr_seq_propaci
		and		a.nr_sequencia = nr_sequencia_p
		and		coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and 		c.cd_tributo = b.cd_tributo
		and 		c.ie_soma_diminui = ie_opcao_p
		and		a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0);	
	
	elsif (origem_p = 'MAPCP') then
		
		select	coalesce(sum(b.vl_imposto),0)
		into STRICT		vl_imposto_w
		from		material_atend_paciente a,
					matpaci_imposto b,
					tributo c
		where	a.nr_sequencia = b.nr_seq_matpaci
		and		coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and 		c.cd_tributo = b.cd_tributo
		and 		c.ie_soma_diminui = ie_opcao_p
		and		a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)					
		and		a.nr_interno_conta = nr_sequencia_p
		and		a.cd_material = nr_item_p;
	
	elsif (origem_p = 'PPCP') then
	
		select	coalesce(sum(b.vl_imposto),0)
		into STRICT		vl_imposto_w
		from		procedimento_paciente a,
					propaci_imposto b,
					tributo c
		where	a.nr_sequencia = b.nr_seq_propaci
		and		coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and		a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
		and 		c.cd_tributo = b.cd_tributo
		and 		c.ie_soma_diminui = ie_opcao_p
		and		a.nr_interno_conta = nr_sequencia_p
		and		a.cd_procedimento = nr_item_p
		and		a.ie_origem_proced = ie_origem_proced_p;
	
	elsif (origem_p = 'MAPPC') then
	
		select	coalesce(sum(b.vl_imposto),0)
		into STRICT		vl_imposto_w
		from		material_atend_paciente a,
					matpaci_imposto b,
					tributo c
		where	a.nr_sequencia = b.nr_seq_matpaci
		and		coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and		a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
		and 		c.cd_tributo = b.cd_tributo
		and 		c.ie_soma_diminui = ie_opcao_p
		and		a.nr_interno_conta = nr_sequencia_p
		and		a.cd_material = nr_item_p;
	
	elsif (origem_p = 'PPCP') then
	
		select	coalesce(sum(b.vl_imposto),0)
		into STRICT		vl_imposto_w
		from		procedimento_paciente a,
					propaci_imposto b,
					tributo c
		where	a.nr_sequencia = b.nr_seq_propaci
		and		coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and		a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
		and 		c.cd_tributo = b.cd_tributo
		and 		c.ie_soma_diminui = ie_opcao_p
		and		a.nr_interno_conta = nr_sequencia_p
		and		a.cd_procedimento = nr_item_p
		and		a.ie_origem_proced = ie_origem_proced_p;

	end if;
	
resultado_w := vl_imposto_w;

return resultado_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tributo_item_credito ( nr_sequencia_p bigint, nr_item_p bigint, ie_opcao_p text, origem_p text, ie_origem_proced_p bigint ) FROM PUBLIC;

