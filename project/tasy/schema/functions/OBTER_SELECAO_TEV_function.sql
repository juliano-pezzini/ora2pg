-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_selecao_tev ( nr_sequencia_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ie_padrao_w varchar(10);

ds_retorno_w	varchar(4000);

titulo_risco_cirurgico_w varchar(2000);
ds_risco_cirurgico_w varchar(255);
ds_lista_risco_cirurgico_w varchar(2000);

titulo_fator_risco_w varchar(2000);
ds_fator_risco_w varchar(255);
ds_lista_fator_risco_w varchar(2000);

titulo_uso_heparina_w varchar(2000);
ds_uso_heparina_w varchar(255);
ds_lista_uso_heparina_w varchar(2000);
ds_lista_uso_heparina_abs_w varchar(2000);
ds_lista_uso_heparina_nen_w varchar(2000);
ds_lista_uso_heparina_rel_w varchar(2000);
titulo_profilaxia_mecanica_w varchar(2000);
ds_profilaxia_mecanica_w varchar(255);
ds_lista_profilaxia_mecanica_w varchar(2000);
nr_seq_apres_w		bigint;
nm_atributo_w		varchar(30);
ie_nao_se_aplica_w	varchar(1);
nr_seq_motivo_w		bigint;
ds_motivo_w		varchar(80);
ie_padrao_heparina_w	varchar(1);
ds_resposta_w		varchar(255);
ie_tipo_w		varchar(1);
ds_label_w		varchar(255);
qt_cad_w		bigint;
nr_seq_cad_w		varchar(10);
qt_resp_cad_w		bigint;

C00 CURSOR FOR
	SELECT	ds_label
	from	tabela_visao_atributo a
	where	nr_sequencia	= 7269
	and	(nr_seq_apresent IS NOT NULL AND nr_seq_apresent::text <> '')
	and	obter_select_concatenado_bv(' select '|| a.nm_atributo ||' from escala_tev  '
		||'where nr_sequencia = :nr_sequencia ','nr_sequencia='||nr_sequencia_p,'N') = 'S'
	and	ie_padrao_w in ('HSL','ALT')
	
union all

	SELECT	ds_label
	from	tabela_visao_atributo a
	where	nr_sequencia	= 7447
	and	(nr_seq_apresent IS NOT NULL AND nr_seq_apresent::text <> '')
	and	obter_select_concatenado_bv(' select '|| a.nm_atributo ||' from escala_tev  '
		||'where nr_sequencia = :nr_sequencia ','nr_sequencia='||nr_sequencia_p,'N') = 'S'
	and     ie_padrao_w = 'D'
	order by 1;


C01 CURSOR FOR
	SELECT	ds_label
	from	tabela_visao_atributo a
	where	nr_sequencia	= 7265
	and	(nr_seq_apresent IS NOT NULL AND nr_seq_apresent::text <> '')
	and	obter_select_concatenado_bv(' select '|| a.nm_atributo ||' from escala_tev  '
		||'where nr_sequencia = :nr_sequencia ','nr_sequencia='||nr_sequencia_p,'N') = 'S'
	and	ie_padrao_w in ('HSL','ALT')
	
union all

	SELECT	ds_label
	from	tabela_visao_atributo a
	where	nr_sequencia	= 7328
	and	(nr_seq_apresent IS NOT NULL AND nr_seq_apresent::text <> '')
	and	obter_select_concatenado_bv(' select '|| a.nm_atributo ||' from escala_tev  '
		||'where nr_sequencia = :nr_sequencia ','nr_sequencia='||nr_sequencia_p,'N') = 'S'
	and     ie_padrao_w = 'D'
	order by 1;


c02 CURSOR FOR
	SELECT	ds_label,
		nr_seq_apresent,
		nm_atributo
	from	tabela_visao_atributo a
	where	nr_sequencia	= 6927
	and	(nr_seq_apresent IS NOT NULL AND nr_seq_apresent::text <> '')
	and	obter_select_concatenado_bv(' select '|| a.nm_atributo ||' from escala_tev  '
		||'where nr_sequencia = :nr_sequencia ','nr_sequencia='||nr_sequencia_p,'N') = 'S'
	and          ie_padrao_w in ('HSL','ALT')
	
union all

	SELECT	ds_label,
		nr_seq_apresent,
		nm_atributo
	from	tabela_visao_atributo a
	where	((nr_sequencia	= 7326 and ie_padrao_heparina_w = 'N') or (nr_sequencia	= 23167 and ie_padrao_heparina_w = 'S'))
	and	(nr_seq_apresent IS NOT NULL AND nr_seq_apresent::text <> '')
	and	obter_select_concatenado_bv(' select '|| a.nm_atributo ||' from escala_tev  '
		||'where nr_sequencia = :nr_sequencia ','nr_sequencia='||nr_sequencia_p,'N') = 'S'
	and     ie_padrao_w = 'D'
	order by 2,1;

c03 CURSOR FOR
	SELECT	ds_label
	from	tabela_visao_atributo a
	where	nr_sequencia	= 7301
	and	(nr_seq_apresent IS NOT NULL AND nr_seq_apresent::text <> '')
	and	obter_select_concatenado_bv(' select '|| a.nm_atributo ||' from escala_tev  '
		||'where nr_sequencia = :nr_sequencia ','nr_sequencia='||nr_sequencia_p,'N') = 'S'
	and          ie_padrao_w in ('HSL','ALT')
	
union all

	SELECT	ds_label
	from	tabela_visao_atributo a
	where	nr_sequencia	= 7301
	and	(nr_seq_apresent IS NOT NULL AND nr_seq_apresent::text <> '')
	and	obter_select_concatenado_bv(' select '|| a.nm_atributo ||' from escala_tev  '
		||'where nr_sequencia = :nr_sequencia ','nr_sequencia='||nr_sequencia_p,'N') = 'S'
	and     ie_padrao_w = 'D'
	order by 1;

C04 CURSOR FOR
	SELECT	TEV_obter_dados_cad(nm_atributo,'3') ds_label,
		nr_seq_apresent,
		nm_atributo,
		TEV_obter_dados_cad(nm_atributo,'2')
	from	tabela_visao_atributo a
	where	nr_sequencia	= 24492
	and	obter_select_concatenado_bv(' select '|| a.nm_atributo ||' from escala_tev  '
		||'where nr_sequencia = :nr_sequencia ','nr_sequencia='||nr_sequencia_p,'N') = 'S'
	and	TEV_obter_dados_cad(nm_atributo,'1') = 'S'
	order by 1;


BEGIN
ie_padrao_w := Obter_Param_Usuario(697, 1, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_padrao_w);
ie_padrao_heparina_w := Obter_Param_Usuario(697, 2, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_padrao_heparina_w);

--Risco cirurgico
open c00;
loop
fetch c00 into
	ds_risco_cirurgico_w;
EXIT WHEN NOT FOUND; /* apply on c00 */
	begin

	if (ds_lista_risco_cirurgico_w IS NOT NULL AND ds_lista_risco_cirurgico_w::text <> '') then
		ds_lista_risco_cirurgico_w := substr(ds_lista_risco_cirurgico_w || ', ',1,2000);
	end if;

	ds_lista_risco_cirurgico_w	:= substr(ds_lista_risco_cirurgico_w || ds_risco_cirurgico_w,1,2000);

	end;
end loop;
close c00;

--Fatores de Risco para TEV
open c01;
loop
fetch c01 into
	ds_fator_risco_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	if (ds_lista_fator_risco_w IS NOT NULL AND ds_lista_fator_risco_w::text <> '') then
		ds_lista_fator_risco_w := substr(ds_lista_fator_risco_w || ', ',1,2000);
	end if;

	ds_lista_fator_risco_w	:= substr(ds_lista_fator_risco_w || ds_fator_risco_w,1,2000);

	end;
end loop;
close c01;

--Contra-indicações ao uso de heparina
select	count(*)
into STRICT	qt_cad_w
from	tev_contraindicacao
where	(ie_tipo_contraindicacao_estab IS NOT NULL AND ie_tipo_contraindicacao_estab::text <> '')
and	coalesce(ie_exibir_estab,ie_exibir) = 'S';

if (qt_cad_w = 0 or ie_padrao_w in ('HSL','ALT'))  then
	open c02;
	loop
	fetch c02 into
		ds_uso_heparina_w,
		nr_seq_apres_w,
		nm_atributo_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		if (ie_padrao_w	in ('HSL','ALT')) then
			if (nm_atributo_w	in ('IE_ANTICOAGULACAO','IE_HIPERSENSIBILIDADE_HEPARINA','IE_PLAQUETOPENIA_HEPARINA','IE_SANGRAMENTO_ULCERA')) then
				if (ds_lista_uso_heparina_abs_w IS NOT NULL AND ds_lista_uso_heparina_abs_w::text <> '') then
					ds_lista_uso_heparina_abs_w := substr(ds_lista_uso_heparina_abs_w || ', ',1,2000);
				end if;
				ds_lista_uso_heparina_abs_w	:= substr(ds_lista_uso_heparina_abs_w || ds_uso_heparina_w,1,2000);
			elsif (nm_atributo_w	= 'IE_NENHUMA_CONTRA_INDIC') then
				ds_lista_uso_heparina_nen_w	:= ds_uso_heparina_w;
			else
				if (ds_lista_uso_heparina_rel_w IS NOT NULL AND ds_lista_uso_heparina_rel_w::text <> '') then
					ds_lista_uso_heparina_rel_w := substr(ds_lista_uso_heparina_rel_w || ', ',1,2000);
				end if;
				ds_lista_uso_heparina_rel_w	:= substr(ds_lista_uso_heparina_rel_w || ds_uso_heparina_w,1,2000);
			end if;

		else
			if (ds_lista_uso_heparina_w IS NOT NULL AND ds_lista_uso_heparina_w::text <> '') then
				ds_lista_uso_heparina_w := substr(ds_lista_uso_heparina_w || ', ',1,2000);
			end if;

			ds_lista_uso_heparina_w	:= substr(ds_lista_uso_heparina_w || ds_uso_heparina_w,1,2000);
		end if;
		end;
	end loop;
	close c02;
else
	open C04;
	loop
	fetch C04 into
		ds_uso_heparina_w,
		nr_seq_apres_w,
		nm_atributo_w,
		nr_seq_cad_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin

		select	max(ie_tipo_contraindicacao_estab),
			max(ds_resposta)
		into STRICT	ie_tipo_w,
			ds_resposta_w
		from	tev_contraindicacao
		where	nr_sequencia = nr_seq_cad_w;

		if (ie_padrao_w	in ('HSL','ALT')) then
			if (nm_atributo_w	in ('IE_ANTICOAGULACAO','IE_HIPERSENSIBILIDADE_HEPARINA','IE_PLAQUETOPENIA_HEPARINA','IE_SANGRAMENTO_ULCERA')) then
				if (ds_lista_uso_heparina_abs_w IS NOT NULL AND ds_lista_uso_heparina_abs_w::text <> '') then
					ds_lista_uso_heparina_abs_w := substr(ds_lista_uso_heparina_abs_w || ', ',1,2000);
				end if;
				ds_lista_uso_heparina_abs_w	:= substr(ds_lista_uso_heparina_abs_w || ds_uso_heparina_w,1,2000);
			elsif (nm_atributo_w	= 'IE_NENHUMA_CONTRA_INDIC') then
				ds_lista_uso_heparina_nen_w	:= ds_uso_heparina_w;
			else
				if (ds_lista_uso_heparina_rel_w IS NOT NULL AND ds_lista_uso_heparina_rel_w::text <> '') then
					ds_lista_uso_heparina_rel_w := substr(ds_lista_uso_heparina_rel_w || ', ',1,2000);
				end if;
				ds_lista_uso_heparina_rel_w	:= substr(ds_lista_uso_heparina_rel_w || ds_uso_heparina_w,1,2000);
			end if;

		else
			if (ds_lista_uso_heparina_w IS NOT NULL AND ds_lista_uso_heparina_w::text <> '') then
				ds_lista_uso_heparina_w := substr(ds_lista_uso_heparina_w || ', ',1,2000);
			end if;

			ds_lista_uso_heparina_w	:= substr(ds_lista_uso_heparina_w || ds_uso_heparina_w,1,2000);
		end if;
		end;
	end loop;
	close C04;
end if;

if (ie_padrao_w	in ('HSL','ALT')) and (ds_lista_uso_heparina_abs_w IS NOT NULL AND ds_lista_uso_heparina_abs_w::text <> '') then
	ds_lista_uso_heparina_w:=	substr(Wheb_mensagem_pck.get_texto(309834) /*'Absolutas:'*/
||chr(13) ||'    '||ds_lista_uso_heparina_abs_w||chr(13),1,2000);
end if;
if (ie_padrao_w	in ('HSL','ALT')) and (ds_lista_uso_heparina_rel_w IS NOT NULL AND ds_lista_uso_heparina_rel_w::text <> '') then
	ds_lista_uso_heparina_w:=	substr(ds_lista_uso_heparina_w||Wheb_mensagem_pck.get_texto(309835) /*'Relativas:'*/
||chr(13) ||'    '||ds_lista_uso_heparina_rel_w||chr(13),1,2000);
end if;

if (ie_padrao_w	in ('HSL','ALT')) and (ds_lista_uso_heparina_nen_w IS NOT NULL AND ds_lista_uso_heparina_nen_w::text <> '') then
	ds_lista_uso_heparina_w:=	substr(ds_lista_uso_heparina_w||ds_lista_uso_heparina_nen_w,1,2000);
end if;

select	count(*)
into STRICT	qt_cad_w
from	tev_contraindicacao
where	(ie_tipo_contraindicacao_estab IS NOT NULL AND ie_tipo_contraindicacao_estab::text <> '')
and	coalesce(ie_exibir_estab,ie_exibir) = 'S';

if (qt_cad_w > 0) and (ie_padrao_w 	not in ('HSL','ALT')) then

	if (ds_lista_uso_heparina_abs_w IS NOT NULL AND ds_lista_uso_heparina_abs_w::text <> '') then
		ds_lista_uso_heparina_w := substr(Wheb_mensagem_pck.get_texto(309834) /*'Absolutas:'*/
||chr(13) ||'    '||ds_lista_uso_heparina_abs_w||chr(13),1,2000);
	end if;
	if (ds_lista_uso_heparina_rel_w IS NOT NULL AND ds_lista_uso_heparina_rel_w::text <> '') then
		ds_lista_uso_heparina_w := substr(ds_lista_uso_heparina_w||Wheb_mensagem_pck.get_texto(309835) /*'Relativas:'*/
||chr(13) ||'    '||ds_lista_uso_heparina_rel_w||chr(13),1,2000);
	end if;
	if (ds_lista_uso_heparina_nen_w IS NOT NULL AND ds_lista_uso_heparina_nen_w::text <> '') then
		ds_lista_uso_heparina_w := substr(ds_lista_uso_heparina_w||ds_lista_uso_heparina_nen_w,1,2000);
	end if;
end if;

--Contra-indicações ao uso de profilaxia mecânica (métodos físicos)
open c03;
loop
fetch c03 into
	ds_profilaxia_mecanica_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	begin

	if (ds_lista_profilaxia_mecanica_w IS NOT NULL AND ds_lista_profilaxia_mecanica_w::text <> '') then
		ds_lista_profilaxia_mecanica_w := substr(ds_lista_profilaxia_mecanica_w || ', ',1,2000);
	end if;

	ds_lista_profilaxia_mecanica_w	:= substr(ds_lista_profilaxia_mecanica_w || ds_profilaxia_mecanica_w,1,2000);

	end;
end loop;
close c03;


titulo_risco_cirurgico_w       := null;
titulo_fator_risco_w		   := null;
titulo_uso_heparina_w		   := null;
titulo_profilaxia_mecanica_w   := null;

if (ds_lista_risco_cirurgico_w IS NOT NULL AND ds_lista_risco_cirurgico_w::text <> '') then
	titulo_risco_cirurgico_w := substr(Wheb_mensagem_pck.get_texto(309837) || ':' /*'Risco cirurgico:'*/|| chr(13) ||ds_lista_risco_cirurgico_w || chr(13) ||chr(13),1,2000);
end if;

if (ds_lista_fator_risco_w IS NOT NULL AND ds_lista_fator_risco_w::text <> '') then
	titulo_fator_risco_w := substr(Wheb_mensagem_pck.get_texto(309838) || ':' /*'Fatores de Risco para TEV:'*/||chr(13)||ds_lista_fator_risco_w || chr(13) ||chr(13),1,2000);
end if;

if (ds_lista_uso_heparina_w IS NOT NULL AND ds_lista_uso_heparina_w::text <> '') then
	--titulo_uso_heparina_w := Wheb_mensagem_pck.get_texto(309840) || ':' /*'Contra-indicações ao uso de heparina:'*/||chr(13) ||ds_lista_uso_heparina_w || chr(13) ||chr(13);
	titulo_uso_heparina_w := substr(Wheb_mensagem_pck.get_texto(326950) || ':' /*'Contra-indicações ao uso de heparina:'*/||chr(13) ||ds_lista_uso_heparina_w || chr(13) ||chr(13),1,2000);
end if;

if (ds_lista_profilaxia_mecanica_w IS NOT NULL AND ds_lista_profilaxia_mecanica_w::text <> '') then
	titulo_profilaxia_mecanica_w := substr(Wheb_mensagem_pck.get_texto(309841) || ':' /*'Contra-indicações ao uso de profilaxia mecânica (métodos físicos):'*/||chr(13) ||ds_lista_profilaxia_mecanica_w,1,2000);
end if;

select	IE_NAO_SE_APLICA,
	nr_seq_motivo_tev
into STRICT	ie_nao_se_aplica_w,
	nr_seq_motivo_w
from	escala_tev
where	nr_sequencia	= nr_sequencia_p;

ds_retorno_w := substr(titulo_risco_cirurgico_w  ||
				titulo_fator_risco_w 	  ||
				titulo_uso_heparina_w 	  ||
				titulo_profilaxia_mecanica_w,1,2000);


if (ie_nao_se_aplica_w	= 'S') then
	ds_retorno_w	:= substr(Wheb_mensagem_pck.get_texto(309842),1,2000); --'O protocolo de profilaxia de TEV não se aplica';
	if (nr_seq_motivo_w IS NOT NULL AND nr_seq_motivo_w::text <> '') then
		select	max(ds_motivo)
		into STRICT	ds_motivo_w
		from	tev_motivo
		where	nr_sequencia	= nr_seq_motivo_w;

		if (ds_motivo_w IS NOT NULL AND ds_motivo_w::text <> '') then
			ds_retorno_w	:= substr(ds_retorno_w||chr(13) ||'    '||Wheb_mensagem_pck.get_texto(309843) || ' ' /*'Motivo: '*/||ds_motivo_w,1,2000);
		end if;
	end if;
end if;


return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_selecao_tev ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

