-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_proximo_evento_fanep ( nr_seq_pepo_p bigint) RETURNS bigint AS $body$
DECLARE


nr_seq_exec_max_registrado_w	bigint;
nr_seq_exec_min_disponivel_w	bigint;
nr_sequencia_proximo_evento_w	bigint;
cd_perfil_ativo_w				integer;
cd_estabelecimento_w			bigint := wheb_usuario_pck.get_cd_estabelecimento;

					

BEGIN
cd_perfil_ativo_w := wheb_usuario_pck.get_cd_perfil;

select	max(a.nr_seq_execucao)
into STRICT	nr_seq_exec_max_registrado_w
from	evento_cirurgia a,
	evento_cirurgia_paciente b
where	b.nr_seq_evento = a.nr_sequencia
and	b.nr_seq_pepo 	= nr_seq_pepo_p
and	coalesce(b.ie_situacao,'A') = 'A';

select	min(nr_seq_execucao)
into STRICT	nr_seq_exec_min_disponivel_w
from	evento_cirurgia
where	substr(obter_se_mostra_evento(null,nr_seq_pepo_p,nr_sequencia, cd_perfil_ativo_w),1,1) = 'S'
and	ie_situacao = 'A'
and 	coalesce(ie_exibicao, 'A') IN ('A', 'F')
and	((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
and (coalesce(nr_seq_exec_max_registrado_w::text, '') = '' or nr_seq_execucao > nr_seq_exec_max_registrado_w);
	
if (nr_seq_exec_min_disponivel_w IS NOT NULL AND nr_seq_exec_min_disponivel_w::text <> '') then
	select	max(a.nr_sequencia)
	into STRICT	nr_sequencia_proximo_evento_w
	from	evento_cirurgia a
	where	a.nr_seq_execucao = nr_seq_exec_min_disponivel_w
	and 	coalesce(ie_exibicao, 'A') IN ('A', 'F');
end if;

return coalesce(nr_sequencia_proximo_evento_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_proximo_evento_fanep ( nr_seq_pepo_p bigint) FROM PUBLIC;

