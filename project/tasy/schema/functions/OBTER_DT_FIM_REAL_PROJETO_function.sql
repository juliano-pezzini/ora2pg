-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dt_fim_real_projeto (nr_seq_proj_p bigint) RETURNS timestamp AS $body$
DECLARE


data_fim_real_w	timestamp;
dt_max_fim_real_w	timestamp;
dt_min_fim_real_w	timestamp;
nr_seq_w	double precision;


BEGIN

select	min(c.dt_fim_real),
		min(c.nr_sequencia)
into STRICT	dt_min_fim_real_w,
		nr_seq_w
from    proj_projeto p,
		proj_cronograma c
where   p.nr_sequencia = c.nr_seq_proj
and     c.ie_situacao  = 'A'
and 	p.nr_sequencia = nr_seq_proj_p
and 	coalesce(c.dt_fim_real::text, '') = '';


if (coalesce(dt_min_fim_real_w::text, '') = '' and (nr_seq_w IS NOT NULL AND nr_seq_w::text <> ''))then
	data_fim_real_w := dt_min_fim_real_w;
else
	select 	 max(c.dt_fim_real)
	into STRICT	 dt_max_fim_real_w
	from     proj_projeto p,
			 proj_cronograma c,
			 proj_cron_etapa e
	where    p.nr_sequencia = c.nr_seq_proj
	and      c.nr_sequencia = e.nr_seq_cronograma
	and      c.ie_situacao  = 'A'
	and  	 not exists (SELECT 1 from proj_cron_etapa xx where xx.nr_seq_superior =  e.nr_sequencia)
	and 	 p.nr_sequencia = nr_seq_proj_p;

	data_fim_real_w := dt_max_fim_real_w;
end if;

return	data_fim_real_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dt_fim_real_projeto (nr_seq_proj_p bigint) FROM PUBLIC;

