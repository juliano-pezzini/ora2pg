-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_gerar_nut_reserv_p ( nr_seq_servico_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_fisica_p text, nr_seq_restaurante_p bigint) RETURNS varchar AS $body$
DECLARE



nr_seq_perfil_pf_w	bigint;
qt_reserva_w		integer;
ie_perfil_nut_w		varchar(1);
ds_perfil_w		varchar(80);
ie_retorna_w		varchar(1)  := 'N';


ds_retorno_w		varchar(255) := '';


c01 CURSOR FOR
	SELECT	coalesce( obter_se_perfil_nut_liberado(nr_seq_perfil_pf_w, nr_sequencia) , '')
	from	nut_reserva
	where	nr_seq_servico = nr_seq_servico_p
	and	((nr_seq_restaurante = nr_seq_restaurante_p) or (nr_seq_restaurante_p = 0))
	and	dt_servico between dt_inicial_p and fim_dia(dt_final_p)
	and	to_date(to_char(dt_servico,'dd/mm/yyyy') || ' ' || to_char(hr_inicio,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') > (clock_timestamp() + (coalesce(qt_min_antecedencia,0) / 1440))
	and	nr_sequencia not in (	SELECT	nr_seq_nut_reserva
					from	nut_reserva_pf
					where	cd_pessoa_fisica = cd_pessoa_fisica_p);



BEGIN


if (nr_seq_servico_p IS NOT NULL AND nr_seq_servico_p::text <> '') and (dt_inicial_p IS NOT NULL AND dt_inicial_p::text <> '') and (dt_final_p IS NOT NULL AND dt_final_p::text <> '') and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then


	select	coalesce(nr_seq_nut_perfil, 0)
	into STRICT	nr_seq_perfil_pf_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;



	if (nr_seq_perfil_pf_w > 0) then

		select	ds_perfil
		into STRICT	ds_perfil_w
		from	nut_perfil
		where 	nr_sequencia	= nr_seq_perfil_pf_w;

		ds_retorno_w := ds_retorno_w|| ' ' || substr(obter_texto_tasy(1040112, wheb_usuario_pck.get_nr_seq_idioma),1,255)|| ' ' ||ds_perfil_w|| ' ' || substr(obter_texto_tasy(1040113, wheb_usuario_pck.get_nr_seq_idioma),1,255)||chr(10);

	else

		ds_retorno_w := ds_retorno_w|| ' ' || substr(obter_texto_tasy(1040114, wheb_usuario_pck.get_nr_seq_idioma),1,255)|| chr(10) || ' ';

	end if;


	open c01;
	loop
	fetch c01 into
		ie_perfil_nut_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		if (ie_perfil_nut_w = 'N') then

			ie_retorna_w := 'S';

		end if;

		end;
	end loop;
	close c01;


	if (ie_retorna_w = 'N') then
		ds_retorno_w := '';
	end if;


end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_gerar_nut_reserv_p ( nr_seq_servico_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_fisica_p text, nr_seq_restaurante_p bigint) FROM PUBLIC;

