-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_infect_detail (cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type) RETURNS varchar AS $body$
DECLARE


ds_infection_w	varchar(1000);
ds_retorno_w		varchar(32000);
ds_tipo_infeccao_w tipo_infeccao.ds_tipo_infeccao%type;
ds_cd_doenca_w cid_doenca.ds_doenca_cid%type;
ds_tem_investigacao_w historico_infeccao.ds_item_investigacao%type;
ds_infecction_result_w infection_result.ds_infecction_result%type;

C01 CURSOR FOR
SELECT (select ds_tipo_infeccao from tipo_infeccao tp where tp.nr_sequencia=a.cd_tipo_infeccao),
obter_desc_cid_doenca(cd_doenca),
ds_item_investigacao,
(select  ds_infecction_result from infection_result where nr_sequencia=cd_result_infec)
from historico_infeccao  a
where cd_pessoa_fisica =cd_pessoa_fisica_p
and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and ie_situacao <>'I'
and (a.dt_fim >= clock_timestamp()  or coalesce(a.dt_fim::text, '') = '')
;



BEGIN


open c01;
loop
fetch c01 into
		ds_tipo_infeccao_w,ds_cd_doenca_w,ds_tem_investigacao_w,ds_infecction_result_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
    ds_infection_w:=null;
    if (ds_tipo_infeccao_w IS NOT NULL AND ds_tipo_infeccao_w::text <> '')then
    ds_infection_w:=obter_desc_expressao(299644)||': '||ds_tipo_infeccao_w||' ';
    end if;
    if (ds_cd_doenca_w IS NOT NULL AND ds_cd_doenca_w::text <> '') then
    ds_infection_w:=ds_infection_w||obter_desc_expressao(284902)||': '||ds_cd_doenca_w||' ';
    end if;
    if (ds_infecction_result_w IS NOT NULL AND ds_infecction_result_w::text <> '') then
    ds_infection_w:=ds_infection_w||obter_desc_expressao(644057)||': '||ds_infecction_result_w||' ';
    end if;
    if (ds_tem_investigacao_w IS NOT NULL AND ds_tem_investigacao_w::text <> '') then
    ds_infection_w:=ds_infection_w||obter_desc_expressao(1041752)||': '||ds_tem_investigacao_w;
    end if;

	if (coalesce(ds_retorno_w::text, '') = '') then
		ds_retorno_w := ds_infection_w;
	else
		ds_retorno_w := ds_retorno_w || ', ' || ds_infection_w;
	end if;
	end;
end loop;
close c01;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_infect_detail (cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type) FROM PUBLIC;

