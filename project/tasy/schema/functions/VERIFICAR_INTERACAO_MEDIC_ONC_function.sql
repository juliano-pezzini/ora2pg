-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function verificar_interacao_medic_onc as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE FUNCTION verificar_interacao_medic_onc ( nr_seq_paciente_p bigint, cd_material_p bigint default null) RETURNS varchar AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

	v_ret	varchar;
BEGIN
	v_query := 'SELECT * FROM verificar_interacao_medic_onc_atx ( ' || quote_nullable(nr_seq_paciente_p) || ',' || quote_nullable(cd_material_p) || ' )';
	SELECT * INTO v_ret FROM dblink(v_conn_str, v_query) AS p (ret varchar);
	RETURN v_ret;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE FUNCTION verificar_interacao_medic_onc_atx ( nr_seq_paciente_p bigint, cd_material_p bigint default null) RETURNS varchar AS $body$
DECLARE


cd_material_w		integer;
ds_retorno_w		varchar(4000) := '';
ds_material_w		varchar(100);
ds_material_ww		varchar(100);
ds_interacao_w		varchar(4000) := '';
ds_principio_ativo_w	varchar(100);
ds_tipo_w		varchar(255);
ds_severidade_w		varchar(254);
nr_seq_ficha_tecnica_w	bigint;
cd_material_interacao_w	integer;
ie_severidade_w		varchar(15);
ie_consistir_w		varchar(15);
ie_gravar_w		varchar(1);
ds_orientacao_w		varchar(2000);
ds_orient_w		varchar(2000);
nr_sequencia_w		bigint;
nr_seq_medic_w		bigint;
qt_dependente_w		bigint;
ie_medicamentos_w	varchar(10);
nm_usuario_w	varchar(15);
cd_pessoa_fisica_w	varchar(10);
nr_atendimento_w	bigint;C01 CURSOR FOR
SELECT	distinct b.cd_material,
	substr(c.ds_material,1,100),
	c.nr_seq_ficha_tecnica,
	b.nr_seq_material
from	material c,
	paciente_protocolo_medic b,
	paciente_setor a
where	coalesce(cd_material_p::text, '') = ''
and	a.nr_seq_paciente	= nr_seq_paciente_p
and	a.nr_seq_paciente	= b.nr_seq_paciente
and	b.cd_material		= c.cd_material

union

select	distinct b.cd_material,
		substr(c.ds_material,1,100),
		c.nr_seq_ficha_tecnica,
		0 nr_seq_material
from	material c,
		paciente_medic_uso b
where	coalesce(cd_material_p::text, '') = ''
and		b.cd_material		= c.cd_material
and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
and		coalesce(b.dt_inativacao::text, '') = ''
and		coalesce(b.dt_fim::text, '') = ''
and		coalesce(ie_medicamentos_w,'N') in ('PM','SM')

union

select	distinct c.cd_material,
	substr(c.ds_material,1,100),
	c.nr_seq_ficha_tecnica,
	0 nr_seq_material
from	material c
where	(cd_material_p IS NOT NULL AND cd_material_p::text <> '')
and	c.cd_material	=	cd_material_p;

C02 CURSOR FOR
SELECT	distinct substr(obter_desc_material(b.cd_material),1,100),
	ds_tipo,
	substr(Obter_Valor_Dominio(1325, ie_severidade),1,254),
	ie_severidade,
	a.cd_material_interacao,
	coalesce(a.ie_consistir,'P'),
	a.ds_orientacao,
	a.ie_gravar,
	substr(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo
from	material_interacao_medic a,
		paciente_medic_uso b
where	a.cd_material		= b.cd_material
and		a.cd_material_interacao	= cd_material_w
and		CASE WHEN coalesce(nr_atendimento::text, '') = '' THEN b.cd_pessoa_fisica  ELSE obter_pessoa_atendimento(b.nr_atendimento,'C') END  = cd_pessoa_fisica_w
and		coalesce(ie_medicamentos_w,'N') in ('PM','SM')
and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
and		coalesce(b.dt_inativacao::text, '') = ''
and		coalesce(b.dt_fim::text, '') = ''

union

select	distinct substr(obter_desc_material(b.cd_material),1,100),
	ds_tipo,
	substr(Obter_Valor_Dominio(1325, ie_severidade),1,254),
	ie_severidade,
	a.cd_material_interacao,
	coalesce(a.ie_consistir,'P'),
	a.ds_orientacao,
	a.ie_gravar,
	substr(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo
from	material_interacao_medic a,
		paciente_medic_uso b
where	a.cd_material_interacao	= b.cd_material
and		a.cd_material = cd_material_w
and		coalesce(ie_medicamentos_w,'N') in ('PM','SM')
and		CASE WHEN coalesce(nr_atendimento::text, '') = '' THEN b.cd_pessoa_fisica  ELSE obter_pessoa_atendimento(b.nr_atendimento,'C') END  = cd_pessoa_fisica_w
and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
and		coalesce(b.dt_inativacao::text, '') = ''
and		coalesce(b.dt_fim::text, '') = ''

union

select	distinct substr(obter_desc_material(a.cd_material_interacao),1,100),
	ds_tipo,
	substr(Obter_Valor_Dominio(1325, ie_severidade),1,254),
	ie_severidade,
	a.cd_material_interacao,
	coalesce(a.ie_consistir,'P'),
	a.ds_orientacao,
	a.ie_gravar,
	substr(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo
from	material_interacao_medic a,
	paciente_protocolo_medic b,
	paciente_setor k
where	a.cd_material		= cd_material_w
and	a.cd_material_interacao	= b.cd_material
and	k.nr_seq_paciente 	= nr_seq_paciente_p
and	k.nr_seq_paciente	= b.nr_seq_paciente

union

select	distinct substr(obter_desc_material(b.cd_material),1,100),
	ds_tipo,
	substr(Obter_Valor_Dominio(1325, ie_severidade),1,254),
	ie_severidade,
	a.cd_material_interacao,
	coalesce(a.ie_consistir,'P'),
	a.ds_orientacao,
	a.ie_gravar,
	substr(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo
from	material_interacao_medic a,
	paciente_protocolo_medic b,
	paciente_setor k
where	a.cd_material		= b.cd_material
and		a.cd_material_interacao	= cd_material_w
and	k.nr_seq_paciente 	= nr_seq_paciente_p
and	coalesce(ie_medicamentos_w,'N') in ('PM','SM')
and	k.nr_seq_paciente	= b.nr_seq_paciente

union

select	distinct substr(obter_desc_material(a.cd_material_interacao),1,100),
	ds_tipo,
	substr(Obter_Valor_Dominio(1325, ie_severidade),1,254),
	ie_severidade,
	a.cd_material_interacao,
	coalesce(a.ie_consistir,'P'),
	a.ds_orientacao,
	a.ie_gravar,
	substr(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo
from	material_interacao_medic a,
	paciente_protocolo_medic b,
	paciente_setor k
where	a.cd_material		= b.cd_material
and		a.cd_material_interacao	= cd_material_w
and	k.nr_seq_paciente 	= nr_seq_paciente_p
and	coalesce(ie_medicamentos_w,'N') in ('PM','SM')
and	k.nr_seq_paciente	= b.nr_seq_paciente

union

select	distinct substr(obter_desc_material(b.cd_material),1,100),
	ds_tipo,
	substr(obter_valor_dominio(1325, ie_severidade),1,254),
	ie_severidade,
	b.cd_material,
	coalesce(a.ie_consistir,'P'),
	a.ds_orientacao,
	a.ie_gravar,
	substr(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo
from	material x,
	material_interacao_medic a,
	paciente_protocolo_medic b,
	paciente_setor k
where	k.nr_seq_paciente = nr_seq_paciente_p
and	k.nr_seq_paciente = b.nr_seq_paciente
and	b.cd_material	= x.cd_material
and	a.nr_seq_ficha_interacao = nr_seq_ficha_tecnica_w
and	a.nr_seq_ficha	= x.nr_seq_ficha_tecnica;


BEGIN
nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

Select 	cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from	PACIENTE_SETOR
where 	nr_seq_paciente = nr_seq_paciente_p;

ie_medicamentos_w  := obter_param_usuario(281, 973, obter_perfil_ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento, ie_medicamentos_w );

open C01;
loop
	fetch C01 into
		cd_material_w,
		ds_material_ww,
		nr_seq_ficha_tecnica_w,
		nr_seq_medic_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_interacao_w	:= '';
	ds_orientacao_w	:= '';
	open C02;
	loop
		fetch C02 into
			ds_material_w,
			ds_tipo_w,
			ds_severidade_w,
			ie_severidade_w,
			cd_material_interacao_w,
			ie_consistir_w,
			ds_orient_w,
			ie_gravar_w,
			ds_principio_ativo_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		if (ie_gravar_w = 'S') then
			ds_orientacao_w	:= ds_orient_w;
		end if;

		if (coalesce(length(ds_interacao_w),0) < 3000) then
			begin
			if (coalesce(ds_interacao_w::text, '') = '') then
				ds_interacao_w := Wheb_mensagem_pck.get_texto(306005, 'DS_MATERIAL_A='||ds_material_ww||';DS_MATERIAL_B='||ds_material_w);
			else
				ds_interacao_w := ds_interacao_w  || chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(306005, 'DS_MATERIAL_A='||ds_material_ww||';DS_MATERIAL_B='||ds_material_w);
			end if;

			if (ds_tipo_w IS NOT NULL AND ds_tipo_w::text <> '') then
				ds_interacao_w := ds_interacao_w  || ' ' || Wheb_mensagem_pck.get_texto(305995) || ' ' || ds_tipo_w;
			end if;
			if (ds_severidade_w IS NOT NULL AND ds_severidade_w::text <> '') then
				ds_interacao_w := ds_interacao_w  || '. '||chr(13)||chr(10)|| Wheb_mensagem_pck.get_texto(306029) || ' ' || ds_severidade_w;
			end if;
			if (ds_principio_ativo_w IS NOT NULL AND ds_principio_ativo_w::text <> '') then
				ds_interacao_w := ds_interacao_w || '. '||chr(13)||chr(10)|| Wheb_mensagem_pck.get_texto(306016) || ' ' || ds_principio_ativo_w;
			end if;
			ds_interacao_w := ds_interacao_w || chr(13) || chr(10);
			end;
		end if;
		end;
	end loop;
	close C02;

	if (ds_orientacao_w IS NOT NULL AND ds_orientacao_w::text <> '') and (coalesce(nr_seq_medic_w,0) > 0) then
		update	paciente_protocolo_medic
		set	ds_observacao	= ds_observacao || '  ' || ds_orientacao_w
		where	nr_seq_paciente	= nr_seq_paciente_p
		and	nr_seq_material	= nr_seq_medic_w;
	end if;

	if (ds_interacao_w IS NOT NULL AND ds_interacao_w::text <> '') and (coalesce(length(ds_retorno_w),0) < 4000) then
		if (coalesce(ds_retorno_w::text, '') = '') then
			ds_retorno_w := substr(ds_interacao_w,1,4000);
		else
			ds_retorno_w := substr(ds_retorno_w ||chr(13) || chr(10) ||ds_interacao_w,1,4000);
		end if;
	end if;
	end;
end loop;
close C01;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION verificar_interacao_medic_onc ( nr_seq_paciente_p bigint, cd_material_p bigint default null) FROM PUBLIC; -- REVOKE ALL ON FUNCTION verificar_interacao_medic_onc_atx ( nr_seq_paciente_p bigint, cd_material_p bigint default null) FROM PUBLIC;

