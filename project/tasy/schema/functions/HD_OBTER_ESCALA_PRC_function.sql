-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hd_obter_escala_prc ( cd_pessoa_fisica_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

-- C - Codigo

-- D - Descricao

-- DI - Data

-- G - Descricao(Recepcao)
nr_seq_escala_w		bigint;
nr_seq_escala_ww		bigint;
ds_retorno_w		varchar(200);
dt_inicio_w		timestamp;
ie_dias_escala_w		varchar(1);
ds_escala_retorno_w	varchar(255) := '';
ds_escala_retorno_ww	varchar(255) := '';
ie_dia_semana_w		varchar(2);


c01 CURSOR FOR
	SELECT	distinct substr(obter_valor_dominio(2766,d.IE_DIA_SEMANA),1,255),
		ie_dia_semana
	from	hd_escala_dialise a,
		hd_escala_dialise_dia d
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	d.dt_inicio_escala_dia <= clock_timestamp()	
	and	a.nr_sequencia = d.nr_seq_escala
	and	coalesce(d.dt_fim_escala_dia::text, '') = ''
	and	coalesce(a.dt_fim::text, '') = ''
	order by 2;
	
C02 CURSOR FOR
	SELECT	nr_seq_escala
	from	hd_escala_dialise
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	dt_inicio <= clock_timestamp()
	and	coalesce(dt_fim::text, '') = '';	


BEGIN

ie_dias_escala_w := Obter_Param_Usuario(7009, 114, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_dias_escala_w);

if (ie_dias_escala_w = 'N') and (ie_opcao_p = 'G') then

	open C01;
	loop
	fetch C01 into
		ds_retorno_w,
		ie_dia_semana_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin										
		ds_escala_retorno_w := substr(ds_escala_retorno_w ||' - '|| ds_retorno_w,1,255);				
		end;
	end loop;
	close C01;
	ds_escala_retorno_w := substr(ds_escala_retorno_w,4,255);
else
			
	select	max(nr_seq_escala),
		max(dt_inicio)
		into STRICT	nr_seq_escala_w,
		dt_inicio_w
	from	hd_escala_dialise
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	dt_inicio <= clock_timestamp()
	and	coalesce(dt_fim::text, '') = '';
		
		
	if (ie_opcao_p = 'C') then
		ds_escala_retorno_w	:= nr_seq_escala_w;
	elsif (ie_opcao_p = 'D') or
		(ie_opcao_p = 'G' AND ie_dias_escala_w = 'S') then
		begin
		
		open C02;
		loop
		fetch C02 into	
			nr_seq_escala_ww;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			
			select	substr(ds_escala,1,200)
			into STRICT	ds_escala_retorno_ww
			from	hd_escala
			where	nr_sequencia	= nr_seq_escala_ww;
			
			ds_escala_retorno_w := substr(ds_escala_retorno_w||' - '||ds_escala_retorno_ww,1,255);
			
			end;
		end loop;
		close C02;
		
		end;
		
	elsif (ie_opcao_p = 'DI') then
			ds_escala_retorno_w	:= substr(to_char(dt_inicio_w,'dd/mm/yyyy'),1,255);
		else
			ds_escala_retorno_w	:= '';
		end if;
		
	end if;

return ds_escala_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hd_obter_escala_prc ( cd_pessoa_fisica_p text, ie_opcao_p text) FROM PUBLIC;

