-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valores_procmat_audit ( nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, ie_acao_p bigint) RETURNS bigint AS $body$
DECLARE

vl_retorno_w	double precision	:= 0;
vl_acao_w	double precision	:= 0;
ie_acao_w	smallint;

C01 CURSOR FOR
	SELECT	coalesce(b.vl_glosa,0)
	from	convenio_retorno_item a,
		convenio_retorno_glosa b,
		conta_paciente_ret_hist c,
		hist_audit_conta_paciente d
	where	a.nr_sequencia		= b.nr_seq_ret_item
	  and	b.nr_seq_conpaci_ret_hist	= c.nr_sequencia
	  and	c.nr_seq_hist_audit		= d.nr_sequencia
	  and	b.nr_seq_propaci		= nr_seq_propaci_p
	  and	d.ie_acao			= ie_acao_p
	
union

	SELECT	coalesce(b.vl_glosa,0)
	from	convenio_retorno_item a,
		convenio_retorno_glosa b,
		conta_paciente_ret_hist c,
		hist_audit_conta_paciente d
	where	a.nr_sequencia		= b.nr_seq_ret_item
	  and	b.nr_seq_conpaci_ret_hist	= c.nr_sequencia
	  and	c.nr_seq_hist_audit		= d.nr_sequencia
	  and	b.nr_seq_matpaci		= nr_seq_matpaci_p
    	  and	d.ie_acao			= ie_acao_p;


BEGIN

open c01;
loop
fetch C01 into
	vl_acao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	vl_retorno_w	:= vl_retorno_w + vl_acao_w;
end loop;
close c01;

return	coalesce(vl_retorno_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valores_procmat_audit ( nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, ie_acao_p bigint) FROM PUBLIC;

