-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION val_highlight_flowsheet ( nr_atendimento_p atend_timeline_highlight.nr_atendimento%type, dt_inicio_p atend_timeline_highlight.dt_inicio%type, dt_fim_p atend_timeline_highlight.dt_fim%type, nr_sequencia_p atend_timeline_highlight.nr_sequencia%type default null) RETURNS varchar AS $body$
DECLARE


qt_niveis_inicio_w 	atend_timeline_highlight.nr_sequencia%type;
qt_niveis_fim_w 	atend_timeline_highlight.nr_sequencia%type;
ie_return 			atend_timeline_highlight.ie_situacao%type;

dt_inicio_w timestamp;
dt_fim_w timestamp;

  x RECORD;

BEGIN

ie_return := 'S';

dt_inicio_w := TRUNC(dt_inicio_p, 'MI');
dt_fim_w := TRUNC(dt_fim_p, 'MI');

select count(*)
  into STRICT qt_niveis_inicio_w
  from atend_timeline_highlight
 where ie_situacao = 'A'
   and nr_atendimento = nr_atendimento_p
   and dt_inicio_p + (1/24/60) between TRUNC(dt_inicio, 'MI') and TRUNC(dt_fim, 'MI')
   and (coalesce(nr_sequencia_p::text, '') = '' OR nr_sequencia_p <> nr_sequencia);

if (qt_niveis_inicio_w > 1) then
	ie_return := 'N';
end if;

select count(*)
  into STRICT qt_niveis_fim_w
  from atend_timeline_highlight
 where ie_situacao = 'A'
   and nr_atendimento = nr_atendimento_p
   and dt_fim_p between TRUNC(dt_inicio, 'MI') and TRUNC(dt_fim, 'MI')
   and (coalesce(nr_sequencia_p::text, '') = '' OR nr_sequencia_p <> nr_sequencia);

if (qt_niveis_fim_w > 1) then
	ie_return := 'N';
end if;

for x in (
	select nr_sequencia, TRUNC(dt_inicio, 'MI') dt_inicio, TRUNC(dt_fim, 'MI') dt_fim, ds_cor
	 from atend_timeline_highlight
	where ie_situacao = 'A'
	  and nr_atendimento = nr_atendimento_p
	  and (dt_inicio_p + (1/24/60) between TRUNC(dt_inicio, 'MI') and TRUNC(dt_fim, 'MI') or
		   dt_fim_p between TRUNC(dt_inicio, 'MI') and TRUNC(dt_fim, 'MI'))
      and (coalesce(nr_sequencia_p::text, '') = '' OR nr_sequencia_p <> nr_sequencia)
) loop
	if (x.dt_inicio >= dt_inicio_p) then

		select count(*)
		  into STRICT qt_niveis_inicio_w
		  from atend_timeline_highlight
		 where ie_situacao = 'A'
		   and nr_atendimento = nr_atendimento_p
		   and x.dt_inicio + (1/24/60) between TRUNC(dt_inicio, 'MI') and TRUNC(dt_fim, 'MI')
		   and x.nr_sequencia <> nr_sequencia
           and (coalesce(nr_sequencia_p::text, '') = '' OR nr_sequencia_p <> nr_sequencia);

		if (qt_niveis_inicio_w > 0) then
			ie_return := 'N';
		end if;

	end if;

	if (x.dt_fim <= dt_fim_p) then

		select count(*)
		  into STRICT qt_niveis_fim_w
		  from atend_timeline_highlight
		 where ie_situacao = 'A'
		   and nr_atendimento = nr_atendimento_p
		   and x.dt_fim between TRUNC(dt_inicio, 'MI') and TRUNC(dt_fim, 'MI')
		   and x.nr_sequencia <> nr_sequencia
           and (coalesce(nr_sequencia_p::text, '') = '' OR nr_sequencia_p <> nr_sequencia);

		if (qt_niveis_fim_w > 0) then
			ie_return := 'N';
		end if;

	end if;
end loop;

return ie_return;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION val_highlight_flowsheet ( nr_atendimento_p atend_timeline_highlight.nr_atendimento%type, dt_inicio_p atend_timeline_highlight.dt_inicio%type, dt_fim_p atend_timeline_highlight.dt_fim%type, nr_sequencia_p atend_timeline_highlight.nr_sequencia%type default null) FROM PUBLIC;

