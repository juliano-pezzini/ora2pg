-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_material_bloqueio_inv (cd_estabelecimento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, nr_seq_inventario_p bigint default null) RETURNS varchar AS $body$
DECLARE


ie_bloqueio_w			            saldo_estoque.ie_bloqueio_inventario%type;
ie_bloqueio_proprio_w               saldo_estoque.ie_bloqueio_inventario%type;
ie_bloqueio_consignado_w            fornecedor_mat_consignado.ie_bloqueio_inventario%type;
cd_material_estoque_w		        material.cd_material_estoque%type;
dt_mesano_vigente_w		            parametro_estoque.dt_mesano_vigente%type;
dt_mesano_referencia_w		        saldo_estoque.dt_mesano_referencia%type;
ie_saldo_ambos_w                    varchar(1);
ie_existe_inventario_w			    bigint;
ie_tipo_inventario_atual_w          inventario.ie_consignado%type;
ie_permite_inventarios_local_w      varchar(1);


BEGIN

ie_saldo_ambos_w := Obter_Param_Usuario(143, 388, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_saldo_ambos_w);
ie_permite_inventarios_local_w := Obter_Param_Usuario(143, 390, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_permite_inventarios_local_w);

select	max(dt_mesano_vigente)
into STRICT	dt_mesano_vigente_w
from 	parametro_estoque
where	cd_estabelecimento	= cd_estabelecimento_p;

select	cd_material_estoque
into STRICT 	cd_material_estoque_w
from 	material
where 	cd_material = cd_material_p;

select	coalesce(max(s.dt_mesano_referencia),PKG_DATE_UTILS.START_OF(clock_timestamp(), 'month'))
into STRICT	dt_mesano_referencia_w
from 	saldo_estoque s
where	s.cd_estabelecimento	= cd_estabelecimento_p
and	s.cd_material		= cd_material_estoque_w
and	s.dt_mesano_referencia	>= dt_mesano_vigente_w
and	((cd_local_estoque_p = 0) or (s.cd_local_estoque = cd_local_estoque_p));

if (ie_saldo_ambos_w = 'N' and 
   ie_permite_inventarios_local_w = 'S' and 
   obter_se_mat_consignado(cd_material_p) = '2') then
    
    select coalesce(max(a.ie_consignado), 'N')
      into STRICT ie_tipo_inventario_atual_w 
      from inventario a
     where a.nr_sequencia = nr_seq_inventario_p;

    --verifica se ha outro inventario bloqueado para o mesmo material (consignado ou proprio)
    select count(*)
      into STRICT ie_existe_inventario_w
      from	inventario a,
            inventario_material b
     where	a.nr_sequencia = b.nr_seq_inventario
       and	(a.dt_bloqueio IS NOT NULL AND a.dt_bloqueio::text <> '')
       and	a.nr_sequencia <> nr_seq_inventario_p
       and  a.ie_consignado = ie_tipo_inventario_atual_w
       and  b.cd_material = cd_material_p
       and	coalesce(a.dt_atualizacao_saldo::text, '') = '';

    if (ie_existe_inventario_w = 0) then
        ie_bloqueio_w := 'N';
    else
        ie_bloqueio_w := 'S';
    end if;
else
    select	coalesce(max(a.ie_bloqueio_inventario),'N')
    into STRICT	ie_bloqueio_proprio_w
    from	saldo_estoque a
    where	a.cd_estabelecimento	= cd_estabelecimento_p
    and 	a.cd_material		= cd_material_estoque_w
    and	((cd_local_estoque_p = 0) or (a.cd_local_estoque = cd_local_estoque_p))
    and 	a.dt_mesano_referencia	= dt_mesano_referencia_w;

    select	coalesce(max(a.ie_bloqueio_inventario),'N')
    into STRICT	ie_bloqueio_consignado_w
    from	fornecedor_mat_consignado a
    where	a.cd_estabelecimento	= cd_estabelecimento_p
    and 	a.cd_material		= cd_material_estoque_w
    and	((cd_local_estoque_p = 0) or (a.cd_local_estoque = cd_local_estoque_p))
    and 	a.dt_mesano_referencia	= dt_mesano_referencia_w;

    if (ie_bloqueio_proprio_w = 'S' or ie_bloqueio_consignado_w = 'S') then
        ie_bloqueio_w := 'S';
    else
        ie_bloqueio_w := 'N';
    end if;
end if;

return ie_bloqueio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_material_bloqueio_inv (cd_estabelecimento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, nr_seq_inventario_p bigint default null) FROM PUBLIC;

