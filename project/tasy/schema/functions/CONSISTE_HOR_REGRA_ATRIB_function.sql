-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_hor_regra_atrib (hr_inicio_p timestamp, hr_fim_p timestamp,ie_dia_semana_p text) RETURNS varchar AS $body$
DECLARE


ie_retorno_w	varchar(1) := 'N';

dt_inicio_w	timestamp;
dt_fim_w	timestamp;
dt_atual_w	timestamp;

hr_inicio_w	timestamp;
hr_fim_w	timestamp;

hr_atual_w	timestamp;
qt_reg_w	bigint;

BEGIN

if (ie_dia_semana_p IS NOT NULL AND ie_dia_semana_p::text <> '') then
	if (ie_dia_semana_p = '8') then
		qt_reg_w := Obter_Se_Feriado(wheb_usuario_pck.get_cd_estabelecimento,clock_timestamp());
		if ( qt_reg_w > 0 ) then
			ie_retorno_w := 'S';
		end if;
	elsif (to_char(pkg_date_utils.get_WeekDay(clock_timestamp())) = ie_dia_semana_p) then
		ie_retorno_w := 'S';
	end if;

	if ( ie_retorno_w = 'S' ) and (hr_inicio_p IS NOT NULL AND hr_inicio_p::text <> '') and (hr_fim_p IS NOT NULL AND hr_fim_p::text <> '') then
		ie_retorno_w := consiste_hor_regra_atrib(hr_inicio_p,hr_fim_p,null);
	end if;

elsif (hr_inicio_p IS NOT NULL AND hr_inicio_p::text <> '') and (hr_fim_p IS NOT NULL AND hr_fim_p::text <> '') then

	hr_inicio_w 	:= to_date(to_char(hr_inicio_p,'hh24:mm'),'hh24:mm');
	hr_fim_w	:= to_date(to_char(hr_fim_p,'hh24:mm'),'hh24:mm');

	dt_atual_w := clock_timestamp();
	hr_atual_w := to_date(to_char(dt_atual_w,'hh24:mm'),'hh24:mm');

	if (hr_fim_w < hr_inicio_w) then

		if ( hr_atual_w <= hr_fim_w ) then
			dt_inicio_w := to_date(to_char(dt_atual_w-1,'dd/mm/yyyy') || ' ' || to_char(hr_inicio_w,'hh24:mi') ,'dd/mm/yyyy hh24:mi');
			dt_fim_w := to_date(to_char(dt_atual_w,'dd/mm/yyyy') || ' ' || to_char(hr_fim_w,'hh24:mi') ,'dd/mm/yyyy hh24:mi');
		else
			dt_inicio_w := to_date(to_char(dt_atual_w,'dd/mm/yyyy') || ' ' || to_char(hr_inicio_w,'hh24:mi'),'dd/mm/yyyy hh24:mi');
			dt_fim_w := to_date(to_char(dt_atual_w+1,'dd/mm/yyyy') || ' ' || to_char(hr_fim_w,'hh24:mi'),'dd/mm/yyyy hh24:mi');
		end if;
	else
		dt_inicio_w := to_date(to_char(dt_atual_w,'dd/mm/yyyy') || ' ' || to_char(hr_inicio_w,'hh24:mi'),'dd/mm/yyyy hh24:mi');
		dt_fim_w := to_date(to_char(dt_atual_w,'dd/mm/yyyy') || ' ' || to_char(hr_fim_w,'hh24:mi'),'dd/mm/yyyy hh24:mi');
	end if;

	if ( dt_atual_w >= dt_inicio_w ) and (dt_atual_w <= dt_fim_w) then
		ie_retorno_w := 'S';
	end if;
else
	ie_retorno_w := 'S';
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_hor_regra_atrib (hr_inicio_p timestamp, hr_fim_p timestamp,ie_dia_semana_p text) FROM PUBLIC;

