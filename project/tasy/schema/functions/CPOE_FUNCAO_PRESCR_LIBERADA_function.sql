-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_funcao_prescr_liberada ( cd_perfil_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE



ie_possui_regra_w		varchar(1):='N';
ie_funcao_usuario_w		usuario.ie_profissional%type;
ie_funcao_medico_lib_w	cpoe_presentation_rule.ie_funcao_medico_lib%type;
ie_funcao_enf_lib_w		cpoe_presentation_rule.ie_funcao_enf_lib%type;
ie_funcao_farm_lib_w	cpoe_presentation_rule.ie_funcao_farm_lib%type;
ie_funcao_fisio_lib_w	cpoe_presentation_rule.ie_funcao_fisio_lib%type;
ie_funcao_nutric_lib_w	cpoe_presentation_rule.ie_funcao_nutric_lib%type;



BEGIN

if (cd_perfil_p IS NOT NULL AND cd_perfil_p::text <> '') then

		select 	max(coalesce('S','N'))
		into STRICT	ie_possui_regra_w
		from 	cpoe_presentation_rule
		where 	((cd_perfil = cd_perfil_p) or (coalesce(cd_perfil::text, '') = ''))
		and	coalesce(cd_estabelecimento, coalesce(wheb_usuario_pck.get_cd_estabelecimento,0)) = coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);

		if (coalesce(ie_possui_regra_w,'N') = 'S') then

			ie_funcao_usuario_w := Obter_Profissional_Usuario(nm_usuario_p, 'C');

			if (Obter_funcao_usuario(nm_usuario_p) in (20, 44, 30)) then
				return 'N';
			end if;

			if (coalesce(ie_funcao_usuario_w, '') <> '') or (ie_funcao_usuario_w IS NOT NULL AND ie_funcao_usuario_w::text <> '') then

				select	max(coalesce(ie_funcao_medico_lib,'S')),
					max(coalesce(ie_funcao_enf_lib,'S')),
					max(coalesce(ie_funcao_farm_lib,'S')),
					max(coalesce(ie_funcao_fisio_lib,'S')),
					max(coalesce(ie_funcao_nutric_lib,'S'))
				into STRICT	ie_funcao_medico_lib_w,
					ie_funcao_enf_lib_w,
					ie_funcao_farm_lib_w,
					ie_funcao_fisio_lib_w,
					ie_funcao_nutric_lib_w
				from (SELECT 	ie_funcao_medico_lib,
						ie_funcao_enf_lib,
						ie_funcao_farm_lib,
						ie_funcao_fisio_lib,
						ie_funcao_nutric_lib
					from 	cpoe_presentation_rule
					where 	coalesce(cd_perfil, coalesce(cd_perfil_p,0)) = coalesce(cd_perfil_p,0)
					and	coalesce(cd_estabelecimento, coalesce(wheb_usuario_pck.get_cd_estabelecimento,0)) = coalesce(wheb_usuario_pck.get_cd_estabelecimento,0)
					order by 	cd_perfil, cd_estabelecimento) alias19 LIMIT 1;

				if (ie_funcao_usuario_w = 'M') then
					return coalesce(ie_funcao_medico_lib_w,'N');

				elsif (ie_funcao_usuario_w in ('E', 'TE')) then
					return coalesce(ie_funcao_enf_lib_w,'N');

				elsif (ie_funcao_usuario_w = 'F')then
					return coalesce(ie_funcao_farm_lib_w,'N');

				elsif (ie_funcao_usuario_w = 'FI') then
					return coalesce(ie_funcao_fisio_lib_w,'N');

				elsif (ie_funcao_usuario_w = 'N') then
					return coalesce(ie_funcao_nutric_lib_w,'N');

				else
					return 'S';
				end if;
			end if;

		end if;
end if;

return	'S';

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_funcao_prescr_liberada ( cd_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

