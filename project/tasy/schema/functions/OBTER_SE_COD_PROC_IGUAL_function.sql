-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_cod_proc_igual (nr_cirurgia_p bigint) RETURNS varchar AS $body$
DECLARE


/*retorna se o codigo do procedimento da função autorização convenio é o mesmo da função gestão de cirurgias*/

ie_retorno_w			varchar(1) := 'S';
cd_procedimento_princ_w		bigint;
ie_origem_proced_cir_w 		bigint;
nr_seq_autor_conv_w		bigint;


BEGIN

select  max(a.nr_sequencia)
into STRICT	nr_seq_autor_conv_w
from    autorizacao_convenio a,
	agenda_paciente c,
	cirurgia d
where   c.nr_cirurgia = d.nr_cirurgia
and	c.nr_sequencia = a.nr_seq_agenda
and     d.nr_cirurgia = nr_cirurgia_p;

if (nr_seq_autor_conv_w > 0) then

select  a.cd_procedimento_princ,
	a.ie_origem_proced
into STRICT	cd_procedimento_princ_w	,
	ie_origem_proced_cir_w
from    cirurgia a
	where   a.nr_cirurgia = nr_cirurgia_p;

select  coalesce(max('S'),'N')
into STRICT	ie_retorno_w
from    autorizacao_convenio a,
	agenda_paciente c,
	cirurgia d
where   c.nr_cirurgia = d.nr_cirurgia
and	c.nr_sequencia = a.nr_seq_agenda
and	d.nr_cirurgia = nr_cirurgia_p
and	a.cd_procedimento_principal	=  cd_procedimento_princ_w
and	a.ie_origem_proced	=	ie_origem_proced_cir_w;

if (ie_retorno_w = 'N') then
	select  coalesce(max('S'),'N')
	into STRICT	ie_retorno_w
	from    procedimento_autorizado a
	where   a.nr_sequencia_autor 	=  	nr_seq_autor_conv_w
	and	a.cd_procedimento	=	cd_procedimento_princ_w
	and	a.ie_origem_proced	=	ie_origem_proced_cir_w;
end if;

end if;

return  ie_retorno_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_cod_proc_igual (nr_cirurgia_p bigint) FROM PUBLIC;

