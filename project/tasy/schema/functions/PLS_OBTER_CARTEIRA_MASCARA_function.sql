-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_carteira_mascara ( nr_seq_segurado_p bigint ) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(50);
ds_mascara_w		varchar(50);
cd_usuario_plano_w	pls_segurado_carteira.cd_usuario_plano%type;
nr_seq_emissor_w	pls_segurado_carteira.nr_seq_emissor%type;
nr_caracteres_w		integer;
nr_cont_mask_w		integer := 0;
nr_cont_cart_w		integer := 1;
I			integer := 1;


BEGIN 
ds_retorno_w := '';
 
select	max(cd_usuario_plano), 
	max(nr_seq_emissor) 
into STRICT	cd_usuario_plano_w, 
	nr_seq_emissor_w 
from	pls_segurado_carteira 
where	nr_seq_segurado	= nr_seq_segurado_p;
 
if (nr_seq_emissor_w IS NOT NULL AND nr_seq_emissor_w::text <> '') then 
	ds_mascara_w := pls_obter_mascara_cartao_benef( nr_seq_emissor_w,'E',wheb_usuario_pck.get_cd_estabelecimento);
else 
	ds_mascara_w := pls_obter_mascara_carteira;
end if;
 
nr_caracteres_w := length(cd_usuario_plano_w);
 
/* se cd_usuario plano for zero ou null retorna sem entrar no loop */
 
if coalesce(nr_caracteres_w,0) = 0 then 
	return null;
end if;
 
/*Realiza até a carteira acabar*/
 
loop 
	begin 
	 
	if (substr(ds_mascara_w, i, 1) in ('/','-','.',' ','_')) then 
		ds_retorno_w := ds_retorno_w || substr(ds_mascara_w, i, 1);
	else 
		ds_retorno_w := ds_retorno_w || substr(cd_usuario_plano_w, nr_cont_cart_w,1);
		nr_cont_cart_w := nr_cont_cart_w + 1;
	end if;	
	 
	i := i + 1;
	 
	end;
	 
	exit when nr_cont_cart_w > nr_caracteres_w;
	/* Usado exit no final ao invés de WHILE para ler último caracter corretamente */
 
end loop;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_carteira_mascara ( nr_seq_segurado_p bigint ) FROM PUBLIC;

