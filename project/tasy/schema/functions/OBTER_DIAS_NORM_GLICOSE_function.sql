-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dias_norm_glicose (nr_atendimento_p bigint, dt_inicio timestamp, dt_fim timestamp) RETURNS bigint AS $body$
DECLARE

  QTD_DIAS_V bigint;

BEGIN
  SELECT SUM(OBTER_DIAS_ENTRE_DATAS(MIN(T.DT_CONTROLE), DT_ALTERACAO)) DIAS
  INTO STRICT QTD_DIAS_V
  FROM (SELECT R.*,
               CASE WHEN DS_RESULTADO='Glucose Compliance' THEN  1  ELSE 0 END  COMPLIANCE,
               CASE WHEN DS_RESULTADO='Glucose Compliance' THEN (SELECT MIN(DT_CONTROLE)                         FROM REL_RESULTADO_GLICEMIA_V A                        WHERE A.NR_ATENDIMENTO = R.NR_ATENDIMENTO                          AND A.DS_RESULTADO <> R.DS_RESULTADO                          AND A.DT_CONTROLE BETWEEN dt_inicio AND FIM_DIA(dt_fim)                          AND A.NR_SEQ_PROTOCOLO = 1302                          AND A.DT_CONTROLE > R.DT_CONTROLE)  ELSE (SELECT MIN(DT_CONTROLE)                         FROM REL_RESULTADO_GLICEMIA_V C                        WHERE C.NR_ATENDIMENTO = R.NR_ATENDIMENTO                          AND C.DS_RESULTADO = 'Glucose Compliance'                          AND C.DT_CONTROLE BETWEEN dt_inicio AND FIM_DIA(dt_fim)                          AND C.NR_SEQ_PROTOCOLO = 1302                          AND C.DT_CONTROLE > R.DT_CONTROLE) END  DT_ALTERACAO
          FROM REL_RESULTADO_GLICEMIA_V R
         WHERE NR_ATENDIMENTO = nr_atendimento_p
         AND R.DT_CONTROLE BETWEEN dt_inicio AND FIM_DIA(dt_fim)
         AND R.NR_SEQ_PROTOCOLO = 1302
         ORDER BY R.DT_CONTROLE
         ) T
 GROUP BY T.NR_ATENDIMENTO, T.CD_PESSOA_FISICA, DT_ALTERACAO, COMPLIANCE
 ORDER BY 1;

  return QTD_DIAS_V;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dias_norm_glicose (nr_atendimento_p bigint, dt_inicio timestamp, dt_fim timestamp) FROM PUBLIC;

