-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION mat_possui_faixa_cuidado ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_material_p material.cd_material%type) RETURNS varchar AS $body$
DECLARE

  ie_possui_resticao_w varchar(1) := 'N';
  nr_seq_faixa FAIXA_ETARIA_CUIDADO.NR_SEQUENCIA%type;
  qt_ig_semana_p bigint;
  C01 CURSOR(nr_seq_item_p  bigint, qt_ig_semana_p  bigint)
  FOR
    SELECT nr_sequencia
    FROM FAIXA_ETARIA_CUIDADO
    WHERE nr_sequencia = nr_seq_item_p
    AND ((coalesce(TRUNC(obter_idade_pf(
      (SELECT MAX(cd_pessoa_fisica)
      FROM atendimento_paciente
      WHERE nr_atendimento = nr_atendimento_p
      ), clock_timestamp(), 'DIA')),1) BETWEEN coalesce(Obter_idade_param_prescr2(coalesce(qt_idade_min,0),coalesce(qt_idade_min_mes,0),coalesce(qt_idade_min_dia,0), coalesce(qt_idade_max,0),coalesce(qt_idade_max_mes,0),coalesce(qt_idade_max_dia,0),'MIN'),0)
      AND coalesce(Obter_idade_param_prescr2(coalesce(qt_idade_min,0),coalesce(qt_idade_min_mes,0),coalesce(qt_idade_min_dia,0),coalesce(qt_idade_max,0), coalesce(qt_idade_max_mes,0),coalesce(qt_idade_max_dia,0),'MAX'),9999999)
      and coalesce(Obter_idade_param_prescr2(coalesce(qt_idade_min,0),coalesce(qt_idade_min_mes,0),coalesce(qt_idade_min_dia,0), coalesce(qt_idade_max,0),coalesce(qt_idade_max_mes,0),coalesce(qt_idade_max_dia,0),'MIN'),0) <> 0 
      and coalesce(Obter_idade_param_prescr2(coalesce(qt_idade_min,0),coalesce(qt_idade_min_mes,0),coalesce(qt_idade_min_dia,0),coalesce(qt_idade_max,0), coalesce(qt_idade_max_mes,0),coalesce(qt_idade_max_dia,0),'MAX'),9999999) <> 9999999)
    OR ((qt_ig_semana_p IS NOT NULL AND qt_ig_semana_p::text <> '') and ((QT_IG_MAX IS NOT NULL AND QT_IG_MAX::text <> '') or (QT_IG_MIN IS NOT NULL AND QT_IG_MIN::text <> ''))
    AND coalesce(QT_IG_MAX, 9999999) >= qt_ig_semana_p
    AND coalesce(QT_IG_MIN, 0) <= qt_ig_semana_p));
    c01_w c01%rowtype;

  CO2 CURSOR FOR 
  SELECT NR_SEQ_FAIXA_ETARIA FROM MATERIAL_RESTRICAO_PRESCR WHERE cd_material = cd_material_p;

  
BEGIN    
  
    SELECT MAX(obter_idade_gest_semana(nr_atendimento_p))
    INTO STRICT qt_ig_semana_p
;
    
    FOR item IN CO2
    LOOP      
      for c01_proc_w in c01(item.NR_SEQ_FAIXA_ETARIA, qt_ig_semana_p) loop          
        IF (c01_proc_w.nr_sequencia IS NOT NULL AND c01_proc_w.nr_sequencia::text <> '') THEN          
          ie_possui_resticao_w := 'S';
        END IF;
      end loop;
      
    END LOOP;

    RETURN ie_possui_resticao_w;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION mat_possui_faixa_cuidado ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_material_p material.cd_material%type) FROM PUBLIC;

