-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_plano_cod_usuario_conv (cd_convenio_p bigint, cd_usuario_convenio_p text) RETURNS varchar AS $body$
DECLARE


qt_inicio_digito_w	smallint;
nr_digito_plano_w	bigint;
nr_digito_usuario_w	varchar(10);
cd_plano_w		varchar(10);


BEGIN
if (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '') and (cd_usuario_convenio_p IS NOT NULL AND cd_usuario_convenio_p::text <> '') then
	/* obter número de digitos plano x convênio */

	select	coalesce(max(qt_inicio_digito),1),
		coalesce(max(nr_digito_plano),0)
	into STRICT	qt_inicio_digito_w,
		nr_digito_plano_w
	from	convenio
	where	cd_convenio = cd_convenio_p;

	if (nr_digito_plano_w > 0) then
		/* obter digitos carteirinha usuario */

		nr_digito_usuario_w := substr(cd_usuario_convenio_p,qt_inicio_digito_w,nr_digito_plano_w);

		/* obter plano x convenio x digitos */

		select	coalesce(max(cd_plano),'')
		into STRICT	cd_plano_w
		from	convenio_plano
		where	cd_convenio = cd_convenio_p
		and	cd_plano = nr_digito_usuario_w;
	end if;
end if;

return cd_plano_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_plano_cod_usuario_conv (cd_convenio_p bigint, cd_usuario_convenio_p text) FROM PUBLIC;

