-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION qua_obter_se_visualiza_tipo_nc ( nr_seq_nao_conform_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(3) := 'N';
qt_existe_w			bigint;
nr_seq_tipo_w			qua_nao_conformidade.nr_sequencia%type;
nm_usuario_abertura_w		usuario.nm_usuario%type;
nm_usuario_receptor_w		usuario.nm_usuario%type;
cd_setor_usuario_w			setor_atendimento.cd_setor_atendimento%type := wheb_usuario_pck.get_cd_setor_atendimento;
ie_regra_visualizacao_w		qua_tipo_nc_regra_visual.ie_regra_visualizacao%type;
dt_atual_w			timestamp := trunc(clock_timestamp());

C01 CURSOR FOR
SELECT	ie_regra_visualizacao
from	qua_tipo_nc_regra_visual
where	nr_seq_tipo_nao_conform = nr_seq_tipo_w
and	coalesce(dt_inicio_vigencia,dt_atual_w) <= dt_atual_w
and	coalesce(dt_fim_vigencia,dt_atual_w) >= dt_atual_w;


BEGIN

begin
select	nr_seq_tipo,
	substr(obter_usuario_pf(cd_pf_abertura),1,15),
	substr(obter_usuario_pf(cd_pf_resp_ocorrencia),1,15)
into STRICT	nr_seq_tipo_w,
	nm_usuario_abertura_w,
	nm_usuario_receptor_w
from	qua_nao_conformidade
where	nr_sequencia = nr_seq_nao_conform_p;
exception
when others then
	nr_seq_tipo_w		:= null;
	nm_usuario_abertura_w	:= '';
	nm_usuario_receptor_w	:= '';
end;

select	count(*)
into STRICT	qt_existe_w
from	qua_tipo_nc_regra_visual
where	nr_seq_tipo_nao_conform = nr_seq_tipo_w;

if (qt_existe_w > 0) then
	open C01;
	loop
	fetch C01 into
		ie_regra_visualizacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ds_retorno_w = 'N') and (ie_regra_visualizacao_w = 'R') and --Receptor responsável
			(nm_usuario_receptor_w = nm_usuario_p) then
			ds_retorno_w := 'S';
		end if;

		if (ds_retorno_w = 'N') and (ie_regra_visualizacao_w = 'E') then --Setores envolvidos
			begin
			select	count(*)
			into STRICT	qt_existe_w
			from	qua_nao_conform_setor
			where	cd_setor_atendimento = cd_setor_usuario_w
			and	nr_seq_nao_conform = nr_seq_nao_conform_p;

			if (qt_existe_w > 0) then
				ds_retorno_w := 'S';
			else
				begin
				select	'S'
				into STRICT	ds_retorno_w
				from	qua_nao_conform_setor
				where	nm_usuario_destino = nm_usuario_p
				and	nr_seq_nao_conform = nr_seq_nao_conform_p  LIMIT 1;
				exception
				when others then
					begin
					select	'S'
					into STRICT	ds_retorno_w
					from	usuario_grupo b,
						qua_nao_conform_setor a
					where	b.nr_seq_grupo = a.nr_seq_grupo_usuario_dest
					and	b.ie_situacao = 'A'
					and	b.nm_usuario_grupo = nm_usuario_p
					and	a.nr_seq_nao_conform = nr_seq_nao_conform_p  LIMIT 1;
					exception
					when others then
						ds_retorno_w := 'N';
					end;
				end;
			end if;
			end;
		end if;

		if (ds_retorno_w = 'N') and (ie_regra_visualizacao_w = 'A') and --Usuário abertura
			(nm_usuario_abertura_w = nm_usuario_p) then
			ds_retorno_w := 'S';
		end if;
		end;
	end loop;
	close C01;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION qua_obter_se_visualiza_tipo_nc ( nr_seq_nao_conform_p bigint, nm_usuario_p text) FROM PUBLIC;

