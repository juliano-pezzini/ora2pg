-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_servico_leito_futuro ( nr_seq_interno_p bigint, ie_opcao_p text ) RETURNS varchar AS $body$
DECLARE


/*
ie_opcao_p:
	S - Stauts
	E - Serviço
	D - Descrição
*/
dt_prevista_w		timestamp;
dt_inicio_w		timestamp;
dt_fim_w		timestamp;
nr_seq_servico_w	bigint;
ie_status_servico_w	varchar(15);
ds_servico_w		varchar(80);
ds_status_w		varchar(40);
ds_retorno_w		varchar(1000) := null;


BEGIN

begin
select	a.dt_prevista,
	a.dt_inicio,
	a.dt_fim,
	coalesce(a.nr_seq_servico_exec,a.nr_seq_servico),
	b.ds_servico,
	a.ie_status_serv,
	substr(obter_valor_dominio(1812, ie_status_serv),1,40)
into STRICT	dt_prevista_w,
	dt_inicio_w,
	dt_fim_w,
	nr_seq_servico_w,
	ds_servico_w,
	ie_status_servico_w,
	ds_status_w
from	sl_servico b,
	sl_unid_atend a
where	b.nr_sequencia	=	coalesce(a.nr_seq_servico_exec,a.nr_seq_servico)
and	a.nr_sequencia	=	(	SELECT	max(x.nr_sequencia)
					from	sl_unid_atend x
					where	x.nr_seq_unidade	=	nr_seq_interno_p
					and	x.dt_prevista 	> trunc(clock_timestamp(),'dd'));
exception
	when others then
	ds_retorno_w	:= ' ';
end;

if (ie_opcao_p = 'D') and (coalesce(ds_retorno_w::text, '') = '') then
	ds_retorno_w := wheb_mensagem_pck.get_texto(309946, 'DS_STATUS_W='||ds_status_w||';DS_SERVICO_W='||ds_servico_w||';DT_PREVISTA_W='||to_char(dt_prevista_w,'dd/mm/yy hh24:mi')||';'||
														'DT_INICIO_W='||coalesce(to_char(dt_inicio_w,'dd/mm/yy hh24:mi'),wheb_mensagem_pck.get_texto(309945))); -- Não iniciado
					-- Serviço #@DS_STATUS_W#@: #@DS_SERVICO_W#@. Início previsto / real: #@DT_PREVISTA_W#@ / #@DT_INICIO_W#@
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_servico_leito_futuro ( nr_seq_interno_p bigint, ie_opcao_p text ) FROM PUBLIC;

