-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_tipo_contratacao_sip ( nr_seq_lote_p sip_lote_item_assistencial.nr_seq_lote%type, nr_seq_item_sip_p sip_lote_item_assistencial.nr_seq_item_sip%type) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Retorna as contratações encontradas para o item assistencial, que exista no lote SIP

	O formato de retorno é para ser utilizado ao "IN" no where de uma consulta.

	Essa function foi criada unicamente por compatibilidade com o Oracle 10g, em
	vista que nas versões superiores já existe solução melhor.

-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

Alterações:
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_retorno_w	varchar(2000) := '';

-- Busca as contratações do dominio, que posuirem incidencia no lote SIP por item assistencial
c01 CURSOR(	nr_seq_lote_pc		sip_lote_item_assistencial.nr_seq_lote%type,
		nr_seq_item_sip_pc	sip_lote_item_assistencial.nr_seq_item_sip%type ) FOR
	SELECT	''''||x.vl_dominio||'''' ie_tipo_contratacao_sip
	from	valor_dominio	x
	where	x.cd_dominio = 1666
	and	exists (	SELECT	1
				from	sip_lote_item_assistencial	x
				where	x.nr_seq_lote		= nr_seq_lote_pc
				and	x.nr_seq_item_sip	= nr_seq_item_sip_pc
				and	x.ie_tipo_contratacao	= x.vl_dominio)
	group by ''''||x.vl_dominio||'''';


BEGIN

-- navega e contatena as contratações
for r_c01_w in c01(nr_seq_lote_p, nr_seq_item_sip_p) loop

	ds_retorno_w := ds_retorno_w||r_c01_w.ie_tipo_contratacao_sip||',';
end loop;

-- remove a ultima virgula
ds_retorno_w := substr(ds_retorno_w, 1, length(ds_retorno_w)-1);

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_tipo_contratacao_sip ( nr_seq_lote_p sip_lote_item_assistencial.nr_seq_lote%type, nr_seq_item_sip_p sip_lote_item_assistencial.nr_seq_item_sip%type) FROM PUBLIC;

