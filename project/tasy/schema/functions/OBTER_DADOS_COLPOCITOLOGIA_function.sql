-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_colpocitologia ( nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(2000);
ds_medicamento_utilizado_w	varchar(200);
dt_ultima_mestruacao_w	timestamp;
dt_ultimo_parto_w	timestamp;
ie_nuligesta_w		varchar(1);
ie_gemelar_w		varchar(1);
qt_gestacao_w		bigint;
qt_lamina_w		bigint;
qt_abortos_paciente_w	bigint;

C02 CURSOR FOR
	SELECT  to_char(d.dt_ultimo_parto,'dd/mm/yyyy'),
		CASE WHEN d.ie_gestacao_nuligesta='' THEN 'S'  ELSE 'N' END ,
		CASE WHEN d.ie_gestacao_gemelar='' THEN 'S'  ELSE 'N' END ,
		coalesce(d.qt_gestacoes,0),
		coalesce(d.qt_laminas,0),
		coalesce(d.nr_abortos_paciente,0)
	from    prescr_medica_inf_adic d
	where   nr_prescricao = nr_prescricao_p
	order by 1;

C03 CURSOR FOR
	SELECT  substr(coalesce(obter_desc_material(f.cd_material),ds_medicamento),1,100)
	from    paciente_medic_uso f,
		prescr_medica d
	where   d.nr_atendimento   = f.nr_atendimento
	and     d.nr_prescricao    = nr_prescricao_p
	order by 1;


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
	begin

	select  max(a.Dt_Mestruacao)
	into STRICT	dt_ultima_mestruacao_w
	from    prescr_medica a
	where   a.nr_prescricao = nr_prescricao_p;

	ds_retorno_w := 	'Data da última mestruação: ' || to_char(dt_ultima_mestruacao_w,'dd/mm/yyyy') || ';';

	open C02;
	loop
	fetch C02 into
		dt_ultimo_parto_w,
		ie_nuligesta_w,
		ie_gemelar_w,
		qt_gestacao_w,
		qt_lamina_w,
		qt_abortos_paciente_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		ds_retorno_w := ds_retorno_w ||
				'Data último parto.............: ' || to_char(dt_ultimo_parto_w,'dd/mm/yyyy')|| ';' ||
				'Nuligesta........................: ' || ie_nuligesta_w 			|| ';' ||
				'Gemelar..........................: ' || ie_gemelar_w 				|| ';' ||
				'Qtd gestação..................: ' || qt_gestacao_w 				|| ';' ||
				'Qtd lâminas.....................: ' || qt_lamina_w 				|| ';' ||
				'Qtd aborto......................: ' || qt_abortos_paciente_w			|| ';';
		end;
	end loop;
	close C02;

	open C03;
	loop
	fetch C03 into
		ds_medicamento_utilizado_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		ds_retorno_w := ds_retorno_w ||
				'Medicamentos utilizados....: ' || ds_medicamento_utilizado_w || ';';
		end;
	end loop;
	close C03;
	end;
end if;

return  ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_colpocitologia ( nr_prescricao_p bigint) FROM PUBLIC;

