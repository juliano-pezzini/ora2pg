-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_ap_lote_turno ( nr_seq_turno_p bigint, cd_setor_atendimento_p text, cd_local_estoque_p bigint, nr_seq_classif_p text, ie_tipo_data_p text, dt_geracao_inicio_lote_p timestamp, dt_geracao_final_lote_p timestamp) RETURNS bigint AS $body$
DECLARE


qt_lotes_w	bigint;
qt_lotes_agrup_w bigint;
ie_lote_alta_w	varchar(1);
ie_somente_desdobrado_w	varchar(1);
ie_agrupar_w 	varchar(1);


BEGIN

select	coalesce(max(ie_agrupar_lote_copia),'N')
into STRICT	ie_agrupar_w
from	parametros_farmacia
where 	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

ie_lote_alta_w := substr(obter_valor_param_usuario(7029,17,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento),1,1);
ie_somente_desdobrado_w := substr(obter_valor_param_usuario(88,94,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento),1,1);

if (nr_seq_classif_p IS NOT NULL AND nr_seq_classif_p::text <> '') and (coalesce(nr_seq_classif_p, 'X') <> 'X') then
	select	count(distinct a.nr_sequencia) qt_lotes
	into STRICT	qt_lotes_w
	FROM regra_turno_disp d, ap_lote_item b, ap_lote a, obter_atendimento_prescr(a
LEFT OUTER JOIN atendimento_paciente c ON (obter_atendimento_prescr(a.nr_prescricao) = c.nr_atendimento)
WHERE a.nr_sequencia = b.nr_seq_lote and d.nr_sequencia = a.nr_seq_turno and d.ie_situacao = 'A' and a.nr_sequencia = b.nr_seq_lote  and a.nr_seq_turno = nr_seq_turno_p and ((a.cd_local_estoque = cd_local_estoque_p) or (coalesce(cd_local_estoque_p::text, '') = '')) and b.qt_dispensar > 0 and a.ie_status_lote = 'G' and (ie_lote_alta_w = 'S' or coalesce(c.dt_alta::text, '') = '') and CASE WHEN ie_tipo_data_p='G' THEN a.dt_geracao_lote WHEN ie_tipo_data_p='I' THEN a.dt_inicio_turno WHEN ie_tipo_data_p='A' THEN a.dt_atend_lote END  between dt_geracao_inicio_lote_p and dt_geracao_final_lote_p and ((ie_somente_desdobrado_w = 'T') or ((ie_somente_desdobrado_w = 'S') and ((a.nr_seq_lote_sup IS NOT NULL AND a.nr_seq_lote_sup::text <> '') or coalesce(a.ie_reaprazado,'N') = 'S'))
	or 	((ie_somente_desdobrado_w = 'N') and (coalesce(a.nr_seq_lote_sup::text, '') = '' or coalesce(a.ie_reaprazado,'N') = 'S'))) and substr(obter_se_contido(a.cd_setor_atendimento, cd_setor_atendimento_p),1,1) = 'S' and substr(obter_se_contido_char(a.nr_seq_classif, nr_seq_classif_p),1,1) = 'S' and (ie_agrupar_w = 'N' or (ie_agrupar_w = 'S' and coalesce(a.nr_lote_agrupamento::text, '') = ''));
	
	select	count(distinct a.nr_sequencia) qt_lotes
	into STRICT	qt_lotes_agrup_w
	FROM regra_turno_disp d, ap_lote a
LEFT OUTER JOIN atendimento_paciente c ON (a.nr_atendimento = c.nr_atendimento)
WHERE a.nr_seq_turno = d.nr_sequencia and d.ie_situacao = 'A' and a.nr_seq_turno = nr_seq_turno_p and ((a.cd_local_estoque = cd_local_estoque_p) or (coalesce(cd_local_estoque_p::text, '') = '')) and a.ie_status_lote = 'G' and (ie_lote_alta_w = 'S' or coalesce(c.dt_alta::text, '') = '') and CASE WHEN ie_tipo_data_p='G' THEN a.dt_geracao_lote WHEN ie_tipo_data_p='I' THEN a.dt_inicio_turno WHEN ie_tipo_data_p='A' THEN a.dt_atend_lote END  between dt_geracao_inicio_lote_p and dt_geracao_final_lote_p and ((ie_somente_desdobrado_w = 'T') or ((ie_somente_desdobrado_w = 'S') and ((a.nr_seq_lote_sup IS NOT NULL AND a.nr_seq_lote_sup::text <> '') or coalesce(a.ie_reaprazado,'N') = 'S'))
	or 	((ie_somente_desdobrado_w = 'N') and (coalesce(a.nr_seq_lote_sup::text, '') = '' or coalesce(a.ie_reaprazado,'N') = 'S'))) and substr(obter_se_contido(a.cd_setor_atendimento, cd_setor_atendimento_p),1,1) = 'S' and substr(obter_se_contido_char(a.nr_seq_classif, nr_seq_classif_p),1,1) = 'S' and a.ie_agrupamento = 'S';
else
	select	count(distinct a.nr_sequencia) qt_lotes
	into STRICT	qt_lotes_w
	FROM regra_turno_disp d, ap_lote_item b, ap_lote a, obter_atendimento_prescr(a
LEFT OUTER JOIN atendimento_paciente c ON (obter_atendimento_prescr(a.nr_prescricao) = c.nr_atendimento)
WHERE a.nr_sequencia = b.nr_seq_lote and d.nr_sequencia = a.nr_seq_turno and d.ie_situacao = 'A' and a.nr_sequencia = b.nr_seq_lote  and a.nr_seq_turno = nr_seq_turno_p and ((a.cd_local_estoque = cd_local_estoque_p) or (coalesce(cd_local_estoque_p::text, '') = '')) and b.qt_dispensar > 0 and a.ie_status_lote = 'G' and (ie_lote_alta_w = 'S' or coalesce(c.dt_alta::text, '') = '') and CASE WHEN ie_tipo_data_p='G' THEN a.dt_geracao_lote WHEN ie_tipo_data_p='I' THEN a.dt_inicio_turno WHEN ie_tipo_data_p='A' THEN a.dt_atend_lote END  between dt_geracao_inicio_lote_p and dt_geracao_final_lote_p and ((ie_somente_desdobrado_w = 'T') or ((ie_somente_desdobrado_w = 'S') and ((a.nr_seq_lote_sup IS NOT NULL AND a.nr_seq_lote_sup::text <> '') or coalesce(a.ie_reaprazado,'N') = 'S'))
	or ((ie_somente_desdobrado_w = 'N') and (coalesce(a.nr_seq_lote_sup::text, '') = '' or coalesce(a.ie_reaprazado,'N') = 'S'))) and substr(obter_se_contido(a.cd_setor_atendimento, cd_setor_atendimento_p),1,1) = 'S' and (ie_agrupar_w = 'N' or (ie_agrupar_w = 'S' and coalesce(a.nr_lote_agrupamento::text, '') = ''));
	
	select	count(distinct a.nr_sequencia) qt_lotes
	into STRICT	qt_lotes_agrup_w
	FROM regra_turno_disp d, ap_lote a
LEFT OUTER JOIN atendimento_paciente c ON (a.nr_atendimento = c.nr_atendimento)
WHERE d.nr_sequencia = a.nr_seq_turno and d.ie_situacao = 'A' and a.nr_seq_turno = nr_seq_turno_p and ((a.cd_local_estoque = cd_local_estoque_p) or (coalesce(cd_local_estoque_p::text, '') = '')) and a.ie_status_lote = 'G' and (ie_lote_alta_w = 'S' or coalesce(c.dt_alta::text, '') = '') and CASE WHEN ie_tipo_data_p='G' THEN a.dt_geracao_lote WHEN ie_tipo_data_p='I' THEN a.dt_inicio_turno WHEN ie_tipo_data_p='A' THEN a.dt_atend_lote END  between dt_geracao_inicio_lote_p and dt_geracao_final_lote_p and ((ie_somente_desdobrado_w = 'T') or ((ie_somente_desdobrado_w = 'S') and ((a.nr_seq_lote_sup IS NOT NULL AND a.nr_seq_lote_sup::text <> '') or coalesce(a.ie_reaprazado,'N') = 'S'))
	or 	((ie_somente_desdobrado_w = 'N') and (coalesce(a.nr_seq_lote_sup::text, '') = '' or coalesce(a.ie_reaprazado,'N') = 'S'))) and substr(obter_se_contido(a.cd_setor_atendimento, cd_setor_atendimento_p),1,1) = 'S' and a.ie_agrupamento = 'S';
	
	
end if;

return(qt_lotes_w + qt_lotes_agrup_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_ap_lote_turno ( nr_seq_turno_p bigint, cd_setor_atendimento_p text, cd_local_estoque_p bigint, nr_seq_classif_p text, ie_tipo_data_p text, dt_geracao_inicio_lote_p timestamp, dt_geracao_final_lote_p timestamp) FROM PUBLIC;

