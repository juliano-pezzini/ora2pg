-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_internal_proc_number (cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_atend_p bigint, cd_setor_lanc_p bigint, cd_convenio_p bigint, cd_categoria_p text, dt_vigencia_p timestamp, cd_estab_atend_p bigint, nr_atendimento_p bigint) RETURNS bigint AS $body$
DECLARE

 
cd_edicao_amb_w		bigint;
dt_vigencia_w		timestamp;
nr_seq_proc_interno_w	proc_interno.nr_sequencia%type;
ie_origem_proc_filtro_w	proc_interno_conv.ie_origem_proc_filtro%type;
cd_tipo_acomodacao_w	proc_interno_conv.cd_tipo_acomodacao%type;
cd_estab_logado_w	smallint;


BEGIN

dt_vigencia_w		:= trunc(coalesce(dt_vigencia_p, clock_timestamp()));
ie_origem_proc_filtro_w	:= coalesce(obter_origem_proced_cat(cd_estab_atend_p, ie_tipo_atend_p, obter_tipo_convenio(cd_convenio_p), cd_convenio_p, cd_categoria_p),0);
cd_edicao_amb_w		:= coalesce(obter_edicao_amb(cd_estab_atend_p, cd_convenio_p, cd_categoria_p, dt_vigencia_p),0);
cd_tipo_acomodacao_w	:= coalesce(somente_numero(obter_tipo_acomod_atend(nr_atendimento_p,'C')),0);
cd_estab_logado_w	:= wheb_usuario_pck.get_cd_estabelecimento;

select	max(b.nr_sequencia) 
into STRICT	nr_seq_proc_interno_w 
from	proc_interno_conv a,
	proc_interno b
where	a.nr_seq_proc_interno	= b.nr_sequencia
and	a.cd_procedimento	= cd_procedimento_p
and	a.ie_situacao	= 'A'
and	b.ie_situacao	= 'A'
and	coalesce(a.ie_origem_proc_filtro, ie_origem_proc_filtro_w, 0)	= ie_origem_proc_filtro_w
and	coalesce(a.cd_edicao_amb ,cd_edicao_amb_w ,0)	= cd_edicao_amb_w
and	coalesce(a.cd_convenio, cd_convenio_p, 0)	= coalesce(cd_convenio_p, 0)
and	coalesce(a.cd_categoria, cd_categoria_p, '0')	= coalesce(cd_categoria_p, '0')
and	dt_vigencia_w between coalesce(a.dt_inicio_vigencia, dt_vigencia_w) and coalesce(a.dt_final_vigencia, dt_vigencia_w)
and	coalesce(a.ie_tipo_atendimento, ie_tipo_atend_p, 0)	= coalesce(ie_tipo_atend_p, 0)
and (coalesce(a.ie_tipo_setor::text, '') = '' 
	OR coalesce(a.cd_setor_atendimento::text, '') = ''
	OR (a.ie_tipo_setor = 'P' and a.cd_setor_atendimento = obter_setor_atendimento(nr_atendimento_p))
	OR (a.ie_tipo_setor = 'L' and a.cd_setor_atendimento = cd_setor_lanc_p)
	OR (a.ie_tipo_setor = 'I' and a.cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_p,'IA','CS')))
and	coalesce(a.cd_estabelecimento, cd_estab_logado_w, 0)	= coalesce(cd_estab_logado_w, 0)
and	coalesce(a.cd_tipo_acomodacao, cd_tipo_acomodacao_w, 0) = cd_tipo_acomodacao_w;

if (coalesce(nr_seq_proc_interno_w::text, '') = '') then
	select	max(b.nr_sequencia)
	into STRICT	nr_seq_proc_interno_w 
	from	proc_interno b 
	where	b.cd_procedimento = cd_procedimento_p
	and	b.ie_origem_proced = ie_origem_proced_p
	and	b.ie_situacao = 'A';
end if;

return	nr_seq_proc_interno_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_internal_proc_number (cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_atend_p bigint, cd_setor_lanc_p bigint, cd_convenio_p bigint, cd_categoria_p text, dt_vigencia_p timestamp, cd_estab_atend_p bigint, nr_atendimento_p bigint) FROM PUBLIC;

