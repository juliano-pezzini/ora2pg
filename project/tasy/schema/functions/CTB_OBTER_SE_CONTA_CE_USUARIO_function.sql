-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_se_conta_ce_usuario ( cd_empresa_p bigint, cd_centro_custo_p bigint, cd_conta_contabil_p text, nm_usuario_p text, dt_vigencia_p timestamp default null) RETURNS varchar AS $body$
DECLARE


cd_classif_conta_w		varchar(40);
cd_conta_contabil_w		varchar(20)	:= cd_conta_contabil_p;
ie_centro_custo_w		varchar(1)	:= 'N';
ie_centro_lib_w			varchar(1)	:= 'S';
ie_conta_lib_w			varchar(1)	:= 'S';
ie_permite_w			varchar(1)	:= 'S';
ie_permissao_visual_w		varchar(1)	:= 'S';
ie_nivel_w			bigint;
qt_regra_w			bigint	:= 0;
cd_perfil_w			integer;
cd_estabelecimento_w		smallint;


BEGIN
cd_perfil_w	:= wheb_usuario_pck.get_cd_perfil;

begin
cd_classif_conta_w	:= ctb_obter_classif_conta(cd_conta_contabil_p, null, dt_vigencia_p);

	select	cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	from	centro_custo
	where	cd_centro_custo	= cd_centro_custo_p;

exception when others then
	cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
end;

/* verifica se o centro está liberado para o usuário */

ie_centro_lib_w	:= coalesce(substr(ctb_obter_se_centro_usuario(cd_centro_custo_p,cd_empresa_p,nm_usuario_p),1,1),'N');

select	cd
into STRICT	qt_regra_w
from	(
	SELECT	1 cd
	from	ctb_lib_orc_conta
	where	cd_empresa	= cd_empresa_p
	and	((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
	
union all

	SELECT	0 cd
	
	order by 1 desc LIMIT 1) alias4 LIMIT 1;

if (qt_regra_w > 0) then
	ie_permite_w	:= 'N';
	ie_conta_lib_w	:= 'N';
	if (dt_vigencia_p IS NOT NULL AND dt_vigencia_p::text <> '') then
		begin
		select	ie_nivel_conta,
			ie_atualizacao,
			ie_centro_custo,
			ie_permissao_visual
		into STRICT	ie_nivel_w,
			ie_conta_lib_w,
			ie_centro_custo_w,
			ie_permissao_visual_w
		from (
		SELECT	ctb_obter_nivel_conta(cd_conta_contabil) ie_nivel_conta,
			coalesce(ie_atualizacao,'N') ie_atualizacao,
			coalesce(ie_centro_custo,'N') ie_centro_custo,
			coalesce(ie_permissao_visual,'N') ie_permissao_visual
		from	ctb_lib_orc_conta
		where	cd_empresa		= cd_empresa_p
		and	ie_conta_inferior	= 'N'
		and (case when coalesce(cd_estabelecimento::text, '') = '' then cd_estabelecimento_w
			else cd_estabelecimento_w end) = cd_estabelecimento_w
		and (case when coalesce(nm_usuario_lib::text, '') = '' then nm_usuario_p
			else nm_usuario_lib end) = nm_usuario_p
		and (case when coalesce(cd_perfil::text, '') = '' then cd_perfil_w
			else cd_perfil end) = cd_perfil_w
		and (case when coalesce(cd_conta_contabil::text, '') = '' then cd_conta_contabil_w
			else cd_conta_contabil end) = cd_conta_contabil_w
		
union all

		SELECT	ctb_obter_nivel_conta(a.cd_conta_contabil) ie_nivel_conta,
			coalesce(a.ie_atualizacao,'N'),
			coalesce(a.ie_centro_custo,'N'),
			coalesce(ie_permissao_visual,'N') ie_permissao_visual
		from	conta_contabil b,
			ctb_lib_orc_conta a
		where	a.cd_conta_contabil	= b.cd_conta_contabil
		and	a.cd_empresa		= b.cd_empresa
		and	ie_conta_inferior	= 'S'
		and	a.cd_empresa		= cd_empresa_p
		and	ctb_obter_classif_conta(b.cd_conta_contabil, null, dt_vigencia_p) = substr(cd_classif_conta_w,1,length(ctb_obter_classif_conta(b.cd_conta_contabil, null, dt_vigencia_p)))
		and (case when coalesce(cd_estabelecimento::text, '') = '' then cd_estabelecimento_w
			else cd_estabelecimento_w end) = cd_estabelecimento_w
		and (case when coalesce(nm_usuario_lib::text, '') = '' then nm_usuario_p
			else nm_usuario_lib end) = nm_usuario_p
		and (case when coalesce(cd_perfil::text, '') = '' then cd_perfil_w
			else cd_perfil end) = cd_perfil_w
		
union all

		select	0,
			'N',
			'N',
			'S'
		
		order by
			1 desc) alias27 LIMIT 1;
		end;
	else
		begin
		select	ie_nivel_conta,
			ie_atualizacao,
			ie_centro_custo,
			ie_permissao_visual
		into STRICT	ie_nivel_w,
			ie_conta_lib_w,
			ie_centro_custo_w,
			ie_permissao_visual_w
		from (
		SELECT	ctb_obter_nivel_conta(cd_conta_contabil) ie_nivel_conta,
			coalesce(ie_atualizacao,'N') ie_atualizacao,
			coalesce(ie_centro_custo,'N') ie_centro_custo,
			coalesce(ie_permissao_visual,'N') ie_permissao_visual
		from	ctb_lib_orc_conta
		where	cd_empresa		= cd_empresa_p
		and	ie_conta_inferior	= 'N'
		and (case when coalesce(cd_estabelecimento::text, '') = '' then cd_estabelecimento_w
			else cd_estabelecimento_w end) = cd_estabelecimento_w
		and (case when coalesce(nm_usuario_lib::text, '') = '' then nm_usuario_p
			else nm_usuario_lib end) = nm_usuario_p
		and (case when coalesce(cd_perfil::text, '') = '' then cd_perfil_w
			else cd_perfil end) = cd_perfil_w
		and (case when coalesce(cd_conta_contabil::text, '') = '' then cd_conta_contabil_w
			else cd_conta_contabil end) = cd_conta_contabil_w
		
union all

		SELECT	ctb_obter_nivel_conta(a.cd_conta_contabil) ie_nivel_conta,
			coalesce(a.ie_atualizacao,'N'),
			coalesce(a.ie_centro_custo,'N'),
			coalesce(ie_permissao_visual,'N') ie_permissao_visual
		from	conta_contabil b,
			ctb_lib_orc_conta a
		where	a.cd_conta_contabil	= b.cd_conta_contabil
		and	a.cd_empresa		= b.cd_empresa
		and	ie_conta_inferior	= 'S'
		and	a.cd_empresa		= cd_empresa_p
		and	b.cd_classificacao_atual = substr(cd_classif_conta_w,1,length(b.cd_classificacao_atual))
		and (case when coalesce(cd_estabelecimento::text, '') = '' then cd_estabelecimento_w
			else cd_estabelecimento_w end) = cd_estabelecimento_w
		and (case when coalesce(nm_usuario_lib::text, '') = '' then nm_usuario_p
			else nm_usuario_lib end) = nm_usuario_p
		and (case when coalesce(cd_perfil::text, '') = '' then cd_perfil_w
			else cd_perfil end) = cd_perfil_w
		
union all

		select	0,
			'N',
			'N',
			'S'
		
		order by
			1 desc) alias24 LIMIT 1;
		end;
	end if;

end if;

if (ie_centro_lib_w <> ie_conta_lib_w) then
	begin
	if (ie_centro_lib_w = 'S') then
		begin
		if (ie_conta_lib_w = 'N') then
			ie_permite_w	:= 'N';
		end if;
		end;
	elsif (ie_centro_lib_w = 'N') then
		begin /* Se o centro não liberado libera a conta somente se regra especial */
		if (ie_conta_lib_w = 'S') then
			begin
			if (ie_centro_custo_w = 'N') then
				ie_permite_w	:= 'N';
			elsif (ie_centro_custo_w = 'S') then
				ie_permite_w	:= 'S';
			end if;
			end;
		end if;
		end;
	elsif (ie_centro_lib_w = 'V') then
		begin
		ie_permite_w	:= ie_permissao_visual_w;
		end;
	end if;
	end;
else	/* Se centro e conta liberados = PERMITE - se centro e conta NÃO liberados = NÃO PERMITE */
	ie_permite_w	:= ie_centro_lib_w;
end if;

return ie_permite_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_se_conta_ce_usuario ( cd_empresa_p bigint, cd_centro_custo_p bigint, cd_conta_contabil_p text, nm_usuario_p text, dt_vigencia_p timestamp default null) FROM PUBLIC;

