-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ligacao_pf_tabela (nm_tabela_p text) RETURNS varchar AS $body$
DECLARE


nm_tabela_w		tabela_sistema.nm_tabela%type;
nm_atributo_pk_w	tabela_atributo.nm_atributo%type;
nm_atributo_pf_w	tabela_atributo.nm_atributo%type;
nm_atributo_pk_ww	tabela_atributo.nm_atributo%type;

nm_atributo_refer_w	tabela_atributo.nm_atributo%type;
nm_atributo_ligacao_w	patient_deletion_table.nm_atributo_ligacao%type;

ds_comando_w		varchar(32000);

C01 CURSOR FOR
	SELECT	a.nm_atributo
	from	integridade_atributo a,
		integridade_referencial b,
		patient_deletion_table c
	where	a.nm_integridade_referencial = b.nm_integridade_referencial
	and	b.nm_tabela = nm_tabela_w
	and	b.nm_tabela_referencia = 'PESSOA_FISICA'
	and	b.nm_tabela = c.nm_tabela
	and	c.nm_atributo_ligacao = a.nm_atributo;

c02 CURSOR FOR
	SELECT	b.nm_tabela_referencia,
		a.nm_atributo
	from	integridade_atributo a,
		integridade_referencial b,
		patient_deletion_table c
	where	b.nm_tabela = nm_tabela_w
	and	c.nm_tabela = b.nm_tabela_referencia
	and	(c.nm_atributo_ligacao IS NOT NULL AND c.nm_atributo_ligacao::text <> '')
	and	c.nm_tabela <> 'PESSOA_FISICA'
	and	a.nm_integridade_referencial = b.nm_integridade_referencial
	and	b.nm_tabela_referencia in (	SELECT	y.nm_tabela
						from	integridade_referencial y
						where	y.nm_tabela_referencia = 'PESSOA_FISICA');

C03 CURSOR FOR
	SELECT	a.nm_atributo
	from	integridade_atributo a,
		integridade_referencial b,
		patient_deletion_table c
	where	a.nm_integridade_referencial = b.nm_integridade_referencial
	and	b.nm_tabela = nm_tabela_w
	and	b.nm_tabela_referencia = 'PESSOA_FISICA'
	and	c.nm_tabela = b.nm_tabela
	and	a.nm_atributo = c.nm_atributo_ligacao;

c04 CURSOR FOR
	SELECT	b.nm_tabela
	from	patient_deletion_table b,
		tabela_sistema a
	where	coalesce(b.ds_sql_ligacao::text, '') = ''
	and	a.nm_tabela = b.nm_tabela
	and	exists (SELECT 1
			from patient_deletion_attribute c
			where c.nr_seq_patient_deletion = b.nr_sequencia)
	and 	exists (select 1
			from tabela_atributo d
			where a.nm_tabela = d.nm_tabela
			and d.nm_atributo = 'NR_ATENDIMENTO'
			and d.ie_tipo_atributo not in ('FUNCTION','VISUAL'))
	and	b.nm_tabela = nm_tabela_p;



BEGIN
ds_comando_w := null;
nm_tabela_w := nm_tabela_p;

select	max(b.nm_atributo)
into STRICT	nm_atributo_pk_w
from	indice a,
	indice_atributo b
where	a.nm_indice = b.nm_indice
and	a.ie_tipo = 'PK'
and	a.nm_tabela = nm_tabela_w;


/* Se houver ligação com a PESSOA_FISICA */

open C01;
loop
fetch C01 into
	nm_atributo_ligacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	if (coalesce(ds_comando_w::text, '') = '' or ds_comando_w = '') then
		ds_comando_w := ' '||coalesce(nm_atributo_pk_w,nm_atributo_ligacao_w)||' in (';
	else
		ds_comando_w := ds_comando_w || ' union all ';
	end if;
	ds_comando_w := ds_comando_w ||
			' select '	|| coalesce(nm_atributo_pk_w,nm_atributo_ligacao_w) ||
			' from '	|| nm_tabela_w ||
			' where ' 	|| nm_atributo_ligacao_w || ' = :PATIENT_ID ';

end loop;
close C01;

/* Quando existir um nível até a PESSOA_FISICA */

open C02;
loop
fetch C02 into
	nm_tabela_w,
	nm_atributo_refer_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	open C03;
	loop
	fetch C03 into
		nm_atributo_pf_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin

		select	max(b.nm_atributo)
		into STRICT	nm_atributo_pk_ww
		from	indice a,
			indice_atributo b
		where	a.nm_indice = b.nm_indice
		and	a.ie_tipo = 'PK'
		and	a.nm_tabela = nm_tabela_w;

		if (coalesce(ds_comando_w::text, '') = '' or ds_comando_w = '') then
			ds_comando_w := ' '||coalesce(nm_atributo_pk_w,coalesce(nm_atributo_ligacao_w,nm_atributo_refer_w))||' in (';
		else
			ds_comando_w := ds_comando_w || ' union all ';
		end if;

		if (nm_atributo_pk_w IS NOT NULL AND nm_atributo_pk_w::text <> '') then
			ds_comando_w := ds_comando_w ||
					' select b.'	|| nm_atributo_pk_w 	||
					' from '	|| nm_tabela_w 		|| ' a, '			||
							   nm_tabela_p 		|| ' b '			||
					' where a.'	|| nm_atributo_pk_ww 	|| ' = b.' || nm_atributo_refer_w 	||
					' and a.'	|| nm_atributo_pf_w 	|| ' = :PATIENT_ID ';
		else
			if (nm_atributo_ligacao_w IS NOT NULL AND nm_atributo_ligacao_w::text <> '') then
				ds_comando_w := ds_comando_w ||
						' select a.'	|| nm_atributo_pf_w 	||
						' from '	|| nm_tabela_w 		|| ' a, '			||
								   nm_tabela_p 		|| ' b '			||
						' where a.'	|| nm_atributo_pk_ww 	|| ' = b.' || nm_atributo_refer_w 	||
						' and a.'	|| nm_atributo_pf_w 	|| ' = :PATIENT_ID ';
			else
				ds_comando_w := ds_comando_w ||
						' select b.'	|| nm_atributo_refer_w 	||
						' from '	|| nm_tabela_w 		|| ' a, '			||
								   nm_tabela_p 		|| ' b '			||
						' where a.'	|| nm_atributo_pk_ww 	|| ' = b.' || nm_atributo_refer_w 	||
						' and a.'	|| nm_atributo_pf_w 	|| ' = :PATIENT_ID ';
			end if;
		end if;
		end;

	end loop;
	close C03;
end;
end loop;
close C02;

if (ds_comando_w IS NOT NULL AND ds_comando_w::text <> '') then
	ds_comando_w := ds_comando_w || ') ';
end if;

if (coalesce(ds_comando_w::text, '') = '') then
	/* Se houver atributo para ligação com a ATENDIMENTO_PACIENTE */

	open c04;
	loop
	fetch c04 into
		nm_tabela_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		if (coalesce(ds_comando_w::text, '') = '' or ds_comando_w = '') then
			ds_comando_w := ' '||coalesce(nm_atributo_pk_w,'NR_ATENDIMENTO')||' in (';
		else
			ds_comando_w := ds_comando_w || ' union all ';
		end if;
		ds_comando_w := ds_comando_w ||
				' select b.'	|| coalesce(nm_atributo_pk_w,'NR_ATENDIMENTO') ||
				' from '	|| 'ATENDIMENTO_PACIENTE' || ' a, ' ||
						   nm_tabela_w 		|| ' b ' ||
				' where a.NR_ATENDIMENTO = b.NR_ATENDIMENTO ' ||
				' and a.CD_PESSOA_FISICA = :PATIENT_ID ) ';

	end loop;
	close c04;
end if;


return	ds_comando_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ligacao_pf_tabela (nm_tabela_p text) FROM PUBLIC;

