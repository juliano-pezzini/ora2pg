-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION recep_obter_auto_atend (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


ie_autorizado_w		varchar(1);
nr_seq_agenda_w		bigint;
qt_recep_ficha_w	bigint;
qt_autorizado_w		bigint;
qt_prescricao_w		bigint;


BEGIN

ie_autorizado_w := 'N';

if (coalesce(nr_atendimento_p,0) > 0) then

	select	max(a.nr_seq_agenda)
	into STRICT	nr_seq_agenda_w
	from    recep_ficha_pre_agenda a,
			recep_ficha_pre b
	where 	b.nr_atendimento = nr_atendimento_p
	and     a.nr_seq_ficha = b.nr_sequencia;

	if (coalesce(nr_seq_agenda_w,0) > 0) then

		select	count(*)
		into STRICT	qt_autorizado_w
		from 	autorizacao_convenio a,
				estagio_autorizacao b
		where	a.nr_seq_estagio	= b.nr_sequencia
		and		b.ie_interno		= '10'
		and		a.nr_seq_agenda		= nr_seq_agenda_w;

		if (qt_autorizado_w > 0) then
			ie_autorizado_w := 'S';
		end if;
	else

		select	count(*)
		into STRICT	qt_prescricao_w
		from 	prescr_medica
		where 	nr_atendimento = nr_atendimento_p;

		if (coalesce(qt_prescricao_w,0) > 0) then

			select	count(*)
			into STRICT	qt_autorizado_w
			from 	autorizacao_convenio a,
					estagio_autorizacao b,
					prescr_medica c
			where	a.nr_seq_estagio	= b.nr_sequencia
			and		b.ie_interno		= '10'
			and		a.nr_prescricao		= c.nr_prescricao
			and		c.nr_atendimento    = nr_atendimento_p;

			if (coalesce(qt_autorizado_w,0) > 0) then
				ie_autorizado_w := 'S';
			end if;
		end if;
	end if;
end if;

return	ie_autorizado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION recep_obter_auto_atend (nr_atendimento_p bigint) FROM PUBLIC;

