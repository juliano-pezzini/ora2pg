-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION mprev_obter_hor_marc_agenda ( cd_agenda_p bigint, dt_inicio_intervalo_p timestamp) RETURNS timestamp AS $body$
DECLARE

 
dt_fim_intervalo_w	timestamp := dt_inicio_intervalo_p + 30/1440;
dt_retorno_w		timestamp := dt_inicio_intervalo_p;
dt_fim_agendamento_w	timestamp;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;


BEGIN 
/* Horários agendados */
 
while(dt_retorno_w <= dt_fim_intervalo_w) loop 
 
	select	min(a.dt_agenda + a.nr_minuto_duracao/1440) 
	into STRICT	dt_fim_agendamento_w 
	from	mprev_agendamento a 
	where	a.cd_agenda		= cd_agenda_p 
	and	dt_retorno_w 		between a.dt_agenda and a.dt_agenda + (a.nr_minuto_duracao * (1/24/60)) - (60/86400) --decrementa 1 minuto 
	and	a.ie_status_agenda 	<> 'C';
 
	if (dt_fim_agendamento_w IS NOT NULL AND dt_fim_agendamento_w::text <> '') then 
		dt_retorno_w	:= dt_fim_agendamento_w;
	else 
		exit;
	end if;
end loop;
 
if (dt_retorno_w	= dt_inicio_intervalo_p) then 
	select	a.cd_estabelecimento 
	into STRICT	cd_estabelecimento_w 
	from	agenda a 
	where	a.cd_agenda	= cd_agenda_p;
 
	/* Sem horário cadastrado */
 
	while(dt_retorno_w <= dt_fim_intervalo_w) loop 
		 
		select	min(a.dt_horario_inicio + a.nr_minutos_duracao/1440) 
		into STRICT	dt_fim_agendamento_w 
		from	table(mprev_disp_agenda_pck.obter_horarios_indisp(null,null,null,cd_agenda_p,cd_estabelecimento_w,dt_inicio_intervalo_p,'SHD')) a 
		where	dt_retorno_w 		between a.dt_horario_inicio and a.dt_horario_inicio + (a.nr_minutos_duracao * (1/24/60)) - (60/86400); --decrementa 1 minuto 
		
		if (dt_fim_agendamento_w IS NOT NULL AND dt_fim_agendamento_w::text <> '') then 
			dt_retorno_w	:= dt_fim_agendamento_w;
		else 
			exit;
		end if;
	end loop;
end if;
 
return	dt_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION mprev_obter_hor_marc_agenda ( cd_agenda_p bigint, dt_inicio_intervalo_p timestamp) FROM PUBLIC;

