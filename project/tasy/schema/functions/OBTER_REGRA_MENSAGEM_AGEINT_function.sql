-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_mensagem_ageint ( cd_medico_p text, nr_proc_interno_p bigint, ie_tipo_agenda_p text, ie_tipo_dado_p text, cd_convenio_p bigint default null, ie_grupo_proced_p text default 'N', cd_agenda_p bigint default null, nr_seq_agenda_p bigint default null, ie_classificacao_p text default null, nr_seq_classif_p bigint default null, nr_seq_item_p bigint default null, cd_pessoa_fisica_p text default null) RETURNS varchar AS $body$
DECLARE


qt_regra_w		bigint;
nr_seq_regra_msg_w	bigint;
cd_medico_w		varchar(10);
ds_mensagem_w		varchar(4000);
ds_titulo_w		varchar(80);
qt_idade_w		bigint := 0;

ds_todas_mensagens_w	varchar(10000);
ds_retorno_w		varchar(4000) := '';
ie_classificacao_w	agenda_consulta.ie_classif_agenda%type;
nr_seq_classif_w	agenda_paciente.nr_seq_classif_agenda%type;
cd_convenio_w 		agenda_integrada.cd_convenio%type := 0;

C01 CURSOR FOR
	SELECT	substr((ds_mensagem),1,4000),
		ds_titulo_mensagem
	from	agenda_regra_mensagem
	where	coalesce(cd_medico,coalesce(cd_medico_p,'0'))	= coalesce(cd_medico_p,'0')
	and	coalesce(nr_seq_proc_interno,nr_proc_interno_p) = nr_proc_interno_p
	and	qt_idade_w between coalesce(qt_idade_min,qt_idade_w) and coalesce(qt_idade_max, qt_idade_w)
	and	ie_agenda_integrada = 'S'
	and	ie_agenda = ie_tipo_agenda_p
	and	((coalesce(dt_inicio_vigencia::text, '') = '') or (trunc(dt_inicio_vigencia) <= trunc(clock_timestamp())))
	and	((coalesce(dt_final_vigencia::text, '') = '') or (trunc(dt_final_vigencia) >= trunc(clock_timestamp())))
	and	coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0)
	and 	coalesce(ie_grupo_proced,'N') = ie_grupo_proced_p
	and	coalesce(cd_agenda,coalesce(cd_agenda_p,0))	= coalesce(cd_agenda_p,0)
	and	coalesce(ie_classif_agenda,coalesce(ie_classificacao_w,'0')) = coalesce(ie_classificacao_w,'0')
	and	coalesce(nr_seq_classif_agenda,coalesce(nr_seq_classif_w,0)) = coalesce(nr_seq_classif_w,0);
			

BEGIN
	
/*	Tipo
	T - Titulo
	M - Mensagem 	*/
ie_classificacao_w := ie_classificacao_p;
nr_seq_classif_w := nr_seq_classif_p;
cd_convenio_w := cd_convenio_p;

if (nr_seq_agenda_p > 0) then
	if (ie_tipo_agenda_p = 'C') and (coalesce(ie_classificacao_p::text, '') = '') then
		select 	max(ie_classif_agenda)
		into STRICT	ie_classificacao_w
		from 	agenda_consulta
		where 	nr_sequencia = nr_seq_agenda_p;
	end if;

	if (ie_tipo_agenda_p = 'E') and (coalesce(nr_seq_classif_p, 0) = 0) then
		select 	max(nr_seq_classif_agenda)
		into STRICT	nr_seq_classif_w
		from 	agenda_paciente
		where 	nr_sequencia = nr_seq_agenda_p;
	end if;
end if;

if (coalesce(cd_convenio_p, 0) = 0 and
  coalesce(nr_seq_item_p, 0) > 0) then
  select max(a.cd_convenio)
  into STRICT cd_convenio_w
  from agenda_integrada a,
      agenda_integrada_item b
  where a.nr_sequencia = b.nr_seq_agenda_int
  and b.nr_sequencia = nr_seq_item_p;
end if;

select	count(*)
into STRICT	qt_regra_w
from	agenda_regra_mensagem
where	ie_agenda_integrada = 'S'
and 	coalesce(ie_grupo_proced,'N') = ie_grupo_proced_p;

if (qt_regra_w > 0) then
	
	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	
		select	(obter_idade(dt_nascimento, clock_timestamp(), 'A'))::numeric
		into STRICT	qt_idade_w
		from	pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_p;
		
	end if;	
	
	open C01;
	loop
	fetch C01 into	
		ds_mensagem_w,
		ds_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_todas_mensagens_w := substr(ds_mensagem_w||' '||ds_todas_mensagens_w,1,10000);
		end;
	end loop;
	close C01;
		
	if (ie_tipo_dado_p = 'T') then
		ds_retorno_w	:= ds_titulo_w;
	elsif (ie_tipo_dado_p = 'M') then
		ds_retorno_w	:= ds_todas_mensagens_w;
	end if;
	
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_mensagem_ageint ( cd_medico_p text, nr_proc_interno_p bigint, ie_tipo_agenda_p text, ie_tipo_dado_p text, cd_convenio_p bigint default null, ie_grupo_proced_p text default 'N', cd_agenda_p bigint default null, nr_seq_agenda_p bigint default null, ie_classificacao_p text default null, nr_seq_classif_p bigint default null, nr_seq_item_p bigint default null, cd_pessoa_fisica_p text default null) FROM PUBLIC;

