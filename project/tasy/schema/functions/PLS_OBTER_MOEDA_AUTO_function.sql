-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_moeda_auto ( nr_seq_preco_auto_p pls_preco_autogerado.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type) RETURNS MOEDA.CD_MOEDA%TYPE AS $body$
DECLARE

			 
cd_especialidade_w		varchar(4000);
ie_valido_w			varchar(1);
cd_moeda_w			moeda.cd_moeda%type;
			
C01 CURSOR(	nr_seq_preco_auto_pc		pls_preco_autogerado.nr_sequencia%type) FOR 
	SELECT	a.cd_moeda, 
		a.nr_seq_grupo_servico, 
		a.nr_seq_grupo_prestador, 
		a.cd_especialidade_prest 
	from	pls_preco_regra_autogerado a 
	where	a.nr_seq_preco_auto = nr_seq_preco_auto_pc 
	order by 
		coalesce(a.nr_seq_grupo_servico,0), 
		coalesce(a.nr_seq_grupo_prestador,0), 
		coalesce(a.cd_especialidade_prest,0);

BEGIN 
 
cd_especialidade_w := substr(pls_obter_cod_espec_prest(nr_seq_prestador_p, null)||',',1,4000);
 
for r_C01_w in C01(nr_seq_preco_auto_p) loop 
	 
	ie_valido_w := 'S';
	 
	if (r_C01_w.nr_seq_grupo_servico IS NOT NULL AND r_C01_w.nr_seq_grupo_servico::text <> '') then 
		ie_valido_w := pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, cd_procedimento_p, ie_origem_proced_p);
	end if;
	 
	if (r_C01_w.nr_seq_grupo_prestador IS NOT NULL AND r_C01_w.nr_seq_grupo_prestador::text <> '') and (ie_valido_w = 'S') then 
		ie_valido_w := pls_obter_se_grupo_prestador(nr_seq_prestador_p, r_C01_w.nr_seq_grupo_prestador);
	end if;
	 
	if (r_C01_w.cd_especialidade_prest IS NOT NULL AND r_C01_w.cd_especialidade_prest::text <> '') and 
		not(cd_especialidade_w like('%'||r_c01_w.cd_especialidade_prest||',%')) then 
		ie_valido_w := 'N';
	end if;
	 
	if (ie_valido_w = 'S') then 
		cd_moeda_w := r_C01_w.cd_moeda;
	end if;
end loop;
 
return	cd_moeda_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_moeda_auto ( nr_seq_preco_auto_p pls_preco_autogerado.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type) FROM PUBLIC;

