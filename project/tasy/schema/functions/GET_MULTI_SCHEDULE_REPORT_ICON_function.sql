-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_multi_schedule_report_icon ( ie_status_agenda_p text, ie_encaixe_p text, cd_sexo_paciente_p text, ie_patient_allergic_p text, ie_paciente_isolado_p text, ie_delay_check_p text, cd_delaying_time_p bigint, ie_urgencia_cpoe_p bigint, ie_status_laudo_p text, nm_usuario_acesso_p text, ie_emergency_response_p text, dt_today_p text, ie_tipo_agenda_p text ) RETURNS varchar AS $body$
DECLARE


    ds_titulo_w                     varchar(255);
    cd_perfil_w                     perfil.cd_perfil%TYPE := wheb_usuario_pck.get_cd_perfil;
    nm_usuario_w                    usuario.nm_usuario%TYPE := wheb_usuario_pck.get_nm_usuario;
    cd_estabelecimento_w            estabelecimento.cd_estabelecimento%TYPE := wheb_usuario_pck.get_cd_estabelecimento;
    ie_show_emergency_response_w    varchar(1);
    ie_perform_mutual_exclusion_w   varchar(1);
    delay_percentage_w              bigint;
    qt_absent_w                     bigint := 0;
    qt_canceled_w                   bigint := 0;
    qt_confirmed_w                  bigint := 0;
    qt_patients_w                   bigint := 0;

BEGIN
    /*
    ie_tipo_agenda_p
    'SA' = getIconByIeStatusAgenda
    'SP' = getIconBySexoPaciente
    'AI' = getAllergiesIcon
    'II' = addIsolationIcon
    'DC' = addDelayCheckPercentageIcon
    'EC' = getIconByEmergenciaCPOE
    'SL' = getIconByStatusLaudo
    'UA' = getIconByUserAccess
    'ES' = getIconByEmergencyStatus
    */
    ie_show_emergency_response_w := obter_param_usuario(869, 465, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_show_emergency_response_w);
    ie_perform_mutual_exclusion_w := obter_param_usuario(869, 472, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_perform_mutual_exclusion_w);
    ds_titulo_w := '';

    --getIconByIeStatusAgenda
    IF ( ie_tipo_agenda_p = 'SA' ) THEN
        IF ( ie_status_agenda_p = 'A' ) THEN
            ds_titulo_w := 'clock-icon';
        ELSIF ( ie_status_agenda_p = 'AC' ) THEN
            ds_titulo_w := 'patient-clock-icon';
        ELSIF ( ie_status_agenda_p = 'AE' ) THEN
            ds_titulo_w := 'circular-arrow-clock-icon';
        ELSIF ( ie_status_agenda_p = 'E' ) THEN
            ds_titulo_w := 'check-icon';
        ELSIF ( ie_status_agenda_p = 'F' ) THEN
            ds_titulo_w := 'patient-cancel-icon';
        ELSIF ( ie_status_agenda_p = 'B' ) THEN
            ds_titulo_w := 'block-icon';
        ELSIF ( ie_status_agenda_p = 'C' ) THEN
            ds_titulo_w := 'cancel-icon';
        ELSIF ( ie_status_agenda_p = 'N' ) THEN
            ds_titulo_w := 'calendar-check-gray-icon';
        ELSIF ( ie_status_agenda_p = 'L' ) THEN
            ds_titulo_w := 'circle-stroke-icon';
        ELSIF ( ie_encaixe_p = 'S' ) THEN
            ds_titulo_w := 'fitting-icon';
        END IF;
    END IF;

    --getIconBySexoPaciente
    IF ( ie_tipo_agenda_p = 'SP' ) THEN
        IF ( cd_sexo_paciente_p = 'F' ) THEN
            ds_titulo_w := 'female-icon';
        ELSIF ( cd_sexo_paciente_p = 'M' ) THEN
            ds_titulo_w := 'male-icon';
        ELSIF ( cd_sexo_paciente_p = 'I' OR cd_sexo_paciente_p = 'D' ) THEN
            ds_titulo_w := 'transgender-icon';
        END IF;
    END IF;

    --getAllergiesIcon
    IF ( ie_tipo_agenda_p = 'AI' ) THEN
        IF ( ie_patient_allergic_p = 'S' ) THEN
            ds_titulo_w := 'allergies-warning-icon';
        END IF;
    END IF;

    --addIsolationIcon
    IF ( ie_tipo_agenda_p = 'II' ) THEN
        IF ( ie_paciente_isolado_p = 'S' ) THEN
            ds_titulo_w := 'patient-isolated-icon';
        END IF;
    END IF;

    --addDelayCheckPercentageIcon 
    IF ( ie_tipo_agenda_p = 'DC' ) THEN
        SELECT
            coalesce(MAX(nr_schedule_delay_percent), 0) delay_percentage
        INTO STRICT delay_percentage_w
        FROM
            parametro_agenda
        WHERE
            cd_estabelecimento = coalesce(cd_estabelecimento_w, 1);

        IF ( ie_delay_check_p = 'S' ) THEN
            IF ( delay_percentage_w > 0 ) THEN
                IF ( cd_delaying_time_p <= delay_percentage_w ) THEN
                    ds_titulo_w := 'patient-partial-icon';
                ELSIF ( cd_delaying_time_p <= 100 ) THEN
                    ds_titulo_w := 'patient-partial-yellow-icon';
                ELSE
                    ds_titulo_w := 'patient-partial-red-icon';
                END IF;

            END IF;
        END IF;

    END IF;

    --getIconByEmergenciaCPOE
    IF ( ie_tipo_agenda_p = 'EC' ) THEN
        IF ( ie_urgencia_cpoe_p = 0 ) THEN
            ds_titulo_w := 'major-warning-icon';
        END IF;
    END IF;

    --getIconByStatusLaudo
    IF ( ie_tipo_agenda_p = 'SL' ) THEN
        IF ( ie_status_laudo_p = 'LNL' ) THEN
            ds_titulo_w := 'report-circle-icon';
        ELSE
            IF ( ie_status_agenda_p = 'EP' ) THEN
                ds_titulo_w := 'patient-loop-icon';
            ELSIF ( ie_status_agenda_p = 'I' ) THEN
                ds_titulo_w := 'patient-interrogation-icon';
            ELSIF ( ie_status_agenda_p = 'AD' ) THEN
                IF ( ie_status_laudo_p = 'LL' ) THEN
                    ds_titulo_w := 'report-check-icon';
                ELSE
                    ds_titulo_w := 'patient-check-icon';
                END IF;
            ELSIF ( ie_status_agenda_p = 'EE' ) THEN
                ds_titulo_w := 'physician-partial-icon';
            END IF;
        END IF;
    END IF;

    --getIconByUserAccess
    IF ( ie_tipo_agenda_p = 'UA' ) THEN
        IF ( ie_perform_mutual_exclusion_w = 'S' AND (nm_usuario_acesso_p IS NOT NULL AND nm_usuario_acesso_p::text <> '') ) THEN
            ds_titulo_w := 'calendar-icon';
        END IF;
    END IF;
    
    --getIconByEmergencyStatus
    IF ( ie_tipo_agenda_p = 'ES' ) THEN
        IF ( ie_emergency_response_p = 'S' AND ie_show_emergency_response_w = 'A' OR ( ie_emergency_response_p = 'S' AND ie_show_emergency_response_w
        = 'C' AND dt_today_p = 'S' ) ) THEN
            ds_titulo_w := 'emergency-icon';
        END IF;
    END IF;

    RETURN ds_titulo_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_multi_schedule_report_icon ( ie_status_agenda_p text, ie_encaixe_p text, cd_sexo_paciente_p text, ie_patient_allergic_p text, ie_paciente_isolado_p text, ie_delay_check_p text, cd_delaying_time_p bigint, ie_urgencia_cpoe_p bigint, ie_status_laudo_p text, nm_usuario_acesso_p text, ie_emergency_response_p text, dt_today_p text, ie_tipo_agenda_p text ) FROM PUBLIC;

