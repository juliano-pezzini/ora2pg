-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_lib_mat_hor_gpt ( ie_tipo_usuario_p text, nm_tabela_p text, nr_seq_item_p bigint) RETURNS varchar AS $body$
DECLARE


ie_liberacao_w			varchar(1) := 'N';
nr_prescricao_w			prescr_medica.nr_prescricao%type;
	
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_perfil_w				perfil.cd_perfil%type;
nm_usuario_w			usuario.nm_usuario%type;
ie_urgente_regra_w		gpt_presentation_rule.ie_urgente%type;
	
ie_param_62_w			varchar(1);
ie_item_lib_hor_w		varchar(1);
ie_tipo_item_w			varchar(255);


BEGIN

ie_tipo_item_w := cpoe_obter_tipo_item(nm_tabela_p, nr_seq_item_p);

nr_prescricao_w := obter_prescr_item_cpoe(nr_seq_item_p, ie_tipo_item_w);

if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
	begin
		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_liberacao_w
		from	prescr_material
		where	((ie_tipo_usuario_p = 'E' and coalesce(dt_lib_enfermagem::text, '') = '') or (ie_tipo_usuario_p = 'F' and coalesce(dt_lib_farmacia::text, '') = '' and
				(dt_lib_enfermagem IS NOT NULL AND dt_lib_enfermagem::text <> '')))
		and		nr_prescricao = nr_prescricao_w
		and		nr_seq_mat_cpoe = nr_seq_item_p;

		cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
		cd_perfil_w := obter_perfil_ativo;
		nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

		ie_param_62_w := obter_param_usuario(252, 62, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_param_62_w);

		if (ie_liberacao_w = 'S') then
			
			if (coalesce(ie_param_62_w,'N') = 'S') then
				ie_item_lib_hor_w := obter_se_item_lib_hor_gpt(
					ie_tipo_item_p	=> ie_tipo_item_w,
					nr_seq_cpoe_p	=> nr_seq_item_p
				);
			
				if (ie_item_lib_hor_w = 'S') then
					ie_liberacao_w := 'N';
				end if;
			end if;

		elsif (ie_liberacao_w = 'N' and
				ie_param_62_w = 'N') then
			
			select	max(a.ie_urgente)
			into STRICT	ie_urgente_regra_w
			from	gpt_presentation_rule a
			where	a.cd_perfil = cd_perfil_w;

			select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
			into STRICT	ie_liberacao_w
			from	cpoe_material a
			where	a.nr_sequencia = nr_seq_item_p
			and		ie_urgente_regra_w = 'S'
			and		a.nr_ocorrencia = 1
			and		(a.ie_urgencia IS NOT NULL AND a.ie_urgencia::text <> '')
			and		((ie_tipo_usuario_p = 'E' and coalesce(a.dt_liberacao_enf::text, '') = '') or (ie_tipo_usuario_p = 'F' and coalesce(a.dt_liberacao_farm::text, '') = '' and (a.dt_liberacao_enf IS NOT NULL AND a.dt_liberacao_enf::text <> '')));
		end if;
	end;
end if;

return  ie_liberacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_lib_mat_hor_gpt ( ie_tipo_usuario_p text, nm_tabela_p text, nr_seq_item_p bigint) FROM PUBLIC;

