-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_regra_proc ( nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE
					
	 
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
ds_retorno_w		varchar(2) := 'S';
cd_grupo_proc_w		procedimento.cd_grupo_proc%type;
qt_reg_pac_w		bigint;
cd_procedimento_w	procedimento.cd_procedimento%type;
nr_seq_proc_int_w	prescr_procedimento.nr_seq_proc_interno%type;
qt_horas_passado_w	bigint;
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
C01 CURSOR FOR
	SELECT	obter_grupo_procedimento(a.cd_procedimento, a.ie_origem_proced, 'C'), 
		a.cd_procedimento, 
		a.nr_seq_proc_interno		 
	from 	prescr_procedimento a, 
		prescr_medica b 
	where 	a.nr_prescricao = b.nr_prescricao 
	and	b.nr_atendimento = nr_atendimento_p 
	and	b.dt_prescricao >= clock_timestamp() - (coalesce(qt_horas_passado_w, 1)/24);
	

BEGIN 
 
if (coalesce(nr_atendimento_p,0) > 0) then 
 
	begin 
		qt_horas_passado_w := obter_param_usuario(924, 29, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, qt_horas_passado_w);		
	exception 
	when others then 
		qt_horas_passado_w := 24;
	end;
 
	select 	max(cd_estabelecimento), 
		max(cd_pessoa_fisica) 
	into STRICT	cd_estabelecimento_w, 
		cd_pessoa_fisica_w 
	from 	atendimento_paciente 
	where	nr_atendimento = nr_atendimento_p;
 
	select 	count(*) 
	into STRICT 	qt_reg_pac_w 
	from 	PACIENTE_ACESSORIO 
	where 	cd_pessoa_fisica = cd_pessoa_fisica_w 
	and	ie_situacao = 'A' 
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
 
	if ( qt_reg_pac_w = 0) then	 
		open C01;
		loop 
		fetch C01 into	 
			cd_grupo_proc_w, 
			cd_procedimento_w, 
			nr_seq_proc_int_w;		
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin			 
			if ( ds_retorno_w = 'S') then		  
				select 	CASE WHEN count(*)=0 THEN  'S'  ELSE 'N' END  
				into STRICT	ds_retorno_w 
				from	REGRA_PROC_ORTESE_PROTESE				 
				where 	coalesce( CD_ESTABELECIMENTO, cd_estabelecimento_w ) = cd_estabelecimento_w 
				and	((CD_PROCEDIMENTO = cd_procedimento_w) or (coalesce(cd_procedimento::text, '') = '')) 
				and	((NR_SEQ_PROC_INTERNO = nr_seq_proc_int_w) or (coalesce(nr_seq_proc_interno::text, '') = '')) 
				and	((CD_GRUPO_PROC = cd_grupo_proc_w ) or (coalesce(cd_grupo_proc::text, '') = ''));
			end if;
			end;
		end loop;
		close C01;
	end if;	
end if;
		 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_regra_proc ( nr_atendimento_p bigint) FROM PUBLIC;

