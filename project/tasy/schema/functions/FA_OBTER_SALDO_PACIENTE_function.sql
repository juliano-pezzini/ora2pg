-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION fa_obter_saldo_paciente (nr_seq_rec_entr_p bigint, cd_material_p bigint, nm_usuario_p text) RETURNS bigint AS $body$
DECLARE


nr_saldo_w		bigint;
qt_dispensar_w		bigint;
nr_seq_receita_w	bigint;
dt_periodo_inicial_w	timestamp;
dt_periodo_final_w	timestamp;
cd_pessoa_fisica_w	bigint;

nr_seq_entrega_w	bigint;
dt_per_final_entr_w	timestamp;
qt_dias_saldo_w		bigint;

C01 CURSOR FOR
	SELECT 	max(nr_sequencia),
		max(dt_periodo_final)
	from	fa_entrega_medicacao
	where	nr_seq_receita_amb = nr_seq_receita_w
	and	trunc(dt_periodo_inicial_w) between trunc(dt_periodo_inicial) and trunc(dt_periodo_final)
	and	trunc(dt_periodo_final) >= trunc(clock_timestamp()) - qt_dias_saldo_w
	and	nr_sequencia <> coalesce(nr_seq_rec_entr_p,0)
	and	cd_pessoa_fisica = cd_pessoa_fisica_w
	and	((coalesce(nr_seq_motivo_canc::text, '') = '')
	or (fa_obter_se_consiste_saldo(coalesce(nr_seq_motivo_canc,0)) = 'S'));

C02 CURSOR FOR
	SELECT	max(e.nr_sequencia),
		max(e.dt_periodo_final)
	from	fa_entrega_medicacao_item i,
		fa_entrega_medicacao e
	where	i.nr_seq_fa_entrega = e.nr_sequencia
	and	i.cd_material  = cd_material_p
	and	trunc(dt_periodo_inicial_w) between trunc(e.dt_periodo_inicial) and trunc(e.dt_periodo_final)
	and	e.nr_sequencia <> coalesce(nr_seq_rec_entr_p,0)
	and	e.cd_pessoa_fisica = cd_pessoa_fisica_w
	and	((coalesce(e.nr_seq_motivo_canc::text, '') = '')
	         or (fa_obter_se_consiste_saldo(coalesce(i.nr_seq_motivo_canc,0)) = 'S'))
	and	((coalesce(i.nr_seq_motivo_canc::text, '') = '')
	         or (fa_obter_se_consiste_saldo(coalesce(i.nr_seq_motivo_canc,0)) = 'S'));



BEGIN
nr_saldo_w := 0;
qt_dispensar_w := 0;

qt_dias_saldo_w := obter_param_usuario(10015, 3, obter_perfil_ativo, nm_usuario_p, 0, qt_dias_saldo_w);

select 	e.dt_periodo_inicial,
	e.dt_periodo_final,
	e.nr_seq_receita_amb,
	cd_pessoa_fisica
into STRICT	dt_periodo_inicial_w,
	dt_periodo_final_w,
	nr_seq_receita_w,
	cd_pessoa_fisica_w
from	fa_entrega_medicacao e
where	e.nr_sequencia = nr_seq_rec_entr_p;

-- Consistir se ja houve entrega desse medicamento no periodo selecionada, sendo que
-- tem que ser a mesma receita
open C01;
loop
fetch C01 into
	nr_seq_entrega_w,
	dt_per_final_entr_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	if (dt_per_final_entr_w IS NOT NULL AND dt_per_final_entr_w::text <> '') then
		select 	sum(coalesce(h.qt_dose_dispensar,0))
		into STRICT	qt_dispensar_w
		from	fa_receita_farm_item_hor h,
			fa_receita_farmacia_item f,
			fa_entrega_medicacao e,
			fa_medic_farmacia_amb m
		where	e.nr_seq_receita_amb = f.nr_seq_receita
		and	f.nr_sequencia = h.nr_seq_fa_item
		and	e.nr_sequencia = nr_seq_entrega_w
		and	f.cd_material = m.cd_material
		and	f.cd_material = cd_material_p
		and	trunc(h.dt_horario) between trunc(dt_periodo_inicial_w) and trunc(dt_per_final_entr_w);

		nr_saldo_w := nr_saldo_w + qt_dispensar_w;
	end if;
	qt_dispensar_w := 0;
end loop;
close C01;

return	nr_saldo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION fa_obter_saldo_paciente (nr_seq_rec_entr_p bigint, cd_material_p bigint, nm_usuario_p text) FROM PUBLIC;

