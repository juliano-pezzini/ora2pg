-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_medispan_creatine_serum (nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%TYPE) RETURNS bigint AS $body$
DECLARE


	qt_creatinina_serica_w	pac_clereance_creatinina.qt_creatinina_serica%type;


BEGIN

	qt_creatinina_serica_w := 0;

	if (coalesce(nr_atendimento_p,0) > 0) then
		begin
			/* RETORNO DE INTEGRACAO LABORATORIAL */

			select 	max(to_number(trim(both resultado), '999999999D999999999', 'NLS_NUMERIC_CHARACTERS = ''.,'''))
			  into STRICT 	qt_creatinina_serica_w
			  from (
					SELECT 	b.dt_resultado,
							trim(both lab_obter_resultado_exame(a.nr_seq_resultado, a.nr_sequencia)) as resultado
					  from 	exame_lab_result_item a,
							exame_lab_resultado b,
							table(lista_pck.obter_lista(get_medispan_seq_exame_creatin('PAC_CLEREANCE_CREATININA', 'QT_CREATININA_SERICA', 20))) x
					 where 	a.nr_seq_resultado = b.nr_seq_resultado
					   and 	a.nr_seq_exame = x.nr_registro
					   and  b.nr_atendimento = nr_atendimento_p
					   and 	trim(both lab_obter_resultado_exame(a.nr_seq_resultado, a.nr_sequencia)) is not null
					 order by b.dt_resultado desc
					) alias12 LIMIT 1;
		exception
			when others then
				/* ALGUNS RESULTADOS DE EXAME VEM COM LETRAS E INVALIDA TODA A INTEGRACAO */

				qt_creatinina_serica_w := 0;
		end;

		/* CADASTRO DE ESCALAS E INDICES */

		if (coalesce(qt_creatinina_serica_w, 0) = 0) then
			select	max(qt_creatinina_serica)
			  into STRICT	qt_creatinina_serica_w
			  from	pac_clereance_creatinina
			 where	nr_sequencia	= (	SELECT	max(nr_sequencia)
										  from	pac_clereance_creatinina
										 where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
										   and 	coalesce(ie_situacao,'A') = 'A'
										   and	nr_atendimento = nr_atendimento_p);
		end if;
	end if;

	return coalesce(qt_creatinina_serica_w, 0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_medispan_creatine_serum (nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%TYPE) FROM PUBLIC;

