-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ds_hor_prox_adm ( nm_tabela_cpoe_p text, nm_rep_tabela_cpoe_p text, nm_rep_chave_cpoe_p text, nm_hor_tabela_rep_p text, nm_hor_chave_rep_p text, ds_sql_restricao_p text, nr_seq_reg_item_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(2000);
ds_sql_w			varchar(4000);
dt_fim_w			timestamp;


BEGIN

	if (nm_tabela_cpoe_p IS NOT NULL AND nm_tabela_cpoe_p::text <> '') then
	
		dt_fim_w := trunc(clock_timestamp() + interval '1 days', 'hh24') - 1 / 86400;
					
		if (nm_tabela_cpoe_p <> 'cpoe_hemoterapia') then
			ds_sql_w	:=
			' select 	max(cpoe_obter_prox_adm_grid_ang(nr_sequencia, ''M'', nm_usuario, nr_atendimento, ie_administracao, cd_intervalo, nvl(dt_prox_geracao, sysdate),  dt_inicio, dt_fim, ' ||
			' :nm_rep_tabela_cpoe, :nm_rep_chave_cpoe,:nm_hor_tabela_rep, :nm_hor_chave_rep, null, :dt_fim, 252))'  ||
			' from 		' || nm_tabela_cpoe_p ||
			' where 	nr_sequencia = :nr_seq_reg_item' ||
			' and		dt_liberacao is not null ' ||
			' and		dt_lib_suspensao is null ' ||
			ds_sql_restricao_p;
		
			begin			
				EXECUTE ds_sql_w
				into STRICT	ds_retorno_w
				using	nm_rep_tabela_cpoe_p,
						nm_rep_chave_cpoe_p,
						nm_hor_tabela_rep_p,
						nm_hor_chave_rep_p,
						dt_fim_w,
						nr_seq_reg_item_p;
			exception when others then
				null;
			end;
		else
			begin	
				select
					max(cpoe_obter_prox_adm_grid_ang(
						nr_sequencia, 'H', null, null, 'P', cd_intervalo, null, dt_programada, dt_fim, nm_rep_tabela_cpoe_p,
						nm_rep_chave_cpoe_p, nm_hor_tabela_rep_p, nm_hor_chave_rep_p, null, dt_fim_w, 252
					))
				into STRICT 	ds_retorno_w
				from	cpoe_hemoterapia
				where	nr_sequencia = nr_seq_reg_item_p
				and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and 	coalesce(dt_lib_suspensao::text, '') = '';
			exception when others then
				null;
			end;
		end if;		
	end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ds_hor_prox_adm ( nm_tabela_cpoe_p text, nm_rep_tabela_cpoe_p text, nm_rep_chave_cpoe_p text, nm_hor_tabela_rep_p text, nm_hor_chave_rep_p text, ds_sql_restricao_p text, nr_seq_reg_item_p bigint) FROM PUBLIC;

