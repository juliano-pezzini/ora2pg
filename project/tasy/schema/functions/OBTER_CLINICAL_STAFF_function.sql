-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_clinical_staff ( NR_SEQUENCIA_P bigint , PROF_P bigint ) RETURNS varchar AS $body$
DECLARE


data_w varchar(1000);
Primary_nurse  varchar(1000);
Attending_Physician  varchar(1000);
Assist_Physician varchar(1000);
Sec_nurse varchar(1000);
Param_S constant funcao_medico.ie_medico%type := 'S';
Param_N constant funcao_medico.ie_medico%type := 'N';

  i RECORD;

BEGIN

if (PROF_P=1) THEN -- Attending Physician
<<main_physician>>
for i in (SELECT obter_nome_pf(a.cd_profissional) as Attending_Physician
          from  usuario u RIGHT OUTER JOIN pessoa_fisica c ON c.cd_pessoa_fisica = u.cd_pessoa_fisica INNER JOIN atend_paciente_medico a
          ON a.cd_profissional = c.cd_pessoa_fisica INNER JOIN funcao_medico b ON a.nr_seq_func_medico = b.cd_funcao
          where
          a.nr_atendimento = NR_SEQUENCIA_P
          and b.IE_MEDICO =Param_S and b.IE_AUXILIAR = Param_N)
Loop

data_w := data_w ||',' ||i.Attending_Physician;


end Loop main_physician;
 end if;


IF (PROF_P=2) then --Nurse primary 
<<main_nurse>>
for i in (SELECT obter_nome_pf(a.cd_profissional) as Primary_nurse
          from  usuario u RIGHT OUTER JOIN pessoa_fisica c ON c.cd_pessoa_fisica = u.cd_pessoa_fisica INNER JOIN atend_paciente_medico a
          ON a.cd_profissional = c.cd_pessoa_fisica INNER JOIN funcao_medico b ON a.nr_seq_func_medico = b.cd_funcao
          where
          a.nr_atendimento = NR_SEQUENCIA_P
          and b.ie_enfermeira =Param_S and b.IE_AUXILIAR = Param_N )
Loop

data_w := data_w ||',' ||i.Primary_nurse;


end Loop main_nurse;
END if;

IF (PROF_P=3) then --Assist_Physician 
<<secondary_physician>>
for i in (SELECT obter_nome_pf(a.cd_profissional) as Assist_Physician
          from  usuario u RIGHT OUTER JOIN pessoa_fisica c ON c.cd_pessoa_fisica = u.cd_pessoa_fisica INNER JOIN atend_paciente_medico a
          ON a.cd_profissional = c.cd_pessoa_fisica INNER JOIN funcao_medico b ON a.nr_seq_func_medico = b.cd_funcao
          where
          a.nr_atendimento = NR_SEQUENCIA_P
          and b.IE_MEDICO =Param_S and b.IE_AUXILIAR = Param_S)
loop
data_w := data_w ||',' ||i.Assist_Physician;
end loop secondary_physician;

end if;

IF (PROF_P=4) then --Nurse Secondary 
<<secondary_nurse>>
for i in (SELECT obter_nome_pf(a.cd_profissional) as Sec_nurse
          from  usuario u RIGHT OUTER JOIN pessoa_fisica c ON c.cd_pessoa_fisica = u.cd_pessoa_fisica INNER JOIN atend_paciente_medico a
          ON a.cd_profissional = c.cd_pessoa_fisica INNER JOIN funcao_medico b ON a.nr_seq_func_medico = b.cd_funcao
          where
          a.nr_atendimento = NR_SEQUENCIA_P
          and b.ie_enfermeira =Param_S and b.IE_AUXILIAR = Param_S )
loop
data_w := data_w ||',' ||i.Sec_nurse;
end loop secondary_nurse;
end if;


  RETURN ltrim(data_w,',');
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_clinical_staff ( NR_SEQUENCIA_P bigint , PROF_P bigint ) FROM PUBLIC;

