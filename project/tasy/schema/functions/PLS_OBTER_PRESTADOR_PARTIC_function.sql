-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_prestador_partic ( nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type) RETURNS bigint AS $body$
DECLARE


ds_retorno_w		pls_proc_participante.nr_seq_prestador%type;

-- A prioridade de busca do participante se dá de acordo com o grau de participação, o cursor está ordenado do grau de menor prioridade para o de maior prioridade visto que o último registro será o retorno desta function.
c01 CURSOR( nr_seq_conta_proc_pc	pls_conta_proc.nr_sequencia%type) FOR
	SELECT	b.nr_seq_prestador
	FROM pls_grau_participacao a
LEFT OUTER JOIN pls_proc_participante b ON (a.nr_sequencia = b.nr_seq_grau_partic)
WHERE b.nr_seq_conta_proc 	= nr_seq_conta_proc_pc  and (b.nr_seq_prestador IS NOT NULL AND b.nr_seq_prestador::text <> '') -- O Cursor ordena 1º Sem grau de participação, 2º Com grau irrelevante, 3º Primeiro auxiliar, 4º Anestesista e 5º Cirurgião
 order by CASE WHEN coalesce(a.cd_tiss::text, '') = '' THEN  1 WHEN a.cd_tiss='01' THEN  3 WHEN a.cd_tiss='06' THEN  4 WHEN a.cd_tiss='00' THEN  5  ELSE 2 END;

BEGIN

for r_C01_w in C01( nr_seq_conta_proc_p ) loop
	ds_retorno_w := r_C01_w.nr_seq_prestador;
end loop;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_prestador_partic ( nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type) FROM PUBLIC;

