-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_totais_codificacao (nr_seq_catalogo_cod_p bigint, ie_opcao_p text, dt_inicio_p timestamp, dt_fim_p timestamp, ie_sexo_p text default null) RETURNS bigint AS $body$
DECLARE


c01 CURSOR FOR
	SELECT 	cd_cid_doenca
	from 	cat_ontologia_rel_cid
	where 	nr_seq_catalogo_cod = nr_seq_catalogo_cod_p;

cd_cid_doenca_w			cat_ontologia_rel_cid.cd_cid_doenca%type;
nr_total_w				bigint;
nr_count_w				bigint := 0;
nr_dias_internado_w		bigint := 0;


BEGIN

open c01;
loop
fetch c01 into
	cd_cid_doenca_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

		if (ie_opcao_p = 'T') then

			select 	count(x.nr_atendimento)
			into STRICT 	nr_total_w
			from 	atendimento_paciente x
			where 	nr_atendimento in (
					SELECT 	b.nr_atendimento
					from 	codificacao_atend_item a,
							codificacao_atendimento b
					where 	a.nr_seq_codificacao = b.nr_sequencia
					and		a.ie_classificacao = 'P'
					and		a.ie_tipo_item = 'D'
					and 	a.cd_doenca_cid = cd_cid_doenca_w)
			and (trunc(x.dt_entrada) between dt_inicio_p and dt_fim_p)
			and   	obter_sexo_pf(x.cd_pessoa_fisica, 'C') in ('M', 'F');

			nr_count_w := nr_count_w + nr_total_w;

		elsif (ie_opcao_p = 'S' and (ie_sexo_p IS NOT NULL AND ie_sexo_p::text <> '')) then

			select 	count(cd_pessoa_fisica)
			into STRICT 	nr_total_w
			from 	pessoa_fisica where cd_pessoa_fisica in (
					SELECT 	cd_pessoa_fisica from atendimento_paciente where nr_atendimento in (
						SELECT 	nr_atendimento
						from 	codificacao_atendimento
						where 	nr_sequencia in (select nr_seq_codificacao from codificacao_atend_item where ie_classificacao = 'P' and ie_tipo_item = 'D' and cd_doenca_cid = cd_cid_doenca_w)
					) and (trunc(dt_entrada) between dt_inicio_p and dt_fim_p)
			)
			and ie_sexo = ie_sexo_p;

			nr_count_w := nr_count_w + nr_total_w;

		elsif (ie_opcao_p = 'D') then

			select 	coalesce(sum(CASE WHEN(trunc(dt_alta) - trunc(dt_entrada))=0 THEN  1  ELSE (trunc(dt_alta) - trunc(dt_entrada)) END ), 0)
			into STRICT	nr_dias_internado_w
			from atendimento_paciente where nr_atendimento in (
				SELECT 	nr_atendimento
				from 	codificacao_atendimento
				where 	nr_sequencia in (SELECT nr_seq_codificacao from codificacao_atend_item where ie_classificacao = 'P' and ie_tipo_item = 'D' and cd_doenca_cid = cd_cid_doenca_w)
			)
			and (trunc(dt_entrada) between dt_inicio_p and dt_fim_p)
			and obter_sexo_pf(cd_pessoa_fisica, 'C') in ('M', 'F');

			nr_count_w := nr_count_w + nr_dias_internado_w;

		elsif (ie_opcao_p = 'O') then

			select 	count(cd_motivo_alta)
			into STRICT 	nr_total_w
			from 	motivo_alta where cd_motivo_alta in (
					SELECT 	cd_motivo_alta from atendimento_paciente where nr_atendimento in (
						SELECT 	nr_atendimento
						from 	codificacao_atendimento
						where 	nr_sequencia in (select nr_seq_codificacao from codificacao_atend_item where ie_classificacao = 'P' and ie_tipo_item = 'D' and cd_doenca_cid = cd_cid_doenca_w)
					)
					and (trunc(dt_entrada) between dt_inicio_p and dt_fim_p)
					and obter_sexo_pf(cd_pessoa_fisica, 'C') in ('M', 'F')
			)
			and coalesce(ie_obito, 'N') = 'S';

			nr_count_w := nr_count_w + nr_total_w;

		end if;

end loop;
close c01;


return nr_count_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_totais_codificacao (nr_seq_catalogo_cod_p bigint, ie_opcao_p text, dt_inicio_p timestamp, dt_fim_p timestamp, ie_sexo_p text default null) FROM PUBLIC;

