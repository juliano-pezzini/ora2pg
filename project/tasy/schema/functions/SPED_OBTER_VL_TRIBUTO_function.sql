-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sped_obter_vl_tributo ( nr_seq_superior_p bigint, cd_tributo_p bigint, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) RETURNS bigint AS $body$
DECLARE


vl_tributo_nota_w	double precision := 0;
vl_descontos_w		double precision;
qt_itens_nota_w		bigint;
vl_item_w		double precision := 0;
vl_rateio_w		double precision := 0;
vl_rateado_w		double precision := 0;
contador_w		bigint := 0;

c01 CURSOR FOR
	SELECT	b.vl_total_item_nf vl_item
	FROM operacao_nota o, nota_fiscal a, nota_fiscal_item b
LEFT OUTER JOIN material_fiscal c ON (b.cd_material = c.cd_material)
WHERE a.nr_sequencia  = b.nr_sequencia  and a.cd_operacao_nf = o.cd_operacao_nf and a.cd_estabelecimento	= cd_estabelecimento_p and b.vl_total_item_nf > 0 and o.ie_servico = 'S' and a.nr_sequencia = nr_seq_superior_p order by b.nr_item_nf;			
			

BEGIN

select	vl_descontos
into STRICT	vl_descontos_w
from	nota_fiscal
where	nr_sequencia = nr_seq_superior_p;

select	count(*)
into STRICT	qt_itens_nota_w
from	nota_fiscal_item
where	nr_sequencia = nr_seq_superior_p;

begin
  vl_rateio_w := vl_descontos_w / qt_itens_nota_w;
exception
when others then
  CALL wheb_mensagem_pck.exibir_mensagem_abort(1134036,'NR_SEQ_NOTA='|| nr_seq_superior_p);
end;

open c01;
loop
fetch c01 into	
	vl_item_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if (vl_item_w > vl_rateio_w) then
		vl_item_w := vl_item_w - vl_rateio_w;
		vl_rateado_w := vl_rateado_w + vl_rateio_w;
	end if;
	
	if (contador_w = qt_itens_nota_w) then
		if (vl_rateado_w < vl_descontos_w) then
			vl_item_w := vl_item_w + (vl_descontos_w - vl_rateado_w);
		elsif (vl_rateado_w > vl_descontos_w) then
			vl_item_w := vl_item_w + (vl_rateado_w - vl_descontos_w);
		end if;
	end if;
	
	vl_tributo_nota_w := vl_tributo_nota_w + round((vl_item_w * obter_pr_imposto(cd_tributo_p)) / 100,2);

	end;
end loop;
close c01;

return vl_tributo_nota_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sped_obter_vl_tributo ( nr_seq_superior_p bigint, cd_tributo_p bigint, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) FROM PUBLIC;

