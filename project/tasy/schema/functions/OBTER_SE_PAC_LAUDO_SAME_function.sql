-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_pac_laudo_same ( cd_pessoa_fisica_p text) RETURNS varchar AS $body$
DECLARE

 
cd_pessoa_fisica_w	varchar(10);
ds_retorno_w		varchar(2000) := null;
nr_sequencia_w		bigint;
nr_seq_loc_w		bigint;
ie_laudo_w		varchar(1) := 'N';
ie_retirado_w		varchar(1) := 'N';
nr_atendimento_w	bigint;
ds_atendimento_w	varchar(2000) := ' ';

c01 CURSOR FOR 
SELECT	nr_atendimento 
from	atendimento_paciente 
where	cd_pessoa_fisica = cd_pessoa_fisica_p;

 
c02 CURSOR FOR 
SELECT	nr_sequencia 
from	laudo_paciente 
where	nr_atendimento = nr_atendimento_w 
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

c03 CURSOR FOR 
SELECT	nr_sequencia, 
	cd_pessoa_fisica 
from	laudo_paciente_loc 
where	nr_sequencia = nr_sequencia_W;


BEGIN 
 
open c01;
loop 
	fetch c01 into 
		nr_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	ie_laudo_w := 'N';
	open c02;
	loop 
		fetch c02 into 
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		ie_laudo_w := 'S';
		ie_retirado_w := 'N';
		open c03;
		loop 
			fetch c03 into 
				nr_seq_loc_w, 
				cd_pessoa_fisica_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
			ie_retirado_w := 'N';
			if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
				ie_retirado_w := 'S';
			EXIT;
			end if;
		end loop;
		close c03;
  
		if (ie_retirado_w = 'S') then 
		exit;
		end if;
	end loop;
	close c02;
 
	if (ie_retirado_w = 'N') and (ie_laudo_w = 'S') and (length(ds_atendimento_w) < 1990) then 
		ds_atendimento_w := ds_atendimento_w ||' / '||to_char( nr_atendimento_w);
	end if;
end loop;
close c01;
 
if (ds_atendimento_w <> ' ') then 
	ds_retorno_w := substr(wheb_mensagem_pck.get_texto(347046) || ds_atendimento_w,1,2000);
end if;
 
return substr(ds_retorno_w,1,2000);
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_pac_laudo_same ( cd_pessoa_fisica_p text) FROM PUBLIC;

