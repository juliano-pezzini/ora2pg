-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_ds_componentes_rel ( cd_dieta_p bigint, ie_tipo_dieta_p text, cd_intervalo_p text, ie_administracao_p text, qt_dose_p bigint, cd_unidade_medida_p text, ie_continuo_p text, qt_tempo_aplic_p text, ie_bomba_infusao_p text, qt_vel_infusao_p text, nr_seq_objetivo_p bigint, ie_via_aplicacao_p text, ie_tipo_dosagem_p text default null, nr_seq_disp_succao_p bigint default null, ie_urgente_p text default null, qt_porcentagem_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(4000);

	function via_aplicacao return text is
	ds_retorno_ww	varchar(255);
	
BEGIN
		select	ds_via_aplicacao ds
		into STRICT		ds_retorno_ww
		from	via_aplicacao
		where	ie_via_aplicacao = ie_via_aplicacao_p;

		return ' ' || obter_desc_expressao(301661, '') || ' ' || ds_retorno_ww || ' ';
	end;

	function tipo_adm return varchar2 is
	begin
		if (ie_administracao_p = 'N' ) then
			return obter_desc_expressao(298074, '');
		elsif ( ie_administracao_p = 'C') then
			return obter_desc_expressao(689215, '');
		end if;

		return '';
	end;

	function dose_unidade_medidda return varchar2 is
		qt_dose_w  varchar2(30);
	begin
		qt_dose_w := qt_dose_p;

		if (substr(qt_dose_w,1,1) = ',') then
			qt_dose_w	:= '0' || qt_dose_w;

			qt_dose_w	:= replace(qt_dose_w,'.',',');
		end if;

		if (qt_porcentagem_p IS NOT NULL AND qt_porcentagem_p::text <> '') then
			return ' '|| qt_porcentagem_p || obter_desc_expressao(309212, '') || ' ' || qt_dose_w || ' ' ||  obter_dados_unid_medida(cd_unidade_medida_p, 'DS') || ' ';
		end if;

		return ' ' || qt_dose_w || ' ' ||  obter_dados_unid_medida(cd_unidade_medida_p, 'DS') || ' ';
	end;

	function desc_objetivo_jejum return varchar2 is
	ds_retorno_ww	varchar2(255);
	begin
		select	ds_objetivo
		into STRICT	ds_retorno_ww
		from	rep_objetivo_jejum
		where	nr_sequencia = nr_seq_objetivo_p;

		return obter_desc_expressao(327458, '') || ' ' || ds_retorno_ww;
	end;

	function desc_intervalo return varchar2 is
	begin
		if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
			return ' ' || obter_desc_expressao(292190, '') || ': ' ||obter_desc_intervalo(cd_intervalo_p) || ' ';
		end if;

		return '';
	end;

	function desc_continuo return varchar2 is
	begin
		if (ie_continuo_p = 'C' ) then
			return ' ' || obter_desc_expressao(608174, '') || ' ';
		elsif (ie_continuo_p = 'I') then
			return ' ' || obter_desc_expressao(292175, '') || ' ';
		end if;
		return '';
	end;

	function desc_bomba_infusao return varchar2 is
	begin
		if (ie_bomba_infusao_p <> 'N') then
			return ' ' || obter_valor_dominio(1537, ie_bomba_infusao_p) || ' ';
		end if;

		return '';
	end;

	function velocidade_infusao return varchar2 is
	ds_retorno_ww	varchar2(255);
	ie_via_sonda_w	varchar2(1);
	begin
		select	ie_via_sonda
		into STRICT	ie_via_sonda_w
		from	via_aplicacao
		where	ie_via_aplicacao = ie_via_aplicacao_p;


		if ((qt_vel_infusao_p IS NOT NULL AND qt_vel_infusao_p::text <> '') and (coalesce(ie_via_sonda_w, 'N') = 'S')) then

			ds_retorno_ww := qt_vel_infusao_p;

			if (substr(ds_retorno_ww,1,1) = ',') then
				ds_retorno_ww	:= '0' || ds_retorno_ww;
				ds_retorno_ww	:= replace(ds_retorno_ww,'.',',');
			end if;

			return ' ' || ds_retorno_ww || ' ' ||  ie_tipo_dosagem_p || ' ';
		end if;

		return '';
	end;

	function disp_succao return varchar2 is
	begin
		if (nr_seq_disp_succao_p IS NOT NULL AND nr_seq_disp_succao_p::text <> '') then
			return ' ' || obter_desc_disp_succao(nr_seq_disp_succao_p) || ' ';
		end if;

		return '';
	end;

	function quantidade_dose return varchar2 is
	begin
		if (qt_dose_p IS NOT NULL AND qt_dose_p::text <> '') then
			return ' ' || qt_dose_p || substr(obter_unid_med_dieta(cd_dieta_p),1,150) || ' ';
		end if;

		return '';
	end;

	function duracao_etapa return varchar2 is
		ie_via_sonda_w	varchar2(1);
	begin

		select	ie_via_sonda
		into STRICT	ie_via_sonda_w
		from	via_aplicacao
		where	ie_via_aplicacao = ie_via_aplicacao_p;

		if ((qt_tempo_aplic_p IS NOT NULL AND qt_tempo_aplic_p::text <> '') and (coalesce(ie_via_sonda_w,'N') = 'S')) then
			return ' ' || obter_desc_expressao(306433, '') || ' ' || qt_tempo_aplic_p || ' ';
		end if;

		return '';
	end;

	function ds_urgencia return varchar2 is
	begin
		if (ie_administracao_p = 'P') and (ie_urgente_p IS NOT NULL AND ie_urgente_p::text <> '') then
			return  ' ' || obter_valor_dominio(7069, ie_urgente_p)||' ';
		end if;

		return '';
	end;

begin

if (ie_tipo_dieta_p = 'O') then
	ds_retorno_w := quantidade_dose() || desc_intervalo() || ds_urgencia();
elsif (ie_tipo_dieta_p = 'S') then
   	ds_retorno_w := via_aplicacao() || tipo_adm() || dose_unidade_medidda() || desc_intervalo() || duracao_etapa() || velocidade_infusao() || desc_bomba_infusao || ds_urgencia();
elsif (ie_tipo_dieta_p = 'L') then
	ds_retorno_w :=  tipo_adm() || dose_unidade_medidda() ||  disp_succao()  ||'  ' ||desc_intervalo() || '  ' || desc_bomba_infusao || ds_urgencia();
elsif (ie_tipo_dieta_p = 'E') then
	ds_retorno_w := via_aplicacao() || tipo_adm() || dose_unidade_medidda() || desc_continuo || desc_intervalo() || qt_tempo_aplic_p || ' ' || desc_bomba_infusao || ' ' || velocidade_infusao || ds_urgencia();
elsif (ie_tipo_dieta_p = 'S') then
	ds_retorno_w := '';
elsif (ie_tipo_dieta_p = 'P')then
	ds_retorno_w := '';
elsif (ie_tipo_dieta_p = 'I') then
	ds_retorno_w := '';
elsif (ie_tipo_dieta_p = 'J') then
	ds_retorno_w := desc_objetivo_jejum;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_ds_componentes_rel ( cd_dieta_p bigint, ie_tipo_dieta_p text, cd_intervalo_p text, ie_administracao_p text, qt_dose_p bigint, cd_unidade_medida_p text, ie_continuo_p text, qt_tempo_aplic_p text, ie_bomba_infusao_p text, qt_vel_infusao_p text, nr_seq_objetivo_p bigint, ie_via_aplicacao_p text, ie_tipo_dosagem_p text default null, nr_seq_disp_succao_p bigint default null, ie_urgente_p text default null, qt_porcentagem_p bigint default null) FROM PUBLIC;

