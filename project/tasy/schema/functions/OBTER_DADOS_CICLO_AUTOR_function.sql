-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_ciclo_autor (nr_seq_autorizacao_p bigint, cd_material_p bigint, ie_opcao_p text, cd_material_informado_p bigint default null, qt_dose_total_quimio_p bigint default null) RETURNS varchar AS $body$
DECLARE


/*
IE_OPCAO:
DT - Dose Total
DP - Dose prescricao
DO - Dose
DU - Dias utilizacao
UM - Unidade medida dose
UMP - Unidade medida prescricao
DUDP - Dose Total com dias aplicacao
*/
ds_retorno_w			varchar(255) := '';
qt_dose_total_w			double precision;
qt_dose_prescricao_w		double precision;
qt_dose_w			double precision;
qt_dias_util_w			smallint;
cd_unid_med_dose_w		varchar(30);
nr_seq_paciente_setor_w		bigint;
nr_ciclo_w			smallint;
nr_seq_paciente_w		bigint;
cd_unid_med_prescr_w  		varchar(30);
ie_interno_w            estagio_autorizacao.ie_interno%type;

BEGIN

select	max(a.nr_seq_paciente_setor),
	max(a.nr_ciclo),
	max(a.nr_seq_paciente),
    max(e.ie_interno)
into STRICT	nr_seq_paciente_setor_w,
	nr_ciclo_w,
	nr_seq_paciente_w,
    ie_interno_w
FROM autorizacao_convenio a
LEFT OUTER JOIN estagio_autorizacao e ON (a.nr_seq_estagio = e.nr_sequencia)
WHERE a.nr_sequencia	= nr_seq_autorizacao_p;

select	sum(calcula_dose_total_quimio(qt_dose_prescricao,qt_dias_util,cd_intervalo)) qt_dose_total,
	sum(a.qt_dose_prescricao),
	sum(a.qt_dose),
	sum(a.qt_dias_util),
	max(a.cd_unid_med_dose),
    max(a.cd_unid_med_prescr)
into STRICT	qt_dose_total_w,
	qt_dose_prescricao_w,
	qt_dose_w,
	qt_dias_util_w,
	cd_unid_med_dose_w,
    cd_unid_med_prescr_w
from	paciente_atendimento b,
	paciente_atend_medic a
where	a.nr_seq_atendimento	= b.nr_seq_atendimento
and	b.nr_seq_paciente	= nr_seq_paciente_setor_w
and	((b.nr_seq_atendimento	= nr_seq_paciente_w) or (coalesce(nr_seq_paciente_w::text, '') = ''))
and	a.cd_material		= coalesce(cd_material_informado_p,cd_material_p)
and 	coalesce(b.dt_cancelamento::text, '') = ''
and	b.nr_ciclo		= nr_ciclo_w;

if (ie_opcao_p = 'DT') then
	ds_retorno_w := qt_dose_total_w;

elsif (ie_opcao_p = 'DP') then
	ds_retorno_w := qt_dose_prescricao_w;

elsif (ie_opcao_p = 'DO') then
	ds_retorno_w := qt_dose_w;

elsif (ie_opcao_p = 'DU') then
	ds_retorno_w := qt_dias_util_w;

elsif (ie_opcao_p = 'UM') then
	ds_retorno_w := cd_unid_med_dose_w;

elsif (ie_opcao_p = 'UMP') then
	ds_retorno_w := cd_unid_med_prescr_w;

elsif (ie_opcao_p = 'DUDP') then

        if   ie_interno_w = '70' and
            qt_dose_total_quimio_p > 0 then

            ds_retorno_w  := qt_dose_total_quimio_p;
        else
                ds_retorno_w := qt_dose_total_w;
        end if;

end if;

	if (SUBSTR(ds_retorno_w,0,1) = ',' or SUBSTR(ds_retorno_w,0,1) = '.') then
        	ds_retorno_w := '0' || ds_retorno_w;
    	end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_ciclo_autor (nr_seq_autorizacao_p bigint, cd_material_p bigint, ie_opcao_p text, cd_material_informado_p bigint default null, qt_dose_total_quimio_p bigint default null) FROM PUBLIC;

