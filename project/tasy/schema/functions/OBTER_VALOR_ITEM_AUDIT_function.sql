-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_item_audit (nr_interno_conta_p bigint, nr_seq_procedimento_p bigint, nr_seq_material_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/*  ie_opcao_p
Q	- Quantidade

*/
vl_retorno_w		double precision;
nr_seq_proc_audit_w	bigint;
qt_proc_origem_w	double precision;
qt_proc_audit_w		double precision;
qt_item_w		double precision;
qt_mat_origem_w		double precision;
qt_mat_audit_w		double precision;
nr_seq_mat_audit_w	bigint;
cd_material_w		material.cd_material%type;
cd_procedimento_w	procedimento.cd_procedimento%type;
ie_origem_proced_w	procedimento.ie_origem_proced%type;
				

BEGIN

if (coalesce(nr_seq_procedimento_p,0) > 0) then

	select	coalesce(max(qt_procedimento),0)
	into STRICT	qt_proc_origem_w
	from	procedimento_paciente
	where	nr_sequencia		= nr_seq_procedimento_p
	and	nr_interno_conta	= nr_interno_conta_p;
	
	select	max(nr_sequencia),
		max(cd_procedimento),
		max(ie_origem_proced)
	into STRICT	nr_seq_proc_audit_w,
		cd_procedimento_w,
		ie_origem_proced_w
	from	procedimento_paciente
	where	nr_seq_orig_audit	= nr_seq_procedimento_p
	and	nr_interno_conta	= nr_interno_conta_p;
	
	qt_item_w	:= qt_proc_origem_w;
	
	if (coalesce(nr_seq_proc_audit_w::text, '') = '') then
		select	coalesce(max(a.qt_procedimento),0)
		into STRICT	qt_proc_audit_w
		from	procedimento_paciente a
		where	a.cd_procedimento = cd_procedimento_w
		and	a.ie_origem_proced = ie_origem_proced_w
		and	nr_interno_conta	= nr_interno_conta_p
		and	a.qt_procedimento < 0
		and	exists (	SELECT	1
				from	auditoria_propaci x,
					auditoria_conta_paciente y
				where	x.nr_seq_auditoria = y.nr_sequencia
				and	y.nr_interno_conta = a.nr_interno_conta
				and	x.nr_seq_propaci = a.nr_sequencia
				and	x.qt_original < 0);
		
		qt_item_w	:= qt_proc_origem_w + qt_proc_audit_w;
	else

		select	coalesce(max(qt_procedimento),0)
		into STRICT	qt_proc_audit_w
		from	procedimento_paciente
		where	nr_seq_orig_audit	= nr_seq_procedimento_p
		and	nr_interno_conta	= nr_interno_conta_p;
		
		qt_item_w	:= qt_proc_origem_w + qt_proc_audit_w;
	end if;	

end if;

if (coalesce(nr_seq_material_p,0) > 0) then

	select	coalesce(max(qt_material),0),
		max(cd_material)
	into STRICT	qt_mat_origem_w,
		cd_material_w
	from	material_atend_paciente
	where	nr_sequencia		= nr_seq_material_p
	and	nr_interno_conta	= nr_interno_conta_p;
	
	select	max(nr_sequencia)		
	into STRICT	nr_seq_mat_audit_w		
	from	material_atend_paciente
	where	nr_seq_orig_audit	= nr_seq_material_p
	and	nr_interno_conta	= nr_interno_conta_p;
	
	qt_item_w	:= qt_mat_origem_w;
	
	if (coalesce(nr_seq_mat_audit_w::text, '') = '') then
		select	coalesce(max(a.qt_material),0)
		into STRICT	qt_mat_audit_w
		from	material_atend_paciente a
		where	a.cd_material = cd_material_w
		and	a.nr_interno_conta = nr_interno_conta_p
		and	a.qt_material < 0
		and	exists (	SELECT	1
				from	auditoria_matpaci x,
					auditoria_conta_paciente y
				where	x.nr_seq_auditoria = y.nr_sequencia
				and	y.nr_interno_conta = a.nr_interno_conta
				and	x.nr_seq_matpaci = a.nr_sequencia
				and	x.qt_original < 0);
		
		qt_item_w	:= qt_mat_origem_w + qt_mat_audit_w;
		
	else

		select	coalesce(max(qt_material),0)
		into STRICT	qt_mat_audit_w
		from	material_atend_paciente
		where	nr_seq_orig_audit	= nr_seq_material_p
		and	nr_interno_conta	= nr_interno_conta_p;	
		
		qt_item_w	:= qt_mat_origem_w + qt_mat_audit_w;
	end if;

end if;

if (ie_opcao_p = 'Q') then
	return 	qt_item_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_item_audit (nr_interno_conta_p bigint, nr_seq_procedimento_p bigint, nr_seq_material_p bigint, ie_opcao_p text) FROM PUBLIC;

