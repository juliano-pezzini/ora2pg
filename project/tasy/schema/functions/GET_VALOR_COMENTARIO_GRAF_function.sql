-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_valor_comentario_graf ( nr_cirurgia_p bigint, nr_seq_registro_p bigint, nm_tabela_p text, nm_campo_p text, ie_etapa_p text default 'I') RETURNS varchar AS $body$
DECLARE

				
ds_resultado_w varchar(1000);

c_observ_registro CURSOR FOR
SELECT 	substr(obter_nome_pf(b.cd_profissional)
		|| ' - ' ||
		b.ds_observao,1,1000) ds_observao
from 	revisao_cirurgia a,
		revisao_cirurgia_obs b 
where 	a.nr_seq_origem 	= nr_seq_registro_p
and 	upper(a.ie_tabela_referencia) = upper(nm_tabela_p)
and 	a.nr_cirurgia = nr_cirurgia_p
and 	a.nr_sequencia = b.nr_seq_revisao		
and 	coalesce(a.dt_inativacao::text, '') = ''
and 	coalesce(a.ie_situacao, 'A') =  'A'
and 	coalesce(b.ie_situacao, 'A') =  'A'
and 	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
and     coalesce(b.ie_etapa, 'I') = ie_etapa_p;

c_observ_registro_campo CURSOR FOR
SELECT 	substr(obter_nome_pf(b.cd_profissional)
		|| ' - ' ||
		b.ds_observao,1,1000) ds_observao
from 	revisao_cirurgia a,
		revisao_cirurgia_obs b 
where 	a.nr_seq_origem 	= nr_seq_registro_p
and 	upper(a.ie_tabela_referencia) = upper(nm_tabela_p)
and 	a.nr_cirurgia = nr_cirurgia_p
and 	a.ie_campo_ref_valor = nm_campo_p
and 	a.nr_sequencia = b.nr_seq_revisao		
and 	coalesce(a.dt_inativacao::text, '') = ''
and 	coalesce(a.ie_situacao, 'A') =  'A'
and 	coalesce(b.ie_situacao, 'A') =  'A'
and 	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
and     coalesce(b.ie_etapa, 'I') = ie_etapa_p;
BEGIN
if (coalesce(nm_campo_p::text, '') = '') then
ds_resultado_w:= null;
<<read_c_observ_registro>>
for r_observ_registro in c_observ_registro
	loop	
	ds_resultado_w:= ds_resultado_w || r_observ_registro.ds_observao || '<br>';
	end loop read_c_observ_registro;
else
  <<read_c_observ_registro_campo>>
  for r_observ_registro_campo in c_observ_registro_campo
	loop	
	ds_resultado_w:= ds_resultado_w || r_observ_registro_campo.ds_observao || '<br>';
	end loop read_c_observ_registro_campo;
end if;	
	
return	ds_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_valor_comentario_graf ( nr_cirurgia_p bigint, nr_seq_registro_p bigint, nm_tabela_p text, nm_campo_p text, ie_etapa_p text default 'I') FROM PUBLIC;

