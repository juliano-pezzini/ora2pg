-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ptu_obter_tipo_interc_a500 ( nr_seq_conta_p pls_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type ) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_tipo_intercambio_w		varchar(10);
nr_seq_congenere_w		pls_segurado.nr_seq_congenere%type;
ie_tipo_contrato_w		pls_intercambio.ie_tipo_contrato%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
sg_estado_w			pessoa_juridica.sg_estado%type;
sg_estado_int_w			pessoa_juridica.sg_estado%type;


BEGIN
select	coalesce(max(c.nr_seq_ops_congenere), max(c.nr_seq_congenere)),
	max(c.nr_sequencia)
into STRICT	nr_seq_congenere_w,
	nr_seq_segurado_w
from	pls_segurado		c,
	pls_conta		b
where	c.nr_sequencia	= b.nr_seq_segurado
and	b.nr_sequencia	= nr_seq_conta_p;

ie_tipo_intercambio_w	:= 'A';

if (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '') then
	-- Obter a UF da operadora  - Tasy
	select	coalesce(max(sg_estado),'X')
	into STRICT	sg_estado_w
	from	pessoa_juridica
	where	cd_cgc	=	(SELECT	max(cd_cgc_outorgante)
				from	pls_outorgante
				where	cd_estabelecimento	= cd_estabelecimento_p);

	-- Obter a UF da operadora do beneficiário eventual ou que enviou o protocolo
	select	coalesce(max(a.sg_estado),'X')
	into STRICT	sg_estado_int_w
	from	pessoa_juridica	a,
		pls_congenere	b
	where	a.cd_cgc	= b.cd_cgc
	and	b.nr_sequencia	= nr_seq_congenere_w;

	if (sg_estado_w <> 'X') and (sg_estado_int_w <> 'X') then
		if (sg_estado_w	= sg_estado_int_w) then
			ie_tipo_intercambio_w	:= 'E';
		else
			ie_tipo_intercambio_w	:= 'N';
		end if;
	else
		ie_tipo_intercambio_w	:= 'A';
	end if;
end if;

if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then
	select	max(a.ie_tipo_contrato)
	into STRICT	ie_tipo_contrato_w
	from	pls_intercambio a,
		pls_contrato_pagador b,
		pls_segurado c
	where	a.nr_sequencia	= b.nr_seq_pagador_intercambio
	and	b.nr_sequencia	= c.nr_seq_pagador
	and	c.nr_sequencia	= nr_seq_segurado_w;

	-- Quando for PEA, tem que tratar como Nacional
	if (ie_tipo_contrato_w = 'S') then
		ie_tipo_intercambio_w	:= 'N';
	end if;
end if;

return	ie_tipo_intercambio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ptu_obter_tipo_interc_a500 ( nr_seq_conta_p pls_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type ) FROM PUBLIC;

