-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_pag_venc_trib ( nr_seq_pag_prest_trib_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  X]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/ds_retorno_w		double precision;
nr_seq_lote_w		bigint;
nr_seq_prestador_w	bigint;
cd_tributo_w		bigint;
dt_competencia_w	timestamp;
ie_venc_pls_pag_prod_w	tributo.ie_venc_pls_pag_prod%type;
ie_vencimento_w		tributo.ie_vencimento%type;
dt_venc_lote_w		timestamp;


BEGIN
if (ie_opcao_p = 'VROM') then
	select	max(c.nr_seq_lote),
		max(c.nr_seq_prestador),
		max(d.dt_mes_competencia),
		max(a.cd_tributo),
		max(z.ie_venc_pls_pag_prod),
		max(z.ie_vencimento),
		max(b.dt_vencimento)
	into STRICT	nr_seq_lote_w,
		nr_seq_prestador_w,
		dt_competencia_w,
		cd_tributo_w,
		ie_venc_pls_pag_prod_w,		-- 'C' = Data de competência do pagamento de produção	/	'V' = Data do vencimento do pagamento de produção
		ie_vencimento_w,
		dt_venc_lote_w
	from	tributo				z,
		pls_pag_prest_venc_trib		a,
		pls_pag_prest_vencimento	b,
		pls_pagamento_prestador		c,
		pls_lote_pagamento		d
	where	b.nr_sequencia			= a.nr_seq_vencimento
	and	c.nr_sequencia			= b.nr_seq_pag_prestador
	and	d.nr_sequencia			= c.nr_seq_lote
	and	a.cd_tributo			= z.cd_tributo
	and	a.nr_sequencia			= nr_seq_pag_prest_trib_p;

	/* Se o campo 'Dt base venc pag prod (OPS)' no cadastro do tributo no SHIFT + F11 estiver como 'Data de competência do pagamento de produção' ou o mesmo esteja nulo e o campo 'O venc do tributo não gerado pela NF se baseia no' estiver como:
			R - Registro compromisso	OU	B - Data da baixa (quando o tributo for gerado pela baixa)	 OU	S - Data da baixa (quando trib gerado na baixa) ou Vencimento título  */
	if	((coalesce(ie_venc_pls_pag_prod_w,'X') = 'C') or ((coalesce(ie_venc_pls_pag_prod_w::text, '') = '') and (ie_vencimento_w in ( 'R' , 'B' , 'S' )))) then
		dt_venc_lote_w		:= null;

	/* ELSIF	Se o campo 'Dt base venc pag prod (OPS)' no cadastro do tributo no SHIFT + F11 estiver como 'Data do vencimento do pagamento de produção' ou se o mesmo esteja nulo e o campo 'O venc do tributo não gerado pela NF se baseia no' estiver como:
			V - Vencimento título	OU	C - Data contábil ou Reg. compromisso */
	elsif	((coalesce(ie_venc_pls_pag_prod_w,'X') = 'V') or ((coalesce(ie_venc_pls_pag_prod_w::text, '') = '') and (ie_vencimento_w in ( 'V' , 'C' )))) then
		dt_competencia_w	:= null;
	end if;

	select	coalesce(sum(a.vl_imposto), 0) vl_imposto
	into STRICT	ds_retorno_w
	from	pls_pag_prest_venc_trib		a,
		pls_pag_prest_vencimento	b,
		pls_pagamento_prestador		c,
		pls_lote_pagamento		d
	where	b.nr_sequencia			= a.nr_seq_vencimento
	and	c.nr_sequencia			= b.nr_seq_pag_prestador
	and	d.nr_sequencia			= c.nr_seq_lote
	and	a.cd_tributo			= cd_tributo_w
	and	c.nr_seq_prestador 		= nr_seq_prestador_w
	and	d.ie_status 			= 'D'
	and	a.ie_pago_prev 	in ('R', 'P', 'S', 'V')
	and	(((coalesce(dt_venc_lote_w::text, '') = '') and (trunc(d.dt_mes_competencia, 'month') = trunc(dt_competencia_w, 'month'))) or
		((coalesce(dt_competencia_w::text, '') = '') and (trunc(b.dt_vencimento, 'month') = trunc(dt_venc_lote_w, 'month'))))
	and	c.nr_seq_lote <> nr_seq_lote_w;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_pag_venc_trib ( nr_seq_pag_prest_trib_p bigint, ie_opcao_p text) FROM PUBLIC;

