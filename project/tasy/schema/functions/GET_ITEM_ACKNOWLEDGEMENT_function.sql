-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_item_acknowledgement ( nr_seq_cpoe_p bigint, ie_opcao_p text, nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


nr_prescricao_w			prescr_medica.nr_prescricao%type;
nr_seq_item_w			prescr_procedimento.nr_sequencia%type;
nr_seq_proc_interno_w	prescr_procedimento.nr_prescricao%type;
cd_material_w			prescr_material.nr_prescricao%type;
qt_done_w				bigint;
qt_undone_w				bigint;
qt_done_material_w		bigint;
qt_undone_material_w	bigint;
nr_sequencia_w			prescr_mat_alteracao.nr_sequencia%type;
nm_enfermeira_w			varchar(255);
ds_retorno_w			varchar(255);


BEGIN
if (ie_opcao_p	= 'P') then /*exams and procedures*/
	select	max(a.nr_prescricao) nr_prescricao,
			max(b.nr_sequencia) nr_seq_item,
			max(b.nr_seq_proc_interno) nr_seq_proc_interno
    into STRICT	nr_prescricao_w,
			nr_seq_item_w,
			nr_seq_proc_interno_w
	from    prescr_procedimento b,
			prescr_medica a
	where	b.nr_seq_proc_cpoe = nr_seq_cpoe_p
	and		b.nr_prescricao = a.nr_prescricao
	and		a.nr_atendimento = nr_atendimento_p;

	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') and (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then
	
		select	count(*)
		into STRICT	qt_done_w
		from	prescr_mat_alteracao
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_procedimento = nr_seq_item_w
		and		nr_seq_proc_interno = nr_seq_proc_interno_w
		and		ie_alteracao in (64,63)
		and		ie_tipo_item in ('P','G','C','I','L');
		
		select	count(*)
		into STRICT	qt_undone_w
		from	prescr_mat_alteracao
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_procedimento = nr_seq_item_w
		and		nr_seq_proc_interno = nr_seq_proc_interno_w
		and		ie_alteracao in (82)
		and		ie_tipo_item in ('P','G','C','I','L');

		if (qt_done_w IS NOT NULL AND qt_done_w::text <> '') then
		
			select	max(nr_sequencia)
			into STRICT	nr_sequencia_w
			from	prescr_mat_alteracao
			where	nr_prescricao = nr_prescricao_w
			and		nr_seq_procedimento = nr_seq_item_w
			and		nr_seq_proc_interno = nr_seq_proc_interno_w
			and		ie_alteracao in (64,63)
			and		ie_tipo_item in ('P','G','C','I','L');

			select	obter_nome_pf(cd_pessoa_fisica)
			into STRICT	nm_enfermeira_w
			from	prescr_mat_alteracao
			where	nr_sequencia = nr_sequencia_w;

		end if;

		if (qt_done_w > qt_undone_w) and (nm_enfermeira_w IS NOT NULL AND nm_enfermeira_w::text <> '') then
			ds_retorno_w := wheb_mensagem_pck.get_texto(1145993, 'NM_ENFERMEIRA=' || nm_enfermeira_w);
		end if;

	end if;

elsif (ie_opcao_p	= 'MA') then /*materiais*/
	select	max(a.nr_prescricao) nr_prescricao,
			max(b.nr_sequencia) nr_seq_item,
			max(b.cd_material) cd_material
	into STRICT	nr_prescricao_w,
			nr_seq_item_w,
			cd_material_w
	from	prescr_material b,
			prescr_medica a
	where	b.nr_seq_mat_cpoe = nr_seq_cpoe_p
	and 	b.nr_prescricao = a.nr_prescricao
	and 	b.ie_checar_adep = 'S'
	and		a.nr_atendimento = nr_atendimento_p;
	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') and (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then

		select	count(*)
		into STRICT	qt_done_w
		from	prescr_mat_alteracao
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_prescricao = nr_seq_item_w
		and		cd_item = cd_material_w
		and		ie_tipo_item in ('M','MAT','S')
		and		ie_alteracao in (64,63);

		select	count(*)
		into STRICT	qt_undone_w
		from	prescr_mat_alteracao
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_prescricao = nr_seq_item_w
		and		cd_item = cd_material_w
		and		ie_tipo_item in ('M','MAT','S')
		and		ie_alteracao in (82);
		
		if (qt_done_w IS NOT NULL AND qt_done_w::text <> '') then
		
			select	max(nr_sequencia)
			into STRICT    nr_sequencia_w
			from	prescr_mat_alteracao
			where	nr_prescricao = nr_prescricao_w
			and		nr_seq_prescricao = nr_seq_item_w
			and		cd_item = cd_material_w
			and		ie_tipo_item in ('M','MAT','S')
			and		ie_alteracao in (64,63);

			select	obter_nome_pf(cd_pessoa_fisica)
			into STRICT	nm_enfermeira_w
			from	prescr_mat_alteracao
			where	nr_sequencia = nr_sequencia_w;

		end if;

		if (qt_done_w > qt_undone_w) and (nm_enfermeira_w IS NOT NULL AND nm_enfermeira_w::text <> '') then
			ds_retorno_w := wheb_mensagem_pck.get_texto(1145993, 'NM_ENFERMEIRA=' || nm_enfermeira_w);
		end if;

	end if;

elsif (ie_opcao_p	= 'N') then /*dieta*/
	select	min(a.nr_prescricao) nr_prescricao
	into STRICT	nr_prescricao_w
	from	prescr_dieta b,
			prescr_medica a
	where	b.nr_seq_dieta_cpoe = nr_seq_cpoe_p
	and		b.nr_prescricao = a.nr_prescricao
	and		a.nr_atendimento = nr_atendimento_p;
	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then

		select	count(*)
		into STRICT	qt_done_w
		from	prescr_mat_alteracao
		where	nr_prescricao = nr_prescricao_w
		and		ie_tipo_item = 'D'
		and		ie_alteracao in (64,63);

		select	count(*)
		into STRICT	qt_undone_w
		from	prescr_mat_alteracao
		where	nr_prescricao = nr_prescricao_w
		and		ie_tipo_item = 'D'
		and		ie_alteracao in (82);
		
		if (qt_done_w IS NOT NULL AND qt_done_w::text <> '') then
		
			select	max(nr_sequencia)
			into STRICT    nr_sequencia_w
			from	prescr_mat_alteracao
			where	nr_prescricao = nr_prescricao_w
			and		ie_tipo_item = 'D'
			and		ie_alteracao in (64,63);

			select	obter_nome_pf(cd_pessoa_fisica)
			into STRICT	nm_enfermeira_w
			from	prescr_mat_alteracao
			where	nr_sequencia = nr_sequencia_w;

		end if;

		if (qt_done_w > qt_undone_w) and (nm_enfermeira_w IS NOT NULL AND nm_enfermeira_w::text <> '') then
			ds_retorno_w := wheb_mensagem_pck.get_texto(1145993, 'NM_ENFERMEIRA=' || nm_enfermeira_w);
		end if;

	end if;

elsif (ie_opcao_p	= 'R') then  /* recomendacao */
	select	max(a.nr_prescricao) nr_prescricao,
			max(b.nr_sequencia) nr_seq_item
	into STRICT	nr_prescricao_w,
			nr_seq_item_w
	from	prescr_recomendacao b,
			prescr_medica a
	where	b.nr_seq_rec_cpoe = nr_seq_cpoe_p
	and 	b.nr_prescricao = a.nr_prescricao
	and		a.nr_atendimento = nr_atendimento_p;
	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') then

		select	count(*)
		into STRICT	qt_done_w
		from	prescr_mat_alteracao
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_prescricao = nr_seq_item_w
		and		ie_tipo_item = 'R'
		and		ie_alteracao in (64,63);

		select	count(*)
		into STRICT	qt_undone_w
		from	prescr_mat_alteracao
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_prescricao = nr_seq_item_w
		and		ie_tipo_item = 'R'
		and		ie_alteracao in (82);
		
		if (qt_done_w IS NOT NULL AND qt_done_w::text <> '') then
		
			select	max(nr_sequencia)
			into STRICT    nr_sequencia_w
			from	prescr_mat_alteracao
			where	nr_prescricao = nr_prescricao_w
			and		nr_seq_prescricao = nr_seq_item_w
			and		ie_tipo_item = 'R'
			and		ie_alteracao in (64,63);

			select	obter_nome_pf(cd_pessoa_fisica)
			into STRICT	nm_enfermeira_w
			from	prescr_mat_alteracao
			where	nr_sequencia = nr_sequencia_w;

		end if;

		if (qt_done_w > qt_undone_w) and (nm_enfermeira_w IS NOT NULL AND nm_enfermeira_w::text <> '') then
			ds_retorno_w := wheb_mensagem_pck.get_texto(1145993, 'NM_ENFERMEIRA=' || nm_enfermeira_w);
		end if;

	end if;

elsif (ie_opcao_p	= 'H') then /* hemoterapia */
	select	max(a.nr_prescricao) nr_prescricao,
			max(b.nr_sequencia) nr_seq_item
	into STRICT	nr_prescricao_w,
			nr_seq_item_w
	from	prescr_procedimento b,
			prescr_medica a
	where	b.nr_seq_proc_cpoe = nr_seq_cpoe_p
	and		b.nr_prescricao = a.nr_prescricao
	and		a.nr_atendimento = nr_atendimento_p;

	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') then

		select	count(*)
		into STRICT	qt_done_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_procedimento = nr_seq_item_w
		and		ie_alteracao in (59,60);

		select	count(*)
		into STRICT	qt_undone_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_procedimento = nr_seq_item_w
		and		ie_alteracao in (61);
		
		if (qt_done_w IS NOT NULL AND qt_done_w::text <> '') then
		
			select	max(nr_sequencia)
			into STRICT    nr_sequencia_w
			from	prescr_solucao_evento
			where	nr_prescricao = nr_prescricao_w
			and		nr_seq_procedimento = nr_seq_item_w
			and		ie_alteracao in (59,60);

			select	obter_nome_pf(Obter_Cod_PF_Usuario(nm_usuario))
			into STRICT	nm_enfermeira_w
			from	prescr_solucao_evento
			where	nr_sequencia = nr_sequencia_w;

		end if;

		if (qt_done_w > qt_undone_w) and (nm_enfermeira_w IS NOT NULL AND nm_enfermeira_w::text <> '') then
			ds_retorno_w := wheb_mensagem_pck.get_texto(1145993, 'NM_ENFERMEIRA=' || nm_enfermeira_w);
		end if;

	end if;

elsif (ie_opcao_p	= 'G') then /* gasoterapia */
	select	max(a.nr_prescricao) nr_prescricao,
			max(b.nr_sequencia) nr_seq_item
	into STRICT	nr_prescricao_w,
			nr_seq_item_w
	from	prescr_gasoterapia b,
			prescr_medica a
	where	b.nr_seq_gas_cpoe = nr_seq_cpoe_p
	and		b.nr_prescricao = a.nr_prescricao
	and		a.nr_atendimento = nr_atendimento_p;

	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') then

		select	count(*)
		into STRICT	qt_done_w
		from	prescr_gasoterapia_evento
		where	nr_seq_gas_cpoe = nr_seq_cpoe_p
		and		nr_seq_gasoterapia = nr_seq_item_w
		and		ie_evento in ('SA','NA');

		select	count(*)
		into STRICT	qt_undone_w
		from	prescr_gasoterapia_evento
		where	nr_seq_gas_cpoe = nr_seq_cpoe_p
		and		nr_seq_gasoterapia = nr_seq_item_w
		and		ie_evento = 'DA';
		
		if (qt_done_w IS NOT NULL AND qt_done_w::text <> '') then

			select	max(nr_sequencia)
            into STRICT    nr_sequencia_w
            from    prescr_gasoterapia_evento
            where   nr_seq_gas_cpoe = nr_seq_cpoe_p
            and     nr_seq_gasoterapia = nr_seq_item_w
            and     ie_evento in ('SA','NA');

			select	obter_nome_pf(Obter_Cod_PF_Usuario(nm_usuario))
			into STRICT	nm_enfermeira_w
			from	prescr_gasoterapia_evento
			where	nr_sequencia = nr_sequencia_w;

		end if;

		if (qt_done_w > qt_undone_w) and (nm_enfermeira_w IS NOT NULL AND nm_enfermeira_w::text <> '') then
			ds_retorno_w := wheb_mensagem_pck.get_texto(1145993, 'NM_ENFERMEIRA=' || nm_enfermeira_w);
		end if;

	end if;

elsif (ie_opcao_p	= 'AP') then /*exames de anatomia patologica*/
	select	max(a.nr_prescricao) nr_prescricao,
			max(b.nr_sequencia) nr_seq_item,
			max(b.nr_seq_proc_interno) nr_seq_proc_interno
    into STRICT	nr_prescricao_w,
			nr_seq_item_w,
			nr_seq_proc_interno_w
	from    prescr_procedimento b,
			prescr_medica a
	where	b.nr_seq_proc_cpoe = nr_seq_cpoe_p
	and		b.nr_prescricao = a.nr_prescricao
	and		a.nr_atendimento = nr_atendimento_p;

	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') and (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then
	
		select count(*)
		into STRICT qt_done_w
		from prescr_mat_alteracao
		where nr_prescricao = nr_prescricao_w
		and  nr_seq_procedimento = nr_seq_item_w
		and  nr_seq_proc_interno = nr_seq_proc_interno_w
		and ie_alteracao in (64,63)
		and ie_tipo_item in ('P','G','C','I','L');
		
		select count(*)
		into STRICT qt_undone_w
		from prescr_mat_alteracao
		where nr_prescricao = nr_prescricao_w
		and  nr_seq_procedimento = nr_seq_item_w
		and  nr_seq_proc_interno = nr_seq_proc_interno_w
		and ie_alteracao in (82)
		and ie_tipo_item in ('P','G','C','I','L');

		if (qt_done_w IS NOT NULL AND qt_done_w::text <> '') then
		
			select	max(nr_sequencia)
			into STRICT    nr_sequencia_w
			from prescr_mat_alteracao
			where nr_prescricao = nr_prescricao_w
			and  nr_seq_procedimento = nr_seq_item_w
			and  nr_seq_proc_interno = nr_seq_proc_interno_w
			and ie_alteracao in (64,63)
			and ie_tipo_item in ('P','G','C','I','L');

			select	obter_nome_pf(cd_pessoa_fisica)
			into STRICT	nm_enfermeira_w
			from	prescr_mat_alteracao
			where	nr_sequencia = nr_sequencia_w;

		end if;

		if (qt_done_w > qt_undone_w) and (nm_enfermeira_w IS NOT NULL AND nm_enfermeira_w::text <> '') then
			ds_retorno_w := wheb_mensagem_pck.get_texto(1145993, 'NM_ENFERMEIRA=' || nm_enfermeira_w);
		end if;

	end if;

elsif (ie_opcao_p	= 'D') then /* dialysis */
	select	max( a.nr_prescricao) nr_prescricao,
			max(b.nr_seq_solucao) nr_seq_item
	into STRICT	nr_prescricao_w,
			nr_seq_item_w
	from	prescr_solucao b,
			prescr_medica a
	where (a.nr_prescricao, b.nr_seq_dialise) in ( SELECT	c.nr_prescricao,
															c.nr_sequencia
													from	hd_prescricao c,
															prescr_medica f
													where	c.nr_seq_dialise_cpoe = nr_seq_cpoe_p
													and		f.nr_prescricao = c.nr_prescricao
													and		f.nr_atendimento = nr_atendimento_p)
	and		b.nr_prescricao = a.nr_prescricao
	and		a.nr_atendimento = nr_atendimento_p;

	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') then

		select	count(*)
		into STRICT	qt_done_w
		from	hd_prescricao_evento
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_solucao = nr_seq_item_w
		and		ie_evento in ('SA','NA');

		select	count(*)
		into STRICT	qt_undone_w
		from	hd_prescricao_evento
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_solucao = nr_seq_item_w
		and		ie_evento = 'DA';
		
		if (qt_done_w IS NOT NULL AND qt_done_w::text <> '') then
		
			select	max(nr_sequencia)
			into STRICT    nr_sequencia_w
			from	hd_prescricao_evento
			where	nr_prescricao = nr_prescricao_w
			and		nr_seq_solucao = nr_seq_item_w
			and		ie_evento in ('SA','NA');

			select	obter_nome_pf(Obter_Cod_PF_Usuario(nm_usuario))
			into STRICT	nm_enfermeira_w
			from	hd_prescricao_evento
			where	nr_sequencia = nr_sequencia_w;

		end if;

		if (qt_done_w > qt_undone_w) and (nm_enfermeira_w IS NOT NULL AND nm_enfermeira_w::text <> '') then
			ds_retorno_w := wheb_mensagem_pck.get_texto(1145993, 'NM_ENFERMEIRA=' || nm_enfermeira_w);
		end if;

	end if;

elsif (ie_opcao_p	= 'M') then /*infusions and medicines*/
	select	max(a.nr_prescricao) nr_prescricao,
			max(b.nr_sequencia) nr_seq_item,
			max(b.cd_material) cd_material
	into STRICT	nr_prescricao_w,
			nr_seq_item_w,
			cd_material_w
	from	prescr_material b,
			prescr_medica a
	where	b.nr_seq_mat_cpoe = nr_seq_cpoe_p
	and		b.nr_prescricao = a.nr_prescricao
	and		a.nr_atendimento = nr_atendimento_p;
	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') and (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then

		select	count(*)
		into STRICT	qt_done_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_solucao = nr_seq_item_w
		and		ie_alteracao in (59,60);

		select	count(*)
		into STRICT	qt_undone_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_w
		and		nr_seq_solucao = nr_seq_item_w
		and		ie_alteracao = '61';
		
		if (qt_done_w IS NOT NULL AND qt_done_w::text <> '') then
		
			select	max(nr_sequencia)
			into STRICT    nr_sequencia_w
			from	prescr_solucao_evento
			where	nr_prescricao = nr_prescricao_w
			and		nr_seq_solucao = nr_seq_item_w
			and		ie_alteracao in (59,60);

			select	obter_nome_pf(Obter_Cod_PF_Usuario(nm_usuario))
			into STRICT	nm_enfermeira_w
			from	prescr_solucao_evento
			where	nr_sequencia = nr_sequencia_w;

		end if;

		if (qt_done_w > qt_undone_w) and (nm_enfermeira_w IS NOT NULL AND nm_enfermeira_w::text <> '') then
		
			ds_retorno_w := wheb_mensagem_pck.get_texto(1145993, 'NM_ENFERMEIRA=' || nm_enfermeira_w);
			
		else
		
			select	count(*)
			into STRICT	qt_done_material_w
			from	prescr_mat_alteracao
			where	nr_prescricao = nr_prescricao_w
			and		nr_seq_prescricao = nr_seq_item_w
			and		cd_item = cd_material_w
			and		ie_tipo_item in ('M','MAT','S')
			and		ie_alteracao in (64,63);

			select	count(*)
			into STRICT	qt_undone_material_w
			from	prescr_mat_alteracao
			where	nr_prescricao = nr_prescricao_w
			and		nr_seq_prescricao = nr_seq_item_w
			and		cd_item = cd_material_w
			and		ie_tipo_item in ('M','MAT','S')
			and		ie_alteracao in (82);
			
			if (qt_done_material_w IS NOT NULL AND qt_done_material_w::text <> '') then
			
				select	max(nr_sequencia)
				into STRICT    nr_sequencia_w
				from	prescr_mat_alteracao
				where	nr_prescricao = nr_prescricao_w
				and		nr_seq_prescricao = nr_seq_item_w
				and		cd_item = cd_material_w
				and		ie_tipo_item in ('M','MAT','S')
				and		ie_alteracao in (64,63);

				select	obter_nome_pf(cd_pessoa_fisica)
				into STRICT	nm_enfermeira_w
				from	prescr_mat_alteracao
				where	nr_sequencia = nr_sequencia_w;

			end if;

			if (qt_done_material_w > qt_undone_material_w) and (nm_enfermeira_w IS NOT NULL AND nm_enfermeira_w::text <> '') then
				ds_retorno_w := wheb_mensagem_pck.get_texto(1145993, 'NM_ENFERMEIRA=' || nm_enfermeira_w);
			end if;
		
		end if;

	end if;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_item_acknowledgement ( nr_seq_cpoe_p bigint, ie_opcao_p text, nr_atendimento_p bigint) FROM PUBLIC;

