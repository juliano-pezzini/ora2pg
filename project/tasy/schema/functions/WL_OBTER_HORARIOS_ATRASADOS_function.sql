-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION wl_obter_horarios_atrasados (nr_seq_cpoe_p cpoe_material.nr_sequencia%type, dt_inicio_p cpoe_material.dt_inicio%type default null, dt_fim_p cpoe_material.dt_fim%type default null) RETURNS varchar AS $body$
DECLARE

										
ds_retorno_w	varchar(4000);
ie_adep_154_w	varchar(3);

ie_controle_tempo_w	cpoe_material.ie_controle_tempo%type;
ie_material_w	cpoe_material.ie_material%type;
dt_liberacao_enf_w	cpoe_material.dt_liberacao_enf%type;
dt_liberacao_farm_w	cpoe_material.dt_liberacao_farm%type;


BEGIN

	ie_adep_154_w := obter_param_usuario(1113, 154, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_adep_154_w);

	if (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then
						
		select	max(dt_liberacao_enf),
			max(dt_liberacao_farm),
			max(ie_material)
		into STRICT dt_liberacao_enf_w,
			dt_liberacao_farm_w,
			ie_material_w
		from	cpoe_material
		where	nr_sequencia = nr_seq_cpoe_p;
		
		if ((dt_liberacao_enf_w IS NOT NULL AND dt_liberacao_enf_w::text <> '') and ((dt_liberacao_farm_w IS NOT NULL AND dt_liberacao_farm_w::text <> '') or ie_adep_154_w = 'S') and coalesce(ie_material_w,'N') = 'N') then
			RAISE NOTICE 'nr_seq_cpoe_p: %', nr_seq_cpoe_p;

			select 	cpoe_listagg_pck.tab_to_string(cast(collect(to_char(a.dt_horario, 'dd/mm/yyyy hh24:mi')) as strarray), ', ') ds_horarios
			into STRICT	ds_retorno_w
			from	wl_horarios_atrasados_v a
			where	a.nr_seq_mat_cpoe = nr_seq_cpoe_p
			and	((coalesce(dt_inicio_p::text, '') = '' and coalesce(dt_fim_p::text, '') = '') or a.dt_horario between dt_inicio_p and dt_fim_p);

		end if;
	end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION wl_obter_horarios_atrasados (nr_seq_cpoe_p cpoe_material.nr_sequencia%type, dt_inicio_p cpoe_material.dt_inicio%type default null, dt_fim_p cpoe_material.dt_fim%type default null) FROM PUBLIC;

