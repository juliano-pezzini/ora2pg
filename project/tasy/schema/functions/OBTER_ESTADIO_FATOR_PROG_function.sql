-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_estadio_fator_prog (cd_topografia_p text, cd_tumor_primario_p text, cd_linfonodo_regional_p text, cd_metastase_distancia_p text, ie_classificacao_tnm_p text, ie_utiliza_loc_tnm_p text default 'S', cd_edicao_tnm_p text default '8', nr_sequencias_fatores_p text DEFAULT NULL, nr_sequencias_valores_p text DEFAULT NULL, ie_tipo_tnm_p text DEFAULT NULL, nr_seq_loc_tnm_p text default null, vl_score_fatores_p bigint default null) RETURNS varchar AS $body$
DECLARE


nr_seq_can_estadio_w estadios_tnm_v.nr_sequencia%type;
qt_regras_w bigint;
qt_fatores_w bigint;
ie_valido_w varchar(1);
cd_retorno_w estadios_tnm_v.cd_estadio%type;
consulta varchar(2000);

c01 CURSOR FOR
SELECT cd_estadio,
	   nr_sequencia,
	   vl_fator_risco_estadio
from (
	SELECT  a.cd_estadio,
			a.nr_sequencia,
			a.vl_fator_risco_estadio,
			1 as sequencia
	from    estadios_tnm_v a
	where   a.cd_topografia    = cd_topografia_p
	and     ((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario  = cd_tumor_primario_p)
	and     ((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and     ((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and     a.cd_edicao_tnm = cd_edicao_tnm_p
	and 	a.ie_tipo_tnm = ie_tipo_tnm_p
	and 	a.ie_class_tnm_estadio = ie_classificacao_tnm_p
	
union

	select  a.cd_estadio,
			a.nr_sequencia,
			a.vl_fator_risco_estadio,
			2 as sequencia
	from    estadios_tnm_v a
	where   a.cd_topografia    = cd_topografia_p
	and     ((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario  = cd_tumor_primario_p)
	and     ((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and     ((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and     a.cd_edicao_tnm = cd_edicao_tnm_p
	and 	a.ie_tipo_tnm = ie_tipo_tnm_p
	and 	coalesce(a.ie_class_tnm_estadio::text, '') = ''
	
union

	select  a.cd_estadio,
			a.nr_sequencia,
			a.vl_fator_risco_estadio,
			3 as sequencia
	from    estadios_tnm_v a
	where   a.cd_topografia    = cd_topografia_p
	and     ((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario  = cd_tumor_primario_p)
	and     ((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and     ((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and     a.cd_edicao_tnm = cd_edicao_tnm_p
	and 	coalesce(a.ie_tipo_tnm::text, '') = ''
	and 	a.ie_class_tnm_estadio = ie_classificacao_tnm_p
	
union

	select  a.cd_estadio,
			a.nr_sequencia,
			a.vl_fator_risco_estadio,
			4 as sequencia
	from    estadios_tnm_v a
	where   a.cd_topografia    = cd_topografia_p
	and     ((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario  = cd_tumor_primario_p)
	and     ((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and     ((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and     a.cd_edicao_tnm = cd_edicao_tnm_p
	and 	coalesce(a.ie_tipo_tnm::text, '') = ''
	and 	coalesce(a.ie_class_tnm_estadio::text, '') = ''
) alias52
order by sequencia, cd_estadio;

c02 CURSOR FOR
SELECT  a.cd_estadio,
		a.nr_sequencia,
		a.vl_fator_risco_estadio
from
	cido_topografia b,
	can_tnm_localizacao c,
	can_estadio a
where   a.nr_seq_loc_tnm =  nr_seq_loc_tnm_p
and 	a.nr_seq_loc_tnm = c.nr_sequencia
and		b.cd_topografia = cd_topografia_p
and     ((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario  = cd_tumor_primario_p)
and     ((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
and     ((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
and     c.cd_edicao_tnm = cd_edicao_tnm_p
and (coalesce(a.ie_tipo_tnm::text, '') = '' or a.ie_tipo_tnm = ie_tipo_tnm_p)
and (coalesce(a.ie_classificacao_tnm::text, '') = '' or a.ie_classificacao_tnm = ie_classificacao_tnm_p)
order by cd_estadio;

-- rules
c03 CURSOR FOR
SELECT  r.nr_seq_fator_prog,
        r.nr_seq_valor_fator_prog
from    regra_fator_prog r,
        fator_prognostico f
where   r.nr_seq_fator_prog = f.nr_sequencia
and     f.ie_obrigatorio = 'S'
and     r.nr_seq_can_estadio = nr_seq_can_estadio_w;

BEGIN
cd_retorno_w := null;

if (coalesce(nr_sequencias_fatores_p::text, '') = '') then
	qt_fatores_w := 0;
else
	qt_fatores_w := tnm_obter_qtd_fatores(nr_sequencias_fatores_p);
end if;

if ((cd_topografia_p IS NOT NULL AND cd_topografia_p::text <> '')
    and (ie_classificacao_tnm_p IS NOT NULL AND ie_classificacao_tnm_p::text <> '')
    and coalesce(ie_utiliza_loc_tnm_p, 'N') = 'S'
    and (cd_edicao_tnm_p IS NOT NULL AND cd_edicao_tnm_p::text <> '')) then
    for estadio in c01
    loop
        nr_seq_can_estadio_w := estadio.nr_sequencia;

		qt_regras_w := 0;
		ie_valido_w := 'S';
		
		if (vl_score_fatores_p IS NOT NULL AND vl_score_fatores_p::text <> '') then
			if (estadio.vl_fator_risco_estadio <> vl_score_fatores_p) then
				ie_valido_w := 'N';
			end if;
			
		else
			for regra in c03
			loop
				qt_regras_w := qt_regras_w + 1;
				if (Obter_Se_Contido_char(regra.nr_seq_fator_prog, nr_sequencias_fatores_p) <> 'S'
				  or Obter_Se_Contido_char(regra.nr_seq_valor_fator_prog, nr_sequencias_valores_p) <> 'S') then
					ie_valido_w := 'N';
				end if;
			end loop;

			if (qt_regras_w <> qt_fatores_w) then
				ie_valido_w := 'N';
			end if;
		end if;

		if (ie_valido_w = 'S') then
			cd_retorno_w := estadio.cd_estadio;
			exit;
		end if;
    end loop;
end if;

if ((cd_topografia_p IS NOT NULL AND cd_topografia_p::text <> '')
    and (ie_classificacao_tnm_p IS NOT NULL AND ie_classificacao_tnm_p::text <> '')
    and (cd_edicao_tnm_p IS NOT NULL AND cd_edicao_tnm_p::text <> '')
	and coalesce(ie_utiliza_loc_tnm_p, 'N') = 'N'
    and (nr_seq_loc_tnm_p IS NOT NULL AND nr_seq_loc_tnm_p::text <> '')) then
	
	for estadio in c02
	loop
		nr_seq_can_estadio_w := estadio.nr_sequencia;

		qt_regras_w := 0;
		ie_valido_w := 'S';
		
		if (vl_score_fatores_p IS NOT NULL AND vl_score_fatores_p::text <> '') then
			if (estadio.vl_fator_risco_estadio <> vl_score_fatores_p) then
				ie_valido_w := 'N';
			end if;
			
		else
			for regra in c03
			loop
				qt_regras_w := qt_regras_w + 1;
				if (Obter_Se_Contido_char(regra.nr_seq_fator_prog, nr_sequencias_fatores_p) <> 'S'
				  or Obter_Se_Contido_char(regra.nr_seq_valor_fator_prog, nr_sequencias_valores_p) <> 'S') then
					ie_valido_w := 'N';
				end if;
			end loop;

			if (qt_regras_w <> qt_fatores_w) then
				ie_valido_w := 'N';
			end if;
		end if;

		if (ie_valido_w = 'S') then
			cd_retorno_w := estadio.cd_estadio;
			exit;
		end if;
	end loop;
end if;

return cd_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_estadio_fator_prog (cd_topografia_p text, cd_tumor_primario_p text, cd_linfonodo_regional_p text, cd_metastase_distancia_p text, ie_classificacao_tnm_p text, ie_utiliza_loc_tnm_p text default 'S', cd_edicao_tnm_p text default '8', nr_sequencias_fatores_p text DEFAULT NULL, nr_sequencias_valores_p text DEFAULT NULL, ie_tipo_tnm_p text DEFAULT NULL, nr_seq_loc_tnm_p text default null, vl_score_fatores_p bigint default null) FROM PUBLIC;

