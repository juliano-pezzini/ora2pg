-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE Rec_Tempo AS (
   Qtd	integer,
   str 	varchar(10));


CREATE OR REPLACE FUNCTION obter_data_upaciente ( p_dt_inicial timestamp , p_masc text DEFAULT null, p_dt_final timestamp DEFAULT null) RETURNS varchar AS $body$
DECLARE


vIndice    	integer := 0;
vMascara   	varchar(60);
vData 		timestamp;
vRetorno   	varchar(100);
vCaracter  	char(01);
vOculta     	boolean := False;
vAno  Rec_Tempo;
vMes  Rec_Tempo;
vDia  Rec_Tempo;
vHora  Rec_Tempo;
vMin  Rec_Tempo;

BEGIN

vdata 		:= coalesce(p_dt_final,clock_timestamp());
vmascara        := coalesce( p_masc, 'a' );  -->> Exemplo de mascara '#aA mM dD'. Se nao for informado nada, retorna a (nao e simbolo fixo de traducao)
vano.qtd 	:= trunc(pkg_date_utils.get_DiffDate(p_dt_inicial, vdata, 'YEAR'));

if (vdata - pkg_date_utils.add_month(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(p_dt_inicial), vano.qtd * 12,0) < 0) then
	vAno.Qtd := vAno.Qtd - 1;
end if;
vmes.qtd 	:= trunc(pkg_date_utils.get_DiffDate(p_dt_inicial, vdata, 'MONTH%'));
vdia.qtd 	:= trunc(pkg_date_utils.get_DiffDate(p_dt_inicial, vdata, 'DAY%'));
vhora.qtd 	:= trunc(pkg_date_utils.get_DiffDate(p_dt_inicial, vdata, 'HOUR%'));
vmin.qtd 	:= trunc(pkg_date_utils.get_DiffDate(p_dt_inicial, vdata, 'MINUTE%'));

if vano.qtd > 1 then
	vAno.str := obter_texto_tasy(308343, philips_param_pck.get_cd_pais);
Else
    vAno.str := obter_texto_tasy(308343, philips_param_pck.get_cd_pais);
End If;
If vMes.Qtd > 1 Then
    vMes.str := obter_texto_tasy(308345, philips_param_pck.get_cd_pais);
Else
	vMes.str := obter_texto_tasy(308345, philips_param_pck.get_cd_pais);
End If;
If vDia.Qtd > 1 Then
    vDia.str:= obter_texto_tasy(308346, philips_param_pck.get_cd_pais);
Else
    vDia.str:= obter_texto_tasy(308346, philips_param_pck.get_cd_pais);
End If;
If vHora.Qtd > 1 Then
  --291453 = Horas
	vHora.str:= obter_desc_expressao(291453);
Else
  --291374 = Hora
	vHora.str:= obter_desc_expressao(291374);
End If;
If vMin.Qtd > 1 Then
  --293343 = Minutos
	vMin.str:= obter_desc_expressao(293343);
Else
  --293340 = Minuto
	vMin.str:= obter_desc_expressao(293340);
End If;
vCaracter	:= Substr( vMascara, 1, 1 );  -->> Retorna o primeiro caracter da mascara
If vCaracter = '#' Then  -->> O primeiro caracter sendo "#" indica que devera inibir as informacoes zeradas
	vOculta := True;
	vIndice := 2;
	vCaracter := Substr( vMascara, 2, 1 );
	If coalesce(vCaracter::text, '') = '' Then  -->> No caso da mascara ter apenas o caracter "#" entao a funcao retornara Null
	Return Null;
	End If;
Else
	vIndice := 1;
End If;

Loop
	If vCaracter = '"' Then
		Loop
		vIndice		:= vIndice + 1;
		vCaracter 	:= Substr( vMascara, vIndice, 1 );
		Exit When vCaracter = '"' or coalesce(vCaracter::text, '') = '';
			vRetorno := vRetorno || vCaracter;
		End Loop;
	Else
		if vCaracter = 'a' Then  -->> Retorno da informacao em forma numerica de Anos
			If vAno.Qtd > 0 or Not vOculta Then
				vRetorno := vRetorno || vAno.Qtd;
			End If;
		Elsif vCaracter = 'A' Then  -->> Retorno da informacao em forma de texto de Anos
			If vAno.Qtd > 0 or Not vOculta Then
				vRetorno := vRetorno || vAno.Str;
			End If;
		Elsif vCaracter = 'm'      %OPEN_COMMENT% -->> Retorno da informacao em forma numerica de Mes */ and Nvl(Substr(vMascara,vIndice+1,1),'.') <> 'i' Then   -->> Diferencia a mascara do mes e dos minutos
			If vMes.Qtd > 0 or Not vOculta Then
				vRetorno := vRetorno || vMes.Qtd;
			End If;
		Elsif vCaracter = 'M' %OPEN_COMMENT%-->> Retorno da informacao em forma de texto do Mes*/ and Nvl(Substr(vMascara,vIndice+1,1),'.') <> 'I' Then -->> Diferencia a mascara do mes e dos minutos
			If vMes.Qtd > 0 or Not vOculta Then
				vRetorno := vRetorno || vMes.Str;
			End If;
		Elsif vCaracter = 'd' Then  -->> Retorno da informacao em forma numerica de Dias
			If vDia.Qtd > 0 or Not vOculta Then
				vRetorno := vRetorno || vDia.Qtd;
			End If;
		Elsif vCaracter = 'D' Then  --->> Retorno da informacao em forma de texto de Dias
			If vDia.Qtd > 0 or Not vOculta Then
				vRetorno := vRetorno || vDia.Str;
			End If;
		Elsif vCaracter = 'h' Then  --->> Retorno da informacao em forma numerica de Horas
			If vHora.Qtd > 0 or Not vOculta Then
				vRetorno := vRetorno || vHora.Qtd;
			End If;
		Elsif vCaracter = 'H' Then  -->> Retorno da informacao em forma de texto de Horas
			If vHora.Qtd > 0 or Not vOculta Then
				vRetorno := vRetorno || vHora.Str;
			End If;
		Elsif vCaracter = 'm'     %OPEN_COMMENT%  -->> Retorno da informacao em forma numerica de Minutos*/ and Nvl(Substr(vMascara,vIndice+1,1),'.') = 'i' Then   -->> Diferencia a mascara o mes e dos minutos
			If vMin.Qtd > 0 or Not vOculta Then
				vRetorno := vRetorno || vMin.Qtd;
			End If;
			vIndice := vIndice + 1;
		Elsif vCaracter = 'M'  %OPEN_COMMENT%-->> Retorno da informacao em forma de texto de Minutos*/ and Nvl(Substr(vMascara,vIndice+1,1),'.') = 'I' Then -->> Diferencia a mascarao mes e dos minutos
			If vMin.Qtd > 0 or Not vOculta Then
				vRetorno := vRetorno || vMin.Str;
			End If;
			vIndice := vIndice + 1;
		Elsif vCaracter = 'x' Then
			If vAno.Qtd >= 2 Then
				vRetorno := vRetorno || vAno.Qtd;
			Elsif vAno.Qtd = 1 or vMes.Qtd >= 2 Then
				vRetorno := vRetorno || ((vAno.Qtd*12)+vMes.Qtd);
			Elsif vMes.Qtd = 1 or vDia.Qtd >= 2 Then
				vRetorno := vRetorno || ( ESTABLISHMENT_TIMEZONE_UTILS.startOfDay( vData ) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay( P_DT_INICIAL ) );
			Elsif vOculta Then
				vRetorno := vRetorno;
			Elsif vDia.Qtd = 1 or vHora.Qtd >= 2 Then
				vRetorno := vRetorno || ( vDia.Qtd*24 + vHora.Qtd );
			Elsif vHora.Qtd = 1 and vMin.Qtd >= 2 Then
				vRetorno := vRetorno || ( vHora.Qtd*60 + vMin.Qtd );
			End If;
		Elsif vCaracter = 'X' Then
			If vAno.Qtd >= 2 Then
				vRetorno := vRetorno || vAno.Str;
			Elsif vAno.Qtd = 1 or vMes.Qtd >= 2 Then
        --293251 = Meses
				vRetorno := vRetorno || obter_desc_expressao(293251);
			Elsif vMes.Qtd = 1 or vDia.Qtd >= 2 Then
        --287753 = Dias
				vRetorno := vRetorno || obter_desc_expressao(287753);
			Elsif vOculta Then
				vRetorno := vRetorno;
			Elsif vDia.Qtd = 1 or vHora.Qtd >= 2 Then
        --291453 = Horas
				vRetorno := vRetorno || obter_desc_expressao(291453);
			Elsif vHora.Qtd = 1 and vMin.Qtd >= 2 Then
        --293343 = Minutos
				vRetorno := vRetorno || obter_desc_expressao(293343);
			End If;
		Else
			vRetorno := vRetorno || vCaracter;
		End If;
	End If;
	vIndice := vIndice + 1;
	vCaracter := Substr( vMascara, vIndice, 1 );
	Exit When coalesce(vCaracter::text, '') = '';
End Loop;
Return vRetorno;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_data_upaciente ( p_dt_inicial timestamp , p_masc text DEFAULT null, p_dt_final timestamp DEFAULT null) FROM PUBLIC;

