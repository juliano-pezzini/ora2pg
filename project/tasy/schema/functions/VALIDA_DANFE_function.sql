-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION valida_danfe (nr_danfe_p text) RETURNS varchar AS $body$
DECLARE


ds_danfe_w	varchar(44);
vl_sequencial_w varchar(44);
vl_retorno_w	varchar(1) := 'S';
i     		integer;
vl_soma_w	bigint;
vl_digito_w	bigint;




BEGIN

if (length(replace(nr_danfe_p,' ',''))> 44) then
	begin
	vl_retorno_w := 'N';
	goto Final;
	end;
elsif (coalesce(replace(nr_danfe_p,' ','')::text, '') = '') then
	begin
	vl_retorno_w := 'S';
	goto Final;
	end;
end if;

ds_danfe_w      := substr(replace(nr_danfe_p,' ',''),1,44);
vl_sequencial_w := '4329876543298765432987654329876543298765432';
vl_soma_w       := 0;
vl_digito_w     := 0;

if (obter_se_somente_numero(ds_danfe_w) = 'S') and (length(ds_danfe_w) = 44) then
	begin

	for i in 1..length(ds_danfe_w)-1 loop
		begin

		vl_soma_w := vl_soma_w + (substr(ds_danfe_w,i,1) * substr(vl_sequencial_w,i,1));

		end;
	end loop;

	vl_soma_w   := vl_soma_w mod 11;

	if (vl_soma_w = 0) or (vl_soma_w = 1) then
		vl_digito_w := 0;
	else
		vl_digito_w := 11 - vl_soma_w;
	end if;

	if (vl_digito_w = substr(ds_danfe_w,length(ds_danfe_w),1)) then
		begin
		vl_retorno_w := 'S';
		end;
	else
		begin
		vl_retorno_w := 'N';
		end;
	end if;

	end;
else
	vl_retorno_w := 'N';
end if;

<<Final>>

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION valida_danfe (nr_danfe_p text) FROM PUBLIC;

