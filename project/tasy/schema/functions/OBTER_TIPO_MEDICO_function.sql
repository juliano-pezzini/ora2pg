-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tipo_medico ( nm_usuario_p text, nr_seq_carta_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	                varchar(255);
ds_medico_senior_w	        varchar(255);
ds_medico_responsavel_w	      	varchar(255);
ds_chefe_departamento_w	      	varchar(255);
ie_sexo_usuario_w             	pessoa_fisica.IE_SEXO%type;
nr_cirurgia_w			carta_medica.nr_cirurgia%type;
ie_funcao_w			cirurgia_participante.ie_funcao%type;
ie_cirurgiao_w			funcao_medico.ie_cirurgiao%type;


BEGIN

ie_sexo_usuario_w := OBTER_SEXO_PF(OBTER_PESSOA_FISICA_USUARIO(nm_usuario_p, 'C'), 'C');

if (ie_sexo_usuario_w = 'F') then
  ds_medico_senior_w := obter_desc_expressao(945810); --Medico senior
  ds_medico_responsavel_w := obter_desc_expressao(945822); --Medico responsavel
  ds_chefe_departamento_w := obter_desc_expressao(945804); --Chefe departamento
else
  ds_medico_senior_w := obter_texto_tasy(1026475, null); --Medico senior
  ds_medico_responsavel_w := obter_texto_tasy(1026476, null); --Medico responsavel
  ds_chefe_departamento_w := obter_texto_tasy(1026473, null); --Chefe departamento
end if;

if (Obter_se_pf_Medico(OBTER_PESSOA_FISICA_USUARIO(nm_usuario_p, 'C'), 'S') = 'N') then
  ds_medico_responsavel_w := '';
end if;

select  	CASE WHEN coalesce(max(b.cd_pessoa_fisica), 0)=0 THEN  CASE WHEN coalesce(max(cd_departamento), 0)=0 THEN  ds_medico_responsavel_w  ELSE ds_chefe_departamento_w END   ELSE ds_medico_senior_w END
into STRICT 	ds_retorno_w
FROM usuario a
LEFT OUTER JOIN medico b ON (a.cd_pessoa_fisica = b.cd_pessoa_fisica AND 'S' = b.ie_medico_senior)
LEFT OUTER JOIN departamento_medico c ON (a.cd_pessoa_fisica = c.cd_responsavel)
WHERE lower(a.nm_usuario) like lower(nm_usuario_p);

if (nr_seq_carta_p IS NOT NULL AND nr_seq_carta_p::text <> '') then
	select 	nr_cirurgia
	into STRICT	nr_cirurgia_w
	from	carta_medica
	where	nr_sequencia = nr_seq_carta_p;
	
	if (nr_cirurgia_w IS NOT NULL AND nr_cirurgia_w::text <> '') then
		select	max(a.ie_funcao)
		into STRICT	ie_funcao_w
		from	cirurgia_participante a
		where	a.nr_cirurgia = nr_cirurgia_w
		and	coalesce(a.dt_inativacao::text, '') = ''
		and	a.cd_pessoa_fisica = obter_pessoa_fisica_usuario(nm_usuario_p, 'C');
		
		if (ie_funcao_w IS NOT NULL AND ie_funcao_w::text <> '') then
			select	max(b.ie_cirurgiao)
			into STRICT	ie_cirurgiao_w
			from 	funcao_medico b
			where 	b.cd_funcao = ie_funcao_w;
			
			if (coalesce(ie_cirurgiao_w, 'N') = 'S') then
				ds_retorno_w := obter_desc_expressao(486331);
			end if;
		end if;
	end if;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tipo_medico ( nm_usuario_p text, nr_seq_carta_p bigint default null) FROM PUBLIC;

