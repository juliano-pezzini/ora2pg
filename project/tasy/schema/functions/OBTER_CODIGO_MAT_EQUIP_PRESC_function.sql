-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_codigo_mat_equip_presc (cd_sigla_equip_p text, nr_prescricao_p bigint, nr_seq_prescr_p bigint) RETURNS varchar AS $body$
DECLARE

 
resultado_w	 		varchar(100);
cd_exame_integr_w		varchar(100);

nr_seq_exame_w			bigint;
ie_tipo_atendimento_w		bigint;
ie_urgente_w			varchar(2);
nr_seq_material_w		bigint;

cd_estabelecimento_w		bigint;
cd_setor_atendimento_w		integer;

c01 CURSOR FOR 
	SELECT	coalesce((b.cd_material_integr),null) 
	FROM equipamento_lab a, lab_exame_equip b
LEFT OUTER JOIN exame_lab_equip_regra c ON (b.nr_sequencia = c.nr_seq_exame_equip)
WHERE a.cd_equipamento	= b.cd_equipamento and upper(a.ds_sigla)	= upper(cd_sigla_equip_p) and b.nr_seq_exame 		= nr_seq_exame_w  and ((b.nr_seq_material 	= coalesce(nr_seq_material_w,b.nr_seq_material)) or (coalesce(nr_seq_material::text, '') = '')) and ((b.ie_tipo_atendimento	= coalesce(ie_tipo_atendimento_w,b.ie_tipo_atendimento)) or (coalesce(b.ie_tipo_atendimento::text, '') = '')) and (b.ie_urgente		= coalesce(ie_urgente_w,b.ie_urgente) or coalesce(b.ie_urgente::text, '') = '') and (c.cd_estabelecimento	= coalesce(cd_estabelecimento_w,c.cd_estabelecimento) or coalesce(c.cd_estabelecimento::text, '') = '') and (c.cd_setor_atendimento	= coalesce(cd_setor_atendimento_w,c.cd_setor_atendimento) or coalesce(c.cd_setor_atendimento::text, '') = '') 
	order 	by coalesce(b.ie_tipo_atendimento,0), coalesce(b.nr_seq_material,0);


BEGIN 
 
resultado_w := null;
 
select 	max(b.nr_seq_exame), 
	max(e.ie_tipo_atendimento), 
	max(b.ie_urgencia), 
	max(d.nr_sequencia), 
	max(a.cd_estabelecimento), 
	max(a.cd_setor_atendimento) 
into STRICT	nr_seq_exame_w, 
	ie_tipo_atendimento_w, 
	ie_urgente_w, 
	nr_seq_material_w, 
	cd_estabelecimento_w, 
	cd_setor_atendimento_w 
from 	atendimento_paciente e, 
	material_exame_lab d, 
	prescr_procedimento b, 
	prescr_medica a 
where 	a.nr_atendimento = e.nr_atendimento 
and 	a.nr_prescricao = b.nr_prescricao 
and	b.cd_material_exame = d.cd_material_exame 
and 	a.nr_prescricao = nr_prescricao_p 
and	b.nr_sequencia	= nr_seq_prescr_p;
 
 
open c01;
loop 
fetch c01 into cd_exame_integr_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	resultado_w := cd_exame_integr_w;
end loop;
close c01;
 
return resultado_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_codigo_mat_equip_presc (cd_sigla_equip_p text, nr_prescricao_p bigint, nr_seq_prescr_p bigint) FROM PUBLIC;

