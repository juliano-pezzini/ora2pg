-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gerar_resumo_dacon ( nr_sequencia_p integer, ie_opcao text) RETURNS bigint AS $body$
DECLARE


retorno_w			double precision;
pr_pis_w			double precision;
pr_cofins_w			double precision;
vl_receita_pis_ret_w		double precision;
vl_receita_sem_pis_ret_w	double precision;
vl_receita_cof_ret_w		double precision;
vl_receita_sem_cof_ret_w	double precision;
vl_base_pis_w			double precision;
vl_base_cofins_w		double precision;
pr_aliq_pis_w			double precision;
pr_aliq_cofins_w		double precision;
vl_pis_pagar_w			double precision;
vl_cofins_pagar_w		double precision;
vl_contrib_pis_w		double precision;
vl_contrib_cofins_w		double precision;
vl_pis_retido_w			double precision;
vl_cofins_retido_w		double precision;


BEGIN
/*
	opções
TPR : Total PIS retido.
TCR: Total COFINS retido.
TNPR: Total das notas com PIS retido.
TNCR: Total das notas com COFINS retido.
TNSPR: Total das notas sem PIS retido.
TNSCR:Total das notas sem COFINS retido.
AP: Alíquota do PIS.
AC: Alíquota do COFINS.
TBCP: Total da base de cálculo PIS.
TBCC: Total da base de cálculo COFINS.
RTP: Receita Total de PIS
RTC: Receita Total de COFINS
TCP: Total da contribuição de PIS
TCC: Total da contribuição de COFINS
VPP: Valor do PIS a pagar
VCP: Valor do COFINS a pagar
*/
if (ie_opcao = 'TPR') or (ie_opcao = 'VPP') then
	select	sum(c.vl_tributo)
	into STRICT	retorno_w
	from 	nota_fiscal b,
		nota_fiscal_trib c,
		dacon_nota_fiscal a
	where 	b.nr_sequencia = c.nr_sequencia
	and	a.nr_seq_nota_fiscal = b.nr_sequencia
	and	c.cd_tributo = (SELECT cd_tributo_pis from dacon where nr_sequencia = nr_sequencia_p)
	and	c.vl_tributo > 0
	and	a.nr_seq_dacon= nr_sequencia_p;

	vl_pis_retido_w := retorno_w;
end if;

if (ie_opcao = 'TCR') or (ie_opcao = 'VCP') then
	select	sum(c.vl_tributo)
	into STRICT	retorno_w
	from 	nota_fiscal b,
		nota_fiscal_trib c,
		dacon_nota_fiscal a
	where 	b.nr_sequencia = c.nr_sequencia
	and	a.nr_seq_nota_fiscal = b.nr_sequencia
	and	c.cd_tributo = (SELECT cd_tributo_cofins from dacon where nr_sequencia = nr_sequencia_p)
	and	c.vl_tributo > 0
	and	a.nr_seq_dacon = nr_sequencia_p;

	vl_cofins_retido_w := retorno_w;
end if;

if (ie_opcao = 'TNPR') or (ie_opcao = 'RTP') then
	select 	sum(b.vl_mercadoria)
	into STRICT	vl_receita_pis_ret_w
	from 	nota_fiscal b,
		nota_fiscal_trib c,
		dacon_nota_fiscal a
	where 	b.nr_sequencia = c.nr_sequencia
	and	a.nr_seq_nota_fiscal = b.nr_sequencia
	and	c.cd_tributo = (SELECT cd_tributo_pis from dacon where nr_sequencia = nr_sequencia_p)
	and	c.vl_tributo > 0
	and	a.nr_seq_dacon = nr_sequencia_p;

	retorno_w := vl_receita_pis_ret_w;
end if;

if (ie_opcao = 'TNCR') or (ie_opcao = 'RTC') then
	select	sum(b.vl_mercadoria)
	into STRICT	vl_receita_cof_ret_w
	from 	nota_fiscal b,
		nota_fiscal_trib c,
		dacon_nota_fiscal a
	where 	b.nr_sequencia = c.nr_sequencia
	and	a.nr_seq_nota_fiscal = b.nr_sequencia
	and	c.cd_tributo = (SELECT cd_tributo_cofins from dacon where nr_sequencia = nr_sequencia_p)
	and	c.vl_tributo > 0
	and	a.nr_seq_dacon= nr_sequencia_p;

	retorno_w := vl_receita_cof_ret_w;
end if;

if (ie_opcao = 'TNSPR') or (ie_opcao = 'RTP') then
	select	sum(b.vl_mercadoria)
	into STRICT	vl_receita_sem_pis_ret_w
	from 	nota_fiscal b,
		dacon_nota_fiscal a
	where 	a.nr_seq_nota_fiscal = b.nr_sequencia
	and 	(not exists (SELECT  	1 from nota_fiscal_trib c
			  where  	b.nr_sequencia = c.nr_sequencia
			  and     	c.cd_tributo = (select cd_tributo_pis from dacon where nr_sequencia = nr_sequencia_p))
	or 	exists (	select  	1 from nota_fiscal_trib c
			where   	b.nr_sequencia = c.nr_sequencia
			and      	c.cd_tributo = (select cd_tributo_pis from dacon where nr_sequencia = nr_sequencia_p)
			and	c.vl_tributo = 0))
	and	a.nr_seq_dacon = nr_sequencia_p;

	retorno_w := vl_receita_sem_pis_ret_w;
end if;

if (ie_opcao = 'TNSCR') or (ie_opcao = 'RTC') then
	select	sum(b.vl_mercadoria)
	into STRICT	vl_receita_sem_cof_ret_w
	from 	nota_fiscal b,
		dacon_nota_fiscal a
	where 	a.nr_seq_nota_fiscal = b.nr_sequencia
	and 	(not exists	(SELECT	1
				from	nota_fiscal_trib c
				where  	b.nr_sequencia = c.nr_sequencia
				and    	c.cd_tributo = (select cd_tributo_cofins from dacon where nr_sequencia = nr_sequencia_p))
	or 	exists (	select  	1 from nota_fiscal_trib c
			where  	b.nr_sequencia = c.nr_sequencia
			and     	c.cd_tributo = (select cd_tributo_cofins from dacon where nr_sequencia = nr_sequencia_p)
			and     	c.vl_tributo = 0))
	and	a.nr_seq_dacon = nr_sequencia_p;

	retorno_w := vl_receita_sem_cof_ret_w;
end if;

if (ie_opcao = 'RTP') then
	retorno_w := vl_receita_pis_ret_w + vl_receita_sem_pis_ret_w;
end if;

if (ie_opcao = 'RTC') then
	retorno_w := vl_receita_cof_ret_w + vl_receita_sem_cof_ret_w;
end if;

if (ie_opcao = 'AP') or (ie_opcao = 'TCP') or (ie_opcao = 'VPP') then
	select	max(pr_imposto)
	into STRICT	retorno_w
	from	regra_calculo_imposto e
	where   e.cd_tributo =	(SELECT	cd_tributo_pis
				from	dacon
				where	nr_sequencia = nr_sequencia_p);

	select	coalesce(max(pr_pis),0)
	into STRICT	pr_pis_w
	from	dacon
	where	nr_sequencia = nr_sequencia_p;

	if (pr_pis_w <> 0) then
		retorno_w := pr_pis_w;
	end if;

	pr_aliq_pis_w := retorno_w;

end if;

if (ie_opcao = 'AC') or (ie_opcao = 'TCC') or (ie_opcao = 'VCP') then
	select	max(pr_imposto)
	into STRICT	retorno_w
	from   	regra_calculo_imposto e
	where	e.cd_tributo =	(SELECT	cd_tributo_cofins
				from	dacon
				where	nr_sequencia = nr_sequencia_p);

	select	coalesce(max(pr_cofins),0)
	into STRICT	pr_cofins_w
	from	dacon
	where	nr_sequencia = nr_sequencia_p;

	if (pr_cofins_w <> 0) then
		retorno_w := pr_cofins_w;
	end if;

	pr_aliq_cofins_w := retorno_w;
end if;

if (ie_opcao = 'TBCP') or (ie_opcao = 'TCP') or (ie_opcao = 'VPP') then

	select	sum(vl_mercadoria)
	into STRICT	retorno_w
	from	(	SELECT 	sum(b.vl_mercadoria) vl_mercadoria
			from 	nota_fiscal b,
				nota_fiscal_trib c,
				dacon_nota_fiscal a
			where 	b.nr_sequencia = c.nr_sequencia
			and	a.nr_seq_nota_fiscal = b.nr_sequencia
			and	c.cd_tributo = (select cd_tributo_pis from dacon where nr_sequencia = nr_sequencia_p)
			and	c.vl_tributo > 0
			and	a.nr_seq_dacon = nr_sequencia_p
			
union

			SELECT	sum(b.vl_mercadoria) vl_mercadoria
			from 	nota_fiscal b,
				dacon_nota_fiscal a
			where 	a.nr_seq_nota_fiscal = b.nr_sequencia
			and 	(not exists (	select  1 from nota_fiscal_trib c
						where  	b.nr_sequencia = c.nr_sequencia
						and     c.cd_tributo = (select cd_tributo_pis from dacon where nr_sequencia = nr_sequencia_p))
			or 	exists (	select  1 from nota_fiscal_trib c
						where   b.nr_sequencia = c.nr_sequencia
						and     c.cd_tributo = (select cd_tributo_pis from dacon where nr_sequencia = nr_sequencia_p)
						and	c.vl_tributo = 0))
			and	a.nr_seq_dacon = nr_sequencia_p) alias12;

	vl_base_pis_w := retorno_w;
end if;

if (ie_opcao = 'TBCC') or (ie_opcao = 'TCC') or (ie_opcao = 'VCP') then

	select	sum(vl_mercadoria)
	into STRICT	retorno_w
	from	(	SELECT	sum(b.vl_mercadoria) vl_mercadoria
			from 	nota_fiscal b,
				nota_fiscal_trib c,
				dacon_nota_fiscal a
			where 	b.nr_sequencia = c.nr_sequencia
			and	a.nr_seq_nota_fiscal = b.nr_sequencia
			and	c.cd_tributo = (select cd_tributo_cofins from dacon where nr_sequencia = nr_sequencia_p)
			and	c.vl_tributo > 0
			and	a.nr_seq_dacon= nr_sequencia_p
			
union

			SELECT	sum(b.vl_mercadoria) vl_mercadoria
			from 	nota_fiscal b,
				dacon_nota_fiscal a
			where 	a.nr_seq_nota_fiscal = b.nr_sequencia
			and 	(not exists	(select	1
						from	nota_fiscal_trib c
						where  	b.nr_sequencia = c.nr_sequencia
						and    	c.cd_tributo = (select cd_tributo_cofins from dacon where nr_sequencia = nr_sequencia_p))
			or 	exists (	select 	1 from nota_fiscal_trib c
						where  	b.nr_sequencia = c.nr_sequencia
						and    	c.cd_tributo = (select cd_tributo_cofins from dacon where nr_sequencia = nr_sequencia_p)
						and    	c.vl_tributo = 0))
			and	a.nr_seq_dacon = nr_sequencia_p) alias12;

	vl_base_cofins_w := retorno_w;
end if;

if (ie_opcao = 'TCP') or (ie_opcao = 'VPP') then
	retorno_w := vl_base_pis_w * (pr_aliq_pis_w /100);
	vl_contrib_pis_w := retorno_w;
end if;

if (ie_opcao = 'TCC') or (ie_opcao = 'VCP') then
	retorno_w := vl_base_cofins_w * (pr_aliq_cofins_w /100);
	vl_contrib_cofins_w := retorno_w;
end if;

if (ie_opcao = 'VPP') then
	retorno_w := vl_contrib_pis_w - vl_pis_retido_w;
end if;

if (ie_opcao = 'VCP') then
	retorno_w := vl_contrib_cofins_w - vl_cofins_retido_w;
end if;

return	retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gerar_resumo_dacon ( nr_sequencia_p integer, ie_opcao text) FROM PUBLIC;

