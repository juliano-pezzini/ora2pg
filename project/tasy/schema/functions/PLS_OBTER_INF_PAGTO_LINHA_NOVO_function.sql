-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_inf_pagto_linha_novo ( nr_seq_prestador_p bigint, nr_linha_p bigint, ie_informacao_p text, nr_seq_lote_p pls_lote_pagamento.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(30);
nr_linha_w			bigint;
dt_liquidacao_w			timestamp;
vl_titulo_w			double precision;
dt_mes_competencia_w		timestamp;
cpf_cgc_w			varchar(255);


BEGIN

cpf_cgc_w	:= '';

select	CASE WHEN coalesce(cd_cgc::text, '') = '' THEN  cd_pessoa_fisica  ELSE cd_cgc END
into STRICT	cpf_cgc_w
from	pls_prestador
where	nr_sequencia = nr_seq_prestador_p;

select	linha,
	dt_liquidacao,
	vl_titulo,
	dt_mes_competencia
into STRICT	nr_linha_w,
	dt_liquidacao_w,
	vl_titulo_w,
	dt_mes_competencia_w
from	(
	SELECT a.nr_sequencia,
		row_number() OVER () AS linha,
		trunc(d.dt_vencimento_atual) dt_liquidacao,
		CASE WHEN d.ie_situacao='L' THEN (obter_dados_tit_pagar(d.nr_titulo,'P'))::numeric   ELSE d.vl_saldo_titulo END  vl_titulo, -- d.vl_titulo vl_titulo,
		a.dt_mes_competencia dt_mes_competencia,
		e.vl_base_calculo
	from	pls_pp_lote 			a,
		pls_pp_prestador		b,
		pls_prestador 			c,
		titulo_pagar 			d,
		pls_pp_valor_trib_pessoa	e
	where	a.nr_sequencia 		= b.nr_seq_lote
	and	b.nr_seq_prestador 	= c.nr_sequencia
	and 	e.nr_seq_prestador 	= b.nr_seq_prestador
	and	b.nr_titulo_pagar	= d.nr_titulo
	and	((c.cd_pessoa_fisica	= cpf_cgc_w) or (c.cd_cgc		= cpf_cgc_w))
	and	a.nr_sequencia 		< nr_seq_lote_p  LIMIT 5) alias6
where	linha = nr_linha_p;

if (ie_informacao_p = 'L') then
	ds_retorno_w := substr(dt_liquidacao_w,1,10);
elsif (ie_informacao_p = 'V') then
	ds_retorno_w := campo_mascara_virgula(vl_titulo_w);
elsif (ie_informacao_p = 'M') then
	ds_retorno_w := substr(dt_mes_competencia_w,1,10);
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_inf_pagto_linha_novo ( nr_seq_prestador_p bigint, nr_linha_p bigint, ie_informacao_p text, nr_seq_lote_p pls_lote_pagamento.nr_sequencia%type) FROM PUBLIC;

