-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_seq_rel_laudo ( nr_prescricao_p bigint, nr_seq_prescr_p bigint) RETURNS bigint AS $body$
DECLARE


nr_seq_relatorio_w	bigint := 0;
cd_pessoa_fisica_w	varchar(10);
cd_setor_atendimento_w	bigint;


c01 CURSOR FOR
	SELECT	nr_seq_relatorio
	from	regra_layout_rel_laudo
	where	coalesce(cd_pessoa_fisica,cd_pessoa_fisica_w) = cd_pessoa_fisica_w
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w
	and	ie_situacao = 'A'
	order	by cd_pessoa_fisica, cd_setor_atendimento, nr_sequencia;


BEGIN


select 	max(u.cd_pessoa_fisica)
into STRICT	cd_pessoa_fisica_w
from	laudo_paciente l,
	usuario u
where	l.nr_prescricao 	= nr_prescricao_p
and	l.nr_seq_prescricao 	= nr_seq_prescr_p
and	u.nm_usuario		= l.nm_usuario_aprovacao
and	((coalesce(l.nr_seq_superior::text, '') = '') or (l.nr_seq_superior = 0));


select	coalesce(max(cd_setor_atendimento),0)
into STRICT	cd_setor_atendimento_w
from	prescr_procedimento
where	nr_prescricao	= nr_prescricao_p
and	nr_sequencia	= nr_seq_prescr_p;

open c01;
loop
fetch c01 into
	nr_seq_relatorio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	exit;

	end;
end loop;
close c01;


return	nr_seq_relatorio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_seq_rel_laudo ( nr_prescricao_p bigint, nr_seq_prescr_p bigint) FROM PUBLIC;

