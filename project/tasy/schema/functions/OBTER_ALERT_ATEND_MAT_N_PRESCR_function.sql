-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_alert_atend_mat_n_prescr ( cd_material_p bigint, cd_Setor_atendimento_p bigint, cd_convenio_p bigint) RETURNS varchar AS $body$
DECLARE


cd_material_w		bigint;
ds_mensagem_w		varchar(2000);

C01 CURSOR FOR
	SELECT	ds_mensagem
	FROM	regra_alerta_material
	WHERE	ie_situacao	= 'A'
	AND 	coalesce(ie_atend_prescr,'N') = 'S'
	AND 	coalesce(ie_mat_nao_prescr,'N') = 'S'
	AND	coalesce(cd_Setor_atendimento,cd_Setor_atendimento_p)	= cd_Setor_atendimento_p
	AND	coalesce(cd_material,cd_material_p)				= cd_material_p
	AND	coalesce(cd_convenio, cd_convenio_p)				= cd_convenio_p
	and	((coalesce(cd_perfil::text, '') = '') or (cd_perfil = obter_perfil_ativo))
	AND	((coalesce(nr_seq_estrutura::text, '') = '')	OR (consistir_se_mat_estrutura(nr_seq_estrutura,cd_material_w)	= 'S'))
	ORDER BY coalesce(qt_idade_min, 0),
		 coalesce(cd_material,0),
		 coalesce(nr_seq_estrutura,0),
		 coalesce(cd_Setor_atendimento,0),
		 coalesce(ie_via_aplicacao,'0'),
		 coalesce(cd_unidade_medida,'0'),
		 coalesce(cd_convenio,0);


BEGIN
begin

open C01;
loop
fetch C01 into
	ds_mensagem_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;

if (coalesce(ds_mensagem_w::text, '') = '') then

	cd_material_w := obter_material_generico(cd_material_w);

	open C01;
	loop
	fetch C01 into
		ds_mensagem_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;
end if;

exception
	when others then
	null;
	end;

return ds_mensagem_w;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_alert_atend_mat_n_prescr ( cd_material_p bigint, cd_Setor_atendimento_p bigint, cd_convenio_p bigint) FROM PUBLIC;

