-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_centro_nivel ( cd_centro_custo_p bigint, qt_nivel_p bigint) RETURNS varchar AS $body$
DECLARE


cd_classificacao_w	varchar(40);
cd_classif_w		varchar(40);
cd_centro_custo_w	integer;
i			integer;
k			integer;
cd_estabelecimento_w	integer;
ie_separador_centro_w	empresa.ie_sep_classif_centro%type;


BEGIN

ie_separador_centro_w	:= philips_contabil_pck.get_separador_centro;

select	max(cd_classificacao),
	max(cd_estabelecimento)
into STRICT	cd_classificacao_w,
	cd_estabelecimento_w
from	centro_custo
where	cd_centro_custo	= cd_centro_custo_p;

i			:= 0;
if (cd_classificacao_w IS NOT NULL AND cd_classificacao_w::text <> '') then
	i			:= 1;
	FOR k in 1..length(cd_classificacao_w) LOOP
		if (substr(cd_classificacao_w,k,1) = ie_separador_centro_w) then
			i	:= i + 1;
		end if;
	END LOOP;
end if;

if (i = 0) then
	cd_centro_custo_w	:= null;
elsif (i <= qt_nivel_p) then
	cd_centro_custo_w	:= cd_centro_custo_p;
else
	begin
	i			:= 0;
	FOR k in 1..length(cd_classificacao_w) LOOP
		if (substr(cd_classificacao_w,k,1) = ie_separador_centro_w) then
			i	:= i + 1;
		end if;
		if (i = qt_nivel_p) then
			cd_classif_w	:= substr(cd_classificacao_w,1, k -1);
			exit;
		end if;
	END LOOP;
	select	max(cd_centro_custo)
	into STRICT	cd_centro_custo_w
	from	centro_custo
	where	cd_classificacao	= cd_classif_w
	and	cd_estabelecimento	= cd_estabelecimento_w;
	end;
end if;

return cd_centro_custo_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_centro_nivel ( cd_centro_custo_p bigint, qt_nivel_p bigint) FROM PUBLIC;

