-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_permite_realizar_proc (nr_atendimento_p bigint, dt_inicio_real_p timestamp, dt_termino_p timestamp) RETURNS varchar AS $body$
DECLARE

 
ie_exec_proc_conta_fechada_w	varchar(1); -- 132 
ie_perm_env_proc_fim_conta_w	varchar(1); -- 196 
ie_perm_real_proc_sem_fim_w	varchar(1); -- 420 
ie_fim_conta_w			varchar(1);
dt_fim_conta_w			timestamp;
ie_conta_fechada_w		varchar(1);


BEGIN 
 
ie_exec_proc_conta_fechada_w := Obter_param_Usuario(900, 132, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_exec_proc_conta_fechada_w);
ie_perm_env_proc_fim_conta_w := Obter_param_Usuario(900, 196, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_perm_env_proc_fim_conta_w);
ie_perm_real_proc_sem_fim_w := Obter_param_Usuario(900, 420, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_perm_real_proc_sem_fim_w);
 
select	max(ie_fim_conta), 
	max(dt_fim_conta) 
into STRICT	ie_fim_conta_w, 
	dt_fim_conta_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_p;
 
if (coalesce(ie_fim_conta_w, 'X') = 'F') and (dt_fim_conta_w IS NOT NULL AND dt_fim_conta_w::text <> '') then 
	ie_conta_fechada_w := 'S';
else 
	ie_conta_fechada_w := 'N';
end if;
 
if (dt_inicio_real_p IS NOT NULL AND dt_inicio_real_p::text <> '') and 
	((ie_exec_proc_conta_fechada_w = 'S') or (ie_conta_fechada_w = 'N')) and 
	((ie_perm_real_proc_sem_fim_w = 'S') or (coalesce(dt_termino_p::text, '') = '')) and 
	((ie_perm_env_proc_fim_conta_w = 'S') or (ie_fim_conta_w = 'N')) then 
	return 'S';
else 
	return 'N';
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_permite_realizar_proc (nr_atendimento_p bigint, dt_inicio_real_p timestamp, dt_termino_p timestamp) FROM PUBLIC;

