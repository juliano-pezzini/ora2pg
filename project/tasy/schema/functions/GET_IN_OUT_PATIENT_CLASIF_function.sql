-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_in_out_patient_clasif ( patient_code_p text, transaction_time_p timestamp ) RETURNS varchar AS $body$
DECLARE

  bed_request_seq_w    bigint;
  bed_request_status_w varchar(2);
  c05 CURSOR FOR
    SELECT nr_sequencia bed_request_seq
    FROM gestao_vaga
    WHERE cd_pessoa_fisica = patient_code_p;

BEGIN
  OPEN c05;
  LOOP
    FETCH c05 INTO bed_request_seq_w;
    EXIT WHEN NOT FOUND; /* apply on c05 */
    BEGIN
      SELECT coalesce(ie_status, '-')
      INTO STRICT bed_request_status_w
      FROM gestao_vaga_hist_status
      WHERE nr_seq_gestao_vaga = bed_request_seq_w
      AND dt_atualizacao      <= transaction_time_p
      ORDER BY dt_atualizacao DESC  LIMIT 1;
    EXCEPTION
    WHEN no_data_found THEN
      bed_request_status_w := '-';
    END;
    IF (bed_request_status_w = 'F') THEN
      RETURN 'I'; -- Inpatient
    END IF;
  END LOOP;
RETURN 'O'; -- Outpatient
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_in_out_patient_clasif ( patient_code_p text, transaction_time_p timestamp ) FROM PUBLIC;

