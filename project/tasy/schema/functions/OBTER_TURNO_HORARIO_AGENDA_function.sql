-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_turno_horario_agenda (cd_agenda_p bigint, dt_horario_p text) RETURNS varchar AS $body$
DECLARE


cd_turno_w		varchar(1) := '0';
hr_turno_w		agenda.hr_quebra_turno%type;
hr_turno_not_w		agenda.hr_quebra_turno_not%type;
hr_quebra_turno_not_fim_w	agenda.hr_quebra_turno_not_fim%type;
qt_min_turno_w		agenda.qt_min_quebra_turno%type;
hr_horario_w		varchar(2);
qt_min_horario_w	varchar(2);


BEGIN
hr_horario_w := substr(dt_horario_p,1,2);
qt_min_horario_w := substr(dt_horario_p,4,2);

if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') then
	select	coalesce(max(hr_quebra_turno),'12'),
		coalesce(max(qt_min_quebra_turno),'00'),
		max(hr_quebra_turno_not),
		max(hr_quebra_turno_not_fim)
	into STRICT	hr_turno_w,
		qt_min_turno_w,
		hr_turno_not_w,
		hr_quebra_turno_not_fim_w
	from	agenda
	where	cd_agenda = cd_agenda_p;

	if (hr_horario_w > hr_turno_w) or
		(hr_horario_w = hr_turno_w AND qt_min_horario_w > qt_min_turno_w) then
		cd_turno_w := '1';--tarde
	end if;
	
	if (hr_turno_not_w IS NOT NULL AND hr_turno_not_w::text <> '') then
		if ((coalesce(hr_quebra_turno_not_fim_w::text, '') = '') and (hr_horario_w >= hr_turno_not_w) and (hr_horario_w < 24)) then
			cd_turno_w := '3';--noite
	
		elsif (hr_quebra_turno_not_fim_w IS NOT NULL AND hr_quebra_turno_not_fim_w::text <> '' AND ( or
			)) then
			cd_turno_w := '3';--noite
		end if;
	end if;
	
end if;

return cd_turno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_turno_horario_agenda (cd_agenda_p bigint, dt_horario_p text) FROM PUBLIC;

