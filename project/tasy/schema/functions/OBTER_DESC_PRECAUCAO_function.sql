-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_precaucao (nr_atendimento_p bigint, ds_param_390_cir_p text default null) RETURNS varchar AS $body$
DECLARE


ds_precaucao_w 			varchar(255);
ds_precaucao_concat_w 		varchar(4000);
ie_consiste_isolamento_w	varchar(1);
ie_isolamento_w			varchar(1);

c01 CURSOR FOR
        SELECT  distinct
		b.ds_precaucao,
		coalesce(b.ie_isolamento,'N')
        from    cih_precaucao b,
                atendimento_precaucao a
        where   a.nr_seq_precaucao = b.nr_sequencia
        and     a.nr_atendimento = nr_atendimento_p
        and     clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and coalesce(dt_termino,clock_timestamp() + interval '1 days')
	and	coalesce(dt_final_precaucao::text, '') = ''
	and	coalesce(a.ie_situacao,'A') = 'A'
        order by 1;


BEGIN

if (coalesce(nr_atendimento_p,0) > 0) then
	if (coalesce(ds_param_390_cir_p::text, '') = '') then
		ie_consiste_isolamento_w := Obter_Param_Usuario(871, 390, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_consiste_isolamento_w);
	else
		ie_consiste_isolamento_w := ds_param_390_cir_p;
	end if;
	open c01;
	loop
	fetch c01 into
			  ds_precaucao_w,
		ie_isolamento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
			  begin
		if	((ie_consiste_isolamento_w = 'N') or (ie_isolamento_w = 'S')) then
			if (ds_precaucao_concat_w IS NOT NULL AND ds_precaucao_concat_w::text <> '') then
				ds_precaucao_concat_w := substr(ds_precaucao_concat_w || ', ',1,4000);
			end if;
			ds_precaucao_concat_w := substr(ds_precaucao_concat_w || ds_precaucao_w,1,4000);
		end if;
		end;
	end loop;
	close c01;
end if;

return ds_precaucao_concat_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_precaucao (nr_atendimento_p bigint, ds_param_390_cir_p text default null) FROM PUBLIC;

