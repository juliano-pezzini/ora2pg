-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_verificar_existe_carteira (nr_carteira_p text) RETURNS varchar AS $body$
DECLARE

				
/* Valores de retorno:
S - Existe
N - Nao existe
V - Existe mas com validade vencida
R - Beneficiario rescindido
CA - Beneficiario ja cadastrado e ativo
CP - Beneficiario ja cadastrado e pendente
CI - Beneficiario ja cadastrado e inativo*/
				
ds_retorno_w			varchar(2) := 'S';
dt_validade_carteira_w	timestamp;
dt_rescisao_w			timestamp;
dt_rescisao_contrato_w	timestamp;
nr_seq_segurado_w		bigint;
ie_situacao_w			varchar(1);
nr_carteira_w			varchar(30);
ie_situacao_wsuite_w		wsuite_usuario.ie_situacao%type;
dt_ativacao_wsuite_w		wsuite_usuario.dt_ativacao%type;


BEGIN

nr_carteira_w := nr_carteira_p;

select	coalesce(max(nr_seq_segurado), 0)
into STRICT	nr_seq_segurado_w
from	pls_segurado_carteira
where	cd_usuario_plano = nr_carteira_w;

if (nr_seq_segurado_w > 0) then

	begin
		select 	ie_situacao,
			dt_ativacao
		into STRICT	ie_situacao_wsuite_w,
			dt_ativacao_wsuite_w
		from	wsuite_usuario
		where	nr_seq_segurado = nr_seq_segurado_w;	
	exception
	when others then
		ie_situacao_wsuite_w := null;
		dt_ativacao_wsuite_w := null;
	end;
	
	--Tratamento realizado para a utilizacao do TWS, quando usuario nao estiver ativo a situacao vai receber o valor P - Pendente 
	if ( ie_situacao_wsuite_w = 'I' and coalesce(dt_ativacao_wsuite_w::text, '') = '' ) then
			ie_situacao_w := 'P';
	else	
		select	max(ie_situacao)
		into STRICT	ie_situacao_w
		from	pls_segurado_web
		where	nr_seq_segurado = nr_seq_segurado_w
		and	(ds_senha IS NOT NULL AND ds_senha::text <> '');	
	end if;
	
	if (ie_situacao_w IS NOT NULL AND ie_situacao_w::text <> '') then
		ds_retorno_w := 'C' || ie_situacao_w;
	else
		select	max(a.dt_validade_carteira),
			max(b.dt_rescisao),
			max(c.dt_rescisao_contrato)
		into STRICT	dt_validade_carteira_w,
			dt_rescisao_w,
			dt_rescisao_contrato_w
		from	pls_segurado_carteira a,
			pls_segurado b,
			pls_contrato c
		where	b.nr_sequencia 		= nr_seq_segurado_w
		and	a.nr_seq_segurado 	= b.nr_sequencia
		and	b.nr_seq_contrato 	= c.nr_sequencia;
		
		--Segundo o Leonardo, se a data da rescisao for igual a data atual, ainda valida.
		if	(((dt_rescisao_w IS NOT NULL AND dt_rescisao_w::text <> '') and trunc(dt_rescisao_w) < trunc(clock_timestamp())) or ((dt_rescisao_contrato_w IS NOT NULL AND dt_rescisao_contrato_w::text <> '') and trunc(dt_rescisao_contrato_w) < trunc(clock_timestamp()))) then
			ds_retorno_w := 'R';
		elsif (dt_validade_carteira_w < clock_timestamp()) then
			ds_retorno_w := 'V';
		end if;
	end if;	
else
	ds_retorno_w := 'N';
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_verificar_existe_carteira (nr_carteira_p text) FROM PUBLIC;

