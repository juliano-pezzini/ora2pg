-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_voltas_os_dev ( nr_seq_ordem_p bigint, ds_filtro_p text default null, ie_filtro_p text default null, vl_divisor_p bigint default null) RETURNS bigint AS $body$
DECLARE


qt_voltas_w		integer := 0;
qt_voltas_filtro_w		integer := 0;

qt_voltas_calc_w		double precision := 0;

ie_entrou_rnd_w		varchar(1)	:=	'N';
ie_resp_rnd_w		varchar(1)	:=	'N';
ie_resp_sup_w		varchar(1)	:=	'N';

ie_fora_rnd_old_w		varchar(1)	:=	'N';

nr_seq_diretoria_w		gerencia_wheb.nr_seq_diretoria%type;
nr_seq_gerencia_w		gerencia_wheb.nr_sequencia%type;
nr_seq_grupo_des_w	grupo_desenvolvimento.nr_sequencia%type;
nm_usuario_w		man_ordem_serv_estagio.nm_usuario%type;
dt_filtro_grupo_w		timestamp;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.dt_atualizacao,
	a.nm_usuario,
	a.nr_seq_estagio,
	b.ds_estagio,
	coalesce(b.ie_aguarda_cliente,'N') ie_aguarda_cliente,
	coalesce(b.ie_suporte,'N') ie_suporte,
	coalesce(b.ie_desenv,'N') ie_desenv,
	coalesce(b.ie_tecnologia,'N') ie_tecnologia,
	coalesce(b.ie_projeto,'N') ie_projeto,
	coalesce(b.ie_testes,'N') ie_testes,
	coalesce(b.ie_qualidade,'N') ie_qualidade,
	coalesce(b.ie_sup_nivel2,'N') ie_sup_nivel2,
	coalesce(b.ie_infra,'N') ie_infra,
	coalesce(b.ie_design,'N') ie_design
from	man_ordem_serv_estagio a,
	man_estagio_processo b
where	a.nr_seq_estagio = b.nr_sequencia
and	a.nr_seq_ordem = nr_seq_ordem_p
order by	a.nr_sequencia;

c01_w	c01%rowtype;

				

BEGIN
open c01;
loop
fetch c01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
--	obter_area_gerencia_usuario(w.nm_usuario) = 'DES'
	if	((c01_w.ie_desenv = 'S') or (c01_w.ie_tecnologia = 'S')) then
		begin
		if (ie_fora_rnd_old_w = 'S') and (ie_entrou_rnd_w = 'S') then
			begin
			qt_voltas_w	:=	qt_voltas_w + 1;
			
			if (ie_filtro_p = 'D') and (somente_numero(ds_filtro_p) = nr_seq_diretoria_w) then
				qt_voltas_filtro_w	:=	qt_voltas_filtro_w + 1;
			elsif (ie_filtro_p = 'M') and (somente_numero(ds_filtro_p) = nr_seq_gerencia_w) then
				qt_voltas_filtro_w	:=	qt_voltas_filtro_w + 1;
			elsif (ie_filtro_p = 'G') and (somente_numero(ds_filtro_p) = nr_seq_grupo_des_w) then
				qt_voltas_filtro_w	:=	qt_voltas_filtro_w + 1;
			elsif (ie_filtro_p = 'U') and (ds_filtro_p = nm_usuario_w) then
				qt_voltas_filtro_w	:=	qt_voltas_filtro_w + 1;
			end if;
			end;
		end if;		
		
		ie_entrou_rnd_w		:=	'S';
		ie_fora_rnd_old_w	:=	'N';
		end;
	elsif (c01_w.nr_seq_estagio not in (511)) and -- 'Encerramento solicitado pelo cliente'
		((c01_w.ie_aguarda_cliente = 'S') or (c01_w.ie_projeto = 'S') or (c01_w.ie_testes = 'S')) then --solicitado ajuste para que considere somente cliente/vev/projeto (suporte n√£o deve considerar)
		begin
		if (ie_fora_rnd_old_w = 'N') then
			begin
			nm_usuario_w		:=	c01_w.nm_usuario;
			
			select	max(a.dt_atualizacao)
			into STRICT	dt_filtro_grupo_w
			from	man_ordem_log_grupo_des a
			where	a.nr_seq_ordem_serv = nr_seq_ordem_p
			and	a.dt_atualizacao < c01_w.dt_atualizacao;
			
			select	max(a.nr_seq_grupo_des)
			into STRICT	nr_seq_grupo_des_w
			from	man_ordem_log_grupo_des a
			where	a.nr_seq_ordem_serv = nr_seq_ordem_p
			and	a.dt_atualizacao = dt_filtro_grupo_w;
			
			begin
			select	b.nr_seq_diretoria,
				b.nr_sequencia
			into STRICT	nr_seq_diretoria_w,
				nr_seq_gerencia_w
			from	grupo_desenvolvimento a,
				gerencia_wheb b
			where	a.nr_seq_gerencia = b.nr_sequencia
			and	a.nr_sequencia = nr_seq_grupo_des_w;
			exception
			when others then
				nr_seq_diretoria_w	:=	null;
				nr_seq_gerencia_w	:=	null;
			end;
			end;
		end if;
		
		ie_fora_rnd_old_w	:=	'S';
		end;
	end if;
	end;
end loop;
close c01;

qt_voltas_calc_w	:=	qt_voltas_w;

if (vl_divisor_p > 0) then
	qt_voltas_calc_w	:=	trunc(dividir(qt_voltas_calc_w, vl_divisor_p));
end if;

if (coalesce(ie_filtro_p,'X') <> 'X') then
	qt_voltas_calc_w	:=	qt_voltas_calc_w * dividir(qt_voltas_filtro_w,qt_voltas_w);
end if;

return	qt_voltas_calc_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_voltas_os_dev ( nr_seq_ordem_p bigint, ds_filtro_p text default null, ie_filtro_p text default null, vl_divisor_p bigint default null) FROM PUBLIC;

