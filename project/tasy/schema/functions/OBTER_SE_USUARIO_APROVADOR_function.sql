-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_usuario_aprovador ( nr_seq_carta_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE

				
ds_retorno_w		varchar(1);
nr_seq_carta_mae_w 	carta_medica.nr_seq_carta_mae%type;


BEGIN

	select 	max(nr_seq_carta_mae)
	into STRICT	nr_seq_carta_mae_w
	from	carta_medica
	where	nr_sequencia = nr_seq_carta_p;

	select 	coalesce(max('S'),'N')
	into STRICT	ds_retorno_w
	from 	participante_carta_medica x
	where  	x.nr_seq_carta_mae = nr_seq_carta_mae_w
	and	lower(x.nm_usuario_resp) =  lower(nm_usuario_p)
	and	x.ie_deve_assinar = 'S';

	if (ds_retorno_w = 'N') then
		select 	coalesce(max('S'),'N')
		into STRICT	ds_retorno_w
		from 	medico_carta_medica a,
			medico_carta_medica_permit b,
			participante_carta_medica c
		where 	a.nr_sequencia = b.nr_seq_medico_carta_medica
		and 	c.nr_seq_carta_mae = nr_seq_carta_mae_w
		and   	a.cd_medico = obter_pessoa_fisica_usuario(c.nm_usuario_resp, 'C')
		and   	b.cd_medico = obter_pessoa_fisica_usuario(nm_usuario_p, 'C')	
		and	b.ie_situacao = 'A'
		and 	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
		and    	(((b.dt_inicio IS NOT NULL AND b.dt_inicio::text <> '') and (b.dt_fim IS NOT NULL AND b.dt_fim::text <> '') and clock_timestamp() between b.dt_inicio and b.dt_fim)
		or 	coalesce(b.dt_inicio::text, '') = '' and coalesce(b.dt_fim::text, '') = '');
	end if;

    begin
    if (ds_retorno_w <> 'S') then
        select coalesce(max('S'),'N') 
        into STRICT ds_retorno_w
        from medico_carta_medica a, medico_carta_medica_subst c , participante_carta_medica d
        where not exists    (SELECT b.nr_seq_medico_carta_medica 
                            from medico_carta_medica_permit b 
                            where b.nr_seq_medico_carta_medica = a.nr_sequencia
                            and	b.ie_situacao = 'A'
                            and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
                            and (((b.dt_inicio IS NOT NULL AND b.dt_inicio::text <> '') and (b.dt_fim IS NOT NULL AND b.dt_fim::text <> '') and clock_timestamp() between b.dt_inicio and b.dt_fim) or coalesce(b.dt_inicio::text, '') = '' and coalesce(b.dt_fim::text, '') = ''))
        and d.nr_seq_carta_mae = nr_seq_carta_mae_w                                        
        and a.cd_medico = obter_pessoa_fisica_usuario(d.nm_usuario_resp, 'C')
        and c.cd_pessoa_fisica = obter_pessoa_fisica_usuario(nm_usuario_p, 'C')
        and (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
        and c.ie_situacao = 'A';
    end if;
    exception
    when others then
    ds_retorno_w := 'N';
    end;

	return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_usuario_aprovador ( nr_seq_carta_p bigint, nm_usuario_p text) FROM PUBLIC;

