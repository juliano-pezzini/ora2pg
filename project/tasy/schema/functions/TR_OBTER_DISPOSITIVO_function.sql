-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tr_obter_dispositivo (nr_seq_solicitacao_p bigint) RETURNS varchar AS $body$
DECLARE


ds_proced_w   varchar(255);
ds_retorno_w  varchar(4000);
ds_retorno_ww varchar(4000);
nr_atendimento_w atendimento_paciente.nr_atendimento%type;
ds_disp_instalado_w varchar(1);

c01 CURSOR FOR
  SELECT obter_nome_dispositivo(nr_seq_dispositivo)
  from   trans_solic_dispositivo
  where  nr_seq_solicitacao = nr_seq_solicitacao_p
  order by nr_seq_solicitacao;


BEGIN
ds_disp_instalado_w := obter_param_usuario(10050, 12, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ds_disp_instalado_w);

if (nr_seq_solicitacao_p IS NOT NULL AND nr_seq_solicitacao_p::text <> '') then
 open c01;
 loop
 fetch c01 into
  ds_proced_w;
 EXIT WHEN NOT FOUND; /* apply on c01 */
  begin
  ds_retorno_w := ds_retorno_w||' - '||ds_proced_w;
  end;
 end loop;
 close c01;

 if (coalesce(ds_disp_instalado_w,'N') = 'S') then
  begin
   select  nr_atendimento
   into STRICT nr_atendimento_w
   from trans_solicitacao
   where nr_sequencia = nr_seq_solicitacao_p
   and  coalesce(nr_atendimento,0) > 0;

   ds_retorno_ww := substr(obter_dispositivo_pac_setor(nr_atendimento_w), 1, 4000);
  exception
  when others then
   nr_atendimento_w := 0;
  end;
 end if;
end if;

if (coalesce(ds_retorno_w::text, '') = '') then
	return ds_retorno_ww;
elsif (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') and (coalesce(ds_retorno_ww::text, '') = '') then
	return substr(ds_retorno_w,3,4000);
elsif (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') and (ds_retorno_ww IS NOT NULL AND ds_retorno_ww::text <> '') then
	return substr(ds_retorno_w||' - '||ds_retorno_ww,3,4000);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tr_obter_dispositivo (nr_seq_solicitacao_p bigint) FROM PUBLIC;

