-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_reacao_transfuncional ( cd_pessoa_fisica_p text, ie_opcao_p text ) RETURNS varchar AS $body$
DECLARE

 
/* 
ie_opcao_p 
DPF - Descrição localizando por pessoa física 
*/
 
 
ds_tipo_reacao_w	varchar(100);
nr_seq_evento_w		bigint;


BEGIN 
 
if (ie_opcao_p = 'DPF') then 
	begin 
	select	substr(obter_descricao_padrao('SAN_TIPO_REACAO','DS_TIPO_REACAO',nr_seq_reacao),1,100) 
	into STRICT	ds_tipo_reacao_w 
	from	prescr_solic_bco_sangue 
	where	nr_sequencia	=	(	SELECT	max(nr_sequencia) 
						from	prescr_solic_bco_sangue a, 
							prescr_medica b 
						where	a.nr_prescricao		=	b.nr_prescricao 
						and	b.cd_pessoa_fisica	=	cd_pessoa_fisica_p 
						and	(nr_seq_reacao IS NOT NULL AND nr_seq_reacao::text <> '') );
	exception 
	when others then 
		ds_tipo_reacao_w	:= null;
	end;
	 
	if (coalesce(ds_tipo_reacao_w::text, '') = '') then 
	 
		nr_seq_evento_w := OBTER_PARAM_USUARIO(450, 339, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, nr_seq_evento_w);
		 
		select substr(max(ds_evento),1,100) 
		into STRICT 	ds_tipo_reacao_w 
		from 	QUA_EVENTO_PACIENTE a, 
				atendimento_paciente b				 
		where 	a.nr_atendimento = b.nr_atendimento 
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
		and	 	a.nr_seq_evento = nr_seq_evento_w 
		and	 	b.cd_pessoa_fisica = cd_pessoa_fisica_p;
	end if;	
	 
end if;
 
return	ds_tipo_reacao_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_reacao_transfuncional ( cd_pessoa_fisica_p text, ie_opcao_p text ) FROM PUBLIC;

