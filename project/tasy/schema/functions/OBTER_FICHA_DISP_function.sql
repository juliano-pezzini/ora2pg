-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ficha_disp ( ie_opcao_p text, dt_inicio_p timestamp, dt_final_p timestamp, nr_seq_dispositivo_p bigint, cd_setor_p bigint, ds_filtro_p text default null) RETURNS bigint AS $body$
DECLARE

/* 
Total de dispositivos -dia			'TD' 
Total de eventos de Retirada de Dispositivos	'TR' 
*/
 
			 
ds_retorno_w		bigint;
ds_setor_w		varchar(255);
vl_pos_w		bigint;
	

BEGIN 
 
if (ds_filtro_p IS NOT NULL AND ds_filtro_p::text <> '') then 
   
ds_setor_w	:= ds_filtro_p;
vl_pos_w	:= position('#' in ds_setor_w);
 
while(vl_pos_w > 0) loop 
	ds_setor_w	:= substr(ds_setor_w, 1, vl_pos_w - 1) || chr(39)||','||chr(39) || substr(ds_setor_w, (vl_pos_w + 1), length(ds_setor_w )-1);
	vl_pos_w	:= position('#' in ds_setor_w);
end loop;
 
ds_setor_w := chr(39)||ds_setor_w||chr(39);
 
end if;
 
 
If (ie_opcao_p = 'TR') then 
 
	if (ds_setor_w IS NOT NULL AND ds_setor_w::text <> '') then 
	 
		select 	count(*) 
		into STRICT	ds_retorno_w 
		from	qua_evento_paciente a, 
			qua_tipo_evento b, 
			qua_evento c, 
			atend_pac_dispositivo d	 
		where 	b.ie_tipo_evento = 'RD' 
		and	b.nr_sequencia = c.nr_seq_tipo 
		and	d.nr_sequencia = a.nr_seq_disp_pac 
		and 	a.nr_seq_evento = c.nr_sequencia 
		and	trunc(dt_evento) between dt_inicio_p and coalesce(dt_final_p,dt_inicio_p) 
		and	a.cd_setor_atendimento = coalesce(cd_setor_p,a.cd_setor_atendimento) 
		and	Obter_Se_Contido_Filtro(obter_nome_setor(a.cd_setor_atendimento),ds_setor_w) = 'S';	
	 
	else 
	 
		select 	count(*) 
		into STRICT	ds_retorno_w 
		from	qua_evento_paciente a, 
			qua_tipo_evento b, 
			qua_evento c, 
			atend_pac_dispositivo d	 
		where 	b.ie_tipo_evento = 'RD' 
		and	b.nr_sequencia = c.nr_seq_tipo 
		and	d.nr_sequencia = a.nr_seq_disp_pac 
		and 	a.nr_seq_evento = c.nr_sequencia 
		and	trunc(dt_evento) between dt_inicio_p and coalesce(dt_final_p,dt_inicio_p) 
		and	a.cd_setor_atendimento = coalesce(cd_setor_p,a.cd_setor_atendimento);
	 
	end if;
	 
	 
elsif (ie_opcao_p = 'TD') then 
 
		if (ds_setor_w IS NOT NULL AND ds_setor_w::text <> '') then 
		 
		select 	count(*) 
		into STRICT	ds_retorno_w 
		from	atend_pac_dispositivo 
		where	nr_seq_dispositivo = coalesce(nr_seq_dispositivo_p,nr_seq_dispositivo) 
		and	((coalesce(dt_retirada::text, '') = '') or (trunc(dt_retirada) >= dt_inicio_p)) 
		and	Obter_Setor_Atendimento(nr_atendimento)= coalesce(cd_setor_p,Obter_Setor_Atendimento(nr_atendimento)) 
		and	Obter_Se_Contido_Filtro(obter_nome_setor(Obter_Setor_Atendimento(nr_atendimento)),ds_setor_w) = 'S';	
 
	else 
	 
		select 	count(*) 
		into STRICT	ds_retorno_w 
		from	atend_pac_dispositivo 
		where	nr_seq_dispositivo = coalesce(nr_seq_dispositivo_p,nr_seq_dispositivo) 
		and	((coalesce(dt_retirada::text, '') = '') or (trunc(dt_retirada) >= dt_inicio_p)) 
		and	Obter_Setor_Atendimento(nr_atendimento)= coalesce(cd_setor_p,Obter_Setor_Atendimento(nr_atendimento));
 
	 
	end if;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ficha_disp ( ie_opcao_p text, dt_inicio_p timestamp, dt_final_p timestamp, nr_seq_dispositivo_p bigint, cd_setor_p bigint, ds_filtro_p text default null) FROM PUBLIC;

