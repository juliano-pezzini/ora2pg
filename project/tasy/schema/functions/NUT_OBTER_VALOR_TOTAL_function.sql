-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nut_obter_valor_total (qt_componente_p bigint, nr_sequencia_p bigint, ie_opcao_p bigint) RETURNS bigint AS $body$
DECLARE


vl_custo_total_w	double precision;
vl_custo_total1_w 	double precision;
nr_seq_receita_w        bigint;
nr_qt_refeicao_w        bigint;
nr_seq_receita_ww       bigint;

/*
ie_opcao_P
1 - Receitas
2 - Cardapios
3 - Valor unitario
4 - planejamento com cardapio liberado

**/
C01 CURSOR FOR
	SELECT b.nr_seq_receita,
	       b.qt_refeicao
	from   nut_cardapio_dia a,
	       nut_pac_opcao_rec b
	where
 	       a.nr_sequencia = b.nr_seq_cardapio_dia
	and    a.nr_sequencia = nr_sequencia_p;

C02 CURSOR FOR	
	SELECT b.nr_seq_receita
	from   nut_cardapio_dia a,
	       nut_pac_opcao_rec b
	where
	       a.nr_sequencia = b.nr_seq_cardapio_dia
	and    a.nr_sequencia = nr_sequencia_p;


c03 CURSOR FOR

	SELECT b.nr_seq_receita
	from   nut_cardapio_dia a,
    	   nut_cardapio b
	where  b.nr_seq_card_dia = a.nr_sequencia
	and    a.nr_sequencia = nr_sequencia_p;	
BEGIN

	if ie_opcao_p = 1 then
		select sum(nut_obter_custo_gen(c.cd_material,b.qt_componente,a.qt_rendimento,qt_componente_p,c.qt_conversao,'T',c.nr_sequencia)) vl_custo_total
		into STRICT 	   vl_custo_total1_w
		from       nut_receita a,
			   nut_receita_comp b,
			   nut_genero_alim c
		where      a.nr_sequencia = b.nr_seq_receita
		and	   c.nr_sequencia = b.nr_seq_gen_alim
		and	   a.nr_sequencia = nr_sequencia_p;

		vl_custo_total_w := vl_custo_total1_w;
	end if;


	if ie_opcao_p = 2 then
		open C01;
		loop
		fetch C01 into
		      nr_seq_receita_w,
		      nr_qt_refeicao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

				select sum(nut_obter_custo_gen(c.cd_material,b.qt_componente,a.qt_rendimento,nr_qt_refeicao_w,c.qt_conversao,'T',c.nr_sequencia)) vl_custo_total
				into STRICT 	   vl_custo_total1_w
				from       nut_receita a,
					   nut_receita_comp b,
					   nut_genero_alim c
				where      a.nr_sequencia = b.nr_seq_receita
				and	   c.nr_sequencia = b.nr_seq_gen_alim
				and	   a.nr_sequencia = nr_seq_receita_w;
/*				Alterado para funcionar corretamente :)
				if (vl_custo_total_w is null) then
					vl_custo_total_w := vl_custo_total1_w;
				else 
					vl_custo_total_w := (vl_custo_total_w + vl_custo_total1_w);
				end if;*/
				vl_custo_total_w := (coalesce(vl_custo_total_w,0) + coalesce(vl_custo_total1_w,0));


			end;
		end loop;
		close C01;
	end if;

	if ie_opcao_p = 3 then
		vl_custo_total_w := 0;
		open C02;
		loop
		fetch C02 into
		      nr_seq_receita_ww;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

				select coalesce(sum(nut_obter_custo_gen(c.cd_material,b.qt_componente,a.qt_rendimento,1,c.qt_conversao,'U',c.nr_sequencia)),0) vl_custo_total
				into STRICT 	   vl_custo_total1_w
				from       nut_receita a,
					   nut_receita_comp b,
					   nut_genero_alim c
				where      a.nr_sequencia = b.nr_seq_receita
				and	   c.nr_sequencia = b.nr_seq_gen_alim
				and	   a.nr_sequencia = nr_seq_receita_ww;
			end;

			vl_custo_total_w := vl_custo_total_w + vl_custo_total1_w;			

		end loop;
		close C02;				
	end if;

	if ie_opcao_p = 4 then
		vl_custo_total_w := 0;
		for c03_w in c03 loop
			begin
				select  coalesce(sum(nut_obter_custo_gen(e.cd_material, d.qt_componente,c.qt_rendimento,qt_componente_p,e.qt_conversao, 'T', e.nr_sequencia)), 0) vl_custo_total
				into STRICT	vl_custo_total1_w
				from    nut_receita c,
						nut_receita_comp d,
						nut_genero_alim e
				where   c.nr_sequencia = d.nr_seq_receita
				and     e.nr_sequencia = d.nr_seq_gen_alim
				and     c.nr_sequencia = c03_w.nr_seq_receita;
				
				vl_custo_total_w := (coalesce(vl_custo_total_w,0) + coalesce(vl_custo_total1_w,0));
			end;
		end loop;
	end if;

return	vl_custo_total_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nut_obter_valor_total (qt_componente_p bigint, nr_sequencia_p bigint, ie_opcao_p bigint) FROM PUBLIC;

