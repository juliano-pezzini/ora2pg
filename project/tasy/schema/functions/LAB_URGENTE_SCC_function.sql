-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_urgente_scc (nr_prescricao_p bigint,nr_sequencia_p bigint, ie_tipo_return_p text) RETURNS varchar AS $body$
DECLARE
 ds_retorno_w		varchar(20);
  ie_tipoe_atendimento_w atendimento_paciente.ie_tipo_atendimento%type;
  dt_prev_execucao_w varchar(20);
  ie_urgencia_w varchar(1);
  --D - Data prevista

  --S - Sigla urgencia

  --DTAPR - Sigla data aprazamento
BEGIN
  ds_retorno_w := '';

  if ie_tipo_return_p = 'DTAPR' then
    select to_char(max(a.dt_horario), 'yyyymmddhh24mi')
    into STRICT ds_retorno_w
    from prescr_proc_hor a,
         Prescr_procedimento b
    where a.nr_prescricao = b.nr_prescricao
    and coalesce(a.nr_seq_proc_origem,a.nr_seq_procedimento) = b.nr_sequencia
    and b.nr_prescricao= nr_prescricao_p
    and b.nr_Sequencia=nr_sequencia_p;
  else
      select Obter_Tipo_Atendimento(nr_atendimento)
      into STRICT ie_tipoe_atendimento_w
      from prescr_medica
      where nr_prescricao = nr_prescricao_p;

       select ie_urgencia
      into STRICT ie_urgencia_w
      from prescr_procedimento 
      where nr_prescricao= nr_prescricao_p
      and nr_Sequencia=nr_sequencia_p;

      select to_char(coalesce(cpoe_obter_data_hora_form(c.dt_inicio,c.hr_prim_horario),p.dt_prev_execucao),'yyyymmddhh24mi')
      into STRICT dt_prev_execucao_w
      from  prescr_procedimento p
      left join  cpoe_procedimento c  on p.nr_seq_proc_cpoe = c.nr_sequencia
      where p.nr_prescricao= nr_prescricao_p
      and p.nr_Sequencia=nr_sequencia_p;

      if (ie_tipoe_atendimento_w = 1) then
        select CASE WHEN ie_urgencia='S' THEN 'U'  ELSE 'T' END 
          into STRICT ie_urgencia_w
        from prescr_procedimento 
        where nr_prescricao= nr_prescricao_p
          and nr_Sequencia=nr_sequencia_p;
      else
        select CASE WHEN ie_urgencia='S' THEN 'U'  ELSE 'R' END 
          into STRICT ie_urgencia_w
        from prescr_procedimento 
        where nr_prescricao= nr_prescricao_p
        and nr_Sequencia=nr_sequencia_p;
      end if;

      if (ie_tipo_return_p = 'D') then
        ds_retorno_w := dt_prev_execucao_w;
      else
        ds_retorno_w := ie_urgencia_w;
      end if;
  end if;

  return ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_urgente_scc (nr_prescricao_p bigint,nr_sequencia_p bigint, ie_tipo_return_p text) FROM PUBLIC;

