-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION search_chart_tubes_lines ( code_group_p text, nr_seq_pepo_p bigint, nr_cirurgia_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text, dt_atendimento_p timestamp, ie_em_andamento_p text) RETURNS SETOF GET_CHART_TUBES_LINES_TABLE AS $body$
DECLARE
 TYPE cursor_ref REFCURSOR;

name_w				varchar(80);
color_w				varchar(30);
dt_instalacao_w	timestamp;
end_date_w			timestamp;
code_chart_w		bigint;
nr_seq_apres_w		bigint;
dt_fim_w				timestamp;
ie_sucesso_w		varchar(15);
nr_atendimento_w	bigint;
nr_cirurgia_w		bigint;
nr_seq_pepo_w		bigint;
ie_permite_disp_alta_w varchar(15);
ie_exige_disp_grafico_w		varchar(15);


get_values_r		get_chart_tubes_lines_row := get_chart_tubes_lines_row(null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null);

tubes_and_lines CURSOR FOR
	SELECT	substr(b.ds_dispositivo,1,80) NAME,
				substr(Obter_Cor_Grafico_Dispositivo(nr_seq_dispositivo,'S'),1,30) COLOR,
				a.dt_instalacao,
				(clock_timestamp() + interval '8640 seconds') end_date,
				a.nr_sequencia code_chart,
				b.nr_seq_apres,
				a.dt_retirada dt_fim,
				coalesce(a.ie_sucesso,'S') ie_sucesso,
				a.nr_atendimento nr_Atendimento,
				a.nr_cirurgia nr_cirurgia,
				a.nr_seq_pepo nr_seq_pepo,
				coalesce(b.ie_permite_disp_alta,'N') ie_permite_disp_alta,
				obter_se_exibe_graf_disp(a.nr_sequencia) ie_exige_disp_grafico
	from   	dispositivo b,
				atend_pac_dispositivo a
	where 	a.nr_seq_dispositivo = b.nr_sequencia
	and		(((coalesce(nr_cirurgia_p,0) > 0) and (a.nr_cirurgia = nr_cirurgia_p)) or
				 ((coalesce(nr_cirurgia_p,0) = 0) and (coalesce(nr_seq_pepo_p,0) > 0) and (a.nr_seq_pepo = nr_seq_pepo_p)) or
				 ((coalesce(nr_cirurgia_p,0) = 0) and (coalesce(nr_seq_pepo_p,0) = 0) and (a.nr_atendimento = nr_atendimento_p) or (
																										 a.nr_atendimento in (
																															SELECT	a.nr_atendimento
																															from		atendimento_paciente a,
																																		atend_pac_dispositivo b
																															where		b.nr_atendimento 			= a.nr_atendimento
																															and 		a.cd_pessoa_fisica	 	= cd_pessoa_fisica_p
																															and		a.cd_estabelecimento 	= coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1)
																															and		(a.dt_alta IS NOT NULL AND a.dt_alta::text <> '')
																															and 		obter_se_dispo_usado_paciente(a.nr_atendimento) = 'S'
																															and 		coalesce(b.dt_retirada,clock_timestamp()) >= dt_atendimento_p
																										)
																										and coalesce(b.ie_permite_disp_alta,'N') = 'S'
																									)))
	and   	((coalesce(ie_em_andamento_p,'N') = 'N') or (coalesce(ie_em_andamento_p,'N') = 'S' and (coalesce(a.dt_retirada::text, '') = '')));


equipment CURSOR FOR
	SELECT 	substr(d.ds_equipamento,1,80) NAME,
				substr(obter_dados_equipamento(c.cd_equipamento,'COR','S'),1,30) COLOR,
				c.dt_inicio dt_instalacao,
				(clock_timestamp() + interval '8640 seconds') end_date,
				c.nr_sequencia code_chart,
				1 nr_seq_apres,
				c.dt_fim dt_fim,
				'S' ie_sucesso,
				c.nr_atendimento nr_Atendimento,
				c.nr_cirurgia nr_cirurgia,
				c.nr_seq_pepo nr_seq_pepo,
				null ie_permite_disp_alta
	from  	equipamento_cirurgia c,
				equipamento d
	where  	c.cd_equipamento = d.cd_equipamento
	and    	coalesce(obter_dados_equipamento(c.cd_equipamento,'GD'),'S') = 'S'
	and   	((coalesce(ie_em_andamento_p,'N') = 'N') or (coalesce(ie_em_andamento_p,'N') = 'S' and (coalesce(c.dt_fim::text, '') = '')))
	and    	(c.dt_inicio IS NOT NULL AND c.dt_inicio::text <> '')
	and		(((coalesce(nr_cirurgia_p,0) > 0) and (c.nr_cirurgia = nr_cirurgia_p)) or
				 ((coalesce(nr_cirurgia_p,0) = 0) and (coalesce(nr_seq_pepo_p,0) > 0) and (c.nr_seq_pepo = nr_seq_pepo_p)) or
				 ((coalesce(nr_cirurgia_p,0) = 0) and (coalesce(nr_seq_pepo_p,0) = 0) and (c.nr_atendimento = nr_atendimento_p)));




BEGIN

if (code_group_p = 'D') then
	open tubes_and_lines;
	loop
	fetch tubes_and_lines into
		name_w,
		color_w,
		dt_instalacao_w,
		end_date_w,
		code_chart_w,
		nr_seq_apres_w,
		dt_fim_w,
		ie_sucesso_w,
		nr_atendimento_w,
		nr_cirurgia_w,
		nr_seq_pepo_w,
		ie_permite_disp_alta_w,
		ie_exige_disp_grafico_w;
	EXIT WHEN NOT FOUND; /* apply on tubes_and_lines */
		begin
		if (ie_exige_disp_grafico_w = 'S') then
			get_values_r	:=	get_chart_tubes_lines_row(	name_w, 						--name
																		color_w,						--color
																		dt_instalacao_w,			--dt_instalacao
																		end_date_w,					--end_date
																		'D',							--code_group
																		code_chart_w,				--code_chart
																		nr_seq_apres_w,			--nr_seq_apres
																		dt_fim_w,					--dt_fim
																		ie_sucesso_w,				--ie_sucesso
																		nr_atendimento_w,			--nr_atendimento
																		nr_cirurgia_w,				--nr_cirurgia
																		nr_seq_pepo_w,				--nr_seq_pepo
																		ie_permite_disp_alta_w,	--ie_permite_disp_alta
																		'',							--description
																		null,							--max_scale
																		null,							--min_scale
																		'lines',						--style
																		null,							--shape
																		10,							--qt_size
																		'true',						--shaded
																		0,								--fixed_scale
																		null,							--fill_position
																		null);						--point_shape
			RETURN NEXT get_values_r;
		end if;
		end;
	end loop;
	close tubes_and_lines;
elsif (code_group_p = 'E') then
	open equipment;
	loop
	fetch equipment into
		name_w,
		color_w,
		dt_instalacao_w,
		end_date_w,
		code_chart_w,
		nr_seq_apres_w,
		dt_fim_w,
		ie_sucesso_w,
		nr_atendimento_w,
		nr_cirurgia_w,
		nr_seq_pepo_w,
		ie_permite_disp_alta_w;
	EXIT WHEN NOT FOUND; /* apply on equipment */
		begin
		get_values_r := 	get_chart_tubes_lines_row(name_w,						--name
																	color_w,						--color
																	dt_instalacao_w,			--dt_instalacao
																	end_date_w,					--end_date
																	'E',							--code_group
																	code_chart_w,				--code_chart
																	nr_seq_apres_w,			--nr_seq_apres
																	dt_fim_w,					--dt_fim
																	ie_sucesso_w,				--ie_sucesso
																	nr_atendimento_w,			--nr_atendimento
																	nr_cirurgia_w,				--nr_cirurgia
																	nr_seq_pepo_w,				--nr_seq_pepo
																	ie_permite_disp_alta_w,	--ie_permite_disp_alta
																	'',							--description
																	null,							--max_scale
																	null,							--min_scale
																	'lines',						--style
																	null,							--shape
																	10,							--qt_size
																	'true',						--shaded
																	0,								--fixed_scale
																	null,							--fill_position
																	null);						--point_shape);
		RETURN NEXT get_values_r;

		end;
	end loop;
	close equipment;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION search_chart_tubes_lines ( code_group_p text, nr_seq_pepo_p bigint, nr_cirurgia_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text, dt_atendimento_p timestamp, ie_em_andamento_p text) FROM PUBLIC;

