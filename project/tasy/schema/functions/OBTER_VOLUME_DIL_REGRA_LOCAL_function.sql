-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_volume_dil_regra_local ( nr_prescricao_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


cd_material_w			integer;
cd_medic_w			integer;
qt_dose_w			double precision;
qt_dose_ml_w			double precision;
cd_unid_med_dose_w		varchar(30) := '';
ds_material_w			varchar(100);
ds_material_ww			varchar(100);
ds_reduzida_w			varchar(100);
ds_diluir_w			varchar(255) := '';
ds_rediluir_w			varchar(255) := '';
ds_retorno_w			varchar(2000) := '';
ds_reconstituir_w		varchar(2000) := '';
ie_agrupador_w			smallint;
qt_dose_mat_w			double precision;
qt_dose_mat_str_w		varchar(20) := '';
cd_unid_med_dose_mat_w		varchar(30) := '';
qt_solucao_w			double precision := 0;
qt_solucao_str_w		varchar(10) :='';
qt_solucao_ww			double precision := 0;
qt_min_aplicacao_w		smallint  := 0;
qt_min_aplicacao_ant_w		smallint  := 0;
qt_hora_aplicacao_ant_w		smallint  := 0;
qt_hora_aplicacao_w		smallint  := 0;
ds_min_aplicacao_w		varchar(255) := '';
cd_volume_final_w		double precision := 0;
mascara_w			smallint := 0;
qt_dose_str_w			varchar(20) := '';
cd_volume_final_str_w		varchar(20) := '';
qt_diluicao_w			double precision := 0;
cd_diluente_w			integer  := 0;
ds_diluente_w			varchar(100) := '';
qt_diluicao_str_w		varchar(20) := '';
ds_intervalo_w			varchar(50) := '';
cd_unidade_medida_w		varchar(30);
ds_conv_ml_w			varchar(20) := '';
qt_conv_ml_w			double precision;
cd_estabelecimento_w		smallint;
ie_descr_redu_dil_w		varchar(1);

ds_aux_diluir_w			varchar(30);
ie_via_aplicacao_w		varchar(5);
cd_intervalo_w			varchar(7);
qt_ml_diluente_w		double precision;
ds_volume_w			varchar(100);
ds_tempo_w			varchar(100);
qt_dose_medic_ml_w		double precision;
ds_aplicar_w			varchar(200);
ds_diluicao_edit_w		varchar(2000);
ie_aplicar_w			varchar(1);
ds_dose_diluicao_w		varchar(100);
qt_dose_unid_med_cons_w		double precision;
qt_vol_adic_reconst_w		double precision;


c01 CURSOR FOR
	SELECT	a.cd_material,
		a.qt_dose,
		coalesce(a.qt_vol_adic_reconst,0),
		a.qt_min_aplicacao,
		a.qt_hora_aplicacao,
		a.cd_unidade_medida_dose,
		a.ie_agrupador,
		a.qt_solucao,
		obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose),
		substr(b.ds_material,1,100),
		substr(b.ds_reduzida,1,100)
	from 	material b,
		prescr_material a
	where 	((a.nr_sequencia_diluicao = nr_sequencia_p) or (a.nr_sequencia = nr_sequencia_p))
	  and 	a.nr_prescricao = nr_prescricao_p
	  and	a.cd_material = b.cd_material
	  and	a.ie_agrupador IN (3,7,9)
	order by a.ie_agrupador desc;


BEGIN

select	b.qt_dose,
	b.qt_min_aplicacao,
	b.qt_hora_aplicacao,
	b.cd_unidade_medida_dose,
	b.qt_solucao,
	b.cd_unidade_medida,
	b.cd_material,
	a.cd_estabelecimento,
	b.cd_intervalo,
	b.ie_via_aplicacao
into STRICT	qt_dose_mat_w,
	qt_min_aplicacao_w,
	qt_hora_aplicacao_w,
	cd_unid_med_dose_mat_w,
	qt_solucao_ww,
	cd_unidade_medida_w,
	cd_medic_w,
	cd_estabelecimento_w,
	cd_intervalo_w,
	ie_via_aplicacao_w
from 	prescr_material b,
	prescr_medica a
where 	a.nr_prescricao	= b.nr_prescricao
and	b.nr_sequencia	= nr_sequencia_p
and	a.nr_prescricao	= nr_prescricao_p
and	b.ie_agrupador	in (1,8, 14);

select	coalesce(max(ie_aplicar),'N')
into STRICT	ie_aplicar_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_w;

if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
	select	max(ds_prescricao)
	into STRICT	ds_intervalo_w
	from	intervalo_prescricao
	where	cd_intervalo	= cd_intervalo_w;

	if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
		ds_intervalo_w	:= ds_intervalo_w ||' '||ie_via_aplicacao_w;
	end if;
end if;

select	coalesce(max(ie_descr_redu_dil),'N')
into STRICT	ie_descr_redu_dil_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_w;

select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
into STRICT	qt_conv_ml_w
;

if (qt_conv_ml_w > 0) and (upper(cd_unid_med_dose_mat_w) <> upper(obter_unid_med_usua('ml'))) then
	if (qt_conv_ml_w >= 1) then
		ds_conv_ml_w	:= to_char(qt_conv_ml_w);
	else
		ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w);
	end if;
end if;

qt_dose_mat_str_w	:= qt_dose_mat_w;

open c01;
loop
fetch c01 into
	cd_material_w,
	qt_dose_w,
	qt_vol_adic_reconst_w,
	qt_min_aplicacao_ant_w,
	qt_hora_aplicacao_ant_w,
	cd_unid_med_dose_w,
	ie_agrupador_w,
	qt_solucao_w,
	qt_dose_ml_w,
	ds_material_ww,
	ds_reduzida_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 9) then
		begin

		select	obter_conversao_ml(cd_material_w,qt_dose_w + qt_vol_adic_reconst_w,cd_unid_med_dose_w)
		into STRICT	qt_conv_ml_w
		;

		if (upper(cd_unid_med_dose_mat_w) = upper(obter_unid_med_usua('ml'))) then
			begin
			qt_conv_ml_w	:= qt_dose_mat_w;
			end;
		else
			begin
			qt_dose_unid_med_cons_w	:= obter_conversao_unid_med_cons(cd_medic_w,cd_unid_med_dose_mat_w,qt_dose_mat_w);
			qt_conv_ml_w		:= qt_dose_unid_med_cons_w * qt_conv_ml_w;
			end;
		end if;

		if (qt_conv_ml_w > 0) then
			if (qt_conv_ml_w >= 1) then
				ds_conv_ml_w	:= to_char(qt_conv_ml_w);
			else
				ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w);
			end if;
		end if;

		select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
		into STRICT	ds_material_w
		;

		if (qt_dose_w < 1) or (mod(qt_dose_w, trunc(qt_dose_w)) <> 0) then
			mascara_w	:= 0;
		else
			mascara_w	:= 1;
		end if;

		Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_dose_w, 2)  ELSE campo_mascara(qt_dose_w, 0) END
		into STRICT	qt_dose_str_w
		;

		ds_reconstituir_w := 	ds_reconstituir_w ||wheb_mensagem_pck.get_texto(306838) ||' ' ||cd_unidade_medida_w||
				' ' || wheb_mensagem_pck.get_texto(306840) || ' '||replace(qt_dose_str_w,'.',',')||' '||cd_unid_med_dose_w||
				' ' || wheb_mensagem_pck.get_texto(306844) || ' '||ds_material_w || chr(13) || chr(10);
		end;
	end if;

	if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 3) then
		begin
		qt_ml_diluente_w	:= qt_dose_ml_w;
		select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
		into STRICT	ds_material_w
		;

		ds_aux_diluir_w	:= OBTER_DESC_EXPRESSAO(346572);
		if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
			ds_aux_diluir_w	:= OBTER_DESC_EXPRESSAO(346574);
		end if;

		ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' '||lower(obter_unid_med_usua('ml'));
		if (qt_dose_ml_w = 0) then
			begin
			ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') ||' '||cd_unid_med_dose_w;
			end;
		end if;

		if (coalesce(ds_conv_ml_w::text, '') = '') and (coalesce(ds_diluir_w::text, '') = '') then
			ds_diluir_w := 	substr(ds_diluir_w ||wheb_mensagem_pck.get_texto(306860) || ' '||replace(qt_dose_mat_str_w,'.',',')||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w||' ' || wheb_mensagem_pck.get_texto(306840) || ' '||
				ds_dose_diluicao_w||' ' || wheb_mensagem_pck.get_texto(306844) || ' '||ds_material_w || chr(13) || chr(10),1,255);
		elsif (coalesce(ds_diluir_w::text, '') = '') then
			ds_diluir_w := 	substr(ds_diluir_w ||wheb_mensagem_pck.get_texto(306860) || ' '||ds_conv_ml_w ||ds_aux_diluir_w||' ' || wheb_mensagem_pck.get_texto(306840) || ' '||
				ds_dose_diluicao_w||' ' || wheb_mensagem_pck.get_texto(306844) || ' '||ds_material_w || chr(13) || chr(10),1,255);
		else
			ds_diluir_w := 	substr(ds_diluir_w ||wheb_mensagem_pck.get_texto(306860) || ' '||  wheb_mensagem_pck.get_texto(306869) || ' '||
				ds_dose_diluicao_w ||' ' || wheb_mensagem_pck.get_texto(306844) || ' '||ds_material_w || chr(13) || chr(10),1,255);
		end if;
		end;
	end if;

	if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 7) then
		begin
		select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
		into STRICT	ds_material_w
		;

		cd_volume_final_w := qt_dose_ml_w + qt_solucao_w;

		if (qt_solucao_w < 1) or (mod(qt_solucao_w, trunc(qt_solucao_w)) <> 0) then
			mascara_w	:= 0;
		else
			mascara_w	:= 1;
		end if;

		ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' '||lower(obter_unid_med_usua('ml'));
		if (qt_dose_ml_w = 0) then
			begin
			ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') ||' '||cd_unid_med_dose_w;
			end;
		end if;

		Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_solucao_w, 2)  ELSE campo_mascara(qt_solucao_w, 0) END
		into STRICT	qt_solucao_str_w
		;

		ds_rediluir_w := ds_rediluir_w||wheb_mensagem_pck.get_texto(306848) || ' '||replace(qt_solucao_str_w,'.',',')||' '||lower(obter_unid_med_usua('ml'))||' ' || wheb_mensagem_pck.get_texto(309596) || ' '||
				 ds_dose_diluicao_w ||' ' || wheb_mensagem_pck.get_texto(306844) || ' '||ds_material_w || chr(13) || chr(10);
		end;
	end if;
	end;
end loop;
close c01;

if (cd_volume_final_w < 1) or (mod(cd_volume_final_w, trunc(cd_volume_final_w)) <> 0) then
	mascara_w	:= 0;
else
	mascara_w	:= 1;
end if;

Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(cd_volume_final_w, 2)  ELSE campo_mascara(cd_volume_final_w, 0) END
into STRICT	cd_volume_final_str_w
;

if (qt_solucao_ww IS NOT NULL AND qt_solucao_ww::text <> '') then
	ds_volume_w	:= to_char(qt_solucao_ww);
elsif (ie_aplicar_w = 'S') then
	begin
	if (ds_rediluir_w IS NOT NULL AND ds_rediluir_w::text <> '') then
		ds_volume_w := cd_volume_final_str_w;
	elsif (ds_diluir_w IS NOT NULL AND ds_diluir_w::text <> '') then
		ds_volume_w	:= to_char(qt_conv_ml_w + qt_ml_diluente_w);
	elsif (ds_conv_ml_w IS NOT NULL AND ds_conv_ml_w::text <> '') then
		ds_volume_w	:= ds_conv_ml_w;
	end if;
	end;
end if;

ds_volume_w		:= replace(ds_volume_w,'.',',');
ds_retorno_w	:= replace(ds_volume_w,' ,',' 0,');

RETURN	substr(ds_retorno_w,1,2000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_volume_dil_regra_local ( nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

