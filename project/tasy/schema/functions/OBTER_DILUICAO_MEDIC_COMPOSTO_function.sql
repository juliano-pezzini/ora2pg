-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_diluicao_medic_composto ( nr_sequencia_p bigint, nr_prescricao_p bigint, ie_descr_redu_dil_p text) RETURNS varchar AS $body$
DECLARE

 
cd_material_w			integer;
cd_medic_w			integer;
qt_dose_w			double precision;
qt_dose_ml_w			double precision;
cd_unid_med_dose_w		varchar(30) := '';
ds_material_w			varchar(100);
ds_material_ww			varchar(100);
ds_reduzida_w			varchar(100);
ds_diluir_w			varchar(255) := '';
ds_rediluir_w			varchar(255) := '';
ds_retorno_w			varchar(2000) := '';
ds_reconstituir_w		varchar(2000) := '';
ie_agrupador_w			smallint;
qt_dose_mat_w			double precision;
qt_totalml_reconst_w		double precision;
qt_dose_mat_str_w		varchar(20) := '';
cd_unid_med_dose_mat_w		varchar(30) := '';
qt_solucao_w			double precision := 0;
qt_solucao_str_w		varchar(10) :='';
qt_solucao_ww			double precision := 0;
qt_min_aplicacao_w		smallint := 0;
qt_min_aplicacao_ant_w		smallint := 0;
qt_hora_aplicacao_ant_w		smallint := 0;
qt_hora_aplicacao_w		smallint := 0;
ds_min_aplicacao_w		varchar(255) := '';
cd_volume_final_w		double precision := 0;
mascara_w			smallint := 0;
qt_dose_str_w			varchar(20) := '';
cd_volume_final_str_w		varchar(20) := '';
qt_diluicao_w			double precision := 0;
cd_diluente_w			integer := 0;
ds_diluente_w			varchar(100) := '';
qt_diluicao_str_w		varchar(20) := '';
ds_intervalo_w			varchar(50) := '';
cd_unidade_medida_w		varchar(30);
ds_conv_ml_w			varchar(20) := '';
qt_conv_ml_w			double precision;
cd_estabelecimento_w		smallint;
--ie_descr_redu_dil_p		varchar2(1); 
ds_material_princ_w		varchar(100);

ds_aux_diluir_w			varchar(30);
ie_via_aplicacao_w		varchar(5);
cd_intervalo_w			varchar(7);
qt_ml_diluente_w		double precision;
ds_volume_w			varchar(100);
ds_tempo_w			varchar(100);
qt_dose_medic_ml_w		double precision;
ds_aplicar_w			varchar(200);
ds_diluicao_edit_w		varchar(2000);
ie_aplicar_w			varchar(1);
ds_dose_diluicao_w		varchar(100);
qt_dose_unid_med_cons_w		double precision;
qt_vol_adic_reconst_w		double precision;

nr_agrupamento_w		double precision;
nr_sequencia_princ_w		bigint;
ds_material_composto_w		varchar(100);
qt_dose_composto_w		double precision;
cd_um_dose_composto_w		varchar(30);
ds_materiais_compostos_w	varchar(500);
nr_sequencia_composto_w		bigint;

qt_dose_mat_comp_w		double precision;
qt_min_aplicacao_comp_w		smallint := 0;
qt_hora_aplicacao_comp_w	smallint := 0;
cd_unid_med_dose_mat_comp_w	varchar(30);
qt_solucao_comp_ww		double precision := 0;
cd_unidade_medida_comp_w	varchar(30);
cd_medic_comp_w			integer;
cd_estabelecimento_comp_w	smallint;
cd_intervalo_comp_w		varchar(7);
ie_via_aplicacao_comp_w		varchar(5);

cd_material_comp_w		integer;
qt_dose_comp_w			double precision;
qt_vol_adic_reconst_comp_w	double precision;
qt_min_aplicacao_ant_comp_w	smallint := 0;
qt_hora_aplicacao_ant_comp_w	smallint := 0;
cd_unid_med_dose_comp_w		varchar(30);
ie_agrupador_comp_w		smallint;
qt_solucao_comp_w		double precision;
qt_dose_ml_comp_w		double precision;
ds_material_comp_ww		varchar(100);
ds_reduzida_comp_w		varchar(100);
ds_reconstituir_comp_w		varchar(2000);
ds_intervalo_comp_w		varchar(50);
qt_conv_ml_comp_w		double precision;
ds_conv_ml_comp_w		varchar(20) := '';
qt_dose_unid_med_cons_comp_w	double precision;
ds_material_comp_w		varchar(100);
cd_volume_final_comp_w		double precision;
cd_volume_final_str_comp_w	varchar(20) := '';
ds_aplicar_todos_comp_w		varchar(300);
ds_tempo_comp_w			varchar(100);
ds_aplicar_comp_w		varchar(200);
ds_volume_comp_w		varchar(100);
qt_conv_ml_tot_comp_w		double precision;
qt_dose_ml_diluicao_w		double precision := 0;
qt_agrupamento_w		bigint;
ds_volume_total_w		varchar(255);
ie_soma_total_w			varchar(2);

c01 CURSOR FOR 
	SELECT	a.cd_material, 
		a.qt_dose, 
		coalesce(a.qt_vol_adic_reconst,0), 
		a.qt_min_aplicacao, 
		a.qt_hora_aplicacao, 
		a.cd_unidade_medida_dose, 
		a.ie_agrupador, 
		a.qt_solucao, 
		obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose), 
		substr(b.ds_material,1,100), 
		substr(b.ds_reduzida,1,100) 
	from 	material b, 
		prescr_material a 
	where 	((a.nr_sequencia_diluicao = nr_sequencia_p) or (a.nr_sequencia = nr_sequencia_p)) 
	 and 	a.nr_prescricao = nr_prescricao_p 
	 and	a.cd_material = b.cd_material 
	 and	a.ie_agrupador in (3,7,9) 
	 and	coalesce(a.dt_suspensao::text, '') = '' 
	order by a.ie_agrupador desc;

c02 CURSOR FOR 
	SELECT	substr(CASE WHEN ie_descr_redu_dil_p='S' THEN a.ds_reduzida  ELSE a.ds_material END ,1,100), 
		b.qt_dose, 
		b.cd_unidade_medida_dose, 
		b.nr_sequencia 
	from	material a, 
		prescr_material b 
	where	a.cd_material = b.cd_material 
	and	b.nr_prescricao = nr_prescricao_p 
	and	nr_agrupamento = nr_agrupamento_w 
	and	b.nr_sequencia <> nr_sequencia_p 
	and	coalesce(b.dt_suspensao::text, '') = '' 
	and	b.ie_agrupador = 1;
/* 
cursor	c03 is 
	select	a.cd_material, 
		a.qt_dose, 
		nvl(a.qt_vol_adic_reconst,0), 
		a.qt_min_aplicacao, 
		a.qt_hora_aplicacao, 
		a.cd_unidade_medida_dose, 
		a.ie_agrupador, 
		a.qt_solucao, 
		obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose), 
		substr(b.ds_material,1,100), 
		substr(b.ds_reduzida,1,100) 
	from 	material b, 
		prescr_material a 
	where 	(a.nr_sequencia_diluicao = nr_sequencia_composto_w) 
	 and 	a.nr_prescricao = nr_prescricao_p 
	 and	a.cd_material = b.cd_material 
	 and	a.ie_agrupador in (3,7,9) 
	order by a.ie_agrupador desc; 
*/
 
c03 CURSOR FOR 
SELECT	a.cd_material, 
	a.qt_dose, 
	coalesce(a.qt_vol_adic_reconst,0), 
	a.qt_min_aplicacao, 
	a.qt_hora_aplicacao, 
	a.cd_unidade_medida_dose, 
	a.ie_agrupador, 
	a.qt_solucao, 
	obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose), 
	substr(b.ds_material,1,100), 
	substr(b.ds_reduzida,1,100), 
	'S' ie_soma_total 
from 	material b, 
	prescr_material a 
where 	a.nr_sequencia_diluicao	= nr_sequencia_composto_w 
and 	a.nr_prescricao = nr_prescricao_p 
and	a.cd_material = b.cd_material 
and	a.ie_agrupador in (3,7,9) 
and	coalesce(a.dt_suspensao::text, '') = '' 

union
 
SELECT	b.cd_material, 
	b.qt_dose, 
	coalesce(b.qt_vol_adic_reconst,0), 
	b.qt_min_aplicacao, 
	b.qt_hora_aplicacao, 
	b.cd_unidade_medida_dose, 
	b.ie_agrupador, 
	b.qt_solucao, 
	obter_conversao_ml(b.cd_material,b.qt_dose,b.cd_unidade_medida_dose), 
	substr(a.ds_material,1,100), 
	substr(a.ds_reduzida,1,100), 
	'S' ie_soma_total 
from	material a, 
	prescr_material b 
where	a.cd_material = b.cd_material 
and	b.nr_prescricao = nr_prescricao_p 
and	nr_agrupamento = nr_agrupamento_w 
and	b.nr_sequencia = nr_sequencia_composto_w 
and	b.ie_agrupador = 1 
and	coalesce(b.dt_suspensao::text, '') = '' 
and 	not exists (	select	1 
			from	prescr_material x 
			where	x.nr_prescricao = b.nr_prescricao 
			and	x.nr_sequencia_diluicao = b.nr_sequencia 
			and	ie_agrupador in (3,7,9) 
			and	coalesce(x.dt_suspensao::text, '') = '') 

union
 
select	b.cd_material, 
	b.qt_dose, 
	coalesce(b.qt_vol_adic_reconst,0), 
	b.qt_min_aplicacao, 
	b.qt_hora_aplicacao, 
	b.cd_unidade_medida_dose, 
	b.ie_agrupador, 
	b.qt_solucao, 
	obter_conversao_ml(b.cd_material,b.qt_dose,b.cd_unidade_medida_dose), 
	substr(a.ds_material,1,100), 
	substr(a.ds_reduzida,1,100), 
	'N' ie_soma_total 
from	material a, 
	prescr_material b 
where	a.cd_material = b.cd_material 
and	b.nr_prescricao = nr_prescricao_p 
and	nr_agrupamento = nr_agrupamento_w 
and	1 = 2 
and	b.nr_sequencia = nr_sequencia_p 
and	b.ie_agrupador = 1 
and	coalesce(b.dt_suspensao::text, '') = '';


BEGIN 
/* 
select	nvl(max(ie_descr_redu_dil),'N') 
into	ie_descr_redu_dil_p 
from	parametro_medico 
where	cd_estabelecimento	= cd_estabelecimento_w; */
 
 
 
select	max(ds_diluicao_edit), 
	max(nr_agrupamento) 
into STRICT	ds_diluicao_edit_w, 
	nr_agrupamento_w 
from	prescr_material 
where	nr_prescricao	= nr_prescricao_p 
and	nr_sequencia	= nr_sequencia_p;
 
select	count(*) 
into STRICT	qt_agrupamento_w 
from	prescr_material b 
where	b.nr_prescricao = nr_prescricao_p 
and	nr_agrupamento = nr_agrupamento_w 
and	b.nr_sequencia <> nr_sequencia_p 
and	b.ie_agrupador = 1 
and	coalesce(b.dt_suspensao::text, '') = '';
 
select	min(nr_sequencia) 
into STRICT	nr_sequencia_princ_w 
from	prescr_material 
where	ie_agrupador	= 1 
and	nr_agrupamento	= nr_agrupamento_w 
and	ie_item_superior = 'S' 
and	nr_prescricao	= nr_prescricao_p 
and	coalesce(dt_suspensao::text, '') = '';
 
if (coalesce(nr_sequencia_princ_w,0) = 0) then 
	select	min(nr_sequencia) 
	into STRICT	nr_sequencia_princ_w 
	from	prescr_material 
	where	ie_agrupador	= 1 
	and	nr_agrupamento	= nr_agrupamento_w 
	and	nr_prescricao	= nr_prescricao_p 
	and	coalesce(dt_suspensao::text, '') = '';
end if;
 
-- (ds_diluicao_edit_w is null) and 
if (nr_sequencia_princ_w = nr_sequencia_p) and (qt_agrupamento_w > 0) then 
 
	select	b.qt_dose, 
		b.qt_min_aplicacao, 
		b.qt_hora_aplicacao, 
		b.cd_unidade_medida_dose, 
		b.qt_solucao, 
		b.cd_unidade_medida, 
		b.cd_material, 
		a.cd_estabelecimento, 
		b.cd_intervalo, 
		b.ie_via_aplicacao, 
		substr(CASE WHEN ie_descr_redu_dil_p='S' THEN c.ds_reduzida  ELSE c.ds_material END ,1,100) 
	into STRICT	qt_dose_mat_w, 
		qt_min_aplicacao_w, 
		qt_hora_aplicacao_w, 
		cd_unid_med_dose_mat_w, 
		qt_solucao_ww, 
		cd_unidade_medida_w, 
		cd_medic_w, 
		cd_estabelecimento_w, 
		cd_intervalo_w, 
		ie_via_aplicacao_w, 
		ds_material_princ_w 
	from 	material c, 
		prescr_material b, 
		prescr_medica a 
	where 	a.nr_prescricao	= b.nr_prescricao 
	and	c.cd_material = b.cd_material 
	and	b.nr_sequencia	= nr_sequencia_p 
	and	a.nr_prescricao	= nr_prescricao_p 
	and	b.ie_agrupador	in (1, 14) 
	and	coalesce(b.dt_suspensao::text, '') = '';
 
	select	coalesce(max(ie_aplicar),'N') 
	into STRICT	ie_aplicar_w 
	from	parametro_medico 
	where	cd_estabelecimento	= cd_estabelecimento_w;
 
	if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then 
		select	max(ds_prescricao) 
		into STRICT	ds_intervalo_w 
		from	intervalo_prescricao 
		where	cd_intervalo	= cd_intervalo_w;
 
		if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then 
			ds_intervalo_w	:= ds_intervalo_w ||' '||ie_via_aplicacao_w;
		end if;
	end if;
 
	select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w) 
	into STRICT	qt_conv_ml_w 
	;
 
	if (qt_conv_ml_w > 0) and (upper(cd_unid_med_dose_mat_w) <> upper(obter_unid_med_usua('ML'))) then 
		if (qt_conv_ml_w >= 1) then 
			ds_conv_ml_w	:= to_char(qt_conv_ml_w)||' '||	obter_unid_med_usua('ml');
		else 
			ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w)||' '|| obter_unid_med_usua('ml');
		end if;
	end if;
 
	qt_dose_mat_str_w	:= qt_dose_mat_w;
 
	open	c01;
	loop 
	fetch	c01 into 
		cd_material_w, 
		qt_dose_w, 
		qt_vol_adic_reconst_w, 
		qt_min_aplicacao_ant_w, 
		qt_hora_aplicacao_ant_w, 
		cd_unid_med_dose_w, 
		ie_agrupador_w, 
		qt_solucao_w, 
		qt_dose_ml_w, 
		ds_material_ww, 
		ds_reduzida_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		 
		qt_totalml_reconst_w	:= coalesce(qt_totalml_reconst_w,0) + coalesce(qt_dose_ml_w,0);
 
		if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 9) then 
			begin 
 
			select	obter_conversao_ml(cd_material_w,qt_dose_w + qt_vol_adic_reconst_w,cd_unid_med_dose_w) 
			into STRICT	qt_conv_ml_w 
			;
 
			if (upper(cd_unid_med_dose_mat_w) = upper(obter_unid_med_usua('ML'))) then 
				begin 
				qt_conv_ml_w	:= qt_dose_mat_w;
				end;
			else 
				begin 
				qt_dose_unid_med_cons_w	:= obter_conversao_unid_med_cons(cd_medic_w,cd_unid_med_dose_mat_w,qt_dose_mat_w);
				qt_conv_ml_w		:= qt_dose_unid_med_cons_w * qt_conv_ml_w;
				end;
			end if;
 
			if (qt_conv_ml_w > 0) then 
				if (qt_conv_ml_w >= 1) then 
					ds_conv_ml_w	:= to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
				else 
					ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
				end if;
			end if;
 
			select 	CASE WHEN ie_descr_redu_dil_p='S' THEN ds_reduzida_w  ELSE ds_material_ww END  
		  	into STRICT	ds_material_w 
		  	;
 
			if (qt_dose_w < 1) or (mod(qt_dose_w, trunc(qt_dose_w)) <> 0) then 
				mascara_w	:= 0;
			else 
				mascara_w	:= 1;
			end if;
			 
			select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_dose_w, 2)  ELSE campo_mascara(qt_dose_w, 0) END  
			into STRICT	qt_dose_str_w 
			;
 
			ds_reconstituir_w := 	ds_reconstituir_w ||Wheb_mensagem_pck.get_texto(307023) || ' ' /*'Reconstituir cada '*/ ||cd_unidade_medida_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/ || ds_material_princ_w || 
					' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||replace(qt_dose_str_w,'.',',')||' '||cd_unid_med_dose_w|| 
					' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
			end;
		end if;
 
		if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 3) then 
		  	begin 
			qt_ml_diluente_w	:= qt_dose_ml_w;
			select 	CASE WHEN ie_descr_redu_dil_p='S' THEN ds_reduzida_w  ELSE ds_material_ww END  
		  	into STRICT	ds_material_w 
		  	;
 
			ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307083); --' do medicamento'; 
			if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
				ds_aux_diluir_w	:= ''; --' da reconstituição'; 
			end if;
 
			ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' '||obter_unid_med_usua('ml');
			qt_dose_ml_diluicao_w	:= coalesce(qt_dose_ml_w,0);
			if (qt_dose_ml_w = 0) then 
				begin 
				ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') ||' '||cd_unid_med_dose_w;
				qt_dose_ml_diluicao_w	:= coalesce(qt_dose_ml_w,0);
				end;
			end if;
			 
			/* 
			if	(ds_conv_ml_w is null) and 
				(ds_diluir_w is null) then 
				ds_diluir_w := 	ds_diluir_w ||'Diluir '||replace(qt_dose_mat_str_w,'.',',')||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w||' em '|| 
					ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10); 
			elsif	(ds_diluir_w is null) then 
		  		ds_diluir_w := 	ds_diluir_w ||'Diluir '||ds_conv_ml_w ||ds_aux_diluir_w||' em '|| 
					ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10); 
			else 
				ds_diluir_w := 	ds_diluir_w ||'Diluir a solução em '|| 
					ds_dose_diluicao_w ||' de '||ds_material_w || chr(13) || chr(10); 
			end if; 
			*/
 
			 
			if (coalesce(ds_conv_ml_w::text, '') = '') and (coalesce(ds_diluir_w::text, '') = '') then 
				ds_diluir_w := 	ds_diluir_w || ' ' || Wheb_mensagem_pck.get_texto(309431) || ' ' /*' e Diluir em '*/|| ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
			elsif (coalesce(ds_diluir_w::text, '') = '') then 
		  		ds_diluir_w := 	ds_diluir_w || ' ' || Wheb_mensagem_pck.get_texto(309431) || ' ' /*' e Diluir em '*/|| ds_dose_diluicao_w||' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
			else 
				ds_diluir_w := 	ds_diluir_w || ' ' || Wheb_mensagem_pck.get_texto(309432) || ' ' /*' e Diluir a solução em '*/|| ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
			end if;
			 
			 
		  	end;
		end if;
 
		if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 7) then 
		  	begin 
			select 	CASE WHEN ie_descr_redu_dil_p='S' THEN ds_reduzida_w  ELSE ds_material_ww END  
		  	into STRICT	ds_material_w 
		  	;
 
			cd_volume_final_w := qt_dose_ml_w + qt_solucao_w;
 
			if (qt_solucao_w < 1) or (mod(qt_solucao_w, trunc(qt_solucao_w)) <> 0) then 
				mascara_w	:= 0;
			else 
				mascara_w	:= 1;
			end if;
 
			ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' '||obter_unid_med_usua('ml');
			if (qt_dose_ml_w = 0) then 
				begin 
				ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') ||' '||cd_unid_med_dose_w;
				end;
			end if;
 
			select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_solucao_w, 2)  ELSE campo_mascara(qt_solucao_w, 0) END  
			into STRICT	qt_solucao_str_w 
			;
 
		  	ds_rediluir_w := ds_rediluir_w||Wheb_mensagem_pck.get_texto(307184) || ' ' /*'Rediluir '*/||replace(qt_solucao_str_w,'.',',')||' '||obter_unid_med_usua('ml')|| ' ' || Wheb_mensagem_pck.get_texto(309433) || ' ' /*' da solução em '*/|| 
					 ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
		  	end;
		end if;
		end;
	end loop;
	close c01;
 
	open C02;
	loop 
	fetch C02 into 
		ds_material_composto_w, 
		qt_dose_composto_w, 
		cd_um_dose_composto_w, 
		nr_sequencia_composto_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
 
		if (coalesce(ds_materiais_compostos_w::text, '') = '') then 
			ds_materiais_compostos_w	:= Wheb_mensagem_pck.get_texto(309434)||': '; --'ITENS COMPOSTOS:'; 
		end if;
 
		ds_materiais_compostos_w	:=	ds_materiais_compostos_w || chr(13) || chr(10) || 
							ds_material_composto_w || ' ' || Wheb_mensagem_pck.get_texto(309437) || ' ' /*' Dose: '*/ || to_char(qt_dose_composto_w) || ' ' || cd_um_dose_composto_w;
 
		select	b.qt_dose, 
			b.qt_min_aplicacao, 
			b.qt_hora_aplicacao, 
			b.cd_unidade_medida_dose, 
			b.qt_solucao, 
			b.cd_unidade_medida, 
			b.cd_material, 
			a.cd_estabelecimento, 
			b.cd_intervalo, 
			b.ie_via_aplicacao 
		into STRICT	qt_dose_mat_comp_w, 
			qt_min_aplicacao_comp_w, 
			qt_hora_aplicacao_comp_w, 
			cd_unid_med_dose_mat_comp_w, 
			qt_solucao_comp_ww, 
			cd_unidade_medida_comp_w, 
			cd_medic_comp_w, 
			cd_estabelecimento_comp_w, 
			cd_intervalo_comp_w, 
			ie_via_aplicacao_comp_w 
		from 	prescr_material b, 
			prescr_medica a 
		where 	a.nr_prescricao	= b.nr_prescricao 
		and	b.nr_sequencia	= nr_sequencia_composto_w 
		and	a.nr_prescricao	= nr_prescricao_p 
		and	b.ie_agrupador	in (1, 14) 
		and	coalesce(b.dt_suspensao::text, '') = '';
 
		if (cd_intervalo_comp_w IS NOT NULL AND cd_intervalo_comp_w::text <> '') then 
			select	max(ds_prescricao) 
			into STRICT	ds_intervalo_comp_w 
			from	intervalo_prescricao 
			where	cd_intervalo	= cd_intervalo_comp_w;
 
			if (ie_via_aplicacao_comp_w IS NOT NULL AND ie_via_aplicacao_comp_w::text <> '') then 
				ds_intervalo_comp_w	:= ds_intervalo_comp_w ||' '||ie_via_aplicacao_comp_w;
			end if;
		end if;
 
		select	obter_conversao_ml(cd_medic_comp_w,qt_dose_mat_comp_w,cd_unid_med_dose_mat_comp_w) 
		into STRICT	qt_conv_ml_comp_w 
		;
 
		if (qt_conv_ml_comp_w > 0) and (upper(cd_unid_med_dose_mat_comp_w) <> upper(obter_unid_med_usua('ML'))) then 
			if (qt_conv_ml_comp_w >= 1) then 
				ds_conv_ml_comp_w	:= to_char(qt_conv_ml_comp_w)||' '||obter_unid_med_usua('ml');
			else 
				ds_conv_ml_comp_w	:= '0'||to_char(qt_conv_ml_comp_w)||' '||obter_unid_med_usua('ml');
			end if;
		end if;
 
		qt_dose_mat_str_w	:= qt_dose_mat_w;
 
		open C03;
		loop 
		fetch C03 into 
			cd_material_comp_w, 
			qt_dose_comp_w, 
			qt_vol_adic_reconst_comp_w, 
			qt_min_aplicacao_ant_comp_w, 
			qt_hora_aplicacao_ant_comp_w, 
			cd_unid_med_dose_comp_w, 
			ie_agrupador_comp_w, 
			qt_solucao_comp_w, 
			qt_dose_ml_comp_w, 
			ds_material_comp_ww, 
			ds_reduzida_comp_w, 
			ie_soma_total_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
 
			if (cd_material_comp_w IS NOT NULL AND cd_material_comp_w::text <> '') and (qt_dose_comp_w IS NOT NULL AND qt_dose_comp_w::text <> '') and (cd_unid_med_dose_comp_w IS NOT NULL AND cd_unid_med_dose_comp_w::text <> '') and (ie_agrupador_comp_w in (1,3,9)) then 
				begin 
 
				select	obter_conversao_ml(cd_material_comp_w,qt_dose_comp_w + qt_vol_adic_reconst_comp_w,cd_unid_med_dose_comp_w) 
				into STRICT	qt_conv_ml_comp_w 
				;
				 
				if (ie_agrupador_comp_w <> 1) then 
					if (upper(cd_unid_med_dose_mat_comp_w) = upper(obter_unid_med_usua('ML'))) then 
						begin 
						qt_conv_ml_comp_w	:= qt_dose_mat_comp_w;
						end;
					else 
						begin 
						qt_dose_unid_med_cons_comp_w	:= obter_conversao_unid_med_cons(cd_medic_comp_w,cd_unid_med_dose_mat_comp_w,qt_dose_mat_comp_w);
						qt_conv_ml_comp_w		:= qt_dose_unid_med_cons_comp_w * qt_conv_ml_comp_w;
						end;
					end if;
				end if;
				 
				if (qt_conv_ml_comp_w > 0) then 
					if (qt_conv_ml_comp_w >= 1) then 
						ds_conv_ml_comp_w	:= to_char(qt_conv_ml_comp_w)||' '||obter_unid_med_usua('ml');
					else 
						ds_conv_ml_comp_w	:= '0'||to_char(qt_conv_ml_comp_w)||' '||obter_unid_med_usua('ml');
					end if;
				end if;
 
				select 	CASE WHEN ie_descr_redu_dil_p='S' THEN ds_reduzida_comp_w  ELSE ds_material_comp_ww END  
			  	into STRICT	ds_material_comp_w 
			  	;
 
				if (qt_dose_comp_w < 1) or (mod(qt_dose_w, trunc(qt_dose_comp_w)) <> 0) then 
					mascara_w	:= 0;
				else 
					mascara_w	:= 1;
				end if;
 
				select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_dose_comp_w, 2)  ELSE campo_mascara(qt_dose_comp_w, 0) END  
				into STRICT	qt_dose_str_w 
				;
				 
				if (ie_agrupador_comp_w = 9) then 
					ds_reconstituir_comp_w := 	ds_reconstituir_comp_w ||Wheb_mensagem_pck.get_texto(307023) || ' ' /*'Reconstituir cada '*/ ||cd_unidade_medida_comp_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/ || ds_material_composto_w || 
									' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||replace(qt_dose_str_w,'.',',')||' '||cd_unid_med_dose_comp_w|| 
									' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_comp_w || chr(13) || chr(10);
				end if;
 
				if (ie_soma_total_w	= 'S') then 
					qt_conv_ml_tot_comp_w	:= coalesce(qt_conv_ml_tot_comp_w,0) + coalesce(qt_conv_ml_comp_w,0);
				else 
					ds_material_composto_w	:= ds_material_comp_ww;
				end if;
 
				cd_volume_final_comp_w	:= coalesce(qt_dose_ml_comp_w,0) + coalesce(qt_solucao_comp_w,0);
 
				if (cd_volume_final_comp_w < 1) or (mod(cd_volume_final_comp_w, trunc(cd_volume_final_comp_w)) <> 0) then 
					mascara_w	:= 0;
				else 
					mascara_w	:= 1;
				end if;
 
				select 	CASE WHEN mascara_w=0 THEN  campo_mascara(cd_volume_final_comp_w, 2)  ELSE campo_mascara(cd_volume_final_comp_w, 0) END  
				into STRICT	cd_volume_final_str_comp_w 
				;
 
				/* 
				if	(qt_min_aplicacao_comp_w is not null) and 
					(qt_hora_aplicacao_comp_w is not null) then 
					ds_tempo_comp_w	:= ' em ' || to_char(qt_hora_aplicacao_comp_w) || ' h. e '|| to_char(qt_min_aplicacao_comp_w) || ' min.'; 
				elsif	(qt_min_aplicacao_comp_w is null) and 
					(qt_hora_aplicacao_comp_w is not null) then 
					ds_tempo_comp_w	:= ' em ' || to_char(qt_hora_aplicacao_comp_w) || ' h.'; 
				elsif	(qt_min_aplicacao_comp_w is not null) and 
					(qt_hora_aplicacao_comp_w is null) then 
					ds_tempo_comp_w	:= ' em ' || to_char(qt_min_aplicacao_comp_w) || ' min.'; 
				end if; 
				*/
 
							 
				if (qt_solucao_comp_ww IS NOT NULL AND qt_solucao_comp_ww::text <> '') then 
					ds_volume_comp_w	:= ' '||to_char(qt_solucao_comp_ww) ||' '||obter_unid_med_usua('ml');
				else 
					begin 
					if (ds_conv_ml_comp_w IS NOT NULL AND ds_conv_ml_comp_w::text <> '') then 
						ds_volume_comp_w	:= ' '||ds_conv_ml_comp_w;
					end if;
					end;
				end if;
				 
				if (ds_volume_comp_w IS NOT NULL AND ds_volume_comp_w::text <> '') then 
					ds_aplicar_comp_w	:= Wheb_mensagem_pck.get_texto(309441) /*'Aspirar'*/
 || replace(ds_volume_comp_w,'.',',') || ds_tempo_comp_w || ' ' ||Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/ || ds_material_composto_w;
				elsif (ds_tempo_comp_w IS NOT NULL AND ds_tempo_comp_w::text <> '') then 
					ds_aplicar_comp_w	:= Wheb_mensagem_pck.get_texto(309441) /*'Aspirar'*/
 || ds_tempo_comp_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/ || ds_material_composto_w;
				end if;
				 
				ds_aplicar_todos_comp_w := ds_aplicar_todos_comp_w || ' - ' || ds_aplicar_comp_w;
 
				end;
			end if;
 
			end;
		end loop;
		close C03;
 
		end;
	end loop;
	close C02;
 
	if (cd_volume_final_w < 1) or (mod(cd_volume_final_w, trunc(cd_volume_final_w)) <> 0) then 
		mascara_w	:= 0;
	else 
		mascara_w	:= 1;
	end if;
 
	select 	CASE WHEN mascara_w=0 THEN  campo_mascara(cd_volume_final_w, 2)  ELSE campo_mascara(cd_volume_final_w, 0) END  
	into STRICT	cd_volume_final_str_w 
	;
	 
	 
	if (qt_min_aplicacao_w IS NOT NULL AND qt_min_aplicacao_w::text <> '') and (qt_hora_aplicacao_w IS NOT NULL AND qt_hora_aplicacao_w::text <> '') then 
		ds_tempo_w	:= Wheb_mensagem_pck.get_texto(309443) || ' ' /*'Aplicar em '*/ || to_char(qt_hora_aplicacao_w) || ' ' || Wheb_mensagem_pck.get_texto(309411) || ' ' || /*' h. e '*/ PERFORM Wheb_mensagem_pck.get_texto(309413) || ' ' || to_char(qt_min_aplicacao_w) || ' ' || lower(Wheb_mensagem_pck.get_texto(309401)); --' min.'; 
	elsif (coalesce(qt_min_aplicacao_w::text, '') = '') and (qt_hora_aplicacao_w IS NOT NULL AND qt_hora_aplicacao_w::text <> '') then
		ds_tempo_w	:= Wheb_mensagem_pck.get_texto(309443) || ' ' /*'Aplicar em '*/ || to_char(qt_hora_aplicacao_w) || ' ' || Wheb_mensagem_pck.get_texto(309411); --' h.'; 
	elsif (qt_min_aplicacao_w IS NOT NULL AND qt_min_aplicacao_w::text <> '') and (coalesce(qt_hora_aplicacao_w::text, '') = '') then
		ds_tempo_w	:= Wheb_mensagem_pck.get_texto(309443) || ' ' /*'Aplicar em '*/ || to_char(qt_min_aplicacao_w) || ' ' || Wheb_mensagem_pck.get_texto(309408) || '.'; --' min.'; 
	end if;
	 
	 
	if (qt_solucao_ww IS NOT NULL AND qt_solucao_ww::text <> '') then 
		ds_volume_w	:= ' '||to_char(qt_solucao_ww) ||' '||obter_unid_med_usua('ml');
	elsif (ie_aplicar_w = 'S') then 
		begin 
		if (ds_conv_ml_w IS NOT NULL AND ds_conv_ml_w::text <> '') then 
			ds_volume_w	:= ' '||ds_conv_ml_w;
		end if;
		end;
	end if;
	 
	if (ds_volume_w IS NOT NULL AND ds_volume_w::text <> '') then 
		ds_aplicar_w	:= Wheb_mensagem_pck.get_texto(309441) /*'Aspirar'*/
|| replace(ds_volume_w,'.',',') || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/ || ds_material_princ_w;
	--elsif	(ds_tempo_w is not null) then 
	--	ds_aplicar_w	:= 'Aspirar'||ds_tempo_w || ' de ' || ds_material_princ_w; 
	end if;
	 
 
	ds_retorno_w := ds_reconstituir_w; -- || ds_diluir_w || ds_rediluir_w; || ds_aplicar_w; 
	ds_retorno_w	:= replace(ds_retorno_w,' ,',' 0,');
	ds_retorno_w	:= replace(ds_retorno_w,' .',' 0,');
	 
	ds_retorno_w := ds_materiais_compostos_w || chr(13) || chr(10) || chr(13) || chr(10) || 
			ds_retorno_w || 
			ds_reconstituir_comp_w || chr(13) || chr(10) || 
			ds_aplicar_w || 
			ds_aplicar_todos_comp_w || ds_diluir_w;
	 
	ds_volume_total_w := null;
	 
	if	((coalesce(qt_conv_ml_tot_comp_w,0) + coalesce(qt_conv_ml_w,0) + coalesce(qt_dose_ml_diluicao_w,0)) > 0) then 
		ds_volume_total_w := chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(309446) || ': ' /*'Volume total: '*/ || to_char(coalesce(qt_conv_ml_tot_comp_w,0) + coalesce(qt_conv_ml_w,0) + coalesce(qt_dose_ml_diluicao_w,0));
	elsif (coalesce(qt_totalml_reconst_w,0) > 0) then 
		ds_volume_total_w := chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(309446) || ': ' /*'Volume total: '*/ || to_char(coalesce(qt_totalml_reconst_w,0));
	else 
		ds_volume_total_w := chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(309446) || ': ' /*'Volume total: '*/ || to_char(qt_conv_ml_w);
	end if;
	 
	if (ds_tempo_w IS NOT NULL AND ds_tempo_w::text <> '') then 
		ds_volume_total_w := ds_tempo_w || chr(13) || chr(10) || ds_volume_total_w;
	end if;
	 
	if (ds_volume_total_w IS NOT NULL AND ds_volume_total_w::text <> '') then 
		ds_retorno_w := ds_retorno_w || ds_volume_total_w;	
	end if;
	 
else 
 
	select	max(CASE WHEN coalesce(nr_seq_atendimento::text, '') = '' THEN  a.qt_dose  ELSE Obter_dose_medic_atend(a.nr_seq_atendimento, a.nr_seq_material) END  || ' ' || CASE WHEN coalesce(nr_seq_atendimento::text, '') = '' THEN  coalesce(a.cd_unidade_medida_dose, a.cd_unidade_medida)  ELSE Obter_UM_dose_medic_atend(a.nr_seq_atendimento, a.nr_seq_material) END ) 
	into STRICT	ds_volume_total_w 
	from	prescr_mat_hor b, 
		prescr_material a 
	where	a.nr_prescricao		= b.nr_prescricao 
	and   a.nr_sequencia		= b.nr_seq_material 
	and	b.nr_prescricao		= nr_prescricao_p 
	and	b.nr_seq_material	= nr_sequencia_p 
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S';
 
	ds_retorno_w	:= Obter_Diluicao_Medic(nr_sequencia_p, nr_prescricao_p) || chr(13) || chr(10) || 
				Wheb_mensagem_pck.get_texto(309446) || ': ' /*'Volume total: '*/ || coalesce(Obter_Volume_Total_Diluicao(nr_sequencia_p, nr_prescricao_p),ds_volume_total_w);
end if;
 
return substr(ds_retorno_w,1,2000);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_diluicao_medic_composto ( nr_sequencia_p bigint, nr_prescricao_p bigint, ie_descr_redu_dil_p text) FROM PUBLIC;

