-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_pf_nf (value_p bigint, ie_tipo bigint default 1) RETURNS bigint AS $body$
DECLARE


cd_pessoa_fisica_w   bigint;
nr_seq_lote_fornec_w bigint;
nr_sequencia_nf_w	 bigint;


BEGIN
if (ie_tipo = 1)then
begin
	select nr_seq_lote_fornec
	into STRICT nr_seq_lote_fornec_w
	from movimento_estoque 
	where nr_movimento_estoque = value_p;

	select nr_sequencia_nf
	into STRICT nr_sequencia_nf_w
	from material_lote_fornec 
	where nr_sequencia = nr_seq_lote_fornec_w;
	
	if (coalesce(nr_sequencia_nf_w::text, '') = '') then
		select	max(nr_sequencia_nf)
		into STRICT	nr_sequencia_nf_w
		from	material_lote_fornec_nf
		where	nr_seq_lote_fornec = nr_seq_lote_fornec_w;
	end if;

	select cd_pessoa_fisica
	into STRICT cd_pessoa_fisica_w
	from nota_fiscal 
	where nr_sequencia = nr_sequencia_nf_w
	and IE_TIPO_NOTA = 'EF';
end;
elsif (ie_tipo = 2)then	
begin
	select nr_sequencia_nf
	into STRICT nr_sequencia_nf_w
	from material_lote_fornec 
	where nr_sequencia = value_p;
	
	if (coalesce(nr_sequencia_nf_w::text, '') = '') then
		select	max(nr_sequencia_nf)
		into STRICT	nr_sequencia_nf_w
		from	material_lote_fornec_nf
		where	nr_seq_lote_fornec = nr_seq_lote_fornec_w;
	end if;

	select cd_pessoa_fisica
	into STRICT cd_pessoa_fisica_w
	from nota_fiscal 
	where nr_sequencia = nr_sequencia_nf_w
	and ie_tipo_nota = 'EF';
end;
elsif (ie_tipo = 3)then
begin
	select cd_pessoa_fisica
	into STRICT cd_pessoa_fisica_w
	from nota_fiscal
	where nr_sequencia = value_p
	and ie_tipo_nota = 'EF';
end;
else
	cd_pessoa_fisica_w := null;
end if;
	
return cd_pessoa_fisica_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_pf_nf (value_p bigint, ie_tipo bigint default 1) FROM PUBLIC;

