-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION check_dt_mipres ( nr_sequencia_p agenda_paciente.nr_sequencia%type, nr_seq_agenda_p text, dt_validity_mipres_p timestamp, cd_agenda_p agenda.cd_agenda%type default null, nr_seq_agenda_int_p agenda_integrada.nr_sequencia%type default null) RETURNS varchar AS $body$
DECLARE


ie_tipo_agenda_w    agenda.cd_tipo_agenda%type;
ie_return_w         varchar(1);


BEGIN

    ie_return_w := 'N';

    if (nr_seq_agenda_int_p IS NOT NULL AND nr_seq_agenda_int_p::text <> '') then

        select 	coalesce(max('S'),'N')
        into STRICT    ie_return_w
        from	agenda_integrada ai
        where	ai.nr_sequencia = nr_seq_agenda_int_p
        and ((ai.dt_inicio_agendamento IS NOT NULL AND ai.dt_inicio_agendamento::text <> '') and trunc(ai.dt_inicio_agendamento) > trunc(dt_validity_mipres_p));

    elsif (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '' AND dt_validity_mipres_p IS NOT NULL AND dt_validity_mipres_p::text <> '') then

        select  obter_tipo_agenda(cd_agenda_p)
        into STRICT    ie_tipo_agenda_w
;

        if (ie_tipo_agenda_w = 2)then
            select 	coalesce(max('S'),'N') 
            into STRICT    ie_return_w
            from	agenda_paciente ap
            where	ap.nr_sequencia = nr_sequencia_p
            and ((ap.dt_agenda IS NOT NULL AND ap.dt_agenda::text <> '') and trunc(ap.dt_agenda) > trunc(dt_validity_mipres_p));
        elsif (ie_tipo_agenda_w = 3 or ie_tipo_agenda_w = 5)then
            select 	coalesce(max('S'),'N')
            into STRICT    ie_return_w
            from	agenda_consulta ac
            where	ac.nr_sequencia = nr_seq_agenda_p
            and ((ac.dt_agenda IS NOT NULL AND ac.dt_agenda::text <> '') and trunc(ac.dt_agenda) > trunc(dt_validity_mipres_p));
        end if;
    end if;
	
return ie_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION check_dt_mipres ( nr_sequencia_p agenda_paciente.nr_sequencia%type, nr_seq_agenda_p text, dt_validity_mipres_p timestamp, cd_agenda_p agenda.cd_agenda%type default null, nr_seq_agenda_int_p agenda_integrada.nr_sequencia%type default null) FROM PUBLIC;

