-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_itens_prescr ( nr_prescricao_p bigint, ds_itens_prescr_p text default null) RETURNS varchar AS $body$
DECLARE


qt_registro_w		bigint;
qt_registro_medic_w	bigint	:= 0;
qt_registro_mat_w	bigint	:= 0;
qt_registro_sne_w	bigint	:= 0;
qt_registro_supl_w	bigint	:= 0;
ds_result_w			varchar(500);
ie_agrupador_w		smallint;

C01 CURSOR FOR
	SELECT	count(*),
			ie_agrupador
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_p
	and		ie_agrupador in (1,2,5,8,12)
	and		coalesce(ie_suspenso,'N') = 'N'
	group by ie_agrupador;


BEGIN
if (ds_itens_prescr_p IS NOT NULL AND ds_itens_prescr_p::text <> '') then
	return ds_itens_prescr_p;
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_procedimento
where	nr_prescricao	= nr_prescricao_p
and		coalesce(coalesce(nr_seq_origem,nr_seq_exame)::text, '') = ''
and		((obter_se_valor_contido(ie_tipo_proced,'O,IVC') = 'S') or (coalesce(nr_seq_proc_interno::text, '') = '') or (obter_se_valor_contido(Obter_tipo_proc_interno(nr_seq_proc_interno),'O,IVC') = 'S'))
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= wheb_mensagem_pck.get_texto(309515) || ' '|| qt_registro_w; -- Proc
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_procedimento
where	nr_prescricao	= nr_prescricao_p
and		obter_se_valor_contido(ie_tipo_proced,'AP,APC,APH') = 'S'
and		(nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '')
and		obter_se_valor_contido(Obter_tipo_proc_interno(nr_seq_proc_interno), 'AP,APC,APH') = 'S'
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w || ' ' || wheb_mensagem_pck.get_texto(309523) || ' ' || qt_registro_w; -- Anat
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_procedimento
where	nr_prescricao	= nr_prescricao_p
and		coalesce(nr_seq_origem::text, '') = ''
and		(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '')
and		((Obter_se_valor_contido(ie_tipo_proced,'O,IVC') = 'S') or (coalesce(nr_seq_proc_interno::text, '') = '') or (obter_se_valor_contido(Obter_tipo_proc_interno(nr_seq_proc_interno),'O,IVC') = 'S'))
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w || ' ' || wheb_mensagem_pck.get_texto(309524) || ' '|| qt_registro_w; -- Lab
end if;

open C01;
loop
fetch C01 into
	qt_registro_w,
	ie_agrupador_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (ie_agrupador_w = 1) then
		Qt_registro_medic_w	:= qt_registro_w;
	elsif (ie_agrupador_w = 2) then
		Qt_registro_mat_w	:= qt_registro_w;
	elsif (ie_agrupador_w = 8) then
		Qt_registro_SNE_w	:= qt_registro_w;
	elsif (ie_agrupador_w = 12) then
		Qt_registro_supl_w	:= qt_registro_w;
	end if;
	end;
end loop;
close C01;

if (Qt_registro_medic_w > 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309525) || ' '|| Qt_registro_medic_w; -- Medic
end if;

if (Qt_registro_SNE_w > 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309526) || ' '|| Qt_registro_SNE_w; -- SNE
end if;

if (Qt_registro_supl_w > 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309528) || ' '|| Qt_registro_supl_w; -- Supl
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_solucao
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N'
and		coalesce(ie_hemodialise,'N')	= 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309531) || ' '|| qt_registro_w; -- Sol
end if;

select	count(*)
into STRICT	qt_registro_w
from	hd_prescricao where		nr_prescricao	= nr_prescricao_p LIMIT 1;

if (qt_registro_w <> 0) then
	select	count(*)
	into STRICT	qt_registro_w
	from	prescr_solucao
	where	nr_prescricao	= nr_prescricao_p
	and		coalesce(ie_suspenso,'N') = 'N'
	and		coalesce(ie_hemodialise,'N')	= 'S';

	if (qt_registro_w <> 0) then
		ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309534) || ' '|| qt_registro_w; -- Sol HD
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	prescr_solucao
	where	nr_prescricao	= nr_prescricao_p
	and		coalesce(ie_suspenso,'N') = 'N'
	and		coalesce(ie_hemodialise,'N')	= 'P';

	if (qt_registro_w <> 0) then
		ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309538) || ' '|| qt_registro_w; -- Sol DP
	end if;
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_dieta
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w||' ' || wheb_mensagem_pck.get_texto(309539) || ' '|| qt_registro_w; -- Dieta
end if;

select	count(*)
into STRICT	qt_registro_w
from	rep_jejum
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w||' ' || wheb_mensagem_pck.get_texto(309541) || ' '|| qt_registro_w; -- Jejum
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_recomendacao
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309544) || ' '|| qt_registro_w; -- Rec
end if;

select	count(*)
into STRICT	qt_registro_w
from	nut_paciente
where	nr_prescricao = nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

select	count(*) + qt_registro_w
into STRICT	qt_registro_w
from	nut_pac
where	nr_prescricao = nr_prescricao_p
and		coalesce(ie_npt_adulta,'N')  = 'S'
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w||' ' || wheb_mensagem_pck.get_texto(309545) || ' '|| qt_registro_w; -- NPTA
end if;

select	count(*)
into STRICT	qt_registro_w
from	nut_pac
where	nr_prescricao	= nr_prescricao_p
and 	coalesce(ie_npt_adulta,'N') not in ('S', 'P')
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w||' ' || wheb_mensagem_pck.get_texto(309546) || ' '|| qt_registro_w; -- NPTN
end if;

select	count(*)
into STRICT	qt_registro_w
from	nut_pac
where	nr_prescricao	= nr_prescricao_p
and 	coalesce(ie_npt_adulta,'N') = 'P'
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w||' ' || wheb_mensagem_pck.get_texto(458619) || ' '|| qt_registro_w; -- NPTP
end if;



select	count(*)
into STRICT	qt_registro_w
from	prescr_solic_bco_sangue a,
		prescr_medica b
where	a.nr_prescricao	= nr_prescricao_p
and		a.nr_prescricao = b.nr_prescricao
and		coalesce(b.dt_suspensao::text, '') = '';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309547) || ' '|| qt_registro_w; -- Sangue
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_leite_deriv
where	nr_prescricao = nr_prescricao_p;

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309548) || ' '|| qt_registro_w; -- Leite
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_gasoterapia
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309550) || ' '|| qt_registro_w; -- GÃ¡s
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_opme
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309552) || ' '|| qt_registro_w; -- CAR
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_protese_ms
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309553) || ' '|| qt_registro_w; -- PMS
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_protese_mi
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309554) || ' '|| qt_registro_w; -- PMI
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_meio_locomocao
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309555) || ' '|| qt_registro_w; -- MAL
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_ortese_ms
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309556) || ' '|| qt_registro_w; -- OMS
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_ortese_mi
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309558) || ' '|| qt_registro_w; -- OMI
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_compl_opm
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309559) || ' '|| qt_registro_w; -- CPL
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_ortese_coluna
where	nr_prescricao	= nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N';

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309560) || ' '|| qt_registro_w; -- OCO
end if;

select	count(*)
into STRICT	qt_registro_w
from	prescr_opm
where	nr_prescricao	= nr_prescricao_p;

if (qt_registro_w <> 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309561) || ' '|| qt_registro_w; -- OPM
end if;

if (Qt_registro_mat_w > 0) then
	ds_result_w	:= ds_result_w ||' ' || wheb_mensagem_pck.get_texto(309562) || ' '|| Qt_registro_mat_w; -- Mat
end if;

if (substr(ds_result_w,1,1) = ' ') then
	ds_result_w	:= substr(ds_result_w,2,length(ds_result_w));
end if;

return ds_result_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_itens_prescr ( nr_prescricao_p bigint, ds_itens_prescr_p text default null) FROM PUBLIC;

