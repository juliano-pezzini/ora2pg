-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_volume_frasco_age (nr_prescricao_p bigint) RETURNS bigint AS $body$
DECLARE

				
age_w		                     bigint;
nr_seq_frasco_w                     bigint;
cd_one_year_female_w                bigint;
cd_one_year_male_w                  bigint;
cd_six_years_female_w               bigint;
cd_six_years_male_w                 bigint;
cd_seven_years_old_female_w			label_code.cd_seven_years_old_female%TYPE;
cd_seven_years_old_male_w			label_code.cd_seven_years_old_male%TYPE;
cd_sixty_five_years_female_w        bigint;
cd_sixty_five_years_male_w          bigint;
ie_sexo_w                           pessoa_fisica.ie_sexo%TYPE;
cd_common_w							label_code.cd_common%TYPE;
ie_common_w							label_code.ie_common%TYPE;
				

BEGIN

select cd_one_year_old_female,
       cd_one_year_old_male,
       cd_six_years_old_female,
       cd_six_years_old_male,
       cd_seven_years_old_female,
       cd_seven_years_old_male,
       cd_sixty_five_years_old_female,
       cd_sixty_five_years_old_male,
       cd_common,
       ie_common
into STRICT   cd_one_year_female_w,
       cd_one_year_male_w,
       cd_six_years_female_w,
       cd_six_years_male_w,
       cd_seven_years_old_female_w,
       cd_seven_years_old_male_w,
       cd_sixty_five_years_female_w,
       cd_sixty_five_years_male_w,
       cd_common_w,
       ie_common_w
from label_code;

select Obter_Idade(dt_nascimento,clock_timestamp(),'A'),
p.ie_sexo
into STRICT age_w,
ie_sexo_w
from pessoa_fisica p, prescr_medica m
where p.cd_pessoa_fisica = m.cd_pessoa_fisica
and m.nr_prescricao = nr_prescricao_p;


if (ie_common_w = 'S') then
			select coalesce(cd_common_w,0)
			into STRICT nr_seq_frasco_w
			;
else
if (age_w < 1)then
			select coalesce(CASE WHEN ie_sexo_w='F' THEN cd_one_year_female_w  ELSE cd_one_year_male_w END ,0)
			into STRICT nr_seq_frasco_w
			;
elsif (age_w > 1 and age_w <= 6)then
			select coalesce(CASE WHEN ie_sexo_w='F' THEN cd_six_years_female_w  ELSE cd_six_years_male_w END ,0)
			into STRICT nr_seq_frasco_w
			;
elsif (age_w > 7 and age_w <= 64)then
			select coalesce(CASE WHEN ie_sexo_w='F' THEN cd_seven_years_old_female_w  ELSE cd_seven_years_old_male_w END ,0)
			into STRICT nr_seq_frasco_w
			;
else
			select coalesce(CASE WHEN ie_sexo_w='F' THEN cd_sixty_five_years_female_w  ELSE cd_sixty_five_years_male_w END ,0)
			into STRICT nr_seq_frasco_w
			;
end if;
end if;
return LAB_OBTER_VOLUME_FRASCO(nr_seq_frasco_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_volume_frasco_age (nr_prescricao_p bigint) FROM PUBLIC;

