-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_aviso_compras ( ie_tipo_aviso_p text, nr_documento_p bigint, ie_tipo_retorno_w text) RETURNS varchar AS $body$
DECLARE


/* ie_tipo_aviso_p
 UCF - Ordem de compra (última compra do fornecedor)


ie_tipo_retorno_p
 A - Avisa ou Não avisa
 Q - Quantidade de dias da regra

*/
cd_estabelecimento_w  bigint;
cd_cgc_fornecedor_w  varchar(14);
ie_avisa_w   varchar(1) := 'N';
nr_seq_regra_w   bigint;
qt_dias_ultima_compra_w  bigint;
dt_ultima_compra_w  timestamp;
dt_base_w   timestamp;
ds_retorno_w   varchar(20);

c01 CURSOR FOR
SELECT nr_sequencia,
 qt_dias_ultima_compra
FROM regra_avisos_compras
WHERE cd_estabelecimento = cd_estabelecimento_w
AND ((cd_cnpj IS NOT NULL AND cd_cnpj::text <> '' AND cd_cnpj = cd_cgc_fornecedor_w) OR (coalesce(cd_cnpj::text, '') = ''))
AND ie_ultima_compra = 'S'
ORDER BY coalesce(cd_cnpj,'') DESC;


BEGIN
IF (ie_tipo_aviso_p = 'UCF') THEN

 SELECT cd_cgc_fornecedor,
  cd_estabelecimento
 INTO STRICT cd_cgc_fornecedor_w,
  cd_estabelecimento_w
 FROM ordem_compra
 WHERE nr_ordem_compra = nr_documento_p;

 OPEN C01;
 LOOP
 FETCH C01 INTO
  nr_seq_regra_w,
  qt_dias_ultima_compra_w;
 EXIT WHEN NOT FOUND; /* apply on C01 */
  BEGIN
  nr_seq_regra_w   := nr_seq_regra_w;
  qt_dias_ultima_compra_w := qt_dias_ultima_compra_w;
  END;
 END LOOP;
 CLOSE C01;

 IF (nr_seq_regra_w > 0) AND (cd_cgc_fornecedor_w IS NOT NULL AND cd_cgc_fornecedor_w::text <> '') THEN

  SELECT coalesce(obter_data_ult_compra_fornec(cd_cgc_fornecedor_w,cd_estabelecimento_w),TO_DATE('01/01/1990','dd/mm/yyyy'))
  INTO STRICT dt_ultima_compra_w
;

  dt_base_w := TRUNC(clock_timestamp(),'dd') - qt_dias_ultima_compra_w;

  IF (dt_ultima_compra_w < dt_base_w) THEN
   ie_avisa_w := 'S';
  END IF;

 END IF;
END IF;

IF (ie_tipo_retorno_w = 'A') THEN
 ds_retorno_w := ie_avisa_w;
ELSIF (ie_tipo_retorno_w = 'Q') THEN
 ds_retorno_w := qt_dias_ultima_compra_w;
END IF;

RETURN ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_aviso_compras ( ie_tipo_aviso_p text, nr_documento_p bigint, ie_tipo_retorno_w text) FROM PUBLIC;

