-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_copartic_exclusao ( nr_seq_tipo_copartic_p bigint, nr_seq_prestador_prot_p bigint, nr_seq_prestador_p bigint, dt_parametro_p timestamp, nr_seq_conta_prin_p bigint, ie_tipo_guia_p text, nr_seq_saida_int_p bigint, ie_tipo_faturamento_p text, nr_seq_grau_partic_p bigint, nr_seq_contrato_p bigint, nr_seq_tipo_prest_prot_p bigint, cd_procedimento_p bigint, nr_seq_prestador_solic_p bigint, nr_seq_segurado_p pls_segurado.nr_sequencia%type, cd_guia_ok_p pls_conta.cd_guia_ok%type, ie_origem_conta_p pls_conta.ie_origem_conta%type, nr_seq_tipo_atendimento_p pls_conta.nr_seq_tipo_atendimento%type, ie_carater_internacao_p pls_conta.ie_carater_internacao%type, ie_apresentacao_p pls_protocolo_conta.ie_apresentacao%type, nr_seq_produto_p bigint, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type default null, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type default null) RETURNS bigint AS $body$
DECLARE



C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.cd_procedimento,
		a.ie_origem_proced
	from  	pls_copartic_exclusao	a
	where  	a.nr_seq_tipo_copartic = nr_seq_tipo_copartic_p
	and  	((a.nr_seq_prestador_prot = nr_seq_prestador_prot_p) or (coalesce(a.nr_seq_prestador_prot::text, '') = ''))
	and  	((a.nr_seq_prestador = nr_seq_prestador_p) or (coalesce(a.nr_seq_prestador::text, '') = ''))
	and  	((a.ie_tipo_guia = ie_tipo_guia_p) or (coalesce(a.ie_tipo_guia::text, '') = ''))
	and  	((a.nr_seq_saida_int = nr_seq_saida_int_p) or (coalesce(a.nr_seq_saida_int::text, '') = ''))
	and  	((a.ie_tipo_faturamento = ie_tipo_faturamento_p) or (coalesce(a.ie_tipo_faturamento::text, '') = '') or (coalesce(ie_tipo_faturamento_p::text, '') = ''))
	and  	trunc(dt_parametro_p) between trunc(a.dt_inicio_vigencia) and trunc(coalesce(a.dt_fim_vigencia, dt_parametro_p + 1))
	and  	((a.nr_seq_grau_partic = nr_seq_grau_partic_p) or (coalesce(a.nr_seq_grau_partic::text, '') = ''))
	and   	((a.nr_seq_tipo_prest_prot = nr_seq_tipo_prest_prot_p) or (coalesce(a.nr_seq_tipo_prest_prot::text, '') = ''))
	and  	((a.nr_seq_contrato = nr_seq_contrato_p) or coalesce(a.nr_seq_contrato::text, '') = '')
	and	((coalesce(a.ie_origem_conta::text, '') = '') or (a.ie_origem_conta	= ie_origem_conta_p))
	and  	(a.cd_procedimento IS NOT NULL AND a.cd_procedimento::text <> '')
	and  	a.ie_situacao  = 'A'
	and  	((a.nr_seq_prestador_solic = nr_seq_prestador_solic_p) or (coalesce(a.nr_seq_prestador_solic::text, '') = ''))
	and 	( (a.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_p) or (coalesce(a.nr_seq_tipo_atendimento::text, '') = ''))
	and 	( (a.ie_regime_atendimento = ie_regime_atendimento_p) or (coalesce(a.ie_regime_atendimento::text, '') = ''))
	and 	( (a.ie_saude_ocupacional = ie_saude_ocupacional_p) or (coalesce(a.ie_saude_ocupacional::text, '') = ''))
	and 	((a.ie_carater_internacao = ie_carater_internacao_p) or (coalesce(a.ie_carater_internacao::text, '') = ''))
	and 	((coalesce(ie_apresentacao::text, '') = '') or (ie_apresentacao =  'N') or (ie_apresentacao = ie_apresentacao_p))
	and	((coalesce(nr_seq_plano::text, '') = '') or (nr_seq_plano = nr_seq_produto_p))
	-- excecao da regra
	and	not exists (	SELECT	1
				from	pls_copartic_exclusao_exce	x,
					pls_preco_grupo_contrato	y,
					pls_preco_contrato		z
				where	y.nr_sequencia			= x.nr_seq_grupo_contrato
				and	z.nr_seq_grupo			= y.nr_sequencia
				and	x.nr_seq_copart_exclu		= a.nr_sequencia
				and	z.nr_seq_contrato		= nr_seq_contrato_p
				and	trunc(dt_parametro_p) between trunc(x.dt_inicio_vigencia) and trunc(coalesce(fim_dia(x.dt_fim_vigencia), dt_parametro_p + 1)));

nr_seq_regra_w      		pls_copartic_exclusao.nr_sequencia%type := 0;
qt_registros_w      		integer;
cd_procedimento_w    		pls_copartic_exclusao.cd_procedimento%type;
ie_origem_proced_w    		pls_copartic_exclusao.ie_origem_proced%type;
ie_considerar_conta_proc_w  	pls_copartic_exclusao.ie_considerar_conta_proc%type;
nr_seq_regra_excl_w    		pls_copartic_exclusao.nr_sequencia%type := null;
ie_tipo_relacao_prest_prot_w		pls_prestador.ie_tipo_relacao%type;
ie_tipo_relacao_prest_exec_w		pls_prestador.ie_tipo_relacao%type;



BEGIN

select  max(ie_considerar_conta_proc),
	count(1)
into STRICT  	ie_considerar_conta_proc_w,
	qt_registros_w
from  	pls_copartic_exclusao
where  	nr_seq_tipo_copartic = nr_seq_tipo_copartic_p
and  	(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')
and  	ie_situacao  = 'A';

select	max(ie_tipo_relacao)
into STRICT	ie_tipo_relacao_prest_prot_w
from	pls_prestador
where	nr_sequencia = nr_seq_prestador_prot_p;

select	max(ie_tipo_relacao)
into STRICT	ie_tipo_relacao_prest_exec_w
from	pls_prestador
where	nr_sequencia = nr_seq_prestador_p;

/*aaschlote 06/12/2013 OS 672733*/

if ( qt_registros_w > 0) then
	open C01;
	loop
	fetch C01 into
		nr_seq_regra_w,
		cd_procedimento_w,
		ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		if (coalesce(ie_considerar_conta_proc_w,'S')  = 'S') then
			select  count(1)
			into STRICT  	qt_registros_w
			from  	pls_conta_proc  a,
				pls_conta    	b
			where  	a.nr_seq_conta  	= b.nr_sequencia
			and  	b.cd_guia_ok 		= cd_guia_ok_p
			and 	b.nr_seq_segurado 	= nr_seq_segurado_p
			and  	a.cd_procedimento	= cd_procedimento_w
			and  	a.ie_origem_proced 	= ie_origem_proced_w
			and  	a.ie_status	 	not in ('D','U')  LIMIT 1;
	
			if (qt_registros_w > 0) then
				nr_seq_regra_excl_w := nr_seq_regra_w;
				exit;
			end if;
		elsif (coalesce(ie_considerar_conta_proc_w,'S')  = 'N') then
			if (coalesce(cd_procedimento_w,0) = cd_procedimento_p)then
				nr_seq_regra_excl_w := nr_seq_regra_w;
				exit;
			end if;
		end if;
	end;
	end loop;
	close C01;

	if ( coalesce(nr_seq_regra_excl_w::text, '') = '') then
		select  max(a.nr_sequencia)
		into STRICT  	nr_seq_regra_excl_w
		from  	pls_copartic_exclusao	a
		where  	a.nr_seq_tipo_copartic 	= nr_seq_tipo_copartic_p
		and  	((a.nr_seq_prestador_prot = nr_seq_prestador_prot_p) or (coalesce(a.nr_seq_prestador_prot::text, '') = ''))
		and  	((a.nr_seq_prestador 	= nr_seq_prestador_p) 	or (coalesce(a.nr_seq_prestador::text, '') = ''))
		and  	((a.ie_tipo_guia 	= ie_tipo_guia_p) 	or (coalesce(a.ie_tipo_guia::text, '') = ''))
		and  	((a.nr_seq_saida_int 	= nr_seq_saida_int_p) 	or (coalesce(a.nr_seq_saida_int::text, '') = ''))
		and  	((a.ie_tipo_faturamento = ie_tipo_faturamento_p) or (coalesce(a.ie_tipo_faturamento::text, '') = '') or (coalesce(ie_tipo_faturamento_p::text, '') = ''))
		and  	trunc(dt_parametro_p) 	between trunc(a.dt_inicio_vigencia) and trunc(coalesce(a.dt_fim_vigencia, dt_parametro_p + 1))
		and  	((a.nr_seq_grau_partic 	= nr_seq_grau_partic_p) or (coalesce(a.nr_seq_grau_partic::text, '') = ''))
		and  	((a.nr_seq_tipo_prest_prot = nr_seq_tipo_prest_prot_p) or (coalesce(a.nr_seq_tipo_prest_prot::text, '') = ''))
		and  	((a.nr_seq_contrato 	= nr_seq_contrato_p) 	or coalesce(a.nr_seq_contrato::text, '') = '')
		and	((coalesce(a.ie_origem_conta::text, '') = '') or (a.ie_origem_conta	= ie_origem_conta_p))
		and  	a.ie_situacao  		= 'A'
		and  	coalesce(a.cd_procedimento::text, '') = ''
		and  	((a.nr_seq_prestador_solic = nr_seq_prestador_solic_p) or (coalesce(a.nr_seq_prestador_solic::text, '') = ''))
		and 	( (a.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_p) or (coalesce(a.nr_seq_tipo_atendimento::text, '') = ''))
		and 	( (a.ie_regime_atendimento = ie_regime_atendimento_p) or (coalesce(a.ie_regime_atendimento::text, '') = ''))
		and 	( (a.ie_saude_ocupacional = ie_saude_ocupacional_p) or (coalesce(a.ie_saude_ocupacional::text, '') = ''))
		and 	((a.ie_carater_internacao = ie_carater_internacao_p) or (coalesce(a.ie_carater_internacao::text, '') = ''))
		and 	((coalesce(ie_apresentacao::text, '') = '') or (ie_apresentacao =  'N') or (ie_apresentacao = ie_apresentacao_p))
		and	((coalesce(nr_seq_plano::text, '') = '') or (nr_seq_plano = nr_seq_produto_p))
                and     ((coalesce(ie_tipo_prest_relacao::text, '') = '') or (ie_tipo_prest_relacao = 'A' and ie_tipo_relacao = ie_tipo_relacao_prest_prot_w) or (ie_tipo_prest_relacao = 'E' and ie_tipo_relacao = ie_tipo_relacao_prest_exec_w))		
		-- excecao da regra
		and	not exists (	SELECT	1
				from	pls_copartic_exclusao_exce	x,
					pls_preco_grupo_contrato	y,
					pls_preco_contrato		z
				where	y.nr_sequencia			= x.nr_seq_grupo_contrato
				and	z.nr_seq_grupo			= y.nr_sequencia
				and	x.nr_seq_copart_exclu		= a.nr_sequencia
				and	z.nr_seq_contrato		= nr_seq_contrato_p
				and	trunc(dt_parametro_p) between trunc(x.dt_inicio_vigencia) and trunc(coalesce(fim_dia(x.dt_fim_vigencia), dt_parametro_p + 1)));
	end if;
else


  select  max(a.nr_sequencia)
  into STRICT  nr_seq_regra_excl_w
  from  pls_copartic_exclusao	a
  where	a.nr_seq_tipo_copartic 	= nr_seq_tipo_copartic_p
  and   ((a.nr_seq_prestador_prot = nr_seq_prestador_prot_p) or (coalesce(a.nr_seq_prestador_prot::text, '') = ''))
  and   ((a.nr_seq_prestador 	= nr_seq_prestador_p) 	or (coalesce(a.nr_seq_prestador::text, '') = ''))
  and   ((a.ie_tipo_guia 	= ie_tipo_guia_p) 	or (coalesce(a.ie_tipo_guia::text, '') = ''))
  and   ((a.nr_seq_saida_int 	= nr_seq_saida_int_p) 	or (coalesce(a.nr_seq_saida_int::text, '') = ''))
  and   ((a.ie_tipo_faturamento = ie_tipo_faturamento_p) or (coalesce(a.ie_tipo_faturamento::text, '') = '') or (coalesce(ie_tipo_faturamento_p::text, '') = ''))
  and   trunc(dt_parametro_p) 	between trunc(a.dt_inicio_vigencia) and trunc(coalesce(a.dt_fim_vigencia, dt_parametro_p + 1))
  and   ((a.nr_seq_grau_partic 	= nr_seq_grau_partic_p) or (coalesce(a.nr_seq_grau_partic::text, '') = ''))
  and   ((a.nr_seq_tipo_prest_prot = nr_seq_tipo_prest_prot_p) or (coalesce(a.nr_seq_tipo_prest_prot::text, '') = ''))
  and   ((a.nr_seq_contrato 	= nr_seq_contrato_p) 	or coalesce(a.nr_seq_contrato::text, '') = '')
  and	((coalesce(a.ie_origem_conta::text, '') = '') or (a.ie_origem_conta	= ie_origem_conta_p))
  and   a.ie_situacao  		= 'A'
  and   ((a.nr_seq_prestador_solic = nr_seq_prestador_solic_p) or (coalesce(a.nr_seq_prestador_solic::text, '') = ''))
  and 	( (a.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_p) or (coalesce(a.nr_seq_tipo_atendimento::text, '') = ''))
  and 	( (a.ie_regime_atendimento = ie_regime_atendimento_p) or (coalesce(a.ie_regime_atendimento::text, '') = ''))
  and 	( (a.ie_saude_ocupacional = ie_saude_ocupacional_p) or (coalesce(a.ie_saude_ocupacional::text, '') = ''))
  and 	((a.ie_carater_internacao = ie_carater_internacao_p) or (coalesce(a.ie_carater_internacao::text, '') = ''))
  and 	((coalesce(ie_apresentacao::text, '') = '') or (ie_apresentacao =  'N') or (ie_apresentacao = ie_apresentacao_p))
  and	((coalesce(nr_seq_plano::text, '') = '') or (nr_seq_plano = nr_seq_produto_p))
  and   ((coalesce(ie_tipo_prest_relacao::text, '') = '') or (ie_tipo_prest_relacao = 'A' and ie_tipo_relacao = ie_tipo_relacao_prest_prot_w) or (ie_tipo_prest_relacao = 'E' and ie_tipo_relacao = ie_tipo_relacao_prest_exec_w))
  -- excecao da regra
  and	not exists (	SELECT	1
			from	pls_copartic_exclusao_exce	x,
				pls_preco_grupo_contrato	y,
				pls_preco_contrato		z
			where	y.nr_sequencia			= x.nr_seq_grupo_contrato
			and	z.nr_seq_grupo			= y.nr_sequencia
			and	x.nr_seq_copart_exclu		= a.nr_sequencia
			and	z.nr_seq_contrato		= nr_seq_contrato_p
			and	trunc(dt_parametro_p) between trunc(x.dt_inicio_vigencia) and trunc(coalesce(fim_dia(x.dt_fim_vigencia), dt_parametro_p + 1)));

end if;

return  coalesce(nr_seq_regra_excl_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_copartic_exclusao ( nr_seq_tipo_copartic_p bigint, nr_seq_prestador_prot_p bigint, nr_seq_prestador_p bigint, dt_parametro_p timestamp, nr_seq_conta_prin_p bigint, ie_tipo_guia_p text, nr_seq_saida_int_p bigint, ie_tipo_faturamento_p text, nr_seq_grau_partic_p bigint, nr_seq_contrato_p bigint, nr_seq_tipo_prest_prot_p bigint, cd_procedimento_p bigint, nr_seq_prestador_solic_p bigint, nr_seq_segurado_p pls_segurado.nr_sequencia%type, cd_guia_ok_p pls_conta.cd_guia_ok%type, ie_origem_conta_p pls_conta.ie_origem_conta%type, nr_seq_tipo_atendimento_p pls_conta.nr_seq_tipo_atendimento%type, ie_carater_internacao_p pls_conta.ie_carater_internacao%type, ie_apresentacao_p pls_protocolo_conta.ie_apresentacao%type, nr_seq_produto_p bigint, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type default null, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type default null) FROM PUBLIC;

