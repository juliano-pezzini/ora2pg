-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_justificativa_item ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text default 'MAT', nr_seq_npt_cpoe_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_justificativa_w 	        varchar(4000);
nr_seq_cpoe_w		            bigint;
ie_posicao_administracao_w  cpoe_dieta.ie_posicao_administracao%type;
qt_irrigacao_ml_w           cpoe_dieta.qt_irrigacao_ml%type;
qt_intervalo_irrigacao_w    cpoe_dieta.qt_intervalo_irrigacao%type;
espace_w		                varchar(20)	:= CHR(9);


function verify_dot_in_result(ds_result in text) return text as
	;
BEGIN
        if (position('.'  in ds_result) > 0 AND substr(ds_result,LENGTH(ds_result),1) = '.') then
            return concat(ds_result, ' ');
        end if;
        return concat(ds_result, '. ');
    end;

function not_allow_only_expression(ds_result_simple_p in varchar2, ds_result_compound_p in varchar2) return varchar2 as
	begin
		if (ds_result_simple_p != '' or (ds_result_simple_p IS NOT NULL AND ds_result_simple_p::text <> '')) then
            return verify_dot_in_result(ds_result_compound_p);
		end if;
        return '';
    end;

begin

ds_justificativa_w := null;

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '' AND nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
	if (ie_tipo_item_p = 'SOL') then

		nr_seq_cpoe_w := coalesce(obter_nr_seq_cpoe_sol(nr_prescricao_p, nr_seq_item_p),0);

	elsif (ie_tipo_item_p = 'G') then

		select 	max(nr_seq_gas_cpoe)
		into STRICT 	nr_seq_cpoe_w
		from 	prescr_gasoterapia
		where	nr_prescricao	= nr_prescricao_p
		and		nr_seq_gas		= nr_seq_item_p;

	elsif (ie_tipo_item_p = 'REC') then

		select 	max(nr_seq_rec_cpoe)
		into STRICT 	nr_seq_cpoe_w
		from 	prescr_recomendacao
		where	nr_prescricao	= nr_prescricao_p
		and		nr_sequencia	= nr_seq_item_p;

	elsif (ie_tipo_item_p = 'D') then

		select 	max(nr_seq_dieta_cpoe)
		into STRICT	nr_seq_cpoe_w
		from 	prescr_dieta
		where	nr_prescricao = nr_prescricao_p
		and		nr_sequencia  = nr_seq_item_p;

	elsif (ie_tipo_item_p = 'P') then

		select 	max(nr_seq_proc_cpoe)
		into STRICT	nr_seq_cpoe_w
		from 	prescr_procedimento
		where	nr_prescricao = nr_prescricao_p
		and		nr_sequencia  = nr_seq_item_p;

	elsif (ie_tipo_item_p = 'J') then

		select 	max(nr_seq_dieta_cpoe)
		into STRICT	nr_seq_cpoe_w
		from 	rep_jejum
		where	nr_prescricao = nr_prescricao_p
		and		nr_sequencia  = nr_seq_item_p;

	elsif (ie_tipo_item_p = 'NPT') then

		select 	max(nr_seq_npt_cpoe)
		into STRICT	nr_seq_cpoe_w
		from 	nut_pac
		where	nr_prescricao = nr_prescricao_p
		and		nr_sequencia  = nr_seq_item_p;

	else

		select 	max(coalesce(nr_seq_mat_cpoe, nr_seq_dieta_cpoe))
		into STRICT	nr_seq_cpoe_w
		from 	prescr_material
		where	nr_prescricao = nr_prescricao_p
		and		nr_sequencia  = nr_seq_item_p;

	end if;

	if (nr_seq_cpoe_w IS NOT NULL AND nr_seq_cpoe_w::text <> '') then
		if (ie_tipo_item_p in ('MAT', 'SOL')) then

			select 	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from 	cpoe_material
			where 	nr_sequencia = nr_seq_cpoe_w;

		elsif (ie_tipo_item_p = 'G') then

			select 	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from 	cpoe_gasoterapia
			where 	nr_sequencia = nr_seq_cpoe_w;

		elsif (ie_tipo_item_p = 'REC') then

			select 	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from 	cpoe_recomendacao
			where 	nr_sequencia = nr_seq_cpoe_w;

		elsif (ie_tipo_item_p = 'P') then

			select 	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from 	cpoe_procedimento
			where 	nr_sequencia = nr_seq_cpoe_w;

		elsif (ie_tipo_item_p in ('D', 'SNE')) then 	

			select 	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from 	cpoe_dieta
			where 	nr_sequencia = nr_seq_cpoe_w;

		elsif (ie_tipo_item_p = 'S') then

			select 	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from 	cpoe_dieta
			where 	nr_sequencia = nr_seq_cpoe_w;

    elsif (ie_tipo_item_p = 'NPT') then

      select 	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from 	cpoe_dieta
			where 	nr_sequencia = nr_seq_cpoe_w;

      ie_posicao_administracao_w := OBTER_POSICAO_NPT_ADULTO(nr_seq_npt_cpoe_p);

      select	max(qt_irrigacao_ml), MAX(qt_intervalo_irrigacao)
      into STRICT	qt_irrigacao_ml_w, qt_intervalo_irrigacao_w
      from 	cpoe_dieta a
      where 	a.nr_sequencia = nr_seq_cpoe_w
              AND (QT_IRRIGACAO_ML IS NOT NULL AND QT_IRRIGACAO_ML::text <> '');

      ds_justificativa_w := not_allow_only_expression(ds_justificativa_w,ds_justificativa_w) ||
                            not_allow_only_expression(ie_posicao_administracao_w, Wheb_mensagem_pck.get_texto(455735) || espace_w || ie_posicao_administracao_w) ||
                            not_allow_only_expression(qt_irrigacao_ml_w, Wheb_mensagem_pck.get_texto(1206603, 'QT_IRRIGACAO_ML_W=' || qt_irrigacao_ml_w || ';QT_INTERVALO_IRRIGACAO_W=' || qt_intervalo_irrigacao_w));

		end if;

	else

		if (ie_tipo_item_p = 'D') then

			select 	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from 	prescr_dieta
			where	nr_prescricao = nr_prescricao_p
			and		nr_sequencia  = nr_seq_item_p;

		elsif (ie_tipo_item_p = 'P') then

			select 	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from 	prescr_procedimento
			where	nr_prescricao = nr_prescricao_p
			and		nr_sequencia  = nr_seq_item_p;

		elsif (ie_tipo_item_p = 'NPT') then

			select 	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from 	nut_pac
			where	nr_prescricao = nr_prescricao_p
			and		nr_sequencia  = nr_seq_item_p;

		elsif (ie_tipo_item_p not in ('SOL','G','REC','J')) then

			select 	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from 	prescr_material
			where	nr_prescricao = nr_prescricao_p
			and		nr_sequencia  = nr_seq_item_p;

		end if;
	end if;
end if;

return substr(ds_justificativa_w, 1, 2000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_justificativa_item ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text default 'MAT', nr_seq_npt_cpoe_p bigint default null) FROM PUBLIC;

