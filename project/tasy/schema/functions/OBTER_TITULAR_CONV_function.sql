-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_titular_conv (nr_seq_segurado_p bigint DEFAULT NULL, NR_SEQ_AGENDA_P bigint DEFAULT NULL, CD_TIPO_AGENDA_P bigint DEFAULT NULL) RETURNS varchar AS $body$
DECLARE

					 
dt_validade_carteira_w 	timestamp;	
cd_convenio_w			integer;
cd_pessoa_titular_w		varchar(10);
cd_pf_w					varchar(10);
cd_categoria_w			varchar(10);
cd_plano_w				varchar(10);
nr_seq_segurado_w		bigint;
					

BEGIN 
 
if (coalesce(nr_seq_segurado_p,0) > 0) then 
 
	cd_convenio_w			:= obter_dados_seg_entrada_unica(nr_seq_segurado_p, 'CV', null);
	cd_categoria_w			:= obter_dados_seg_entrada_unica(nr_seq_segurado_p, 'CA', null);
	cd_plano_w				:= obter_dados_seg_entrada_unica(nr_seq_segurado_p, 'PLC', null);	
	 
	SELECT max(CD_PESSOA_FISICA) 
	into STRICT	cd_pessoa_titular_w 
	FROM 	pls_segurado 
	WHERE (nr_sequencia = nr_seq_segurado_p 
	and 	 coalesce(nr_seq_titular::text, '') = '') 
	or 		(nr_sequencia = (SELECT 	MAX(nr_seq_titular) 
							FROM 	pls_segurado 
							WHERE 	nr_sequencia = nr_seq_segurado_p));
 
elsif (coalesce(NR_SEQ_AGENDA_P,0) > 0) AND (coalesce(CD_TIPO_AGENDA_P,0) > 0)then 
 
	if (CD_TIPO_AGENDA_P in (1,2)) then -- Cirúrgica / Exames 
	begin 
		select max(coalesce(cd_convenio,0)), 
				max(coalesce(cd_categoria,0)), 
				max(coalesce(CD_PLANO,0)), 
				max(cd_pessoa_fisica), 
				max(nr_seq_segurado) 
		into STRICT	cd_convenio_w, 
				cd_categoria_w, 
				cd_plano_w, 
				cd_pf_w, 
				nr_seq_segurado_w 
		from 	agenda_paciente 
		where 	nr_sequencia = NR_SEQ_AGENDA_P;
 
	end;
	elsif (CD_TIPO_AGENDA_P in (3,4,5)) then -- Consulta / Serviços 
	begin 
		select max(coalesce(cd_convenio,0)), 
				max(coalesce(cd_categoria,0)), 
				max(coalesce(CD_PLANO,0)), 
				max(cd_pessoa_fisica), 
				max(nr_seq_segurado) 
		into STRICT	cd_convenio_w, 
				cd_categoria_w, 
				cd_plano_w, 
				cd_pf_w, 
				nr_seq_segurado_w 
		from 	agenda_consulta 
		where 	nr_sequencia = NR_SEQ_AGENDA_P;
	end;
	end if;
	 
	 
	if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then	 
 
		SELECT max(CD_PESSOA_FISICA) 
		into STRICT	cd_pessoa_titular_w 
		FROM 	pls_segurado 
		WHERE (nr_sequencia = nr_seq_segurado_w 
		and 	 coalesce(nr_seq_titular::text, '') = '') 
		or 		(nr_sequencia = (SELECT 	MAX(nr_seq_titular) 
								FROM 	pls_segurado 
								WHERE 	nr_sequencia = nr_seq_segurado_w));
 
	elsif (cd_pf_w IS NOT NULL AND cd_pf_w::text <> '')then 
		select	max(CD_PESSOA_TITULAR) 
		into STRICT	cd_pessoa_titular_w 
		from	PESSOA_TITULAR_CONVENIO 
		where	cd_pessoa_fisica = cd_pf_w 
		and 	coalesce(CD_CONVENIO, cd_convenio_w) = cd_convenio_w 
		and 	((trunc(clock_timestamp()) >= trunc(DT_INICIO_VIGENCIA) or (coalesce(DT_INICIO_VIGENCIA::text, '') = '')) 
		and (trunc(clock_timestamp()) <= trunc(DT_FIM_VIGENCIA) or coalesce(DT_FIM_VIGENCIA::text, '') = '')) 
		and 	coalesce(cd_categoria,cd_categoria_w) = cd_categoria_w 
		and 	coalesce(cd_plano_convenio, cd_plano_w) = cd_plano_w;
	end if;
	 
end if;
 
RETURN cd_pessoa_titular_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_titular_conv (nr_seq_segurado_p bigint DEFAULT NULL, NR_SEQ_AGENDA_P bigint DEFAULT NULL, CD_TIPO_AGENDA_P bigint DEFAULT NULL) FROM PUBLIC;

