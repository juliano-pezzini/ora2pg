-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_malot_envelope ( nr_seq_envelope_p bigint, ie_etapa_hist_p text, ie_valor_p text) RETURNS varchar AS $body$
DECLARE

			
nr_seq_malote_envelope_w	bigint;
nm_pessoa_retirada_w		varchar(80);
ds_observacao_w			varchar(255);
ds_documento_w			varchar(25);

ds_retorno_w			varchar(255) := '';



BEGIN

if (ie_etapa_hist_p = 'DEE') then

	select coalesce(max(nr_sequencia),0)
	into STRICT   nr_seq_malote_envelope_w
	from   malote_envelope_item
	where  nr_seq_envelope = nr_seq_envelope_p;

	if (nr_seq_malote_envelope_w IS NOT NULL AND nr_seq_malote_envelope_w::text <> '') then
       select max(nm_pessoa_retirada),
              max(ds_observacao),
              max(ds_documento) 
         into STRICT nm_pessoa_retirada_w,
			  ds_observacao_w,
			  ds_documento_w       
         from (SELECT max(substr(e.nm_pessoa_retirada,1,80)) nm_pessoa_retirada,
                      max(substr(e.ds_observacao,1,255)) ds_observacao,
                      max(e.ds_documento) ds_documento
                 from malote_envelope_item e
                where nr_sequencia = nr_seq_malote_envelope_w
               
union
 
               SELECT max(substr(e.nm_pessoa_retirada,1,80)) nm_pessoa_retirada,
                      max(substr(e.ds_observacao,1,255)) ds_observacao,
                      max(e.ds_documento) ds_documento
                 from envelope_laudo e
                where nr_sequencia = nr_seq_envelope_p) alias14;

	   if (ie_valor_p = 'P') then
         ds_retorno_w := nm_pessoa_retirada_w;
	   elsif (ie_valor_p = 'O') then
	     ds_retorno_w := ds_observacao_w;
	   elsif (ie_valor_p = 'D') then
	     ds_retorno_w := ds_documento_w;
	   end if;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_malot_envelope ( nr_seq_envelope_p bigint, ie_etapa_hist_p text, ie_valor_p text) FROM PUBLIC;

