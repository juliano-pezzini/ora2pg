-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_regra_bloq_opme ( cd_guia_p text) RETURNS varchar AS $body$
DECLARE


dt_solicitacao_w		timestamp;

ie_tipo_guia_w			varchar(4);

nr_seq_prestador_w		bigint;
nr_seq_regra_w			bigint;
nr_seq_guia_w			bigint;
nr_retorno_w			varchar(10)	:= '0';


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_guia_w
from	pls_guia_plano
where	cd_guia = cd_guia_p;

if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
	select	ie_tipo_guia,
		nr_seq_prestador,
		dt_solicitacao
	into STRICT	ie_tipo_guia_w,
		nr_seq_prestador_w,
		dt_solicitacao_w
	from	pls_guia_plano
	where	nr_sequencia	= nr_seq_guia_w;

	if (pls_obter_se_controle_estab('RE') = 'S') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_regra_w
		from	pls_bloqueio_solic_mat_med
		where (coalesce(ie_tipo_guia::text, '') = ''	or ie_tipo_guia		= ie_tipo_guia_w)
		and (coalesce(nr_seq_prestador::text, '') = ''	or nr_seq_prestador	= nr_seq_prestador_w)
		and (coalesce(nr_seq_grupo_prestador::text, '') = ''	or pls_obter_se_prestador_grupo(nr_seq_grupo_prestador, nr_seq_prestador_w) = 'S')
		and	dt_solicitacao_w	between(dt_inicio_vigencia) 	and (fim_dia(coalesce(dt_fim_vigencia, clock_timestamp())))
		and 	coalesce(cd_estabelecimento, wheb_usuario_pck.get_cd_estabelecimento) = wheb_usuario_pck.get_cd_estabelecimento;
	else
		select	max(nr_sequencia)
		into STRICT	nr_seq_regra_w
		from	pls_bloqueio_solic_mat_med
		where (coalesce(ie_tipo_guia::text, '') = ''	or ie_tipo_guia		= ie_tipo_guia_w)
		and (coalesce(nr_seq_prestador::text, '') = ''	or nr_seq_prestador	= nr_seq_prestador_w)
		and (coalesce(nr_seq_grupo_prestador::text, '') = ''	or pls_obter_se_prestador_grupo(nr_seq_grupo_prestador, nr_seq_prestador_w) = 'S')
		and	dt_solicitacao_w	between(dt_inicio_vigencia) 	and (fim_dia(coalesce(dt_fim_vigencia, clock_timestamp())));
	end if;

	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
		nr_retorno_w	:= nr_seq_regra_w;
	end if;
end if;

return	nr_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_regra_bloq_opme ( cd_guia_p text) FROM PUBLIC;

