-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION qua_obter_count_nao_conform ( nr_sequencia_p bigint) RETURNS bigint AS $body$
DECLARE


nr_seq_tipo_w		bigint;
ie_causa_w		varchar(3);
ie_acao_w		varchar(3);
ie_eficacia_w		varchar(3);
ie_setor_envolvido_w	varchar(3);
qt_causa_w		bigint := 0;
qt_acao_w		bigint := 0;
qt_eficacia_w		bigint := 0;
qt_setor_envolvido_w	bigint := 0;
qt_hist_w		bigint := 0;
qt_anexo_w		bigint := 0;
qt_count_w		bigint := 0;


BEGIN

select	nr_seq_tipo
into STRICT	nr_seq_tipo_w
from	qua_nao_conformidade
where	nr_sequencia = nr_sequencia_p;

select	substr(qua_obter_tipo_nao_conform(nr_seq_tipo_w, 'C'),1,3),
	substr(qua_obter_tipo_nao_conform(nr_seq_tipo_w, 'A'),1,3),
	substr(qua_obter_tipo_nao_conform(nr_seq_tipo_w, 'E'),1,3),
	substr(qua_obter_tipo_nao_conform(nr_seq_tipo_w, 'S'),1,3)
into STRICT	ie_causa_w,
	ie_acao_w,
	ie_eficacia_w,
	ie_setor_envolvido_w
;

select	count(*)
into STRICT	qt_hist_w
from	qua_nao_conform_hist
where	nr_seq_nao_conform = nr_sequencia_p;

select	count(*)
into STRICT	qt_anexo_w
from	qua_nao_conform_anexo
where	nr_seq_nao_conform = nr_sequencia_p;

if (ie_eficacia_w <> 'NI') then
	select	count(*)
	into STRICT	qt_eficacia_w
	from	qua_nao_conform_eficacia
	where	nr_seq_nao_conform = nr_sequencia_p;
end if;

if (ie_causa_w <> 'NI') then
	select	count(*)
	into STRICT	qt_causa_w
	from	qua_nao_conform_causa
	where	nr_seq_nao_conform = nr_sequencia_p;
end if;

if (ie_acao_w <> 'NI') then
	select	count(*)
	into STRICT	qt_acao_w
	from	man_ordem_servico
	where	nr_seq_nao_conform = nr_sequencia_p;
end if;

if (ie_setor_envolvido_w <> 'NI') then
	select	count(*)
	into STRICT	qt_setor_envolvido_w
	from	qua_nao_conform_setor
	where	nr_seq_nao_conform = nr_sequencia_p;
end if;

qt_count_w	:= qt_hist_w + qt_anexo_w + qt_causa_w + qt_acao_w + qt_eficacia_w + qt_setor_envolvido_w;

return qt_count_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION qua_obter_count_nao_conform ( nr_sequencia_p bigint) FROM PUBLIC;

