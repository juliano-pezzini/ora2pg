-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_cycle_day (dt_menu_p timestamp default clock_timestamp(), nr_seq_cycle_p cycle_menu.nr_cycle_days%type DEFAULT NULL) RETURNS CYCLE_MENU.NR_CYCLE_DAYS%TYPE AS $body$
DECLARE

					
nr_menu_day_w cycle_menu.nr_cycle_days%type := 0;

  rec RECORD;

BEGIN
/* Loop over Cycle Menu rows */

for	rec in (SELECT	nr_sequencia,
			dt_validity_start,
			dt_validity_end,
			nr_cycle_days,
			trunc(dt_menu_p - dt_validity_start) + 1 curr_day
	from	cycle_menu
	where	nr_sequencia = nr_seq_cycle_p
	and (dt_validity_start <= dt_menu_p
	and (coalesce(dt_validity_end::text, '') = '' or dt_validity_end >= dt_menu_p)))
loop
	if (rec.nr_sequencia) > 0 then
		nr_menu_day_w         := rec.curr_day;
		/* Loop to find the day occured */

		while(nr_menu_day_w  > rec.nr_cycle_days) loop
				nr_menu_day_w := nr_menu_day_w - rec.nr_cycle_days;
		end loop;
	end if;
	
end loop;

return nr_menu_day_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION get_cycle_day (dt_menu_p timestamp default clock_timestamp(), nr_seq_cycle_p cycle_menu.nr_cycle_days%type DEFAULT NULL) FROM PUBLIC;

