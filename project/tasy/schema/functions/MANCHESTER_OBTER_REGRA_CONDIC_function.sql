-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION manchester_obter_regra_condic ( nr_seq_item_manchester_p bigint, ie_leitura_obrigatoria_p text, qt_valor_p bigint, ie_valor_regra_p text, qt_idade_p bigint, nr_atendimento_p bigint default 0, ie_dormindo_p text default 'A') RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(1);
qt_regra_estab_w	bigint;
qt_dias_w			bigint;
qt_meses_w			bigint;
cd_pessoa_fisica_w	varchar(10);
qt_idade_meses_w	bigint;
qt_idade_w			bigint;
ie_versao_w			varchar(10);


BEGIN
if (nr_seq_item_manchester_p	is	not	null)then

	ds_retorno_w	:=	'N';

	if ( 'O' = ie_leitura_obrigatoria_p)then

		if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'de_DE') then
			if (nr_seq_item_manchester_p = 3518) then
				if (ie_valor_regra_p = '1' and qt_valor_p < 90) then
					ds_retorno_w := 'S';
				elsif (ie_valor_regra_p = '2' and qt_valor_p < 95) then
					ds_retorno_w := 'S';
				end if;
			elsif (nr_seq_item_manchester_p = 3487) then
				if (ie_valor_regra_p = '1' and qt_valor_p < 95) then
					ds_retorno_w := 'S';
				end if;
			end if;
		else
			select		coalesce(MAX('S'),'N')
			into STRICT		ds_retorno_w
			from		manchester_item	a
			where		nr_sequencia			=	nr_seq_item_manchester_p
			and			ie_leitura_obrigatoria	=	ie_leitura_obrigatoria_p
			and			ie_ar_o2				=	ie_valor_regra_p
			and			qt_valor_p	between	qt_valor_minimo	and	qt_valor_maximo;

			if ( ds_retorno_w = 'N')then
				select		coalesce(MAX('S'),'N')
				into STRICT		ds_retorno_w
				from		manchester_item	a
				where		nr_sequencia	<> nr_seq_item_manchester_p
				and			ie_leitura_obrigatoria	=	ie_leitura_obrigatoria_p
				and			ie_ar_o2	=	ie_valor_regra_p
				and			qt_valor_p	between	qt_valor_minimo	and	qt_valor_maximo
				and			a.ds_item	=	(SELECT		max(a.ds_item)
											 from		manchester_item	a
											 where		nr_sequencia	=	nr_seq_item_manchester_p);
			end if;
		end	if;
	elsif ('FCP' = ie_leitura_obrigatoria_p)then
		
		if (ie_valor_regra_p = '2' and coalesce(pkg_i18n.get_user_locale, 'pt_BR') <> 'de_DE') then
			ds_retorno_w := 'S';
		end if;

		if (ds_retorno_w	=	'N')then		
			select	coalesce(max(ie_versao_cliente),'1')
			into STRICT	ie_versao_w
			from	parametro_medico
			where 	cd_estabelecimento = obter_estabelecimento_ativo;
			
			if (nr_atendimento_p > 0) then		
				cd_pessoa_fisica_w := OBTER_PESSOA_ATENDIMENTO(nr_atendimento_p,'C');		
				qt_dias_w := trunc(obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'DIA'));
				qt_meses_w	:= trunc(obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'M'));
				qt_idade_w := trunc(obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'A'));
			end if;		
		
			if (ie_versao_w = '2') then				
				if (qt_meses_w <= 3) then
					if (ie_dormindo_p = 'A') and
					   not(qt_valor_p between 85 and 205) then
						ds_retorno_w := 'S';
					elsif (ie_dormindo_p = 'D') and
					   not(qt_valor_p between 80 and 160) then
						ds_retorno_w := 'S';
					end if;
				elsif (qt_idade_w <= 2) then
					if (ie_dormindo_p = 'A') and
					   not(qt_valor_p between 100 and 190) then
						ds_retorno_w := 'S';
					elsif (ie_dormindo_p = 'D') and
					   not(qt_valor_p between 75 and 160) then
						ds_retorno_w := 'S';
					end if;
				elsif (qt_idade_w <= 10) then
					if (ie_dormindo_p = 'A') and
					   not(qt_valor_p between 60 and 140) then
						ds_retorno_w := 'S';
					elsif (ie_dormindo_p = 'D') and
					   not(qt_valor_p between 60 and 90) then
						ds_retorno_w := 'S';
					end if;
				else
					if (ie_dormindo_p = 'A') and
					   not(qt_valor_p between 60 and 100) then
						ds_retorno_w := 'S';
					elsif (ie_dormindo_p = 'D') and
					   not(qt_valor_p between 50 and 90) then
						ds_retorno_w := 'S';
					end if;
				end if;
			elsif (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'de_DE') then				
				if (qt_dias_w <= 28) then
					if not(qt_valor_p between 90 and 180) then
						ds_retorno_w := 'S';
					end if;
				elsif (qt_meses_w <= 6) then
					if not(qt_valor_p between 105 and 170) then
						ds_retorno_w := 'S';
					end if;
				elsif (qt_idade_w < 2) then
					if not(qt_valor_p between 90 and 150) then
						ds_retorno_w := 'S';
					end if;
				elsif (qt_idade_w <= 3) then
					if not(qt_valor_p between 72 and 135) then
						ds_retorno_w := 'S';
					end if;
				elsif (qt_idade_w <= 5) then
					if not(qt_valor_p between 65 and 135) then
						ds_retorno_w := 'S';
					end if;
				elsif (qt_idade_w <= 9) then
					if not(qt_valor_p between 65 and 130) then
						ds_retorno_w := 'S';
					end if;
				elsif (qt_idade_w <= 13) then
					if not(qt_valor_p between 60 and 120) then
						ds_retorno_w := 'S';
					end if;
				elsif (qt_idade_w <= 18) then
					if not(qt_valor_p between 60 and 100) then
						ds_retorno_w := 'S';
					end if;
				elsif (qt_idade_w >= 18) then
					if not(qt_valor_p between 60 and 100) then
						ds_retorno_w := 'S';
					end if;
				end if;				
			else
				
				select 	count(*)
				into STRICT	qt_regra_estab_w
				from 	manchester_item	a
				where	ie_leitura_obrigatoria = ie_leitura_obrigatoria_p
				and	coalesce(ie_tipo_cadastro,'P') = 'C' 
				and	a.ds_item	=	(SELECT		max(a.ds_item)
								 from		manchester_item	a
								 where		nr_sequencia = nr_seq_item_manchester_p)
				and	qt_idade_p between(coalesce(qt_idade_min,0) + dividir(coalesce(qt_dia_min,0),365)) and (coalesce(qt_idade_max,9999) + dividir(coalesce(qt_dia_max,0),365))
				and 	((coalesce(qt_dias_w,0) between coalesce(qt_dia_min,0) and coalesce(qt_dia_max,999999)) or (coalesce(qt_dias_w::text, '') = '') or (coalesce(qt_dia_max,0) = 0))
				and		((coalesce(qt_meses_w,0) between coalesce(qt_meses_min,0) and coalesce(qt_meses_max,9999)) or (coalesce(qt_meses_w::text, '') = ''));					
			
				
				if (qt_regra_estab_w = 0) then
					
					select		coalesce(MAX('S'),'N')
					into STRICT		ds_retorno_w
					from		manchester_item	a
					where		nr_sequencia = nr_seq_item_manchester_p
					and		ie_leitura_obrigatoria = ie_leitura_obrigatoria_p
					and		coalesce(ie_tipo_cadastro,'P') <> 'C'
					and		ie_ritmico = ie_valor_regra_p				
					and		qt_idade_p between(coalesce(qt_idade_min,0) + dividir(coalesce(qt_dia_min,0),365)) and (coalesce(qt_idade_max,9999) + dividir(coalesce(qt_dia_max,0),365))
					and 	((coalesce(qt_dias_w,0) between coalesce(qt_dia_min,0) and coalesce(qt_dia_max,999999)) or (coalesce(qt_dias_w::text, '') = '') or (coalesce(qt_dia_max,0) = 0))
					and		((coalesce(qt_meses_w,0) between coalesce(qt_meses_min,0) and coalesce(qt_meses_max,9999)) or (coalesce(qt_meses_w::text, '') = ''))
					and		qt_valor_p between qt_valor_minimo and qt_valor_maximo
					and		coalesce(ie_tipo_cadastro,'P') <> 'C';
				
					
					if (ds_retorno_w	=	'N')then			
				
					
					select		coalesce(MAX('S'),'N')
					into STRICT		ds_retorno_w
					from		manchester_item	a
					where		nr_sequencia <> nr_seq_item_manchester_p
					and		ie_leitura_obrigatoria = ie_leitura_obrigatoria_p
					and		ie_ritmico = ie_valor_regra_p
					and		qt_idade_p between(coalesce(qt_idade_min,0) + dividir(coalesce(qt_dia_min,0),365)) and (coalesce(qt_idade_max,9999) + dividir(coalesce(qt_dia_max,0),365))
					and 	((coalesce(qt_dias_w,0) between coalesce(qt_dia_min,0) and coalesce(qt_dia_max,999999)) or (coalesce(qt_dias_w::text, '') = '') or (coalesce(qt_dia_max,0) = 0))
					and		((coalesce(qt_meses_w,0) between coalesce(qt_meses_min,0) and coalesce(qt_meses_max,9999)) or (coalesce(qt_meses_w::text, '') = ''))
					and		qt_valor_p between qt_valor_minimo and qt_valor_maximo
					and		coalesce(ie_tipo_cadastro,'P') <> 'C' 
					and		a.ds_item	=	(SELECT		max(a.ds_item)
										 from		manchester_item	a
										 where		nr_sequencia	=	nr_seq_item_manchester_p);
					end if;
				else
					
					select 	coalesce(MAX('S'),'N')
					into STRICT	ds_retorno_w
					from 	manchester_item	a
					where	ie_leitura_obrigatoria	=		ie_leitura_obrigatoria_p
					and		coalesce(ie_tipo_cadastro,'P') = 'C'
					and		a.ds_item	=	(SELECT		 max(a.ds_item)
											 from		manchester_item	a
											 where		nr_sequencia	=	nr_seq_item_manchester_p)
					and			qt_valor_p			between		qt_valor_minimo	and	qt_valor_maximo
					and			qt_idade_p			between(coalesce(qt_idade_min,0) + dividir(coalesce(qt_dia_min,0),365))	and (coalesce(qt_idade_max,9999) + dividir(coalesce(qt_dia_max,0),365))
					and 	((coalesce(qt_dias_w,0) between coalesce(qt_dia_min,0) and coalesce(qt_dia_max,999999)) or (coalesce(qt_dias_w::text, '') = '') or (coalesce(qt_dia_max,0) = 0))
					and		((coalesce(qt_meses_w,0) between coalesce(qt_meses_min,0) and coalesce(qt_meses_max,9999)) or (coalesce(qt_meses_w::text, '') = ''));
					
				end if;
			end if;
		end	if;
	end	if;

end	if;

return	ds_retorno_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION manchester_obter_regra_condic ( nr_seq_item_manchester_p bigint, ie_leitura_obrigatoria_p text, qt_valor_p bigint, ie_valor_regra_p text, qt_idade_p bigint, nr_atendimento_p bigint default 0, ie_dormindo_p text default 'A') FROM PUBLIC;

