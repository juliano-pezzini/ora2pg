-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_posicao_card_ocup_quimio ( nr_seq_local_p bigint, ie_posicao_p text, cd_estabelecimento_p bigint, nr_seq_grupo_quimio_p bigint) RETURNS bigint AS $body$
DECLARE


qt_posicao_w                bigint := 0;
qt_posicao_card_w           bigint := 0;
continua_w                  varchar(1) :='S';

nr_sequencia_w              bigint;
qt_posicao_card_y_w         bigint := 0;
qt_posicao_card_x_w         bigint := 0;

C01 CURSOR FOR
SELECT
    qt_local.nr_sequencia
FROM
    qt_local,
    qt_local_turno
WHERE
    qt_local_turno.nr_seq_local = qt_local.nr_sequencia
    AND qt_local.cd_estabelecimento = cd_estabelecimento_p
    AND qt_local.ie_situacao = 'A'
    AND (qt_local_turno.dt_dia_semana = obter_cod_dia_semana(clock_timestamp()) OR (qt_local_turno.dt_dia_semana = 9 AND pkg_date_utils.is_business_day(clock_timestamp()) = 1) )
    AND (coalesce(qt_local_turno.dt_vigencia_inicial::text, '') = '' OR clock_timestamp() >= qt_local_turno.dt_vigencia_inicial )
    AND (coalesce(qt_local_turno.dt_vigencia_final::text, '') = '' OR clock_timestamp() <= qt_local_turno.dt_vigencia_final )
    AND ((coalesce(qt_local_turno.ie_feriado::text, '') = '' OR qt_local_turno.ie_feriado = 'N') OR (qt_local_turno.ie_feriado = 'S' AND obter_se_feriado(cd_estabelecimento_p, clock_timestamp()) > 0) )
    AND (coalesce(nr_seq_grupo_quimio_p::text, '') = '' OR ((nr_seq_grupo_quimio_p IS NOT NULL AND nr_seq_grupo_quimio_p::text <> '') AND qt_local.nr_seq_grupo_quimio = nr_seq_grupo_quimio_p))
GROUP BY 
    qt_local.nr_sequencia,
    qt_local.nr_seq_apres
ORDER BY
    qt_local.nr_seq_apres, 
    qt_local.nr_sequencia;


BEGIN


open C01;
loop
fetch C01 into
    nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */


    if (continua_w = 'S') then      
        if (nr_sequencia_w = nr_seq_local_p) then
            continua_w := 'N';
            
            qt_posicao_card_y_w := trunc(qt_posicao_card_w / 4, 0);
            qt_posicao_card_x_w := mod(qt_posicao_card_w, 4);
        end if;
    end if;

    qt_posicao_card_w := qt_posicao_card_w + 1;

end loop;
close C01;

<<Fim>>
if ( ie_posicao_p = 'X' ) then
    qt_posicao_w := qt_posicao_card_x_w;

elsif ( ie_posicao_p = 'Y' ) then   
    qt_posicao_w := qt_posicao_card_y_w;

end if;

return  qt_posicao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_posicao_card_ocup_quimio ( nr_seq_local_p bigint, ie_posicao_p text, cd_estabelecimento_p bigint, nr_seq_grupo_quimio_p bigint) FROM PUBLIC;

