-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_data_autor_convenio (cd_convenio_p bigint, dt_agenda_p timestamp, operacao_p text, ie_limite_p text, ie_descricao_p text, cd_agenda_p text default 0) RETURNS timestamp AS $body$
DECLARE

qt_tempo_autorizacao_w		bigint:=0;
qt_tempo_autorizacao_proc_w	bigint:=0;
nr_cont_w			bigint:=1;
dt_agenda_w			timestamp;
cd_dia_semana_w			varchar(1);
qt_dias_uteis_w			bigint:=0;
qt_dias_param_w			bigint:= 2;
qt_tempo_codificao_w		bigint:=0;
qt_tempo_term_agenda_w		bigint:=0;
cd_estabelecimento_w		smallint;

-- operacao_p

--A - Adiciona 	- Operacao utilizada no filtro da agenda conforme data atual

--S - Subtrai 	- Operacao utilizada para calcular a data limite


--ie_limite_p

--C - Convenio	- Data  Limite do Convenio - Data da agenda - (Quantidade de dias uteis para autorizacao)

--A - Agenda	- Data  Limite da Agenda - Data da agenda - (Quantidade de dias uteis para autorizacao + 2 dias para a etapa de agendamento)


-- ie_descricao_p

-- M - Material - Traz a descricao da data limite do material

-- P - Procedimento - Traz a descricao da data limite do procedimento

-- C - Codificacao - Traz a descricao da data limite de codificacao

-- T - Term agenda - Traz a descricao da data limite de termino  agenda
BEGIN

qt_dias_param_w := obter_param_usuario(871, 676, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, qt_dias_param_w);

dt_agenda_w		:= dt_agenda_p;

select 	coalesce(max(cd_estabelecimento),wheb_usuario_pck.get_cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	agenda
where 	cd_agenda = cd_agenda_p;

-- Obter Quantidade de dias para autorizacao
qt_tempo_autorizacao_w		:= obter_qtd_dias_aut_convenio(cd_convenio_p,'M',cd_estabelecimento_w);
qt_tempo_autorizacao_proc_w	:= obter_qtd_dias_aut_convenio(cd_convenio_p,'P',cd_estabelecimento_w);

qt_tempo_codificao_w		:= obter_qtd_dias_aut_convenio(cd_convenio_p,'C',cd_estabelecimento_w);
qt_tempo_term_agenda_w		:= obter_qtd_dias_aut_convenio(cd_convenio_p,'T',cd_estabelecimento_w);

if (ie_descricao_p <> 'M') and (ie_descricao_p <> 'P') and (ie_descricao_p <> 'C') and (ie_descricao_p <> 'T') then -- Nao e descricao, e para buscar a data limite do convenio
	if (qt_tempo_autorizacao_proc_w > qt_tempo_autorizacao_w) then
		-- Verifica qual e a maior quantidade (se e a do material ou do procedimento)
		qt_tempo_autorizacao_w := qt_tempo_autorizacao_proc_w;
	end if;	
elsif (ie_descricao_p = 'P') then -- Traz a descricao da data limite do procedimento
	qt_tempo_autorizacao_w := qt_tempo_autorizacao_proc_w;
elsif (ie_descricao_p = 'C') then -- Traz a descricao da data limite da codificacao
	qt_tempo_autorizacao_w := qt_tempo_codificao_w;
elsif (ie_descricao_p = 'T') then -- Traz a descricao da data termino agenda
	qt_tempo_autorizacao_w := qt_tempo_term_agenda_w;
end if;	

-- Se for data limite da agenda
if (ie_limite_p = 'A') then
	qt_dias_uteis_w := qt_dias_param_w;
end if;
	
if (qt_tempo_autorizacao_w > 0) then
	qt_tempo_autorizacao_w := qt_tempo_autorizacao_w + qt_dias_uteis_w;
end if;	

while(nr_cont_w <= qt_tempo_autorizacao_w) loop
	begin
	if (operacao_p = 'S') then
		dt_agenda_w 	:= dt_agenda_w - 1;
	else
		dt_agenda_w 	:= dt_agenda_w + 1;
	end if;	
	cd_dia_semana_w := Obter_Cod_Dia_Semana(dt_agenda_w);
	if (cd_dia_semana_w <> 1) and (cd_dia_semana_w <> 7) then
		nr_cont_w 	:= nr_cont_w + 1;
	end if;
	end;
end loop;	

if (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_agenda_w) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_agenda_p)) then
	return null;
else
	return dt_agenda_w;
end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_data_autor_convenio (cd_convenio_p bigint, dt_agenda_p timestamp, operacao_p text, ie_limite_p text, ie_descricao_p text, cd_agenda_p text default 0) FROM PUBLIC;

