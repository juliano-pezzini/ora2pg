-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_emitir_relat_adep (cd_estabelecimento_p bigint, nr_atendimento_p bigint, dt_inicial_relat_p timestamp, dt_final_relat_p timestamp, ie_emissao_relat_p text) RETURNS varchar AS $body$
DECLARE



ie_emitir_relat_w		varchar(1) := 'S';

nr_seq_regra_w			bigint;
cd_setor_atendimento_w	bigint;
ie_dieta_oral_w		varchar(1);
ie_suplemento_oral_w	varchar(1);
ie_medicamento_w		varchar(1);
ie_material_w		varchar(1);
ie_so_setor_atual_w	varchar(10);
ie_procedimento_w		varchar(1);
ie_recomendacao_w	varchar(1);
ie_solucao_w		varchar(1);
ie_sae_w			varchar(1);
ie_laboratorio_w		varchar(1);
ie_gasoterapia_w		varchar(1);
ie_suplemento_enteral_w	varchar(1);
ie_dialise_w			varchar(1);

C01 CURSOR FOR
SELECT	ie_dieta_oral,
		ie_suplemento_oral,
		ie_medicamento,
		ie_material,
		ie_procedimento,
		ie_recomendacao,
		ie_sae,
		ie_laboratorio,
		ie_solucao,
		ie_gasoterapia,
		ie_suplemento_enteral,
		ie_dialise
from	regra_emissao_relat_adep
where	coalesce(nr_sequencia,0) > 0
and		cd_estabelecimento = cd_estabelecimento_p
and (cd_perfil = wheb_usuario_pck.get_cd_perfil
or		coalesce(cd_perfil::text, '') = '')
and (cd_setor_atendimento = wheb_usuario_pck.get_cd_setor_atendimento
or		coalesce(cd_setor_atendimento::text, '') = '')
order by coalesce(cd_perfil, 0),
		 coalesce(cd_setor_atendimento,0);


BEGIN
if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (dt_inicial_relat_p IS NOT NULL AND dt_inicial_relat_p::text <> '') and (dt_final_relat_p IS NOT NULL AND dt_final_relat_p::text <> '') and (ie_emissao_relat_p IS NOT NULL AND ie_emissao_relat_p::text <> '') then

	ie_so_setor_atual_w := Obter_Param_Usuario(1113, 240, obter_perfil_ativo, WHEB_USUARIO_PCK.get_nm_usuario, cd_estabelecimento_p, ie_so_setor_atual_w);
	
	cd_setor_atendimento_w	:= obter_setor_atendimento(nr_atendimento_p);
	
	if (ie_emissao_relat_p = 'N') then

		select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
		into STRICT	ie_emitir_relat_w
		from	adep_pend_v
		where	nr_atendimento = nr_atendimento_p
		and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
		and	dt_horario between dt_inicial_relat_p and dt_final_relat_p;

	elsif (ie_emissao_relat_p = 'R') then

		open C01;
		loop
		fetch C01 into
			ie_dieta_oral_w,
			ie_suplemento_oral_w,
			ie_medicamento_w,
			ie_material_w,
			ie_procedimento_w,
			ie_recomendacao_w,
			ie_sae_w,
			ie_laboratorio_w,
			ie_solucao_w,
			ie_gasoterapia_w,
			ie_suplemento_enteral_w,
			ie_dialise_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */		
		end loop;
		close C01;
				
			if (ie_dieta_oral_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_pend_v
				where	nr_atendimento = nr_atendimento_p
				and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
				and	dt_horario between dt_inicial_relat_p and dt_final_relat_p
				and	ie_tipo_item = 'D';
				
			end if;

			if (ie_emitir_relat_w = 'S') and (ie_suplemento_oral_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_pend_v
				where	nr_atendimento = nr_atendimento_p
				and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
				and	dt_horario between dt_inicial_relat_p and dt_final_relat_p
				and	ie_tipo_item = 'S';
				
			end if;

			if (ie_emitir_relat_w = 'S') and (ie_gasoterapia_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_pend_v
				where	nr_atendimento = nr_atendimento_p
				and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
				and		dt_horario between dt_inicial_relat_p and dt_final_relat_p
				and		coalesce(substr(Obter_Status_Gasoterapia(nr_seq_item, 'C'),1,80),'N') not in ('T', 'S', 'R', 'I')
				and		ie_tipo_item = 'O';
				
			end if;

			if (ie_emitir_relat_w = 'S') and (ie_suplemento_enteral_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_pend_v
				where	nr_atendimento = nr_atendimento_p
				and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
				and	dt_horario between dt_inicial_relat_p and dt_final_relat_p
				and	ie_tipo_item = 'NE';
				
			end if;

			if (ie_emitir_relat_w = 'S') and (ie_dialise_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_pend_dialise_v
				where	nr_atendimento = nr_atendimento_p
				and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
				and	dt_status between dt_inicial_relat_p and dt_final_relat_p
				and	ie_tipo_item = 'DI';
				
			end if;
			
			if (ie_emitir_relat_w = 'S') and (ie_solucao_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_sol_prescr_v a,
					prescr_medica b
				where   coalesce(a.dt_susp_prescr::text, '') = ''
				and      a.ie_suspenso <> 'S'
				and      coalesce(a.ie_acm,'N') <> 'S'
				and      (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
				and      a.dt_status < clock_timestamp()
				and		((ie_so_setor_atual_w <> 'S') or (b.cd_setor_atendimento = cd_setor_atendimento_w))
				and      a.dt_validade_prescr between dt_inicial_relat_p and dt_final_relat_p
				and      a.nr_atendimento = nr_atendimento_p
				and      a.nr_prescricao = b.nr_prescricao
				and      a.ie_tipo_solucao = 1
				and      coalesce(a.ie_adep,'N') = 'S'
				and     a.ie_status_solucao = 'N';

			end if;

			if (ie_emitir_relat_w = 'S') and (ie_medicamento_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_pend_v
				where	nr_atendimento = nr_atendimento_p
				and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
				and	dt_horario between dt_inicial_relat_p and dt_final_relat_p
				and	ie_tipo_item = 'M';
				
			end if;

			if (ie_emitir_relat_w = 'S') and (ie_material_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_pend_v
				where	nr_atendimento = nr_atendimento_p
				and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
				and	dt_horario between dt_inicial_relat_p and dt_final_relat_p
				and	ie_tipo_item = 'MAT';
				
			end if;

			if (ie_emitir_relat_w = 'S') and (ie_procedimento_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_pend_v
				where	nr_atendimento = nr_atendimento_p
				and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
				and	dt_horario between dt_inicial_relat_p and dt_final_relat_p
				and	ie_tipo_item = 'P';
				
			end if;

			if (ie_emitir_relat_w = 'S') and (ie_recomendacao_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_pend_v
				where	nr_atendimento = nr_atendimento_p
				and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
				and	dt_horario between dt_inicial_relat_p and dt_final_relat_p
				and	ie_tipo_item = 'R';
				
			end if;

			if (ie_emitir_relat_w = 'S') and (ie_sae_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_pend_v
				where	nr_atendimento = nr_atendimento_p
				and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
				and	dt_horario between dt_inicial_relat_p and dt_final_relat_p
				and	ie_tipo_item = 'E';
				
			end if;

			if (ie_emitir_relat_w = 'S') and (ie_laboratorio_w = 'S') then

				select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
				into STRICT	ie_emitir_relat_w
				from	adep_pend_v
				where	nr_atendimento = nr_atendimento_p
				and		((ie_so_setor_atual_w <> 'S') or (cd_setor_prescr = cd_setor_atendimento_w))
				and	dt_horario between dt_inicial_relat_p and dt_final_relat_p
				and	ie_tipo_item = 'L';
				
			end if;
		
	end if;

end if;

return ie_emitir_relat_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_emitir_relat_adep (cd_estabelecimento_p bigint, nr_atendimento_p bigint, dt_inicial_relat_p timestamp, dt_final_relat_p timestamp, ie_emissao_relat_p text) FROM PUBLIC;

