-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prescricao_servicos_rep (nr_seq_serv_dia_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		 	varchar(255);
nr_prescr_oral_w   	  	bigint;
nr_prescr_jejum_w         	bigint;
nr_prescr_compl_w         	bigint;
nr_prescr_enteral_w       	bigint;
nr_prescr_npt_adulta_w    	bigint;
nr_prescr_npt_ped_w       	bigint;
nr_prescr_npt_neo_w      	bigint;
nr_prescr_leite_deriv_w		bigint;
nr_seq_servico_w	  	bigint;
ie_tipo_prescr_serv_w		bigint;


BEGIN

if (nr_seq_serv_dia_p IS NOT NULL AND nr_seq_serv_dia_p::text <> '') then

	ds_retorno_w := '';
	select  max(coalesce(nr_prescr_oral,0)),
		max(coalesce(nr_prescr_jejum,0)),
		max(coalesce(nr_prescr_compl,0)),
		max(coalesce(nr_prescr_enteral,0)),
		max(coalesce(nr_prescr_npt_adulta,0)),
		max(coalesce(nr_prescr_npt_ped,0)),
		max(coalesce(nr_prescr_npt_neo,0)),
		max(coalesce(nr_prescr_leite_deriv,0))
	into STRICT	nr_prescr_oral_w,
		nr_prescr_jejum_w,
		nr_prescr_compl_w,
		nr_prescr_enteral_w,
		nr_prescr_npt_adulta_w,
		nr_prescr_npt_ped_w,
		nr_prescr_npt_neo_w,
		nr_prescr_leite_deriv_w
	from 	nut_atend_serv_dia_rep a
	where	nr_seq_serv_dia = nr_seq_serv_dia_p;

	select	max(coalesce(nr_seq_servico,0))
	into STRICT	nr_seq_servico_w
	from	nut_atend_serv_dia
	where	nr_sequencia	= nr_seq_serv_dia_p;

	select	coalesce(max(ie_tipo_prescricao_servico),1)
	into STRICT	ie_tipo_prescr_serv_w
	from	nut_servico
	where	nr_sequencia = nr_seq_servico_w;


	if (ie_tipo_prescr_serv_w = 3) then --Suplemento
		ds_retorno_w:= nr_prescr_compl_w;
	else

		if (nr_prescr_oral_w <> 0) then
			ds_retorno_w := nr_prescr_oral_w || ',';
		end if;
		if (nr_prescr_jejum_w <> 0 AND nr_prescr_jejum_w <> nr_prescr_oral_w) then
			ds_retorno_w := ds_retorno_w || nr_prescr_jejum_w || ',';
		end if;

		/* Suplemento
		if ((nr_prescr_compl_w <> 0) and (nr_prescr_compl_w <> nr_prescr_oral_w) and (nr_prescr_compl_w <> nr_prescr_jejum_w)) then
			ds_retorno_w := ds_retorno_w || nr_prescr_compl_w|| ',';
		end if;*/
		if ((nr_prescr_enteral_w <> 0) and (nr_prescr_enteral_w <> nr_prescr_oral_w) and (nr_prescr_enteral_w <> nr_prescr_jejum_w)) then
			ds_retorno_w := ds_retorno_w || nr_prescr_enteral_w||',';
		end if;
		if ((nr_prescr_npt_adulta_w <> 0) and (nr_prescr_npt_adulta_w <> nr_prescr_oral_w) and (nr_prescr_npt_adulta_w <> nr_prescr_jejum_w) and (nr_prescr_npt_adulta_w <> nr_prescr_enteral_w)) then
			ds_retorno_w := ds_retorno_w || nr_prescr_npt_adulta_w || ',';
		end if;
		if ((nr_prescr_npt_ped_w <> 0) and (nr_prescr_npt_ped_w <> nr_prescr_oral_w) and (nr_prescr_npt_ped_w <> nr_prescr_jejum_w) and (nr_prescr_npt_ped_w <> nr_prescr_enteral_w) and (nr_prescr_npt_ped_w <> nr_prescr_npt_adulta_w)) then
			ds_retorno_w := ds_retorno_w || nr_prescr_npt_ped_w|| ',';
		end if;
		if ((nr_prescr_npt_neo_w <> 0) and (nr_prescr_npt_neo_w <> nr_prescr_oral_w) and (nr_prescr_npt_neo_w <> nr_prescr_jejum_w) and (nr_prescr_npt_neo_w <> nr_prescr_enteral_w) and (nr_prescr_npt_neo_w <> nr_prescr_npt_adulta_w) and (nr_prescr_npt_neo_w <> nr_prescr_npt_ped_w) )then
			ds_retorno_w := ds_retorno_w || nr_prescr_npt_neo_w|| ',';
		end if;

		if ((nr_prescr_leite_deriv_w <> 0) and (nr_prescr_leite_deriv_w <> nr_prescr_oral_w) and (nr_prescr_leite_deriv_w <> nr_prescr_jejum_w) and (nr_prescr_leite_deriv_w <> nr_prescr_enteral_w) and (nr_prescr_leite_deriv_w <> nr_prescr_npt_adulta_w) and (nr_prescr_leite_deriv_w <> nr_prescr_npt_ped_w) )then
			ds_retorno_w := ds_retorno_w || nr_prescr_leite_deriv_w|| ',';
		end if;

		ds_retorno_w := substr(ds_retorno_w,0,length(ds_retorno_w)-1);
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prescricao_servicos_rep (nr_seq_serv_dia_p bigint) FROM PUBLIC;

