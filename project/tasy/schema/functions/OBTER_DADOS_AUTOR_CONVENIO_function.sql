-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_autor_convenio (nr_sequencia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

/* ie_opcao
	S - Senha		- recebe parametro nr_atendimento
	A - Autorizacao 		- recebe parametro nr_atendimento
	E - Estabelecimento	- recebe parametro nr_sequencia da autorizacao_convenio
	DA - Data da agenda	- recebe parametro nr_sequencia da autorizacao_convenio
	CC - Categoria do convenio	- recebe parametro nr_sequencia da autorizacao_convenio
	CU - Codigo do usuario	- recebe parametro nr_sequencia da autorizacao_convenio
	PR - Prontuario 		- recebe parametro nr_sequencia da autorizacao_convenio - afstringari OS164694 04/09/2009
	C - Convenio		- recebe parametro nr_sequencia da autorizacao_convenio
	CP -  Codigo  do plano
	CPR -  Codigo procedimento
	OP - ie origem procedimento
	HR  - hora do procedimento
	TA -  Tipo atendimento
	PA - Pessoa do atendimento
	NT - Telefone da agenda integrada	afreinert OS696928 12/02/2014
	ET - Descricao da etapa da autorizacao
*/
cd_senha_w					varchar(20);
cd_autorizacao_w			varchar(20);
ds_retorno_w				varchar(100);
cd_estabelecimento_w		bigint;
nr_atendimento_w			bigint;
nr_seq_agenda_w				agenda_paciente.nr_sequencia%type;
nr_seq_agenda_consulta_w 	agenda_consulta.nr_sequencia%type;
nr_seq_gestao_w				bigint;
dt_agenda_w					timestamp;
cd_categoria_conv_w			varchar(10) := null;
cd_usuario_convenio_w		varchar(30);
nr_seq_age_integ_w			bigint;
nr_prontuario_w				varchar(30);
cd_convenio_w				bigint;
nr_seq_paciente_setor_W		bigint;
cd_plano_w					varchar(10);
cd_procedimento_w			bigint;
ie_origem_proced_w			bigint;
hr_inicio_w					timestamp;
ie_tipo_atendimento_w		smallint;
nm_pessoa_fisica_w		varchar(100);
nr_telefone_agen_int_w	agenda_integrada.nr_telefone%type;
nr_seq_etapa_w			autorizacao_conv_etapa.nr_seq_etapa%type;
dt_autorizacao_w		timestamp;
nr_seq_paciente_w		paciente_atendimento.nr_seq_atendimento%type;
c01 CURSOR FOR
SELECT	cd_senha,
	cd_autorizacao
from	autorizacao_convenio
where	nr_atendimento	= nr_sequencia_p;

BEGIN
if (ie_opcao_p  ('S', 'A')) then
	open	c01;
	loop
	fetch	c01 into
		cd_senha_w,
		cd_autorizacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		if (ie_opcao_p	= 'S') then
			ds_retorno_w	:= cd_senha_w;
		elsif (ie_opcao_p	= 'A') then
			ds_retorno_w	:= cd_autorizacao_w;
		end if;
	end loop;
	close c01;
elsif (ie_opcao_p = 'E') then
	select	nr_seq_agenda,
		nr_atendimento,
		nr_seq_agenda_consulta,
		nr_seq_gestao,
		nr_seq_paciente_setor,
		nr_seq_paciente
	into STRICT	nr_seq_agenda_w,
		nr_atendimento_w,
		nr_seq_agenda_consulta_w,
		nr_seq_gestao_w,
		nr_seq_paciente_setor_w,
		nr_seq_paciente_w
	from	autorizacao_convenio
	where	nr_sequencia	= nr_sequencia_p;
	if (coalesce(nr_seq_agenda_w,0) > 0) then
		select	b.cd_estabelecimento
		into STRICT	cd_estabelecimento_w
		from	agenda b,
			agenda_paciente a
		where	a.cd_agenda	= b.cd_agenda
		and	a.nr_sequencia	= nr_seq_agenda_w;
	elsif (coalesce(nr_atendimento_w,0) > 0) then
		select	cd_estabelecimento
		into STRICT	cd_estabelecimento_w
		from	atendimento_paciente
		where	nr_atendimento	= nr_atendimento_w;
	elsif (coalesce(nr_seq_agenda_consulta_w, 0) > 0) then
		select	cd_estabelecimento
		into STRICT	cd_estabelecimento_w
		from	agenda b,
			agenda_consulta a
		where	a.cd_agenda	= b.cd_agenda
		and	a.nr_sequencia	= nr_seq_agenda_consulta_w;
	elsif (coalesce(nr_seq_gestao_w,0) > 0) then
		select	cd_estabelecimento
		into STRICT	cd_estabelecimento_w
		from	gestao_vaga
		where	nr_sequencia	= nr_seq_gestao_w;
	elsif (coalesce(nr_seq_paciente_w,0) > 0) then
		select	max(cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	paciente_atendimento
		where	nr_seq_atendimento = nr_seq_paciente_w;
	elsif (coalesce(nr_seq_paciente_setor_w,0) > 0) then
		select	cd_estabelecimento
		into STRICT	cd_estabelecimento_w
		from	paciente_setor
		where	nr_seq_paciente = nr_seq_paciente_setor_w;
	end if;
	ds_retorno_w		:= cd_estabelecimento_w;
elsif (ie_opcao_p = 'PR') then
	select	nr_atendimento,
		nr_seq_agenda,
		nr_seq_gestao,
		nr_seq_age_integ,
		nr_seq_paciente_setor,
		nr_seq_agenda_consulta
	into STRICT	nr_atendimento_w,
		nr_seq_agenda_w,
		nr_seq_gestao_w,
		nr_seq_age_integ_w,
		nr_seq_paciente_setor_w,
		nr_seq_agenda_consulta_w
	from	autorizacao_convenio
	where	nr_sequencia	= nr_sequencia_p;
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		select	obter_prontuario_paciente(cd_pessoa_fisica)
		into STRICT	nr_prontuario_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_w;
	elsif (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') then
		select	obter_prontuario_paciente(a.cd_pessoa_fisica)
		into STRICT	nr_prontuario_w
		from	agenda_paciente a,
			autorizacao_convenio b
		where	a.nr_sequencia	= b.nr_seq_agenda
		and	b.nr_sequencia	= nr_sequencia_p;
	elsif (nr_seq_gestao_w IS NOT NULL AND nr_seq_gestao_w::text <> '') then
		select	obter_prontuario_paciente(a.cd_pessoa_fisica)
		into STRICT	nr_prontuario_w
		from	gestao_vaga a,
			autorizacao_convenio b
		where	a.nr_sequencia	= b.nr_seq_gestao
		and	b.nr_sequencia	= nr_sequencia_p;
	elsif (nr_seq_age_integ_w IS NOT NULL AND nr_seq_age_integ_w::text <> '') then
		select	obter_prontuario_paciente(a.cd_pessoa_fisica)
		into STRICT	nr_prontuario_w
		from	agenda_integrada a,
			autorizacao_convenio b
		where	b.nr_seq_age_integ	= a.nr_sequencia
		and	b.nr_sequencia		= nr_sequencia_p;
	elsif (nr_seq_paciente_setor_w IS NOT NULL AND nr_seq_paciente_setor_w::text <> '') then
		select	obter_prontuario_paciente(a.cd_pessoa_fisica)
		into STRICT	nr_prontuario_w
		from	paciente_setor a
		where	a.nr_seq_paciente = nr_seq_paciente_setor_w;
	elsif (nr_seq_agenda_consulta_w IS NOT NULL AND nr_seq_agenda_consulta_w::text <> '') then
		select	obter_prontuario_paciente(cd_pessoa_fisica)
		into STRICT	nr_prontuario_w
		from	agenda_consulta
		where	nr_sequencia = nr_seq_agenda_consulta_w;
	end if;
	ds_retorno_w		:= nr_prontuario_w;
elsif (ie_opcao_p = 'DA') then
	select	max(nr_seq_agenda),
		max(nr_seq_agenda_consulta),
		max(nr_seq_age_integ)
	into STRICT	nr_seq_agenda_w,
		nr_seq_agenda_consulta_w,
		nr_seq_age_integ_w
	from	autorizacao_convenio
	where	nr_sequencia	= nr_sequencia_p;
	if (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') then
		select	a.dt_agenda
		into STRICT	dt_agenda_w
		from	agenda_paciente a
		where	nr_sequencia	= nr_seq_agenda_w;
	elsif (nr_seq_agenda_consulta_w IS NOT NULL AND nr_seq_agenda_consulta_w::text <> '') then
		select	max(a.dt_agenda)
		into STRICT	dt_agenda_w
		from	agenda_consulta a
		where	nr_sequencia	= nr_seq_agenda_consulta_w;
	elsif (nr_seq_age_integ_w IS NOT NULL AND nr_seq_age_integ_w::text <> '') then
		select	max(a.dt_inicio_agendamento)
		into STRICT	dt_agenda_w
		from	agenda_integrada a
		where	nr_sequencia	= nr_seq_age_integ_w;
	end if;
	ds_retorno_w		:= dt_agenda_w;
elsif (ie_opcao_p = 'CC') then
	select	nr_atendimento,
		nr_seq_agenda,
		nr_seq_gestao,
		nr_seq_age_integ,
		nr_seq_paciente_setor
	into STRICT	nr_atendimento_w,
		nr_seq_agenda_w,
		nr_seq_gestao_w,
		nr_seq_age_integ_w,
		nr_seq_paciente_setor_w
	from	autorizacao_convenio
	where	nr_sequencia	= nr_sequencia_p;
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		select	a.cd_categoria
		into STRICT	cd_categoria_conv_w
		from	atend_categoria_convenio a,
			autorizacao_convenio b
		where	a.nr_atendimento	= b.nr_atendimento
		and	a.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento)
		and	b.nr_sequencia		= nr_sequencia_p;
	elsif (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') then
		select	a.cd_categoria
		into STRICT	cd_categoria_conv_w
		from	agenda_paciente a,
			autorizacao_convenio b
		where	a.nr_sequencia	= b.nr_seq_agenda
		and	b.nr_sequencia	= nr_sequencia_p;
	elsif (nr_seq_gestao_w IS NOT NULL AND nr_seq_gestao_w::text <> '') then
		select	a.cd_categoria
		into STRICT	cd_categoria_conv_w
		from	gestao_vaga a,
			autorizacao_convenio b
		where	a.nr_sequencia	= b.nr_seq_gestao
		and	b.nr_sequencia	= nr_sequencia_p;
	elsif (nr_seq_age_integ_w IS NOT NULL AND nr_seq_age_integ_w::text <> '') then
		select	a.cd_categoria
		into STRICT	cd_categoria_conv_w
		from	agenda_integrada a,
			autorizacao_convenio b
		where	b.nr_seq_age_integ	= a.nr_sequencia
		and	b.nr_sequencia		= nr_sequencia_p;
	elsif (nr_seq_paciente_setor_w IS NOT NULL AND nr_seq_paciente_setor_w::text <> '') then
		select	max(cd_categoria)
		into STRICT	cd_categoria_conv_w
		from	paciente_setor_convenio
		where	nr_seq_paciente = nr_seq_paciente_setor_w;
	else
		select	max(cd_categoria)
		into STRICT	cd_categoria_conv_w
		from	autorizacao_convenio_tiss
		where	nr_sequencia_autor = nr_sequencia_p;
	end if;
	ds_retorno_w		:= cd_categoria_conv_w;
elsif (ie_opcao_p = 'CU') then
	select	nr_atendimento,
		nr_seq_agenda,
		nr_seq_gestao,
		nr_seq_age_integ,
		dt_autorizacao,
		nr_seq_agenda_consulta
	into STRICT	nr_atendimento_w,
		nr_seq_agenda_w,
		nr_seq_gestao_w,
		nr_seq_age_integ_w,
		dt_autorizacao_w,
		nr_seq_agenda_consulta_w
	from	autorizacao_convenio
	where	nr_sequencia	= nr_sequencia_p;
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		
		
		select	max(a.cd_usuario_convenio)
		into STRICT	cd_usuario_convenio_w
		from	atend_categoria_convenio a,
			autorizacao_convenio b
		where	a.nr_atendimento	= b.nr_atendimento
		and 	dt_autorizacao_w between a.dt_inicio_vigencia and coalesce(a.dt_final_vigencia,dt_autorizacao_w+1)
		and	b.nr_sequencia		= nr_sequencia_p;
		
		if (coalesce(cd_usuario_convenio_w::text, '') = '') then
			select	max(a.cd_usuario_convenio)
			into STRICT	cd_usuario_convenio_w
			from	atend_categoria_convenio a,
				autorizacao_convenio b
			where	a.nr_atendimento	= b.nr_atendimento
			and	a.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento)
			and	b.nr_sequencia		= nr_sequencia_p;
		end if;
		
		
		
	elsif (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') then
		select	a.cd_usuario_convenio
		into STRICT	cd_usuario_convenio_w
		from	agenda_paciente a,
			autorizacao_convenio b
		where	a.nr_sequencia	= b.nr_seq_agenda
		and	b.nr_sequencia	= nr_sequencia_p;
	elsif (nr_seq_gestao_w IS NOT NULL AND nr_seq_gestao_w::text <> '') then
		select	a.ds_cod_usuario
		into STRICT	cd_usuario_convenio_w
		from	gestao_vaga a,
			autorizacao_convenio b
		where	a.nr_sequencia	= b.nr_seq_gestao
		and	b.nr_sequencia	= nr_sequencia_p;
	elsif (nr_seq_age_integ_w IS NOT NULL AND nr_seq_age_integ_w::text <> '') then
		select	a.cd_usuario_convenio
		into STRICT	cd_usuario_convenio_w
		from	agenda_integrada a,
			autorizacao_convenio b
		where	b.nr_seq_age_integ	= a.nr_sequencia
		and	b.nr_sequencia		= nr_sequencia_p;
	elsif (nr_seq_agenda_consulta_w IS NOT NULL AND nr_seq_agenda_consulta_w::text <> '') then
		select	a.cd_usuario_convenio
		into STRICT	cd_usuario_convenio_w
		from	agenda_consulta a,
			autorizacao_convenio b
		where	b.nr_seq_agenda_consulta = a.nr_sequencia
		and	b.nr_sequencia		= nr_sequencia_p;
	end if;
	
	if (coalesce(cd_usuario_convenio_w::text, '') = '') then
		select 	max(a.cd_usuario_convenio)
		into STRICT 	cd_usuario_convenio_w
		from 	pessoa_titular_convenio a,
			autorizacao_convenio b
		where 	b.nr_sequencia = nr_sequencia_p
		and 	a.cd_pessoa_fisica = b.cd_pessoa_fisica
		and 	a.cd_convenio = b.cd_convenio
		and 	clock_timestamp() between coalesce(a.dt_inicio_vigencia,clock_timestamp()) and coalesce(a.dt_fim_vigencia,clock_timestamp() + interval '1 days');
	end if;

	ds_retorno_w		:= cd_usuario_convenio_w;
	elsif (ie_opcao_p = 'CP') then
	select	nr_atendimento,
		nr_seq_agenda,
		nr_seq_gestao,
		nr_seq_age_integ,
		nr_seq_paciente_setor
	into STRICT	nr_atendimento_w,
		nr_seq_agenda_w,
		nr_seq_gestao_w,
		nr_seq_age_integ_w,
		nr_seq_paciente_setor_w
	from	autorizacao_convenio
	where	nr_sequencia	= nr_sequencia_p;
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	select	b.cd_plano_convenio
	into STRICT	cd_plano_w
	from	autorizacao_convenio a,
			atend_categoria_convenio b
	where	a.nr_atendimento	= b.nr_atendimento
	and		b.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento)
	and		a.nr_sequencia		= nr_sequencia_p;
	elsif (nr_Seq_agenda_w IS NOT NULL AND nr_Seq_agenda_w::text <> '') then
		select	b.cd_plano
		into STRICT	cd_plano_w
		from	agenda_paciente b,
			autorizacao_convenio a
		where	a.nr_seq_agenda	= b.nr_sequencia
		and	a.nr_Sequencia	= nr_Sequencia_p;
	elsif (nr_seq_gestao_w IS NOT NULL AND nr_seq_gestao_w::text <> '') then
		select	b.cd_plano_convenio
		into STRICT	cd_plano_w
		from	gestao_Vaga b,
				autorizacao_convenio a
		where	a.nr_Seq_gestao	= b.nr_sequencia
		and	a.nr_Sequencia	= nr_Sequencia_p;
	elsif (nr_seq_age_integ_w IS NOT NULL AND nr_seq_age_integ_w::text <> '') then
		select	b.cd_plano
		into STRICT	cd_plano_w
		from	agenda_integrada b,
			autorizacao_convenio a
		where   a.nr_seq_age_integ	= b.nr_sequencia
		and	a.nr_sequencia		= nr_Sequencia_p;
	elsif (nr_seq_paciente_setor_w IS NOT NULL AND nr_seq_paciente_setor_w::text <> '')then
		select	max(cd_plano)
		into STRICT	cd_plano_w
		from	paciente_setor_convenio
		where	nr_seq_paciente = nr_seq_paciente_setor_w;
	elsif (nr_seq_paciente_setor_w IS NOT NULL AND nr_seq_paciente_setor_w::text <> '') then
		select	max(cd_plano)
		into STRICT	cd_plano_w
		from	paciente_setor_convenio
		where	nr_seq_paciente = nr_seq_paciente_setor_w;
	end if;
	ds_Retorno_w	 :=	cd_plano_w;
	elsif (ie_opcao_p = 'CPR') then
		select	max(b.cd_procedimento)
		into STRICT	cd_procedimento_w
		from	agenda_paciente b,
				autorizacao_convenio a
		where	a.nr_seq_agenda	= b.nr_sequencia
		and		a.nr_Sequencia	= nr_Sequencia_p;
		ds_Retorno_w	 :=	to_char(cd_procedimento_w);
	elsif (ie_opcao_p = 'OP') then
		select max(b.ie_origem_proced)
		into STRICT	ie_origem_proced_w
		from	agenda_paciente b,
				autorizacao_convenio a
		where	a.nr_Seq_agenda	= b.nr_Sequencia
		and		a.nr_Sequencia	= nr_Sequencia_p;
		ds_retorno_w			:= to_char(ie_origem_proced_w);
	elsif (ie_opcao_p = 'HR') then
	select	max(b.hr_inicio)
	into STRICT	hr_inicio_w
	from	agenda_paciente b,
			autorizacao_convenio a
	where	a.nr_Seq_agenda	= b.nr_Sequencia
	and		a.nr_Sequencia	= nr_Sequencia_p;
	ds_retorno_w				:= hr_inicio_w;
elsif (ie_opcao_p = 'C') then
	select	max(cd_convenio)
	into STRICT	cd_convenio_w
	from	autorizacao_convenio
	where	nr_sequencia	= nr_sequencia_p;
	ds_retorno_w			:= to_char(cd_convenio_w);
elsif (ie_opcao_p = 'TA') then

	select	nr_atendimento,
		nr_seq_agenda,
		nr_seq_gestao,
		nr_seq_age_integ,
		nr_seq_paciente_setor,
		nr_seq_agenda_consulta
	into STRICT	nr_atendimento_w,
		nr_seq_agenda_w,
		nr_seq_gestao_w,
		nr_seq_age_integ_w,
		nr_seq_paciente_setor_w,
		nr_seq_agenda_consulta_w
	from	autorizacao_convenio
	where	nr_sequencia	= nr_sequencia_p;
	
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	
		select	max(ie_tipo_atendimento)
		into STRICT	ie_tipo_atendimento_w
		from 	atendimento_paciente
		where 	nr_atendimento = nr_atendimento_w;
		
	elsif (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') then
	
		select	max(ie_tipo_atendimento)
		into STRICT	ie_tipo_atendimento_w
		from 	agenda_paciente
		where 	nr_sequencia = nr_seq_agenda_w;
		
	elsif (nr_seq_age_integ_w IS NOT NULL AND nr_seq_age_integ_w::text <> '') then
	
		select	max(ie_tipo_atendimento)
		into STRICT	ie_tipo_atendimento_w
		from 	agenda_integrada
		where 	nr_sequencia = nr_seq_age_integ_w;
	elsif (nr_seq_agenda_consulta_w IS NOT NULL AND nr_seq_agenda_consulta_w::text <> '') then
	
		select	max(ie_tipo_atendimento)
		into STRICT	ie_tipo_atendimento_w
		from 	agenda_consulta
		where 	nr_sequencia = nr_seq_agenda_consulta_w;
		
	elsif (nr_seq_paciente_setor_w IS NOT NULL AND nr_seq_paciente_setor_w::text <> '') then
	
		select	max(ie_tipo_atendimento)
		into STRICT	ie_tipo_atendimento_w
		from 	paciente_setor_convenio
		where 	nr_seq_paciente = nr_seq_paciente_setor_w;
		
	end if;
ds_retorno_w := ie_tipo_atendimento_w;
elsif (ie_opcao_p = 'PA') then
	select	max(substr(obter_pessoa_atendimento(nr_atendimento,'N'),1,100))
	into STRICT	nm_pessoa_fisica_w
	from	autorizacao_convenio
	where	nr_sequencia	= nr_sequencia_p;
	ds_retorno_w			:= nm_pessoa_fisica_w;
elsif (ie_opcao_p = 'NT') then
	select	substr(a.nr_telefone,1,100)
	into STRICT	nr_telefone_agen_int_w
	from	agenda_integrada a,
		autorizacao_convenio b
	where	a.nr_sequencia = b.nr_seq_age_integ
	and	b.nr_sequencia = nr_sequencia_p;
	ds_retorno_w := nr_telefone_agen_int_w;
elsif (ie_opcao_p = 'ET') then
	select	coalesce(substr(obter_descricao_padrao('AUTORIZACAO_ETAPA', 'DS_ETAPA',nr_seq_etapa),1,100),'')
	into STRICT	ds_retorno_w
	from    autorizacao_conv_etapa
	where   nr_seq_autor_conv = nr_sequencia_p
	and     DT_ETAPA  = (	SELECT max(dt_etapa)
			from autorizacao_conv_etapa
			where nr_seq_autor_conv = nr_sequencia_p
			and dt_etapa           <= clock_timestamp());
end if;

return	ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_autor_convenio (nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

