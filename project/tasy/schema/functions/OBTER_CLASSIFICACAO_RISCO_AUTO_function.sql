-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE r_valor AS (ds_valor varchar(4000));


CREATE OR REPLACE FUNCTION obter_classificacao_risco_auto (nr_seq_template_p bigint ,nr_seq_reg_template_p bigint ,nm_usuario_p text ,ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


  c_regras_clas_risco CURSOR FOR
    SELECT templates.nr_seq_template
          ,templates.nr_seq_elemento
          ,templates.nr_seq_linked_data
          ,clas_risco.nr_seq_classificacao
          ,clas_risco.nr_seq_prioridade
          ,clas_risco.nr_seq_atributo
          ,(SELECT t.nm_atributo
              FROM tabela_atributo_linked t
             WHERE t.nr_sequencia = clas_risco.nr_seq_atributo) nm_atributo
          ,clas_risco.qt_valor_minimo
          ,clas_risco.qt_valor_maximo
          ,clas_risco.ds_valor_exato
      FROM (SELECT a.nr_seq_template
                  ,b.nr_sequencia    nr_seq_linked_data
                  ,a.nr_sequencia    nr_seq_elemento
              FROM ehr_template_conteudo a
                  ,linked_data           b
             WHERE a.nr_seq_linked_data = b.nr_sequencia
               AND a.nr_seq_template = nr_seq_template_p

UNION

            SELECT DISTINCT a.nr_seq_template
                           ,b.nr_sequencia
                           ,a.nr_sequencia nr_seq_elemento
              FROM ehr_template_conteudo a
                  ,linked_data           b
             WHERE a.nr_seq_linked_data = b.nr_sequencia
               AND a.nr_seq_template IN (SELECT a.nr_seq_template_cluster
                      FROM ehr_template_conteudo a
                     WHERE a.nr_seq_template = nr_seq_template_p)
            
UNION

            SELECT a.nr_seq_template
                  ,NULL              nr_seq_linked_data
                  ,a.nr_sequencia    nr_seq_elemento
              FROM ehr_template_conteudo a
             WHERE coalesce(a.nr_seq_linked_data::text, '') = ''
               AND coalesce(a.nr_seq_template_cluster::text, '') = ''
               AND a.nr_seq_template = nr_seq_template_p) templates
          ,(SELECT b.nr_seq_classificacao
                  ,d.nr_seq_prioridade
                  ,b.nr_seq_template
                  ,c.nr_seq_elemento
                  ,c.nr_seq_risco_auto
                  ,c.nr_seq_atributo
                  ,c.qt_valor_minimo
                  ,c.qt_valor_maximo
                  ,c.ds_valor_exato
              FROM ehr_template            a
                  ,triagem_clas_risco_auto b
                  ,triagem_clas_risco_item c
                  ,triagem_classif_risco   d
             WHERE a.nr_sequencia = b.nr_seq_template
               AND b.nr_sequencia = c.nr_seq_risco_auto
               AND b.nr_seq_classificacao = d.nr_sequencia
               AND coalesce(d.cd_estabelecimento,wheb_usuario_pck.get_cd_estabelecimento) = wheb_usuario_pck.get_cd_estabelecimento
               AND a.ie_classificacao_risco = 'S'
               AND b.ie_tipo = 'T'
               AND ie_opcao_p = 'T') clas_risco
     WHERE clas_risco.nr_seq_template = templates.nr_seq_template
       AND clas_risco.nr_seq_elemento = templates.nr_seq_elemento
     ORDER BY clas_risco.nr_seq_prioridade;
  TYPE t_valor IS TABLE OF r_valor INDEX BY integer;

  w_valores  t_valor;
  w_qt_valor bigint;
  w_ds_sql   varchar(4000);
BEGIN
  FOR r1 IN c_regras_clas_risco LOOP
    IF (r1.nr_seq_linked_data IS NOT NULL AND r1.nr_seq_linked_data::text <> '') THEN
      w_ds_sql := 'SELECT t.' || r1.nm_atributo || '
                     FROM ehr_linked_' || r1.nr_seq_template || '_' || r1.nr_seq_linked_data || ' t
                    WHERE t.nr_seq_reg_template = ' || nr_seq_reg_template_p || '
                      AND t.nm_usuario = ''' || nm_usuario_p || '''';
    ELSE
      w_ds_sql := 'SELECT nvl(t.ds_resultado, t.vl_resultado)
                     FROM ehr_reg_elemento t
                    WHERE t.nr_seq_temp_conteudo = ' || r1.nr_seq_elemento || '
                      AND t.nr_seq_reg_template = ' || nr_seq_reg_template_p || '
                      AND t.nm_usuario = ''' || nm_usuario_p || '''';
    END IF;

    EXECUTE w_ds_sql BULK COLLECT INTO STRICT w_valores;

    FOR i IN 1 .. w_valores.COUNT LOOP
      BEGIN
        w_qt_valor := (w_valores[i].ds_valor)::numeric;
      EXCEPTION
        WHEN data_exception THEN
          w_qt_valor := NULL;
      END;

      IF ((w_qt_valor IS NOT NULL AND w_qt_valor::text <> '') AND w_qt_valor BETWEEN r1.qt_valor_minimo AND r1.qt_valor_maximo)
      OR (w_valores[i].ds_valor = r1.ds_valor_exato) THEN
        RETURN r1.nr_seq_classificacao;
      END IF;
    END LOOP;
  END LOOP;

  RETURN NULL;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_classificacao_risco_auto (nr_seq_template_p bigint ,nr_seq_reg_template_p bigint ,nm_usuario_p text ,ie_opcao_p text) FROM PUBLIC;

