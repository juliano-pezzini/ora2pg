-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hd_obter_unidade_prc ( cd_pessoa_fisica_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

-- C - Codigo

-- D - Descricao
nr_seq_unidade_w		bigint := 0;
ds_retorno_w		varchar(200);
ie_considera_escala_dialise_w varchar(10);
nr_seq_unidade_ext_w		bigint := 0;
nr_seq_transf_w		bigint;
ie_propria_w		varchar(1);
nr_seq_unidade_int_w	hd_paciente_int_ext.nr_seq_unidade_int%type;

BEGIN

ie_considera_escala_dialise_w := Obter_param_Usuario(7009, 114, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_considera_escala_dialise_w);

/* Verifica a ultima transferencia do paciente */

select	max(nr_sequencia)
into STRICT	nr_seq_transf_w
from	hd_pac_obs_transf
where	cd_pessoa_fisica = cd_pessoa_fisica_p;

if (nr_seq_transf_w <> '') then

	/* Se houver, verificar se foi para uma unidade propria */

	select	coalesce(max(a.ie_propria),'S')
	into STRICT	ie_propria_w
	from	hd_unidade_dialise a,
		hd_pac_obs_transf b
	where	a.nr_sequencia = b.nr_seq_unid_destino
	and	b.nr_sequencia = nr_seq_transf_w;
	
else
	/* Senao ve se a unidade de cadstro do paciente e propria */

	select	coalesce(max(a.ie_propria),'S')
	into STRICT	ie_propria_w
	from	hd_unidade_dialise a,
		hd_pac_renal_cronico b
	where	b.nr_seq_unid_dialise = a.nr_sequencia
	and	b.cd_pessoa_fisica	= cd_pessoa_fisica_p;

end if;	

if (ie_propria_w = 'S') then

	select	coalesce(max(nr_seq_unid_dialise),0)
	into STRICT	nr_seq_unidade_w
	from	hd_escala_dialise
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	dt_inicio <= clock_timestamp()
	and	coalesce(dt_fim::text, '') = '';
	
	if (nr_seq_unidade_w = 0) then
		select	coalesce(max(nr_seq_unid_dialise),0)
		into STRICT	nr_seq_unidade_w
		from	paciente_tratamento
		where	cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	ie_tratamento in ('HD','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DPA','CPI','CO','CAPD','PL','DPAV','DDC','IHF','IHDF')
		and	coalesce(dt_final_tratamento::text, '') = '';
	end if;

	if (nr_seq_unidade_w = 0) then
		select	max(nr_seq_unid_dialise)
		into STRICT	nr_seq_unidade_w
		from	hd_pac_renal_cronico
		where	cd_pessoa_fisica	= cd_pessoa_fisica_p;
	end if;
else
	if (coalesce(ie_considera_escala_dialise_w,'N') = 'S') then

		select	coalesce(max(nr_seq_unid_dialise),0)
		into STRICT	nr_seq_unidade_w
		from	hd_escala_dialise
		where	cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	dt_inicio <= clock_timestamp()
		and	coalesce(dt_fim::text, '') = '';
	end if;
	
	if (nr_seq_unidade_w = 0) then
		select	coalesce(max(nr_seq_unid_dialise),0)
		into STRICT	nr_seq_unidade_w
		from	paciente_tratamento
		where	cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	ie_tratamento in ('HD','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DPA','CPI','CO','CAPD','PL','DPAV','DDC','IHF','IHDF')
		and	coalesce(dt_final_tratamento::text, '') = '';
	end if;

end if;

SELECT 	max(nr_seq_unidade_int)
into STRICT	nr_seq_unidade_int_w
FROM 	HD_PACIENTE_INT_EXT a
WHERE 	a.cd_pessoa_fisica = cd_pessoa_fisica_p
AND	   	coalesce(a.dt_retorno::text, '') = ''
AND	   	EXISTS (SELECT	1
				FROM	HD_ESCALA_DIALISE b
				WHERE  	a.cd_pessoa_fisica = b.cd_pessoa_fisica
				AND	   	coalesce(b.dt_fim::text, '') = '');
				
if (nr_seq_unidade_int_w IS NOT NULL AND nr_seq_unidade_int_w::text <> '') then
	nr_seq_unidade_w := nr_seq_unidade_int_w;
end if;				
	
if (ie_opcao_p = 'C') then
	ds_retorno_w	:= nr_seq_unidade_w;
elsif (ie_opcao_p = 'D') then
	begin
	
	select	ds_unidade
	into STRICT	ds_retorno_w
	from	hd_unidade_dialise
	where	nr_sequencia		= nr_seq_unidade_w;

	end;
else
	ds_retorno_w	:= '';
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hd_obter_unidade_prc ( cd_pessoa_fisica_p text, ie_opcao_p text) FROM PUBLIC;

