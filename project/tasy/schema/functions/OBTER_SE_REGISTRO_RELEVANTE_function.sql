-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_registro_relevante ( cd_pessoa_fisica_p text, nm_usuario_p text, cd_chave_p text, const_laboratorio_p text default 'A', nr_seq_result_p bigint default 0, nr_seq_result_item_p bigint default 0, nr_atendimento_p bigint default null) RETURNS varchar AS $body$
DECLARE


ie_retorno_w	varchar(1);
const_marcado_relevante_w	constant varchar(1) := 'M';
const_adicionado_carta_w	constant varchar(1) := 'S';
const_sem_vinc_carta_w		constant varchar(1) := 'N';
nr_seq_carta_w				carta_conteudo.nr_seq_carta%type := obter_carta_edicao(cd_pessoa_fisica_p, obter_pf_usuario(nm_usuario_p, 'C'), nm_usuario_p, nr_atendimento_p);


BEGIN
	if (const_laboratorio_p = 'MP') then
		select	coalesce(max('S'),'N')
		into STRICT	ie_retorno_w
		from	carta_conteudo a
		where	a.nr_seq_medic_uso in (	SELECT 	b.nr_sequencia
										from 	paciente_medic_uso b
										where	b.nr_seq_versao = cd_chave_p)
		and		a.nr_seq_carta = nr_seq_carta_w;

		if (ie_retorno_w = 'N') then
			select	coalesce(max('M'),'N')
			into STRICT	ie_retorno_w
			from	carta_conteudo_relevante a
			where	a.nr_seq_medic_uso in (	SELECT 	b.nr_sequencia
											from 	paciente_medic_uso b
											where	b.nr_seq_versao = cd_chave_p)
			and		a.nr_atendimento = nr_atendimento_p;
		end if;

	elsif (const_laboratorio_p = 'MEK') then
		select	coalesce(max('S'),'N')
		into STRICT	ie_retorno_w
		from	carta_conteudo a
		where	a.nr_seq_kv_item in (	SELECT	b.nr_sequencia
										from	kv_receita_farmacia_item b
										where	b.nr_seq_receita = cd_chave_p)
		and		a.nr_seq_carta = nr_seq_carta_w;

		if (ie_retorno_w = 'N') then
			select	coalesce(max('M'),'N')
			into STRICT	ie_retorno_w
			from	carta_conteudo_relevante a
			where	a.nr_seq_kv_item in (	SELECT	b.nr_sequencia
											from	kv_receita_farmacia_item b
											where	b.nr_seq_receita = cd_chave_p)
			and		a.nr_atendimento = nr_atendimento_p;
		end if;

	elsif (const_laboratorio_p = 'MD') then
		select	coalesce(max('S'),'N')
		into STRICT	ie_retorno_w
		from	carta_conteudo a
		where	a.ie_tipo_item = 'MD'
		and		a.nr_seq_mat_cpoe in (	SELECT 	b.nr_sequencia
										from 	cpoe_material b
										where	b.nr_sequencia = cd_chave_p)
		and		a.nr_seq_carta = nr_seq_carta_w;

		if (ie_retorno_w = 'N') then
			select	coalesce(max('M'),'N')
			into STRICT	ie_retorno_w
			from	carta_conteudo_relevante a
			where  	a.ie_tipo_item = 'MD'
			and		a.nr_seq_mat_cpoe in (	SELECT 	b.nr_sequencia
											from 	cpoe_material b
											where	b.nr_sequencia = cd_chave_p)
			and		a.nr_atendimento = nr_atendimento_p;
		end if;

	else
		select	coalesce(max('S'),'N')
		into STRICT	ie_retorno_w
		from	carta_conteudo a
		where	((coalesce(a.nr_seq_cirurgia,a.nr_seq_alergia,a.nr_seq_diag_doenca,a.cd_evolucao,a.nr_seq_medic_uso,a.nr_seq_comorbidade,
				a.nr_seq_procedimento,a.nr_prescricao,a.nr_seq_prescricao,a.nr_seq_proc_pac,a.nr_seq_laudo) = cd_chave_p
		and     const_laboratorio_p <> 'EL') or (const_laboratorio_p = 'EL' and a.nr_prescricao = nr_seq_result_p and a.nr_seq_prescricao = nr_seq_result_item_p))
		and		a.nr_seq_carta = nr_seq_carta_w;

		if (ie_retorno_w = 'N') then
			select	coalesce(max('M'),'N')
			into STRICT	ie_retorno_w
			from	carta_conteudo_relevante a
			where	((coalesce(a.nr_seq_cirurgia,a.nr_seq_alergia,a.nr_seq_diag_doenca,a.cd_evolucao,a.nr_seq_medic_uso,a.nr_seq_comorbidade,
					a.nr_seq_procedimento,a.nr_prescricao,a.nr_seq_prescricao,a.nr_seq_proc_pac,a.nr_seq_laudo) = cd_chave_p
			and     const_laboratorio_p <> 'EL') or (const_laboratorio_p = 'EL' and a.nr_prescricao = nr_seq_result_p and a.nr_seq_prescricao = nr_seq_result_item_p))
			and		a.nr_atendimento = nr_atendimento_p;
		end if;
	end if;

	return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_registro_relevante ( cd_pessoa_fisica_p text, nm_usuario_p text, cd_chave_p text, const_laboratorio_p text default 'A', nr_seq_result_p bigint default 0, nr_seq_result_item_p bigint default 0, nr_atendimento_p bigint default null) FROM PUBLIC;

