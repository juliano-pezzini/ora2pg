-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_volta_os (nr_seq_ordem_p bigint) RETURNS bigint AS $body$
DECLARE


qt_volta_w			bigint;
ie_cliente_sup_teste_w		varchar(255);
ie_entrou_desen_w			varchar(255);
nr_seq_estagio_w			bigint;

c01 CURSOR FOR
SELECT	nr_seq_estagio
from	MAN_ORDEM_SERV_ESTAGIO a
Where	nr_seq_ordem = nr_seq_ordem_p
Order	by DT_ATUALIZACAO;


BEGIN

qt_volta_w	:= 0;

	if (phi_is_base_philips = 'S') then
		begin
			qt_volta_w := phi_obter_qt_volta_os(nr_seq_ordem_p);
		end;
	else
		begin
			ie_cliente_sup_teste_w	:= 'N';
			ie_entrou_desen_w		:= 'N';
			
			open c01;
			loop
			fetch c01 into
				nr_seq_estagio_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
			
				if (ie_entrou_desen_w = 'S') and (ie_cliente_sup_teste_w = 'S') and (nr_seq_estagio_w in (4, 1191, 871, 731, 732, 891, 1141, 261)) then
					ie_cliente_sup_teste_w	:= 'N';
					qt_volta_w		:= qt_volta_w + 1;
				end if;
			
				if (nr_seq_estagio_w in (2, 31, 1511)) then
					ie_cliente_sup_teste_w	:= 'S';
				end if;
			
				if (nr_seq_estagio_w in (4, 1191, 871, 731, 732, 891, 1141, 261, 1051)) then
					ie_entrou_desen_w		:= 'S';
				end if;
			
			end loop;
			close c01;
		end;
	end if;

return	qt_volta_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_volta_os (nr_seq_ordem_p bigint) FROM PUBLIC;

