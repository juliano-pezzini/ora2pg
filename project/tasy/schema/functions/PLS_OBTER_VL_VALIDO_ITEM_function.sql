-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_vl_valido_item ( ie_proc_mat_p text, nr_seq_proc_ref_p pls_conta_proc.nr_seq_proc_ref%type, vl_apresentado_p bigint, vl_calculado_p bigint, vl_liberado_p bigint, qt_apresentada_p bigint, qt_liberada_p bigint, ie_status_item_p text, ie_qtd_valor_p text) RETURNS bigint AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Obter o valor/qtde válido(a) para o status atual do item. Nos parâmetro não foi utilizado o %type pois este tratamento
	é aplicado tanto a campos de quantidade, valor e taxas, e por estes conter tamanho e precisão diferentes é preferível
	informar um tipo genérico e deixar que o Oracle cuide da precisão e tamanho..
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

ie_proc_mat_p :

P - Procedimento
M - Material

ie_qtd_valor_p :

VL - Valor
QT - Quantidade.

ie_status_item_p = Dominio 1870:

VL_DOM	DS_VALOR_DOMINIO		           NM_APLICACAO_MODULO
------------  ---------------------------------------------------  -----------------------------------------------------
A               Em Análise                                                   TasyPLS - OPS - Produtos
C               Consistido                                                   TasyPLS - OPS - Produtos
D               Cancelado                                                    TasyPLS - OPS - Produtos
L               Liberado pelo usuário                                        TasyPLS - OPS - Produtos
M               Faturamento manual                                           TasyPLS - OPS - Produtos
P               Pendente de Liberação                                        TasyPLS - OPS - Produtos
S               Liberado pelo Sistema                                        TasyPLS - OPS - Produtos
U               Usuário (aguardando ação)                                    TasyPLS - OPS - Produtos


Alterações:
-------------------------------------------------------------------------------------------------------------------
jjung 28/08/2013 - OS 636854 - Criação da function.
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
function tratar_retorno(	vl_a_retornar_p	bigint)
				return bigint is
;
BEGIN

-- Sempre que o valor que será retornardo for nulo ou menor que zero devemos retornar apenas 0, pois o valor não é válido. Caso contrário retorna o valor, pois ele é válido.
if ((vl_a_retornar_p IS NOT NULL AND vl_a_retornar_p::text <> '') and vl_a_retornar_p > 0) then

	return vl_a_retornar_p;
else
	return 0;
end if;

end;

begin

-- Verifica se é para tratar da quantidade ou dos valores.
-- Quantidade.
if (ie_qtd_valor_p = 'QT') then

	-- Se for procedimento, para as quantidades deve sempre verificar o procedimento principal (NR_SEQ_PROC_REF). O item só terá uma quantidade válida se
	-- não tiver procedimento principal informado ou se o procedimento principal estiver cancelado.
	-- Procedimento.
	if (ie_proc_mat_p = 'P') then

		-- O tratamento referente ao procedimento principal é feito na function OBTER_SE_CONSIDERA_PROC_REF, se ela retornar S então o procedimento deve ser
		-- considerado para retornar a quantidade, caso contrário, se retorna N então  o procedimento não deve ser considerado para a contagem de quantidade então
		-- retorna 0.
		if ( pls_obter_se_consid_proc_ref( nr_seq_proc_ref_p) = 'N') then

			return 0;
		end if;
	end if;

	-- Se o item estiver Em Análise, Pendente ou Consistido então sempre deve ser considerada a quantidade apresentada.
	-- Caso a quantidade apresentada seja nula ou menor que zero será retornado 0, isto é tratado na function aclopada TRATAR_RETORNO.
	if (ie_status_item_p in ('A', 'P', 'C')) then

		return tratar_retorno(qt_apresentada_p);

	-- Se o item estiver Liberado pelo Sistema, Liberado pelo Usuário então sempre deve ser considerada a quantidade liberada.
	-- Caso a quantidade liberada seja nula ou menor que zero será retornado 0, isto é tratado na function aclopada TRATAR_RETORNO.
	elsif (ie_status_item_p in ('S', 'L')) then

		return tratar_retorno(qt_liberada_p);

	-- Se for um item de faturamento manual o mesmo não deve ser considerado para nada. É como se não existisse ou fosse um item cancelado, o mesmo só deve ser considerado para o
	-- faturamento para cobranças do beneficiário. Este status significa que o item foi inserido no faturamente de forma manual, não está sendo cobrado por prestador e não faz parte do
	-- atendimento.
	elsif (ie_status_item_p = 'M') then

		return 0;

	-- Se o item estiver Cancelado, Aguardando Ação ou não for nada disso, retorna 0, pois o item não tem um status válido e não se sabe o que se deve fazer com ele.
	else
		return 0;
	end if;
-- Valores.
elsif (ie_qtd_valor_p = 'VL') then

	-- Se o item estiver Liberado pelo Sistema, Liberado pelo Usuário então sempre deve ser considerada o valor liberado.
	-- Caso o valor liberado seja nula ou menor que zero será retornado 0, isto é tratado na function aclopada TRATAR_RETORNO.
	if (ie_status_item_p in ('L', 'S')) then

		return	tratar_retorno(vl_liberado_p);

	-- Se o item estiver Em Análise, Pendente ou Consistido então sempre deve ser considerada o valor calculado.
	-- Caso o valor calculado seja nula ou menor que zero será retornado 0, isto é tratado na function aclopada TRATAR_RETORNO.
	elsif (ie_status_item_p in ('A', 'P', 'C')) then

		return 	tratar_retorno(vl_calculado_p);

	-- Se for um item de faturamento manual o mesmo não deve ser considerado para nada. É como se não existisse ou fosse um item cancelado, o mesmo só deve ser considerado para o
	-- faturamento para cobranças do beneficiário. Este status significa que o item foi inserido no faturamente de forma manual, não está sendo cobrado por prestador e não faz parte do
	-- atendimento.
	elsif (ie_status_item_p = 'M') then

		return 0;

	-- Se o item estiver Cancelado, Aguardando Ação ou não for nada disso, retorna 0, pois o item não tem um status válido e não se sabe o que se deve fazer com ele.
	else
		return 0;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_vl_valido_item ( ie_proc_mat_p text, nr_seq_proc_ref_p pls_conta_proc.nr_seq_proc_ref%type, vl_apresentado_p bigint, vl_calculado_p bigint, vl_liberado_p bigint, qt_apresentada_p bigint, qt_liberada_p bigint, ie_status_item_p text, ie_qtd_valor_p text) FROM PUBLIC;

