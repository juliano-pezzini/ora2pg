-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_aprova_repasse ( nr_seq_terceiro_p bigint, nr_repasse_terceiro_p bigint, dt_referencia_p timestamp, nm_usuario_p text, cd_perfil_p bigint) RETURNS varchar AS $body$
DECLARE


ie_aprova_repasse_w	varchar(1)	:= 'N';
qt_regra_w		bigint;
vl_repasse_w		bigint;
nr_seq_regra_w		bigint;
qt_permissao_w		bigint;
qt_usuario_w		bigint;
qt_perfil_w		bigint;

c01 CURSOR FOR
SELECT	a.nr_sequencia
from	regra_aprovacao_repasse a
where	vl_repasse_w	between coalesce(vl_minimo,vl_repasse_w) and coalesce(vl_maximo,vl_repasse_w)
and	coalesce(a.nr_seq_terceiro,coalesce(nr_seq_terceiro_p,0))	= coalesce(nr_seq_terceiro_p,0)
and	dt_referencia_p	between coalesce(dt_inicio_vigencia,dt_referencia_p) and coalesce(dt_fim_vigencia,dt_referencia_p)
order by	coalesce(a.nr_seq_terceiro,0);


BEGIN

select	count(*)
into STRICT	qt_regra_w
from	regra_aprovacao_repasse a
where	coalesce(a.nr_seq_terceiro,coalesce(nr_seq_terceiro_p,0))	= coalesce(nr_seq_terceiro_p,0)
and	dt_referencia_p	between coalesce(dt_inicio_vigencia,dt_referencia_p) and coalesce(dt_fim_vigencia,dt_referencia_p);

if (qt_regra_w	= 0) then

	ie_aprova_repasse_w	:= 'S';

else

	select	coalesce(obter_valor_repasse(nr_repasse_terceiro_p,'R'),0)
	into STRICT	vl_repasse_w
	;

	open	c01;
	loop
	fetch	c01 into
		nr_seq_regra_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	end	loop;
	close	c01;

	select	count(*)
	into STRICT	qt_permissao_w
	from	regra_aprovacao_repas_usu a
	where	a.nr_seq_regra		= nr_seq_regra_w;

	if (qt_permissao_w	= 0) then

		ie_aprova_repasse_w	:= 'S';

	else

		select	count(*)
		into STRICT	qt_usuario_w
		from	regra_aprovacao_repas_usu a
		where	a.nm_usuario_lib	= nm_usuario_p
		and	a.nr_seq_regra		= nr_seq_regra_w;

		if (qt_usuario_w	> 0) then

			ie_aprova_repasse_w	:= 'S';

		else

			select	count(*)
			into STRICT	qt_perfil_w
			from	regra_aprovacao_repas_usu a
			where	a.cd_perfil_lib		= cd_perfil_p
			and	a.nr_seq_regra		= nr_seq_regra_w;

			if (qt_perfil_w	> 0) then

				ie_aprova_repasse_w	:= 'S';

			end if;

		end if;

	end if;

end if;

RETURN ie_aprova_repasse_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_aprova_repasse ( nr_seq_terceiro_p bigint, nr_repasse_terceiro_p bigint, dt_referencia_p timestamp, nm_usuario_p text, cd_perfil_p bigint) FROM PUBLIC;

