-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_setor_nova_prescr ( nr_atendimento_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) RETURNS bigint AS $body$
DECLARE

				
cd_setor_atendimento_w	integer;
ie_pac_usu_w		varchar(5);
ie_setor_usu_pac_w	char(1);
ie_setor_mae_w		char(1) := 'N';
ie_rn_w			char(1) := 'N';
nr_atendimento_mae_w	bigint;
qt_setor_exibe_rn_w	integer;
cd_setor_rn_w			integer;
cd_setor_mae_w			integer;


BEGIN

ie_pac_usu_w := Obter_Param_Usuario(950, 6, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_pac_usu_w);

select 	coalesce(max(nr_atendimento_mae),0)
into STRICT	nr_atendimento_mae_w
from	atendimento_paciente
where 	nr_atendimento = nr_atendimento_p;

if (nr_atendimento_mae_w > 0) then

	select count(cd_setor_atendimento)
	into STRICT qt_setor_exibe_rn_w
	from setor_atendimento
	where ie_rn_mae = 'S'
	and cd_estabelecimento = cd_estabelecimento_p;

	if (qt_setor_exibe_rn_w > 0) then
	
		if (ie_pac_usu_w = 'A') or (ie_pac_usu_w = 'S') then
			cd_setor_atendimento_w := obter_unidade_atendimento(nr_atendimento_p,'A','CS');
		elsif (ie_pac_usu_w = 'D') then
		begin
		  select coalesce(ie_rn_mae,'N'), cd_setor_atendimento
		  into STRICT ie_setor_mae_w, cd_setor_mae_w
		  from setor_atendimento
		  where cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS');

		  select coalesce(a.cd_setor_atendimento,0)
		  into STRICT cd_setor_rn_w
		  from unidade_atendimento a
		  where a.nr_seq_interno = (SELECT coalesce(b.nr_seq_unidade_rn,0) from setor_atendimento b
      				                   where b.cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
		  if (ie_setor_mae_w = 'S') and (cd_setor_mae_w = cd_setor_rn_w) then
		    cd_setor_atendimento_w := cd_setor_mae_w;
		  else
		    cd_setor_atendimento_w := coalesce(obter_unidade_atendimento(nr_atendimento_p,'A','CS'), 0);
		  end if;
		end;
		else
			cd_setor_atendimento_w := coalesce(obter_unidade_atendimento(nr_atendimento_mae_w,'IA','CS'),obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS'));
		end if;
		
		select coalesce(ie_rn_mae,'N')
		into STRICT ie_setor_mae_w
		from setor_atendimento		
		where cd_setor_atendimento = cd_setor_atendimento_w;
		
	end if;
	
end if;

if (ie_setor_mae_w = 'N') then

	if (ie_pac_usu_w		= 'B') then
		cd_setor_atendimento_w	:= null;
	elsif (ie_pac_usu_w		= 'U') then
		ie_setor_usu_pac_w := Obter_Param_Usuario(924, 136, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_setor_usu_pac_w);

		if (coalesce(ie_setor_usu_pac_w,'N') <> 'S') then
			select	coalesce(max('S'),'N')
			into STRICT	ie_setor_usu_pac_w
			from	atend_paciente_unidade b
			where	b.nr_atendimento        = nr_atendimento_p
			and		b.cd_setor_atendimento  = wheb_usuario_pck.get_cd_setor_atendimento LIMIT 1;
		end if;

		if (ie_setor_usu_pac_w	= 'S') then
			cd_setor_atendimento_w	:= wheb_usuario_pck.get_cd_setor_atendimento;
		end if;	
		
	elsif (ie_pac_usu_w		= 'R') then
		cd_setor_atendimento_w	:= Obter_setor_prescr_regra(cd_perfil_p);
	elsif (ie_pac_usu_w		= 'A') and (nr_atendimento_p	> 0) then
		cd_setor_atendimento_w	:= obter_unidade_atendimento(nr_atendimento_p,'A','CS');
	elsif (nr_atendimento_p	> 0) then
		cd_setor_atendimento_w	:= coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'),obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
	end if;

end if;

return	cd_setor_atendimento_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_setor_nova_prescr ( nr_atendimento_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

