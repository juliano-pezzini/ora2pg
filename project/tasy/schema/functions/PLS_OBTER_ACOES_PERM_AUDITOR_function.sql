-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_acoes_perm_auditor ( nr_seq_analise_p bigint, ie_acao_p text, nr_seq_grupo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ie_retorno_w			varchar(50) := 'N';
nr_seq_grupo_fluxo_w		bigint;
ie_tipo_fluxo_w			varchar(1);
ie_valor_calculado_w		varchar(1);
ie_valor_apresentado_w		varchar(1);
ie_melhor_valor_w		varchar(1);
ie_modificar_item_w		varchar(1);
ie_substituir_item_w		varchar(1);
ie_inserir_item_w		varchar(1);
ie_valor_pagamento_w		varchar(1);
ie_valor_faturamento_w		varchar(1);
ie_modificar_conta_w		varchar(1);
ie_desfazer_analise_w		varchar(1);
ie_glosar_w			varchar(1);
ie_analisar_w			varchar(1);
ie_finalizar_analise_w		varchar(1);
ie_excluir_itens_w		varchar(1);
ie_encaminhar_grupo_w		varchar(1);
ie_excluir_anexo_w		varchar(1);
ie_permissao_w			varchar(1);
ie_excluir_obs_w		varchar(1);
ie_desfazer_solic_w		varchar(1);
ie_cancelar_item_w		varchar(1);
nr_seq_membro_grupo_aud_w	bigint;
ie_exc_item_reg_des_w		pls_membro_grupo_aud.ie_exc_item_reg_despesa%type;
/*Diego 28/04/2011
******************************************************************************************************
Esta procedure tem por função verificar se a ação passada por parâmetro(ie_acao_p) pode ser executada pelo usuário.

A lógica desta rotina é que: Como somente usuário que estão no momento do fluxo podem executar ações, é verificado
somente neste grupo as ações possiveis. Se ele não faz parte do grupo do fluxo o sistema não prmitira nenhuma ação.

>>Como um auditor master pode executar todas as ações este grupo não é verificado simplismente retornado 'S'.

ie_acao_p
VC	- Aceiar valor calculado
VA	- Aceiar valor Apresentado
MV	- Aceiar melhor valor
MI	- Modificar item
SI	- Substituir item
IP	- Inserir procedimento
RP	- Reconsitir
RF	- Recalcular faturamento
MC	- Modificar conta
DA	- Desfazer análise
GL	- Glosar
AN	- Análisar
FA	- Finalizar análise
EI	- Excluir itens
EG	- Encaminhar para outro grupo de análise
EA	- Excluir anexos
EO	- Excluir observações
DS	- Desfazer solicitação
CI	- Cancelar item
ER	- Excluir item regra despesa
*/
BEGIN

/*Verificação se o usuário é master*/

/*if	(pls_obter_se_usuario_master(nm_usuario_p,cd_estabelecimento_p) = 'S') then
	ie_retorno_w := 'S';*/
--comentado e substituido pelo codigo abaixo
select	max(ie_permissao)
into STRICT	ie_permissao_w
from 	pls_grupo_auditor
where	nr_sequencia	= coalesce(nr_seq_grupo_p,0);

select	max(nr_sequencia)
into STRICT	nr_seq_membro_grupo_aud_w
from	pls_membro_grupo_aud
where	upper(nm_usuario_exec)	= upper(nm_usuario_p)
and	nr_seq_grupo	  	= nr_seq_grupo_p
and	ie_situacao = 'A';

if (ie_permissao_w = 'T') then
	ie_retorno_w := 'S';
else
	/*Obtem as permissãoes*/

	begin
	select	coalesce(ie_valor_calculado,'S'),
		coalesce(ie_valor_apresentado,'S'),
		coalesce(ie_melhor_valor,'S'),
		coalesce(ie_modificar_item,'S'),
		coalesce(ie_substituir_item,'S'),
		coalesce(ie_inserir_item,'S'),
		coalesce(ie_valor_pagamento,'S'),
		coalesce(ie_valor_faturamento,'S'),
		coalesce(ie_modificar_conta,'S'),
		coalesce(ie_desfazer_analise,'S'),
		coalesce(ie_glosar,'S'),
		coalesce(ie_analisar,'S'),
		coalesce(ie_finalizar_analise,'S'),
		coalesce(ie_excluir_item,'S'),
		coalesce(ie_encaminhar_grupo,'S'),
		coalesce(ie_excluir_anexo,'S'),
		coalesce(ie_excluir_obs,'S'),
		coalesce(ie_desfazer_solicitacao_area,'S'),
		coalesce(ie_cancelar_item,'S')
	into STRICT	ie_valor_calculado_w,
		ie_valor_apresentado_w,
		ie_melhor_valor_w,
		ie_modificar_item_w,
		ie_substituir_item_w,
		ie_inserir_item_w,
		ie_valor_pagamento_w,
		ie_valor_faturamento_w,
		ie_modificar_conta_w,
		ie_desfazer_analise_w,
		ie_glosar_w,
		ie_analisar_w,
		ie_finalizar_analise_w,
		ie_excluir_itens_w,
		ie_encaminhar_grupo_w,
		ie_excluir_anexo_w,
		ie_excluir_obs_w,
		ie_desfazer_solic_w,
		ie_cancelar_item_w
	from	pls_membro_grupo_aud
	where	nr_sequencia	= nr_seq_membro_grupo_aud_w;
	exception
	when others then
		/*Se o usuário não existe neste grupo ele não é o grupo do momento no fluxo.*/

		ie_retorno_w	:= 'N';
	end;

	if (ie_valor_calculado_w	= 'S' and ie_acao_p = 'VC') or (ie_valor_apresentado_w	= 'S' and ie_acao_p = 'VA') or (ie_melhor_valor_w	= 'S' and ie_acao_p = 'MV') or (ie_modificar_item_w 	= 'S' and ie_acao_p = 'MI') or (ie_substituir_item_w 	= 'S' and ie_acao_p = 'SI') or (ie_inserir_item_w 	= 'S' and ie_acao_p = 'IP') or (ie_valor_pagamento_w 	= 'S' and ie_acao_p = 'RP') or (ie_valor_faturamento_w	= 'S' and ie_acao_p = 'RF') or (ie_desfazer_analise_w	= 'S' and ie_acao_p = 'DA') or (ie_glosar_w		= 'S' and ie_acao_p = 'GL') or (ie_analisar_w		= 'S' and ie_acao_p = 'AN') or (ie_finalizar_analise_w	= 'S' and ie_acao_p = 'FA') or (ie_modificar_conta_w	= 'S' and ie_acao_p = 'MC') or (ie_encaminhar_grupo_w	= 'S' and ie_acao_p = 'EG') or (ie_excluir_itens_w	= 'S' and ie_acao_p = 'EI') or (ie_excluir_anexo_w	= 'S' and ie_acao_p = 'EA') or (ie_excluir_obs_w	= 'S' and ie_acao_p = 'EO') or (ie_desfazer_solic_w	= 'S' and ie_acao_p = 'DS') or (ie_cancelar_item_w	= 'S' and ie_acao_p = 'CI') then
		ie_retorno_w := 'S';
	end if;
end if;

--Tratamento separado para a opção "ER - Excluir item regra despesa", pois quando o grupo possui acesso total a function sempre retornava "S", indiferente do valor do campo.
if (ie_acao_p = 'ER') then
	begin
	select	coalesce(ie_exc_item_reg_despesa,'N')
	into STRICT	ie_exc_item_reg_des_w
	from	pls_membro_grupo_aud
	where	nr_sequencia	= nr_seq_membro_grupo_aud_w;
	exception
	when others then
		ie_exc_item_reg_des_w	:= 'N';
	end;

	ie_retorno_w := ie_exc_item_reg_des_w;
end if;

return ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_acoes_perm_auditor ( nr_seq_analise_p bigint, ie_acao_p text, nr_seq_grupo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

