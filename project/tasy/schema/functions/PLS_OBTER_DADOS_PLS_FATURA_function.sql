-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_pls_fatura (nr_seq_fatura_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(255);

/* ie_opcao_p 
PF  - Número fatura 
PN - Número NDC 
VT - Valor total fatura 
VTN - Valor total NDC 
NF - Nota fiscal 
SNF - Sequência nota fiscal 
NFN - Nota fiscal NDC 
SNFN - Sequência nota fiscal NDC 
DVF - Data de vencimento do título fatura 
DVN - Data de vencimento do título NDR 
LF - Lote faturamento 
SP - Sequencia pagador 
NP - Nome pagador 
NT - Numero titulo 
NTC - Numero titulo NDC 
DL - Link 
DLC - Link NDC 
*/
 
 

BEGIN 
if (ie_opcao_p = 'PF') then 
	select	coalesce(max(b.nr_fatura),to_char(max(a.nr_titulo))) 
	into STRICT	ds_retorno_w 
	FROM pls_fatura a
LEFT OUTER JOIN ptu_fatura b ON (a.nr_sequencia = b.nr_seq_pls_fatura)
WHERE a.nr_sequencia	= nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'NT') then 
	select	max(a.nr_titulo) 
	into STRICT	ds_retorno_w 
	from	pls_fatura	a 
	where	a.nr_sequencia	= nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'DL') then 
	select	max(ds_link_rps) 
	into STRICT	ds_retorno_w 
	from	nota_fiscal 
	where	nr_seq_fatura = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'VT') then 
	select	max(a.vl_fatura) 
	into STRICT	ds_retorno_w 
	from	pls_fatura	a 
	where	a.nr_sequencia = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'NF') then 
	select	max(nr_nota_fiscal) 
	into STRICT	ds_retorno_w 
	from	nota_fiscal 
	where	nr_seq_fatura = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'SNF') then 
	select	max(nr_sequencia) 
	into STRICT	ds_retorno_w 
	from	nota_fiscal 
	where	nr_seq_fatura = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'NFE') then 
	select	max(nr_nfe_imp) 
	into STRICT	ds_retorno_w 
	from	nota_fiscal 
	where	nr_seq_fatura = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'NFN') then 
	select	max(nr_nota_fiscal) 
	into STRICT	ds_retorno_w 
	from	nota_fiscal 
	where	nr_seq_fatura_ndc = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'SNFN') then 
	select	max(nr_sequencia) 
	into STRICT	ds_retorno_w 
	from	nota_fiscal 
	where	nr_seq_fatura_ndc = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'NFNE') then 
	select	max(nr_nfe_imp) 
	into STRICT	ds_retorno_w 
	from	nota_fiscal 
	where	nr_seq_fatura_ndc = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'VTN') then 
	select	max(a.vl_total_ndc) 
	into STRICT	ds_retorno_w 
	from	pls_fatura	a 
	where	a.nr_sequencia = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'PN') then	 
	select	coalesce(max(b.nr_nota_credito_debito),to_char(max(a.nr_titulo_ndc))) 
	into STRICT	ds_retorno_w 
	FROM pls_fatura a
LEFT OUTER JOIN ptu_fatura b ON (a.nr_sequencia = b.nr_seq_pls_fatura)
WHERE a.nr_sequencia = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'NTC') then 
	select	max(a.nr_titulo_ndc) 
	into STRICT	ds_retorno_w 
	from	pls_fatura	a 
	where	a.nr_sequencia	= nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'DLC') then 
	select	max(ds_link_rps) 
	into STRICT	ds_retorno_w 
	from	nota_fiscal 
	where	nr_seq_fatura_ndc = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'VTT') then 
	select	coalesce(a.vl_fatura,0) + coalesce(a.vl_total_ndc,0) 
	into STRICT	ds_retorno_w 
	from	pls_fatura	a 
	where	a.nr_sequencia = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'DVF') then 
	select	max(a.dt_pagamento_previsto) 
	into STRICT	ds_retorno_w 
	from	pls_fatura b, 
		titulo_receber a 
	where	a.nr_titulo	= b.nr_titulo 
	and	b.nr_sequencia	= nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'DVN') then 
	select	max(a.dt_pagamento_previsto) 
	into STRICT	ds_retorno_w 
	from	pls_fatura b, 
		titulo_receber a 
	where	a.nr_titulo	= b.nr_titulo_ndc 
	and	b.nr_sequencia	= nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'DEF') then 
	select	max(a.dt_emissao) 
	into STRICT	ds_retorno_w 
	from	pls_fatura b, 
		titulo_receber a 
	where	a.nr_titulo	= b.nr_titulo 
	and	b.nr_sequencia	= nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'DEN') then 
	select	max(a.dt_emissao) 
	into STRICT	ds_retorno_w 
	from	pls_fatura b, 
		titulo_receber a 
	where	a.nr_titulo	= b.nr_titulo_ndc 
	and	b.nr_sequencia	= nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'LF') then 
	select	max(a.nr_seq_lote) 
	into STRICT	ds_retorno_w 
	from	pls_fatura	a 
	where	a.nr_sequencia = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'SP') then 
	select	max(a.nr_seq_pagador) 
	into STRICT	ds_retorno_w 
	from	pls_fatura	a 
	where	a.nr_sequencia = nr_seq_fatura_p;
	 
elsif (ie_opcao_p = 'NP') then 
	select	substr(pls_obter_dados_pagador(nr_seq_pagador,'NF'),1,255) 
	into STRICT	ds_retorno_w 
	from	pls_fatura	a 
	where	a.nr_sequencia = nr_seq_fatura_p;
 
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_pls_fatura (nr_seq_fatura_p bigint, ie_opcao_p text) FROM PUBLIC;

