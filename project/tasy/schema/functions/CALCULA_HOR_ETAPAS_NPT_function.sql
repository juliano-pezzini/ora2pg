-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION calcula_hor_etapas_npt (nr_prescricao_p bigint, ie_gerar_npt_fases_p text) RETURNS varchar AS $body$
DECLARE


i                         bigint := 1;
ds_retorno_w              varchar(200) := '';
qt_fase_npt_w             bigint;
dt_prim_horario_w		  timestamp;
hr_prim_horario_w         timestamp;
qt_hora_w                 timestamp;
Mascara_w                 varchar(10);
nr_horas_intervalo_w      bigint;
qt_tempo_etapa_w          nut_pac.qt_tempo_etapa%type;
qt_hora_inf_w             nut_pac.qt_hora_inf%type;
ie_acm_w				  varchar(1);


BEGIN

select dt_primeiro_horario
into STRICT   dt_prim_horario_w
from   prescr_medica
where  nr_prescricao = nr_prescricao_p;


select	qt_fase_npt,
	coalesce(qt_tempo_etapa,0),
	qt_hora_inf,
	CASE WHEN coalesce(hr_prim_horario::text, '') = '' THEN  dt_prim_horario_w  ELSE pkg_date_utils.get_time(clock_timestamp(), hr_prim_horario, 0) END ,
	ie_acm
into STRICT  	qt_fase_npt_w,
	qt_tempo_etapa_w,
	qt_hora_inf_w,
	hr_prim_horario_w,
	ie_acm_w
from    nut_pac
where   nr_sequencia    = (SELECT  min(nr_sequencia)
                              from    nut_pac
                              where   nr_prescricao   = nr_prescricao_p);

if (qt_tempo_etapa_w > 0) then
	nr_horas_intervalo_w := qt_tempo_etapa_w;
else
	nr_horas_intervalo_w    := dividir(qt_hora_inf_w,qt_fase_npt_w);
end if;

if (pkg_date_utils.extract_field('MINUTE', hr_prim_horario_w, 0) <> 0) then
	Mascara_w	:= 'hh24:mi';
else
	Mascara_w	:= 'hh24';
end if;

qt_hora_w := hr_prim_horario_w;

if (coalesce(ie_gerar_npt_fases_p,'N') = 'S') and (ie_acm_w <> 'S') then
	for i in 1.. qt_fase_npt_w loop
		begin
		ds_retorno_w 	:= 	ds_retorno_w || ' ' || wheb_mensagem_pck.get_texto(307054, 'NR_PRIM_HOR=' ||  to_char(trunc(qt_hora_w,'mi'), Mascara_w)) || ' ' || -- das #@NR_PRIM_HOR#@ Ã s
					to_char(trunc(qt_hora_w,'mi') + (nr_horas_intervalo_w / 24), Mascara_w) || ';';
		qt_hora_w       :=  trunc(qt_hora_w,'mi') + nr_horas_intervalo_w/24;
		end;
	end loop;
else
	ds_retorno_w := to_char(trunc(qt_hora_w,'mi'), Mascara_w);
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION calcula_hor_etapas_npt (nr_prescricao_p bigint, ie_gerar_npt_fases_p text) FROM PUBLIC;

