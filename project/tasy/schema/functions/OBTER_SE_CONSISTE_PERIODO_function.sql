-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_consiste_periodo (ie_tipo_item_p text, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_perfil_p bigint, cd_setor_atendimento_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*
ie_opcao_p
- C - Consiste (S,N)
- M - Mensagem da regra
*/
hr_inicio_w		varchar(5);
hr_fim_w		varchar(5);
ie_consiste_periodo_w 	varchar(1) := 'N';
dt_horario_w		timestamp;
dt_inicio_w		timestamp;
dt_fim_w		timestamp;
ds_mensagem_w		varchar(2000);

C01 CURSOR FOR
SELECT	hr_inicio,
	hr_fim,
	ds_mensagem
from	regra_periodo_sem_hor
where	ie_tipo_item			=	ie_tipo_item_p
and	coalesce(cd_perfil,cd_perfil_p)	=	cd_perfil_p
and	coalesce(cd_setor_atendimento,cd_setor_atendimento_p)	= cd_setor_atendimento_p;

C02 CURSOR FOR
SELECT	dt_horario
from	prescr_mat_hor
where	nr_prescricao	  = nr_prescricao_p
and	nr_seq_material   = nr_sequencia_p
and	coalesce(ie_horario_especial,'N') 	= 'N'
and	coalesce(ie_situacao,'A')	=	'A'
and	coalesce(dt_suspensao::text, '') = '';


BEGIN
open C01;
loop
fetch C01 into
	hr_inicio_w,
	hr_fim_w,
	ds_mensagem_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	open C02;
	loop
	fetch C02 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		dt_inicio_w	:= to_date(to_char(dt_horario_w,'dd/mm/yyyy ') || substr(hr_inicio_w,1,5) || ':00','dd/mm/yyyy hh24:mi:ss');
		dt_fim_w	:= to_date(to_char(dt_horario_w,'dd/mm/yyyy ') || substr(hr_fim_w,1,5)    || ':00','dd/mm/yyyy hh24:mi:ss');

		if (dt_horario_w between dt_inicio_w and dt_fim_w) then
			ie_consiste_periodo_w	 := 'S';
			exit;
		end if;

		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

if (ie_opcao_p	= 'C') then
	return	ie_consiste_periodo_w;
elsif (ie_consiste_periodo_w	= 'S') then
	return	ds_mensagem_w;
else
	return	'';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_consiste_periodo (ie_tipo_item_p text, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_perfil_p bigint, cd_setor_atendimento_p bigint, ie_opcao_p text) FROM PUBLIC;

