-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_regulacao ( nr_seq_origem_p bigint, ie_tipo_p text, ie_info_p text default null) RETURNS varchar AS $body$
DECLARE

/*
Descrição				ie_tipo_p
Encaminhamento				'E'
Pendências (SUEP)			'PD'
Nota clínica				'NC'
Solicitação de vaga			'SV'
Parecer medico				'PM'
Receita Farmácia			'RF'
Solicitação de home care	'SH'
Equipamento					'EQ'

Status
AE  Aguardando encaminhamento
EN	Encaminhado
CA	Cancelado
AN	Em análise
RP	Resposta do parecer
PS	Pendente do solicitante
AT	Autorizado
LE	Em lista de espera
AG	Agendado
NG	Negado
*/
ie_status_w		varchar(10) := '';
nr_seq_w		bigint;

BEGIN
if (nr_seq_origem_p IS NOT NULL AND nr_seq_origem_p::text <> '') then

	if ( ie_tipo_p = 'E') then
	
		Select  coalesce(max(a.ie_status),'')
		into STRICT	ie_status_w
		from	regulacao_atend a,
				atend_encaminhamento b
		where	a.nr_seq_encaminhamento = b.nr_sequencia
		and		b.nr_sequencia = nr_seq_origem_p;
		
	elsif ( ie_tipo_p = 'PD') then
	
		Select  coalesce(max(a.ie_status),'')
		into STRICT	ie_status_w
		from	regulacao_atend a
		where	a.nr_sequencia = nr_seq_origem_p;

	elsif ( ie_tipo_p = 'NC') then
	
		Select  coalesce(max(a.ie_status),'')
		into STRICT	ie_status_w
		from	regulacao_atend a,
				evolucao_paciente b
		where	a.cd_evolucao_ori = b.cd_evolucao
		and		b.cd_evolucao = nr_seq_origem_p;

    elsif ( ie_tipo_p = 'SE') then
	
		Select  max(a.nr_sequencia)
		into STRICT 	nr_seq_w
		from	regulacao_atend a,
				pedido_exame_externo b
		where	a.NR_SEQ_PEDIDO = b.nr_sequencia
		and		b.nr_sequencia = nr_seq_origem_p;
	
	
		Select  coalesce(max(a.ie_status),'')
		into STRICT	ie_status_w
		from	regulacao_atend a
		where	a.nr_sequencia = nr_seq_w;
			
    elsif ( ie_tipo_p = 'SV') then

		Select  coalesce(max(a.ie_status),'')
		into STRICT	ie_status_w
		from	regulacao_atend a
			join gestao_vaga gv ON (gv.nr_sequencia = a.nr_seq_gestao_vaga)
		where	a.nr_seq_gestao_vaga = nr_seq_origem_p
			and gv.ie_status not in ('D', 'C')
			and a.ie_status not in ('CA', 'AG', 'NG');
			
		if (coalesce(ie_status_w::text, '') = '') then
			Select  coalesce(max(a.ie_status),'')
			into STRICT	ie_status_w
			from	regulacao_atend a
				join gestao_vaga gv ON (gv.nr_sequencia = a.nr_seq_gestao_vaga)
			where	a.nr_seq_gestao_vaga = nr_seq_origem_p
				and gv.ie_status in ('D', 'C')
				and a.ie_status in ('CA', 'AG', 'NG');
		end if;
			
	elsif ( ie_tipo_p = 'PM') then
		
		Select  coalesce(max(a.ie_status),'')
		into STRICT 	ie_status_w
		from	regulacao_atend a,
				parecer_medico_req b
		where	a.nr_seq_parecer_ori = b.nr_parecer
		and		b.nr_parecer = nr_seq_origem_p;
	
	elsif ( ie_tipo_p = 'RF') then
	
		Select  coalesce(max(a.ie_status),'')
		into STRICT 	ie_status_w
		from	regulacao_atend a,
				fa_receita_farmacia b
		where	a.nr_seq_receita_amb = b.nr_sequencia
		and		b.nr_sequencia = nr_seq_origem_p;
		
	elsif ( ie_tipo_p = 'SH') then
	
		Select  coalesce(max(a.ie_status),'')
		into STRICT 	ie_status_w
		from	regulacao_atend a,
				paciente_home_care b
		where	a.nr_seq_home_care = b.nr_sequencia
		and		b.nr_sequencia = nr_seq_origem_p;

	elsif ( ie_tipo_p = 'EQ') then
	
		if (ie_info_p = 'HC') then
			Select  coalesce(max(a.ie_status),'')
			into STRICT 	ie_status_w
			from	regulacao_atend a
			where	a.nr_seq_equip_home = nr_seq_origem_p;
		else
			Select  coalesce(max(a.ie_status),'')
			into STRICT 	ie_status_w
			from	regulacao_atend a
			where	a.nr_seq_requisicao_item = nr_seq_origem_p;
		end if;
	
	end if;	
		
end if;

return ie_status_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_regulacao ( nr_seq_origem_p bigint, ie_tipo_p text, ie_info_p text default null) FROM PUBLIC;

