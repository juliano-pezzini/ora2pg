-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_time_atend ( NR_ATENDIMENTO_P bigint, IE_TIPO_INFO_P text DEFAULT 'C') RETURNS varchar AS $body$
DECLARE


    DS_RESULTADO_W	varchar(255) := '';
    NR_SEQ_TIME_W	NURSING_TEAM.NR_SEQUENCIA%TYPE;
    DS_TEAM_W		NURSING_TEAM.DS_TEAM%TYPE;


BEGIN

IF (NR_ATENDIMENTO_P IS NOT NULL AND NR_ATENDIMENTO_P::text <> '') THEN
	SELECT 	X.CD,
			X.DS
	INTO STRICT    NR_SEQ_TIME_W,
			DS_TEAM_W
	FROM  (SELECT 	NR_SEQ_TEAM CD,  NT.DS_TEAM DS
			FROM 	NURSING_TEAM_PROF NTP, NURSING_TEAM NT
			WHERE 	NTP.NR_SEQ_TEAM = NT.NR_SEQUENCIA
			AND 	EXISTS (SELECT 1
							FROM ATEND_ENFERMAGEM_AUX AEA
							WHERE AEA.NR_ATENDIMENTO = NR_ATENDIMENTO_P
							AND AEA.CD_PESSOA_FISICA = NTP.CD_PESSOA_FISICA
							AND coalesce(AEA.DT_FINAL_RESP::text, '') = '')
			
UNION

			SELECT NR_SEQ_TEAM CD,  NT.DS_TEAM DS
			FROM NURSING_TEAM_PROF NTP, NURSING_TEAM NT
			WHERE NTP.NR_SEQ_TEAM = NT.NR_SEQUENCIA
			AND EXISTS (SELECT 1 FROM ATEND_PROFISSIONAL AP
						WHERE AP.CD_PESSOA_FISICA = NTP.CD_PESSOA_FISICA
						AND AP.IE_PROFISSIONAL = 'E'
						AND AP.NR_SEQUENCIA = (SELECT MAX(APX.NR_SEQUENCIA) FROM ATEND_PROFISSIONAL APX WHERE APX.NR_ATENDIMENTO = NR_ATENDIMENTO_P))
	) X;

	IF (IE_TIPO_INFO_P = 'C') THEN
		DS_RESULTADO_W := NR_SEQ_TIME_W;
	ELSIF (IE_TIPO_INFO_P = 'D') THEN
		DS_RESULTADO_W := DS_TEAM_W;
	END IF;

END IF;
RETURN	DS_RESULTADO_W;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_time_atend ( NR_ATENDIMENTO_P bigint, IE_TIPO_INFO_P text DEFAULT 'C') FROM PUBLIC;

