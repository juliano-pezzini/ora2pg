-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_comp_hemo_rel ( ie_tipo_hemoterap_p text, cd_intervalo_p text, qt_procedimento_p bigint, qt_hora_min_infusao_p text, ie_via_aplicacao_p text, ie_reserva_p text, ie_mod_trans_p bigint, qt_vol_hemocomp_p bigint default null, ie_aliquotado_p text default null, ie_filtrado_p text default null, ie_irradiado_p text default null, ie_lavado_p text default null, ie_fenotipado_p text default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(4000);

	function via_aplicacao return text is
	ds_retorno_ww	varchar(255);
	
BEGIN
		select	ds_via_aplicacao ds
		into STRICT		ds_retorno_ww
		from	via_aplicacao
		where	ie_via_aplicacao = ie_via_aplicacao_p;
		
		return ' ' || ds_retorno_ww || ' ';
	end;
	
	function unidade_medida return varchar2 is
	begin
		return ' ' || qt_procedimento_p || ' ' || obter_desc_expressao(315377,null) || ' ';
	end;
	
	function reserva return varchar2 is
	begin
		if (ie_reserva_p = 'N') then
			return ' ' || obter_desc_expressao(300409, '') || ' '; -- Transfusao
		elsif (ie_reserva_p = 'S') then
			return ' ' || obter_desc_expressao(297667, '')|| ' '; -- Reserva
		end if;
		
		return null;
	end;
	
	function modalidade_transfusao return varchar2 is
	begin	
		if (ie_mod_trans_p IS NOT NULL AND ie_mod_trans_p::text <> '') then
			return ' ' ||obter_valor_dominio(1223, ie_mod_trans_p) || ' ';
		end if;
		
		return null;
	end;
	
	function qt_volume_hemo return varchar2 is
	begin	
		if (qt_vol_hemocomp_p IS NOT NULL AND qt_vol_hemocomp_p::text <> '') then
			return ' ' || obter_desc_expressao(302292, '') || ' ' ||qt_vol_hemocomp_p  || ' ';
		end if;
		
		return null;
	end;
	
	function duracao_infusacao return varchar2 is
	begin	
		if (qt_hora_min_infusao_p IS NOT NULL AND qt_hora_min_infusao_p::text <> '') then
			return ' ' || obter_desc_expressao(657027, '') || ' ' ||qt_hora_min_infusao_p  || ' ';
		end if;
		
		return null;
	end;	

	function desc_intervalo return varchar2 is
	begin
		if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
			return ' ' || obter_desc_expressao(292190, '') || ': ' ||obter_desc_intervalo(cd_intervalo_p) || ' ';
		end if;

		return '';
	end;
	
	function ie_tratamento_item return varchar2 is
	ds_retorno_ww	varchar2(255);
	begin	
		ds_retorno_ww := null;
		if (ie_aliquotado_p IS NOT NULL AND ie_aliquotado_p::text <> '') and (ie_aliquotado_p <> 'N') then
			ds_retorno_ww :=  obter_desc_expressao(283367, '') ||',';
		end if;
		
		if (ie_filtrado_p IS NOT NULL AND ie_filtrado_p::text <> '') and (ie_filtrado_p <> 'N') then
			ds_retorno_ww :=  ds_retorno_ww  ||' ' || obter_desc_expressao(290096, '') ||',';
		end if;

		if (ie_irradiado_p IS NOT NULL AND ie_irradiado_p::text <> '') and (ie_irradiado_p <> 'N') then
			ds_retorno_ww :=  ds_retorno_ww ||' ' || obter_desc_expressao(292247, '') ||',';
		end if;
		
		if (ie_lavado_p IS NOT NULL AND ie_lavado_p::text <> '') and (ie_lavado_p <> 'N') then
			ds_retorno_ww :=  ds_retorno_ww ||' ' || obter_desc_expressao(292460, '');
		end if;
		
		if (ie_fenotipado_p IS NOT NULL AND ie_fenotipado_p::text <> '') and (ie_fenotipado_p <> 'N') then
			ds_retorno_ww :=  ds_retorno_ww ||' ' || obter_desc_expressao(870224, '');
		end if;
		
		if (ds_retorno_ww IS NOT NULL AND ds_retorno_ww::text <> '') then
			return '  (' || ds_retorno_ww || ') ';
		else 	
			return null;
		end if;	
	end;
	
begin

	if (ie_tipo_hemoterap_p = '0') then
		ds_retorno_w := via_aplicacao() || qt_volume_hemo() || unidade_medida() ||  duracao_infusacao() || reserva() || modalidade_transfusao() || ie_tratamento_item() || desc_intervalo();
	elsif (ie_tipo_hemoterap_p = '1') then
		ds_retorno_w := qt_volume_hemo() || desc_intervalo();
	end if;

	return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_comp_hemo_rel ( ie_tipo_hemoterap_p text, cd_intervalo_p text, qt_procedimento_p bigint, qt_hora_min_infusao_p text, ie_via_aplicacao_p text, ie_reserva_p text, ie_mod_trans_p bigint, qt_vol_hemocomp_p bigint default null, ie_aliquotado_p text default null, ie_filtrado_p text default null, ie_irradiado_p text default null, ie_lavado_p text default null, ie_fenotipado_p text default null) FROM PUBLIC;

