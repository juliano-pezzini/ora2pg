-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cus_obter_ponto_equilibrio ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, cd_centro_controle_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


cd_empresa_w			bigint;
cd_tabela_custo_w			bigint;
dt_referencia_w			timestamp;
ie_tipo_gasto_w			varchar(2);
vl_receita_w			double precision;
vl_variavel_w			double precision;
vl_fixo_w				double precision;
vl_resultado_w			double precision;
qt_disponibilidade_w		double precision;
qt_disponibilidade_ww		double precision;


BEGIN

dt_referencia_w	:= trunc(dt_referencia_p,'month');
cd_empresa_w	:= obter_empresa_estab(cd_estabelecimento_p);

/* Tabela Resultado Centro Controle do mÃªs */

select	max(cd_tabela_custo)
into STRICT	cd_tabela_custo_w
from	tabela_custo
where	cd_estabelecimento		= cd_estabelecimento_p
and	dt_mes_referencia		= dt_referencia_w
and	cd_tipo_tabela_custo	= 11;

ie_tipo_gasto_w	:= 'R';

/*Obter o valor dos GNG de Receita*/

select	coalesce(sum(a.vl_mes),0)
into STRICT	vl_receita_w
from	grupo_natureza_gasto c,
	natureza_gasto b,
	resultado_centro_controle a
where	a.nr_seq_ng		= b.nr_sequencia
and	a.cd_estabelecimento	= b.cd_estabelecimento
and	b.nr_seq_gng		= c.nr_sequencia
and	b.cd_estabelecimento	= coalesce(c.cd_estabelecimento, cd_estabelecimento_p)
and	b.cd_empresa		= c.cd_empresa
and	c.cd_empresa		= cd_empresa_w
and	c.ie_tipo_gasto		= ie_tipo_gasto_w
and	a.cd_estabelecimento	= cd_estabelecimento_p
and	a.cd_tabela_custo		= cd_tabela_custo_w
and	a.cd_centro_controle	= cd_centro_controle_p;

ie_tipo_gasto_w	:= 'V';

/* Obter Valor Variavel*/

select	coalesce(sum(a.vl_mes),0)
into STRICT	vl_variavel_w
from	grupo_natureza_gasto c,
	natureza_gasto b,
	resultado_centro_controle a
where	a.nr_seq_ng		= b.nr_sequencia
and	a.cd_estabelecimento	= b.cd_estabelecimento
and	b.nr_seq_gng		= c.nr_sequencia
and	b.cd_estabelecimento	= coalesce(c.cd_estabelecimento, cd_estabelecimento_p)
and	b.cd_empresa		= c.cd_empresa
and	c.cd_empresa		= cd_empresa_w
and	c.ie_tipo_gasto		= ie_tipo_gasto_w
and	a.cd_estabelecimento	= cd_estabelecimento_p
and	a.cd_tabela_custo	= cd_tabela_custo_w
and	a.cd_centro_controle	= cd_centro_controle_p;

ie_tipo_gasto_w	:= 'F';

/* Obter Valor Fixo */

select	coalesce(sum(a.vl_mes),0)
into STRICT	vl_fixo_w
from	grupo_natureza_gasto c,
	natureza_gasto b,
	resultado_centro_controle a
where	a.nr_seq_ng		= b.nr_sequencia
and	a.cd_estabelecimento	= b.cd_estabelecimento
and	b.nr_seq_gng		= c.nr_sequencia
and	b.cd_estabelecimento	= coalesce(c.cd_estabelecimento, cd_estabelecimento_p)
and	b.cd_empresa		= c.cd_empresa
and	c.cd_empresa		= cd_empresa_w
and	c.ie_tipo_gasto		= ie_tipo_gasto_w
and	a.cd_estabelecimento	= cd_estabelecimento_p
and	a.cd_tabela_custo		= cd_tabela_custo_w
and	a.cd_centro_controle	= cd_centro_controle_p;

select	max(cd_tabela_custo)
into STRICT	cd_tabela_custo_w
from	tabela_custo
where	cd_estabelecimento		= cd_estabelecimento_p
and	dt_mes_referencia		= dt_referencia_w
and	cd_tipo_tabela_custo	= 2;

select	max(qt_disponibilidade)
into STRICT	qt_disponibilidade_ww
from	capac_centro_controle
where	cd_estabelecimento		= cd_estabelecimento_p
and	cd_centro_controle		= cd_centro_controle_p
and	cd_tabela_custo		= cd_tabela_custo_w
and	nr_sequencia_nivel	= 4;

select	coalesce(max(qt_base_ponto_equil), qt_disponibilidade_ww)
into STRICT	qt_disponibilidade_w
from	capac_centro_controle
where	cd_estabelecimento		= cd_estabelecimento_p
and	cd_centro_controle		= cd_centro_controle_p
and	cd_tabela_custo		= cd_tabela_custo_w
and	nr_sequencia_nivel	= 4;

if (coalesce(qt_disponibilidade_w::text, '') = '') then
	qt_disponibilidade_w	:= 0;
elsif (qt_disponibilidade_w = 0) then
	qt_disponibilidade_w	:= qt_disponibilidade_ww;
end if;

if (ie_opcao_p = 'V') then /* Calculo do Ponto de Equilibrio em valor*/
	vl_resultado_w	:= dividir((vl_receita_w - vl_variavel_w), vl_receita_w);
	vl_resultado_w	:= coalesce(dividir(vl_fixo_w,vl_resultado_w),0);
elsif (ie_opcao_p = 'Q') then /* Calculo do Ponto de Equilibrio em quantidade*/
	vl_resultado_w	:= dividir(vl_fixo_w,dividir((vl_receita_w - vl_variavel_w),qt_disponibilidade_w));
end if;
return	vl_resultado_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cus_obter_ponto_equilibrio ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, cd_centro_controle_p bigint, ie_opcao_p text) FROM PUBLIC;

