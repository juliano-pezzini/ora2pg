-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_saldo_projeto ( nr_sequencia_p bigint, ie_valor_p integer) RETURNS bigint AS $body$
DECLARE


/*
ie_valor_p
0 - vl_disponivel
1 - vl_utilizado
2 - valor disponivel com diminuição dos valores já pagos
*/
vl_disponivel_w		double precision;
vl_utilizado_w		double precision;
vl_disponivel_ja_pago_w	double precision;
vl_baixa_w		double precision;


BEGIN

if (ie_valor_p in (0,1)) then
	begin
	select	coalesce(sum(CASE WHEN substr(obter_se_nota_entrada_saida(a.nr_sequencia),1,1)='E' THEN 	coalesce(a.vl_projeto, a.vl_liquido)  ELSE coalesce(a.vl_projeto, a.vl_liquido)*-1 END ),0)
	into STRICT	vl_utilizado_w
	from 	nota_fiscal c,
		nota_fiscal_item a,
		projeto_recurso b
	where 	c.nr_sequencia = a.nr_sequencia
	and	a.nr_seq_proj_rec = b.nr_sequencia
	and	c.ie_situacao = '1'
	and	a.nr_seq_proj_rec = nr_sequencia_p;

	vl_disponivel_w	:= coalesce(obter_valor_projeto(nr_sequencia_p, clock_timestamp()),0) - vl_utilizado_w;
	end;
elsif (ie_valor_p = 2) then
	begin
	select	coalesce(sum(b.vl_baixa),0)
	into STRICT	vl_baixa_w
	from	titulo_pagar t,
		titulo_pagar_baixa b,
		nota_fiscal n
	where	t.nr_seq_nota_fiscal in (SELECT	i.nr_sequencia
					from	nota_fiscal_item i
					where	i.nr_seq_proj_rec = nr_sequencia_p)
	and	n.nr_sequencia = t.nr_seq_nota_fiscal
	and	t.ie_situacao = 'L'
	and 	t.nr_titulo = b.nr_titulo;

	vl_disponivel_ja_pago_w := (obter_valor_projeto(nr_sequencia_p,clock_timestamp()) - vl_baixa_w);
	end;
end if;

if (ie_valor_p = 0) then
	return coalesce(vl_disponivel_w,0);
elsif (ie_valor_p = 1) then
	return coalesce(vl_utilizado_w,0);
elsif (ie_valor_p = 2) then
	return coalesce(vl_disponivel_ja_pago_w,0);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_saldo_projeto ( nr_sequencia_p bigint, ie_valor_p integer) FROM PUBLIC;

