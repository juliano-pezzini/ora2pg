-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nosso_numero_banco (cd_banco_p bigint, nr_titulo_p bigint, ie_lock_p text default null) RETURNS varchar AS $body$
DECLARE



ds_retorno_w			varchar(255);
cd_estabelecimento_w		smallint;
ie_regra_w			varchar(3);
nr_fixo_w				bigint;
ds_rotina_digito_w			varchar(15);
nr_digito_w			bigint;
ds_digito_w			varchar(3);
nr_atual_w			banco_regra_numero.nr_atual%type;
qt_dig_numero_w			bigint;
qt_dig_verif_w			bigint;

nr_seq_conta_banco_w		bigint;
cd_agencia_w			varchar(20);
cd_conta_w			varchar(20);
cd_carteira_w			varchar(20);
nr_numero_calculo_w		varchar(40);
cd_carteira_tit_w			varchar(20);
nr_nosso_w			varchar(20);
cd_cedente_w			varchar(13);
qt_tamanho_w			bigint;
i				bigint;
ds_soma_w			varchar(20);
cd_estab_financ_w			titulo_receber.cd_estab_financeiro%type;
nr_vencimento_w     		integer;
cd_beneficiario_w			numeric(20);
nr_titulo_w			titulo_receber.nr_titulo%type;
dt_emissao_w		titulo_receber.dt_emissao%type;	
cd_posto_w			banco_estabelecimento.cd_posto%type;

ie_result_lock_w 	bigint;


BEGIN

if (ie_lock_p IS NOT NULL AND ie_lock_p::text <> '') then
	ie_result_lock_w := DBMS_LOCK.REQUEST(lockhandle => ie_lock_p, lockmode => DBMS_LOCK.X_MODE, timeout => 10);
else
	ie_result_lock_w := 0;
end if;

while(ie_result_lock_w > 0) loop --Se ta com lock ainda, tentar de novo ate liberar para poder efetuar o processo
	ie_result_lock_w := DBMS_LOCK.REQUEST(lockhandle => ie_lock_p, lockmode => DBMS_LOCK.X_MODE, timeout => 10);
end loop;

if (ie_result_lock_w = 0) then

select	max(cd_estabelecimento),
	max(nr_seq_conta_banco),
	max(cd_estab_financeiro)
into STRICT	cd_estabelecimento_w,
	nr_seq_conta_banco_w,
	cd_estab_financ_w
from	titulo_receber
where	nr_titulo	= nr_titulo_p;

/*OS 913077 - Se ie_cod_barras_nosso_num no cadastro do banco estiver para passar o nosso numero no lugar do titulo, o select acima nao vai achar os dados, pois vai procurar
o titulo comparando com o nosso numero do titulo. Caso passar o nosso numero e nao achar, aqui em baixo tenta achar o titulo pelo nosso numero*/
if (coalesce(cd_estabelecimento_w::text, '') = '') then

	select	max(nr_titulo)
	into STRICT	nr_titulo_w
	from	titulo_receber
	where	(nr_nosso_numero IS NOT NULL AND nr_nosso_numero::text <> '')
	and	somente_numero(nr_nosso_numero) = nr_titulo_p;

	if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
	
		select	max(cd_estabelecimento),
			max(nr_seq_conta_banco),
			max(cd_estab_financeiro)
		into STRICT	cd_estabelecimento_w,
			nr_seq_conta_banco_w,
			cd_estab_financ_w
		from	titulo_receber
		where	nr_titulo	= nr_titulo_w;
	
	end if;

end if;

select	max(ie_regra),
	max(nr_fixo),
	max(ds_rotina_digito),
	max(nr_Atual),
	coalesce(max(qt_dig_numero),length(nr_titulo_p)),
	coalesce(max(qt_dig_verif),1)
into STRICT	ie_regra_w,
	nr_fixo_w,
	ds_rotina_digito_w,
	nr_atual_w,
	qt_dig_numero_w,
	qt_dig_verif_w
from	banco_regra_numero
where	cd_banco		= cd_banco_p
and	cd_estabelecimento		= cd_estabelecimento_w;

if (coalesce(ie_regra_w::text, '') = '') then /*Se nao achou pelo estabelecimento do titulo, procura pelo estabelecimento financeiro do titulo AAMFIRMO OS 815365*/
	select	max(ie_regra),
		max(nr_fixo),
		max(ds_rotina_digito),
		max(nr_Atual),
		coalesce(max(qt_dig_numero),length(nr_titulo_p)),
		coalesce(max(qt_dig_verif),1)
	into STRICT	ie_regra_w,
		nr_fixo_w,
		ds_rotina_digito_w,
		nr_atual_w,
		qt_dig_numero_w,
		qt_dig_verif_w
	from	banco_regra_numero
	where	cd_banco		= cd_banco_p
	and	cd_estabelecimento		= cd_estab_financ_w;

end if;

/* Busca a carteira pelo titulo */

select	substr(max(b.cd_carteira),1,20)
into STRICT	cd_carteira_tit_w
from	banco_carteira b,
	titulo_receber a
where	b.nr_sequencia  = a.nr_seq_carteira_cobr
and	a.nr_titulo 	= nr_titulo_p;

if (ie_regra_w	= 'T') then
	ds_retorno_w	:= nr_titulo_p;
elsif (ie_regra_w	= 'FT') then
	if (qt_dig_numero_w > 0) then
		ds_retorno_w	:= to_char(nr_fixo_w) || lpad(nr_titulo_p,qt_dig_numero_w - length(nr_fixo_w),0);
	else
		ds_retorno_w	:= to_char(nr_fixo_w) || nr_titulo_p;
	end if;
elsif (ie_regra_w	= 'FTD') then
	if (cd_banco_p = 104) then
		begin
		
		select	Calcula_Digito(ds_rotina_digito_w, (to_char(nr_fixo_w) || lpad(to_char(nr_titulo_p),qt_dig_numero_w - length(to_char(nr_fixo_w)) - qt_dig_verif_w,'0'))::numeric )
		into STRICT	nr_digito_w
		;

		ds_retorno_w	:= to_char(nr_fixo_w) || lpad(to_char(nr_titulo_p),qt_dig_numero_w - length(to_char(nr_fixo_w)) - qt_dig_verif_w,'0') || nr_digito_w;

		end;
	elsif (cd_banco_p	= 237) then
		begin
		select	coalesce(cd_carteira_tit_w,max(a.cd_carteira))
		into STRICT	cd_carteira_w
		from	banco_estabelecimento a
		where	a.nr_sequencia	= nr_seq_conta_banco_w;
	
		ds_digito_w	:=	Calcula_Digito(ds_rotina_digito_w, cd_carteira_w || (to_char(nr_fixo_w) || lpad(to_char(nr_titulo_p),qt_dig_numero_w - length(to_char(nr_fixo_w)) - qt_dig_verif_w,'0'))::numeric );
		if (ds_digito_w = '-1') then
			ds_digito_w	:= 'P';
		end if;
		
		ds_retorno_w	:=  to_char(nr_fixo_w) || lpad(to_char(nr_titulo_p),qt_dig_numero_w - length(to_char(nr_fixo_w)) - qt_dig_verif_w,'0') || ds_digito_w;
		end;		
	else
		begin
		
		select	Calcula_Digito(ds_rotina_digito_w, (to_char(nr_fixo_w) || lpad(to_char(nr_titulo_p),qt_dig_numero_w - coalesce(length(to_char(nr_fixo_w)),0) - qt_dig_verif_w,'0'))::numeric  )
		into STRICT	nr_digito_w
		;

		--ds_retorno_w	:= to_char(nr_fixo_w) || nr_titulo_p || nr_digito_w;
		ds_retorno_w	:= to_char(nr_fixo_w) || lpad(to_char(nr_titulo_p),qt_dig_numero_w - length(to_char(nr_fixo_w)) - qt_dig_verif_w,'0') || nr_digito_w;

		end;
	end if;
elsif (ie_regra_w = 'S') then
	ds_retorno_w	:= to_char(nr_atual_w);
elsif (ie_regra_w = 'TD') then
	begin
	if (cd_banco_p	= 237) then
		select	coalesce(cd_carteira_tit_w,max(a.cd_carteira))
		into STRICT	cd_carteira_w
		from	banco_estabelecimento a
		where	a.nr_sequencia	= nr_seq_conta_banco_w;
	
		ds_digito_w	:=	Calcula_Digito(ds_rotina_digito_w, cd_carteira_w || lpad(to_char(nr_titulo_p),qt_dig_numero_w - qt_dig_verif_w,'0'));
		if (ds_digito_w = '-1') then
			ds_digito_w	:= 'P';
		end if;
		
		ds_retorno_w	:= 	lpad(to_char(nr_titulo_p),qt_dig_numero_w - qt_dig_verif_w,'0') || '-' || lpad(to_char(ds_digito_w),qt_dig_verif_w,'0');
	elsif (cd_banco_p	= 756) then	/* Sicoob */
		select	lpad(substr(coalesce(max(a.cd_agencia_bancaria),'0'),1,4),4,'0'),
			lpad(substr(coalesce(max(a.cd_cedente),'0'),1,9),9,'0')
		into STRICT	cd_agencia_w,
			cd_cedente_w
		from	banco_estabelecimento a,
			titulo_receber b
		where	a.nr_sequencia	= b.nr_seq_conta_banco
		and	b.nr_titulo	= nr_titulo_p;

		/* agencia (4) + cedente (10) + titulo (7) */

		nr_digito_w	:=	Calcula_Digito(ds_rotina_digito_w,lpad(cd_agencia_w,4,'0') || lpad(cd_cedente_w,10,'0') || lpad(to_char(nr_titulo_p),7,'0'));
		ds_retorno_w	:= 	lpad(to_char(nr_titulo_p),qt_dig_numero_w - qt_dig_verif_w,'0') || lpad(to_char(nr_digito_w),qt_dig_verif_w,'0');

	elsif (cd_banco_p = 748) then
		select	lpad(substr(coalesce(max(a.cd_agencia_bancaria),'0'),1,4),4,'0'),
			lpad(substr(coalesce(max(a.cd_cedente),'0'),1,9),5,'0')
		into STRICT	cd_agencia_w,
			cd_cedente_w
		from	banco_estabelecimento a,
			titulo_receber b
		where	a.nr_sequencia	= b.nr_seq_conta_banco
		and	b.nr_titulo	= nr_titulo_p;
		
		nr_digito_w	:= Calcula_Digito(ds_rotina_digito_w,lpad(cd_agencia_w,4,'0') || '04' || lpad(cd_cedente_w,5,'0') || lpad(to_char(nr_titulo_p),8,'0'));
		ds_retorno_w	:= lpad(to_char(nr_titulo_p),qt_dig_numero_w - qt_dig_verif_w,'0') || lpad(to_char(nr_digito_w),qt_dig_verif_w,'0');
	else
		nr_digito_w	:=	Calcula_Digito(ds_rotina_digito_w,lpad(to_char(nr_titulo_p),qt_dig_numero_w - qt_dig_verif_w,'0'));
		ds_retorno_w	:= 	lpad(to_char(nr_titulo_p),qt_dig_numero_w - qt_dig_verif_w,'0') || lpad(to_char(nr_digito_w),qt_dig_verif_w,'0');
	end if;
	
	end;
	
/* Francisco - OS 228238 - 13/08/2010 */


/* Padrao Itau */

elsif (ie_regra_w = 'ACC') then
	select	max(nr_seq_conta_banco)
	into STRICT	nr_seq_conta_banco_w
	from	titulo_receber a
	where	a.nr_titulo	= nr_titulo_p;

	if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') then
		select	a.cd_agencia_bancaria,
			a.cd_conta,
			coalesce(cd_carteira_tit_w,a.cd_carteira)
		into STRICT	cd_agencia_w,
			cd_conta_w,
			cd_carteira_w
		from	banco_estabelecimento a
		where	a.nr_sequencia	= nr_seq_conta_banco_w;

		nr_numero_calculo_w	:= lpad(cd_agencia_w,4,'0') || cd_conta_w || lpad(cd_carteira_w,3,'0') || lpad(to_char(nr_titulo_p),qt_dig_numero_w,'0');
		nr_digito_w		:= calcula_digito('MODULO10',nr_numero_calculo_w);

		ds_retorno_w	:= lpad(cd_carteira_w,3,'0') || '/' || lpad(to_char(nr_titulo_p),qt_dig_numero_w,'0') || '-' || nr_digito_w;

	else
		ds_retorno_w	:= null;
	end if;
elsif (ie_regra_w = 'ACS') then
	select	max(nr_seq_conta_banco)
	into STRICT	nr_seq_conta_banco_w
	from	titulo_receber a
	where	a.nr_titulo	= nr_titulo_p;

	if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') then
		select	a.cd_agencia_bancaria,
			a.cd_conta,
			coalesce(cd_carteira_tit_w,a.cd_carteira)
		into STRICT	cd_agencia_w,
			cd_conta_w,
			cd_carteira_w
		from	banco_estabelecimento a
		where	a.nr_sequencia	= nr_seq_conta_banco_w;
		
		nr_numero_calculo_w	:= lpad(cd_agencia_w,4,'0') || cd_conta_w || lpad(cd_carteira_w,3,'0') || lpad(to_char(nr_atual_w),qt_dig_numero_w,'0');
		nr_digito_w		:= calcula_digito('MODULO10',nr_numero_calculo_w);
		
		ds_retorno_w	:= lpad(cd_carteira_w,3,'0') || '/' || lpad(to_char(nr_atual_w),qt_dig_numero_w,'0') || '-' || nr_digito_w;

	else
		ds_retorno_w	:= null;
	end if;
elsif (ie_regra_w = 'FSD') then
	
	select	lpad(substr(coalesce(max(a.cd_agencia_bancaria),'0'),1,4),4,'0'),
		lpad(coalesce(cd_carteira_tit_w,max(a.cd_carteira)),2,'0')
	into STRICT	cd_agencia_w,
		cd_carteira_w		
	from	banco_estabelecimento a
	where	a.nr_sequencia	= nr_seq_conta_banco_w;
		
	if (cd_banco_p	= 87) then
		
		nr_nosso_w :=  to_char(substr(coalesce(nr_fixo_w,0),1,1)) || cd_agencia_w || lpad(to_char(coalesce(nr_atual_w,0)),6,'0');
	
		ds_digito_w	:=	Calcula_Digito(ds_rotina_digito_w, cd_carteira_w || nr_nosso_w);
		
		if (ds_digito_w = '-1') then
			ds_digito_w	:= 'P';
		end if;
		
		ds_retorno_w	:= 	nr_nosso_w || '-' || lpad(ds_digito_w, qt_dig_verif_w,'0');
		
	elsif (cd_banco_p	in (707,643)) then --Daycoval, Pine
	
		select	lpad(coalesce(cd_carteira_tit_w,max(a.cd_carteira)),3,'0') -- No daycoval, a carteira e 3 digitos para calculo do DV
		into STRICT	cd_carteira_w		
		from	banco_estabelecimento a
		where	a.nr_sequencia	= nr_seq_conta_banco_w;
		
		if (coalesce(nr_fixo_w::text, '') = '') then
			nr_nosso_w 	:= lpad( to_char(nr_atual_w), qt_dig_numero_w - coalesce(qt_dig_verif_w,0),'0');
		else
			nr_nosso_w 	:= lpad( to_char(nr_fixo_w) || to_char(nr_atual_w), qt_dig_numero_w - length(nr_fixo_w) - coalesce(qt_dig_verif_w,0),'0');
		end if;

		ds_digito_w	:= Calcula_Digito(ds_rotina_digito_w, cd_agencia_w || cd_carteira_w || lpad(nr_nosso_w,10,'0'));
		ds_retorno_w	:= nr_nosso_w || lpad(ds_digito_w, qt_dig_verif_w,'0');
		
	else
		nr_nosso_w	:= 	to_char(nr_fixo_w);
		

		if (coalesce(qt_dig_numero_w,0) > 0) then
			if (coalesce(nr_fixo_w::text, '') = '') then
				nr_nosso_w	:= nr_nosso_w || lpad(nr_atual_w,qt_dig_numero_w - coalesce(qt_dig_verif_w,0),'0');
			else
				nr_nosso_w	:= nr_nosso_w || lpad(nr_atual_w,qt_dig_numero_w - length(nr_fixo_w) - coalesce(qt_dig_verif_w,0),'0');
			end if;
		else
			nr_nosso_w	:= nr_nosso_w || to_char(nr_atual_w);
		end if;
		
		/*OS 1862390 - Se nao tiver quantidade de digitos verificadores informados na regra, nao tentar calcular DV nem concatenar o nr_digito_w que por padrao sera 0*/

		if (coalesce(qt_dig_verif_w,0) > 0) then
		
			if (cd_banco_p = 237 and cd_carteira_w <> '00') then
				
				ds_digito_w	:=	Calcula_Digito(ds_rotina_digito_w, cd_carteira_w || nr_nosso_w);
				
				if (ds_digito_w = '-1') then
					ds_digito_w	:= 'P';
				end if;
				
				ds_retorno_w	:= 	nr_nosso_w || lpad(ds_digito_w, qt_dig_verif_w,'0');
				
			else
				select	Calcula_Digito(ds_rotina_digito_w, nr_nosso_w)
				into STRICT	nr_digito_w
				;
				
				ds_retorno_w	:= nr_nosso_w || nr_digito_w;
				
			end if;	
		else
			ds_retorno_w	:= nr_nosso_w;	
		end if;	

	end if;	

elsif (ie_regra_w = 'TDP') then

	select	substr(coalesce(max(a.cd_cedente),'0'),1,13)
	into STRICT	cd_cedente_w
	from	banco_estabelecimento a,
		titulo_receber b
	where	a.nr_sequencia	= b.nr_seq_conta_banco
	and	b.nr_titulo	= nr_titulo_p;

	nr_digito_w	:= calcula_digito(ds_rotina_digito_w,nr_titulo_p);
	ds_retorno_w	:= nr_titulo_p || lpad(nr_digito_w,qt_dig_verif_w,'0') || '5';

	ds_soma_w	:= to_char(somente_numero(nr_titulo_p || nr_digito_w || '5') + somente_numero(cd_cedente_w));

	nr_digito_w	:= calcula_digito(ds_rotina_digito_w,ds_soma_w);
	ds_retorno_w	:= lpad(ds_retorno_w || lpad(nr_digito_w,qt_dig_verif_w,'0'),qt_dig_numero_w,'0');

elsif (ie_regra_w = 'AFS') then
	
	nr_nosso_w	:= substr(formatar_data_mascara(clock_timestamp(),'yy'),1,2);


	if (coalesce(qt_dig_numero_w,0) > 0) then
		if (coalesce(nr_fixo_w::text, '') = '') then
			nr_nosso_w	:= nr_nosso_w || lpad(nr_atual_w,qt_dig_numero_w - coalesce(qt_dig_verif_w,0),'0');
		else
			nr_nosso_w := nr_nosso_w || nr_fixo_w;
			nr_nosso_w	:= nr_nosso_w || lpad(nr_atual_w,qt_dig_numero_w - length(nr_nosso_w) - coalesce(qt_dig_verif_w,0),'0');
		end if;
	else
		nr_nosso_w	:= nr_nosso_w || to_char(nr_atual_w);
	end if;

	select	Calcula_Digito(ds_rotina_digito_w, nr_nosso_w)
	into STRICT	nr_digito_w
	;

	ds_retorno_w	:= nr_nosso_w || nr_digito_w;
						
elsif (ie_regra_w = 'PBV') then
			
	if (cd_banco_p	= 399) then
		
		ds_digito_w	:= Calcula_Digito(ds_rotina_digito_w, lpad(to_char(nr_titulo_p), qt_dig_numero_w - qt_dig_verif_w,'0'));
		
		select	coalesce(max(b.cd_convenio_banco), 0),		
			(to_char(max(a.dt_vencimento), 'ddmmyy'))::numeric
		into STRICT	cd_beneficiario_w,
			nr_vencimento_w
		FROM titulo_receber a
LEFT OUTER JOIN banco_estabelecimento b ON (a.nr_seq_conta_banco = b.nr_sequencia)
WHERE a.nr_titulo	= nr_titulo_p;	
		
		nr_numero_calculo_w 	:= to_char(nr_titulo_p) || ds_digito_w || '4';
		
		nr_numero_calculo_w 	:= to_char((nr_numero_calculo_w)::numeric  + cd_beneficiario_w + nr_vencimento_w);	
		
		nr_numero_calculo_w	:= Calcula_Digito(ds_rotina_digito_w, lpad(nr_numero_calculo_w, qt_dig_numero_w - qt_dig_verif_w,'0'));
		
		ds_retorno_w		:= lpad(to_char(nr_titulo_p),qt_dig_numero_w - qt_dig_verif_w,'0') || lpad(to_char(ds_digito_w || '4' || nr_numero_calculo_w),qt_dig_verif_w,'0');
	end if;

elsif (ie_regra_w = 'DAC') then
/*aamfirmo OS 1018514, Regra criada para atender o calculo do DAC do Itau. Funciona quase igual a regra ACS, porem nao pode retornar o nosso numero com a carteira, a carteira, conta, agencia devem ser apenas utilizados para calcular o DAC*/

	select	coalesce(coalesce(max(e.cd_bloqueto),max(e.cd_agencia_bancaria)),'0'),
			coalesce(max(b.cd_conta),'0'),
			coalesce(max(d.cd_carteira), substr(coalesce(max(b.cd_carteira),'0'), 1,3))
	into STRICT	cd_agencia_w,
			cd_conta_w,
			cd_carteira_w
	FROM agencia_bancaria e, moeda c, banco_estabelecimento b
LEFT OUTER JOIN banco f ON (b.cd_banco = f.cd_banco)
, titulo_receber a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.nr_seq_conta_banco	= b.nr_sequencia and a.cd_moeda   		= c.cd_moeda  and a.nr_titulo 		= nr_titulo_p and b.cd_banco		= e.cd_banco and b.cd_agencia_bancaria	= e.cd_agencia_bancaria;
	
	nr_nosso_w	:= 	to_char(nr_fixo_w);

	if (coalesce(qt_dig_numero_w,0) > 0) then
		if (coalesce(nr_fixo_w::text, '') = '') then
			nr_nosso_w	:= nr_nosso_w || lpad(nr_atual_w,qt_dig_numero_w - coalesce(qt_dig_verif_w,0),'0');
		else
			nr_nosso_w	:= nr_nosso_w || lpad(nr_atual_w,qt_dig_numero_w - length(nr_fixo_w) - coalesce(qt_dig_verif_w,0),'0');
		end if;
	else
		nr_nosso_w	:= nr_nosso_w || to_char(nr_atual_w);
	end if;

	select	Calcula_Digito(ds_rotina_digito_w, cd_agencia_w || cd_conta_w || cd_carteira_w || nr_nosso_w)
	into STRICT	nr_digito_w
	;

	ds_retorno_w	:= nr_nosso_w || nr_digito_w;
	
elsif (ie_regra_w = 'PAS') then
/*Essa regra  utiliza para gerar o nosso numero a mesma composicao que a regra AFS, porem para calcular o digito do nosso numero considera agencia, posto e codigo do cedente com o ano, byte e sequencial - OS 1105414 30/05/2016, 
Conforme manual sicred em anexo na OS 1105414, manual de Agosto de 2010*/


	/*Composicao do Nosso Numero, pagina 11 do manual
	AA = Ano da geracao do Titulo
	b = Geracao do nosso numero: 1 - Gerado pela cooperativa, 2 a 9 - Gerado pelo cedente
	Nnnnn = Numero sequencial
	d = Digito verificador*/
	
	select	lpad(coalesce(max(e.cd_agencia_bancaria),'0'),4,'0'),
			lpad(coalesce(max(b.cd_posto),'0'),2,'0'),
			lpad(coalesce(max(b.cd_cedente),'0'),5,'0'),
			coalesce(max(a.dt_emissao),clock_timestamp())
	into STRICT	cd_agencia_w,
			cd_posto_w,
			cd_cedente_w,
			dt_emissao_w
	FROM agencia_bancaria e, titulo_receber a, banco_estabelecimento b
LEFT OUTER JOIN banco f ON (b.cd_banco = f.cd_banco)
WHERE a.nr_seq_conta_banco	= b.nr_sequencia and a.nr_titulo 		= nr_titulo_p and b.cd_banco		= e.cd_banco and b.cd_agencia_bancaria	= e.cd_agencia_bancaria;
	
	nr_nosso_w	:= substr(formatar_data_mascara(coalesce(dt_emissao_w,clock_timestamp()),'yy'),1,2);
	
	if (coalesce(qt_dig_numero_w,0) > 0) then
		if (coalesce(nr_fixo_w::text, '') = '') then
			nr_nosso_w	:= nr_nosso_w || lpad(nr_atual_w,qt_dig_numero_w - coalesce(qt_dig_verif_w,0),'0');
		else
			nr_nosso_w	:= nr_nosso_w || nr_fixo_w || lpad(nr_atual_w,qt_dig_numero_w - length(nr_fixo_w) - coalesce(qt_dig_verif_w,0),'0');
		end if;
	else
		nr_nosso_w	:= nr_nosso_w || to_char(nr_atual_w);
	end if;

	/*O calculo do digito segundo o manual da Sicredi deve considerar agencia + posto + cedente + ano + byte + sequencial*/

	select	Calcula_Digito(ds_rotina_digito_w, cd_agencia_w || cd_posto_w || cd_cedente_w ||nr_nosso_w)
	into STRICT	nr_digito_w
	;
	ds_retorno_w	:= nr_nosso_w || nr_digito_w;
	
elsif (ie_regra_w = 'FAS') then

	select	lpad(substr(coalesce(max(e.cd_agencia_bancaria),'0'),1,4),4,'0'),
			coalesce(max(d.cd_carteira), substr(coalesce(max(b.cd_carteira),'0'), 1,3))
	into STRICT	cd_agencia_w,
			cd_carteira_w
	FROM agencia_bancaria e, moeda c, banco_estabelecimento b
LEFT OUTER JOIN banco f ON (b.cd_banco = f.cd_banco)
, titulo_receber a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.nr_seq_conta_banco	= b.nr_sequencia and a.cd_moeda   			= c.cd_moeda  and a.nr_titulo 			= nr_titulo_p and b.cd_banco				= e.cd_banco and b.cd_agencia_bancaria	= e.cd_agencia_bancaria;

	if (cd_banco_p	= 756) then
		/* OS 1503335 - Atender o sicredi
		P - Produto (1-Registrada / 3-Caucionada / 4-Descontada)
		AAAA - Agencia Unicred associada a conta do cooperado
                NNNNNN - sequencial de 000001 a 999999
		D - Digito Verificador*/

		--FAS             Campo fixo + Agencia + Sequencial + Digito  04/10/17

	
		/*Desenvolvido para atender o layout da OS 1503335. 
		Como no layout define exatamente que deve ter 1 fixo, agencia com 4 digitos, sequencial com 6 e digito com 1, nao sera verificado so campos qt_dig_numero_w e qt_dig_verif_w*/
		nr_nosso_w	:= 	substr(nr_fixo_w,1,1) 							|| /*Pos 01*/
						lpad(substr(coalesce(cd_agencia_w,'0'),1,4),4,'0') 	|| /*Pos 02 a 05*/
						lpad(substr(coalesce(nr_atual_w,'0'),1,6),6,'0');	 /*Pos 06 a 11*/
					
		ds_digito_w	:= Calcula_Digito( ds_rotina_digito_w,
									   cd_carteira_w || nr_nosso_w );

		/* OS 1546931 - historico 24/11/2017 14:06:01 */

		if (ds_digito_w = '-1') then
			ds_digito_w	:= 'P';
		end if;

		ds_retorno_w := nr_nosso_w || ds_digito_w;
		
	else
	
		if (coalesce(qt_dig_numero_w,0) > 0) then
			if (coalesce(nr_fixo_w::text, '') = '') then
				nr_nosso_w	:= cd_agencia_w || 
							   lpad(nr_atual_w,qt_dig_numero_w  - length(cd_agencia_w) - coalesce(qt_dig_verif_w,0),'0');
			else
				nr_nosso_w	:=  nr_fixo_w ||
								cd_agencia_w ||
								lpad(nr_atual_w,qt_dig_numero_w - length(nr_fixo_w) - length(cd_agencia_w) - coalesce(qt_dig_verif_w,0),'0');
			end if;
		else
			nr_nosso_w	:= nr_fixo_w ||
						   cd_agencia_w ||
						   nr_atual_w;		
		end if;	
		
		ds_digito_w	:= Calcula_Digito( ds_rotina_digito_w,
									   cd_carteira_w || nr_nosso_w );
									
		ds_retorno_w := nr_nosso_w || ds_digito_w; 							

	end if;	
			
end if;

end if; --fim if ie_result_lock_w
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nosso_numero_banco (cd_banco_p bigint, nr_titulo_p bigint, ie_lock_p text default null) FROM PUBLIC;

