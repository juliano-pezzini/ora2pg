-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gpt_get_item_prescription_data (nm_tabela_p text, nr_sequencia_p bigint, si_option_p text) RETURNS varchar AS $body$
DECLARE

										 
 
ds_return_w		varchar(255);


BEGIN 
 
/* Codigo Padronizado */
 
if (si_option_p = 'CPD') then 
	if (nm_tabela_p = 'CPOE_NUTRICAO') then 
		select	substr(obter_se_material_padronizado(obter_dados_prescricao(b.nr_prescricao,'E'), b.cd_material),1,1) ie_padronizado 
		into STRICT	ds_return_w 
		from	prescr_material b, 
				cpoe_dieta a 
		where	a.nr_sequencia = b.nr_seq_dieta_cpoe 
		and		a.nr_sequencia	= nr_sequencia_p;
	elsif (nm_tabela_p = 'CPOE_MATERIAL') then 
		select	substr(obter_se_material_padronizado(obter_dados_prescricao(b.nr_prescricao,'E'), b.cd_material),1,1) ie_padronizado 
		into STRICT	ds_return_w 
		from	prescr_material b, 
				cpoe_material a 
		where	a.nr_sequencia = b.nr_seq_mat_cpoe 
		and		a.nr_sequencia	= nr_sequencia_p;
	end if;
/* Codigo Regra dispensacao */
 
elsif (si_option_p = 'CRD') then 
	if (nm_tabela_p = 'CPOE_NUTRICAO') then 
		select	max(coalesce(b.ie_regra_disp,'S')) ie_regra_df 
		into STRICT	ds_return_w 
		from	prescr_material b, 
				cpoe_dieta a 
		where	a.nr_sequencia = b.nr_seq_dieta_cpoe 
		and		a.nr_sequencia	= nr_sequencia_p 
		and  	b.nr_prescricao = (SELECT max(x.nr_prescricao) from prescr_material x where x.nr_seq_dieta_cpoe = b.nr_seq_dieta_cpoe and coalesce(x.dt_suspensao::text, '') = '');
	elsif (nm_tabela_p = 'CPOE_MATERIAL') then 
		select	max(coalesce(b.ie_regra_disp,'S')) ie_regra_df 
		into STRICT	ds_return_w 
		from	prescr_material b, 
				cpoe_material a 
		where	a.nr_sequencia = b.nr_seq_mat_cpoe 
		and		a.nr_sequencia	= nr_sequencia_p 
		and  	b.nr_prescricao = (SELECT max(x.nr_prescricao) from prescr_material x where x.nr_seq_mat_cpoe = b.nr_seq_mat_cpoe and coalesce(x.dt_suspensao::text, '') = '');
	end if;
/* Descricao Padronizado */
 
elsif (si_option_p = 'DPD') then 
	if (nm_tabela_p = 'CPOE_NUTRICAO') then 
		select	CASE WHEN max(substr(obter_se_material_padronizado(obter_dados_prescricao(b.nr_prescricao,'E'), b.cd_material),1,1))='S' THEN  				obter_desc_expressao(314958,null)  ELSE null END  ie_padronizado 
		into STRICT	ds_return_w 
		from	prescr_material b, 
				cpoe_dieta a 
		where	a.nr_sequencia = b.nr_seq_dieta_cpoe 
		and		a.nr_sequencia	= nr_sequencia_p;
	elsif (nm_tabela_p = 'CPOE_MATERIAL') then 
		select	CASE WHEN max(substr(obter_se_material_padronizado(obter_dados_prescricao(b.nr_prescricao,'E'), b.cd_material),1,1))='S' THEN  				obter_desc_expressao(314958,null)  ELSE null END  ie_padronizado 
		into STRICT	ds_return_w 
		from	prescr_material b, 
				cpoe_material a 
		where	a.nr_sequencia = b.nr_seq_mat_cpoe 
		and		a.nr_sequencia	= nr_sequencia_p;
	end if;
/* Descricao Regra dispensacao */
 
elsif (si_option_p = 'DRD') then 
	if (nm_tabela_p = 'CPOE_NUTRICAO') then 
		select	max(obter_valor_dominio(8176,coalesce(b.ie_regra_disp,'S'))) ie_regra_df 
		into STRICT	ds_return_w 
		from	prescr_material b, 
				cpoe_dieta a 
		where	a.nr_sequencia = b.nr_seq_dieta_cpoe 
		and		a.nr_sequencia	= nr_sequencia_p 
		and  	b.nr_prescricao = (SELECT max(x.nr_prescricao) from prescr_material x where x.nr_seq_dieta_cpoe = b.nr_seq_dieta_cpoe and coalesce(x.dt_suspensao::text, '') = '');
	elsif (nm_tabela_p = 'CPOE_MATERIAL') then 
		select	max(obter_valor_dominio(8176,coalesce(b.ie_regra_disp,'S'))) ie_regra_df 
		into STRICT	ds_return_w 
		from	prescr_material b, 
				cpoe_material a 
		where	a.nr_sequencia = b.nr_seq_mat_cpoe 
		and		a.nr_sequencia	= nr_sequencia_p 
		and  	b.nr_prescricao = (SELECT max(x.nr_prescricao) from prescr_material x where x.nr_seq_mat_cpoe = b.nr_seq_mat_cpoe and coalesce(x.dt_suspensao::text, '') = '');
	end if;
end if;
 
return	ds_return_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gpt_get_item_prescription_data (nm_tabela_p text, nr_sequencia_p bigint, si_option_p text) FROM PUBLIC;

