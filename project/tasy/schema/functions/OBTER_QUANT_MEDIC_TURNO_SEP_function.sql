-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_quant_medic_turno_sep (nr_prescricao_p bigint, cd_material_p bigint, ie_turno_p bigint) RETURNS varchar AS $body$
DECLARE

 
dt_primeiro_horario_w	timestamp;
hr_prim_horario_w	varchar(5);
ds_retorno_w		varchar(255);
cd_setor_atendimento_w	integer;
cd_estabelecimento_w	smallint;
hr_prim_turno_w		varchar(5);
hr_seg_turno_w		varchar(5);
hr_ter_turno_w		varchar(5);
nr_sequencia_w		integer;
qt_total_dispensar_w	double precision;
nr_ocorrencia_w		double precision;

hr_prim_horario_sol_w	varchar(5);

 
ds_horarios_w		varchar(2000);
ds_horarios_dif_w	varchar(2000);
qt_manha_w		double precision := 0;
qt_tarde_w		double precision := 0;
qt_noite_w		double precision := 0;
qt_exedente_w		double precision := 0;
qt_sobra_w		double precision := 0;
ds_hora_w		varchar(255);
qt_unitaria_w		double precision;
ie_agupador_w		smallint;
nr_sequencia_diluicao_w	integer;
nr_sequencia_solucao_w	integer;
k			integer;
y			integer;
qt_flag_w		integer := 0;

ie_agrupador_w		smallint;

 
C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.ie_agrupador, 
		a.nr_sequencia_diluicao, 
		a.nr_sequencia_solucao, 
		a.hr_prim_horario 
	from	material b, 
		prescr_material a 
	where	a.nr_prescricao	= nr_prescricao_p 
	and	a.cd_material	= cd_material_p 
	and	a.cd_material	= b.cd_material 
	and	b.ie_material_estoque 			= 'S' 
	and	coalesce(a.ie_urgencia,'N')			<> 'S' 
	and	coalesce(a.ie_medicacao_paciente,'N')	<> 'S' 
	and	coalesce(a.ie_suspenso,'N')			<> 'S' 
	order by a.ie_agrupador;

BEGIN
 
select	coalesce(cd_setor_atendimento,obter_setor_atendimento(nr_atendimento)), 
	cd_estabelecimento, 
	dt_primeiro_horario 
into STRICT	cd_setor_atendimento_w, 
	cd_estabelecimento_w, 
	dt_primeiro_horario_w 
from	prescr_medica 
where	nr_prescricao = nr_prescricao_p;
 
begin 
select	hr_prim_turno, 
	hr_seg_turno, 
	hr_ter_turno 
into STRICT	hr_prim_turno_w, 
	hr_seg_turno_w, 
	hr_ter_turno_w 
from	regra_turno_prescr 
where	cd_estabelecimento	= cd_estabelecimento_w 
and	nr_sequencia		= (	SELECT	min(b.nr_sequencia) 
					from	regra_turno_prescr b 
					where	cd_setor_atendimento = cd_setor_atendimento_w);
exception 
	when others then 
		hr_prim_turno_w := null;
end;
 
if (coalesce(hr_prim_turno_w::text, '') = '') then 
	begin 
	select	hr_prim_turno, 
		hr_seg_turno, 
		hr_ter_turno 
	into STRICT	hr_prim_turno_w, 
		hr_seg_turno_w, 
		hr_ter_turno_w 
	from	regra_turno_prescr 
	where	cd_estabelecimento	= cd_estabelecimento_w 
	and	nr_sequencia		= (	SELECT	min(b.nr_sequencia) 
						from	regra_turno_prescr b 
						where	coalesce(cd_setor_atendimento::text, '') = '');
	exception 
		when others then 
			hr_prim_turno_w := null;
	end;	
end if;
 
 
 
if (hr_prim_turno_w IS NOT NULL AND hr_prim_turno_w::text <> '') then 
 
	OPEN C01;
	LOOP 
		FETCH C01 into 
			nr_sequencia_w, 
			ie_agrupador_w, 
			nr_sequencia_diluicao_w, 
			nr_sequencia_solucao_w, 
			hr_prim_horario_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		select	padroniza_horario_prescr(ds_horarios, '00:00'), 
			ds_horarios, 
			dividir(qt_total_dispensar,nr_ocorrencia), 
			ie_agrupador, 
			nr_sequencia_diluicao 
		into STRICT	ds_horarios_w, 
			ds_horarios_dif_w, 
			qt_unitaria_w, 
			ie_agupador_w, 
			nr_sequencia_diluicao_w 
		from	prescr_material 
		where	nr_prescricao	= nr_prescricao_p 
		and	nr_sequencia	= nr_sequencia_w;
 
		if (ie_agrupador_w in (1,3,7,9)) then 
			if (ie_agupador_w in (3,7,9)) then 
				select	padroniza_horario_prescr(ds_horarios, '00:00'), 
					ds_horarios, 
					qt_total_dispensar, 
					nr_ocorrencia 
				into STRICT	ds_horarios_w, 
					ds_horarios_dif_w, 
					qt_total_dispensar_w, 
					nr_ocorrencia_w 
				from	prescr_material 
				where	nr_prescricao	= nr_prescricao_p 
				and	nr_sequencia	= nr_sequencia_diluicao_w;
			end if;
				 
			if (ie_agrupador_w = 9) then 
				qt_unitaria_w	:= dividir(qt_total_dispensar_w,nr_ocorrencia_w);
			end if;
					 
			if (coalesce(ds_horarios_w::text, '') = '') and (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then	 
				ds_horarios_w	:= hr_prim_horario_w||' ';
			elsif (coalesce(ds_horarios_w::text, '') = '') and (coalesce(hr_prim_horario_w::text, '') = '') then 
				ds_horarios_w	:= to_char(dt_primeiro_horario_w,'hh24:mi')||' ';
			end if;
 
			ds_horarios_w	:= replace(ds_horarios_w, 'A','');
			while	(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') LOOP 
				begin 
				select	position(' ' in ds_horarios_w) 
				into STRICT	k 
				;
				if (k > 1) and ((substr(ds_horarios_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_w, 1, k -1))::text <> '')) then 
					ds_hora_w		:= substr(ds_horarios_w, 1, k-1);
					ds_hora_w		:= replace(ds_hora_w, ' ','');
					ds_horarios_w		:= substr(ds_horarios_w, k + 1, 200);
				elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
					ds_hora_w 		:= replace(ds_horarios_w,' ','');
					ds_horarios_w		:= '';
				end if;
	 
				if (hr_ter_turno_w IS NOT NULL AND hr_ter_turno_w::text <> '') and 
					((ds_hora_w >= hr_ter_turno_w) or (ds_hora_w < hr_prim_turno_w)) then 
					qt_noite_w	:= qt_noite_w + qt_unitaria_w;
				elsif (hr_seg_turno_w IS NOT NULL AND hr_seg_turno_w::text <> '') and (ds_hora_w >= hr_seg_turno_w) and (ds_hora_w < coalesce(hr_ter_turno_w,'99999')) then 
					qt_tarde_w	:= qt_tarde_w + qt_unitaria_w;
				elsif (hr_prim_turno_w IS NOT NULL AND hr_prim_turno_w::text <> '') and (ds_hora_w IS NOT NULL AND ds_hora_w::text <> '') then 
					qt_manha_w	:= qt_manha_w + qt_unitaria_w;
				end if;
			 
				qt_flag_w	:= qt_flag_w + 1;
				if (qt_flag_w > 30) then	 
					ds_horarios_w	:= '';
				end if;
				end;
			END LOOP;
			 
		end if;
 
		if (ie_agrupador_w = 2) then 
						 
			if (coalesce(ds_horarios_w::text, '') = '') and (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then	 
				ds_horarios_w	:= hr_prim_horario_w||' ';
			elsif (coalesce(ds_horarios_w::text, '') = '') and (coalesce(hr_prim_horario_w::text, '') = '') then 
				ds_horarios_w	:= to_char(dt_primeiro_horario_w,'hh24:mi')||' ';
			end if;
 
			ds_horarios_w	:= replace(ds_horarios_w, 'A','');
			while	(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') LOOP 
				begin 
				select	position(' ' in ds_horarios_w) 
				into STRICT	k 
				;
				if (k > 1) and ((substr(ds_horarios_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_w, 1, k -1))::text <> '')) then 
					ds_hora_w		:= substr(ds_horarios_w, 1, k-1);
					ds_hora_w		:= replace(ds_hora_w, ' ','');
					ds_horarios_w		:= substr(ds_horarios_w, k + 1, 200);
				elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
					ds_hora_w 		:= replace(ds_horarios_w,' ','');
					ds_horarios_w		:= '';
				end if;
	 
				if (hr_ter_turno_w IS NOT NULL AND hr_ter_turno_w::text <> '') and 
					((ds_hora_w >= hr_ter_turno_w) or (ds_hora_w < hr_prim_turno_w)) then 
					qt_noite_w	:= qt_noite_w + qt_unitaria_w;
				elsif (hr_seg_turno_w IS NOT NULL AND hr_seg_turno_w::text <> '') and (ds_hora_w >= hr_seg_turno_w) and (ds_hora_w < coalesce(hr_ter_turno_w,'99999')) then 
					qt_tarde_w	:= qt_tarde_w + qt_unitaria_w;
				elsif (hr_prim_turno_w IS NOT NULL AND hr_prim_turno_w::text <> '') and (ds_hora_w IS NOT NULL AND ds_hora_w::text <> '') then 
					qt_manha_w	:= qt_manha_w + qt_unitaria_w;
				end if;
			 
				qt_flag_w	:= qt_flag_w + 1;
				if (qt_flag_w > 30) then	 
					ds_horarios_w	:= '';
				end if;
				end;
			END LOOP;
			 
		end if;
 
		if (ie_agrupador_w	= 4) then 
 
			select	hr_prim_horario, 
				ds_horarios 
			into STRICT	hr_prim_horario_sol_w, 
				ds_horarios_w 
			from	prescr_solucao 
			where	nr_prescricao	= nr_prescricao_p 
			and	nr_seq_solucao	= nr_sequencia_solucao_w;
 
			if (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
				ds_horarios_w	:= ds_horarios_w ||' ';
			end if;
 
			while	(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') LOOP 
				begin 
				select	position('das' in ds_horarios_w) 
				into STRICT	k 
				;
				if (k > 0) then 
					ds_horarios_w		:= substr(ds_horarios_w, k + 4, 255);
					select	position(' ' in ds_horarios_w) 
					into STRICT	y 
					;
					ds_hora_w		:= substr(ds_horarios_w, 1, y-1);
					ds_hora_w		:= replace(ds_hora_w, ' ','');
					ds_horarios_w		:= substr(ds_horarios_w, y + 1, 200);
				elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
					ds_hora_w 		:= replace(ds_horarios_w,' ','');
					ds_horarios_w		:= '';
				end if;
 
				if (position(':' in ds_hora_w) = 0) then 
					ds_hora_w	:= ds_hora_w||':00';
				end if;
	 
				if (hr_ter_turno_w IS NOT NULL AND hr_ter_turno_w::text <> '') and 
					((ds_hora_w >= hr_ter_turno_w) or (ds_hora_w < hr_prim_turno_w)) then 
					qt_noite_w	:= qt_noite_w + qt_unitaria_w;
				elsif (hr_seg_turno_w IS NOT NULL AND hr_seg_turno_w::text <> '') and (ds_hora_w >= hr_seg_turno_w) and (ds_hora_w < coalesce(hr_ter_turno_w,'99999')) then 
					qt_tarde_w	:= qt_tarde_w + qt_unitaria_w;
				elsif (hr_prim_turno_w IS NOT NULL AND hr_prim_turno_w::text <> '') and (ds_hora_w IS NOT NULL AND ds_hora_w::text <> '') then 
					qt_manha_w	:= qt_manha_w + qt_unitaria_w;
				end if;
			 
				qt_flag_w	:= qt_flag_w + 1;
				if (qt_flag_w > 30) then	 
					ds_horarios_w	:= '';
				end if;
				select	position('das' in ds_horarios_w) 
				into STRICT	k 
				;
				if (k = 0) then 
					ds_horarios_w	:= '';
				end if;
				end;
			END LOOP;			
 
		end if;
 
		if (ie_agrupador_w = 6) then 
			 
			ds_hora_w	:= to_char(dt_primeiro_horario_w,'hh24:mi:ss');
	 
			if (hr_ter_turno_w IS NOT NULL AND hr_ter_turno_w::text <> '') and 
				((ds_hora_w >= hr_ter_turno_w) or (ds_hora_w < hr_prim_turno_w)) then 
				qt_noite_w	:= qt_noite_w + qt_unitaria_w;
			elsif (hr_seg_turno_w IS NOT NULL AND hr_seg_turno_w::text <> '') and (ds_hora_w >= hr_seg_turno_w) and (ds_hora_w < coalesce(hr_ter_turno_w,'99999')) then 
				qt_tarde_w	:= qt_tarde_w + qt_unitaria_w;
			elsif (hr_prim_turno_w IS NOT NULL AND hr_prim_turno_w::text <> '') and (ds_hora_w IS NOT NULL AND ds_hora_w::text <> '') then 
				qt_manha_w	:= qt_manha_w + qt_unitaria_w;
			end if;
		end if;
 
		if (ie_agrupador_w	= 8) then 
			if (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
				ds_horarios_w	:= ds_horarios_w ||' ';
			end if;
			 
 
			if (position('das' in ds_horarios_dif_w) > 0) then 
 
				ds_horarios_w	:= ds_horarios_dif_w ||' ';
			 
				while	(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') LOOP 
					begin 
					select	position('das' in ds_horarios_w) 
					into STRICT	k 
					;
					if (k > 0) then 
						ds_horarios_w		:= substr(ds_horarios_w, k + 4, 255);
						select	position(' ' in ds_horarios_w) 
						into STRICT	y 
						;
						ds_hora_w		:= substr(ds_horarios_w, 1, y-1);
						ds_hora_w		:= replace(ds_hora_w, ' ','');
						ds_horarios_w		:= substr(ds_horarios_w, y + 1, 200);
					elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
						ds_hora_w 		:= replace(ds_horarios_w,' ','');
						ds_horarios_w		:= '';
					end if;
	 
					if (position(':' in ds_hora_w) = 0) then 
						ds_hora_w	:= ds_hora_w||':00';
					end if;
		 
					if (hr_ter_turno_w IS NOT NULL AND hr_ter_turno_w::text <> '') and 
						((ds_hora_w >= hr_ter_turno_w) or (ds_hora_w < hr_prim_turno_w)) then 
						qt_noite_w	:= qt_noite_w + qt_unitaria_w;
					elsif (hr_seg_turno_w IS NOT NULL AND hr_seg_turno_w::text <> '') and (ds_hora_w >= hr_seg_turno_w) and (ds_hora_w < coalesce(hr_ter_turno_w,'99999')) then 
						qt_tarde_w	:= qt_tarde_w + qt_unitaria_w;
					elsif (hr_prim_turno_w IS NOT NULL AND hr_prim_turno_w::text <> '') and (ds_hora_w IS NOT NULL AND ds_hora_w::text <> '') then 
						qt_manha_w	:= qt_manha_w + qt_unitaria_w;
					end if;
				 
					qt_flag_w	:= qt_flag_w + 1;
					if (qt_flag_w > 30) then	 
						ds_horarios_w	:= '';
					end if;
					select	position('das' in ds_horarios_w) 
					into STRICT	k 
					;
					if (k = 0) then 
						ds_horarios_w	:= '';
					end if;
					end;
				END LOOP;
			elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
 
				ds_horarios_w	:= replace(ds_horarios_w, 'A','');
				ds_horarios_w	:= ds_horarios_w|| ' ';
 
				while	(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') LOOP 
					begin 
					select	position(' ' in ds_horarios_w) 
					into STRICT	k 
					;
					if (k > 1) and ((substr(ds_horarios_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_w, 1, k -1))::text <> '')) then 
						ds_hora_w		:= substr(ds_horarios_w, 1, k-1);
						ds_hora_w		:= replace(ds_hora_w, ' ','');
						ds_horarios_w		:= substr(ds_horarios_w, k + 1, 200);
					elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
						ds_hora_w 		:= replace(ds_horarios_w,' ','');
						ds_horarios_w		:= '';
					end if;
	 
					if (hr_ter_turno_w IS NOT NULL AND hr_ter_turno_w::text <> '') and 
						((ds_hora_w >= hr_ter_turno_w) or (ds_hora_w < hr_prim_turno_w)) then 
						qt_noite_w	:= qt_noite_w + qt_unitaria_w;
					elsif (hr_seg_turno_w IS NOT NULL AND hr_seg_turno_w::text <> '') and (ds_hora_w >= hr_seg_turno_w) and (ds_hora_w < coalesce(hr_ter_turno_w,'99999')) then 
						qt_tarde_w	:= qt_tarde_w + qt_unitaria_w;
					elsif (hr_prim_turno_w IS NOT NULL AND hr_prim_turno_w::text <> '') and (ds_hora_w IS NOT NULL AND ds_hora_w::text <> '') then 
						qt_manha_w	:= qt_manha_w + qt_unitaria_w;
					end if;
				 
					qt_flag_w	:= qt_flag_w + 1;
					if (qt_flag_w > 30) then	 
						ds_horarios_w	:= '';
					end if;
					end;
				END LOOP;			
			end if;
		end if;
		 
		if (ie_agrupador_w	= 5) then 
			 
			ds_horarios_w	:= replace(ds_horarios_w, 'A','');
			while	(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') LOOP 
				begin 
				select	position(' ' in ds_horarios_w) 
				into STRICT	k 
				;
				if (k > 1) and ((substr(ds_horarios_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_w, 1, k -1))::text <> '')) then 
					ds_hora_w		:= substr(ds_horarios_w, 1, k-1);
					ds_hora_w		:= replace(ds_hora_w, ' ','');
					ds_horarios_w		:= substr(ds_horarios_w, k + 1, 200);
				elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
					ds_hora_w 		:= replace(ds_horarios_w,' ','');
					ds_horarios_w		:= '';
				end if;
	 
				if (hr_ter_turno_w IS NOT NULL AND hr_ter_turno_w::text <> '') and 
					((ds_hora_w >= hr_ter_turno_w) or (ds_hora_w < hr_prim_turno_w)) then 
					qt_noite_w	:= qt_noite_w + qt_unitaria_w;
				elsif (hr_seg_turno_w IS NOT NULL AND hr_seg_turno_w::text <> '') and (ds_hora_w >= hr_seg_turno_w) and (ds_hora_w < coalesce(hr_ter_turno_w,'99999')) then 
					qt_tarde_w	:= qt_tarde_w + qt_unitaria_w;
				elsif (hr_prim_turno_w IS NOT NULL AND hr_prim_turno_w::text <> '') and (ds_hora_w IS NOT NULL AND ds_hora_w::text <> '') then 
					qt_manha_w	:= qt_manha_w + qt_unitaria_w;
				end if;
			 
				qt_flag_w	:= qt_flag_w + 1;
				if (qt_flag_w > 30) then	 
					ds_horarios_w	:= '';
				end if;
				end;
			END LOOP;
		end if;
			 
		end;
	END LOOP;
	CLOSE C01;	
 
end if;
 
qt_tarde_w	:= round((qt_tarde_w)::numeric,1);
qt_noite_w	:= round((qt_noite_w)::numeric,1);
qt_manha_w	:= round((qt_manha_w)::numeric,1);
 
qt_exedente_w	:= mod(qt_tarde_w,1);
 
if (qt_exedente_w > 0) then 
	qt_tarde_w	:= trunc(qt_tarde_w) +1;
	qt_sobra_w	:= 1 - qt_exedente_w;
end if;	
 
if (qt_noite_w > 0) then 
	qt_exedente_w	:= mod(qt_noite_w,1);
 
	if (qt_sobra_w >= qt_exedente_w) then 
		qt_noite_w	:= trunc(qt_noite_w);	
	else 
		qt_noite_w	:= trunc(qt_noite_w) + 1;
		qt_sobra_w	:= qt_sobra_w + 1 - qt_exedente_w;
	end if;
end if;
 
if (qt_sobra_w > 0) then 
	qt_manha_w	:= trunc(qt_manha_w);
elsif (qt_manha_w > 0) and (qt_sobra_w = 0) then 
	qt_manha_w	:= trunc(qt_manha_w);
elsif (qt_manha_w > 0) then 
	qt_manha_w	:= trunc(qt_manha_w) + 1;
end if;
 
if (ie_turno_p = 1) then 
	ds_retorno_w	:= wheb_mensagem_pck.get_texto(309282) || ' '||qt_manha_w; -- Manh√£ 
elsif (ie_turno_p = 2) then
	ds_retorno_w	:= wheb_mensagem_pck.get_texto(309281) || ' '||qt_tarde_w; -- Tarde 
elsif (ie_turno_p = 3) then
	ds_retorno_w	:= wheb_mensagem_pck.get_texto(309280) || ' '||qt_noite_w; -- Noite 
end if;
ds_retorno_w	:= replace(ds_retorno_w,' .',' 0,');
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_quant_medic_turno_sep (nr_prescricao_p bigint, cd_material_p bigint, ie_turno_p bigint) FROM PUBLIC;

