-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_idade_gest_semana ( nr_atendimento_p bigint) RETURNS bigint AS $body$
DECLARE

  QT_SEM_IG_CRONOLOGICA_w real;
  dt_ult_mes_histo        timestamp;
  qt_sema_histo HISTORICO_SAUDE_MULHER.QT_SEM_IG_CRONOLOGICA%type;
  dt_ult_mes_gravi timestamp;
  qt_sema_gravi ATENDIMENTO_GRAVIDEZ.QT_IG_SEMANA%type;
  dt_ult_mes_pac timestamp;
  qt_sema_pac atendimento_paciente.QT_IG_SEMANA%type;

BEGIN
  SELECT MAX(DT_ULTIMA_MENSTRUACAO),
    MAX(QT_IG_SEMANA)
  INTO STRICT dt_ult_mes_pac,
    qt_sema_pac
  FROM atendimento_paciente
  WHERE IE_PACIENTE_GRAVIDA = 'S'
  AND nr_atendimento        = nr_atendimento_p;
  SELECT MAX(DT_ULTIMA_MENSTRUACAO),
    MAX(QT_IG_SEMANA)
  INTO STRICT dt_ult_mes_gravi,
    qt_sema_gravi
  FROM ATENDIMENTO_GRAVIDEZ
  WHERE IE_PAC_GRAVIDA = 'S'
  AND IE_SITUACAO      = 'A'
  AND (DT_LIBERACAO IS NOT NULL AND DT_LIBERACAO::text <> '')
  AND nr_atendimento   = nr_atendimento_p;
  SELECT MAX(DT_ULT_MENSTRUACAO),
    MAX(QT_SEM_IG_CRONOLOGICA)
  INTO STRICT dt_ult_mes_histo,
    qt_sema_histo
  FROM HISTORICO_SAUDE_MULHER
  WHERE IE_PAC_GRAVIDA = 'S'
  AND cd_pessoa_fisica =
    (SELECT MAX(cd_pessoa_fisica)
    FROM atendimento_paciente
    WHERE nr_atendimento = nr_atendimento_p
    );
  IF (dt_ult_mes_histo IS NOT NULL AND dt_ult_mes_histo::text <> '') THEN
    QT_SEM_IG_CRONOLOGICA_w := TRUNC(dividir((TRUNC(clock_timestamp()) - TRUNC(dt_ult_mes_histo)),7));
    IF (qt_sema_histo IS NOT NULL AND qt_sema_histo::text <> '') THEN
      QT_SEM_IG_CRONOLOGICA_w := qt_sema_pac;
    END IF;
  END IF;
IF (dt_ult_mes_gravi IS NOT NULL AND dt_ult_mes_gravi::text <> '') THEN
  QT_SEM_IG_CRONOLOGICA_w := TRUNC(dividir((TRUNC(clock_timestamp()) - TRUNC(dt_ult_mes_gravi)),7));
  IF (qt_sema_gravi IS NOT NULL AND qt_sema_gravi::text <> '') THEN
    QT_SEM_IG_CRONOLOGICA_w := qt_sema_gravi;
  END IF;
END IF;
IF (dt_ult_mes_pac IS NOT NULL AND dt_ult_mes_pac::text <> '') THEN
  QT_SEM_IG_CRONOLOGICA_w := TRUNC(dividir((TRUNC(clock_timestamp()) - TRUNC(dt_ult_mes_pac)),7));
  IF (qt_sema_pac IS NOT NULL AND qt_sema_pac::text <> '') THEN
    QT_SEM_IG_CRONOLOGICA_w := qt_sema_pac;
  END IF;
END IF;
RETURN QT_SEM_IG_CRONOLOGICA_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_idade_gest_semana ( nr_atendimento_p bigint) FROM PUBLIC;

