-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_info_cid_doenca ( cd_doenca_p text, nr_atendimento_p bigint, dt_diagnostico_p timestamp, ds_campo_p text ) RETURNS varchar AS $body$
DECLARE

-- Atributos
ds_cid_doenca_w			varchar(255);
ds_retorno_w			varchar(4000);
indicador				integer := 0;
ds_cid_doenca_adic_w	varchar(400);
cid_doenca_adic_info_w  varchar(400);
ie_situacao_w			diagnostico_doenca.ie_situacao%type;

-- Cursores
c01 CURSOR FOR
	SELECT	obter_desc_cid(cd_doenca) ds_cid_doenca_adic,
			cd_doenca
	from	diagnostico_doenca
	where	cd_doenca_superior = cd_doenca_p
	and		dt_diagnostico = dt_diagnostico_p
	and		nr_atendimento = nr_atendimento_p;
-- Functions
	function add_span_adic_info(ds_informacao_p	text, ds_style_adic_p text) return  text is
	ds_span_w	varchar(4000);
	
BEGIN
		select	coalesce(max(ie_situacao),'A')
		into STRICT	ie_situacao_w
		from	diagnostico_doenca
		where	cd_doenca_superior = cd_doenca_p
		and		dt_diagnostico = dt_diagnostico_p
		and		nr_atendimento = nr_atendimento_p
		and		(dt_inativacao IS NOT NULL AND dt_inativacao::text <> '');
		
		if (ie_situacao_w = 'A') then
			if ((trim(both ds_informacao_p) IS NOT NULL AND (trim(both ds_informacao_p))::text <> '')) then
				begin
				ds_span_w	:= '<span class=''cid-doenca-adic-info '''||ds_style_adic_p||'> '||ds_informacao_p||'</span>';
				end;
			end if;
		else
			if ((trim(both ds_informacao_p) IS NOT NULL AND (trim(both ds_informacao_p))::text <> '')) then
				begin
				ds_span_w	:= '<span class=''inactive-cid-doenca-adic-info '''||ds_style_adic_p||'> '||ds_informacao_p||'</span>';
				end;
			end if;
		end if;
		return ds_span_w;

	end;

	function bold( ds_valor_p varchar2) return varchar2 is
	begin
		return '<strong>' ||ds_valor_p||'</strong>';
	end;
	
	function add_span(ds_informacao_p	varchar2, ds_style_adic_p varchar2) return varchar2 is
	ds_span_w	varchar2(2000);
	begin
		select	coalesce(max(ie_situacao),'A')
		into STRICT	ie_situacao_w
		from	diagnostico_doenca
		where	cd_doenca = cd_doenca_p
		and		dt_diagnostico = dt_diagnostico_p
		and		nr_atendimento = nr_atendimento_p
		and		(dt_inativacao IS NOT NULL AND dt_inativacao::text <> '');
		
		if (ie_situacao_w = 'A') then
			if ((trim(both ds_informacao_p) IS NOT NULL AND (trim(both ds_informacao_p))::text <> '')) then
				begin
				ds_span_w	:= '<span class=''ds-cid-doenca-adic '''||ds_style_adic_p||'> '||ds_informacao_p||'</span>';
				end;
			end if;
		else
			if ((trim(both ds_informacao_p) IS NOT NULL AND (trim(both ds_informacao_p))::text <> '')) then
				begin
				ds_span_w	:= '<span class=''inactive-ds-cid-doenca-adic '''||ds_style_adic_p||'> '||ds_informacao_p||'</span>';
				end;
			end if;
		end if;
		return ds_span_w;
	end;
-- Main
begin
	-- Descricao do CID
	if (ds_campo_p = 'DS_CID_DOENCA') then
		if (cd_doenca_p IS NOT NULL AND cd_doenca_p::text <> '') then
			select	obter_desc_cid(cd_doenca_p)
			into STRICT	ds_cid_doenca_w
			;
		
			ds_retorno_w :=	add_span(bold(ds_cid_doenca_w),'');
			
			for r_c01_w in c01 loop
				begin
				ds_retorno_w := ds_retorno_w || '<br>' || add_span_adic_info(r_c01_w.ds_cid_doenca_adic,'');
				end;
			end loop;
		end if;
	
	-- Codigo do CID
	elsif (ds_campo_p = 'DS_DOENCA') then
		if (cd_doenca_p IS NOT NULL AND cd_doenca_p::text <> '') then
		
			ds_retorno_w :=	add_span(bold(cd_doenca_p),'');
			
			for r_c01_w in c01 loop
				begin
				if (indicador = 0) then
					ds_retorno_w := ds_retorno_w || '+' || '<br>' || add_span_adic_info(r_c01_w.cd_doenca,'');
					indicador :=1;
				else
					ds_retorno_w := ds_retorno_w || '<br>' || add_span_adic_info(r_c01_w.cd_doenca,'');
				end if;
				end;
			end loop;
		end if;
    elsif (ds_campo_p = 'DS_CID_COMPLETO') then
		if (cd_doenca_p IS NOT NULL AND cd_doenca_p::text <> '') then
            ds_cid_doenca_adic_w := ' style="color: #333333;
                    opacity: 1;
                    font-size: 14px;
                    font-family: '|| CHR(09) ||'CentraleSansCndBook'|| CHR(09) ||'"';

            cid_doenca_adic_info_w := ' style="color: #333333;
                                    opacity: 1;
                                    font-size: 14px;
                                    font-family: '|| CHR(09) ||'CentraleSansCndBook' || CHR(09) || ';
                                    font-style: italic;
                                    margin-left: 4px;"';

			select	substr(cd_doenca_p ||(  select coalesce(max('+'), '') 
                                            from    diagnostico_doenca h 
                                            where   h.cd_doenca_superior = cd_doenca_p
                                            and		dt_diagnostico = dt_diagnostico_p
                                            and	h.dt_diagnostico = dt_diagnostico_p) || ' - ' || obter_desc_cid(cd_doenca_p),1,200)
			into STRICT	ds_cid_doenca_w
			;

            ds_retorno_w :=	add_span(ds_cid_doenca_w, ds_cid_doenca_adic_w);
			
			for r_c01_w in c01 loop
				begin
				ds_retorno_w := ds_retorno_w || '<br>'
                    || add_span_adic_info(('&' || 'nbsp;' || r_c01_w.cd_doenca || ' - ' || r_c01_w.ds_cid_doenca_adic), cid_doenca_adic_info_w);
				end;
			end loop;
		end if;
	elsif (ds_campo_p = 'DS_LISTA_DOENCAS_LOC') then
		if (cd_doenca_p IS NOT NULL AND cd_doenca_p::text <> '') then
			for r_c01_w in c01 loop
				begin
				ds_retorno_w := ds_retorno_w || r_c01_w.cd_doenca || ',';
				end;
			end loop;
		end if;
	end if;
	return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_info_cid_doenca ( cd_doenca_p text, nr_atendimento_p bigint, dt_diagnostico_p timestamp, ds_campo_p text ) FROM PUBLIC;

