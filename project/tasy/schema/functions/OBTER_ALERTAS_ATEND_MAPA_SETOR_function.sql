-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_alertas_atend_mapa_setor ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ie_alerta_w				varchar(1);
ds_alerta_w				varchar(4000);
ds_retorno_w			varchar(4000);
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
dt_nascimento_w			pessoa_fisica.dt_nascimento%type;
cd_setor_atendimento_w	setor_atendimento.cd_setor_atendimento%type;
qt_hora_pend_prescr_w	bigint;
ds_meta_w				varchar(4000);
dt_prescricao_w			prescr_medica.dt_prescricao%type;
nr_prescricao_w			prescr_medica.nr_prescricao%type;
nr_seq_exame_w			prescr_procedimento.nr_seq_exame%type;
ds_procedimento_w		varchar(120);
ds_item_w				varchar(4000);
ds_tipo_item_w			varchar(50);
cd_item_w				bigint;
ds_alerta_icon_w		varchar(2000);
dt_alerta_icon_w		timestamp;
dt_solicitacao_w		timestamp;
dt_prevista_w			timestamp;
ds_status_w				varchar(20);
ds_tipo_acomodacao_w	varchar(40);
ds_setor_desejado_w		varchar(100);
cd_unidade_desejada_w	varchar(25);
dt_resultado_w			timestamp;
ds_exame_w				varchar(255);
nm_medico_w				varchar(60);
ds_resultado_exame_w	varchar(255);
qt_exame_critico_w		bigint;
ie_visualizacao_icon_w	varchar(1);
ie_pac_mr_w				varchar(5);
ie_pac_isol_w			varchar(5);
nr_seq_regra_w			regra_perm_panorama.nr_sequencia%type;
ds_lista_icones_lib_w	varchar(255) := '';
ie_allow_free_text_w	tipo_alerta_atend.ie_allow_free_text%type;
nr_seq_alerta_w			atendimento_alerta.nr_seq_alerta%type;
nr_seq_tipo_alerta_w	atendimento_alerta.nr_seq_tipo_alerta%type;
ds_alerta_ww			varchar(4000);
ds_objetivo_jejum_w		varchar(255);
ds_tipo_jejum_w			varchar(255);
ie_labr_w				varchar(1);
ds_protocolos_w         varchar(255);

C02 CURSOR FOR
	SELECT	b.dt_prescricao,
		b.nr_prescricao,
		c.nr_seq_exame,
		substr(p.ds_procedimento,1,120) ds_procedimento
	from	atendimento_paciente a,
		prescr_medica b,
		procedimento p,
		exame_laboratorio z,
		prescr_procedimento c
		left outer join proc_interno w on w.nr_sequencia = c.nr_seq_proc_interno
	where	a.nr_atendimento = nr_atendimento_p
	and	a.nr_atendimento = b.nr_atendimento
	and	b.nr_prescricao = c.nr_prescricao
	and	p.cd_procedimento = c.cd_procedimento
	and	p.ie_origem_proced = c.ie_origem_proced
	and	z.nr_seq_exame = c.nr_seq_exame
	and	b.dt_prescricao > clock_timestamp() - interval '2 days'
	and	c.ie_suspenso = 'N'
	and	(c.nr_seq_exame IS NOT NULL AND c.nr_seq_exame::text <> '')
	and	coalesce(c.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(c.nr_seq_derivado::text, '') = ''
	and	coalesce(c.nr_seq_exame_sangue::text, '') = ''
	and	((coalesce(w.nr_sequencia::text, '') = ''
			and coalesce(c.nr_seq_proc_interno::text, '') = '') or ((w.nr_sequencia IS NOT NULL AND w.nr_sequencia::text <> '')
			and	(c.nr_seq_proc_interno IS NOT NULL AND c.nr_seq_proc_interno::text <> '')
			and	coalesce(c.nr_seq_prot_glic::text, '') = ''
			and	coalesce(c.nr_seq_origem::text, '') = ''
			and	coalesce(w.ie_tipo,'O') not in ('G','BS')
			and	coalesce(w.ie_ivc,'N') <> 'S'))
	and	exists (	SELECT	1
				from	prescr_proc_hor d
				where	c.nr_prescricao = d.nr_prescricao
				and	c.nr_sequencia = d.nr_seq_procedimento
				and	coalesce(d.dt_fim_horario::text, '') = ''
				and	coalesce(d.ie_situacao,'A') = 'A'  LIMIT 1)
	and	adep_obter_regra_inclusao('LAB', b.cd_estabelecimento, b.cd_setor_atendimento, b.cd_perfil_ativo, null, p.cd_procedimento, p.ie_origem_proced, c.nr_seq_proc_interno, b.cd_Setor_atendimento,c.cd_Setor_atendimento, b.nr_prescricao, c.nr_seq_exame) = 'S';

C03 CURSOR FOR
	SELECT	b.dt_prescricao,
		b.nr_prescricao,
		c.nr_seq_exame,
		substr(p.ds_procedimento,1,120) ds_procedimento
	from	atendimento_paciente a,
		prescr_medica b,
		procedimento p,
		exame_laboratorio z,
		prescr_procedimento c
		left outer join proc_interno w on w.nr_sequencia = c.nr_seq_proc_interno
	where	a.nr_atendimento = nr_atendimento_p
	and	a.nr_atendimento = b.nr_atendimento
	and	b.nr_prescricao = c.nr_prescricao
	and	p.cd_procedimento = c.cd_procedimento
	and	p.ie_origem_proced = c.ie_origem_proced
	and	z.nr_seq_exame = c.nr_seq_exame
	and	b.dt_prescricao > clock_timestamp() - interval '2 days'
	and	c.ie_suspenso = 'N'
	and	(c.nr_seq_exame IS NOT NULL AND c.nr_seq_exame::text <> '')
	and	coalesce(c.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(c.nr_seq_derivado::text, '') = ''
	and	coalesce(c.nr_seq_exame_sangue::text, '') = ''
	and	c.ie_amostra = 'N'
	and	c.ie_status_atend <> 20
	and	c.cd_motivo_baixa = 0
	and	((coalesce(w.nr_sequencia::text, '') = ''
			and coalesce(c.nr_seq_proc_interno::text, '') = '') or ((w.nr_sequencia IS NOT NULL AND w.nr_sequencia::text <> '')
			and	(c.nr_seq_proc_interno IS NOT NULL AND c.nr_seq_proc_interno::text <> '')
			and	coalesce(c.nr_seq_prot_glic::text, '') = ''
			and	coalesce(c.nr_seq_origem::text, '') = ''
			and	coalesce(w.ie_tipo,'O') not in ('G','BS')
			and	coalesce(w.ie_ivc,'N') <> 'S'))
	and	exists (	SELECT	1
				from	prescr_proc_hor d
				where	c.nr_prescricao = d.nr_prescricao
				and	c.nr_sequencia = d.nr_seq_procedimento
				and	coalesce(d.dt_fim_horario::text, '') = ''
				and	coalesce(d.ie_situacao,'A') = 'A'  LIMIT 1)
	and	adep_obter_regra_inclusao('LAB', b.cd_estabelecimento, b.cd_setor_atendimento, b.cd_perfil_ativo, null, p.cd_procedimento, p.ie_origem_proced, c.nr_seq_proc_interno, b.cd_Setor_atendimento,c.cd_Setor_atendimento, b.nr_prescricao, c.nr_seq_exame) = 'N';

C04 CURSOR FOR
	SELECT	b.nr_prescricao,
		c.nr_seq_solucao cd_item,
		c.ds_solucao ds_item
	from	atendimento_paciente a,
		prescr_medica b,
		prescr_solucao c
	where	a.nr_atendimento = nr_atendimento_p
	and	a.nr_atendimento = b.nr_atendimento
	and	c.nr_prescricao = b.nr_prescricao
	and	b.dt_prescricao > clock_timestamp() - interval '2 days'
	and	c.ie_suspenso = 'S'
	and	Obter_se_prescr_vigente(b.nr_prescricao) = 'S'
	and	(c.dt_suspensao > coalesce((	SELECT	max(x.dt_atualizacao)
					from	panorama_icone_click x
					where	x.nr_atendimento = nr_atendimento_p
					and	x.cd_icone_panorama = 6),
					c.dt_suspensao-1));

C05 CURSOR FOR
	SELECT	b.nr_prescricao,
		m.cd_material cd_item,
		m.ds_material ds_item
	from	atendimento_paciente a,
		prescr_medica b,
		prescr_material c,
		material m
	where	a.nr_atendimento = nr_atendimento_p
	and	a.nr_atendimento = b.nr_atendimento
	and	b.nr_prescricao = c.nr_prescricao
	and	m.cd_material = c.cd_material
	and	b.dt_prescricao > clock_timestamp() - interval '2 days'
	and	c.ie_suspenso = 'S'
	and	c.ie_agrupador not in (3,4,7,9)
	and	coalesce(c.nr_seq_kit::text, '') = ''
	and	Obter_se_prescr_vigente(b.nr_prescricao) = 'S'
	and	(c.dt_suspensao > coalesce((	SELECT	max(x.dt_atualizacao)
					from	panorama_icone_click x
					where	x.nr_atendimento = nr_atendimento_p
					and	x.cd_icone_panorama = 13),
					c.dt_suspensao-1));

C06 CURSOR FOR
	SELECT	a.dt_alerta,
			a.ds_alerta,
			a.nr_seq_alerta,
			a.nr_seq_tipo_alerta
	from	atendimento_alerta a,
		atendimento_paciente b
	where	b.cd_pessoa_fisica = cd_pessoa_fisica_w
	and	a.nr_atendimento = b.nr_atendimento
	and	a.ie_situacao = 'A'
	and	((coalesce(a.dt_fim_alerta::text, '') = '') or (a.dt_fim_alerta >= trunc(clock_timestamp(),'dd')))
	and	obter_se_tipo_alerta_lib(a.nr_seq_tipo_alerta, null, cd_perfil_p)	= 'S' -- somente irá consistir o perfil, pois com o RabbitMQ não pode passar os demais parâmetros
	
union all

	SELECT	a.dt_alerta,
			a.ds_alerta,
			a.nr_seq_alerta,
			a.nr_seq_tipo_alerta
	from	alerta_paciente a
	where	a.cd_pessoa_fisica = cd_pessoa_fisica_w
	and	a.ie_situacao = 'A'
	and	((coalesce(a.dt_fim_alerta::text, '') = '') or (a.dt_fim_alerta >= trunc(clock_timestamp(),'dd')))
	and	obter_se_tipo_alerta_lib(a.nr_seq_tipo_alerta, null, cd_perfil_p)	= 'S' -- somente irá consistir o perfil, pois com o rabbitmq não pode passar os demais parâmetros
	order by 1, 2;

C07 CURSOR FOR
	SELECT	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795040) ds_tipo_item,
		'S' ie_labr
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao		= b.nr_prescricao
	and	b.cd_material		= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and	b.ie_agrupador		= 1
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--Materiais
	SELECT	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795043) ds_tipo_item,
		'S' ie_labr
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material 	= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and	b.ie_agrupador 		= 2
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	-- SNE
	select	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795044 ) ds_tipo_item,
		'S' ie_labr
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material 	= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and	b.ie_agrupador 		= 8
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--Sup. oral
	select	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795045) ds_tipo_item,
		'S' ie_labr
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material 	= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and	b.ie_agrupador 		= 12
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--Leites e derivados
	select	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795074) ds_tipo_item,
		'S' ie_labr
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material 	= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	(b.nr_seq_leite_deriv IS NOT NULL AND b.nr_seq_leite_deriv::text <> '')
	and	b.ie_agrupador 		= 16
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--NPT Adulto
	select	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795075) ds_tipo_item,
		'S' ie_labr
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material 	= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and	b.ie_agrupador 		= 10
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--NPT Adulto 2
	select	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795075) ||' 2' ds_tipo_item,
		'S' ie_labr
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material 	= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and	b.ie_agrupador 		= 11
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--Procedimentos
	select	a.nr_prescricao,
		x.cd_procedimento cd_item,
		substr(y.ds_procedimento,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795046) ds_tipo_item,
		'N' ie_labr
	from	procedimento y,
		prescr_procedimento x,
		prescr_medica a
	where	y.cd_procedimento = x.cd_procedimento
	and	y.ie_origem_proced = x.ie_origem_proced
	and	x.nr_prescricao = a.nr_prescricao
	and	coalesce(x.nr_seq_proc_interno::text, '') = ''
	and	coalesce(x.nr_seq_exame::text, '') = ''
	and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(x.nr_seq_derivado::text, '') = ''
	and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	coalesce(x.nr_Seq_origem::text, '') = ''
	and	coalesce(x.dt_suspensao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(x.ie_administrar,'S') = 'S'
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	select	a.nr_prescricao,
		x.cd_procedimento cd_item,
		substr(y.ds_procedimento,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795046) ds_tipo_item,
		'N' ie_labr
	from	procedimento y,
		proc_interno w,
		prescr_procedimento x,
		prescr_medica a
	where	y.cd_procedimento = x.cd_procedimento
	and	y.ie_origem_proced = x.ie_origem_proced
	and	w.nr_sequencia = x.nr_seq_proc_interno
	and	x.nr_prescricao = a.nr_prescricao
	and	coalesce(w.ie_tipo,'O') not in ('G','BS')
	and	coalesce(x.nr_Seq_origem::text, '') = ''
	and	coalesce(w.ie_ivc,'N') <> 'S'
	and	coalesce(w.ie_ctrl_glic,'NC') = 'NC'
	and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
	and	coalesce(x.nr_seq_prot_glic::text, '') = ''
	and	coalesce(x.ie_administrar,'S') = 'S'
	and	coalesce(x.nr_seq_exame::text, '') = ''
	and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(x.nr_seq_derivado::text, '') = ''
	and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	coalesce(x.dt_suspensao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--CIG
	select	a.nr_prescricao,
		x.cd_procedimento cd_item,
		substr(z.ds_expressao,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795048) ds_tipo_item,
		'N' ie_labr
	from	valor_dominio_v z,
		procedimento y,
		proc_interno w,
		prescr_procedimento x,
		prescr_medica a
	where	z.cd_dominio = 1903
	and	z.vl_dominio = w.ie_ctrl_glic
	and	y.cd_procedimento = x.cd_procedimento
	and	y.ie_origem_proced = x.ie_origem_proced
	and	w.nr_sequencia = x.nr_seq_proc_interno
	and	x.nr_prescricao = a.nr_prescricao
	and	coalesce(w.ie_tipo,'O') not in ('G','BS')
	and	coalesce(w.ie_ivc,'N') <> 'S'
	and	w.ie_ctrl_glic = 'CIG'
	and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
	and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(x.dt_suspensao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(x.nr_seq_derivado::text, '') = ''
	and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--CCG
	select	a.nr_prescricao,
		x.cd_procedimento cd_item,
		substr(z.ds_protocolo,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795049) ds_tipo_item,
		'N' ie_labr
	from	pep_protocolo_glicemia z,
		procedimento y,
		proc_interno w,
		prescr_procedimento x,
		prescr_medica a
	where	z.nr_sequencia = x.nr_seq_prot_glic
	and	y.cd_procedimento = x.cd_procedimento
	and	y.ie_origem_proced = x.ie_origem_proced
	and	w.nr_sequencia = x.nr_seq_proc_interno
	and	x.nr_prescricao = a.nr_prescricao
	and	coalesce(w.ie_tipo,'O') not in ('G','BS')
	and	coalesce(w.ie_ivc,'N') <> 'S'
	and	w.ie_ctrl_glic = 'CCG'
	and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
	and	(x.nr_seq_prot_glic IS NOT NULL AND x.nr_seq_prot_glic::text <> '')
	and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(x.nr_seq_derivado::text, '') = ''
	and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(x.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	-- Dieta oral
	select	a.nr_prescricao,
		b.cd_dieta cd_item,
		substr(obter_desc_dieta(cd_dieta),1,255) ds_item,
		wheb_mensagem_pck.get_texto(795050) ds_tipo_item,
		'S' ie_labr
	from	prescr_medica a,
		prescr_dieta b
	where	a.nr_prescricao 	= b.nr_prescricao
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--Solução
	select	a.nr_prescricao,
		b.nr_seq_solucao cd_item,
		substr(ds_solucao,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795051) ds_tipo_item,
		'S' ie_labr
	from	prescr_medica a,
		prescr_solucao b
	where	a.nr_prescricao 				= b.nr_prescricao
	and	coalesce(b.ie_hemodialise,'N') 	= 'N'
	and	coalesce(b.nr_seq_dialise::text, '') = ''
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 				= nr_atendimento_p
	
union

	--Gasoterapia
	select	a.nr_prescricao,
		b.nr_sequencia cd_item,
		substr(c.ds_gas, 1,255) ds_item,
		wheb_mensagem_pck.get_texto(795052) ds_tipo_item,
		'N' ie_labr
	from	prescr_medica a,
		prescr_gasoterapia b,
		gas c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.nr_seq_gas		= c.nr_sequencia
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--Hemoterapia
	select	a.nr_prescricao,
		x.cd_procedimento cd_item,
		CASE WHEN coalesce(x.nr_seq_exame_sangue::text, '') = '' THEN CASE WHEN coalesce(x.ie_util_hemocomponente::text, '') = '' THEN null  ELSE '('|| substr(obter_valor_dominio(2247,x.ie_util_hemocomponente),1,20) ||') ' END  || coalesce(z.ds_derivado,y.ds_procedimento)  ELSE substr(Obter_desc_san_exame(x.nr_seq_exame_sangue),1,255) END  || ' ' || substr(obter_interv_cuidados_hm(x.nr_prescricao, x.nr_sequencia, 'N'),1,255)  ds_item,
		wheb_mensagem_pck.get_texto(795053) ds_tipo_item,
		'S' ie_labr
	FROM procedimento y, prescr_medica a, prescr_procedimento x
LEFT OUTER JOIN san_derivado z ON (x.nr_seq_derivado = z.nr_sequencia)
WHERE y.cd_procedimento = x.cd_procedimento and y.ie_origem_proced = x.ie_origem_proced and x.nr_prescricao = a.nr_prescricao and coalesce(x.nr_seq_proc_interno::text, '') = '' and coalesce(x.nr_seq_exame::text, '') = '' and (x.nr_seq_solic_sangue IS NOT NULL AND x.nr_seq_solic_sangue::text <> '') and (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') and coalesce(a.dt_liberacao_farmacia::text, '') = '' and coalesce(a.dt_suspensao::text, '') = '' and coalesce(x.dt_suspensao::text, '') = '' and a.nr_atendimento = nr_atendimento_p
	
union

	select	a.nr_prescricao,
		x.cd_procedimento cd_item,
		substr(z.ds_derivado || ' ' || substr(obter_interv_cuidados_hm(x.nr_prescricao, x.nr_sequencia, 'S'),1,100),1,255) ds_item,
		wheb_mensagem_pck.get_texto(795053) ds_tipo_item,
		'S' ie_labr
	FROM procedimento y, proc_interno w, prescr_medica a, san_derivado z
LEFT OUTER JOIN prescr_procedimento x ON (z.nr_sequencia = x.nr_seq_derivado)
WHERE y.cd_procedimento = x.cd_procedimento and y.ie_origem_proced = x.ie_origem_proced and w.nr_sequencia = x.nr_seq_proc_interno and x.nr_prescricao = a.nr_prescricao and coalesce(w.ie_tipo,'O') not in ('G','BS') and coalesce(w.ie_ivc,'N') <> 'S' and coalesce(w.ie_ctrl_glic,'NC') = 'NC' and (x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '') and coalesce(x.nr_seq_prot_glic::text, '') = '' and coalesce(x.nr_seq_exame::text, '') = '' and (x.nr_seq_solic_sangue IS NOT NULL AND x.nr_seq_solic_sangue::text <> '') and (x.nr_seq_derivado IS NOT NULL AND x.nr_seq_derivado::text <> '') and coalesce(x.nr_seq_exame_sangue::text, '') = '' and (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') and coalesce(a.dt_liberacao_farmacia::text, '') = '' and coalesce(a.dt_suspensao::text, '') = '' and coalesce(x.dt_suspensao::text, '') = '' and a.nr_atendimento = nr_atendimento_p
	 
union

	--Recomendação
	select	a.nr_prescricao,
		b.cd_recomendacao cd_item,
		substr(coalesce(c.ds_tipo_recomendacao,coalesce(b.ds_recomendacao,' ')),1,255) ds_item,
		wheb_mensagem_pck.get_texto(795054) ds_tipo_item,
		'N' ie_labr
	FROM prescr_medica a, prescr_recomendacao b
LEFT OUTER JOIN tipo_recomendacao c ON (b.cd_recomendacao = c.cd_tipo_recomendacao)
WHERE a.nr_prescricao 			= b.nr_prescricao  and (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') and coalesce(a.dt_liberacao_farmacia::text, '') = '' and coalesce(a.dt_suspensao::text, '') = '' and coalesce(b.dt_suspensao::text, '') = '' and a.nr_atendimento 	= nr_atendimento_p
	 
union

	--Diálise
	select	a.nr_prescricao,
		x.nr_seq_solucao cd_item,
		substr(coalesce(obter_desc_prot_npt(x.nr_seq_protocolo),obter_prim_comp_sol(a.nr_prescricao,x.nr_seq_solucao)),1,255) ds_item,
		wheb_mensagem_pck.get_texto(795055) ds_tipo_item,
		'N' ie_labr
	from	hd_prescricao b,
		prescr_solucao x,
		prescr_medica a
	where	x.nr_prescricao 	= a.nr_prescricao
	and	b.nr_sequencia    	= x.nr_seq_dialise
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(x.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	--IVC
	
union

	select	a.nr_prescricao,
		x.cd_procedimento cd_item,
		substr(coalesce(w.ds_proc_exame,y.ds_procedimento),1,255) ds_item,
		wheb_mensagem_pck.get_texto(795058) ds_tipo_item,
		'N' ie_labr
	from	procedimento y,
		proc_interno w,
		prescr_procedimento x,
		prescr_medica a
	where	y.cd_procedimento = x.cd_procedimento
	and	y.ie_origem_proced = x.ie_origem_proced
	and	w.nr_sequencia = x.nr_seq_proc_interno
	and	x.nr_prescricao = a.nr_prescricao
	and	coalesce(w.ie_tipo,'O') not in ('G','BS')
	and	coalesce(w.ie_ivc,'N') = 'S'
	and	coalesce(x.nr_seq_origem::text, '') = ''
	and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
	and	coalesce(x.nr_seq_prot_glic::text, '') = ''
	and	coalesce(x.nr_seq_exame::text, '') = ''
	and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(x.nr_seq_derivado::text, '') = ''
	and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	coalesce(x.dt_suspensao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	order by nr_prescricao;

C08 CURSOR FOR
	SELECT	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795040) ds_tipo_item
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material 	= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and	b.ie_agrupador 		= 1
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--Materiais
	SELECT	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795043) ds_tipo_item
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material 	= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and	b.ie_agrupador 		= 2
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	-- SNE
	select	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795044) ds_tipo_item
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material 	= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and	b.ie_agrupador 		= 8
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--Sup. oral
	select	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795045) ds_tipo_item
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material 	= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and	b.ie_agrupador 		= 12
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--Leites e derivados
	select	a.nr_prescricao,
		b.cd_material cd_item,
		substr(c.ds_material,1,255) ds_item,
		wheb_mensagem_pck.get_texto(795074) ds_tipo_item
	from	prescr_medica a,
		prescr_material b,
		material c
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material 	= c.cd_material
	and	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and	coalesce(b.cd_kit_material::text, '') = ''
	and	coalesce(b.nr_sequencia_proc::text, '') = ''
	and	(b.nr_seq_leite_deriv IS NOT NULL AND b.nr_seq_leite_deriv::text <> '')
	and	b.ie_agrupador 		= 16
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(a.dt_liberacao::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.nr_atendimento 	= nr_atendimento_p
	
union

	--NPT Adulto
	select 	a.nr_prescricao,
			b.cd_material cd_item,
			substr(c.ds_material,1,255) ds_item,
			wheb_mensagem_pck.get_texto(795075) ds_tipo_item
	from   	prescr_medica a,
			prescr_material b,
			material c
	where  	a.nr_prescricao 	= b.nr_prescricao
	and	   	b.cd_material 	= c.cd_material
	and    	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and    	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	   	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and    	coalesce(b.cd_kit_material::text, '') = ''
	and		coalesce(b.nr_sequencia_proc::text, '') = ''
	and		coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and    	b.ie_agrupador 		= 10
	and	   	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	   	coalesce(a.dt_liberacao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(b.dt_suspensao::text, '') = ''
	and	   	a.nr_atendimento 	= nr_atendimento_p
	
union

	--NPT Adulto 2
	select 	a.nr_prescricao,
			b.cd_material cd_item,
			substr(c.ds_material,1,255) ds_item,
			wheb_mensagem_pck.get_texto(795075) || ' 2' ds_tipo_item
	from   	prescr_medica a,
			prescr_material b,
			material c
	where  	a.nr_prescricao 	= b.nr_prescricao
	and	   	b.cd_material 	= c.cd_material
	and    	coalesce(b.nr_sequencia_solucao::text, '') = ''
	and    	coalesce(b.nr_sequencia_dieta::text, '') = ''
	and	   	coalesce(b.nr_sequencia_diluicao::text, '') = ''
	and    	coalesce(b.cd_kit_material::text, '') = ''
	and		coalesce(b.nr_sequencia_proc::text, '') = ''
	and		coalesce(b.nr_seq_leite_deriv::text, '') = ''
	and    	b.ie_agrupador 		= 11
	and	   	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	   	coalesce(a.dt_liberacao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(b.dt_suspensao::text, '') = ''
	and	   	a.nr_atendimento 	= nr_atendimento_p
	
union

	--Procedimentos
	select	a.nr_prescricao,
			x.cd_procedimento cd_item,
			substr(y.ds_procedimento,1,255) ds_item,
			wheb_mensagem_pck.get_texto(795046) ds_tipo_item
	from	procedimento y,
			prescr_procedimento x,
			prescr_medica a
	where	y.cd_procedimento = x.cd_procedimento
	and		y.ie_origem_proced = x.ie_origem_proced
	and		x.nr_prescricao = a.nr_prescricao
	and		coalesce(x.nr_seq_proc_interno::text, '') = ''
	and		coalesce(x.nr_seq_exame::text, '') = ''
	and		coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and		coalesce(x.nr_seq_derivado::text, '') = ''
	and		coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and 	coalesce(x.nr_Seq_origem::text, '') = ''
	and 	coalesce(x.dt_suspensao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(x.ie_administrar,'S') = 'S'
	and	   	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	   	coalesce(a.dt_liberacao::text, '') = ''
	and	   	a.nr_atendimento 	= nr_atendimento_p
	
union

	select	a.nr_prescricao,
			x.cd_procedimento cd_item,
			substr(y.ds_procedimento,1,255) ds_item,
			wheb_mensagem_pck.get_texto(795046) ds_tipo_item
	from	procedimento y,
			proc_interno w,
			prescr_procedimento x,
			prescr_medica a
	where	y.cd_procedimento = x.cd_procedimento
	and		y.ie_origem_proced = x.ie_origem_proced
	and		w.nr_sequencia = x.nr_seq_proc_interno
	and		x.nr_prescricao = a.nr_prescricao
	and		coalesce(w.ie_tipo,'O') not in ('G','BS')
	and 	coalesce(x.nr_Seq_origem::text, '') = ''
	and		coalesce(w.ie_ivc,'N') <> 'S'
	and		coalesce(w.ie_ctrl_glic,'NC') = 'NC'
	and		(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
	and		coalesce(x.nr_seq_prot_glic::text, '') = ''
	and		coalesce(x.ie_administrar,'S') = 'S'
	and		coalesce(x.nr_seq_exame::text, '') = ''
	and		coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and		coalesce(x.nr_seq_derivado::text, '') = ''
	and		coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and 	coalesce(x.dt_suspensao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and	   	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	   	coalesce(a.dt_liberacao::text, '') = ''
	and	   	a.nr_atendimento 	= nr_atendimento_p
	
union

	--CIG
	select	a.nr_prescricao,
			x.cd_procedimento cd_item,
			substr(z.ds_expressao,1,255) ds_item,
			wheb_mensagem_pck.get_texto(795048) ds_tipo_item
	from	valor_dominio_v z,
			procedimento y,
			proc_interno w,
			prescr_procedimento x,
			prescr_medica a
	where	z.cd_dominio = 1903
	and		z.vl_dominio = w.ie_ctrl_glic
	and		y.cd_procedimento = x.cd_procedimento
	and		y.ie_origem_proced = x.ie_origem_proced
	and		w.nr_sequencia = x.nr_seq_proc_interno
	and		x.nr_prescricao = a.nr_prescricao
	and		coalesce(w.ie_tipo,'O') not in ('G','BS')
	and		coalesce(w.ie_ivc,'N') <> 'S'
	and		w.ie_ctrl_glic = 'CIG'
	and		(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
	and		coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and 	coalesce(x.dt_suspensao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(x.nr_seq_derivado::text, '') = ''
	and		coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	   	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	   	coalesce(a.dt_liberacao::text, '') = ''
	and	   	a.nr_atendimento 	= nr_atendimento_p
	
union

	--CCG
	select	a.nr_prescricao,
			x.cd_procedimento cd_item,
			substr(z.ds_protocolo,1,255) ds_item,
			wheb_mensagem_pck.get_texto(795049) ds_tipo_item
	from	pep_protocolo_glicemia z,
			procedimento y,
			proc_interno w,
			prescr_procedimento x,
			prescr_medica a
	where	z.nr_sequencia = x.nr_seq_prot_glic
	and		y.cd_procedimento = x.cd_procedimento
	and		y.ie_origem_proced = x.ie_origem_proced
	and		w.nr_sequencia = x.nr_seq_proc_interno
	and		x.nr_prescricao = a.nr_prescricao
	and		coalesce(w.ie_tipo,'O') not in ('G','BS')
	and		coalesce(w.ie_ivc,'N') <> 'S'
	and		w.ie_ctrl_glic = 'CCG'
	and		(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
	and		(x.nr_seq_prot_glic IS NOT NULL AND x.nr_seq_prot_glic::text <> '')
	and		coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and		coalesce(x.nr_seq_derivado::text, '') = ''
	and		coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	   	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	   	coalesce(a.dt_liberacao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(x.dt_suspensao::text, '') = ''
	and	   	a.nr_atendimento 	= nr_atendimento_p
	
union

	-- Dieta oral
	select	a.nr_prescricao,
			b.cd_dieta cd_item,
			substr(obter_desc_dieta(cd_dieta),1,255) ds_item,
			wheb_mensagem_pck.get_texto(795050) ds_tipo_item
	from	prescr_medica a,
			prescr_dieta b
	where	a.nr_prescricao 	= b.nr_prescricao
	and	   	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	   	coalesce(a.dt_liberacao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(b.dt_suspensao::text, '') = ''
	and		a.nr_atendimento 	= nr_atendimento_p
	
union

	--Solução
	select	a.nr_prescricao,
			b.nr_seq_solucao cd_item,
			substr(ds_solucao,1,255) ds_item,
			wheb_mensagem_pck.get_texto(795051) ds_tipo_item
	from	prescr_medica a,
			prescr_solucao b
	where	a.nr_prescricao 				= b.nr_prescricao
	and		coalesce(b.ie_hemodialise,'N') 	= 'N'
	and		coalesce(b.nr_seq_dialise::text, '') = ''
	and	   	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	   	coalesce(a.dt_liberacao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(b.dt_suspensao::text, '') = ''
	and		a.nr_atendimento 				= nr_atendimento_p
	
union

	--Gasoterapia
	select	a.nr_prescricao,
			b.nr_sequencia cd_item,
			substr(c.ds_gas, 1,255) ds_item,
			wheb_mensagem_pck.get_texto(795052) ds_tipo_item
	from	prescr_medica a,
			prescr_gasoterapia b,
			gas c
	where	a.nr_prescricao 	= b.nr_prescricao
	and		b.nr_seq_gas		= c.nr_sequencia
	and	   	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	   	coalesce(a.dt_liberacao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(b.dt_suspensao::text, '') = ''
	and		a.nr_atendimento 	= nr_atendimento_p
	
union

	--Hemoterapia
	select	a.nr_prescricao,
			x.cd_procedimento cd_item,
			CASE WHEN coalesce(x.nr_seq_exame_sangue::text, '') = '' THEN CASE WHEN coalesce(x.ie_util_hemocomponente::text, '') = '' THEN null  ELSE '('|| substr(obter_valor_dominio(2247,x.ie_util_hemocomponente),1,20) ||') ' END  || coalesce(z.ds_derivado,y.ds_procedimento)  ELSE substr(Obter_desc_san_exame(x.nr_seq_exame_sangue),1,255) END  || ' ' || substr(obter_interv_cuidados_hm(x.nr_prescricao, x.nr_sequencia, 'N'),1,255)  ds_item,
			wheb_mensagem_pck.get_texto(795053) ds_tipo_item
	FROM procedimento y, prescr_medica a, prescr_procedimento x
LEFT OUTER JOIN san_derivado z ON (x.nr_seq_derivado = z.nr_sequencia)
WHERE y.cd_procedimento = x.cd_procedimento and y.ie_origem_proced = x.ie_origem_proced and x.nr_prescricao = a.nr_prescricao and coalesce(x.nr_seq_proc_interno::text, '') = '' and coalesce(x.nr_seq_exame::text, '') = '' and (x.nr_seq_solic_sangue IS NOT NULL AND x.nr_seq_solic_sangue::text <> '') and (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') and coalesce(a.dt_liberacao::text, '') = '' and coalesce(a.dt_suspensao::text, '') = '' and coalesce(x.dt_suspensao::text, '') = '' and a.nr_atendimento = nr_atendimento_p
	
union

	select	a.nr_prescricao,
			x.cd_procedimento cd_item,
			substr(z.ds_derivado || ' ' || substr(obter_interv_cuidados_hm(x.nr_prescricao, x.nr_sequencia, 'S'),1,100),1,255) ds_item,
			wheb_mensagem_pck.get_texto(795053) ds_tipo_item
	FROM procedimento y, proc_interno w, prescr_medica a, san_derivado z
LEFT OUTER JOIN prescr_procedimento x ON (z.nr_sequencia = x.nr_seq_derivado)
WHERE y.cd_procedimento = x.cd_procedimento and y.ie_origem_proced = x.ie_origem_proced and w.nr_sequencia = x.nr_seq_proc_interno and x.nr_prescricao = a.nr_prescricao and coalesce(w.ie_tipo,'O') not in ('G','BS') and coalesce(w.ie_ivc,'N') <> 'S' and coalesce(w.ie_ctrl_glic,'NC') = 'NC' and (x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '') and coalesce(x.nr_seq_prot_glic::text, '') = '' and coalesce(x.nr_seq_exame::text, '') = '' and (x.nr_seq_solic_sangue IS NOT NULL AND x.nr_seq_solic_sangue::text <> '') and (x.nr_seq_derivado IS NOT NULL AND x.nr_seq_derivado::text <> '') and coalesce(x.nr_seq_exame_sangue::text, '') = '' and (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') and coalesce(a.dt_liberacao::text, '') = '' and coalesce(a.dt_suspensao::text, '') = '' and coalesce(x.dt_suspensao::text, '') = '' and a.nr_atendimento = nr_atendimento_p
	 
union

	--Recomenção
	select	a.nr_prescricao,
			b.cd_recomendacao cd_item,
			substr(coalesce(c.ds_tipo_recomendacao,coalesce(b.ds_recomendacao,' ')),1,255) ds_item,
			wheb_mensagem_pck.get_texto(795054) ds_tipo_item
	FROM prescr_medica a, prescr_recomendacao b
LEFT OUTER JOIN tipo_recomendacao c ON (b.cd_recomendacao = c.cd_tipo_recomendacao)
WHERE a.nr_prescricao 			= b.nr_prescricao  and (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') and coalesce(a.dt_liberacao::text, '') = '' and coalesce(a.dt_suspensao::text, '') = '' and coalesce(b.dt_suspensao::text, '') = '' and a.nr_atendimento 	= nr_atendimento_p
	 
union

	--Diálise
	select	a.nr_prescricao,
			x.nr_seq_solucao cd_item,
			substr(coalesce(obter_desc_prot_npt(x.nr_seq_protocolo),obter_prim_comp_sol(a.nr_prescricao,x.nr_seq_solucao)),1,255) ds_item,
			wheb_mensagem_pck.get_texto(795055) ds_tipo_item
	from	hd_prescricao b,
			prescr_solucao x,
			prescr_medica a
	where	x.nr_prescricao 	= a.nr_prescricao
	and     b.nr_sequencia    	= x.nr_seq_dialise
	and	   	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	   	coalesce(a.dt_liberacao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(x.dt_suspensao::text, '') = ''
	and		a.nr_atendimento 	= nr_atendimento_p
	--IVC
	
union

	select	a.nr_prescricao,
			x.cd_procedimento cd_item,
			substr(coalesce(w.ds_proc_exame,y.ds_procedimento),1,255) ds_item,
			wheb_mensagem_pck.get_texto(795058) ds_tipo_item
	from	procedimento y,
			proc_interno w,
			prescr_procedimento x,
			prescr_medica a
	where	y.cd_procedimento = x.cd_procedimento
	and		y.ie_origem_proced = x.ie_origem_proced
	and		w.nr_sequencia = x.nr_seq_proc_interno
	and		x.nr_prescricao = a.nr_prescricao
	and		coalesce(w.ie_tipo,'O') not in ('G','BS')
	and		coalesce(w.ie_ivc,'N') = 'S'
	and 	coalesce(x.nr_seq_origem::text, '') = ''
	and		(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
	and		coalesce(x.nr_seq_prot_glic::text, '') = ''
	and		coalesce(x.nr_seq_exame::text, '') = ''
	and		coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and		coalesce(x.nr_seq_derivado::text, '') = ''
	and		coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and 	coalesce(x.dt_suspensao::text, '') = ''
	and 	coalesce(a.dt_suspensao::text, '') = ''
	and	   	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	   	coalesce(a.dt_liberacao::text, '') = ''
	and		a.nr_atendimento 	= nr_atendimento_p
	order by nr_prescricao;

C09 CURSOR FOR
	SELECT  d.dt_resultado,
		d.nr_prescricao,
		substr(obter_desc_exame_lab(e.nr_seq_exame,null,null,null),1,255) ds_exame,
		substr(obter_nome_medico(d.cd_medico,'N'),1,60) nm_medico
	from 	exame_lab_resultado d,
		exame_lab_result_item e
	where	d.nr_seq_resultado = e.nr_seq_resultado
	and	d.nr_atendimento = nr_atendimento_p
	and	e.dt_liberacao > clock_timestamp() - interval '2 days'
	and	Obter_se_prescr_vigente(d.nr_prescricao) = 'S'
	and	coalesce(e.dt_visualizacao::text, '') = '';

C10 CURSOR FOR
	SELECT  d.dt_resultado,
		d.nr_prescricao,
		substr(obter_desc_exame_lab(e.nr_seq_exame,null,null,null),1,255) ds_exame,
		substr(obter_nome_medico(d.cd_medico,'N'),1,60) nm_medico
	from 	exame_lab_resultado d,
		exame_lab_result_item e
	where	d.nr_seq_resultado = e.nr_seq_resultado
	and	d.nr_atendimento = nr_atendimento_p
	and	e.dt_aprovacao > clock_timestamp() - interval '2 days'
	and	Obter_se_prescr_vigente(d.nr_prescricao) = 'S'
	and	coalesce(e.dt_visualizacao::text, '') = '';

C11 CURSOR FOR
	SELECT  d.dt_resultado,
		d.nr_prescricao,
		substr(obter_desc_exame_lab(e.nr_seq_exame,null,null,null),1,255) ds_exame,
		substr(obter_nome_medico(coalesce(d.cd_medico,e.cd_medico_resp),'N'),1,60) nm_medico,
		substr(obter_result_lab_panorama(d.nr_seq_resultado, e.ds_resultado, e.qt_resultado, e.pr_resultado, e.nr_seq_prescr, d.nr_prescricao, e.nr_seq_exame),1,255) || ' ' || Obter_LAB_Unid_Med(e.nr_seq_unid_med,'C') ds_resultado
	from	exame_lab_resultado d,
		exame_lab_result_item e
	where	d.nr_seq_resultado = e.nr_seq_resultado
	and	d.nr_atendimento = nr_atendimento_p
	and	coalesce(e.dt_visualizacao::text, '') = ''
	and	e.dt_liberacao > clock_timestamp() - interval '1 days' and e.dt_liberacao > coalesce((SELECT max(x.dt_atualizacao) from panorama_icone_click x where x.nr_atendimento = nr_atendimento_p and x.cd_icone_panorama = 11), e.dt_liberacao-1)
	and (lab_se_result_nao_aceit(d.nr_seq_resultado, e.ds_resultado, e.qt_resultado, e.pr_resultado, e.nr_seq_prescr, d.nr_prescricao, e.nr_seq_exame) = 'S' or e.ie_resultado_critico = 'S');

C12 CURSOR FOR
	SELECT  d.dt_resultado,
		d.nr_prescricao,
		substr(obter_desc_exame_lab(e.nr_seq_exame,null,null,null),1,255) ds_exame,
		substr(obter_nome_medico(coalesce(d.cd_medico,e.cd_medico_resp),'N'),1,60) nm_medico,
		substr(obter_result_lab_panorama(d.nr_seq_resultado, e.ds_resultado, e.qt_resultado, e.pr_resultado, e.nr_seq_prescr, d.nr_prescricao, e.nr_seq_exame),1,255) || ' ' || Obter_LAB_Unid_Med(e.nr_seq_unid_med,'C') ds_resultado
	from	exame_lab_resultado d,
		exame_lab_result_item e
	where	d.nr_seq_resultado = e.nr_seq_resultado
	and	d.nr_atendimento = nr_atendimento_p
	and	coalesce(e.dt_visualizacao::text, '') = ''
	and	e.dt_aprovacao > clock_timestamp() - interval '1 days' and e.dt_aprovacao > coalesce((SELECT max(x.dt_atualizacao) from panorama_icone_click x where x.nr_atendimento = nr_atendimento_p and x.cd_icone_panorama = 11), e.dt_aprovacao-1)
	and (lab_se_result_nao_aceit(d.nr_seq_resultado, e.ds_resultado, e.qt_resultado, e.pr_resultado, e.nr_seq_prescr, d.nr_prescricao, e.nr_seq_exame) = 'S' or e.ie_resultado_critico = 'S');

C13 CURSOR FOR
	SELECT	obter_desc_material(cd_material)
	from	cpoe_material
	where	coalesce(dt_fim::text, '') = ''
	and		coalesce(dt_suspensao::text, '') = ''
	and		(IE_URGENCIA IS NOT NULL AND IE_URGENCIA::text <> '')
	and		nr_atendimento = nr_atendimento_p;

C14 CURSOR FOR
	SELECT	substr(obter_desc_obj_jejum(a.nr_seq_objetivo),1,255),
			substr(obter_desc_tipo_jejum(a.nr_seq_tipo),1,255)
	from	prescr_medica b,
			rep_jejum a
	where	b.nr_prescricao		= a.nr_prescricao
	and		clock_timestamp() between coalesce(a.dt_inicio, b.dt_inicio_prescr) and coalesce(a.dt_fim, b.dt_validade_prescr)
	and		(coalesce(b.dt_liberacao, b.dt_liberacao_medico) IS NOT NULL AND (coalesce(b.dt_liberacao, b.dt_liberacao_medico))::text <> '')
	and		coalesce(a.ie_suspenso,'N') = 'N'
	and		nr_atendimento = nr_atendimento_p;

C15 CURSOR FOR
	SELECT	b.dt_prescricao,
		b.nr_prescricao,
		c.nr_seq_exame,
		substr(p.ds_procedimento,1,120) ds_procedimento
	from	atendimento_paciente a,
		prescr_medica b,
		procedimento p,
		prescr_procedimento c
		left outer join proc_interno w on w.nr_sequencia = c.nr_seq_proc_interno
	where	a.nr_atendimento = nr_atendimento_p
	and	a.nr_atendimento = b.nr_atendimento
	and	b.nr_prescricao = c.nr_prescricao
	and	p.cd_procedimento = c.cd_procedimento
	and	p.ie_origem_proced = c.ie_origem_proced
	and	b.dt_prescricao > clock_timestamp() - interval '2 days'
	and (c.nr_seq_proc_interno IS NOT NULL AND c.nr_seq_proc_interno::text <> '')
	and	c.ie_suspenso = 'N'
	and	((coalesce(w.nr_sequencia::text, '') = ''
			and coalesce(c.nr_seq_proc_interno::text, '') = '') or ((w.nr_sequencia IS NOT NULL AND w.nr_sequencia::text <> '')
			and	(c.nr_seq_proc_interno IS NOT NULL AND c.nr_seq_proc_interno::text <> '')
			and	coalesce(c.nr_seq_origem::text, '') = ''
			and	coalesce(w.ie_tipo,'O') not in ('BS')
			and	coalesce(w.ie_ivc,'N') <> 'S'))
	and	exists (	SELECT	1
				from	prescr_proc_hor d
				where	c.nr_prescricao = d.nr_prescricao
				and	c.nr_sequencia = d.nr_seq_procedimento
				and	coalesce(d.dt_fim_horario::text, '') = ''
				and	coalesce(d.ie_situacao,'A') = 'A'  LIMIT 1)
	and	adep_obter_regra_inclusao('PROC', b.cd_estabelecimento, b.cd_setor_atendimento, b.cd_perfil_ativo, null, p.cd_procedimento, p.ie_origem_proced, c.nr_seq_proc_interno, b.cd_Setor_atendimento,c.cd_Setor_atendimento, b.nr_prescricao, c.nr_seq_exame) = 'S';


BEGIN
	begin
		ie_visualizacao_icon_w := obter_param_usuario(281, 176, cd_perfil_p, '', cd_estabelecimento_p, ie_visualizacao_icon_w);
	exception
	when others then
		ie_visualizacao_icon_w := 'L';
	end;

	ds_retorno_w:= '';

	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	select	max(dt_nascimento)
	into STRICT	dt_nascimento_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;

	cd_setor_atendimento_w := obter_setor_atendimento(nr_atendimento_p);

	ie_pac_mr_w	:=	Obter_se_paciente_MR(nr_atendimento_p);
	ie_pac_isol_w	:=	obter_se_pac_isolamento(nr_atendimento_p);


	-- OBTER A LISTA DE ICONES - INICIO
	select	max(a.nr_sequencia)
	into STRICT 	nr_seq_regra_w
	from	regra_perm_panorama a
	where	a.cd_perfil = cd_perfil_p
	and exists (	SELECT 1
			from	regra_perm_panorama_icone x
			where	x.nr_seq_regra = a.nr_sequencia  LIMIT 1);

	if (coalesce(nr_seq_regra_w::text, '') = '') then -- se não encontrou a regra para o perfil, busca uma regra sem perfil definido.
		select	max(a.nr_sequencia)
		into STRICT 	nr_seq_regra_w
		from	regra_perm_panorama a
		where	coalesce(a.cd_perfil::text, '') = ''
		and exists (	SELECT 1
				from	regra_perm_panorama_icone x
				where	x.nr_seq_regra = a.nr_sequencia  LIMIT 1);
	end if;WITH RECURSIVE cte AS (


	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
		select	ltrim(cd_icone_panorama,',') icones
		into STRICT	ds_lista_icones_lib_w
		from (
			SELECT	cd_icone_panorama,
				row_number() over (order by cd_icone_panorama) as fila
			from	regra_perm_panorama_icone
			where	nr_seq_regra = nr_seq_regra_w) alias5 WHERE fila = 1
  UNION ALL


	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
		select	c.ds_lista_icones_lib_w || ',' || ltrim(cd_icone_panorama,',') icones
		into STRICT	ds_lista_icones_lib_w
		from (
			SELECT	cd_icone_panorama,
				row_number() over (order by cd_icone_panorama) as fila
			from	regra_perm_panorama_icone
			where	nr_seq_regra = nr_seq_regra_w) JOIN cte c ON (c.prior fila = alias5.(fila-1))

) SELECT * FROM cte WHERE connect_by_isleaf = 1;
;
	end if;


	-- OBTER A LISTA DE ICONES - FIM
	-- Alergias
	begin
	--if('S' = obter_se_exibe_icone_mapa(0, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',0,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		ds_alerta_w := substr(Obter_Alergias(cd_pessoa_fisica_w),1,4000);
		if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
			ie_alerta_w := 'S';
		end if;

		if (ie_alerta_w = 'S') then
			ie_alerta_w:= 'S';
		end if;

		--ds_retorno_w:= substr(ds_retorno_w || 'id=0;'|| ie_alerta_w ||';ie_alergia='|| ie_alerta_w ||';;ds_alergia='||ds_alerta_w||';',1,4000);
		ds_retorno_w:= substr(ds_retorno_w || '0;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	--  Itens não checados OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(1, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',1,' in ','||ds_lista_icones_lib_w||',') > 0) then
		qt_hora_pend_prescr_w := Obter_qt_hor_pendente_prescr(	cd_estabelecimento_P,
																cd_setor_atendimento_w,
																cd_perfil_p,
																nr_atendimento_p,
																0,
																trunc(clock_timestamp()),
																clock_timestamp(),
																1,
																'S',
																0,
																0,
																0,
																'S');

		if (qt_hora_pend_prescr_w > 0) then
			ie_alerta_w := 'S';
			ds_alerta_w := substr(obter_desc_expressao(652654),1,4000);
		else
			ie_alerta_w := 'N';
			ds_alerta_w := null;
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '1;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	-- Aniversariante OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(2, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',2,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		ds_alerta_w := substr(obter_se_aniversario_paciente(cd_pessoa_fisica_w),1,4000);

		if (to_char(dt_nascimento_w, 'dd/mm') = to_char(clock_timestamp(), 'dd/mm')) then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '2;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	-- Alertas --  OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(3, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',3,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		open C06;
		loop
		fetch C06 into
			dt_alerta_icon_w,
			ds_alerta_icon_w,
			nr_seq_alerta_w,
			nr_seq_tipo_alerta_w;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			begin
			if (nr_seq_tipo_alerta_w IS NOT NULL AND nr_seq_tipo_alerta_w::text <> '') and (nr_seq_alerta_w IS NOT NULL AND nr_seq_alerta_w::text <> '') then
				begin
				select 	coalesce(max(ie_allow_free_text),'Y')
				into STRICT	ie_allow_free_text_w
				from	tipo_alerta_atend
				where	nr_sequencia = nr_seq_tipo_alerta_w;

				if (ie_allow_free_text_w = 'N') then
					select 	max(ds_alert)
					into STRICT 	ds_alerta_icon_w
					from 	tipo_alerta_atend_option
					where 	nr_sequencia = nr_seq_alerta_w;
				end if;
				end;
			end if;

			if (coalesce(length(ds_alerta_w),0) < 800) then
				ds_alerta_w	:= 	substr(ds_alerta_w||dt_alerta_icon_w || ' - ' ||ds_alerta_icon_w|| '<br>',1,4000);
			end if;

			end;
		end loop;
		close C06;

		if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '3;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	-- Exames para coleta - laboratório OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(4, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',4,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		open C03;
		loop
		fetch C03 into
			dt_prescricao_w,
			nr_prescricao_w,
			nr_seq_exame_w,
			ds_procedimento_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin

			ds_alerta_w	:= 	substr(ds_alerta_w||dt_prescricao_w || ' - ' ||ds_procedimento_w|| '<br>',1,4000);

			end;
		end loop;
		close C03;

		if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '4;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	--Exames para coleta - enfermagem OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(5, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',5,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		open C02;
		loop
		fetch C02 into
			dt_prescricao_w,
			nr_prescricao_w,
			nr_seq_exame_w,
			ds_procedimento_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			ds_alerta_w	:= 	substr(ds_alerta_w||dt_prescricao_w || ' - ' ||ds_procedimento_w|| '<br>',1,4000);

			end;
		end loop;
		close C02;

		if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '5;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	-- Itens suspensos	solucao OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(6, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',6,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		open C04;
		loop
		fetch C04 into
			nr_prescricao_w,
			cd_item_w,
			ds_item_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin

			ds_alerta_w	:= 	substr(ds_alerta_w||dt_prescricao_w || ' - ' ||ds_item_w|| '<br>',1,4000);

			end;
		end loop;
		close C04;

		if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '6;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	-- Gerenciamento de Riscos - Feller OK
/*	begin
	--if('S' = obter_se_exibe_icone_mapa(7, cd_perfil_p)) then
	if	(ds_lista_icones_lib_w is null) or (instr(','||ds_lista_icones_lib_w||',', ',7,') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		ds_meta_w:= obter_se_risco_panorama(nr_atendimento_p);

		if (ds_meta_w is not null) then

			ds_alerta_w	:= 	substr(ds_alerta_w||ds_meta_w||'<br>',1,4000);

		end if;


		if	(ds_alerta_w is not null) then
			ie_alerta_w := 'S';
		end if;


		ds_retorno_w:= substr(ds_retorno_w || '7;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;*/
	-- Bactéria multirresistente - não confirmada - isolamento preventivo
	begin
	--if('S' = obter_se_exibe_icone_mapa(8, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',8,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		if	(ie_pac_mr_w = 'S' AND ie_pac_isol_w = 'N') or
			(ie_pac_mr_w = 'N' AND ie_pac_isol_w = 'S')then
			ie_alerta_w := 'S';

			if (ie_pac_mr_w = 'S') then
				ds_alerta_w := substr(wheb_mensagem_pck.get_texto(795077, 'DS_MICROORGANISMO='||Obter_desc_MR(nr_atendimento_p)), 1, 1000);
			else
				ds_alerta_w := substr(wheb_mensagem_pck.get_texto(795078, 'DS_PRECAUCAO='||obter_desc_precaucao_atend(nr_atendimento_p)), 1, 1000);
			end if;

		end if;

		ds_retorno_w:= substr(ds_retorno_w || '8;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
		end if;
	end;

	-- Protocolo IAM OK
	begin
	--if(('S' = obter_se_exibe_icone_mapa(9, cd_perfil_p)) and ('1' = obter_dados_setor(cd_setor_atendimento_w, 'CL'))) then
	if	((coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',1,' in ','||ds_lista_icones_lib_w||',') > 0)) then


		ie_alerta_w := 'N';
		ds_alerta_w := ' ';

		if ('1' = obter_dados_setor(cd_setor_atendimento_w, 'CL')) then
			select	coalesce(max(IE_PROTOCOLO_ASSISTENCIAL),'N')
			into STRICT 		ie_alerta_w
			from		triagem_pronto_atend
			where		nr_atendimento = nr_atendimento_p;

			if (ie_alerta_w = 'S') then
				ds_alerta_w := obter_desc_expressao(690408);
			end if;
		end if;

		ds_protocolos_w := substr(obter_se_panorama_mentor(nr_atendimento_p),1,255);
		if (ds_protocolos_w <> 'N') then
			ie_alerta_w := 'S';
			if (ds_alerta_w = ' ') then
				ds_alerta_w := ds_protocolos_w;
			else
				ds_alerta_w := ds_alerta_w || ' <br> ' || ds_protocolos_w;
			end if;
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '9;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;

	end;

	-- Resultado de exames laboratoriais	OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(10, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',10,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		if (ie_visualizacao_icon_w =  'L') then
			open C09;
			loop
			fetch C09 into
				dt_resultado_w,
				nr_prescricao_w,
				ds_exame_w,
				nm_medico_w;
			EXIT WHEN NOT FOUND; /* apply on C09 */
				begin

				ds_alerta_w	:= 	substr(ds_alerta_w||nr_prescricao_w|| ' - ' ||dt_resultado_w||' - ' ||ds_exame_w || ' - ' || nm_medico_w || '<br>',1,4000);

				end;
			end loop;
			close C09;
		else
			open C10;
			loop
			fetch C10 into
				dt_resultado_w,
				nr_prescricao_w,
				ds_exame_w,
				nm_medico_w;
			EXIT WHEN NOT FOUND; /* apply on C10 */
				begin

				ds_alerta_w	:= 	substr(ds_alerta_w||nr_prescricao_w|| ' - ' ||dt_resultado_w||' - ' ||ds_exame_w || ' - ' || nm_medico_w || '<br>',1,4000);

				end;
			end loop;
			close C10;
		end if;

		if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '10;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	-- Resultado crítico 	OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(11, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',11,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		if (ie_visualizacao_icon_w =  'L') then
			open C11;
			loop
			fetch C11 into
				dt_resultado_w,
				nr_prescricao_w,
				ds_exame_w,
				nm_medico_w,
				ds_resultado_exame_w;
			EXIT WHEN NOT FOUND; /* apply on C11 */
				begin

				ds_alerta_w	:= 	substr(ds_alerta_w||nr_prescricao_w|| ' - ' ||dt_resultado_w||' - ' ||ds_exame_w || ' - ' || trim(both ds_resultado_exame_w) || ' - ' || nm_medico_w || '<br>',1,4000);

				end;
			end loop;
			close C11;
		else
			open C12;
			loop
			fetch C12 into
				dt_resultado_w,
				nr_prescricao_w,
				ds_exame_w,
				nm_medico_w,
				ds_resultado_exame_w;
			EXIT WHEN NOT FOUND; /* apply on C12 */
				begin

				ds_alerta_w	:= 	substr(ds_alerta_w||nr_prescricao_w|| ' - ' ||dt_resultado_w||' - ' ||ds_exame_w || ' - ' || trim(both ds_resultado_exame_w) || ' - ' || nm_medico_w || '<br>',1,4000);

				end;
			end loop;
			close C12;
		end if;

		if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '11;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	-- Itens descontinuados - Não fazer OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(12, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',12,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		ds_retorno_w:= substr(ds_retorno_w || '12;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	-- Item suspenso medicamento OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(13, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',13,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		open C05;
		loop
		fetch C05 into
			nr_prescricao_w,
			cd_item_w,
			ds_item_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin

			ds_alerta_w	:= 	substr(ds_alerta_w||dt_prescricao_w || ' - ' ||ds_item_w|| '<br>',1,4000);

			end;
		end loop;
		close C05;

		if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '13;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	-- Item pendente confirmacao enfermagem OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(14, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',14,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		open C08;
		loop
		fetch C08 into
			nr_prescricao_w,
			cd_item_w,
			ds_item_w,
			ds_tipo_item_w;
		EXIT WHEN NOT FOUND; /* apply on C08 */
			begin

			ds_alerta_w	:= 	substr(ds_alerta_w||nr_prescricao_w || ' - ' ||ds_item_w|| '<br>',1,4000);

			end;
		end loop;
		close C08;

		if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '14;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	-- Item pendente confirmacao farmacia      OK
	-- Item pendente confirmacao farmacia (laboratorial)      OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(15, cd_perfil_p)) then
	if	((coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',15,' in ','||ds_lista_icones_lib_w||',') > 0) or (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',26,' in ','||ds_lista_icones_lib_w||',') > 0)) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		open C07;
		loop
		fetch C07 into
			nr_prescricao_w,
			cd_item_w,
			ds_item_w,
			ds_tipo_item_w,
			ie_labr_w;
		EXIT WHEN NOT FOUND; /* apply on C07 */
			begin

			if	((coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',15,' in ','||ds_lista_icones_lib_w||',') > 0)) then
				ds_alerta_w		:= 	substr(ds_alerta_w||nr_prescricao_w || ' - ' ||ds_item_w|| '<br>',1,4000);
			end if;

			if	(((coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',26,' in ','||ds_lista_icones_lib_w||',') > 0)) and (coalesce(ie_labr_w,'N')	= 'S'))then
				ds_alerta_ww	:= 	substr(ds_alerta_ww||nr_prescricao_w || ' - ' ||ds_item_w|| '<br>',1,4000);
			end if;

			end;
		end loop;
		close C07;

		ie_alerta_w := 'N';
		if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '15;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);

		ie_alerta_w := 'N';
		if (ds_alerta_ww IS NOT NULL AND ds_alerta_ww::text <> '') then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '26;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_ww|| ';#@',1,4000);
	end if;
	end;

	-- Bactéria multirresistente - confirmada - pendente isolamento OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(16, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',16,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		if (ie_pac_mr_w = 'S') and (ie_pac_isol_w = 'S') then
			ie_alerta_w := 'S';
			ds_alerta_w := substr(Obter_desc_MR(nr_atendimento_p) || ' - ' || obter_desc_precaucao_atend(nr_atendimento_p), 1, 1000);
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '16;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	--alta médica         OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(17, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',17,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		select	CASE WHEN coalesce(max(dt_alta_medico)::text, '') = '' THEN  'N'  ELSE 'S' END ,
						max(dt_alta_medico)
		into STRICT 		ie_alerta_w,
						ds_alerta_w
		from		atendimento_paciente
		where		nr_atendimento = nr_atendimento_p;

		ds_retorno_w:= substr(ds_retorno_w || '17;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	--transferencia solicitada OK
	begin
	--if('S' = obter_se_exibe_icone_mapa(18, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',18,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		select	max(dt_solicitacao),
				max(obter_valor_dominio(1408, ie_status)),
				max(dt_prevista),
				max(obter_desc_tipo_acomodacao(cd_tipo_acomod_desej)) ds_tipo_acomodacao,
				max(obter_ds_descricao_setor(cd_setor_desejado)) ds_setor_desejado,
				max(cd_unidade_basica||' '||cd_unidade_compl)
		into STRICT	dt_solicitacao_w,
				ds_status_w,
				dt_prevista_w,
				ds_tipo_acomodacao_w,
				ds_setor_desejado_w,
				cd_unidade_desejada_w
		from	gestao_vaga
		where	ie_status not in ('F','R','C','D','N','E','T')
		and		nr_atendimento = nr_atendimento_P;

		if (dt_solicitacao_w IS NOT NULL AND dt_solicitacao_w::text <> '') then
			ie_alerta_w:= 'S';

			ds_alerta_w:= substr(dt_solicitacao_w||' '||ds_status_w||'<br>'||dt_prevista_w,1,4000);

			if (ds_tipo_acomodacao_w IS NOT NULL AND ds_tipo_acomodacao_w::text <> '') then
				ds_alerta_w:= substr(ds_alerta_w || wheb_mensagem_pck.get_texto(795063) ||': '||ds_tipo_acomodacao_w,1,4000);
			end if;
			if (ds_setor_desejado_w IS NOT NULL AND ds_setor_desejado_w::text <> '') then
				ds_alerta_w:= substr(ds_alerta_w || wheb_mensagem_pck.get_texto(795066) ||': '||ds_setor_desejado_w,1,4000);
			end if;
			if ((trim(both cd_unidade_desejada_w) IS NOT NULL AND (trim(both cd_unidade_desejada_w))::text <> '')) then
				ds_alerta_w:= substr(ds_alerta_w || wheb_mensagem_pck.get_texto(795070) ||': '||cd_unidade_desejada_w,1,4000);
			end if;
		end if;


		ds_retorno_w:= substr(ds_retorno_w || '18;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;


	--Solicitação de reserva pendente
	begin
	--if('S' = obter_se_exibe_icone_mapa(19, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',19,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		select	max(dt_solicitacao),
				max(obter_valor_dominio(1408, ie_status)),
				max(dt_prevista),
				max(obter_desc_tipo_acomodacao(cd_tipo_acomod_desej)) ds_tipo_acomodacao,
				max(obter_ds_descricao_setor(cd_setor_desejado)) ds_setor_desejado,
				max(cd_unidade_basica||' '||cd_unidade_compl)
		into STRICT	dt_solicitacao_w,
				ds_status_w,
				dt_prevista_w,
				ds_tipo_acomodacao_w,
				ds_setor_desejado_w,
				cd_unidade_desejada_w
		from	gestao_vaga
		where	ie_status = 'R'
		and		nr_atendimento = nr_atendimento_P;

		if (dt_solicitacao_w IS NOT NULL AND dt_solicitacao_w::text <> '') then
			ie_alerta_w:= 'S';

			ds_alerta_w:= substr(dt_solicitacao_w||' '||ds_status_w||'<br>'||dt_prevista_w,1,4000);

			if (ds_tipo_acomodacao_w IS NOT NULL AND ds_tipo_acomodacao_w::text <> '') then
				ds_alerta_w:= substr(ds_alerta_w || wheb_mensagem_pck.get_texto(795063) ||': '||ds_tipo_acomodacao_w,1,4000);
			end if;
			if (ds_setor_desejado_w IS NOT NULL AND ds_setor_desejado_w::text <> '') then
				ds_alerta_w:= substr(ds_alerta_w || wheb_mensagem_pck.get_texto(795066) ||': '||ds_setor_desejado_w,1,4000);
			end if;
			if ((trim(both cd_unidade_desejada_w) IS NOT NULL AND (trim(both cd_unidade_desejada_w))::text <> '')) then
				ds_alerta_w:= substr(ds_alerta_w || wheb_mensagem_pck.get_texto(795070) ||': '||cd_unidade_desejada_w,1,4000);
			end if;
		end if;


		ds_retorno_w:= substr(ds_retorno_w || '19;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	--Alta médica setor
	begin
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',22,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;
		ds_alerta_ww := null;
		begin
			select	substr(obter_dados_data_alta_setor(nr_atendimento_p),1,2000)
			into STRICT	ds_alerta_ww
			;
		exception
		when others then
			ds_alerta_ww := null;
		end;

		if (ds_alerta_ww IS NOT NULL AND ds_alerta_ww::text <> '') then
			ie_alerta_w := 'S';

			ds_alerta_w := substr(ds_alerta_ww,1,4000);
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '22;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	--Diagnóstico do atendimento
	begin
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',23,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;
		ds_alerta_ww := null;
		begin
			select	substr(Obter_Diagnostico_atendimento(nr_atendimento_P),1,2000)
			into STRICT	ds_alerta_ww
			;
		exception
		when others then
			ds_alerta_ww := null;
		end;

		if (ds_alerta_ww IS NOT NULL AND ds_alerta_ww::text <> '') then
			ie_alerta_w := 'S';

			ds_alerta_w := substr(ds_alerta_ww,1,4000);
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '23;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w || ';#@',1,4000);
	end if;
	end;

	--Medicamento de início imediato
	begin
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',24,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;
		ds_alerta_ww := null;
		begin
			open C13;
			loop
			fetch C13 into
				ds_item_w;
			EXIT WHEN NOT FOUND; /* apply on C13 */
				begin
				ds_alerta_ww := ds_alerta_ww || ds_item_w || '<br>';
				end;
			end loop;
			close C13;

		exception
		when others then
			ds_alerta_ww := null;
		end;

		if (ds_alerta_ww IS NOT NULL AND ds_alerta_ww::text <> '') then
			ie_alerta_w := 'S';

			ds_alerta_w := substr(ds_alerta_ww,1,4000);
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '24;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	--Paciente em jejum
	begin
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',25,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;
		ds_alerta_ww := null;
		begin
			open C14;
			loop
			fetch C14 into
				ds_objetivo_jejum_w,
				ds_tipo_jejum_w;
			EXIT WHEN NOT FOUND; /* apply on C14 */
				begin
				ds_alerta_ww := ds_alerta_ww || ds_objetivo_jejum_w || ' - ' || ds_tipo_jejum_w || '<br>';
				end;
			end loop;
			close C14;

		exception
		when others then
			ds_alerta_ww := null;
		end;

		if (ds_alerta_ww IS NOT NULL AND ds_alerta_ww::text <> '') then
			ie_alerta_w := 'S';

			ds_alerta_w := substr(ds_alerta_ww,1,4000);
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '25;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

	--Exames não laboratoriais para coleta da enfermagem - Exame enfermagem (não laboratorial)
	begin
	--if('S' = obter_se_exibe_icone_mapa(27, cd_perfil_p)) then
	if (coalesce(ds_lista_icones_lib_w::text, '') = '') or (position(',27,' in ','||ds_lista_icones_lib_w||',') > 0) then
		ie_alerta_w := 'N';
		ds_alerta_w := null;

		open C15;
		loop
		fetch C15 into
			dt_prescricao_w,
			nr_prescricao_w,
			nr_seq_exame_w,
			ds_procedimento_w;
		EXIT WHEN NOT FOUND; /* apply on C15 */
			begin

			ds_alerta_w	:= 	substr(ds_alerta_w||dt_prescricao_w || ' - ' ||ds_procedimento_w|| '<br>',1,4000);

			end;
		end loop;
		close C15;

		if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
			ie_alerta_w := 'S';
		end if;

		ds_retorno_w:= substr(ds_retorno_w || '27;##@' ||ie_alerta_w|| ';##@' ||ds_alerta_w|| ';#@',1,4000);
	end if;
	end;

ds_retorno_w:= substr(ds_retorno_w, 1, 4000);
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_alertas_atend_mapa_setor ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

