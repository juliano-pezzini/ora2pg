-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_proc_orig_laudo ( nr_aih_p bigint, nr_seq_aih_p bigint, nr_atendimento_p bigint, dt_emissao_p timestamp, ie_tipo_retorno_p bigint) RETURNS varchar AS $body$
DECLARE
					
/* ie_tipo_retorno_p
	1 - Codigo
	2 - Descricao
*/
					
cd_procedimento_w	bigint;
ds_procedimento_w	procedimento.ds_procedimento%TYPE;
ds_retorno_w		varchar(240);
cd_estab_usuario_w	smallint		:= 0;
ie_proc_emissao_w	varchar(15)	:= 'N';


BEGIN

begin
cd_estab_usuario_w	:= coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);
exception
when others then
	cd_estab_usuario_w := 0;
end;

ie_proc_emissao_w := coalesce(obter_valor_param_usuario(1123,185,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario,cd_estab_usuario_w),'N');

if (coalesce(nr_aih_p,0) > 0) then
	ds_retorno_w := Sus_Obter_Proc_LaudoSolic_Aih(nr_aih_p,nr_seq_aih_p,ie_tipo_retorno_p);
elsif (ie_proc_emissao_w = 'S') then
	begin
	select	cd_procedimento_solic,
		substr(obter_descricao_procedimento(cd_procedimento_solic, ie_origem_proced),1,255) ds_procedimento_solic
	into STRICT	cd_procedimento_w,
		ds_procedimento_w
	from	sus_laudo_paciente
	where	nr_seq_interno = (	SELECT	max(nr_seq_interno)	
					from	sus_laudo_paciente
					where	nr_atendimento = nr_atendimento_p
					and PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_emissao, 'shortDate', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) = PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_emissao_p, 'shortDate', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)
					and	ie_tipo_laudo_sus = 0);
	exception
		when others then
		cd_procedimento_w	:= 0;
		ds_procedimento_w	:= '';
	end;

	if (ie_tipo_retorno_p	= 1) then
		ds_retorno_w	:= cd_procedimento_w;
	elsif (ie_tipo_retorno_p	= 2) then
		ds_retorno_w	:= ds_procedimento_w;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_proc_orig_laudo ( nr_aih_p bigint, nr_seq_aih_p bigint, nr_atendimento_p bigint, dt_emissao_p timestamp, ie_tipo_retorno_p bigint) FROM PUBLIC;

