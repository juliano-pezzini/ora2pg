-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_media_nas_atend ( nr_atendimento_p bigint, dt_inicial_p timestamp) RETURNS bigint AS $body$
DECLARE

qt_retorno_w		real;
qt_pontuacao_w		real;
qt_total_w		real := 0;
qt_contador_w		integer := 0;
dt_atual_w		timestamp;
dt_final_w		timestamp;



c01 CURSOR FOR
SELECT	coalesce(qt_pontuacao,0)
from	escala_nas a
where	a.dt_avaliacao = ( 	SELECT	max(e.dt_avaliacao)
				from	escala_nas e
				where	e.nr_atendimento = nr_atendimento_p
				and	pkg_date_utils.start_of(e.dt_avaliacao, 'DD', 0) = pkg_date_utils.start_of(dt_atual_w,'DD',0));


BEGIN

dt_atual_w := pkg_date_utils.start_of(dt_inicial_p, 'MONTH',0);

dt_final_w := PKG_DATE_UTILS.ADD_MONTH(dt_atual_w, 1, 0);


while(dt_atual_w < dt_final_w) loop
	begin
	open c01;
		loop
		fetch c01 into
			qt_pontuacao_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
				qt_total_w 	:= qt_total_w + qt_pontuacao_w;
				qt_contador_w	:= qt_contador_w + 1;
			end;
		end loop;
	close C01;

	dt_atual_w	:= pkg_date_utils.start_of(dt_atual_w + 1, 'DD',0);

	end;
end loop;

if (qt_contador_w > 0)then
	qt_retorno_w := qt_total_w / qt_contador_w;
end if;

return	qt_retorno_w;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_media_nas_atend ( nr_atendimento_p bigint, dt_inicial_p timestamp) FROM PUBLIC;

