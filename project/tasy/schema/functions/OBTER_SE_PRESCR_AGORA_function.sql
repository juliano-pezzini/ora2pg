-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_prescr_agora ( nr_prescricao_p bigint, qt_minutos_p bigint, cd_intervalo_p text) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(1) := 'N';

dt_inicio_prescr_w	timestamp;
dt_prim_horario_w	timestamp;
hr_prim_horario_w	varchar(5);
ie_urgencia_w		varchar(5);
ie_dose_espec_agora_w	varchar(1) := 'N';
hr_dose_especial_w	varchar(5);
dt_prescricao_w		timestamp;
cd_intervalo_w		varchar(10);
ie_classif_urgente_w	varchar(15);
ie_motivo_prescricao_w	varchar(3);

C01 CURSOR FOR
SELECT	b.dt_prescricao,
	b.dt_inicio_prescr,
	a.hr_prim_horario,
	a.ie_urgencia,
	coalesce(a.ie_dose_espec_agora,'N'),
	a.hr_dose_especial,
	a.cd_intervalo
from	prescr_material a,
	prescr_medica b
where	a.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = nr_prescricao_p
and	coalesce(a.nr_sequencia_solucao::text, '') = ''
and	coalesce(a.nr_sequencia_dieta::text, '') = ''
and	coalesce(a.nr_sequencia_diluicao::text, '') = ''
and	coalesce(a.ie_administrar,'S') = 'S'
and	a.ie_agrupador in (1,5)
and	a.ie_suspenso <> 'S';

C02 CURSOR FOR
SELECT	c.dt_inicio_prescr,
	a.hr_prim_horario,
	a.ie_urgencia
from	prescr_solucao a,
	prescr_medica c
where	a.nr_prescricao = c.nr_prescricao
and	c.nr_prescricao	= nr_prescricao_p
and	a.ie_suspenso	<> 'S';


BEGIN

if (obter_funcao_ativa = 252) then
	ie_classif_urgente_w := obter_param_usuario(252, 51, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_classif_urgente_w);
else
	ie_classif_urgente_w := obter_param_usuario(7010, 81, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_classif_urgente_w);
end if;

open C01;
loop
fetch C01 into
	dt_prescricao_w,
	dt_inicio_prescr_w,
	hr_prim_horario_w,
	ie_urgencia_w,
	ie_dose_espec_agora_w,
	hr_dose_especial_w,
	cd_intervalo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (coalesce(cd_intervalo_p,'XPTO')	<> 'XPTO') then
		if (cd_intervalo_p		= cd_intervalo_w) then
			ie_retorno_w	:= 'S';
			exit;
		end if;
	else

		if (ie_urgencia_w = 'S') then
			ie_retorno_w	:= 'S';
			exit;
		end if;

		if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') and (hr_prim_horario_w <> '  :  ') then
			begin
			if (ie_dose_espec_agora_w = 'N') and (hr_prim_horario_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then
				dt_inicio_prescr_w	:= dt_inicio_prescr_w + 1;
			end if;
			dt_prim_horario_w	:= to_date(to_char(dt_inicio_prescr_w,'dd/mm/yyyy')||' '||hr_prim_horario_w,'dd/mm/yyyy hh24:mi');
			dt_prim_horario_w	:= dt_prim_horario_w - qt_minutos_p / 1440;
			if (clock_timestamp() >= dt_prim_horario_w) then
				ie_retorno_w	:= 'S';
				exit;
			end if;
			end;
		end if;

		if (ie_dose_espec_agora_w = 'S') and (hr_dose_especial_w IS NOT NULL AND hr_dose_especial_w::text <> '') and (hr_dose_especial_w <> '  :  ') then
			begin
			/*if	(hr_dose_especial_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then
				dt_inicio_prescr_w	:= dt_inicio_prescr_w + 1;
			end if;*/
			dt_prim_horario_w	:= to_date(to_char(dt_inicio_prescr_w,'dd/mm/yyyy')||' '||hr_dose_especial_w,'dd/mm/yyyy hh24:mi');
			if (dt_prim_horario_w < dt_prescricao_w) then
				dt_prim_horario_w := dt_prim_horario_w + 1;
			end if;
			dt_prim_horario_w	:= dt_prim_horario_w - qt_minutos_p / 1440;

			if (clock_timestamp() >= dt_prim_horario_w) then
				ie_retorno_w	:= 'S';
				exit;
			end if;
			end;
		end if;
	end if;
	end;
end loop;
close C01;

if (ie_retorno_w = 'N') then
	begin
	open C02;
	loop
	fetch C02 into
		dt_inicio_prescr_w,
		hr_prim_horario_w,
		ie_urgencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		if (ie_urgencia_w = 'S') then
			ie_retorno_w	:= 'S';
			exit;
		end if;

		if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') and (hr_prim_horario_w <> '  :  ') then
			begin
			if (hr_prim_horario_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then
				dt_inicio_prescr_w	:= dt_inicio_prescr_w + 1;
			end if;
			dt_prim_horario_w	:= to_date(to_char(dt_inicio_prescr_w,'dd/mm/yyyy')||' '||hr_prim_horario_w,'dd/mm/yyyy hh24:mi');
			dt_prim_horario_w	:= dt_prim_horario_w - qt_minutos_p / 1440;
			if (clock_timestamp() >= dt_prim_horario_w) then
				ie_retorno_w	:= 'S';
				exit;
			end if;
			end;
		end if;
		end;
	end loop;
	close C02;
	end;
end if;

if (ie_retorno_w = 'N') and (ie_classif_urgente_w = 'S') then

	select	max(ie_motivo_prescricao)
	into STRICT	ie_motivo_prescricao_w
	from	prescr_medica
	where	nr_prescricao	=	nr_prescricao_p;

	if (ie_motivo_prescricao_w = '7') then
		ie_retorno_w := 'S';
	end if;
end if;

return ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_prescr_agora ( nr_prescricao_p bigint, qt_minutos_p bigint, cd_intervalo_p text) FROM PUBLIC;

