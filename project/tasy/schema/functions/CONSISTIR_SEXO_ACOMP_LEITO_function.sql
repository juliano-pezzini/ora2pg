-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consistir_sexo_acomp_leito (nr_atendimento_p bigint, nr_seq_interno_para_p bigint, nr_seq_interno_para_acomp_p bigint default null, ie_considera_ctrl_visita_p text default 'N') RETURNS varchar AS $body$
DECLARE


ie_achou_sexo_diferente_w 		varchar(1) := 'N';
cd_setor_atendimento_para_w 	unidade_atendimento.cd_setor_atendimento%type;
cd_unidade_basica_para_w 		unidade_atendimento.cd_unidade_basica%type;
cd_unidade_compl_para_w 		unidade_atendimento.cd_unidade_compl%type;
cd_paciente_reserva_w		    bigint;
nr_agrupamento_acom_w		    integer;
dt_acompanhante_w		        atendimento_acompanhante.dt_acompanhante%type;
cd_unid_comp_acom_ww		    varchar(10);
cd_unidade_basica_acom_ww	    varchar(10);

c01 CURSOR FOR
	SELECT	cd_paciente_reserva cd_pessoa_acompanhante,
			null dt_acompanhante
	from	unidade_atendimento
	where	nr_atendimento_acomp = nr_atendimento_p
	and 	ie_status_unidade = 'M'
	
union

	SELECT	cd_pessoa_fisica cd_pessoa_acompanhante,
			dt_acompanhante
	from	atendimento_acompanhante a
	where	nr_atendimento = nr_atendimento_p
    and 	ie_alojamento = 'S'
	and		not exists (select	1
						from	unidade_atendimento b
						where	b.nr_atendimento_acomp = a.nr_atendimento
						and	b.cd_paciente_reserva = a.cd_pessoa_fisica)
	and 	a.dt_acompanhante = (select max(x.dt_acompanhante)
								 from   atendimento_acompanhante  x
								 where  x.nr_atendimento   = nr_atendimento_p
								 and    x.cd_pessoa_fisica = a.cd_pessoa_fisica)
	and		ie_considera_ctrl_visita_p = 'S'
	and		coalesce(a.dt_saida::text, '') = '';

BEGIN
	select	max(cd_setor_atendimento),
			max(cd_unidade_basica),
            max(cd_unidade_compl)
	into STRICT	cd_setor_atendimento_para_w,
			cd_unidade_basica_para_w,
            cd_unidade_compl_para_w
	from	unidade_atendimento
	where	nr_seq_interno = nr_seq_interno_para_p;

    select 	a.nr_agrupamento
    into STRICT	nr_agrupamento_acom_w
    from	unidade_atendimento a
    where	a.cd_unidade_basica	= cd_unidade_basica_para_w
    and 	a.cd_unidade_compl	= cd_unidade_compl_para_w
    and	a.cd_setor_atendimento	= cd_setor_atendimento_para_w;

	open C01;
	loop
		fetch C01 into cd_paciente_reserva_w,
					   dt_acompanhante_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		
		if (coalesce(nr_seq_interno_para_acomp_p::text, '') = '') then
            Select	max(cd_unidade_compl)
            into STRICT	cd_unid_comp_acom_ww
            from	unidade_atendimento
            where   cd_unidade_basica	 = cd_unidade_basica_para_w
            and     cd_unidade_compl	 <> cd_unidade_compl_para_w
            and	    cd_setor_atendimento = cd_setor_atendimento_para_w
            and	    ie_status_unidade in ('L');
        else
            begin
                Select	cd_unidade_compl
               into STRICT	cd_unid_comp_acom_ww
               from	unidade_atendimento
               where   nr_seq_interno = nr_seq_interno_para_acomp_p;
            exception
                when others then
                    cd_unid_comp_acom_ww := null;
            end;
        end if;
		
		if (coalesce(cd_unid_comp_acom_ww::text, '') = '') then
			select	max(cd_unidade_basica)
			into STRICT	cd_unidade_basica_acom_ww
			from 	unidade_atendimento
			where	cd_unidade_basica	<> cd_unidade_basica_para_w
			and	nr_agrupamento	= nr_agrupamento_acom_w
			and	cd_setor_atendimento	= cd_setor_atendimento_para_w
			and 	ie_status_unidade IN ('L');
		end if;
		
		if (obter_se_leito_sexo_acomp_pan(cd_setor_atendimento_para_w, cd_unidade_basica_para_w, coalesce(cd_unid_comp_acom_ww, cd_unidade_basica_acom_ww) , nr_atendimento_p, dt_acompanhante_w, cd_paciente_reserva_w) = 'N') then
			ie_achou_sexo_diferente_w := 'S';
		end if;
	end loop;

	return ie_achou_sexo_diferente_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consistir_sexo_acomp_leito (nr_atendimento_p bigint, nr_seq_interno_para_p bigint, nr_seq_interno_para_acomp_p bigint default null, ie_considera_ctrl_visita_p text default 'N') FROM PUBLIC;

