-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_valor_item_mens ( nr_seq_mensalidade_seg_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/*	'1' - Preço pré-estabelecido
	'2' - Taxa de inscrição
	'3' - Co-participação
	'4' - Reajuste - Variação de custo
	'5' - Reajuste - Mudança de faixa-etária
	'6' - Preço pós-estabelecido por custo operacional
	'7' - Preço pós-estabelecido por rateio
	'8' - Preço misto
	'9' - Valor da taxa de administração
	'10' - Valor de manutenção
	'11' - Via adicional de cartão de identificação
	'12' - Preço pré-estabelecido não subsidiado
	'13' - Valores não cobertos pelo contrato
	'14' - Bonificação
	'15' - Serviços e coberturas adicionais
	'16' - Valor de saldo - Pagamento a menor parcela anterior
	'17' - Taxa de emissão de boleto
	'18' - Valor parcela da negociação de débito
	'MA' -  Preço pré-estabelecido do segurado no mês anterior
	'A' - Lançamentos adicionais	*/
vl_retorno_w			double precision	:= 0;
vl_item_w			double precision	:= 0;
vl_total_item_w			double precision	:= 0;
nr_seq_mensalidade_seg_w	bigint;
nr_seq_mens_seg_item_w		bigint;
vl_taxa_boleto_w		double precision;
dt_mesano_refere_w		timestamp;
nr_seq_segurado_w		bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_mensalidade_segurado
	where	nr_sequencia	= nr_seq_mensalidade_seg_p;

C02 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_mensalidade_seg_item
	where	nr_seq_mensalidade_seg	= nr_seq_mensalidade_seg_w;


BEGIN

if (coalesce(nr_seq_mensalidade_seg_p,0) > 0) then
	vl_item_w		:= 0;
	vl_total_item_w		:= 0;
	if (ie_opcao_p <> 'A') then
		select	coalesce(sum(b.vl_item),0)
		into STRICT	vl_total_item_w
		from	pls_mensalidade_seg_item	b,
			pls_mensalidade_segurado	a
		where	a.nr_sequencia			= b.nr_seq_mensalidade_seg
		and	a.nr_sequencia			= nr_seq_mensalidade_seg_p
		and	b.ie_tipo_item			= ie_opcao_p
		and	coalesce(b.ie_tipo_mensalidade, 'N') = 'N';

		if (ie_opcao_p = '17') then
			select	sum(b.vl_taxa_boleto)
			into STRICT	vl_taxa_boleto_w
			from	pls_mensalidade_seg_item	b,
				pls_mensalidade_segurado	a
			where	a.nr_sequencia			= b.nr_seq_mensalidade_seg
			and	a.nr_sequencia			= nr_seq_mensalidade_seg_p
			and	coalesce(b.ie_tipo_mensalidade, 'N') = 'N';

			vl_total_item_w	:= coalesce(vl_total_item_w,0) + coalesce(vl_taxa_boleto_w,0);
		end if;

		if (ie_opcao_p	= 'MA') then
			vl_total_item_w	:= 0;

			select	dt_mesano_referencia,
				nr_seq_segurado
			into STRICT	dt_mesano_refere_w,
				nr_seq_segurado_w
			from	pls_mensalidade_segurado
			where	nr_sequencia			= nr_seq_mensalidade_seg_p;

			select	coalesce(sum(b.vl_item),0)
			into STRICT	vl_total_item_w
			from	pls_mensalidade_seg_item	b,
				pls_mensalidade_segurado	a
			where	a.nr_sequencia			= b.nr_seq_mensalidade_seg
			and	a.nr_seq_segurado		= nr_seq_segurado_w
			and	b.ie_tipo_item			= 1
			and	coalesce(b.ie_tipo_mensalidade, 'N') = 'N'
			and	a.dt_mesano_referencia		= add_months(trunc(dt_mesano_refere_w,'month'),- 1);
		end if;
		/* OS 116311 - Felipe e Elton - Performance no Costa
		open c01;
		loop
		fetch c01 into	nr_seq_mensalidade_seg_w;
		exit when c01%notfound;
			open c02;
			loop
			fetch c02 into	nr_seq_mens_seg_item_w;
			exit when c02%notfound;

				select	nvl(sum(vl_item),0)
				into	vl_item_w
				from	pls_mensalidade_seg_item
				where	nr_sequencia	= nr_seq_mens_seg_item_w
				and	ie_tipo_item	= ie_opcao_p;

				vl_total_item_w		:= vl_total_item_w + vl_item_w;

			end loop;
			close c02;

		end loop;
		close c01; */
	else
		select	sum(vl_item)
		into STRICT	vl_total_item_w
		from	pls_mensalidade_seg_item
		where	nr_seq_mensalidade_seg	= nr_seq_mensalidade_seg_p
		and	ie_tipo_mensalidade = 'A';
	end if;

	vl_retorno_w	:= coalesce(vl_total_item_w,0);
end if;

return	coalesce(vl_retorno_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_valor_item_mens ( nr_seq_mensalidade_seg_p bigint, ie_opcao_p text) FROM PUBLIC;

