-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prescricoes_copia (NR_PRESCRICAO_P bigint, NR_ATENDIMENTO_P bigint, NM_USUARIO_P text, IE_AGRUPAMENTO_P bigint, nr_prescricoes_p text, hr_prescr_inicial_p text, hr_prescr_final_p text, cd_perfil_p bigint) RETURNS varchar AS $body$
DECLARE

			 
ds_retorno_w		varchar(2000) := null;
nr_prescricao_w		bigint;
nr_horas_copia_w	bigint;
ie_copia_farm_clinica_w		varchar(1);
cd_pessoa_fisica_ww		varchar(10);
dt_prescricao_ww		timestamp;
ie_origem_inf_filtro_w		varchar(10);
Prescr_dia_w			varchar(1) := 'S';
ie_copia_nao_liberadas_w	varchar(10);
ie_copia_REP_motivo_w		varchar(1);
ie_funcao_agrupar_w			varchar(2000);
ie_agrupa_prescr_atend_w	varchar(1)	:= 'S';	
nr_prescricoes_w		varchar(2000);

C001 CURSOR FOR 
SELECT		nr_prescricao 
 from		prescr_medica a 
where		nr_prescricao 		= nr_prescricao_p 
 and		coalesce(nr_prescricoes_p::text, '') = '' 
 and		coalesce(ie_emergencia,'N')	<> 'S' 
 and		not exists (SELECT 1 from cirurgia b 
		where a.nr_prescricao = b.nr_prescricao) 
 and		((coalesce(hr_prescr_inicial_p::text, '') = '') or (dt_prescricao >= to_date(to_char(dt_prescricao, 'dd/mm/yyyy') || hr_prescr_inicial_p, 'dd/mm/yyyy hh24:mi'))) 
 and		((coalesce(hr_prescr_final_p::text, '') = '') or (dt_prescricao <= to_date(to_char(dt_prescricao, 'dd/mm/yyyy') || hr_prescr_final_p, 'dd/mm/yyyy hh24:mi'))) 
and		((coalesce(nr_horas_copia_w,0) = 0) or (dt_prescricao	>= clock_timestamp() - nr_horas_copia_w/24)) 
and		((coalesce(ie_copia_farm_clinica_w,'S')	= 'S') or (coalesce(ie_prescr_farm,'N')	= 'N')) 

union
 
select		nr_prescricao 
 from		prescr_medica a 
where		nr_prescricao_mae 		= nr_prescricao_p 
 and		nr_prescricao			<> nr_prescricao_p 
 and		coalesce(ie_emergencia,'N')	<> 'S' 
 and		ie_agrupamento_p = 1 
 and		((coalesce(ie_copia_farm_clinica_w,'S')	= 'S') or (coalesce(ie_prescr_farm,'N')	= 'N')) 
 and		not exists (select 1 from cirurgia b 
		where a.nr_prescricao = b.nr_prescricao) 

union
 
select		nr_prescricao 
from		prescr_medica a 
where		cd_pessoa_fisica		= cd_pessoa_fisica_ww 
 and		((coalesce(nr_horas_copia_w,0) 	> 0) or (trunc(dt_prescricao,'dd')	= dt_prescricao_ww)) 
 and		((coalesce(hr_prescr_inicial_p::text, '') = '') or (dt_prescricao >= to_date(to_char(dt_prescricao, 'dd/mm/yyyy') || hr_prescr_inicial_p, 'dd/mm/yyyy hh24:mi'))) 
 and		((coalesce(hr_prescr_final_p::text, '') = '') or (dt_prescricao <= to_date(to_char(dt_prescricao, 'dd/mm/yyyy') || hr_prescr_final_p, 'dd/mm/yyyy hh24:mi'))) 
 and		((coalesce(nr_horas_copia_w,0) = 0) or (dt_prescricao	>= clock_timestamp() - nr_horas_copia_w/24))		 
 and		nr_prescricao			<> nr_prescricao_p 
 and		coalesce(ie_emergencia,'N')	<> 'S' 
 and		(((Prescr_dia_w	= 'F') and (Obter_Dados_Usuario_Opcao(a.nm_usuario_original,'F') = ie_origem_inf_filtro_w)) or 
		 ((Prescr_dia_w	= 'A') and (Obter_Dados_Usuario_Opcao(a.nm_usuario_original,'F') = ie_origem_inf_filtro_w or IE_PRESCR_FARM = 'S')) or 
		 (Prescr_dia_w = 'S' AND ie_origem_inf = '1') or (Prescr_dia_w = 'N')) 
 and		((ie_copia_nao_liberadas_w	= 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')) 
 and		((ie_copia_REP_motivo_w		= 'S') or (coalesce(a.IE_MOTIVO_PRESCRICAO::text, '') = '')) 
 and		((coalesce(ie_funcao_agrupar_w::text, '') = '') or (obter_se_contido_char(a.ie_funcao_prescritor,ie_funcao_agrupar_w) = 'S')) 
 and		ie_agrupamento_p		= 2 
 and		((ie_agrupa_prescr_atend_w = 'N') or (ie_agrupa_prescr_atend_w = 'S' AND nr_atendimento = nr_atendimento_p)) 
 and		not exists (select 1 from cirurgia b 
		where a.nr_prescricao = b.nr_prescricao) 
 and		((coalesce(ie_copia_farm_clinica_w,'S')	= 'S') or (coalesce(ie_prescr_farm,'N')	= 'N')) 

union
 
select		nr_prescricao 
 from		prescr_medica a 
where		cd_pessoa_fisica		= cd_pessoa_fisica_ww 
 and		coalesce(ie_emergencia,'N')	<> 'S' 
 and		nr_prescricoes_w like	'% ' || nr_prescricao || ' %' 
 and		((coalesce(ie_copia_farm_clinica_w,'S')	= 'S') or (coalesce(ie_prescr_farm,'N')	= 'N'))  
 and		not exists (select 1 from cirurgia b 
		where a.nr_prescricao = b.nr_prescricao);
			

BEGIN 
 
nr_horas_copia_w := Obter_Param_Usuario(924, 348, cd_perfil_p, nm_usuario_p, 0, nr_horas_copia_w);
ie_copia_farm_clinica_w := Obter_Param_Usuario(924, 434, cd_perfil_p, nm_usuario_p, 0, ie_copia_farm_clinica_w);
Prescr_dia_w := Obter_Param_Usuario(924, 52, cd_perfil_p, nm_usuario_p, 0, Prescr_dia_w);
ie_copia_nao_liberadas_w := Obter_Param_Usuario(924, 370, cd_perfil_p, nm_usuario_p, 0, ie_copia_nao_liberadas_w);
ie_copia_REP_motivo_w := Obter_Param_Usuario(924, 496, cd_perfil_p, nm_usuario_p, 0, ie_copia_REP_motivo_w);
ie_funcao_agrupar_w := Obter_Param_Usuario(924, 497, cd_perfil_p, nm_usuario_p, 0, ie_funcao_agrupar_w);
ie_agrupa_prescr_atend_w := Obter_Param_Usuario(924, 254, cd_perfil_p, nm_usuario_p, 0, ie_agrupa_prescr_atend_w);
 
nr_prescricoes_w	:= ' ' || nr_prescricoes_p || ' ';
nr_prescricoes_w	:= replace(nr_prescricoes_w, ',',' ');
nr_prescricoes_w	:= replace(nr_prescricoes_w, ' ',' ');
 
begin 
Select	cd_pessoa_fisica, 
	trunc(dt_prescricao,'dd') 
into STRICT	cd_pessoa_fisica_ww, 
	dt_prescricao_ww 
from prescr_medica 
where nr_prescricao = nr_prescricao_p;
exception 
when others then 
	null;
end;
 
select 	coalesce(max(a.ie_tipo_evolucao),'3') 
into STRICT	ie_origem_inf_filtro_w 
from	Medico b, 
	Usuario a 
where 	a.nm_usuario		= nm_usuario_p 
 and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 
 and	b.ie_situacao		= 'A';
  
open C001;
loop 
fetch C001 into	 
	nr_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on C001 */
	begin 
	if (coalesce(ds_retorno_w::text, '') = '') then 
		ds_retorno_w := nr_prescricao_w;
	else 
		ds_retorno_w := ds_retorno_w||', '||nr_prescricao_w;
	end if;
	end;
end loop;
close C001;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prescricoes_copia (NR_PRESCRICAO_P bigint, NR_ATENDIMENTO_P bigint, NM_USUARIO_P text, IE_AGRUPAMENTO_P bigint, nr_prescricoes_p text, hr_prescr_inicial_p text, hr_prescr_final_p text, cd_perfil_p bigint) FROM PUBLIC;

