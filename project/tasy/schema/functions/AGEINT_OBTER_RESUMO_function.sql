-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ageint_obter_resumo (cd_convenio_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_ageint_p bigint ) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(4000);
hr_agenda_w			varchar(20);
ds_item_w			varchar(255);
ds_orientacao_proc_w		varchar(255);
ds_orientacao_pac_w		varchar(255);
nr_seq_Agenda_cons_w		agenda_integrada_item.nr_seq_agenda_cons%type;
nr_seq_agenda_exame_w		agenda_integrada_item.nr_seq_agenda_exame%type;
ds_agenda_w			varchar(255);
nm_medico_exec_w		varchar(60);
ds_dados_agenda_w		varchar(255);
ds_observacao_w			varchar(4000);
nr_seq_item_w			bigint;
nr_seq_proc_interno_adic_w	bigint;
ds_exame_adic_w			varchar(100);
ie_prim_exame_adic_w		varchar(1)	:= 'S';

C01 CURSOR FOR
	SELECT	nr_sequencia,
		substr(to_char(Obter_Horario_item_Ageint(nr_seq_agenda_cons, nr_Seq_Agenda_exame,nr_sequencia),'dd/mm/yyyy hh24:mi'),1,20),
		substr(Obter_Item_Grid_Ageint(nr_seq_proc_interno, cd_medico, cd_Especialidade, cd_estabelecimento_p),1,255),
		substr(obter_orientacao_proc(0,0,cd_convenio_p,nr_seq_proc_interno, null,0),1,255),
		substr(obter_orient_exame_agenda(0,0,cd_convenio_p,nr_seq_proc_interno,nm_usuario_p,cd_estabelecimento_p,869),1,255),
		nr_seq_agenda_cons,
		nr_seq_agenda_exame
	from	agenda_integrada_item
	where	nr_seq_Agenda_int	= nr_Seq_ageint_p
	and ((nr_seq_agenda_exame IS NOT NULL AND nr_seq_agenda_exame::text <> '')
	or	(nr_seq_agenda_cons IS NOT NULL AND nr_seq_agenda_cons::text <> ''))
	order by 1;

C02 CURSOR FOR
	SELECT	nr_seq_proc_interno
	from	ageint_exame_adic_item
	where	nr_seq_item	= nr_seq_item_w
	order by 1;


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_item_w,
	hr_agenda_w,
	ds_item_w,
	ds_orientacao_proc_w,
	ds_orientacao_pac_w,
	nr_seq_agenda_cons_w,
	nr_seq_agenda_exame_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (nr_seq_agenda_exame_w IS NOT NULL AND nr_seq_agenda_exame_w::text <> '') then
		select	a.ds_agenda,
			substr(obter_nome_pf(b.cd_medico_exec),1,60),
			a.ds_observacao
		into STRICT	ds_agenda_w,
			nm_medico_exec_w,
			ds_observacao_w
		from	agenda a,
			agenda_paciente b
		where	a.cd_agenda	= b.cd_agenda
		and	b.nr_sequencia	= nr_seq_agenda_exame_w;

		if (ds_agenda_w IS NOT NULL AND ds_agenda_w::text <> '') then
			ds_dados_agenda_w	:= wheb_mensagem_pck.get_texto(791362) || ' ' || ds_agenda_w;
		end if;
		if (nm_medico_exec_w IS NOT NULL AND nm_medico_exec_w::text <> '') then
			ds_dados_agenda_w	:= ds_dados_agenda_w ||'	' || wheb_mensagem_pck.get_texto(791363) || ' ' || nm_medico_Exec_w;
		end if;
		if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
			ds_dados_agenda_w	:= ds_dados_agenda_w || chr(10) || wheb_mensagem_pck.get_texto(791365) || ' ' || ds_observacao_w;
		end if;
	else
		select	substr(obter_nome_pf(a.cd_pessoa_fisica),1,60),
			a.ds_observacao
		into STRICT	ds_agenda_w,
			ds_observacao_w
		from	agenda a,
			agenda_consulta b
		where	a.cd_agenda	= b.cd_agenda
		and	b.nr_sequencia	= nr_seq_agenda_cons_w;

		if (ds_agenda_w IS NOT NULL AND ds_agenda_w::text <> '') then
			ds_dados_agenda_w	:= wheb_mensagem_pck.get_texto(306975, 'DS_AGENDA_W=' || ds_agenda_w); -- Agenda: #@DS_AGENDA_W#@
		end if;
		if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
			ds_dados_agenda_w	:= ds_dados_agenda_w ||chr(10)|| wheb_mensagem_pck.get_texto(306976, null) || ' ' || ds_observacao_w; -- Observacao:
		end if;
	end if;
	if (ds_orientacao_proc_w IS NOT NULL AND ds_orientacao_proc_w::text <> '') then
		ds_orientacao_proc_w	:= wheb_mensagem_pck.get_texto(306977, null) ||chr(10)||ds_orientacao_proc_w||chr(10); -- Orientacoes para o exame:
	end if;
	if (ds_orientacao_pac_w IS NOT NULL AND ds_orientacao_pac_w::text <> '') then
		ds_orientacao_pac_w	:= wheb_mensagem_pck.get_texto(306978, null) ||chr(10)||ds_orientacao_pac_w||chr(10); -- Orientacoes ao paciente:
	end if;
	ds_retorno_w	:= substr(ds_retorno_w || hr_agenda_w||'	'||ds_item_w||chr(10)||ds_dados_agenda_w||chr(10)||ds_orientacao_proc_w||ds_orientacao_pac_w,1,4000);
	open C02;
	loop
	fetch C02 into
		nr_seq_proc_interno_adic_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		select	max(ds_proc_exame)
		into STRICT	ds_exame_adic_w
		from	proc_interno
		where	nr_sequencia	= nr_seq_proc_interno_adic_w;
		if (ie_prim_exame_adic_w	= 'S') then
			ds_retorno_w	:= substr(ds_retorno_w ||' ' || wheb_mensagem_pck.get_texto(306979, null) ||chr(10),1,4000); -- Exames adicionais
		end if;
		ds_retorno_w	:= substr(ds_retorno_w || '	' || ds_exame_adic_w ||chr(10),1,4000);
		ie_prim_exame_adic_w	:= 'N';
		end;
	end loop;
	close C02;
	ds_retorno_w	:= substr(ds_retorno_w ||chr(10),1,4000);
	ie_prim_exame_adic_w	:= 'S';
	end;
end loop;
close C01;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ageint_obter_resumo (cd_convenio_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_ageint_p bigint ) FROM PUBLIC;

