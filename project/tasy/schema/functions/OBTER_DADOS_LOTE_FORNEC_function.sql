-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_lote_fornec ( nr_sequencia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

/*' ie_opcao
D - Descricao
V - Validade
CF - CNPJ Fornecedor
DF - Descricao fornecedor
NF - Numero da Nota Fiscal
NFN - Numero da Nota Fiscal - Somente numero
SN - Sequencia da Nota Fiscal
NI - Nr Item da Nota
MA - Descricao da marca
SMA - Seq da marca
DMAT - Descr do material
CMAT - Codigo do material
DG - Digito do lote
CD - Codigo do Barras.
O - Origem do lote
NSE - Numero de Serie
CSAM - Codigo sistema anterior da marca
'*/
				
				
ds_lote_fornec_w		varchar(20);
dt_validade_w		timestamp;
cd_cgc_fornec_w		varchar(14);
nr_nota_fiscal_w		varchar(255);
nr_sequencia_nf_w		bigint;
nr_item_nf_w		integer;
ds_retorno_w		varchar(255);
ds_marca_w		varchar(255);
nr_seq_marca_w		bigint;
cd_material_w		integer;
ds_material_w		varchar(80);
nr_digito_verif_w		smallint;
cd_barra_material_w	material_lote_fornec.cd_barra_material%type;
ie_origem_lote_w		material_lote_fornec.ie_origem_lote%type;
nr_serie_material_w		material_lote_fornec.nr_serie_material%type;
cd_sistema_ant_marca_w	marca.cd_sistema_ant%type;


BEGIN

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	begin
	select	ds_lote_fornec,
		dt_validade,
		cd_cgc_fornec,
		nr_nota_fiscal,
		nr_sequencia_nf,
		nr_item_nf,
		substr(obter_desc_marca(nr_seq_marca),1,255) ds_marca,
		nr_seq_marca,
		cd_material,
		substr(obter_desc_material(cd_material),1,80) ds_material,
		nr_digito_verif,
		cd_barra_material,
		ie_origem_lote,
		nr_serie_material
	into STRICT	ds_lote_fornec_w,
		dt_validade_w,
		cd_cgc_fornec_w,
		nr_nota_fiscal_w,
		nr_sequencia_nf_w,
		nr_item_nf_w,
		ds_marca_w,
		nr_seq_marca_w,
		cd_material_w,
		ds_material_w,
		nr_digito_verif_w,
		cd_barra_material_w,
		ie_origem_lote_w,
		nr_serie_material_w
	from	material_lote_fornec
	where	nr_sequencia	= nr_sequencia_p;
	exception
	when others then
		null;
	end;



	if (ie_opcao_p = 'D') then
		ds_retorno_w	:= ds_lote_fornec_w;
	elsif (ie_opcao_p = 'V') then
		ds_retorno_w	:= to_char(dt_validade_w,'DD/MM/YYYY');
	elsif (ie_opcao_p = 'CF') then
		ds_retorno_w	:= cd_cgc_fornec_w;
	elsif (ie_opcao_p = 'DF') then
		ds_retorno_w	:= obter_nome_pf_pj(null, cd_cgc_fornec_w);
	elsif (ie_opcao_p = 'NF') then
		ds_retorno_w	:= nr_nota_fiscal_w;
	elsif (ie_opcao_p = 'NFN') then
		begin
		if (nr_nota_fiscal_w <> '') then
			nr_nota_fiscal_w := to_char(somente_numero(nr_nota_fiscal_w));
		end if;
		ds_retorno_w	:= nr_nota_fiscal_w;
		end;
	elsif (ie_opcao_p = 'SN') then
		ds_retorno_w	:= nr_sequencia_nf_w;
	elsif (ie_opcao_p = 'NI') then
		ds_retorno_w	:= nr_item_nf_w;
	elsif (ie_opcao_p = 'MA') then
		ds_retorno_w	:= ds_marca_w;
	elsif (ie_opcao_p = 'SMA') then
		ds_retorno_w	:= nr_seq_marca_w;
	elsif (ie_opcao_p = 'CMAT') then	
		ds_retorno_w	:= cd_material_w;
	elsif (ie_opcao_p = 'DMAT') then
		ds_retorno_w	:= ds_material_w;
	elsif (ie_opcao_p = 'DG') then
		ds_retorno_w	:= nr_digito_verif_w;
	elsif (ie_opcao_p = 'CD') then
		ds_retorno_w := cd_barra_material_w;
		if (coalesce(cd_barra_material_w::text, '') = '') then
			ds_retorno_w := lpad(nr_sequencia_p || nr_digito_verif_w,11,0);
		end if;
	elsif (ie_opcao_p = 'O') then
		ds_retorno_w	:= ie_origem_lote_w;
	elsif (ie_opcao_p = 'NSE') then
		ds_retorno_w	:= nr_serie_material_w;
	elsif (nr_seq_marca_w > 0) and (ie_opcao_p = 'CSAM') then
		
		select	cd_sistema_ant
		into STRICT	cd_sistema_ant_marca_w
		from	marca
		where	nr_sequencia = nr_seq_marca_w;
		ds_retorno_w := cd_sistema_ant_marca_w;	
	end if;	

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_lote_fornec ( nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

