-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_pr_prev_etapa_proj ( nr_seq_proj_p bigint,dt_ref_p timestamp ) RETURNS bigint AS $body$
DECLARE

/* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Obter percentual previsto de execução de uma etapa do projeto
---------------------------------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ]  Relatórios [ ] Outros:
 --------------------------------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
pr_retorno_w		double precision := 0;
hrs_prev_w		double precision;
dias_uteis_w		double precision;
dias_uteis_data_atual_w	double precision;
hrs_executadas_prev_w	double precision;
total_hrs_prev_w	double precision := 0;
total_hrs_exec_prev_w	double precision := 0;
dt_inicio_prev_w	timestamp;


C01 CURSOR FOR

SELECT  e.qt_hora_prev hrs_previstas,
	obter_dias_uteis_periodo(e.dt_inicio_prev, e.dt_fim_prev, 1) dias_uteis,
        obter_dias_uteis_periodo(e.dt_inicio_prev, trunc(dt_ref_p), 1) dias_uteis_data_atual
from    proj_projeto p,
	proj_cronograma c,
	proj_cron_etapa e
where	p.nr_sequencia = c.nr_seq_proj
and     c.nr_sequencia = e.nr_seq_cronograma
and     c.ie_situacao  = 'A'
and 	p.nr_sequencia = nr_seq_proj_p
and	e.ie_fase = 'N'
and	(c.dt_aprovacao IS NOT NULL AND c.dt_aprovacao::text <> '')
and  	not exists (SELECT 1 from proj_cron_etapa xx where xx.nr_seq_superior =  e.nr_sequencia)
order by c.ie_tipo_cronograma, e.dt_inicio_prev;


BEGIN

	select  min(e.dt_inicio_prev)
	into STRICT	dt_inicio_prev_w
	from    proj_projeto p,
		proj_cronograma c,
		proj_cron_etapa e
	where	p.nr_sequencia = c.nr_seq_proj
	and     c.nr_sequencia = e.nr_seq_cronograma
	and     c.ie_situacao  = 'A'
	and 	p.nr_sequencia = nr_seq_proj_p
	and	e.ie_fase = 'N'
	and	(c.dt_aprovacao IS NOT NULL AND c.dt_aprovacao::text <> '')
	and  	not exists (SELECT 1 from proj_cron_etapa xx where xx.nr_seq_superior =  e.nr_sequencia);


	if (dt_ref_p < dt_inicio_prev_w) then
		pr_retorno_w := 0;

	else
		open C01;
		loop
		fetch C01 into
			hrs_prev_w,
			dias_uteis_w,
			dias_uteis_data_atual_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

				if (dias_uteis_data_atual_w >= dias_uteis_w) then
					hrs_executadas_prev_w := hrs_prev_w;
				else
					hrs_executadas_prev_w := ((dias_uteis_data_atual_w / dias_uteis_w) * hrs_prev_w);
				end if;

				total_hrs_exec_prev_w := total_hrs_exec_prev_w + hrs_executadas_prev_w;
				total_hrs_prev_w := total_hrs_prev_w + hrs_prev_w;

			end;
		end loop;
		close C01;

		if (total_hrs_exec_prev_w = 0 and total_hrs_prev_w = 0)then
			pr_retorno_w := 0;
		else
			pr_retorno_w := ((total_hrs_exec_prev_w / total_hrs_prev_w) * 100);
		end if;
	end if;

return  pr_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_pr_prev_etapa_proj ( nr_seq_proj_p bigint,dt_ref_p timestamp ) FROM PUBLIC;

