-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lic_obter_vl_fim_item_lote ( nr_seq_licitacao_p bigint, nr_seq_lic_item_p bigint, nr_seq_fornec_p bigint) RETURNS bigint AS $body$
DECLARE


vl_item_w				double precision;
nr_seq_lote_w			integer;
pr_diferenca_w			double precision;
vl_proposta_inicial_w		double precision;
vl_diferenca_w			double precision := 0;
vl_retorno_w			double precision := 0;
qt_item_w			double precision;
qt_registros_w			bigint;
ie_lance_zerado_w		varchar(1) := 'N';
vl_lote_inicial_w		double precision;


BEGIN

select	nr_seq_lote,
	qt_item
into STRICT	nr_seq_lote_w,
	qt_item_w
from	reg_lic_item
where	nr_seq_licitacao = nr_seq_licitacao_p
and	nr_seq_lic_item = nr_seq_lic_item_p;

select	vl_original
into STRICT	vl_lote_inicial_w
from	reg_lic_item_fornec
where	nr_seq_licitacao = nr_seq_licitacao_p
and	nr_seq_lic_item = nr_seq_lote_w
and	nr_seq_fornec = nr_seq_fornec_p;

select	coalesce(max(vl_item),0)
into STRICT	vl_item_w
from	reg_lic_vencedor
where	nr_seq_licitacao = nr_seq_licitacao_p
and	nr_seq_lic_item = nr_seq_lote_w;

/*OS 512333*/

select	coalesce(max(a.vl_item),0)
into STRICT	vl_proposta_inicial_w
from	reg_lic_item_fornec_lote a
where	a.nr_seq_licitacao = nr_seq_licitacao_p
and	a.nr_seq_lic_item = nr_seq_lic_item_p
and	a.nr_seq_lic_item_fornec in (
		SELECT	x.nr_sequencia
		from	reg_lic_item_fornec x
		where	x.nr_seq_licitacao = nr_seq_licitacao_p
		and	x.nr_seq_lic_item = nr_seq_lote_w
		and	x.nr_seq_fornec = nr_seq_fornec_p);


/*OS 512333*/

select	count(*)
into STRICT	qt_registros_w
from	reg_lic_fornec_lance a
where	a.nr_seq_licitacao = nr_seq_licitacao_p
and	a.nr_seq_lic_item = nr_seq_lote_w
and	a.nr_seq_fornec = nr_seq_fornec_p;

/*OS 512333*/

if (qt_registros_w = 1) then
	select	count(*)
	into STRICT	qt_registros_w
	from	reg_lic_fornec_lance a
	where	a.nr_seq_licitacao = nr_seq_licitacao_p
	and	a.nr_seq_lic_item = nr_seq_lote_w
	and	a.nr_seq_fornec = nr_seq_fornec_p
	and	coalesce(a.vl_item,0) = 0;

	if (qt_registros_w = 1) then
		ie_lance_zerado_w := 'S';
	end if;
end if;

/*Não usei o dividir porque ele só usa 4 casas decimais. E para esse caso eu preciso mais  */

if (ie_lance_zerado_w = 'N') then
	pr_diferenca_w	:= ((vl_item_w * 100) / vl_lote_inicial_w);
	pr_diferenca_w	:= pr_diferenca_w - 100;

	if (pr_diferenca_w <= 0) then
		vl_diferenca_w	:= abs(((vl_proposta_inicial_w * pr_diferenca_w)/100));
		vl_retorno_w	:= ((vl_proposta_inicial_w - vl_diferenca_w) * qt_item_w);
	else
		vl_diferenca_w	:= abs(((vl_lote_inicial_w * pr_diferenca_w)/100));
		vl_retorno_w	:= dividir((vl_lote_inicial_w - vl_diferenca_w) , qt_item_w);
	end if;
else
	vl_retorno_w := vl_proposta_inicial_w * qt_item_w; --OS 512333
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lic_obter_vl_fim_item_lote ( nr_seq_licitacao_p bigint, nr_seq_lic_item_p bigint, nr_seq_fornec_p bigint) FROM PUBLIC;

