-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_vl_exame_laborat (nr_seq_exame_p bigint) RETURNS bigint AS $body$
DECLARE



vl_retorno_w		double precision;
cd_cgc_externo_w	varchar(14);
ie_exame_externo_w	varchar(1);


BEGIN


select	coalesce(max(cd_cgc_externo),'0')
into STRICT	cd_cgc_externo_w
from	exame_laboratorio
where	nr_seq_exame = nr_seq_exame_p;

select	coalesce(max(ie_exame_externo),'N')
into STRICT	ie_exame_externo_w
from	exame_laboratorio
where	nr_seq_exame = nr_seq_exame_p;

if (cd_cgc_externo_w <> '0') then
	begin
	select	max(b.vl_exame)
	into STRICT	vl_retorno_w
	from	lab_tab_preco_externo a,
		lab_tab_preco_externo_item b
	where	a.dt_inicio_vigencia < clock_timestamp()
	and	coalesce(a.dt_fim_vigencia,clock_timestamp()) >= clock_timestamp()
	and	((b.dt_inicio_vigencia < clock_timestamp())  or (coalesce(b.dt_inicio_vigencia::text, '') = ''))
	and	coalesce(b.dt_fim_vigencia,clock_timestamp()) >= clock_timestamp()
	and	a.nr_sequencia = b.nr_seq_tab_preco
	and	a.cd_cgc_externo = cd_cgc_externo_w
	and	b.nr_seq_exame = nr_seq_exame_p;
	end;
elsif (ie_exame_externo_w = 'S') then
	begin
	select	max(b.vl_exame)
	into STRICT	vl_retorno_w
	from	lab_tab_preco_externo a,
		lab_tab_preco_externo_item b
	where	a.dt_inicio_vigencia < clock_timestamp()
	and	coalesce(a.dt_fim_vigencia,clock_timestamp()) >= clock_timestamp()
	and	((b.dt_inicio_vigencia < clock_timestamp())  or (coalesce(b.dt_inicio_vigencia::text, '') = ''))
	and	coalesce(b.dt_fim_vigencia,clock_timestamp()) >= clock_timestamp()
	and	a.nr_sequencia = b.nr_seq_tab_preco
	and	b.nr_seq_exame = nr_seq_exame_p;
	end;
end if;
return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_vl_exame_laborat (nr_seq_exame_p bigint) FROM PUBLIC;

