-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_menor_intervalo_agora ( ie_opcao_p text, nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE


cd_intervalo_w		varchar(7);
cd_setor_w		bigint;
cd_estabelecimento_w	integer;


BEGIN

select	max(cd_setor_atendimento),
		max(cd_estabelecimento)
into STRICT	cd_setor_w,
	cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select	max(cd_intervalo)
into STRICT	cd_intervalo_w
from	intervalo_prescricao
where	Obter_se_intervalo(cd_intervalo, ie_opcao_p) = 'S'
and	obter_se_exibe_intervalo(nr_prescricao_p, cd_intervalo, cd_setor_w) = 'S'
and	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w))
and	ie_agora	= 'S'
--and	nvl(ie_se_farmacia_amb,'N') <> 'S'
and 	coalesce(ie_padrao_agora,'N') = 'S'
and	ie_situacao	= 'A';

if (coalesce(cd_intervalo_w,'XPTO') = 'XPTO') then
	select	max(cd_intervalo)
	into STRICT	cd_intervalo_w
	from	intervalo_prescricao
	where	coalesce(qt_min_agora::text, '') = ''
	and	Obter_se_intervalo(cd_intervalo, ie_opcao_p) = 'S'
	--and	nvl(ie_se_farmacia_amb,'N') <> 'S'
	and	obter_se_exibe_intervalo(nr_prescricao_p, cd_intervalo, cd_setor_w) = 'S'
	and	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w))
	and	ie_agora	= 'S'
	and	ie_situacao	= 'A';

	if (coalesce(cd_intervalo_w,'XPTO') = 'XPTO') then
		select	max(cd_intervalo)
		into STRICT	cd_intervalo_w
		from	intervalo_prescricao
		where	qt_min_agora	= (SELECT	min(qt_min_agora)
					   from		intervalo_prescricao
					   where	(qt_min_agora IS NOT NULL AND qt_min_agora::text <> '')
					   and	Obter_se_intervalo(cd_intervalo, ie_opcao_p) = 'S'
					   and	obter_se_exibe_intervalo(nr_prescricao_p,cd_intervalo, cd_setor_w) = 'S'
					   and	ie_agora	= 'S'
					   --and	nvl(ie_se_farmacia_amb,'N') <> 'S'
					   and	ie_situacao	= 'A')
		and	Obter_se_intervalo(cd_intervalo, ie_opcao_p) = 'S'
		--and	nvl(ie_se_farmacia_amb,'N') <> 'S'
		and	obter_se_exibe_intervalo(nr_prescricao_p, cd_intervalo, cd_setor_w) = 'S'
		and	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w))
		and	ie_agora	= 'S'
		and	ie_situacao	= 'A';
	end if;
end if;
return	cd_intervalo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_menor_intervalo_agora ( ie_opcao_p text, nr_prescricao_p bigint) FROM PUBLIC;

