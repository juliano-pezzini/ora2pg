-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION reinf_4020_dados_trib_nota ( nr_seq_nota_p bigint, ie_tipo_valor_p text, ie_tipo_tributo_p text, ie_exigibilidade_p text, cd_estabelecimento_p bigint, ie_exig_susp_forma_p text default null) RETURNS bigint AS $body$
DECLARE


vl_item_tributo_w 			nota_fiscal_item_trib.vl_tributo%type;
vl_item_base_calculo_w		nota_fiscal_item_trib.vl_base_calculo%type;
tx_item_tributo_w			nota_fiscal_item_trib.tx_tributo%type;
vl_tributo_w			nota_fiscal_trib.vl_tributo%type;
vl_base_calculo_w			nota_fiscal_trib.vl_base_calculo%type;
tx_tributo_w			nota_fiscal_trib.tx_tributo%type;
vl_total_trib_w			nota_fiscal_trib.vl_tributo%type;
vl_total_base_trib_w		nota_fiscal_trib.vl_base_calculo%type;
tx_total_trib_w			nota_fiscal_trib.tx_tributo%type;
ds_retorno_w			double precision;
				

BEGIN

if (ie_exigibilidade_p = 'S') then
	begin
		select	coalesce(sum(n.vl_tributo),0),
			coalesce(sum(n.vl_base_calculo),0),
			coalesce(sum(n.tx_tributo),0)
		into STRICT	vl_tributo_w,
			vl_base_calculo_w,
			tx_tributo_w
		from	nota_fiscal_trib n,
			tributo_conta_pagar tc,
			tributo t
		where	n.nr_seq_regra_trib = tc.nr_sequencia
		and	t.cd_tributo = n.cd_tributo
		and	tc.cd_tributo = t.cd_tributo		
		and	n.nr_sequencia = nr_seq_nota_p
		and	((coalesce(ie_tipo_tributo_p,'X') = 'X') or (t.ie_tipo_tributo = ie_tipo_tributo_p))
		and	tc.ie_exigibilidade_suspensa = 'S'
		and	n.cd_tributo in (SELECT cd_tributo from fis_reinf_r4020_regra where cd_estabelecimento = cd_estabelecimento_p and ie_tipo_data = 1)
		and	((tc.ie_exig_susp_forma = ie_exig_susp_forma_p) or (coalesce(ie_exig_susp_forma_p::text, '') = ''));
		
		select	coalesce(sum(n.vl_tributo),0),
			coalesce(sum(n.vl_base_calculo),0),
			coalesce(sum(n.tx_tributo),0)
		into STRICT	vl_item_tributo_w,
			vl_item_base_calculo_w,
			tx_item_tributo_w
		from	nota_fiscal_item_trib n,
			tributo_conta_pagar tc,
			tributo t
		where	n.nr_seq_regra_trib = tc.nr_sequencia
		and	t.cd_tributo = n.cd_tributo
		and	tc.cd_tributo = t.cd_tributo		
		and	n.nr_sequencia = nr_seq_nota_p
		and	((coalesce(ie_tipo_tributo_p,'X') = 'X') or (t.ie_tipo_tributo = ie_tipo_tributo_p))
		and	tc.ie_exigibilidade_suspensa = 'S'
		and	n.cd_tributo in (SELECT cd_tributo from fis_reinf_r4020_regra where cd_estabelecimento = cd_estabelecimento_p and ie_tipo_data = 1)
		and	((tc.ie_exig_susp_forma = ie_exig_susp_forma_p) or (coalesce(ie_exig_susp_forma_p::text, '') = ''));
		
		vl_total_trib_w 		:= vl_tributo_w 		+ vl_item_tributo_w;
		vl_total_base_trib_w 	:= vl_base_calculo_w	+ vl_item_base_calculo_w;
		tx_total_trib_w		:= tx_tributo_w 		+ tx_item_tributo_w;
	end;
else
	begin
		select	coalesce(sum(n.vl_tributo),0),
			coalesce(sum(n.vl_base_calculo),0),
			coalesce(sum(n.tx_tributo),0)
		into STRICT	vl_tributo_w,
			vl_base_calculo_w,
			tx_tributo_w
		FROM tributo t, nota_fiscal_trib n
LEFT OUTER JOIN tributo_conta_pagar tc ON (n.nr_seq_regra_trib = tc.nr_sequencia)
WHERE t.cd_tributo = n.cd_tributo and n.nr_sequencia = nr_seq_nota_p and ((coalesce(ie_tipo_tributo_p,'X') = 'X') or (t.ie_tipo_tributo = ie_tipo_tributo_p)) and n.cd_tributo in (SELECT cd_tributo from fis_reinf_r4020_regra where cd_estabelecimento = cd_estabelecimento_p and ie_tipo_data = 1) and (coalesce(tc.ie_exigibilidade_suspensa::text, '') = '' or tc.ie_exigibilidade_suspensa = 'N') and coalesce(tc.ie_exig_susp_forma::text, '') = '';
		
		select	coalesce(sum(n.vl_tributo),0),
			coalesce(sum(n.vl_base_calculo),0),
			coalesce(sum(n.tx_tributo),0)
		into STRICT	vl_item_tributo_w,
			vl_item_base_calculo_w,
			tx_item_tributo_w
		FROM tributo t, nota_fiscal_item_trib n
LEFT OUTER JOIN tributo_conta_pagar tc ON (n.nr_seq_regra_trib = tc.nr_sequencia)
WHERE t.cd_tributo = n.cd_tributo and n.nr_sequencia = nr_seq_nota_p and ((coalesce(ie_tipo_tributo_p,'X') = 'X') or (t.ie_tipo_tributo = ie_tipo_tributo_p)) and n.cd_tributo in (SELECT cd_tributo from fis_reinf_r4020_regra where cd_estabelecimento = cd_estabelecimento_p and ie_tipo_data = 1) and (coalesce(tc.ie_exigibilidade_suspensa::text, '') = '' or tc.ie_exigibilidade_suspensa = 'N') and coalesce(tc.ie_exig_susp_forma::text, '') = '';
		
			
		vl_total_trib_w 		:= vl_tributo_w 		+ vl_item_tributo_w;
		vl_total_base_trib_w 	:= vl_base_calculo_w	+ vl_item_base_calculo_w;
		tx_total_trib_w		:= tx_tributo_w 		+ tx_item_tributo_w;
	end;
end if;

if (ie_tipo_valor_p = 'B' )then
	ds_retorno_w := vl_total_base_trib_w;
elsif (ie_tipo_valor_p = 'V') then
	ds_retorno_w := vl_total_trib_w;
elsif (ie_tipo_valor_p = 'TX') then
	ds_retorno_w := tx_total_trib_w;
end if;


return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION reinf_4020_dados_trib_nota ( nr_seq_nota_p bigint, ie_tipo_valor_p text, ie_tipo_tributo_p text, ie_exigibilidade_p text, cd_estabelecimento_p bigint, ie_exig_susp_forma_p text default null) FROM PUBLIC;

