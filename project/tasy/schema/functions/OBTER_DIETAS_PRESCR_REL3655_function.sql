-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dietas_prescr_rel3655 ( nr_atendimento_p bigint, ie_tipo_dieta_p text default null, ie_observacao_p text default null) RETURNS varchar AS $body$
DECLARE


nm_dieta_w 	varchar(100);
ds_observacao_w	varchar(255);
ds_retorno_w 	varchar(2000):= '';

c01 CURSOR FOR

	SELECT 	distinct substr(obter_nome_dieta(a.cd_dieta),1,100),
		substr(a.ds_observacao,1,255)
	from 	prescr_dieta a
	where 	coalesce(a.ie_suspenso,'N') = 'N'
	and 	(((SELECT	d.ie_tipo_dieta
		from	dieta d
		where	d.cd_dieta = a.cd_dieta) = ie_tipo_dieta_p) or (coalesce(ie_tipo_dieta_p::text, '') = ''))
	and 	a.nr_prescricao = (select coalesce(max(c.nr_prescricao),0)
				from	prescr_dieta b,
					prescr_medica c
				where	c.nr_prescricao  = b.nr_prescricao
				and	c.nr_atendimento = nr_atendimento_p
				and 	(coalesce(c.dt_liberacao,c.dt_liberacao_medico) IS NOT NULL AND (coalesce(c.dt_liberacao,c.dt_liberacao_medico))::text <> '')
				and	substr(elimina_acentos(upper(obter_funcao_usuario_orig(c.nm_usuario_original))),1,3) = 'MED')
	
union

	select 	substr(obter_nome_dieta(a.cd_dieta),1,100),
		substr(a.ds_observacao,1,255)
	from 	prescr_dieta a
	where 	coalesce(a.ie_suspenso,'N') = 'N'
	and 	(((select	d.ie_tipo_dieta
		from	dieta d
		where	d.cd_dieta = a.cd_dieta) = ie_tipo_dieta_p) or (coalesce(ie_tipo_dieta_p::text, '') = ''))
	and 	a.nr_prescricao = ( select coalesce(max(c.nr_prescricao),0)
				from  	prescr_dieta b,
					prescr_medica c
				where	c.nr_prescricao  = b.nr_prescricao
				and	c.nr_atendimento = nr_atendimento_p
				and	c.dt_prescricao	> clock_timestamp() - interval '1 days'
				and (coalesce(c.dt_liberacao,c.dt_liberacao_medico) IS NOT NULL AND (coalesce(c.dt_liberacao,c.dt_liberacao_medico))::text <> '')
				and substr(elimina_acentos(upper(obter_funcao_usuario_orig(c.nm_usuario_original))),1,3) = 'ENF')
	
union

	select	substr(obter_nome_dieta(a.cd_dieta),1,100),
		substr(a.ds_observacao,1,255)
	from	prescr_dieta a
	where	coalesce(a.ie_suspenso,'N') = 'N'
	and 	(((select	d.ie_tipo_dieta
		from	dieta d
		where	d.cd_dieta = a.cd_dieta) = ie_tipo_dieta_p) or (coalesce(ie_tipo_dieta_p::text, '') = ''))
	and	a.nr_prescricao	= ( select coalesce(max(c.nr_prescricao),0)
	from	prescr_dieta b,
		prescr_medica c
	where	c.nr_prescricao  = b.nr_prescricao
	and	c.nr_atendimento = nr_atendimento_p
	and	c.dt_prescricao	 > clock_timestamp() - interval '2 days'
	and	(coalesce(c.dt_liberacao,c.dt_liberacao_medico) IS NOT NULL AND (coalesce(c.dt_liberacao,c.dt_liberacao_medico))::text <> '')
	and	substr(elimina_acentos(upper(obter_funcao_usuario_orig(c.nm_usuario_original))),1,3) = 'NUT')
	and	not exists (select 1
			from	prescr_medica x
			where	x.nr_prescricao > a.nr_prescricao
			and	substr(elimina_acentos(upper(obter_funcao_usuario_orig(x.nm_usuario_original))),1,3) = 'NUT')
	order by 1;


BEGIN

open c01;
	loop
		fetch c01
		into	nm_dieta_w,
			ds_observacao_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */

		begin
			if ((nm_dieta_w IS NOT NULL AND nm_dieta_w::text <> '') and (coalesce(ie_observacao_p::text, '') = '')) then

				ds_retorno_w := substr(nm_dieta_w || ', ' || substr(ds_retorno_w,1,length(ds_retorno_w)-1),1,2000);

			elsif (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '' AND ie_observacao_p IS NOT NULL AND ie_observacao_p::text <> '') then

				ds_retorno_w := substr(ds_observacao_w || ', ' || substr(ds_retorno_w,1,length(ds_retorno_w)-1),1,2000);
			end if;
		end;
	end loop;
close c01;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dietas_prescr_rel3655 ( nr_atendimento_p bigint, ie_tipo_dieta_p text default null, ie_observacao_p text default null) FROM PUBLIC;

