-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_pode_acao_analise (cd_perfil_p perfil.cd_perfil%type, ie_permite_cancelar_p pls_cta_regra_ctrl.ie_excluir_lote%type, ie_permite_desfazer_p pls_cta_regra_ctrl.ie_desfazer_geracao_analise%type, ie_permite_gerar_p pls_cta_regra_ctrl.ie_gerar_analise%type, ie_origem_protocolo_p pls_protocolo_conta.ie_origem_protocolo%type) RETURNS varchar AS $body$
DECLARE


/*Os parâmetros abaixo, deverão receber valor de entrada S ou nulo  Apenas o parâmetro
referente a ação que esta sendo verificada as perrmissões no momento deve receber "S"
enquanto os demais devem receber valor nulo, pois não estão sendo validados no momento.
ie_permite_cancelar_p
ie_permite_desfazer_p
ie_permite_gerar_p
*/
ie_valor_w		varchar(1);
total_w			integer;
qtde_registros_origem_w	integer;


BEGIN

/*Mudou - Caso não tiver nenhuma regra para a origem de protocolo atual, então as ações estão liberadas para todos os perfis, caso tiver uma única regra que seja para
essa origem(seja ela permitindo ou não realizar a ação), então o usuário deverá estar utilizando um perfil onde permita fazer a ação que esta tentando executar
Ex: apenas uma regra criada para importação de xml, nessa regra não tem nenhum perfil informado. Então nesse caso, nenhma usuário utilizando nenhum perfil, poderá
éxecutar nenhuma ação. Alterando essa regra, informando um registro filho de perfil Conta médicas, então apenas esse perfil poderá executar essas ações.

*/
select	count(1)
into STRICT	qtde_registros_origem_w
from	pls_cta_regra_ctrl a
where	a.ie_origem_protocolo = ie_origem_protocolo_p;


ie_valor_w := 'S';

--Tem regra cadastrada para a origem de protocolo em questão.
if (qtde_registros_origem_w > 0) then

	--Muda o valor padrão para não nesse momento, pois se entrar aqui, significa que tem uma regra para essa origem, então para liberar a ação
	--será necessário ter uma regra que libere a mesma para o perfil utilizado. Caso não tiver nenhuma regra que libere isso, então irá inibir.
	ie_valor_w :='N';

	select	count(1) total_permite
	into STRICT	total_w
	from	pls_cta_regra_ctrl a
	where	a.ie_origem_protocolo = ie_origem_protocolo_p
	and (coalesce(ie_permite_cancelar_p::text, '') = '' or ie_excluir_lote = ie_permite_cancelar_p)
	and (coalesce(ie_permite_desfazer_p::text, '') = '' or ie_desfazer_geracao_analise = ie_permite_desfazer_p)
	and (coalesce(ie_permite_gerar_p::text, '') = '' or ie_gerar_analise = ie_permite_gerar_p)
	and		exists (	SELECT 	1
						from	pls_cta_perfil_ctrl b
						where	a.nr_sequencia = b.nr_seq_regra_ctrl
						and		cd_perfil = cd_perfil_p
						and		b.ie_situacao = 'A');

	if ( total_w > 0) then
		ie_valor_w := 'S';
	else
		ie_valor_w := 'N';
	end if;
end if;

return	ie_valor_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_pode_acao_analise (cd_perfil_p perfil.cd_perfil%type, ie_permite_cancelar_p pls_cta_regra_ctrl.ie_excluir_lote%type, ie_permite_desfazer_p pls_cta_regra_ctrl.ie_desfazer_geracao_analise%type, ie_permite_gerar_p pls_cta_regra_ctrl.ie_gerar_analise%type, ie_origem_protocolo_p pls_protocolo_conta.ie_origem_protocolo%type) FROM PUBLIC;

