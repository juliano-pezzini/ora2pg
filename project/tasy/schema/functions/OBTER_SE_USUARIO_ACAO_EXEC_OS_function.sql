-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_usuario_acao_exec_os ( nr_ordem_servico_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ie_acao_exec_w		varchar(1) := 'N';
nm_usuario_exec_os_w	varchar(15);
ie_tipo_exec_w		varchar(15);



BEGIN
if (nr_ordem_servico_p IS NOT NULL AND nr_ordem_servico_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	ie_tipo_exec_w := obter_param_usuario(296, 50, obter_perfil_Ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_tipo_exec_w);


	if (ie_tipo_exec_w in ('0','1')) then
		select	nm_usuario_exec
		into STRICT	nm_usuario_exec_os_w
		from	man_ordem_servico
		where	nr_sequencia = nr_ordem_servico_p;
	end if;


	if (coalesce(ie_tipo_exec_w,'2') in ('2','0')) then
		begin
		select	CASE WHEN count(a.nr_sequencia)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_acao_exec_w
		from	man_ordem_servico_exec a
		where	nr_seq_ordem	= nr_ordem_servico_p
		and	a.nm_usuario_exec 	= nm_usuario_p
		and	coalesce(a.nr_seq_tipo_exec::text, '') = ''
		and	(coalesce(a.dt_fim_execucao::text, '') = '' or ((not exists (SELECT	x.nr_sequencia
									from	usuario_grupo_des y,
										man_ordem_servico_exec x
									where	x.nm_usuario_exec = y.nm_usuario_grupo
									and	x.nr_seq_ordem = a.nr_seq_ordem
									and	coalesce(x.dt_fim_execucao::text, '') = '')
									and	exists (select	1
											from	usuario_grupo_des y,
												man_ordem_servico_exec x
											where	x.nm_usuario_exec = y.nm_usuario_grupo
											and	x.nr_seq_ordem = a.nr_seq_ordem)) and
							exists (select	1
								from	man_estagio_processo y,
									man_ordem_servico x
								where	x.nr_sequencia		= a.nr_seq_ordem
								and	x.nr_seq_estagio	= y.nr_sequencia
								and	y.ie_desenv		= 'S'))
			); /* Francisco - 08/09/2010 - Tratar data final de execucao */
		if (ie_acao_exec_w = 'N') then
			begin
			select	CASE WHEN count(a.nr_sequencia)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_acao_exec_w
			from	man_tipo_executor b,
				man_ordem_servico_exec a
			where	a.nr_seq_ordem 		= nr_ordem_servico_p
			and	a.nm_usuario_exec 		= nm_usuario_p
			and	b.nr_sequencia		= a.nr_seq_tipo_exec
			and	((phi_is_base_philips = 'S') and a.nr_seq_tipo_exec in (1,2,3)
                or (phi_is_base_philips = 'N') and b.ie_tipo_executor in (1,2,3,4))
			and	(coalesce(a.dt_fim_execucao::text, '') = '' or ((not exists (SELECT	x.nr_sequencia
										from	usuario_grupo_des y,
											man_ordem_servico_exec x
										where	x.nm_usuario_exec = y.nm_usuario_grupo
										and	x.nr_seq_ordem = a.nr_seq_ordem
										and	coalesce(x.dt_fim_execucao::text, '') = '')
										and	exists (select	1
												from	usuario_grupo_des y,
													man_ordem_servico_exec x
												where	x.nm_usuario_exec = y.nm_usuario_grupo
												and	x.nr_seq_ordem = a.nr_seq_ordem)) and
								exists (select	1
								from	man_estagio_processo y,
									man_ordem_servico x
								where	x.nr_sequencia		= a.nr_seq_ordem
								and	x.nr_seq_estagio	= y.nr_sequencia
								and	y.ie_desenv		= 'S')
								)
				); /* Francisco - 08/09/2010 - Tratar data final de execucao */
			end;
		end if;

		if (coalesce(ie_tipo_exec_w,'2') = '0') and (ie_acao_exec_w = 'N') and (nm_usuario_exec_os_w = nm_usuario_p) then
			ie_acao_exec_w := 'S';
		end if;
		end;
	elsif (coalesce(ie_tipo_exec_w,'2') = '1') and (nm_usuario_exec_os_w = nm_usuario_p) then
		ie_acao_exec_w := 'S';
	end if;
	end;
end if;
return ie_acao_exec_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_usuario_acao_exec_os ( nr_ordem_servico_p bigint, nm_usuario_p text) FROM PUBLIC;

