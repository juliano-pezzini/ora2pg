-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_permite_req_dia_aut ( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_local_estoque_destino_p bigint) RETURNS varchar AS $body$
DECLARE


cd_estabelecimento_w		bigint;
cd_local_estoque_w		bigint;
cd_local_estoque_destino_w		bigint;
qt_requisicao_dia_w		bigint;
qt_registro_w			bigint;
ds_retorno_w			varchar(1) := 'S';

c01 CURSOR FOR
SELECT	qt_requisicao_dia,
	cd_estabelecimento,
	cd_local_estoque,
	cd_local_estoque_destino
from	regra_req_permissao_qtde
where	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0))			= coalesce(cd_estabelecimento_p,0)
and	coalesce(cd_local_estoque, cd_local_estoque_p)				= cd_local_estoque_p
and	coalesce(cd_local_estoque_destino, coalesce(cd_local_estoque_destino_p,0))		= coalesce(cd_local_estoque_destino_p,0)
and	coalesce(ie_requisicao_auto,'S')						= 'S';


BEGIN

open C01;
loop
fetch C01 into
	qt_requisicao_dia_w,
	cd_estabelecimento_w,
	cd_local_estoque_w,
	cd_local_estoque_destino_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	requisicao_material a,
		item_requisicao_material b,
		estrutura_material_v e
	where	a.nr_requisicao = b.nr_requisicao
	and	b.cd_material = e.cd_material
	and	trunc(a.dt_solicitacao_requisicao,'dd') = trunc(clock_timestamp(),'dd')
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	((coalesce(cd_estabelecimento_p::text, '') = '') or (coalesce(cd_estabelecimento_w::text, '') = '') or (coalesce(a.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p))
	and	((coalesce(cd_local_estoque_p::text, '') = '') or (coalesce(cd_local_estoque_w::text, '') = '') or (coalesce(a.cd_local_estoque, cd_local_estoque_p)  = cd_local_estoque_p))
	and	((coalesce(cd_local_estoque_destino_p::text, '') = '') or (coalesce(cd_local_estoque_destino_w::text, '') = '') or (coalesce(a.cd_local_estoque_destino, cd_local_estoque_destino_p) = cd_local_estoque_destino_p));

	if (qt_registro_w >= qt_requisicao_dia_w) then
		ds_retorno_w := 'N';
	end if;

	end;
end loop;
close C01;


return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_permite_req_dia_aut ( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_local_estoque_destino_p bigint) FROM PUBLIC;

