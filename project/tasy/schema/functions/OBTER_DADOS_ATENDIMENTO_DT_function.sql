-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_atendimento_dt (NR_ATENDIMENTO_P bigint, IE_OPCAO_P text) RETURNS timestamp AS $body$
DECLARE


ds_retorno_w		timestamp;
nr_Atendimento_mae_w	bigint;
nr_seq_aux_w		bigint;

/*

DA	- Data alta.

DE	- Data entrada.

DR	- Data Saída Real

DAP	- Data Prevista Alta

DET	- Data entrada truncada

DC	- Data chamada paciente

DFC	- Data fim conta

AAM	- Alta atendimento mãe

DAM	- Data alta médico

FCO	- dt_fim_consulta

DATM	- Data atendimento médico
*/
BEGIN

IF (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') THEN

	IF (coalesce(ie_opcao_p, 'DA') = 'DA') THEN

		SELECT	max(a.dt_alta)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DE') THEN

		SELECT	a.dt_entrada

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DR') THEN

		SELECT	a.dt_saida_real

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DAP') = 'DAP') THEN

		SELECT	dt_previsto_alta

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DET') THEN

		SELECT	PKG_DATE_UTILS.START_OF(a.dt_entrada, 'dd')

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DC') THEN

		SELECT	a.dt_chamada_paciente

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DFC') THEN

		SELECT	PKG_DATE_UTILS.START_OF(dt_fim_conta, 'dd')

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'AAM') = 'AAM') THEN

		SELECT	max(nr_Atendimento_mae)

		INTO STRICT	nr_Atendimento_mae_w

		FROM	atendimento_paciente

		WHERE	nr_Atendimento	= nr_atendimento_p;


		SELECT	max(a.dt_alta)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_Atendimento_mae_w;

	ELSIF (coalesce(ie_opcao_p, 'DAM') = 'DAM') THEN

		SELECT	a.dt_alta_medico

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'FCO') = 'FCO') THEN

		SELECT	a.dt_fim_consulta

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p,'DATM') = 'DATM') THEN

		SELECT	PKG_DATE_UTILS.START_OF(MAX(dt_atend_medico), 'dd')

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente

		WHERE	nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DFA') THEN

		SELECT	MIN(nr_seq_interno)

		INTO STRICT	nr_seq_aux_w

		FROM	atend_paciente_unidade

		WHERE	nr_atendimento	= nr_atendimento_p;

		IF (nr_seq_aux_w IS NOT NULL AND nr_seq_aux_w::text <> '') THEN

			SELECT	MAX(a.dt_atualizacao_nrec)

			INTO STRICT	ds_retorno_w

			FROM	atend_paciente_unidade a

			WHERE	a.nr_seq_interno = nr_seq_aux_w;

		END IF;

	END IF;

END IF;

RETURN	ds_retorno_w;



END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_atendimento_dt (NR_ATENDIMENTO_P bigint, IE_OPCAO_P text) FROM PUBLIC;

