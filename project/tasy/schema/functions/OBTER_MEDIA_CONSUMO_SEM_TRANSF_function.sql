-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_media_consumo_sem_transf ( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_material_p bigint, ie_tipo_p text) RETURNS bigint AS $body$
DECLARE

 
qt_mes_consumo_w				smallint;
IE_MES_ATUAL_CONSUMO_w			varchar(1);

dt_mesano_inicio_w				timestamp;
dt_mesano_fim_w					timestamp;

vl_retorno_w					double precision;
qt_consumo_w					double precision;
vl_consumo_w					double precision;


BEGIN 
select 	max(qt_mes_consumo), 
		max(IE_MES_ATUAL_CONSUMO) 
into STRICT	qt_mes_consumo_w, 
		IE_MES_ATUAL_CONSUMO_w 
from 	PARAMETRO_COMPRAS 
where	cd_estabelecimento = cd_estabelecimento_p;
 
if (ie_mes_atual_consumo_w = 'S') then 
	dt_mesano_inicio_w 	:= PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.ADD_MONTH(clock_timestamp(),((qt_mes_consumo_w - 1) * -1), 0),'MONTH', 0);
	dt_mesano_fim_w		:= PKG_DATE_UTILS.start_of(clock_timestamp(),'MONTH', 0);
else 
	dt_mesano_inicio_w	:= PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.ADD_MONTH(clock_timestamp(),(qt_mes_consumo_w * -1), 0),'MONTH', 0);
	dt_mesano_fim_w		:= PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.ADD_MONTH(clock_timestamp(),-1, 0),'MONTH', 0);
end if;
 
select	coalesce(sum(a.qt_consumo),0) qt_estoque, 
		coalesce(sum(a.vl_consumo),0) vl_consumo 
into STRICT	qt_consumo_w, 
		vl_consumo_w 
from	movto_estoque_operacao_v a 
where	a.cd_estabelecimento	= cd_estabelecimento_p 
and		a.cd_local_estoque	= coalesce(cd_local_estoque_p, a.cd_local_estoque) 
and		a.cd_material		= cd_material_p 
and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between dt_mesano_inicio_w and dt_mesano_fim_w 
and not exists ( SELECT  1 
		 from	  operacao_nota x 
		 where	  x.cd_operacao_estoque = a.cd_operacao_estoque 
		 and	  coalesce(x.ie_transferencia_estab, 'N') = 'S');
 
 
qt_consumo_w 	:= dividir(qt_consumo_w,qt_mes_consumo_w);
vl_consumo_w	:= dividir(vl_consumo_w,qt_mes_consumo_w);
 
if (ie_tipo_p = 'Q') then 
	vl_retorno_w := qt_consumo_w;
elsif (ie_tipo_p = 'V') then 
	vl_retorno_w := vl_consumo_w;
end if;
 
return vl_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_media_consumo_sem_transf ( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_material_p bigint, ie_tipo_p text) FROM PUBLIC;

