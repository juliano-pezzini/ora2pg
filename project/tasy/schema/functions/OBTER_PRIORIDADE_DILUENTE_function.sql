-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prioridade_diluente ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_medicamento_p bigint, ie_tipo_diluicao_p text, ie_tipo_inf_p text default 'P') RETURNS varchar AS $body$
DECLARE


ie_param_813_rep_w	varchar(1);
nr_prescr_ant_w		prescr_medica.nr_prescricao%type;
nr_seq_ant_w		prescr_material.nr_sequencia%type;
cd_mat_diluente_w	prescr_material.cd_material%type;
ie_agrupador_tipo_w	prescr_material.ie_agrupador%type;
nr_seq_prioridade_w	material_diluicao.nr_seq_prioridade%type;
ds_retorno_w		varchar(255) := '';
qt_count_w			bigint;
ie_alt_dose_dil_w	prescr_material.ie_alterou_dose_dil%type;
nr_seq_prio_aux_w	varchar(255);
dt_prescr_ant_w		prescr_medica.dt_prescricao%type;
nr_atendimento_ant_w	prescr_medica.nr_atendimento%type;
nr_atendimento_atual_w 	prescr_medica.nr_atendimento%type;
ie_via_aplicacao_w		prescr_material.ie_via_aplicacao%type;

C01 CURSOR FOR
SELECT 	nr_seq_prioridade
from   	material_diluicao
where  	ie_reconstituicao = ie_tipo_diluicao_p
and	   	cd_material = cd_medicamento_p
and		cd_diluente = cd_mat_diluente_w
and		coalesce(ie_via_aplicacao,ie_via_aplicacao_w) = ie_via_aplicacao_w;


BEGIN

ie_param_813_rep_w := Obter_Param_Usuario(924, 813, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_param_813_rep_w);

if (ie_tipo_diluicao_p = 'N') then
	ie_agrupador_tipo_w := 3;
elsif (ie_tipo_diluicao_p = 'S') then
	ie_agrupador_tipo_w := 9;
elsif (ie_tipo_diluicao_p = 'R') then
	ie_agrupador_tipo_w := 7;
end if;

select 	MAX(nr_prescricao_anterior),
		max(nr_atendimento)
into STRICT	nr_prescr_ant_w,
		nr_atendimento_atual_w
from   	prescr_medica
where  	nr_prescricao = nr_prescricao_p;

select 	coalesce(max(ie_via_aplicacao),'XPTO')
into STRICT	ie_via_aplicacao_w
from 	prescr_material
where	nr_prescricao = nr_prescricao_p
and 	nr_sequencia = nr_sequencia_p;

select	MAX(nr_sequencia)
into STRICT	nr_seq_ant_w
from	prescr_material
where	nr_prescricao = nr_prescr_ant_w
and		nr_sequencia_diluicao = nr_sequencia_p
and		ie_agrupador = ie_agrupador_tipo_w;

select 	max(nr_atendimento)
into STRICT	nr_atendimento_ant_w
from   	prescr_medica
where  	nr_prescricao = nr_prescr_ant_w;

if (ie_tipo_diluicao_p = 'N') then
	select	MAX(cd_material),
			coalesce(MAX(ie_alterou_dose_dil),'N')
	into STRICT	cd_mat_diluente_w,
			ie_alt_dose_dil_w
	from   	prescr_material
	where  	nr_prescricao = nr_prescr_ant_w
	and	   	nr_sequencia = nr_seq_ant_w
	and	   	ie_agrupador = 3;
elsif (ie_tipo_diluicao_p = 'S') then
	select 	MAX(cd_material),
			coalesce(MAX(ie_alterou_dose_dil),'N')
	into STRICT	cd_mat_diluente_w,
			ie_alt_dose_dil_w
	from   	prescr_material
	where  	nr_prescricao = nr_prescr_ant_w
	and	   	nr_sequencia = nr_seq_ant_w
	and	   	ie_agrupador = 9;
elsif (ie_tipo_diluicao_p = 'R') then
	select 	MAX(cd_material),
			coalesce(MAX(ie_alterou_dose_dil),'N')
	into STRICT	cd_mat_diluente_w,
			ie_alt_dose_dil_w
	from   	prescr_material
	where  	nr_prescricao = nr_prescr_ant_w
	and	   	nr_sequencia = nr_seq_ant_w
	and	   	ie_agrupador = 7;
end if;

select 	count(*)
into STRICT	qt_count_w
from	material_diluicao
where	cd_material = cd_medicamento_p
and		cd_diluente = cd_mat_diluente_w
and		ie_reconstituicao = ie_tipo_diluicao_p
and		coalesce(ie_via_aplicacao,ie_via_aplicacao_w) = ie_via_aplicacao_w;

if (ie_param_813_rep_w = 'P' ) and (nr_atendimento_ant_w <> nr_atendimento_atual_w) and (cd_mat_diluente_w IS NOT NULL AND cd_mat_diluente_w::text <> '') then

   ds_retorno_w := '0';
elsif (ie_param_813_rep_w = 'P' and qt_count_w > 0) then

	open C01;
	loop
	fetch C01 into
		nr_seq_prioridade_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		nr_seq_prio_aux_w := '000';

		if (ie_alt_dose_dil_w <> 'C' and ie_alt_dose_dil_w <> 'E') then

			select	max(dt_prescricao)
			into STRICT	dt_prescr_ant_w
			from	prescr_medica
			where	nr_prescricao = nr_prescr_ant_w;

			if (dt_prescr_ant_w < (clock_timestamp() - interval '10 days')) then
				dt_prescr_ant_w := clock_timestamp() - interval '2 days';
			end if;

			select	coalesce(max(b.nr_seq_prioridade), '000')
			into STRICT	nr_seq_prio_aux_w
			from	material_log_alteracao a,
					material_diluicao b
			where	a.cd_material = b.cd_diluente
			and		a.cd_material_princ = b.cd_material
			and		a.ie_agrupador = ie_agrupador_tipo_w
			and		a.cd_material = cd_mat_diluente_w
			and		a.cd_material_princ = cd_medicamento_p
			and		a.dt_atualizacao between dt_prescr_ant_w and clock_timestamp();
		end if;

		if (nr_seq_prio_aux_w <> '000') then
			ds_retorno_w := ds_retorno_w || ',' || nr_seq_prio_aux_w;
		else
			ds_retorno_w := '000';
		end if;

	end loop;
	close C01;


elsif (ie_param_813_rep_w = 'P' ) and (nr_atendimento_ant_w = nr_atendimento_atual_w) and (cd_mat_diluente_w IS NOT NULL AND cd_mat_diluente_w::text <> '') and (ie_alt_dose_dil_w <> 'D') then
	ds_retorno_w := '0';
elsif (ie_alt_dose_dil_w = 'D') then
	ds_retorno_w := '000';
end if;

if (coalesce(ie_tipo_inf_p,'P') = 'D') then
	if (ie_alt_dose_dil_w <> 'N') and (qt_count_w > 0) then
		ds_retorno_w := coalesce(cd_mat_diluente_w,'');
	else
		ds_retorno_w := 0;
	end if;
end if;

return coalesce(ds_retorno_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prioridade_diluente ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_medicamento_p bigint, ie_tipo_diluicao_p text, ie_tipo_inf_p text default 'P') FROM PUBLIC;

