-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_teste_amostral ( CD_VERSAO_P text, CD_BUILD_P text, NR_SEQ_ORDEM_P bigint, IE_TIPO_INF_P text) RETURNS varchar AS $body$
DECLARE

 IE_RESULTADO_W   varchar(50);
 NM_TESTADOR_W   varchar(100);
 CLASSIFICACAO_VV_W varchar(255);
 NR_SEQ_HISTORICO_W bigint;

/* Tipos de resultado 
RES - Resultado do teste amostral 
NOM - Nome do testador 
CLA - Cassificação VeV 
*/
 
 

BEGIN 
 SELECT coalesce(MAX(NR_SEQUENCIA),0) 
  INTO STRICT NR_SEQ_HISTORICO_W 
  FROM MAN_ORDEM_SERV_TECNICO 
  WHERE NR_SEQ_TIPO IN (117,118,122) 
   AND NR_SEQ_ORDEM_SERV     = NR_SEQ_ORDEM_P 
   AND CD_VERSAO_TESTE      = CD_VERSAO_P 
   AND (CD_BUILD_TESTE)::numeric  = CD_BUILD_P;
 
 IF (NR_SEQ_HISTORICO_W <> 0) THEN 
  SELECT CASE WHEN NR_SEQ_TIPO=117 THEN  'Aprovado' WHEN NR_SEQ_TIPO=118 THEN  'Reprovado' WHEN NR_SEQ_TIPO=122 THEN  'Sem resultado' END , 
      OBTER_PF_USUARIO(NM_USUARIO, 'N'), 
      OBTER_DESC_CLASSIF_VV(NR_SEQ_CLASSIF_VV) 
   INTO STRICT IE_RESULTADO_W, 
      NM_TESTADOR_W, 
      CLASSIFICACAO_VV_W 
   FROM MAN_ORDEM_SERV_TECNICO 
   WHERE NR_SEQUENCIA = NR_SEQ_HISTORICO_W 
    AND coalesce(DT_INATIVACAO::text, '') = '';
 END IF;
 
 IF (IE_TIPO_INF_P = 'RES') THEN 
  RETURN IE_RESULTADO_W;
 ELSIF (IE_TIPO_INF_P = 'NOM') THEN 
  RETURN NM_TESTADOR_W;
 ELSIF (IE_TIPO_INF_P = 'CLA') THEN 
  RETURN CLASSIFICACAO_VV_W;
 END IF;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_teste_amostral ( CD_VERSAO_P text, CD_BUILD_P text, NR_SEQ_ORDEM_P bigint, IE_TIPO_INF_P text) FROM PUBLIC;

