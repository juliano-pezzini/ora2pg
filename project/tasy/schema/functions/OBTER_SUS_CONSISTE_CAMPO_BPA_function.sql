-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_sus_consiste_campo_bpa ( nm_campo_p text, nr_bpa_p text, nr_seq_bpa_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE

 
 
ds_erro_w		varchar(2000)	:= '';
ds_erro_numero_w		varchar(255)	:= '';
ds_erro_dados_w		varchar(255)	:= '';
ds_inco_w		varchar(255);
cd_inconsistencia_w	bigint;
ds_inconsistencia_w	varchar(255);
ds_retorno_w		varchar(2000);
i			integer;

 

BEGIN 
 
if (nm_campo_p	= 'NR_BPA') then 
	ds_erro_numero_w := Sus_Consiste_Numero_BPA(nr_interno_conta_p, nr_bpa_p, nr_seq_bpa_p, nm_usuario_p, 2, ds_erro_numero_w);
end if;
 
ds_erro_w	:= ds_erro_numero_w;
 
/* Teste se há algum erro */
 
if (length(ds_erro_w) > 0) then 
	ds_inco_w	:= ds_erro_w;
	while (ds_inco_w IS NOT NULL AND ds_inco_w::text <> '') LOOP 
		begin 
		/* Busca a posição do separados das inconsistencias, no caso a virgula */
 
		i	:= position(', ' in ds_inco_w);
		if (i > 1) then 
			cd_inconsistencia_w	:= substr(ds_inco_w, 1, i-1);
			ds_inco_w		:= substr(ds_inco_w, i+1, 255);	
		end if;
		/* Se existir apenas um espaço em branco entao limpa a variavel para sair do loop */
 
		if (ds_inco_w = ' ') then 
			ds_inco_w	:= '';
		end if;
		 
		/* Busca a descricao da inconsistencia */
 
		select	coalesce(max(ds_inconsistencia),'') 
		into STRICT	ds_inconsistencia_w 
		from	sus_inconsistencia 
		where	cd_inconsistencia	= cd_inconsistencia_w;
 
		ds_retorno_w	:= ds_retorno_w || ' - ' || ds_inconsistencia_w || chr(10);
 
		end;
	END LOOP;
end if;
 
return	ds_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_sus_consiste_campo_bpa ( nm_campo_p text, nr_bpa_p text, nr_seq_bpa_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

