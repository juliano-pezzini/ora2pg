-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_concent_medic_prescr ( nr_prescricao_p bigint, nr_sequencia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


cd_material_w				integer;
qt_dose_medic_w				double precision;
qt_dose_reconst_w			double precision;
qt_dose_diluente_w			double precision;
qt_dose_rediluente_w		double precision;
qt_concent_ml_w				double precision := 0;
qt_concentracao_ml_w		double precision;
qt_concentracao_min_ml_w	double precision;
qt_conversao_w				double precision;
cd_unidade_medida_dose_w	varchar(30);
retorno_w					varchar(255) := 'N';
qt_solucao_w				double precision;
ie_via_aplicacao_w			varchar(5);
cd_setor_atendimento_w		integer;
qt_idade_w					double precision;
qt_peso_w					double precision;
qt_concentracao_w			double precision;
ds_unid_med_cons_volume_w	varchar(255);
cd_unid_med_cons_peso_w		varchar(30);
cd_estabelecimento_w		bigint;	


BEGIN

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

/*material, Concentracao, dose e unidade de medida  */

select	max(cd_material),
		max(cd_unidade_medida_dose),
		coalesce(max(obter_conversao_ml(cd_material, qt_dose,cd_unidade_medida_dose)),0),
		max(ie_via_aplicacao),
		max(substr(obter_setor_prescricao(nr_prescricao, 'C'),1,10))
		--max(obter_qt_conversao_mg(cd_material))
into STRICT	cd_material_w,
		cd_unidade_medida_dose_w,
		qt_dose_medic_w,
		ie_via_aplicacao_w,
		cd_setor_atendimento_w
from	prescr_material
where	nr_sequencia = nr_sequencia_p
and		nr_prescricao = nr_prescricao_p;

select	coalesce(max(qt_conversao),0)
into STRICT	qt_conversao_w
from	material_conversao_unidade
where	upper(cd_unidade_medida) = upper(obter_unid_med_usua('ML'))
and		cd_material = cd_material_w;

select	coalesce(CASE WHEN upper(CD_UNID_MED_BASE_CONC)=upper(obter_unid_med_usua('ML')) THEN  coalesce(QT_CONVERSAO_MG,0)  ELSE dividir(QT_CONVERSAO_MG, qt_conversao_w) END ,0)
into STRICT	qt_concentracao_w
from	material
where	cd_material	= cd_material_w;

select	obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'M'),
		coalesce(a.qt_peso,0)
into STRICT	qt_idade_w,
		qt_peso_w
from	pessoa_fisica b,
		prescr_medica a
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and		a.nr_prescricao		= nr_prescricao_p;

qt_idade_w	:= dividir(qt_idade_w,12);

select	coalesce(max(qt_concentracao),0),
		coalesce(max(qt_concentracao_min),0),
		max(substr(obter_desc_unid_med(cd_unid_med_cons_volume),1,255)),
		max(cd_unid_med_cons_peso)
into STRICT	qt_concentracao_ml_w,
		qt_concentracao_min_ml_w,
		ds_unid_med_cons_volume_w,
		cd_unid_med_cons_peso_w
from	material_prescr
where	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
and		coalesce(ie_via_aplicacao, coalesce(ie_via_aplicacao_w,0)) = coalesce(ie_via_aplicacao_w,0)
and		qt_idade_w between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,999)
and		qt_peso_w between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999)
and		(qt_concentracao IS NOT NULL AND qt_concentracao::text <> '')
and		((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w))
and		ie_tipo = '2'
and		cd_material = cd_material_w;

if	--(qt_dose_medic_w > 0) and
	((qt_concentracao_ml_w > 0) or (qt_concentracao_min_ml_w > 0)) and (qt_concentracao_w > 0) then
	
	select	coalesce(max(qt_conversao),0)
	into STRICT	qt_conversao_w
	from	material_conversao_unidade
	where	cd_material = cd_material_w
	and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('ML'));
	
	/*Reconstituicao*/

	select  coalesce(max(obter_conversao_ml(cd_material, qt_dose,cd_unidade_medida_dose)),0)
	into STRICT	qt_dose_reconst_w
	from	prescr_material
	where	nr_prescricao		= nr_prescricao_p
	and	nr_sequencia_diluicao	= nr_sequencia_p
	and	ie_agrupador = 9;

	if (qt_dose_medic_w > 0) or (qt_dose_reconst_w > 0) then
		/*Diluicao*/

		select  coalesce(max(obter_conversao_ml(cd_material, qt_dose,cd_unidade_medida_dose)),0)
		into STRICT	qt_dose_diluente_w
		from	prescr_material
		where	nr_prescricao		= nr_prescricao_p
		and	nr_sequencia_diluicao 	= nr_sequencia_p
		and	ie_agrupador = 3;

		/*Rediluicao*/

		select  coalesce(max(obter_conversao_ml(cd_material, qt_dose,cd_unidade_medida_dose)),0),
			coalesce(max(qt_solucao),0)
		into STRICT	qt_dose_rediluente_w,
			qt_solucao_w
		from	prescr_material
		where	nr_prescricao			= nr_prescricao_p
		and	nr_sequencia_diluicao 		= nr_sequencia_p
		and	ie_agrupador = 7;
		
		qt_concent_ml_w	:= qt_concentracao_w;
		
		if (qt_dose_reconst_w > 0) then
			qt_concent_ml_w := dividir((qt_concentracao_w * qt_conversao_w), qt_dose_reconst_w);
			qt_dose_medic_w := qt_dose_reconst_w;
		end if;
		
		if (qt_dose_diluente_w > 0) then
			qt_concent_ml_w := dividir((qt_concent_ml_w * qt_dose_medic_w), qt_dose_diluente_w + qt_dose_medic_w);
		end if;

		if (qt_dose_rediluente_w > 0) then
			qt_concent_ml_w := dividir((qt_concent_ml_w * qt_solucao_w), qt_solucao_w + qt_dose_rediluente_w);
		end if;

		--qt_concent_ml_w
		
		if	((qt_concent_ml_w > qt_concentracao_ml_w) or (qt_concent_ml_w < qt_concentracao_min_ml_w)) then
			if (ie_opcao_p	=  'M') then
				if (qt_concent_ml_w > qt_concentracao_ml_w) then
					--retorno_w	:= substr('A concentracao atual e maior que a maxima permitida: '|| qt_concentracao_ml_w ||' '||cd_unid_med_cons_peso_w ||' por '||ds_unid_med_cons_volume_w||'.',1,255);
					retorno_w	:= SUBSTR(WHEB_MENSAGEM_PCK.get_texto(456715,'qt_concentracao_ml_w=' || qt_concentracao_ml_w || ';cd_unid_med_cons_peso_w=' || cd_unid_med_cons_peso_w || ';ds_unid_med_cons_volume_w=' || ds_unid_med_cons_volume_w),1,255);
				elsif (qt_concent_ml_w < qt_concentracao_min_ml_w) then
					--retorno_w	:= substr('A concentracao atual e menor que a minima permitida: '|| qt_concentracao_min_ml_w ||' '||cd_unid_med_cons_peso_w ||' por '||ds_unid_med_cons_volume_w||'.',1,255); 
					retorno_w	:= SUBSTR(WHEB_MENSAGEM_PCK.get_texto(456717,'qt_concentracao_min_ml_w=' || qt_concentracao_min_ml_w || ';cd_unid_med_cons_peso_w=' || cd_unid_med_cons_peso_w || ';ds_unid_med_cons_volume_w=' || ds_unid_med_cons_volume_w),1,255);
				end if;
			else
			   retorno_w	:= 'S';
			end if;
		end if;
	end if;
end if;

return retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_concent_medic_prescr ( nr_prescricao_p bigint, nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

