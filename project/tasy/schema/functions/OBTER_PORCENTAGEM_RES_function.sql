-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_porcentagem_res ( cd_pessoa_fisica_p text, nm_usuario_p text) RETURNS bigint AS $body$
DECLARE


ds_porcentagem_w		varchar(255);
cd_profissional_w		varchar(255);
qt_requisicao_w			bigint;
qt_requisicao_atual_w	bigint;
qt_porcentagem_w		bigint := 0;
ie_Agendamento_w		varchar(1);
dt_atualizacao_w		timestamp;
ie_xml_macro_w			varchar(1);


BEGIN

SELECT 	Obter_Pf_Usuario(nm_usuario_p,'C')
INTO STRICT	cd_profissional_w
;


SELECT 	MAX(qt_requisicao),
		MAX(qt_requisicao_atual),
		MAX(dt_atualizacao)
INTO STRICT	qt_requisicao_w,
		qt_requisicao_atual_w,
		dt_atualizacao_w
FROM 	res_paciente_resultado
WHERE	cd_pessoa_fisica = cd_pessoa_fisica_p
AND		cd_profissional_dest = cd_profissional_w
AND		nm_usuario = nm_usuario_p
AND		(qt_requisicao IS NOT NULL AND qt_requisicao::text <> '');

IF ((qt_requisicao_atual_w = qt_requisicao_w) OR (coalesce(qt_requisicao_w,0) = 0)) THEN

	qt_porcentagem_w := 100;

			SELECT 	coalesce(MAX('S'),'N')
			INTO STRICT	ie_xml_macro_w
			FROM	imp_sumario_pac_arquivo a,
					imp_sumario_paciente b
			WHERE	a.nr_seq_sumario = b.nr_sequencia
			AND		a.ie_tipo_arquivo   = 'TFO'
			AND		b.cd_pessoa_fisica = cd_pessoa_fisica_p
			AND		b.cd_prof_solic = cd_profissional_w
			AND		a.dt_atualizacao > dt_atualizacao_w;

			IF ( ie_xml_macro_w = 'N' and qt_requisicao_atual_w > 0) then

				qt_porcentagem_w := 99;

			END IF;

ELSIF ( qt_requisicao_atual_w = 0) THEN

	SELECT 	ROUND(((clock_timestamp() - dt_atualizacao_w) * 86400) / 4)
	INTO STRICT	qt_porcentagem_w
	;

	IF ( qt_porcentagem_w > 8) THEN

		qt_porcentagem_w := 10;

	END IF;

ELSE

		SELECT  ROUND((qt_requisicao_atual_w  * 100) / (qt_requisicao_w))
		INTO STRICT	qt_porcentagem_w
		;



END IF;


RETURN	qt_porcentagem_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_porcentagem_res ( cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

