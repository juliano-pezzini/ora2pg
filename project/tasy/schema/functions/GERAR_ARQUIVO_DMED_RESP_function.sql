-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gerar_arquivo_dmed_resp ( nm_usuario_p text, nr_seq_dmed_p bigint) RETURNS varchar AS $body$
DECLARE

			
separador_w		varchar(1)	:= '|';
cd_pessoa_fisica_w	varchar(15);
cd_responsavel_w	varchar(15);
ds_resp_w		varchar(4000);


BEGIN
select 	cd_responsavel_dados
into STRICT	cd_responsavel_w
from 	dmed
where 	nr_sequencia	= nr_seq_dmed_p;

if (cd_responsavel_w IS NOT NULL AND cd_responsavel_w::text <> '') then
	cd_pessoa_fisica_w 	:= cd_responsavel_w;
else
	cd_pessoa_fisica_w	:= substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,255);
end if;

select	'RESPO' 				|| separador_w ||
	LPAD(p.nr_cpf,11,'0') 			|| separador_w ||
	substr(fis_remove_special_characters(p.nm_pessoa_fisica),1,60)		|| separador_w ||
	substr(c.nr_ddd_telefone,1,2)		|| separador_w ||
	substr(c.nr_telefone,1,8)		|| separador_w ||
	substr(c.nr_ramal,1,6)			|| separador_w ||
	substr(c.ds_fax,1,8)			|| separador_w ||
	substr(c.ds_email,1,50)			|| separador_w
into STRICT	ds_resp_w	
FROM pessoa_fisica p
LEFT OUTER JOIN compl_pessoa_fisica c ON (p.cd_pessoa_fisica = c.cd_pessoa_fisica)
WHERE c.ie_tipo_complemento	= 2 and p.cd_pessoa_fisica	= cd_pessoa_fisica_w;
	
return ds_resp_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gerar_arquivo_dmed_resp ( nm_usuario_p text, nr_seq_dmed_p bigint) FROM PUBLIC;

