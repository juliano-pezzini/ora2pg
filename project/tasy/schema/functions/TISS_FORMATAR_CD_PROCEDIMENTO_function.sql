-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tiss_formatar_cd_procedimento (cd_procedimento_p text, nr_sequencia_autor_p bigint default null, nr_interno_conta_p bigint default null) RETURNS varchar AS $body$
DECLARE


ie_digitos_proc_w 		tiss_parametros_convenio.ie_digitos_proc%type;
cd_convenio_w 			tiss_parametros_convenio.cd_convenio%type;
cd_estabelecimento_w 		tiss_parametros_convenio.cd_estabelecimento%type;
ie_tipo_autorizacao_w 		autorizacao_convenio.ie_tipo_autorizacao%type;
nr_seq_estagio_w 		autorizacao_convenio.nr_seq_estagio%type;
dt_mesano_referencia_w 		timestamp;
ds_versao_w 			varchar(50);
nr_seq_projeto_autor_w		bigint;
ie_tiss_tipo_guia_autor_w	varchar(20);
retorno_w 			varchar(10);


BEGIN
retorno_w  := substr(cd_procedimento_p,1,10);

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then
	select 	max(cd_convenio_parametro),
		max(cd_estabelecimento),
		max(dt_mesano_referencia)
	into STRICT	cd_convenio_w,
		cd_estabelecimento_w,
		dt_mesano_referencia_w
	from 	conta_paciente
	where 	nr_interno_conta = nr_interno_conta_p;

	select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w,dt_mesano_referencia_w)
	into STRICT	ds_versao_w
	;
elsif (nr_sequencia_autor_p IS NOT NULL AND nr_sequencia_autor_p::text <> '') then
	select 	max(cd_convenio),
		max(cd_estabelecimento),
		max(ie_tipo_autorizacao),
		max(nr_seq_estagio)
	into STRICT 	cd_convenio_w,
		cd_estabelecimento_w,
		ie_tipo_autorizacao_w,
		nr_seq_estagio_w
	from 	autorizacao_convenio
	where 	nr_sequencia = nr_sequencia_autor_p;

	TISS_OBTER_PROJETO_TISS_AUTOR(cd_estabelecimento_w, cd_convenio_w, nr_sequencia_autor_p, ie_tipo_autorizacao_w, nr_seq_estagio_w, nr_seq_projeto_autor_w, ie_tiss_tipo_guia_autor_w);

	select 	tiss_convenio_pck.tiss_obter_versao(cd_convenio_w, cd_estabelecimento_w, dt_mesano_referencia_w, ie_tiss_tipo_guia_autor_w)
	into STRICT 	ds_versao_w
	;
end if;

select 	coalesce(max(ie_digitos_proc),'S')
into STRICT 	ie_digitos_proc_w
from 	tiss_parametros_convenio
where 	cd_convenio = cd_convenio_w
and 	cd_estabelecimento = cd_estabelecimento_w;

if (ie_digitos_proc_w = 'S' or (ie_digitos_proc_w = 'V' and position('2.0' in ds_versao_w) = 1)) then
	if (length(cd_procedimento_p) < 8) then
		select lpad(cd_procedimento_p,8,'0') into STRICT retorno_w;	
	end if;
end if;

return retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_formatar_cd_procedimento (cd_procedimento_p text, nr_sequencia_autor_p bigint default null, nr_interno_conta_p bigint default null) FROM PUBLIC;

