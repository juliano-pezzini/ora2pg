-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_codigo_barras (ds_valor_p text, nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_prescr_proc_mat_p bigint) RETURNS varchar AS $body$
DECLARE

cd_barras_w     varchar(255);
dt_prior_codigo_barras_w varchar(2);


BEGIN
  dt_prior_codigo_barras_w := lab_obter_valor_parametro(722,373);

  SELECT distinct case when ds_valor_p = 'DGSL' then (to_char(coalesce(b.dt_liberacao_medico, coalesce(b.dt_liberacao, b.dt_prescricao)), 'dd') || lpad(c.nr_seq_grupo, 2 , '0') || lpad(a.nr_seq_lab, 4, '0'))
                      when ds_valor_p = 'DGS7' then (to_char(coalesce(b.dt_liberacao_medico, coalesce(b.dt_liberacao, b.dt_prescricao)), 'ddmm') || lpad(c.nr_seq_grupo, 2, '0') || lpad(a.nr_seq_lab, 7, '0'))
                      when ds_valor_p = 'DAGS4' then
                        case when dt_prior_codigo_barras_w = 'LM' then (to_char(coalesce(b.dt_liberacao_medico, coalesce(b.dt_liberacao, b.dt_prescricao)), 'ddmmyy') || lpad(c.nr_seq_grupo, 2, '0') || lpad(a.nr_seq_lab, 4, '0'))
                        else (to_char(coalesce(b.dt_liberacao, coalesce(b.dt_liberacao_medico, b.dt_prescricao)), 'ddmmyy') || lpad(c.nr_seq_grupo, 2, '0') || lpad(a.nr_seq_lab, 4, '0'))
                        end
                      when ds_valor_p = 'DGIS' then (to_char(coalesce(b.dt_liberacao_medico, coalesce(b.dt_liberacao, b.dt_prescricao)), 'ddmm') || lpad(c.nr_seq_grupo_imp, 2, '0') || lpad(a.nr_seq_lab, 3, '0'))
                      when ds_valor_p = 'DS4GI' then (to_char(coalesce(b.dt_liberacao_medico, coalesce(b.dt_liberacao, b.dt_prescricao)), 'ddmm') || lpad(a.nr_seq_lab, 4, '0') || lpad(c.nr_seq_grupo_imp, 2, '0'))
                      when ds_valor_p = 'DGS6' then (to_char(coalesce(b.dt_liberacao_medico, coalesce(b.dt_liberacao, b.dt_prescricao)), 'ddmm') || lpad(c.nr_seq_grupo, 2, '0') || lpad(a.nr_seq_lab, 6, '0'))
                      when ds_valor_p = 'DGS5' then (to_char(coalesce(b.dt_liberacao_medico, coalesce(b.dt_liberacao, b.dt_prescricao)), 'ddmm') || lpad(c.nr_seq_grupo, 2, '0') || lpad(a.nr_seq_lab, 5, '0'))
                      when ds_valor_p = 'AMO9' then (lpad(g.cd_barras, 9, 0))
                      when ds_valor_p = 'AMO10' then (lpad(g.cd_barras, 10, 0))
                      when ds_valor_p = 'AMO11' then (lpad(g.cd_barras, 11, 0))
                      when ds_valor_p = 'EAM10' then (lpad(g.cd_barras, 10, 0))
                      when ds_valor_p = 'AMO13' then (lpad(g.cd_barras, 13, 0))
                      when ds_valor_p = 'AM11F' then (lpad(g.cd_barras, 11, 0))
                      when ds_valor_p = 'AM10F' then (lpad(g.cd_barras, 10, 0))
                      when ds_valor_p = 'PM' then (to_char(substr(Lab_obter_amostra_prescr('PM',	a.nr_prescricao, a.nr_seq_exame, a.nr_sequencia), 1, 255)))
                      when ds_valor_p = 'PM11' then (to_char(substr(Lab_obter_amostra_prescr('PM11',	a.nr_prescricao, a.nr_seq_exame, a.nr_sequencia), 1, 255)))
                      when ds_valor_p = 'PM13' then (to_char(substr(Lab_obter_amostra_prescr('PM13',	a.nr_prescricao, a.nr_seq_exame, a.nr_sequencia), 1, 255)))
                      when ds_valor_p = 'PMR11' then (to_char(substr(Lab_obter_amostra_prescr('PMR11',	a.nr_prescricao, a.nr_seq_exame, a.nr_sequencia), 1, 255)))
                      when ds_valor_p = 'P' then (to_char(a.nr_prescricao))
                      when ds_valor_p = 'DGS' then (to_char(coalesce(b.dt_liberacao_medico, coalesce(b.dt_liberacao, b.dt_prescricao)), 'ddmm') || lpad(c.nr_seq_grupo, 2, '0') || lpad(a.nr_seq_lab, 3, '0'))
                 end cd_barras
                 into STRICT cd_barras_w
            FROM prescr_procedimento a, prescr_proc_mat_item g, prescr_medica b,
                 exame_laboratorio c, material_exame_lab d
           WHERE a.nr_prescricao = g.nr_prescricao
             AND a.nr_sequencia = g.nr_seq_prescr
             and a.nr_seq_exame = c.nr_seq_exame
             and a.nr_prescricao = b.nr_prescricao
			 and d.nr_sequencia = Obter_Material_Exame_Lab(null, a.cd_material_exame, 1)
             and a.nr_prescricao = nr_prescricao_p
             and a.nr_sequencia = nr_seq_prescr_p
			 and g.nr_seq_prescr_proc_mat = nr_seq_prescr_proc_mat_p;

return cd_barras_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_codigo_barras (ds_valor_p text, nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_prescr_proc_mat_p bigint) FROM PUBLIC;

