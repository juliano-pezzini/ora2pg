-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_barras_prescr ( nr_controle_p bigint, nr_seq_etiqueta_p bigint, cd_unidade_fleury_p lab_parametro.cd_unidade_fleury%TYPE default null, cd_estabelecimento_p bigint  DEFAULT NULL) RETURNS bigint AS $body$
DECLARE

    nr_prescricao_w		bigint;
    nr_seq_prescr_w		bigint;		
    ie_status_atend_w	bigint := 0;
    ie_agrupa_ficha_fleury_w lab_parametro.ie_agrupa_ficha_fleury%TYPE;
    ie_etiqueta_uni_fleury_w lab_parametro.ie_etiqueta_uni_fleury%TYPE;

BEGIN
    SELECT
        coalesce(MAX(ie_agrupa_ficha_fleury), 'N'),
        coalesce(MAX(ie_etiqueta_uni_fleury), 'N')
    INTO STRICT
        ie_agrupa_ficha_fleury_w,
        ie_etiqueta_uni_fleury_w
    FROM lab_parametro
    WHERE cd_estabelecimento = coalesce(cd_estabelecimento_p, cd_estabelecimento);

    if (ie_etiqueta_uni_fleury_w = 'N') then
        if (ie_agrupa_ficha_fleury_w <> 'N') then
            select	max(nr_prescricao)
            into STRICT	nr_prescricao_w
            from	prescr_procedimento
            where	nr_controle_ext = nr_controle_p;
        else
            select 	nr_prescricao
            into STRICT	nr_prescricao_w
            from 	prescr_medica
            where 	nr_controle   = nr_controle_p;

            if (coalesce(nr_prescricao_w::text, '') = '') then
                select	max(b.nr_prescricao)
                into STRICT	nr_prescricao_w
                from	prescr_procedimento a, prescr_medica b
                where	a.nr_prescricao = b.nr_prescricao
                and		a.nr_controle_ext = nr_controle_p
                and (b.cd_estabelecimento = coalesce(cd_estabelecimento_p,b.cd_estabelecimento));
            end if;
        end if;
    else
        IF ( ie_agrupa_ficha_fleury_w <> 'N' ) THEN
            SELECT MAX(p.nr_prescricao)
            INTO STRICT nr_prescricao_w
            FROM
                prescr_procedimento   p
                INNER JOIN prescr_medica         m ON m.nr_prescricao = p.nr_prescricao
                INNER JOIN lab_parametro         l ON l.cd_estabelecimento = m.cd_estabelecimento
            WHERE
                p.nr_controle_ext = nr_controle_p
                AND l.cd_unidade_fleury = cd_unidade_fleury_p;
        ELSE
            SELECT m.nr_prescricao
            INTO STRICT nr_prescricao_w
            FROM
                prescr_medica   m
                INNER JOIN lab_parametro   l ON l.cd_estabelecimento = m.cd_estabelecimento
            WHERE
                m.nr_controle = nr_controle_p
                AND l.cd_unidade_fleury = cd_unidade_fleury_p;

            IF ( coalesce(nr_prescricao_w::text, '') = '' ) THEN
                SELECT MAX(m.nr_prescricao)
                INTO STRICT nr_prescricao_w
                FROM
                    prescr_procedimento   p
                    INNER JOIN prescr_medica         m ON p.nr_prescricao = m.nr_prescricao
                    INNER JOIN lab_parametro         l ON l.cd_estabelecimento = m.cd_estabelecimento
                WHERE
                    p.nr_controle_ext = nr_controle_p
                    AND ( m.cd_estabelecimento = coalesce(cd_estabelecimento_p, m.cd_estabelecimento) )
                    AND l.cd_unidade_fleury = cd_unidade_fleury_p;
            END IF;
        END IF;
    end if;

    select 	max(nr_seq_prescr)
    into STRICT	nr_seq_prescr_w
    from 	prescr_proc_controle_etiq 
    where 	nr_controle 	= nr_controle_p
    and 	nr_seq_etiqueta = nr_seq_etiqueta_p;

    
    if ( nr_prescricao_w > 0 ) and ( nr_seq_prescr_w > 0 ) then
    
        select 	coalesce(max(nr_seq_prescr_subst),nr_seq_prescr_w)
        into STRICT	nr_seq_prescr_w
        from	regra_canc_subst_fleury
        where	nr_prescricao 	= nr_prescricao_w
        and	nr_seq_prescr	= nr_seq_prescr_w;

        
        select	ie_status_atend
        into STRICT	ie_status_atend_w
        from	prescr_procedimento
        where	nr_prescricao	= nr_prescricao_w
        and	nr_sequencia	= nr_seq_prescr_w;

    end if;

    
    return	ie_status_atend_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_barras_prescr ( nr_controle_p bigint, nr_seq_etiqueta_p bigint, cd_unidade_fleury_p lab_parametro.cd_unidade_fleury%TYPE default null, cd_estabelecimento_p bigint  DEFAULT NULL) FROM PUBLIC;

