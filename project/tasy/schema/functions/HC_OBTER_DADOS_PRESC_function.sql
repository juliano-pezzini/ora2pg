-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hc_obter_dados_presc ( nr_seq_paciente_p bigint, dt_referencia_p timestamp, nr_seq_agenda_p bigint default null, ie_opcao_p text DEFAULT NULL) RETURNS varchar AS $body$
DECLARE

			 
/* ie_opcao_p 
'M'	Medicamento - Diluição 
'R'	Recomendações 
*/
 
			 
 
nr_atendimento_w	bigint;	
nr_prescricao_w		bigint;	
ds_medicamento_w	varchar(2000);	
ds_retorno_w		varchar(4000);	
ds_recomendacao_w	varchar(4000) := '';
qt_registros_w		bigint;
dt_agenda_w		timestamp;

C01 CURSOR FOR 
	SELECT	substr(obter_desc_material(a.cd_material)||' - '||obter_diluicao_medic(a.nr_sequencia,a.nr_prescricao),1,255), 
		substr(a.ds_observacao,1,255) 
	from	prescr_material a, 
		prescr_medica b, 
		prescr_mat_hor c 
	where	a.nr_prescricao = b.nr_prescricao 
	and	c.nr_prescricao = a.nr_prescricao 
	and	c.nr_seq_material = a.nr_sequencia 
	and	trunc(dt_referencia_p) between inicio_dia(coalesce(b.dt_inicio_prescr,b.dt_prescricao)) and fim_dia(coalesce(dt_validade_prescr,b.dt_prescricao)) 
	and	b.nr_atendimento = nr_atendimento_w 
	and	b.nr_prescricao = coalesce(nr_prescricao_w,b.nr_prescricao) 
	and	c.dt_horario = dt_referencia_p 
	and	coalesce(b.dt_suspensao::text, '') = '' 
	and	a.ie_suspenso <> 'S' 
	and	coalesce(c.dt_suspensao::text, '') = '';
	
C02 CURSOR FOR 
	SELECT	substr(obter_desc_material(a.cd_material)||' - '||obter_diluicao_medic(a.nr_sequencia,a.nr_prescricao),1,255), 
		substr(a.ds_observacao,1,255) 
	from	prescr_material a, 
		prescr_medica b, 
		prescr_mat_hor c 
	where	a.nr_prescricao = b.nr_prescricao 
	and	c.nr_prescricao = a.nr_prescricao 
	and	c.nr_seq_material = a.nr_sequencia 
	and	trunc(dt_referencia_p) between inicio_dia(coalesce(b.dt_inicio_prescr,b.dt_prescricao)) and fim_dia(coalesce(dt_validade_prescr,b.dt_prescricao)) 
	and	b.nr_atendimento = nr_atendimento_w 
	and	(a.ds_observacao IS NOT NULL AND a.ds_observacao::text <> '') 
	and	b.nr_prescricao = coalesce(nr_prescricao_w,b.nr_prescricao) 
	and	c.dt_horario = dt_referencia_p 
	and	coalesce(b.dt_suspensao::text, '') = '' 
	and	a.ie_suspenso <> 'S' 
	and	coalesce(c.dt_suspensao::text, '') = '';
	

BEGIN 
if (nr_seq_paciente_p IS NOT NULL AND nr_seq_paciente_p::text <> '') then 
	begin 
	 
	select	max(a.nr_atendimento) 
	into STRICT	nr_atendimento_w 
	from	paciente_hc_atend a 
	where 	a.nr_seq_paciente = nr_seq_paciente_p 
	and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '');
	 
	if (coalesce(nr_atendimento_w::text, '') = '') then 
		select	nr_atendimento_origem 
		into STRICT	nr_atendimento_w 
		from	paciente_home_care 
		where	nr_sequencia = nr_seq_paciente_p;
		 
	end if;
	 
	 
	 
	 
	select	max(nr_prescricao), 
		max(dt_agenda) 
	into STRICT	nr_prescricao_w, 
		dt_agenda_w 
	from	agenda_hc_paciente 
	where	nr_sequencia = nr_seq_agenda_p;
	 
	select	count(*) 
	into STRICT	qt_registros_w 
	from	agenda_hc_paciente a 
	where	cd_pessoa_fisica = (	SELECT	max(x.cd_pessoa_fisica) 
					from	paciente_home_care x 
					where	x.nr_sequencia = nr_seq_paciente_p) 
	and	dt_agenda = dt_agenda_w;
					 
	if (qt_registros_w > 1) then 
		nr_prescricao_w := null;
	end if;
	 
	/*where	a.nr_sequencia = (select max(b.nr_sequencia) 
					from paciente_hc_atend b 
					where	b.nr_seq_paciente = nr_seq_paciente_p 
					and	b.nr_atendimento is not null);	*/
 
	if (ie_opcao_p = 'M') then 
		begin 
		open C01;
		loop 
		fetch C01 into	 
			ds_medicamento_w, 
			ds_recomendacao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			ds_retorno_w :=	ds_retorno_w || ' / ' || ds_medicamento_w;
			end;
		end loop;
		close C01;
		 
		ds_retorno_w :=	substr(ds_retorno_w,4,255);
		end;
	end if;
	if (ie_opcao_p = 'R') then 
		begin 
		open C02;
		loop 
		fetch C02 into	 
			ds_medicamento_w, 
			ds_recomendacao_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			ds_retorno_w := ds_retorno_w || '/'|| substr(ds_recomendacao_w,1,255);
			end;
		end loop;
		close C02;
		end;
	end if;
	end;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hc_obter_dados_presc ( nr_seq_paciente_p bigint, dt_referencia_p timestamp, nr_seq_agenda_p bigint default null, ie_opcao_p text DEFAULT NULL) FROM PUBLIC;

