-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_se_digit_prescr ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_opcao_p bigint) RETURNS varchar AS $body$
DECLARE



ds_retorno_w	varchar(1);

/*
ie_opcao
1 - Verifica se o exame teve algo digitado
2 - Verifica se todos os analitos do exame foram digitados (parametro [55] da Exames Pendentes)
3 - Opção 'ND' do parâmetro [55] da função Exames Pendentes. A opção consiste resultados descritivos que foram apagados após entrar em digitação, impedindo a aprovação. ***conferir ie_consiste_res_desc na exame_laboratorio
*/
BEGIN

if (ie_opcao_p = 1)	then

	select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ds_retorno_w
	from	exame_laboratorio b,
		exame_lab_result_item a,
		exame_lab_resultado c
	where	a.nr_seq_exame		= b.nr_seq_exame
	and	a.nr_seq_resultado	= c.nr_seq_resultado
	and	c.nr_prescricao		= nr_prescricao_p
	and	a.nr_seq_prescr		= nr_seq_prescr_p
	and	a.ie_status		= '1';

elsif (ie_opcao_p = 2)	then

	SELECT 	CASE WHEN COUNT(*)=0 THEN 'S'  ELSE 'N' END
	INTO STRICT	ds_retorno_w
	FROM	exame_laboratorio b,
		exame_lab_result_item a,
		exame_lab_resultado c
	WHERE	a.nr_seq_exame		= b.nr_seq_exame
	AND	a.nr_seq_resultado	= c.nr_seq_resultado
	AND	c.nr_prescricao		= nr_prescricao_p
	AND	a.nr_seq_prescr		= nr_seq_prescr_p
	AND	((a.ie_status <> '1') OR (coalesce(a.ie_status::text, '') = ''))
	and	(b.nr_seq_superior IS NOT NULL AND b.nr_seq_superior::text <> '');

elsif (ie_opcao_p = 3)		then

	select 	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
	into STRICT	ds_retorno_w
	from	exame_laboratorio b,
		exame_lab_result_item a,
		exame_lab_resultado c
	where	a.nr_seq_exame		= b.nr_seq_exame
	and	a.nr_seq_resultado	= c.nr_seq_resultado
	and	c.nr_prescricao 	= nr_prescricao_p
	and	a.nr_seq_prescr		= nr_seq_prescr_p
	and	a.ie_status 		= '1'
	and	coalesce(a.qt_resultado, 0) 	= 0
	and	coalesce(trim(both a.ds_resultado)::text, '') = ''
	and	b.ie_formato_resultado not in ('V', 'P', 'PV', 'CV', 'CA')
	and	b.ie_consiste_res_desc = 'S';

	if (ds_retorno_w = 'S') then
		select 	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
		into STRICT	ds_retorno_w
		from	exame_laboratorio b,
			exame_lab_result_item a,
			exame_lab_resultado c
		where	a.nr_seq_exame		= b.nr_seq_exame
		and	a.nr_seq_resultado	= c.nr_seq_resultado
		and	c.nr_prescricao 	= nr_prescricao_p
		and	a.nr_seq_prescr		= nr_seq_prescr_p
		and	((a.ie_status <> '1') or (coalesce(a.ie_status::text, '') = ''));
	end if;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_se_digit_prescr ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_opcao_p bigint) FROM PUBLIC;

