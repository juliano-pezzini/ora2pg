-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_brasindice ( cd_material_p bigint, ie_opcao_p text ) RETURNS bigint AS $body$
DECLARE


/* ie_opcao_p:	'C' - Convertido */

vl_preco_medicamento_w	double precision;
cd_laboratorio_w		varchar(6);
cd_medicamento_w		varchar(6);
cd_apresentacao_w		varchar(6);
qt_conversao_w		double precision;
nr_sequencia_w		material_brasindice.nr_sequencia%type;


BEGIN

select	max(a.nr_sequencia)
into STRICT	nr_sequencia_w
from	material_brasindice a,
	material b,
	brasindice_laboratorio c,
	brasindice_medicamento d,
	brasindice_apresentacao e,
	classe_material f,
	subgrupo_material g
where (a.cd_material		= b.cd_material)
and (a.cd_laboratorio	= c.cd_laboratorio)
and (a.cd_medicamento	= d.cd_medicamento)
and (a.cd_apresentacao	= e.cd_apresentacao)
and (b.cd_classe_material	= f.cd_classe_material)
and (f.cd_subgrupo_material	= g.cd_subgrupo_material)
and	a.cd_material		= cd_material_p
and	a.ie_situacao		= 'A';

if (coalesce(nr_sequencia_w,0) > 0) then

	select	max(a.cd_medicamento),
		max(a.cd_laboratorio),
		max(a.cd_apresentacao),
		coalesce(max(a.qt_conversao),0)
	into STRICT	cd_medicamento_w,
		cd_laboratorio_w,
		cd_apresentacao_w,
		qt_conversao_w
	from	material_brasindice a
	where	a.nr_sequencia = nr_sequencia_w;

end if;

begin
select	max(coalesce(vl_preco_medicamento * (1 + coalesce(pr_ipi,0)/100),0))
into STRICT	vl_preco_medicamento_w
from	brasindice_preco a
where	a.cd_laboratorio 	= cd_laboratorio_w
and 	a.cd_medicamento 	= cd_medicamento_w
and 	a.cd_apresentacao 	= cd_apresentacao_w
and 	a.dt_inicio_vigencia = (	SELECT 	max(b.dt_inicio_vigencia)
				from	brasindice_preco b
				where	b.cd_laboratorio 	= cd_laboratorio_w
				and	b.cd_medicamento 	= cd_medicamento_w
				and 	b.cd_apresentacao 	= cd_apresentacao_w);
exception
	when no_data_found then
		vl_preco_medicamento_w := 0;
end;

if	(qt_conversao_w > 0  AND ie_opcao_p = 'C') then
	vl_preco_medicamento_w := vl_preco_medicamento_w / qt_conversao_w;
end if;

if (vl_preco_medicamento_w = 0) then
	select	coalesce(max(vl_preco_venda),0)
	into STRICT	vl_preco_medicamento_w
	from	preco_material
	where	dt_inicio_vigencia	=	(SELECT	max(dt_inicio_vigencia)
					from	preco_material
					where	cd_material	=	cd_material_p)
	and	cd_material	=	cd_material_p;
end if;


return	vl_preco_medicamento_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_brasindice ( cd_material_p bigint, ie_opcao_p text ) FROM PUBLIC;

