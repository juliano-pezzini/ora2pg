-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_nfse_tubarao (nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w   		varchar(4000) := '';
ds_itens_w     		varchar(2000) := '~';
ds_separador_w 		varchar(1) := '~';
ds_observacao_w         nota_fiscal.ds_observacao%type;
vl_descontos_w 		nota_fiscal.vl_descontos%type;
vl_total_nota_w         nota_fiscal.vl_total_nota%type;
nr_inscricao_municipal_w 	pessoa_juridica.nr_inscricao_municipal%type;
nr_inscricao_estadual_w  	pessoa_juridica.nr_inscricao_estadual%type;
cd_unidade_w           varchar(2);
qt_item_nf_w           nota_fiscal_item.qt_item_nf%type;
ds_procedimento_w      varchar(255);
vl_unitario_item_nf_w   varchar(60);
vl_total_item_nf_w      varchar(60);
ds_sep_desconto_inc_w   varchar(4) := chr(38) || 'DI' || chr(38);
ds_sep_desconto_con_w   varchar(4) := chr(38) || 'DC' || chr(38);
ds_sep_mun_w            varchar(3) := chr(38) || 'M' || chr(38);
ds_sep_est_w            varchar(3) := chr(38) || 'E' || chr(38);

qtd_rps_regra_w			bigint := 0;
cd_estabelecimento_w	nota_fiscal.cd_estabelecimento%type;


c01 CURSOR FOR
SELECT 	'UN',
	qt_item_nf,
	substr(nfe_elimina_caractere_especial(CASE WHEN coalesce(cd_material::text, '') = '' THEN obter_descricao_procedimento(cd_procedimento, ie_origem_proced)  ELSE obter_desc_material(cd_material) END ),1,255),
	campo_mascara_virgula_casas(vl_unitario_item_nf,2),
	campo_mascara_virgula_casas(vl_total_item_nf,2)
from	nota_fiscal_item
where   nr_sequencia = 	nr_sequencia_p;
	

BEGIN
	select 	nfe_elimina_caractere_especial(ds_observacao),
			vl_descontos,
			vl_total_nota,
			obter_dados_pf_pj(null,cd_cgc,'IM'),
			obter_dados_pf_pj(null,cd_cgc,'IE'),
			cd_estabelecimento
	into STRICT	ds_observacao_w,
			vl_descontos_w,
			vl_total_nota_w,
			nr_inscricao_municipal_w,
			nr_inscricao_estadual_w,
			cd_estabelecimento_w
	from    nota_fiscal
	where 	nr_sequencia = nr_sequencia_p;
	
	select count(*)
	into STRICT qtd_rps_regra_w
	from regra_descricao_rps
	where cd_estabelecimento = cd_estabelecimento_w;
								
	if (qtd_rps_regra_w > 0) then
		ds_retorno_w := obter_descricao_rps(cd_estabelecimento_w, nr_sequencia_p, 'DS_SERVICOS');
	else	
		open C01;
		loop
		fetch C01 into
			cd_unidade_w,
			qt_item_nf_w,
			ds_procedimento_w,
			vl_unitario_item_nf_w,
			vl_total_item_nf_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin	
				ds_itens_w := ds_itens_w || cd_unidade_w || ds_separador_w || to_char(qt_item_nf_w) || ds_separador_w
					|| ds_procedimento_w || ds_separador_w || vl_unitario_item_nf_w || ds_separador_w || vl_total_item_nf_w || ds_separador_w; 	
			end;
		end loop;
		close C01;
			
		if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
			ds_retorno_w := '@@' || ds_observacao_w;
		end if;
		
		ds_retorno_w := ds_retorno_w || '#@' || campo_mascara(vl_total_nota_w,2) || ds_sep_desconto_inc_w || campo_mascara(coalesce(vl_descontos_w,0),2) || ds_sep_desconto_con_w || campo_mascara(coalesce(vl_descontos_w,0),2);
		
		if (nr_inscricao_municipal_w IS NOT NULL AND nr_inscricao_municipal_w::text <> '') then
			ds_retorno_w := ds_retorno_w || ds_sep_mun_w || nr_inscricao_municipal_w;
		end if;
		
		if (nr_inscricao_estadual_w IS NOT NULL AND nr_inscricao_estadual_w::text <> '') then
			ds_retorno_w := ds_retorno_w || ds_sep_est_w || nr_inscricao_estadual_w;
		end if;
		
		ds_retorno_w := ds_itens_w || ds_retorno_w;

	end if;
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_nfse_tubarao (nr_sequencia_p bigint) FROM PUBLIC;

