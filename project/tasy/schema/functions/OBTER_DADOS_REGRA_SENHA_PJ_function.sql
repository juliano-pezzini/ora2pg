-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_regra_senha_pj ( cd_estabelecimento_p bigint, cd_cgc_p text, nm_usuario_p text, ie_retorno_p text) RETURNS varchar AS $body$
DECLARE


/*ie_retorno_p = 
S - Sequencia
M - mensagem
A - Assunto*/
			
nr_sequencia_w		bigint;
ds_assunto_w		varchar(255);
ds_mensagem_w		varchar(2000);
nm_fantasia_w		varchar(80);
ds_razao_social_w		pessoa_juridica.ds_razao_social%type;
ds_estabelecimento_w	varchar(80);
ds_senha_w		varchar(20);
nm_usuario_w		varchar(100);
ds_cargo_w		varchar(80);
nr_telefone_w		varchar(15);
nr_ramal_w		varchar(20);
ds_email_w		varchar(255);
cd_cnpj_editado_w		varchar(20);
cd_cnpj_w		varchar(14);
ie_usuario_w		varchar(3);


BEGIN

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_sequencia_w
from	regra_envio_email_compra
where	ie_tipo_mensagem = 17
and	ie_situacao = 'A'
and	cd_estabelecimento = cd_estabelecimento_p;

if (nr_sequencia_w > 0) then

	select	ie_usuario
	into STRICT	ie_usuario_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_Sequencia_w;
	if (ie_usuario_w = 'U') then --Usuario
		select	substr(obter_dados_usuario_opcao(nm_usuario_p,'M'),1,20),
			substr(obter_dados_usuario_opcao(nm_usuario_p,'E'),1,255),
			substr(coalesce(obter_compl_pf(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),2,'T'),obter_dados_pf_pj(null,obter_cgc_estabelecimento(cd_estabelecimento_p),'T')),1,15)
		into STRICT	nr_ramal_w,
			ds_email_w,
			nr_telefone_w
		from	usuario
		where	nm_usuario = nm_usuario_p;

	elsif	((ie_usuario_w = 'C') or (ie_usuario_w = 'O')) then --Setor compras		
		
		select	ds_email,
			nr_telefone
		into STRICT	ds_email_w,
			nr_telefone_w
		from	parametro_compras
		where	cd_estabelecimento = cd_estabelecimento_p;
	end if;
	
	select	obter_cgc_cpf_editado(cd_cgc) cd_cnpj_editado,
		cd_cgc,
		substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,100),
		substr(obter_nome_usuario(nm_usuario_p),1,100),
		substr(obter_desc_cargo(obter_dados_usuario_opcao(nm_usuario_p,'R')),1,80),
		nm_fantasia,
		ds_razao_social,
		ds_senha
	into STRICT	cd_cnpj_editado_w,
		cd_cnpj_w,
		ds_estabelecimento_w,
		nm_usuario_w,
		ds_cargo_w,
		nm_fantasia_w,
		ds_razao_social_w,
		ds_senha_w
	from	pessoa_juridica
	where	cd_cgc = cd_cgc_p;
	
	select	ds_assunto,
		ds_mensagem_padrao
	into STRICT	ds_assunto_w,
		ds_mensagem_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_sequencia_w;
	
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj_editado',cd_cnpj_editado_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cnpj',cd_cnpj_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fantasia_pj',nm_fantasia_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@razao_pj',ds_razao_social_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@estabelecimento',ds_estabelecimento_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@senha',ds_senha_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@nm_usuario',nm_usuario_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@usuario',nm_usuario_p);
	ds_assunto_w := replace_macro(ds_assunto_w,'@cargo',ds_cargo_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@fone',nr_telefone_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@ramal',nr_ramal_w);
	ds_assunto_w := replace_macro(ds_assunto_w,'@email',ds_email_w);
	ds_assunto_w := substr(ds_assunto_w,1,255);
	
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@cnpj_editado',cd_cnpj_editado_w);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@cnpj',cd_cnpj_w);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@fantasia_pj',nm_fantasia_w);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@razao_pj',ds_razao_social_w);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@estabelecimento',ds_estabelecimento_w);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@senha',ds_senha_w);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@nm_usuario',nm_usuario_w);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@usuario',nm_usuario_p);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@cargo',ds_cargo_w);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@fone',nr_telefone_w);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@ramal',nr_ramal_w);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@email',ds_email_w);
	ds_mensagem_w := substr(ds_mensagem_w,1,2000);	
	
end if;

if (ie_retorno_p = 'S') then
	return	nr_sequencia_w;
elsif (ie_retorno_p = 'M') then
	return	ds_mensagem_w;
elsif (ie_retorno_p = 'A') then
	return ds_assunto_w;
end if;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_regra_senha_pj ( cd_estabelecimento_p bigint, cd_cgc_p text, nm_usuario_p text, ie_retorno_p text) FROM PUBLIC;

