-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_media_espera_local (nr_seq_computador_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_media_w				varchar(255); --variavel de retorno 
nm_computador_w			varchar(255); -- retorno cursor 1 
 
--cursor2 
dt_atualizacao_nrec_w	timestamp;
nr_seq_senha_w			bigint;

--variaveis auxiliares para o c√°lculo 
dt_calculo_w			timestamp;
qt_diferenca_w			bigint := 0;
qt_acumulador_w			bigint := 0;

C01 CURSOR FOR 
	SELECT NM_COMPUTADOR 
	from ( 
	SELECT OBTER_NOME_COMPUTADOR(NR_SEQ_COMPUTADOR) NM_COMPUTADOR 
	from  MAQUINA_LOCAL_SENHA 
	where  NR_SEQ_COMP_MONITOR = NR_SEQ_COMPUTADOR_P  -- INTEGRIDADE TABELA COMPUTADOR 
	
union
 
	select A.NM_COMPUTADOR 
	from  COMPUTADOR A, 
		  MAQUINA_LOCAL_SENHA B, 
		  MAQUINA_MONITOR_ADICIONAL C 
	where A.NR_SEQUENCIA = B.NR_SEQ_COMPUTADOR 
	and	  B.NR_SEQUENCIA = C.NR_SEQ_LOCAL 
	and	  A.NR_SEQUENCIA = NR_SEQ_COMPUTADOR_P) alias1;

 
C02 CURSOR FOR 
	SELECT DT_ATUALIZACAO_NREC, 
		  NR_SEQ_SENHA 
	from  PACIENTE_SENHA_FILA_HIST 
	where DS_MAQUINA_CHAMADA = NM_COMPUTADOR_W 
	and  trunc(DT_ATUALIZACAO_NREC) = trunc(clock_timestamp());

 

BEGIN 
if (nr_seq_computador_p IS NOT NULL AND nr_seq_computador_p::text <> '') then 
 
	open C01;
	loop 
	fetch C01 into 
		nm_computador_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
 
		open C02;
		loop 
		fetch C02 into 
			dt_atualizacao_nrec_w, 
			nr_seq_senha_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
 
			select	max(a.dt_atualizacao_nrec) 
			into STRICT	dt_calculo_w 
			from	MOVIMENTACAO_SENHA_FILA a 
			where	a.dt_atualizacao_nrec < dt_atualizacao_nrec_w 
			and		nr_seq_pac_senha_fila = nr_seq_senha_w;
 
			select	OBTER_DIF_SEGUNDOS(dt_calculo_w,dt_atualizacao_nrec_w)+qt_diferenca_w 
			into STRICT	qt_diferenca_w 
			;
 
			qt_acumulador_w := qt_acumulador_w+1;
 
			end; --fim do cursor 2 
		end loop;
		close C02;
 
		end; --fim do cursor 1 
	end loop;
	close C01;
 
		if (qt_acumulador_w > 0) then 
			select	obter_horas_minutos(qt_diferenca_w/qt_acumulador_w) 
			into STRICT	ds_media_w 
			;
		end if;
 
end if;
return	ds_media_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_media_espera_local (nr_seq_computador_p bigint) FROM PUBLIC;

