-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_extensao ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, nr_seq_contrato_p bigint, nr_seq_cooperativa_p pls_cooperativa_area.nr_seq_cooperativa%type, dt_atual_p timestamp) RETURNS varchar AS $body$
DECLARE


c01 CURSOR FOR
SELECT  cd_municipio_ibge,
		sg_estado,
		nr_seq_regiao,
    nr_seq_congenere
  from pls_extensao_area
 where (nr_seq_segurado = nr_seq_segurado_p or ((nr_seq_contrato    = nr_seq_contrato_p) or (nr_seq_plano    = nr_seq_plano_p)))
   and dt_atual_p between coalesce(trunc(dt_inicio_vigencia), dt_atual_p) and coalesce(dt_fim_vigencia,dt_atual_p);

c02 CURSOR FOR
SELECT *
  from pls_cooperativa_area
 where nr_seq_cooperativa = nr_seq_cooperativa_p;

c03 CURSOR FOR
SELECT *
  from pls_prestador_area
 where nr_seq_prestador = nr_seq_prestador_p;

ie_area_coberta_w		varchar(1)	:= 'N';
BEGIN

  if (nr_seq_cooperativa_p IS NOT NULL AND nr_seq_cooperativa_p::text <> '') then
    for r_c01_w in c01 loop
      for r_c02_w in c02 loop
        if (coalesce(r_c01_w.sg_estado,'X') = coalesce(r_c02_w.sg_estado,'Y')) then
          ie_area_coberta_w	:= 'S';
              exit;
        elsif (coalesce(r_c01_w.nr_seq_regiao,'0') = coalesce(r_c02_w.nr_seq_regiao,'1')) then
          ie_area_coberta_w	:= 'S';
              exit;
        elsif (coalesce(r_c01_w.cd_municipio_ibge,'X') = coalesce(r_c02_w.cd_municipio_ibge,'Y')) then
          ie_area_coberta_w	:= 'S';
              exit;
        elsif (coalesce(r_c01_w.nr_seq_congenere, '0') = coalesce(r_c02_w.nr_seq_cooperativa,'1')) then
          ie_area_coberta_w	:= 'S';
              exit;
        elsif (pls_obter_se_municipio_em_uf(r_c02_w.cd_municipio_ibge, r_c01_w.sg_estado) = 'S') then
          ie_area_coberta_w	:= 'S';
              exit;
        elsif (pls_obter_se_municipio_em_uf(r_c01_w.cd_municipio_ibge, r_c02_w.sg_estado) = 'S') then
          ie_area_coberta_w	:= 'S';
              exit;
        elsif (pls_obter_se_mun_uf_regiao(r_c01_w.cd_municipio_ibge, null,r_c02_w.nr_seq_regiao) = 'S') then
          ie_area_coberta_w	:= 'S';
              exit;
        elsif (pls_obter_se_mun_uf_regiao(null, r_c01_w.sg_estado, r_c02_w.nr_seq_regiao) = 'S') then
          ie_area_coberta_w	:= 'S';
              exit;
        elsif (pls_obter_se_mun_uf_regiao(r_c02_w.cd_municipio_ibge, null,r_c01_w.nr_seq_regiao) = 'S') then
          ie_area_coberta_w	:= 'S';
              exit;
        elsif (pls_obter_se_mun_uf_regiao(null, r_c02_w.sg_estado, r_c01_w.nr_seq_regiao) = 'S') then
          ie_area_coberta_w	:= 'S';
              exit;
        end if;
      end loop;
    	if (ie_area_coberta_w = 'S') then
			exit;
		end if;
	end loop;
  end if;
  if (ie_area_coberta_w = 'N' ) then
	for r_c01_w in c01 loop
		for r_c03_w in c03 loop
			if (coalesce(r_c01_w.sg_estado,'X') = coalesce(r_c03_w.sg_estado,'Y')) then
				ie_area_coberta_w	:= 'S';
        		exit;
			elsif (coalesce(r_c01_w.nr_seq_regiao,'0') = coalesce(r_c03_w.nr_seq_regiao,'1')) then
				ie_area_coberta_w	:= 'S';
        		exit;
			elsif (coalesce(r_c01_w.cd_municipio_ibge,'X') = coalesce(r_c03_w.cd_municipio_ibge,'Y')) then
				ie_area_coberta_w	:= 'S';
        		exit;
			elsif (pls_obter_se_municipio_em_uf(r_c03_w.cd_municipio_ibge, r_c01_w.sg_estado) = 'S') then
				ie_area_coberta_w	:= 'S';
        		exit;
			elsif (pls_obter_se_municipio_em_uf(r_c01_w.cd_municipio_ibge, r_c03_w.sg_estado) = 'S') then
				ie_area_coberta_w	:= 'S';
        		exit;
			elsif (pls_obter_se_mun_uf_regiao(r_c01_w.cd_municipio_ibge, null,r_c03_w.nr_seq_regiao) = 'S') then
				ie_area_coberta_w	:= 'S';
        		exit;
			elsif (pls_obter_se_mun_uf_regiao(null, r_c01_w.sg_estado, r_c03_w.nr_seq_regiao) = 'S') then
				ie_area_coberta_w	:= 'S';
        		exit;
			elsif (pls_obter_se_mun_uf_regiao(r_c03_w.cd_municipio_ibge, null,r_c01_w.nr_seq_regiao) = 'S') then
				ie_area_coberta_w	:= 'S';
        		exit;
			elsif (pls_obter_se_mun_uf_regiao(null, r_c03_w.sg_estado, r_c01_w.nr_seq_regiao) = 'S') then
				ie_area_coberta_w	:= 'S';
        		exit;
			end if;
		end loop;
		if (ie_area_coberta_w = 'S') then
			exit;
		end if;
	end loop;
  end if;

return ie_area_coberta_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_extensao ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, nr_seq_contrato_p bigint, nr_seq_cooperativa_p pls_cooperativa_area.nr_seq_cooperativa%type, dt_atual_p timestamp) FROM PUBLIC;

