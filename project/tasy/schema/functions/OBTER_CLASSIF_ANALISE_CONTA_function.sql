-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_classif_analise_conta ( cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_material_p bigint) RETURNS bigint AS $body$
DECLARE


cd_area_w				bigint		:= 0;
cd_especialidade_w		bigint		:= 0;
cd_grupo_w				bigint		:= 0;
nr_sequencia_w         		bigint	:= 0;
cd_grupo_material_w		smallint	:= 0;
cd_subgrupo_material_w		smallint	:= 0;
cd_classe_material_w		integer	:= 0;

C01 CURSOR FOR
SELECT nr_seq_classif
from	regra_classif_analise
where	coalesce(cd_area_procedimento,cd_area_w)			= cd_area_w
and	coalesce(cd_especialidade_proc,cd_especialidade_w)	= cd_especialidade_w
and	coalesce(cd_grupo_proc,cd_grupo_w)				= cd_grupo_w
and	coalesce(cd_grupo_material,cd_grupo_material_w)	= cd_grupo_material_w
and	coalesce(cd_subgrupo_material,cd_subgrupo_material_w)= cd_subgrupo_material_w
and	coalesce(cd_classe_material,cd_classe_material_w)	= cd_classe_material_w
order by
	coalesce(cd_area_procedimento,0),
	coalesce(cd_especialidade_proc,0),
	coalesce(cd_grupo_proc,0),
	coalesce(cd_grupo_material,0),
	coalesce(cd_subgrupo_material,0),
	coalesce(cd_classe_material,0);


BEGIN

select 	coalesce(max(cd_grupo_proc),0),
		coalesce(max(cd_especialidade),0),
		coalesce(max(cd_area_procedimento),0)
into STRICT		cd_grupo_w,
		cd_especialidade_w,
		cd_area_w
from		Estrutura_Procedimento_V
where		cd_procedimento 	= cd_procedimento_p
and		ie_origem_proced	= ie_origem_proced_p
and		(cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '');

select 	coalesce(max(cd_grupo_material),0),
		coalesce(max(cd_subgrupo_material),0),
		coalesce(max(cd_classe_material),0)
into STRICT		cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w
from estrutura_material_v
where cd_material		= cd_material_p
  and	(cd_material_p IS NOT NULL AND cd_material_p::text <> '');

OPEN C01;
LOOP
FETCH C01 into nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	nr_sequencia_w	:= nr_sequencia_w;
END LOOP;
CLOSE C01;

if (coalesce(nr_sequencia_w,0) = 0) then
	select min(nr_sequencia)
	into STRICT nr_sequencia_w
	from analise_conta_classif;
end if;

RETURN nr_sequencia_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_classif_analise_conta ( cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_material_p bigint) FROM PUBLIC;

