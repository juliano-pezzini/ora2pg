-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_portador_cheque_data ( nr_seq_cheque_p bigint, dt_referencia_p timestamp, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/* ie_opcao_p
CP - Código do portador
CT - Código do tipo de portador
DP - Descrição do portador
DT - Descrição do tipo de portador
*/
cd_tipo_portador_w	integer;
cd_portador_w		bigint;
nr_seq_alt_portador_w	bigint;
dt_alteracao_w		timestamp;
dt_referencia_w		timestamp;


BEGIN

dt_referencia_w	:= trunc(dt_referencia_p,'dd');

select	max(a.dt_alteracao)
into STRICT	dt_alteracao_w
from	cheque_cr_alt_portador a
where	trunc(a.dt_alteracao,'dd')	<= dt_referencia_w
and	a.nr_seq_cheque	= nr_seq_cheque_p;

begin
select	b.cd_tipo_portador,
	b.cd_portador
into STRICT	cd_tipo_portador_w,
	cd_portador_w
from	cheque_cr_alt_portador b
where	b.dt_alteracao	= dt_alteracao_w
and	b.nr_seq_cheque	= nr_seq_cheque_p;

exception
	when no_data_found then
	select	coalesce(min(a.nr_sequencia),0)
	into STRICT	nr_seq_alt_portador_w
	from	cheque_cr_alt_portador a
	where	a.nr_seq_cheque	= nr_seq_cheque_p;

	if (nr_seq_alt_portador_w = 0) then
		select	a.cd_tipo_portador,
			a.cd_portador
		into STRICT	cd_tipo_portador_w,
			cd_portador_w
		from	cheque_cr a
		where	a.nr_seq_cheque = nr_seq_cheque_p;
	else
		select	b.cd_tipo_portador_ant,
			b.cd_portador_ant
		into STRICT	cd_tipo_portador_w,
			cd_portador_w
		from	cheque_cr_alt_portador b
		where	b.nr_seq_cheque	= nr_seq_cheque_p
		and	b.nr_sequencia	= nr_seq_alt_portador_w;
	end if;
end;

if (ie_opcao_p	= 'CP') then
	return to_char(cd_portador_w);
elsif (ie_opcao_p	= 'CT') then
	return to_char(cd_tipo_portador_w);
elsif (ie_opcao_p	= 'DP') then
	return substr(obter_desc_portador(cd_tipo_portador_w,cd_portador_w),1,255);
elsif (ie_opcao_p	= 'DT') then
	return substr(obter_valor_dominio(703,cd_tipo_portador_w),1,100);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_portador_cheque_data ( nr_seq_cheque_p bigint, dt_referencia_p timestamp, ie_opcao_p text) FROM PUBLIC;

