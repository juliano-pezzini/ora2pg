-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_pro_sched_manage_status (nr_atendimento_p atendimento_paciente.nr_atendimento%type) RETURNS varchar AS $body$
DECLARE

    ds_retorno_w	    varchar(1) := 'C';
	nr_count_w          bigint := 0;
	type_register_w		varchar(1);
	/*
	return types:
	C = Patients currently hospitalized (default)
	H = Scheduled hospitalization
	T = Scheduled transferred
	*/
BEGIN
	select  amount_register,
			type_register
	into STRICT	nr_count_w,
			type_register_w
	from (
			SELECT  date_register,
					type_register,
					amount_register
			from (
					SELECT  count(gv.dt_prevista) amount_register,
							max(gv.dt_prevista) date_register,
							'H' type_register
					from    gestao_vaga gv
					where   (gv.dt_prevista IS NOT NULL AND gv.dt_prevista::text <> '')
					and     gv.ie_status in ('R', 'I', 'A', 'L')
					and     gv.nr_atendimento = nr_atendimento_p
			
					
union

			
					select  count(apu.dt_entrada_unidade) amount_register,
							max(apu.dt_entrada_unidade) date_register,
							'T' type_register
					from    atend_paciente_unidade apu
					where   apu.ie_passagem_setor = 'N'
					and     apu.nr_atendimento = nr_atendimento_p
                    having  count(apu.dt_entrada_unidade) > 1
			) alias7
			where   (date_register IS NOT NULL AND date_register::text <> '')
			order by
					date_register desc
	) alias9 LIMIT 1;

    if (nr_count_w > 0) then
        ds_retorno_w := type_register_w;
    end if;

	return ds_retorno_w;
exception
    when no_data_found then
        return 'C';
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_pro_sched_manage_status (nr_atendimento_p atendimento_paciente.nr_atendimento%type) FROM PUBLIC;

