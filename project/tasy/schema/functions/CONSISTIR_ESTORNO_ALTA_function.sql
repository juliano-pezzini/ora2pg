-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consistir_estorno_alta (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
ie_estornar_alta_w	 	varchar(1);
ds_atendimentos_w	varchar(4000);
ds_atend_w	varchar(255);
ds_setor_w	varchar(255);
nr_seq_interno_w	atend_paciente_unidade.nr_seq_interno%type;
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
				
C01 CURSOR FOR	 
	SELECT 	a.nr_atendimento, 
			OBTER_ATEPACU_PACIENTE(a.nr_atendimento, 'IAA') 
	from 	atendimento_paciente a 
	where 	a.nr_atendimento <> nr_atendimento_p 
	and 	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
	and 	coalesce(a.dt_alta::text, '') = '' 
	order 	by 1;
	

BEGIN 
 
select	cd_pessoa_fisica 
into STRICT	cd_pessoa_fisica_w 
from	atendimento_paciente 
where	nr_atendimento 		= nr_atendimento_p;
 
begin 
	open C01;
	loop 
	fetch C01 into 			  
		ds_atend_w, 
		nr_seq_interno_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin	 
			 
			begin 
				select	DS_SETOR_ATENDIMENTO 
				into STRICT	ds_setor_w 
				from 	setor_atendimento a, 
						atend_paciente_unidade b 
				where	a.cd_setor_atendimento = b.cd_setor_atendimento 
				and		nr_Seq_interno = nr_seq_interno_w;
			exception 
				when	others then 
				begin 
					ds_setor_w := '';								     	
				end;
			end;
			 
			 
			ds_atendimentos_w := substr(ds_atendimentos_w || ds_atend_w || ' (' || ds_setor_w || ') ' || chr(13), 1, 3900);
		end;
	end loop;			
	close C01;			
exception 
	when	others then 
	begin 
		ds_atendimentos_w := null;										     	
	end;
end;
 
if (ds_atendimentos_w IS NOT NULL AND ds_atendimentos_w::text <> '') then			 
		ds_atendimentos_w := substr(wheb_mensagem_pck.get_texto (	460878, 
			'DS_ATEND=' || (SUBSTR(ds_atendimentos_w, 1, LENGTH(ds_atendimentos_w)-2))),1,4000);
end if;
 
return	ds_atendimentos_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consistir_estorno_alta (nr_atendimento_p bigint) FROM PUBLIC;

