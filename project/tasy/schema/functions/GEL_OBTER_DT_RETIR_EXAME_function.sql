-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gel_obter_dt_retir_exame ( nr_atendimento_p bigint) RETURNS timestamp AS $body$
DECLARE


ds_retorno_w		timestamp;

/* Function utilizada na Gest√£o de Entrega de Laudos */

/* Igual a function hsl_obter_dt_retir_exame */

BEGIN

select	CASE WHEN 	substr(obter_data_extenso(max(trunc(coalesce(dt_resultado, dt_prev_execucao))) , 3), 0, 3)='Sab' THEN  max(trunc(coalesce(dt_resultado, dt_prev_execucao))) +2 WHEN 	substr(obter_data_extenso(max(trunc(coalesce(dt_resultado, dt_prev_execucao))) , 3), 0, 3)='Dom' THEN  max(trunc(coalesce(dt_resultado, dt_prev_execucao))) +1  ELSE max(trunc(coalesce(dt_resultado, dt_prev_execucao))) END
into STRICT	ds_retorno_w
from	prescr_procedimento
where	coalesce(dt_resultado, dt_prev_execucao) in (
		SELECT	coalesce(a.dt_resultado, a.dt_prev_execucao)
		FROM exame_laboratorio c, procedimento b, prescr_procedimento a
LEFT OUTER JOIN prescr_medica d ON (a.nr_prescricao = d.nr_prescricao)
WHERE a.cd_procedimento	= b.cd_procedimento and a.ie_origem_proced		= b.ie_origem_proced  and d.nr_atendimento 		= nr_atendimento_p and obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'O') = 'S' and coalesce(a.nr_seq_solic_sangue::text, '') = '' and a.ie_suspenso 		<> 'S' and a.nr_seq_exame 		= c.nr_seq_exame

		 
union


		SELECT	coalesce(a.dt_resultado, a.dt_prev_execucao)
		FROM proc_interno c, procedimento b, prescr_procedimento a
LEFT OUTER JOIN prescr_medica d ON (a.nr_prescricao = d.nr_prescricao)
WHERE a.cd_procedimento	= b.cd_procedimento and a.ie_origem_proced   = b.ie_origem_proced  and d.nr_atendimento = nr_atendimento_p and obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'O') = 'S' and coalesce(a.nr_seq_solic_sangue::text, '') = '' and a.ie_suspenso <> 'S' and a.nr_seq_proc_interno = c.nr_sequencia
		 );

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gel_obter_dt_retir_exame ( nr_atendimento_p bigint) FROM PUBLIC;

