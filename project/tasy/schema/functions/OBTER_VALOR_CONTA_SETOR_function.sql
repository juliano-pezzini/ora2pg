-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_conta_setor ( nr_interno_conta_p bigint, cd_setor_atendimento_p bigint, ie_valor_p integer) RETURNS bigint AS $body$
DECLARE

 
/*	ie_valor_p		0 - vl_total 
				1 - vl_procedimento 
				2 - vl_material 
				3 - vl_medico 
				4 - vl_custo_operacional 
				5 - vl_custo_original_proced 
				6 - vl_custo_original_material 
				7 - vl_diaria 
*/
 
 
ie_status_acerto_w		bigint;
ie_proc_mat_w			bigint;
vl_medico_w			double precision;
vl_anestesista_w		double precision;
vl_filme_w			double precision;
vl_auxiliares_w		double precision;
vl_custo_operacional_w	double precision;
vl_item_w			double precision;
vl_original_proced_w		double precision;
vl_original_material_w	double precision;
vl_diaria_w			double precision;
nr_seq_proc_pacote_w		bigint;

vl_resultado_w		double precision := 0;

C01 CURSOR FOR 
	SELECT 	ie_proc_mat, 
			coalesce(nr_seq_proc_pacote,0), 
			coalesce(sum(vl_medico),0), 
			coalesce(sum(vl_anestesista),0), 
			coalesce(sum(vl_filme),0), 
			coalesce(sum(vl_auxiliares),0), 
			coalesce(sum(vl_custo_operacional),0), 
			coalesce(sum(vl_item),0), 
			coalesce(sum(CASE WHEN ie_proc_mat=1 THEN vl_original  ELSE 0 END ),0) vl_orig_proced, 
			coalesce(sum(CASE WHEN ie_proc_mat=2 THEN vl_original  ELSE 0 END ),0) vl_orig_mat, 
			coalesce(sum(CASE WHEN ie_proc_mat=1 THEN CASE WHEN tp_item=3 THEN vl_item  ELSE 0 END   ELSE 0 END ),0) vl_diaria 
	from 	conta_paciente_v 
	where 	nr_interno_conta = nr_interno_conta_p 
	 and	cd_setor_atendimento = cd_setor_atendimento_p 
	 and 	ie_status_acerto_w = 1 
--	 and 	qt_item <> 0			Edgar 18/03/2005, OS 16232, qdo glosa parcial fic com qt zero 
	 and 	coalesce(cd_motivo_exc_conta::text, '') = '' 
	 and 	coalesce(nr_seq_proc_pacote,nr_sequencia) = nr_sequencia 
	group by ie_proc_mat, 
		coalesce(nr_seq_proc_pacote,0) 
	
union
 
	SELECT 	CASE WHEN coalesce(cd_material::text, '') = '' THEN 1  ELSE 2 END , 
			coalesce(nr_seq_proc_pacote,0), 
			coalesce(sum(vl_medico),0), 
			coalesce(sum(vl_anestesista),0), 
			coalesce(sum(vl_Materiais),0), 
			coalesce(sum(vl_auxiliares),0), 
			coalesce(sum(vl_custo_operacional),0), 
			coalesce(sum(vl_procedimento + vl_material),0), 
			coalesce(sum(CASE WHEN coalesce(cd_material::text, '') = '' THEN vl_original  ELSE 0 END ),0) vl_orig_proced, 
			coalesce(sum(CASE WHEN coalesce(cd_material::text, '') = '' THEN 0  ELSE vl_original END ),0) vl_orig_mat, 
			coalesce(sum(CASE WHEN ie_diaria='S' THEN vl_procedimento  ELSE 0 END ),0) vl_diaria 
	from 	conta_paciente_Resumo 
	where nr_interno_conta = nr_interno_conta_p 
	 and cd_setor_atendimento = cd_setor_atendimento_p		 
	 and ie_status_acerto_w = 2 
	group by CASE WHEN coalesce(cd_material::text, '') = '' THEN 1  ELSE 2 END , 
		coalesce(nr_seq_proc_pacote,0) 
	order by 1;


BEGIN 
 
select ie_status_acerto 
into STRICT	ie_status_acerto_w 
from	conta_paciente 
where	nr_interno_conta	= nr_interno_conta_p;
 
open C01;
loop 
	fetch C01 into	ie_proc_mat_w, 
				nr_seq_proc_pacote_w, 
				vl_medico_w, 
				vl_anestesista_w, 
				vl_filme_w, 
				vl_auxiliares_w, 
				vl_custo_operacional_w, 
				vl_item_w, 
				vl_original_proced_w, 
				vl_original_material_w, 
				vl_diaria_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
 
	RAISE NOTICE '%', vl_item_w;
 
	if (ie_proc_mat_w = 1) then 
		if (ie_valor_p = 0) then 
			vl_resultado_w := vl_resultado_w + vl_item_w;
		elsif (ie_valor_p = 1) then 
			vl_resultado_w := vl_item_w;
		elsif (ie_valor_p = 3) then 
			vl_resultado_w := vl_medico_w + vl_anestesista_w + vl_auxiliares_w;
		elsif (ie_valor_p = 4) then 
			vl_resultado_w := vl_custo_operacional_w;
		elsif (ie_valor_p = 5) then 
			begin 
			if (coalesce(nr_seq_proc_pacote_w,0) <> 0) then 
				vl_resultado_w := vl_original_proced_w;
			else 
				vl_resultado_w := vl_item_w;				
			end if;
			end;
		elsif (ie_valor_p = 7) then 
			vl_resultado_w := vl_diaria_w;
		end if;
 
	else 
		if (ie_valor_p = 0) then 
			vl_resultado_w := vl_resultado_w + vl_item_w;
		elsif (ie_valor_p = 2) then 
			vl_resultado_w := vl_item_w;
		elsif (ie_valor_p = 6) then 
			begin 
			if (coalesce(nr_seq_proc_pacote_w,0) <> 0) then 
				vl_resultado_w := vl_original_material_w;
			else 
				vl_resultado_w := vl_item_w;				
			end if;
			end;
		end if;
	end if;
end loop;
close C01;
 
return coalesce(vl_resultado_w,0);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_conta_setor ( nr_interno_conta_p bigint, cd_setor_atendimento_p bigint, ie_valor_p integer) FROM PUBLIC;

