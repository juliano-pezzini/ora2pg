-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_pac_resultato_js ( nr_prescricao_p bigint, ie_result_atend_p text, ie_exibe_diag_result_p text, ie_mostra_nome_p text, ie_idade_completa_p text, ie_observacao_coleta_p text) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w			varchar(2000) := '';
nm_paciente_w			varchar(255);
ds_procedencia_w		varchar(255);
nr_atendimento_w		bigint;
nr_prontuario_w			numeric(22);
nm_medico_w 			varchar(255);
nr_prescricao_w			bigint;
nr_anos_w				varchar(20);
ie_sexo_w				varchar(1);
qt_peso_w				real;
qt_altura_cm_w			real;
dt_mesnstruacao_w		varchar(255);
dt_prescricao_w			varchar(255);
dt_liberacao_w			varchar(255);
dt_entrega_w			varchar(255);
dt_entrada_atend_w		varchar(255);
ds_setor_atendimento_w	varchar(255);
ds_observacao_prescr_w	varchar(255);
ds_dados_clinicos_w		varchar(255);
ds_observacao_pac_w		varchar(255);
ds_setor_atual_w		varchar(255);
ds_diagnostico_w		varchar(255);
cd_pessoa_fisica_w		varchar(20);
ds_forma_entregra_w		varchar(255);
cd_convenio_w			integer;
ie_tipo_atendimento_w	smallint;
qt_exames_w				bigint;
qt_exames_sem_result_w	bigint;
ds_observacao_coleta_w	varchar(255);
dt_nascimento_w			varchar(10);
qt_tempo_jejum_real_w	varchar(255);


BEGIN 
 
SELECT * FROM carregar_info_prescricao_js(	 
	nr_prescricao_p, ie_mostra_nome_p, ie_idade_completa_p, nr_atendimento_w, dt_prescricao_w, nm_medico_w, nm_paciente_w, nr_anos_w, dt_liberacao_w, cd_pessoa_fisica_w, ie_sexo_w, ds_setor_atendimento_w, ds_forma_entregra_w, dt_entrega_w, dt_mesnstruacao_w, qt_peso_w, qt_altura_cm_w, nr_prontuario_w, qt_exames_w, qt_exames_sem_result_w, cd_convenio_w, ie_tipo_atendimento_w, dt_entrada_atend_w 
) INTO STRICT nr_atendimento_w, dt_prescricao_w, nm_medico_w, nm_paciente_w, nr_anos_w, dt_liberacao_w, cd_pessoa_fisica_w, ie_sexo_w, ds_setor_atendimento_w, ds_forma_entregra_w, dt_entrega_w, dt_mesnstruacao_w, qt_peso_w, qt_altura_cm_w, nr_prontuario_w, qt_exames_w, qt_exames_sem_result_w, cd_convenio_w, ie_tipo_atendimento_w, dt_entrada_atend_w
;
 
select 	substr(coalesce(a.ds_observacao, wheb_mensagem_pck.get_texto(323341)),1,255), 
		substr(coalesce(coalesce(a.ds_dado_clinico,obter_dado_clinico_proced(a.nr_prescricao)),wheb_mensagem_pck.get_texto(323343)),1,255), 
		substr(coalesce(obter_procedencia_atend(a.nr_atendimento,'d'), wheb_mensagem_pck.get_texto(323342)),1,90), 
		substr(obter_nome_setor(obter_setor_atendimento(a.nr_atendimento)),1,40), 
		substr(coalesce(b.ds_observacao,wheb_mensagem_pck.get_texto(323341)),1,255), 
		substr(coalesce(lab_obter_obs_coleta(a.nr_prescricao), wheb_mensagem_pck.get_texto(323341)),1,255), 
		substr(TO_CHAR(obter_nascimento_prescricao(a.nr_prescricao), 'dd/mm/yyyy'),1,255), 
		substr(coalesce(qt_tempo_jejum_real, 0) || ' ' || wheb_mensagem_pck.get_texto(835610), 1,255) 
into STRICT	ds_observacao_prescr_w, 
		ds_dados_clinicos_w, 
		ds_procedencia_w, 
		ds_setor_atendimento_w, 
		ds_observacao_pac_w, 
		ds_observacao_coleta_w, 
		dt_nascimento_w, 
		qt_tempo_jejum_real_w 
from 	prescr_medica a, 
		pessoa_fisica b 
where 	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
and		a.nr_prescricao = nr_prescricao_p;
 
if (ie_result_atend_p = 'N') then 
	ds_retorno_w := substr( 
						wheb_mensagem_pck.get_texto(308501) || ': ' || nm_paciente_w     || ' - ' || wheb_mensagem_pck.get_texto(365824) || ': ' || dt_nascimento_w    || ' - ' || wheb_mensagem_pck.get_texto(323346) || ': ' || ds_procedencia_w	|| '\n' || 
						wheb_mensagem_pck.get_texto(323347) || ': ' || nr_atendimento_w    || ' - ' || wheb_mensagem_pck.get_texto(323348) || ': ' || nr_prontuario_w    || ' - ' || wheb_mensagem_pck.get_texto(323349) || ': ' || nm_medico_w 		|| '\n' || 
						wheb_mensagem_pck.get_texto(323350) || ': ' || nr_prescricao_p    || ' - ' || wheb_mensagem_pck.get_texto(323353) || ': ' || nr_anos_w       || ' - ' || wheb_mensagem_pck.get_texto(323356) || ': ' || ie_sexo_w  		|| ' - ' || wheb_mensagem_pck.get_texto(323357) || ': ' || qt_peso_w || ' ' || wheb_mensagem_pck.get_texto(323358) || ' - ' || wheb_mensagem_pck.get_texto(323359) || ': ' || qt_altura_cm_w || ' - ' || wheb_mensagem_pck.get_texto(323360) || ': ' || dt_mesnstruacao_w || ' - ' || wheb_mensagem_pck.get_texto(323361) || ' ' || dt_prescricao_w || ' - ' || wheb_mensagem_pck.get_texto(835611) || ': ' || qt_tempo_jejum_real_w || '\n'|| 
						wheb_mensagem_pck.get_texto(323351) || ': ' || ds_setor_atendimento_w || ' - ' || wheb_mensagem_pck.get_texto(323355) || ': ' || ds_observacao_prescr_w || '\n' || 
						wheb_mensagem_pck.get_texto(323352) || ': ' || ds_dados_clinicos_w  || '\n' || 
						wheb_mensagem_pck.get_texto(385700) || ': ' || ds_observacao_pac_w, 
					1,1999);
elsif (ie_result_atend_p = 'S') then 
 
	ds_retorno_w := substr( 
						wheb_mensagem_pck.get_texto(308501) || ': ' || nm_paciente_w     || ' - ' || wheb_mensagem_pck.get_texto(365824) || ': ' || dt_nascimento_w || ' - ' || wheb_mensagem_pck.get_texto(323346) || ': ' || ds_procedencia_w 	|| '\n' || 
						wheb_mensagem_pck.get_texto(323347) || ': ' || nr_atendimento_w    || ' - ' || wheb_mensagem_pck.get_texto(323348) || ': ' || nr_prontuario_w || ' - ' || wheb_mensagem_pck.get_texto(323349) || ': ' || nm_medico_w 	|| '\n' || 
						wheb_mensagem_pck.get_texto(323353) || ': ' || nr_anos_w       || ' - ' || wheb_mensagem_pck.get_texto(323356) || ': ' || ie_sexo_w    || ' - ' || wheb_mensagem_pck.get_texto(323357) || ': ' || qt_peso_w  	|| ' ' || wheb_mensagem_pck.get_texto(323358) || ' - ' || wheb_mensagem_pck.get_texto(323359) || ': ' || qt_altura_cm_w || ' - ' || wheb_mensagem_pck.get_texto(323362) || ': ' || dt_entrada_atend_w || '\n'|| 
						wheb_mensagem_pck.get_texto(323351) || ': ' || ds_setor_atendimento_w || '\n' || 
						wheb_mensagem_pck.get_texto(385700) || ': ' || ds_observacao_pac_w, 
					1,1999);
end if;
 
if (ie_exibe_diag_result_p = 'S') then 
	ds_diagnostico_w := substr(obter_diagnostico_atendimento(nr_atendimento_w),1,120);
  ds_retorno_w 	 := substr(ds_retorno_w || '\n' || wheb_mensagem_pck.get_texto(323345) || ': ' || ds_diagnostico_w,1,1999);
end if;
 
if (ie_observacao_coleta_p = 'S') then 
	ds_retorno_w := substr(ds_retorno_w || '\n' || wheb_mensagem_pck.get_texto(323344) || ': ' || ds_observacao_coleta_w,1,1999);
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_pac_resultato_js ( nr_prescricao_p bigint, ie_result_atend_p text, ie_exibe_diag_result_p text, ie_mostra_nome_p text, ie_idade_completa_p text, ie_observacao_coleta_p text) FROM PUBLIC;

