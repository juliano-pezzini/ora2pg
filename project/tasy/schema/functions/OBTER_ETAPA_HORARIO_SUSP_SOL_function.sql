-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_etapa_horario_susp_sol ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, dt_horario_p timestamp, ie_tipo_item_p bigint default 1) RETURNS bigint AS $body$
DECLARE

/*
ie_tipo_item_p
1 - Soluções
2 - Suporte Nutricional Enteral SNE
3 - Hemoterapia
*/
nr_etapa_final_w	bigint;
nr_etapa_w		bigint := 0;
dt_horario_w		timestamp;

c01 CURSOR FOR
SELECT	dt_horario
from	prescr_mat_hor
where	nr_seq_solucao	= nr_seq_solucao_p
and	nr_prescricao	= nr_prescricao_p
group by dt_horario
order by dt_horario;

c02 CURSOR FOR
SELECT	dt_horario
from	prescr_mat_hor
where	nr_seq_material	= nr_seq_solucao_p
and	nr_prescricao	= nr_prescricao_p
group by dt_horario
order by dt_horario;

c03 CURSOR FOR
SELECT	dt_horario
from	prescr_proc_hor
where	nr_seq_procedimento	= nr_seq_solucao_p
and	nr_prescricao	= nr_prescricao_p
group by dt_horario
order by dt_horario;


BEGIN

if (ie_tipo_item_p = 1) then
	open C01;
	loop
	fetch C01 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		nr_etapa_w	:= nr_etapa_w + 1;
		if (dt_horario_w = dt_horario_p) then
			nr_etapa_final_w := nr_etapa_w;
		end if;
	end loop;
	close C01;
elsif (ie_tipo_item_p = 2) then
	open c02;
	loop
	fetch c02 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		nr_etapa_w	:= nr_etapa_w + 1;
		if (dt_horario_w = dt_horario_p) then
			nr_etapa_final_w := nr_etapa_w;
		end if;
	end loop;
	close c02;
elsif (ie_tipo_item_p = 3) then
	open c03;
	loop
	fetch c03 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		nr_etapa_w	:= nr_etapa_w + 1;
		if (dt_horario_w = dt_horario_p) then
			nr_etapa_final_w := nr_etapa_w;
		end if;
	end loop;
	close c03;
end if;

return	nr_etapa_final_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_etapa_horario_susp_sol ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, dt_horario_p timestamp, ie_tipo_item_p bigint default 1) FROM PUBLIC;

