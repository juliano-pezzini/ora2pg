-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_padrao_param_prescr_onc ( nr_atendimento_p bigint, cd_material_p bigint, ie_via_aplicacao_p text, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p text, qt_idade_p bigint, qt_peso_p bigint, ie_se_necessario_p text, ie_opcao_p text, cd_intervalo_p text default null, ie_solucao_p text default 'N') RETURNS varchar AS $body$
DECLARE

/*
I - Intervalo
D - Dose
DT - Dose de ataque
U - Unidade medida
J - Justificativa
A - Agora
SN - Se necessario
OL - Obedecer limite
HP   - Horarios padroes
LH - Limpa Primeiro Horario
FC - Formula de calculo
EJ - Exigir Justificativa
JP - Justificativa padrao
TD - Tipo dosagem (unidade de medida da vazao do medicamento
*/
ds_retorno_w			varchar(255) := null;
cd_unidade_medida_w		varchar(30);
cd_unidade_basica_w		varchar(30);
cd_intervalo_w			varchar(7);
ie_obriga_just_dose_w		varchar(1);
qt_dose_w				double precision;
ie_via_aplic_padrao_w		varchar(5);
ie_dispositivo_inf_w		varchar(1);
ds_mensagem_w			varchar(255);
qt_minuto_aplicacao_w	smallint;
qt_idade_w				double precision;
qt_idade_gestacional_w	double precision;
qt_idade_min_w			double precision;
qt_idade_max_w			double precision;
nr_seq_agrupamento_w	bigint;
qt_dias_solicitado_w	smallint;
ie_dose_w				varchar(2);
ie_diluicao_w			varchar(2);
ie_justificativa_padrao_w varchar(2);
ie_exige_justicativa_w	varchar(2);
ie_se_necessario_w		varchar(2);
qt_hora_aplicacao_w		smallint;
qt_solucao_w			double precision;
qt_dose_ataque_w		double precision;
ds_justificativa_w		varchar(2000);
ie_dose_nula_w			varchar(2);
hr_prim_horario_w		varchar(200);
ie_urgencia_w			varchar(1);
ie_obedecer_limite_w	varchar(1);
qt_dose_terapeutica_w	double precision;
nr_seq_dose_terap_w		bigint;
ds_horarios_w			varchar(2000);
ds_obs_padrao_w			varchar(2000);
nr_atendimento_w		bigint;
qt_casas_retorno_w		bigint;
ie_limpar_prim_hor_w	varchar(1);
ie_fracao_dose_w		varchar(1);
cd_setor_atendimento_w	setor_atendimento.cd_setor_atendimento%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
ie_tipo_dosagem_w		material_prescr.ie_tipo_dosagem%type;
ds_retorno_obs_w		varchar(2000);
ie_somente_sn_w			varchar(1);


c01 REFCURSOR;


BEGIN

if (coalesce(cd_material_p,0) = 0) then
	return '';
end if;

select	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA')),
	coalesce(max(Obter_semana_Idade_IGC(clock_timestamp(), b.dt_nascimento, b.dt_nascimento_ig, b.qt_dias_ig, b.qt_semanas_ig)),0)
into STRICT	qt_idade_w,
	qt_idade_gestacional_w
from	pessoa_fisica b
where	b.cd_pessoa_fisica	= cd_pessoa_fisica_p;

if (coalesce(nr_atendimento_p,0) > 0) then
	nr_atendimento_w	:= nr_atendimento_p;
else
	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	atendimento_paciente
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	coalesce(dt_alta::text, '') = '';
end if;

cd_unidade_basica_w	:= coalesce(obter_unidade_atendimento(nr_atendimento_w,'A','UB'),'0');

cd_setor_atendimento_w	:= coalesce(cd_setor_atendimento_p,0);
cd_estabelecimento_w	:= coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);

if cd_estabelecimento_w = 0 then
	select	coalesce(max(cd_estabelecimento),0)
	into STRICT	cd_estabelecimento_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;
end if;

if (cd_setor_atendimento_w > 0) then
	select	coalesce(max(nr_seq_agrupamento),0)
	into STRICT	nr_seq_agrupamento_w
	from	setor_atendimento
	where	cd_setor_atendimento	= cd_setor_atendimento_w;
end if;

if	((qt_idade_gestacional_w > 40) or (qt_idade_gestacional_w = 0)) then

	open c01 for
	SELECT	CASE WHEN coalesce(a.ie_somente_sn,'N')='S' THEN CASE WHEN ie_se_necessario_p='S' THEN 2  ELSE 1 END   ELSE 1 END  ie_somente_sn,
			qt_dose,
			substr(a.cd_intervalo,1,7),
			substr(a.cd_unidade_medida,1,30),
			a.ie_via_aplic_padrao,
			a.ie_dispositivo_infusao,
			a.qt_minuto_aplicacao,
			a.qt_dias_solicitado,
			a.ie_dose,
			a.ds_justificativa,
			a.qt_hora_aplicacao,
			a.qt_solucao,
			a.ie_diluicao,
			a.hr_prim_horario,
			a.ie_se_necessario,
			a.ie_justificativa_padrao,
			coalesce(a.ie_dose_nula,'N'),
			coalesce(a.ie_gerar_agora,'N'),
			coalesce(obter_idade_param_prescr_onc(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MIN'),0) qt_idade_min,
			coalesce(obter_idade_param_prescr_onc(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MAX'),9999999) qt_idade_max,
			a.ie_obedecer_limite,
			a.ds_mensagem,
			a.ie_obriga_just_dose,
			a.qt_dose_terapeutica,
			a.nr_seq_dose_terap,
			a.ds_horarios,
			a.qt_dose_especial,
			substr(a.ds_obs_padrao,1,2000) ds_obs_padrao,
			coalesce(a.ie_limpar_prim_hor,'N'),
			a.ie_exige_justificativa,
			a.ie_tipo_dosagem
	from	material_prescr a
	where	a.cd_material	= cd_material_p
	and		a.ie_tipo 		= '1'
	and 	(((coalesce(a.ie_somente_sn,'N') = 'S') and (ie_se_necessario_p = 'S')) or (coalesce(a.ie_somente_sn,'N') = 'N'))
	and		coalesce(qt_peso_p,1) between coalesce(a.qt_peso_min,0) and coalesce(a.qt_peso_max,999999)
	and		coalesce(trunc(qt_idade_p),1) between coalesce(obter_idade_param_prescr_onc(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MIN'),0) and coalesce(obter_idade_param_prescr_onc(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MAX'),9999999)
	and		((coalesce(a.cd_doenca_cid::text, '') = '') or (obter_se_cid_atendimento(nr_atendimento_w,a.cd_doenca_cid) = 'S'))
	and 	(((qt_idade_gestacional_w >= 41) and (coalesce(coalesce(a.qt_ig_min,a.qt_ig_max)::text, '') = '')) or
			 ((qt_idade_gestacional_w < 41) and
			  (((coalesce(coalesce(a.qt_ig_min,a.qt_ig_max)::text, '') = '') or (qt_idade_gestacional_w between coalesce(a.qt_ig_min,0) and coalesce(a.qt_ig_max,9999999))))))
	and		(((cd_setor_atendimento_w = 0) and (coalesce(a.cd_setor_atendimento::text, '') = '' and coalesce(a.nr_seq_agrupamento::text, '') = '')) or
			 ((cd_setor_atendimento_w > 0) and
			  ((coalesce(a.cd_setor_atendimento, cd_setor_atendimento_w) = cd_setor_atendimento_w) and (not exists ( SELECT 1 from regra_setor_mat_prescr b where a.nr_sequencia = b.nr_seq_mat_prescr and b.cd_setor_excluir = cd_setor_atendimento_w))) and
			  ((nr_seq_agrupamento_w = 0 and coalesce(a.nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento_w > 0 and coalesce(a.nr_seq_agrupamento,nr_seq_agrupamento_w) = nr_seq_agrupamento_w))))
	and		((cd_estabelecimento_w > 0 AND a.cd_estabelecimento = cd_estabelecimento_w) or (cd_estabelecimento_w = 0) or (coalesce(a.cd_estabelecimento::text, '') = ''))
	and		(((coalesce(cd_intervalo_p::text, '') = '') and (coalesce(a.cd_intervalo_filtro::text, '') = '')) or
			 ((cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') and (coalesce(a.cd_intervalo_filtro, cd_intervalo_p) = cd_intervalo_p)))
	and		(((cd_unidade_basica_w = '0') and (coalesce(a.cd_unidade_basica::text, '') = '')) or
			 ((cd_unidade_basica_w <> '0') and (coalesce(a.cd_unidade_basica, cd_unidade_basica_w) = cd_unidade_basica_w)))
	and		(((coalesce(ie_via_aplicacao_p::text, '') = '') and (coalesce(a.ie_via_aplicacao::text, '') = '')) or
			 ((ie_via_aplicacao_p IS NOT NULL AND ie_via_aplicacao_p::text <> '') and (coalesce(a.ie_via_aplicacao, ie_via_aplicacao_p) = ie_via_aplicacao_p)))
	and (coalesce(a.ie_aplica_solucao,'N') = 'S' or ie_solucao_p = 'N')
	order by ie_somente_sn,
			 coalesce(a.cd_setor_atendimento,99999) desc,
			 a.qt_idade_min,
	         a.qt_idade_max,
			 coalesce(a.ie_via_aplicacao, 'zzzzzzzz') desc,
			 coalesce(a.qt_peso_min, 99999999) desc,
			 a.nr_sequencia;
else

	open c01 for
	SELECT	CASE WHEN coalesce(a.ie_somente_sn,'N')='S' THEN CASE WHEN ie_se_necessario_p='S' THEN 2  ELSE 1 END   ELSE 1 END  ie_somente_sn,
			qt_dose,
			substr(a.cd_intervalo,1,7),
			substr(a.cd_unidade_medida,1,30),
			a.ie_via_aplic_padrao,
			a.ie_dispositivo_infusao,
			a.qt_minuto_aplicacao,
			a.qt_dias_solicitado,
			a.ie_dose,
			a.ds_justificativa,
			a.qt_hora_aplicacao,
			a.qt_solucao,
			a.ie_diluicao,
			a.hr_prim_horario,
			a.ie_se_necessario,
			a.ie_justificativa_padrao,
			coalesce(a.ie_dose_nula,'N'),
			coalesce(a.ie_gerar_agora,'N'),
			coalesce(obter_idade_param_prescr_onc(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MIN'),0) qt_idade_min,
			coalesce(obter_idade_param_prescr_onc(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MAX'),9999999) qt_idade_max,
			a.ie_obedecer_limite,
			a.ds_mensagem,
			a.ie_obriga_just_dose,
			a.qt_dose_terapeutica,
			a.nr_seq_dose_terap,
			a.ds_horarios,
			a.qt_dose_especial,
			substr(a.ds_obs_padrao,1,2000) ds_obs_padrao,
			coalesce(a.ie_limpar_prim_hor,'N'),
			a.ie_exige_justificativa,
			a.ie_tipo_dosagem
	from	material_prescr a
	where	a.cd_material	= cd_material_p
	and		a.ie_tipo 		= '1'
	and 	(((coalesce(a.ie_somente_sn,'N') = 'S') and (ie_se_necessario_p = 'S')) or (coalesce(a.ie_somente_sn,'N') = 'N'))
	and		coalesce(qt_peso_p,1) between coalesce(a.qt_peso_min,0) and coalesce(a.qt_peso_max,999999)
	and		coalesce(trunc(qt_idade_w),1) between coalesce(obter_idade_param_prescr_onc(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MIN'),0) and coalesce(obter_idade_param_prescr_onc(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MAX'),9999999)
	and		((coalesce(a.cd_doenca_cid::text, '') = '') or (obter_se_cid_atendimento(nr_atendimento_w,a.cd_doenca_cid) = 'S'))
	and 	(((qt_idade_gestacional_w >= 41) and (coalesce(coalesce(a.qt_ig_min,a.qt_ig_max)::text, '') = '')) or
			 ((qt_idade_gestacional_w < 41) and
			  (((coalesce(coalesce(a.qt_ig_min,a.qt_ig_max)::text, '') = '') or (qt_idade_gestacional_w between coalesce(a.qt_ig_min,0) and coalesce(a.qt_ig_max,9999999))))))
	and		(((cd_setor_atendimento_w = 0) and (coalesce(a.cd_setor_atendimento::text, '') = '' and coalesce(a.nr_seq_agrupamento::text, '') = '')) or
			 ((cd_setor_atendimento_w > 0) and
			  ((coalesce(a.cd_setor_atendimento, cd_setor_atendimento_w) = cd_setor_atendimento_w) and (not exists ( SELECT 1 from regra_setor_mat_prescr b where a.nr_sequencia = b.nr_seq_mat_prescr and b.cd_setor_excluir = cd_setor_atendimento_w))) and
			  ((nr_seq_agrupamento_w = 0 and coalesce(a.nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento_w > 0 and coalesce(a.nr_seq_agrupamento,nr_seq_agrupamento_w) = nr_seq_agrupamento_w))))
	and		((cd_estabelecimento_w > 0 AND a.cd_estabelecimento = cd_estabelecimento_w) or (cd_estabelecimento_w = 0) or (coalesce(a.cd_estabelecimento::text, '') = ''))
	and		(((coalesce(cd_intervalo_p::text, '') = '') and (coalesce(a.cd_intervalo_filtro::text, '') = '')) or
			 ((cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') and (coalesce(a.cd_intervalo_filtro, cd_intervalo_p) = cd_intervalo_p)))
	and		(((cd_unidade_basica_w = '0') and (coalesce(a.cd_unidade_basica::text, '') = '')) or
			 ((cd_unidade_basica_w <> '0') and (coalesce(a.cd_unidade_basica, cd_unidade_basica_w) = cd_unidade_basica_w)))
	and		(((coalesce(ie_via_aplicacao_p::text, '') = '') and (coalesce(a.ie_via_aplicacao::text, '') = '')) or
			 ((ie_via_aplicacao_p IS NOT NULL AND ie_via_aplicacao_p::text <> '') and (coalesce(a.ie_via_aplicacao, ie_via_aplicacao_p) = ie_via_aplicacao_p)))
	and (coalesce(a.ie_aplica_solucao,'N') = 'S' or ie_solucao_p = 'N')
	order by ie_somente_sn,
			 coalesce(a.cd_setor_atendimento,99999) desc,
			 coalesce(a.qt_ig_min,0),
	         coalesce(a.qt_ig_max,0),
			 a.qt_idade_min,
			 a.qt_idade_max,
			 coalesce(a.ie_via_aplicacao, 'zzzzzzzz') desc,
			 coalesce(a.qt_peso_min, 99999999) desc,
			 a.nr_sequencia;
end if;

loop
fetch c01 into
	ie_somente_sn_w,
	qt_dose_w,
	cd_intervalo_w,
	cd_unidade_medida_w,
	ie_via_aplic_padrao_w,
	ie_dispositivo_inf_w,
	qt_minuto_aplicacao_w,
	qt_dias_solicitado_w,
	ie_dose_w,
	ds_justificativa_w,
	qt_hora_aplicacao_w,
	qt_solucao_w,
	ie_diluicao_w,
	hr_prim_horario_w,
	ie_se_necessario_w,
	ie_justificativa_padrao_w,
	ie_dose_nula_w,
	ie_urgencia_w,
	qt_idade_min_w,
	qt_idade_max_w,
	ie_obedecer_limite_w,
	ds_mensagem_w,
	ie_obriga_just_dose_w,
	qt_dose_terapeutica_w,
	nr_seq_dose_terap_w,
	ds_horarios_w,
	qt_dose_ataque_w,
	ds_obs_padrao_w,
	ie_limpar_prim_hor_w,
	ie_exige_justicativa_w,
	ie_tipo_dosagem_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	begin

	ie_fracao_dose_w := null;

	if (((ie_opcao_p = 'D') or (ie_opcao_p = 'DT')) and (coalesce(ie_dose_w,'F') <> 'F')) then
		select	coalesce(max(ie_fracao_dose),'N')
		into STRICT	ie_fracao_dose_w
		from	unidade_medida
		where	cd_unidade_medida = cd_unidade_medida_w;
	end if;

	if (ie_opcao_p = 'I') then
		ds_retorno_w	:= cd_intervalo_w;
	elsif (ie_opcao_p = 'D') then
		select	coalesce(max(qt_casas),0)
		into STRICT	qt_casas_retorno_w
		from	rep_regra_arredond_dose
		where	qt_peso_p between qt_peso_inicial and qt_peso_final;

		if (coalesce(ie_dose_w,'F') = 'F') then
			if (qt_casas_retorno_w > 0) then
				ds_retorno_w	:= round(qt_dose_w,qt_casas_retorno_w);
			else
				ds_retorno_w	:= qt_dose_w;
			end if;

		else
			if (ie_fracao_dose_w = 'S') then
				if (qt_casas_retorno_w > 0) then
					ds_retorno_w	:= round(qt_dose_w * coalesce(qt_peso_p,1),qt_casas_retorno_w);
				else
					ds_retorno_w	:= qt_dose_w * coalesce(qt_peso_p,1);
				end if;
			else
				if (qt_casas_retorno_w > 0) then
					ds_retorno_w	:= round(qt_dose_w * coalesce(qt_peso_p,1),qt_casas_retorno_w);
				else
					ds_retorno_w	:= round(qt_dose_w * coalesce(qt_peso_p,1));
				end if;
			end if;
		end if;
	elsif (ie_opcao_p = 'DT') then
		if (coalesce(ie_dose_w,'F') = 'F') then
			ds_retorno_w	:= qt_dose_ataque_w;
		else
			if (ie_fracao_dose_w = 'S') then
				ds_retorno_w	:= qt_dose_ataque_w * coalesce(qt_peso_p,1);
			else
				ds_retorno_w	:= round(qt_dose_ataque_w * coalesce(qt_peso_p,1));
			end if;
		end if;
	elsif (ie_opcao_p = 'U') then
		ds_retorno_w	:= cd_unidade_medida_w;
	elsif (ie_opcao_p = 'FC') then
		if (coalesce(ie_dose_w,'F') = 'F') then
			ds_retorno_w	:= qt_dose_w||' '||cd_unidade_medida_w||' fixo';
		else
			ds_retorno_w	:= qt_dose_w||' '||cd_unidade_medida_w||'/kg';
		end if;
	elsif (ie_opcao_p = 'V') then
		ds_retorno_w	:= ie_via_aplic_padrao_w;
	elsif (ie_opcao_p = 'DI') then
		ds_retorno_w	:= ie_dispositivo_inf_w;
	elsif (ie_opcao_p = 'MA') then
		ds_retorno_w	:= qt_minuto_aplicacao_w;
	elsif (ie_opcao_p = 'HA') then
		ds_retorno_w	:= qt_hora_aplicacao_w;
	elsif (ie_opcao_p = 'S') then
		ds_retorno_w	:= qt_solucao_w;
	elsif (ie_opcao_p = 'J') then
		ds_retorno_w	:= substr(ds_justificativa_w,1,255);
	elsif (ie_opcao_p = 'L') then
		if (coalesce(ie_diluicao_w::text, '') = '') then
			select	max(ie_diluicao)
			into STRICT	ie_diluicao_w
			from	mat_via_aplic
			where	cd_material		= cd_material_p
			and	ie_via_aplicacao	= ie_via_aplicacao_p;
		else
			exit;
		end if;
		ds_retorno_w	:= ie_diluicao_w;
	elsif (ie_opcao_p = 'Q') then
		ds_retorno_w	:= qt_dias_solicitado_w;
	elsif (ie_opcao_p = 'H') then
		ds_retorno_w	:= hr_prim_horario_w;
	elsif (ie_opcao_p = 'JP') then
		ds_retorno_w	:= obter_dados_medic_atb_var(cd_material_p,cd_estabelecimento_w,ie_justificativa_padrao_w,'JP',null,null,null);
	elsif (ie_opcao_p = 'SN') then
		ds_retorno_w	:= ie_se_necessario_w;
	elsif (ie_opcao_p = 'DB') then
		ds_retorno_w	:= ie_dose_nula_w;
	elsif (ie_opcao_p = 'A') then
		ds_retorno_w	:= ie_urgencia_w;
	elsif (ie_opcao_p = 'M') then
		ds_retorno_w	:= ds_mensagem_w;
	elsif (ie_opcao_p = 'M1') then
		ds_retorno_w	:= ie_obriga_just_dose_w;
	elsif (ie_opcao_p = 'QT') then
		ds_retorno_w	:= qt_dose_terapeutica_w;
	elsif (ie_opcao_p = 'TT') then
		ds_retorno_w	:= nr_seq_dose_terap_w;
	elsif (ie_opcao_p = 'OL') then
		ds_retorno_w	:= ie_obedecer_limite_w;
	elsif (ie_opcao_p = 'HP') then
		ds_retorno_w	:= ds_horarios_w;
	elsif (ie_opcao_p = 'O') then
		ds_retorno_obs_w := ds_obs_padrao_w;
	elsif (ie_opcao_p = 'LH') then
		ds_retorno_w 	:= ie_limpar_prim_hor_w;
	elsif (ie_opcao_p = 'HR') then
		ds_retorno_w 	:= coalesce(qt_hora_aplicacao_w,0);
	elsif (ie_opcao_p = 'MI') then
		ds_retorno_w 	:= coalesce(qt_minuto_aplicacao_w,0);
	elsif (ie_opcao_p = 'TD') then
		ds_retorno_w 	:= ie_tipo_dosagem_w;
	elsif (ie_opcao_p = 'EJ') then
		ds_retorno_w    := ie_exige_justicativa_w;
	else
		ds_retorno_w	:= '';
	end if;
	end;
end loop;
close c01;

if (ie_opcao_p = 'L') then
	if (coalesce(ie_diluicao_w::text, '') = '') then
		select	max(ie_diluicao)
		into STRICT	ie_diluicao_w
		from	mat_via_aplic
		where	cd_material		= cd_material_p
		and	ie_via_aplicacao	= ie_via_aplicacao_p;

		ds_retorno_w	:= ie_diluicao_w;
	end if;
	if (coalesce(ie_diluicao_w::text, '') = '') then
		select	max(ie_diluicao)
		into STRICT	ie_diluicao_w
		from	material
		where	cd_material		= cd_material_p;
		ds_retorno_w	:= ie_diluicao_w;
	end if;
end if;

if (ie_opcao_p = 'O') then
	return ds_retorno_obs_w;
else
	return ds_retorno_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_padrao_param_prescr_onc ( nr_atendimento_p bigint, cd_material_p bigint, ie_via_aplicacao_p text, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p text, qt_idade_p bigint, qt_peso_p bigint, ie_se_necessario_p text, ie_opcao_p text, cd_intervalo_p text default null, ie_solucao_p text default 'N') FROM PUBLIC;

