-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consistir_se_agrup_quimio ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, cd_material_p bigint, cd_intervalo_p text) RETURNS varchar AS $body$
DECLARE


cd_material_w		integer;
ie_via_aplicacao_w	varchar(5);
nr_seq_paciente_w	bigint;
cd_intervalo_w		varchar(7);
ie_bomba_infusao_w	varchar(1);
ds_dias_aplicacao_w	varchar(4000);
ds_dia_agrupar_w	varchar(2);
ds_dia_ciclo_w		varchar(5);
ie_protocolo_livre_w	varchar(1);
cd_intervalo_ww		varchar(7);

C01 CURSOR FOR
	SELECT	a.cd_material,
		a.cd_intervalo
	from	paciente_atend_medic a,
		paciente_atendimento b
	where	a.nr_seq_atendimento 	= b.nr_seq_atendimento
	and	b.nr_seq_atendimento 	= nr_seq_atendimento_p
	and	((a.cd_material		= cd_material_p) or (coalesce(cd_material_p::text, '') = ''))
	and	((a.cd_intervalo	= cd_intervalo_p) or (coalesce(cd_intervalo_p::text, '') = ''));

C02 CURSOR FOR
	SELECT	b.ds_dia_ciclo,
		a.cd_intervalo,
		a.ie_bomba_infusao
	from	paciente_atend_medic a,
		paciente_atendimento b
	where	a.nr_seq_atendimento 	= b.nr_seq_atendimento
	and	b.nr_seq_paciente 	= nr_seq_paciente_p
	and	a.cd_material		= cd_material_w;


BEGIN

select	coalesce(max(ie_protocolo_livre),'N')
into STRICT	ie_protocolo_livre_w
from	paciente_setor
where	nr_seq_paciente	=	nr_seq_paciente_p;


if (ie_protocolo_livre_w = 'N') and (nr_seq_paciente_p > 0) and (nr_seq_atendimento_p > 0) then

	open C01;
	loop
	fetch C01 into
		cd_material_w,
		cd_intervalo_ww;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	max(cd_intervalo),
			max(ie_bomba_infusao),
			max(ds_dias_aplicacao)
		into STRICT	cd_intervalo_w,
			ie_bomba_infusao_w,
			ds_dias_aplicacao_w
		from	paciente_protocolo_medic
		where	nr_seq_paciente		= nr_seq_paciente_p
		and	cd_material		= cd_material_w
		and	((cd_intervalo		= cd_intervalo_p) or (coalesce(cd_intervalo_p::text, '') = ''));

		select	max(ds_dia_agrupar)
		into STRICT	ds_dia_agrupar_w
		from	regra_agrupamento_prep
		where	coalesce(cd_intervalo,coalesce(cd_intervalo_ww,'X'))		= coalesce(cd_intervalo_ww,'X')
		and	coalesce(ie_bomba_infusao,coalesce(ie_bomba_infusao_w,'X'))	= coalesce(ie_bomba_infusao_w,'X')
		and	coalesce(ds_dias_aplic,coalesce(ds_dias_aplicacao_w,'X'))		= coalesce(ds_dias_aplicacao_w,'X')
		and	coalesce(cd_material,coalesce(cd_material_w,0))			= coalesce(cd_material_w,0);

		if (ds_dia_agrupar_w IS NOT NULL AND ds_dia_agrupar_w::text <> '') then
			exit;
		end if;

		end;
	end loop;
	close C01;

elsif (ie_protocolo_livre_w = 'S') and (nr_seq_paciente_p > 0) and (nr_seq_atendimento_p > 0) then

	open C01;
	loop
	fetch C01 into
		cd_material_w,
		cd_intervalo_ww;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_dias_aplicacao_w := null;

		open C02;
		loop
		fetch C02 into
			ds_dia_ciclo_w,
			cd_intervalo_w,
			ie_bomba_infusao_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			if (coalesce(ds_dias_aplicacao_w::text, '') = '') then
				ds_dias_aplicacao_w := ds_dia_ciclo_w;
			else
				ds_dias_aplicacao_w := ds_dias_aplicacao_w || ',' || ds_dia_ciclo_w;
			end if;
			end;
		end loop;
		close C02;

		select	max(ds_dia_agrupar)
		into STRICT	ds_dia_agrupar_w
		from	regra_agrupamento_prep
		where	coalesce(cd_intervalo,coalesce(cd_intervalo_w,'X'))		= coalesce(cd_intervalo_w,'X')
		and	coalesce(ie_bomba_infusao,coalesce(ie_bomba_infusao_w,'X'))	= coalesce(ie_bomba_infusao_w,'X')
		and	coalesce(ds_dias_aplic,coalesce(ds_dias_aplicacao_w,'X'))		= coalesce(ds_dias_aplicacao_w,'X')
		and	coalesce(cd_material,coalesce(cd_material_w,0))			= coalesce(cd_material_w,0);

		if (ds_dia_agrupar_w IS NOT NULL AND ds_dia_agrupar_w::text <> '') then
			exit;
		end if;

		end;
	end loop;
	close C01;

end if;

return ds_dia_agrupar_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consistir_se_agrup_quimio ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, cd_material_p bigint, cd_intervalo_p text) FROM PUBLIC;

