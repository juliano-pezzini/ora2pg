-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION proj_obter_dados_ordem_serv ( nr_seq_ordem_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


nr_seq_estagio_w		bigint;
ds_retorno_w		varchar(255);

/*
ie_opcao_p:
C - Data conclusão
A - Data acordo
S - Solicitante
OC - Ordem cliente
CL - Classificação da OS
CLC - Classificação do Cliente
PROJ - Projeto (PROJ_ORDEM_SERVICO) da ordem de serviço
PROJD - Ordens de serviço do projeto desenvolvimento- vinculadas na PROJ_PROJETO
PROJA - Ordens de serviço do projeto que estão em acompanhamento (tabela PROJ_PROJETO_CLIENTE_ADIC)
PROJDDT -  Data fim previsto da ordem de serviço do projeto desenvolvimento- vinculadas na PROJ_PROJETO.
PROJDT - Data fim previsto da ordem de serviço do projeto que estão em acompanhamento (tabela PROJ_PROJETO_CLIENTE_ADIC).
GRPDES - Grupo de desenvolvimento
GRPSUP - Grupo do suporte
*/
BEGIN
if (nr_seq_ordem_p IS NOT NULL AND nr_seq_ordem_p::text <> '') then
	if (ie_opcao_p = 'C') then
		select	to_char(dt_interna_acordo, 'dd/mm/yyyy hh24:mi:ss')
		into STRICT	ds_retorno_w
		from 	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_p;
	elsif (ie_opcao_p = 'A') then
		select	to_char(dt_fim_acordo, 'dd/mm/yyyy hh24:mi:ss')
		into STRICT	ds_retorno_w
		from 	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_p;
	elsif (ie_opcao_p = 'S') then
		select	substr(obter_nome_pf(cd_pessoa_solicitante),1,200)
		into STRICT	ds_retorno_w
		from 	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_p;
	elsif (ie_opcao_p = 'OC') then
		select	NR_SEQ_ORIGEM
		into STRICT	ds_retorno_w
		from 	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_p;
	elsif (ie_opcao_p = 'CL') then
		select	obter_valor_dominio(1149, ie_classificacao)
		into STRICT	ds_retorno_w
		from 	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_p;
	elsif (ie_opcao_p = 'CLC') then
		select	obter_valor_dominio(1149, ie_classificacao_cliente)
		into STRICT	ds_retorno_w
		from 	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_p;
	elsif (ie_opcao_p = 'PROJ') then
		select	max(b.nr_seq_proj)
		into STRICT	ds_retorno_w
		from	proj_projeto a, proj_ordem_servico b
		where	b.nr_seq_ordem 	= nr_seq_ordem_p
		and	a.nr_sequencia	= b.nr_seq_proj
		and	a.ie_origem	= 'D';
	elsif (ie_opcao_p = 'PROJD') then
		select	max(nr_sequencia)
		into STRICT	ds_retorno_w
		from (SELECT	nr_sequencia
			from	proj_projeto
			where	nr_seq_ordem_serv = nr_seq_ordem_p
			
union

			SELECT	nr_sequencia
			from	PROJ_PROJETO_CLIENTE_ADIC
			where 	NR_SEQ_ORDEM_SERV  = nr_seq_ordem_p) alias2;	
	elsif (ie_opcao_p = 'PROJDT') then
		select	max(a.dt_fim_prev)
		into STRICT	ds_retorno_w
		from	proj_projeto a, proj_ordem_servico b
		where	b.nr_seq_ordem 	= nr_seq_ordem_p
		and	a.nr_sequencia	= b.nr_seq_proj
		and	a.ie_origem	= 'D';
	elsif (ie_opcao_p = 'PROJDDT') then
		select	max(dt_fim_prev)
		into STRICT	ds_retorno_w
		from (SELECT	dt_fim_prev
			from	proj_projeto
			where	nr_seq_ordem_serv = nr_seq_ordem_p
			
union

			SELECT	b.dt_fim_prev
			from	proj_projeto b, PROJ_PROJETO_CLIENTE_ADIC a
			where 	a.NR_SEQ_ORDEM_SERV  = nr_seq_ordem_p
			and		a.nr_seq_projeto = b.nr_sequencia) alias2;	
	elsif (ie_opcao_p = 'PROJA') then
		select	max(nr_sequencia)
		into STRICT	ds_retorno_w
		from	proj_projeto_cliente_adic
		where	nr_seq_ordem_serv = nr_seq_ordem_p;
	elsif (ie_opcao_p = 'GRPDES') then
		select	obter_desc_grupo_desen(nr_seq_grupo_des)
		into STRICT	ds_retorno_w
		from 	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_p;	
	elsif (ie_opcao_p = 'GRPSUP') then
		select	obter_desc_grupo_suporte(nr_seq_grupo_sup)
		into STRICT	ds_retorno_w
		from 	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_p;	
	end if;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION proj_obter_dados_ordem_serv ( nr_seq_ordem_p bigint, ie_opcao_p text) FROM PUBLIC;

