-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_atend_ocorr_cih (nr_atendimento_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*
ie_opcao_p =
'DTAUH' 	= Data de atualização do ultimo historico da ultima ficha de ocorrencia do atendimento
'PFO'	= Possui ficha ocorrencia

*/
nr_ficha_ocorrencia_w 	bigint:=null;
dt_atualizacao_hist_w	varchar(30):=null;


BEGIN

select 	max(nr_ficha_ocorrencia)
into STRICT	nr_ficha_ocorrencia_w
from   	cih_ficha_ocorrencia
where  	nr_atendimento = nr_atendimento_p;

IF ie_opcao_p = 'DTAUH' then
	select 	to_char(max(dt_atualizacao),'dd/mm/yyyy hh24:mi:ss')
	into STRICT	dt_atualizacao_hist_w
	from   	CIH_FICHA_OCORRENCIA_HIST
	where  	nr_ficha_ocorrencia = nr_ficha_ocorrencia_w;
	RETURN 	dt_atualizacao_hist_w;
END IF;

if ie_opcao_p = 'PFO' then
	if (nr_ficha_ocorrencia_w IS NOT NULL AND nr_ficha_ocorrencia_w::text <> '') then
		return 'S';
	else
		return 'N';
	end if;
end if;

RETURN	null;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_atend_ocorr_cih (nr_atendimento_p bigint, ie_opcao_p text) FROM PUBLIC;

