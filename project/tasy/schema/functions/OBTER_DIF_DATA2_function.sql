-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dif_data2 (dt_inicial_p timestamp, dt_final_p timestamp) RETURNS varchar AS $body$
DECLARE


qt_segundo_w    bigint;
qt_min_w   	bigint;
qt_hora_w	bigint;
qt_dia_w	bigint;
qt_retorno_w	varchar(30);

qt_segundo_inicial_w 	bigint;
qt_segundo_fim_w 	bigint;

qt_hora_aux_w	bigint;


BEGIN

if (coalesce(dt_inicial_p::text, '') = '')
or (coalesce(dt_final_p::text, '') = '') then
	return '';
else
	qt_segundo_inicial_w 	:= (to_char(dt_inicial_p,'SSSSS'))::numeric;
	qt_segundo_fim_w	:= (to_char(dt_final_p,'SSSSS'))::numeric;

	if ( qt_segundo_inicial_w > qt_segundo_fim_w ) then
		qt_hora_aux_w	:= 24;
	end if;

	qt_segundo_w 	:= qt_segundo_fim_w - qt_segundo_inicial_w;

	qt_dia_w     	:= TRUNC(dt_final_p) - trunc(dt_inicial_p);
	qt_hora_w 	:= TRUNC(qt_segundo_w/60/60);
	qt_min_w	:= TRUNC(MOD(qt_segundo_w/60, 60));
	qt_segundo_w	:= MOD(qt_segundo_w, 60);

	if ( qt_segundo_w < 0 )then
		qt_segundo_w 	:= 60 + qt_segundo_w;
		qt_min_w	:= qt_min_w - 1;
	end if;
	if ( qt_min_w < 0 )then
		qt_min_w 	:= 60 + qt_min_w;
		qt_hora_w	:= qt_hora_w - 1;
	end if;
	if (qt_hora_w < 0) then
		qt_hora_w := 24 + qt_hora_w;
		qt_dia_w := qt_dia_w - 1;
	--if	( qt_dia_w > 0 ) then
		--qt_hora_w := -1*(qt_hora_w - (qt_dia_w * 60)) ;
		--qt_hora_w - (qt_dia_w * 24)
	end if;
	qt_retorno_w := qt_retorno_w || qt_dia_w || 'd ';
	if ( qt_hora_w < 10 ) then
		qt_retorno_w := qt_retorno_w || '0';
	end if;
	qt_retorno_w := qt_retorno_w || qt_hora_w || ':';
	if ( qt_min_w < 10 ) then
		qt_retorno_w := qt_retorno_w || '0';
	end if;
	qt_retorno_w := qt_retorno_w || qt_min_w;

	return qt_retorno_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dif_data2 (dt_inicial_p timestamp, dt_final_p timestamp) FROM PUBLIC;

