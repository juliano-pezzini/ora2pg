-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consistir_se_mat_contr_estrut ( nr_seq_estrutura_p mat_estrutura_cadastro.nr_seq_estrutura%type, cd_material_p material.cd_material%type) RETURNS varchar AS $body$
DECLARE

SUBTYPE one_char IS varchar(1);

ie_retorno_w				one_char := 'N';
cd_material_generico_w		material.cd_material_generico%type;
cd_material_estoque_w 		material.cd_material_estoque%type;

C01 CURSOR FOR
	SELECT	cd_material,
			cd_material_estoque
	from	material
	where	cd_material_generico = cd_material_p
	and		ie_situacao = 'A'
	and		cd_material <> cd_material_p;

BEGIN

if (nr_seq_estrutura_p IS NOT NULL AND nr_seq_estrutura_p::text <> '') and (cd_material_p is not  null) then

	select	max(cd_material_generico),
			max(cd_material_estoque)
	into STRICT	cd_material_generico_w,
			cd_material_estoque_w
	from	material
	where	cd_material = cd_material_p;
	
	select	coalesce(max('S'),'N')
	into STRICT	ie_retorno_w
	from	mat_estrutura_cadastro b
	where	b.nr_seq_estrutura	= nr_seq_estrutura_p
	and (b.cd_material = cd_material_p or
			b.cd_material = cd_material_estoque_w or
			b.cd_material = cd_material_generico_w);
	
	if (ie_retorno_w = 'N') then
		for r_c01 in c01 loop
			begin
			
			select	coalesce(max('S'),'N')
			into STRICT	ie_retorno_w
			from	mat_estrutura_cadastro b
			where	b.nr_seq_estrutura	= nr_seq_estrutura_p
			and (b.cd_material = r_c01.cd_material or
					b.cd_material = r_c01.cd_material_estoque);
			
			if (ie_retorno_w = 'S') then
				exit;
			end if;
			end;
		end loop;
	end if;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consistir_se_mat_contr_estrut ( nr_seq_estrutura_p mat_estrutura_cadastro.nr_seq_estrutura%type, cd_material_p material.cd_material%type) FROM PUBLIC;

