-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consistir_ordem_compra (nr_ordem_compra_p bigint) RETURNS varchar AS $body$
DECLARE


cd_local_estoque_ordem_w	ordem_compra.cd_local_entrega%type;
ie_tipo_local_ordem_w		local_estoque.ie_tipo_local%type;
ie_tipo_local_w			local_estoque.ie_tipo_local%type;
ds_material_w		  	material.ds_reduzida%type;

ds_erro_w           varchar(4000);

c01 CURSOR FOR
SELECT cd_local_estoque,
	cd_centro_custo,
	cd_material
from ordem_compra_item
where nr_ordem_compra = nr_ordem_compra_p
order by nr_item_oci;

BEGIN

select cd_local_entrega
into STRICT cd_local_estoque_ordem_w
from ordem_compra
where nr_ordem_compra = nr_ordem_compra_p;

select	coalesce(ie_tipo_local,0)
into STRICT ie_tipo_local_ordem_w
from 	local_estoque
where cd_local_estoque = cd_local_estoque_ordem_w;

for c01_row in c01 loop
begin
--c01_row.cd_local_estoque
--c01_row.cd_centro_custo
--c01_row.cd_material
  if (coalesce(c01_row.cd_local_estoque,0) > 0) then

    select	coalesce(ie_tipo_local,0)
    into STRICT ie_tipo_local_w
    from 	local_estoque
    where cd_local_estoque = c01_row.cd_local_estoque;

  else

    ie_tipo_local_w := ie_tipo_local_ordem_w;

  end if;

  if (ie_tipo_local_w = 8) then

    if (coalesce(c01_row.cd_centro_custo::text, '') = '') then

	select ds_material
	into STRICT ds_material_w
	from material
	where cd_material = c01_row.cd_material;

	ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(297677, 'CD_MATERIAL=' || c01_row.cd_material || ';DS_MATERIAL=' || ds_material_w)
		|| ' - ' || WHEB_MENSAGEM_PCK.get_texto(154351);
	--ds_erro_w := 'O Local de Estoque é Direto e o Centro de Custo não foi informado';
    end if;

  elsif (c01_row.cd_local_estoque IS NOT NULL AND c01_row.cd_local_estoque::text <> '' AND c01_row.cd_centro_custo IS NOT NULL AND c01_row.cd_centro_custo::text <> '') then

	select ds_material
	into STRICT ds_material_w
	from material
	where cd_material = c01_row.cd_material;

	ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(297677, 'CD_MATERIAL=' || c01_row.cd_material || ';DS_MATERIAL=' || ds_material_w)
		|| ' - ' || WHEB_MENSAGEM_PCK.get_texto(298907);
	--ds_erro_w := 'Preencher somente o local de estoque ou centro de custo.';
  end if;

  if (length(ds_erro_w) > 0) then
	exit;
  end if;

end;
end loop;

return ds_erro_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consistir_ordem_compra (nr_ordem_compra_p bigint) FROM PUBLIC;

