-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_cgc_externo ( nr_seq_exame_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_prescricao_p bigint, cd_material_exame_p text default null) RETURNS varchar AS $body$
DECLARE


    cd_cgc_externo_w             exame_laboratorio.cd_cgc_externo%type;
    cd_cgc_ext_param_w           exame_laboratorio.cd_cgc_externo%type;
    nr_atendimento_w             atendimento_paciente.nr_atendimento%type;
    cd_convenio_w                convenio.cd_convenio%type;
    nr_seq_material_w            exame_laboratorio_externo.nr_seq_material%type;
    cd_pessoa_fisica_w           prescr_medica.cd_pessoa_fisica%type;


BEGIN

    cd_cgc_ext_param_w := obter_param_usuario(718, 34, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_cgc_ext_param_w);

    begin
        select cd_cgc_externo
        into STRICT   cd_cgc_externo_w
        from   exame_laboratorio
        where  nr_seq_exame = nr_seq_exame_p
          and  cd_cgc_externo != coalesce(cd_cgc_ext_param_w, 0);
        exception
          when no_data_found then
               cd_cgc_externo_w := null;
               CALL gravar_log_lab_pragma(99800, SQLERRM, nm_usuario_p, nr_prescricao_p, null);
    end;

    if (coalesce(cd_cgc_externo_w::text, '') = '') then

        select nr_atendimento,
               cd_pessoa_fisica
        into STRICT   nr_atendimento_w,
               cd_pessoa_fisica_w
        from   prescr_medica
        where  nr_prescricao = nr_prescricao_p;

        select coalesce(acc.cd_convenio, 0)
        into STRICT   cd_convenio_w
        from   atend_categoria_convenio acc
        where  acc.nr_atendimento = nr_atendimento_w
          and  acc.nr_seq_interno = obter_atecaco_atendimento(acc.nr_atendimento);

        select nr_sequencia
        into STRICT   nr_seq_material_w
        from   material_exame_lab
        where  cd_material_exame = cd_material_exame_p;

        begin
            select cd_cgc_externo
            into STRICT   cd_cgc_externo_w
            from (
                SELECT cd_cgc_externo,
                       cd_estabelecimento
                from   exame_laboratorio_externo
                where  nr_seq_exame = nr_seq_exame_p
                  and  coalesce(cd_convenio, cd_convenio_w) = cd_convenio_w
                  and  coalesce(nr_seq_material, nr_seq_material_w) = nr_seq_material_w
                  and  coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p
                  and  ((coalesce(ie_tratamento::text, '') = '' ) or (obter_se_paciente_tratamento(cd_pessoa_fisica_w,ie_tratamento)='S'))
                  and  cd_cgc_externo != coalesce(cd_cgc_ext_param_w, 0)
                order by
                       coalesce(cd_convenio, 9999999999),
                       coalesce(ie_prioridade, 1)
            ) alias11 LIMIT 1;
            exception
            when no_data_found then
                 cd_cgc_externo_w := null;
                 CALL gravar_log_lab_pragma(99800, SQLERRM, nm_usuario_p, nr_prescricao_p, null);
        end;

    end if;

    return cd_cgc_externo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_cgc_externo ( nr_seq_exame_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_prescricao_p bigint, cd_material_exame_p text default null) FROM PUBLIC;

