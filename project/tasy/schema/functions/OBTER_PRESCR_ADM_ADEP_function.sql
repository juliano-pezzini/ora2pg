-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prescr_adm_adep (dt_validade_p timestamp, ie_ignorar_validade_p text, nr_atendimento_p bigint, dt_horario_p timestamp, cd_item_p text, cd_intervalo_p text, ie_origem_proced_p text, nr_seq_proc_interno_p text, ie_tipo_item_p text, qt_item_p bigint) RETURNS bigint AS $body$
DECLARE

 
nr_prescricao_p 	bigint;


BEGIN 
 
select  max(a.nr_prescricao) 
into STRICT	 nr_prescricao_p 
from   prescr_medica b, 
     prescr_dieta_hor a 
where  b.nr_prescricao     = a.nr_prescricao 
and   b.nr_atendimento    = nr_atendimento_p 
and   a.dt_horario      = dt_horario_p 
and   a.cd_refeicao      = cd_item_p 
and   ie_tipo_item_p     = 'D' 
and   coalesce(a.ie_situacao,'A') = 'A' 
and   coalesce(b.ie_adep,'S')   = 'S' 
and   coalesce(b.dt_suspensao::text, '') = '' 
and   coalesce(a.dt_suspensao::text, '') = '' 
and   ((ie_ignorar_validade_p = 'N' AND b.dt_validade_prescr > dt_validade_p) or (ie_ignorar_validade_p = 'S')) 
and   Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
 
	if (coalesce(nr_prescricao_p::text, '') = '') then 
		select  max(a.nr_prescricao) 
		into STRICT	 nr_prescricao_p 
		from   prescr_medica b, 
			 prescr_dieta_hor a, 
			 prescr_dieta c 
		where  b.nr_prescricao     = a.nr_prescricao 
		and   a.nr_prescricao     = c.nr_prescricao 
		and   a.nr_seq_dieta     = c.nr_sequencia 
		and   b.nr_atendimento    = nr_atendimento_p 
		and   a.dt_horario      = dt_horario_p 
		and   to_char(c.cd_dieta)   = cd_item_p 
		and   coalesce(a.cd_refeicao,'X') = 'X' 
		and   ie_tipo_item_p     = 'D' 
		and   coalesce(a.ie_situacao,'A') = 'A' 
		and   coalesce(b.ie_adep,'S')   = 'S' 
		and   coalesce(b.dt_suspensao::text, '') = '' 
		and   coalesce(a.dt_suspensao::text, '') = '' 
		and   ((coalesce(ie_ignorar_validade_p,'N') = 'S') or (b.dt_validade_prescr > dt_validade_p)) 
		and   Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
	end if;
 
	if (coalesce(nr_prescricao_p::text, '') = '') then 
		select  max(b.nr_prescricao) 
		into STRICT	 nr_prescricao_p 
		from   prescr_medica b, 
			 nut_atend_serv_dia_rep d, 
			 nut_atend_serv_dia a, 
			 prescr_dieta c 
		where  b.nr_atendimento    = a.nr_atendimento 
		and   b.nr_prescricao     = c.nr_prescricao 
		and   d.NR_SEQ_SERV_DIA    = a.nr_sequencia 
		and   d.nr_prescr_oral    = b.nr_prescricao 
		and   b.nr_atendimento    = nr_atendimento_p 
		and   a.dt_servico      = dt_horario_p 
		and	  a.nr_sequencia     = cd_item_p 
		and   ie_tipo_item_p     = 'DE' 
		and   coalesce(b.ie_adep,'S')   = 'S' 
		and   coalesce(b.dt_suspensao::text, '') = '' 
		and   coalesce(c.dt_suspensao::text, '') = '' 
		and   ((ie_ignorar_validade_p = 'N' AND b.dt_validade_prescr > dt_validade_p) or (ie_ignorar_validade_p = 'S'));
	end if;
 
	if (coalesce(nr_prescricao_p::text, '') = '') then 
		select  max(a.nr_prescricao) 
		into STRICT	 nr_prescricao_p 
		from   prescr_medica b, 
			 prescr_mat_hor a 
		where  b.nr_prescricao                             = a.nr_prescricao 
		and   b.nr_atendimento                            = nr_atendimento_p 
		and   a.dt_horario                              = dt_horario_p 
		and   a.cd_material                              = cd_item_p 
		and   obter_interv_item_rep(a.nr_prescricao,a.nr_seq_material,ie_tipo_item_p) = coalesce(cd_intervalo_p,'XPTO') 
		and   obter_dose_item_rep(a.nr_prescricao,a.nr_seq_material,ie_tipo_item_p,coalesce(a.ie_dose_especial,'N'))  = coalesce(qt_item_p,1) 
		and   ie_tipo_item_p                             = 'S' 
		and   a.ie_agrupador                             = 12 
		and   coalesce(a.ie_situacao,'A')                         = 'A' 
		and   coalesce(b.ie_adep,'S')                           = 'S' 
		and   coalesce(b.dt_suspensao::text, '') = '' 
		and   coalesce(a.dt_suspensao::text, '') = '' 
		and   obter_se_prescr_mat_susp(a.nr_prescricao,a.nr_seq_material)       = 'N' 
		and   ((ie_ignorar_validade_p = 'N' AND b.dt_validade_prescr > dt_validade_p) or (ie_ignorar_validade_p = 'S')) 
		and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
	end if;
	 
	if (coalesce(nr_prescricao_p::text, '') = '') then 
		select  max(a.nr_prescricao) 
		into STRICT	 nr_prescricao_p 
		from   prescr_medica b, 
			 prescr_mat_hor a 
		where  b.nr_prescricao                             = a.nr_prescricao 
		and   b.nr_atendimento                            = nr_atendimento_p 
		and   a.dt_horario                              = dt_horario_p 
		and   a.cd_material                              = cd_item_p 
		and   obter_interv_item_rep(a.nr_prescricao,a.nr_seq_material,ie_tipo_item_p) = coalesce(cd_intervalo_p,'XPTO') 
		and   obter_dose_item_rep(a.nr_prescricao,a.nr_seq_material,ie_tipo_item_p,coalesce(a.ie_dose_especial,'N'))  = coalesce(qt_item_p,1) 
		and   ie_tipo_item_p                             = 'M' 
		and   a.ie_agrupador                             = 1 
		and   coalesce(a.ie_situacao,'A')                         = 'A' 
		and   coalesce(b.ie_adep,'S')                           = 'S' 
		and   coalesce(b.dt_suspensao::text, '') = '' 
		and   coalesce(a.ie_adep,'S')                           = 'S' 
		and   coalesce(a.dt_suspensao::text, '') = '' 
		and   obter_se_prescr_mat_susp(a.nr_prescricao,a.nr_seq_material)       = 'N' 
		and   ((ie_ignorar_validade_p = 'N' AND b.dt_validade_prescr > dt_validade_p) or (ie_ignorar_validade_p = 'S')) 
		and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
	end if;
	 
	if (coalesce(nr_prescricao_p::text, '') = '') then 
		select  max(a.nr_prescricao) 
		into STRICT	 nr_prescricao_p 
		from   prescr_medica b, 
			 prescr_mat_hor a 
		where  b.nr_prescricao                             = a.nr_prescricao 
		and   b.nr_atendimento                            = nr_atendimento_p 
		and   a.dt_horario                              = dt_horario_p 
		and   a.cd_material                              = cd_item_p 
		and   obter_interv_item_rep(a.nr_prescricao,a.nr_seq_material,ie_tipo_item_p) = coalesce(cd_intervalo_p,'XPTO') 
		and   obter_dose_item_rep(a.nr_prescricao,a.nr_seq_material,ie_tipo_item_p,coalesce(a.ie_dose_especial,'N'))  = coalesce(qt_item_p,1) 
		and   ie_tipo_item_p                             = 'MAT' 
		and   a.ie_agrupador                             = 2 
		and   coalesce(a.ie_situacao,'A')                         = 'A' 
		and   coalesce(b.ie_adep,'S')                           = 'S' 
		and   coalesce(b.dt_suspensao::text, '') = '' 
		and   coalesce(a.dt_suspensao::text, '') = '' 
		and   obter_se_prescr_mat_susp(a.nr_prescricao,a.nr_seq_material)       = 'N' 
		and   ((ie_ignorar_validade_p = 'N' AND b.dt_validade_prescr > dt_validade_p) or (ie_ignorar_validade_p = 'S')) 
		and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
	end if;
	 
	if (coalesce(nr_prescricao_p::text, '') = '') then 
		select  max(a.nr_prescricao) 
		into STRICT	 nr_prescricao_p 
		from   prescr_medica b, 
			 prescr_proc_hor a 
		where  b.nr_prescricao                              = a.nr_prescricao 
		and   b.nr_atendimento                              = nr_atendimento_p 
		and   a.dt_horario                                = dt_horario_p 
		and   a.cd_procedimento                             = cd_item_p 
		and   a.ie_origem_proced                             = ie_origem_proced_p 
		and   coalesce(a.nr_seq_proc_interno,0)                        = nr_seq_proc_interno_p 
		and   obter_interv_item_rep(a.nr_prescricao,a.nr_seq_procedimento,ie_tipo_item_p) = coalesce(cd_intervalo_p,'XPTO') 
		and   obter_dose_item_rep(a.nr_prescricao,a.nr_seq_procedimento,ie_tipo_item_p,'N')  = coalesce(qt_item_p,1) 
		and   ie_tipo_item_p                              in ('P','G','C','I','O') 
		and   coalesce(a.ie_situacao,'A')                           = 'A' 
		and   coalesce(b.ie_adep,'S')                             = 'S' 
		and   coalesce(b.dt_suspensao::text, '') = '' 
		and   coalesce(a.dt_suspensao::text, '') = '' 
		and   obter_se_prescr_proc_susp(a.nr_prescricao,a.nr_seq_procedimento)      = 'N' 
		and   ((ie_ignorar_validade_p = 'N' AND b.dt_validade_prescr > dt_validade_p) or (ie_ignorar_validade_p = 'S')) 
		and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
	end if;
	 
	if (coalesce(nr_prescricao_p::text, '') = '') then 
		select  max(a.nr_prescricao) 
		into STRICT	 nr_prescricao_p 
		from   prescr_medica b, 
			 prescr_recomendacao c, 
			 prescr_rec_hor a 
		where  b.nr_prescricao                              = a.nr_prescricao 
		and   b.nr_prescricao                              = c.nr_prescricao 
		and   c.nr_prescricao                              = a.nr_prescricao 
		and   c.nr_sequencia                               = a.nr_seq_recomendacao 
		and   b.nr_atendimento                              = nr_atendimento_p 
		and   a.dt_horario                                = dt_horario_p 
		and   coalesce(a.cd_recomendacao,c.ds_recomendacao)                  = cd_item_p 
		and   obter_interv_item_rep(a.nr_prescricao,a.nr_seq_recomendacao,ie_tipo_item_p) = coalesce(cd_intervalo_p,'XPTO') 
		and   obter_dose_item_rep(a.nr_prescricao,a.nr_seq_recomendacao,ie_tipo_item_p,'N')  = coalesce(qt_item_p,1) 
		and   ie_tipo_item_p                               = 'R' 
		and   coalesce(a.ie_situacao,'A')                           = 'A' 
		and   coalesce(b.ie_adep,'S')                             = 'S' 
		and   coalesce(b.ie_hemodialise::text, '') = '' 
		and   coalesce(b.dt_suspensao::text, '') = '' 
		and   coalesce(a.dt_suspensao::text, '') = '' 
		and   obter_se_prescr_rec_susp(a.nr_prescricao,a.nr_seq_recomendacao)      = 'N' 
		and   ((ie_ignorar_validade_p = 'N' AND b.dt_validade_prescr > dt_validade_p) or (ie_ignorar_validade_p = 'S')) 
		and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
	end if;
 
	if (coalesce(nr_prescricao_p::text, '') = '') then 
		select  max(a.nr_seq_pe_prescr) 
		into STRICT	 nr_prescricao_p 
		from   pe_prescricao b, 
			 pe_prescr_proc_hor a 
		where  b.nr_sequencia                               = a.nr_seq_pe_prescr 
		and   b.nr_atendimento                              = nr_atendimento_p 
		and   a.dt_horario                                = dt_horario_p 
		and   a.nr_seq_proc                               = cd_item_p 
		and   obter_interv_item_rep(a.nr_seq_pe_prescr,a.nr_seq_pe_proc,ie_tipo_item_p)  = coalesce(cd_intervalo_p,'XPTO') 
		and   ie_tipo_item_p                               = 'E' 
		and   coalesce(a.ie_situacao,'A')                           = 'A' 
		and   coalesce(obter_se_item_adep_sae(a.nr_seq_pe_prescr,a.nr_seq_pe_proc),'S')    = 'S' 
		and   coalesce(a.dt_suspensao::text, '') = '' 
		and   coalesce(b.dt_inativacao::text, '') = '' 
		and   obter_se_pe_prescr_proc_susp(a.nr_seq_pe_prescr,a.nr_seq_pe_proc)     = 'N' 
		and   ((ie_ignorar_validade_p = 'N' AND b.dt_validade_prescr > dt_validade_p) or (ie_ignorar_validade_p = 'S'));
	end if;
	 
	if (coalesce(nr_prescricao_p::text, '') = '') then 
		select  max(b.nr_prescricao) 
		into STRICT	 nr_prescricao_p 
		from   prescr_medica b, 
			 prescr_medica_ordem c, 
			 prescr_ordem_hor a 
		where  b.nr_prescricao                              = c.nr_prescricao 
		and   c.nr_sequencia                               = a.nr_seq_ordem 
		and   b.nr_atendimento                              = nr_atendimento_p 
		and   a.dt_horario                                = dt_horario_p 
		and   ie_tipo_item_p                               = 'B' 
		and   coalesce(b.ie_adep,'S')                             = 'S' 
		and   coalesce(b.dt_suspensao::text, '') = '' 
		and   coalesce(a.dt_suspensao::text, '') = '' 
		and   ((ie_ignorar_validade_p = 'N' AND b.dt_validade_prescr > dt_validade_p) or (ie_ignorar_validade_p = 'S'));
	end if;
return	nr_prescricao_p;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prescr_adm_adep (dt_validade_p timestamp, ie_ignorar_validade_p text, nr_atendimento_p bigint, dt_horario_p timestamp, cd_item_p text, cd_intervalo_p text, ie_origem_proced_p text, nr_seq_proc_interno_p text, ie_tipo_item_p text, qt_item_p bigint) FROM PUBLIC;

