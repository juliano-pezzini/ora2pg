-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ultima_senha_chamada ( nr_chamadas_p bigint, ds_maquina_p text, ie_senha_inutilizadas_p text) RETURNS bigint AS $body$
DECLARE



nr_sequencia_w			bigint;


BEGIN

select	max(b.nr_sequencia)
into STRICT	nr_sequencia_w
from	paciente_senha_fila b
where	((coalesce(b.dt_vinculacao_senha::text, '') = '') or ((b.dt_inicio_atendimento IS NOT NULL AND b.dt_inicio_atendimento::text <> '') and (b.dt_inutilizacao IS NOT NULL AND b.dt_inutilizacao::text <> '') and (coalesce(b.dt_fim_atendimento::text, '') = '')))
and     	(((ie_senha_inutilizadas_p = 'N') and (coalesce(b.dt_inutilizacao::text, '') = '')) or
	(ie_senha_inutilizadas_p = 'S' AND b.dt_inutilizacao IS NOT NULL AND b.dt_inutilizacao::text <> ''))
and	coalesce(b.dt_fim_atendimento::text, '') = ''
and     coalesce(b.dt_utilizacao::text, '') = ''
and	b.ds_maquina_chamada_pesquisa = upper(ds_maquina_p)
and     	(((ie_senha_inutilizadas_p = 'S') and (coalesce(b.qt_chamadas,0) > nr_chamadas_p)) or
	((ie_senha_inutilizadas_p = 'N') and (((coalesce(b.qt_chamadas,0) <= nr_chamadas_p) or (nr_chamadas_p = 0) or (coalesce(dt_inutilizacao::text, '') = '')))))
and	coalesce(b.dt_chamada,b.dt_primeira_chamada) = 		(SELECT	max(coalesce(a.dt_chamada,a.dt_primeira_chamada))
														from    paciente_senha_fila a
														where	  	((coalesce(a.dt_vinculacao_senha::text, '') = '') or ((a.dt_inicio_atendimento IS NOT NULL AND a.dt_inicio_atendimento::text <> '') and (a.dt_inutilizacao IS NOT NULL AND a.dt_inutilizacao::text <> '') and (coalesce(a.dt_fim_atendimento::text, '') = '')))
														and     (((ie_senha_inutilizadas_p = 'N') and (coalesce(b.dt_inutilizacao::text, '') = '')) or
																(ie_senha_inutilizadas_p = 'S' AND b.dt_inutilizacao IS NOT NULL AND b.dt_inutilizacao::text <> ''))
														and	  	coalesce(a.dt_fim_atendimento::text, '') = ''
														and     coalesce(a.dt_utilizacao::text, '') = ''
														and		a.ds_maquina_chamada_pesquisa = upper(ds_maquina_p)
														and     (((ie_senha_inutilizadas_p = 'S') and (coalesce(a.qt_chamadas,0) > nr_chamadas_p)) or
																((ie_senha_inutilizadas_p = 'N') and (((coalesce(a.qt_chamadas,0) <= nr_chamadas_p) or (nr_chamadas_p = 0) or (coalesce(dt_inutilizacao::text, '') = ''))))));


return	nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ultima_senha_chamada ( nr_chamadas_p bigint, ds_maquina_p text, ie_senha_inutilizadas_p text) FROM PUBLIC;

