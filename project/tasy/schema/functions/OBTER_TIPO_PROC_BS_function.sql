-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tipo_proc_bs ( nr_prescricao_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


ds_tipo_w		varchar(20);
nr_sequencia_w	prescr_proc_hor.nr_sequencia%type;
nr_prescricao_w	prescr_medica.nr_prescricao%type;


BEGIN

if (coalesce(nr_prescricao_p::text, '') = '') then

	select	max(nr_seq_procedimento),
			max(nr_prescricao)
	into STRICT	nr_sequencia_w,
			nr_prescricao_w
	from	prescr_proc_hor
	where	nr_sequencia = nr_sequencia_p;

else
	nr_sequencia_w	:= nr_sequencia_p;
	nr_prescricao_w	:= nr_prescricao_p;
end if;

select	max(ie_tipo)
into STRICT	ds_tipo_w
from (	SELECT		'BS' ie_tipo
		from		prescr_procedimento
		where		nr_prescricao	= nr_prescricao_w
		and		nr_sequencia	= nr_sequencia_w
		and		(nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '')
		and		Obter_tipo_proc_interno(nr_seq_proc_interno) = 'BS'
		
union all

		SELECT		'BSHE' ie_tipo
		from		prescr_procedimento
		where		nr_prescricao	= nr_prescricao_w
		and		nr_sequencia	= nr_sequencia_w
		and		(nr_seq_solic_sangue IS NOT NULL AND nr_seq_solic_sangue::text <> '')
		and		coalesce(nr_seq_exame_sangue::text, '') = ''
		and		(nr_seq_derivado IS NOT NULL AND nr_seq_derivado::text <> '')
		
union all

		select		'BSST' ie_tipo
		from		prescr_procedimento
		where		nr_prescricao	= nr_prescricao_w
		and		nr_sequencia	= nr_sequencia_w
		and		(nr_seq_solic_sangue IS NOT NULL AND nr_seq_solic_sangue::text <> '')
		and		(nr_seq_exame_sangue IS NOT NULL AND nr_seq_exame_sangue::text <> '')
		and		coalesce(nr_seq_derivado::text, '') = ''
	) alias9;

return	ds_tipo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tipo_proc_bs ( nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

