-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_retorno_elegibilidade ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_carteirinha_p text, nr_seq_agenda_con_p bigint, nr_seq_agenda_pac_p bigint) RETURNS varchar AS $body$
DECLARE



ds_procedure_w		varchar(255);
ds_retorno_w		varchar(4000);
ds_motivo_glosa_w 	varchar(4000);
ie_verificar_w		varchar(1);

BEGIN
	select 	coalesce(max(IE_CONSISTE_ELEGIBILIDADE),'N')
	into STRICT	ie_verificar_w
	from	parametro_atendimento
	where	cd_estabelecimento = obter_estabelecimento_ativo;

	if (ie_verificar_w = 'S') then
		ds_procedure_w := Obter_Regra_Valid_Usuario_Conv(cd_convenio_p, cd_categoria_p, ie_tipo_atendimento_p, ds_procedure_w);
		if (ds_procedure_w IS NOT NULL AND ds_procedure_w::text <> '') then
			begin
				select 	substr(a.ds_mensagem_erro || chr(13) ||a.ds_mensagem_glosa,1,4000)
				into STRICT	ds_motivo_glosa_w
				from 	tiss_retorno_elegibilidade a
				where	nr_sequencia = 	(SELECT max(x.nr_sequencia)
							from	tiss_retorno_elegibilidade x
							where (x.cd_pessoa_fisica = cd_pessoa_fisica_p   or x.nr_atendimento = nr_atendimento_p
							or	x.nr_seq_agenda_consulta = nr_seq_agenda_con_p or x.nr_seq_agenda = nr_seq_agenda_pac_p)
							and	x.cd_convenio 		= cd_convenio_p
							and 	x.cd_usuario_convenio 	= cd_carteirinha_p)
				and	coalesce(a.ie_resposta_elegibilidade,'N') = 'N'  LIMIT 1;
			exception
			when others then
				ds_retorno_w := '';
			end;
		end if;
	end if;

if (ds_motivo_glosa_w IS NOT NULL AND ds_motivo_glosa_w::text <> '') then
	return	WHEB_MENSAGEM_PCK.get_texto(488731,'DS_MOTIVO_GLOSA='||ds_motivo_glosa_w);
else	return '';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_retorno_elegibilidade ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_carteirinha_p text, nr_seq_agenda_con_p bigint, nr_seq_agenda_pac_p bigint) FROM PUBLIC;

