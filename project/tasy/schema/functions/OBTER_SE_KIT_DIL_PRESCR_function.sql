-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_kit_dil_prescr ( nr_seq_horario_p bigint, ds_horarios_p text, cd_material_p bigint, ds_prescricoes_p text) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(1);
nr_seq_prescricao_w	bigint;
nr_prescricao_w		bigint;
nr_prescricao_ww	bigint;
dt_horario_w		timestamp;
ie_contador_w		bigint	:= 0;
lista_prescr_w		varchar(400);
tam_lista_w		bigint;
ie_pos_virgula_w	smallint;
nr_sequencia_solucao_w	prescr_material.nr_sequencia_solucao%type;



/*
Cursor C01 is
	select	b.nr_sequencia
	from	prescr_mat_hor a,
		prescr_material	b
	where	a.nr_prescricao	=	b.nr_prescricao
	and	a.nr_sequencia		=	nr_seq_horario_p;*/
c01 CURSOR FOR
	SELECT 	b.nr_prescricao,
		b.nr_sequencia,
		a.dt_horario,
		b.nr_sequencia_solucao
	FROM	prescr_mat_hor a,
		prescr_material	b
	WHERE	b.nr_prescricao 	= nr_prescricao_ww
	and	obter_se_contido_char(a.nr_sequencia,ds_horarios_p) = 'S'
	AND	a.nr_prescricao		= b.nr_prescricao
	AND	a.nr_seq_material  	= b.nr_sequencia
	AND	a.dt_horario 		> clock_timestamp() - interval '4 days';


BEGIN
ie_retorno_w := 'N';

lista_prescr_w		:= ds_prescricoes_p ||',';

IF (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') AND (ds_horarios_p IS NOT NULL AND ds_horarios_p::text <> '') THEN

	while(ie_retorno_w = 'N') and
		((lista_prescr_w IS NOT NULL AND lista_prescr_w::text <> '') or (ie_contador_w > 200)) loop
		begin

		tam_lista_w		:= length(lista_prescr_w);
		ie_pos_virgula_w	:= position(',' in lista_prescr_w);

		if (ie_pos_virgula_w <> 0) then
			begin
			nr_prescricao_ww	:= substr(lista_prescr_w,1,(ie_pos_virgula_w - 1));
			lista_prescr_w		:= substr(lista_prescr_w,(ie_pos_virgula_w + 1),tam_lista_w);
			end;
		end if;


		OPEN C01;
		LOOP
		FETCH C01 INTO
			nr_prescricao_w,
			nr_seq_prescricao_w,
			dt_horario_w,
			nr_sequencia_solucao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			BEGIN
			IF (ie_retorno_w = 'N') THEN

				SELECT 	coalesce(MAX('S'),'N')
				INTO STRICT	ie_retorno_w
				FROM	prescr_mat_hor a,
						prescr_material	b
				WHERE	a.nr_prescricao		=	b.nr_prescricao
				AND		a.nr_seq_material  	= 	b.nr_sequencia
				AND		a.nr_prescricao		=	nr_prescricao_w
				AND		a.nr_sequencia		=	nr_seq_horario_p
				AND		a.dt_horario		=	dt_horario_w
				AND		(	(b.nr_sequencia = nr_seq_prescricao_w) OR (b.nr_seq_kit 	=	nr_seq_prescricao_w) OR (b.nr_sequencia_diluicao = nr_seq_prescricao_w) OR (b.nr_sequencia_solucao = nr_sequencia_solucao_w)	);

			END IF;
			END;
		END LOOP;
		CLOSE C01;
		ie_contador_w	:= ie_contador_w + 1;
		end;
	end loop;
END IF;

RETURN	ie_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_kit_dil_prescr ( nr_seq_horario_p bigint, ds_horarios_p text, cd_material_p bigint, ds_prescricoes_p text) FROM PUBLIC;

