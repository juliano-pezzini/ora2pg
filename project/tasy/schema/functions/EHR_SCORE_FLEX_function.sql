-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ehr_score_flex ( nr_seq_elemento_p bigint, cd_pessoa_fisica_p bigint, nr_atendimento_p bigint, ie_inf_entidade_p text, ie_atendimento_p text, ie_profissional_p text default 'N', ie_tipo_score_p text default 'I') RETURNS varchar AS $body$
DECLARE


c02 CURSOR FOR
SELECT coalesce(ds_function,nm_atributo) nm_atributo,
	   ds_label,
	   CASE WHEN ie_quebra_linha='S' THEN ' chr(13) ||chr(10) ||'  ELSE null END  ds_quebra,
	   ds_separador
from   ehr_template_cont_ret
where  nr_seq_elemento = nr_seq_elemento_p
order by nr_seq_apres;

nm_usuario_w  usuario.nm_usuario%type;
ds_comando_w  varchar(2000);
ds_retorno_w  varchar(20000);
ds_retorno_ww varchar(20000);
nm_tabela_w   varchar(50);
ds_propriedade_w EHR_TEMPLATE_CONTEUDO.DS_PROPRIEDADE%type;


v_cursor REFCURSOR;

BEGIN
for atributos in c02 loop
	if (ds_comando_w IS NOT NULL AND ds_comando_w::text <> '') then
		ds_comando_w := ds_comando_w ||' || '||chr(13);
	end if;
	ds_comando_w := ds_comando_w || ' decode('||atributos.nm_atributo||',null,null,'||atributos.ds_quebra||chr(39)||atributos.ds_label||
		chr(39)||' || '||atributos.nm_atributo||' || '||chr(39)||atributos.ds_separador||chr(39)||')';
end loop;

if (ie_tipo_score_p = 'II') then
	nm_tabela_w := ' escala_eif_II ';
else
	nm_tabela_w := ' escala_eif ';
end if;

ds_comando_w := 'select '||ds_comando_w||' ds from '||nm_tabela_w||' where nr_sequencia ';

if (ie_inf_entidade_p = 'U') then
	ds_comando_w := ds_comando_w || ' = (select max(x.nr_sequencia) ';
elsif (ie_inf_entidade_p = 'T') then
	ds_comando_w := ds_comando_w || ' in (select x.nr_sequencia ';
end if;

if (ie_atendimento_p = 'S') then
	ds_comando_w := ds_comando_w || ' from '||nm_tabela_w||' x where nr_atendimento = '||nr_atendimento_p;
elsif (ie_atendimento_p = 'N') then
	ds_comando_w := ds_comando_w || ' from '||nm_tabela_w||' x where nr_atendimento in ( select b.nr_atendimento from atendimento_paciente b where b.cd_pessoa_fisica = '''||cd_pessoa_fisica_p ||''') ';
end if;

nm_usuario_w := WHEB_USUARIO_PCK.get_nm_usuario;
if (ie_profissional_p = 'S') then
	ds_comando_w := ds_comando_w || ' and x.nm_usuario_nrec = '''||nm_usuario_w||''' ';
end if;

select max(upper(DS_PROPRIEDADE))
into STRICT ds_propriedade_w
from EHR_TEMPLATE_CONTEUDO
where nr_sequencia = nr_seq_elemento_p;

if (ds_propriedade_w IS NOT NULL AND ds_propriedade_w::text <> '') then
	if (ie_tipo_score_p = 'II') then
		ds_propriedade_w := substr(ds_propriedade_w, position('@SCORE_FLEX_II(' in ds_propriedade_w) + 15);
	else
		ds_propriedade_w := substr(ds_propriedade_w, position('@SCORE_FLEX(' in ds_propriedade_w) + 12);
	end if;
	ds_propriedade_w := substr(ds_propriedade_w, 1, LENGTH(ds_propriedade_w) - 1);
	if (ds_propriedade_w IS NOT NULL AND ds_propriedade_w::text <> '') then
		ds_comando_w := ds_comando_w || ' and x.nr_seq_escala = '||ds_propriedade_w||' ';
	end if;
end if;

ds_comando_w := ds_comando_w ||' and x.dt_liberacao is not null and x.dt_inativacao is null ) order by dt_avaliacao ';

ds_retorno_ww := '';
open v_cursor for EXECUTE ds_comando_w;
loop
fetch v_cursor into ds_retorno_w;
EXIT WHEN NOT FOUND; /* apply on v_cursor */
	ds_retorno_ww := ds_retorno_ww || ds_retorno_w;
end loop;
close v_cursor;

return ds_retorno_ww;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ehr_score_flex ( nr_seq_elemento_p bigint, cd_pessoa_fisica_p bigint, nr_atendimento_p bigint, ie_inf_entidade_p text, ie_atendimento_p text, ie_profissional_p text default 'N', ie_tipo_score_p text default 'I') FROM PUBLIC;

