-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_mensagem_viagem ( nr_sequencia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
/* MACROS 
Meio_transporte 
Veiculo 
Empresa 
Origem 
Destino 
Saida_prevista 
Chegada_prevista 
Hotel 
Voo 
Assento 
ETicket 
Localizador 
Entrada_hotel 
Saida_hotel 
Endereco_hotel 
Bairro_hotel 
Cidade_hotel 
*/
 
						 
ds_meio_transporte_w	varchar(240);
nr_seq_meio_transp_w	bigint;
nm_veiculo_w		varchar(40);
nm_cnpj_w		varchar(80);
cd_cnpj_w		varchar(14);
ds_local_origem_w		varchar(240);
ds_local_destino_w		varchar(240);
nm_hotel_w		varchar(255);
dt_saida_prev_w		timestamp;
dt_chegada_prev_w	timestamp;
dt_entrada_hotel_w		timestamp;
dt_saida_hotel_w		timestamp;
nr_voo_w			varchar(15);
ds_mensagem_w		varchar(255);
ds_assento_w		varchar(15);
ds_eticket_w		varchar(15);
nr_localizador_w		varchar(15);
ds_observacao_w		varchar(255);
ds_endereco_w		varchar(265);
ds_bairro_w		varchar(255);
ds_cidade_w		varchar(255);
sg_aero_origem_w varchar(15);
sg_aero_destino_w varchar(15);

 

BEGIN 
 
select	substr(obter_desc_meio_transp(a.nr_seq_meio_transp),1,240), 
	substr(obter_nome_veiculo(a.nr_seq_veiculo),1,40), 
	substr(obter_dados_pf_pj(null,a.cd_cnpj,'N'),1,60), 
	substr(obter_desc_loc(a.nr_seq_loc_origem),1,240), 
	substr(obter_desc_loc(a.nr_seq_loc_destino),1,240), 
	a.dt_saida_prev, 
	a.dt_chegada_prev, 
	substr(obter_nome_hotel(c.nr_seq_hotel),1,255), 
	a.nr_voo, 
	a.nr_seq_meio_transp, 
	a.cd_cnpj, 
	c.ds_assento, 
	c.ds_eticket, 
	c.nr_localizador, 
	c.ds_observacao, 
	c.dt_entrada_hotel, 
	c.dt_saida_hotel, 
	substr(obter_dados_hotel(c.nr_seq_hotel, 'E'),1,265), 
	substr(obter_dados_hotel(c.nr_seq_hotel, 'B'),1,255), 
	substr(obter_dados_hotel(c.nr_seq_hotel, 'C'),1,255), 
	substr((select DS_SIGLA from via_aeroporto where nr_sequencia = NR_SEQ_AEROPORTO_ORI),1,15) sg_aero_origem, 
	substr((select DS_SIGLA from via_aeroporto where nr_sequencia = NR_SEQ_AEROPORTO_DES),1,15) sg_aero_destino	 
into STRICT	ds_meio_transporte_w, 
	nm_veiculo_w, 
	nm_cnpj_w, 
	ds_local_origem_w, 
	ds_local_destino_w, 
	dt_saida_prev_w, 
	dt_chegada_prev_w, 
	nm_hotel_w, 
	nr_voo_w, 
	nr_seq_meio_transp_w, 
	cd_cnpj_w, 
	ds_assento_w, 
	ds_eticket_w, 
	nr_localizador_w, 
	ds_observacao_w, 
	dt_entrada_hotel_w, 
	dt_saida_hotel_w, 
	ds_endereco_w, 
	ds_bairro_w, 
	ds_cidade_w, 
	sg_aero_origem_w, 
	sg_aero_destino_w 
from	via_transporte a, 
	via_reserva c, 
	via_reserva_transporte b 
where 	a.nr_sequencia = b.nr_seq_transporte 
and	c.nr_sequencia = b.nr_seq_reserva 
and	b.nr_sequencia = nr_sequencia_p;
 
select	ds_mensagem 
into STRICT	ds_mensagem_w 
from	via_regra_mensagem 
where	coalesce(nr_seq_meio_transp,coalesce(nr_seq_meio_transp_w,0))	=	coalesce(nr_seq_meio_transp_w,0) 
and	coalesce(cd_cnpj,coalesce(cd_cnpj_w,'0'))			=	coalesce(cd_cnpj_w,'0') 
and	coalesce(ie_tipo_mensagem,'') = ie_opcao_p 
and	dt_atualizacao = (	SELECT	max(dt_atualizacao) 
			from	via_regra_mensagem 
			where	coalesce(ie_tipo_mensagem,'') = ie_opcao_p 
			and	coalesce(nr_seq_meio_transp,coalesce(nr_seq_meio_transp_w,0)) = coalesce(nr_seq_meio_transp_w,0) 
			and	coalesce(cd_cnpj,coalesce(cd_cnpj_w,'0')) = coalesce(cd_cnpj_w,'0')	);
 
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Meio_transporte',ds_meio_transporte_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Veiculo',nm_veiculo_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Empresa',nm_cnpj_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Origem',ds_local_origem_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Destino',ds_local_destino_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Saida_prevista',to_char(dt_saida_prev_w,'dd/mm hh24:mi'));
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Chegada_prevista',to_char(dt_chegada_prev_w,'dd/mm hh24:mi'));
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Hotel',nm_hotel_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Voo',nr_voo_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Assento',ds_assento_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@ETicket',ds_eticket_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Localizador',nr_localizador_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Observacao',ds_observacao_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Entrada_hotel', to_char(dt_entrada_hotel_w,'dd/mm hh24:mi'));
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Saida_hotel', to_char(dt_saida_hotel_w,'dd/mm hh24:mi'));
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Endereco_hotel',ds_endereco_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Bairro_hotel',ds_bairro_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Cidade_hotel',ds_cidade_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Aeroporto_origem',sg_aero_origem_w);
ds_mensagem_w	:= replace_macro(ds_mensagem_w,'@Aeroporto_destino',sg_aero_destino_w);
 
return ds_mensagem_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_mensagem_viagem ( nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

