-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_vel_inf_medic ( nr_sequencia_p bigint, nr_prescricao_p bigint, qt_dose_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(4000) := '';
qt_tempo_infusao_w		double precision;
qt_vel_infusao_w		double precision;
qt_tempo_aplicacao_w	double precision;
qt_hora_aplicacao_w		double precision;
ie_tipo_dosagem_w		varchar(255) := '';
cd_material_w			bigint;
ie_via_aplicacao_w		prescr_material.ie_via_aplicacao%type;
ie_se_necessario_w		prescr_material.ie_se_necessario%type;
cd_intervalo_w			prescr_material.cd_intervalo%type;
ie_bomba_infusao_w		prescr_material.ie_bomba_infusao%type;
nr_atendimento_w		prescr_medica.nr_atendimento%type;
cd_setor_atendimento_w	prescr_medica.cd_setor_atendimento%type;
cd_pessoa_fisica_w		prescr_medica.cd_pessoa_fisica%type;
qt_peso_w				prescr_medica.qt_peso%type;
nr_seq_mat_cpoe_w		prescr_material.nr_seq_mat_cpoe%type;


BEGIN

select	max(cd_material),
		max(qt_min_aplicacao),
		max(qt_hora_aplicacao),
		max(ie_via_aplicacao),
		max(ie_se_necessario),
		max(cd_intervalo),
		max(ie_bomba_infusao),
		max(nr_seq_mat_cpoe)
into STRICT	cd_material_w,
		qt_tempo_aplicacao_w,
		qt_hora_aplicacao_w,
		ie_via_aplicacao_w,
		ie_se_necessario_w,
		cd_intervalo_w,
		ie_bomba_infusao_w,
		nr_seq_mat_cpoe_w
from	prescr_material
where	nr_sequencia = nr_sequencia_p
and		nr_prescricao = nr_prescricao_p;

select	max(nr_atendimento),
	max(cd_setor_atendimento),
	max(cd_pessoa_fisica),
	max(qt_peso)
into STRICT	nr_atendimento_w,
	cd_setor_atendimento_w,
	cd_pessoa_fisica_w,
	qt_peso_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select 	max(ie_tipo_dosagem)
into STRICT	ie_tipo_dosagem_w
from 	cpoe_material
where 	nr_sequencia = nr_seq_mat_cpoe_w;

if (coalesce(ie_tipo_dosagem_w, 'X') = 'X') or (pkg_i18n.get_user_locale() <> 'en_AU') then
	if (coalesce(ie_bomba_infusao_w, '0') <> '0') then
		ie_tipo_dosagem_w	:= obter_um_rep_dispositivo(ie_bomba_infusao_w, 1);
	end if;

	if (coalesce(ie_tipo_dosagem_w, 'X') = 'X') then
		ie_tipo_dosagem_w	:= Obter_Padrao_Param_Prescr(	
								nr_atendimento_w,
								cd_material_w,
								ie_via_aplicacao_w,
								cd_setor_atendimento_w,
								cd_pessoa_fisica_w,
								0,
								qt_peso_w,
								ie_se_necessario_w,
								'TD',
								cd_intervalo_w);
	end if;
end if;

qt_tempo_aplicacao_w	:= coalesce(qt_tempo_aplicacao_w, 0) + (coalesce(qt_hora_aplicacao_w, 0) * 60);

if (ie_tipo_dosagem_w IS NOT NULL AND ie_tipo_dosagem_w::text <> '') and (coalesce(qt_tempo_aplicacao_w, 0) > 0) then

	if (upper(ie_tipo_dosagem_w) = 'MLH') then

		qt_tempo_infusao_w	:= dividir(60, qt_tempo_aplicacao_w);
		qt_vel_infusao_w		:= round((qt_dose_p * qt_tempo_infusao_w)::numeric, 2);
		if (qt_vel_infusao_w > 0) then
			ds_retorno_w		:= ' ' || Wheb_mensagem_pck.get_texto(284389) /* ' com ' */ || ' ' || lower(Wheb_mensagem_pck.get_texto(308609)) /*'vel. infusao: '*/ || ': ' || qt_vel_infusao_w || ' ' || Wheb_mensagem_pck.get_texto(309504) /*' ml/h'*/;
		end if;
	elsif (upper(ie_tipo_dosagem_w) = 'GTM') then

		qt_tempo_infusao_w	:= dividir(qt_tempo_aplicacao_w, 60);
		qt_vel_infusao_w		:= round((dividir(dividir(qt_dose_p * 20, qt_tempo_infusao_w), 60))::numeric, 2);
		if (qt_vel_infusao_w	> 0) then
			ds_retorno_w		:= ' ' || Wheb_mensagem_pck.get_texto(284389) /* ' com ' */ || ' ' || lower(Wheb_mensagem_pck.get_texto(308609)) /*'vel. infusao: '*/ || ': ' || qt_vel_infusao_w || ' ' || Wheb_mensagem_pck.get_texto(324183) /*' gotas/min'*/;
		end if;
	elsif (upper(ie_tipo_dosagem_w) = 'MGM') then

		qt_tempo_infusao_w	:= dividir(qt_tempo_aplicacao_w, 60);
		qt_vel_infusao_w		:= round((dividir(dividir(qt_dose_p * 60, qt_tempo_infusao_w), 60))::numeric,2 );
		if (qt_vel_infusao_w	> 0) then
			ds_retorno_w		:= ' ' || Wheb_mensagem_pck.get_texto(284389) /* ' com ' */ || ' ' || lower(Wheb_mensagem_pck.get_texto(308609)) /*'vel. infusao: '*/ || ': ' || qt_vel_infusao_w || ' ' || lower(Wheb_mensagem_pck.get_texto(324184)) /*' microgotas/min'*/;
		end if;
	end if;	

end if;

return	ds_retorno_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_vel_inf_medic ( nr_sequencia_p bigint, nr_prescricao_p bigint, qt_dose_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

