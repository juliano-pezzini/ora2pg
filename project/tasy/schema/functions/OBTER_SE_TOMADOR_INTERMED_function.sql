-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_tomador_intermed (nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


vl_retorno_w			varchar(1) := 'N';
qt_nf_protocolo_w		bigint;
qt_nf_conta_paciente_w		bigint;
qt_convenio_nf_w		bigint;
ie_tipo_convenio_w		convenio.ie_tipo_convenio%type;
cd_cgc_conv_w			convenio.cd_cgc%type;
cd_cgc_w			nota_fiscal.cd_cgc%type;
nr_interno_conta_w		nota_fiscal.nr_interno_conta%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;


BEGIN

select	count(1)
into STRICT	qt_nf_protocolo_w
from	nota_fiscal
where	(nr_seq_protocolo IS NOT NULL AND nr_seq_protocolo::text <> '')
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	nr_sequencia = nr_sequencia_p;

select	count(1)
into STRICT	qt_nf_conta_paciente_w
from	nota_fiscal
where	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	nr_sequencia = nr_sequencia_p;

if (qt_nf_protocolo_w > 0) then
	begin

	select	c.ie_tipo_convenio,
		c.cd_cgc,
		a.cd_cgc
	into STRICT	ie_tipo_convenio_w,
		cd_cgc_conv_w,
		cd_cgc_w
	from	nota_fiscal a,
		protocolo_convenio b,
		convenio c
	where	a.nr_seq_protocolo = b.nr_seq_protocolo
	and	b.cd_convenio = c.cd_convenio
	and	a.nr_sequencia = nr_sequencia_p;

	if (cd_cgc_conv_w = cd_cgc_w) then
		begin

		if (ie_tipo_convenio_w in (1,3,5,10)) then
			begin
			vl_retorno_w := 'S';
			end;
		else
			vl_retorno_w := 'N';
		end if;

		end;
	else
		vl_retorno_w := 'S';
	end if;


	end;
elsif (qt_nf_conta_paciente_w > 0) then
	begin

	select	max(c.cd_cgc),
		max(b.cd_cgc),
		max(c.ie_tipo_convenio),
		max(b.nr_interno_conta),
		max((select count(1) from convenio x where x.cd_cgc = b.cd_cgc))
	into STRICT	cd_cgc_conv_w,
		cd_cgc_w,
		ie_tipo_convenio_w,
		nr_interno_conta_w,
		qt_convenio_nf_w
	from	conta_paciente a,
		nota_fiscal b,
		convenio c
	where	a.nr_interno_conta = b.nr_interno_conta
	and	b.nr_sequencia = nr_sequencia_p
	and	(b.nr_interno_conta IS NOT NULL AND b.nr_interno_conta::text <> '')
	and	a.cd_convenio_parametro = c.cd_convenio;


	if	((ie_tipo_convenio_w in (1,5)) and (qt_convenio_nf_w > 0)) then
		begin

		select	max(ie_tipo_convenio)
		into STRICT	ie_tipo_convenio_w
		from	convenio
		where	cd_cgc = cd_cgc_w;

		if (ie_tipo_convenio_w in (1,3,5,10)) then
			begin
			vl_retorno_w := 'S';
			end;
		else
			begin

			select  max(a.cd_pessoa_fisica)
			into STRICT	cd_pessoa_fisica_w
			from	conta_paciente c,
				atendimento_paciente a
			where	nr_interno_conta = nr_interno_conta_w
			and	c.nr_atendimento = a.nr_atendimento;

			if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
				vl_retorno_w := 'C';
			else
				vl_retorno_w := 'N';
			end if;

			end;
		end if;

		end;
	else
		begin

		if (ie_tipo_convenio_w in (1,3,5,10)) then
			begin
			vl_retorno_w := 'S';
			end;
		else
			vl_retorno_w := 'N';
		end if;

		end;
	end if;

	end;
else
	vl_retorno_w := 'S';
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_tomador_intermed (nr_sequencia_p bigint) FROM PUBLIC;

