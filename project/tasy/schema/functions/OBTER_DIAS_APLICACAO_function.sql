-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dias_aplicacao (CD_MATERIAL_P bigint, QT_DOSE_PRESCRICAO_P bigint,NR_SEQ_PACIENTE_P bigint) RETURNS varchar AS $body$
DECLARE


W_DS_DIA_CICLO varchar(50);
W_DS_DIAS_APLICACAO varchar(50) := NULL;

C01 CURSOR FOR
SELECT DISTINCT
        PA.DS_DIA_CICLO
FROM    PACIENTE_SETOR S
        LEFT JOIN PACIENTE_ATENDIMENTO PA
        ON PA.NR_SEQ_PACIENTE = S.NR_SEQ_PACIENTE
        LEFT JOIN PACIENTE_ATEND_MEDIC PAM
        ON PA.NR_SEQ_ATENDIMENTO = PAM.NR_SEQ_ATENDIMENTO
        INNER JOIN PACIENTE_PROTOCOLO_MEDIC PPM
        ON S.NR_SEQ_PACIENTE = PPM.NR_SEQ_PACIENTE
        AND PAM.CD_MATERIAL = PPM.CD_MATERIAL
        LEFT JOIN INTERVALO_PRESCRICAO IP
        ON PPM.CD_INTERVALO = IP.CD_INTERVALO
        LEFT JOIN DEFINIDOR_ONCOLOCIA DEO
        ON S.NR_SEQ_DEFINIDOR = DEO.NR_SEQUENCIA
WHERE
PAM.CD_MATERIAL = CD_MATERIAL_P
AND PAM.QT_DOSE_PRESCRICAO = QT_DOSE_PRESCRICAO_P
AND PA.NR_SEQ_PACIENTE = NR_SEQ_PACIENTE_P
ORDER BY (SUBSTR(DS_DIA_CICLO,2,4))::numeric;


BEGIN
OPEN C01;
    LOOP
    FETCH C01 INTO
  W_DS_DIA_CICLO;
EXIT WHEN NOT FOUND; /* apply on C01 */

BEGIN
    IF coalesce(W_DS_DIAS_APLICACAO::text, '') = '' THEN
    W_DS_DIAS_APLICACAO := W_DS_DIA_CICLO;
    ELSE
    W_DS_DIAS_APLICACAO := W_DS_DIAS_APLICACAO ||','|| W_DS_DIA_CICLO;
    END IF;
END;
 END LOOP;
 CLOSE C01;
 W_DS_DIAS_APLICACAO	:= trim(both REPLACE( W_DS_DIAS_APLICACAO,'D',' D'));

  RETURN W_DS_DIAS_APLICACAO;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dias_aplicacao (CD_MATERIAL_P bigint, QT_DOSE_PRESCRICAO_P bigint,NR_SEQ_PACIENTE_P bigint) FROM PUBLIC;

