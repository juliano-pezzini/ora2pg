-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cp_generate_goals (nr_seq_prescr_p bigint, cabecalho text, si_clinical_goal_p text, si_education_goal_p text) RETURNS text AS $body$
DECLARE


ds_texto_geral_w                                    text;
newline_w			varchar(10) := chr(13) || chr(10);
ds_data_ini_fim_w		                varchar(4000);
space_n1_w			varchar(100) := '      ';
space_n2_w			varchar(100) := '            ';
space_n3_w			varchar(100) := '                  ';
ds_fonte_w			varchar(100);
ds_tam_fonte_w			varchar(100);
nr_tam_fonte_w			integer;
ds_cabecalho_w			varchar(32000);
ds_rodape_w			varchar(255);
si_rule_assessment_w		varchar(1) := 'N';
si_rule_care_plan_w		varchar(1) := 'N';
si_rule_patient_prog_w		varchar(1) := 'N';
si_rule_diagnosis_w		varchar(1) := 'N';
si_rule_clinical_goal_w		varchar(1) := 'N';
si_rule_education_goal_w		varchar(1) := 'N';
flag_obs   pat_cp_ind_measure_eg_item.ds_note%type;

c_meta_educacional CURSOR FOR
SELECT distinct pg.nr_sequencia, c.DS_DISPLAY_NAME, pg.DT_START, pg.DT_END, pg.DT_RELEASE
from    cp_goal c,
        patient_cp_goal pg,
        patient_cp_indicator pi,
        PE_PRESCR_INDICATOR a
where a.NR_SEQ_PAT_CP_INDICATOR = pi.nr_sequencia
and   pi.NR_SEQ_PAT_CP_GOAL = pg.nr_sequencia
and   pg.NR_SEQ_CP_GOAL = c.nr_sequencia
and   c.ie_type_goal = 'E'
and   pg.SI_SELECTED = 'Y'
and   a.nr_seq_prescr = nr_seq_prescr_p
order by c.DS_DISPLAY_NAME asc;

c_meta_cuidado CURSOR FOR
SELECT distinct pg.nr_sequencia nr_sequencia_pg, c.NR_SEQUENCIA, c.DS_DISPLAY_NAME, pg.DT_START, pg.DT_END, pg.DT_RELEASE
from    cp_goal c,
        patient_cp_goal pg,
        patient_cp_indicator pi,
        PE_PRESCR_INDICATOR a
where a.NR_SEQ_PAT_CP_INDICATOR = pi.nr_sequencia
and   pi.NR_SEQ_PAT_CP_GOAL = pg.nr_sequencia
and   pg.NR_SEQ_CP_GOAL = c.nr_sequencia
and   c.ie_type_goal = 'C'
and   pg.SI_SELECTED = 'Y'
and   a.nr_seq_prescr = nr_seq_prescr_p
order by c.DS_DISPLAY_NAME asc;


c_meta_cuidado_indicador CURSOR FOR
SELECT 	e.DS_DISPLAY_NAME, 
		c.NR_SEQUENCIA PAI, 
		d.*,
		obter_dados_mensuracao_atual(d.nr_seq_cp_indicator, nr_seq_prescr_p, 'DSM') ds_cp_measure
from 
            patient_care_plan a
            , patient_cp_goal b
            , cp_goal c
            , patient_cp_indicator d
            , cp_indicator e
where a.NR_SEQ_PRESCR = nr_seq_prescr_p
  and a.NR_SEQUENCIA = b.NR_SEQ_PAT_CARE_PLAN
  and b.NR_SEQ_CP_GOAL = c.NR_SEQUENCIA
  and d.NR_SEQ_PAT_CP_GOAL = b.NR_SEQUENCIA
  and d.NR_SEQ_CP_INDICATOR = e.NR_SEQUENCIA
  and c.IE_TYPE_GOAL = 'C'
  and b.SI_SELECTED = 'Y'
  order by e.DS_DISPLAY_NAME asc;

  r_c_measure_eg RECORD;

BEGIN
        if (coalesce(si_clinical_goal_p::text, '') = '' or length(si_clinical_goal_p) = 0
            or coalesce(si_education_goal_p::text, '') = '' or length(si_education_goal_p) = 0) then
            SELECT * FROM get_cp_clinical_note_rule(obter_usuario_ativo, obter_perfil_ativo, obter_estabelecimento_ativo, si_rule_assessment_w, si_rule_diagnosis_w, si_rule_care_plan_w, si_rule_patient_prog_w, si_rule_clinical_goal_w, si_rule_education_goal_w) INTO STRICT si_rule_assessment_w, si_rule_diagnosis_w, si_rule_care_plan_w, si_rule_patient_prog_w, si_rule_clinical_goal_w, si_rule_education_goal_w;
        else
            si_rule_clinical_goal_w := si_clinical_goal_p;
            si_rule_education_goal_w := si_education_goal_p;
        end if;
        --======================META CUIDADO
        if (si_rule_clinical_goal_w = 'Y') then
            ds_texto_geral_w := ds_texto_geral_w || '\b ' || substr(obter_desc_expressao(948691, null),1,250) || '\b0 ' || newline_w;
            for linha in c_meta_cuidado loop
                select	substr(space_n2_w || obter_desc_expressao(291978, null) || ': ' || /*Inicio: */
                    pkg_date_utils.start_of(linha.dt_start, 'DD', null) ||
                    newline_w || space_n2_w || obter_desc_expressao(290101, null) || ': ' || /*Fim*/
                    pkg_date_utils.start_of(linha.dt_end, 'DD'),1,4000)
                into STRICT	ds_data_ini_fim_w
;	

                ds_texto_geral_w := ds_texto_geral_w || space_n1_w || '\u9632   ' || linha.DS_DISPLAY_NAME || newline_w || ds_data_ini_fim_w || newline_w;
                --==================INDICADOR
                for indicador in c_meta_cuidado_indicador loop
                    if (indicador.PAI = linha.NR_SEQUENCIA) then
                        ds_texto_geral_w := ds_texto_geral_w
                            || space_n2_w || obter_desc_expressao(291850,null) || ': ' || indicador.ds_display_name || newline_w /*Indicador: */
                            || space_n3_w || obter_desc_expressao(951411, null) || ': ' || indicador.ds_cp_measure || newline_w; /*Mensuracao atual: */
                    end if;
                end loop;
            end loop;
        end if;

        --======================META EDUCACIONAL
        if (si_rule_education_goal_w = 'Y') then
            ds_texto_geral_w := ds_texto_geral_w || newline_w || '\b ' || substr(obter_desc_expressao(947748, null),1,250) || '\b0 ' || newline_w;
            for linha in c_meta_educacional loop
                ds_texto_geral_w := ds_texto_geral_w || space_n1_w || '\u9632   ' || linha.DS_DISPLAY_NAME || newline_w;

              for  r_c_measure_eg in (
                                        select f.DS_DISPLAY_NAME DS_INDICATOR, a.DS_NOTE DS_DESC, d.nr_sequencia SEQ_GOAL, to_char(b.DT_EVALUATION, 'dd/mm/yyyy') DT_EVALUATION, c.DS_DISPLAY_NAME DS_MEASURE
                                        
                                        from    pat_cp_ind_measure_eg_item a,
                                                pat_cp_ind_measure_eg b,
                                                cp_measure c,
                                                patient_cp_goal pgoal,
                                                cp_goal d,
                                                patient_cp_indicator e,
                                                cp_indicator f
                                        where   a.NR_SEQ_IND_MEASURE_EG = b.NR_SEQUENCIA
                                        and     b.nr_seq_pat_cp_goal = linha.nr_sequencia
                                        and     (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
                                        and     c.nr_sequencia = a.NR_SEQ_MEASURE
                                        and     b.NR_SEQ_PAT_CP_GOAL = pgoal.NR_SEQUENCIA
                                        and     pgoal.NR_SEQ_CP_GOAL = d.nr_sequencia
                                        and     a.NR_SEQ_PAT_CP_INDIC = e.nr_sequencia
                                        and     e.NR_SEQ_CP_INDICATOR = f.nr_sequencia
                                        and     b.nr_sequencia = (select    max(x.nr_sequencia)
                                                                from        pat_cp_ind_measure_eg x
                                                                where       x.nr_seq_pat_cp_goal = b.nr_seq_pat_cp_goal
                                                                and         (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> ''))
                                        order by f.DS_DISPLAY_NAME
              ) loop
              
              select CASE WHEN coalesce(r_c_measure_eg.DS_DESC::text, '') = '' THEN  null  ELSE ( space_n3_w ||   obter_desc_expressao(341947, null)  || r_c_measure_eg.DS_DESC || newline_w) END  
              into STRICT flag_obs
;

                    ds_texto_geral_w := ds_texto_geral_w || space_n2_w || ' \b ' || r_c_measure_eg.DS_INDICATOR || ' \b0 ' || newline_w;
                    ds_texto_geral_w := ds_texto_geral_w || space_n3_w || obter_desc_expressao(950263, null) || ': ' || r_c_measure_eg.DS_MEASURE || newline_w;
                    ds_texto_geral_w := ds_texto_geral_w || space_n3_w || obter_desc_expressao(951409, null) || ': ' || r_c_measure_eg.DT_EVALUATION || newline_w;
                    ds_texto_geral_w := ds_texto_geral_w || flag_obs;

              end loop;
            end loop;
        end if;

	if (ds_texto_geral_w IS NOT NULL AND ds_texto_geral_w::text <> '') then
        ds_texto_geral_w := replace(ds_texto_geral_w, chr(13) || chr(10), ' \par ');	

        if ( cabecalho = 'S') then
            ds_fonte_w := obter_param_usuario(281, 5, OBTER_PERFIL_ATIVO, OBTER_USUARIO_ATIVO, OBTER_PERFIL_ATIVO, ds_fonte_w);
            ds_tam_fonte_w := obter_param_usuario(281, 6, OBTER_PERFIL_ATIVO, OBTER_USUARIO_ATIVO, OBTER_PERFIL_ATIVO, ds_tam_fonte_w);
            nr_tam_fonte_w := somente_numero(ds_tam_fonte_w) * 2;

            ds_cabecalho_w := '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 '
                      || ds_fonte_w
                      || ';}}'
                      || '{\*\generator msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs'
                      || nr_tam_fonte_w
                      || ' ';
            ds_rodape_w := '}';

            ds_texto_geral_w := ds_cabecalho_w || ds_texto_geral_w || ds_rodape_w;	
        end if;
				
    end if;
return ds_texto_geral_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cp_generate_goals (nr_seq_prescr_p bigint, cabecalho text, si_clinical_goal_p text, si_education_goal_p text) FROM PUBLIC;

