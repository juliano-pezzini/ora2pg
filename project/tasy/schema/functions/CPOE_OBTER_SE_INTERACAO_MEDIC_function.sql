-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_se_interacao_medic ( cd_material_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


qt_count_w	bigint;
ds_retorno_w	varchar(1) := 'N';


BEGIN

if ((cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '')) then

	select	count(1)
	into STRICT	qt_count_w
	from(	SELECT	b.ie_severidade ie_severidade, a.nr_atendimento nr_atendimento
			from	cpoe_material_vig_v a,
				material_interacao_medic b 
			where	((b.cd_material = cd_material_p AND a.cd_material = b.cd_material_interacao) or (b.cd_material_interacao = cd_material_p AND a.cd_material = b.cd_material)) 
			and	((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(a.nr_atendimento::text, '') = '')) 
			and	((cpoe_reg_valido_ativacao(CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ,a.dt_inicio,clock_timestamp()) = 'S') or (a.ie_retrogrado = 'S' and coalesce(a.dt_liberacao::text, '') = '')) 
			and	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.nm_usuario = wheb_usuario_pck.get_nm_usuario)) and a.nr_sequencia <> nr_sequencia_p 
			and	a.ie_tipo_item in ('MAT','MCOMP1','MCOMP2','MCOMP3', 'PMAT1', 'PMAT2', 'PMAT3', 'PMAT4', 'PMAT5', 'GMAT1', 'GMAT2', 'GMAT3','E','S','L') 
			and	coalesce(dt_fim, dt_inicio + 1) > (clock_timestamp() - (select coalesce(nr_dias_interacao,0) from parametro_medico where cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento))
      and coalesce(b.ie_situacao, 'A') = 'A'
			
union
 
			SELECT	b.ie_severidade ie_severidade, a.nr_atendimento nr_atendimento
			from	cpoe_material_vig_v a,material m,material mi,material_interacao_medic b 
			where	m.cd_material = a.cd_material 
			and		((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(a.nr_atendimento::text, '') = '')) 
			and		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.nm_usuario = wheb_usuario_pck.get_nm_usuario)) and a.nr_sequencia <> nr_sequencia_p 
			and 	a.ie_tipo_item in ('MAT','MCOMP1','MCOMP2','MCOMP3', 'PMAT1', 'PMAT2', 'PMAT3', 'PMAT4', 'PMAT5', 'GMAT1', 'GMAT2', 'GMAT3','E','S','L') 
			and		mi.cd_material = cd_material_p 
      and   coalesce(b.ie_situacao, 'A') = 'A'
			and		((b.nr_seq_ficha = mi.nr_seq_ficha_tecnica AND m.nr_seq_ficha_tecnica = b.nr_seq_ficha_interacao) or (b.nr_seq_ficha = m.nr_seq_ficha_tecnica AND mi.nr_seq_ficha_tecnica = b.nr_seq_ficha_interacao)))
	where	cpoe_consiste_severidade_apres(wheb_usuario_pck.get_cd_perfil, nr_atendimento, ie_severidade) = 'S';
	
	if (qt_count_w > 0) then
		ds_retorno_w := 'S';
	end if;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_se_interacao_medic ( cd_material_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text, nr_sequencia_p bigint) FROM PUBLIC;

