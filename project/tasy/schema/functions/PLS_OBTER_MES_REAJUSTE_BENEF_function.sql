-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_mes_reajuste_benef ( nr_seq_segurado_p bigint, ie_formato_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(15)	:= null;
dt_retorno_w			timestamp 		:= null;
ie_tipo_contrato_w		varchar(1);
ie_reajuste_w			varchar(1);
nr_seq_contrato_w		bigint;
nr_mes_reajuste_w		pls_contrato.nr_mes_reajuste%type;
ie_retorno_w			varchar(1);

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Obter o mês de reajuste do beneficiário, contrato ou grupo de contrato,
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
BEGIN

ie_retorno_w := 'S';

if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') then
	select	CASE WHEN coalesce(nr_seq_contrato::text, '') = '' THEN  'I'  ELSE 'C' END
	into STRICT	ie_tipo_contrato_w
	from	pls_segurado
	where	nr_sequencia = nr_seq_segurado_p;

	if (ie_tipo_contrato_w = 'C') then
		select	coalesce(a.ie_reajuste,'C'),
			a.nr_sequencia,
			a.nr_mes_reajuste
		into STRICT	ie_reajuste_w,
			nr_seq_contrato_w,
			nr_mes_reajuste_w
		from	pls_segurado	b,
			pls_contrato	a
		where	a.nr_sequencia = b.nr_seq_contrato
		and	b.nr_sequencia = nr_seq_segurado_p;

		if (ie_reajuste_w = 'C') then
			if (nr_mes_reajuste_w IS NOT NULL AND nr_mes_reajuste_w::text <> '') then
				if (ie_formato_p = 'E') then
					select	obter_valor_dominio(8483, nr_mes_reajuste_w)
					into STRICT	ds_retorno_w
					;
				elsif (ie_formato_p = 'MM') then
					ds_retorno_w	:= nr_mes_reajuste_w;
				end if;

				ie_retorno_w	:= 'N';
			else
				begin
				select	max(c.dt_reajuste)
				into STRICT	dt_retorno_w
				from	pls_contrato		a,
					pls_contrato_grupo	b,
					pls_grupo_contrato	c
				where	a.nr_sequencia 		= b.nr_seq_contrato
				and	b.nr_seq_grupo		= c.nr_sequencia
				and	b.ie_reajuste_grupo	= 'S'
				and	a.nr_sequencia 		= nr_seq_contrato_w;
				exception
				when others then
					dt_retorno_w := null;
				end;

				if (coalesce(dt_retorno_w::text, '') = '') then
					begin
					select	max(a.dt_reajuste)
					into STRICT	dt_retorno_w
					from	pls_contrato		a
					where	a.nr_sequencia 		= nr_seq_contrato_w;
					exception
					when others then
						dt_retorno_w := null;
					end;

					if (coalesce(dt_retorno_w::text, '') = '') then
						begin
						select	add_months(a.dt_contrato,coalesce(qt_intervalo,12))
						into STRICT	dt_retorno_w
						from	pls_contrato		a
						where	a.nr_sequencia 		= nr_seq_contrato_w;
						exception
						when others then
							dt_retorno_w := null;
						end;
					end if;
				end if;
			end if;
		elsif (ie_reajuste_w = 'A') then
			select	coalesce(dt_reajuste,dt_contratacao)
			into STRICT	dt_retorno_w
			from	pls_segurado
			where	nr_sequencia = nr_seq_segurado_p;
		end if;
	elsif (ie_tipo_contrato_w = 'I') then
		select	max(c.dt_reajuste)
		into STRICT	dt_retorno_w
		from	pls_regra_grupo_inter	c,
			pls_segurado		b,
			pls_intercambio		a
		where	a.nr_sequencia 			= b.nr_seq_intercambio
		and	a.nr_seq_grupo_intercambio	= c.nr_sequencia
		and	b.nr_sequencia 			= nr_seq_segurado_p;

		if (coalesce(dt_retorno_w::text, '') = '') then
			select	max(a.dt_inclusao)
			into STRICT	dt_retorno_w
			from	pls_segurado		b,
				pls_intercambio		a
			where	a.nr_sequencia = b.nr_seq_intercambio
			and	b.nr_sequencia = nr_seq_segurado_p;
		end if;
	end if;

	if	(dt_retorno_w IS NOT NULL AND dt_retorno_w::text <> '' AND ie_retorno_w = 'S') then
		if (ie_formato_p = 'E') then
			ds_retorno_w := initcap(to_char(dt_retorno_w,'month'));
		elsif (ie_formato_p = 'MM') then
			ds_retorno_w := to_char(dt_retorno_w,'MM');
		end if;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_mes_reajuste_benef ( nr_seq_segurado_p bigint, ie_formato_p text) FROM PUBLIC;

