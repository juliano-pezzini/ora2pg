-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_dose_maxima ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_unidade_medida_dose_p text, qt_dose_p bigint, ie_via_aplicacao_p text, cd_setor_atendimento_p bigint, nr_seq_agrupamento_p bigint, cd_prescritor_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint ) RETURNS bigint AS $body$
DECLARE


cd_unid_med_limite_w		unidade_medida.cd_unidade_medida%type;

qt_limite_pessoa_w			material_prescr.qt_limite_pessoa%type;
ie_dose_limite_w			material_prescr.ie_dose_limite%type;

qt_dose_limite_w			double precision;
ie_regra_w					char(1);

c01 CURSOR FOR
	SELECT	a.qt_limite_pessoa,
			coalesce(a.ie_dose_limite,'DOSE'),
			a.cd_unid_med_limite
	from	material_prescr a
	where	Obter_se_setor_regra_prescr(a.nr_sequencia, cd_setor_atendimento_p) = 'S'
	and		((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
	and		((coalesce(a.cd_setor_atendimento::text, '') = '') or (a.cd_setor_atendimento = cd_setor_atendimento_p))
	and		((coalesce(a.nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento = nr_seq_agrupamento_p))
	and		((coalesce(a.ie_via_aplicacao::text, '') = '') or (a.ie_via_aplicacao = ie_via_aplicacao_p))
	and		((coalesce(a.cd_especialidade::text, '') = '') or (obter_se_especialidade_medico(cd_prescritor_p, a.cd_especialidade) = 'S'))
	and		qt_idade_dia_p between coalesce(a.qt_idade_min_dia,0) and coalesce(a.qt_idade_max_dia,55000)
	and		qt_idade_mes_p between coalesce(a.qt_idade_min_mes,0) and coalesce(a.qt_idade_max_mes,55000)
	and		qt_idade_ano_p between coalesce(a.qt_idade_min,0) and coalesce(a.qt_idade_max,999)
	and		qt_peso_p between coalesce(a.qt_peso_min,0) and coalesce(a.qt_peso_max,999)
	and		coalesce(a.ie_obedecer_limite,'N') = 'S'
	and		(a.qt_limite_pessoa IS NOT NULL AND a.qt_limite_pessoa::text <> '')
	and		a.ie_tipo = '2'
	and		a.cd_material = cd_material_p
	order by a.nr_sequencia;


BEGIN

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
	open c01;
	loop
	fetch c01 into
		qt_limite_pessoa_w,
		ie_dose_limite_w,
		cd_unid_med_limite_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	end loop;
	close c01;

	if (coalesce(ie_dose_limite_w::text, '') = '') then
		select	max(cd_unid_med_limite),
				coalesce(max(qt_limite_pessoa),0),
				coalesce(max(ie_dose_limite),'DOSE')
		into STRICT	cd_unid_med_limite_w,
				qt_limite_pessoa_w,
				ie_dose_limite_w
		from	material
		where	cd_material	= cd_material_p;
	end if;

	if (ie_dose_limite_w = 'DOSE') then
		if (cd_unidade_medida_dose_p = cd_unid_med_limite_w) and (qt_dose_p > qt_limite_pessoa_w) then
			return qt_limite_pessoa_w;
		else
			qt_dose_limite_w	:= (dividir(qt_limite_pessoa_w * 1000, obter_conversao_unid_med( cd_material_p, cd_unid_med_limite_w ))/ 1000);

			if (qt_dose_limite_w > 0) and
				(qt_dose_limite_w < (dividir(qt_dose_p * 1000, obter_conversao_unid_med( cd_material_p, cd_unidade_medida_dose_p ))/ 1000)) then
				return qt_dose_limite_w;
			end if;
		end if;
	end if;
end if;

return 0;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_dose_maxima ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_unidade_medida_dose_p text, qt_dose_p bigint, ie_via_aplicacao_p text, cd_setor_atendimento_p bigint, nr_seq_agrupamento_p bigint, cd_prescritor_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint ) FROM PUBLIC;

