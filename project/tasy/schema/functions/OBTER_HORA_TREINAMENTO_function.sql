-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_hora_treinamento ( nr_seq_agenda_p bigint, dt_parametro_p timestamp) RETURNS varchar AS $body$
DECLARE


hr_retorno_w		varchar(20);
nr_canc_aula_w		integer;
ie_dia_semana_w		varchar(1);


BEGIN

ie_dia_semana_w := to_char(pkg_date_utils.get_WeekDay(dt_parametro_p));

select	count(*)
into STRICT	nr_canc_aula_w
from	tre_alteracao_dia_aula a
where	a.nr_seq_agenda = nr_seq_agenda_p
and		a.dt_alteracao = to_date(to_char(dt_parametro_p,'dd/mm/yyyy'));

select	to_char(max(hr_inicial),'hh24:mi:ss')
into STRICT 	hr_retorno_w
from	tre_agenda_turno x,
		tre_agenda k
where	k.nr_sequencia = x.nr_seq_agenda_tre
and		k.nr_sequencia = nr_seq_agenda_p
and		((ie_dia_semana_w = ie_dia_semana)
	or 	(ie_dia_semana = 9 AND ie_dia_semana_w between 2 and 7))
and		((dt_parametro_p between x.dt_inicio_vigencia and fim_dia(x.dt_fim_vigencia)) or ((coalesce(x.dt_inicio_vigencia::text, '') = '') or (coalesce(x.dt_fim_vigencia::text, '') = '')));

if (nr_canc_aula_w > 0) and (coalesce(hr_retorno_w::text, '') = '') then
	select 	to_char(max(hr_inicial), 'hh24:mi:ss')
	into STRICT 	hr_retorno_w
	from	tre_alteracao_dia_aula a
	where	a.nr_seq_agenda = nr_seq_agenda_p
	and		a.dt_alteracao = to_date(to_char(dt_parametro_p,'dd/mm/yyyy'));
end if;

return	hr_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_hora_treinamento ( nr_seq_agenda_p bigint, dt_parametro_p timestamp) FROM PUBLIC;

