-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_estatistica_mat_agenda ( cd_medico_p text, nr_seq_proc_interno_p bigint, cd_material_p bigint, nr_atendimento_p bigint, qt_dias_p bigint, nr_seq_agenda_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


qt_agenda_med_proc_w		bigint; -- Quantidade total de agendas por médico e procedimento
qt_agenda_med_proc_mat_w	bigint; -- Quantidade total de agendas por médico, procedimento e material autorizado
qt_material_autorizado_w	bigint; -- Quantidade total de material autorizado por médico, procedimento e material
qt_material_atend_w		bigint; -- Total do material do atendimento
/*
ie_opcao_p
TAMP 	- Total de agendas conforme médico e procedimento
TAMPM	- Total de agendas conforme médico, procedimento e material
TMAMPM	- Total de material autorizado conforme médico, procedimento e material
TMA	- Total do material do atendimento
*/
BEGIN

if (ie_opcao_p = 'TAMP') then --  Total de agendas conforme médico e procedimento
	select	count(*)
	into STRICT	qt_agenda_med_proc_w
	from	agenda_paciente
	where	cd_medico 		= cd_medico_p
	and	nr_seq_proc_interno 	= coalesce(nr_seq_proc_interno_p,0)
	and	ie_status_agenda 	<> 'C'
	and	trunc(dt_agenda) 	>= (trunc(dt_agenda)- qt_dias_p)
	and	nr_sequencia 		<> nr_seq_agenda_p;
	return	qt_agenda_med_proc_w;
end if;

if (ie_opcao_p = 'TMAMPM') then --Total de material autorizado conforme médico, procedimento e material
	select	coalesce(sum(b.qt_autorizada),0)
	into STRICT	qt_material_autorizado_w
	from	autorizacao_convenio a,
		material_autorizado b,
		agenda_paciente c
	where	b.nr_sequencia_autor 	= a.nr_sequencia
	and	c.nr_sequencia 		= a.nr_seq_agenda
	and	c.nr_seq_proc_interno 	= coalesce(nr_seq_proc_interno_p,0)
	and	c.cd_medico		= cd_medico_p
	and	b.cd_material 		= coalesce(cd_material_p,0)
	and	b.qt_autorizada 	> 0
	and 	trunc(c.dt_agenda) 	>= (trunc(c.dt_agenda)- qt_dias_p)
	and	c.ie_status_agenda 	<> 'C'
	and	c.nr_sequencia		<> nr_seq_agenda_p;
	return	qt_material_autorizado_w;
end if;

if (ie_opcao_p = 'TAMPM') then --Total de agendas conforme médico, procedimento e material
	select	count(distinct c.nr_sequencia)
	into STRICT	qt_agenda_med_proc_mat_w
	from	autorizacao_convenio a,
		material_autorizado b,
		agenda_paciente c
	where	b.nr_sequencia_autor 	= a.nr_sequencia
	and	c.nr_sequencia 		= a.nr_seq_agenda
	and	c.nr_seq_proc_interno 	= coalesce(nr_seq_proc_interno_p,0)
	and	c.cd_medico		= cd_medico_p
	and	b.cd_material 		= coalesce(cd_material_p,0)
	and	b.qt_autorizada 	> 0
	and 	trunc(c.dt_agenda) 	>= (trunc(c.dt_agenda)- qt_dias_p)
	and	c.ie_status_agenda 	<> 'C'
	and	c.nr_sequencia		<> nr_seq_agenda_p;
	return	qt_agenda_med_proc_mat_w;
end if;

if (ie_opcao_p = 'TMA') then --TMA	- Total do material do atendimento
	select	coalesce(sum(qt_material),0)
	into STRICT	qt_material_atend_w
	from	material_atend_paciente
	where  	nr_atendimento 	= coalesce(nr_atendimento_p,0)
	and	cd_material	= coalesce(cd_material_p,0);
	return	qt_material_atend_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_estatistica_mat_agenda ( cd_medico_p text, nr_seq_proc_interno_p bigint, cd_material_p bigint, nr_atendimento_p bigint, qt_dias_p bigint, nr_seq_agenda_p bigint, ie_opcao_p text) FROM PUBLIC;

