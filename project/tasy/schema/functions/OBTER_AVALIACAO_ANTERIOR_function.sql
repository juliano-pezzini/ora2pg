-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_avaliacao_anterior ( cd_perfil_p bigint, nr_atendimento_p bigint, nm_usuario_p text) RETURNS bigint AS $body$
DECLARE


  type_of_care_user_w       varchar(1);
  type_of_care_prescricao_w varchar(1);
  type_evol_prescricao_w    varchar(1);
  nr_seq_prescr_w           bigint;
  ie_tipo_evolucao_w        bigint;
  C01 CURSOR FOR
    SELECT b.nr_sequencia,
      c.ie_tipo_evolucao
    FROM pe_prescricao b,
      usuario c
    WHERE b.nr_atendimento = nr_atendimento_p
    AND c.nm_usuario       = b.nm_usuario
    AND (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
    AND coalesce(b.dt_suspensao::text, '') = '';


BEGIN
  SELECT MAX(ie_tipo_evolucao)
  INTO STRICT ie_tipo_evolucao_w
  FROM usuario
  WHERE nm_usuario = nm_usuario_p;

  SELECT MAX(a.ie_nivel_atencao)
  INTO STRICT type_of_care_user_w
  FROM perfil a
  WHERE a.cd_perfil = cd_perfil_p;

  SELECT MAX(b.ie_nivel_atencao)
  INTO STRICT type_of_care_prescricao_w
  FROM pe_prescricao b
  WHERE b.nr_atendimento = nr_atendimento_p
  AND (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
  AND coalesce(b.dt_suspensao::text, '') = '';

  OPEN C01;
  FETCH C01 INTO nr_seq_prescr_w, type_evol_prescricao_w;
  CLOSE C01;

  IF (type_of_care_user_w = type_of_care_prescricao_w) AND (type_evol_prescricao_w = ie_tipo_evolucao_w) THEN
    RETURN nr_seq_prescr_w;
  ELSE
    RETURN 0;
  END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_avaliacao_anterior ( cd_perfil_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

