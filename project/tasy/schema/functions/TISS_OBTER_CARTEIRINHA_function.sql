-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tiss_obter_carteirinha (cd_convenio_p bigint, cd_estabelecimento_p bigint, ie_tipo_atendimento_p bigint, cd_usuario_convenio_p text, cd_complemento_p text) RETURNS varchar AS $body$
DECLARE


cd_usuario_convenio_w		varchar(255);
cd_usuario_mascara_w		varchar(255);
ds_mascara_w			varchar(255)	:= null;
ie_regra_mascara_w		varchar(10);
ie_envio_carteira_w		varchar(3);
nr_posicao_final_w		bigint;
qt_digitos_carteira_w		bigint;
ds_formato_carteira_w		varchar(50);


BEGIN

cd_usuario_convenio_w	:= cd_usuario_convenio_p;

if (cd_usuario_convenio_w IS NOT NULL AND cd_usuario_convenio_w::text <> '') then

	select	max(ds_mascara_usuario),
		coalesce(max(ie_regra_mascara), 'N'),
		coalesce(max(ie_envio_carteira), 'CI')
	into STRICT	ds_mascara_w,
		ie_regra_mascara_w,
		ie_envio_carteira_w
	from	tiss_parametros_convenio
	where	cd_convenio		= cd_convenio_p
	and	cd_estabelecimento	= cd_estabelecimento_p;

	if (coalesce(ie_regra_mascara_w,'N') = 'N') then

		if (position('@ELIMINA_ZEROS_ESQ' in ds_mascara_w) > 0) then

			select	ltrim(cd_usuario_convenio_w,'0')
			into STRICT	cd_usuario_convenio_w
			;

		elsif (position('@ELIMINA_ZEROS_DIR' in ds_mascara_w) > 0) then

			select	rtrim(cd_usuario_convenio_w,'0')
			into STRICT	cd_usuario_convenio_w
			;

		elsif (position('Y' in ds_mascara_w) > 0) then

			/*lhalves em 10/11/2012 - OS 513516
			Utilizado para os casos conforme exemplo:
				Devem ser enviados sempre no máximo 10 dígitos, só que para os código que possuem menos que 10 dígitos não deve completar com zeros.
				Então utilizar mascara com 10 'Y' = 'YYYYYYYYYY' - Maiúsculo
			*/
			nr_posicao_final_w	:= instr(ds_mascara_w,'Y',-1,1); --Retorna a posição final do último Y
			if (nr_posicao_final_w > 0) then
				cd_usuario_convenio_w	:= substr(cd_usuario_convenio_w,1,nr_posicao_final_w);	--Retorna o código do usuário até a posição do último Y
			end if;
		else
			if (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') and (length(cd_usuario_convenio_w) < length(ds_mascara_w)) then
				qt_digitos_carteira_w	:= length(ds_mascara_w);
				cd_usuario_convenio_w	:= lpad(cd_usuario_convenio_w, qt_digitos_carteira_w,0);
			end if;

			if (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') then
				begin

				select	TISS_OBTER_COD_USUARIO_MASC(cd_usuario_convenio_w, ds_mascara_w)
				into STRICT	cd_usuario_mascara_w
				;

				exception
					when others then
						cd_usuario_mascara_w	:= null;
				end;

				if (cd_usuario_mascara_w IS NOT NULL AND cd_usuario_mascara_w::text <> '') then
					cd_usuario_convenio_w	:= cd_usuario_mascara_w;
				end if;
			end if;
		end if;
	else

		select	max(Obter_Mascara_Usuario_Conv(cd_estabelecimento_p, cd_convenio_p, null, ie_tipo_atendimento_p, null, clock_timestamp()))
		into STRICT	ds_mascara_w
		;

		ds_mascara_w	:= Tiss_Substituir_String(ds_mascara_w, '9', '0');

		if (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') and (length(cd_usuario_convenio_w) < length(ds_mascara_w)) then
			qt_digitos_carteira_w	:= length(ds_mascara_w);
			cd_usuario_convenio_w	:= lpad(cd_usuario_convenio_w, qt_digitos_carteira_w,0);
		end if;

		if (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') then
			begin

			select	TISS_OBTER_COD_USUARIO_MASC(cd_usuario_convenio_w, ds_mascara_w)
			into STRICT	cd_usuario_mascara_w
			;

			exception
				when others then
					cd_usuario_mascara_w	:= null;
			end;

			if (cd_usuario_mascara_w IS NOT NULL AND cd_usuario_mascara_w::text <> '') then
				cd_usuario_convenio_w	:= cd_usuario_mascara_w;
			end if;
		end if;

	end if;

	if (ie_envio_carteira_w = '0ND') and (ds_formato_carteira_w IS NOT NULL AND ds_formato_carteira_w::text <> '') then
		cd_usuario_convenio_w	:= TISS_OBTER_COD_USUARIO(cd_usuario_convenio_w, ds_formato_carteira_w, '0') ||
					   TISS_OBTER_COD_USUARIO(cd_usuario_convenio_w, ds_formato_carteira_w, 'ND');
	elsif (ie_envio_carteira_w = '0') and (ds_formato_carteira_w IS NOT NULL AND ds_formato_carteira_w::text <> '') then
		cd_usuario_convenio_w	:= TISS_OBTER_COD_USUARIO(cd_usuario_convenio_w, ds_formato_carteira_w, '0');
	elsif (ie_envio_carteira_w = 'CIC') then
		cd_usuario_convenio_w	:= substr(cd_usuario_convenio_w || cd_complemento_p,1,30);
	elsif (ie_envio_carteira_w = 'COM') then
		cd_usuario_convenio_w	:= substr(cd_complemento_p,1,30);
	end if;
end if;

return cd_usuario_convenio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_obter_carteirinha (cd_convenio_p bigint, cd_estabelecimento_p bigint, ie_tipo_atendimento_p bigint, cd_usuario_convenio_p text, cd_complemento_p text) FROM PUBLIC;

