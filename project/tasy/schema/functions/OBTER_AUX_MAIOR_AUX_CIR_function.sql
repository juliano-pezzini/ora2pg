-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_aux_maior_aux_cir (nr_cirurgia_p bigint, nr_interno_conta_p bigint, dt_conta_p timestamp, ie_origem_proced_p bigint, cd_edicao_amb_p bigint) RETURNS bigint AS $body$
DECLARE


nr_aux_w		bigint;
nr_auxiliares_w		bigint;
nr_auxiliares_maior_w	bigint := 0;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;

cd_edicao_amb_w		edicao_amb.cd_edicao_amb%type;
dt_conta_w		procedimento_paciente.dt_conta%type;

C01 CURSOR FOR
	SELECT	cd_procedimento,
		ie_origem_proced,
		cd_edicao_amb,
		dt_conta
	from	procedimento_paciente
	where	nr_cirurgia		= nr_cirurgia_p
	and	nr_interno_conta	= nr_interno_conta_p
	order by cd_procedimento;


BEGIN

open C01;
loop
fetch 	C01 into
	cd_procedimento_w,
	ie_origem_proced_w,
	cd_edicao_amb_w,
	dt_conta_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	cd_edicao_amb_w	:= coalesce(cd_edicao_amb_w, cd_edicao_amb_p);
	dt_conta_w	:= coalesce(dt_conta_w, dt_conta_p);

	if (ie_origem_proced_w	= 5) then
		begin

		select 	coalesce(max(a.nr_auxiliar),0)
		into STRICT	nr_auxiliares_w
		from	cbhpm_preco a
		where	a.cd_procedimento	= cd_procedimento_w
		and	a.ie_origem_proced	= ie_origem_proced_w
		and	coalesce(a.dt_vigencia,clock_timestamp() - interval '3650 days') =
				(SELECT max(coalesce(b.dt_vigencia,clock_timestamp() - interval '3650 days'))
					from cbhpm_preco b
					where b.cd_procedimento		= cd_procedimento_w
					and	b.ie_origem_proced	= ie_origem_proced_w
					and	coalesce(b.dt_vigencia,clock_timestamp() - interval '3650 days') <= dt_conta_w);

		if (nr_auxiliares_maior_w < nr_auxiliares_w) then
			nr_auxiliares_maior_w	:= nr_auxiliares_w;
			nr_aux_w		:= nr_auxiliares_w;
		end if;
		end;
	else
		begin

		select	coalesce(max(a.nr_auxiliares),0)
		into STRICT	nr_auxiliares_w
		from	preco_amb a
		where	a.cd_procedimento		= cd_procedimento_w
		and	a.cd_edicao_amb			= cd_edicao_amb_w
		and 	coalesce(a.dt_inicio_vigencia,clock_timestamp() - interval '3650 days')	=
			(SELECT	max(coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days'))
			from 	preco_amb b
			where 	b.cd_edicao_amb		= cd_edicao_amb_w
			and	b.cd_procedimento	= cd_procedimento_w
			and	coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days')	<= dt_conta_w);

		if (nr_auxiliares_maior_w < nr_auxiliares_w) then
			nr_auxiliares_maior_w	:= nr_auxiliares_w;
			nr_aux_w		:= nr_auxiliares_w;
		end if;

		end;
	end if;

	end;
end loop;
close C01;

return	nr_aux_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_aux_maior_aux_cir (nr_cirurgia_p bigint, nr_interno_conta_p bigint, dt_conta_p timestamp, ie_origem_proced_p bigint, cd_edicao_amb_p bigint) FROM PUBLIC;

