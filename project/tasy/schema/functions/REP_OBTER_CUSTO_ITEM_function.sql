-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION rep_obter_custo_item (cd_material_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, ie_opcao_p text, ie_informacao_p text) RETURNS bigint AS $body$
DECLARE


vl_unit_w		double precision;
vl_total_w		double precision;
vl_retorno_w		double precision;
qt_dose_w			double precision;
cd_material_w			double precision;
qt_conv_estoque_consumo_w	double precision;
cd_unidade_medida_dose_w	varchar(50);


BEGIN

if (ie_opcao_p	= 'J') then

	SELECT	coalesce(obter_valor_brasindice(a.cd_material,'C'), REP_Obter_Maior_Valor_Compra(a.cd_material,clock_timestamp(),1825)),
		c.qt_conv_estoque_consumo,
		a.qt_dose,
		c.cd_material,
		a.cd_unidade_medida_dose
	into STRICT	vl_unit_w,
		qt_conv_estoque_consumo_w,
		qt_dose_w,
		cd_material_w,
		cd_unidade_medida_dose_w
	FROM	material c,
		prescr_material a,
		prescr_medica b
	WHERE	a.nr_prescricao = b.nr_prescricao
	and	c.cd_material = a.cd_material
	AND	b.nr_prescricao = nr_prescricao_p
	and	a.nr_sequencia	= nr_sequencia_p;

	qt_dose_w	:= obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_dose_w, qt_dose_w);

	if (ie_informacao_p = 'U') then
		vl_retorno_w	:= (vl_unit_w / qt_conv_estoque_consumo_w);
	elsif (ie_informacao_p = 'T') then
		vl_retorno_w	:= (vl_unit_w / qt_conv_estoque_consumo_w) * qt_dose_w;
	end if;

end if;

return	coalesce(vl_retorno_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION rep_obter_custo_item (cd_material_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, ie_opcao_p text, ie_informacao_p text) FROM PUBLIC;

