-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dt_agenda_autor ( nr_sequencia_autor_p bigint) RETURNS timestamp AS $body$
DECLARE


dt_agenda_w			timestamp;
nr_seq_agenda_w			bigint	:= null;
nr_seq_agenda_consulta_w		bigint	:= null;
nr_seq_age_integ_w		bigint	:= null;
nr_seq_paciente_setor_w		bigint	:= null;
nr_seq_paciente_w			bigint	:= null;
nr_ciclo_w			bigint	:= null;
ie_limpar_data_ciclo_w		varchar(15)	:= 'N';


BEGIN

begin
ie_limpar_data_ciclo_w	:= coalesce(Obter_valor_param_usuario(3004,141,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento),'N');
exception
when others then
	ie_limpar_data_ciclo_w := 'N';
end;

if (nr_sequencia_autor_p IS NOT NULL AND nr_sequencia_autor_p::text <> '') then
	select	nr_seq_agenda,
		nr_seq_agenda_consulta,
		nr_seq_age_integ,
		nr_seq_paciente_setor,
		nr_ciclo,
		nr_seq_paciente
	into STRICT	nr_seq_agenda_w,
		nr_seq_agenda_consulta_w,
		nr_seq_age_integ_w,
		nr_seq_paciente_setor_w,
		nr_ciclo_w,
		nr_seq_paciente_w
	from	autorizacao_convenio
	where	nr_sequencia	= nr_sequencia_autor_p;
end if;

if (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') then

	select	a.dt_agenda
	into STRICT	dt_agenda_w
	from	agenda_paciente a
	where	nr_sequencia	= nr_seq_agenda_w;
	
elsif (nr_seq_agenda_consulta_w IS NOT NULL AND nr_seq_agenda_consulta_w::text <> '') then

	select	max(a.dt_agenda)
	into STRICT	dt_agenda_w
	from	agenda_consulta a
	where	nr_sequencia	= nr_seq_agenda_consulta_w;

elsif (nr_seq_age_integ_w IS NOT NULL AND nr_seq_age_integ_w::text <> '') then
		
	select	max(a.dt_inicio_agendamento)
	into STRICT	dt_agenda_w
	from	agenda_integrada a
	where	nr_sequencia	= nr_seq_age_integ_w;
	
end if;

return dt_agenda_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dt_agenda_autor ( nr_sequencia_autor_p bigint) FROM PUBLIC;

