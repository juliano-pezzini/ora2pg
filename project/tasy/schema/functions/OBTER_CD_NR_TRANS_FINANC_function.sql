-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_cd_nr_trans_financ (cd_transacao_p text, nr_seq_trans_fin_p bigint, ie_tipo_p text, nr_seq_caixa_p bigint DEFAULT NULL, nr_seq_conta_banco_p bigint DEFAULT NULL) RETURNS varchar AS $body$
DECLARE



-- ie_tipo_p:

-- 'DESC': Descrição da transação

-- 'BTR': Baixa de Títulos a Receber

-- 'RCT': Recebimento de caixa tesouraria

-- 'CBT': Controle bancario transação

-- 'RCTOR': Recebimento de caixa tesouraria Outros recebimentos

-- 'RTT': Recebimento de transacao na tesouraria
nm_usuario_w		usuario.nm_usuario%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_empresa_w		empresa.cd_empresa%type;
ds_retorno_w    	varchar(255);
ie_transacao_saldo_w varchar(255);
ie_mostrar_inativos_w varchar(255);


BEGIN

select	obter_usuario_ativo,
	obter_estabelecimento_ativo
into STRICT	nm_usuario_w,
	cd_estabelecimento_w
;

ie_transacao_saldo_w := Obter_Param_Usuario(813, 75, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, ie_transacao_saldo_w);
ie_mostrar_inativos_w := Obter_Param_Usuario(813, 67, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, ie_mostrar_inativos_w);

if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then
	select obter_empresa_estab(cd_estabelecimento_w)
	into STRICT cd_empresa_w
	;
end if;

-- 'DESC': Descrição da transação
if (ie_tipo_p = 'DESC' and (nr_seq_trans_fin_p IS NOT NULL AND nr_seq_trans_fin_p::text <> '')) then
	select substr(obter_desc_trans_financ(nr_seq_trans_fin_p),1,254)
	into STRICT ds_retorno_w
	;
end if;


-- 'BTR': Baixa de Títulos a Receber
if (ie_tipo_p = 'BTR' and (cd_transacao_p IS NOT NULL AND cd_transacao_p::text <> '')) then
	select max(a.nr_sequencia) nr_seq_trans_fin
	into STRICT	ds_retorno_w
	from transacao_financeira a
	where obter_se_trans_fin_usuario(nm_usuario_w, a.nr_sequencia) = 'S'
	and obter_se_trans_fin_estab(a.nr_sequencia,cd_estabelecimento_w) = 'S'
	and a.ie_conta_receber = 'S'
	and a.ie_situacao = 'A'
	and a.cd_transacao = cd_transacao_p
	and a.cd_empresa = cd_empresa_w;
end if;

if (ie_tipo_p = 'BTR' and (nr_seq_trans_fin_p IS NOT NULL AND nr_seq_trans_fin_p::text <> '')) then
	select a.cd_transacao
	into STRICT ds_retorno_w
	from transacao_financeira a
where 	a.nr_sequencia = nr_seq_trans_fin_p;
end if;

-- 'RCT': Recebimento de caixa tesouraria
if (ie_tipo_p = 'RCT' and (cd_transacao_p IS NOT NULL AND cd_transacao_p::text <> '')) then
	
	if (ie_transacao_saldo_w = 'S') then
	
	SELECT MAX(nr_seq_trans_fin)
	 INTO STRICT ds_retorno_w
	FROM ( 
		SELECT    max(a.nr_sequencia) nr_seq_trans_fin		
		from       transacao_financeira a
		where  ie_situacao          = 'A' 
		and    ((coalesce(a.cd_estabelecimento::text, '') = '' and 
			exists (SELECT  1 
						from     trans_financ_estab x 
						where    x.nr_seq_trans_financ   = a.nr_sequencia) and 
			obter_se_trans_fin_estab(a.nr_sequencia,cd_estabelecimento_w) = 'S') or (not exists (select     1 
					from       trans_financ_estab x 
					where      x.nr_seq_trans_financ   = a.nr_sequencia) and (coalesce(a.cd_estabelecimento::text, '') = '' or a.cd_estabelecimento = cd_estabelecimento_w)))
		and    cd_empresa           = cd_empresa_w
		and    obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia) = 'S' 
		and    ((ie_caixa = 'D'  and ie_saldo_caixa in ( 'E', 'N'))
			or (ie_caixa in ('D','A') and ie_saldo_caixa = 'N' and ie_acao in (1,18)))
		and    ie_acao in (0,1,3,18,32,34,99) 
		and    obter_se_trans_fin_caixa(nr_seq_caixa_p ,nr_sequencia) = 'S'
		and coalesce(ie_util_caixa, 'A') in ('A','R') 
		and a.cd_transacao = cd_transacao_p
		
union
 
		select     max(nr_sequencia) nr_seq_trans_fin
		from       transacao_financeira
		where      nr_sequencia    = nr_seq_trans_fin_p
	) alias26;
	
	else
	
	SELECT MAX(nr_seq_trans_fin)
	 INTO STRICT ds_retorno_w
	FROM ( 
		SELECT     max(a.nr_sequencia) nr_seq_trans_fin
		from       transacao_financeira a
		where  ie_situacao          = 'A' 
		and    ((coalesce(a.cd_estabelecimento::text, '') = '' and 
			exists (SELECT  1 
					from     trans_financ_estab x 
					where    x.nr_seq_trans_financ   = a.nr_sequencia) and 
			obter_se_trans_fin_estab(a.nr_sequencia,cd_estabelecimento_w) = 'S') or (not exists (select     1 
					from       trans_financ_estab x 
					where      x.nr_seq_trans_financ   = a.nr_sequencia) and (coalesce(a.cd_estabelecimento::text, '') = '' or a.cd_estabelecimento = cd_estabelecimento_w)))
		and    cd_empresa           = cd_empresa_w 
		and    obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia) = 'S' 
		and    ((ie_caixa = 'D'  and ie_saldo_caixa = 'E')
			or (ie_caixa in ('D','A') and ie_saldo_caixa = 'N' and ie_acao in (1,18)))
		and    ie_acao in (0,1,3,18,32,34,99) 
		and    obter_se_trans_fin_caixa(nr_seq_caixa_p ,nr_sequencia) = 'S'
		and coalesce(ie_util_caixa, 'A') in ('A','R') 
		and a.cd_transacao = cd_transacao_p
		
union
 
		select     max(nr_sequencia) nr_seq_trans_fin
		from       transacao_financeira
		where      nr_sequencia    = nr_seq_trans_fin_p
	) alias22;
	
	end if;
end if;


if (ie_tipo_p = 'RCT' and (nr_seq_trans_fin_p IS NOT NULL AND nr_seq_trans_fin_p::text <> '')) then
	
	if (ie_transacao_saldo_w = 'S') then
	
	SELECT MAX(cd_transacao)
	 INTO STRICT ds_retorno_w
	FROM ( 
		SELECT    max(a.cd_transacao) cd_transacao		
		from       transacao_financeira a
		where  ie_situacao          = 'A' 
		and    ((coalesce(a.cd_estabelecimento::text, '') = '' and 
			exists (SELECT  1 
					from     trans_financ_estab x 
					where    x.nr_seq_trans_financ   = a.nr_sequencia) and 
			obter_se_trans_fin_estab(a.nr_sequencia,cd_estabelecimento_w) = 'S' ) or (not exists (select     1 
					from       trans_financ_estab x 
					where      x.nr_seq_trans_financ   = a.nr_sequencia) and (coalesce(a.cd_estabelecimento::text, '') = '' or a.cd_estabelecimento = cd_estabelecimento_w)))
		and    cd_empresa           = cd_empresa_w
		and    obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia) = 'S' 
		and    ((ie_caixa = 'D'  and ie_saldo_caixa in ( 'E', 'N'))
			or (ie_caixa in ('D','A') and ie_saldo_caixa = 'N' and ie_acao in (1,18)))
		and    ie_acao in (0,1,3,18,32,34,99) 
		and    obter_se_trans_fin_caixa(nr_seq_caixa_p ,nr_sequencia) = 'S'
		and coalesce(ie_util_caixa, 'A') in ('A','R') 
		and a.nr_sequencia = nr_seq_trans_fin_p
		
union
 
		select     max(cd_transacao) cd_transacao
		from       transacao_financeira
		where      nr_sequencia    = nr_seq_trans_fin_p
	) alias26;
	
	else
	
	SELECT MAX(cd_transacao)
	 INTO STRICT ds_retorno_w
	FROM ( 
		SELECT     max(a.cd_transacao) cd_transacao
		from       transacao_financeira a
		where  ie_situacao          = 'A' 
		and    ((coalesce(a.cd_estabelecimento::text, '') = '' and 
			exists (SELECT  1 
					from     trans_financ_estab x 
					where    x.nr_seq_trans_financ   = a.nr_sequencia) and 
			obter_se_trans_fin_estab(a.nr_sequencia,cd_estabelecimento_w) = 'S' ) or (not exists (select     1 
					from       trans_financ_estab x 
					where      x.nr_seq_trans_financ   = a.nr_sequencia) and (coalesce(a.cd_estabelecimento::text, '') = '' or a.cd_estabelecimento = cd_estabelecimento_w)))
		and    cd_empresa           = cd_empresa_w 
		and    obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia) = 'S' 
		and    ((ie_caixa = 'D'  and ie_saldo_caixa = 'E')
			or (ie_caixa in ('D','A') and ie_saldo_caixa = 'N' and ie_acao in (1,18)))
		and    ie_acao in (0,1,3,18,32,34,99) 
		and    obter_se_trans_fin_caixa(nr_seq_caixa_p ,nr_sequencia) = 'S'
		and coalesce(ie_util_caixa, 'A') in ('A','R') 
		and a.nr_sequencia = nr_seq_trans_fin_p
		
union
 
		select     max(cd_transacao) cd_transacao
		from       transacao_financeira
		where      nr_sequencia    = nr_seq_trans_fin_p
	) alias22;
	
	end if;

end if;

-- 'CBT': Controle bancario transação
if (ie_tipo_p = 'CBT' and (cd_transacao_p IS NOT NULL AND cd_transacao_p::text <> '')) then
	
SELECT MAX(nr_seq_trans_fin)
 INTO STRICT ds_retorno_w
FROM ( 
	SELECT   max(nr_sequencia) nr_seq_trans_fin
	from     transacao_financeira
	where    coalesce(ie_banco,'N') <> 'N'
	and      ie_situacao = 'A'
	and      obter_se_trans_fin_estab(nr_sequencia,cd_estabelecimento_w) = 'S'
	and      cd_empresa           = cd_empresa_w
	and      obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia) = 'S'
	and      obter_se_trans_fin_banco(nr_seq_conta_banco_p, nr_sequencia) = 'S'
	and      coalesce(ie_controle_banc, 'S') = 'S'
	and 	cd_transacao = cd_transacao_p
	
union

	SELECT   max(a.nr_sequencia) nr_seq_trans_fin
	FROM     transacao_financeira a
	WHERE    coalesce(ie_banco,'N') <> 'N'
	AND      ie_situacao = 'I'
	AND      obter_se_trans_fin_estab(nr_sequencia,cd_estabelecimento_w) = 'S'
	AND      cd_empresa           = cd_empresa_w
	AND      obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia) = 'S'
	AND      obter_se_trans_fin_banco(nr_seq_conta_banco_p, nr_sequencia) = 'S'
	AND      coalesce(ie_controle_banc, 'S') = 'S'
	and 	 cd_transacao = cd_transacao_p
	and      'S'   = coalesce(ie_mostrar_inativos_w,'N')
	AND		 EXISTS (SELECT		   1
		 		FROM		   banco_saldo x,
							   movto_trans_financ y
				WHERE		   x.nr_sequencia	   	   = y.nr_Seq_saldo_banco
				AND			   y.nr_seq_trans_financ   = a.nr_sequencia)
	
union
 
	select     max(nr_sequencia) nr_seq_trans_fin
	from       transacao_financeira
	where      nr_sequencia    = nr_seq_trans_fin_p
) alias18;
end if;

if (ie_tipo_p = 'CBT' and (nr_seq_trans_fin_p IS NOT NULL AND nr_seq_trans_fin_p::text <> '')) then

SELECT MAX(cd_transacao)
 INTO STRICT ds_retorno_w
FROM ( 
	SELECT   max(CD_TRANSACAO) cd_transacao
	from     transacao_financeira
	where    coalesce(ie_banco,'N') <> 'N'
	and      ie_situacao = 'A'
	and      obter_se_trans_fin_estab(nr_sequencia,cd_estabelecimento_w) = 'S'
	and      cd_empresa           = cd_empresa_w
	and      obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia) = 'S'
	and      obter_se_trans_fin_banco(nr_seq_conta_banco_p, nr_sequencia) = 'S'
	and      coalesce(ie_controle_banc, 'S') = 'S'
	and      nr_sequencia = nr_seq_trans_fin_p
	
union
 
	SELECT   max(a.CD_TRANSACAO) cd_transacao
	FROM     transacao_financeira a
	WHERE    coalesce(ie_banco,'N') <> 'N'
	AND      ie_situacao = 'I'
	AND      obter_se_trans_fin_estab(nr_sequencia,cd_estabelecimento_w) = 'S'
	AND      cd_empresa           = cd_empresa_w
	AND      obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia) = 'S'
	AND      obter_se_trans_fin_banco(nr_seq_conta_banco_p, nr_sequencia) = 'S'
	AND      coalesce(ie_controle_banc, 'S') = 'S'
	and 	 a.nr_sequencia = nr_seq_trans_fin_p
	and      'S'   = coalesce(ie_mostrar_inativos_w,'N')
	AND		 EXISTS (SELECT		   1
		 		FROM		   banco_saldo x,
							   movto_trans_financ y
				WHERE		   x.nr_sequencia	   	   = y.nr_Seq_saldo_banco
				AND			   y.nr_seq_trans_financ   = a.nr_sequencia)
	
union
  
	select     max(cd_transacao) cd_transacao
	from       transacao_financeira
	where      nr_sequencia    = nr_seq_trans_fin_p
) alias18;	
end if;

-- 'RCTOR': Recebimento de caixa tesouraria Outros recebimentos
if (ie_tipo_p = 'RCTOR' and (cd_transacao_p IS NOT NULL AND cd_transacao_p::text <> '')) then

SELECT MAX(nr_seq_trans_fin)
 INTO STRICT ds_retorno_w
FROM ( 
	SELECT max(nr_sequencia) nr_seq_trans_fin
	from   transacao_financeira a
	where  ie_situacao          = 'A'
	and    ((coalesce(a.cd_estabelecimento::text, '') = '' and
			 exists (SELECT  1
						 from     trans_financ_estab x 
						 where    x.nr_seq_trans_financ   = a.nr_sequencia) and
			 obter_se_trans_fin_estab(a.nr_sequencia,cd_estabelecimento_w) = 'S') or (not exists (select  1
						 from     trans_financ_estab x
						 where    x.nr_seq_trans_financ   = a.nr_sequencia) and (coalesce(a.cd_estabelecimento::text, '') = '' or a.cd_estabelecimento = cd_estabelecimento_w)))
	and    cd_empresa           = cd_empresa_w
	and	obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia) = 'S'
	and    ((ie_caixa = 'D' and ie_saldo_caixa = 'E') or (ie_caixa =  'A'  and ie_saldo_caixa =  'N' )) 
	and    ie_acao in (0,27,32)
	and	OBTER_SE_TRANS_FIN_CAIXA(nr_seq_caixa_p, nr_sequencia) = 'S'
	and 	 cd_transacao = cd_transacao_p
	
union
  
	select     max(nr_sequencia) nr_seq_trans_fin
	from       transacao_financeira
	where      nr_sequencia    = nr_seq_trans_fin_p
) alias20;
end if;

if (ie_tipo_p = 'RCTOR' and (nr_seq_trans_fin_p IS NOT NULL AND nr_seq_trans_fin_p::text <> '')) then

SELECT MAX(cd_transacao)
 INTO STRICT ds_retorno_w
FROM ( 
	SELECT max(CD_TRANSACAO) cd_transacao
	from   transacao_financeira a
	where  ie_situacao          = 'A'
	and    ((coalesce(a.cd_estabelecimento::text, '') = '' and
			 exists (SELECT  1
						 from     trans_financ_estab x 
						 where    x.nr_seq_trans_financ   = a.nr_sequencia) and
			 obter_se_trans_fin_estab(a.nr_sequencia,cd_estabelecimento_w) = 'S') or (not exists (select  1
						 from     trans_financ_estab x
						 where    x.nr_seq_trans_financ   = a.nr_sequencia) and (coalesce(a.cd_estabelecimento::text, '') = '' or a.cd_estabelecimento = cd_estabelecimento_w)))
	and    cd_empresa           = cd_empresa_w
	and	obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia) = 'S'
	and    ((ie_caixa = 'D' and ie_saldo_caixa = 'E') or (ie_caixa =  'A'  and ie_saldo_caixa =  'N' )) 
	and    ie_acao in (0,27,32)
	and	OBTER_SE_TRANS_FIN_CAIXA(nr_seq_caixa_p, nr_sequencia) = 'S'
	and 	 a.nr_sequencia = nr_seq_trans_fin_p
	
union
  
	select     max(cd_transacao) cd_transacao
	from       transacao_financeira
	where      nr_sequencia    = nr_seq_trans_fin_p
) alias20;
end if;

IF (ie_tipo_p = 'RTT' AND (cd_transacao_p IS NOT NULL AND cd_transacao_p::text <> '')) THEN

SELECT MAX(nr_seq_trans_fin)
 INTO STRICT ds_retorno_w
FROM ( 
  SELECT MAX(nr_sequencia) nr_seq_trans_fin
  FROM transacao_financeira a
  WHERE ie_caixa             <> 'N'
  AND ie_situacao             = 'A'
  AND ((coalesce(a.cd_estabelecimento::text, '') = ''
  AND EXISTS (SELECT 1
    FROM trans_financ_estab x
    WHERE x.nr_seq_trans_financ = a.nr_sequencia
    )
  AND obter_se_trans_fin_estab(a.nr_sequencia,cd_estabelecimento_w) = 'S' )
  OR (NOT EXISTS (SELECT 1
    FROM trans_financ_estab x
    WHERE x.nr_seq_trans_financ = a.nr_sequencia
    )
  AND (coalesce(a.cd_estabelecimento::text, '') = ''
  OR a.cd_estabelecimento                                         = cd_estabelecimento_w)))
  AND cd_empresa                                                  = cd_empresa_w
  AND obter_se_trans_fin_caixa(nr_seq_caixa_p, nr_sequencia)      = 'S'
  AND obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia)      = 'S'
  AND coalesce(ie_util_caixa, 'A')                                    IN ('A', 'T')
  AND a.cd_transacao                                             = cd_transacao_p
  
UNION

  SELECT max(nr_sequencia) nr_seq_trans_fin
  FROM transacao_financeira
  WHERE nr_sequencia = nr_seq_trans_fin_p
 ) alias18;
END IF;

IF (ie_tipo_p = 'RTT' AND (nr_seq_trans_fin_p IS NOT NULL AND nr_seq_trans_fin_p::text <> '')) THEN

SELECT MAX(cd_transacao)
 INTO STRICT ds_retorno_w	
FROM (
  SELECT MAX(cd_transacao) cd_transacao
  FROM transacao_financeira a
  WHERE ie_caixa             <> 'N'
  AND ie_situacao             = 'A'
  AND ((coalesce(a.cd_estabelecimento::text, '') = ''
  AND EXISTS (SELECT 1
    FROM trans_financ_estab x
    WHERE x.nr_seq_trans_financ = a.nr_sequencia
    )
  AND obter_se_trans_fin_estab(a.nr_sequencia,cd_estabelecimento_w) = 'S' )
  OR (NOT EXISTS (SELECT 1
    FROM trans_financ_estab x
    WHERE x.nr_seq_trans_financ = a.nr_sequencia
    )
  AND (coalesce(a.cd_estabelecimento::text, '') = ''
  OR a.cd_estabelecimento                                         = cd_estabelecimento_w)))
  AND cd_empresa                                                  = cd_empresa_w
  AND obter_se_trans_fin_caixa(nr_seq_caixa_p, nr_sequencia)      = 'S'
  AND obter_se_trans_fin_usuario(nm_usuario_w, nr_sequencia)      = 'S'
  AND coalesce(ie_util_caixa, 'A')                                    IN ('A', 'T')
  AND a.nr_sequencia                                              = nr_seq_trans_fin_p

UNION

  SELECT max(cd_transacao) cd_transacao
  FROM transacao_financeira
  WHERE nr_sequencia = nr_seq_trans_fin_p
 ) alias18;
END IF;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_cd_nr_trans_financ (cd_transacao_p text, nr_seq_trans_fin_p bigint, ie_tipo_p text, nr_seq_caixa_p bigint DEFAULT NULL, nr_seq_conta_banco_p bigint DEFAULT NULL) FROM PUBLIC;

