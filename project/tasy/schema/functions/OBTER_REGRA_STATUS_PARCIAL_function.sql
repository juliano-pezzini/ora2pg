-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_status_parcial (nr_prescricao_p bigint, nr_seq_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w  varchar(60);
nr_seq_exame_w bigint;
nr_seq_grupo_w bigint;
qt_dias_w   bigint;
qt_regras   bigint;
ds_resultado_w varchar(2000);
ds_status_w  varchar(255);


BEGIN 
 ds_retorno_w := ' ';
 
 select count(*) 
  into STRICT qt_regras  
  from LABW_REGRA_STATUS_PARCIAL;
 
 if (qt_regras > 0) then 
  select max(pp.nr_seq_exame), max(el.nr_seq_grupo), Obter_Dias_Entre_Datas(max(pm.dt_liberacao), clock_timestamp()), 
      substr(coalesce(coalesce(CASE WHEN max(elri.ds_resultado)='0' THEN ''  ELSE CASE WHEN max(el.ie_formato_resultado)='V' THEN ''  ELSE max(elri.ds_resultado) END  END , 
             coalesce(to_char(max(elri.qt_resultado)),to_char(CASE WHEN max(elri.pr_resultado)=0 THEN ''  ELSE max(elri.pr_resultado) END ))),max(elri.ds_resultado)),1,100) 
   into STRICT nr_seq_exame_w, nr_seq_grupo_w, qt_dias_w, ds_resultado_w 
   from prescr_procedimento pp 
   inner join exame_laboratorio el on el.nr_seq_exame = pp.nr_seq_exame 
   inner join prescr_medica pm on pm.nr_prescricao = pp.nr_prescricao 
   inner join exame_lab_resultado elr on elr.nr_prescricao = pp.nr_prescricao 
   inner join exame_lab_result_item elri on elri.nr_seq_resultado = elr.nr_seq_resultado and elri.nr_seq_prescr = pp.nr_sequencia and elri.nr_seq_exame = pp.nr_seq_exame 
   where pp.nr_prescricao = nr_prescricao_p 
  	 and pp.nr_sequencia = nr_seq_prescricao_p;
    
  select ds_desc_status 
   into STRICT ds_status_w 
   from (SELECT coalesce(max(ds_desc_status),'') ds_desc_status 
       from LABW_REGRA_STATUS_PARCIAL 
      where upper(ds_resultado) = upper(ds_resultado_w) and 
         qt_dias > qt_dias_w and 
         ((nr_seq_exame = nr_seq_exame_w AND nr_seq_grupo = nr_seq_grupo_w) or 
          ((nr_seq_exame = nr_seq_exame_w) and (coalesce(nr_seq_grupo::text, '') = '')) or 
          ((coalesce(nr_seq_exame::text, '') = '') and (nr_seq_grupo = nr_seq_grupo_w)))) alias14 LIMIT 1;
   
  ds_retorno_w := coalesce(ds_status_w,' ');
 end if;
 
 RETURN	ds_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_status_parcial (nr_prescricao_p bigint, nr_seq_prescricao_p bigint) FROM PUBLIC;

