-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_existe_vacina ( nr_seq_vacina_p bigint, qt_volume_p bigint, nr_atendimento_p bigint, nr_seq_topografia_p bigint, nr_seq_pac_vacina_p bigint, ie_dose_p text, cd_pessoa_fisica_p text, ie_tipo_p text, dt_prevista_execucao_p timestamp default null) RETURNS varchar AS $body$
DECLARE


ie_existe_w	varchar(1);
ie_dose_ref_w	varchar(3);

/*
IE_TIPO_P 
D = Dose;
V = Volume;
T = Topografia;
PV = Pac vacina;
*/
BEGIN

if (ie_tipo_p IS NOT NULL AND ie_tipo_p::text <> '') and (nr_seq_vacina_p IS NOT NULL AND nr_seq_vacina_p::text <> '') then
	begin
	
	if (ie_tipo_p = 'D') then
		begin
		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_existe_w
		from  	vacina b,
			vacina_calendario c,
			pessoa_fisica d
		where	b.nr_sequencia	= c.nr_seq_vacina
		and (coalesce(dt_prevista_execucao_p,clock_timestamp()) -d.dt_nascimento) between Obter_idade_min_max_vacina(c.nr_sequencia,'MIN', ie_dose_p)
		and 	Obter_idade_min_max_vacina(c.nr_sequencia,'MAX', ie_dose_p)
		and	b.nr_sequencia 	= nr_seq_vacina_p
		and	c.ie_dose 	= ie_dose_p
		and	((d.cd_pessoa_fisica 	= cd_pessoa_fisica_p) 
			or (d.cd_pessoa_fisica 	= obter_pessoa_atendimento(nr_atendimento_p,'C')));
		end;
	elsif (ie_tipo_p = 'V') then
		begin
		if (qt_volume_p IS NOT NULL AND qt_volume_p::text <> '')	then
			begin
			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT 	ie_existe_w
			from  	pessoa_fisica a,
				vacina_regra b
			where	a.cd_pessoa_fisica = coalesce(cd_pessoa_fisica_p,obter_pessoa_atendimento(nr_atendimento_p,'C'))
			and	trunc(coalesce(dt_prevista_execucao_p,clock_timestamp())-a.dt_nascimento) between Obter_idade_regra_vacina(b.nr_sequencia,'MIN')
			and 	obter_idade_regra_vacina(b.nr_sequencia,'MAX')
			and	qt_volume_p between b.qt_vol_minimo and	b.qt_volume_maximo
			and	b.nr_seq_vacina = nr_seq_vacina_p
			and	b.ie_situacao 	= 'A';
			end;
		end if;
		end;
	elsif (ie_tipo_p = 'T') then
		begin
		if (nr_seq_topografia_p IS NOT NULL AND nr_seq_topografia_p::text <> '') then
			begin
			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END 
			into STRICT	ie_existe_w
			from  	pessoa_fisica a,
				vacina_regra b
			where	a.cd_pessoa_fisica = coalesce(cd_pessoa_fisica_p,obter_pessoa_atendimento(nr_atendimento_p,'C'))
			and	trunc(coalesce(dt_prevista_execucao_p,clock_timestamp())-a.dt_nascimento)  between obter_idade_regra_vacina(b.nr_sequencia,'MIN')
			and 	obter_idade_regra_vacina(b.nr_sequencia,'MAX')
			and	qt_volume_p between b.qt_vol_minimo and b.qt_volume_maximo
			and	b.nr_seq_vacina 	= nr_seq_vacina_p
			and	b.nr_seq_topografia 	= nr_seq_topografia_p
			and	b.ie_situacao 		= 'A';
			end;
		end if;
		end;
	elsif (ie_tipo_p = 'PV') then
		begin
		if (ie_dose_p IS NOT NULL AND ie_dose_p::text <> '') and (nr_seq_pac_vacina_p IS NOT NULL AND nr_seq_pac_vacina_p::text <> '') then
			begin
			
			ie_dose_ref_w	:= obter_ie_dose_ref_vacina(nr_seq_vacina_p,ie_dose_p);
			
			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_existe_w
			from  	vacina_calendario c,
				vacina b,		
				paciente_vacina a
			where	a.nr_seq_vacina 	= b.nr_sequencia
			and	b.nr_sequencia 		= c.nr_seq_vacina 
			and	a.ie_dose 		= c.ie_dose
			and	a.nr_seq_vacina 	= nr_seq_vacina_p
			and	c.ie_dose 		= ie_dose_ref_w
			and	a.cd_pessoa_fisica 	= coalesce(cd_pessoa_fisica_p,(
								SELECT	max(d.cd_pessoa_fisica) 
								from	atendimento_paciente d 
								where 	d.nr_atendimento = nr_atendimento_p))
			and	a.nr_sequencia <> nr_seq_pac_vacina_p;
			end;
		end if;	
		end;
	end if;
	end;
end if;
return ie_existe_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_existe_vacina ( nr_seq_vacina_p bigint, qt_volume_p bigint, nr_atendimento_p bigint, nr_seq_topografia_p bigint, nr_seq_pac_vacina_p bigint, ie_dose_p text, cd_pessoa_fisica_p text, ie_tipo_p text, dt_prevista_execucao_p timestamp default null) FROM PUBLIC;

