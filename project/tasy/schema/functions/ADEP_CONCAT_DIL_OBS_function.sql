-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION adep_concat_dil_obs (cd_matmed_p text, nr_prescricoes_p text, qt_hora_prescr_p bigint, ds_diluicao_p text) RETURNS varchar AS $body$
DECLARE


ds_dil_obs_w	varchar(2000);

ds_obs_w	varchar(2000) := null;

ds_obs_ww	varchar(2000);
ie_medico_w	varchar(1);

ie_prof_w	varchar(1);

c01 CURSOR FOR
SELECT	a.ds_observacao,
	obter_se_medico(a.cd_pessoa_fisica,'M') ie_medico
from	prescr_medica b,
	prescr_mat_alteracao a
where	b.nr_prescricao = a.nr_prescricao
and	b.dt_validade_prescr > clock_timestamp() - qt_hora_prescr_p/24
and	a.ie_tipo_item = 'M'
and	a.cd_item = cd_matmed_p
and	substr(obter_se_contido(a.nr_prescricao,nr_prescricoes_p),1,1) = 'S'
order by
	ie_medico desc,
	a.dt_alteracao desc;


BEGIN
if (cd_matmed_p IS NOT NULL AND cd_matmed_p::text <> '') and (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') and (ds_diluicao_p IS NOT NULL AND ds_diluicao_p::text <> '') then

	open c01;
	loop
	fetch c01 into	ds_obs_ww,
			ie_medico_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		if (coalesce(ds_obs_w::text, '') = '') then
			if (ie_medico_w = 'S') then
				ds_obs_w := substr('-MED: ' || ds_obs_ww,1,2000);
			else
				ds_obs_w := substr('-ENF: ' || ds_obs_ww,1,2000);
			end if;
			ie_prof_w := ie_medico_w;

		else

			if (ie_prof_w = ie_medico_w) then
				ds_obs_w := substr(ds_obs_w || '; ' || ds_obs_ww,1,2000);
			elsif (ie_medico_w = 'S') then
				ds_obs_w := substr(ds_obs_w || '; -MED: ' || ds_obs_ww,1,2000);
			elsif (ie_medico_w = 'N') then
				ds_obs_w := substr(ds_obs_w || '; -ENF: ' || ds_obs_ww,1,2000);
			end if;
			ie_prof_w := ie_medico_w;
		end if;		

		end;
	end loop;
	close c01;

	ds_dil_obs_w := substr(ds_diluicao_p || chr(10) || ds_obs_w,1,2000);


elsif (ds_diluicao_p IS NOT NULL AND ds_diluicao_p::text <> '') then

	ds_dil_obs_w	:= ds_diluicao_p;

end if;

return ds_dil_obs_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION adep_concat_dil_obs (cd_matmed_p text, nr_prescricoes_p text, qt_hora_prescr_p bigint, ds_diluicao_p text) FROM PUBLIC;

