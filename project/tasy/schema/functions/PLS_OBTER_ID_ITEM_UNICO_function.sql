-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_id_item_unico ( nr_seq_conta_proc_p ptu_nota_servico.nr_seq_conta_proc%type, nr_seq_conta_mat_p ptu_nota_servico.nr_seq_conta_mat%type, dt_procedimento_p ptu_nota_servico.dt_procedimento%type, cd_unimed_prestador_p ptu_nota_servico.cd_unimed_prestador%type, nr_seq_item_p ptu_nota_servico.nr_seq_item%type) RETURNS varchar AS $body$
DECLARE


id_item_unico_w		varchar(28);
nr_seq_conta_proc_w	pls_conta_proc.nr_sequencia%type;
nr_seq_proc_ref_w	pls_conta_proc.nr_seq_proc_ref%type;
ie_pacote_filme		varchar(1) := 'N';
qt_proc_partic		varchar(3) := 0;
ie_item_unico_partic_w	pls_parametro_faturamento.ie_item_unico_partic%type;


BEGIN

select max(coalesce(ie_item_unico_partic, 'N'))
into STRICT ie_item_unico_partic_w
from pls_parametro_faturamento
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

-- Se parametro para duplicar item unico quando tiver duas participacoes estiver ativado
if (ie_item_unico_partic_w = 'S') then
	if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then
		select 	max(d.nr_seq_proc_ref)
		into STRICT 	nr_seq_proc_ref_w
		from 	pls_conta_proc d
		where 	d.nr_sequencia	= nr_seq_conta_proc_p;

		if (coalesce(nr_seq_proc_ref_w::text, '') = '') then
			select	count(a.nr_sequencia)
			into STRICT	qt_proc_partic
			from 	pls_proc_participante a
			where 	a.nr_seq_conta_proc 	= nr_seq_conta_proc_p;

			if (qt_proc_partic >= 2) then
				select 	nextval('pls_conta_proc_seq')
				into STRICT	nr_seq_conta_proc_w
				;
			else
				nr_seq_conta_proc_w := nr_seq_conta_proc_p;
			end if;
		else
			select	CASE WHEN coalesce(max(d.nr_sequencia)::text, '') = '' THEN 'N'  ELSE 'S' END
			into STRICT	ie_pacote_filme
			from	pls_conta_proc d
			where	d.nr_sequencia 	in (nr_seq_conta_proc_p, nr_seq_proc_ref_w)
			and	((coalesce(d.vl_liberado_co,0) > 0 and coalesce(d.vl_liberado_material,0) > 0 and coalesce(d.vl_liberado_hi,0) = 0)
			or (coalesce(d.vl_liberado_hi,0) > 0 and coalesce(d.vl_liberado_co,0) = 0 and coalesce(d.vl_liberado_material,0) = 0))
			and (SELECT count(1)
				from pls_conta_proc x
				where x.nr_sequencia in (nr_seq_conta_proc_p, nr_seq_proc_ref_w)
				and coalesce(x.vl_liberado_co,0) > 0
				and coalesce(x.vl_liberado_material,0) > 0) 	> 0;

			if (ie_pacote_filme) = 'S' then
				nr_seq_conta_proc_w := nr_seq_proc_ref_w;
			else
				nr_seq_conta_proc_w := nr_seq_conta_proc_p;
			end if;
		end if;

		select (to_char(coalesce(dt_procedimento_p,clock_timestamp()),'YYMM') || lpad(cd_unimed_prestador_p, 4, '0') || '1' || lpad(nr_seq_item_p,4,'0') ||lpad(nr_seq_conta_proc_w,15,'0')) id_item_unico
		into STRICT	id_item_unico_w
		;

	elsif (nr_seq_conta_mat_p IS NOT NULL AND nr_seq_conta_mat_p::text <> '') then
		select (to_char(coalesce(dt_procedimento_p,clock_timestamp()),'YYMM') || lpad(cd_unimed_prestador_p, 4, '0') || '2' || lpad(nr_seq_item_p,4,'0') ||lpad(nr_seq_conta_mat_p,15, '0')) id_item_unico
		into STRICT	id_item_unico_w
		;
	end if;

-- Se parametro para duplicar item unico quando tiver duas participacoes nao estiver ativado
else
	if (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then
		select (to_char(coalesce(dt_procedimento_p,clock_timestamp()),'YYMM') || lpad(cd_unimed_prestador_p, 4, '0') || '1' || lpad(nr_seq_item_p,4,'0') ||lpad(nr_seq_conta_proc_p,15, '0')) id_item_unico
		into STRICT	id_item_unico_w
		;

	elsif (nr_seq_conta_mat_p IS NOT NULL AND nr_seq_conta_mat_p::text <> '') then
		select (to_char(coalesce(dt_procedimento_p,clock_timestamp()),'YYMM') || lpad(cd_unimed_prestador_p, 4, '0') || '2' || lpad(nr_seq_item_p,4,'0') ||lpad(nr_seq_conta_mat_p,15, '0')) id_item_unico
		into STRICT	id_item_unico_w
		;
	end if;

end if;

return	id_item_unico_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_id_item_unico ( nr_seq_conta_proc_p ptu_nota_servico.nr_seq_conta_proc%type, nr_seq_conta_mat_p ptu_nota_servico.nr_seq_conta_mat%type, dt_procedimento_p ptu_nota_servico.dt_procedimento%type, cd_unimed_prestador_p ptu_nota_servico.cd_unimed_prestador%type, nr_seq_item_p ptu_nota_servico.nr_seq_item%type) FROM PUBLIC;

