-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_presc_proc_type ( nr_seq_sub_grp_p text, nr_sequencia_p text, nr_atendimento_p bigint, start_time_p timestamp, end_time_p timestamp ) RETURNS varchar AS $body$
DECLARE

    ds_others_w        varchar(500);
    test_w   varchar(165);

BEGIN

   IF nr_seq_sub_grp_p = 'R' THEN
    test_w :='['||obter_expressao_idioma(331494)||' '|| obter_expressao_idioma(761511)||'] ';
    ELSIF nr_seq_sub_grp_p='PH' then
    test_w :='['||obter_expressao_idioma(703250)||' '|| obter_expressao_idioma(761511)||']';
    ELSIF nr_seq_sub_grp_p='E' then
    test_w :='['||obter_expressao_idioma(330885)||']';
    ELSIF nr_seq_sub_grp_p='RE' then
    test_w :='['||obter_expressao_idioma(488422)||']';
    ELSIF nr_seq_sub_grp_p='S' then
    test_w :='['||obter_expressao_idioma(561220)||']';

        END IF;
        SELECT  rtrim(XMLAGG(XMLELEMENT(name E,proce,chr(10))).EXTRACT['//text()'].getclobval(), ',')
        into STRICT ds_others_w
        from(SELECT distinct
        test_w|| chr(10) ||substr(DS_HORARIO,1,50)|| ' '
              || (SELECT substr(ds_proc_exame,1,100) FROM  proc_interno pi WHERE pi.nr_sequencia = cp.nr_seq_proc_interno )
              ||chr(10)proce
        FROM
            proc_order_type     po,
            cpoe_tipo_pedido    ctp,
            cpoe_procedimento   cp,
            PRESCR_PROCEDIMENTO pp,prescr_proc_hor ph
        WHERE
            nr_seq_sub_grp = nr_seq_sub_grp_p
            AND cp.nr_seq_proc_interno = po.nr_seq_proc_interno
            AND ctp.nr_sequencia = po.nr_seq_order_type
           and	cp.nr_sequencia=nr_sequencia_p
             and (cp.DT_LIBERACAO IS NOT NULL AND cp.DT_LIBERACAO::text <> '')
             and  pp.CD_PROCEDIMENTO = ph.CD_PROCEDIMENTO and pp.nr_prescricao = ph.nr_prescricao
             and cp.nr_sequencia= pp.NR_SEQ_PROC_CPOE
    and coalesce(cp.DT_SUSPENSAO::text, '') = ''
    and ph.ds_horario >=  to_Char(start_time_p,'hh24:mi:ss')
    and ph.ds_horario <= to_Char(end_time_p,'hh24:mi:ss')
           and cp.nr_atendimento=nr_atendimento_p);

  RETURN ds_others_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_presc_proc_type ( nr_seq_sub_grp_p text, nr_sequencia_p text, nr_atendimento_p bigint, start_time_p timestamp, end_time_p timestamp ) FROM PUBLIC;

