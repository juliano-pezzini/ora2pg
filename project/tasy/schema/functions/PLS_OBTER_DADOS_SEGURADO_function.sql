-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_segurado ( nr_seq_segurado_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Obter dados do segurado
----------------------------------------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  ]  Objetos do dicionario [ x ] Tasy (Delphi/Java) [ x ] Portal [  ] Relatorios [ ] Outros:
 ----------------------------------------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	
	N - Nome do segurado
	NS - Nome social
	NST - Nome social (TISS - retorna NM_SOCIAL.PESSOA_FISICA)
	C - Carteirinha do usuario
	D - Data de contratacao
	DA - Data de Admissao do segurado
	P - Produto
	PG - Pagador
	CBOS - Codigo brasileiro de ocupacao de saude
	CNS - Cartao nacional de saude
	V - Data de validade do cartao
	I - Data de inclusao na operadora
	NAS - Data de nascimento
	CO - Data do contrato
	ES - Estipulante do contrato
	TC - Tipo contratacao
	TCC - Tipo contratacao Codigo
	DB - Data base do contrato
	DS - Descricao da Situacao
	CS - Codigo da situacao
	T - Tabela de preco
	DT - Descricao da tabela de preco
	DR - Data de rescisao
	NC - Numero de sequencia do contrato (PLS_CONTRATO.NR_SEQUENCIA)
	CC - Numero do contrato (PLS_CONTRATO.NR_CONTRATO)
	PF - Codigo da pessoa fisica do segurado
	E - Email
	EST - Estabelecimento
	CA - Carteira do sistema anterior
	VE -Vendedor
	CV - Canal de venda
	NVE -Nome vendedor
	NCV - Nome Canal de venda
	NT - Nome titular
	VS - Vinculo estipulante
	NCP - Nome contratante principal
	TI - Titularidade
	SU - Subestipulante
	SB - Sequencia do subestipulante
	ID - Idade em anos. ex: 18
	TP - Tipo de beneficiario
	VPF - Vendedor PF
	CI - Numero da carteira de intercambio do beneficiario
	DVDE - Data validade documento escolaridade
	IED - Retorna Sim ou Nao, se o beneficiario e um deficiente
	SXS - Sexo Sigla ('M', 'F', 'I')
	SXD - Sexo Descricao ('Masculino', 'Feminino', 'Indeterminado')
	NRP - Sequencia do produto do beneficiario
	DMR - Descricao do motivo de cancelamento
	CME - Matricula do estipulante (pls_segurado cd_matricula_estipulante)
	IV - Data de inicio da vigencia da carteirinha
	CPF - CPF do segurado
	CON - Congenere
	NRCON - Sequencia da congenere
	NRTI - Sequencia do titular
	TCD - Telefone celular com ddd
	CR - Carteira conforme repasse - Utilizada na OPS - Autorizacao e OPSW - Autorizacoes
	PCMSO - Obter se o beneficiario e um de PCMSO
	DSPCMSO - Obter se o beneficiario e um de PCMSO na forma de "Sim" ou "Nao
	MF - Matricula familiar
	RG - Registro Geral
	RPL - Regulamentacao do Plano.
	TCI - Tipo do contrato de Intercambio
	NRCI - Numero do contrato de Intercambio
	CDE - Codigo operadora empresa
	NEAF - Numero de agrupamento de empresa por Ops - Fatura
	CPFPS - Codigo pessoa fisica pagador do segurado
	TEPS - Tipo de endereco do pagador do segurado
	TES - Tipo de estipulante
	CLAS - Classificacao do beneficiario
	ABR - Abrangencia do produto do beneficiario
	TRP - Tipo do Repasse
	DSC - Descricao do contrato
	CSA - Cartao sistema anterior
	CCO - CCO
	CE - Codigo de Estipulante
	VIA - Via carteirinha
	SIC - Situacao carteirinha
	ACC - Codigo tipo acomodacao
	CM - Carteria do usuario com mascara
	DMI - Descricao do motivo de inclusao
	ORT - Operadora repasse compartilhamento de risco
*/ds_retorno_w				varchar(255);
nr_seq_carteira_w			bigint;
ds_tipo_contratacao_w			varchar(100);
dt_liberacao_w				timestamp;
dt_migracao_w				timestamp;
dt_rescisao_w				timestamp;
dt_limite_utilizacao_w			timestamp;
qt_deficiencia_w			bigint;
nr_seq_motivo_cancelamento_w		bigint;
dt_cancelamento_w			timestamp;
nr_seq_contrato_w			bigint;
qt_cpt_w				bigint;
cd_operadora_empresa_w			pls_segurado.cd_operadora_empresa%type;
ie_carteira_atual_w			pls_segurado_repasse.ie_carteira_atual%type;
cd_cartao_ident_ans_sist_ant_w		pls_segurado.cd_cartao_ident_ans_sist_ant%type;
nr_seq_emissor_w			pls_segurado_carteira.nr_seq_emissor%type;
cd_usuario_plano_w			pls_segurado_carteira.cd_usuario_plano%type;
ie_pf_pj_w				varchar(2);
cd_estabelecimento_w			estabelecimento.cd_estabelecimento%type;
nr_seq_emissor_contrato_w		pls_contrato.nr_seq_emissor%type;
ds_mascara_w				pls_regra_carteira.ds_mascara%type;
str					varchar(1);
vl_atributo_aux_w			varchar(255);
ind					bigint;
vl_atributo_w				varchar(2000);
nr_seq_motivo_inclusao_w		pls_segurado.nr_seq_motivo_inclusao%type;
nr_seq_segurado_repasse_w		pls_segurado_repasse.nr_sequencia%type;

BEGIN

if (coalesce(nr_seq_segurado_p::text, '') = '') then
	return null;
end if;

if (ie_opcao_p	= 'N') then
	select	max(nm_pessoa_fisica)
	into STRICT	ds_retorno_w
	from (	SELECT	b.nm_pessoa_fisica
			from	pls_segurado a,
				pessoa_fisica b
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	a.nr_sequencia		= nr_seq_segurado_p) alias2;
elsif (ie_opcao_p	= 'NS') then
	select	max(tws_get_name_person(a.cd_pessoa_fisica, a.cd_estabelecimento))
	into STRICT	ds_retorno_w
	from	pls_segurado a
	where	a.nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'NST') then
	select	max(nm_social)
	into STRICT	ds_retorno_w
	from (	SELECT	b.nm_social
			from	pls_segurado a,
				pessoa_fisica b
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	a.nr_sequencia		= nr_seq_segurado_p) alias2;
elsif (ie_opcao_p	= 'C') then
	select	max(cd_usuario_plano)
	into STRICT	ds_retorno_w
	from	pls_segurado_carteira a,
		pls_segurado b
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p = 'D') then
	SELECT	PKG_DATE_FORMATERS.TO_VARCHAR(dt_contratacao, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p = 'DA') then
	select	PKG_DATE_FORMATERS.TO_VARCHAR(a.dt_admissao, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario)
	into STRICT	ds_retorno_w
	from	pls_segurado_compl a,
		pls_segurado b
	where	a.nr_seq_segurado = b.nr_sequencia
	and	b.nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'P') then
	select	b.ds_plano
	into STRICT	ds_retorno_w
	from	pls_segurado a,
		pls_plano b
	where	a.nr_seq_plano	= b.nr_sequencia
	and	a.nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'PG') then
	select	substr(pls_obter_dados_pagador(nr_seq_pagador,'N'),1,255)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p = 'CBOS') then
	select	substr(obter_dados_pf(cd_pessoa_fisica,'CBOS'),1,5)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p = 'CNS') then
	select	nr_cartao_nac_sus
	into STRICT	ds_retorno_w
	from	pessoa_fisica	b,
		pls_segurado	a
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p 	= 'V') then
	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_carteira_w
	from	pls_segurado_carteira
	where	nr_seq_segurado	= nr_seq_segurado_p;
	
	if (nr_seq_carteira_w > 0) then
		select	PKG_DATE_FORMATERS.TO_VARCHAR(dt_validade_carteira, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario)
		into STRICT	ds_retorno_w
		from	pls_segurado_carteira
		where	nr_sequencia	= nr_seq_carteira_w;
	end if;
elsif (ie_opcao_p 	= 'I') then
	SELECT	PKG_DATE_FORMATERS.TO_VARCHAR(dt_inclusao_operadora, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'NAS') then
	select	PKG_DATE_FORMATERS.TO_VARCHAR(b.dt_nascimento, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario)
	into STRICT	ds_retorno_w
	from	pessoa_fisica	b,
		pls_segurado	a
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'CO') then
	select	PKG_DATE_FORMATERS.TO_VARCHAR(b.dt_contrato, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario)
	into STRICT	ds_retorno_w
	from	pls_contrato b,
		pls_segurado a
	where	a.nr_seq_contrato	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'ES') then
	
	select	nr_seq_contrato
	into STRICT	nr_seq_contrato_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
	
	if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
		select	substr(obter_nome_pf_pj(b.cd_pf_estipulante,b.cd_cgc_estipulante),1,80)
		into STRICT	ds_retorno_w
		from	pls_contrato b,
			pls_segurado a
		where	a.nr_seq_contrato	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_segurado_p;
	else
		select	substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,80)
		into STRICT	ds_retorno_w
		from	pls_intercambio b,
			pls_segurado a
		where	a.nr_seq_intercambio	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_segurado_p;
	end if;
elsif (ie_opcao_p	= 'CE') then
	
	select	nr_seq_contrato
	into STRICT	nr_seq_contrato_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
	
	if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
		select	substr(coalesce(b.cd_pf_estipulante,b.cd_cgc_estipulante),1,80)
		into STRICT	ds_retorno_w
		from	pls_contrato b,
			pls_segurado a
		where	a.nr_seq_contrato	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_segurado_p;
	else
		select	substr(coalesce(b.cd_pessoa_fisica,b.cd_cgc),1,80)
		into STRICT	ds_retorno_w
		from	pls_intercambio b,
			pls_segurado a
		where	a.nr_seq_intercambio	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_segurado_p;
	end if;
elsif (ie_opcao_p	= 'TC') then
	select	substr(pls_obter_dados_produto(nr_seq_plano,'C'),1,255)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'DB') then
	select	CASE WHEN b.ie_reajuste='C' THEN wheb_mensagem_pck.get_texto(1174651)  ELSE wheb_mensagem_pck.get_texto(1174652) END
	into STRICT	ds_retorno_w
	from	pls_contrato b,
		pls_segurado a
	where	a.nr_seq_contrato	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p	in ('DS','CS')) then
	select	dt_liberacao,
		dt_migracao,
		dt_rescisao,
		dt_limite_utilizacao,
		dt_cancelamento
	into STRICT	dt_liberacao_w,
		dt_migracao_w,
		dt_rescisao_w,
		dt_limite_utilizacao_w,
		dt_cancelamento_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
	
	if (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') and (coalesce(dt_cancelamento_w::text, '') = '') and
		((coalesce(dt_rescisao_w::text, '') = '') or ((dt_rescisao_w IS NOT NULL AND dt_rescisao_w::text <> '') and (coalesce(dt_limite_utilizacao_w,dt_rescisao_w) >= clock_timestamp()))) then
		if (ie_opcao_p	= 'DS') then
			ds_retorno_w := obter_desc_expressao(894905,wheb_usuario_pck.get_nr_seq_idioma);
		else
			ds_retorno_w := 'A';
		end if;
	elsif	((dt_rescisao_w IS NOT NULL AND dt_rescisao_w::text <> '') or (dt_cancelamento_w IS NOT NULL AND dt_cancelamento_w::text <> '')) then
		if (ie_opcao_p	= 'DS') then
			ds_retorno_w := obter_desc_expressao(319239,wheb_usuario_pck.get_nr_seq_idioma);
		else
			ds_retorno_w := 'I';
		end if;
	elsif (coalesce(dt_liberacao_w::text, '') = '') and (dt_migracao_w IS NOT NULL AND dt_migracao_w::text <> '') and (coalesce(dt_rescisao_w::text, '') = '') and (coalesce(dt_cancelamento_w::text, '') = '') then
		if (ie_opcao_p	= 'DS') then
			ds_retorno_w := obter_desc_expressao(331187,wheb_usuario_pck.get_nr_seq_idioma);
		else
			ds_retorno_w := 'M';
		end if;
	elsif (coalesce(dt_liberacao_w::text, '') = '') and (coalesce(dt_migracao_w::text, '') = '') then
		if (ie_opcao_p	= 'DS') then
			ds_retorno_w := obter_desc_expressao(330512,wheb_usuario_pck.get_nr_seq_idioma);
		else
			ds_retorno_w := 'D';
		end if;
	end if;
elsif (ie_opcao_p	= 'T') then
	select	to_char(nr_seq_tabela)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'DT') then
	select	nm_tabela
	into STRICT	ds_retorno_w
	from	pls_segurado	a,
		pls_tabela_preco b
	where	a.nr_seq_tabela	= b.nr_sequencia
	and	a.nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'DR') then
	select	PKG_DATE_FORMATERS.TO_VARCHAR(dt_rescisao, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'NC') then
	select	to_char(nr_seq_contrato)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'PF') then
	select	cd_pessoa_fisica
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'E') then
	begin
		select	ds_email
		into STRICT	ds_retorno_w
		from	pls_segurado		a,
			pessoa_fisica		b,
			compl_pessoa_fisica	c
		where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
		and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	a.nr_sequencia		= nr_seq_segurado_p
		and	c.ie_tipo_complemento = 1;
	exception
		when others then
			ds_retorno_w		:= null;
	end;
elsif (ie_opcao_p	= 'EST') then
	select	cd_estabelecimento
	into STRICT	ds_retorno_w
	from	pls_plano
	where	nr_sequencia = (SELECT	nr_seq_plano
				from	pls_segurado
				where	nr_sequencia = nr_seq_segurado_p);
elsif (ie_opcao_p	= 'CA') then
	select	coalesce(max(cd_usuario_ant),0)
	into STRICT	ds_retorno_w
	from	pls_segurado_cart_ant
	where	nr_seq_segurado	= nr_seq_segurado_p
	and	ie_sistema_anterior = 'S';
elsif (ie_opcao_p	= 'VE') then
	select	nr_seq_vendedor_pf
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'NVE') then
	select	c.nm_pessoa_fisica
	into STRICT	ds_retorno_w
	from	pls_segurado a,
		pls_vendedor b,
		pessoa_fisica c
	where	a.nr_seq_vendedor_canal	= b.nr_sequencia
	and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
	and	a.nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'CV') then
	select	to_char(nr_seq_vendedor_canal)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'NCV') then
	select	substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,200)
	into STRICT	ds_retorno_w
	from	pls_segurado a,
		pls_vendedor b
	where	a.nr_seq_vendedor_canal	= b.nr_sequencia
	and	a.nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'NT') then
	select	c.nm_pessoa_fisica
	into STRICT	ds_retorno_w
	from	pls_segurado a,
		pls_segurado b,
		pessoa_fisica c
	where	a.nr_seq_titular	= b.nr_sequencia
	and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'VS') then
	select	ds_vinculo
	into STRICT	ds_retorno_w
	from	pls_segurado		a,
		pls_vinculo_estipulante	b
	where	a.nr_seq_vinculo_est	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'NCP') then
	select	max(c.nm_pessoa_fisica)
	into STRICT	ds_retorno_w
	from	pls_segurado a,
		pls_segurado b,
		pessoa_fisica c
	where	a.nr_sequencia	= b.nr_seq_contratante_princ
	and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
	and	a.nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'TI') then
	select	CASE WHEN coalesce(nr_seq_titular::text, '') = '' THEN obter_desc_expressao(300089,wheb_usuario_pck.get_nr_seq_idioma)  ELSE obter_desc_expressao(287413,wheb_usuario_pck.get_nr_seq_idioma) END
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'SU') then
	select	substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,200)
	into STRICT	ds_retorno_w
	from	pls_segurado a,
		pls_sub_estipulante b
	where	b.nr_sequencia	= a.nr_seq_subestipulante
	and	a.nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'SB') then
	select	to_char(a.nr_seq_subestipulante)
	into STRICT	ds_retorno_w
	from	pls_segurado a
	where	a.nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'ID') then
	select	Obter_Idade(b.dt_nascimento,clock_timestamp(),'A')
	into STRICT	ds_retorno_w
	from	pessoa_fisica	b,
		pls_segurado	a
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'TP') then
	select	ie_tipo_segurado
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'VPF') then
	select	c.nm_pessoa_fisica
	into STRICT	ds_retorno_w
	from	pls_segurado		a,
		pls_vendedor_vinculado	b,
		pessoa_fisica		c
	where	a.nr_seq_vendedor_pf	= b.nr_sequencia
	and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'CI') then
	select	max(a.nr_cartao_intercambio)
	into STRICT	ds_retorno_w
	from	pls_segurado_carteira a,
		pls_segurado b
	where	b.nr_sequencia	= a.nr_seq_segurado
	and	b.nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'CC') then
	select	b.nr_contrato
	into STRICT	ds_retorno_w
	from	pls_segurado	a,
		pls_contrato	b
	where	a.nr_seq_contrato	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'DSC') then
	select	b.ds_contrato
	into STRICT	ds_retorno_w
	from	pls_segurado	a,
		pls_contrato	b
	where	a.nr_seq_contrato	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'DVDE') then
	select	max(c.dt_validade)
	into STRICT	ds_retorno_w
	from	pessoa_fisica		a,
		pls_segurado		b,
		pls_tipo_documento_pf	c,
		tipo_documentacao	d
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
	and	c.nr_seq_tipo_documento = d.nr_sequencia
	and	d.ie_escolaridade	= 'S'
	and	b.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'IED') then
	select	count(*)
	into STRICT	qt_deficiencia_w
	from	pls_segurado		a,
		pessoa_fisica		b,
		pf_tipo_deficiencia	c
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	c.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.nr_sequencia		= nr_seq_segurado_p;
	
	if (qt_deficiencia_w > 0) then
		ds_retorno_w	:= obter_desc_expressao(719927,wheb_usuario_pck.get_nr_seq_idioma);
	else
		ds_retorno_w	:= obter_desc_expressao(327114,wheb_usuario_pck.get_nr_seq_idioma);
	end if;
elsif (ie_opcao_p	= 'SXS') then
	select	max(b.ie_sexo)
	into STRICT	ds_retorno_w
	from	pessoa_fisica	b,
		pls_segurado	a
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'SXD') then
	select	max(b.ie_sexo)
	into STRICT	ds_retorno_w
	from	pessoa_fisica	b,
		pls_segurado	a
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.nr_sequencia		= nr_seq_segurado_p;
	
	if (ds_retorno_w = 'M') then
		ds_retorno_w	:= obter_desc_expressao(292932,wheb_usuario_pck.get_nr_seq_idioma);
	elsif (ds_retorno_w = 'F') then
		ds_retorno_w	:= obter_desc_expressao(290058,wheb_usuario_pck.get_nr_seq_idioma);
	elsif (ds_retorno_w = 'I') then
		ds_retorno_w	:= obter_desc_expressao(291833,wheb_usuario_pck.get_nr_seq_idioma);
	end if;
elsif (ie_opcao_p = 'NRP') then
	select	max(nr_seq_plano)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p = 'DMR') then
	begin
	select	max(nr_seq_motivo_cancelamento)
	into STRICT	nr_seq_motivo_cancelamento_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
	exception
	when others then
		nr_seq_motivo_cancelamento_w	:= null;
	end;
	if (nr_seq_motivo_cancelamento_w IS NOT NULL AND nr_seq_motivo_cancelamento_w::text <> '') then
		select	ds_motivo_cancelamento
		into STRICT	ds_retorno_w
		from	pls_motivo_cancelamento
		where	nr_sequencia	= nr_seq_motivo_cancelamento_w;
	end if;
elsif (ie_opcao_p = 'CME') then
	select	max(cd_matricula_estipulante)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p	= 'IV') then
	begin
	SELECT	PKG_DATE_FORMATERS.TO_VARCHAR(dt_inicio_vigencia, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario)
	into STRICT	ds_retorno_w
	from	pls_segurado_carteira
	where	nr_seq_segurado	= nr_seq_segurado_p;
	exception
	when others then
		ds_retorno_w	:= '';
	end;
elsif (ie_opcao_p  = 'CPF') then
	select	max(b.nr_cpf)
	into STRICT	ds_retorno_w
	from	pessoa_fisica	b,
		pls_segurado	a
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p  = 'RG') then
	select	max(b.nr_identidade)
	into STRICT	ds_retorno_w
	from	pessoa_fisica	b,
		pls_segurado	a
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p  = 'CON') then
	select	max(a.nr_seq_congenere)
	into STRICT	ds_retorno_w
	from	pls_segurado	a
	where	a.nr_sequencia		= nr_seq_segurado_p;
	
	if (coalesce(ds_retorno_w,'X') <> 'X') then
		ds_retorno_w := to_char(pls_obter_cd_seq_congenere(ds_retorno_w, 'CD'),'0000')||' - '||pls_obter_nome_congenere(ds_retorno_w);
	end if;
elsif (ie_opcao_p  = 'CODCON') then
	select	max(a.nr_seq_congenere)
	into STRICT	ds_retorno_w
	from	pls_segurado	a
	where	a.nr_sequencia		= nr_seq_segurado_p;
	
	if (coalesce(ds_retorno_w,'X') <> 'X') then
		ds_retorno_w := pls_obter_cd_seq_congenere(ds_retorno_w,'CD');
	end if;
elsif (ie_opcao_p	= 'NRTI') then
	select	max(nr_seq_titular)
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p  = 'NRCON') then
	select	max(a.nr_seq_congenere)
	into STRICT	ds_retorno_w
	from	pls_segurado	a
	where	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p  = 'TCD') then
	select	obter_dados_pf(a.cd_pessoa_fisica, 'TCD')
	into STRICT	ds_retorno_w
	from	pls_segurado	a
	where	a.nr_sequencia		= nr_seq_segurado_p;
elsif (ie_opcao_p  = 'CR') then
	select	max(ie_carteira_atual)
	into STRICT	ie_carteira_atual_w
	from 	pls_segurado_repasse a
	where 	a.nr_seq_segurado = nr_seq_segurado_p
	and 	clock_timestamp() > a.dt_repasse
	and (coalesce(a.dt_fim_repasse::text, '') = ''
	or  	clock_timestamp() <= a.dt_fim_repasse);
	
	if ( coalesce(ie_carteira_atual_w,'N') = 'N') then
		/* Tratamento feito para retornar o codigo da carteira de intercambio para beneficiarios repassados em Custo  operacional */

		select 	max(a.nr_cartao_intercambio)
		into STRICT	ds_retorno_w
		from	pls_segurado_Carteira a,
			pls_segurado b
		where 	b.nr_sequencia 		= a.nr_seq_segurado
		and	b.ie_tipo_repasse  	= 'C'
		and	b.ie_tipo_segurado 	in ('T','H','I') -- Verificado com Lepinski o usuario habitual nao deve ter cd_usuario_plano da pls_segurado_carteira
		and	b.nr_sequencia 		= nr_seq_segurado_p;
		
		if ( coalesce(ds_retorno_w::text, '') = '' ) then
			select	max(cd_usuario_plano)
			into STRICT	ds_retorno_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	b.nr_sequencia		= nr_seq_segurado_p;
		end if;
	else
		select	max(cd_usuario_plano)
		into STRICT	ds_retorno_w
		from	pls_segurado_carteira a
		where 	a.nr_seq_segurado	= nr_seq_segurado_p;
	end if;
elsif (ie_opcao_p  = 'PCMSO') then
	begin
		select	coalesce(ie_pcmso,'N')
		into STRICT	ds_retorno_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_p;
	exception
	when others then
		ds_retorno_w	:= 'N';
	end;
elsif (ie_opcao_p  = 'DSPCMSO') then
	begin
		select	CASE WHEN coalesce(ie_pcmso,'N')='N' THEN  wheb_mensagem_pck.get_texto(1174653)  ELSE wheb_mensagem_pck.get_texto(1174654) END
		into STRICT	ds_retorno_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_p;
	exception
	when others then
		ds_retorno_w	:= 'N';
	end;
elsif (ie_opcao_p = 'MF') then
	begin
	select	cd_matricula_familia
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia = nr_seq_segurado_p;
	exception
	when others then
		ds_retorno_w := '';
	end;
elsif (ie_opcao_p = 'CPT') then
	begin
	select	count(1)
	into STRICT	qt_cpt_w
	from	pls_carencia		a
	where	a.nr_seq_segurado	= nr_seq_segurado_p
	and	a.ie_cpt		= 'S';
	
	if (qt_cpt_w > 0) then
		ds_retorno_w := wheb_mensagem_pck.get_texto(1174654); --Sim
	else
		ds_retorno_w := wheb_mensagem_pck.get_texto(1174653); --Nao
	end if;
	end;
elsif (ie_opcao_p = 'RPL') then
	select	max(substr(pls_obter_dados_produto(nr_seq_plano,'R'),1,255))
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia = nr_seq_segurado_p;
elsif (ie_opcao_p = 'TCC') then
	select	max(substr(pls_obter_dados_produto(nr_seq_plano,'CC'),1,255))
	into STRICT	ds_retorno_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
-- Tipo do contrato de Intercambio
elsif (ie_opcao_p = 'TCI') then
	if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') then
		-- Obter o tipo de contrato de Intercambio
		select	pls_obter_dados_intercambio(max(a.nr_seq_intercambio),'TP')
		into STRICT	ds_retorno_w
		from	pls_segurado a
		where	a.nr_sequencia = nr_seq_segurado_p;
	end if;
-- Numero do contrato de intercambio
elsif (ie_opcao_p = 'NRCI') then
	if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '')  then
		select	max(a.nr_seq_intercambio)
		into STRICT	ds_retorno_w
		from	pls_segurado a
		where	a.nr_sequencia	= nr_seq_segurado_p;
	end if;
-- Codigo operadora empresa
elsif (ie_opcao_p = 'CDE') then
	select	max(a.cd_operadora_empresa)
	into STRICT	ds_retorno_w
	from	pls_segurado a
	where	a.nr_sequencia	= nr_seq_segurado_p;
-- NEAF - Numero de agrupamento de empresa por Ops - Fatura
elsif (ie_opcao_p = 'NEAF') then
	ds_retorno_w := null;
	
	select	max(a.cd_operadora_empresa)
	into STRICT	cd_operadora_empresa_w
	from	pls_segurado a
	where	a.nr_sequencia	= nr_seq_segurado_p;
	
	if (cd_operadora_empresa_w IS NOT NULL AND cd_operadora_empresa_w::text <> '') then
		select	max(nr_agrupamento)
		into STRICT	ds_retorno_w
		from	pls_regra_divisao_fat_emp
		where	cd_empresa_regra = cd_operadora_empresa_w;
	end if;
-- CPFPS-  Codigo pessoa fisica pagador do segurado
elsif (ie_opcao_p = 'CPFPS') then
	ds_retorno_w := null;
	
	select 	y.cd_pessoa_fisica cd_pessoa_fisica_pagador
	into STRICT	ds_retorno_w
	from 	pls_contrato_pagador y,
		pls_segurado x
	where	x.nr_seq_pagador = y.nr_sequencia
	and	x.nr_sequencia = nr_seq_segurado_p;
--TEPS - Tipo de endereco do pagador do segurado
elsif (ie_opcao_p = 'TEPS') then
	select 	b.ie_endereco_boleto
	into STRICT	ds_retorno_w
	from 	pls_contrato_pagador b,
		pls_segurado a
	where	a.nr_seq_pagador = b.nr_sequencia
	and	a.nr_sequencia = nr_seq_segurado_p;
--CLAS - Classificacao do beneficiario
elsif (ie_opcao_p = 'CLAS') then
	select 	max(a.nr_seq_classificacao)
	into STRICT	ds_retorno_w
	from 	pls_segurado a
	where	a.nr_sequencia = nr_seq_segurado_p;
elsif (ie_opcao_p = 'ABR') then
	select	max(pls_obter_dados_produto(nr_seq_plano, 'A'))
	into STRICT	ds_retorno_w
	from	pls_segurado a
	where	a.nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p = 'TRP') then
	select	max(obter_valor_dominio(3384,a.ie_tipo_repasse))
	into STRICT	ds_retorno_w
	from	pls_segurado a
	where	a.nr_sequencia		= nr_seq_segurado_p
	and	coalesce(nr_seq_intercambio::text, '') = '';

	if (coalesce(ds_retorno_w::text, '') = '') then
		select	max(obter_valor_dominio(3384,a.ie_tipo_repasse))
		into STRICT	ds_retorno_w
		from	pls_segurado_repasse a
		where	a.nr_seq_segurado	= nr_seq_segurado_p
		and	trunc(clock_timestamp(), 'dd') between trunc(a.dt_repasse) and (a.dt_fim_repasse);
	end if;
elsif (ie_opcao_p	= 'TES') then
	
	select	nr_seq_contrato
	into STRICT	nr_seq_contrato_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
	
	if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
		select	substr(coalesce(CASE WHEN coalesce(b.cd_pf_estipulante::text, '') = '' THEN wheb_mensagem_pck.get_texto(1174656)  ELSE wheb_mensagem_pck.get_texto(1174655) END , ''),1,80)
		into STRICT	ds_retorno_w
		from	pls_contrato b,
			pls_segurado a
		where	a.nr_seq_contrato	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_segurado_p;
	end if;
elsif (ie_opcao_p = 'CSA') then --Cartao sistema anterior
	select	max(a.cd_cartao_ident_ans_sist_ant)
	into STRICT	cd_cartao_ident_ans_sist_ant_w
	from	pls_segurado a
	where	nr_sequencia	= nr_seq_segurado_p;
	
	ds_retorno_w := substr(to_char(cd_cartao_ident_ans_sist_ant_w),1,50);
elsif (ie_opcao_p = 'CCO') then -- CCO
	select	max(a.nr_cco)
	into STRICT	ds_retorno_w
	from	pls_segurado a
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (ie_opcao_p = 'VIA') then -- VIA
	select  max(nr_via_solicitacao)
	into STRICT	ds_retorno_w
	from	pls_segurado_carteira
	where   nr_seq_segurado  = nr_seq_segurado_p;
elsif (ie_opcao_p = 'SIC') then -- SIC
	select	max(ie_situacao)
	into STRICT	ds_retorno_w
	from	pls_segurado_carteira
	where	nr_seq_segurado = nr_seq_segurado_p;
elsif (ie_opcao_p = 'ACC') then -- ACC	
	select max(pa.nr_seq_tipo_acomodacao)
	  into STRICT ds_retorno_w
	  from pls_segurado ps
	 inner join pls_plano pl on ps.nr_seq_plano = pl.nr_sequencia
	 inner join pls_plano_acomodacao pa on pl.nr_sequencia = pa.nr_seq_plano
	 where ps.nr_sequencia = nr_seq_segurado_p
	   and pa.ie_acomod_padrao = 'S';
elsif (ie_opcao_p = 'CM') then --CM
	select	CASE WHEN coalesce(cd_pf_estipulante::text, '') = '' THEN  'PJ'  ELSE 'PF' END ,
		a.nr_seq_emissor,
		b.cd_estabelecimento,
		c.cd_usuario_plano
	into STRICT	ie_pf_pj_w,
		nr_seq_emissor_contrato_w,
		cd_estabelecimento_w,
		cd_usuario_plano_w
	from	pls_contrato a,
		pls_segurado b,
		pls_segurado_carteira c
	where	a.nr_sequencia = b.nr_seq_contrato
	and	b.nr_sequencia = c.nr_seq_segurado
	and	b.nr_sequencia = nr_seq_segurado_p;

	select	max(nr_seq_emissor)
	into STRICT	nr_seq_emissor_w
	from	pls_segurado_carteira
	where	nr_seq_segurado = nr_seq_segurado_p;
	
	if (coalesce(nr_seq_emissor_w::text, '') = '') then
		if (nr_seq_emissor_contrato_w IS NOT NULL AND nr_seq_emissor_contrato_w::text <> '') then
			nr_seq_emissor_w	:= nr_seq_emissor_contrato_w;
		else
			select	max(nr_seq_emissor)
			into STRICT	nr_seq_emissor_w
			from	pls_parametros
			where	cd_estabelecimento = cd_estabelecimento_w;
		end if;
	end if;

	select	max(ds_mascara)
	into STRICT	ds_mascara_w
	from	pls_regra_carteira
	where	nr_seq_emissor = nr_seq_emissor_w
	and	ie_tipo_estipulante = 'A';
	
	if (coalesce(ds_mascara_w::text, '') = '') then
		select	max(ds_mascara)
		into STRICT	ds_mascara_w
		from	pls_regra_carteira
		where	nr_seq_emissor = nr_seq_emissor_w
		and	ie_tipo_estipulante = ie_pf_pj_w;
	end if;
	
	vl_atributo_w	:= cd_usuario_plano_w;

	if (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') and (cd_usuario_plano_w IS NOT NULL AND cd_usuario_plano_w::text <> '') then
		str			:= '';
		vl_atributo_aux_w	:= '';
		ind			:= 1;
		for i in 1..length(ds_mascara_w) loop
			begin
			str	:= substr(ds_mascara_w, i, 1);
			if (regexp_like(str, '[A-Z,0-9]')) then
				vl_atributo_aux_w := vl_atributo_aux_w || substr(vl_atributo_w, ind, 1);
				ind 		  := ind + 1;
			else
				vl_atributo_aux_w := vl_atributo_aux_w || str;
			end if;
			end;
		end loop;
		vl_atributo_w := vl_atributo_aux_w;
	end if;
	
	ds_retorno_w := vl_atributo_w;
elsif (ie_opcao_p = 'DMI') then
	begin
	select	max(nr_seq_motivo_inclusao)
	into STRICT	nr_seq_motivo_inclusao_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
	exception
	when others then
		nr_seq_motivo_inclusao_w	:= null;
	end;
	if (nr_seq_motivo_inclusao_w IS NOT NULL AND nr_seq_motivo_inclusao_w::text <> '') then
		select	max(ds_motivo)
		into STRICT	ds_retorno_w
		from	pls_motivo_inclusao_seg
		where	nr_sequencia	= nr_seq_motivo_inclusao_w;
	end if;
	
elsif (ie_opcao_p = 'ORT') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_segurado_repasse_w
	from	pls_segurado_repasse
	where	nr_seq_segurado	= nr_seq_segurado_p
	and	ie_tipo_compartilhamento = 1
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
	
	if (nr_seq_segurado_repasse_w IS NOT NULL AND nr_seq_segurado_repasse_w::text <> '') then
		select	substr(pls_obter_nome_congenere(nr_seq_congenere),1,255)
		into STRICT	ds_retorno_w
		from	pls_segurado_repasse
		where	nr_sequencia	= nr_seq_segurado_repasse_w;
	else
		ds_retorno_w	:= null;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_segurado ( nr_seq_segurado_p bigint, ie_opcao_p text) FROM PUBLIC;

