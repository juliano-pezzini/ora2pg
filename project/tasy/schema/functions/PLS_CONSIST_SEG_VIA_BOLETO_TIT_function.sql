-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_consist_seg_via_boleto_tit ( nr_seq_pagador_p bigint, dt_recalculo_p timestamp, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
dt_vencimento_w			timestamp;
dt_limite_w			timestamp;
dt_ultimo_vencimento_w		timestamp;
ie_permite_recalculo_w		varchar(1) := 'N';
qt_titulos_w			integer;
qt_dias_limite_prorrogacao_w	pls_parametros.qt_dias_limite_prorrogacao%type;
			

BEGIN 
if (nr_seq_pagador_p IS NOT NULL AND nr_seq_pagador_p::text <> '') and (trunc(dt_recalculo_p, 'dd') >= trunc(clock_timestamp(),'dd')) then	 
	select	coalesce(max(qt_dias_limite_prorrogacao),0) 
	into STRICT	qt_dias_limite_prorrogacao_w 
	from	pls_parametros 
	where	cd_estabelecimento = cd_estabelecimento_p;	
	 
	select 	count(1), 
		trunc(max(dt_pagamento_previsto), 'dd'), 
		min(dt_pagamento_previsto) 
	into STRICT	qt_titulos_w, 
		dt_ultimo_vencimento_w, 
		dt_vencimento_w 
	from	titulo_receber 
	where	nr_seq_pagador 	= nr_seq_pagador_p 
	and	ie_situacao 	= '1' 
	and	(nr_seq_mensalidade IS NOT NULL AND nr_seq_mensalidade::text <> '');
	 
	if (qt_titulos_w < 3) then 
		dt_limite_w := trunc(dt_vencimento_w,'dd') + qt_dias_limite_prorrogacao_w;
	elsif (qt_titulos_w = 3) and (dt_ultimo_vencimento_w <= trunc(dt_recalculo_p,'dd')) then -- Se possuir 2 títulos vencidos e 1 a vencer utiliza a data do último vencimento 
		dt_limite_w := dt_ultimo_vencimento_w;
	end if;
	 
	if (dt_limite_w <= trunc(dt_recalculo_p, 'dd')) then /* Limite de X dias para o a geração da segunda via para o título aberto mais antigo do pagador */
 
		if	((obter_se_feriado(cd_estabelecimento_p, dt_limite_w) > 0) or 
			to_char(dt_limite_w, 'd') in (1,7)) and (obter_proximo_dia_util(cd_estabelecimento_p, dt_limite_w) >= trunc(dt_recalculo_p, 'dd')) then /* Caso o dia limite do vencimento for final de semana ou feriado, permitir recalcular para o próximo dia útil. */
 
			ie_permite_recalculo_w := 'S';
		elsif (qt_titulos_w >= 3) then 
			ie_permite_recalculo_w := 'M'; -- Se possuir 3 títulos vencidos, apresenta mensagem e não deixa imprimir o boleto. 
		else
			ie_permite_recalculo_w := 'N';
		end if;
	else	 
		ie_permite_recalculo_w := 'S';
	end if;
end if;
 
return 	ie_permite_recalculo_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_consist_seg_via_boleto_tit ( nr_seq_pagador_p bigint, dt_recalculo_p timestamp, cd_estabelecimento_p bigint) FROM PUBLIC;

