-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_exige_cpf_doc_estr (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(2)	:= 'N';
ie_brasileiro_w		varchar(2)	:= 'S';
qt_idade_paciente_w	smallint;
nr_rg_estrangeiro_w 	pessoa_fisica.nr_reg_geral_estrang%type;
nr_passaporte_w		pessoa_fisica.nr_passaporte%type := '1';
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
nr_cpf_w		pessoa_fisica.nr_cpf%type;
cd_nacionalidade_w	pessoa_fisica.cd_nacionalidade%type;
cd_pessoa_responsavel_w pessoa_fisica.cd_pessoa_fisica%type;
dt_nascimento_w		pessoa_fisica.dt_nascimento%type;
ie_documentacao_ok_w	varchar(1) := 'N';


BEGIN

select 	coalesce(max(cd_pessoa_fisica),'0'),
	coalesce(max(cd_pessoa_responsavel),'0')
into STRICT	cd_pessoa_fisica_w,
	cd_pessoa_responsavel_w
from 	atendimento_paciente
where 	nr_atendimento = nr_atendimento_p;

select	coalesce(max(nr_cpf),'0'),
	coalesce(max(cd_nacionalidade),'0'),
	coalesce(max(nr_reg_geral_estrang),'0'),
	coalesce(max(nr_passaporte),'0'),
	max(dt_nascimento)
into STRICT	nr_cpf_w,
	cd_nacionalidade_w,
	nr_rg_estrangeiro_w,
	nr_passaporte_w,
	dt_nascimento_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_w;

if (cd_nacionalidade_w <> '0') and (obter_se_brasileiro(cd_pessoa_fisica_w) <> 'S') then
	ie_brasileiro_w := 'N';
end if;

if (ie_brasileiro_w = 'S' AND nr_cpf_w <> '0') or
	((ie_brasileiro_w <> 'S') and ((nr_rg_estrangeiro_w <> '0') or (nr_passaporte_w <> '0'))) then
	ie_documentacao_ok_w 	:= 'S';
end if;

qt_idade_paciente_w	:= trunc(pkg_date_utils.get_DiffDate(dt_nascimento_w, clock_timestamp(), 'YEAR'));

if (qt_idade_paciente_w >= 18 AND ie_documentacao_ok_w = 'S') then
	return 'N';
end if;

/*---------VERIFICA O RESPONSAVEL DO PACIENTE---------*/

ie_documentacao_ok_w 	:= 'N';
ie_brasileiro_w		:= 'S';

select	coalesce(max(nr_cpf),'0'),
	coalesce(max(cd_nacionalidade),'0'),
	coalesce(max(nr_reg_geral_estrang),'0'),
	coalesce(max(nr_passaporte),'0')
into STRICT	nr_cpf_w,
	cd_nacionalidade_w,
	nr_rg_estrangeiro_w,
	nr_passaporte_w
from 	pessoa_fisica
where 	cd_pessoa_fisica = cd_pessoa_responsavel_w;

if (cd_nacionalidade_w <> '0') and (obter_se_brasileiro(cd_pessoa_responsavel_w) <> 'S') then
	ie_brasileiro_w := 'N';
end if;

if (ie_brasileiro_w = 'S' AND nr_cpf_w <> '0') or
	((ie_brasileiro_w <> 'S') and ((nr_rg_estrangeiro_w <> '0') or (nr_passaporte_w <> '0'))) then
	ie_documentacao_ok_w 	:= 'S';
end if;

if (ie_documentacao_ok_w = 'N') then
	return 'S';
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_exige_cpf_doc_estr (nr_atendimento_p bigint) FROM PUBLIC;

