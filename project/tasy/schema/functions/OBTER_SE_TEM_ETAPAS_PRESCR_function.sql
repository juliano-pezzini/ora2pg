-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_tem_etapas_prescr ( ie_tipo_item_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_item_cpoe_p bigint default null) RETURNS varchar AS $body$
DECLARE


ie_tem_etapas_w		varchar(4);
ie_count_etapas_w   smallint;


BEGIN
if (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
	
	if (ie_tipo_item_p = 1) then -- solucao
            select	count(0)
            into STRICT    ie_count_etapas_w
            from	prescr_solucao x,
                    prescr_mat_hor c,
                    prescr_medica a
            where	x.nr_prescricao = c.nr_prescricao
            and	    x.nr_prescricao = a.nr_prescricao
            and	    c.nr_prescricao = a.nr_prescricao
            and     a.nr_prescricao = nr_prescricao_p
            and     coalesce(x.dt_suspensao::text, '') = ''
            and	    coalesce(c.dt_fim_horario::text, '') = ''
            and	    coalesce(c.dt_suspensao::text, '') = ''
            and     coalesce(c.dt_inicio_horario::text, '') = ''
            and	    x.nr_seq_solucao = c.nr_seq_solucao
            and     x.nr_seq_solucao = nr_seq_item_p;

	elsif (ie_tipo_item_p = 2) then -- suporte nutricional enteral
		select	count(0)
        into STRICT	ie_count_etapas_w
		from	prescr_medica a,
				prescr_mat_hor b,
				prescr_material c,
				cpoe_dieta d
		where	a.nr_prescricao = b.nr_prescricao
		and		a.nr_prescricao = c.nr_prescricao
		and		b.nr_seq_material = c.nr_sequencia
		and		a.nr_prescricao = nr_prescricao_p
		and		c.nr_seq_dieta_cpoe = nr_seq_item_cpoe_p
		and		c.nr_seq_dieta_cpoe = d.nr_sequencia
        and     coalesce(b.dt_inicio_horario::text, '') = ''
		and		coalesce(b.dt_fim_horario::text, '') = ''
		and		coalesce(b.dt_suspensao::text, '') = ''
        and     coalesce(c.dt_suspensao::text, '') = '';

	elsif (ie_tipo_item_p = 3) then -- hemocomponente
        select	count(0)
        into STRICT    ie_count_etapas_w
        from	prescr_proc_hor x,
                prescr_medica a,
                prescr_solic_bco_sangue c,
                prescr_procedimento b
        where	a.nr_prescricao	= c.nr_prescricao
        and		c.nr_sequencia = b.nr_seq_solic_sangue
        and     x.nr_prescricao = a.nr_prescricao
        and     x.nr_seq_procedimento = b.nr_sequencia
        and		a.nr_prescricao	= nr_prescricao_p
        and		c.nr_seq_hemo_cpoe	= nr_seq_item_cpoe_p
        and     coalesce(x.dt_inicio_horario::text, '') = ''
        and     coalesce(x.dt_fim_horario::text, '') = ''
        and     coalesce(x.dt_suspensao::text, '') = ''
        and     coalesce(b.dt_suspensao::text, '') = '';

    elsif (ie_tipo_item_p in (5, 7)) then -- npt neo / npt Pediátrica
		select	count(0)
        into STRICT    ie_count_etapas_w
        from	nut_paciente_hor b,
                nut_pac x,
                prescr_medica a	
        where	x.nr_prescricao = a.nr_prescricao
        and     a.nr_prescricao = nr_prescricao_p
        and     x.nr_seq_npt_cpoe = nr_seq_item_cpoe_p	
        and		b.nr_seq_nut_protocolo	= x.nr_sequencia
        and		coalesce(x.dt_suspensao::text, '') = ''
        and		((coalesce(b.ie_horario_especial,'N') = 'N') or (b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> ''))		
        and     coalesce(b.dt_suspensao::text, '') = ''
        and     coalesce(b.ie_status::text, '') = ''
        and		coalesce(x.ie_npt_adulta, 'S') = 'P'				
		and     x.ie_status = 'N';

	elsif (ie_tipo_item_p = 6) then -- npt Adulta
		select	count(0)
        into STRICT    ie_count_etapas_w
        from	nut_paciente_hor b,
                nut_pac x,
                prescr_medica a	
        where	x.nr_prescricao = a.nr_prescricao
        and     a.nr_prescricao = nr_prescricao_p
        and     x.nr_seq_npt_cpoe = nr_seq_item_cpoe_p	
        and		b.nr_seq_nut_protocolo	= x.nr_sequencia
        and		coalesce(x.dt_suspensao::text, '') = ''
        and		((coalesce(b.ie_horario_especial,'N') = 'N') or (b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> ''))		
        and     coalesce(b.dt_suspensao::text, '') = ''
        and     coalesce(b.ie_status::text, '') = ''
        and		coalesce(x.ie_npt_adulta, 'S') = 'S'				
		and     x.ie_status = 'N';

    elsif (ie_tipo_item_p = 8) then -- diálise
        select	count(0)
        into STRICT    ie_count_etapas_w
        from	hd_prescricao b,
                prescr_solucao x,
                prescr_medica a
        where	x.nr_prescricao = a.nr_prescricao
        and     b.nr_sequencia  = x.nr_seq_dialise	
        and	    a.nr_prescricao = nr_prescricao_p
        and     b.nr_seq_dialise_cpoe = nr_seq_item_cpoe_p
        and     b.ie_tipo_dialise in ('H','P')
        and	    (x.nr_seq_dialise IS NOT NULL AND x.nr_seq_dialise::text <> '')
        and	    coalesce(x.dt_suspensao::text, '') = ''
        and     x.nr_seq_solucao not in (
                SELECT nr_seq_solucao
                from hd_prescricao_evento
                where nr_prescricao = nr_prescricao_p
                and ie_evento in ('II','IT','T')
        );

    elsif (ie_tipo_item_p = 9) then -- gasoterapia
		select	count(nr_sequencia)
        into STRICT	ie_count_etapas_w
        from	prescr_gasoterapia_hor
        where	nr_seq_gasoterapia	= nr_seq_item_p
        and 	nr_prescricao		= nr_prescricao_p
        and     coalesce(coalesce(dt_fim_horario, dt_interrupcao)::text, '') = ''
        and 	coalesce(dt_suspensao::text, '') = ''
        and     nr_sequencia not in (
            SELECT nr_seq_horario
            from prescr_gasoterapia_evento 
            where nr_seq_gasoterapia = nr_seq_item_p
            and nr_prescricao = nr_prescricao_p
            and ie_evento in ('I','R')
            and ie_evento_valido = 'S'
        );
	end if;
end if;

if (coalesce(ie_count_etapas_w,0) > 0) then
    ie_tem_etapas_w := 'S';
else
    ie_tem_etapas_w := 'N';
end if;

return ie_tem_etapas_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_tem_etapas_prescr ( ie_tipo_item_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_item_cpoe_p bigint default null) FROM PUBLIC;

