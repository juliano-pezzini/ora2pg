-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION recep_obter_auto_prescr (nr_seq_interno_p bigint, nr_prescricao_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ie_autorizado_w		varchar(1);
qt_autorizado_w		bigint;
qt_prescricao_w		bigint;
nr_seq_agenda_w		bigint;

/*
ie_opcao_p:
C - convênio
P - Prescrição
*/
BEGIN


ie_autorizado_w := 'N';

if (coalesce(nr_seq_interno_p,0) > 0) then

	select	max(a.nr_seq_agenda)
	into STRICT	nr_seq_agenda_w
	from    recep_ficha_pre_agenda a,
		atend_categoria_convenio b,
		prescr_medica c,
		prescr_procedimento d,
		recep_ficha_pre e
	where 	a.nr_seq_agenda = d.nr_seq_agenda
	and     c.nr_prescricao = d.nr_prescricao
	and	a.nr_seq_ficha =  e.nr_sequencia
	and     c.nr_atendimento = c.nr_atendimento
	and     c.nr_seq_atecaco = nr_seq_interno_p
	and 	((c.nr_prescricao =  nr_prescricao_p) or (nr_prescricao_p = 0));

	if (coalesce(nr_seq_agenda_w,0) > 0) then

		select	count(*)
		into STRICT	qt_autorizado_w
		from 	autorizacao_convenio a,
			estagio_autorizacao b
		where	a.nr_seq_estagio	= b.nr_sequencia
		and	b.ie_interno		= '10'
		and	a.nr_seq_agenda		= nr_seq_agenda_w;

		if (qt_autorizado_w > 0) then
			ie_autorizado_w := 'S';
		end if;
	end if;
end if;

if (coalesce(nr_seq_agenda_w,0) = 0) then

	if (ie_opcao_p = 'P') and (coalesce(nr_prescricao_p,0) > 0) then

			select	count(*)
			into STRICT	qt_autorizado_w
			from 	autorizacao_convenio a,
				estagio_autorizacao b,
				prescr_medica c
			where	a.nr_seq_estagio	= b.nr_sequencia
			and	b.ie_interno		= '10'
			and	a.nr_prescricao		= c.nr_prescricao
			and	c.nr_prescricao     = nr_prescricao_p;

			if (coalesce(qt_autorizado_w,0) > 0) then
				ie_autorizado_w := 'S';
			end if;

	elsif (ie_opcao_p = 'C') and (coalesce(nr_seq_interno_p,0) > 0) then

		select	count(*)
		into STRICT	qt_prescricao_w
		from 	prescr_medica
		where 	nr_seq_atecaco = nr_seq_interno_p;

		if (coalesce(qt_prescricao_w,0) > 0) then

				select	count(*)
				into STRICT	qt_autorizado_w
				from 	autorizacao_convenio a,
					estagio_autorizacao b,
					prescr_medica c
				where	a.nr_seq_estagio	= b.nr_sequencia
				and	b.ie_interno		= '10'
				and	a.nr_prescricao		= c.nr_prescricao
				and	c.nr_seq_atecaco    = nr_seq_interno_p;

				if (coalesce(qt_autorizado_w,0) > 0) then
					ie_autorizado_w := 'S';
				end if;
		end if;
	end if;
end if;

return	ie_autorizado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION recep_obter_auto_prescr (nr_seq_interno_p bigint, nr_prescricao_p bigint, ie_opcao_p text) FROM PUBLIC;

