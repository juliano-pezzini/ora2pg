-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ult_resultado_lab_gir (cd_pessoa_fisica_p bigint, nr_seq_exame_p bigint) RETURNS varchar AS $body$
DECLARE

nr_seq_resultado_w		bigint;
ds_resultado_w			varchar(10) := null;
nr_seq_resultado_prescr_w	bigint;
					

BEGIN

select 	coalesce(max(c.nr_seq_resultado),0)
into STRICT	nr_seq_resultado_w
from	exame_laboratorio d,
		exame_lab_resultado a,
		exame_lab_result_item c
where	a.nr_seq_resultado 	= c.nr_seq_resultado
and		d.nr_seq_exame 		= c.nr_seq_exame
and (coalesce(coalesce(CASE WHEN c.ds_resultado='0' THEN ''  ELSE CASE WHEN d.ie_formato_resultado='V' THEN ''  ELSE c.ds_resultado END  END ,	coalesce(to_char(c.qt_resultado),to_char(CASE WHEN c.pr_resultado=0 THEN ''  ELSE c.pr_resultado END ))),c.ds_resultado)) is not null
and		a.cd_pessoa_fisica	= cd_pessoa_fisica_p
and		c.nr_seq_exame		= nr_seq_exame_p
AND 	a.dt_resultado BETWEEN clock_timestamp() - interval '120 days' AND clock_timestamp();

SELECT 	coalesce(MAX(A.NR_SEQ_RESULTADO),0)
INTO STRICT	NR_SEQ_RESULTADO_PRESCR_W
FROM	ULT_RESULTADO_EXAME_PRESC_V a
WHERE a.NR_SEQ_EXAME		= NR_SEQ_EXAME_P
AND	a.CD_PESSOA_FISICA	= CD_PESSOA_FISICA_P
AND  ((a.IE_FORMATO_RESULTADO IN ('VP','DV','V') AND (coalesce(a.QT_RESULTADO,0) > 0)) OR (coalesce(a.PR_RESULTADO,0) > 0) OR ((a.DS_RESULTADO IS NOT NULL AND a.DS_RESULTADO::text <> '')  AND a.DS_RESULTADO <> '0'));

if (nr_seq_resultado_prescr_w > nr_seq_resultado_w) then
	nr_seq_resultado_w	:= nr_seq_resultado_prescr_w;
end if;


if (nr_seq_resultado_w > 0) then

	select	substr(max(coalesce(coalesce(CASE WHEN c.ds_resultado='0' THEN ''  ELSE CASE WHEN d.ie_formato_resultado='V' THEN ''  ELSE c.ds_resultado END  END ,	coalesce(to_char(c.qt_resultado),to_char(CASE WHEN c.pr_resultado=0 THEN ''  ELSE c.pr_resultado END ))),c.ds_resultado)),1,10)
	into STRICT	ds_resultado_w
	from	exame_laboratorio d,
		exame_lab_result_item c
	where	d.nr_seq_exame 		= c.nr_seq_exame
	and	c.nr_seq_resultado 	= nr_seq_resultado_w
	and	c.nr_seq_exame		= nr_seq_exame_p;

end if;

return ds_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ult_resultado_lab_gir (cd_pessoa_fisica_p bigint, nr_seq_exame_p bigint) FROM PUBLIC;

