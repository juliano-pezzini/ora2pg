-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_nr_contr_prog_rpc ( nr_seq_prog_reaj_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(255);
tx_reajuste_programado_w	pls_prog_reaj_coletivo.tx_reajuste_programado%type;
dt_reajuste_w			pls_prog_reaj_coletivo.dt_reajuste%type;
ie_numero_contrato_w		pls_regra_rpc.ie_numero_contrato%type;
nr_seq_contrato_w		pls_prog_reaj_coletivo.nr_seq_contrato%type;
cd_cgc_outorgante_w		pls_outorgante.cd_cgc_outorgante%type;
cd_cooperativa_w		pls_congenere.cd_cooperativa%type;
nr_contrato_w			pls_contrato.nr_contrato%type;
cd_operadora_empresa_w		pls_contrato.cd_operadora_empresa%type;
cd_cod_anterior_w		pls_contrato.cd_cod_anterior%type;


BEGIN

select	coalesce(tx_reajuste_programado,0),
	dt_reajuste,
	nr_seq_contrato
into STRICT	tx_reajuste_programado_w,
	dt_reajuste_w,
	nr_seq_contrato_w
from	pls_prog_reaj_coletivo
where	nr_sequencia	= nr_seq_prog_reaj_p;

select	max(ie_numero_contrato)
into STRICT	ie_numero_contrato_w
from	pls_regra_rpc
where	dt_reajuste_w between coalesce(dt_inicio_vigencia,dt_reajuste_w) and coalesce(dt_fim_vigencia,dt_reajuste_w)
and	tx_reajuste_programado_w between coalesce(pr_reajuste_inicial,tx_reajuste_programado_w) and coalesce(pr_reajuste_final,tx_reajuste_programado_w);

select	max(nr_contrato),
	max(cd_operadora_empresa),
	max(cd_cod_anterior)
into STRICT	nr_contrato_w,
	cd_operadora_empresa_w,
	cd_cod_anterior_w
from	pls_contrato
where	nr_sequencia	= nr_seq_contrato_w;

if (ie_numero_contrato_w IS NOT NULL AND ie_numero_contrato_w::text <> '') then
	select	max(cd_cgc_outorgante)
	into STRICT	cd_cgc_outorgante_w
	from	pls_outorgante;

	select	max(cd_cooperativa)
	into STRICT	cd_cooperativa_w
	from	pls_congenere
	where	cd_cgc	= cd_cgc_outorgante_w;

	if (coalesce(ie_numero_contrato_w,'C')	= 'C') then
		ds_retorno_w	:= nr_contrato_w;
	elsif (coalesce(ie_numero_contrato_w,'C')	= 'CC') then
		ds_retorno_w	:= cd_cooperativa_w || nr_contrato_w;
	elsif (coalesce(ie_numero_contrato_w,'C')	= 'CE') then
		ds_retorno_w	:= (cd_cooperativa_w)::numeric  ||' '|| lpad(cd_operadora_empresa_w,4,'0');
	elsif (coalesce(ie_numero_contrato_w,'C')	= 'CA') then
		ds_retorno_w	:= coalesce(cd_cod_anterior_w,nr_contrato_w);
	end if;
else
	ds_retorno_w	:= nr_contrato_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_nr_contr_prog_rpc ( nr_seq_prog_reaj_p bigint) FROM PUBLIC;

