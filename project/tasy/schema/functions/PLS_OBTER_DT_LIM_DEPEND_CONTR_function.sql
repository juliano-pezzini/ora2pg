-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dt_lim_depend_contr ( nr_seq_segurado_p bigint, cd_pessoa_fisica_p text, nr_seq_contrato_p bigint, nr_seq_parentesco_p bigint, dt_nascimento_p timestamp, ie_sexo_p text, ie_estado_civil_p text) RETURNS timestamp AS $body$
DECLARE


dt_retorno_w			timestamp;
dt_validade_doc_w		timestamp;
dt_nascimento_w			timestamp;

qt_regra_w			integer;
qt_deficiencia_w		integer;
qt_anos_w			integer;
qt_regra_contrato_w		integer;

nr_seq_regra_dependencia_w	pls_contrato_dependencia.nr_seq_regra_dependencia%type;
qt_idade_max_w			bigint;
nr_sequencia_doc_w		bigint;
ie_data_limite_w		regra_grau_parent_contrato.ie_data_limite%type;


BEGIN
dt_nascimento_w		:= dt_nascimento_p;
qt_regra_contrato_w	:= 0;

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	select	max(b.nr_seq_regra_dependencia)
	into STRICT	nr_seq_regra_dependencia_w
	from	pls_contrato_dependencia	b,
		regra_grau_parent_contrato	a
	where	a.nr_seq_lote_parentesco	= b.nr_seq_regra_dependencia
	and	b.nr_seq_contrato		= nr_seq_contrato_p
	and	a.nr_seq_parentesco		= nr_seq_parentesco_p
	and	b.ie_situacao			= 'A';
	
	if (nr_seq_regra_dependencia_w IS NOT NULL AND nr_seq_regra_dependencia_w::text <> '') then
		qt_regra_contrato_w := 1;
	else
		qt_regra_contrato_w := 0;
	end if;
	
	/*Primeiro verificar a regra do contrato*/

	if (qt_regra_contrato_w > 0) then
		/*Limitar pelo sexo do beneficiario*/

		if (dt_nascimento_w IS NOT NULL AND dt_nascimento_w::text <> '') then
			qt_anos_w	:= trunc(months_between(clock_timestamp(), trunc(dt_nascimento_w,'month')) / 12);
			
			select  max(qt_idade_max),
				max(ie_data_limite)
			into STRICT	qt_idade_max_w,
				ie_data_limite_w
			from	regra_grau_parent_contrato
			where	nr_seq_lote_parentesco		= nr_seq_regra_dependencia_w
			and	nr_seq_parentesco		= nr_seq_parentesco_p
			and	qt_anos_w			>= qt_idade_min
			and 	qt_anos_w			<= qt_idade_max
			and	ie_benef_deficiencia 		= 'N'
			and	ie_possui_comp_esc_valido 	= 'N'
			and	ie_possui_procuracao_valida	= 'N'
			and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
			and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
			
			if (qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '') then
				begin
				dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
				exception
				when others then
					if (to_char(dt_nascimento_w,'mm') = '02') then
						dt_nascimento_w	:= '28'||'/'|| to_char(dt_nascimento_w,'mm/yyyy');
					end if;
					dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
				end;
				
				begin
				if (coalesce(ie_data_limite_w, '1') = '2') then
					dt_retorno_w	:= fim_mes(add_months(dt_retorno_w, -1));
				end if;
				exception
				when others then
					dt_retorno_w	:= null;
				end;
			else
				select  max(qt_idade_max),
					max(ie_data_limite)
				into STRICT	qt_idade_max_w,
					ie_data_limite_w
				from	regra_grau_parent_contrato
				where	nr_seq_lote_parentesco		= nr_seq_regra_dependencia_w
				and	nr_seq_parentesco		= nr_seq_parentesco_p
				and	qt_anos_w			>= qt_idade_min
				and 	qt_anos_w			<= qt_idade_max
				and	ie_benef_deficiencia 		= 'S'
				and	ie_possui_comp_esc_valido 	= 'N'
				and	ie_possui_procuracao_valida	= 'N'
				and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
				and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
				
				select 	count(*)
				into STRICT	qt_deficiencia_w
				from	pf_tipo_deficiencia
				where	cd_pessoa_fisica = cd_pessoa_fisica_p;
				
				if (qt_deficiencia_w > 0) and (qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '') then
					begin
					dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
					exception
					when others then
						if (to_char(dt_nascimento_w,'mm') = '02') then
							dt_nascimento_w	:= '28'||'/'|| to_char(dt_nascimento_w,'mm/yyyy');
						end if;
						dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
					end;
					
					begin
					if (coalesce(ie_data_limite_w, '1') = '2') then
						dt_retorno_w	:= fim_mes(add_months(dt_retorno_w, -1));
					end if;
					exception
					when others then
						dt_retorno_w	:= null;
					end;
				else
					select  max(qt_idade_max),
						max(ie_data_limite)
					into STRICT	qt_idade_max_w,
						ie_data_limite_w
					from	regra_grau_parent_contrato
					where	nr_seq_lote_parentesco		= nr_seq_regra_dependencia_w
					and	nr_seq_parentesco		= nr_seq_parentesco_p
					and	qt_anos_w			>= qt_idade_min
					and 	qt_anos_w			<= qt_idade_max
					and	ie_benef_deficiencia 		= 'N'
					and	ie_possui_comp_esc_valido 	= 'S'
					and	ie_possui_procuracao_valida	= 'N'
					and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
					and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
					
					select	max(a.nr_sequencia)
					into STRICT	nr_sequencia_doc_w
					from	pls_tipo_documento_pf 		a,
						tipo_documentacao 		b
					where	a.nr_seq_tipo_documento 	= b.nr_sequencia
					and	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p
					and	b.ie_finalidade			= 'P'
					and	b.ie_escolaridade		= 'S';
			
					if (qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '') and (nr_sequencia_doc_w IS NOT NULL AND nr_sequencia_doc_w::text <> '') then
							
						select	max(dt_validade)
						into STRICT	dt_validade_doc_w
						from	pls_tipo_documento_pf 		a,
							tipo_documentacao 		b
						where	a.nr_seq_tipo_documento 	= b.nr_sequencia
						and	a.nr_sequencia			= nr_sequencia_doc_w;
						
						if (dt_validade_doc_w IS NOT NULL AND dt_validade_doc_w::text <> '') then
							dt_retorno_w := dt_validade_doc_w;
						else
							begin
							dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
							exception
							when others then
								if (to_char(dt_nascimento_w,'mm') = '02') then
									dt_nascimento_w	:= '28'||'/'|| to_char(dt_nascimento_w,'mm/yyyy');
								end if;
								dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
							end;
							
							begin
							if (coalesce(ie_data_limite_w, '1') = '2') then
								dt_retorno_w	:= fim_mes(add_months(dt_retorno_w, -1));
							end if;
							exception
							when others then
								dt_retorno_w	:= null;
							end;
						end if;					
					else
						select  max(qt_idade_max),
							max(ie_data_limite)
						into STRICT	qt_idade_max_w,
							ie_data_limite_w
						from	regra_grau_parent_contrato
						where	nr_seq_lote_parentesco		= nr_seq_regra_dependencia_w
						and	nr_seq_parentesco		= nr_seq_parentesco_p
						and	ie_benef_deficiencia 		= 'N'
						and	ie_possui_comp_esc_valido 	= 'S'
						and	ie_possui_procuracao_valida	= 'N'
						and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
						and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
						
						select	max(a.nr_sequencia)
						into STRICT	nr_sequencia_doc_w
						from	pls_tipo_documento_pf 		a,
							tipo_documentacao 		b
						where	a.nr_seq_tipo_documento 	= b.nr_sequencia
						and	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p
						and	b.ie_finalidade			= 'P'
						and	b.ie_escolaridade		= 'S';
						
						if (qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '') and (nr_sequencia_doc_w IS NOT NULL AND nr_sequencia_doc_w::text <> '') then
							select	max(dt_validade)
							into STRICT	dt_validade_doc_w
							from	pls_tipo_documento_pf 		a,
								tipo_documentacao 		b
							where	a.nr_seq_tipo_documento 	= b.nr_sequencia
							and	a.nr_sequencia			= nr_sequencia_doc_w;
							
							if (dt_validade_doc_w IS NOT NULL AND dt_validade_doc_w::text <> '') then
								dt_retorno_w := dt_validade_doc_w;							
							end if;
						else
							select  max(qt_idade_max),
								max(ie_data_limite)
							into STRICT	qt_idade_max_w,
								ie_data_limite_w
							from	regra_grau_parent_contrato
							where	nr_seq_parentesco		= nr_seq_parentesco_p
							and	coalesce(nr_seq_lote_parentesco::text, '') = ''
							and	qt_anos_w			>= qt_idade_min
							and 	qt_anos_w			<= qt_idade_max
							and	ie_benef_deficiencia 		= 'N'
							and	ie_possui_comp_esc_valido 	= 'N'
							and	ie_possui_procuracao_valida	= 'S'
							and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
							and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
							
							select	max(a.nr_sequencia)
							into STRICT	nr_sequencia_doc_w
							from	pls_tipo_documento_pf 		a,
								tipo_documentacao 		b
							where	a.nr_seq_tipo_documento 	= b.nr_sequencia
							and	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p
							and	b.ie_finalidade			= 'P'
							and	b.ie_procuracao			= 'S';
					
							if (qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '') and (nr_sequencia_doc_w IS NOT NULL AND nr_sequencia_doc_w::text <> '') then
									
								select	max(dt_validade)
								into STRICT	dt_validade_doc_w
								from	pls_tipo_documento_pf 		a,
									tipo_documentacao 		b
								where	a.nr_seq_tipo_documento 	= b.nr_sequencia
								and	a.nr_sequencia			= nr_sequencia_doc_w;
								
								if (dt_validade_doc_w IS NOT NULL AND dt_validade_doc_w::text <> '') then
									dt_retorno_w := dt_validade_doc_w;
								else
									begin
									dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
									exception
									when others then
										if (to_char(dt_nascimento_w,'mm') = '02') then
											dt_nascimento_w	:= '28'||'/'|| to_char(dt_nascimento_w,'mm/yyyy');
										end if;
										dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
									end;
									
									begin
									if (coalesce(ie_data_limite_w, '1') = '2') then
										dt_retorno_w	:= fim_mes(add_months(dt_retorno_w, -1));
									end if;
									exception
									when others then
										dt_retorno_w	:= null;
									end;
								end if;
							else
								select  max(qt_idade_max),
									max(ie_data_limite)
								into STRICT	qt_idade_max_w,
									ie_data_limite_w
								from	regra_grau_parent_contrato
								where	nr_seq_lote_parentesco		= nr_seq_regra_dependencia_w
								and	nr_seq_parentesco		= nr_seq_parentesco_p
								and	qt_anos_w			>= qt_idade_min
								and 	qt_anos_w			<= qt_idade_max
								and	ie_benef_deficiencia 		= 'N'
								and	ie_possui_comp_esc_valido 	= 'N'
								and	ie_possui_procuracao_valida	= 'N'
								and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
								and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
								
								if (coalesce(qt_idade_max_w::text, '') = '') then
									dt_retorno_w := null;
								else
									begin
									dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
									exception
									when others then
										if (to_char(dt_nascimento_w,'mm') = '02') then
											dt_nascimento_w	:= '28'||'/'|| to_char(dt_nascimento_w,'mm/yyyy');
										end if;
										dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
									end;
									
									begin
									if (coalesce(ie_data_limite_w, '1') = '2') then
										dt_retorno_w	:= fim_mes(add_months(dt_retorno_w, -1));
									end if;
									exception
									when others then
										dt_retorno_w	:= null;
									end;
								end if;
							end if;
						end if;
					end if;
				end if;
			end if;
		else
			dt_retorno_w := null;
		end if;
	else	
		select 	count(1)
		into STRICT	qt_regra_w
		from	regra_grau_parent_contrato
		where	nr_seq_parentesco = nr_seq_parentesco_p
		and	coalesce(nr_seq_lote_parentesco::text, '') = ''  LIMIT ALL;
		
		/*A regra do padrao*/
	
		if (qt_regra_w > 0) then
			if (dt_nascimento_w IS NOT NULL AND dt_nascimento_w::text <> '') then
				qt_anos_w := trunc(months_between(clock_timestamp(), trunc(dt_nascimento_w,'month')) / 12);
				
				select  max(qt_idade_max),
					max(ie_data_limite)
				into STRICT	qt_idade_max_w,
					ie_data_limite_w
				from	regra_grau_parent_contrato
				where	nr_seq_parentesco		= nr_seq_parentesco_p
				and	coalesce(nr_seq_lote_parentesco::text, '') = ''
				and	qt_anos_w			>= qt_idade_min
				and 	qt_anos_w			<= qt_idade_max
				and	ie_benef_deficiencia 		= 'N'
				and	ie_possui_comp_esc_valido 	= 'N'
				and	ie_possui_procuracao_valida	= 'N'
				and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
				and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
				
				if (qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '') then
					begin
					dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
					exception
					when others then
						if (to_char(dt_nascimento_w,'mm') = '02') then
							dt_nascimento_w	:= '28'||'/'|| to_char(dt_nascimento_w,'mm/yyyy');
						end if;
						dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
					end;

					begin
					if (coalesce(ie_data_limite_w, '1') = '2') then
						dt_retorno_w	:= fim_mes(add_months(dt_retorno_w, -1));
					end if;
					exception
					when others then
						dt_retorno_w	:= null;
					end;				
				else
					select  max(qt_idade_max),
						max(ie_data_limite)
					into STRICT	qt_idade_max_w,
						ie_data_limite_w
					from	regra_grau_parent_contrato
					where	nr_seq_parentesco 		= nr_seq_parentesco_p
					and	coalesce(nr_seq_lote_parentesco::text, '') = ''
					and	qt_anos_w			>= qt_idade_min
					and 	qt_anos_w			<= qt_idade_max
					and	ie_benef_deficiencia 		= 'S'
					and	ie_possui_comp_esc_valido 	= 'N'
					and	ie_possui_procuracao_valida	= 'N'
					and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
					and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
					
					select 	count(*)
					into STRICT	qt_deficiencia_w
					from	pf_tipo_deficiencia
					where	cd_pessoa_fisica = cd_pessoa_fisica_p;
					
					if (qt_deficiencia_w > 0) and (qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '') then
						begin
						dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
						exception
						when others then
							if (to_char(dt_nascimento_w,'mm') = '02') then
								dt_nascimento_w	:= '28'||'/'|| to_char(dt_nascimento_w,'mm/yyyy');
							end if;
							dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
						end;
						
						begin
						if (coalesce(ie_data_limite_w, '1') = '2') then
							dt_retorno_w	:= fim_mes(add_months(dt_retorno_w, -1));
						end if;
						exception
						when others then
							dt_retorno_w	:= null;
						end;
					else
						select  max(qt_idade_max),
							max(ie_data_limite)
						into STRICT	qt_idade_max_w,
							ie_data_limite_w
						from	regra_grau_parent_contrato
						where	nr_seq_parentesco		= nr_seq_parentesco_p
						and	coalesce(nr_seq_lote_parentesco::text, '') = ''
						and	qt_anos_w			>= qt_idade_min
						and 	qt_anos_w			<= qt_idade_max
						and	ie_benef_deficiencia 		= 'N'
						and	ie_possui_comp_esc_valido 	= 'S'
						and	ie_possui_procuracao_valida	= 'N'
						and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
						and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
						
						select	max(a.nr_sequencia)
						into STRICT	nr_sequencia_doc_w
						from	pls_tipo_documento_pf 		a,
							tipo_documentacao 		b
						where	a.nr_seq_tipo_documento 	= b.nr_sequencia
						and	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p
						and	b.ie_finalidade			= 'P'
						and	b.ie_escolaridade		= 'S';
				
						if (qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '') and (nr_sequencia_doc_w IS NOT NULL AND nr_sequencia_doc_w::text <> '') then
							select	max(dt_validade)
							into STRICT	dt_validade_doc_w
							from	pls_tipo_documento_pf 		a,
								tipo_documentacao 		b
							where	a.nr_seq_tipo_documento 	= b.nr_sequencia
							and	a.nr_sequencia			= nr_sequencia_doc_w;
							
							if (dt_validade_doc_w IS NOT NULL AND dt_validade_doc_w::text <> '') then
								dt_retorno_w := dt_validade_doc_w;
							else
								begin
								dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
								exception
								when others then
									if (to_char(dt_nascimento_w,'mm') = '02') then
										dt_nascimento_w	:= '28'||'/'|| to_char(dt_nascimento_w,'mm/yyyy');
									end if;
									dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
								end;
								
								begin
								if (coalesce(ie_data_limite_w, '1') = '2') then
									dt_retorno_w	:= fim_mes(add_months(dt_retorno_w, -1));
								end if;
								exception
								when others then
									dt_retorno_w	:= null;
								end;
							end if;					
						else
							select  max(qt_idade_max),
								max(ie_data_limite)
							into STRICT	qt_idade_max_w,
								ie_data_limite_w
							from	regra_grau_parent_contrato
							where	nr_seq_parentesco		= nr_seq_parentesco_p
							and	coalesce(nr_seq_lote_parentesco::text, '') = ''
							and	ie_benef_deficiencia 		= 'N'
							and	ie_possui_comp_esc_valido 	= 'S'
							and	ie_possui_procuracao_valida	= 'N'
							and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
							and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
							
							select	max(a.nr_sequencia)
							into STRICT	nr_sequencia_doc_w
							from	pls_tipo_documento_pf a,
								tipo_documentacao b
							where	a.nr_seq_tipo_documento 	= b.nr_sequencia
							and	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p
							and	b.ie_finalidade			= 'P'
							and	b.ie_escolaridade		= 'S';
							
							if (qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '') and (nr_sequencia_doc_w IS NOT NULL AND nr_sequencia_doc_w::text <> '') then
								select	max(dt_validade)
								into STRICT	dt_validade_doc_w
								from	pls_tipo_documento_pf 		a,
									tipo_documentacao 		b
								where	a.nr_seq_tipo_documento 	= b.nr_sequencia
								and	a.nr_sequencia			= nr_sequencia_doc_w;
								
								if (dt_validade_doc_w IS NOT NULL AND dt_validade_doc_w::text <> '') then
									dt_retorno_w := dt_validade_doc_w;							
								end if;
							else
								select  max(qt_idade_max),
									max(ie_data_limite)
								into STRICT	qt_idade_max_w,
									ie_data_limite_w
								from	regra_grau_parent_contrato
								where	nr_seq_parentesco		= nr_seq_parentesco_p
								and	coalesce(nr_seq_lote_parentesco::text, '') = ''
								and	qt_anos_w			>= qt_idade_min
								and 	qt_anos_w			<= qt_idade_max
								and	ie_benef_deficiencia 		= 'N'
								and	ie_possui_comp_esc_valido 	= 'N'
								and	ie_possui_procuracao_valida	= 'S'
								and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
								and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
								
								select	max(a.nr_sequencia)
								into STRICT	nr_sequencia_doc_w
								from	pls_tipo_documento_pf 		a,
									tipo_documentacao 		b
								where	a.nr_seq_tipo_documento 	= b.nr_sequencia
								and	a.cd_pessoa_fisica 		= cd_pessoa_fisica_p
								and	b.ie_finalidade			= 'P'
								and	b.ie_procuracao			= 'S';
						
								if (qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '') and (nr_sequencia_doc_w IS NOT NULL AND nr_sequencia_doc_w::text <> '') then
										
									select	max(dt_validade)
									into STRICT	dt_validade_doc_w
									from	pls_tipo_documento_pf 		a,
										tipo_documentacao 		b
									where	a.nr_seq_tipo_documento 	= b.nr_sequencia
									and	a.nr_sequencia			= nr_sequencia_doc_w;
									
									if (dt_validade_doc_w IS NOT NULL AND dt_validade_doc_w::text <> '') then
										dt_retorno_w := dt_validade_doc_w;
									else
										begin
										dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
										exception
										when others then
											if (to_char(dt_nascimento_w,'mm') = '02') then
												dt_nascimento_w	:= '28'||'/'|| to_char(dt_nascimento_w,'mm/yyyy');
											end if;
											dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
										end;
										
										begin
										if (coalesce(ie_data_limite_w, '1') = '2') then
											dt_retorno_w	:= fim_mes(add_months(dt_retorno_w, -1));
										end if;
										exception
										when others then
											dt_retorno_w	:= null;
										end;
									end if;
								else	
									select  max(qt_idade_max),
										max(ie_data_limite)
									into STRICT	qt_idade_max_w,
										ie_data_limite_w
									from	regra_grau_parent_contrato
									where	nr_seq_parentesco		= nr_seq_parentesco_p
									and	coalesce(nr_seq_lote_parentesco::text, '') = ''					
									and	ie_benef_deficiencia 		= 'N'
									and	ie_possui_comp_esc_valido 	= 'N'
									and	ie_possui_procuracao_valida	= 'N'
									and	((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = ''))
									and	((ie_estado_civil = ie_estado_civil_p) or (coalesce(ie_estado_civil::text, '') = ''));
									
									if (coalesce(qt_idade_max_w::text, '') = '') then
										dt_retorno_w := null;
									else
										begin
										dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
										exception
										when others then
											if (to_char(dt_nascimento_w,'mm') = '02') then
												dt_nascimento_w	:= '28'||'/'|| to_char(dt_nascimento_w,'mm/yyyy');
											end if;
											dt_retorno_w := to_char(dt_nascimento_w,'dd/mm')||'/'||(to_char(dt_nascimento_w,'yyyy') + qt_idade_max_w);
										end;
										
										begin
										if (coalesce(ie_data_limite_w, '1') = '2') then
											dt_retorno_w	:= fim_mes(add_months(dt_retorno_w, -1));
										end if;
										exception
										when others then
											dt_retorno_w	:= null;
										end;
									end if;	
								end if;
							end if;
						end if;
					end if;
				end if;
			else
				dt_retorno_w := null;
			end if;
		else
			dt_retorno_w := null;
		end if;
	end if;
end if;

return	dt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dt_lim_depend_contr ( nr_seq_segurado_p bigint, cd_pessoa_fisica_p text, nr_seq_contrato_p bigint, nr_seq_parentesco_p bigint, dt_nascimento_p timestamp, ie_sexo_p text, ie_estado_civil_p text) FROM PUBLIC;

