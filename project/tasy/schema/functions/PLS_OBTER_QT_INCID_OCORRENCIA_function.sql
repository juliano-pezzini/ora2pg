-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_qt_incid_ocorrencia ( qt_liberada_p bigint, dt_ref_inicial_p timestamp, dt_ref_final_p timestamp, cd_estabelecimento_p bigint, qt_solicitada_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_execucao_p bigint, nr_seq_segurado_p bigint, nr_seq_clinica_regra_p bigint, ie_tipo_incidencia_p text, nr_seq_ocor_combinada_p bigint, ie_valida_grupo_serv_p text, ie_valida_medico_cbo_p text, ie_valida_conta_p text, nr_seq_prestador_p bigint, nr_seq_local_atend_p bigint, cd_medico_solic_p text, nr_seq_segurado_regra_p bigint, nr_seq_prestador_regra_p bigint, ie_valida_execucao_p text, ie_valida_guia_dif_p pls_validacao_aut_qt_incid.ie_valida_guia_dif%type, ie_valida_mesma_espec_p pls_validacao_aut_qt_incid.ie_valida_mesma_espec%type default 'N', ds_observacao_p out text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:Validar as regras de quantidade incidencia para as ocorrencia combinadas
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
				
ie_retorno_w			varchar(1) 	:= 'N';
qt_liberacao_w			pls_conta_proc.qt_procedimento%type	:= 0;
ie_grupo_servico_w		varchar(2);
cd_medico_solicitante_w 	varchar(10);
nr_seq_cbo_saude_w		bigint;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
ie_tipo_processo_w		varchar(1);
ie_local_atend_w		varchar(1);
ie_regra_qtd_w			varchar(1);
ie_regra_tipo_pessoa_w		varchar(1);
nr_seq_guia_w			pls_guia_plano.nr_sequencia%type;
dt_execucao_w			timestamp;
nm_medico_requisit_w		varchar(255);
cd_guia_w			pls_guia_plano.cd_guia%type;
nr_seq_exec_item_w		pls_execucao_req_item.nr_sequencia%type;
nr_seq_prestador_w		pls_requisicao.nr_seq_prestador%type;
nr_seq_segurado_w		pls_requisicao.nr_seq_segurado%type;
nm_usuario_solic_w		pls_requisicao.nm_usuario_solic%type;
nr_seq_clinica_w		pls_requisicao.nr_seq_clinica%type;
ie_tipo_internacao_w		varchar(1);
nr_seq_requisicao_w		pls_requisicao.nr_sequencia%type;
cd_especialidade_w		especialidade_medica.cd_especialidade%type;

C01 CURSOR(nr_seq_ocor_combinada_pc bigint) FOR
	SELECT	nr_seq_grupo_servico
	from	pls_ocor_aut_combinada		a,
		pls_ocor_aut_filtro		b,
		pls_ocor_aut_filtro_proc	c
	where	a.nr_sequencia		= nr_seq_ocor_combinada_pc
	and	a.nr_sequencia		= b.nr_seq_ocor_aut_combinada
	and	b.nr_sequencia		= nr_seq_ocor_aut_filtro
	and	b.ie_situacao		= 'A'
	and	b.ie_excecao		= 'N';

cProcGuia01 CURSOR(	nr_seq_segurado_pc bigint, nr_seq_guia_pc bigint, cd_estabelecimento_pc bigint,
			dt_ref_inicial_pc timestamp, dt_ref_final_pc timestamp, nr_seq_clinica_regra_pc bigint) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_solicitada,
		b.nr_seq_prestador,
		b.nr_seq_segurado,
		b.ie_tipo_processo,
		b.cd_medico_solicitante,
		b.nm_usuario_solic
	from	pls_guia_plano		b,
		pls_guia_plano_proc	a
	where	a.nr_seq_guia		= b.nr_sequencia
	and	b.nr_seq_segurado	= nr_seq_segurado_pc
	and	b.cd_estabelecimento	= cd_estabelecimento_pc
	and	((b.ie_status		<> '3')
	or (b.nr_sequencia	= nr_seq_guia_pc))
	and	trunc(a.dt_liberacao) 	between dt_ref_inicial_pc and dt_ref_final_pc
	and (b.nr_seq_clinica	= nr_seq_clinica_regra_pc or coalesce(nr_seq_clinica_regra_pc::text, '') = '');
	
cProcGuia02 CURSOR(	nr_seq_segurado_pc bigint, nr_seq_guia_pc bigint, cd_estabelecimento_pc text) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_solicitada,
		b.nr_seq_prestador,
		b.nr_seq_segurado,
		b.ie_tipo_processo,
		b.cd_medico_solicitante,
		b.nm_usuario_solic
	from	pls_guia_plano		b,
		pls_guia_plano_proc	a
	where	a.nr_seq_guia		= b.nr_sequencia
	and	b.nr_seq_segurado	= nr_seq_segurado_pc
	and	b.nr_sequencia		= nr_seq_guia_pc
	and	b.cd_estabelecimento	= cd_estabelecimento_pc
	and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '');

cProcGuia03 CURSOR(	nr_seq_segurado_pc bigint, nr_seq_guia_pc bigint, cd_estabelecimento_pc bigint,
			dt_ref_inicial_pc timestamp, dt_ref_final_pc timestamp, nr_seq_clinica_regra_pc bigint) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_solicitada,
		b.nr_seq_prestador,
		b.nr_seq_segurado,
		b.ie_tipo_processo,
		b.cd_medico_solicitante,
		b.nm_usuario_solic
	from	pls_guia_plano		b,
		pls_guia_plano_proc	a
	where	a.nr_seq_guia		= b.nr_sequencia
	and	b.nr_seq_segurado	= nr_seq_segurado_pc
	and	b.cd_estabelecimento	= cd_estabelecimento_pc
	and	((b.ie_status		<> '3')
	or (b.nr_sequencia	= nr_seq_guia_pc))
	and	a.dt_liberacao		between dt_ref_inicial_pc and dt_ref_final_pc
	and (b.nr_seq_clinica	= nr_seq_clinica_regra_pc or coalesce(nr_seq_clinica_regra_pc::text, '') = '');

cProcRequisicao01 CURSOR(	nr_seq_segurado_pc bigint, nr_seq_requisicao_pc bigint, cd_estabelecimento_pc text,
				dt_ref_inicial_pc timestamp, dt_ref_final_pc timestamp, nr_seq_clinica_regra_pc bigint) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_solicitado,
		b.nr_seq_prestador,
		b.nr_seq_segurado,
		b.ie_tipo_processo,
		b.cd_medico_solicitante,
		b.nm_usuario_solic
	from	pls_requisicao		b,
		pls_requisicao_proc	a
	where	a.nr_seq_requisicao	= b.nr_sequencia
	and	b.nr_seq_segurado	= nr_seq_segurado_pc
	and	b.cd_estabelecimento	= cd_estabelecimento_pc
	and	((b.ie_estagio		in (2,4))
	or (b.nr_sequencia	= nr_seq_requisicao_pc))
	and	trunc(b.dt_requisicao) between dt_ref_inicial_pc and dt_ref_final_pc
	and (b.nr_seq_clinica	= nr_seq_clinica_regra_pc or coalesce(nr_seq_clinica_regra_pc::text, '') = '');
	
cProcRequisicao02 CURSOR(	nr_seq_segurado_pc bigint, nr_seq_requisicao_pc bigint, cd_estabelecimento_pc text) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_solicitado,
		b.nr_seq_prestador,
		b.nr_seq_segurado,
		b.ie_tipo_processo,
		b.cd_medico_solicitante,
		b.nm_usuario_solic
	from	pls_requisicao		b,
		pls_requisicao_proc	a
	where	a.nr_seq_requisicao	= b.nr_sequencia
	and	b.nr_seq_segurado	= nr_seq_segurado_pc
	and	b.nr_sequencia		= nr_seq_requisicao_pc
	and	b.cd_estabelecimento	= cd_estabelecimento_pc
	and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '');

cProcRequisicao03 CURSOR(	nr_seq_segurado_pc bigint, nr_seq_requisicao_pc bigint, cd_estabelecimento_pc text,
				dt_ref_inicial_pc timestamp, dt_ref_final_pc timestamp, nr_seq_clinica_regra_pc bigint) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_solicitado,
		b.nr_seq_prestador,
		b.nr_seq_segurado,
		b.ie_tipo_processo,
		b.cd_medico_solicitante,
		b.nm_usuario_solic
	from	pls_requisicao		b,
		pls_requisicao_proc	a
	where	a.nr_seq_requisicao	= b.nr_sequencia
	and	b.nr_seq_segurado	= nr_seq_segurado_pc
	and	b.cd_estabelecimento	= cd_estabelecimento_pc
	and	((b.ie_estagio		in (2,4))
	or (b.nr_sequencia	= nr_seq_requisicao_pc))
	and	b.dt_requisicao		between dt_ref_inicial_pc and dt_ref_final_pc
	and (b.nr_seq_clinica	= nr_seq_clinica_regra_pc or coalesce(nr_seq_clinica_regra_pc::text, '') = '');
	
cProcExecucao CURSOR(	nr_seq_segurado_pc bigint, nr_seq_execucao_pc bigint, dt_ref_inicial_pc timestamp,
			dt_ref_final_pc timestamp, nr_seq_clinica_regra_pc bigint) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_item,
		c.nr_seq_prestador,
		c.nr_seq_segurado,
		c.ie_tipo_processo,
		c.cd_medico_solicitante,
		c.nm_usuario_solic
	from	pls_requisicao 		c,
		pls_execucao_requisicao	b,
		pls_execucao_req_item	a
	where	a.nr_seq_execucao	= b.nr_sequencia
	and	b.nr_seq_requisicao	= c.nr_sequencia
	and	a.nr_seq_segurado	= nr_seq_segurado_pc
	and	((a.ie_situacao		not in ('C','G','N','U'))
	or (b.nr_sequencia	= nr_seq_execucao_p))
	and	trunc(b.dt_execucao) between dt_ref_inicial_pc and dt_ref_final_pc
	and (c.nr_seq_clinica	= nr_seq_clinica_regra_pc or coalesce(nr_seq_clinica_regra_pc::text, '') = '');

cProcExecucao01 CURSOR(	nr_seq_segurado_pc bigint, nr_seq_execucao_pc bigint, dt_ref_inicial_pc timestamp,
				dt_ref_final_pc timestamp, nr_seq_clinica_regra_pc bigint) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_item,
		c.nr_seq_prestador,
		c.nr_seq_segurado,
		c.ie_tipo_processo,
		c.cd_medico_solicitante,
		c.nm_usuario_solic
	from	pls_requisicao 		c,
		pls_execucao_requisicao	b,
		pls_execucao_req_item	a
	where	a.nr_seq_execucao	= b.nr_sequencia
	and	b.nr_seq_requisicao	= c.nr_sequencia
	and	a.nr_seq_segurado	= nr_seq_segurado_pc
	and	((a.ie_situacao		not in ('C','G','N','U'))
	or (b.nr_sequencia	= nr_seq_execucao_p))
	and	b.dt_execucao		between dt_ref_inicial_pc and dt_ref_final_pc
	and (c.nr_seq_clinica	= nr_seq_clinica_regra_pc or coalesce(nr_seq_clinica_regra_pc::text, '') = '');

cProcConta01 CURSOR(	cd_estabelecimento_pc bigint, dt_ref_inicial_pc timestamp, dt_ref_final_pc timestamp,
			nr_seq_guia_pc bigint, nr_seq_requisicao_pc bigint) FOR
	SELECT	b.cd_procedimento,
		b.ie_origem_proced,
		b.qt_procedimento_imp
	from	pls_conta		a,
		pls_conta_proc		b,
		pls_segurado		c
	where	a.nr_sequencia		= b.nr_seq_conta
	and	c.nr_sequencia		= a.nr_seq_segurado
	and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
	and	a.cd_estabelecimento	= cd_estabelecimento_pc
	and	a.ie_status		<> 'C'
	and	b.ie_status		<> 'D'
	and	coalesce(b.dt_procedimento, a.dt_atendimento_referencia) between dt_ref_inicial_pc and dt_ref_final_pc
	
union 	all

	PERFORM	b.cd_procedimento,
		b.ie_origem_proced,
		b.qt_solicitada
	from	pls_guia_plano		a,
		pls_guia_plano_proc	b
	where	b.nr_seq_guia		= a.nr_sequencia
	and	a.cd_estabelecimento	= cd_estabelecimento_pc
	and	a.nr_sequencia		= nr_seq_guia_pc
	
union 	all

	select	b.cd_procedimento,
		b.ie_origem_proced,
		b.qt_solicitado
	from	pls_requisicao		a,
		pls_requisicao_proc	b
	where	b.nr_seq_requisicao	= a.nr_sequencia
	and	a.cd_estabelecimento	= cd_estabelecimento_pc
	and	a.nr_sequencia		= nr_seq_requisicao_pc;
	
cProcConta02 CURSOR(	cd_estabelecimento_pc bigint, dt_ref_inicial_pc timestamp, dt_ref_final_pc timestamp,
			nr_seq_guia_pc bigint, nr_seq_requisicao_pc bigint) FOR
	SELECT	b.cd_procedimento,
		b.ie_origem_proced,
		b.qt_procedimento_imp
	from	pls_conta		a,
		pls_conta_proc		b,
		pls_segurado		c
	where	a.nr_sequencia		= b.nr_seq_conta
	and	c.nr_sequencia		= a.nr_seq_segurado
	and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
	and	a.cd_estabelecimento	= cd_estabelecimento_pc
	and	a.ie_status		<> 'C'
	and	b.ie_status		<> 'D'
	and	trunc(coalesce(b.dt_procedimento, a.dt_atendimento_referencia)) between dt_ref_inicial_pc and dt_ref_final_pc
	
union 	all

	PERFORM	b.cd_procedimento,
		b.ie_origem_proced,
		b.qt_solicitada
	from	pls_guia_plano		a,
		pls_guia_plano_proc	b
	where	b.nr_seq_guia		= a.nr_sequencia
	and	a.cd_estabelecimento	= cd_estabelecimento_pc
	and	a.nr_sequencia		= nr_seq_guia_pc
	
union 	all

	select	b.cd_procedimento,
		b.ie_origem_proced,
		b.qt_solicitado
	from	pls_requisicao		a,
		pls_requisicao_proc	b
	where	b.nr_seq_requisicao	= a.nr_sequencia
	and	a.cd_estabelecimento	= cd_estabelecimento_pc
	and	a.nr_sequencia		= nr_seq_requisicao_pc;
	
cValidaExecProc01 CURSOR(	nr_seq_segurado_pc bigint, dt_ref_inicial_pc timestamp,
			dt_ref_final_pc timestamp) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_item,
		b.nr_seq_requisicao
	from	pls_execucao_requisicao	b,
		pls_execucao_req_item	a
	where	a.nr_seq_execucao	= b.nr_sequencia
	and	a.nr_seq_segurado	= nr_seq_segurado_pc
	and	a.ie_situacao		not in ('C','G','N','U')
	and	trunc(b.dt_execucao) between dt_ref_inicial_pc and dt_ref_final_pc
	and	coalesce(a.nr_seq_material::text, '') = '';

cValidaExecProc02 CURSOR(	nr_seq_segurado_pc bigint, dt_ref_inicial_pc timestamp,
				dt_ref_final_pc timestamp) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_item,
		b.nr_seq_requisicao
	from	pls_execucao_requisicao	b,
		pls_execucao_req_item	a
	where	a.nr_seq_execucao	= b.nr_sequencia
	and	a.nr_seq_segurado	= nr_seq_segurado_pc
	and	a.ie_situacao		not in ('C','G','N','U')
	and	b.dt_execucao		between dt_ref_inicial_pc and dt_ref_final_pc
	and	coalesce(a.nr_seq_material::text, '') = '';

BEGIN

if (ie_valida_conta_p = 'S') then
	begin
		select	cd_pessoa_fisica
		into STRICT	cd_pessoa_fisica_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_p;
	exception
	when others then
		cd_pessoa_fisica_w	:= null;
	end;
	
	if (coalesce(cd_procedimento_p,0) > 0) then
		if (ie_valida_grupo_serv_p = 'N') then
			if (ie_tipo_incidencia_p = 'H') then
				select 	coalesce(sum(b.qt_procedimento_imp),0)
				into STRICT	qt_liberacao_w
				from	pls_conta		a,
					pls_conta_proc		b,
					pls_segurado		c
				where	a.nr_sequencia		= b.nr_seq_conta
				and	c.nr_sequencia		= a.nr_seq_segurado
				and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
				and	a.cd_estabelecimento	= cd_estabelecimento_p
				and	b.cd_procedimento	= cd_procedimento_p
				and	b.ie_origem_proced	= ie_origem_proced_p
				and	a.ie_status		<> 'C'
				and	b.ie_status		<> 'D'		
				and	coalesce(b.dt_procedimento, a.dt_atendimento_referencia) between dt_ref_inicial_p and dt_ref_final_p;
			else
				select 	coalesce(sum(b.qt_procedimento_imp),0)
				into STRICT	qt_liberacao_w
				from	pls_conta		a,
					pls_conta_proc		b,
					pls_segurado		c
				where	a.nr_sequencia		= b.nr_seq_conta
				and	c.nr_sequencia		= a.nr_seq_segurado
				and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
				and	a.cd_estabelecimento	= cd_estabelecimento_p
				and	b.cd_procedimento	= cd_procedimento_p
				and	b.ie_origem_proced	= ie_origem_proced_p
				and	a.ie_status		<> 'C'
				and	b.ie_status		<> 'D'		
				and	trunc(coalesce(b.dt_procedimento, a.dt_atendimento_referencia)) between dt_ref_inicial_p and dt_ref_final_p;	
				
			end if;
		elsif (ie_valida_grupo_serv_p = 'S') then
			for r_C01_w in C01(nr_seq_ocor_combinada_p) loop				
				begin					
				if (ie_tipo_incidencia_p = 'H') then
					for r_cProcConta01_w in cProcConta01(cd_estabelecimento_p, dt_ref_inicial_p, dt_ref_final_p, nr_seq_guia_p, nr_seq_requisicao_p) loop
						begin
						ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cProcConta01_w.cd_procedimento, r_cProcConta01_w.ie_origem_proced);
						
						
						if (ie_grupo_servico_w	= 'S') then
							qt_liberacao_w	:= qt_liberacao_w + r_cProcConta01_w.qt_procedimento_imp;
						end if;
						end;
					end loop;						
				else	
					for r_cProcConta02_w in cProcConta02(cd_estabelecimento_p, dt_ref_inicial_p, dt_ref_final_p, nr_seq_guia_p, nr_seq_requisicao_p) loop
						begin
						ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cProcConta02_w.cd_procedimento, r_cProcConta02_w.ie_origem_proced);
						
						if (ie_grupo_servico_w	= 'S') then
							qt_liberacao_w	:= qt_liberacao_w + r_cProcConta02_w.qt_procedimento_imp;						
						end if;						
						end;
					end loop;
				end if;
				end;
			end loop;
		end if;
	elsif (coalesce(nr_seq_material_p,0) > 0) then
		if (ie_tipo_incidencia_p = 'H') then
			select	coalesce(sum(b.qt_material_imp),0)
			into STRICT	qt_liberacao_w
			from	pls_conta		a,
				pls_conta_mat		b,
				pls_segurado		c
			where	a.nr_sequencia		= b.nr_seq_conta
			and	c.nr_sequencia		= a.nr_seq_segurado
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	a.cd_estabelecimento	= cd_estabelecimento_p
			and	b.nr_seq_material	= nr_seq_material_p
			and	a.ie_status		<> 'C'
			and	b.ie_status		<> 'D'	
			and	coalesce(b.dt_atendimento, a.dt_atendimento_referencia) between dt_ref_inicial_p and dt_ref_final_p;		
		else
			select	coalesce(sum(b.qt_material_imp),0)
			into STRICT	qt_liberacao_w
			from	pls_conta		a,
				pls_conta_mat		b,
				pls_segurado		c
			where	a.nr_sequencia		= b.nr_seq_conta
			and	c.nr_sequencia		= a.nr_seq_segurado
			and	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	a.cd_estabelecimento	= cd_estabelecimento_p
			and	b.nr_seq_material	= nr_seq_material_p
			and	a.ie_status		<> 'C'
			and	b.ie_status		<> 'D'	
			and	trunc(coalesce(b.dt_atendimento, a.dt_atendimento_referencia)) between dt_ref_inicial_p and dt_ref_final_p;	
		end if;
	end if;		
else
	--Capturar medico e especialidade
	if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '')then
		select 	coalesce(cd_medico_solicitante,''),
			coalesce(nr_seq_cbo_saude,0),
			coalesce(cd_especialidade,0)
		into STRICT 	cd_medico_solicitante_w,
			nr_seq_cbo_saude_w,
			cd_especialidade_w
		from 	pls_requisicao
		where 	nr_sequencia = nr_seq_requisicao_p;
	elsif (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
		select 	coalesce(cd_medico_solicitante,''),
			coalesce(nr_seq_cbo_saude,0),
			coalesce(cd_especialidade,0)
		into STRICT 	cd_medico_solicitante_w,
			nr_seq_cbo_saude_w,
			cd_especialidade_w
		from 	pls_guia_plano
		where 	nr_sequencia = nr_seq_guia_p;
	elsif (nr_seq_execucao_p IS NOT NULL AND nr_seq_execucao_p::text <> '') then
		select 	coalesce(b.cd_medico_solicitante,''),
			coalesce(b.nr_seq_cbo_saude,0),
			coalesce(b.cd_especialidade,0)
		into STRICT 	cd_medico_solicitante_w,
			nr_seq_cbo_saude_w,
			cd_especialidade_w
		from 	pls_execucao_requisicao a,
			pls_requisicao b
		where 	a.nr_seq_requisicao = b.nr_sequencia
		and 	a.nr_sequencia = nr_seq_execucao_p;	
	end if;
		
	if (coalesce(nr_seq_guia_p,0) > 0) then	
		if (coalesce(cd_procedimento_p,0) > 0) then
			if (ie_valida_grupo_serv_p = 'N') then
				if (ie_tipo_incidencia_p = 'G') then				
					if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then						
						select 	coalesce(sum(a.qt_solicitada),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_guia_w
						from	pls_guia_plano		b,
							pls_guia_plano_proc	a
						where	a.nr_seq_guia		= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_sequencia		= nr_seq_guia_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then						
						select 	coalesce(sum(a.qt_solicitada),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_guia_w
						from	pls_guia_plano		b,
							pls_guia_plano_proc	a
						where	a.nr_seq_guia		= b.nr_sequencia
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		= nr_seq_guia_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_solicitada),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_guia_w
						from	pls_guia_plano		b,
							pls_guia_plano_proc	a
						where	a.nr_seq_guia		= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		= nr_seq_guia_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					end if;
				elsif (ie_tipo_incidencia_p = 'H') then					
					if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then						
						select 	coalesce(sum(a.qt_autorizada),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_guia_w
						from	pls_guia_plano		b,
							pls_guia_plano_proc	a
						where	a.nr_seq_guia		= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_sequencia		<> nr_seq_guia_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_status		<> '3'
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	a.dt_liberacao		between dt_ref_inicial_p and dt_ref_final_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_autorizada),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_guia_w
						from	pls_guia_plano		b,
							pls_guia_plano_proc	a
						where	a.nr_seq_guia		= b.nr_sequencia
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_guia_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_status		<> '3'
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	a.dt_liberacao		between dt_ref_inicial_p and dt_ref_final_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_autorizada),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_guia_w
						from	pls_guia_plano		b,
							pls_guia_plano_proc	a
						where	a.nr_seq_guia		= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_guia_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_status		<> '3'
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	a.dt_liberacao		between dt_ref_inicial_p and dt_ref_final_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					end if;
				else
					
					if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
						select 	coalesce(sum(a.qt_autorizada),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_guia_w
						from	pls_guia_plano		b,
							pls_guia_plano_proc	a
						where	a.nr_seq_guia		= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_sequencia		<> nr_seq_guia_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_status		<> '3'
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	trunc(a.dt_liberacao) between trunc(dt_ref_inicial_p) and trunc(dt_ref_final_p)
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_autorizada),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_guia_w
						from	pls_guia_plano		b,
							pls_guia_plano_proc	a
						where	a.nr_seq_guia		= b.nr_sequencia
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_guia_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_status		<> '3'
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	trunc(a.dt_liberacao) between trunc(dt_ref_inicial_p) and trunc(dt_ref_final_p)
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_autorizada),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_guia_w
						from	pls_guia_plano		b,
							pls_guia_plano_proc	a
						where	a.nr_seq_guia		= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_guia_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_status		<> '3'
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	trunc(a.dt_liberacao) between trunc(dt_ref_inicial_p) and trunc(dt_ref_final_p)
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					end if;

					
				end if;						
			elsif (ie_valida_grupo_serv_p = 'S') then
				for r_C01_w in C01(nr_seq_ocor_combinada_p) loop
					begin

					if (ie_tipo_incidencia_p = 'G') then
						for r_cProcGuia02_w in cProcGuia02(nr_seq_segurado_p, nr_seq_guia_p, cd_estabelecimento_p) loop
							begin
							
							ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cProcGuia02_w.cd_procedimento, r_cProcGuia02_w.ie_origem_proced);
							
							ie_local_atend_w := 'N';
							
							ie_regra_qtd_w := 'N';
							
							ie_regra_tipo_pessoa_w := 'N';
							
							if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
								if (r_cProcGuia02_w.nr_seq_segurado = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
								if (r_cProcGuia02_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
								if	(r_cProcGuia02_w.nr_seq_segurado = nr_seq_segurado_regra_p AND r_cProcGuia02_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							end if;
							
							if (cd_medico_solic_p IS NOT NULL AND cd_medico_solic_p::text <> '') then
								if (r_cProcGuia02_w.cd_medico_solicitante = cd_medico_solic_p) then
									ie_regra_qtd_w := 'S';
								end if;
							else
								ie_regra_qtd_w := 'S';
							end if;
							
							if (nr_seq_local_atend_p IS NOT NULL AND nr_seq_local_atend_p::text <> '') then
								if (r_cProcGuia02_w.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(r_cProcGuia02_w.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p) then									
										
										ie_local_atend_w := 'S';
										
								end if;
							else
								ie_local_atend_w := 'S';
							end if;
							
							if (ie_grupo_servico_w	= 'S') and (ie_local_atend_w = 'S') and (ie_regra_qtd_w = 'S') and (ie_regra_tipo_pessoa_w = 'S') then
								qt_liberacao_w	:= qt_liberacao_w + r_cProcGuia02_w.qt_solicitada; 							
							end if;
							end;
						end loop;
					elsif (ie_tipo_incidencia_p = 'H') then
						for r_cProcGuia03_w in cProcGuia03(nr_seq_segurado_p, nr_seq_guia_p, cd_estabelecimento_p, dt_ref_inicial_p, dt_ref_final_p, nr_seq_clinica_regra_p) loop
							begin
							ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cProcGuia03_w.cd_procedimento, r_cProcGuia03_w.ie_origem_proced);
							
							ie_local_atend_w := 'N';
							
							ie_regra_qtd_w := 'N';
							
							ie_regra_tipo_pessoa_w := 'N';
							
							if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
								if (r_cProcGuia03_w.nr_seq_segurado = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
								if (r_cProcGuia03_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
								if	(r_cProcGuia03_w.nr_seq_segurado = nr_seq_segurado_regra_p AND r_cProcGuia03_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							end if;
							
							if (cd_medico_solic_p IS NOT NULL AND cd_medico_solic_p::text <> '') then
								if (r_cProcGuia03_w.cd_medico_solicitante = cd_medico_solic_p) then
									ie_regra_qtd_w := 'S';
								end if;
							else
								ie_regra_qtd_w := 'S';
							end if;
							
							if (nr_seq_local_atend_p IS NOT NULL AND nr_seq_local_atend_p::text <> '') then
								if (r_cProcGuia03_w.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(r_cProcGuia03_w.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p) then
										
										ie_local_atend_w := 'S';
										
								end if;
							else
								ie_local_atend_w := 'S';
							end if;
							
							if (ie_grupo_servico_w	= 'S') and (ie_local_atend_w = 'S') and (ie_regra_qtd_w = 'S') and (ie_regra_tipo_pessoa_w = 'S') then
								qt_liberacao_w	:= qt_liberacao_w + r_cProcGuia03_w.qt_solicitada;
							end if;
							end;
						end loop;
					else	
						for r_cProcGuia01_w in cProcGuia01(nr_seq_segurado_p, nr_seq_guia_p, cd_estabelecimento_p, dt_ref_inicial_p, dt_ref_final_p, nr_seq_clinica_regra_p) loop
							begin
							ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cProcGuia01_w.cd_procedimento, r_cProcGuia01_w.ie_origem_proced);
							
							ie_local_atend_w := 'N';
							
							ie_regra_qtd_w := 'N';
							
							ie_regra_tipo_pessoa_w := 'N';
							
							if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
								if (r_cProcGuia01_w.nr_seq_segurado = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
								if (r_cProcGuia01_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
								if	(r_cProcGuia01_w.nr_seq_segurado = nr_seq_segurado_regra_p AND r_cProcGuia01_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							end if;
							
							if (cd_medico_solic_p IS NOT NULL AND cd_medico_solic_p::text <> '') then
								if (r_cProcGuia01_w.cd_medico_solicitante = cd_medico_solic_p) then
									ie_regra_qtd_w := 'S';
								end if;
							else
								ie_regra_qtd_w := 'S';
							end if;
							
							if (nr_seq_local_atend_p IS NOT NULL AND nr_seq_local_atend_p::text <> '') then
								if (r_cProcGuia01_w.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(r_cProcGuia01_w.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p) then
										
										ie_local_atend_w := 'S';
				
								end if;
							else
								ie_local_atend_w := 'S';
							end if;
							
							if (ie_grupo_servico_w	= 'S') and (ie_local_atend_w = 'S') and (ie_regra_qtd_w = 'S') and (ie_regra_tipo_pessoa_w = 'S') then
								qt_liberacao_w	:= qt_liberacao_w + r_cProcGuia01_w.qt_solicitada;
							end if;
							end;
						end loop;
					end if;
					
					end;
				end loop;
			end if;			
		elsif (coalesce(nr_seq_material_p,0) > 0) then
			if (ie_tipo_incidencia_p = 'G') then
				if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
					select 	coalesce(sum(a.qt_solicitada),0),
						max(b.nr_sequencia)
					into STRICT	qt_liberacao_w,
						nr_seq_guia_w
					from	pls_guia_plano		b,
						pls_guia_plano_mat	a
					where	a.nr_seq_guia		= b.nr_sequencia
					and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
					and	b.nr_sequencia		= nr_seq_guia_p
					and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	a.nr_seq_material	= nr_seq_material_p
					and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
					)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (b.cd_medico_solicitante = cd_medico_solic_p)
					);
				elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
					select 	coalesce(sum(a.qt_solicitada),0),
						max(b.nr_sequencia)
					into STRICT	qt_liberacao_w,
						nr_seq_guia_w
					from	pls_guia_plano		b,
						pls_guia_plano_mat	a
					where	a.nr_seq_guia		= b.nr_sequencia
					and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
					and	b.nr_sequencia		= nr_seq_guia_p
					and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	a.nr_seq_material	= nr_seq_material_p
					and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
					)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (b.cd_medico_solicitante = cd_medico_solic_p)
					);
				elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
					select 	coalesce(sum(a.qt_solicitada),0),
						max(b.nr_sequencia)
					into STRICT	qt_liberacao_w,
						nr_seq_guia_w
					from	pls_guia_plano		b,
						pls_guia_plano_mat	a
					where	a.nr_seq_guia		= b.nr_sequencia
					and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
					and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
					and	b.nr_sequencia		= nr_seq_guia_p
					and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	a.nr_seq_material	= nr_seq_material_p
					and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
					)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (b.cd_medico_solicitante = cd_medico_solic_p)
					);
				end if;
			elsif (ie_tipo_incidencia_p = 'H') then
				if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
					select 	coalesce(sum(a.qt_autorizada),0),
						max(b.nr_sequencia)
					into STRICT	qt_liberacao_w,
						nr_seq_guia_w
					from	pls_guia_plano		b,
						pls_guia_plano_mat	a
					where	a.nr_seq_guia		= b.nr_sequencia
					and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
					and	b.nr_sequencia		<> nr_seq_guia_p
					and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	b.ie_status 		<> '3'
					and	a.nr_seq_material	= nr_seq_material_p
					and	a.dt_liberacao		between dt_ref_inicial_p and dt_ref_final_p
					and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
					)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (b.cd_medico_solicitante = cd_medico_solic_p)
					);
				elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
					select 	coalesce(sum(a.qt_autorizada),0),
						max(b.nr_sequencia)
					into STRICT	qt_liberacao_w,
						nr_seq_guia_w
					from	pls_guia_plano		b,
						pls_guia_plano_mat	a
					where	a.nr_seq_guia		= b.nr_sequencia
					and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
					and	b.nr_sequencia		<> nr_seq_guia_p
					and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	b.ie_status 		<> '3'
					and	a.nr_seq_material	= nr_seq_material_p
					and	a.dt_liberacao		between dt_ref_inicial_p and dt_ref_final_p
					and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (b.cd_medico_solicitante = cd_medico_solic_p)
					);
				elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
					select 	coalesce(sum(a.qt_autorizada),0),
						max(b.nr_sequencia)
					into STRICT	qt_liberacao_w,
						nr_seq_guia_w
					from	pls_guia_plano		b,
						pls_guia_plano_mat	a
					where	a.nr_seq_guia		= b.nr_sequencia
					and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
					and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
					and	b.nr_sequencia		<> nr_seq_guia_p
					and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	b.ie_status 		<> '3'
					and	a.nr_seq_material	= nr_seq_material_p
					and	a.dt_liberacao		between dt_ref_inicial_p and dt_ref_final_p
					and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (b.cd_medico_solicitante = cd_medico_solic_p)
					);
				end if;
			else
				if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
					select 	coalesce(sum(a.qt_autorizada),0),
						max(b.nr_sequencia)
					into STRICT	qt_liberacao_w,
						nr_seq_guia_w
					from	pls_guia_plano		b,
						pls_guia_plano_mat	a
					where	a.nr_seq_guia		= b.nr_sequencia
					and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
					and	b.nr_sequencia		<> nr_seq_guia_p
					and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	b.ie_status 		<> '3'
					and	a.nr_seq_material	= nr_seq_material_p
					and	trunc(a.dt_liberacao) between dt_ref_inicial_p and dt_ref_final_p
					and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (b.cd_medico_solicitante = cd_medico_solic_p)
					);
				elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
					select 	coalesce(sum(a.qt_autorizada),0),
						max(b.nr_sequencia)
					into STRICT	qt_liberacao_w,
						nr_seq_guia_w
					from	pls_guia_plano		b,
						pls_guia_plano_mat	a
					where	a.nr_seq_guia		= b.nr_sequencia
					and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
					and	b.nr_sequencia		<> nr_seq_guia_p
					and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	b.ie_status 		<> '3'
					and	a.nr_seq_material	= nr_seq_material_p
					and	trunc(a.dt_liberacao) between dt_ref_inicial_p and dt_ref_final_p
					and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (b.cd_medico_solicitante = cd_medico_solic_p)
					);
				elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
					select 	coalesce(sum(a.qt_autorizada),0),
						max(b.nr_sequencia)
					into STRICT	qt_liberacao_w,
						nr_seq_guia_w
					from	pls_guia_plano		b,
						pls_guia_plano_mat	a
					where	a.nr_seq_guia		= b.nr_sequencia
					and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
					and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
					and	b.nr_sequencia		<> nr_seq_guia_p
					and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	b.ie_status 		<> '3'
					and	a.nr_seq_material	= nr_seq_material_p
					and	trunc(a.dt_liberacao) between dt_ref_inicial_p and dt_ref_final_p
					and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (b.cd_medico_solicitante = cd_medico_solic_p)
					);
				end if;

				
			end if;
		end if;		
	elsif (coalesce(nr_seq_requisicao_p,0) > 0) then
		if (coalesce(cd_procedimento_p,0) > 0) then
			if (coalesce(ie_valida_execucao_p,'N') = 'N') then
				if (ie_valida_grupo_serv_p = 'N') then			
					if (ie_tipo_incidencia_p = 'G') then
						if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
							select 	coalesce(sum(a.qt_solicitado),0),
								max(b.nr_sequencia)
							into STRICT	qt_liberacao_w,
								nr_seq_requisicao_w
							from	pls_requisicao		b,
								pls_requisicao_proc	a
							where	a.nr_seq_requisicao	= b.nr_sequencia
							and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
							and	b.nr_sequencia		= nr_seq_requisicao_p
							and	b.cd_estabelecimento	= cd_estabelecimento_p
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and	((ie_valida_mesma_espec_p = 'N')
							or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
							and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
							or (ie_valida_medico_cbo_p = 'N'))
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									(b.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(b.nm_usuario_solic ,cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							)
							and (
									(coalesce(cd_medico_solic_p::text, '') = '')
								or (b.cd_medico_solicitante = cd_medico_solic_p)
							);
						elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
							select 	coalesce(sum(a.qt_solicitado),0),
								max(b.nr_sequencia)
							into STRICT	qt_liberacao_w,
								nr_seq_requisicao_w
							from	pls_requisicao		b,
								pls_requisicao_proc	a
							where	a.nr_seq_requisicao	= b.nr_sequencia
							and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
							and	b.nr_sequencia		= nr_seq_requisicao_p
							and	b.cd_estabelecimento	= cd_estabelecimento_p
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and	((ie_valida_mesma_espec_p = 'N')
							or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
							and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
							or (ie_valida_medico_cbo_p = 'N'))
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									(b.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(b.nm_usuario_solic, cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							)
							and (
									(coalesce(cd_medico_solic_p::text, '') = '')
								or (b.cd_medico_solicitante = cd_medico_solic_p)
							);

						elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
							select 	coalesce(sum(a.qt_solicitado),0),
								max(b.nr_sequencia)
							into STRICT	qt_liberacao_w,
								nr_seq_requisicao_w
							from	pls_requisicao		b,
								pls_requisicao_proc	a
							where	a.nr_seq_requisicao	= b.nr_sequencia
							and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
							and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
							and	b.nr_sequencia		= nr_seq_requisicao_p
							and	b.cd_estabelecimento	= cd_estabelecimento_p
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and	((ie_valida_mesma_espec_p = 'N')
							or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
							and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
							or (ie_valida_medico_cbo_p = 'N'))
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									(b.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							)
							and (
									(coalesce(cd_medico_solic_p::text, '') = '')
								or (b.cd_medico_solicitante = cd_medico_solic_p)
							);

						end if;			
					elsif (ie_tipo_incidencia_p = 'H') then
						if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
							select 	coalesce(sum(a.qt_procedimento),0),
								max(b.nr_sequencia)
							into STRICT	qt_liberacao_w,
								nr_seq_requisicao_w
							from	pls_requisicao		b,
								pls_requisicao_proc	a
							where	a.nr_seq_requisicao	= b.nr_sequencia
							and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
							and	b.nr_sequencia		<> nr_seq_requisicao_p
							and	b.cd_estabelecimento	= cd_estabelecimento_p
							and	b.ie_estagio		= 2
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	b.dt_requisicao		between dt_ref_inicial_p and dt_ref_final_p
							and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and	((ie_valida_mesma_espec_p = 'N')
							or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
							and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
							or (ie_valida_medico_cbo_p = 'N'))
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									(b.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							)
							and (
									(coalesce(cd_medico_solic_p::text, '') = '')
								or (b.cd_medico_solicitante = cd_medico_solic_p)
							);
						elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
							select 	coalesce(sum(a.qt_procedimento),0),
								max(b.nr_sequencia)
							into STRICT	qt_liberacao_w,
								nr_seq_requisicao_w
							from	pls_requisicao		b,
								pls_requisicao_proc	a
							where	a.nr_seq_requisicao	= b.nr_sequencia
							and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
							and	b.nr_sequencia		<> nr_seq_requisicao_p
							and	b.cd_estabelecimento	= cd_estabelecimento_p
							and	b.ie_estagio		= 2
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	b.dt_requisicao		between dt_ref_inicial_p and dt_ref_final_p
							and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and	((ie_valida_mesma_espec_p = 'N')
							or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
							and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
							or (ie_valida_medico_cbo_p = 'N'))
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									(b.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							)
							and (
									(coalesce(cd_medico_solic_p::text, '') = '')
								or (b.cd_medico_solicitante = cd_medico_solic_p)
							);
						elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
							select 	coalesce(sum(a.qt_procedimento),0),
								max(b.nr_sequencia)
							into STRICT	qt_liberacao_w,
								nr_seq_requisicao_w
							from	pls_requisicao		b,
								pls_requisicao_proc	a
							where	a.nr_seq_requisicao	= b.nr_sequencia
							and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
							and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
							and	b.nr_sequencia		<> nr_seq_requisicao_p
							and	b.cd_estabelecimento	= cd_estabelecimento_p
							and	b.ie_estagio		= 2
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	b.dt_requisicao		between dt_ref_inicial_p and dt_ref_final_p
							and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and	((ie_valida_mesma_espec_p = 'N')
							or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
							and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
							or (ie_valida_medico_cbo_p = 'N'))
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									(b.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							)
							and (
									(coalesce(cd_medico_solic_p::text, '') = '')
								or (b.cd_medico_solicitante = cd_medico_solic_p)
							);
						end if;
					else					
						if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
							select 	coalesce(sum(a.qt_procedimento),0),
								max(b.nr_sequencia)
							into STRICT	qt_liberacao_w,
								nr_seq_requisicao_w
							from	pls_requisicao		b,
								pls_requisicao_proc	a
							where	a.nr_seq_requisicao	= b.nr_sequencia
							and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
							and	b.nr_sequencia		<> nr_seq_requisicao_p
							and	b.cd_estabelecimento	= cd_estabelecimento_p
							and	b.ie_estagio		= 2
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	trunc(b.dt_requisicao)	between dt_ref_inicial_p and dt_ref_final_p
							and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and	((ie_valida_mesma_espec_p = 'N')
							or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
							and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
							or (ie_valida_medico_cbo_p = 'N'))
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									(b.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							)
							and (
									(coalesce(cd_medico_solic_p::text, '') = '')
								or (b.cd_medico_solicitante = cd_medico_solic_p)
							);
						elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
							select 	coalesce(sum(a.qt_procedimento),0),
								max(b.nr_sequencia)
							into STRICT	qt_liberacao_w,
								nr_seq_requisicao_w
							from	pls_requisicao		b,
								pls_requisicao_proc	a
							where	a.nr_seq_requisicao	= b.nr_sequencia
							and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
							and	b.nr_sequencia		<> nr_seq_requisicao_p
							and	b.cd_estabelecimento	= cd_estabelecimento_p
							and	b.ie_estagio		= 2
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	trunc(b.dt_requisicao)	between dt_ref_inicial_p and dt_ref_final_p
							and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and	((ie_valida_mesma_espec_p = 'N')
							or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
							and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
							or (ie_valida_medico_cbo_p = 'N'))
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									(b.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							)
							and (
									(coalesce(cd_medico_solic_p::text, '') = '')
								or (b.cd_medico_solicitante = cd_medico_solic_p)
							);

						elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
							select 	coalesce(sum(a.qt_procedimento),0),
								max(b.nr_sequencia)
							into STRICT	qt_liberacao_w,
								nr_seq_requisicao_w
							from	pls_requisicao		b,
								pls_requisicao_proc	a
							where	a.nr_seq_requisicao	= b.nr_sequencia
							and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
							and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
							and	b.nr_sequencia		<> nr_seq_requisicao_p
							and	b.cd_estabelecimento	= cd_estabelecimento_p
							and	b.ie_estagio		= 2
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	trunc(b.dt_requisicao)	between dt_ref_inicial_p and dt_ref_final_p
							and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and	((ie_valida_mesma_espec_p = 'N')
							or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
							and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
							or (ie_valida_medico_cbo_p = 'N'))
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									(b.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							)
							and (
									(coalesce(cd_medico_solic_p::text, '') = '')
								or (b.cd_medico_solicitante = cd_medico_solic_p)
							);

						end if;
					end if;
				elsif (ie_valida_grupo_serv_p = 'S') then		
					for r_C01_w in C01(nr_seq_ocor_combinada_p) loop
						begin
						if (ie_tipo_incidencia_p = 'G') then
							for r_cProcRequisicao02_w in cProcRequisicao02(nr_seq_segurado_p, nr_seq_requisicao_p, cd_estabelecimento_p) loop
								begin
								ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cProcRequisicao02_w.cd_procedimento, r_cProcRequisicao02_w.ie_origem_proced);
								
								ie_local_atend_w := 'N';
								
								ie_regra_qtd_w := 'N';
								
								ie_regra_tipo_pessoa_w := 'N';
								
								if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
									if (r_cProcRequisicao02_w.nr_seq_segurado = nr_seq_segurado_regra_p) then
										ie_regra_tipo_pessoa_w := 'S';
									end if;
								elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
									if (r_cProcRequisicao02_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
										ie_regra_tipo_pessoa_w := 'S';
									end if;
								elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
									if	(r_cProcRequisicao02_w.nr_seq_segurado = nr_seq_segurado_regra_p AND r_cProcRequisicao02_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
										ie_regra_tipo_pessoa_w := 'S';
									end if;
								end if;
								
								if (nr_seq_local_atend_p IS NOT NULL AND nr_seq_local_atend_p::text <> '') then
									if (r_cProcRequisicao02_w.ie_tipo_processo = 'P')
									and (pls_obter_local_atend_usuario(r_cProcRequisicao02_w.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p) then
									
											ie_local_atend_w := 'S';
										
									end if;
								else
									ie_local_atend_w := 'S';
								end if;
								
								if (cd_medico_solic_p IS NOT NULL AND cd_medico_solic_p::text <> '') then
									if (r_cProcRequisicao02_w.cd_medico_solicitante = cd_medico_solic_p) then
										ie_regra_qtd_w := 'S';
									end if;
								else
									ie_regra_qtd_w := 'S';
								end if;
								
								if (ie_grupo_servico_w	= 'S') and (ie_local_atend_w	= 'S') and (ie_regra_qtd_w	= 'S') and (ie_regra_tipo_pessoa_w = 'S') then
									qt_liberacao_w	:= qt_liberacao_w + r_cProcRequisicao02_w.qt_solicitado;
								
								end if;
								end;
							end loop;

						elsif (ie_tipo_incidencia_p = 'H') then
							for r_cProcRequisicao03_w in cProcRequisicao03(nr_seq_segurado_p, nr_seq_requisicao_p, cd_estabelecimento_p, dt_ref_inicial_p, dt_ref_final_p, nr_seq_clinica_regra_p) loop
								begin
								ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cProcRequisicao03_w.cd_procedimento, r_cProcRequisicao03_w.ie_origem_proced);
								
								ie_local_atend_w 	:= 'N';
								
								ie_regra_qtd_w		:= 'N';
								
								ie_regra_tipo_pessoa_w := 'N';
								
								if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
									if (r_cProcRequisicao03_w.nr_seq_segurado = nr_seq_segurado_regra_p) then
										ie_regra_tipo_pessoa_w := 'S';
									end if;
								elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
									if (r_cProcRequisicao03_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
										ie_regra_tipo_pessoa_w := 'S';
									end if;
								elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
									if	(r_cProcRequisicao03_w.nr_seq_segurado = nr_seq_segurado_regra_p AND r_cProcRequisicao03_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
										ie_regra_tipo_pessoa_w := 'S';
									end if;
								end if;
								
								if (nr_seq_local_atend_p IS NOT NULL AND nr_seq_local_atend_p::text <> '') then
									if (r_cProcRequisicao03_w.ie_tipo_processo = 'P')
									and (pls_obter_local_atend_usuario(r_cProcRequisicao03_w.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p) then
									
											ie_local_atend_w := 'S';

									end if;
								else
									ie_local_atend_w := 'S';
								end if;
								
								if (cd_medico_solic_p IS NOT NULL AND cd_medico_solic_p::text <> '') then
									if (r_cProcRequisicao03_w.cd_medico_solicitante = cd_medico_solic_p) then
										ie_regra_qtd_w := 'S';
									end if;
								else
									ie_regra_qtd_w := 'S';
								end if;
								
								if (ie_grupo_servico_w	= 'S') and (ie_local_atend_w	= 'S') and (ie_regra_qtd_w	= 'S') and (ie_regra_tipo_pessoa_w = 'S') then
									qt_liberacao_w	:= qt_liberacao_w + r_cProcRequisicao03_w.qt_solicitado;
								end if;
								end;
							end loop;
						else
							for r_cProcRequisicao01_w in cProcRequisicao01(nr_seq_segurado_p, nr_seq_requisicao_p, cd_estabelecimento_p, dt_ref_inicial_p, dt_ref_final_p, nr_seq_clinica_regra_p) loop
								begin
								ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cProcRequisicao01_w.cd_procedimento, r_cProcRequisicao01_w.ie_origem_proced);
								
								ie_local_atend_w	:= 'N';
								
								ie_regra_qtd_w		:= 'N';
								
								ie_regra_tipo_pessoa_w := 'N';
								
								if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
									if (r_cProcRequisicao01_w.nr_seq_segurado = nr_seq_segurado_regra_p) then
										ie_regra_tipo_pessoa_w := 'S';
									end if;
								elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
									if (r_cProcRequisicao01_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
										ie_regra_tipo_pessoa_w := 'S';
									end if;
								elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
									if	(r_cProcRequisicao01_w.nr_seq_segurado = nr_seq_segurado_regra_p AND r_cProcRequisicao01_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
										ie_regra_tipo_pessoa_w := 'S';
									end if;
								end if;
								
								if (nr_seq_local_atend_p IS NOT NULL AND nr_seq_local_atend_p::text <> '') then
									if (r_cProcRequisicao01_w.ie_tipo_processo = 'P')
									and (pls_obter_local_atend_usuario(r_cProcRequisicao01_w.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p) then
									
											ie_local_atend_w := 'S';
										
									end if;
								else
									ie_local_atend_w := 'S';
								end if;
								
								if (cd_medico_solic_p IS NOT NULL AND cd_medico_solic_p::text <> '') then
									if (r_cProcRequisicao01_w.cd_medico_solicitante = cd_medico_solic_p) then
										ie_regra_qtd_w := 'S';
									end if;
								else
									ie_regra_qtd_w := 'S';
								end if;
								
								if (ie_grupo_servico_w	= 'S') and (ie_local_atend_w	= 'S') and (ie_regra_qtd_w	= 'S') and (ie_regra_tipo_pessoa_w = 'S') then
									qt_liberacao_w	:= qt_liberacao_w + r_cProcRequisicao01_w.qt_solicitado;
								end if;
								end;
							end loop;
						end if;
						end;
					end loop;
				end if;
			elsif (coalesce(ie_valida_execucao_p,'N') = 'S') then
				if (ie_valida_grupo_serv_p = 'N') then					
					if (ie_tipo_incidencia_p = 'H') then
						if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
							select 	coalesce(sum(a.qt_item),0) qt_item,
								max(a.nr_sequencia) nr_seq_exec_item
							into STRICT	qt_liberacao_w,
								nr_seq_exec_item_w
							from	pls_execucao_requisicao	b,
								pls_execucao_req_item	a
							where	a.nr_seq_execucao	= b.nr_sequencia
							and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
							and	a.ie_situacao		not in ('C','G','N','U')
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
							and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
								and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							);
						elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
							select 	coalesce(sum(a.qt_item),0) qt_item,
								max(a.nr_sequencia) nr_seq_exec_item
							into STRICT	qt_liberacao_w,
								nr_seq_exec_item_w
							from	pls_execucao_requisicao	b,
								pls_execucao_req_item	a
							where	a.nr_seq_execucao	= b.nr_sequencia
							and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
							and	a.ie_situacao		not in ('C','G','N','U')
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
							and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
								and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							);
						elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
							select 	coalesce(sum(a.qt_item),0) qt_item,
								max(a.nr_sequencia) nr_seq_exec_item
							into STRICT	qt_liberacao_w,
								nr_seq_exec_item_w
							from	pls_execucao_requisicao	b,
								pls_execucao_req_item	a
							where	a.nr_seq_execucao	= b.nr_sequencia
							and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
							and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
							and	a.ie_situacao		not in ('C','G','N','U')
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
							and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
								and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							);
						end if;						
					else
						if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then							
							select 	coalesce(sum(a.qt_item),0) qt_item,
								max(a.nr_sequencia) nr_seq_exec_item
							into STRICT	qt_liberacao_w,
								nr_seq_exec_item_w
							from	pls_execucao_requisicao	b,
								pls_execucao_req_item	a
							where	a.nr_seq_execucao	= b.nr_sequencia
							and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
							and	a.ie_situacao		not in ('C','G','N','U')
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
							and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
								and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							);
						elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
							select 	coalesce(sum(a.qt_item),0) qt_item,
								max(a.nr_sequencia) nr_seq_exec_item
							into STRICT	qt_liberacao_w,
								nr_seq_exec_item_w
							from	pls_execucao_requisicao	b,
								pls_execucao_req_item	a
							where	a.nr_seq_execucao	= b.nr_sequencia
							and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
							and	a.ie_situacao		not in ('C','G','N','U')
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
							and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
								and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							);
						elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then							
							select 	coalesce(sum(a.qt_item),0) qt_item,
								max(a.nr_sequencia) nr_seq_exec_item
							into STRICT	qt_liberacao_w,
								nr_seq_exec_item_w
							from	pls_execucao_requisicao	b,
								pls_execucao_req_item	a
							where	a.nr_seq_execucao	= b.nr_sequencia
							and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
							and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
							and	a.ie_situacao		not in ('C','G','N','U')
							and	a.cd_procedimento	= cd_procedimento_p
							and	a.ie_origem_proced	= ie_origem_proced_p
							and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
							and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
							and (
									(coalesce(nr_seq_local_atend_p::text, '') = '')
								or	(
									((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
								and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
									)
							);
						end if;
					end if;					
				elsif (ie_valida_grupo_serv_p = 'S') then									
					for r_C01_w in C01(nr_seq_ocor_combinada_p) loop
						begin
							if (ie_tipo_incidencia_p = 'H') then
								for r_cValidaExecProc02_w in cValidaExecProc02(nr_seq_segurado_p, dt_ref_inicial_p, dt_ref_final_p) loop									
									begin										
										select	nr_seq_prestador,
											nr_seq_segurado,
											ie_tipo_processo,
											nm_usuario_solic,
											nr_seq_clinica
										into STRICT	nr_seq_prestador_w,
											nr_seq_segurado_w,
											ie_tipo_processo_w,
											nm_usuario_solic_w,
											nr_seq_clinica_w
										from 	pls_requisicao
										where	nr_sequencia = r_cValidaExecProc02_w.nr_seq_requisicao;
										
										ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cValidaExecProc02_w.cd_procedimento, r_cValidaExecProc02_w.ie_origem_proced);
										
										ie_local_atend_w 	:= 'N';
																				
										ie_regra_tipo_pessoa_w 	:= 'N';
										
										ie_tipo_internacao_w	:= 'N';
										
										if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
											if (nr_seq_segurado_w = nr_seq_segurado_regra_p) then
												ie_regra_tipo_pessoa_w := 'S';
											end if;
										elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
											if (nr_seq_prestador_w = nr_seq_segurado_regra_p) then
												ie_regra_tipo_pessoa_w := 'S';
											end if;
										elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
											if	(nr_seq_segurado_w = nr_seq_segurado_regra_p AND nr_seq_prestador_w = nr_seq_segurado_regra_p) then
												ie_regra_tipo_pessoa_w := 'S';
											end if;
										end if;
										
										if (nr_seq_local_atend_p IS NOT NULL AND nr_seq_local_atend_p::text <> '') then
											if (ie_tipo_processo_w = 'P')
											and (pls_obter_local_atend_usuario(nm_usuario_solic_w,cd_estabelecimento_p) = nr_seq_local_atend_p) then
												
													ie_local_atend_w := 'S';

											end if;
										else
											ie_local_atend_w := 'S';
										end if;
										
										if (nr_seq_clinica_regra_p IS NOT NULL AND nr_seq_clinica_regra_p::text <> '') then
											if (nr_seq_clinica_regra_p = nr_seq_clinica_w) then
												ie_tipo_internacao_w	:= 'S';
											end if;
										else
											ie_tipo_internacao_w	:= 'S';
										end if;
										
										if (ie_grupo_servico_w	= 'S') and (ie_local_atend_w	= 'S') and (ie_regra_tipo_pessoa_w = 'S') and (ie_tipo_internacao_w = 'S') then
											qt_liberacao_w	:= qt_liberacao_w + r_cValidaExecProc02_w.qt_item;
										end if;
									end;
								end loop;
							else
								for r_cValidaExecProc01_w in cValidaExecProc01(nr_seq_segurado_p, dt_ref_inicial_p, dt_ref_final_p) loop
									begin											
										select	nr_seq_prestador,
											nr_seq_segurado,
											ie_tipo_processo,
											nm_usuario_solic,
											nr_seq_clinica
										into STRICT	nr_seq_prestador_w,
											nr_seq_segurado_w,
											ie_tipo_processo_w,
											nm_usuario_solic_w,
											nr_seq_clinica_w
										from 	pls_requisicao
										where	nr_sequencia = r_cValidaExecProc01_w.nr_seq_requisicao;
										
										
										ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cValidaExecProc01_w.cd_procedimento, r_cValidaExecProc01_w.ie_origem_proced);
										
										ie_local_atend_w 	:= 'N';
										
										ie_regra_tipo_pessoa_w 	:= 'N';
										
										ie_tipo_internacao_w	:= 'N';
										
										if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
											if (nr_seq_segurado_w = nr_seq_segurado_regra_p) then
												ie_regra_tipo_pessoa_w := 'S';
											end if;
										elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
											if (nr_seq_prestador_w = nr_seq_segurado_regra_p) then
												ie_regra_tipo_pessoa_w := 'S';
											end if;
										elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
											if	(nr_seq_segurado_w = nr_seq_segurado_regra_p AND nr_seq_prestador_w = nr_seq_segurado_regra_p) then
												ie_regra_tipo_pessoa_w := 'S';
											end if;
										end if;
										
										if (nr_seq_local_atend_p IS NOT NULL AND nr_seq_local_atend_p::text <> '') then
											if (ie_tipo_processo_w = 'P')
											and (pls_obter_local_atend_usuario(nm_usuario_solic_w,cd_estabelecimento_p) = nr_seq_local_atend_p) then
											
													ie_local_atend_w := 'S';
										
											end if;
										else
											ie_local_atend_w := 'S';
										end if;
										
										if (nr_seq_clinica_regra_p IS NOT NULL AND nr_seq_clinica_regra_p::text <> '') then
											if (nr_seq_clinica_regra_p = nr_seq_clinica_w) then
												ie_tipo_internacao_w	:= 'S';
											end if;
										else
											ie_tipo_internacao_w	:= 'S';
										end if;
										
										if (ie_grupo_servico_w	= 'S') and (ie_local_atend_w	= 'S') and (ie_regra_tipo_pessoa_w = 'S') and (ie_tipo_internacao_w = 'S') then
											qt_liberacao_w	:= qt_liberacao_w + r_cValidaExecProc01_w.qt_item;
										end if;
									end;
								end loop;
							end if;
						end;
					end loop;
				end if;
			end if;
		elsif (coalesce(nr_seq_material_p,0) > 0) then
			if (coalesce(ie_valida_execucao_p,'N') = 'N') then
				if (ie_tipo_incidencia_p = 'G') then
					if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
						select 	coalesce(sum(a.qt_solicitado),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_requisicao_w
						from	pls_requisicao		b,
							pls_requisicao_mat	a
						where	a.nr_seq_requisicao	= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_sequencia		= nr_seq_requisicao_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.nr_seq_material	= nr_seq_material_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_solicitado),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_requisicao_w
						from	pls_requisicao		b,
							pls_requisicao_mat	a
						where	a.nr_seq_requisicao	= b.nr_sequencia
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		= nr_seq_requisicao_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.nr_seq_material	= nr_seq_material_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);

					elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_solicitado),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_requisicao_w
						from	pls_requisicao		b,
							pls_requisicao_mat	a
						where	a.nr_seq_requisicao	= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		= nr_seq_requisicao_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.nr_seq_material	= nr_seq_material_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);

					end if;
				elsif (ie_tipo_incidencia_p = 'H') then
					if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
						select 	coalesce(sum(a.qt_material),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_requisicao_w
						from	pls_requisicao		b,
							pls_requisicao_mat	a
						where	a.nr_seq_requisicao	= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_sequencia		<> nr_seq_requisicao_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_estagio		= 2
						and	a.nr_seq_material	= nr_seq_material_p
						and	b.dt_requisicao		between dt_ref_inicial_p and dt_ref_final_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_material),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_requisicao_w
						from	pls_requisicao		b,
							pls_requisicao_mat	a
						where	a.nr_seq_requisicao	= b.nr_sequencia
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_requisicao_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_estagio		= 2
						and	a.nr_seq_material	= nr_seq_material_p
						and	b.dt_requisicao		between dt_ref_inicial_p and dt_ref_final_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);

					elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_material),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_requisicao_w
						from	pls_requisicao		b,
							pls_requisicao_mat	a
						where	a.nr_seq_requisicao	= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_requisicao_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_estagio		= 2
						and	a.nr_seq_material	= nr_seq_material_p
						and	b.dt_requisicao		between dt_ref_inicial_p and dt_ref_final_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);

					end if;
				else
					if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
						select 	coalesce(sum(a.qt_material),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_requisicao_w
						from	pls_requisicao		b,
							pls_requisicao_mat	a
						where	a.nr_seq_requisicao	= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_sequencia		<> nr_seq_requisicao_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_estagio		= 2
						and	a.nr_seq_material	= nr_seq_material_p
						and	trunc(b.dt_requisicao) between dt_ref_inicial_p and dt_ref_final_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_material),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_requisicao_w
						from	pls_requisicao		b,
							pls_requisicao_mat	a
						where	a.nr_seq_requisicao	= b.nr_sequencia
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_requisicao_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_estagio		= 2
						and	a.nr_seq_material	= nr_seq_material_p
						and	trunc(b.dt_requisicao) between dt_ref_inicial_p and dt_ref_final_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);

					elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_material),0),
							max(b.nr_sequencia)
						into STRICT	qt_liberacao_w,
							nr_seq_requisicao_w
						from	pls_requisicao		b,
							pls_requisicao_mat	a
						where	a.nr_seq_requisicao	= b.nr_sequencia
						and	b.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_requisicao_p
						and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	b.ie_estagio		= 2
						and	a.nr_seq_material	= nr_seq_material_p
						and	trunc(b.dt_requisicao) between dt_ref_inicial_p and dt_ref_final_p
						and (b.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (b.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (b.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(b.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(b.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(b.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (b.cd_medico_solicitante = cd_medico_solic_p)
						);
					end if;
				end if;
			elsif (coalesce(ie_valida_execucao_p,'N') = 'S') then
				if (ie_tipo_incidencia_p = 'H') then
					if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
						select 	coalesce(sum(a.qt_item),0) qt_item,
							max(a.nr_sequencia) nr_seq_exec_item
						into STRICT	qt_liberacao_w,
							nr_seq_exec_item_w
						from	pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	a.ie_situacao		not in ('C','G','N','U')
						and	a.nr_seq_material	= nr_seq_material_p
						and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
						and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
							and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						);
					elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_item),0) qt_item,
							max(a.nr_sequencia) nr_seq_exec_item
						into STRICT	qt_liberacao_w,
							nr_seq_exec_item_w
						from	pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	a.ie_situacao		not in ('C','G','N','U')
						and	a.nr_seq_material	= nr_seq_material_p
						and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
						and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
							and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						);
					elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then						
						select 	coalesce(sum(a.qt_item),0) qt_item,
							max(a.nr_sequencia) nr_seq_exec_item
						into STRICT	qt_liberacao_w,
							nr_seq_exec_item_w
						from	pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	a.ie_situacao		not in ('C','G','N','U')
						and	a.nr_seq_material	= nr_seq_material_p
						and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
						and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
							and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						);
					end if;
				else
					if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
						select 	coalesce(sum(a.qt_item),0) qt_item,
							max(a.nr_sequencia) nr_seq_exec_item
						into STRICT	qt_liberacao_w,
							nr_seq_exec_item_w
						from	pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	a.ie_situacao		not in ('C','G','N','U')
						--and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.nr_seq_material	= nr_seq_material_p
						and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
						and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
							and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						);
					elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then												
						select 	coalesce(sum(a.qt_item),0) qt_item,
							max(a.nr_sequencia) nr_seq_exec_item
						into STRICT	qt_liberacao_w,
							nr_seq_exec_item_w
						from	pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	a.ie_situacao		not in ('C','G','N','U')
						and	a.nr_seq_material	= nr_seq_material_p
						and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
						and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
							and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						);
					elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then											
						select 	coalesce(sum(a.qt_item),0) qt_item,
							max(a.nr_sequencia) nr_seq_exec_item
						into STRICT	qt_liberacao_w,
							nr_seq_exec_item_w
						from	pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	a.ie_situacao		not in ('C','G','N','U')
						and	a.nr_seq_material	= nr_seq_material_p
						and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
						and	((SELECT c.nr_seq_clinica from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								((select c.ie_tipo_processo from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao) = 'P')
							and (pls_obter_local_atend_usuario((select c.nm_usuario_solic from pls_requisicao c where c.nr_sequencia = b.nr_seq_requisicao),cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						);
					end if;				
				end if;
			end if;
		end if;	
	elsif (coalesce(nr_seq_execucao_p,0) > 0) then	
		if (coalesce(cd_procedimento_p,0) > 0) then
			if (ie_valida_grupo_serv_p = 'N') then
				if (ie_tipo_incidencia_p = 'H') then
					if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
						select 	coalesce(sum(a.qt_item),0)
						into STRICT	qt_liberacao_w
						from	pls_requisicao 		c,
							pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	b.nr_seq_requisicao	= c.nr_sequencia
						and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_sequencia		<> nr_seq_execucao_p
						and	a.ie_situacao		not in ('C','G','N','U')
						--and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
						and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(c.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (c.cd_medico_solicitante = cd_medico_solic_p)
						);
					elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_item),0)
						into STRICT	qt_liberacao_w
						from	pls_requisicao 		c,
							pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	b.nr_seq_requisicao	= c.nr_sequencia
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_execucao_p
						and	a.ie_situacao		not in ('C','G','N','U')
						--and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
						and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(c.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (c.cd_medico_solicitante = cd_medico_solic_p)
						);

					elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_item),0)
						into STRICT	qt_liberacao_w
						from	pls_requisicao 		c,
							pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	b.nr_seq_requisicao	= c.nr_sequencia
						and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_execucao_p
						and	a.ie_situacao		not in ('C','G','N','U')
						--and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
						and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(c.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (c.cd_medico_solicitante = cd_medico_solic_p)
						);
					end if;
				else
					if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
						select 	coalesce(sum(a.qt_item),0)
						into STRICT	qt_liberacao_w
						from	pls_requisicao 		c,
							pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	b.nr_seq_requisicao	= c.nr_sequencia
						and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_sequencia		<> nr_seq_execucao_p
						and	a.ie_situacao		not in ('C','G','N','U')
						--and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
						and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(c.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (c.cd_medico_solicitante = cd_medico_solic_p)
						);
					elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_item),0)
						into STRICT	qt_liberacao_w
						from	pls_requisicao 		c,
							pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	b.nr_seq_requisicao	= c.nr_sequencia
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_execucao_p
						and	a.ie_situacao		not in ('C','G','N','U')
						--and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
						and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(c.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (c.cd_medico_solicitante = cd_medico_solic_p)
						);

					elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
						select 	coalesce(sum(a.qt_item),0)
						into STRICT	qt_liberacao_w
						from	pls_requisicao 		c,
							pls_execucao_requisicao	b,
							pls_execucao_req_item	a
						where	a.nr_seq_execucao	= b.nr_sequencia
						and	b.nr_seq_requisicao	= c.nr_sequencia
						and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
						and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
						and	b.nr_sequencia		<> nr_seq_execucao_p
						and	a.ie_situacao		not in ('C','G','N','U')
						--and	b.cd_estabelecimento	= cd_estabelecimento_p
						and	a.cd_procedimento	= cd_procedimento_p
						and	a.ie_origem_proced	= ie_origem_proced_p
						and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
						and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
						and	((ie_valida_mesma_espec_p = 'N')
						or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
						and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
						or (ie_valida_medico_cbo_p = 'N'))
						and (
								(coalesce(nr_seq_local_atend_p::text, '') = '')
							or	(
								(c.ie_tipo_processo = 'P')
							and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
								)
						)
						and (
								(coalesce(cd_medico_solic_p::text, '') = '')
							or (c.cd_medico_solicitante = cd_medico_solic_p)
						);

					end if;
				end if;
				
			elsif (ie_valida_grupo_serv_p = 'S') then
				for r_C01_w in C01(nr_seq_ocor_combinada_p) loop
					begin

					if (ie_tipo_incidencia_p = 'H') then
						for r_cProcExecucao01_w in cProcExecucao01(nr_seq_segurado_p, nr_seq_execucao_p, dt_ref_inicial_p, dt_ref_final_p, nr_seq_clinica_regra_p) loop
							begin
							ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cProcExecucao01_w.cd_procedimento, r_cProcExecucao01_w.ie_origem_proced);
							
							ie_local_atend_w 	:= 'N';
							
							ie_regra_qtd_w		:= 'N';
							
							ie_regra_tipo_pessoa_w := 'N';
							
							if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
								if (r_cProcExecucao01_w.nr_seq_segurado = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
								if (r_cProcExecucao01_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
								if	(r_cProcExecucao01_w.nr_seq_segurado = nr_seq_segurado_regra_p AND r_cProcExecucao01_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							end if;
							
							if (nr_seq_local_atend_p IS NOT NULL AND nr_seq_local_atend_p::text <> '') then
								if (r_cProcExecucao01_w.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(r_cProcExecucao01_w.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p) then
									
										ie_local_atend_w := 'S';

								end if;
							else
								ie_local_atend_w := 'S';
							end if;
							
							if (cd_medico_solic_p IS NOT NULL AND cd_medico_solic_p::text <> '') then
								if (r_cProcExecucao01_w.cd_medico_solicitante = cd_medico_solic_p) then
									ie_regra_qtd_w := 'S';
								end if;
							else
								ie_regra_qtd_w := 'S';
							end if;
							
							if (ie_grupo_servico_w	= 'S') and (ie_local_atend_w	= 'S') and (ie_regra_qtd_w	= 'S') and (ie_regra_tipo_pessoa_w = 'S') then
								qt_liberacao_w	:= qt_liberacao_w + r_cProcExecucao01_w.qt_item;
							end if;
							end;
						end loop;
					else
						for r_cProcExecucao_w in cProcExecucao(nr_seq_segurado_p, nr_seq_execucao_p, dt_ref_inicial_p, dt_ref_final_p, nr_seq_clinica_regra_p) loop
							begin
							ie_grupo_servico_w	:= pls_se_grupo_preco_servico(r_C01_w.nr_seq_grupo_servico, r_cProcExecucao_w.cd_procedimento, r_cProcExecucao_w.ie_origem_proced);
							
							ie_local_atend_w 	:= 'N';
							
							ie_regra_qtd_w		:= 'N';
							
							ie_regra_tipo_pessoa_w := 'N';
							
							if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
								if (r_cProcExecucao_w.nr_seq_segurado = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
								if (r_cProcExecucao_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
								if	(r_cProcExecucao_w.nr_seq_segurado = nr_seq_segurado_regra_p AND r_cProcExecucao_w.nr_seq_prestador = nr_seq_segurado_regra_p) then
									ie_regra_tipo_pessoa_w := 'S';
								end if;
							end if;
							
							if (nr_seq_local_atend_p IS NOT NULL AND nr_seq_local_atend_p::text <> '') then
								if (r_cProcExecucao_w.ie_tipo_processo = 'P')
								and (pls_obter_local_atend_usuario(r_cProcExecucao_w.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p) then
								
										ie_local_atend_w := 'S';
							
								end if;
							else
								ie_local_atend_w := 'S';
							end if;
							
							if (cd_medico_solic_p IS NOT NULL AND cd_medico_solic_p::text <> '') then
								if (r_cProcExecucao_w.cd_medico_solicitante = cd_medico_solic_p) then
									ie_regra_qtd_w := 'S';
								end if;
							else
								ie_regra_qtd_w := 'S';
							end if;
							
							if (ie_grupo_servico_w	= 'S') and (ie_local_atend_w	= 'S') and (ie_regra_qtd_w	= 'S') and (ie_regra_tipo_pessoa_w = 'S') then
								qt_liberacao_w	:= qt_liberacao_w + r_cProcExecucao_w.qt_item;
							end if;
							end;
						end loop;
					end if;
					end;
				end loop;
			end if;
		elsif (coalesce(nr_seq_material_p,0) > 0) then
			if (ie_tipo_incidencia_p = 'H') then
				if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
					select 	coalesce(sum(a.qt_item),0)
					into STRICT	qt_liberacao_w
					from	pls_requisicao 		c,
						pls_execucao_requisicao	b,
						pls_execucao_req_item	a
					where	a.nr_seq_execucao	= b.nr_sequencia
					and	b.nr_seq_requisicao	= c.nr_sequencia
					and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
					and	b.nr_sequencia		<> nr_seq_execucao_p
					and	a.ie_situacao		not in ('C','G','N','U')
					--and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	a.nr_seq_material	= nr_seq_material_p
					and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
					and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
							(coalesce(nr_seq_local_atend_p::text, '') = '')
						or	(
							(c.ie_tipo_processo = 'P')
						and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
							)
					)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (c.cd_medico_solicitante = cd_medico_solic_p)
					);
				elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
					select 	coalesce(sum(a.qt_item),0)
					into STRICT	qt_liberacao_w
					from	pls_requisicao 		c,
						pls_execucao_requisicao	b,
						pls_execucao_req_item	a
					where	a.nr_seq_execucao	= b.nr_sequencia
					and	b.nr_seq_requisicao	= c.nr_sequencia
					and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
					and	b.nr_sequencia		<> nr_seq_execucao_p
					and	a.ie_situacao		not in ('C','G','N','U')
					--and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	a.nr_seq_material	= nr_seq_material_p
					and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
					and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
							(coalesce(nr_seq_local_atend_p::text, '') = '')
						or	(
							(c.ie_tipo_processo = 'P')
						and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
							)
					)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (c.cd_medico_solicitante = cd_medico_solic_p)
					);
				elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
					select 	coalesce(sum(a.qt_item),0)
					into STRICT	qt_liberacao_w
					from	pls_requisicao 		c,
						pls_execucao_requisicao	b,
						pls_execucao_req_item	a
					where	a.nr_seq_execucao	= b.nr_sequencia
					and	b.nr_seq_requisicao	= c.nr_sequencia
					and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
					and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
					and	b.nr_sequencia		<> nr_seq_execucao_p
					and	a.ie_situacao		not in ('C','G','N','U')
					--and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	a.nr_seq_material	= nr_seq_material_p
					and	b.dt_execucao		between dt_ref_inicial_p and dt_ref_final_p
					and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
							(coalesce(nr_seq_local_atend_p::text, '') = '')
						or	(
							(c.ie_tipo_processo = 'P')
						and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
							)
					)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (c.cd_medico_solicitante = cd_medico_solic_p)
					);
				end if;
			else
				if	(((coalesce(nr_seq_segurado_regra_p::text, '') = '') and (coalesce(nr_seq_prestador_regra_p::text, '') = '')) or ((nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (coalesce(nr_seq_prestador_regra_p::text, '') = ''))) then
					select 	coalesce(sum(a.qt_item),0)
					into STRICT	qt_liberacao_w
					from	pls_requisicao 		c,
						pls_execucao_requisicao	b,
						pls_execucao_req_item	a
					where	a.nr_seq_execucao	= b.nr_sequencia
					and	b.nr_seq_requisicao	= c.nr_sequencia
					and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
					and	b.nr_sequencia		<> nr_seq_execucao_p
					and	a.ie_situacao		not in ('C','G','N','U')
					--and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	a.nr_seq_material	= nr_seq_material_p
					and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
					and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
							(coalesce(nr_seq_local_atend_p::text, '') = '')
						or	(
							(c.ie_tipo_processo = 'P')
						and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
							)
					)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (c.cd_medico_solicitante = cd_medico_solic_p)
					);
				elsif (coalesce(nr_seq_segurado_regra_p::text, '') = '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
					select 	coalesce(sum(a.qt_item),0)
					into STRICT	qt_liberacao_w
					from	pls_requisicao 		c,
						pls_execucao_requisicao	b,
						pls_execucao_req_item	a
					where	a.nr_seq_execucao	= b.nr_sequencia
					and	b.nr_seq_requisicao	= c.nr_sequencia
					and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
					and	b.nr_sequencia		<> nr_seq_execucao_p
					and	a.ie_situacao		not in ('C','G','N','U')
					--and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	a.nr_seq_material	= nr_seq_material_p
					and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
					and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
							(coalesce(nr_seq_local_atend_p::text, '') = '')
						or	(
							(c.ie_tipo_processo = 'P')
						and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
							)
					)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (c.cd_medico_solicitante = cd_medico_solic_p)
					);
				elsif (nr_seq_segurado_regra_p IS NOT NULL AND nr_seq_segurado_regra_p::text <> '') and (nr_seq_prestador_regra_p IS NOT NULL AND nr_seq_prestador_regra_p::text <> '') then
					select 	coalesce(sum(a.qt_item),0)
					into STRICT	qt_liberacao_w
					from	pls_requisicao 		c,
						pls_execucao_requisicao	b,
						pls_execucao_req_item	a
					where	a.nr_seq_execucao	= b.nr_sequencia
					and	b.nr_seq_requisicao	= c.nr_sequencia
					and	a.nr_seq_segurado	= nr_seq_segurado_regra_p
					and	b.nr_seq_prestador	= nr_seq_prestador_regra_p
					and	b.nr_sequencia		<> nr_seq_execucao_p
					and	a.ie_situacao		not in ('C','G','N','U')
					--and	b.cd_estabelecimento	= cd_estabelecimento_p
					and	a.nr_seq_material	= nr_seq_material_p
					and	trunc(b.dt_execucao) between dt_ref_inicial_p and dt_ref_final_p
					and (c.nr_seq_clinica	= nr_seq_clinica_regra_p or coalesce(nr_seq_clinica_regra_p::text, '') = '')
					and	((ie_valida_mesma_espec_p = 'N')
					or	((ie_valida_mesma_espec_p = 'S') and (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') and (c.cd_especialidade = cd_especialidade_w)))
					and (((ie_valida_medico_cbo_p = 'S') and (c.cd_medico_solicitante = cd_medico_solicitante_w) and (coalesce(c.nr_seq_cbo_saude, nr_seq_cbo_saude_w) = nr_seq_cbo_saude_w))
					or (ie_valida_medico_cbo_p = 'N'))
					and (
							(coalesce(nr_seq_local_atend_p::text, '') = '')
						or	(
							(c.ie_tipo_processo = 'P')
						and (pls_obter_local_atend_usuario(c.nm_usuario_solic,cd_estabelecimento_p) = nr_seq_local_atend_p)
							)
					)
					and (
							(coalesce(cd_medico_solic_p::text, '') = '')
						or (c.cd_medico_solicitante = cd_medico_solic_p)
					);
				end if;				
			end if;
		end if;	
	end if;
end if;

if (ie_valida_grupo_serv_p = 'N') then
	if (ie_tipo_incidencia_p <> 'G' or coalesce(ie_tipo_incidencia_p::text, '') = '') then
		if (coalesce(ie_valida_guia_dif_p, 'N') = 'S') then
			if (qt_liberacao_w > 0) then
				qt_liberacao_w := qt_liberacao_w + qt_solicitada_p;
			else
				qt_liberacao_w := 0;
			end if;
		else
			qt_liberacao_w := qt_liberacao_w + qt_solicitada_p;
		end if;
	end if;
end if;

if (qt_liberacao_w	>= qt_liberada_p) then
	ie_retorno_w	:= 'S';					

	if (coalesce(ie_valida_execucao_p,'N') = 'S') then
		begin
		select	a.nr_seq_guia,
			b.dt_execucao,
			substr(obter_nome_pessoa_fisica(a.cd_medico_requisitante, null),1,255)
		into STRICT	nr_seq_guia_w,
			dt_execucao_w,
			nm_medico_requisit_w
		from	pls_execucao_requisicao	b,
			pls_execucao_req_item	a
		where	a.nr_seq_execucao	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_exec_item_w;

		select	cd_guia
		into STRICT	cd_guia_w
		from	pls_guia_plano
		where	nr_sequencia = nr_seq_guia_w;


		ds_observacao_p := substr('Guia: '||cd_guia_w||'. Data da execucao: '||to_char(dt_execucao_w,'dd/mm/yyyy')||'. Medico requisit: '||nm_medico_requisit_w,1,400);
		exception
		when others then
			ds_observacao_p := '';
		end;
	else
		if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
			begin
			select	dt_requisicao
			into STRICT	dt_execucao_w
			from	pls_requisicao
			where	nr_sequencia = nr_seq_requisicao_w;
			
			ds_observacao_p := substr('Requisicao: '|| nr_seq_requisicao_w ||'. Solicitada em: '||to_char(dt_execucao_w,'dd/mm/yyyy')||'.' ,1,400);
			exception
			when others then
				ds_observacao_p := '';
			end;
		elsif (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
			begin
			select	dt_solicitacao
			into STRICT	dt_execucao_w
			from	pls_guia_plano
			where	nr_sequencia = nr_seq_guia_w;
			
			ds_observacao_p := substr('Guia: '|| nr_seq_guia_w ||'. Solicitada em: '||to_char(dt_execucao_w,'dd/mm/yyyy')||'.' ,1,400);
			exception
			when others then
				ds_observacao_p := '';
			end;
		else
			ds_observacao_p := '';
		end if;
	end if;
end if;

return;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_qt_incid_ocorrencia ( qt_liberada_p bigint, dt_ref_inicial_p timestamp, dt_ref_final_p timestamp, cd_estabelecimento_p bigint, qt_solicitada_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_execucao_p bigint, nr_seq_segurado_p bigint, nr_seq_clinica_regra_p bigint, ie_tipo_incidencia_p text, nr_seq_ocor_combinada_p bigint, ie_valida_grupo_serv_p text, ie_valida_medico_cbo_p text, ie_valida_conta_p text, nr_seq_prestador_p bigint, nr_seq_local_atend_p bigint, cd_medico_solic_p text, nr_seq_segurado_regra_p bigint, nr_seq_prestador_regra_p bigint, ie_valida_execucao_p text, ie_valida_guia_dif_p pls_validacao_aut_qt_incid.ie_valida_guia_dif%type, ie_valida_mesma_espec_p pls_validacao_aut_qt_incid.ie_valida_mesma_espec%type default 'N', ds_observacao_p out text) FROM PUBLIC;

