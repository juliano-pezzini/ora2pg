-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prim_valor_prot_conv ( ie_vl_mat_proc_p text, ie_coluna_senha_p bigint, ie_tipo_convenio_p bigint, ie_imprime_hora_p text, ie_guia_princ_p text, ie_imp_procedimento_p text, ie_procedimento_p bigint, ie_participantes_p text, ie_tipo_convenio_pp text, param_46_p text, ie_canceladas_p text, ie_classificacao_p bigint, nr_seq_protocolo_p text, ie_rateado_p text, cd_autorizacao_p text, ie_tipo_p text) RETURNS varchar AS $body$
DECLARE


vl_retorno_w	varchar(10);
ds_sql_w		varchar(4000);


BEGIN

if (ie_tipo_p = 'P') then
	ds_sql_w := ds_sql_w || ' select     x.ie_proc_mat' || chr(13) || chr(10);
elsif (ie_tipo_p = 'I') then
	ds_sql_w := ds_sql_w || ' select     x.tp_item' || chr(13) || chr(10);
end if;
ds_sql_w := ds_sql_w || ' from       (' || chr(13) || chr(10);

ds_sql_w := ds_sql_w || ' select     a.cd_convenio_parametro,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.nr_seq_protocolo,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            substr(obter_matricula_usuario(a.cd_convenio_parametro,a.nr_atendimento),1,50) nr_matricula,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            substr(obter_matr_usu_conv_glosa(a.cd_convenio_parametro,a.nr_atendimento),1,255) nr_matr_usu_conv, ' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.nr_atendimento,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            substr(obter_pessoa_atendimento(a.nr_atendimento,''N''),1,200) nm_pessoa_fisica,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            obter_prontuario_atendimento(a.nr_atendimento) nr_prontuario,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.nr_interno_conta,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            substr(obter_categoria_convenio(a.cd_convenio_parametro,a.cd_categoria_parametro),1,200) ds_categoria,' || chr(13) || chr(10);

if (ie_vl_mat_proc_p <> 'S') then
	begin
	if (ie_coluna_senha_p = 1) then
		ds_sql_w := ds_sql_w || '            substr(obter_senha_atendimento(a.nr_atendimento),1,20) cd_senha,' || chr(13) || chr(10);
	elsif (ie_coluna_senha_p = 2) then
		ds_sql_w := ds_sql_w || '            substr(obter_titulo_conta(a.nr_interno_conta),1,20) cd_senha,' || chr(13) || chr(10);
	else
		ds_sql_w := ds_sql_w || '            '''' cd_senha,' || chr(13) || chr(10);
	end if;
	end;
else
	ds_sql_w := ds_sql_w || '            '''' cd_senha,' || chr(13) || chr(10);
end if;

if (ie_tipo_convenio_p = 1) then
	ds_sql_w := ds_sql_w || '            substr(obter_titulo_conta(a.nr_interno_conta),1,20) nr_titulo,' || chr(13) || chr(10);
end if;

if (ie_imprime_hora_p = 'S') then
	ds_sql_w := ds_sql_w || '            to_char(a.dt_periodo_inicial,''dd/mm/yyyy hh24:mi:ss'') dt_periodo_inicial,' || chr(13) || chr(10);
	ds_sql_w := ds_sql_w || '            to_char(a.dt_periodo_final,''dd/mm/yyyy hh24:mi:ss'') dt_periodo_final,' || chr(13) || chr(10);
else
	ds_sql_w := ds_sql_w || '            to_char(a.dt_periodo_inicial,''dd/mm/yyyy'') dt_periodo_inicial,' || chr(13) || chr(10);
	ds_sql_w := ds_sql_w || '            to_char(a.dt_periodo_final,''dd/mm/yyyy'') dt_periodo_final,' || chr(13) || chr(10);
end if;

ds_sql_w := ds_sql_w || '            to_char(a.dt_mesano_referencia,''mm/yy'') dt_mesano_referencia,' || chr(13) || chr(10);

if (ie_guia_princ_p <> 'S') then
	ds_sql_w := ds_sql_w || '            a.cd_autorizacao,' || chr(13) || chr(10);
end if;

if (ie_imp_procedimento_p = 'S') then
	begin
	if (ie_procedimento_p = 0) then
		ds_sql_w := ds_sql_w || '            substr(obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,obter_tipo_atendimento(a.nr_atendimento),a.nr_interno_conta,''C''),1,120) ds_procedimento,' || chr(13) || chr(10);
	elsif (ie_procedimento_p = 1) then
		ds_sql_w := ds_sql_w || '            substr(obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,obter_tipo_atendimento(a.nr_atendimento),a.nr_interno_conta,''D''),1,120) ds_procedimento,' || chr(13) || chr(10);
	end if;
	end;
end if;

ds_sql_w := ds_sql_w || '            a.nr_seq_apresent,' || chr(13) || chr(10);

if (ie_participantes_p = 'S') then
	ds_sql_w := ds_sql_w || '            (sum(a.vl_medico) + sum(decode(ie_proc_mat,1,obter_valor_participante(a.nr_sequencia),0))) vl_medico,' || chr(13) || chr(10);
else
	ds_sql_w := ds_sql_w || '            sum(a.vl_medico) vl_medico,' || chr(13) || chr(10);
end if;

if (ie_guia_princ_p = 'S') then
	ds_sql_w := ds_sql_w || '            substr(obter_guia_princ_atend(a.nr_atendimento,a.cd_convenio_parametro,a.cd_categoria_parametro),1,20) nr_doc_conv_principal,' || chr(13) || chr(10);
end if;

ds_sql_w := ds_sql_w || '            nvl(a.nr_conta_convenio,0) nr_conta_convenio,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            obter_nota_conta_prot_conv(a.nr_seq_protocolo,0,''S'') nr_nota_prot_conv,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.ie_proc_mat,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.tp_item' || chr(13) || chr(10);

if ((ie_tipo_convenio_pp IS NOT NULL AND ie_tipo_convenio_pp::text <> '') and (ie_tipo_convenio_pp = '3') and (param_46_p = 'S')) then
	ds_sql_w := ds_sql_w || ' from       protocolo_convenio_item_v5 a' || chr(13) || chr(10);
else
	ds_sql_w := ds_sql_w || ' from       protocolo_convenio_item_v a' || chr(13) || chr(10);
end if;

ds_sql_w := ds_sql_w || ' where      a.nr_seq_protocolo in '||nr_seq_protocolo_p ||' ';
ds_sql_w := ds_sql_w || ' and        a.cd_motivo_exc_conta is null' || chr(13) || chr(10);

if (ie_canceladas_p = 'S') then
	ds_sql_w := ds_sql_w || ' and        a.ie_cancelamento is null' || chr(13) || chr(10);
end if;

ds_sql_w := ds_sql_w || ' and        ((((ie_proc_mat = 2) or (nr_seq_proc_pacote is null or nr_sequencia <> nr_seq_proc_pacote))' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || ' and        :ie_rateado = ''S'') or (nvl(a.nr_seq_proc_pacote,a.nr_sequencia) = a.nr_sequencia and :ie_rateado = ''N''))' || chr(13) || chr(10);

ds_sql_w := ds_sql_w || ' group by   a.cd_convenio_parametro,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.nr_seq_protocolo,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            obter_pessoa_atendimento(a.nr_atendimento,''N''),' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.nr_atendimento,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.nr_conta_convenio,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.nr_interno_conta,' || chr(13) || chr(10);

if (ie_imp_procedimento_p = 'S') then
	begin
	if (ie_procedimento_p = 0) then
		ds_sql_w := ds_sql_w || '            substr(obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,obter_tipo_atendimento(a.nr_atendimento),a.nr_interno_conta,''C''),1,120),' || chr(13) || chr(10);
	else
		ds_sql_w := ds_sql_w || '            substr(obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,obter_tipo_atendimento(a.nr_atendimento),a.nr_interno_conta,''D''),1,120),' || chr(13) || chr(10);
	end if;
	end;
end if;

ds_sql_w := ds_sql_w || '            a.dt_periodo_inicial,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.dt_periodo_final,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.dt_mesano_referencia,' || chr(13) || chr(10);

if (ie_guia_princ_p <> 'S') then
	ds_sql_w := ds_sql_w || '            a.cd_autorizacao,' || chr(13) || chr(10);
end if;

if (ie_guia_princ_p = 'S') then
	ds_sql_w := ds_sql_w || '            a.cd_categoria_parametro,' || chr(13) || chr(10);
end if;

ds_sql_w := ds_sql_w || '            a.nr_seq_apresent,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.cd_convenio_parametro,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.cd_categoria_parametro,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            obter_tipo_atendimento(a.nr_atendimento),' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            obter_nota_conta_prot_conv(a.nr_seq_protocolo,0,''S''),' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.ie_proc_mat,' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || '            a.tp_item' || chr(13) || chr(10);

if (ie_classificacao_p = 8) then
	ds_sql_w := ds_sql_w || '            ,substr(obter_senha_atendimento(a.nr_atendimento),1,50)' || chr(13) || chr(10);
end if;

if (ie_classificacao_p = 0) then
	if (ie_guia_princ_p = 'S') then
		ds_sql_w := ds_sql_w || ' order by   a.nr_atendimento desc' || chr(13) || chr(10);
	else
		ds_sql_w := ds_sql_w || ' order by   a.nr_atendimento desc,' || chr(13) || chr(10);
		ds_sql_w := ds_sql_w || '            a.cd_autorizacao desc' || chr(13) || chr(10);
	end if;
elsif (ie_classificacao_p = 1) then
	if (ie_guia_princ_p = 'S') then
		ds_sql_w := ds_sql_w || ' order by   nr_doc_conv_principal desc,' || chr(13) || chr(10);
		ds_sql_w := ds_sql_w || '            nr_interno_conta desc' || chr(13) || chr(10);
	else
		ds_sql_w := ds_sql_w || ' order by   a.cd_autorizacao desc,' || chr(13) || chr(10);
		ds_sql_w := ds_sql_w || '            nr_interno_conta desc' || chr(13) || chr(10);
	end if;
elsif (ie_classificacao_p = 2) then
	if (ie_guia_princ_p = 'S') then
		ds_sql_w := ds_sql_w || ' order by   somente_numero(nr_doc_conv_principal) desc,' || chr(13) || chr(10);
		ds_sql_w := ds_sql_w || '            nr_interno_conta desc' || chr(13) || chr(10);
	else
		ds_sql_w := ds_sql_w || ' order by   somente_numero(a.cd_autorizacao) desc,' || chr(13) || chr(10);
		ds_sql_w := ds_sql_w || '            nr_interno_conta desc' || chr(13) || chr(10);
	end if;
elsif (ie_classificacao_p = 3) then
	if (ie_guia_princ_p = 'S') then
		ds_sql_w := ds_sql_w || ' order by   nm_pessoa_fisica desc,' || chr(13) || chr(10);
		ds_sql_w := ds_sql_w || '            nr_interno_conta desc' || chr(13) || chr(10);
	else
		ds_sql_w := ds_sql_w || ' order by   nm_pessoa_fisica desc,' || chr(13) || chr(10);
		ds_sql_w := ds_sql_w || '            nr_interno_conta desc,' || chr(13) || chr(10);
		ds_sql_w := ds_sql_w || '            a.cd_autorizacao desc' || chr(13) || chr(10);
	end if;
elsif (ie_classificacao_p = 4) then
	if (ie_guia_princ_p = 'S') then
		ds_sql_w := ds_sql_w || ' order by   nr_matricula desc,' || chr(13) || chr(10);
		ds_sql_w := ds_sql_w || '            a.nr_atendimento desc' || chr(13) || chr(10);
	else
		ds_sql_w := ds_sql_w || ' order by   nr_matricula desc,' || chr(13) || chr(10);
		ds_sql_w := ds_sql_w || '            a.nr_atendimento desc,' || chr(13) || chr(10);
		ds_sql_w := ds_sql_w || '            a.cd_autorizacao desc' || chr(13) || chr(10);
	end if;
elsif (ie_classificacao_p = 5) then
	ds_sql_w := ds_sql_w || ' order by   a.nr_seq_apresent desc,' || chr(13) || chr(10);
	ds_sql_w := ds_sql_w || '            a.nr_atendimento desc' || chr(13) || chr(10);
elsif (ie_classificacao_p = 6) then
	ds_sql_w := ds_sql_w || ' order by   a.dt_periodo_inicial desc,' || chr(13) || chr(10);
	ds_sql_w := ds_sql_w || '            a.nr_atendimento desc' || chr(13) || chr(10);
elsif (ie_classificacao_p = 7) then
	ds_sql_w := ds_sql_w || ' order by   nr_interno_conta desc' || chr(13) || chr(10);
elsif (ie_classificacao_p = 8) then
	ds_sql_w := ds_sql_w || ' order by   substr(obter_senha_atendimento(a.nr_atendimento),1,50) desc' || chr(13) || chr(10);
elsif (ie_classificacao_p = 9) then
	if (ie_imp_procedimento_p = 'S') then
		if (ie_procedimento_p = 0) then
			if (ie_guia_princ_p = 'S') then
				ds_sql_w := ds_sql_w || ' order by   substr(obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,obter_tipo_atendimento(a.nr_atendimento),a.nr_interno_conta,''C''),1,120) desc,' || chr(13) || chr(10);
				ds_sql_w := ds_sql_w || '            a.nr_atendimento desc' || chr(13) || chr(10);
			else
				ds_sql_w := ds_sql_w || ' order by   substr(obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,obter_tipo_atendimento(a.nr_atendimento),a.nr_interno_conta,''C''),1,120) desc,' || chr(13) || chr(10);
				ds_sql_w := ds_sql_w || '            a.nr_atendimento desc,' || chr(13) || chr(10);
				ds_sql_w := ds_sql_w || '            a.cd_autorizacao desc' || chr(13) || chr(10);
			end if;
		elsif (ie_procedimento_p = 1) then
			if (ie_guia_princ_p = 'S') then
				ds_sql_w := ds_sql_w || ' order by   substr(obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,obter_tipo_atendimento(a.nr_atendimento),a.nr_interno_conta,''D''),1,120) desc,' || chr(13) || chr(10);
				ds_sql_w := ds_sql_w || '            a.nr_atendimento desc' || chr(13) || chr(10);
			else
				ds_sql_w := ds_sql_w || ' order by   substr(obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,obter_tipo_atendimento(a.nr_atendimento),a.nr_interno_conta,''D''),1,120) desc,' || chr(13) || chr(10);
				ds_sql_w := ds_sql_w || '            a.nr_atendimento desc,' || chr(13) || chr(10);
				ds_sql_w := ds_sql_w || '            a.cd_autorizacao desc' || chr(13) || chr(10);
			end if;
		end if;
	end if;
elsif (ie_classificacao_p = 10) then
	ds_sql_w := ds_sql_w || ' order by   a.nr_conta_convenio desc' || chr(13) || chr(10);
end if;

ds_sql_w := ds_sql_w || ') x' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || ' where      x.cd_autorizacao = :cd_autorizacao' || chr(13) || chr(10);
ds_sql_w := ds_sql_w || ' and        rownum = 1' || chr(13) || chr(10);

---------------------------------
select	obter_select_concatenado_bv(ds_sql_w,'ie_rateado='||ie_rateado_p||';cd_autorizacao='||cd_autorizacao_p,'')
into STRICT	vl_retorno_w
;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prim_valor_prot_conv ( ie_vl_mat_proc_p text, ie_coluna_senha_p bigint, ie_tipo_convenio_p bigint, ie_imprime_hora_p text, ie_guia_princ_p text, ie_imp_procedimento_p text, ie_procedimento_p bigint, ie_participantes_p text, ie_tipo_convenio_pp text, param_46_p text, ie_canceladas_p text, ie_classificacao_p bigint, nr_seq_protocolo_p text, ie_rateado_p text, cd_autorizacao_p text, ie_tipo_p text) FROM PUBLIC;

