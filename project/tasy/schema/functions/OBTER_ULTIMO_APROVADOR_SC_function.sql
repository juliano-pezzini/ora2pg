-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ultimo_aprovador_sc ( nr_solic_compra_p bigint) RETURNS varchar AS $body$
DECLARE

 
nm_usuario_aprov_w	varchar(15);

c01 CURSOR FOR			 
SELECT	nm_usuario_aprov 
from ( 
	SELECT	a.nm_usuario_aprov, 
		a.dt_definicao 
	from	processo_aprov_compra a, 
		pessoa_fisica b 
	where	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
	and	a.nr_sequencia( 
			select	distinct nr_seq_aprovacao 
			from	solic_compra_item 
			where	nr_solic_compra = nr_solic_compra_p) 
	
union all
 
	select	a.nm_usuario_aprov, 
		a.dt_definicao 
	from	processo_aprov_compra a, 
		cargo b 
	where	a.cd_cargo = b.cd_cargo 
	and	a.nr_sequencia in ( 
			select	distinct nr_seq_aprovacao 
			from	solic_compra_item 
			where	nr_solic_compra = nr_solic_compra_p)) alias2 
order by dt_definicao asc;


BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nm_usuario_aprov_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	nm_usuario_aprov_w := nm_usuario_aprov_w;
	end;
end loop;
close C01;
 
return	nm_usuario_aprov_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ultimo_aprovador_sc ( nr_solic_compra_p bigint) FROM PUBLIC;

