-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_hor_com ( cd_estabelecimento_p bigint, dt_inicio_p timestamp, qt_min_p bigint) RETURNS timestamp AS $body$
DECLARE

			qtd_mins_subtrair_w         double precision;
			data_atual_w                timestamp;
			min_restam_dia_w            double precision;
			limite_data_atual_w         timestamp;
			minimo_data_atual_w         timestamp;


BEGIN
qtd_mins_subtrair_w   := qt_min_p/1440;
data_atual_w          := dt_inicio_p;
min_restam_dia_w      := 0;
minimo_data_atual_w   := (trunc(data_atual_w))+8/24;
limite_data_atual_w   := (trunc(data_atual_w))+18/24;

if (data_atual_w < minimo_data_atual_w) then
	data_atual_w := minimo_data_atual_w;
elsif (data_atual_w > limite_data_atual_w) then
	data_atual_w := (trunc(data_atual_w)+1)+8/24;
end if;

while(qtd_mins_subtrair_w > 0) loop
	if (obter_cod_dia_semana(data_atual_w) in (7,1) OR obter_se_feriado(cd_estabelecimento_p,data_atual_w) > 0) then
		data_atual_w := (trunc(data_atual_w)+1)+8/24;
	else
			limite_data_atual_w := (trunc(data_atual_w))+18/24;
			min_restam_dia_w :=  limite_data_atual_w - data_atual_w;
			if (min_restam_dia_w < qtd_mins_subtrair_w) then
				data_atual_w := (trunc(data_atual_w)+1)+8/24;
				qtd_mins_subtrair_w := qtd_mins_subtrair_w - min_restam_dia_w;
			else
				data_atual_w := data_atual_w + qtd_mins_subtrair_w;
				qtd_mins_subtrair_w := 0;
			end if;
		end if;
end loop;	

RETURN data_atual_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_hor_com ( cd_estabelecimento_p bigint, dt_inicio_p timestamp, qt_min_p bigint) FROM PUBLIC;

