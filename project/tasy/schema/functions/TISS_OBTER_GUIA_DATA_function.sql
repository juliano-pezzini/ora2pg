-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tiss_obter_guia_data (nr_atendimento_p bigint, cd_convenio_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*
ie_opcao_p
'A' -> guia principal da atend_categoria_convenio
'C' -> guia principal da atend_categoria_convenio quando nao for tipo_guia consulta
'CH' -> guia principal da atend_categoria_convenio quando nao for tipo_guia consulta, considerando o periodo e os horarios, sem fim_dia()
*/
nr_doc_conv_principal_w	varchar(255);
nr_doc_conv_w		varchar(255);
nr_doc_conv_horario_w	varchar(255);


BEGIN

select	max(a.nr_doc_convenio)
into STRICT	nr_doc_conv_principal_w
from	atend_categoria_convenio a
where	a.nr_atendimento			= nr_atendimento_p
and	a.cd_convenio			= cd_convenio_p
and	dt_inicial_p			between a.dt_inicio_vigencia and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(coalesce(a.dt_final_vigencia,clock_timestamp()));

select	max(a.nr_doc_convenio)
into STRICT	nr_doc_conv_w
from	atend_categoria_convenio a
where	a.nr_atendimento			= nr_atendimento_p
and	a.cd_convenio			= cd_convenio_p
and	coalesce(a.ie_tipo_guia,'X')		<> 'C'
and	dt_inicial_p			between a.dt_inicio_vigencia and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(coalesce(a.dt_final_vigencia,clock_timestamp()));

select	max(a.nr_doc_convenio)
into STRICT	nr_doc_conv_horario_w
from	atend_categoria_convenio a
where	a.nr_atendimento		= nr_atendimento_p
and	a.cd_convenio			= cd_convenio_p
and	coalesce(a.ie_tipo_guia,'X')		<> 'C'
and	dt_inicial_p			between a.dt_inicio_vigencia and coalesce(a.dt_final_vigencia,clock_timestamp());

if (ie_opcao_p = 'A') then
	return	nr_doc_conv_principal_w;
elsif (ie_opcao_p = 'C') then
	return	nr_doc_conv_w;
elsif (ie_opcao_p = 'CH') then
	return 	nr_doc_conv_horario_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_obter_guia_data (nr_atendimento_p bigint, cd_convenio_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_opcao_p text) FROM PUBLIC;

