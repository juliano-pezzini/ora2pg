-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_se_os_md ( nr_seq_os_p bigint ) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(10) := 'N/A';
ie_medical_device_for_w		bigint;
ie_plataforma_w			man_ordem_servico.ie_plataforma%type := null;
ie_classificacao_w		man_ordem_servico.ie_classificacao%type;
nr_customer_requirement_w	man_ordem_servico.nr_customer_requirement%type;


BEGIN
	select	ie_plataforma,
		ie_classificacao,
		nr_customer_requirement
	into STRICT	ie_plataforma_w,
		ie_classificacao_w,
		nr_customer_requirement_w
	from	man_ordem_servico b
	where	nr_sequencia = nr_seq_os_p;
	
	if (ie_plataforma_w in ('S','D')) then
		ds_retorno_w:= 'N/A';

	elsif (ie_plataforma_w = 'H') then
	
		select	count(*)
		into STRICT	ie_medical_device_for_w
		FROM man_ordem_serv_impacto c, man_ordem_serv_imp_pr b, reg_product_requirement d
LEFT OUTER JOIN reg_customer_requirement e ON (d.nr_customer_requirement = e.nr_sequencia)
WHERE c.nr_seq_ordem_serv = nr_seq_os_p and b.nr_seq_impacto = c.nr_sequencia and b.nr_product_requirement = d.nr_sequencia  and (d.ie_clinico = 'S' or e.ie_clinico = 'S');

		if (ie_classificacao_w = 'S' and ie_medical_device_for_w > 0) then
			return obter_valor_dominio(6, 'S');

		elsif (ie_classificacao_w = 'E') then
			ds_retorno_w := obter_valor_dominio(6,coalesce(man_obter_se_md(nr_customer_requirement_w), 'N'));

		end if;
	else
		ds_retorno_w := obter_valor_dominio(6, 'N');
	end if;
	return 	ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_se_os_md ( nr_seq_os_p bigint ) FROM PUBLIC;

