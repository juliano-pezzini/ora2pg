-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_vagas_clinica (ie_clinica_p bigint, cd_setor_atend_p bigint, cd_convenio_p bigint) RETURNS varchar AS $body$
DECLARE

ie_vaga_setor_w	varchar(1);
qt_vagas_w	integer;
qt_internados_w	bigint;
				

BEGIN 
 
select	coalesce(max(qt_vagas),0) 
into STRICT	qt_vagas_w 
from	regra_clinica_setor 
where	ie_clinica = ie_clinica_p 
and	cd_setor_atendimento = cd_setor_atend_p 
and	coalesce(cd_convenio::text, '') = '';
 
if (qt_vagas_w = 0 ) then 
	 
	select	coalesce(max(qt_vagas),0) 
	into STRICT	qt_vagas_w 
	from	regra_clinica_setor 
	where	ie_clinica = ie_clinica_p 
	and	cd_setor_atendimento = cd_setor_atend_p 
	and (cd_convenio = cd_convenio_p);
	 
	if (qt_vagas_w > 0) then 
	 
		select count(*) 
		into STRICT	qt_internados_w	 
		from 	atendimento_paciente a, 
			atend_categoria_convenio b, 
			atend_paciente_unidade c 
		where 	coalesce(a.dt_alta::text, '') = '' 
		and  	a.nr_atendimento = b.nr_atendimento 
		and  	a.nr_atendimento = c.nr_atendimento 
		and 	a.ie_tipo_atendimento = 1 
		and 	a.ie_clinica = ie_clinica_p 
		and 	b.cd_convenio = cd_convenio_p 
		and 	c.cd_setor_atendimento = cd_setor_atend_p;	
		 
	end if;
 
else 
 
	select count(*) 
	into STRICT	qt_internados_w	 
	from 	atendimento_paciente a, 
		atend_categoria_convenio b, 
		atend_paciente_unidade c 
	where 	coalesce(a.dt_alta::text, '') = '' 
	and  	a.nr_atendimento = b.nr_atendimento 
	and  	a.nr_atendimento = c.nr_atendimento 
	and 	a.ie_tipo_atendimento = 1 
	and 	a.ie_clinica = ie_clinica_p 
	and 	c.cd_setor_atendimento = cd_setor_atend_p;
 
end if;
 
if (qt_vagas_w > 0) then 
 
	if (qt_internados_w >= qt_vagas_w) then 
	 
		ie_vaga_setor_w := 'N';
	else 
		ie_vaga_setor_w := 'S';
		 
	end if;
	 
elsif (qt_vagas_w = 0) then 
	 
	ie_vaga_setor_w := 'S';
	 
end if;
 
return	ie_vaga_setor_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_vagas_clinica (ie_clinica_p bigint, cd_setor_atend_p bigint, cd_convenio_p bigint) FROM PUBLIC;

