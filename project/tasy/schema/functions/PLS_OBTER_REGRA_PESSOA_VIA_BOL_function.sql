-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_regra_pessoa_via_bol ( cd_pessoa_fisica_p text, cd_cgc_p text, nr_titulo_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: 	Obter se emite a segunda via da mensalidade,
	Function utlizada pelo CALL CENTER
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
-------------------------------------------------------------------------------------------------------------------
Referências:
	Objeto - 81945 -> PLS_TITULO_SEGUNDA_VIA_CALL
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_retorno_w				varchar(1)	:= 'S';
nr_seq_regra_w				bigint	:= null;
qt_max_dias_titulo_w		pls_regra_emis_seg_via_bol.qt_max_dias_titulo%type;
ie_permite_visualizar_w		varchar(1)	:= 'N';
dt_venc_original_w			titulo_receber.dt_vencimento%type;
cd_tipo_portador_w			titulo_receber.cd_tipo_portador%type;
cd_tipo_portador_regra_w	pls_regra_emis_seg_via_bol.cd_tipo_portador%type;


BEGIN
--Se o parâmetro estiver marcado como 'N' irá verificar a regra de emissão de segunda via do boleto, se estiver marcada como 'S' irá apresentar todos os titulo em aberto do pagador
ie_permite_visualizar_w := obter_param_usuario(1263, 57, obter_perfil_ativo, obter_usuario_ativo, cd_estabelecimento_p, ie_permite_visualizar_w);

if (ie_permite_visualizar_w = 'N') then
	nr_seq_regra_w	:= pls_obter_regra_seg_via_boleto(	cd_pessoa_fisica_p,
								cd_cgc_p,
								null,
								nr_titulo_p,
								clock_timestamp(),
								'CC',
								cd_estabelecimento_p);

	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
		select	max(a.ie_permite),
			max(a.qt_max_dias_titulo),
			max(a.cd_tipo_portador)
		into STRICT	ie_retorno_w,
			qt_max_dias_titulo_w,
			cd_tipo_portador_regra_w
		from	pls_regra_emis_seg_via_bol	a
		where	a.nr_sequencia	= nr_seq_regra_w;

		select	a.dt_vencimento,
			a.cd_tipo_portador
		into STRICT	dt_venc_original_w,
			cd_tipo_portador_w
		from	titulo_receber	a
		where	a.nr_titulo	= nr_titulo_p;

		if (coalesce(qt_max_dias_titulo_w,0) > 0) and
			(trunc(clock_timestamp()) > (trunc(dt_venc_original_w) + coalesce(qt_max_dias_titulo_w,0))) then
			ie_retorno_w := 'N';
		end if;

		if (cd_tipo_portador_regra_w IS NOT NULL AND cd_tipo_portador_regra_w::text <> '' AND cd_tipo_portador_w <> cd_tipo_portador_regra_w) then
			ie_retorno_w := 'N';
		end if;
	end if;
end if;

return ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_regra_pessoa_via_bol ( cd_pessoa_fisica_p text, cd_cgc_p text, nr_titulo_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

