-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_etiq_rel_solucao ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_material_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


-- M 	- DS_MATERIAL
-- VA	- IE_VIA_APLICACAO
-- QD	- QT_DOSE
-- UM	- CD_UNIDADE_MEDIDA
-- H	- dt_horario
ds_retorno_w		varchar(255);
qt_linha_w			bigint;
ds_material_w		varchar(60);
ie_via_aplic_w		varchar(5);
qt_dose_w			double precision;
cd_unidade_medida_w	varchar(30);
dt_horario_w		varchar(30);

C01 CURSOR FOR
	SELECT 	row_number() OVER () AS qt_linha,
			SUBSTR(obter_desc_material(c.cd_material),1,60) ds_material,
			obter_via_aplic_medic(c.cd_material) ie_via_aplicacao,
			c.qt_dose qt_dose,
			coalesce(c.cd_unidade_medida_dose, c.cd_unidade_medida) cd_unidade_medida,
			c.hr_prim_horario  dt_horario
	FROM	prescr_medica a,
			prescr_solucao b,
			prescr_material c
	WHERE	a.nr_prescricao		= nr_prescricao_p
	AND		a.nr_prescricao		= b.nr_prescricao
	and		b.nr_seq_solucao	= nr_seq_solucao_p
	AND		c.nr_prescricao 	= a.nr_prescricao
	AND		b.nr_seq_solucao	= c.nr_sequencia_solucao
	AND		c.ie_agrupador 		= 4  LIMIT (ie_material_p);


BEGIN

open C01;
loop
fetch C01 into
	qt_linha_w,
	ds_material_w,
	ie_via_aplic_w,
	qt_dose_w,
	cd_unidade_medida_w,
	dt_horario_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (qt_linha_w < ie_material_p) then
		ds_material_w := null;
		ie_via_aplic_w := null;
		qt_dose_w := null;
		cd_unidade_medida_w := null;
		dt_horario_w := null;
	end if;
	end;
end loop;
close C01;

if ('M' = ie_opcao_p) then -- M  - DS_MATERIAL
	ds_retorno_w :=	ds_material_w;
elsif ('VA' = ie_opcao_p) then -- IE  - IE_VIA_APLICACAO
	ds_retorno_w := ie_via_aplic_w;
elsif ('QD' = ie_opcao_p) then -- Q	- QT_DOSE
	ds_retorno_w :=	qt_dose_w;
elsif ('UM' = ie_opcao_p) then -- UM - CD_UNIDADE_MEDIDA
	ds_retorno_w := cd_unidade_medida_w;
elsif ('H' = ie_opcao_p) then -- UM - CD_UNIDADE_MEDIDA
	ds_retorno_w := dt_horario_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_etiq_rel_solucao ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_material_p bigint, ie_opcao_p text) FROM PUBLIC;

