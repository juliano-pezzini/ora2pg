-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_porte_proc_int_agenda ( cd_edicao_amb_p bigint, nr_seq_agenda_p bigint) RETURNS bigint AS $body$
DECLARE

 
nr_seq_proc_interno_w	bigint;
dt_agenda_w		timestamp;
cd_proced_princ_w	bigint;
qt_porte_anestesico_w	smallint;


BEGIN 
 
if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then 
	begin	 
	/* Obter os dados do agendamento */
 
	select	coalesce(nr_seq_proc_interno, 0), 
		dt_agenda 
	into STRICT	nr_seq_proc_interno_w, 
		dt_agenda_w 
	from	agenda_paciente 
	where	nr_sequencia	= nr_seq_agenda_p;
	 
	/* Obter o procedimento interno e a origem proced */
 
	if (nr_seq_proc_interno_w <> 0) then		 
		select	cd_procedimento 
		into STRICT	cd_proced_princ_w 
		from	proc_interno 
		where	nr_sequencia = nr_seq_proc_interno_w;
	end if;
 
	/* Obter o porte anest√©sico do procedimento principal conforme a tabela informada */
 
	select	coalesce(max(qt_porte_anestesico),0) 
	into STRICT	qt_porte_anestesico_w 
	from 	preco_amb a 
	where (a.cd_edicao_amb  	= cd_edicao_amb_p) 
	and (a.cd_procedimento 	= cd_proced_princ_w) 
 	and 	coalesce(a.dt_inicio_vigencia,clock_timestamp() - interval '3650 days') = 
			(SELECT	max(coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days')) 
			from 	preco_amb b 
			where 	b.cd_edicao_amb		= cd_edicao_amb_p 
			and	b.cd_procedimento	= cd_proced_princ_w 
			and	coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days') <= dt_agenda_w);
 
	return	qt_porte_anestesico_w;	
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_porte_proc_int_agenda ( cd_edicao_amb_p bigint, nr_seq_agenda_p bigint) FROM PUBLIC;

