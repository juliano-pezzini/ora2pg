-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dose_convertida (cd_material_p bigint, qt_dose_origem_p bigint, cd_unid_medida_ori_p text, cd_unid_medida_dest_p text ) RETURNS bigint AS $body$
DECLARE

  qt_dose_convertida_w    double precision := 0;
  cd_unid_med_cons_w      varchar(30);
  qt_conversao_und_ori_w  double precision;
  qt_conversao_und_dest_w double precision;
  EXEC_W                  varchar(200);

BEGIN
  begin
    select coalesce(a.cd_unidade_medida_consumo, b.cd_unidade_medida_consumo)
    into STRICT  cd_unid_med_cons_w
    from	material_estab a,
          material b
    where	b.cd_material	= a.cd_material
    and	  a.cd_material	= cd_material_p
    and  	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
  exception
    when others then
      begin
        select cd_unidade_medida_consumo
        into STRICT	 cd_unid_med_cons_w
        from	 material
        where	 cd_material = cd_material_p;
      exception
      when others then
      null;
      end;
  end;

  begin
    select coalesce(max(qt_conversao),0)
    into STRICT	 qt_conversao_und_ori_w
    from	 material_conversao_unidade
    where	 upper(cd_unidade_medida) = upper(cd_unid_medida_ori_p)
    and		 cd_material = cd_material_p;
    exception
    when others then
        qt_conversao_und_ori_w := null;
  end;

  begin
    select coalesce(max(qt_conversao),0)
    into STRICT   qt_conversao_und_dest_w
    from   material_conversao_unidade
    where  upper(cd_unidade_medida) = upper(cd_unid_medida_dest_p)
    and	   cd_material = cd_material_p;
    exception
    when others then
        qt_conversao_und_dest_w := null;
  end;

  begin
    EXEC_W := 'CALL OBTER_DOSE_CONVERTIDA_MD(:1,:2,:3,:4,:5,:6) INTO :RESULT';

    EXECUTE EXEC_W USING IN qt_dose_origem_p,
                                    IN cd_unid_medida_ori_p,
                                    IN cd_unid_medida_dest_p,
                                    IN cd_unid_med_cons_w,
                                    IN qt_conversao_und_ori_w,
                                    IN qt_conversao_und_dest_w,
                                    OUT qt_dose_convertida_w;
  exception
    when others then
      qt_dose_convertida_w := null;
  end;

  return	qt_dose_convertida_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dose_convertida (cd_material_p bigint, qt_dose_origem_p bigint, cd_unid_medida_ori_p text, cd_unid_medida_dest_p text ) FROM PUBLIC;

