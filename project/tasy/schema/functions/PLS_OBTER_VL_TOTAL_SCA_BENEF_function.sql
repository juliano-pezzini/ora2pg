-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_vl_total_sca_benef ( nr_seq_segurado_p bigint ) RETURNS bigint AS $body$
DECLARE


nr_seq_tabela_preco_w	pls_sca_vinculo.nr_sequencia%type;
vl_preco_atual_w		pls_plano_preco.vl_preco_atual%type;
vl_total_w				pls_plano_preco.vl_preco_atual%type;
qt_idade_segurado_w		smallint;
ie_titular_w			varchar(255);
ie_tipo_parentesco_w	varchar(255);
ie_grau_titularidade_w	varchar(255) := null;

C00 CURSOR FOR
	SELECT	nr_seq_tabela
	from	pls_sca_vinculo
	where	nr_seq_segurado = nr_seq_segurado_p
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		coalesce(dt_fim_vigencia::text, '') = '';


BEGIN
vl_total_w := 0;
qt_idade_segurado_w := pls_obter_idade_segurado(nr_seq_segurado_p, clock_timestamp(),'A');

select	CASE WHEN coalesce(nr_seq_titular::text, '') = '' THEN 'S'  ELSE 'N' END
into STRICT	ie_titular_w
from	pls_segurado
where	nr_sequencia = nr_seq_segurado_p;

if (ie_titular_w = 'S')	then
	ie_grau_titularidade_w := 'T';	-- Titular
else
	select	ie_tipo_parentesco
	into STRICT	ie_tipo_parentesco_w
	from	pls_segurado
	where	nr_sequencia = nr_seq_segurado_p;

	if (ie_tipo_parentesco_w = '1')	then
		ie_grau_titularidade_w := 'DL';	-- Dependente Legal
	elsif (ie_tipo_parentesco_w = '2')	then
		ie_grau_titularidade_w := 'DA';	-- Dependente Agregado
	end if;
end if;

open C00;
	loop
	fetch C00 into
		nr_seq_tabela_preco_w;
	EXIT WHEN NOT FOUND; /* apply on C00 */
	begin
		select	max(vl_preco_atual)
		into STRICT	vl_preco_atual_w
		from	pls_plano_preco
		where	nr_seq_tabela = nr_seq_tabela_preco_w
		and (qt_idade_segurado_w between qt_idade_inicial and qt_idade_final)
		and	 	((ie_grau_titularidade = ie_grau_titularidade_w) or (coalesce(ie_grau_titularidade::text, '') = ''));

		vl_total_w := vl_total_w + vl_preco_atual_w;
	end;
	end loop;
close C00;

return	vl_total_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_vl_total_sca_benef ( nr_seq_segurado_p bigint ) FROM PUBLIC;

