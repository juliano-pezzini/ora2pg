-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_parametro ( cd_estabelecimento_p bigint, nr_prescricao_p bigint, ds_maquina_p text, ie_parametro_p text) RETURNS varchar AS $body$
DECLARE

 
ie_tipo_atendimento_w  smallint;
ie_tem_regra_w    smallint;
cd_estabelecimento_w  smallint;
DS_MAQUINA_W    varchar(100);
IE_INTEGRA_FLEURY_W   varchar(1);
CD_UNIDADE_FLEURY_W   varchar(5);
DS_URL_SERV_FLEURY_W  varchar(100);
DS_URL_PERG_FLEURY_W  lab_parametro.ds_url_perg_fleury%type;
DS_URL_CONT_FLEURY_W  varchar(100);
IE_OBRIGA_PERG_MAT_FLEURY_W varchar(1);
IE_FECHA_PERG_FLEURY_W  varchar(1);
cd_perfil_w   perfil.cd_perfil%type;
cd_contrato_fleury_w  lab_parametro.cd_contrato_fleury%type;
cd_convenio_w   convenio.cd_convenio%type;
cd_categoria_w   categoria_convenio.cd_categoria%type;
ds_url_perg_par_fleury_w  lab_parametro.ds_url_perg_par_fleury%type;

c01 CURSOR FOR 
 SELECT IE_INTEGRA_FLEURY, 
  CD_UNIDADE_FLEURY, 
  DS_URL_SERV_FLEURY, 
  DS_URL_PERG_FLEURY, 
  DS_URL_CONT_FLEURY, 
  cd_contrato_fleury, 
  ds_url_perg_par_fleury 
 from lab_param_maquina 
 where cd_estabelecimento = cd_estabelecimento_w 
 and coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0)) = coalesce(ie_tipo_atendimento_w,0) 
 and coalesce(ds_maquina, coalesce(ds_maquina_p,0)) = coalesce(ds_maquina_p,0) 
 and coalesce(cd_perfil, coalesce(cd_perfil_w,0))  = coalesce(cd_perfil_w,0) 
 and coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0) 
 and coalesce(cd_categoria, coalesce(cd_categoria_w,0)) = coalesce(cd_categoria_w,0) 
 order by coalesce(ie_tipo_atendimento, 0) desc, 
    coalesce(ds_maquina,'0'), 
    coalesce(cd_convenio, 0) desc, 
    coalesce(cd_perfil, 0) desc, 
    coalesce(cd_categoria, '0');


BEGIN 
 
--cd_perfil_w := obter_perfil_ativo; 
 
select max(ie_tipo_atendimento), 
 max(coalesce(a.cd_estabelecimento,cd_estabelecimento_p)), 
 coalesce(max(obter_convenio_atendimento(b.nr_atendimento)),0), 
 coalesce(max(obter_cat_conv_atend(b.nr_atendimento, obter_convenio_atendimento(b.nr_atendimento))),0), 
 coalesce(max(a.cd_perfil_ativo), obter_perfil_ativo) 
into STRICT ie_tipo_atendimento_w, 
 cd_estabelecimento_w, 
 cd_convenio_w, 
 cd_categoria_w, 
 cd_perfil_w 
from atendimento_paciente b, 
 prescr_medica a 
where a.nr_atendimento = b.nr_atendimento 
 and a.nr_prescricao = nr_prescricao_p;
 
RAISE NOTICE '% - % - % - % - %', ie_tipo_atendimento_w, cd_estabelecimento_w, cd_convenio_w, cd_categoria_w, cd_perfil_w;
 
ie_tem_regra_w := 0;
/*open c01; 
loop 
 fetch c01 into IE_INTEGRA_FLEURY_W, 
   CD_UNIDADE_FLEURY_W, 
   DS_URL_SERV_FLEURY_W, 
   DS_URL_PERG_FLEURY_W, 
   DS_URL_CONT_FLEURY_W, 
   cd_contrato_fleury_w, 
   ds_url_perg_par_fleury_w; 
 exit when c01%notfound or ie_tem_regra_w > 0; 
 ie_tem_regra_w := ie_tem_regra_w + 1; 
 dbms_output.put_line('teste'); 
end loop; 
close c01;*/
 
 
 
begin 
select IE_INTEGRA_FLEURY, 
		CD_UNIDADE_FLEURY, 
		DS_URL_SERV_FLEURY, 
		DS_URL_PERG_FLEURY, 
		DS_URL_CONT_FLEURY, 
		cd_contrato_fleury, 
		ds_url_perg_par_fleury, 
		1 
into STRICT  	IE_INTEGRA_FLEURY_W, 
		CD_UNIDADE_FLEURY_W, 
		DS_URL_SERV_FLEURY_W, 
		DS_URL_PERG_FLEURY_W, 
		DS_URL_CONT_FLEURY_W, 
		cd_contrato_fleury_w, 
		ds_url_perg_par_fleury_w, 
		ie_tem_regra_w 
from ( 
		SELECT	IE_INTEGRA_FLEURY, 
				CD_UNIDADE_FLEURY, 
				DS_URL_SERV_FLEURY, 
				DS_URL_PERG_FLEURY, 
				DS_URL_CONT_FLEURY, 
				cd_contrato_fleury, 
				ds_url_perg_par_fleury 
		from 	lab_param_maquina 
		where 	cd_estabelecimento = cd_estabelecimento_w 
		and 	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0)) = coalesce(ie_tipo_atendimento_w,0) 
		and 	coalesce(ds_maquina, coalesce(ds_maquina_p,0)) = coalesce(ds_maquina_p,0) 
		and 	coalesce(cd_perfil, coalesce(cd_perfil_w,0))  = coalesce(cd_perfil_w,0) 
		and 	coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0) 
		and 	coalesce(cd_categoria, coalesce(cd_categoria_w,0)) = coalesce(cd_categoria_w,0) 
		order by coalesce(ie_tipo_atendimento, 0) desc, 
				coalesce(ds_maquina,'0'), 
				coalesce(cd_convenio, 0) desc, 
				coalesce(cd_perfil, 0) desc, 
				coalesce(cd_categoria, '0')) alias20 LIMIT 1;
 
exception 
	when no_data_found then 
		begin 
		ie_tem_regra_w	:= 0;
		end;		
end;
 
if (coalesce(ie_tem_regra_w,0) = 0) then 
 select  coalesce(max(IE_INTEGRA_FLEURY), 'N'), 
  coalesce(max(CD_UNIDADE_FLEURY), null), 
  coalesce(max(DS_URL_SERV_FLEURY), null), 
  coalesce(max(DS_URL_PERG_FLEURY), null), 
  coalesce(max(DS_URL_CONT_FLEURY), null), 
  coalesce(max(IE_PERGUNTA_TECNICA_OBRIG), 'N'), 
  coalesce(max(IE_FECHA_PERG_FLEURY), 'N'), 
  coalesce(max(ds_url_perg_par_fleury), null) 
 into STRICT IE_INTEGRA_FLEURY_W, 
  CD_UNIDADE_FLEURY_W, 
  DS_URL_SERV_FLEURY_W, 
  DS_URL_PERG_FLEURY_W, 
  DS_URL_CONT_FLEURY_W, 
  IE_OBRIGA_PERG_MAT_FLEURY_W, 
  IE_FECHA_PERG_FLEURY_W, 
  ds_url_perg_par_fleury_w 
 from lab_parametro 
 where cd_estabelecimento = cd_estabelecimento_w;
end if;
 
if (ie_parametro_p = 'IF') then 
 return IE_INTEGRA_FLEURY_W;
elsif (ie_parametro_p = 'UF') then 
 return CD_UNIDADE_FLEURY_W;
elsif (ie_parametro_p = 'SF') then 
 return DS_URL_SERV_FLEURY_W;
elsif (ie_parametro_p = 'PF') then 
 return DS_URL_PERG_FLEURY_W;
elsif (ie_parametro_p = 'CF') then 
 return DS_URL_CONT_FLEURY_W;
elsif (ie_parametro_p = 'IOF') then 
 return IE_OBRIGA_PERG_MAT_FLEURY_W;
elsif (ie_parametro_p = 'IFP') then 
 return IE_FECHA_PERG_FLEURY_W;
elsif (ie_parametro_p = 'COF') then 
 return cd_contrato_fleury_w;
elsif (ie_parametro_p = 'PU') then 
 return ds_url_perg_par_fleury_w;
else 
 return null;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_parametro ( cd_estabelecimento_p bigint, nr_prescricao_p bigint, ds_maquina_p text, ie_parametro_p text) FROM PUBLIC;

