-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_amount_auth_bonus_req ( nr_seq_autorizacao_p PROCEDIMENTO_AUTORIZADO.NR_SEQUENCIA%type ) RETURNS bigint AS $body$
DECLARE


c10 CURSOR FOR
	SELECT 	DISTINCT a.NR_SEQ_REGRA_PLANO,
		COUNT(a.NR_SEQUENCIA) QT_PROC_AUTORIZADO
	FROM 	PROCEDIMENTO_AUTORIZADO a
	WHERE 	a.NR_SEQUENCIA_AUTOR = nr_seq_autorizacao_p
	GROUP BY a.NR_SEQ_REGRA_PLANO
	ORDER BY a.NR_SEQ_REGRA_PLANO;

c20 CURSOR FOR
	SELECT 	DISTINCT a.NR_SEQ_REGRA_PLANO,
	        COUNT(a.NR_SEQUENCIA) QT_MAT_AUTORIZADO
	FROM	MATERIAL_AUTORIZADO a
	WHERE	a.NR_SEQUENCIA_AUTOR = nr_seq_autorizacao_p
	GROUP BY a.NR_SEQ_REGRA_PLANO
	ORDER BY a.NR_SEQ_REGRA_PLANO;

tb_proc_aut_w 		c10%rowtype;
tb_mat_aut_w		c20%rowtype;
qt_required_bonus_w	BONUS_QUANTITY_RULE.QT_REQUIRED_BONUS%type;
qt_required_total_w	BONUS_QUANTITY_RULE.QT_REQUIRED_BONUS%type := 0;


BEGIN

OPEN c10;
LOOP
FETCH c10 INTO tb_proc_aut_w;
EXIT WHEN NOT FOUND; /* apply on c10 */
	SELECT 	coalesce(MAX(a.QT_REQUIRED_BONUS), 0)
	INTO STRICT 	qt_required_bonus_w
	FROM 	BONUS_QUANTITY_RULE a
	WHERE 	a.NR_SEQ_REGRA_PROC = tb_proc_aut_w.NR_SEQ_REGRA_PLANO
	AND 	tb_proc_aut_w.QT_PROC_AUTORIZADO BETWEEN a.QT_ITEM_FROM AND a.QT_ITEM_TO;

	qt_required_total_w := qt_required_total_w + qt_required_bonus_w;
END LOOP;
CLOSE c10;

OPEN c20;
LOOP
FETCH c20 INTO tb_mat_aut_w;
EXIT WHEN NOT FOUND; /* apply on c20 */
	SELECT 	coalesce(MAX(a.QT_REQUIRED_BONUS), 0)
	INTO STRICT 	qt_required_bonus_w
	FROM 	BONUS_QUANTITY_RULE a
	WHERE 	a.NR_SEQ_REGRA_PROC = tb_mat_aut_w.NR_SEQ_REGRA_PLANO
	AND 	tb_mat_aut_w.QT_MAT_AUTORIZADO BETWEEN a.QT_ITEM_FROM AND a.QT_ITEM_TO;

	qt_required_total_w := qt_required_total_w + qt_required_bonus_w;
END LOOP;
CLOSE c20;

RETURN qt_required_total_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_amount_auth_bonus_req ( nr_seq_autorizacao_p PROCEDIMENTO_AUTORIZADO.NR_SEQUENCIA%type ) FROM PUBLIC;

