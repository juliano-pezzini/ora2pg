-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_valida_form_benef ( nr_carteira_p text, dt_nasc_p text, nr_cpf_p text, nr_rg_p text, ds_email_p text, ds_nome_p text) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w			varchar(255) := 'S';
nr_seq_segurado_w		bigint;
dt_nascimento_w			timestamp;
nr_cpf_w			varchar(11);
nr_rg_w				varchar(15);
nr_rg_estrang_w			varchar(30);
ds_email_w			varchar(60);
ie_brasileiro_w			varchar(1);
nm_pessoa_fisica_w		varchar(60);
cd_nacionalidade_w		varchar(8);
nr_carteira_w			varchar(30);

 
/* Retorna a mensagem com o erro ocorrido ou S quando está tudo ok. 
Na mensagem de erro contém a mensagem e um código para definir o campo que deve receber o focus. 
1 - Carteira 
 
2 - Nome 
3 - Email 
4 - Data de nascimento 
5 - CPF 
6 - RG 
*/
 
 

BEGIN 
 
nr_carteira_w := elimina_caractere_especial(nr_carteira_p);
 
nr_seq_segurado_w := pls_obter_dados_carteira(null, nr_carteira_w, 'S');
 
if (coalesce(dt_nasc_p::text, '') = '') then 
	ds_retorno_w := 'Data de nascimento não informada#4';
	return ds_retorno_w;
elsif (coalesce(nr_cpf_p::text, '') = '' and coalesce(nr_rg_p::text, '') = '') then 
	ds_retorno_w := 'CPF ou RG devem ser informados#5';
	return ds_retorno_w;
elsif (coalesce(ds_email_p::text, '') = '') then 
	ds_retorno_w :=	'Email não informado#3';
	return ds_retorno_w;
elsif (coalesce(ds_nome_p::text, '') = '') then 
	ds_retorno_w := 'Nome não informado#2';
	return ds_retorno_w;
end if;
 
if (coalesce(nr_seq_segurado_w::text, '') = '') then 
	ds_retorno_w := 'Carteira não encontrada#1';
else 
	select	max(a.cd_nacionalidade) 
	into STRICT	cd_nacionalidade_w 
	from	pessoa_fisica	a, 
	    pls_segurado 	b	 
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 
	and	b.nr_sequencia		= nr_seq_segurado_w;
	 
	if (cd_nacionalidade_w IS NOT NULL AND cd_nacionalidade_w::text <> '') then	 
		select	a.dt_nascimento, 
			a.nr_cpf, 
			a.nr_identidade, 
			a.nr_reg_geral_estrang, 
			c.ie_brasileiro, 
			obter_compl_pf(a.cd_pessoa_fisica, 1, 'M'), 
			a.nm_pessoa_pesquisa 
 
		into STRICT	dt_nascimento_w, 
			nr_cpf_w, 
			nr_rg_w, 
			nr_rg_estrang_w, 
			ie_brasileiro_w, 
			ds_email_w, 
			nm_pessoa_fisica_w 
 
		from	pessoa_fisica	a, 
			pls_segurado 	b, 
			nacionalidade 	c 
		where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 
		and	a.cd_nacionalidade 	= c.cd_nacionalidade 
		and	b.nr_sequencia		= nr_seq_segurado_w;
		 
		if (padronizar_nome(ds_nome_p) != nm_pessoa_fisica_w) then 
			ds_retorno_w	:= 'Nome não confere#2';
		elsif (coalesce(ds_email_w::text, '') = '') then 
			ds_retorno_w	:= 'Email não cadastrado. Entre em contato com a Operadora para realizar o cadastro#3';
		elsif (upper(ds_email_w) != upper(ds_email_p)) then 
			ds_retorno_w	:= 'Email não confere#3';
		elsif (coalesce(dt_nascimento_w::text, '') = '') then 
			ds_retorno_w	:= 'Data de nascimento não cadastrada. Entre em contato com a Operadora para realizar o cadastro.#4';
		elsif (trunc(dt_nascimento_w) != to_date(dt_nasc_p, 'dd/mm/yyyy')) then 
			ds_retorno_w 	:= 'Data de nascimento não confere#4';
		elsif (ie_brasileiro_w = 'N') then 
			if (coalesce(nr_rg_p::text, '') = '') then 
				ds_retorno_w	:= 'RG Estrangeiro não informado#6';
			elsif (coalesce(nr_rg_estrang_w::text, '') = '') then 
				ds_retorno_w 	:= 'RG Estrangeiro não cadastrado. Entre em contato com a Operadora para realizar o cadastro.#6';
			elsif (nr_rg_estrang_w != nr_rg_p) then 
				ds_retorno_w	:= 'RG Estrangeiro não confere#6';
			end if;
		elsif (ie_brasileiro_w = 'S') then 
			if (nr_cpf_p IS NOT NULL AND nr_cpf_p::text <> '') then 
				if (coalesce(nr_cpf_w::text, '') = '') then 
					ds_retorno_w 	:= 'CPF não cadastrado. Entre em contato com a Operadora para realizar o cadastro.#5';
				elsif (coalesce(nr_cpf_p::text, '') = '') then 
					ds_retorno_w 	:= 'CPF não informado#5';
				elsif (nr_cpf_p != nr_cpf_w) then 
					ds_retorno_w	:= 'CPF não confere#5';
				end if;
			elsif (nr_rg_p IS NOT NULL AND nr_rg_p::text <> '') then 
				if (coalesce(nr_rg_w::text, '') = '') then 
					ds_retorno_w	:= 'RG não cadastrado. Entre em contato com a Operadora para realizar o cadastro.#6';
				elsif (nr_rg_w != nr_rg_p) then 
					ds_retorno_w	:= 'RG não confere#6';
				end if;
			end if;			
 
 
 
		end if;	
	else 
		ds_retorno_w := 'Beneficiário com a nacionalidade não cadastrada.#6';
	end if;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_valida_form_benef ( nr_carteira_p text, dt_nasc_p text, nr_cpf_p text, nr_rg_p text, ds_email_p text, ds_nome_p text) FROM PUBLIC;

