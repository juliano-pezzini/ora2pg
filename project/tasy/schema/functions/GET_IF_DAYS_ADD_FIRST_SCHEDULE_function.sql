-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_if_days_add_first_schedule (nr_atendimento_p bigint, cd_estabelecimento_p bigint, dt_prescricao_p timestamp, nm_usuario_p text, cd_perfil_p bigint, ie_funcao_p text, ie_via_aplicacao_p text) RETURNS varchar AS $body$
DECLARE


nm_usuario_w			usuario.nm_usuario%type;
cd_perfil_w				perfil.cd_perfil%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_setor_atend_prescr_w		setor_atendimento.cd_setor_atendimento%type;
ie_regra_horario_w    prescr_horario_setor.ie_regra_horario%type;
si_has_rule_w varchar(1) := 'N';

C01 CURSOR FOR
	SELECT	ie_regra_horario
	from	prescr_horario_setor
	where	coalesce(cd_setor_atendimento, coalesce(cd_setor_atend_prescr_w,0)) = coalesce(cd_setor_atend_prescr_w,0)
	and	coalesce(nm_usuario_regra, coalesce(nm_usuario_w, 0)) = coalesce(nm_usuario_w, 0)
	and	coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
	and	coalesce(cd_perfil, cd_perfil_w) = cd_perfil_w
	and	((coalesce(ie_funcao_p,'A') = coalesce(ie_funcao,'A')) or (coalesce(ie_funcao,'A') = 'A'))
	and	dt_prescricao_p between obter_prim_hor_prescr_regra(dt_prescricao_p,
						coalesce(hr_inicio,pkg_date_utils.get_dateTime(1900, 1, 1, 00, 00, 01)), 
						coalesce(hr_fim,pkg_date_utils.get_dateTime(1900,01,01,23,59,59)), 'I') and
					obter_prim_hor_prescr_regra(dt_prescricao_p, 
						coalesce(hr_inicio,pkg_date_utils.get_dateTime(1900, 1, 1, 00, 00, 01)), 
						coalesce(hr_fim,pkg_date_utils.get_dateTime(1900,01,01,23,59,59)), 'F')
	and	coalesce(ie_via_aplicacao, coalesce(ie_via_aplicacao_p, 0)) = coalesce(ie_via_aplicacao_p, 0)
	order by coalesce(nr_seq_prioridade,0),
		coalesce(cd_setor_atendimento,99999999) desc,
		coalesce(cd_perfil,9999999) desc,
		coalesce(nm_usuario_regra, 'XXXX') desc,
		hr_fixa desc;

BEGIN

cd_perfil_w				:=  coalesce(cd_perfil_p, wheb_usuario_pck.get_cd_perfil);
nm_usuario_w			:=  coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario);
cd_estabelecimento_w	:=  coalesce(cd_estabelecimento_p, wheb_usuario_pck.get_cd_estabelecimento);

cd_setor_atend_prescr_w := cpoe_obter_setor_atend_prescr(nr_atendimento_p,cd_estabelecimento_w,cd_perfil_w,nm_usuario_w);

FOR C01_w IN C01 LOOP
  ie_regra_horario_w := C01_w.ie_regra_horario;
END LOOP;

if (ie_regra_horario_w = 'D1') or		-- Sunday according interval first time
  (ie_regra_horario_w = 'D2') or		-- Monday according interval first time
  (ie_regra_horario_w = 'D3') or		-- Tuesday according interval first time
  (ie_regra_horario_w = 'D4') or		-- Wednesday according interval first time
  (ie_regra_horario_w = 'D5') or		-- Thursday according interval first time
  (ie_regra_horario_w = 'D6') or		-- Friday according interval first time
  (ie_regra_horario_w = 'D7') then		-- Saturday according interval first time
  si_has_rule_w := 'S';

end if;

return si_has_rule_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_if_days_add_first_schedule (nr_atendimento_p bigint, cd_estabelecimento_p bigint, dt_prescricao_p timestamp, nm_usuario_p text, cd_perfil_p bigint, ie_funcao_p text, ie_via_aplicacao_p text) FROM PUBLIC;

