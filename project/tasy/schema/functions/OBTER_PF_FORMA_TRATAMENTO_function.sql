-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_pf_forma_tratamento ( cd_pessoa_fisica_p text, nm_usuario_p text, IE_SIGLA_P text default 'S', IE_NOME_COMPLETO text default 'S') RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(100);
ds_sigla_w	varchar(100);
qt_titulo_academico_w	bigint;


BEGIN

select	count(*)
into STRICT	qt_titulo_academico_w
from	pessoa_paciente_config
where	IE_CAMPO_PACIENTE = 'TA'
and		(	(cd_pessoa_fisica = obter_pf_usuario_ativo or coalesce(cd_pessoa_fisica::text, '') = '')
		and (cd_perfil = obter_perfil_ativo or coalesce(cd_perfil::text, '') = '')
		and (cd_estabelecimento = obter_estabelecimento_ativo or coalesce(cd_estabelecimento::text, '') = '')
		and (OBTER_SE_ESPECIALIDADES_MEDICO(cd_especialidade, '(' || OBTER_ESPECIALIDADE_MEDICO_COD(obter_pf_usuario_ativo) || ')') = 'S' or coalesce(cd_especialidade::text, '') = '')
		and (cd_funcao = obter_funcao_ativa or coalesce(cd_funcao::text, '') = ''));

if (IE_NOME_COMPLETO = 'S') then
	ds_retorno_w := OBTER_NOME_PESSOA_FISICA(CD_PESSOA_FISICA_P, null);
else
	ds_retorno_w := Obter_Parte_Nome_phillips_pf(OBTER_NOME_PESSOA_FISICA(CD_PESSOA_FISICA_P, null),'nome');
end if;

if (qt_titulo_academico_w > 0) then

  select  CASE WHEN IE_SIGLA_P='S' THEN  a.DS_SIGLA  ELSE a.DS_FORMA_TRATAMENTO END
  into STRICT	  ds_sigla_w
  from 	  PF_FORMA_TRATAMENTO a,
          PESSOA_FISICA b
  where   b.cd_pessoa_fisica = CD_PESSOA_FISICA_P
  and     a.nr_sequencia = b.NR_SEQ_FORMA_TRAT
  and     coalesce(a.ie_situacao,'A') = 'A';

   if (ds_sigla_w IS NOT NULL AND ds_sigla_w::text <> '') then
    ds_retorno_w := ds_sigla_w || ' ' || ds_retorno_w;
  end if;

end if;

RETURN ds_retorno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_pf_forma_tratamento ( cd_pessoa_fisica_p text, nm_usuario_p text, IE_SIGLA_P text default 'S', IE_NOME_COMPLETO text default 'S') FROM PUBLIC;

