-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_exames_lab_integr_online ( nr_prescricao_p bigint, cd_setor_atendimento_p bigint, cd_material_p text, nr_seq_grupo_p bigint, ie_equipamento_p text, ie_opcao_p text, ie_separador_p text, nr_seq_grupo_imp_p bigint, nr_seq_lab_p text, ie_status_envio_p bigint, ds_sigla_p text, nr_seq_apresent_p bigint, nr_seq_lote_externo_p bigint, ie_tipo_atendimento_p bigint, nr_seq_amostra_item_p bigint) RETURNS varchar AS $body$
DECLARE


ie_opcao_w				varchar(255);
ie_status_atend_w			varchar(2);
cd_procedimento_w			bigint;
nr_seq_exame_w				bigint;
cd_exame_w				varchar(20);
cd_exame_integracao_w			varchar(20);
Resultado_w	 			varchar(1000);
qt_linha_w				smallint := 0;
ds_material_especial_w			varchar(255);
nr_sequencia_w				bigint;

ds_aux_w				varchar(100);
nr_seq_amostra_w			varchar(2);
nm_exame_w				varchar(80);
ie_padrao_amostra_w			varchar(5);
cd_estabelecimento_w			integer;
nr_amostra_w				integer;
cd_exame_filho_w			varchar(100);

c01 CURSOR FOR
	SELECT	a.cd_procedimento,
		b.nr_seq_exame,
		b.cd_exame,
		coalesce(b.cd_exame_integracao, b.cd_exame),
		max(a.nr_sequencia),
		b.nm_exame
	from	exame_lab_material d,
		material_exame_lab c,
		exame_laboratorio b,
		prescr_procedimento a
	where a.nr_seq_exame			= b.nr_seq_exame
	  and a.nr_seq_exame			= d.nr_seq_exame
	  and d.nr_seq_material			= c.nr_sequencia
	  and a.nr_prescricao			= nr_prescricao_p
	  and coalesce(a.cd_setor_atendimento,0)	= coalesce(coalesce(cd_setor_atendimento_p, a.cd_setor_atendimento),0)
	  and (a.cd_material_exame		= coalesce(cd_material_p, a.cd_material_exame) or (c.cd_material_exame		= cd_material_p and d.ie_prioridade = 888))
	  and ((nr_seq_GRUPO_IMP 		= coalesce(nr_seq_GRUPO_IMP_P,nr_seq_GRUPO_IMP)) or (coalesce(nr_seq_GRUPO_IMP::text, '') = ''))
	  and ((a.nr_seq_lab = coalesce(NR_SEQ_LAB_P,a.nr_seq_lab)) or (ie_padrao_amostra_w in ('PM','PM11','PM13')))
	  and b.nr_seq_grupo			= coalesce(nr_seq_grupo_p, b.nr_seq_grupo)
	  and coalesce(d.qt_coleta,1) 		>= (coalesce(ie_equipamento_p,'1'))::numeric
	  and a.ie_status_atend			= coalesce(ie_status_atend_w, a.ie_status_atend)
	  and (a.nr_seq_lote_externo	= coalesce(nr_seq_lote_externo_p, a.nr_seq_lote_externo) or (coalesce(nr_seq_lote_externo::text, '') = ''))
	  and ((ds_material_especial_w = 'X' and coalesce(a.ds_material_especial::text, '') = '') or (a.ds_material_especial = ds_material_especial_w))
	  and coalesce(nr_seq_amostra_item_p::text, '') = ''
	  and (ie_padrao_amostra_w not in ('AM11F','AM10F','AMO9','AMO13','AMO11','AMO10'))
	group by 	a.cd_procedimento,
			b.nr_seq_exame,
			b.cd_exame,
			coalesce(b.cd_exame_integracao, b.cd_exame),
			b.nm_exame
	
union all

	SELECT	a.cd_procedimento,
		b.nr_seq_exame,
		b.cd_exame,
		coalesce(b.cd_exame_integracao, b.cd_exame),
		max(a.nr_sequencia),
		b.nm_exame
	from	exame_lab_material d,
		material_exame_lab c,
		exame_laboratorio b,
		prescr_proc_mat_item e,
		prescr_procedimento a
	where a.nr_seq_exame			= b.nr_seq_exame
	  and a.nr_seq_exame			= d.nr_seq_exame
	  and d.nr_seq_material			= c.nr_sequencia
	  and e.nr_prescricao			= a.nr_prescricao
	  and e.nr_seq_prescr			= a.nr_sequencia
	  and a.nr_prescricao			= nr_prescricao_p
	  and coalesce(a.cd_setor_atendimento,0)	= coalesce(coalesce(cd_setor_atendimento_p, a.cd_setor_atendimento),0)
	  and (a.cd_material_exame		= coalesce(cd_material_p, a.cd_material_exame) or (c.cd_material_exame		= cd_material_p and d.ie_prioridade = 888))
	  and ((nr_seq_GRUPO_IMP 		= coalesce(nr_seq_GRUPO_IMP_P,nr_seq_GRUPO_IMP)) or (coalesce(nr_seq_GRUPO_IMP::text, '') = ''))
	  and (e.NR_SEQ_PRESCR_PROC_MAT)				= nr_seq_amostra_item_p
	  and b.nr_seq_grupo			= coalesce(nr_seq_grupo_p, b.nr_seq_grupo)
	  and coalesce(d.qt_coleta,1) 		>= (coalesce(ie_equipamento_p,'1'))::numeric 
	  and a.ie_status_atend			= coalesce(ie_status_atend_w, a.ie_status_atend)
	  and (a.nr_seq_lote_externo	= coalesce(nr_seq_lote_externo_p, a.nr_seq_lote_externo) or (coalesce(nr_seq_lote_externo::text, '') = ''))
	  and ((ds_material_especial_w = 'X' and coalesce(a.ds_material_especial::text, '') = '') or (a.ds_material_especial = ds_material_especial_w))
	  and (nr_seq_amostra_item_p IS NOT NULL AND nr_seq_amostra_item_p::text <> '')
	  and (ie_padrao_amostra_w in ('AM11F','AM10F','AMO9','AMO13','AMO11','AMO10'))
	group by 	a.cd_procedimento,
			b.nr_seq_exame,
			b.cd_exame,
			coalesce(b.cd_exame_integracao, b.cd_exame),
			b.nm_exame
	order by 5;



BEGIN

/* Opções
	CP	- Código Procedimento
	EX	- Exame
	CE	- Código Exame
	CI	- Código Integração
	CI3	- Código Integração com 3 dígitos
	CI8	- Código Integração com 8 dígitos
	NME3	- Nome do exame com 3 digitos
	CE8	- Código Exame com 8 dígitos
*/
select 	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

ie_opcao_w	:= ie_opcao_p;
resultado_w	:= '';

select coalesce(max(ie_padrao_amostra),'PM')
into STRICT	ie_padrao_amostra_w
from 	lab_parametro
where	cd_estabelecimento = cd_estabelecimento_w;

if (position(';' in ie_opcao_p) > 0) then
	ie_opcao_w		:= substr(ie_opcao_p, 1, position(';' in ie_opcao_p) - 1);
	ie_status_atend_w	:= substr(ie_opcao_p, position(';' in ie_opcao_p) + 1, 2);
	ds_aux_w		:= replace(ie_opcao_p, ie_opcao_w || ';' || ie_status_atend_w,'');
	ds_aux_w		:= substr(ds_aux_w, 2, 255);
	ds_material_especial_w  := substr(ds_aux_w, 1, position(';' in ds_aux_w) - 1);
	if (position(';' in ds_aux_w) = 0) then
		ds_material_especial_w := ds_aux_w;
	else
		nr_seq_amostra_w	:= substr(ds_aux_w, position(';' in ds_aux_w) + 1, 255);
	end if;
end if;

ie_status_atend_w := coalesce(ie_status_envio_p,ie_status_atend_w);


if (coalesce(ds_material_especial_w::text, '') = '') then
	ds_material_especial_w := 'X';
end if;

OPEN C01;
LOOP
FETCH C01 into	cd_procedimento_w,
			nr_seq_exame_w,
			cd_exame_w,
			cd_exame_integracao_w,
			nr_sequencia_w,
			nm_exame_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (ie_opcao_w = 'CP') then
		Resultado_w	:= Resultado_w || cd_procedimento_w || ie_separador_p;
	elsif (ie_opcao_w = 'EX') then
		Resultado_w	:= Resultado_w || nr_seq_exame_w || ie_separador_p;
	elsif (ie_opcao_w = 'CE') then
		Resultado_w	:= Resultado_w || cd_exame_w || ie_separador_p;
	elsif (ie_opcao_w = 'CI') then
		Resultado_w	:= Resultado_w || cd_exame_integracao_w || ie_separador_p;
	elsif (ie_opcao_w = 'CI3') then
		Resultado_w	:= Resultado_w || substr(cd_exame_integracao_w || '   ',1,3) || ie_separador_p;
	elsif (ie_opcao_w = 'CI8') then

		select	Obter_Equip_Exame_online(nr_seq_exame,null,ds_sigla_p,ie_tipo_atendimento_p,cd_estabelecimento_w)
		into STRICT	cd_exame_integracao_w
		from	exame_laboratorio
		where nr_seq_exame = nr_seq_exame_w;

		select	max(nr_amostra)
		into STRICT	nr_amostra_w
		from	prescr_proc_material a
		where	a.nr_sequencia = nr_seq_amostra_item_p;

		select 	max(cd_exame_integracao)
		into STRICT	cd_exame_filho_w
		from	exame_laboratorio
		where	nr_seq_superior = nr_seq_exame_w
		and	nr_ordem_amostra = nr_amostra_w;

		if (cd_exame_filho_w IS NOT NULL AND cd_exame_filho_w::text <> '') then
			resultado_w	:= resultado_w || substr(cd_exame_integracao_w || '_' || nr_amostra_w || '        ',1,8) || ie_separador_p;
		elsif (nr_amostra_w > 1) then
			resultado_w	:= resultado_w || substr(cd_exame_integracao_w || '_' || nr_amostra_w || '        ',1,8) || ie_separador_p;
		else
			resultado_w	:= resultado_w || substr(cd_exame_integracao_w || '        ',1,8) || ie_separador_p;
		end if;
	elsif (ie_opcao_w = 'CI9') then

		select	Obter_Equip_Exame_online_bco(nr_seq_exame,null,ds_sigla_p,ie_tipo_atendimento_p,cd_estabelecimento_w)
		into STRICT	cd_exame_integracao_w
		from	exame_laboratorio
		where nr_seq_exame = nr_seq_exame_w;

		select	max(nr_amostra)
		into STRICT	nr_amostra_w
		from	prescr_proc_material a
		where	a.nr_sequencia = nr_seq_amostra_item_p;

		select 	max(cd_exame_integracao)
		into STRICT	cd_exame_filho_w
		from	exame_laboratorio
		where	nr_seq_superior = nr_seq_exame_w
		and	nr_ordem_amostra = nr_amostra_w;

		if (cd_exame_filho_w IS NOT NULL AND cd_exame_filho_w::text <> '') then
			resultado_w	:= resultado_w || substr(cd_exame_integracao_w || '_' || nr_amostra_w || '        ',1,8) || ie_separador_p;
		elsif (nr_amostra_w > 1) then
			resultado_w	:= resultado_w || substr(cd_exame_integracao_w || '_' || nr_amostra_w || '        ',1,8) || ie_separador_p;
		else
			resultado_w	:= resultado_w || substr(cd_exame_integracao_w || '        ',1,8) || ie_separador_p;
		end if;

	elsif (ie_opcao_w = 'NME3') then
		Resultado_w	:= Resultado_w || substr(nm_exame_w || '   ',1,3) || ie_separador_p;
	elsif (ie_opcao_w = 'CE8') then
		Resultado_w	:= Resultado_w || substr(cd_exame_w || '        ',1,8) || ie_separador_p;
	end if;

	end;
END LOOP;

RETURN trim(both resultado_w || ' ');

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_exames_lab_integr_online ( nr_prescricao_p bigint, cd_setor_atendimento_p bigint, cd_material_p text, nr_seq_grupo_p bigint, ie_equipamento_p text, ie_opcao_p text, ie_separador_p text, nr_seq_grupo_imp_p bigint, nr_seq_lab_p text, ie_status_envio_p bigint, ds_sigla_p text, nr_seq_apresent_p bigint, nr_seq_lote_externo_p bigint, ie_tipo_atendimento_p bigint, nr_seq_amostra_item_p bigint) FROM PUBLIC;

