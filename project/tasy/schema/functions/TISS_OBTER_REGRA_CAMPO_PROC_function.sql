-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tiss_obter_regra_campo_proc ( vl_campo_p text, ie_campo_p text, cd_convenio_p text, cd_estabelecimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_material_p bigint, cd_categoria_p text, cd_plano_convenio_p text, ie_tipo_atendimento_p bigint, ie_carater_internacao_tiss_p text default null, ie_tiss_tipo_guia_p text default null) RETURNS varchar AS $body$
DECLARE


ie_envio_w		varchar(255);
ds_padrao_w		varchar(4000);
ds_retorno_w		varchar(255);
cd_grupo_proc_w		bigint;
cd_area_procedimento_w	bigint;
cd_especialidade_w	bigint;
cd_grupo_material_w	bigint;
cd_subgrupo_material_w	bigint;
cd_classe_material_w	bigint;
vl_adicional_w		varchar(10);
qt_regra_w		bigint;
qt_duracao_minuto_w	tiss_regra_campo_proc.QT_DURACAO_MINUTO%type;
vl_campo_w		varchar(255);
vl_campo_data_w		timestamp;
ie_tiss_tipo_guia_w	varchar(5);

c01 CURSOR FOR
SELECT	coalesce(a.ie_envio, 'E'),
	a.ds_padrao,
	a.cd_adicional,
	coalesce(a.qt_duracao_minuto,0)
from	tiss_regra_campo_proc a
where	a.ie_campo									= ie_campo_p
and	a.cd_convenio									= cd_convenio_p
and	a.cd_estabelecimento								= cd_estabelecimento_p
and	coalesce(cd_procedimento, 		coalesce(cd_procedimento_p,0))			= coalesce(cd_procedimento_p,0)
and	coalesce(a.cd_categoria, 		coalesce(cd_categoria_p,0))				= coalesce(cd_categoria_p,0)
and	(
	(ie_origem_proced								= ie_origem_proced_p)	
	or (coalesce(ie_origem_proced::text, '') = '')
	or (coalesce(cd_procedimento_p::text, '') = '') 
	or (coalesce(cd_procedimento::text, '') = '')
	)
and	coalesce(cd_area_procedimento, 	coalesce(cd_area_procedimento_w,0)) 			= coalesce(cd_area_procedimento_w,0)
and	coalesce(cd_especialidade, 		coalesce(cd_especialidade_w,0))			= coalesce(cd_especialidade_w,0)
and	coalesce(cd_grupo_proc, 		coalesce(cd_grupo_proc_w,0))				= coalesce(cd_grupo_proc_w,0)
and	coalesce(cd_material, 		coalesce(cd_material_p,0))				= coalesce(cd_material_p,0)
and	coalesce(cd_grupo_material, 		coalesce(cd_grupo_material_w,0))			= coalesce(cd_grupo_material_w,0)
and	coalesce(cd_subgrupo_material, 	coalesce(cd_subgrupo_material_w,0)) 			= coalesce(cd_subgrupo_material_w,0)
and	coalesce(cd_classe_material, 	coalesce(cd_classe_material_w,0))			= coalesce(cd_classe_material_w,0)
and	coalesce(cd_plano_convenio, 		coalesce(cd_plano_convenio_p,'X'))			= coalesce(cd_plano_convenio_p,'X')
and	coalesce(a.ie_tipo_atendimento,	coalesce(ie_tipo_atendimento_p,0))			= coalesce(ie_tipo_atendimento_p,0)
and	coalesce(a.ie_carater_int_tiss,	coalesce(ie_carater_internacao_tiss_p,'0')) 		= coalesce(ie_carater_internacao_tiss_p,'0')
and	coalesce(a.ie_tiss_tipo_guia, 	ie_tiss_tipo_guia_w)				= ie_tiss_tipo_guia_w
order by coalesce(cd_procedimento, 0),
	 coalesce(cd_grupo_proc, 0),
	 coalesce(cd_especialidade,0),
	 coalesce(cd_area_procedimento, 0),
	 coalesce(cd_material,0),
	 coalesce(cd_grupo_material,0),
	 coalesce(cd_subgrupo_material,0),
	 coalesce(cd_classe_material,0),
	 coalesce(cd_plano_convenio,'X'),
	 coalesce(ie_tipo_atendimento,0),
	 coalesce(a.ie_carater_int_tiss,'A');


BEGIN
ie_tiss_tipo_guia_w := coalesce(ie_tiss_tipo_guia_p, 'X');
vl_campo_w := vl_campo_p;
begin
select	1
into STRICT	qt_regra_w
from	tiss_regra_campo_proc a
where	a.ie_campo		= ie_campo_p
and	a.cd_convenio		= cd_convenio_p
and	a.cd_estabelecimento	= cd_estabelecimento_p  LIMIT 1;
exception
when others then
	qt_regra_w	:= 0;
end;

if (qt_regra_w > 0) then

	select	max(a.cd_grupo_proc),
		max(substr(OBTER_AREA_PROCEDIMENTO(cd_procedimento_p, ie_origem_proced_p),1,200)),
		max(substr(OBTER_ESPECIALIDADE_PROCED(cd_procedimento_p, ie_origem_proced_p),1,200))
	into STRICT	cd_grupo_proc_w,
		cd_area_procedimento_w,
		cd_especialidade_w
	from	procedimento a
	where	cd_procedimento	= cd_procedimento_p
	and	ie_origem_proced	= ie_origem_proced_p;

	select 	max(b.cd_grupo_material),
		max(b.cd_subgrupo_material),
		max(b.cd_classe_material)
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w
	from	estrutura_material_v b,
		material a
	where 	a.cd_material		= b.cd_material
	and	a.cd_material		= cd_material_p;

	open c01;
	loop
	fetch c01 into
		ie_envio_w,
		ds_padrao_w,
		vl_adicional_w,
		qt_duracao_minuto_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	end loop;
	close c01;
	
end if;	


if	ie_campo_p = '9'  	and
	(vl_campo_w IS NOT NULL AND vl_campo_w::text <> '')  and
	qt_duracao_minuto_w > 0 then	
	
	vl_campo_data_w := (to_date(vl_campo_w,'dd/mm/yyyy hh24:mi:ss') + (qt_duracao_minuto_w * 60) / (24 * 60 * 60));
	
	vl_campo_w := to_char(vl_campo_data_w,'dd/mm/yyyy hh24:mi:ss');
	
	if (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(to_date(vl_campo_p,'dd/mm/yyyy hh24:mi:ss')) < ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(vl_campo_data_w)) then
		vl_campo_w := to_char(ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(to_date(vl_campo_p,'dd/mm/yyyy hh24:mi:ss')),'dd/mm/yyyy hh24:mi:ss');
	end if;
	
end if;

if (coalesce(ie_envio_w,'E') = 'E')  then
	ds_retorno_w		:= vl_adicional_w || vl_campo_w;
elsif (coalesce(ie_envio_w,'E') = 'T')  then
	ds_retorno_w		:= vl_adicional_w || ds_padrao_w;
elsif (coalesce(ie_envio_w,'E') = 'DP') and (ds_padrao_w <> vl_campo_w) then
	ds_retorno_w		:= vl_adicional_w || vl_campo_w;
else
	ds_retorno_w	:= null;
	
	/*
		De acordo com o componente de comunicacao TISS disponibilizado pela ANS, alguns campos sao enviados obrigatoriamente.
		A maioria desses campos sao condicionais nas guias de SPSADT, mas obrigatorios nas guias de RI, Honorario, etc.
		
		Essa situacao foi identificada na ordem de servico 2204117, onde o campo 'taxa de reducao ou acrescimo' estava gerando vazio, pois esta rotina retornava
		'null' para a TISS_GERAR_CONTA_PROC, populando o atributo como nulo na tabela, porem, o Gerenciador de XML gera esse campo obrigatoriamente - correto de acordo com o componente de comunicacao.
		
		Dessa forma, para evitar utilizacao de NVL's no Gerenciador de XML, efetuamos o tratamento nos casos onde um campo eh obrigatorio, mas existe regra para nao enviar.
		Ao depararmos com um campo obrigatorio, efetuamos NVL do parametro vl_campo_p. Caso esse possua valor, sera o valor retornado. 
		Do contrario, retornamos o valor padrao estipulado pela ANS.
				
		Os campos identificados como obrigatorios (na data de 26/Out/2020) sao:
		
		|----------------------------------------------|
		|CAMPO 				- PADRAO       |
		|----------------------------------------------|
		|Codigo do procedimento 	- N/A  	       |
		|Quantidade do procedimento 	- N/A	       |
		|Fator de reducao ou acrescimo 	- 1	       |
		|----------------------------------------------|
		
		Os codigos utilizados nas verificacoes abaixo surgem a partir do dominio 2372 (TISS - Campos do procedimento).
	*/

	
	-- Fator de reducao ou acrescimo. Obrigatorio para todas guias fora SPSADT.
	if 	ie_tiss_tipo_guia_w <> '4' and ie_campo_p = '1' then
		ds_retorno_w	:=	coalesce(vl_campo_p, '1');		
	end if;
	
	-- Codigo do procedimento / quantidade do procedimento
	if	ie_tiss_tipo_guia_w <> '4' and ie_campo_p in ('3', '2') then
		ds_retorno_w	:= 	vl_campo_p;
	end if;
	
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_obter_regra_campo_proc ( vl_campo_p text, ie_campo_p text, cd_convenio_p text, cd_estabelecimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_material_p bigint, cd_categoria_p text, cd_plano_convenio_p text, ie_tipo_atendimento_p bigint, ie_carater_internacao_tiss_p text default null, ie_tiss_tipo_guia_p text default null) FROM PUBLIC;

