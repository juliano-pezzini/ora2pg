-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION oft_obter_exames_externos ( nr_seq_consulta_p bigint) RETURNS varchar AS $body$
DECLARE


ds_exame_w		varchar(255);
ds_exame_sem_cad_w	varchar(255);
ds_procedimento_w	varchar(255);
ds_retorno_w		varchar(2000) := null;

c01 CURSOR FOR
	SELECT	substr(obter_med_exame_externo(b.nr_sequencia),1,255) ds_exame
	from   	pedido_exame_externo a,
		pedido_exame_externo_item b
	where  	a.nr_sequencia			= b.nr_seq_pedido
	and	a.nr_seq_consulta		= nr_seq_consulta_p
	and	coalesce(a.ie_situacao,'A')		= 'A'
	order by 1;


BEGIN

open c01;
loop
fetch c01 into
	ds_exame_w;
	--ds_exame_sem_cad_w,
	--ds_procedimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (coalesce(ds_retorno_w::text, '') = '') then
		ds_retorno_w	:= substr(ds_exame_w,1,2000);
	else
		ds_retorno_w	:= substr(ds_retorno_w || ' ; ' || ds_exame_w,1,2000);
	end if;
	/*
	if	(ds_exame_w is not null) then
		if	(ds_retorno_w is null) then
			ds_retorno_w	:= substr(ds_exame_w ||';',1,2000);
		else
			ds_retorno_w	:= substr(ds_retorno_w ||';'|| ds_exame_w ||';',1,2000);
		end if;
	end if;

	if	(ds_exame_sem_cad_w is not null) then
		if	(ds_retorno_w is null) then
			ds_retorno_w	:= substr(ds_exame_sem_cad_w ||';',1,2000);
		else
			ds_retorno_w	:= substr(ds_retorno_w ||';'|| ds_exame_sem_cad_w ||';',1,2000);
		end if;
	end if;
	if	(ds_procedimento_w is not null) then
		if	(ds_retorno_w is null) then
			ds_retorno_w	:= substr(ds_procedimento_w ||';',1,2000);
		else
			ds_retorno_w	:= substr(ds_retorno_w ||';'|| ds_procedimento_w ||';',1,2000);
		end if;
	end if;
	*/
	end;
end loop;
close c01;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION oft_obter_exames_externos ( nr_seq_consulta_p bigint) FROM PUBLIC;

