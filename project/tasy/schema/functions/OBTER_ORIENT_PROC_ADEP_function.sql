-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_orient_proc_adep ( nr_atendimento_p bigint, nr_prescricoes_p text, cd_procedimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
nr_seq_proc_interno_w	bigint;
ds_orientacao_w		varchar(4000);
nr_prescricao_w		bigint;
nr_seq_proced_w		integer;
nr_seq_orientacao_w	bigint;


BEGIN 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') and (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') then 
	begin 
	nr_prescricao_w	:= obter_max_prescr_adep(nr_prescricoes_p);
	 
	if (nr_prescricao_w > 0) then 
		begin 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_proced_w 
		from	prescr_procedimento 
		where	nr_prescricao = nr_prescricao_w 
		and	cd_procedimento = cd_procedimento_p;
	 
		/* Estava dando erro: "a extração exata retorna mais do que o número solicitado de linhas" 
		select	b.cd_procedimento, 
			b.ie_origem_proced, 
			b.nr_seq_proc_interno 
		into	cd_procedimento_w, 
			ie_origem_proced_w, 
			nr_seq_proc_interno_w 
		from	prescr_procedimento b, 
			prescr_medica a 
		where	b.nr_prescricao		= a.nr_prescricao 
		and	a.nr_atendimento	= nr_atendimento_p 
		and	obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S' 
		and	b.cd_procedimento	= cd_procedimento_p 
		and	a.nr_prescricao		= ( 
							select	max(x.nr_prescricao) 
							from	prescr_medica x 
							where	obter_se_contido(x.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S' 
							);*/
	 
		select	cd_procedimento, 
			ie_origem_proced, 
			nr_seq_proc_interno 
		into STRICT	cd_procedimento_w, 
			ie_origem_proced_w, 
			nr_seq_proc_interno_w 
		from	prescr_procedimento 
		where	nr_prescricao = nr_prescricao_w 
		and	nr_sequencia = nr_seq_proced_w;
 
		/* obter orientacao */
 
		select	obter_orientacao_proc(cd_procedimento_w, ie_origem_proced_w, obter_convenio_atendimento(nr_atendimento_p), nr_seq_proc_interno_w, nr_atendimento_p, 0) 
		into STRICT	ds_orientacao_w 
		;
		 
		end;
	end if;
	end;
end if;
return ds_orientacao_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_orient_proc_adep ( nr_atendimento_p bigint, nr_prescricoes_p text, cd_procedimento_p bigint) FROM PUBLIC;

