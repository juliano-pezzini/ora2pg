-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_target_time ( nr_seq_indicator_p bigint, vl_indicator_minutes_p bigint, ie_convert_p text default 'S') RETURNS varchar AS $body$
DECLARE


ie_target_time_w	varchar(255);
ie_rule_w		varchar(1);
qt_initial_target_w	pfcs_indicator_target.qt_initial_target%type;
qt_final_target_w	pfcs_indicator_target.qt_final_target%type;
qt_hours_w		double precision;


BEGIN

if (ie_convert_p = 'S') then
    qt_hours_w	:= vl_indicator_minutes_p / 60;
else
    qt_hours_w	:= vl_indicator_minutes_p;
end if;

select	coalesce(max('S'),'N')
into STRICT	ie_rule_w
from	pfcs_indicator_target a,
      pfcs_indicator_rule b
where	a.nr_seq_rule = b.nr_sequencia
  and b.nr_seq_indicator	= nr_seq_indicator_p;

if (ie_rule_w = 'S') then
	select	max(a.qt_initial_target) qt_initial_target,
		max(a.qt_final_target) qt_final_target
	into STRICT	qt_initial_target_w,
		qt_final_target_w
	from	pfcs_indicator_target a,
        pfcs_indicator_rule b
	where	a.nr_seq_rule = b.nr_sequencia
    and b.nr_seq_indicator	= nr_seq_indicator_p;
else
	select	max(a.qt_initial_target) qt_initial_target,
		max(a.qt_final_target) qt_final_target
	into STRICT	qt_initial_target_w,
		qt_final_target_w
	from	pfcs_indicator_target_def a
	where	a.nr_seq_indicator	= nr_seq_indicator_p;
end if;
	
if (qt_hours_w < qt_initial_target_w) then
	ie_target_time_w	:= 'L'; /* Low - Green */
elsif (qt_hours_w >= qt_initial_target_w) and (qt_hours_w <= qt_final_target_w) then
	ie_target_time_w	:= 'M'; /* Medium - Yellow */
elsif (qt_hours_w > qt_final_target_w) then
	ie_target_time_w	:= 'H'; /* High - Red */
else
	ie_target_time_w	:= '';
end if;

return	ie_target_time_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_target_time ( nr_seq_indicator_p bigint, vl_indicator_minutes_p bigint, ie_convert_p text default 'S') FROM PUBLIC;

