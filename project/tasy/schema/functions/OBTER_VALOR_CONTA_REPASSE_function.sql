-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_conta_repasse (nr_repasse_terceiro_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

vl_mat_w	double precision;
vl_proc_w	double precision;
vl_proc_med_w	double precision;
vl_proc_mat_w 	double precision;
vl_proc_adic_w	double precision;

/* Opção
P - valor do procedimento na conta
ME - Valor do medico do procedimento
M - valor do material na conta
PM - Soma do material e do procedimento
*/
BEGIN

SELECT coalesce(SUM(a.vl_material),0)
into STRICT   vl_mat_w
FROM 	material_atend_paciente a
WHERE 	a.nr_sequencia IN (SELECT b.nr_seq_material
			     FROM 	material_repasse b
			     WHERE 	b.nr_repasse_terceiro = nr_repasse_terceiro_p);

SELECT 	coalesce(SUM(a.vl_procedimento),0),
	coalesce(SUM(a.vl_medico),0)
into STRICT  	vl_proc_w,
	vl_proc_med_w
FROM 	procedimento_paciente a
WHERE 	a.nr_sequencia IN (SELECT b.nr_seq_procedimento
		  	     FROM 	procedimento_repasse b
			     WHERE 	b.nr_repasse_terceiro = nr_repasse_terceiro_p);

select 	coalesce(sum(a.vl_participante),0)
into STRICT	vl_proc_adic_w
from 	procedimento_participante a,
	procedimento_paciente	c
where 	a.nr_seq_partic in (SELECT  b.nr_seq_partic
                           from  procedimento_repasse b
                           where  b.nr_repasse_terceiro = nr_repasse_terceiro_p)
and 	c.nr_sequencia IN (SELECT 	b.nr_seq_procedimento
			  FROM 	procedimento_repasse b
             	          WHERE 	b.nr_repasse_terceiro = nr_repasse_terceiro_p)
and	a.NR_SEQUENCIA	= c.nr_sequencia;


if (ie_opcao_p	= 'M') then
	vl_proc_mat_w := vl_mat_w;
elsif (ie_opcao_p	= 'P') then
	vl_proc_mat_w := vl_proc_w;
elsif (ie_opcao_p	= 'ME') then
	vl_proc_mat_W := vl_proc_med_w + vl_proc_adic_w;
elsif (ie_opcao_p	= 'PM') then
	vl_proc_mat_w := vl_mat_w + vl_proc_w;

end if;
RETURN vl_proc_mat_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_conta_repasse (nr_repasse_terceiro_p bigint, ie_opcao_p text) FROM PUBLIC;

