-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_se_recurso_alocado ( nm_recurso_p text, dt_referencia_p text, ie_opcao_p text, nr_seq_proj_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(255);
ds_projeto_w	varchar(255);
cd_recurso_w	varchar(10);
ie_consiste_w	varchar(1);
qt_horas_dia_w	double precision;
dt_referencia_w	timestamp;


BEGIN
dt_referencia_w := to_date(dt_referencia_p,'dd/mm/yyyy');
	select	coalesce(max(a.cd_pessoa_fisica), 0)
	into STRICT	cd_recurso_w
	from	usuario a
	where	a.nm_usuario = nm_recurso_p;

	select		CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END ,
			substr((d.nr_sequencia || ' - ' ||d.ds_titulo),1,255)
	into STRICT		ie_consiste_w,
			ds_projeto_w
	from		proj_cron_etapa_equipe a,
			proj_cron_etapa b,
			proj_cronograma c,
			proj_projeto d
	where		b.nr_sequencia = a.nr_seq_etapa_cron
	and		c.nr_sequencia = b.nr_seq_cronograma
	and		d.nr_sequencia = c.nr_seq_proj
	and		d.nr_seq_estagio = 12
	and		trunc(b.dt_inicio_prev) = trunc(dt_referencia_w)
	and		b.pr_etapa < 100
	and		a.cd_programador = cd_recurso_w
	and		d.nr_sequencia <> nr_seq_proj_p
	group by	d.nr_sequencia,d.ds_titulo;

if (ie_opcao_p = 'P') then
	ds_retorno_w := ds_projeto_w;
elsif (ie_opcao_p = 'A') then

	if (ie_consiste_w = 'S') then
		begin

		select		sum(b.qt_hora_prev)
		into STRICT		qt_horas_dia_w
		from		proj_cron_etapa_equipe a,
				proj_cron_etapa b,
				proj_cronograma c,
				proj_projeto d
		where		b.nr_sequencia = a.nr_seq_etapa_cron
		and		c.nr_sequencia = b.nr_seq_cronograma
		and		d.nr_sequencia = c.nr_seq_proj
		and		d.nr_seq_estagio = 12
		and		trunc(b.dt_inicio_prev) = trunc(dt_referencia_w)
		and		b.pr_etapa < 100
		and		a.cd_programador = cd_recurso_w
		and		d.nr_sequencia <> nr_seq_proj_p;

		if (qt_horas_dia_w < 4) then
			begin
			ie_consiste_w := 'N';
			end;
		end if;

		end;
	end if;

	ds_retorno_w := ie_consiste_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_se_recurso_alocado ( nm_recurso_p text, dt_referencia_p text, ie_opcao_p text, nr_seq_proj_p bigint) FROM PUBLIC;

