-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hmc_obter_valor_relatorio ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) RETURNS bigint AS $body$
DECLARE

nr_registros_w bigint;


BEGIN 
 
select coalesce(count(a.nr_sequencia),0) 
into STRICT nr_registros_w 
from 
(	 
	SELECT a.nr_sequencia 
	FROM 	prescr_material a, 
			prescr_medica b 
	WHERE 	a.nr_prescricao = b.nr_prescricao 
	AND b.nr_atendimento=nr_atendimento_p 
	AND((b.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (b.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
	AND	a.ie_agrupador = 12 

UNION
 
	SELECT	a.nr_sequencia 
	FROM	rep_jejum a, 
		prescr_medica b 
	WHERE	b.nr_prescricao=a.nr_prescricao 
	AND b.nr_atendimento=nr_atendimento_p 
	AND((b.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (b.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 

UNION
 
	SELECT a.nr_sequencia 
	FROM 	DIETA B, 
		PRESCR_DIETA A, 
		prescr_medica c 
	WHERE	A.CD_DIETA 	= B.CD_DIETA 
	AND	A.nr_prescricao	= c.nr_prescricao 
	AND c.nr_atendimento=nr_atendimento_p 
	AND((c.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (c.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 

UNION
 
	SELECT	A.nr_sequencia 
	FROM 	PRESCR_MATERIAL A, 
		prescr_medica b 
	WHERE 	A.nr_prescricao	= b.nr_prescricao 
	AND b.nr_atendimento=nr_atendimento_p 
	AND((b.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (b.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
	AND	A.IE_AGRUPADOR		= 8 

UNION
 
	select	a.nr_sequencia  
	from  nut_pac_elem_mat c, 
		nut_elemento x, 
		nut_pac_elemento b, 
		nut_pac a, 
		prescr_medica d 
	where	A.nr_prescricao	= d.nr_prescricao 
	AND d.nr_atendimento=nr_atendimento_p 
	AND((d.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (d.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
	and	a.nr_sequencia	= b.nr_seq_nut_pac 
	and	b.nr_seq_elemento= x.nr_sequencia 
	and	b.nr_sequencia	= c.nr_seq_pac_elem 
	and	c.qt_vol_cor 	> 0 
	and	coalesce(a.ie_npt_adulta,'N') <> 'S' 

UNION
 
	select	a.nr_sequencia 
	from	nut_pac a,prescr_medica b 
	where	A.nr_prescricao	= b.nr_prescricao 
	AND b.nr_atendimento=nr_atendimento_p 
	AND((b.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (b.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
	and	coalesce(a.ie_npt_adulta,'N') = 'S' 

union
 
	select	a.nr_sequencia 
	from	nut_paciente a,prescr_medica b 
	where	A.nr_prescricao	= b.nr_prescricao 
	AND b.nr_atendimento=nr_atendimento_p 
	AND((b.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (b.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 

union
 
	SELECT	a.nr_sequencia 
	FROM MATERIAL B, 
	   PRESCR_MATERIAL A, 
	   prescr_medica c 
	WHERE A.CD_MATERIAL=B.CD_MATERIAL 
	AND c.nr_prescricao=a.nr_prescricao 
	AND c.nr_atendimento=nr_atendimento_p 
	AND	((c.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (c.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
	AND coalesce(A.NR_SEQUENCIA_SOLUCAO::text, '') = '' 
	AND coalesce(A.NR_SEQUENCIA_PROC::text, '') = '' 
	AND coalesce(A.NR_SEQUENCIA_DILUICAO::text, '') = '' 
	AND coalesce(A.NR_SEQUENCIA_DIETA::text, '') = '' 
	AND	A.IE_AGRUPADOR=1 
	AND	coalesce(a.cd_kit_material::text, '') = '' 
	AND	coalesce(A.IE_ADMINISTRAR,'S')='S' AND a.qt_dose > 50 

UNION
 
	SELECT	a.nr_sequencia 
	FROM MATERIAL B, 
	   PRESCR_MATERIAL A, 
	   prescr_medica c 
	WHERE A.CD_MATERIAL=B.CD_MATERIAL 
	AND c.nr_prescricao=a.nr_prescricao 
	AND c.nr_atendimento=nr_atendimento_p 
	AND((c.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (c.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
	AND coalesce(A.NR_SEQUENCIA_SOLUCAO::text, '') = '' 
	AND coalesce(A.NR_SEQUENCIA_PROC::text, '') = '' 
	AND coalesce(A.NR_SEQUENCIA_DILUICAO::text, '') = '' 
	AND coalesce(A.NR_SEQUENCIA_DIETA::text, '') = '' 
	AND	A.IE_AGRUPADOR=1 
	AND	coalesce(a.cd_kit_material::text, '') = '' 
	AND	a.qt_dose <= 50 
	and	coalesce(A.IE_ADMINISTRAR,'S') = 'S' 

union
 
	select 	A.NR_SEQ_SOLUCAO 
	from 	PRESCR_SOLUCAO A, 
		prescr_medica b 
	where	A.nr_prescricao	= b.nr_prescricao 
	AND b.nr_atendimento=nr_atendimento_p 
	AND((b.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (b.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
	and	a.ie_esquema_alternado <> 'S' 

union
 
	SELECT A.NR_SEQ_SOLUCAO 
	FROM 	PRESCR_SOLUCAO A, 
		PRESCR_MEDICA b 
	WHERE	 A.nr_prescricao = b.nr_prescricao 
	AND b.nr_atendimento=nr_atendimento_p 
	AND((b.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (b.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
	and	a.ie_esquema_alternado = 'S' 

union
 
	select 	a.nr_sequencia 
	FROM prescr_medica c, procedimento b, prescr_procedimento a
LEFT OUTER JOIN intervalo_prescricao i ON (a.cd_intervalo = i.cd_intervalo)
WHERE a.cd_procedimento = b.cd_procedimento and a.ie_origem_proced = b.ie_origem_proced  and A.nr_prescricao	= c.nr_prescricao AND c.nr_atendimento=nr_atendimento_p AND ((c.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (c.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) and obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'O') = 'S' and coalesce(a.nr_seq_solic_sangue::text, '') = '' and coalesce(a.nr_seq_origem::text, '') = '' and coalesce(a.nr_seq_prescr_mat::text, '') = '' and coalesce(a.nr_seq_prescr_sol::text, '') = '' 
 
union
 
	SELECT a.nr_sequencia 
	FROM	prescr_gasoterapia a, 
		prescr_medica b 
	WHERE	A.nr_prescricao	= b.nr_prescricao 
	AND b.nr_atendimento=nr_atendimento_p 
	AND((b.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (b.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 

union
	 
	SELECT 	a.NR_SEQUENCIA 
	FROM 	PRESCR_RECOMENDACAO a , prescr_medica b 
	WHERE 	A.nr_prescricao	= b.nr_prescricao 
	AND b.nr_atendimento=nr_atendimento_p 
	AND((b.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (b.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 

UNION
 
	SELECT	DISTINCT 1 
	FROM	prescr_leite_deriv a,prescr_medica b 
	WHERE	A.nr_prescricao	= b.nr_prescricao 
	AND b.nr_atendimento=nr_atendimento_p 
	AND((b.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (b.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
	AND	EXISTS (SELECT	1 
			FROM 	prescr_material x, 
				prescr_leite_deriv y,prescr_medica b 
			WHERE  	x.nr_seq_leite_deriv = y.nr_sequencia 
			AND   	x.nr_prescricao	= b.nr_prescricao 
			AND b.nr_atendimento=nr_atendimento_p 
			AND((b.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
			OR (b.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
			AND 	x.ie_agrupador IN (16,17)) 

UNIOn
 
	SELECT b.nr_sequencia 
	from 	prescr_material a, 
		prescr_leite_deriv b,prescr_medica c 
	where  	a.nr_seq_leite_deriv = b.nr_sequencia 
	and   	A.nr_prescricao	= c.nr_prescricao 
	AND c.nr_atendimento=nr_atendimento_p 
	AND((c.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (c.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
	and 	a.ie_agrupador in (16,17) 

UNION
 
	SELECT a.nr_sequencia 
	from 	MATERIAL B, 
		PRESCR_MATERIAL A,prescr_medica c 
	where 	A.CD_MATERIAL  		= B.CD_MATERIAL 
	and 	A.nr_prescricao	= c.nr_prescricao 
	AND c.nr_atendimento=nr_atendimento_p 
	AND((c.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (c.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 
	and 	coalesce(A.NR_SEQUENCIA_SOLUCAO::text, '') = '' 
	and 	coalesce(A.NR_SEQUENCIA_PROC::text, '') = '' 
	and 	coalesce(A.NR_SEQUENCIA_DILUICAO::text, '') = '' 
	and 	coalesce(A.NR_SEQUENCIA_DIETA::text, '') = '' 
	and	coalesce(A.NR_SEQ_PE_PROC::text, '') = '' 
	and  	coalesce(a.nr_seq_kit::text, '') = '' 
	and	A.IE_AGRUPADOR			= 2 
	and	coalesce(A.IE_ADMINISTRAR,'S')		= 'S' 

UNION
 
	SELECT a.nr_sequencia 
	from	pe_prescr_proc b, 
	pe_prescricao a,prescr_medica c 
	where	b.nr_seq_prescr 	= a.nr_sequencia 
	and	A.nr_prescricao	= c.nr_prescricao 
	AND c.nr_atendimento=nr_atendimento_p 
	AND((c.dt_inicio_prescr BETWEEN dt_inicio_p AND dt_fim_p) 
	OR (c.dt_validade_prescr BETWEEN dt_inicio_p AND dt_fim_p)) 

union
 
	select a.nr_sequencia 
	FROM prescr_medica c, procedimento b, prescr_procedimento a
LEFT OUTER JOIN intervalo_prescricao i ON (a.cd_intervalo = i.cd_intervalo)
WHERE a.cd_procedimento = b.cd_procedimento and a.ie_origem_proced = b.ie_origem_proced  and coalesce(a.nr_seq_origem::text, '') = '' and A.nr_prescricao	= c.nr_prescricao and Obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'BSST') <> 'S' and Obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'AT') <> 'S' and Obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'BS') <> 'S' and coalesce(a.nr_seq_prescr_mat::text, '') = '' and (a.nr_seq_solic_sangue IS NOT NULL AND a.nr_seq_solic_sangue::text <> '') and coalesce(a.nr_seq_prescr_sol::text, '') = '' 
 
union
 
	select a.nr_sequencia 
	FROM prescr_medica c, procedimento b, prescr_procedimento a
LEFT OUTER JOIN intervalo_prescricao i ON (a.cd_intervalo = i.cd_intervalo)
WHERE a.cd_procedimento = b.cd_procedimento and a.ie_origem_proced = b.ie_origem_proced  and A.nr_prescricao	= c.nr_prescricao and (a.nr_seq_solic_sangue IS NOT NULL AND a.nr_seq_solic_sangue::text <> '') and Obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'BSST') = 'S' and coalesce(a.nr_seq_origem::text, '') = '' and coalesce(a.nr_seq_prescr_mat::text, '') = '' and coalesce(a.nr_seq_prescr_sol::text, '') = '' 
 
union
 
	select a.nr_sequencia 
	FROM prescr_medica c, procedimento b, prescr_procedimento a
LEFT OUTER JOIN intervalo_prescricao i ON (a.cd_intervalo = i.cd_intervalo)
WHERE a.cd_procedimento = b.cd_procedimento and a.ie_origem_proced = b.ie_origem_proced and A.nr_prescricao	= c.nr_prescricao  and (a.nr_seq_solic_sangue IS NOT NULL AND a.nr_seq_solic_sangue::text <> '') and (Obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'AT') = 'S' or Obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'BS') = 'S') and coalesce(a.nr_seq_origem::text, '') = '' and coalesce(a.nr_seq_prescr_mat::text, '') = '' and coalesce(a.nr_seq_prescr_sol::text, '') = '' 
 
		 
 ) a;
 
 
return(nr_registros_w);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hmc_obter_valor_relatorio ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) FROM PUBLIC;

