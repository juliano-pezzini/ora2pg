-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tipo_rel_ordem_compra (nr_ordem_compra_p bigint, ie_tipo_ordem_p bigint, ie_pendente_p text) RETURNS bigint AS $body$
DECLARE

 
retorno_w bigint;


BEGIN 
case ie_tipo_ordem_p 
  when 0 then 
		select count(o.nr_ordem_compra) 
		into STRICT retorno_w 
		from ordem_compra o, 
			 ordem_compra_item i,  
			 ordem_compra_item_entrega e 
		where o.nr_ordem_compra  = i.nr_ordem_compra  
			and i.nr_ordem_compra    = e.nr_ordem_compra  
			and i.nr_item_oci      = e.nr_item_oci 
			and	coalesce(o.dt_baixa::text, '') = '' 
			and (ie_pendente_p = 'S' AND coalesce(e.dt_cancelamento::text, '') = '') 	 
			and nr_ordem_compra_p = o.nr_ordem_compra;
  when 1 then 
		select count(o.nr_ordem_compra) 
		into STRICT retorno_w 
		from ordem_compra o 
		where (o.dt_baixa IS NOT NULL AND o.dt_baixa::text <> '') 
			and nr_ordem_compra_p = o.nr_ordem_compra;
	when 2 then 
		retorno_w := 1;
  when 3 then 
		select count(o.nr_ordem_compra) 
		into STRICT retorno_w 
		from ordem_compra o, 
			 ordem_compra_item i,  
			 ordem_compra_item_entrega e 
		where o.nr_ordem_compra  = i.nr_ordem_compra  
			and i.nr_ordem_compra    = e.nr_ordem_compra  
			and i.nr_item_oci      = e.nr_item_oci 
			and trunc(e.dt_prevista_entrega, 'dd') < trunc(clock_timestamp(),'dd') 
			and coalesce(e.dt_real_entrega::text, '') = '' 
			and coalesce(o.dt_baixa::text, '') = '' 
			and nr_ordem_compra_p = o.nr_ordem_compra;
end case;
return retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tipo_rel_ordem_compra (nr_ordem_compra_p bigint, ie_tipo_ordem_p bigint, ie_pendente_p text) FROM PUBLIC;

