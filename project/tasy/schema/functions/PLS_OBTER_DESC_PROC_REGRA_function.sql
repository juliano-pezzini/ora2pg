-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_desc_proc_regra ( cd_procedimento_p bigint, ie_origem_proced_p bigint) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Obter a descrição do procedimento respeitando as regras de vigência cadastradas na função Procedimentos/ Procedimentos na OPS
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [X] Tasy (Delphi/Java) [X] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_procedimento_w		procedimento.cd_procedimento%TYPE;


BEGIN

if (coalesce(cd_procedimento_p::text, '') = '') then
	ds_procedimento_w := ' ';
else
	begin
	select	max(a.ds_procedimento)
	into STRICT	ds_procedimento_w
	from	procedimento a
	where	a.cd_procedimento 	= cd_procedimento_p
	and	a.ie_origem_proced 	= coalesce(ie_origem_proced_p,a.ie_origem_proced)
	and (exists (	SELECT 	1
				from 	pls_procedimento_vigencia c
				where 	c.cd_procedimento 	= a.cd_procedimento
				and 	c.ie_origem_proced 	= a.ie_origem_proced
				and (c.dt_inicio_vigencia 	<= clock_timestamp())
				and (c.dt_fim_vigencia 	>= clock_timestamp() or coalesce(c.dt_fim_vigencia::text, '') = ''))
	or 	not exists (	select 	1
				from 	pls_procedimento_vigencia c
				where 	c.cd_procedimento 	= a.cd_procedimento
				and 	c.ie_origem_proced 	= a.ie_origem_proced))  LIMIT 1;
	exception
		when others then
			ds_procedimento_w := '';
	end;
end if;
return ds_procedimento_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_desc_proc_regra ( cd_procedimento_p bigint, ie_origem_proced_p bigint) FROM PUBLIC;

