-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nivel_consultor (cd_empresa_p bigint, cd_consultor_p text, ie_opcao_p text, dt_inicio_rat_p timestamp default clock_timestamp()) RETURNS varchar AS $body$
DECLARE


/*
ie_opcao_p

N = Nivel
V = Valor
C = nr_Sequencia

'NA' = Nivel atual (baseado na data de avaliacao)
'NF' = Nivel final (baseado na maior data de avaliacao existente)
'NRA' = Sequencia do Nivel atual
'PN' = Proximo Nivel (baseado na data de avaliacao)
'VV' = Valor vigente (baseado no parametro inicio da RAT)

*/
ds_nivel_w		varchar(80);
vl_fixo_w			double precision;
vl_vigente_w			double precision;
nr_seq_nivel_w		bigint;
nr_sequencia_nivel_w	bigint;
nr_seq_nivel_atual_w	bigint;
nr_seq_prox_nivel_w	bigint;
ds_nivel_atual_w		varchar(80);
ds_prox_nivel_w		varchar(80);
dt_nivel_atual_w		timestamp;
dt_prox_nivel_w		timestamp;
nr_seq_nivel_final_w	bigint;
ds_nivel_final_w		varchar(80);
dt_nivel_final_w		timestamp;

C01 CURSOR FOR
	SELECT	a.nr_seq_nivel,
		a.vl_fixo,
		a.nr_sequencia
	from	proj_consultor_nivel a
	where	a.cd_empresa		= cd_empresa_p
	and	a.cd_consultor		= cd_consultor_p
	order by a.dt_atualizacao;

C02 CURSOR FOR /* Nivel atual */
	SELECT	a.nr_seq_nivel,
		dt_avaliacao
	from	proj_consultor_nivel a
	where	a.cd_empresa		= cd_empresa_p
	and	a.cd_consultor		= cd_consultor_p
	and	dt_avaliacao <= clock_timestamp()
	order by a.dt_atualizacao;

C03 CURSOR FOR /* Proximo nivel */
	SELECT	a.nr_seq_nivel,
		dt_avaliacao
	from	proj_consultor_nivel a
	where	a.cd_empresa		= cd_empresa_p
	and	a.cd_consultor		= cd_consultor_p
	and	dt_avaliacao > clock_timestamp()
	order by a.dt_atualizacao;

C04 CURSOR FOR /* Valor e Nivel Vigente */
	SELECT	a.nr_seq_nivel,
		dt_avaliacao,
        round((a.vl_fixo/180)::numeric,2)
	from	proj_consultor_nivel a
	where	a.cd_empresa		= cd_empresa_p
	and	a.cd_consultor		= cd_consultor_p
        and a.dt_avaliacao <= dt_inicio_rat_p
	order by a.dt_avaliacao;


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_nivel_w,
	vl_fixo_w,
	nr_sequencia_nivel_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	Obter_desc_expressao(cd_exp_nivel, ds_nivel) ds_nivel
	into STRICT	ds_nivel_w
	from	proj_nivel_consultor
	where	nr_sequencia	= nr_seq_nivel_w;

	end;
end loop;
close C01;

if (ie_opcao_p = 'N') then
	return	ds_nivel_w;
elsif (ie_opcao_p = 'V') then
	return	vl_fixo_w;
elsif (ie_opcao_p = 'C') then
	return nr_sequencia_nivel_w;
end if;

open C02;
loop
fetch C02 into
	nr_seq_nivel_atual_w,
	dt_nivel_atual_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	select	Obter_desc_expressao(cd_exp_nivel, ds_nivel) ds_nivel
	into STRICT	ds_nivel_atual_w
	from	proj_nivel_consultor
	where	nr_sequencia	= nr_seq_nivel_atual_w;

	end;
end loop;
close C02;

if (ie_opcao_p = 'NA') then
	return	ds_nivel_atual_w;
elsif (ie_opcao_p = 'DNA') then
	return	dt_nivel_atual_w;
elsif (ie_opcao_p = 'NRA') then
	return	nr_seq_nivel_atual_w;
end if;

open C03;
loop
fetch C03 into
	nr_seq_prox_nivel_w,
	dt_prox_nivel_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin

	select	Obter_desc_expressao(cd_exp_nivel, ds_nivel) ds_nivel
	into STRICT	ds_prox_nivel_w
	from	proj_nivel_consultor
	where	nr_sequencia	= nr_seq_prox_nivel_w;

	end;
end loop;
close C03;

if (ie_opcao_p = 'PN') then
	return	ds_prox_nivel_w;
end if;
if (ie_opcao_p = 'DPN') then
	return	dt_prox_nivel_w;
end if;

open C04;
loop
fetch C04 into
	nr_seq_nivel_final_w,
	dt_nivel_final_w,
        vl_vigente_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin

	select	Obter_desc_expressao(cd_exp_nivel, ds_nivel) ds_nivel
	into STRICT	ds_nivel_final_w
	from	proj_nivel_consultor
	where	nr_sequencia	= nr_seq_nivel_final_w;

	end;
end loop;
close C04;

if (ie_opcao_p = 'NF') then
	return	ds_nivel_final_w;
elsif (ie_opcao_p = 'DNF') then
	return	dt_nivel_final_w;
elsif (ie_opcao_p = 'NRF') then
	return	nr_seq_nivel_final_w;
elsif (ie_opcao_p = 'VV') then
	return	vl_vigente_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nivel_consultor (cd_empresa_p bigint, cd_consultor_p text, ie_opcao_p text, dt_inicio_rat_p timestamp default clock_timestamp()) FROM PUBLIC;

