-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ultima_etapa ( nr_interno_conta_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

				
				

ds_etapa_w		varchar(80);
dt_etapa_w		timestamp;
dt_etapa_final_w 	varchar(100);
dt_etapa_hora_w 	varchar(100);
ds_retorno_w		varchar(160);
nr_sequencia_w		bigint;
nr_seq_etapa_w		bigint;
ds_observacao_w		varchar(255);
cd_setor_atendimento_w	integer;
nr_seq_motivo_dev_w	bigint;
ds_motivo_devolucao_w	varchar(80);
ie_status_w		conta_paciente_etapa.ie_status%type;


BEGIN

select	max(substr(b.ds_etapa,1,160)),
	max(a.dt_etapa),
	max(a.nr_sequencia),
	max(a.nr_seq_etapa),
	max(substr(ds_observacao,1,160)),
	max(to_char(dt_fim_etapa,'dd/mm/yyyy hh24:mi:ss')),
	max(to_char(dt_etapa,'dd/mm/yyyy hh24:mi:ss')),
	max(a.cd_setor_atendimento),
	max(a.nr_seq_motivo_dev),
	max(a.ie_status)
into STRICT	ds_etapa_w,
	dt_etapa_w,
	nr_sequencia_w,
	nr_seq_etapa_w,
	ds_observacao_w,
	dt_etapa_final_W,
	dt_etapa_hora_w,
	cd_setor_atendimento_w,
	nr_seq_motivo_dev_w,
	ie_status_w
from	fatur_etapa		b,
  	conta_paciente_etapa	a
where	a.nr_seq_etapa		= b.nr_sequencia
and	a.nr_interno_conta	= nr_interno_conta_p
and	coalesce(b.ie_situacao,'A')	= 'A'
and	a.dt_etapa		=	(SELECT	max(x.dt_etapa)
   					from	conta_paciente_etapa x
					where   x.nr_interno_conta = nr_interno_conta_p);
if (ie_opcao_p	= 'E') then
	ds_retorno_w	:=	ds_etapa_w;
elsif (ie_opcao_p	= 'D') then
	ds_retorno_w	:=	dt_etapa_w;		
elsif (ie_opcao_p	= 'ED') then
	ds_retorno_w	:=	ds_etapa_w ||' '|| dt_etapa_w;
elsif (ie_opcao_p	= 'DTF') then
	ds_retorno_w	:=	dt_etapa_final_W;
elsif (ie_opcao_p	= 'DHR') then
	ds_retorno_w	:=	dt_etapa_hora_w;	
elsif (ie_opcao_p	= 'N') then
	ds_retorno_w	:=	to_char(nr_sequencia_w);
elsif (ie_opcao_p	= 'ET') then
	ds_retorno_w	:=	nr_seq_etapa_w;
elsif (ie_opcao_p	= 'OBS') then
	ds_retorno_w	:= ds_observacao_w;
elsif (ie_opcao_p	= 'ST') then
	ds_retorno_w	:= cd_setor_atendimento_w;
elsif (ie_opcao_p	= 'MD') then
	select	max(ds_motivo_devolucao)
	into STRICT	ds_motivo_devolucao_w
	from	fatur_motivo_devol
	where	nr_sequencia = nr_seq_motivo_dev_w;
	ds_retorno_w := ds_motivo_devolucao_w;
elsif (ie_opcao_p	= 'SMD') then
	ds_retorno_w	:= nr_seq_motivo_dev_w;
elsif (ie_opcao_p = 'TT') then
	ds_retorno_w := ie_status_w;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ultima_etapa ( nr_interno_conta_p bigint, ie_opcao_p text) FROM PUBLIC;

