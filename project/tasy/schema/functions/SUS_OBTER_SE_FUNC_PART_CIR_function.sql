-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_se_func_part_cir ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_funcao_medico_p text) RETURNS varchar AS $body$
DECLARE


ie_participou_sus_w	varchar(1);
cd_grupo_w		sus_estrutura_procedimento_v.cd_grupo%type;
cd_subgrupo_w		sus_estrutura_procedimento_v.cd_subgrupo%type;
cd_forma_organizacao_w	sus_estrutura_procedimento_v.cd_forma_organizacao%type;

--LÃª as regras para identificar se participou SUS
c_regra_participou_sus CURSOR(	cd_procedimento_pc	procedimento.cd_procedimento%type,
				ie_origem_proced_pc	procedimento.ie_origem_proced%type,
				cd_grupo_pc		sus_estrutura_procedimento_v.cd_grupo%type,
				cd_subgrupo_pc		sus_estrutura_procedimento_v.cd_subgrupo%type,
				cd_forma_organizacao_pc	sus_estrutura_procedimento_v.cd_forma_organizacao%type,
				ie_funcao_medico_pc	sus_regra_func_partic_cir.ie_funcao%type) FOR
SELECT	coalesce(ie_participou_sus,'S') ie_participou_sus
from	sus_regra_func_partic_cir
where	coalesce(cd_procedimento,cd_procedimento_pc)	= cd_procedimento_pc
and	coalesce(ie_origem_proced,ie_origem_proced_pc)	= ie_origem_proced_pc
and	coalesce(cd_grupo,cd_grupo_pc)	= cd_grupo_pc
and	coalesce(cd_subgrupo,cd_subgrupo_pc)	= cd_subgrupo_pc
and	coalesce(cd_forma_organizacao,cd_forma_organizacao_pc)	= cd_forma_organizacao_pc
and	coalesce(ie_funcao,ie_funcao_medico_pc)		= ie_funcao_medico_pc
order by ie_funcao,
	cd_procedimento,
	ie_origem_proced,
	ie_funcao;

BEGIN

--Busca as estruturas SUS do procedimento informado
begin
	select	cd_grupo,
		cd_subgrupo,
		cd_forma_organizacao
	into STRICT	cd_grupo_w,
		cd_subgrupo_w,
		cd_forma_organizacao_w
	from	sus_estrutura_procedimento_v
	where	cd_procedimento	= cd_procedimento_p
	and	ie_origem_proced = ie_origem_proced_p;
exception
when others then
	cd_grupo_w := 0;
	cd_subgrupo_w := 0;
	cd_forma_organizacao_w := 0;
end;

--Retorna se participou SUS
for r_c_regra_participou_sus in c_regra_participou_sus(	cd_procedimento_p, ie_origem_proced_p, cd_grupo_w,
						cd_subgrupo_w, cd_forma_organizacao_w, ie_funcao_medico_p) loop

	ie_participou_sus_w :=	r_c_regra_participou_sus.ie_participou_sus;

--Fim do cursor que verifica se pariticipou SUS
end loop;

return	ie_participou_sus_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_se_func_part_cir ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_funcao_medico_p text) FROM PUBLIC;

