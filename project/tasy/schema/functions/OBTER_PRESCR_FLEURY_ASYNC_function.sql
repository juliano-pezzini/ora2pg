-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prescr_fleury_async ( NR_PRESCRICAO_P prescr_procedimento.nr_prescricao%type, ds_method_p text default null) RETURNS varchar AS $body$
DECLARE


count_1 bigint;
count_2 bigint;
count_3 bigint;


BEGIN
select count(*)
into STRICT count_1
from	exame_laboratorio e,
     	prescr_procedimento p,
		prescr_medica a
where	p.nr_prescricao = nr_prescricao_p
and		e.nr_seq_exame 	= p.nr_seq_exame
and		a.nr_prescricao = p.nr_prescricao
and		((ds_method_p = 'cancelar_ficha_item') or (ds_method_p = 'cancelar_ficha') or (ds_method_p = 'regerar_fichas') or (coalesce(coalesce(a.nr_controle, p.nr_controle_ext)::text, '') = ''))
and		e.cd_cgc_externo = '60840055000131';

select count(*)
into STRICT count_2
from   proc_interno i,
	   prescr_procedimento p ,
       regra_proc_interno_integra t
where  i.ie_tipo in ('AP','APH','APC')
and	   p.nr_prescricao = nr_prescricao_p
and    i.nr_sequencia  = p.nr_seq_proc_interno
and    p.cd_cgc_laboratorio = '60840055000131'
and	   t.nr_seq_proc_interno = i.nr_sequencia
and	   t.ie_tipo_integracao = 3;

select count(*)
into STRICT count_3
from   proc_interno i,
	   prescr_procedimento p,
	   regra_proc_interno_integra t
where  i.ie_tipo not in ('AP','APH','APC')
and	   p.nr_prescricao = nr_prescricao_p
and    i.nr_sequencia  = p.nr_seq_proc_interno
and	   t.nr_seq_proc_interno = i.nr_sequencia
and	   t.ie_tipo_integracao = 6;

if (count_1 > 0 or count_2 > 0 or count_3 > 0) then
     return '1';
else
     return '0';
end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prescr_fleury_async ( NR_PRESCRICAO_P prescr_procedimento.nr_prescricao%type, ds_method_p text default null) FROM PUBLIC;

