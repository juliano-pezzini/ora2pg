-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_convertido_cotacao ( nr_interno_conta_p bigint, cd_moeda_p bigint) RETURNS bigint AS $body$
DECLARE


vl_retorno_w 			double precision;
vl_cotacao_w		CONTA_PACIENTE_EXCEDENTE.vl_cotacao%type;


c01 CURSOR FOR
SELECT  coalesce(vl_cotacao,0)
from 	conta_paciente_excedente
where   nr_interno_conta 	= nr_interno_conta_p
and 	cd_moeda 			= cd_moeda_p;

c02 CURSOR FOR
SELECT    coalesce(vl_cotacao,0)
from      cotacao_moeda
where     cd_moeda = cd_moeda_p
order by  dt_cotacao desc;


BEGIN

vl_retorno_w := 0;
vl_cotacao_w := 0;
	begin

	if (2 = philips_param_pck.get_cd_pais) then --MEXICO, VERIFICA A TABELA DE EXCEDENTE
		open c01;
			loop
			fetch c01 into
				vl_cotacao_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				vl_cotacao_w := vl_cotacao_w;
				exit;
			end loop;
		close c01;
	end if;

	if (coalesce(vl_cotacao_w,0) = 0)then
		open c02;
			loop
			fetch c01 into
				vl_cotacao_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				vl_cotacao_w := vl_cotacao_w;
				exit;
			end loop;
		close c02;
	end if;

		vl_retorno_w := coalesce(vl_cotacao_w,0);
	EXCEPTION
	when others then
		vl_retorno_w := 0;
	end;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_convertido_cotacao ( nr_interno_conta_p bigint, cd_moeda_p bigint) FROM PUBLIC;

