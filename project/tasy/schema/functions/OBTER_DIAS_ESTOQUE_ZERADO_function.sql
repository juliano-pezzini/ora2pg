-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dias_estoque_zerado ( cd_estabelecimento_p bigint, dt_mesano_referencia_p timestamp, cd_material_p bigint) RETURNS bigint AS $body$
DECLARE


dt_dia_w				timestamp;
dt_dia_anterior_w			timestamp;
qt_dias_w			bigint 	:= 0;
qt_percentual_w			double precision 	:= 0;
qt_saldo_estoque_w		double precision;
qt_dias_mes_w			smallint;

c01 CURSOR FOR
SELECT	a.dt_dia
from	dia_v a
where	a.dt_dia between trunc(dt_mesano_referencia_p,'mm') and last_day(dt_mesano_referencia_p)
and	dt_dia not in (
	SELECT	distinct dt_dia
	from	resumo_movto_estoque_dia b
	where	cd_estabelecimento		= cd_estabelecimento_p
	and	dt_mesano_referencia	= dt_mesano_referencia_p
	and	cd_material 		= cd_material_p);


BEGIN
qt_dias_w := 0;
open C01;
loop
fetch C01 into
	dt_dia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	max(a.dt_dia)
	into STRICT	dt_dia_anterior_w
	from	resumo_movto_estoque_dia a
	where	a.cd_estabelecimento	= cd_estabelecimento_p
	and	a.cd_material 		= cd_material_p
	and	a.dt_dia			< dt_dia_w;

	if (dt_dia_anterior_w IS NOT NULL AND dt_dia_anterior_w::text <> '') then

		select	coalesce(max(a.qt_saldo_estoque),0)
		into STRICT	qt_saldo_estoque_w
		from	resumo_movto_estoque_dia a
		where	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material 		= cd_material_p
		and	a.dt_dia			= dt_dia_anterior_w;

		if (qt_saldo_estoque_w = 0) then
			qt_dias_w := qt_dias_w + 1;
		end if;
	end if;
	end;
end loop;
close C01;

if (qt_dias_w > 0) then
	select	(substr(last_day(dt_mesano_referencia_p),1,2))::numeric
	into STRICT	qt_dias_mes_w
	;

	qt_percentual_w := round((dividir((qt_dias_w * 100),qt_dias_mes_w))::numeric,2);
end if;

return	qt_percentual_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dias_estoque_zerado ( cd_estabelecimento_p bigint, dt_mesano_referencia_p timestamp, cd_material_p bigint) FROM PUBLIC;

