-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION reinf_4020_dados_imp_tit_pagar ( nr_seq_titulo_p bigint, ie_tipo_valor_p text, ie_tipo_tributo_p text, ie_exigibilidade_p text, cd_estabelecimento_p bigint, dt_baixa_p timestamp default null, ie_exig_susp_forma_p text default null) RETURNS bigint AS $body$
DECLARE


vl_tributo_w		titulo_pagar_imposto.vl_imposto%type;
vl_base_calculo_w		titulo_pagar_imposto.vl_base_calculo%type;
ds_retorno_w		double precision;
				

BEGIN

if (ie_exigibilidade_p = 'S') then
	begin
		select 	sum(vl_imposto),
			sum(vl_base_calculo)
		into STRICT	vl_tributo_w,
			vl_base_calculo_w
		from(		
			SELECT	coalesce(sum(i.vl_imposto),0) vl_imposto,
				coalesce(sum(i.vl_base_calculo),0) vl_base_calculo
			FROM tributo_conta_pagar tc, tributo t, titulo_pagar_imposto i
LEFT OUTER JOIN titulo_pagar_baixa b ON (i.nr_seq_baixa = b.nr_sequencia)
WHERE i.nr_seq_trib_cp = tc.nr_sequencia and t.cd_tributo = i.cd_tributo and tc.cd_tributo = t.cd_tributo  and i.nr_titulo = nr_seq_titulo_p and ((coalesce(i.nr_seq_baixa::text, '') = '') or (b.dt_baixa =  dt_baixa_p)) and ((coalesce(ie_tipo_tributo_p,'X') = 'X') or (t.ie_tipo_tributo = ie_tipo_tributo_p)) and tc.ie_exigibilidade_suspensa = 'S' and i.cd_tributo in (SELECT cd_tributo from fis_reinf_r4020_regra where cd_estabelecimento = cd_estabelecimento_p and ie_tipo_data = 2) and ((tc.ie_exig_susp_forma = ie_exig_susp_forma_p) or (coalesce(ie_exig_susp_forma_p::text, '') = ''))			
		 );
						
	end;
else
	begin
		select 	sum(vl_imposto),
			sum(vl_base_calculo)
		into STRICT	vl_tributo_w,
			vl_base_calculo_w
		from(
			SELECT	coalesce(sum(i.vl_imposto),0) vl_imposto,
				coalesce(sum(i.vl_base_calculo),0) vl_base_calculo
			FROM tributo_conta_pagar tc, tributo t, titulo_pagar_imposto i
LEFT OUTER JOIN titulo_pagar_baixa b ON (i.nr_seq_baixa = b.nr_sequencia)
WHERE i.nr_seq_trib_cp = tc.nr_sequencia and t.cd_tributo = i.cd_tributo and tc.cd_tributo = t.cd_tributo and i.nr_titulo = nr_seq_titulo_p  and ((coalesce(i.nr_seq_baixa::text, '') = '') or (b.dt_baixa =  dt_baixa_p)) and ((coalesce(ie_tipo_tributo_p,'X') = 'X') or (t.ie_tipo_tributo = ie_tipo_tributo_p)) and i.cd_tributo in (SELECT cd_tributo from fis_reinf_r4020_regra where cd_estabelecimento = cd_estabelecimento_p and ie_tipo_data = 2) and (coalesce(tc.ie_exigibilidade_suspensa::text, '') = '' or tc.ie_exigibilidade_suspensa = 'N') and coalesce(tc.ie_exig_susp_forma::text, '') = ''
			
union all

			select	coalesce(sum(i.vl_imposto),0) vl_imposto,
				coalesce(sum(i.vl_base_calculo),0) vl_base_calculo	
			FROM tributo t, titulo_pagar_imposto i
LEFT OUTER JOIN titulo_pagar_baixa b ON (i.nr_seq_baixa = b.nr_sequencia)
WHERE t.cd_tributo = i.cd_tributo and i.nr_titulo = nr_seq_titulo_p  and coalesce(i.nr_seq_trib_cp::text, '') = '' and ((coalesce(i.nr_seq_baixa::text, '') = '') or (b.dt_baixa =  dt_baixa_p)) and ((coalesce(ie_tipo_tributo_p,'X') = 'X') or (t.ie_tipo_tributo = ie_tipo_tributo_p)) and i.cd_tributo in (select cd_tributo from fis_reinf_r4020_regra where cd_estabelecimento = cd_estabelecimento_p and ie_tipo_data = 2)
		 );
		
		
	end;
end if;

if (ie_tipo_valor_p = 'B' )then
	ds_retorno_w := vl_base_calculo_w;
elsif (ie_tipo_valor_p = 'V') then
	ds_retorno_w := vl_tributo_w;
end if;


return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION reinf_4020_dados_imp_tit_pagar ( nr_seq_titulo_p bigint, ie_tipo_valor_p text, ie_tipo_tributo_p text, ie_exigibilidade_p text, cd_estabelecimento_p bigint, dt_baixa_p timestamp default null, ie_exig_susp_forma_p text default null) FROM PUBLIC;

