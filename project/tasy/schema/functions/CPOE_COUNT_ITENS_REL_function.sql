-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_count_itens_rel (ie_somente_nao_gerado_p text) RETURNS bigint AS $body$
DECLARE

				 
nr_retorno_w	bigint := 0;


BEGIN 
 
if (ie_somente_nao_gerado_p IS NOT NULL AND ie_somente_nao_gerado_p::text <> '') then 
	 
	select	sum(qt_registros) qt_registros 
	into STRICT	nr_retorno_w 
	from	(	SELECT	count(*) qt_registros 
				from	cpoe_dieta a 
				where	(((ie_somente_nao_gerado_p = 'S') and 
						 ((coalesce(dt_prox_geracao::text, '') = '') or (dt_prox_geracao < clock_timestamp()))) or 
						 ((ie_somente_nao_gerado_p = 'N') and 
						  (dt_prox_geracao > (trunc(clock_timestamp(),'hh') + 1/24)))) 
				and	  ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  > clock_timestamp() + (25/24)) or 
					  ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') and (a.ie_duracao = 'C'))) 
				and		ie_tipo_dieta = 'O' 
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
				and 	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
				and		not exists (	select	1 
										from	atendimento_paciente b 
										where	b.nr_atendimento	= a.nr_atendimento 
										and		(b.dt_alta IS NOT NULL AND b.dt_alta::text <> '')) 
				and 	not exists ( 	SELECT	1 
										from	prescr_medica y, 
												prescr_dieta w 
										where 	y.nr_atendimento = a.nr_atendimento 
										and 	y.nr_prescricao = w.nr_prescricao 
										and 	w.nr_seq_dieta_cpoe = a.nr_sequencia 
										and 	y.dt_validade_prescr = a.dt_fim) 
				
union
 
				select 	count(*) qt_registros 
				from 	cpoe_dieta a 
				where	(((ie_somente_nao_gerado_p = 'S') and 
						 ((coalesce(dt_prox_geracao::text, '') = '') or (dt_prox_geracao < clock_timestamp()))) or 
						 ((ie_somente_nao_gerado_p = 'N') and 
						 (dt_prox_geracao > (trunc(clock_timestamp(),'hh') + 1/24)))) 
				and	  ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  > clock_timestamp() + (25/24)) or 
						 ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') and (a.ie_duracao = 'C'))) 
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
				and		ie_tipo_dieta = 'E' 
				and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
				and		not exists (	select	1 
										from	atendimento_paciente b 
										where	b.nr_atendimento	= a.nr_atendimento 
										and		(b.dt_alta IS NOT NULL AND b.dt_alta::text <> '')) 
				and		not exists ( 	select	1 
										from	prescr_medica y, 	 
												prescr_material w 
										where	y.nr_atendimento = a.nr_atendimento 
										and		y.nr_prescricao = w.nr_prescricao 
										and		w.nr_seq_dieta_cpoe = a.nr_sequencia 
										and		w.ie_agrupador = 8 
										and		y.dt_validade_prescr = a.dt_fim) 		 
				
union
 
				select	count(*) qt_registros 
				from 	cpoe_dieta a 
				where	(((ie_somente_nao_gerado_p = 'S') and 
						 ((coalesce(dt_prox_geracao::text, '') = '') or (dt_prox_geracao < clock_timestamp()))) or 
						 ((ie_somente_nao_gerado_p = 'N') and 
						 (dt_prox_geracao > (trunc(clock_timestamp(),'hh') + 1/24)))) 
				and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  > clock_timestamp() + (25/24)) or 
						 ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') and (a.ie_duracao = 'C'))) 
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
				and		ie_tipo_dieta = 'S'		 
				and 	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
				and		not exists (	select	1 
										from	atendimento_paciente b 
										where	b.nr_atendimento	= a.nr_atendimento 
										and		(b.dt_alta IS NOT NULL AND b.dt_alta::text <> '')) 
				and 	not exists ( 	select	1 
										from	prescr_medica y,	 
												prescr_material w 
										where 	y.nr_atendimento = a.nr_atendimento 
										and 	y.nr_prescricao = w.nr_prescricao 
										and 	w.nr_seq_dieta_cpoe = a.nr_sequencia 
										and 	y.dt_validade_prescr = a.dt_fim 
										and		w.ie_agrupador = 12) 
				
union
 
				select	count(*) qt_registros 
				from	cpoe_dieta a 
				where	(((ie_somente_nao_gerado_p = 'S') and 
						 ((coalesce(dt_prox_geracao::text, '') = '') or (dt_prox_geracao < clock_timestamp()))) or 
						 ((ie_somente_nao_gerado_p = 'N') and 
						 (dt_prox_geracao > (trunc(clock_timestamp(),'hh') + 1/24)))) 
				and	  ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  > clock_timestamp() + (25/24)) or 
						 ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') and (a.ie_duracao = 'C'))) 
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
				and 	ie_tipo_dieta = 'J' 
				and 	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
				and		not exists (	select	1 
										from	atendimento_paciente b 
										where	b.nr_atendimento	= a.nr_atendimento 
										and		(b.dt_alta IS NOT NULL AND b.dt_alta::text <> '')) 
				and 	not exists ( 	select	1 
										from	prescr_medica y, 
												rep_jejum w	 
										where	y.nr_atendimento = a.nr_atendimento 
										and 	y.nr_prescricao = w.nr_prescricao 
										and 	w.nr_seq_dieta_cpoe = a.nr_sequencia 
										and 	y.dt_validade_prescr = a.dt_fim) 	 
				
union
 
				select	count(*) qt_registros 
				from	cpoe_dieta a 
				where	(((ie_somente_nao_gerado_p = 'S') and 
						 ((coalesce(dt_prox_geracao::text, '') = '') or (dt_prox_geracao < clock_timestamp()))) or 
						 ((ie_somente_nao_gerado_p = 'N') and 
						 (dt_prox_geracao > (trunc(clock_timestamp(),'hh') + 1/24)))) 
				and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  > clock_timestamp() + (25/24)) or 
						 ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') and (a.ie_duracao = 'C'))) 
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
				and		ie_tipo_dieta = 'L' 
				and 	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
				and		not exists (	select	1 
										from	atendimento_paciente b 
										where	b.nr_atendimento	= a.nr_atendimento 
										and		(b.dt_alta IS NOT NULL AND b.dt_alta::text <> '')) 
				and 	not exists ( 	select	1 
										from	prescr_medica y,	 
												prescr_leite_deriv w 
										where 	y.nr_atendimento = a.nr_atendimento 
										and 	y.nr_prescricao = w.nr_prescricao 
										and 	w.nr_seq_dieta_cpoe = a.nr_sequencia 
										and 	y.dt_validade_prescr = a.dt_fim) 
				
union
 
				select	count(*) qt_registros 
				from	cpoe_material a 
				where	(((ie_somente_nao_gerado_p = 'S') and 
						 ((coalesce(dt_prox_geracao::text, '') = '') or (dt_prox_geracao < clock_timestamp()))) or 
						 ((ie_somente_nao_gerado_p = 'N') and 
						 (dt_prox_geracao > (trunc(clock_timestamp(),'hh') + 1/24)))) 
				and	  ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  > clock_timestamp() + (25/24)) or 
						 ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') and (a.ie_duracao = 'C'))) 
				and		not exists (	select	1 
										from	atendimento_paciente b 
										where	b.nr_atendimento	= a.nr_atendimento 
										and		(b.dt_alta IS NOT NULL AND b.dt_alta::text <> '')) 
				and 	not exists ( 	select	1 
										from	prescr_medica y, 
												prescr_material w 
										where	y.nr_atendimento = a.nr_atendimento 
										and 	y.nr_prescricao = w.nr_prescricao 
										and 	w.nr_seq_mat_cpoe = a.nr_sequencia 
										and 	w.ie_agrupador = 4 
										and 	y.dt_validade_prescr = a.dt_fim)												 
				and		ie_controle_tempo = 'S' 
				and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
				and 	(nr_atendimento IS NOT NULL AND nr_atendimento::text <> '') 
				
union
 
				select	count(*) qt_registros 
				from	cpoe_material a 
				where	(((ie_somente_nao_gerado_p = 'S') and 
						 ((coalesce(dt_prox_geracao::text, '') = '') or (dt_prox_geracao < clock_timestamp()))) or 
						 ((ie_somente_nao_gerado_p = 'N') and 
						 (dt_prox_geracao > (trunc(clock_timestamp(),'hh') + 1/24)))) 
				and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  > clock_timestamp() + (25/24)) or 
						 ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') and (a.ie_duracao = 'C'))) 
				and		not exists (	select	1 
										from	atendimento_paciente b 
										where	b.nr_atendimento	= a.nr_atendimento 
										and		(b.dt_alta IS NOT NULL AND b.dt_alta::text <> '')) 
				and 	not exists ( 	select 1 
										from	prescr_medica y, 
												prescr_material w 
										where	y.nr_atendimento = a.nr_atendimento 
										and 	y.nr_prescricao = w.nr_prescricao 
										and 	w.nr_seq_mat_cpoe = a.nr_sequencia 
										and 	ie_agrupador = 1 
										and 	y.dt_validade_prescr = a.dt_fim) 
				and		ie_controle_tempo = 'N' 	 
				and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
				and 	(nr_atendimento IS NOT NULL AND nr_atendimento::text <> '') 
				
union
 
				select	count(*) qt_registros 
				from	cpoe_procedimento a 
				where	(((ie_somente_nao_gerado_p = 'S') and 
						 ((coalesce(dt_prox_geracao::text, '') = '') or (dt_prox_geracao < clock_timestamp()))) or 
						 ((ie_somente_nao_gerado_p = 'N') and 
						 (dt_prox_geracao > (trunc(clock_timestamp(),'hh') + 1/24)))) 
				and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  > clock_timestamp() + (25/24)) or 
						 ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') and (a.ie_duracao = 'C'))) 
				and		not exists (	select	1 
										from	atendimento_paciente b 
										where	b.nr_atendimento	= a.nr_atendimento 
										and		(b.dt_alta IS NOT NULL AND b.dt_alta::text <> '')) 
				and 	not exists ( 	select	1 
										from	prescr_medica y, 
												prescr_procedimento w 
										where	y.nr_atendimento = a.nr_atendimento 
										and 	y.nr_prescricao = w.nr_prescricao 
										and 	w.nr_seq_proc_cpoe = a.nr_sequencia 
										and 	y.dt_validade_prescr = a.dt_fim)	 
				and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
				and 	(nr_atendimento IS NOT NULL AND nr_atendimento::text <> '') 
				
union
 
				select	count(*) qt_registros 
				from	cpoe_gasoterapia a 
				where	(((ie_somente_nao_gerado_p = 'S') and 
						 ((coalesce(dt_prox_geracao::text, '') = '') or (dt_prox_geracao < clock_timestamp()))) or 
						 ((ie_somente_nao_gerado_p = 'N') and 
						 (dt_prox_geracao > (trunc(clock_timestamp(),'hh') + 1/24)))) 
				and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  > clock_timestamp() + (25/24)) or 
						 ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') and (a.ie_duracao = 'C'))) 
				and		not exists (	select	1 
										from	atendimento_paciente b 
										where	b.nr_atendimento	= a.nr_atendimento 
										and		(b.dt_alta IS NOT NULL AND b.dt_alta::text <> '')) 
				and 	not exists ( 	select	1 
										from	prescr_medica y, 
												prescr_gasoterapia w 
									where 	y.nr_atendimento = a.nr_atendimento 
									and 	y.nr_prescricao = w.nr_prescricao 
									and 	w.nr_seq_gas_cpoe = a.nr_sequencia 
									and 	y.dt_validade_prescr = a.dt_fim) 
				and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
				and 	(nr_atendimento IS NOT NULL AND nr_atendimento::text <> '') 
				
union
 
				select	count(*) qt_registros 
				from	cpoe_recomendacao a 
				where	(((ie_somente_nao_gerado_p = 'S') and 
						 ((coalesce(dt_prox_geracao::text, '') = '') or (dt_prox_geracao < clock_timestamp()))) or 
						 ((ie_somente_nao_gerado_p = 'N') and 
						 (dt_prox_geracao > (trunc(clock_timestamp(),'hh') + 1/24)))) 
				and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  > clock_timestamp() + (25/24)) or 
						 ((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') and (a.ie_duracao = 'C'))) 
				and		not exists (	select	1 
										from	atendimento_paciente b 
										where	b.nr_atendimento	= a.nr_atendimento 
										and		(b.dt_alta IS NOT NULL AND b.dt_alta::text <> '')) 
				and 	not exists (	select	1 
										from	prescr_medica y, 
												prescr_recomendacao w 
										where	y.nr_atendimento = a.nr_atendimento 
										and 	y.nr_prescricao = w.nr_prescricao 
										and 	w.nr_seq_rec_cpoe = a.nr_sequencia 
										and 	y.dt_validade_prescr = a.dt_fim)	 
				and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
				and 	(nr_atendimento IS NOT NULL AND nr_atendimento::text <> '')) alias326;
 
end if;	
	 
if (coalesce(nr_retorno_w::text, '') = '') then 
	nr_retorno_w := 0;
end if;
 
return	nr_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_count_itens_rel (ie_somente_nao_gerado_p text) FROM PUBLIC;

