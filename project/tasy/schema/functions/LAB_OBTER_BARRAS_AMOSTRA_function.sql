-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_barras_amostra ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_prescr_proc_mat_p bigint, ie_amostra_ant_p text) RETURNS varchar AS $body$
DECLARE

nr_seq_material_w			bigint;
nr_seq_grupo_w			bigint;
nr_seq_origem_w			bigint;
dt_liberacao_w			timestamp;
dt_prescricao_w			timestamp;
dt_liberacao_medico_w		timestamp;
nr_seq_lab_w			varchar(20);
nr_seq_grupo_imp_w		bigint;

nr_seq_prescr_proc_mat_w		bigint;
cd_barras_w			varchar(255);
nr_seq_frasco_w			bigint;
ie_grupo_imp_amostra_seq_w	varchar(1);
cd_estabelecimento_w		smallint;
ie_agrupa_amostra_horario_w	lab_parametro.ie_agrupa_amostra_horario%type;
ie_urgencia_w				prescr_procedimento.ie_urgencia%type;
dt_prev_execucao_w			prescr_procedimento.dt_prev_execucao%type;
dt_prior_codigo_barras_w varchar(2);


BEGIN
select	c.nr_seq_material,
	b.nr_seq_grupo,
	b.nr_seq_grupo_imp,
	coalesce(a.nr_seq_origem,0),
	k.dt_liberacao,
	k.dt_prescricao,
	k.dt_liberacao_medico,
	a.nr_seq_lab,
	a.nr_seq_frasco,
	coalesce(k.cd_estabelecimento,1),
	coalesce(a.ie_urgencia,'N'),
	a.dt_prev_execucao
into STRICT	nr_seq_material_w,
	nr_seq_grupo_w,
	nr_seq_grupo_imp_w,
	nr_seq_origem_w,
	dt_liberacao_w,
	dt_prescricao_w,
	dt_liberacao_medico_w,
	nr_seq_lab_w,
	nr_seq_frasco_w,
	cd_estabelecimento_w,
	ie_urgencia_w,
	dt_prev_execucao_w
from	exame_lab_material c,
	material_exame_lab d,
	exame_laboratorio b,
	prescr_procedimento a,
	prescr_medica k
where	k.nr_prescricao		= a.nr_prescricao
and	a.nr_prescricao 		= a.nr_prescricao
and	a.nr_seq_exame 		= b.nr_seq_exame
and	(a.nr_seq_exame IS NOT NULL AND a.nr_seq_exame::text <> '')
and	d.nr_sequencia 		= Obter_Mat_Exame_Lab_prescr(a.nr_prescricao, a.nr_sequencia, 1)
and	c.nr_seq_material 		= d.nr_sequencia
and	c.nr_seq_exame 		= a.nr_seq_exame
and	a.nr_prescricao		= nr_prescricao_p
and	a.nr_sequencia		= nr_Seq_prescr_p
and (d.ie_volume_tempo 	= 'S' or coalesce(c.qt_coleta,1) > 0);

select	coalesce(max(ie_gerar_padrao_grupo_imp),'N'),
		coalesce(max(ie_agrupa_amostra_horario),'N')
into STRICT 	ie_grupo_imp_amostra_seq_w,
		ie_agrupa_amostra_horario_w
from 	lab_parametro
where 	cd_estabelecimento = cd_estabelecimento_w;

if (ie_agrupa_amostra_horario_w = 'U') then

	select 	coalesce(max(a.NR_SEQUENCIA),0)
	into STRICT	nr_seq_prescr_proc_mat_w
	from 	prescr_proc_material a,
			prescr_proc_mat_item b,
			prescr_procedimento c
	where	a.nr_sequencia = b.nr_seq_prescr_proc_mat
	AND 	c.nr_sequencia = b.nr_seq_prescr
	and		c.nr_prescricao = b.nr_prescricao
	and 	a.nr_prescricao = nr_prescricao_p
	and 	a.nr_seq_material = nr_seq_material_w
   and   ((nr_seq_prescr_proc_mat_p IS NOT NULL AND nr_seq_prescr_proc_mat_p::text <> '') or (b.nr_seq_prescr = nr_seq_prescr_p))
	and		coalesce(c.ie_urgencia,'N') = ie_urgencia_w
	and		a.nr_sequencia    = coalesce(nr_seq_prescr_proc_mat_p,a.nr_sequencia)
	and		((coalesce(a.nr_seq_frasco,0)	= coalesce(nr_seq_frasco_w,0)) or (ie_amostra_ant_p not in ('AM11F','AM10F')))
	and 	((a.nr_seq_grupo   = nr_seq_grupo_w AND ie_grupo_imp_amostra_seq_w = 'N') or
			(a.nr_seq_grupo_imp = nr_seq_grupo_imp_w AND ie_grupo_imp_amostra_seq_w = 'S'));

elsif (ie_agrupa_amostra_horario_w = 'S') then

	select 	coalesce(max(a.NR_SEQUENCIA),0)
	into STRICT	nr_seq_prescr_proc_mat_w
	from 	prescr_proc_material a,
			prescr_proc_mat_item b,
			prescr_procedimento c
	where	a.nr_sequencia = b.nr_seq_prescr_proc_mat
	AND 	c.nr_sequencia = b.nr_seq_prescr
	and		c.nr_prescricao = b.nr_prescricao
	and 	a.nr_prescricao = nr_prescricao_p
	and 	a.nr_seq_material = nr_seq_material_w
	AND 	c.dt_prev_execucao = dt_prev_execucao_w
	and		a.nr_sequencia    = coalesce(nr_seq_prescr_proc_mat_p,a.nr_sequencia)
   and   ((nr_seq_prescr_proc_mat_p IS NOT NULL AND nr_seq_prescr_proc_mat_p::text <> '') or (b.nr_seq_prescr = nr_seq_prescr_p))
	and		((coalesce(a.nr_seq_frasco,0)	= coalesce(nr_seq_frasco_w,0)) or (ie_amostra_ant_p not in ('AM11F','AM10F')))
	and 	((a.nr_seq_grupo   = nr_seq_grupo_w AND ie_grupo_imp_amostra_seq_w = 'N') or
			(a.nr_seq_grupo_imp = nr_seq_grupo_imp_w AND ie_grupo_imp_amostra_seq_w = 'S'));

else

	select 	coalesce(max(a.NR_SEQUENCIA),0)
	into STRICT	nr_seq_prescr_proc_mat_w
	from 	prescr_proc_material a
  left join prescr_proc_mat_item ppmi on ppmi.nr_seq_prescr_proc_mat = a.nr_sequencia
	where 	a.nr_prescricao = nr_prescricao_p
  and (ppmi.nr_seq_prescr = nr_seq_prescr_p or coalesce(ppmi.nr_seq_prescr::text, '') = '')
	and 	nr_seq_material = nr_seq_material_w
	and	a.nr_sequencia    = coalesce(nr_seq_prescr_proc_mat_p,a.nr_sequencia)
	and	((coalesce(a.nr_seq_frasco,0)	= coalesce(nr_seq_frasco_w,0)) or (ie_amostra_ant_p not in ('AM11F','AM10F')))
	and 	((nr_seq_grupo   = nr_seq_grupo_w AND ie_grupo_imp_amostra_seq_w = 'N') or
		(nr_seq_grupo_imp = nr_seq_grupo_imp_w AND ie_grupo_imp_amostra_seq_w = 'S'));

end if;

if (nr_seq_prescr_proc_mat_w > 0) then
  dt_prior_codigo_barras_w := lab_obter_valor_parametro(722,373);

	select 	cd_barras
	into STRICT	cd_barras_w
	from	prescr_proc_material
	where	nr_sequencia = nr_seq_prescr_proc_mat_w;

	if (length(cd_barras_w) > 10) then
		if (ie_amostra_ant_p = 'DGS6') then
			cd_barras_w := to_char(coalesce(dt_liberacao_medico_w,coalesce(dt_liberacao_w,dt_prescricao_w)),'ddmm') || lpad(nr_seq_grupo_w,2,0) || lpad(nr_seq_lab_w,6,0);
		end if;
		if (ie_amostra_ant_p = 'DGS5') then
			cd_barras_w := to_char(coalesce(dt_liberacao_medico_w,coalesce(dt_liberacao_w,dt_prescricao_w)),'ddmm') || lpad(nr_seq_grupo_w,2,0) || lpad(nr_seq_lab_w,5,0);
		end if;
		if (ie_amostra_ant_p = 'DGIS') then
			cd_barras_w := to_char(coalesce(dt_liberacao_medico_w,coalesce(dt_liberacao_w,dt_prescricao_w)),'ddmm') || lpad(nr_seq_grupo_imp_w,2,0) || lpad(nr_seq_lab_w,3,0);
		end if;
		if (ie_amostra_ant_p = 'DS4GI') then
			cd_barras_w := to_char(coalesce(dt_liberacao_medico_w,coalesce(dt_liberacao_w,dt_prescricao_w)),'ddmm') || lpad(nr_seq_lab_w,4,0) || lpad(nr_seq_grupo_imp_w,2,0);
		end if;
		if (ie_amostra_ant_p = 'DAGS4') then
                   if (dt_prior_codigo_barras_w = 'LE') then
                      cd_barras_w := to_char(coalesce(dt_liberacao_w,dt_liberacao_medico_w,dt_prescricao_w),'ddmmyy') || lpad(nr_seq_grupo_w,2,0) || lpad(nr_seq_lab_w,4,0);
                   else
                      cd_barras_w := to_char(coalesce(dt_liberacao_medico_w,dt_liberacao_w,dt_prescricao_w),'ddmmyy') || lpad(nr_seq_grupo_w,2,0) || lpad(nr_seq_lab_w,4,0);
                  end if;
		end if;
	elsif (ie_amostra_ant_p = 'AMO10') then
		cd_barras_w := lpad(cd_barras_w,10,0);
	elsif (ie_amostra_ant_p = 'AM10F') then
		cd_barras_w := lpad(cd_barras_w,10,0);
	elsif (ie_amostra_ant_p = 'EAM10') then
		cd_barras_w := lpad(substr(cd_estabelecimento_w,1,2),2,0)||lpad(cd_barras_w,10,0);
	elsif (ie_amostra_ant_p = 'AMO11') then
		cd_barras_w := lpad(cd_barras_w,11,0);
	elsif (ie_amostra_ant_p = 'AM11F') then
		cd_barras_w := lpad(cd_barras_w,11,0);
	elsif (ie_amostra_ant_p = 'AMO13') then
		cd_barras_w := lpad(cd_barras_w,13,0);
	elsif (ie_amostra_ant_p <> 'WEB') then
		cd_barras_w := lpad(cd_barras_w,9,0);
	end if;
end if;

return cd_barras_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_barras_amostra ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_prescr_proc_mat_p bigint, ie_amostra_ant_p text) FROM PUBLIC;

