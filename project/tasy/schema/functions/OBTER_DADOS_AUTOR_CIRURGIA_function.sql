-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_autor_cirurgia ( nr_sequencia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*
ie_opcao_p
	C - Convenio
	CU - Codigo do usuario no convenio
	NM - nm_usuario_autorizacao
	EG - ie_estagio_autor
	DL  - Dt liberacao
	AT - Atendimento
	NP - Nome do paciente
	CC - Categoria 
*/
cd_convenio_w		bigint;
cd_usuario_convenio_w	varchar(255);
nr_atendimento_w	bigint;
nr_seq_agenda_w		agenda_paciente.nr_sequencia%type;
ds_retorno_w		varchar(255);
nr_seq_autor_conv_w	bigint;
nm_usuario_autorizacao_w varchar(15);
ie_estagio_autor_w	varchar(1);
dt_liberacao_w		timestamp;
cd_categoria_conv_w	varchar(10);



BEGIN

select 	max(nr_atendimento),
	max(nr_seq_agenda),
	max(nr_seq_autor_conv),
	nm_usuario_autorizacao,
	ie_estagio_autor,
	dt_liberacao
into STRICT	nr_atendimento_w,
	nr_seq_agenda_w,
	nr_seq_autor_conv_w,
	nm_usuario_autorizacao_w,
	ie_estagio_autor_w,
	dt_liberacao_w
from 	autorizacao_cirurgia
where	nr_sequencia	= nr_sequencia_p
GROUP BY nm_usuario_autorizacao,ie_estagio_autor,dt_liberacao;

if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	select	max(b.cd_convenio),
		max(b.cd_usuario_convenio),
		max(b.cd_categoria)
	into STRICT	cd_convenio_w,
		cd_usuario_convenio_w,
		cd_categoria_conv_w
	from	atend_categoria_convenio b,
		atendimento_paciente a
	where	a.nr_atendimento	= b.nr_atendimento
	and	b.nr_atendimento	= nr_atendimento_w
	and	a.nr_atendimento	= nr_atendimento_w
	and	b.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento);
elsif (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') then
	select 	max(a.cd_convenio),
		max(a.cd_usuario_convenio),
		max(a.cd_categoria)
	into STRICT	cd_convenio_w,
		cd_usuario_convenio_w,
		cd_categoria_conv_w
	from 	agenda_paciente a
	where	a.nr_sequencia		= nr_seq_agenda_w;
elsif (nr_seq_autor_conv_w IS NOT NULL AND nr_seq_autor_conv_w::text <> '') then
	select	max(a.cd_convenio),
		max(b.cd_usuario_convenio),
		max(b.cd_categoria)
	into STRICT	cd_convenio_w,
		cd_usuario_convenio_w,
		cd_categoria_conv_w
	from	autorizacao_convenio a,
		autorizacao_convenio_tiss b
	where	a.nr_sequencia		= nr_seq_autor_conv_w
	and	b.nr_sequencia_autor	= a.nr_sequencia;
end if;

if (ie_opcao_p = 'C') then
	ds_retorno_w	:= to_char(cd_convenio_w);
elsif (ie_opcao_p = 'CU') then
	ds_retorno_w	:= cd_usuario_convenio_w;
elsif (ie_opcao_p = 'NM') then
	ds_retorno_w	:= nm_usuario_autorizacao_w;
elsif (ie_opcao_p =   'EG') then
	ds_retorno_w	:= ie_estagio_autor_w;
elsif (ie_opcao_p =	'DL') then
	ds_retorno_w	:= to_char(dt_liberacao_w);
elsif (ie_opcao_p =	'AT') then
	ds_retorno_w	:= to_char(nr_atendimento_w);
elsif (ie_opcao_p =	'NP') then
	select	substr(coalesce(obter_nome_paciente_agenda(a.nr_seq_agenda),obter_dados_atendimento(a.nr_atendimento,'NP')),1,254)
	into STRICT	ds_retorno_w
	from	autorizacao_cirurgia a
	where	nr_sequencia = nr_sequencia_p;	
elsif (ie_opcao_p =	'CC')  then
	ds_retorno_w	:= cd_categoria_conv_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_autor_cirurgia ( nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

