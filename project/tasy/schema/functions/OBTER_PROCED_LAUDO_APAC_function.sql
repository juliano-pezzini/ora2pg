-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_proced_laudo_apac (nr_seq_interno_p bigint) RETURNS varchar AS $body$
DECLARE

 
cd_procedimento_w	bigint;
ds_procedimento_w	PROCEDIMENTO.DS_PROCEDIMENTO%type;
ds_via_tratamento_w	varchar(20);
ds_retorno_w		varchar(2000);
ie_via_it_w		varchar(1);
ie_via_iv_w		varchar(1);
ie_via_sc_w		varchar(1);
ie_via_im_w		varchar(1);
ie_via_vo_w		varchar(1);
ie_via_ives_w		varchar(1);
ie_via_outros_w		varchar(1);

C01 CURSOR FOR 
	SELECT	cd_procedimento, 
		substr(obter_descricao_procedimento(cd_procedimento,ie_origem_proced),1,240), 
		substr(obter_valor_dominio(1249,ie_via_tratamento),1,20) 
	from	sus_laudo_proced_adic 
	where	nr_seq_laudo	= nr_seq_interno_p;


BEGIN 
 
select	cd_procedimento_solic, 
	substr(obter_descricao_procedimento(cd_procedimento_solic,ie_origem_proced),1,255), 
	ie_via_it, 
	ie_via_iv, 
	ie_via_sc, 
	ie_via_im, 
	ie_via_vo, 
	ie_via_ives, 
	ie_via_outros 
into STRICT	cd_procedimento_w, 
	ds_procedimento_w, 
	ie_via_it_w, 
	ie_via_iv_w, 
	ie_via_sc_w, 
	ie_via_im_w, 
	ie_via_vo_w, 
	ie_via_ives_w, 
	ie_via_outros_W 
from	sus_laudo_paciente 
where	nr_seq_interno	= nr_seq_interno_p;
 
ds_retorno_w	:= cd_procedimento_w ||' Via(s): ';
 
if (ie_via_it_w	= 'S') then 
	ds_retorno_w	:= ds_retorno_w	||'IT, ';
end if;	
 
if (ie_via_iv_w 	= 'S') then 
	ds_retorno_w	:= ds_retorno_w	||'IV, ';
end if;	
 
if (ie_via_sc_w 	= 'S') then 
	ds_retorno_w	:= ds_retorno_w	||'SC, ';
end if;	
 
if (ie_via_im_w 	= 'S') then 
	ds_retorno_w	:= ds_retorno_w	||'IM, ';
end if;	
 
if (ie_via_vo_w 	= 'S') then 
	ds_retorno_w	:= ds_retorno_w	||'VO, ';
end if;	
 
if (ie_via_ives_w 	= 'S') then 
	ds_retorno_w	:= ds_retorno_w	||'IVES, ';
end if;	
 
if (ie_via_outros_w = 'S') then 
	ds_retorno_w	:= ds_retorno_w	||'Outros, ';
end if;	
 
OPEN C01;
LOOP 
FETCH C01 into	cd_procedimento_w, 
		ds_procedimento_w, 
		ds_via_tratamento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	if (ds_via_tratamento_w IS NOT NULL AND ds_via_tratamento_w::text <> '') then 
		ds_retorno_w	:= ds_retorno_w ||'    -    '|| cd_procedimento_w ||' Via: '||ds_via_tratamento_w;
	else 
		ds_retorno_w	:= ds_retorno_w ||'    -    '|| cd_procedimento_w;
	end if;
END LOOP;
CLOSE C01;
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_proced_laudo_apac (nr_seq_interno_p bigint) FROM PUBLIC;

