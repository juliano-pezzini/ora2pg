-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sus_obter_fpo ( cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_vigencia_p timestamp, ie_tipo_p bigint) RETURNS bigint AS $body$
DECLARE


/* IE_TIPO_P
	1 - Fisico
	2 - Orcamentario
	3 - Sequencia
*/
cd_subgrupo_bpa_w	bigint;
cd_grupo_bpa_w		bigint;
qt_fisico_w		bigint;
vl_orcamentario_w	double precision;
ds_retorno_w		double precision;
nr_sequencia_w		bigint;


C01 CURSOR FOR
SELECT	qt_fisico,
	vl_orcamentario,
	nr_sequencia
from	sus_fpo_bpa
where	ie_origem_proced		= ie_origem_proced_p
and	((coalesce(cd_procedimento::text, '') = '')	or (cd_procedimento = cd_procedimento_p))
and	((coalesce(cd_subgrupo_bpa::text, '') = '') 	or (cd_subgrupo_bpa = cd_subgrupo_bpa_w))
and	((coalesce(cd_grupo_bpa::text, '') = '') 	or (cd_grupo_bpa = cd_grupo_bpa_w))
and	dt_vigencia_p 			>= dt_competencia
order by
	coalesce(cd_procedimento,0),
	coalesce(cd_subgrupo_bpa,0),
	coalesce(cd_grupo_bpa,0);



BEGIN

/* Obtera estrutura BPA */

begin
select	cd_subgrupo_bpa,
	cd_grupo_bpa
into STRICT	cd_subgrupo_bpa_w,
	cd_grupo_bpa_w
from	sus_estrutura_bpa_v
where	cd_procedimento		= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_p;
exception
	when others then
	cd_subgrupo_bpa_w	:= null;
	cd_grupo_bpa_w 		:= null;
end;

OPEN C01;
LOOP
FETCH C01 into
	qt_fisico_w,
	vl_orcamentario_w,
	nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
	if (ie_tipo_p	= 1) then
		ds_retorno_w	:= qt_fisico_w;
	elsif (ie_tipo_p	= 2) then
		ds_retorno_w	:= vl_orcamentario_w;
	elsif (ie_tipo_p	= 3) then
		ds_retorno_w	:= nr_sequencia_w;
	end if;
	END;
END LOOP;
CLOSE C01;

return	ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sus_obter_fpo ( cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_vigencia_p timestamp, ie_tipo_p bigint) FROM PUBLIC;

