-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ds_status_result_exame ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) RETURNS varchar AS $body$
DECLARE

				  
/** 
 	Retorna a descricao do status do exame 
	 - Se o exame estiver bloqueado será mostrado como processando 
	 - Senão será verificado conforme o parâmetro ie_status_internet da Lab_Parametro 
*/
 
 
ds_status_w		varchar(15);
ie_status_atend_w	smallint;
ie_status_internet_w	smallint;
ie_restringe_result_w	varchar(1);
ie_status_particular_w 	varchar(1);
ie_status_convenio_w 	varchar(1);
ie_status_w		varchar(1);
qt_item_prescr_w	integer;
ie_liberado_regra_w	varchar(1);
cd_convenio_w		bigint;
nr_atendimento_w	bigint;
nr_seq_exame_w		bigint;
nr_seq_grupo_w		bigint;	
ie_tipo_atendimento_w	smallint;
nr_prescricao_w		prescr_procedimento.nr_prescricao%type;
nr_seq_prescr_w		prescr_procedimento.nr_sequencia%type;


BEGIN 
 
select 	count(*) 
into STRICT	qt_item_prescr_w 
from	prescr_procedimento 
where	nr_prescricao 	= nr_prescricao_p 
and	nr_sequencia	= nr_sequencia_p;
 
if (nr_sequencia_p = 0) and (qt_item_prescr_w = 0)	then 
	ds_status_w := wheb_mensagem_pck.get_texto(308934); -- Processando 
elsif (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
 
	ie_restringe_result_w :=  obter_se_exame_bloqueado(nr_sequencia_p, nr_prescricao_p);
 
	if ( ie_restringe_result_w = 'S' ) then 
		ds_status_w := wheb_mensagem_pck.get_texto(308934); -- Processando 
	else
		-- buscar o status para liberacao do exame na internet 
     	ie_status_internet_w := obter_valor_param_usuario(80,6,Obter_Perfil_ativo,nm_usuario_p,cd_estabelecimento_p);
 
		select	coalesce(max(b.ie_status_atend),0) 
		into STRICT  	ie_status_atend_w 
		from  	prescr_medica c, 
			prescr_procedimento b 
		where	b.nr_prescricao		= c.nr_prescricao 
		and	b.nr_prescricao		= nr_prescricao_p 
		and	b.nr_sequencia		= nr_sequencia_p 
		and	b.ie_status_atend	>= ie_status_internet_w;
 
  		if ( ie_status_atend_w <> 0 ) then 
		 
		  	ds_status_w := wheb_mensagem_pck.get_texto(308935); -- Liberado 
			 
			--OS 160485 verificar se tiver convenio, liberar somente se possuir a guia e se for particular se estiver pago 
			ie_status_particular_w 	:= obter_valor_param_usuario(80,16,Obter_Perfil_ativo,nm_usuario_p,cd_estabelecimento_p);
			ie_status_convenio_w 	:= obter_valor_param_usuario(80,17,Obter_Perfil_ativo,nm_usuario_p,cd_estabelecimento_p);
		 
			if ( ie_status_particular_w = 'S') then 
				ie_status_w	:= obter_prescr_part_fat(nr_prescricao_p);
				if ( ie_status_w = 'S') then 
					ds_status_w := wheb_mensagem_pck.get_texto(308934); -- Processando 
				end if;
			end if;
				 
			if(ie_status_convenio_w = 'S' AND ie_status_w = 'N') then 
				ie_status_w	:= obter_prescr_guia_conv(nr_prescricao_p);
				if ( ie_status_w = 'S') then 
					ds_status_w := wheb_mensagem_pck.get_texto(308934); -- Processando 
				end if;
			end if;
			 
			 
			 
			select	max(a.nr_atendimento), 
				max(b.ie_tipo_atendimento) 
			into STRICT	nr_atendimento_w, 
				ie_tipo_atendimento_w 
			from	prescr_medica a, 
				atendimento_paciente b 
			where	a.nr_atendimento = b.nr_atendimento 
			and	a.nr_prescricao = nr_prescricao_p;
			 
			cd_convenio_w	:= obter_convenio_atendimento(nr_atendimento_w);	
			 
			select	max(p.nr_seq_exame), 
				max(e.nr_seq_grupo), 
				max(p.nr_prescricao), 
				max(p.nr_sequencia) 
			into STRICT	nr_seq_exame_w, 
				nr_seq_grupo_w, 
				nr_prescricao_w, 
				nr_seq_prescr_w 
			from	prescr_procedimento p, 
				exame_laboratorio e 
			where	p.nr_prescricao 	= nr_prescricao_p 
			and	p.nr_sequencia		= nr_sequencia_p 
			and	p.nr_seq_exame		= e.nr_seq_exame;
			 
						 
			if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then 
			 
				ie_liberado_regra_w := obter_se_regra_visual_exame(Obter_Perfil_ativo, cd_convenio_w, nr_seq_exame_w, nr_seq_grupo_w, ie_tipo_atendimento_w, nr_prescricao_w, nr_seq_prescr_w);
				 
				if (ie_liberado_regra_w = 'N') then 
					ds_status_w := wheb_mensagem_pck.get_texto(308934); -- Processando 
				end if;
				 
			end if;
			 
			 
		else 
			ds_status_w := wheb_mensagem_pck.get_texto(308934); -- Processando 
		end if;
	end if;
end if;
 
RETURN ds_status_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ds_status_result_exame ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

