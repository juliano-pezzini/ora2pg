-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_parametros_sla ( nr_seq_ordem_serv_p bigint, cd_estabelecimento_p bigint, ie_opcao_p text ) RETURNS bigint AS $body$
DECLARE


    qt_minutos_w               bigint;
    qt_min_comercial_w         bigint;
    qt_min_corrido_w           bigint;
    qt_min_termino_regra_w     man_sla_regra.qt_min_termino%type;
    qt_min_inicio_regra_w      man_sla_regra.qt_min_inicio%type;
    ie_tempo_regra_w           man_sla_regra.ie_tempo%type;
    ie_tempo_termino_regra_w   man_sla_regra.ie_tempo_termino%type;
    ie_tipo_sla_w              man_sla_regra.ie_tipo_sla%type;
    ie_tipo_sla_termino_w      man_sla_regra.ie_tipo_sla%type;
    dt_termino_prev_w          timestamp;
    qt_resposta_w              bigint := 0;
	dt_ini_atendimento_w	   timestamp := null;
	dt_ordem_servico_w		   timestamp	:= null;
	qt_minutos_subtrair_w	   bigint := 0;

/*
  ie_opcao_p

  QMR  = qt minutos primeira resposta
  QMS  = qt minutos solucao

  QTRR   = qt minutos restante ate a primeira resposta
  QTRS   = qt minutos restante ate a solucao

  RE  = Verificar se a os ja foi respondida. Nao significa que o atendimento foi iniciado. 
		Atendimento iniciado e quando sai do primeiro estagio de "aguardando triagem" para qualquer outro estagio de execucao

  TIPOSLA  = Retorma o tipo de sla
*/
BEGIN
    if (nr_seq_ordem_serv_p IS NOT NULL AND nr_seq_ordem_serv_p::text <> '') then
	begin

		-- obter regras de SLA
		select  msr.qt_min_inicio,
				msr.qt_min_termino,
				msr.ie_tempo,
				msr.ie_tempo_termino,
				msr.ie_tipo_sla,
				msr.ie_tipo_sla_termino,
				mos.dt_ordem_servico
		into STRICT	qt_min_inicio_regra_w,
				qt_min_termino_regra_w,
				ie_tempo_regra_w,
				ie_tempo_termino_regra_w,
				ie_tipo_sla_w,
				ie_tipo_sla_termino_w,
				dt_ordem_servico_w
		from    man_sla                ms,
				man_sla_regra          msr,
				man_sla_loc            msl,
				man_localizacao        ml,
				man_ordem_servico      mos
		where   ms.ie_situacao = 'A'
		and     ms.nr_sequencia = msr.nr_seq_sla
		and     msr.nr_seq_sla = msl.nr_seq_sla
		and     ml.nr_sequencia = msl.nr_seq_local
		and     msr.ie_prioridade = mos.ie_prioridade /*filtro prioridade da os = prioridade do cadastro de sla*/
		and     msr.ie_classificacao = mos.ie_classificacao /*filtro classificacao da os = classificacao do cadastro de sla*/
		and     mos.nr_seq_localizacao = ml.nr_sequencia
		and     mos.nr_sequencia = nr_seq_ordem_serv_p;

		-- obter minutos da OS 
		select  qt_min_comercial,
				round(((clock_timestamp() - dt_ordem_servico) * 1440)) qt_min_corrido
		into STRICT	qt_min_comercial_w,
				qt_min_corrido_w
		from (
				SELECT  sum(    man_obter_tempo_com(cd_estabelecimento_p, a.dt_atualizacao, coalesce((
						SELECT
							min(x.dt_atualizacao)
						from
							man_ordem_serv_estagio x
						where
							x.nr_seq_ordem = a.nr_seq_ordem
							and x.nr_sequencia > a.nr_sequencia
						), clock_timestamp()), 'MC')
					)
					qt_min_comercial,
					dt_ordem_servico
					
				from
					man_ordem_serv_estagio a,
					man_ordem_servico b
				where   1=1
				and     a.nr_seq_ordem = b.nr_sequencia
				and     a.nr_seq_ordem = nr_seq_ordem_serv_p
				and     a.nr_seq_estagio not in (2, 261, 1511, 1902, 1341, 511, 9, 121, 41, 2231, 562)
				group by dt_ordem_servico
		) alias11;
		
		-- obter data primeiro inicio atendimento
		select  min(mose1.dt_atualizacao) dt_ini_atendimento
		into STRICT	dt_ini_atendimento_w
		from    man_estagio_processo mep1,
				man_ordem_serv_estagio mose1
		where   mose1.nr_seq_ordem		= nr_seq_ordem_serv_p
		and     mep1.ie_aguarda_cliente = 'N'
		and     mep1.nr_sequencia		= mose1.nr_seq_estagio
		and     mose1.nr_sequencia		=
				(
					SELECT  min(mose.nr_sequencia)
					from    man_ordem_serv_estagio mose
					where   mose.nr_seq_ordem = mose1.nr_seq_ordem
							/* desconsidera estagios iniciais da abertura da OS
							231  Aguardando Triagem
							1712  Aguardando Triagem (Customizacao)
							1051  Desenv aguardando triagem
							1731  Tec aguardando triagem
							*/
					and     mose.nr_seq_estagio not in (231, 1712, 1051, 1731)
				);

		if ( ie_opcao_p = 'QTRR' ) then
		
			-- se horario comercial
			if ie_tempo_regra_w = 'COM' then
				qt_minutos_subtrair_w := qt_min_comercial_w;
			else  -- se 24x7
				qt_minutos_subtrair_w := qt_min_corrido_w;
			end if;

			-- se o atendimento ainda nao foi iniciado
			if coalesce(dt_ini_atendimento_w::text, '') = '' then
				qt_minutos_w := qt_min_inicio_regra_w - qt_minutos_subtrair_w;
			else
				qt_minutos_w := qt_min_inicio_regra_w - round((dt_ini_atendimento_w - dt_ordem_servico_w) * 1440);
			end if;
		
		end if;
		
		
		if ( ie_opcao_p = 'QTRS' ) then
			
			-- se horario comercial
			if ie_tempo_termino_regra_w = 'COM' then
				qt_minutos_subtrair_w := qt_min_comercial_w;
			else -- se 24x7
				qt_minutos_subtrair_w := qt_min_corrido_w;
			end if;

			qt_minutos_w := qt_min_termino_regra_w - qt_minutos_subtrair_w;
		
		end if;

		if ( ie_opcao_p = 'QMR' ) then
			qt_minutos_w := qt_min_inicio_regra_w;
		end if;
		
		if ( ie_opcao_p = 'QMS' ) then
			qt_minutos_w := qt_min_termino_regra_w;
		end if;
		
		if ( ie_opcao_p = 'RE' ) then
			select
				count(*)
			into STRICT qt_resposta_w
			from
				man_ordem_serv_tecnico x
			where
				x.nr_seq_tipo = 1 -- so relevant informartion
				and ie_origem = 'I'
				and x.nr_seq_ordem_serv = nr_seq_ordem_serv_p;

			qt_minutos_w := qt_resposta_w;
		end if;

		if (ie_opcao_p = 'TIPOSLA') then
			-- se tipo sla inicio OU tipo sla termino igual contrato com multa
			if (ie_tipo_sla_w = 1 or ie_tipo_sla_termino_w = 1) then
				return 1; -- contrato com multa

			-- se tipo sla inicio igual contrato sem multa E tipo sla termino igual contrato sem multa ou sem contrato
			elsif (ie_tipo_sla_w = 2 and (ie_tipo_sla_termino_w in (2,3))) then
				return 2; -- contrato sem multa

			-- se tipo sla inicio igual sem contrato E tipo sla termino igual sem contrato
			elsif (ie_tipo_sla_w = 3 and ie_tipo_sla_termino_w = 3) then
				return 3; -- sem contrato
			end if;
		end if;
	
	  
        exception
            when others then
                qt_minutos_w := 0;
        end;
    end if;

    return qt_minutos_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_parametros_sla ( nr_seq_ordem_serv_p bigint, cd_estabelecimento_p bigint, ie_opcao_p text ) FROM PUBLIC;

