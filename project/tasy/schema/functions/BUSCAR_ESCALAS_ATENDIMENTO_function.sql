-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION buscar_escalas_atendimento (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


    c_busca_escalas CURSOR FOR
        SELECT aux.nr_sel,
               aux.qt_pontuacao,
               aux.ds_resultado
        from(SELECT '1' as nr_sel,
                    qt_pontuacao,
                    subStr(Obter_desc_escala_morse(qt_pontuacao), 1, 20) as ds_resultado
            from    escala_morse
            where   nr_atendimento = nr_atendimento_p
            and     nr_sequencia = (select  max(nr_sequencia)
                                    from    escala_morse
                                    where   nr_atendimento = nr_atendimento_p)

union

            select  '2' as nr_sel,
                    qt_score,
                    subStr(obter_desc_escala_stratify(qt_score), 1, 100) as ds_resultado
            from    escala_stratify
            where   nr_atendimento = nr_atendimento_p
            and     nr_sequencia = (select  max(nr_sequencia)
                                    from    escala_stratify
                                    where   nr_atendimento = nr_atendimento_p)
            
union

            select  '3' as nr_sel,
                    qt_pontuacao,
                    subStr(obter_descr_escala_earq(qt_pontuacao), 1, 255) as ds_resultado
            from    escala_earq
            where   nr_atendimento = nr_atendimento_p
            and     nr_sequencia = (select  max(nr_sequencia)
                                    from    escala_earq
                                    where   nr_atendimento = nr_atendimento_p)
            
union

            select  '4' as nr_sel,
                    qt_pontuacao,
                    subStr(obter_resultado_jh_frat(qt_pontuacao), 1, 255) as ds_resultado
            from    escala_frat
            where   nr_atendimento = nr_atendimento_p
            and     nr_sequencia = (select  max(nr_sequencia)
                                    from    escala_frat
                                    where   nr_atendimento = nr_atendimento_p)
            
union

            select  '5' as nr_sel,
                    qt_pontuacao,
                    subStr(obter_descr_escala_downton(qt_pontuacao), 1, 255) as ds_resultado
            from    escala_downton
            where   nr_atendimento = nr_atendimento_p
            and     nr_sequencia = (select  max(nr_sequencia)
                                    from    escala_downton
                                    where   nr_atendimento = nr_atendimento_p) ) aux
            order by 1;

    wDsRetorno varchar(1000) := NULL;
BEGIN
    for	r_busca_escalas in c_busca_escalas loop
	if (r_busca_escalas.nr_sel = 1) then -- Morse
            wDsRetorno :=  wDsRetorno ||'1M'||' - '||r_busca_escalas.ds_resultado || chr(13) || chr(10);
        elsif (r_busca_escalas.nr_sel = 2) then -- Stratify
            wDsRetorno :=  wDsRetorno ||'2S'||' - '||r_busca_escalas.ds_resultado || chr(13) || chr(10);
        elsif (r_busca_escalas.nr_sel = 3) then -- EARQ
            wDsRetorno :=  wDsRetorno ||'3E'||' - '||r_busca_escalas.ds_resultado || chr(13) || chr(10);
        elsif (r_busca_escalas.nr_sel = 4) then -- Johns Hopinks - JH - FRAT
            wDsRetorno :=  wDsRetorno ||'4J'||' - '||r_busca_escalas.ds_resultado || chr(13) || chr(10);
        elsif (r_busca_escalas.nr_sel = 5) then -- Downton
            wDsRetorno :=  wDsRetorno ||'5D'||' - '||r_busca_escalas.ds_resultado || chr(13) || chr(10);
        end if;
	end loop;

    return wDsRetorno;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION buscar_escalas_atendimento (nr_atendimento_p bigint) FROM PUBLIC;

