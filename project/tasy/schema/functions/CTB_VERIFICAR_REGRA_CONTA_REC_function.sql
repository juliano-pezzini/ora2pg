-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_verificar_regra_conta_rec (cd_tipo_lote_contabil_p template_regra_lt_contabil.cd_tipo_lote_contabil%type, nm_controle_p regras_tipo_lote_contabil.nm_controle%type, vl_controle_p regras_tipo_lote_contabil.cd_regra%type) RETURNS varchar AS $body$
DECLARE


cd_regra_w	regras_tipo_lote_contabil.cd_regra%type;
nm_controle_w	regras_tipo_lote_contabil.nm_controle%type;
ds_prefixo_w	regras_tipo_lote_contabil.ds_prefixo%type;
qt_regra_w      bigint;

c00 CURSOR FOR
    SELECT 	cd_regra,
		nm_controle,
		ds_prefixo
    from 	regras_tipo_lote_contabil
    where 	cd_tipo_lote_contabil = cd_tipo_lote_contabil_p;
BEGIN

select 	count(1)
into STRICT    qt_regra_w
from 	template_regra_lt_contabil
where 	cd_tipo_lote_contabil = cd_tipo_lote_contabil_p;

for regra in c00 loop
	for i in 1..qt_regra_w loop
		nm_controle_w := trim(both regexp_substr(replace(regra.nm_controle, ',', ', '),'[^,]+', 2, i));
		cd_regra_w := trim(both regexp_substr(replace(regra.cd_regra, '-', '- '),'[^-]+', 2, i));
		if (nm_controle_w <> ' ' and cd_regra_w <> ' ' ) then
			if (nm_controle_w = trim(both regexp_substr(replace(nm_controle_p, ',', ', '),'[^,]+', 2, i))
				and cd_regra_w <> trim(both regexp_substr(replace(vl_controle_p, ',', ', '),'[^,]+', 2, i))) then
				return ' ';
			end if;
		end if;
	end loop;
	ds_prefixo_w := regra.ds_prefixo;
end loop;

return ds_prefixo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_verificar_regra_conta_rec (cd_tipo_lote_contabil_p template_regra_lt_contabil.cd_tipo_lote_contabil%type, nm_controle_p regras_tipo_lote_contabil.nm_controle%type, vl_controle_p regras_tipo_lote_contabil.cd_regra%type) FROM PUBLIC;

