-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_material_estab ( cd_material_p bigint, cd_estabelecimento_p bigint, ie_tipo_dado_p text) RETURNS varchar AS $body$
DECLARE



/* campos para retorno (ie_tipo_dado_p)
CO	- ie_controlado_w
RA	- nr_registro_anvisa_w
VA	- dt_validade_reg_anvisa
RPA	- nr_protocolo_anvisa_w
VPA	- dt_validade_prot_anvisa_w
CU	- Custo
MC	- Codigo do material conta
RQ	- ie_requisicao
QC	- QT_CONSUMO_MENSAL
UMC	- Unidade Medida Compra
UME	- Unidade Medida Estoque
UMS	- Unidade Medida Consumo
CSA         - Codigo Sistema Anterior
QCE	- Conversao Compra X Estoque
QEC	- Conversao Estoque X Consumo
KIT	- Kit material
TC	- Tipo do consignado
PD	- Padronizado
BE	- Baixa estoque
PR                 - Permite prescrever
VI	- Vigente Anvisa
*/
ds_retorno_w			varchar(255);
qt_reg_w				bigint;
ie_controlado_w			varchar(1);
nr_registro_anvisa_w		varchar(60);
ie_classif_custo_w			varchar(1);
cd_material_conta_w		integer;
ie_requisicao_w			varchar(1);
qt_consumo_mensal_w		double precision;
dt_validade_reg_anvisa_w		timestamp;
nr_protocolo_anvisa_w		varchar(60);
dt_validade_prot_anvisa_w		timestamp;
cd_unidade_medida_compra_w	varchar(30);
cd_unidade_medida_estoque_w	varchar(30);
cd_unidade_medida_consumo_w	varchar(30);
cd_sistema_ant_w			varchar(20);
qt_conv_compra_estoque_w		double precision;
qt_conv_estoque_consumo_w	double precision;
nr_minimo_cotacao_w		smallint;
cd_kit_material_w		integer;
ie_prescricao_w			varchar(10)	:= 'S';
ie_tipo_consignado_w		varchar(15);
ie_padronizado_w		varchar(1);
ie_baixa_estoque_w		varchar(1);
ie_permite_prescrever_w		varchar(1) 	:= 'S';
ie_vigente_anvisa_w		material_estab.ie_vigente_anvisa%type;
sql_w                   varchar(200);


BEGIN

begin
select	a.nr_registro_anvisa,
	a.ie_classif_custo,
	a.cd_material_conta,
	a.ie_requisicao,
	a.qt_consumo_mensal,
	a.dt_validade_reg_anvisa,
	a.nr_protocolo_anvisa,
	a.dt_validade_prot_anvisa,
	a.nr_minimo_cotacao,
	a.cd_kit_material,
	a.ie_prescricao,
	a.ie_tipo_consignado,
	a.ie_padronizado,
	a.ie_baixa_estoq_pac,
	b.cd_unidade_medida_compra,
	b.cd_unidade_medida_estoque,
	b.cd_unidade_medida_consumo,
	coalesce(a.cd_sistema_ant, b.cd_sistema_ant),
	b.qt_conv_compra_estoque,
	b.qt_conv_estoque_consumo,
	coalesce(a.ie_prescricao, 'S'),
	coalesce(ie_vigente_anvisa,'N')
into STRICT	nr_registro_anvisa_w,
	ie_classif_custo_w,
	cd_material_conta_w,
	ie_requisicao_w,
	qt_consumo_mensal_w,
	dt_validade_reg_anvisa_w,
	nr_protocolo_anvisa_w,
	dt_validade_prot_anvisa_w,
	nr_minimo_cotacao_w,
	cd_kit_material_w,
	ie_prescricao_w,
	ie_tipo_consignado_w,
	ie_padronizado_w,
	ie_baixa_estoque_w,
	cd_unidade_medida_compra_w,
	cd_unidade_medida_estoque_w,
	cd_unidade_medida_consumo_w,
	cd_sistema_ant_w,
	qt_conv_compra_estoque_w,
	qt_conv_estoque_consumo_w,
	ie_permite_prescrever_w,
	ie_vigente_anvisa_w
from	material_estab a,
	material b
where	b.cd_material	= a.cd_material
and	a.cd_material	= cd_material_p
and	a.cd_estabelecimento = cd_estabelecimento_p;	
exception
when others then
	begin
	select	coalesce(qt_conv_compra_estoque,1),
		coalesce(qt_conv_estoque_consumo,1),
		cd_unidade_medida_compra,
		cd_unidade_medida_estoque,
		cd_unidade_medida_consumo,
		cd_sistema_ant
	into STRICT	qt_conv_compra_estoque_w,
		qt_conv_estoque_consumo_w,
		cd_unidade_medida_compra_w,
		cd_unidade_medida_estoque_w,
		cd_unidade_medida_consumo_w,
		cd_sistema_ant_w
	from	material
	where	cd_material = cd_material_p;	
	exception
	when others then
		null;
	end;
end;



        BEGIN
            sql_w := 'CALL OBTER_RET_DADOS_MAT_ESTAB_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16,
                      :17, :18, :19, :20, :21, :22, :23, :24) INTO :ds_retorno_w';
            EXECUTE sql_w
                USING IN ie_tipo_dado_p, IN cd_material_p, IN nr_registro_anvisa_w, IN ie_classif_custo_w,
                      IN cd_material_conta_w, IN ie_requisicao_w, IN qt_consumo_mensal_w, IN dt_validade_reg_anvisa_w, IN nr_protocolo_anvisa_w, 
                      IN dt_validade_prot_anvisa_w, IN cd_unidade_medida_compra_w, IN cd_unidade_medida_estoque_w, IN cd_unidade_medida_consumo_w, IN cd_sistema_ant_w, 
                      IN qt_conv_compra_estoque_w, IN qt_conv_estoque_consumo_w, IN nr_minimo_cotacao_w, IN cd_kit_material_w, IN ie_prescricao_w, 
                      IN ie_tipo_consignado_w, IN ie_padronizado_w, IN ie_baixa_estoque_w, IN ie_permite_prescrever_w, IN ie_vigente_anvisa_w, 
                      OUT ds_retorno_w;

        EXCEPTION
            WHEN OTHERS THEN
                ds_retorno_w := NULL;
        END;

RETURN ds_retorno_w;



END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_material_estab ( cd_material_p bigint, cd_estabelecimento_p bigint, ie_tipo_dado_p text) FROM PUBLIC;

