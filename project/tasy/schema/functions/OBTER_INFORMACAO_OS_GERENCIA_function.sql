-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_informacao_os_gerencia (dt_parametro_p timestamp, nr_seq_gerencia_p bigint, ie_tipo_inf_p text, ie_tipo_valor_p text, ie_area_gerencia_p text default 'DES,TEC') RETURNS bigint AS $body$
DECLARE


/*
ie_tipo_inf_p
QT - Quantidade total de OS no mes (Desenvolvimento, Tecnologia e Suporte)
QTD - Quantidade de OS's que passaram pelo desenvolvimento e tecnologia. OS's recebidas.
QTDFP - Quantidade de OS's que passaram pelo desenvolvimento e tecnologia fora Projeto.
QTDPRJ - Quantidade de OS's que passaram pelo desenvolvimento e tecnologia vinculadas a Projeto.
QTDPP - Quantidade de OS's que passaram pelo desenvolvimento por produto.
ER - Quantidade total de defeitos no mes
ERI- Quantidade de erros identificados internamente na wheb
ERE-Quantidade de erros identificados externamente pelo cliente
QTI - Quantidade total de Insatisfacao no mes
QTICLI - Quantidade total de Insatisfacao no mes. Somente OS's de Cliente.
PRI - Percentual de insatisfacao. OS's de cliente e internas
PRICLI - Percentual de insatisfacao sobre OS's de cliente
EN - Quantidade total de OS encerrada
ENCPF - Quantidade de OS encerrada por pessoa
ENS - Quantidade total de OS encerrada com satisfacao
ENSCLI - Quantidade total de OS de cliente encerrada com satisfacao
PR - Percentual de defeitos no mes
PRIN- Percentual de erro no mes identificados internamente na Philips
PRDJAVA - Percentual de defeitos identificados pela Philips e pelos clientes, relacionados a linguagem Java
PRDDELPHI - Percentual de defeitos identificados pela Philips e pelos clientes, relacionados a linguagem Delphi
PRDJVCLI - Percentual de defeitos java identificados pelos clientes
PRDJVPHI - Percentual de defeitos Java identificados pela Philips
PRDDECLI - Percentual de defeitos Delphi identificados pelos clientes
PRDDEPHI - Percentual de defeitos Delphi identificados pela Philips
PRD - Percentual de defeitos no mes, considerando apenas as OS's que passaram pelo desenvolvimento e tecnologia
PRIND - Percentual de erro no mes identificados internamente na Philips, considerando apenas as OS's que passaram pelo desenvolvimento e tecnologia
PRPP - Percentual de defeitos por produto, considerando apenas as OS's que passaram pelo desenvolvimento e tecnologia
PRSEV - Percentual de defeitos por severidade, considerando apenas as OS's que passaram pelo desenvolvimento e tecnologia
PRDSEV - Percentual dos defeitos por severidade.
PREX- Percentual de erro no mes identificados externamente pelos clientes
PREXD - Percentual de defeitos identificados pelos clientes, com base somente nas OS's que passaram pelo desenv e tecnologia
PRJIN - Percentual de erros internos de migracao - Java
PRINSJ - Percentual de erros internos sem de migracao - Java
VEVOS - Quantidade de O.Ss de defeito do setor de VeV
TMAC - Tempo medio gasto pelos usuarios de desenvolvimento em ordens de alta complexidade
TMBC - Tempo medio gasto pelos usuarios de desenvolvimento em ordens de baixa complexidade
PRANTIGA - Percental de OS's antigas pendentes no desenvolvimento
QTANTIGA - Quantidade de OS's antigas pendentes no desenvolvimento
QTBACKLOG - Quantidade de OS's pendentes no desenvolvimento no momento.
QTRECCLI - Quantidade de OS's recebidas dos clientes. Fora OS's abertas internamente.
QTRECCLIPLA - Quantidade de OS's recebidas dos clientes por plataforma (Delphi, Java, HTML5). Fora OS's abertas internamente.
QTRECCLIPLAS - Quantidade de OS's de solicitacao recebidas dos clientes por plataforma (Delphi, Java, HTML5). Fora OS's abertas internamente.
QTRECCLIPLAD - Quantidade de OS's de Defeito recebidas dos clientes por plataforma (Delphi, Java, HTML5). Fora OS's abertas internamente.
QTRECCLICLA - Quantidade de OS's recebidas dos clientes. Fora OS's abertas internamente.Por classificacao do cliente. Solicitacao, Defeito, Duvida
QTRECINT - Quantidade de OS's abertas internamente na Philips.
QTBACKCLI - Quantidade de OS's pendentes no desenvolvimento que foram abertas pelos clientes
QTBACKINT - Quantidade de OS's pendentes no desenvolvimento que foram abertas internamente pela Philips.
QTBACKPENDCLI - Quantidade de OS's que passaram pelo desenvolvimento e que no momento estao pendentes com o cliente.
QTBACKPENDVEV - Quantidade de OS's que foram customizadas pelo desenvolvimento e que estao pendentes de testes pelo VeV
PRSLAALLDEF - Percentual de SLA consideranto todos os defeitos
PRSLAOBI - Percentual de SLA consideranto o indicador antigo do BSC.
PRSLAMULTA - Percentual de SLA com contrato e multa.
PRSLASEMMULTA - Percentual de SLA com contrato sem multa.
QTSLA - Quantidade de SLA pendentes no desenvolvimento.
QTSLAD - Quantidade de SLA pendentes no desenvolvimento, desconsiderando regra de sla da "TI - Philips SLA"
QTBACKLOGDEF - Quantidade de defeitos pendentes no desenvolvimento
QTANNE - Quantidade de analistas de negocio
QTANSI - Quantidade de analistas de sistema
QTANMA - Quantidade de analistas de manutencao
QTPROG - Quantidade de programadores
QTESTA - Quantidade de estagiarios
QAUSEN - Quantidade de pessoas ausentes no perido (ferias ou afastamentos atestados por periodo maiores.)
QTHORAOS - Quantidade de horas registradas para encerrar cada ordens de servico no periodo
QTHORAOSPLA - Quantidade de horas registradas para encerrar cada ordens de servico no periodo por plataforma (Delphi, Java, HTML5)
QTHORAOSANAPLA - Quantidade de horas registradas pelos analistas para encerrar cada ordens de servico no periodo por plataforma (Delphi, Java, HTML5)
QTHORAOSPROPLA - Quantidade de horas registradas pelos programadores para encerrar cada ordens de servico no periodo por plataforma (Delphi, Java, HTML5)
QTHORADIA - Quantidade de horas registradas em ordens de servico por dia no periodo
QTHORAOSINT - Quantidade de horas registradas para encerrar cada ordens de servico interna (aberta pela Philips) no periodo
QTHORAOSCLI - Quantidade de horas registradas para encerrar cada ordens de servico externa (aberta pelo cliente) no periodo
QTRECEBDIA - Quantidade de OS's recebidas no dia corrente.
QTRECEBDIACLI - Quantidade de OS's recebidas no dia corrente abertas por clientes
QTRECEBDIAINT - Quantidade de OS's recebidas no dia corrente abertas internamente
QTPESSOA - Quantidade de pessoas no ultimo dia de cada mes no periodo (descontando apenas os gerentes)
QTPFPRODUT - Quantidade de pessoas produtivas no ultimo dia de cada mes descontando gerente, estagiarios e pessoas ausentes.
QTHE - Total de horas extras do grupo no periodo.
MEHEPF - Media de hora extra por pessoa.
QTNET - Quantidade de NET's documentados no periodo.
PRINOV - Percentual de horas trabalhadas em OS's de inovacao que agregam valor ao produto
QTPFDELPHI - Quantidade de pessoas trabalhando em OS de Delphi fora projetos capitalizaveis
QTPFJAVA - Quantidade de pessoas trabalhando em OS de Java fora projetos capitalizaveis
QTPFHTML5 - Quantidade de pessoas trabalhando em OS de HTML5 fora projetos capitalizaveis
QFPFCAP - Quantidade de pessoas trabalhando em OS's vinculadas em projetos capitalizaveis
QTDPLT - Quantidade de OS's que passaram pelo desenvolvimento e tecnologia. OS's recebidas por Plataforma.
QTDCLD - Quantidade de OS's de cliente abertas como defeito pelo cliente
QTDCLDD - Quantidade de OS's de cliente abertas como defeito pelo cliente e reclassificadas para duvida
QTDOR || chr(199) - Quantidade de OS's que foram enviados orcamentos
QTDOR || chr(199) || AP - Quantidade de OS's que foram aprovados orcamentos
*/
qt_total_os_w			double precision;
qt_total_tec_w			double precision := 0;
qt_erro_w			double precision;
qt_retorno_w			double precision;
qt_os_encerrada_w		double precision;
qt_os_encerrada_classif_w	double precision;
qt_min_os_w			double precision;
qt_os_insatisf_w		double precision;
dt_ref_mes_w			timestamp;
dt_fim_mes_w			timestamp;
dt_inicio_w			timestamp;
dt_final_w			timestamp;
qt_os_vev_w			double precision := 0;
qt_os_philips_w			double precision := 0;
qt_pessoas_w			bigint;
ds_sep_bv_w			varchar(30)	:= obter_separador_bv;
qt_dias_util_w			bigint;


BEGIN


dt_ref_mes_w			:= PKG_DATE_UTILS.start_of(dt_parametro_p,'month',0);
dt_fim_mes_w			:= PKG_DATE_UTILS.END_OF(dt_ref_mes_w, 'MONTH', 0);

if (ie_tipo_valor_p	= 'A') then /*Mes corrente*/
	dt_ref_mes_w		:= PKG_DATE_UTILS.ADD_MONTH(PKG_DATE_UTILS.start_of(dt_parametro_p,'month', 0), -11, 0);
	dt_fim_mes_w		:= PKG_DATE_UTILS.start_of(dt_parametro_p,'month',0);
elsif (ie_tipo_valor_p	= 'AC') then /*Ano corrente de 01/01/xxxx ate a data atual*/
	dt_ref_mes_w		:= PKG_DATE_UTILS.start_of(dt_parametro_p,'YEAR',0);
	dt_fim_mes_w		:= PKG_DATE_UTILS.END_OF(dt_parametro_p, 'MONTH', 0);
elsif (ie_tipo_valor_p	= 'ACM') then /*Ano corrente de 01/01/xxxx ate o ultimo mes cheio*/
	dt_ref_mes_w		:= PKG_DATE_UTILS.start_of(dt_parametro_p,'YEAR',0);
	dt_fim_mes_w		:= PKG_DATE_UTILS.END_OF(PKG_DATE_UTILS.start_of(dt_parametro_p,'month',0) - 1, 'MONTH', 0);
end if;

if (ie_tipo_inf_p in ('QT','PR','PRIN','PREX','PRJIN','PRINSJ','PRPHI','PRVEV','PRDJAVA','PRDDELPHI','PRDJVCLI','PRDJVPHI','PRDDECLI','PRDDEPHI'))   then

	/*Quantidade de OS recebidas independetente se passou para o Desenvolvimento/Tecnologia*/

	select 	count(distinct nr_sequencia)
	into STRICT	qt_total_os_w
	from	os_recebida_gerencia_v
	where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and      ((nr_seq_gerencia_p = 0) or (NR_SEQ_GERENCIA = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p in ('QTD','PRD','PREXD','PRIND','PRSEV')) then

	/*Quantidade de OS recebidas que passaram pelo Desenvolvimento e Tecnologia*/

	select 	count(distinct nr_sequencia)
	into STRICT	qt_total_os_w
	from	os_recebida_gerencia_desenv_v
	where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and      ((nr_seq_gerencia_p = 0) or (nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p in ('QTDOR' || chr(199))) then

	select 	count(distinct b.nr_seq_ordem)
	into STRICT	qt_total_os_w
	from	os_recebida_gerencia_desenv_v a,
		man_ordem_servico_orc b
	where	b.dt_orcamento between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_sequencia	= b.nr_seq_ordem
	and      ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p in ('QTDOR' || chr(199) || 'AP')) then

	select 	count(distinct b.nr_seq_ordem)
	into STRICT	qt_total_os_w
	from	os_recebida_gerencia_desenv_v a,
		man_ordem_servico_orc b
	where	b.dt_aprovacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_sequencia	= b.nr_seq_ordem
	and      ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p in ('QTDCLD')) then
	
	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	FROM man_ordem_servico b, os_recebida_gerencia_desenv_v a
LEFT OUTER JOIN man_localizacao c ON (a.nr_seq_localizacao = c.nr_sequencia)
WHERE a.nr_sequencia	= b.nr_sequencia and a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w  and coalesce(c.ie_terceiro,'S')	= 'S' and b.ie_classificacao_cliente	= 'E' and ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p in ('QTDCLDD')) then
	
	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	FROM man_ordem_servico b, os_recebida_gerencia_desenv_v a
LEFT OUTER JOIN man_localizacao c ON (a.nr_seq_localizacao = c.nr_sequencia)
WHERE a.nr_sequencia	= b.nr_sequencia and a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w  and coalesce(c.ie_terceiro,'S')	= 'S' and b.ie_classificacao_cliente	= 'E' and b.ie_classificacao		= 'D' and ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));


elsif (ie_tipo_inf_p in ('QTDPLT')) then

	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	from	man_ordem_servico b,
		os_recebida_gerencia_desenv_v a
	where	a.nr_sequencia	= b.nr_sequencia
	and	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	coalesce(b.ie_plataforma,'D')	= ie_tipo_valor_p
	and      ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));	

elsif (ie_tipo_inf_p in ('PRSLAALLDEF')) then

	if (nr_seq_gerencia_p > 0) then
		select pr_atingido SLA_ACHIEVEMENT
		into STRICT	qt_total_os_w
		from table(sla_dashboard_pck.registros_sla_gerencia(dt_ref_mes_w,'ALLDEF')) a
		where	nr_seq_gerencia_des = nr_seq_gerencia_p;

	else
		select  pr_atingido sla_achievement
		into STRICT	qt_total_os_w
		from	table(sla_dashboard_pck.registros_sla_dashboard(dt_ref_mes_w))
		where	ie_tipo_sla = 'ALLDEF';

	end if;

/*Oficial do BSC */

elsif (ie_tipo_inf_p in ('PRSLAOBI')) then

	if (nr_seq_gerencia_p > 0) then
		select pr_atingido SLA_ACHIEVEMENT
		into STRICT	qt_total_os_w
		from table(sla_dashboard_pck.registros_sla_gerencia(dt_ref_mes_w,'OBI')) a
		where	nr_seq_gerencia_des = nr_seq_gerencia_p;

	else
		select  pr_atingido sla_achievement
		into STRICT	qt_total_os_w
		from	table(sla_dashboard_pck.registros_sla_dashboard(dt_ref_mes_w))
		where	ie_tipo_sla = 'OBI';

	end if;

/*SLA COM contrato com multa */

elsif (ie_tipo_inf_p in ('PRSLAMULTA')) then

	if (nr_seq_gerencia_p > 0) then
		select pr_atingido SLA_ACHIEVEMENT
		into STRICT	qt_total_os_w
		from table(sla_dashboard_pck.registros_sla_gerencia(dt_ref_mes_w,'SWP')) a
		where	nr_seq_gerencia_des = nr_seq_gerencia_p;

	else
		select  pr_atingido sla_achievement
		into STRICT	qt_total_os_w
		from	table(sla_dashboard_pck.registros_sla_dashboard(dt_ref_mes_w))
		where	ie_tipo_sla = 'SWP';

	end if;

/*SLA com contrato sem multa  */

elsif (ie_tipo_inf_p in ('PRSLASEMMULTA')) then

	if (nr_seq_gerencia_p > 0) then
		select pr_atingido SLA_ACHIEVEMENT
		into STRICT	qt_total_os_w
		from table(sla_dashboard_pck.registros_sla_gerencia(dt_ref_mes_w,'SWC')) a
		where	nr_seq_gerencia_des = nr_seq_gerencia_p;

	else
		select  pr_atingido sla_achievement
		into STRICT	qt_total_os_w
		from	table(sla_dashboard_pck.registros_sla_dashboard(dt_ref_mes_w))
		where	ie_tipo_sla = 'SWC';

	end if;

elsif (ie_tipo_inf_p in ('QTDFP')) then

	/*Quantidade de OS recebidas que passaram pelo Desenvolvimento e Tecnologia e que nao estavam vinculadas a projetos*/

	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	from	os_recebida_gerencia_desenv_v a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and      ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	not exists (	SELECT	1
				from	proj_projeto b
				where	b.nr_seq_ordem_serv = a.nr_sequencia
				and	b.ie_origem	= 'D')
	and	not exists (	select	1
				from	proj_projeto c,
					proj_ordem_servico d
				where	d.nr_seq_ordem 	= a.nr_sequencia
				and	c.nr_sequencia	= d.nr_seq_proj
				and	c.ie_origem	= 'D');
elsif (ie_tipo_inf_p in ('QTDPRJ')) then

	/*Quantidade de OS recebidas que passaram pelo Desenvolvimento e Tecnologia e que estavam vinculadas a projetos*/

	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	from	os_recebida_gerencia_desenv_v a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and      ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	exists (SELECT	1
			from	proj_projeto b
			where	b.nr_seq_ordem_serv = a.nr_sequencia
			and	b.ie_origem	= 'D'
			
union

			SELECT	1
			from	proj_projeto c,
				proj_ordem_servico d
			where	d.nr_seq_ordem 	= a.nr_sequencia
			and	c.nr_sequencia	= d.nr_seq_proj
			and	c.ie_origem	= 'D');

elsif (ie_tipo_inf_p in ('QTDPP', 'PRPP')) then

	/*Quantidade de OS's que passaram pelo desenvolvimento por produto*/

	if (UPPER(ie_tipo_valor_p) = 'TASY') then
			select 	count(distinct nr_sequencia)
			into STRICT	qt_total_os_w
			from	os_recebida_gerencia_desenv_v
			where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
			and     nr_seq_gerencia in (3,4,11,60);
		
			select	count(distinct nr_sequencia)
			into STRICT	qt_erro_w
			from	os_erro_gerencia_v
			where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
			and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
			and	nr_seq_gerencia in (3,4,11,60);
			

	elsif (UPPER(ie_tipo_valor_p) = 'OPS') then
			select 	count(distinct nr_sequencia)
			into STRICT	qt_total_os_w
			from	os_recebida_gerencia_desenv_v
			where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
			and     nr_seq_gerencia = 7;

			select	count(distinct nr_sequencia)
			into STRICT	qt_erro_w
			from	os_erro_gerencia_v
			where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
			and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
			and	nr_seq_gerencia = 7;

	elsif (UPPER(ie_tipo_valor_p) = 'MULTIMED') then
			select 	count(distinct nr_sequencia)
			into STRICT	qt_total_os_w
			from	os_recebida_gerencia_desenv_v
			where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
			and     nr_seq_gerencia = 21;

			select	count(distinct nr_sequencia)
			into STRICT	qt_erro_w
			from	os_erro_gerencia_v
			where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
			and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
			and	nr_seq_gerencia = 21;
	end if;
elsif (ie_tipo_inf_p in ('PRANTIGA','QTANTIGA')) then

/*
ie_tipo_valor_p = 'DES' desenvolvimento 'TEC' tecnologia
*/
	if (trunc(clock_timestamp(),'month') = dt_ref_mes_w) then
	
		select	COUNT(*)
		into STRICT	qt_erro_w
		from	man_estagio_processo c,
			grupo_desenvolvimento b,
			man_ordem_servico a
		where	a.nr_seq_grupo_des = b.nr_sequencia
		and	c.nr_sequencia = a.nr_seq_estagio
		and (c.ie_tecnologia = 'S' or c.ie_desenv = 'S')
		and	a.ie_status_ordem <> '3' 
		AND	a.dt_ordem_servico < clock_timestamp() - interval '30 days'
		and	((nr_seq_gerencia_p = 0) or (nr_seq_gerencia = nr_seq_gerencia_p));

	elsif	(ie_tipo_inf_p = ('PRANTIGA')) then
		if (nr_seq_gerencia_p > 0) then
			select	coalesce(max(pr_os_antiga),0)
			into STRICT	qt_erro_w
			from	w_indicador_desenv_apres
			where	nr_seq_gerencia	= nr_seq_gerencia_p
			and	dt_referencia	= trunc(last_day(dt_ref_mes_w))
			and	ie_abrangencia	= 'GER';
		else
			select	coalesce(max(pr_os_antiga),0)
			into STRICT	qt_erro_w
			from	w_indicador_desenv_apres
			where	dt_referencia	= trunc(last_day(dt_ref_mes_w))
			and	ie_abrangencia	= 'AREA'
			and	ie_area_gerencia = ie_tipo_valor_p;
		end if;	
	else
		if (nr_seq_gerencia_p > 0) then
			select	coalesce(max(qt_os_antiga),0)
			into STRICT	qt_erro_w
			from	w_indicador_desenv_apres
			where	nr_seq_gerencia	= nr_seq_gerencia_p
			and	dt_referencia	= trunc(last_day(dt_ref_mes_w))
			and	ie_abrangencia	= 'GER';
		else
			select	coalesce(max(qt_os_antiga),0)
			into STRICT	qt_erro_w
			from	w_indicador_desenv_apres
			where	dt_referencia	= trunc(last_day(dt_ref_mes_w))
			and	ie_abrangencia	= 'AREA'
			and	ie_area_gerencia = ie_tipo_valor_p;
		end if;	
	end if;

elsif (ie_tipo_inf_p = 'ENCPF') then

	if (trunc(last_day(dt_ref_mes_w)) >= trunc(clock_timestamp())) then
		dt_ref_mes_w	:= trunc(clock_timestamp() - interval '1 days');
	else	
		dt_ref_mes_w	:= trunc(last_day(dt_ref_mes_w));
	end if;

	if (nr_seq_gerencia_p > 0) then
		select	coalesce(max(qt_encerrada_pessoa),0)
		into STRICT	qt_total_os_w
		from	w_indicador_desenv_apres
		where	nr_seq_gerencia	= nr_seq_gerencia_p
		and	dt_referencia	= dt_ref_mes_w
		and	ie_abrangencia	= 'GER';
	else
		select	coalesce(max(qt_encerrada_pessoa),0)
		into STRICT	qt_total_os_w
		from	w_indicador_desenv_apres
		where	dt_referencia	= dt_ref_mes_w
		and	ie_abrangencia	= 'AREA'
		and	ie_area_gerencia = ie_tipo_valor_p;
	end if;	

elsif (ie_tipo_inf_p = 'QTRECCLI') then
	
	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	FROM os_recebida_gerencia_desenv_v a
LEFT OUTER JOIN man_localizacao b ON (a.nr_seq_localizacao = b.nr_sequencia)
WHERE a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w  and coalesce(ie_terceiro,'S')	= 'S' and ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));


elsif (ie_tipo_inf_p = 'QTRECCLIPLA') then
	
	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	FROM man_ordem_servico m, os_recebida_gerencia_desenv_v a
LEFT OUTER JOIN man_localizacao b ON (a.nr_seq_localizacao = b.nr_sequencia)
WHERE a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w  and a.nr_sequencia		= m.nr_sequencia and coalesce(ie_terceiro,'S')	= 'S' and m.ie_plataforma	= ie_tipo_valor_p and ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTRECCLIPLAS') then
	
	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	FROM man_ordem_servico m, os_recebida_gerencia_desenv_v a
LEFT OUTER JOIN man_localizacao b ON (a.nr_seq_localizacao = b.nr_sequencia)
WHERE a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w  and a.nr_sequencia		= m.nr_sequencia and coalesce(ie_terceiro,'S')	= 'S' and m.ie_plataforma	= ie_tipo_valor_p and m.ie_classificacao = 'S' and ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTRECCLIPLAD') then
	
	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	FROM man_ordem_servico m, os_recebida_gerencia_desenv_v a
LEFT OUTER JOIN man_localizacao b ON (a.nr_seq_localizacao = b.nr_sequencia)
WHERE a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w  and a.nr_sequencia		= m.nr_sequencia and coalesce(ie_terceiro,'S')	= 'S' and m.ie_plataforma	= ie_tipo_valor_p and m.ie_classificacao = 'D' and ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));


elsif (ie_tipo_inf_p = 'QTRECCLICLA') then
	
	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	FROM man_ordem_servico c, os_recebida_gerencia_desenv_v a
LEFT OUTER JOIN man_localizacao b ON (a.nr_seq_localizacao = b.nr_sequencia)
WHERE a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w  and a.nr_sequencia		= c.nr_sequencia and coalesce(b.ie_terceiro,'S')	= 'S' and c.ie_classificacao_cliente	= ie_tipo_valor_p and ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));

	
elsif (ie_tipo_inf_p = 'QTRECINT') then
	
	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	FROM os_recebida_gerencia_desenv_v a
LEFT OUTER JOIN man_localizacao b ON (a.nr_seq_localizacao = b.nr_sequencia)
WHERE a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w  and coalesce(ie_terceiro,'S')	= 'N' and ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTBACKLOG') then
	select	COUNT(*)
	into STRICT	qt_total_os_w
	from	man_estagio_processo c,
		grupo_desenvolvimento b,
		man_ordem_servico a
	where	a.nr_seq_grupo_des = b.nr_sequencia
	and	c.nr_sequencia = a.nr_seq_estagio
	and (c.ie_tecnologia = 'S' or c.ie_desenv = 'S')
	and	a.ie_status_ordem <> '3' 
	and	((nr_seq_gerencia_p = 0) or (nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTBACKCLI') then
	select	COUNT(*)
	into STRICT	qt_total_os_w
	FROM man_estagio_processo c, grupo_desenvolvimento b, man_ordem_servico a
LEFT OUTER JOIN man_localizacao m ON (a.nr_seq_localizacao = m.nr_sequencia)
WHERE a.nr_seq_grupo_des = b.nr_sequencia and c.nr_sequencia = a.nr_seq_estagio  and coalesce(m.ie_terceiro,'S')	= 'S' and (c.ie_tecnologia = 'S' or c.ie_desenv = 'S') and a.ie_status_ordem <> '3' and ((nr_seq_gerencia_p = 0) or (nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTBACKINT') then
	select	COUNT(*)
	into STRICT	qt_total_os_w
	FROM man_estagio_processo c, grupo_desenvolvimento b, man_ordem_servico a
LEFT OUTER JOIN man_localizacao m ON (a.nr_seq_localizacao = m.nr_sequencia)
WHERE a.nr_seq_grupo_des = b.nr_sequencia and c.nr_sequencia = a.nr_seq_estagio  and coalesce(m.ie_terceiro,'S')	= 'N' and (c.ie_tecnologia = 'S' or c.ie_desenv = 'S') and a.ie_status_ordem <> '3' and ((nr_seq_gerencia_p = 0) or (nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTBACKPENDCLI') then
	select	COUNT(*)
	into STRICT	qt_total_os_w
	FROM man_estagio_processo c, os_recebida_gerencia_desenv_v a, man_ordem_servico b
LEFT OUTER JOIN man_localizacao m ON (b.nr_seq_localizacao = m.nr_sequencia)
WHERE c.nr_sequencia = b.nr_seq_estagio and b.nr_sequencia = a.nr_sequencia  and coalesce(m.ie_terceiro,'S')	= 'S' and coalesce(c.ie_desenv,'X') <> 'S' and b.ie_status_ordem <> '3' and c.ie_acao = 2 and ((nr_seq_gerencia_p = 0) or (nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTBACKPENDVEV') then
	select	COUNT(*)
	into STRICT	qt_total_os_w
	from	man_estagio_processo c,
		man_ordem_servico b,
		os_recebida_gerencia_desenv_v a
	where	c.nr_sequencia = b.nr_seq_estagio
	and	b.nr_sequencia = a.nr_sequencia
	and	coalesce(c.ie_testes,'X') = 'S'
	and	b.ie_status_ordem <> '3' 
	and	((nr_seq_gerencia_p = 0) or (nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTSLA') then
	select	count(*)
	into STRICT	qt_total_os_w
	from	man_estagio_processo c,
		grupo_desenvolvimento b, 	
    		man_ordem_servico  a,
		man_ordem_serv_sla s
	where 	a.nr_sequencia	= s.nr_seq_ordem
	and   	s.nr_seq_status <> 412
	and	c.nr_sequencia	= a.nr_seq_estagio
	and	a.nr_seq_grupo_des	= b.nr_sequencia
	and (c.ie_tecnologia = 'S' or c.ie_desenv = 'S')
	and	((nr_seq_gerencia_p = 0) or (b.nr_seq_gerencia = nr_seq_gerencia_p))
	and   	a.ie_status_ordem	<> '3'
	-- desconsiderar regra de sla da "TI - Philips SLA"
	and	s.nr_seq_sla <> 210;

elsif (ie_tipo_inf_p = 'QTSLAD') then
	select	count(*)
	into STRICT	qt_total_os_w
	from	man_estagio_processo	c,
		grupo_desenvolvimento	b,
		man_ordem_servico	a,
		man_ordem_serv_sla	s
	where	a.nr_sequencia		= s.nr_seq_ordem
	and	s.nr_seq_status	<>	412
	and	c.nr_sequencia		= a.nr_seq_estagio
	and	a.nr_seq_grupo_des	= b.nr_sequencia
	and (c.ie_tecnologia	= 'S' or c.ie_desenv = 'S')
	and	((nr_seq_gerencia_p	= 0) or (b.nr_seq_gerencia = nr_seq_gerencia_p))
	and	a.ie_status_ordem	<> '3'
	--	desconsiderar regra de sla da TI - Philips SLA
	and	s.nr_seq_sla <> 210
	and	s.nr_seq_sla <> sla_dashboard_pck.obter_nr_seq_regra_alldef();

elsif (ie_tipo_inf_p = 'QTBACKLOGDEF') then
	select	COUNT(*)
	into STRICT	qt_total_os_w
	from	man_estagio_processo c,
		grupo_desenvolvimento b,
		man_ordem_servico a
	where	a.nr_seq_grupo_des	= b.nr_sequencia
	and	c.nr_sequencia		= a.nr_seq_estagio
	and	a.ie_classificacao	= 'E'
	and (c.ie_tecnologia = 'S' or c.ie_desenv = 'S')
	and	a.ie_status_ordem	<> '3' 
	and	((nr_seq_gerencia_p = 0) or (nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p in ('QTANNE','QTANSI','QTANMA','QTPROG','QTESTA')) then
	begin
	select	coalesce(sum(phi_obter_valor_usu_grupo(dt_parametro_p,c.nm_usuario_grupo,c.nr_seq_grupo,null,1)),0)
	into STRICT	qt_total_os_w
	from	usuario_grupo_des c,
		grupo_desenvolvimento b,
		gerencia_wheb a
	where	a.nr_sequencia = b.nr_seq_gerencia
	and	b.nr_sequencia = c.nr_seq_grupo
	and	c.ie_funcao_usuario = ie_tipo_valor_p
	and	b.ie_situacao = 'A' --
	and (a.nr_sequencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0)
	and	dt_parametro_p between c.dt_inicio_vigencia and fim_mes(coalesce(c.dt_fim_vigencia,dt_parametro_p));
	end;
elsif (ie_tipo_inf_p = 'QAUSEN') then
	begin
	select	coalesce(sum(phi_obter_valor_usu_grupo(dt_parametro_p,c.nm_usuario_grupo,c.nr_seq_grupo,null,2)),0)
	into STRICT	qt_total_os_w
	from	usuario_grupo_des c,
		grupo_desenvolvimento b,
		gerencia_wheb a
	where	a.nr_sequencia = b.nr_seq_gerencia
	and	b.nr_sequencia = c.nr_seq_grupo
	and	c.ie_funcao_usuario in ('P','S','N','M')
	and	b.ie_situacao = 'A' --
	and (a.nr_sequencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0)
	and	dt_parametro_p between c.dt_inicio_vigencia and fim_mes(coalesce(c.dt_fim_vigencia,dt_parametro_p));
	end;
elsif (ie_tipo_inf_p = 'QTHORADIA') then

	select	dividir(sum(qt_minuto),60)
	into STRICT	qt_total_os_w
	from	MAN_ORDEM_SERV_ATIV a
	where	(a.dt_atividade IS NOT NULL AND a.dt_atividade::text <> '')
	and	(a.dt_fim_atividade IS NOT NULL AND a.dt_fim_atividade::text <> '')
	and	a.dt_atividade between dt_ref_mes_w and dt_fim_mes_w
	and	exists (	SELECT	1
				from	gerencia_wheb w,
					usuario_grupo_des c,
					grupo_desenvolvimento b
				where	b.nr_sequencia		= c.nr_seq_grupo
				and	w.nr_sequencia		= b.nr_seq_gerencia
				and	b.ie_situacao		= 'A'
				and	w.ie_situacao		= 'A'
				and	c.nm_usuario_grupo	= a.nm_usuario_exec
				and	((nr_seq_gerencia_p = 0) or (b.nr_seq_gerencia = nr_seq_gerencia_p)));

elsif (ie_tipo_inf_p = 'QTHORAOS') then
	select	dividir(dividir(sum(qt_minuto),60), count(distinct m.nr_sequencia))
	into STRICT	qt_total_os_w
	from	grupo_desenvolvimento g,
		MAN_ORDEM_SERV_ATIV a,
		man_ordem_servico m
	where	m.nr_sequencia	= a.nr_seq_ordem_serv
	and	m.nr_seq_grupo_des = g.nr_sequencia
  	and	((nr_seq_gerencia_p = 0) or (g.nr_seq_gerencia = nr_seq_gerencia_p))
	and	m.dt_fim_real between dt_ref_mes_w and dt_fim_mes_w
	and	m.ie_status_ordem = '3'
	and	(a.dt_atividade IS NOT NULL AND a.dt_atividade::text <> '')
	and	(a.dt_fim_atividade IS NOT NULL AND a.dt_fim_atividade::text <> '')
	and	exists (	SELECT	1
				from	gerencia_wheb w,
					usuario_grupo_des c,
					grupo_desenvolvimento b
				where	b.nr_sequencia		= c.nr_seq_grupo
				and	w.nr_sequencia		= b.nr_seq_gerencia
				and	b.ie_situacao		= 'A'
				and	w.ie_situacao		= 'A'
				and	c.nm_usuario_grupo	= a.nm_usuario_exec
				and	((nr_seq_gerencia_p = 0) or (b.nr_seq_gerencia = nr_seq_gerencia_p)));

elsif (ie_tipo_inf_p = 'QTHORAOSPLA') then
	select	dividir(dividir(sum(qt_minuto),60), count(distinct m.nr_sequencia))
	into STRICT	qt_total_os_w
	from	grupo_desenvolvimento g,
		MAN_ORDEM_SERV_ATIV a,
		man_ordem_servico m
	where	m.nr_sequencia	= a.nr_seq_ordem_serv
	and	m.nr_seq_grupo_des = g.nr_sequencia
  	and	((nr_seq_gerencia_p = 0) or (g.nr_seq_gerencia = nr_seq_gerencia_p))
	and	m.dt_fim_real between dt_ref_mes_w and dt_fim_mes_w
	and	m.ie_status_ordem = '3'
	and	(a.dt_atividade IS NOT NULL AND a.dt_atividade::text <> '')
	and	(a.dt_fim_atividade IS NOT NULL AND a.dt_fim_atividade::text <> '')
	and	m.ie_plataforma	= ie_tipo_valor_p
	and	exists (	SELECT	1
				from	gerencia_wheb w,
					usuario_grupo_des c,
					grupo_desenvolvimento b
				where	b.nr_sequencia		= c.nr_seq_grupo
				and	w.nr_sequencia		= b.nr_seq_gerencia
				and	b.ie_situacao		= 'A'
				and	w.ie_situacao		= 'A'
				and	c.nm_usuario_grupo	= a.nm_usuario_exec
				and	((nr_seq_gerencia_p = 0) or (b.nr_seq_gerencia = nr_seq_gerencia_p)));

elsif (ie_tipo_inf_p = 'QTHORAOSANAPLA') then

	select	dividir(dividir(sum(qt_minuto),60), count(distinct m.nr_sequencia))
	into STRICT	qt_total_os_w
	from	grupo_desenvolvimento g,
		MAN_ORDEM_SERV_ATIV a,
		man_ordem_servico m
	where	m.nr_sequencia	= a.nr_seq_ordem_serv
	and	m.nr_seq_grupo_des = g.nr_sequencia
  	and	((nr_seq_gerencia_p = 0) or (g.nr_seq_gerencia = nr_seq_gerencia_p))
	and	m.dt_fim_real between dt_ref_mes_w and dt_fim_mes_w
	and	m.ie_status_ordem = '3'
	and	(a.dt_atividade IS NOT NULL AND a.dt_atividade::text <> '')
	and	(a.dt_fim_atividade IS NOT NULL AND a.dt_fim_atividade::text <> '')
	and	m.ie_plataforma	= ie_tipo_valor_p
	and	exists (	SELECT	1
				from	gerencia_wheb w,
					usuario_grupo_des c,
					grupo_desenvolvimento b
				where	b.nr_sequencia		= c.nr_seq_grupo
				and	w.nr_sequencia		= b.nr_seq_gerencia
				and	b.ie_situacao		= 'A'
				and	w.ie_situacao		= 'A'
				and	c.nm_usuario_grupo	= a.nm_usuario_exec
        			and	c.ie_funcao_usuario in ('S','M')
				and	((nr_seq_gerencia_p = 0) or (b.nr_seq_gerencia = nr_seq_gerencia_p)));


elsif (ie_tipo_inf_p = 'QTHORAOSPROPLA') then

	select	dividir(dividir(sum(qt_minuto),60), count(distinct m.nr_sequencia))
	into STRICT	qt_total_os_w
	from	grupo_desenvolvimento g,
		MAN_ORDEM_SERV_ATIV a,
		man_ordem_servico m
	where	m.nr_sequencia	= a.nr_seq_ordem_serv
	and	m.nr_seq_grupo_des = g.nr_sequencia
  	and	((nr_seq_gerencia_p = 0) or (g.nr_seq_gerencia = nr_seq_gerencia_p))
	and	m.dt_fim_real between dt_ref_mes_w and dt_fim_mes_w
	and	m.ie_status_ordem = '3'
	and	(a.dt_atividade IS NOT NULL AND a.dt_atividade::text <> '')
	and	(a.dt_fim_atividade IS NOT NULL AND a.dt_fim_atividade::text <> '')
	and	m.ie_plataforma	= ie_tipo_valor_p
	and	exists (	SELECT	1
				from	gerencia_wheb w,
					usuario_grupo_des c,
					grupo_desenvolvimento b
				where	b.nr_sequencia		= c.nr_seq_grupo
				and	w.nr_sequencia		= b.nr_seq_gerencia
				and	b.ie_situacao		= 'A'
				and	w.ie_situacao		= 'A'
				and	c.nm_usuario_grupo	= a.nm_usuario_exec
        			and	c.ie_funcao_usuario in ('P','E')
				and	((nr_seq_gerencia_p = 0) or (b.nr_seq_gerencia = nr_seq_gerencia_p)));

elsif (ie_tipo_inf_p = 'QTHORAOSCLI') then

	select	dividir(dividir(sum(qt_minuto),60), count(distinct m.nr_sequencia))
	into STRICT	qt_total_os_w
	from	man_localizacao l,
		grupo_desenvolvimento g,
		MAN_ORDEM_SERV_ATIV a,
		man_ordem_servico m
	where	m.nr_sequencia		= a.nr_seq_ordem_serv
	and	m.nr_seq_grupo_des	= g.nr_sequencia
	and	l.nr_sequencia		= m.nr_seq_localizacao
	and	coalesce(l.ie_terceiro,'S')	= 'S'
  	and	((nr_seq_gerencia_p = 0) or (g.nr_seq_gerencia = nr_seq_gerencia_p))
	and	m.dt_fim_real between dt_ref_mes_w and dt_fim_mes_w
	and	m.ie_status_ordem = '3'
	and	(a.dt_atividade IS NOT NULL AND a.dt_atividade::text <> '')
	and	(a.dt_fim_atividade IS NOT NULL AND a.dt_fim_atividade::text <> '')
	and	exists (	SELECT	1
				from	gerencia_wheb w,
					usuario_grupo_des c,
					grupo_desenvolvimento b
				where	b.nr_sequencia		= c.nr_seq_grupo
				and	w.nr_sequencia		= b.nr_seq_gerencia
				and	b.ie_situacao		= 'A'
				and	w.ie_situacao		= 'A'
				and	c.nm_usuario_grupo	= a.nm_usuario_exec
				and	((nr_seq_gerencia_p = 0) or (b.nr_seq_gerencia = nr_seq_gerencia_p)));

elsif (ie_tipo_inf_p = 'QTHORAOSINT') then
	select	dividir(dividir(sum(qt_minuto),60), count(distinct m.nr_sequencia))
	into STRICT	qt_total_os_w
	from	man_localizacao l,
		grupo_desenvolvimento g,
		MAN_ORDEM_SERV_ATIV a,
		man_ordem_servico m
	where	m.nr_sequencia		= a.nr_seq_ordem_serv
	and	m.nr_seq_grupo_des	= g.nr_sequencia
	and	l.nr_sequencia		= m.nr_seq_localizacao
	and	coalesce(l.ie_terceiro,'S')	= 'N'
  	and	((nr_seq_gerencia_p = 0) or (g.nr_seq_gerencia = nr_seq_gerencia_p))
	and	m.dt_fim_real between dt_ref_mes_w and dt_fim_mes_w
	and	m.ie_status_ordem = '3'
	and	(a.dt_atividade IS NOT NULL AND a.dt_atividade::text <> '')
	and	(a.dt_fim_atividade IS NOT NULL AND a.dt_fim_atividade::text <> '')
	and	exists (	SELECT	1
				from	gerencia_wheb w,
					usuario_grupo_des c,
					grupo_desenvolvimento b
				where	b.nr_sequencia		= c.nr_seq_grupo
				and	w.nr_sequencia		= b.nr_seq_gerencia
				and	b.ie_situacao		= 'A'
				and	w.ie_situacao		= 'A'
				and	c.nm_usuario_grupo	= a.nm_usuario_exec
				and	((nr_seq_gerencia_p = 0) or (b.nr_seq_gerencia = nr_seq_gerencia_p)));

elsif (ie_tipo_inf_p = 'QTRECEBDIA') then

	dt_ref_mes_w	:= PKG_DATE_UTILS.start_of(dt_parametro_p,'dd',0);
	dt_fim_mes_w	:= PKG_DATE_UTILS.END_OF(dt_ref_mes_w, 'DAY', 0);

	select 	count(distinct nr_sequencia)
	into STRICT	qt_total_os_w
	from	os_recebida_gerencia_desenv_v
	where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and      ((nr_seq_gerencia_p = 0) or (nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTRECEBDIACLI') then

	dt_ref_mes_w	:= PKG_DATE_UTILS.start_of(dt_parametro_p,'dd',0);
	dt_fim_mes_w	:= PKG_DATE_UTILS.END_OF(dt_ref_mes_w, 'DAY', 0);

	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	from	man_localizacao b,
		os_recebida_gerencia_desenv_v a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_localizacao	= b.nr_sequencia
	and	coalesce(b.ie_terceiro,'S')	= 'S'
	and      ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTRECEBDIAINT') then

	dt_ref_mes_w	:= PKG_DATE_UTILS.start_of(dt_parametro_p,'dd',0);
	dt_fim_mes_w	:= PKG_DATE_UTILS.END_OF(dt_ref_mes_w, 'DAY', 0);

	select 	count(distinct a.nr_sequencia)
	into STRICT	qt_total_os_w
	from	man_localizacao b,
		os_recebida_gerencia_desenv_v a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_localizacao	= b.nr_sequencia
	and	coalesce(b.ie_terceiro,'S')	= 'N'
	and      ((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTPESSOA') then
	
	SELECT	sum(a.qt_total_pessoas)
	into STRICT	qt_total_os_w
	FROM	gerencia_wheb b,
		w_indicador_desenv_apres a
	WHERE	b.nr_sequencia = a.nr_seq_gerencia 
	and	a.dt_referencia = PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.END_OF(a.dt_referencia, 'MONTH', 0),'dd', 0)
	and	a.IE_ABRANGENCIA = 'GER' 
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	a.dt_referencia between dt_ref_mes_w and dt_fim_mes_w;

elsif (ie_tipo_inf_p = 'QTPFPRODUT') then
	
	SELECT	sum(a.qt_total_pessoas - a.qt_pessoa_ausente)
	into STRICT	qt_total_os_w
	FROM	w_indicador_desenv_apres a
	WHERE	a.dt_referencia = PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.END_OF(a.dt_referencia, 'MONTH', 0),'dd', 0)
	and	a.IE_ABRANGENCIA = 'GER' 
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	a.dt_referencia between dt_ref_mes_w and dt_fim_mes_w;


elsif (ie_tipo_inf_p in ('QTHE','MEHEPF')) then

	select	round(sum(a.qt_min_trab) / 60)
	into STRICT	qt_total_os_w
	from	pf_hora_trabalhada a,
		usuario u,
		grupo_desenvolvimento b,
		usuario_grupo_des c,
		gerencia_wheb g
	where	a.cd_pessoa_fisica	= u.cd_pessoa_fisica
	and	u.nm_usuario		= c.NM_USUARIO_GRUPO
	and	c.nr_seq_grupo		= b.nr_sequencia
	and	b.nr_seq_gerencia	= g.nr_sequencia
	and	a.dt_referencia between dt_ref_mes_w and dt_fim_mes_w
	and	a.cd_sistema in (301,302,303,304,305,306,501,502,504,505)
	and	((nr_seq_gerencia_p = 0) or (g.nr_sequencia = nr_seq_gerencia_p));

elsif (ie_tipo_inf_p = 'QTNET') then
	qt_total_os_w := obter_valor_dinamico_bv('select count(1) from alteracao_tasy@whebl02_orcl a, man_ordem_servico b, grupo_desenvolvimento c where a.nr_seq_ordem_serv = b.nr_sequencia and b.nr_seq_grupo_des = 

c.nr_sequencia and c.nr_seq_gerencia = 

:nr_gerencia and a.dt_alteracao between :dt_inicio and :dt_fim', 'nr_gerencia='||to_char(nr_seq_gerencia_p)||ds_sep_bv_w||'dt_inicio='||dt_ref_mes_w||ds_sep_bv_w||'dt_fim='||dt_fim_mes_w, qt_total_os_w);

elsif (ie_tipo_inf_p = 'PRINOV') then

	SELECT	ROUND(dividir((SUM(qt_inov)*100),SUM(qt_total)),2) qt_percent
	into STRICT	qt_total_os_w
	FROM	(
	SELECT	round((dividir(SUM(qt_minuto),60))::numeric,2) qt_inov,
		0 qt_total
	FROM	(	
		SELECT	SUM(b.qt_minuto) qt_minuto
		FROM	grupo_desenvolvimento d,
			usuario_grupo_des e,
			man_ordem_servico a,
			man_ordem_serv_ativ b,
			usuario c
		WHERE	a.nr_sequencia = b.nr_seq_ordem_serv
		AND	c.nm_usuario   = b.nm_usuario_exec
		and d.nr_sequencia = e.nr_seq_grupo
		and e.nm_usuario_grupo = c.nm_usuario
		and ((nr_seq_gerencia_p = 0) or (d.nr_seq_gerencia = nr_seq_gerencia_p))
		AND	a.nr_seq_nivel_valor IN (1,3)
		and 	b.dt_atividade between dt_ref_mes_w and dt_fim_mes_w
		and	not exists (
						select	1
						from	man_ordem_serv_tecnico x
						where	a.nr_sequencia = x.nr_seq_ordem_serv
						and	nr_seq_tipo = 129)
		and	a.nr_seq_classif <> 49) alias16
	
UNION ALL

	SELECT	0 qt_inov,
		round((dividir(SUM(qt_minuto),60))::numeric,2) qt_total
	FROM	(	
		SELECT	SUM(b.qt_minuto) qt_minuto
		FROM	grupo_desenvolvimento d,
			usuario_grupo_des e,
			man_ordem_servico a,
			man_ordem_serv_ativ b,
			usuario c
		WHERE	a.nr_sequencia = b.nr_seq_ordem_serv
		AND	c.nm_usuario   = b.nm_usuario_exec
		and	d.nr_sequencia = e.nr_seq_grupo
		and	e.nm_usuario_grupo = c.nm_usuario
		and 	((nr_seq_gerencia_p = 0) or (d.nr_seq_gerencia = nr_seq_gerencia_p))
		and	(a.nr_seq_nivel_valor IS NOT NULL AND a.nr_seq_nivel_valor::text <> '')
		and	b.dt_atividade between dt_ref_mes_w and dt_fim_mes_w
		and	not exists (
						select	1
						from	man_ordem_serv_tecnico x
						where	a.nr_sequencia = x.nr_seq_ordem_serv
						and	nr_seq_tipo = 129)
		and	a.nr_seq_classif <> 49) alias27) alias28;

elsif (ie_tipo_inf_p = 'QTPFDELPHI') then

	if (trunc(clock_timestamp()) < trunc(dt_fim_mes_w)) then
		dt_fim_mes_w	:= PKG_DATE_UTILS.END_OF(clock_timestamp(), 'DAY', 0);
	end if;

	qt_dias_util_w	:= obter_dias_uteis_periodo(dt_ref_mes_w,dt_fim_mes_w,1);

	select	trunc(sum(b.QT_MINUTO/60)/7/qt_dias_util_w,2)
	into STRICT	qt_total_os_w
	from	man_ordem_servico a,
		MAN_ORDEM_SERV_ATIV b
	where	a.nr_sequencia = b.NR_SEQ_ORDEM_SERV
	and	b.DT_ATIVIDADE between dt_ref_mes_w and dt_fim_mes_w
	and	a.ie_plataforma = 'D'
	and	obter_se_ordem_vinc_projeto(a.nr_sequencia,'4') = 'N'
	and	exists (	SELECT 1
				from	gerencia_wheb c,
					grupo_desenvolvimento d,
					USUARIO_GRUPO_DES e
				where	c.nr_sequencia = d.nr_seq_gerencia
				and	d.nr_sequencia = e.NR_SEQ_GRUPO
				and	c.ie_situacao = 'A'
				and	d.ie_situacao = 'A'
				and 	((nr_seq_gerencia_p = 0) or (c.nr_sequencia = nr_seq_gerencia_p))
				and	e.NM_USUARIO_GRUPO	= b.NM_USUARIO_EXEC);

elsif (ie_tipo_inf_p = 'QTPFJAVA') then

	if (trunc(clock_timestamp()) < trunc(dt_fim_mes_w)) then
		dt_fim_mes_w	:= PKG_DATE_UTILS.END_OF(clock_timestamp(), 'DAY', 0);
	end if;

	qt_dias_util_w	:= obter_dias_uteis_periodo(dt_ref_mes_w,dt_fim_mes_w,1);

	select	trunc(sum(b.QT_MINUTO/60)/7/qt_dias_util_w,2)
	into STRICT	qt_total_os_w
	from	man_ordem_servico a,
		MAN_ORDEM_SERV_ATIV b
	where	a.nr_sequencia = b.NR_SEQ_ORDEM_SERV
	and	b.DT_ATIVIDADE between dt_ref_mes_w and dt_fim_mes_w
	and	a.ie_plataforma = 'S'
	and	obter_se_ordem_vinc_projeto(a.nr_sequencia,'4') = 'N'
	and	exists (	SELECT 1
				from	gerencia_wheb c,
					grupo_desenvolvimento d,
					USUARIO_GRUPO_DES e
				where	c.nr_sequencia = d.nr_seq_gerencia
				and	d.nr_sequencia = e.NR_SEQ_GRUPO
				and	c.ie_situacao = 'A'
				and	d.ie_situacao = 'A'
				and 	((nr_seq_gerencia_p = 0) or (c.nr_sequencia = nr_seq_gerencia_p))
				and	e.NM_USUARIO_GRUPO	= b.NM_USUARIO_EXEC);

elsif (ie_tipo_inf_p = 'QTPFHTML5') then

	if (trunc(clock_timestamp()) < trunc(dt_fim_mes_w)) then
		dt_fim_mes_w	:= PKG_DATE_UTILS.END_OF(clock_timestamp(), 'DAY', 0);
	end if;

	qt_dias_util_w	:= obter_dias_uteis_periodo(dt_ref_mes_w,dt_fim_mes_w,1);

	select	trunc(sum(b.QT_MINUTO/60)/7/qt_dias_util_w,2)
	into STRICT	qt_total_os_w
	from	man_ordem_servico a,
		MAN_ORDEM_SERV_ATIV b
	where	a.nr_sequencia = b.NR_SEQ_ORDEM_SERV
	and	b.DT_ATIVIDADE between dt_ref_mes_w and dt_fim_mes_w
	and	a.ie_plataforma = 'H'
	and	obter_se_ordem_vinc_projeto(a.nr_sequencia,'4') = 'N'
	and	exists (	SELECT 1
				from	gerencia_wheb c,
					grupo_desenvolvimento d,
					USUARIO_GRUPO_DES e
				where	c.nr_sequencia = d.nr_seq_gerencia
				and	d.nr_sequencia = e.NR_SEQ_GRUPO
				and	c.ie_situacao = 'A'
				and	d.ie_situacao = 'A'
				and 	((nr_seq_gerencia_p = 0) or (c.nr_sequencia = nr_seq_gerencia_p))
				and	e.NM_USUARIO_GRUPO	= b.NM_USUARIO_EXEC);

elsif (ie_tipo_inf_p = 'QFPFCAP') then

	if (trunc(clock_timestamp()) < trunc(dt_fim_mes_w)) then
		dt_fim_mes_w	:= PKG_DATE_UTILS.END_OF(clock_timestamp(), 'DAY', 0);
	end if;

	qt_dias_util_w	:= obter_dias_uteis_periodo(dt_ref_mes_w,dt_fim_mes_w,1);

	select	trunc(sum(b.QT_MINUTO/60)/7/qt_dias_util_w,2)
	into STRICT	qt_total_os_w
	from	man_ordem_servico a,
		MAN_ORDEM_SERV_ATIV b
	where	a.nr_sequencia = b.NR_SEQ_ORDEM_SERV
	and	b.DT_ATIVIDADE between dt_ref_mes_w and dt_fim_mes_w
	and	obter_se_ordem_vinc_projeto(a.nr_sequencia,'4') = 'S'
	and	exists (	SELECT 1
				from	gerencia_wheb c,
					grupo_desenvolvimento d,
					USUARIO_GRUPO_DES e
				where	c.nr_sequencia = d.nr_seq_gerencia
				and	d.nr_sequencia = e.NR_SEQ_GRUPO
				and	c.ie_situacao = 'A'
				and	d.ie_situacao = 'A'
				and 	((nr_seq_gerencia_p = 0) or (c.nr_sequencia = nr_seq_gerencia_p))
				and	e.NM_USUARIO_GRUPO	= b.NM_USUARIO_EXEC);

end if;




/* Percentual de defeitos por severidade, considerando apenas as OS's que passaram pelo desenvolvimento e tecnologia */

if (ie_tipo_inf_p in ('PRSEV')) then
	
	select	count(distinct nr_sequencia)
	into STRICT	qt_erro_w
	from	os_erro_gerencia_v
	where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	nr_seq_severidade	= ie_tipo_valor_p
	and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
	
end if;

if (ie_tipo_inf_p in ('PRDSEV')) then

	select	count(distinct nr_sequencia)
	into STRICT	qt_total_os_w
	from	os_erro_gerencia_v
	where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	(nr_seq_severidade IS NOT NULL AND nr_seq_severidade::text <> '')
	and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);

	select	count(distinct nr_sequencia)
	into STRICT	qt_erro_w
	from	os_erro_gerencia_v
	where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	nr_seq_severidade	= ie_tipo_valor_p
	and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;


/*Retorna a quantidade de erros considerando o DOC ERRO*/

if (ie_tipo_inf_p in ('ER','PR','PRD')) then

		select	count(distinct nr_sequencia)
		into STRICT	qt_erro_w
		from	os_erro_gerencia_v
		where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

/*Retorna a quantidade de erros considerando o DOC ERRO*/

if (ie_tipo_inf_p in ('EGW')) then
		select	count(distinct nr_sequencia)
		into STRICT	qt_erro_w
		from	os_erro_gerencia_v
		where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	ie_origem_erro <> 'C'
		and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

/*Retorna a quantidade de erros considerando o DOC ERRO identificados na base da Wheb*/

if (ie_tipo_inf_p in ('PRIN','PRIND')) then
		select	count(distinct nr_sequencia)
		into STRICT	qt_erro_w
		from	os_erro_gerencia_v
		where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	ie_ident_erro	= 'W'
		and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

/*Retorna a quantidade de erros considerando o DOC ERRO externamente pelos clientes */

if (ie_tipo_inf_p in ('PREX','QTEXT','PREXD')) then
		select	count(distinct a.nr_sequencia)
		into STRICT	qt_erro_w
		from	os_erro_gerencia_v a
		where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and	a.ie_ident_erro	<> 'W'
		AND 	((EXISTS (SELECT 1
					    FROM  proj_projeto x
						WHERE  x.nr_sequencia = a.nr_seq_proj_def 
						AND	  (x.dt_fim_real IS NOT NULL AND x.dt_fim_real::text <> '')
						AND     obter_dias_entre_datas(x.dt_fim_real,a.dt_ordem_servico) > 120))
		OR (coalesce(a.nr_seq_proj_def::text, '') = ''))
		and (a.nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

/*Retorna a quantidade de erros encontrados na base Wheb  fora do VV*/

if (ie_tipo_inf_p in ('PRPHI','QTPHI')) then

		select	count(distinct nr_sequencia)
		into STRICT	qt_erro_w
		from	os_erro_gerencia_v
		where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
		and	ie_ident_erro	= 'W'
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	nr_seq_equipamento not in (2897,5818)
		and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

/*Retorna a quantidade de erros encontrados pelo VV */

if (ie_tipo_inf_p in ('PRVEV')) then

		select	count(distinct nr_sequencia)
		into STRICT	qt_erro_w
		from	os_erro_gerencia_v
		where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
		and	ie_ident_erro	= 'W'
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	nr_seq_equipamento in (2897,5818)
		and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

/*Retorna a quantidade de erros considerando o DOC ERRO que foram identificados internamente na Wheb*/

if (ie_tipo_inf_p in ('ERI')) then
		select	count(distinct nr_sequencia)
		into STRICT	qt_erro_w
		from	os_erro_gerencia_v
		where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	ie_ident_erro	= 'W'
		and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

/*Retorna a quantidade de erros considerando o DOC ERRO que foram identificados externamente pelos clientes*/

if (ie_tipo_inf_p in ('ERE')) then
		select	count(distinct nr_sequencia)
		into STRICT	qt_erro_w
		from	os_erro_gerencia_v
		where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	ie_ident_erro	<> 'W'
		and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

/*Retorna a quantidade de OS encerrada que passou pelo Desenvolvimento/Tecnologia*/

if (ie_tipo_inf_p = 'EN') then
	select   count(*)
	into STRICT	 qt_os_encerrada_w
	from     os_encerrada_gerencia_v
	where	((nr_seq_gerencia_p = 0) or (NR_SEQ_GERENCIA = nr_seq_gerencia_p))
	and	dt_fim_real between dt_ref_mes_w and dt_fim_mes_w;
end if;

/*Retorna a quantidade de OS encerrada com Grau de Satisfcao*/

if ( ie_tipo_inf_p in ('PRI','ENS')) then
	
	select	count(*)
	into STRICT	qt_os_encerrada_classif_w
	from	gerencia_wheb b,
		os_encerrada_satisf_gerencia_v a,
		man_localizacao c
	where	a.nr_seq_gerencia = b.nr_sequencia
	and	a.nr_seq_localizacao = c.nr_sequencia
	and	c.ie_terceiro = 'S'
	and	a.dt_fim_real between dt_ref_mes_w and dt_fim_mes_w
	and	b.ie_area_gerencia in (WITH RECURSIVE cte AS (

						SELECT	trim(both regexp_substr(ie_area_gerencia_p,'[^,]+', 1, level))
						
						(regexp_substr(ie_area_gerencia_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(ie_area_gerencia_p, '[^,]+', 1, level))::text <> '')
					  UNION ALL

						SELECT	trim(both regexp_substr(ie_area_gerencia_p,'[^,]+', 1, level)) JOIN cte c ON ()

) SELECT * FROM cte;
)	
	and (a.nr_seq_gerencia = nr_seq_gerencia_p or coalesce(nr_seq_gerencia_p::text, '') = '');
	
end if;

/*Retorna a quantidade de OS de cliente encerrada com Grau de Satisfacao*/

if ( ie_tipo_inf_p in ('PRICLI','ENSCLI')) then
	select   count(*)
	into STRICT	 qt_os_encerrada_classif_w
	from     os_encerrada_satisf_gerencia_v
	where   ((nr_seq_gerencia_p = 0) or (coalesce(nr_seq_gerencia_insatisf,nr_seq_gerencia) = nr_seq_gerencia_p))
	and	ie_terceiro	= 'S'
	and	dt_fim_real between dt_ref_mes_w and dt_fim_mes_w;
end if;

/*Retorna a quantidade de OS encerrada com Grau de Satisfacao Irregular*/

if (ie_tipo_inf_p in ('QTI','PRI')) then

	select	count(*)
	into STRICT	qt_os_insatisf_w
	from	os_insatisfacao_gerencia_v a,
		man_localizacao c
	where	a.nr_seq_localizacao = c.nr_sequencia
	and	c.ie_terceiro = 'S'
	and	a.dt_fim_real between dt_ref_mes_w and dt_fim_mes_w
	and	a.ie_area_gerencia in (WITH RECURSIVE cte AS (

						SELECT	trim(both regexp_substr(ie_area_gerencia_p,'[^,]+', 1, level))
						
						(regexp_substr(ie_area_gerencia_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(ie_area_gerencia_p, '[^,]+', 1, level))::text <> '')
					  UNION ALL

						SELECT	trim(both regexp_substr(ie_area_gerencia_p,'[^,]+', 1, level)) JOIN cte c ON ()

) SELECT * FROM cte;
)	
	and (a.nr_seq_gerencia = nr_seq_gerencia_p or coalesce(nr_seq_gerencia_p::text, '') = '');
	
end if;

/*Retorna a quantidade de OS de cliente encerrada com Grau de Satisfacao Irregular*/

if (ie_tipo_inf_p in ('QTICLI','PRICLI')) then
	select	count(*)
	into STRICT	qt_os_insatisf_w
	from	os_insatisfacao_gerencia_v
	where   ((nr_seq_gerencia_p = 0) or (coalesce(nr_seq_gerencia_insatisf,nr_seq_gerencia) = nr_seq_gerencia_p))
	and	ie_terceiro	= 'S'
	and	dt_fim_real between dt_ref_mes_w and dt_fim_mes_w;
end if;

/*Retorna a quantidade de erros considerando o DOC ERRO identificados na base da Wheb - Somente para migracao JAVA */

if (ie_tipo_inf_p in ('PRJIN')) then
		select	count(distinct nr_sequencia)
		into STRICT	qt_erro_w
		from	os_erro_gerencia_v
		where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	ie_ident_erro	= 'W'
		and	ie_forma_origem = '10'
		and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

/*Retorna a quantidade de erros considerando o DOC ERRO identificados na base da Wheb - Exceto para migracao JAVA */

if (ie_tipo_inf_p in ('PRINSJ')) then
		select	count(distinct nr_sequencia)
		into STRICT	qt_erro_w
		from	os_erro_gerencia_v
		where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	ie_ident_erro	= 'W'
		and	ie_forma_origem <> '10'
		and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

if (ie_tipo_inf_p = 'PRDJAVA') then
	SELECT	count(distinct nr_sequencia)
	INTO STRICT	qt_erro_w
	FROM 	os_erro_gerencia_v
	WHERE	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	AND	IE_ORIGEM_ERRO = 'W'
	AND	(DT_LIBERACAO IS NOT NULL AND DT_LIBERACAO::text <> '')
	AND	NR_SEQ_LP = 2
	AND (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);

end if;

/*Percentual de defeitos java identificados pelos clientes*/

if (ie_tipo_inf_p = 'PRDJVCLI') then
	SELECT	count(distinct nr_sequencia)
	INTO STRICT	qt_erro_w
	FROM 	os_erro_gerencia_v
	WHERE	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	AND	IE_ORIGEM_ERRO = 'W'
	AND	IE_IDENT_ERRO <> 'W'
	AND	(DT_LIBERACAO IS NOT NULL AND DT_LIBERACAO::text <> '')
	AND	NR_SEQ_LP = 2
	AND (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

/*Percentual de defeitos Java identificados pela Philips*/

if (ie_tipo_inf_p = 'PRDJVPHI') then
	SELECT	count(distinct nr_sequencia)
	INTO STRICT	qt_erro_w
	FROM 	os_erro_gerencia_v
	WHERE	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	AND	IE_ORIGEM_ERRO = 'W'
	AND	IE_IDENT_ERRO = 'W'
	AND	(DT_LIBERACAO IS NOT NULL AND DT_LIBERACAO::text <> '')
	AND	NR_SEQ_LP = 2
	AND (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;


/*Percentual de defeitos Delphi identificados pelo Cliente*/

if (ie_tipo_inf_p = 'PRDDECLI') then
	SELECT	count(distinct nr_sequencia)
	INTO STRICT	qt_erro_w
	FROM 	os_erro_gerencia_v
	WHERE	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	AND	IE_ORIGEM_ERRO = 'W'
	AND	IE_IDENT_ERRO <> 'W'
	AND	(DT_LIBERACAO IS NOT NULL AND DT_LIBERACAO::text <> '')
	AND	NR_SEQ_LP <> 2
	AND (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

/*Percentual de defeitos Delphi identificados pela Philips*/

if (ie_tipo_inf_p = 'PRDDEPHI') then
	SELECT	count(distinct nr_sequencia)
	INTO STRICT	qt_erro_w
	FROM 	os_erro_gerencia_v
	WHERE	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	AND	IE_ORIGEM_ERRO = 'W'
	AND	IE_IDENT_ERRO = 'W'
	AND	(DT_LIBERACAO IS NOT NULL AND DT_LIBERACAO::text <> '')
	AND	NR_SEQ_LP <> 2
	AND (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
end if;

if (ie_tipo_inf_p = 'PRDDELPHI') then
	SELECT	count(distinct nr_sequencia)
	INTO STRICT	qt_erro_w
	FROM 	os_erro_gerencia_v
	WHERE	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	AND	IE_ORIGEM_ERRO = 'W'
	AND	(DT_LIBERACAO IS NOT NULL AND DT_LIBERACAO::text <> '')
	AND	NR_SEQ_LP <> 2
	AND (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);

end if;


if (ie_tipo_inf_p in ('VEVOS')) then
	
	select	count(distinct nr_sequencia)
	into STRICT	qt_os_vev_w
	from	os_erro_gerencia_v
	where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	ie_ident_erro	= 'W'
	and	nr_seq_equipamento in (2897,5818)
	and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
	
end if;

if (ie_tipo_inf_p in ('PHIOS')) then
	
	select	count(distinct nr_sequencia)
	into STRICT	qt_os_vev_w
	from	os_erro_gerencia_v
	where	dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	ie_ident_erro	= 'W'
	and	nr_seq_equipamento not in (2897,5818)
	and (nr_seq_gerencia = nr_seq_gerencia_p or nr_seq_gerencia_p = 0);
	
end if;

if (ie_tipo_inf_p in ('TMAC')) then

	select	dividir(sum(b.qt_minuto), count(distinct a.nr_sequencia)) qt_min_os_alta_complex
	into STRICT	qt_min_os_w
	from	usuario x,
		grupo_desenvolvimento c,
		man_ordem_servico a,
		man_ordem_serv_ativ b
	where	a.nr_sequencia	= b.nr_seq_ordem_serv
	and	c.nr_sequencia	= a.nr_seq_grupo_des
	and	x.nm_usuario	= b.nm_usuario_exec
	and	x.cd_setor_atendimento in (2,7,16,33)
	and	a.ie_status_ordem = 3
	and	a.nr_seq_complex in (4,5,6)
	and	a.dt_fim_real between dt_ref_mes_w and dt_fim_mes_w
	and (c.nr_seq_gerencia = nr_seq_gerencia_p OR nr_seq_gerencia_p = 0)
	and	exists ( SELECT 1
			from	os_recebida_gerencia_desenv_v y
			where	a.nr_sequencia = y.nr_sequencia);
	
elsif (ie_tipo_inf_p in ('TMBC')) then

	select	dividir(sum(b.qt_minuto), count(distinct a.nr_sequencia)) qt_min_os_alta_complex
	into STRICT	qt_min_os_w
	from	usuario x,
		grupo_desenvolvimento c,
		man_ordem_servico a,
		man_ordem_serv_ativ b
	where	a.nr_sequencia	= b.nr_seq_ordem_serv
	and	a.ie_status_ordem = 3
	and	c.nr_sequencia	= a.nr_seq_grupo_des
	and	x.nm_usuario	= b.nm_usuario_exec
	and	x.cd_setor_atendimento in (2,7,16,33)
	and	a.nr_seq_complex not in (4,5,6)
	and	a.dt_fim_real between dt_ref_mes_w and dt_fim_mes_w
	and (c.nr_seq_gerencia = nr_seq_gerencia_p OR nr_seq_gerencia_p = 0)
	and	exists ( SELECT 1
			from	os_recebida_gerencia_desenv_v y
			where	a.nr_sequencia = y.nr_sequencia);
end if;

if (ie_tipo_inf_p = 'PRANTIGA') then
	
	select	COUNT(*)
	into STRICT	qt_total_os_w
	from	man_estagio_processo c,
		grupo_desenvolvimento b,
		man_ordem_servico a
	where	a.nr_seq_grupo_des = b.nr_sequencia
	and	c.nr_sequencia = a.nr_seq_estagio
	and (c.ie_tecnologia = 'S' or c.ie_desenv = 'S')
	and	a.ie_status_ordem <> '3' 
	and	((nr_seq_gerencia_p = 0) or (nr_seq_gerencia = nr_seq_gerencia_p));

end if;

if (ie_tipo_inf_p = 'MEHEPF') then

	select	count(distinct nm_usuario_grupo)
	into STRICT	qt_pessoas_w
	from	usuario_grupo_des b,
		grupo_desenvolvimento a
	where	a.nr_sequencia = b.nr_seq_grupo
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	ie_funcao_usuario in ('M','N','S','P');

end if;

if (ie_tipo_inf_p in ('QT','QTD','QTDFP','QTDPRJ','QTDPP','QTBACKLOG','QTRECCLI','QTRECINT','QTBACKCLI','QTBACKINT','QTSLA', 

'QTSLAD','QTBACKLOGDEF','QTANNE','QTANSI','QTANMA','QTPROG','QTHORAOS','QTHORADIA',
                           

'QTHORAOSINT','QTHORAOSCLI','QTRECEBDIA','QTRECEBDIAINT','QTRECEBDIACLI','QTPESSOA','QTESTA','QTBACKPENDCLI','QTBACKPENDVEV','QAUSEN','QTHE','QTNET','PRINOV','QTPFPRODUT',
			

'QTPFDELPHI','QTPFJAVA','QTPFHTML5','QFPFCAP','QTDPLT','QTDCLD','QTDCLDD','QTDOR' || chr(199),'QTDOR' || chr(199) || 'AP','QTRECCLICLA','QTHORAOSPLA','QTHORAOSANAPLA','QTHORAOSPROPLA','QTRECCLIPLA','QTRECCLIPLAS',
			'QTRECCLIPLAD','ENCPF','PRSLAALLDEF','PRSLAOBI','PRSLAMULTA','PRSLASEMMULTA')) then
	return qt_total_os_w;
elsif (ie_tipo_inf_p = 'ER') then
	return qt_erro_w;
elsif (ie_tipo_inf_p = 'EN') then
	return qt_os_encerrada_w;
elsif (ie_tipo_inf_p in ('PR','PRD','PRSEV','PRDSEV','PRDJAVA','PRDDELPHI','PRDJVCLI','PRDJVPHI','PRDDECLI','PRDDEPHI')) then
	return dividir(qt_erro_w, qt_total_os_w)*100;
elsif (ie_tipo_inf_p in ('PRIN','PRIND','PRPP')) then
	return dividir(qt_erro_w, qt_total_os_w)*100;
elsif (ie_tipo_inf_p in ('PREX','PREXD')) then
	return dividir(qt_erro_w, qt_total_os_w)*100;
elsif (ie_tipo_inf_p = 'PRPHI') then
	return dividir(qt_erro_w, qt_total_os_w)*100;
elsif (ie_tipo_inf_p = 'PRVEV') then
	return dividir(qt_erro_w, qt_total_os_w)*100;
elsif (ie_tipo_inf_p in ('QTI','QTICLI')) then
	return	qt_os_insatisf_w;
elsif (ie_tipo_inf_p = 'EGW') then
	return	qt_erro_w;
elsif (ie_tipo_inf_p in ('PRI','PRICLI')) then
	return dividir(qt_os_insatisf_w, qt_os_encerrada_classif_w)*100;
elsif (ie_tipo_inf_p in ('ENS','ENSCLI')) then
	return	qt_os_encerrada_classif_w;
elsif (ie_tipo_inf_p = 'PRJIN') then
	return dividir(qt_erro_w, qt_total_os_w)*100;
elsif (ie_tipo_inf_p = 'PRINSJ') then
	return dividir(qt_erro_w, qt_total_os_w)*100;
elsif (ie_tipo_inf_p = 'VEVOS') then
	return qt_os_vev_w;
elsif (ie_tipo_inf_p = 'PHIOS') then
	return qt_os_philips_w;
elsif (ie_tipo_inf_p = 'QTEXT') then
	return	qt_erro_w;
elsif (ie_tipo_inf_p = 'QTPHI') then
	return	qt_erro_w;
elsif (ie_tipo_inf_p in ('TMBC','TMAC')) then
	return	qt_min_os_w;
elsif (ie_tipo_inf_p = 'PRANTIGA') then
	if (trunc(clock_timestamp(),'month') = dt_ref_mes_w) then
		return dividir(qt_erro_w, qt_total_os_w)*100;	
	else
		return qt_erro_w;
	end if;
elsif (ie_tipo_inf_p = 'QTANTIGA') then
	return qt_erro_w;
elsif (ie_tipo_inf_p = 'ERE') then
	return qt_erro_w;
elsif (ie_tipo_inf_p = 'MEHEPF') then
	return	dividir(qt_total_os_w,qt_pessoas_w);
else	
	return 0;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_informacao_os_gerencia (dt_parametro_p timestamp, nr_seq_gerencia_p bigint, ie_tipo_inf_p text, ie_tipo_valor_p text, ie_area_gerencia_p text default 'DES,TEC') FROM PUBLIC;

