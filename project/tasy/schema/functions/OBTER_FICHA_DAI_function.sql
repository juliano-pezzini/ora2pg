-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ficha_dai ( ie_opcao_p text, dt_inicio_p timestamp, dt_final_p timestamp, cd_setor_p bigint, ds_filtro_p text default null) RETURNS bigint AS $body$
DECLARE

/* 
Total de pacientes-dia	'TD' 
Total de pacientes com DAI	'TI' 
Total de Condutas		'TC'	 
*/
 
			 
ds_retorno_w		bigint;
ds_setor_w		varchar(255);
vl_pos_w			bigint;
nr_seq_apresent_w	bigint;
	

BEGIN 
 
if (ds_filtro_p IS NOT NULL AND ds_filtro_p::text <> '') then 
   
ds_setor_w	:= ds_filtro_p;
vl_pos_w	:= position('#' in ds_setor_w);
 
while(vl_pos_w > 0) loop 
	ds_setor_w	:= substr(ds_setor_w, 1, vl_pos_w - 1) || chr(39)||','||chr(39) || substr(ds_setor_w, (vl_pos_w + 1), length(ds_setor_w )-1);
	vl_pos_w	:= position('#' in ds_setor_w);
end loop;
 
ds_setor_w := chr(39)||ds_setor_w||chr(39);
 
end if;
 
If (ie_opcao_p = 'TD') then 
 
	select	count(distinct nr_atendimento) 
	into STRICT	ds_retorno_w 
	from	resumo_atendimento_paciente_v 
	where	trunc(dt_entrada) <= trunc(dt_inicio_p) 
	and	coalesce(dt_alta,fim_dia(dt_inicio_p)) >= fim_dia(dt_inicio_p) 
	and	Obter_Setor_Atendimento(nr_atendimento)= coalesce(cd_setor_p,Obter_Setor_Atendimento(nr_atendimento)) 
	and	CASE WHEN coalesce(ds_filtro_p::text, '') = '' THEN 'S'  ELSE (Obter_Se_Contido_Filtro(obter_nome_setor(cd_setor_atendimento),ds_setor_w)) END  = 'S';
 
elsif (ie_opcao_p = 'TI') then 
 
	select 	count(distinct b.nr_atendimento) 
	into STRICT	ds_retorno_w 
	from	qua_evento_paciente b, 
		qua_tipo_evento d, 
		qua_evento f, 
		qua_evento_dermatite a 
	where	coalesce(b.dt_inativacao::text, '') = '' 
	and	a.nr_seq_evento = b.nr_sequencia 
	and	d.ie_tipo_evento = 'DAI' 
	and	d.nr_sequencia = f.nr_Seq_tipo 
	and	b.nr_Seq_evento = f.nr_sequencia 
	and	a.ie_origem_dermatite = 'U' 
	and	b.dt_evento between trunc(dt_inicio_p) and fim_dia(coalesce(dt_final_p,dt_inicio_p)) 
	and	Obter_Setor_Atendimento(b.nr_atendimento)= coalesce(cd_setor_p,Obter_Setor_Atendimento(b.nr_atendimento)) 
	and	CASE WHEN coalesce(ds_filtro_p::text, '') = '' THEN 'S'  ELSE (Obter_Se_Contido_Filtro(obter_nome_setor(b.cd_setor_atendimento),ds_setor_w)) END  = 'S';
 
 
elsif (ie_opcao_p = 'TC') then 
 
	select 	count(d.nr_sequencia) 
	into STRICT	ds_retorno_w 
	from	pe_prescricao a, 
		gqa_pendencia_pac b,	 
		gqa_pendencia_regra c,	 
		gqa_pend_pac_acao f, 
		pe_prescr_proc g, 
		gqa_acao d, 
		eif_escala h		 
	where	a.nr_seq_pend_pac_acao = f.nr_sequencia 
	and	f.nr_seq_pend_pac = b.nr_sequencia 
	and	b.nr_seq_pend_regra = c.nr_sequencia 
	and	g.nr_seq_prescr = a.nr_sequencia 
	and	d.nr_Seq_proc = g.nr_seq_proc 
	and	d.nr_seq_pend_regra = c.nr_Sequencia 
	and	c.nr_seq_escala = 117 
	and	c.nr_seq_score_flex = h.nr_sequencia 
	and	UPPER(h.ds_escala) like UPPER('%dermatite%')	 
	and	(c.nr_seq_result IS NOT NULL AND c.nr_seq_result::text <> '') 
	and	b.dt_atualizacao_nrec between trunc(dt_inicio_p) and fim_dia(coalesce(dt_final_p,dt_inicio_p)) 
	and	Obter_Setor_Atendimento(b.nr_atendimento)= coalesce(cd_setor_p,Obter_Setor_Atendimento(b.nr_atendimento)) 
	and	CASE WHEN coalesce(ds_filtro_p::text, '') = '' THEN 'S'  ELSE (Obter_Se_Contido_Filtro(obter_nome_setor(Obter_Setor_Atendimento(b.nr_atendimento)),ds_setor_w)) END  = 'S';	
	 
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ficha_dai ( ie_opcao_p text, dt_inicio_p timestamp, dt_final_p timestamp, cd_setor_p bigint, ds_filtro_p text default null) FROM PUBLIC;

