-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_treinamento ( nr_sequencia_p bigint, ie_tipo_retorno_p text, dt_assigned_p timestamp, dt_completion_p timestamp) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(100);
ds_retorno_ww	varchar(1);
dt_limite_w		timestamp;
ie_dia_sem_w	varchar(10);
ie_necessario_w	qms_treinamento.ie_necessario%type := 'S';
		
/*
ie_tipo_retorno_p

C - Código do status
D - Descrição do status
DT - Data limite de realização do treinamento

*/
		

BEGIN

select	coalesce(max(a.ie_necessario),'S')
into STRICT	ie_necessario_w
from	qms_treinamento a
where	a.nr_sequencia = nr_sequencia_p;

if (dt_assigned_p IS NOT NULL AND dt_assigned_p::text <> '') then
	begin
	
	/*select	trunc(dt_assigned_p + 7)
	into	dt_limite_w
	from	dual;	*/

	
	--ie_dia_sem_w	:= obter_cod_dia_semana(dt_limite_w);

	
	/*if	(ie_dia_sem_w = 1) then
		select	trunc(dt_limite_w + 1)
		into	dt_limite_w
		from	dual;	
	elsif	(ie_dia_sem_w = 7) then
		select	trunc(dt_limite_w + 2)
		into	dt_limite_w
		from	dual;	
	end if;*/

	

	
	--Verificar se a data limite cai num final de semana, considera apenas dias ÚTEIS
	select  obter_dia_util_periodo(wheb_usuario_pck.get_cd_estabelecimento, dt_assigned_p, 15)
	into STRICT	dt_limite_w
	;	
	
	if	((trunc(dt_limite_w) >= trunc(clock_timestamp())) and (coalesce(dt_completion_p::text, '') = '')) then
		--Pendente
		select	obter_desc_expressao(889620)
		into STRICT	ds_retorno_w
		;
		
		ds_retorno_ww := 'P';
		
	elsif	((trunc(clock_timestamp()) > trunc(dt_limite_w)) and (coalesce(dt_completion_p::text, '') = '')) then
		--Atrasado
		select	obter_desc_expressao(302651)
		into STRICT	ds_retorno_w
		;	

		ds_retorno_ww := 'A';
		
	end if;
	
	if (dt_completion_p IS NOT NULL AND dt_completion_p::text <> '') then
		--Concluído
		select	obter_desc_expressao(330733)
		into STRICT	ds_retorno_w
		;

		ds_retorno_ww := 'C';
		
	end if;
	
	end;
else
	--Pendente
	select	obter_desc_expressao(889620)
	into STRICT	ds_retorno_w
	;
	
	ds_retorno_ww := 'P';
	
end if;

if (coalesce(dt_assigned_p::text, '') = '') and (dt_completion_p IS NOT NULL AND dt_completion_p::text <> '') then
	begin
	--Concluído
	select	obter_desc_expressao(330733)
	into STRICT	ds_retorno_w
	;

	ds_retorno_ww := 'C';
		
	end;
end if;

if (ie_necessario_w = 'N') then
	ds_retorno_ww := 'N';
	
	--Não necessário
	select	obter_desc_expressao(495456)
	into STRICT	ds_retorno_w
	;
end if;

if (ie_tipo_retorno_p = 'C') then
	ds_retorno_w := ds_retorno_ww;
elsif (ie_tipo_retorno_p = 'DT') then
	ds_retorno_w := to_char(dt_limite_w,'dd/mm/yyyy');
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_treinamento ( nr_sequencia_p bigint, ie_tipo_retorno_p text, dt_assigned_p timestamp, dt_completion_p timestamp) FROM PUBLIC;

