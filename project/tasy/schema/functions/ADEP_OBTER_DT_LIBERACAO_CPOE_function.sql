-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION adep_obter_dt_liberacao_cpoe (nr_seq_cpoe_p bigint, ie_tipo_item_p text) RETURNS timestamp AS $body$
DECLARE


dt_liberacao_w		timestamp;
ie_tipo_proced_w	prescr_procedimento.ie_tipo_proced%type;


BEGIN

if (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') then

	if (ie_tipo_item_p in ('D','DE','SNE','S','LD','J','NPN','NPA','NAN','NPP')) then

		select	max(dt_liberacao)
		into STRICT	dt_liberacao_w
		from	cpoe_dieta
		where	nr_sequencia = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p = 'HM') then

		select	max(dt_liberacao)
		into STRICT	dt_liberacao_w
		from 	cpoe_hemoterapia
		where	nr_sequencia = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p = 'DI') then

		select	max(dt_liberacao)
		into STRICT	dt_liberacao_w
		from	cpoe_dialise
		where	nr_sequencia = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p = 'O') then

		select	max(dt_liberacao)
		into STRICT	dt_liberacao_w
		from	cpoe_gasoterapia
		where	nr_sequencia = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p in ('M', 'MAT', 'SOL', 'IAH', 'ME')) then

		select	max(dt_liberacao)
		into STRICT	dt_liberacao_w
		from	cpoe_material
		where	nr_sequencia = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p = 'R') then

		select	max(dt_liberacao)
		into STRICT	dt_liberacao_w
		from	cpoe_recomendacao
		where	nr_sequencia = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p in ('P','C','G','I','L','MP','IA','IAG','B')) then

		select	max(x.ie_tipo_proced)
		into STRICT	ie_tipo_proced_w
		from (SELECT		a.ie_tipo_proced,
							dt_atualizacao_nrec
				from		prescr_procedimento a
				where		a.nr_seq_proc_cpoe = nr_seq_cpoe_p
				order by	dt_atualizacao_nrec desc) x LIMIT 1;

		if (ie_tipo_proced_w in ('AP', 'APC', 'APH')) then

			select	max(dt_liberacao)
			into STRICT	dt_liberacao_w
			from	cpoe_anatomia_patologica
			where	nr_sequencia = nr_seq_cpoe_p;

		else

			select	max(dt_liberacao)
			into STRICT	dt_liberacao_w
			from	cpoe_procedimento
			where	nr_sequencia = nr_seq_cpoe_p;

		end if;

	elsif (ie_tipo_item_p = 'E') then

		select	max(dt_liberacao)
		into STRICT	dt_liberacao_w
		from	cpoe_intervencao
		where	nr_sequencia = nr_seq_cpoe_p;

	end if;

end if;

return dt_liberacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION adep_obter_dt_liberacao_cpoe (nr_seq_cpoe_p bigint, ie_tipo_item_p text) FROM PUBLIC;

