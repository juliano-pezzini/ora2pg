-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_dc_rate_id ( ie_type_insurance_p bigint, ie_type_encounter_p bigint, ie_type_insurance_acc_p bigint, cd_insurance_p bigint, nr_account_p bigint) RETURNS varchar AS $body$
DECLARE


nr_return_w	          bigint;
ie_type_insurance_w   bigint;
ie_dva_allied_w       smallint;



BEGIN

ie_type_insurance_w  := ie_type_insurance_p;

if (coalesce(cd_insurance_p,0) > 0) then

  select  a.ie_tipo_convenio
  into STRICT    ie_type_insurance_w
  from    convenio a
  where   a.cd_convenio = cd_insurance_p;


  if (ie_type_insurance_w = 13) then

  select  coalesce(max(1),0)
  into STRICT    ie_dva_allied_w
  from    procedimento_paciente a,
          procedimento b
  where   a.cd_procedimento  = b.cd_procedimento
  and     a.ie_origem_proced = b.ie_origem_proced
  and     a.ie_origem_proced = 4
  and     OBTER_DADOS_ESTRUT_PROC(b.cd_procedimento,b.ie_origem_proced,'C','A') = 60
  and     (b.cd_procedimento_loc IS NOT NULL AND b.cd_procedimento_loc::text <> '')
  and     coalesce(a.cd_motivo_exc_conta::text, '') = ''
  and     a.nr_interno_conta = nr_account_p;

  end if;


end if;

-- DVA and Inpatient
if (ie_type_insurance_w = 13) and (ie_type_encounter_p = 1) then

	nr_return_w := 6; -- Insured
-- DVA Allied Health
elsif (ie_type_insurance_w = 13) and (ie_dva_allied_w = 1) then

  nr_return_w := 18; -- DVA Allied Health
-- DVA and OutPatient	
elsif (ie_type_insurance_w = 13) and (ie_type_encounter_p = 8) then

	nr_return_w := 5;	 -- In Room
-- Medicare and Inpatient
elsif (ie_type_insurance_w = 12) and (ie_type_encounter_p = 1) then

		nr_return_w := 3; -- BulkBill
-- Medicare and OutPatient
elsif (ie_type_insurance_w = 12) and (ie_type_encounter_p = 8) then

		nr_return_w := 3; -- BulkBill
-- Health Fund and Inpatient
elsif (ie_type_insurance_w = 2) and (ie_type_encounter_p = 1) then

	nr_return_w := 6; -- Health Fund
--  Health Fund and OutPatient
elsif (ie_type_insurance_w = 2) and (ie_type_encounter_p = 8) then

	nr_return_w := 6; -- Health Fund
end if;

return	nr_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_dc_rate_id ( ie_type_insurance_p bigint, ie_type_encounter_p bigint, ie_type_insurance_acc_p bigint, cd_insurance_p bigint, nr_account_p bigint) FROM PUBLIC;

