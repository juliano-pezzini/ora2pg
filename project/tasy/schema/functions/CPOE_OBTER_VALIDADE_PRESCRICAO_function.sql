-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_validade_prescricao ( nr_atendimento_p bigint, nr_sequencia_itens_p text, dt_primeiro_horario_p timestamp) RETURNS bigint AS $body$
DECLARE

 
dt_prim_horario_w 		cpoe_material.dt_inicio%TYPE;
nr_horas_validade_w 	prescr_medica.nr_horas_validade%TYPE;

BEGIN
 
select	max(a.dt_inicio) 
into STRICT	dt_prim_horario_w 
from (	SELECT	nr_sequencia, 
					to_date(to_char(dt_inicio,'dd/mm/yyyy')||hr_prim_horario,'dd/mm/yyyy hh24:mi:ss') dt_inicio 
			from	cpoe_dieta 
			where	nr_atendimento = nr_atendimento_p 
			and		ie_tipo_dieta <> 'J' 
			
union all
 
			SELECT	nr_sequencia, 
					dt_inicio 
		  from 	cpoe_dieta 
		  where	nr_atendimento = nr_atendimento_p 
		  and 	ie_tipo_dieta = 'J' 
		  
union all
 
		  select	nr_sequencia, 
					to_date(to_char(dt_inicio,'dd/mm/yyyy')||hr_prim_horario,'dd/mm/yyyy hh24:mi:ss') dt_inicio 
		  from	cpoe_material 
		  where	nr_atendimento = nr_atendimento_p 
		  
union all
 
		  select	nr_sequencia, 
					dt_prev_execucao dt_inicio 
		  from	cpoe_procedimento 
		  where	nr_atendimento = nr_atendimento_p 
		  
union all
 
		  select	nr_sequencia, 
					to_date(to_char(dt_inicio,'dd/mm/yyyy')||hr_prim_horario,'dd/mm/yyyy hh24:mi:ss') dt_inicio 
		  from	cpoe_gasoterapia 
		  where	nr_atendimento = nr_atendimento_p 
		  
union all
 
		  select	nr_sequencia, 
					to_date(to_char(dt_inicio,'dd/mm/yyyy')||hr_prim_horario,'dd/mm/yyyy hh24:mi:ss') dt_inicio 
		  from	cpoe_recomendacao 
		  where	nr_atendimento = nr_atendimento_p 
		  
union all
 
		  select	nr_seq_proced nr_sequencia, 
					to_date(to_char(dt_inicio,'dd/mm/yyyy')||hr_prim_horario,'dd/mm/yyyy hh24:mi:ss') dt_inicio 
		  from	cpoe_material_proced_v 
		  where	nr_atendimento = nr_atendimento_p 
		  
union all
 
		  select	nr_seq_gasoterapia nr_sequencia, 
					to_date(to_char(dt_inicio,'dd/mm/yyyy')||hr_prim_horario,'dd/mm/yyyy hh24:mi:ss') dt_inicio 
		  from 	cpoe_material_gaso_v 
		  where 	nr_atendimento = nr_atendimento_p) a 
where	obter_se_valor_contido(a.nr_sequencia,nr_sequencia_itens_p) = 'S';
 
nr_horas_validade_w := coalesce(Obter_tempo_entre_datas(dt_primeiro_horario_p,dt_prim_horario_w,'T'),0) + 24;
 
return nr_horas_validade_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_validade_prescricao ( nr_atendimento_p bigint, nr_sequencia_itens_p text, dt_primeiro_horario_p timestamp) FROM PUBLIC;

