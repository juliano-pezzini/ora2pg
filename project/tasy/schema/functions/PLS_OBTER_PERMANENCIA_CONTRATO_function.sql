-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_permanencia_contrato (nr_contrato_p bigint, nr_plano_p bigint, ie_movimentacao_p text, dt_inicial_p timestamp, dt_final_p timestamp) RETURNS varchar AS $body$
DECLARE


qt_permanencia_0_3_w		bigint := 0;
qt_permanencia_3_6_w		bigint := 0;
qt_permanencia_6_9_w		bigint := 0;
qt_permanencia_9_12_w		bigint := 0;
qt_permanencia_1_2_w		bigint := 0;
qt_permanencia_2_3_w		bigint := 0;
qt_permanencia_3_4_w		bigint := 0;
qt_permanencia_4_5_w		bigint := 0;
qt_permanencia_5_10_w		bigint := 0;
qt_permanencia_10_50_w		bigint := 0;
qt_permanencia_50_100_w		bigint := 0;
qt_meses_w			bigint;

C01 CURSOR FOR
	SELECT	pls_obter_meses_entre_datas(b.dt_contratacao, b.dt_rescisao)
	FROM pessoa_fisica g, pls_contrato_plano d, pls_segurado_carteira c, pls_segurado b, pls_contrato a, pls_contrato_pagador e
LEFT OUTER JOIN pls_contrato_pagador_fin f ON (e.nr_sequencia = f.nr_seq_pagador)
WHERE a.nr_sequencia = b.nr_seq_contrato and b.nr_sequencia = c.nr_seq_segurado and a.nr_sequencia = d.nr_seq_contrato  and e.nr_sequencia = b.nr_seq_pagador and b.cd_pessoa_fisica = g.cd_pessoa_fisica and a.nr_contrato = nr_contrato_p and d.nr_sequencia = nr_plano_p and (b.dt_rescisao IS NOT NULL AND b.dt_rescisao::text <> '') and ((ie_movimentacao_p = 'I' and to_char(b.dt_contratacao, 'dd/mm/yyyy') between dt_inicial_p and dt_final_p) or
		(ie_movimentacao_p = 'E' and ((to_char(b.dt_cancelamento, 'dd/mm/yyyy') between dt_inicial_p and dt_final_p) or (to_char(b.dt_rescisao, 'dd/mm/yyyy') between dt_inicial_p and dt_final_p))) or
		(ie_movimentacao_p = 'A' and ((to_char(b.dt_contratacao, 'dd/mm/yyyy') between dt_inicial_p and dt_final_p) or (to_char(b.dt_cancelamento, 'dd/mm/yyyy') between dt_inicial_p and dt_final_p) or (to_char(b.dt_rescisao, 'dd/mm/yyyy') between dt_inicial_p and dt_final_p))));


BEGIN

open C01;
loop
fetch C01 into
	qt_meses_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (qt_meses_w between 0 and 3) then
		qt_permanencia_0_3_w := qt_permanencia_0_3_w + 1;
	end if;

	if (qt_meses_w between 4 and 6) then
		qt_permanencia_3_6_w := qt_permanencia_3_6_w + 1;
	end if;

	if (qt_meses_w between 7 and 9) then
		qt_permanencia_6_9_w := qt_permanencia_6_9_w + 1;
	end if;

	if (qt_meses_w between 10 and 12) then
		qt_permanencia_9_12_w := qt_permanencia_9_12_w + 1;
	end if;

	if (qt_meses_w between 13 and 24) then
		qt_permanencia_1_2_w := qt_permanencia_1_2_w + 1;
	end if;

	if (qt_meses_w between 25 and 36) then
		qt_permanencia_2_3_w := qt_permanencia_2_3_w + 1;
	end if;

	if (qt_meses_w between 37 and 48) then
		qt_permanencia_3_4_w := qt_permanencia_3_4_w + 1;
	end if;

	if (qt_meses_w between 49 and 60) then
		qt_permanencia_4_5_w := qt_permanencia_4_5_w + 1;
	end if;

	if (qt_meses_w between 61 and 120) then
		qt_permanencia_5_10_w := qt_permanencia_5_10_w + 1;
	end if;

	if (qt_meses_w between 121 and 600) then
		qt_permanencia_10_50_w := qt_permanencia_10_50_w + 1;
	end if;

	if (qt_meses_w between 601 and 1200) then
		qt_permanencia_50_100_w := qt_permanencia_50_100_w + 1;
	end if;

	end;
end loop;
close C01;

return 	qt_permanencia_0_3_w||'
'||	qt_permanencia_3_6_w||'
'||	qt_permanencia_6_9_w||'
'||	qt_permanencia_9_12_w||'
'||	qt_permanencia_1_2_w||'
'||	qt_permanencia_2_3_w||'
'||	qt_permanencia_3_4_w||'
'||	qt_permanencia_4_5_w||'
'||	qt_permanencia_5_10_w||'
'||	qt_permanencia_10_50_w||'
'||	qt_permanencia_50_100_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_permanencia_contrato (nr_contrato_p bigint, nr_plano_p bigint, ie_movimentacao_p text, dt_inicial_p timestamp, dt_final_p timestamp) FROM PUBLIC;

