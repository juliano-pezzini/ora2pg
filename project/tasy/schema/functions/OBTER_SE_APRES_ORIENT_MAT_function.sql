-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_apres_orient_mat ( cd_material_p bigint, cd_pessoa_fisica_p text) RETURNS varchar AS $body$
DECLARE


ie_mostra_orient_w		char(1) := 'S';
ie_sexo_w				varchar(1);
qt_idade_w				double precision;
cd_estabelecimento_w	smallint := wheb_usuario_pck.get_cd_estabelecimento;


BEGIN

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

	select	coalesce(max('N'),'S')
	into STRICT	ie_mostra_orient_w
	from	regra_orient_usuario where		cd_material = cd_material_p LIMIT 1;

	if (ie_mostra_orient_w = 'N') then
		select	max(obter_idade(dt_nascimento,coalesce(dt_obito,clock_timestamp()),'DIA')),
				max(ie_sexo)
		into STRICT	qt_idade_w,
				ie_sexo_w
		from	pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_p;

		select	coalesce(max(ie_mostrar),'N')
		into STRICT	ie_mostra_orient_w
		from	regra_orient_usuario where		cd_material = cd_material_p
		and		coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
		and (qt_idade_w between
					obter_idade_conversao(qt_idade_min,qt_idade_min_mes,qt_idade_min_dia,qt_idade_max,qt_idade_max_mes,qt_idade_max_dia,'MIN') and
					obter_idade_conversao(qt_idade_min,qt_idade_min_mes,qt_idade_min_dia,qt_idade_max,qt_idade_max_mes,qt_idade_max_dia,'MAX'))
		and		((coalesce(ie_sexo::text, '') = '') or (ie_sexo = ie_sexo_w)) LIMIT 1;
	end if;
end if;

return	ie_mostra_orient_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_apres_orient_mat ( cd_material_p bigint, cd_pessoa_fisica_p text) FROM PUBLIC;

