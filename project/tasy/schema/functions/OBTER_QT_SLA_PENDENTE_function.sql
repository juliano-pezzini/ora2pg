-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_sla_pendente ( nr_seq_gerencia_p bigint, nr_seq_grupo_des_p bigint, nr_seq_grupo_sup_p bigint, ie_desenv_p text, ie_encerrada_p text, ie_informacao_p text) RETURNS bigint AS $body$
DECLARE


qt_retorno_w			bigint;


BEGIN

if (ie_informacao_p = 'GRU') then
	begin
	select	count(*)
	into STRICT	qt_retorno_w
	from  	man_ordem_servico_v  a,
		man_ordem_serv_sla    b,
		man_estagio_processo c
	where 	a.nr_sequencia = b.nr_seq_ordem
	and	a.nr_seq_estagio = c.nr_sequencia
	and   	b.nr_seq_status <> 412
	and	man_obter_se_visualiza_os(nr_seq_grupo_des_p, nr_seq_grupo_sup_p, a.nr_seq_grupo_des, a.nr_seq_grupo_sup, a.nr_seq_gerencia_des, a.nr_seq_gerencia_sup,'GR', null) = 'S'
	and (obter_periodo_os(a.nr_sequencia) IS NOT NULL AND (obter_periodo_os(a.nr_sequencia))::text <> '') -------- ADICIONADO PARA QUE NÃO TRAGA OS's QUE NÃO ESTEJAM NA REGRA
	and (a.nr_seq_grupo_des	= nr_seq_grupo_des_p or coalesce(nr_seq_grupo_des_p,0) = 0)
	and	((ie_desenv_p = 'N')  or (Obter_Se_OS_Desenv(b.nr_seq_ordem) = 'S'))
	and   	((ie_encerrada_p = 'N' and ie_status_ordem <> 3) or (ie_encerrada_p = 'S' and ie_status_ordem = 3))
	and (not exists (SELECT	1
			from	man_estagio_processo x
			where	x.nr_sequencia	= a.nr_seq_estagio
			and	coalesce(x.ie_testes,'N') = 'S'
			and	(nr_seq_grupo_des_p IS NOT NULL AND nr_seq_grupo_des_p::text <> '')))
	and	c.ie_aguarda_cliente = 'N'
	and	c.nr_sequencia <> 261;
	end;
elsif (ie_informacao_p = 'GER') then
	begin
	select	count(*)
	into STRICT	qt_retorno_w
	from  	grupo_desenvolvimento c,
		man_ordem_servico_v  a,
		man_ordem_serv_sla    b,
		man_estagio_processo d
	where 	a.nr_sequencia = b.nr_seq_ordem
	and	c.nr_sequencia	= a.nr_seq_grupo_des
	and	a.nr_seq_estagio = d.nr_sequencia
	and	c.nr_seq_gerencia	= nr_seq_gerencia_p
	and   	b.nr_seq_status <> 412
	and (obter_periodo_os(a.nr_sequencia) IS NOT NULL AND (obter_periodo_os(a.nr_sequencia))::text <> '') -------- ADICIONADO PARA QUE NÃO TRAGA OS's QUE NÃO ESTEJAM NA REGRA
	and	man_obter_se_visualiza_os(a.nr_seq_grupo_des, nr_seq_grupo_sup_p, a.nr_seq_grupo_des, a.nr_seq_grupo_sup, a.nr_seq_gerencia_des, a.nr_seq_gerencia_sup,'GR', null) = 'S'
	and	((ie_desenv_p = 'N')  or (Obter_Se_OS_Desenv(b.nr_seq_ordem) = 'S'))
	and   	((ie_encerrada_p = 'N' and ie_status_ordem <> 3) or (ie_encerrada_p = 'S' and ie_status_ordem = 3))
	and (not exists (SELECT	1
			from	man_estagio_processo x
			where	x.nr_sequencia	= a.nr_seq_estagio
			and	coalesce(x.ie_testes,'N') = 'S'
			and	(nr_seq_gerencia_p IS NOT NULL AND nr_seq_gerencia_p::text <> '')))
	and	d.ie_aguarda_cliente = 'N'
	and	d.nr_sequencia <> 261;
	end;
elsif (ie_informacao_p = 'GRUP') then
	begin
	select	count(*)
	into STRICT	qt_retorno_w
	from  	man_ordem_servico_v  a,
		man_ordem_serv_sla    b,
		man_estagio_processo c
	where 	a.nr_sequencia = b.nr_seq_ordem
	and	a.nr_seq_estagio = c.nr_sequencia
	and   	b.nr_seq_status <> 412
	and	man_obter_se_visualiza_os(nr_seq_grupo_des_p, nr_seq_grupo_sup_p, a.nr_seq_grupo_des, a.nr_seq_grupo_sup, a.nr_seq_gerencia_des, a.nr_seq_gerencia_sup,'GR', null) = 'S'
	and (a.nr_seq_grupo_des	= nr_seq_grupo_des_p or coalesce(nr_seq_grupo_des_p,0) = 0)
	and	man_obter_data_prevista_os(a.nr_sequencia) = trunc(clock_timestamp())
	and (obter_periodo_os(a.nr_sequencia) IS NOT NULL AND (obter_periodo_os(a.nr_sequencia))::text <> '') -------- ADICIONADO PARA QUE NÃO TRAGA OS's QUE NÃO ESTEJAM NA REGRA
	and	((ie_desenv_p = 'N')  or (Obter_Se_OS_Desenv(b.nr_seq_ordem) = 'S'))
	and   	((ie_encerrada_p = 'N' and ie_status_ordem <> 3) or (ie_encerrada_p = 'S' and ie_status_ordem = 3))
	and (not exists (SELECT	1
			from	man_estagio_processo x
			where	x.nr_sequencia	= a.nr_seq_estagio
			and	coalesce(x.ie_testes,'N') = 'S'
			and	(nr_seq_grupo_des_p IS NOT NULL AND nr_seq_grupo_des_p::text <> '')))
	and	c.ie_aguarda_cliente = 'N'
	and	c.nr_sequencia <> 261;
	end;
elsif (ie_informacao_p = 'GERP') then
	begin
	select	count(*)
	into STRICT	qt_retorno_w
	from  	grupo_desenvolvimento c,
		man_ordem_servico_v  a,
		man_ordem_serv_sla    b,
		man_estagio_processo d
	where 	a.nr_sequencia = b.nr_seq_ordem
	and	c.nr_sequencia	= a.nr_seq_grupo_des
	and	a.nr_seq_estagio = d.nr_sequencia
	and	c.nr_seq_gerencia	= nr_seq_gerencia_p
	and   	b.nr_seq_status <> 412
	and (obter_periodo_os(a.nr_sequencia) IS NOT NULL AND (obter_periodo_os(a.nr_sequencia))::text <> '') -------- ADICIONADO PARA QUE NÃO TRAGA OS's QUE NÃO ESTEJAM NA REGRA
	and	man_obter_data_prevista_os(a.nr_sequencia) = trunc(clock_timestamp())
	and	man_obter_se_visualiza_os(a.nr_seq_grupo_des, nr_seq_grupo_sup_p, a.nr_seq_grupo_des, a.nr_seq_grupo_sup, a.nr_seq_gerencia_des, a.nr_seq_gerencia_sup,'GR', null) = 'S'
	and	((ie_desenv_p = 'N')  or (Obter_Se_OS_Desenv(b.nr_seq_ordem) = 'S'))
	and   	((ie_encerrada_p = 'N' and ie_status_ordem <> 3) or (ie_encerrada_p = 'S' and ie_status_ordem = 3))
	and (not exists (SELECT	1
			from	man_estagio_processo x
			where	x.nr_sequencia	= a.nr_seq_estagio
			and	coalesce(x.ie_testes,'N') = 'S'
			and	(nr_seq_gerencia_p IS NOT NULL AND nr_seq_gerencia_p::text <> '')))
	and	d.ie_aguarda_cliente = 'N'
	and	d.nr_sequencia <> 261;
	end;
end if;


return	coalesce(qt_retorno_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_sla_pendente ( nr_seq_gerencia_p bigint, nr_seq_grupo_des_p bigint, nr_seq_grupo_sup_p bigint, ie_desenv_p text, ie_encerrada_p text, ie_informacao_p text) FROM PUBLIC;

