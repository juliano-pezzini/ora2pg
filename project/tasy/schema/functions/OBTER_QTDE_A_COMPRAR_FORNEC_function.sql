-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qtde_a_comprar_fornec ( cd_material_p bigint, qt_estoque_p bigint, qt_max_estoque_p bigint, cd_estabelecimento_p bigint, cd_cgc_p text) RETURNS bigint AS $body$
DECLARE

 
qt_conversao_w			double precision;
qt_conv_divisao_w		double precision;
qt_ordem_w			double precision;
qt_solic_w			double precision;
qt_Cotacao_w			double precision;
qt_compra_w			double precision;
qt_consumo_mensal_w		double precision;
qt_desvio_padrao_cons_w		double precision;
qt_coefic_variacao_w		double precision;
ie_consumo_ressup_w		varchar(15);
ie_arredond_ressup_w		varchar(1);
ie_cons_solic_ressup_w		varchar(1);
ie_cons_cot_ressup_w		varchar(1);
ie_coeficiente_variacao_w	varchar(1);
mod_w				double precision;
cd_unid_med_compra_regra_w	unidade_medida.cd_unidade_medida%type;
cd_unidade_medida_compra_w	unidade_medida.cd_unidade_medida%type;
cd_unidade_medida_estoque_w	unidade_medida.cd_unidade_medida%type;
qt_conv_compra_estoque_w	material.qt_conv_compra_estoque%type;


BEGIN 
 
select	coalesce(qt_ordem_compra,0), 
	coalesce(qt_solic_compra,0), 
	coalesce(qt_cotacao_compra,0) 
into STRICT	qt_ordem_w, 
	qt_solic_w, 
	qt_cotacao_w 
from	material_ressuprimento 
where	cd_material	= cd_material_p 
and	cd_estabelecimento = cd_estabelecimento_p;
 
select	coalesce(b.qt_desvio_padrao_cons,0), 
	CASE WHEN ie_consumo_ressup_w='N' THEN b.qt_consumo_mensal_ressup  ELSE b.qt_consumo_mensal END , 
	a.cd_unidade_medida_compra, 
	a.cd_unidade_medida_estoque, 
	a.qt_conv_compra_estoque 
into STRICT	qt_desvio_padrao_cons_w, 
	qt_consumo_mensal_w, 
	cd_unidade_medida_compra_w, 
	cd_unidade_medida_estoque_w, 
	qt_conv_compra_estoque_w 
from	material a, 
	material_estab b 
where	a.cd_material = b.cd_material 
and	a.cd_material	= cd_material_p 
and	b.cd_estabelecimento = cd_estabelecimento_p;
 
if (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then 
	begin 
	select 	coalesce(obter_med_conversao_compra(cd_material_p,cd_cgc_p,'Q',cd_estabelecimento_p),1), 
		obter_med_conversao_compra(cd_material_p,cd_cgc_p,'U',cd_estabelecimento_p) 
	into STRICT	qt_conversao_w, 
		cd_unid_med_compra_regra_w 
	;
	end;
else 
	begin 
	select	coalesce(qt_conv_compra_estoque,1) 
	into STRICT	qt_conversao_w 
	from	material 
	where	cd_material = cd_material_p;
	end;
end if;
 
select 	ie_arredond_ressup, 
	coalesce(ie_cons_solic_ressup,'S'), 
	coalesce(ie_cons_cot_ressup,'S'), 
	coalesce(ie_coeficiente_variacao,'N'), 
	coalesce(ie_consumo_ressup,'S') 
into STRICT	ie_arredond_ressup_w, 
	ie_cons_solic_ressup_w, 
	ie_cons_cot_ressup_w, 
	ie_coeficiente_variacao_w, 
	ie_consumo_ressup_w 
from 	parametro_compras 
where 	cd_estabelecimento = cd_estabelecimento_p;
 
if (ie_cons_solic_ressup_w in ('N','M')) then 
	qt_solic_w := 0;
end if;
 
if (ie_cons_cot_ressup_w in ('N','M')) then 
	qt_cotacao_w := 0;
end if;
 
qt_compra_w	:= qt_max_estoque_p - qt_estoque_p - 
		(qt_ordem_w + qt_solic_w + qt_cotacao_w);
		 
if (ie_coeficiente_variacao_w = 'S') and (qt_desvio_padrao_cons_w > 0) and (qt_consumo_mensal_w > 0) and (qt_compra_w > 0) then 
	qt_coefic_variacao_w := dividir(qt_desvio_padrao_cons_w,qt_consumo_mensal_w) * 100;
	qt_compra_w := qt_compra_w + (qt_compra_w * qt_coefic_variacao_w / 100);
end if;
 
mod_w := round((mod(qt_compra_w, qt_conversao_w))::numeric,4);
 
if (cd_unid_med_compra_regra_w IS NOT NULL AND cd_unid_med_compra_regra_w::text <> '') and /*OS 980038 Foi colocado esse IF para n達o efetuar a divis達o da convers達o quando houver regra de convers達o por fornecedor, e que as unidades de medidas fossem todas iguais*/
 
	(cd_unidade_medida_compra_w = cd_unid_med_compra_regra_w) and (cd_unidade_medida_estoque_w = cd_unid_med_compra_regra_w) and (qt_conv_compra_estoque_w = 1) then 
	qt_conv_divisao_w := 1;
else 
	qt_conv_divisao_w := qt_conversao_w;
end if;	
 
 
if (qt_compra_w	<= 0) then 
	qt_compra_w	:= 0;
	 
elsif (ie_arredond_ressup_w = 'C') and (mod_w <> 0) then 
	qt_compra_w := qt_compra_w - mod_w;
	qt_compra_w := qt_compra_w + qt_conversao_w;
 
	if (qt_conversao_w > 1) then 
		qt_compra_w	:= round((dividir(qt_compra_w, qt_conv_divisao_w))::numeric,0);
	end if;	
	 
elsif (ie_arredond_ressup_w = 'B') and (mod_w <> 0) then 
	qt_compra_w := qt_compra_w - mod_w;
	 
	if (qt_conversao_w > 1) then 
		qt_compra_w := round((dividir(qt_compra_w, qt_conv_divisao_w))::numeric,0);	
	end if;
	 
else	begin 
	if (qt_compra_w	< qt_conversao_w) then 
		qt_compra_w	:= 1;
	else 
		qt_compra_w	:= round((dividir(qt_compra_w, qt_conv_divisao_w))::numeric,0);
	end if;
	end;
end if;
 
return qt_compra_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qtde_a_comprar_fornec ( cd_material_p bigint, qt_estoque_p bigint, qt_max_estoque_p bigint, cd_estabelecimento_p bigint, cd_cgc_p text) FROM PUBLIC;

