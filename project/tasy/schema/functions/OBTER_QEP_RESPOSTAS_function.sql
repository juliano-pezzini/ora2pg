-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qep_respostas ( nr_seq_que_atend_questao_p bigint, ie_opcao_p text, ie_tipo_resposta_p text, ie_retornar_dor_p text default 'N') RETURNS varchar AS $body$
DECLARE

/* ie_opcao_p:
C = nr_sequencia da que_questao_opcao (da função Questionário Eletrônico Paciente)
D = descrição da opção
O = observação da resposta
*/
ds_retorno_w			varchar(4000);
cd_opcao_w			que_questao_opcao.nr_sequencia%type;
ds_opcao_w			que_questao_opcao.ds_opcao%type;
ds_resposta_w			que_atendimento_questao_op.ds_resposta%type;
nr_seq_tasy_padrao_cor_w	que_atendimento_questao_op.nr_seq_tasy_padrao_cor%type;
cd_perfil_w			perfil.cd_perfil%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ds_item_legenda_w		tasy_padrao_cor.ds_item%type;

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.ds_opcao,
		b.nr_seq_tasy_padrao_cor
	from	que_questao_opcao a,
		que_atendimento_questao_op b
	where	a.nr_sequencia = b.nr_seq_que_questao_opcao
	and	b.nr_seq_que_atend_questao = nr_seq_que_atend_questao_p
	order by coalesce(a.nr_seq_apres,9999), a.ds_opcao;

BEGIN

if (ie_opcao_p = 'O') then
	select	max(ds_observacao)
	into STRICT	ds_retorno_w
	from	que_atendimento_questao_op
	where	nr_seq_que_atend_questao = nr_seq_que_atend_questao_p
	and	(ds_observacao IS NOT NULL AND ds_observacao::text <> ''); -- caso houver registros de resposta multiseleção com observação nula
else
	if (ie_tipo_resposta_p = 'D') then

		select	null,
			max(ds_resposta)
		into STRICT	cd_opcao_w,
			ds_resposta_w
		from	que_atendimento_questao_op
		where	nr_seq_que_atend_questao = nr_seq_que_atend_questao_p;

		if (ie_opcao_p = 'C') then
			ds_retorno_w	:= cd_opcao_w;
		elsif (ie_opcao_p = 'D') then
			ds_retorno_w	:= ds_resposta_w;
		end if;

	elsif (ie_tipo_resposta_p = 'S') then
		select	to_char(max(a.nr_sequencia)),
			max(a.ds_opcao)
		into STRICT	cd_opcao_w,
			ds_opcao_w
		from	que_questao_opcao a,
			que_atendimento_questao_op b
		where	a.nr_sequencia = b.nr_seq_que_questao_opcao
		and	b.nr_seq_que_atend_questao = nr_seq_que_atend_questao_p;

		if (ie_opcao_p = 'C') then
			ds_retorno_w	:= cd_opcao_w;
		elsif (ie_opcao_p = 'D') then
			ds_retorno_w	:= ds_opcao_w;
		end if;
	else
		cd_perfil_w		:= wheb_usuario_pck.get_cd_perfil;
		cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
		open C01;
		loop
		fetch C01 into
			cd_opcao_w,
			ds_opcao_w,
			nr_seq_tasy_padrao_cor_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
				ds_retorno_w	:= ds_retorno_w || ',';
			end if;

			if (ie_opcao_p = 'C') then
				ds_retorno_w	:= ds_retorno_w || cd_opcao_w;
				if (ie_retornar_dor_p = 'S') and (nr_seq_tasy_padrao_cor_w IS NOT NULL AND nr_seq_tasy_padrao_cor_w::text <> '') then
					ds_retorno_w	:= ds_retorno_w || '=' || ds_item_legenda_w;
				end if;

			elsif (ie_opcao_p = 'D') then
				ds_retorno_w	:= ds_retorno_w || ds_opcao_w;

				if (ie_retornar_dor_p = 'S') and (nr_seq_tasy_padrao_cor_w IS NOT NULL AND nr_seq_tasy_padrao_cor_w::text <> '') and (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') and (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then

					select	max(coalesce(a.ds_item, obter_desc_expressao(b.cd_exp_item,b.ds_item)))
					into STRICT	ds_item_legenda_w
					FROM tasy_padrao_cor b
LEFT OUTER JOIN tasy_padrao_cor_cliente a ON (b.nr_sequencia = a.nr_seq_cor)
WHERE b.nr_seq_legenda = 1133  -- legenda intensidade da dor
  and b.nr_sequencia = nr_seq_tasy_padrao_cor_w;

					if (ds_item_legenda_w IS NOT NULL AND ds_item_legenda_w::text <> '') then
						ds_retorno_w	:= ds_retorno_w || '(' || ds_item_legenda_w || ')';
					end if;
				end if;
			end if;

			end;
		end loop;
		close C01;
	end if;
end if;

return	substr(ds_retorno_w,1,2000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qep_respostas ( nr_seq_que_atend_questao_p bigint, ie_opcao_p text, ie_tipo_resposta_p text, ie_retornar_dor_p text default 'N') FROM PUBLIC;

