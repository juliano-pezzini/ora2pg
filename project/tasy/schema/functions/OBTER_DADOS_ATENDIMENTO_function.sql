-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_atendimento (NR_ATENDIMENTO_P bigint, IE_OPCAO_P text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(255);
ds_retorno_ww		varchar(255);
nr_Atendimento_mae_w	bigint;

nr_seq_aux_w		bigint;
nr_seq_classificacao_w	bigint;
ds_classificacao_w		varchar(255);
nr_atend_original_w		bigint;
cd_procedencia_w	procedencia.cd_procedencia%type;

/*

NP	- Nome paciente.

TA	- Tipo atendimento.

DTA	- Descricao tipo atendimento.

CC	- Codigo convenio.

NC	- Nome convenio.

DA	- Data alta.

MR	- Medico responsavel.

NMR	- Nome medico responsavel

DE	- Data entrada.

DR	- Data Saida Real

CA	- Carater atendimento

MRF	- Medico Referido

LEI	- Leito do Paciente

DAP	- Data Prevista Alta

CL	- Clinica

PR	- Probabilidade Alta

DET	- Data entrada truncada

DC	- Data chamada paciente

CMA  	- Codigo do Motivo de Alta

DFC	- Data fim conta

CP	- Codigo da pessoa fisica]

OBS	- Observacoes

TC	- Tipo do Convenio

PSCD	- Cod. Setor de atendimento

AAM	- Alta atendimento mae 

EST	- Estabelecimento

PFR	- Pessoa fisica responsavel

DAM	- Data alta medico

UAM	- Usuario alta medico

SA	- Senha atendimento

US	- Usuario saida

DATM	- Data atendimento medico

ACI	- Sequencia do tipo de acidente - nr_seq_tipo_acidente

ID	- Indicacao

DID	- Descricao da Indicacao

CHA	- Status chamado na funcao Painel de chamada

CLP	- Procedimento da classificacao do atendimento. Consulta / Re-consulta  ou a classificacao. Utilizado na agenda de consulta do PEP.

PV	- Permite visita

PA	- Perfil Ativo

INF 	- Medico infectologista

FCO 	- dt_fim_consulta 

HI 	- Se tem Hipertensao arterial 

DI 	- Se tem Diabetes 

DPOC 	- Se tem Doenca pulmonar obstrutiva cronica

ICC 	- Se tem Insuficiencia cardiaca congestiva

CAN	- Se tem Cancer

AI	- Se tem AIDS

IRC 	- Se tem Insuficiencia renal cronica 

EPI	- nr_seq_episodio

CGC_PROC	- cd_cgc_procedencia

CGC_TRANS - cd_cgc para atendimentos  transferidos

ME - Medico Externo

NME - Nome Medico Externo
CRMNME - CRM + Nome Medico Externo

*/
BEGIN

IF (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') THEN

	IF (coalesce(ie_opcao_p, 'DA') = 'DA') THEN

		SELECT	max(TO_CHAR(a.dt_alta, 'dd/mm/yyyy hh24:mi:ss'))

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'CP') = 'CP') THEN

		SELECT	cd_pessoa_fisica

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'CC') THEN

		SELECT	TO_CHAR(obter_convenio_atendimento(a.nr_atendimento))

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'NC') THEN

		SELECT	SUBSTR(obter_nome_convenio(obter_convenio_atendimento(a.nr_atendimento)),1,40)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'NP') THEN

		SELECT	SUBSTR(obter_nome_pf(a.cd_pessoa_fisica),1,60)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'TA') THEN

		SELECT	TO_CHAR(a.ie_tipo_atendimento)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DTA') THEN

		SELECT	SUBSTR(obter_valor_dominio(12, a.ie_tipo_atendimento),1,80)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'MR') THEN

		SELECT	a.cd_medico_resp

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'NMR') THEN

		SELECT	SUBSTR(obter_nome_pf(a.cd_medico_resp),1,200)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DE') THEN

		SELECT	TO_CHAR(a.dt_entrada, 'dd/mm/yyyy hh24:mi:ss')

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'CA') THEN

		SELECT	SUBSTR(obter_valor_dominio(802,IE_CARATER_INTER_SUS),1,255)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DR') THEN

		SELECT	TO_CHAR(a.dt_saida_real, 'dd/mm/yyyy hh24:mi:ss')

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'MRF') THEN

		SELECT	cd_medico_referido

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DAP') = 'DAP') THEN

		SELECT	TO_CHAR(dt_previsto_alta,'dd/mm/yyyy hh24:mi:ss')

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'CL') = 'CL') THEN

		SELECT	TO_CHAR(ie_clinica)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'PR') THEN

		SELECT	ie_probabilidade_alta

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DET') THEN

		SELECT	TO_CHAR(a.dt_entrada, 'dd/mm/yyyy')

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DC') THEN

		SELECT	TO_CHAR(a.dt_chamada_paciente, 'dd/mm/yyyy hh24:mi:ss')

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'CMA') THEN

		SELECT	a.cd_motivo_alta

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DFC') THEN

		SELECT	dt_fim_conta

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'OBS') THEN

		SELECT	ds_observacao

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'PSET') = 'PSET') THEN

		SELECT	coalesce(MAX(e.ds_setor_atendimento),0)

		INTO STRICT	ds_retorno_w

		FROM 	setor_atendimento e,

			atend_paciente_unidade a

		WHERE	a.nr_atendimento 		= nr_atendimento_p

		AND	e.cd_setor_atendimento		= a.cd_setor_atendimento

	  	AND 	nr_seq_interno	=

			(SELECT MIN(coalesce(nr_seq_interno,0))

			FROM 	Setor_Atendimento y,

				atend_paciente_unidade b

			WHERE 	nr_atendimento 	= nr_atendimento_p

		  	AND 	b.cd_setor_atendimento	= y.cd_setor_atendimento);
			
        ELSIF (coalesce(ie_opcao_p, 'PSCD') = 'PSCD') then

		SELECT	coalesce(max(e.cd_setor_atendimento),0)

		into STRICT	ds_retorno_w

		from 	setor_atendimento e,

			atend_paciente_unidade a

		where	a.nr_atendimento 		= nr_atendimento_p

		and	e.cd_setor_atendimento		= a.cd_setor_atendimento

	  	and 	nr_seq_interno	=

			(SELECT min(coalesce(nr_seq_interno,0))

			from 	Setor_Atendimento y,

				atend_paciente_unidade b

			where 	nr_atendimento 	= nr_atendimento_p

		  	and 	b.cd_setor_atendimento	= y.cd_setor_atendimento);

	ELSIF (coalesce(ie_opcao_p, 'TC') = 'TC') THEN

		SELECT	ie_tipo_convenio

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'AAM') = 'AAM') THEN

		SELECT	MAX(nr_Atendimento_mae)

		INTO STRICT	nr_Atendimento_mae_w

		FROM	atendimento_paciente

		WHERE	nr_Atendimento	= nr_atendimento_p;

		

		SELECT	MAX(TO_CHAR(a.dt_alta, 'dd/mm/yyyy hh24:mi:ss'))

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_Atendimento_mae_w;

	ELSIF (coalesce(ie_opcao_p, 'EST') = 'EST') THEN

		SELECT	MAX(cd_estabelecimento)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente

		WHERE	nr_Atendimento	= nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'PFR') = 'PFR') THEN

		SELECT	MAX(cd_pessoa_responsavel)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente

		WHERE	nr_Atendimento	= nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DAM') = 'DAM') THEN

		SELECT	TO_CHAR(a.dt_alta_medico, 'dd/mm/yyyy hh24:mi:ss')

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;
		
	ELSIF (coalesce(ie_opcao_p, 'UAM') = 'UAM') THEN

		SELECT	max(nm_usuario_alta_medica)
		INTO STRICT	ds_retorno_w
		FROM	atendimento_paciente a
		WHERE	a.nr_atendimento = nr_atendimento_p;
				
	ELSIF (coalesce(ie_opcao_p, 'FCO') = 'FCO') THEN

		SELECT	TO_CHAR(a.dt_fim_consulta, 'dd/mm/yyyy hh24:mi:ss')

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;		

	ELSIF (coalesce(ie_opcao_p, 'SA') = 'SA') THEN

		SELECT	MAX(ds_senha)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'US') = 'US') THEN

		SELECT	MAX(nm_usuario_saida)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a

		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p,'DATM') = 'DATM') THEN

		SELECT	MAX(dt_atend_medico)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente

		WHERE	nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p,'ACI') = 'ACI') THEN

		SELECT	MAX(nr_seq_tipo_acidente)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente

		WHERE	nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'DFA') THEN

		SELECT	MIN(nr_seq_interno)

		INTO STRICT	nr_seq_aux_w

		FROM	atend_paciente_unidade

		WHERE	nr_atendimento	= nr_atendimento_p;

		

		IF (nr_seq_aux_w IS NOT NULL AND nr_seq_aux_w::text <> '') THEN

      SELECT	TO_CHAR(MAX(a.dt_atualizacao_nrec), 'dd/mm/yyyy hh24:mi:ss')

			INTO STRICT	ds_retorno_w

			FROM	atend_paciente_unidade a

			WHERE	a.nr_seq_interno = nr_seq_aux_w;

		

		END IF;

	ELSIF (coalesce(ie_opcao_p, 'ID') = 'ID') THEN

		SELECT	MAX(nr_seq_indicacao)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente

		WHERE	nr_atendimento	= nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DID') = 'DID') THEN

		SELECT	MAX(b.ds_indicacao)

		INTO STRICT	ds_retorno_w

		FROM	atendimento_paciente a,

			tipo_indicacao b

		WHERE	a.nr_atendimento	= nr_atendimento_p

		AND	a.nr_seq_indicacao	= b.nr_sequencia;		
	ELSIF (coalesce(ie_opcao_p, 'LEI') = 'LEI') THEN

		SELECT	MAX(a.cd_unidade_basica ||' '||a.CD_UNIDADE_COMPL)

		INTO STRICT	ds_retorno_w

		FROM	atend_paciente_unidade a

		WHERE	a.nr_atendimento	= nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'IDADE') = 'IDADE') THEN

		select	 max(obter_idade_pf(a.cd_pessoa_fisica,clock_timestamp(),'A'))
		into STRICT	ds_retorno_w
		from	atendimento_paciente a
		where	a.nr_atendimento	= nr_atendimento_p;
		
	ELSIF (coalesce(ie_opcao_p, 'CHA') = 'CHA') THEN

		select	coalesce(ie_chamado,'N')
		into STRICT	ds_retorno_w
		from	atendimento_paciente a
		where	a.nr_atendimento	= nr_atendimento_p;
		
		if (coalesce(ds_retorno_w,'N') != 'X') then
		
			begin
				select	'X'
				into STRICT	ds_retorno_ww
				from	atendimento_paciente b,
					paciente_senha_fila a
				where	b.nr_atendimento	= nr_atendimento_p
				and	b.nr_seq_pac_senha_fila = a.nr_sequencia
				and	(a.dt_inutilizacao IS NOT NULL AND a.dt_inutilizacao::text <> '')  LIMIT 1;		
				
				ds_retorno_w := ds_retorno_ww;
				
			exception
			when others then
				ds_retorno_w := ds_retorno_w;
			end;
				
		end if;
		
	ELSIF (coalesce(ie_opcao_p, 'PV') = 'PV') THEN

		select	coalesce(max(ie_permite_visita),'')
		into STRICT	ds_retorno_w
		from	atendimento_paciente a
		where	a.nr_atendimento	= nr_atendimento_p;
				
	ELSIF (coalesce(ie_opcao_p, 'CLP') = 'CLP') THEN

		select	nr_seq_classificacao,
			nr_atend_original
		into STRICT	nr_seq_classificacao_w,
			nr_atend_original_w
		from	atendimento_paciente a
		where	a.nr_atendimento	= nr_atendimento_p;		
		
		if (coalesce(nr_seq_classificacao_w::text, '') = '') then
			
			if ( nr_atend_original_w > 0 ) then			
				ds_classificacao_w := WHEB_MENSAGEM_PCK.get_texto(299058,null);
			else
				ds_classificacao_w := WHEB_MENSAGEM_PCK.get_texto(299060,null);
			end if;
		else
			select	ds_classificacao
			into STRICT	ds_classificacao_w
			from	classificacao_atendimento
			where	nr_sequencia = nr_seq_classificacao_w;
			
			
			If (Upper(ds_classificacao_w) like 'CONSULTA') then
			
				if ( nr_atend_original_w > 0 )  then			
					ds_classificacao_w := WHEB_MENSAGEM_PCK.get_texto(299058,null);
				else
					ds_classificacao_w := WHEB_MENSAGEM_PCK.get_texto(299060,null);
				end if;
				
			end if;
			
		end if;

		ds_retorno_w := ds_classificacao_w;
	
	ELSIF (coalesce(ie_opcao_p, 'INF') = 'INF') THEN

		select	coalesce(max(CD_MEDICO_INFECT),'')
		into STRICT	ds_retorno_w
		from	atendimento_paciente a
		where	a.nr_atendimento	= nr_atendimento_p;	
		
	ELSIF (coalesce(ie_opcao_p, 'PA') = 'PA') THEN

		SELECT	a.cd_perfil_ativo
		INTO STRICT	ds_retorno_w
		FROM	atendimento_paciente a
		WHERE	a.nr_atendimento = nr_atendimento_p;
	
	ELSIF (coalesce(ie_opcao_p, 'HI') = 'HI') THEN
	
		select  coalesce(max('S'),'N')
		into STRICT    ds_retorno_w
		from 	diagnostico_doenca a,
				cid_doenca b 
		where 	a.cd_doenca = b.cd_doenca
		and   	cd_categoria_cid IN ('I10', 'I11', 'I12', 'I13', 'I15')
		and   	nr_atendimento = nr_atendimento_p;
		
	ELSIF (coalesce(ie_opcao_p, 'DI') = 'DI') THEN
	
		select  coalesce(max('S'),'N')
		into STRICT    ds_retorno_w
		from 	diagnostico_doenca a,
				cid_doenca b 
		where 	a.cd_doenca = b.cd_doenca
		and   	cd_categoria_cid IN ('E10', 'E11', 'E12', 'E13', 'E14', 'E15')
		and   	nr_atendimento = nr_atendimento_p;
		
	ELSIF (coalesce(ie_opcao_p, 'DPOC') = 'DPOC') THEN
	
		select  coalesce(max('S'),'N')
		into STRICT    ds_retorno_w
		from 	diagnostico_doenca a,
				cid_doenca b 
		where 	a.cd_doenca = b.cd_doenca
		and   	cd_categoria_cid IN ('J40', 'J41', 'J42', 'J43', 'J44', 'J45', 'J46', 'J47')
		and   	nr_atendimento = nr_atendimento_p;
		
	ELSIF (coalesce(ie_opcao_p, 'IC') = 'ICC') THEN
	
		select  coalesce(max('S'),'N')
		into STRICT    ds_retorno_w
		from 	diagnostico_doenca a,
				cid_doenca b 
		where 	a.cd_doenca = b.cd_doenca
		and   	cd_categoria_cid IN ('I42', 'I43', 'I50')
		and   	nr_atendimento = nr_atendimento_p;
		
	ELSIF (coalesce(ie_opcao_p, 'CAN') = 'CAN') THEN
	
		select  coalesce(max('S'),'N')
		into STRICT    ds_retorno_w
		from 	diagnostico_doenca a,
				cid_doenca b 
		where 	a.cd_doenca = b.cd_doenca
		and   	cd_categoria_cid IN (	'C00', 'C01', 'C02', 'C03', 'C04', 'C05', 'C06', 'C07', 'C08', 'C09', 'C10', 'C11', 'C12', 'C13', 'C14',
						'C15', 'C16', 'C17', 'C18', 'C19', 'C20', 'C21', 'C22', 'C23', 'C24', 'C25', 'C30', 'C31', 'C32', 'C33', 'C34', 'C37',
						'C38', 'C39', 'C40', 'C41', 'C43', 'C44', 'C45', 'C46', 'C47', 'C48', 'C49', 'C50', 'C51', 'C52', 'C53', 'C54', 'C55',
						'C56', 'C57', 'C58', 'C60', 'C61', 'C62', 'C63', 'C64', 'C65', 'C66', 'C67', 'C68', 'C69', 'C70', 'C71', 'C72', 'C73',
						'C74', 'C75', 'C76', 'C77', 'C78', 'C79', 'C80', 'C81', 'C82', 'C83', 'C84', 'C85', 'C88', 'C90', 'C91', 'C92', 'C93',
						'C94', 'C95', 'C96', 'C97', 'D00', 'D01', 'D02', 'D03', 'D04', 'D05', 'D06', 'D07', 'D09', 'D10', 'D11', 'D12', 'D13',
						'D14', 'D15', 'D16', 'D17', 'D18', 'D19', 'D20', 'D21', 'D22', 'D23', 'D24', 'D25', 'D26', 'D27', 'D28', 'D29', 'D30',
						'D31', 'D32', 'D33', 'D34', 'D35', 'D36', 'D37', 'D38', 'D39', 'D40', 'D41', 'D42', 'D43', 'D44', 'D45', 'D46', 'D47',
						'D48', 'C010', 'C070', 'C120', 'C190', 'C200', 'C230', 'C330', 'C370', 'C520', 'C550', 'C560', 'C580', 'C610', 'C640',
						'C650', 'C660', 'C730', 'C969', 'C970', 'D240', 'D270', 'D340', 'D450')
		and   	nr_atendimento = nr_atendimento_p;
		
	ELSIF (coalesce(ie_opcao_p, 'AI') = 'AI') THEN
	
		select  coalesce(max('S'),'N')
		into STRICT    ds_retorno_w
		from 	diagnostico_doenca a,
				cid_doenca b 
		where 	a.cd_doenca = b.cd_doenca
		and   	cd_categoria_cid IN ('B20', 'B21', 'B23', 'Z26')
		and   	nr_atendimento = nr_atendimento_p;
		
	ELSIF (coalesce(ie_opcao_p, 'IR') = 'IRC') THEN
	
		SELECT  coalesce(max('S'),'N')
		INTO STRICT    ds_retorno_w
		FROM 	diagnostico_doenca a,
				cid_doenca b 
		WHERE 	a.cd_doenca = b.cd_doenca
		AND   	cd_categoria_cid IN ('N17', 'N18', 'N19')
		AND   	nr_atendimento = nr_atendimento_p;
		
	ELSIF (coalesce(ie_opcao_p, 'IR') = 'EPI') THEN
		SELECT	MAX(nr_seq_episodio)
		INTO STRICT	ds_retorno_w
		FROM	atendimento_paciente
		WHERE	nr_Atendimento	= nr_atendimento_p;

	ELSIF (ie_opcao_p = 'CGC_PROC') THEN
		
		select	max(cd_procedencia)
		into STRICT	cd_procedencia_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
		
		if (cd_procedencia_w > 0) then
		
			select	max(cd_cgc_procedencia)
			into STRICT	ds_retorno_w
			from	procedencia
			where	cd_procedencia = cd_procedencia_w;
		end if;
		
	ELSIF (ie_opcao_p = 'CGC_TRANS') then
		
		select	cd_cgc
		into STRICT	ds_retorno_w
		from	atendimento_transf
		where	nr_atendimento = nr_atendimento_p;	
		
	ELSIF (coalesce(ie_opcao_p, 'DA') = 'ME') THEN

		SELECT	a.crm_medico_externo
		INTO STRICT	ds_retorno_w
		FROM	atendimento_paciente a
		WHERE	a.nr_atendimento = nr_atendimento_p;

	ELSIF (coalesce(ie_opcao_p, 'DA') = 'NME') THEN

		SELECT	a.nm_medico_externo
		INTO STRICT	ds_retorno_w
		FROM	atendimento_paciente a
		WHERE	a.nr_atendimento = nr_atendimento_p;
	
	ELSIF (coalesce(ie_opcao_p, 'DA') = 'CRMNME') THEN

		select	CASE WHEN coalesce(a.crm_medico_externo::text, '') = '' THEN  ''  ELSE '(' || a.crm_medico_externo || ') ' END  || a.nm_medico_externo
		into STRICT	ds_retorno_w
		from	atendimento_paciente a
		where	a.nr_atendimento = nr_atendimento_p;
			
	END IF;

END IF;

RETURN	ds_retorno_w;



END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_atendimento (NR_ATENDIMENTO_P bigint, IE_OPCAO_P text) FROM PUBLIC;

