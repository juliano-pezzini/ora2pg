-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_pontuacao_telehealth (nr_atendimento_p bigint, ds_table_p text, ds_table_nr_field_p text, ds_table_dt_field_p text, vl_rownumber_p bigint) RETURNS bigint AS $body$
DECLARE


ds_pontuacao_w         double precision := null;
ds_sql                 varchar(4000);
filtrar_liberacao_w    tabela_atributo.nr_sequencia_criacao%type;
filtrar_inativacao_w   tabela_atributo.nr_sequencia_criacao%type;


BEGIN

if ((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and
    (ds_table_p IS NOT NULL AND ds_table_p::text <> '') and
    (ds_table_nr_field_p IS NOT NULL AND ds_table_nr_field_p::text <> '') and 
    (ds_table_dt_field_p IS NOT NULL AND ds_table_dt_field_p::text <> '') and
    (vl_rownumber_p IS NOT NULL AND vl_rownumber_p::text <> '')) then

  select max(a.nr_sequencia_criacao)
    into STRICT filtrar_liberacao_w
    from tabela_atributo a
    where a.nm_tabela = upper(ds_table_p)
      and a.nm_atributo = 'DT_LIBERACAO';

  select max(a.nr_sequencia_criacao)
    into STRICT filtrar_inativacao_w
    from tabela_atributo a
    where a.nm_tabela = upper(ds_table_p)
      and a.nm_atributo = 'DT_INATIVACAO';

  ds_sql := ' select ' || ds_table_nr_field_p || ' from (' ||
            '       select rownum rn, ' || ds_table_nr_field_p ||
            ' from (' || '                 select ' ||
            ds_table_nr_field_p || ' from ' || ds_table_p ||
            '                 where nr_atendimento = :nr_atendimento_p ';

  if (filtrar_liberacao_w > 0) then
      ds_sql := ds_sql || ' and dt_liberacao is not null';
  end if;

  if (filtrar_inativacao_w > 0) then
      ds_sql := ds_sql || ' and dt_inativacao is null';
  end if;

  ds_sql := ds_sql || '                 order by ' ||
            ds_table_dt_field_p || ' desc, nr_sequencia desc)' ||
            '       where  rownum <=2) ' ||
            ' where rn = :vl_rownumber_p';

  begin
      EXECUTE ds_sql
        into STRICT ds_pontuacao_w
        using nr_atendimento_p, vl_rownumber_p;

  exception
      when no_data_found then
        ds_pontuacao_w := null;

  end;

end if;

return ds_pontuacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_pontuacao_telehealth (nr_atendimento_p bigint, ds_table_p text, ds_table_nr_field_p text, ds_table_dt_field_p text, vl_rownumber_p bigint) FROM PUBLIC;

