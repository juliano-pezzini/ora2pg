-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION exibir_alerta_atepacal_js ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_funcao_p bigint, cd_funcao_chamada_p bigint, cd_pessoa_usuario_p text) RETURNS varchar AS $body$
DECLARE


qt_existe_registro_w	bigint;
ie_restr_estab_w		varchar(2);
ie_somente_liberadas_w	varchar(2);
retorno_w				varchar(2);
retorno_cursor_w		integer;
C02						integer;
ds_alerta_w				varchar(2000);
ds_sql_w				varchar(2000);
user_can_view_w			varchar(1);

c01 CURSOR FOR
	SELECT  b.ds_sql
	from	regra_alerta a,
			regra_alerta_comando b
	where	a.nr_sequencia 				= b.nr_seq_regra
	and		coalesce(a.ie_situacao,'A') 		= 'A'
	and		coalesce(a.cd_perfil,cd_perfil_p) 	= cd_perfil_p
	and		coalesce(retorno_w,'N')			= 'N'
	and (coalesce(b.ie_sensitive,'N')	= 'N' or (coalesce(b.ie_sensitive,'N')	= 'Y' and user_can_view_w = 'Y'))
	order by coalesce(a.cd_perfil,0);


BEGIN

ie_restr_estab_w := Obter_Param_Usuario(-25, 2, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_restr_estab_w);
ie_somente_liberadas_w := Obter_Param_Usuario(-25, 7, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_somente_liberadas_w);
user_can_view_w := user_can_view_sensitive_info(nm_usuario_p, cd_estabelecimento_p);

select sum(qt_existe)
into STRICT	qt_existe_registro_w
from (
SELECT	COUNT(*) qt_existe
from	atendimento_alerta a
where	nr_atendimento       = nr_atendimento_p
and	a.ie_situacao        	 = 'A'
and	((coalesce(a.dt_fim_alerta::text, '') = '') or (a.dt_fim_alerta >= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())))
and	((ie_restr_estab_w = 'N') or (coalesce(a.cd_estabelecimento,cd_estabelecimento_p) = cd_estabelecimento_p))
and	((ie_somente_liberadas_w = 'N') or (not coalesce(a.dt_liberacao::text, '') = ''))
and	   (((obter_se_tipo_alerta_lib(a.nr_seq_tipo_alerta,nm_usuario_p)	= 'S') and (coalesce(a.cd_pessoa_alerta::text, '') = '')) or (a.cd_pessoa_alerta = cd_pessoa_usuario_p))

union all

SELECT	COUNT(*)
from	alerta_paciente a
where	a.cd_pessoa_fisica   = cd_pessoa_fisica_p
and	a.ie_situacao            = 'A'
and	((coalesce(a.dt_fim_alerta::text, '') = '') or (a.dt_fim_alerta >= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())))
and     ((cd_funcao_p = 0) or (a.cd_funcao = cd_funcao_p))
and	((ie_restr_estab_w = 'N') or (coalesce(a.cd_estabelecimento,cd_estabelecimento_p) = cd_estabelecimento_p))
and	((ie_somente_liberadas_w = 'N') or (not coalesce(a.dt_liberacao::text, '') = ''))
and      obter_se_tipo_alerta_lib(a.nr_seq_tipo_alerta,nm_usuario_p)	= 'S'

union all

select	COUNT(*)
from	alerta_paciente_geral a,
	pessoa_fisica b
where	a.ie_situacao        = 'A'
and	((coalesce(a.dt_fim_alerta::text, '') = '') or (a.dt_fim_alerta >= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())))
and	((coalesce(a.cd_funcao::text, '') = '') or (a.cd_funcao = cd_funcao_chamada_p))
and	((coalesce(a.cd_perfil::text, '') = '') or (a.cd_perfil = cd_perfil_p))
and      ((coalesce(a.cd_convenio::text, '') = '') or (a.cd_convenio = obter_convenio_atendimento(nr_atendimento_p)))
and	obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'A') between
	coalesce(qt_idade_min,obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'A')) and
	coalesce(qt_idade_max,obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'A'))
and	b.cd_pessoa_fisica = cd_pessoa_fisica_p) alias73;

if (qt_existe_registro_w = 0) then
	retorno_w  	:= 'N';
else
	retorno_w	:= 'S';
end if;

if (retorno_w = 'N') then
	begin
	-- caso somente existam alertas do cadastro do shift+F11, para apresentar devera fazer a verificacao para abrir o AtePac_AL
	open C01;
	loop
	fetch C01 into
		ds_sql_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		C02 := DBMS_SQL.OPEN_CURSOR;
		DBMS_SQL.PARSE(C02, ds_sql_w, dbms_sql.Native);
		DBMS_SQL.DEFINE_COLUMN(C02,1,ds_alerta_w,2000);

		if (position(':NR_ATENDIMENTO' in upper(ds_sql_w)) > 0) then
			DBMS_SQL.BIND_VARIABLE(C02,'NR_ATENDIMENTO', nr_atendimento_p);
		end if;
		if (position(':CD_PESSOA_FISICA' in upper(ds_sql_w)) > 0) then
			DBMS_SQL.BIND_VARIABLE(C02,'CD_PESSOA_FISICA', cd_pessoa_fisica_p);
		end if;
		retorno_cursor_w := DBMS_SQL.execute(C02);

		if (DBMS_SQL.FETCH_ROWS(C02) > 0 ) then
			retorno_w := 'S';
		end if;
		DBMS_SQL.CLOSE_CURSOR(C02);
		end;
	end loop;
	close C01;

	exception
	when others then
		retorno_w := 'N';
	end;

end if;

return	retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION exibir_alerta_atepacal_js ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_funcao_p bigint, cd_funcao_chamada_p bigint, cd_pessoa_usuario_p text) FROM PUBLIC;

