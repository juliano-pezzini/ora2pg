-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_conta_resumo (nr_interno_conta_p bigint, ie_tipo_valor_p bigint, cd_setor_atendimento_p bigint, cd_classif_setor_p text) RETURNS bigint AS $body$
DECLARE


/*

1 - Materiais
2 - Medicamentos
3 - Procedimento
4 - Taxa
5 - Diária
6 - Custo Materiais
7 - Custo Medicamentos
8 - Imposto
9 - Custo Total
10 - Médico fora conta
*/
cd_classif_setor_w	varchar(100);
vl_retorno_w		double precision;


BEGIN

cd_classif_setor_w	:= ' ' || replace(cd_classif_setor_p, ',', ' ') || ' ';


if (ie_tipo_valor_p = 1) then 		-- 1 - Materiais
	select	sum(a.vl_material)
	into STRICT	vl_retorno_w
	from	material b,
		conta_paciente_resumo a
	where	a.cd_material		= b.cd_material
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	b.ie_tipo_material	in (1, 5)
	and	((coalesce(cd_classif_setor_p::text, '') = '' and coalesce(cd_setor_atendimento_p::text, '') = '') or
		exists (SELECT	1
			from	setor_atendimento x
			where	x.cd_setor_atendimento	= a.cd_setor_atendimento
			and (x.cd_setor_atendimento	= cd_setor_atendimento_p
				or ' ' || cd_classif_setor_w || ' '	like	'%' || x.cd_classif_setor || '%')));

elsif (ie_tipo_valor_p = 2) then		-- 2 - Medicamentos
	select	sum(a.vl_material)
	into STRICT	vl_retorno_w
	from	material b,
		conta_paciente_resumo a
	where	a.cd_material		= b.cd_material
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	b.ie_tipo_material	in (2, 3, 4)
	and	((coalesce(cd_classif_setor_p::text, '') = '' and coalesce(cd_setor_atendimento_p::text, '') = '') or
		exists (SELECT	1
			from	setor_atendimento x
			where	x.cd_setor_atendimento	= a.cd_setor_atendimento
			and (x.cd_setor_atendimento	= cd_setor_atendimento_p
				or ' ' || cd_classif_setor_w || ' '	like	'%' || x.cd_classif_setor || '%')));


elsif (ie_tipo_valor_p = 3) then		-- 3 - Procedimento
	select	sum(a.vl_procedimento)
	into STRICT	vl_retorno_w
	from	procedimento b,
		conta_paciente_resumo a
	where	a.nr_interno_conta	= nr_interno_conta_p
	and	b.cd_procedimento	= a.cd_procedimento
	and	b.ie_origem_proced	= a.ie_origem_proced
	and	b.ie_classificacao	= 1
	and	((coalesce(cd_classif_setor_p::text, '') = '' and coalesce(cd_setor_atendimento_p::text, '') = '') or
		exists (SELECT	1
			from	setor_atendimento x
			where	x.cd_setor_atendimento	= a.cd_setor_atendimento
			and (x.cd_setor_atendimento	= cd_setor_atendimento_p
				or ' ' || cd_classif_setor_w || ' '	like	'%' || x.cd_classif_setor || '%')));

elsif (ie_tipo_valor_p = 4) then		-- 4 - Taxa
	select	sum(a.vl_procedimento)
	into STRICT	vl_retorno_w
	from	procedimento b,
		conta_paciente_resumo a
	where	a.nr_interno_conta	= nr_interno_conta_p
	and	b.cd_procedimento	= a.cd_procedimento
	and	b.ie_origem_proced	= a.ie_origem_proced
	and	b.ie_classificacao	= 2
	and	((coalesce(cd_classif_setor_p::text, '') = '' and coalesce(cd_setor_atendimento_p::text, '') = '') or
		exists (SELECT	1
			from	setor_atendimento x
			where	x.cd_setor_atendimento	= a.cd_setor_atendimento
			and (x.cd_setor_atendimento	= cd_setor_atendimento_p
				or ' ' || cd_classif_setor_w || ' '	like	'%' || x.cd_classif_setor || '%')));

elsif (ie_tipo_valor_p = 5) then		-- 5 - Diária
	select	sum(a.vl_procedimento)
	into STRICT	vl_retorno_w
	from	procedimento b,
		conta_paciente_resumo a
	where	a.nr_interno_conta	= nr_interno_conta_p
	and	b.cd_procedimento	= a.cd_procedimento
	and	b.ie_origem_proced	= a.ie_origem_proced
	and	b.ie_classificacao	= 3
	and	((coalesce(cd_classif_setor_p::text, '') = '' and coalesce(cd_setor_atendimento_p::text, '') = '') or
		exists (SELECT	1
			from	setor_atendimento x
			where	x.cd_setor_atendimento	= a.cd_setor_atendimento
			and (x.cd_setor_atendimento	= cd_setor_atendimento_p
				or ' ' || cd_classif_setor_w || ' '	like	'%' || x.cd_classif_setor || '%')));

elsif (ie_tipo_valor_p = 6) then 		/* 6 -  Custo Materiais*/
	select	sum(a.vl_custo)
	into STRICT	vl_retorno_w
	from	material b,
		conta_paciente_resumo a
	where	a.cd_material		= b.cd_material
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	b.ie_tipo_material	in (1, 5)
	and	((coalesce(cd_classif_setor_p::text, '') = '' and coalesce(cd_setor_atendimento_p::text, '') = '') or
		exists (SELECT	1
			from	setor_atendimento x
			where	x.cd_setor_atendimento	= a.cd_setor_atendimento
			and (x.cd_setor_atendimento	= cd_setor_atendimento_p
				or ' ' || cd_classif_setor_w || ' '	like	'%' || x.cd_classif_setor || '%')));
elsif (ie_tipo_valor_p = 7) then		 /* 7  - Custo Medicamentos */
	select	sum(a.vl_custo)
	into STRICT	vl_retorno_w
	from	material b,
		conta_paciente_resumo a
	where	a.cd_material		= b.cd_material
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	b.ie_tipo_material	in (2, 3, 4)
	and	((coalesce(cd_classif_setor_p::text, '') = '' and coalesce(cd_setor_atendimento_p::text, '') = '') or
		exists (SELECT	1
			from	setor_atendimento x
			where	x.cd_setor_atendimento	= a.cd_setor_atendimento
			and (x.cd_setor_atendimento	= cd_setor_atendimento_p
				or ' ' || cd_classif_setor_w || ' '	like	'%' || x.cd_classif_setor || '%')));


elsif (ie_tipo_valor_p = 8) then /* 8 - Valor total Imposto*/
	select	sum(a.vl_imposto)
	into STRICT	vl_retorno_w
	from	conta_paciente_resumo a
	where	a.nr_interno_conta	= nr_interno_conta_p
	and	((coalesce(cd_classif_setor_p::text, '') = '' and coalesce(cd_setor_atendimento_p::text, '') = '') or
		exists (SELECT	1
			from	setor_atendimento x
			where	x.cd_setor_atendimento	= a.cd_setor_atendimento
			and (x.cd_setor_atendimento	= cd_setor_atendimento_p
				or ' ' || cd_classif_setor_w || ' '	like	'%' || x.cd_classif_setor || '%')));

elsif (ie_tipo_valor_p = 9) then /* 9 - Custo Total */
	select	sum(a.vl_custo)
	into STRICT	vl_retorno_w
	from	conta_paciente_resumo a
	where	a.nr_interno_conta	= nr_interno_conta_p
	and	((coalesce(cd_classif_setor_p::text, '') = '' and coalesce(cd_setor_atendimento_p::text, '') = '') or
		exists (SELECT	1
			from	setor_atendimento x
			where	x.cd_setor_atendimento	= a.cd_setor_atendimento
			and (x.cd_setor_atendimento	= cd_setor_atendimento_p
				or ' ' || cd_classif_setor_w || ' '	like	'%' || x.cd_classif_setor || '%')));

elsif (ie_tipo_valor_p	= 10) then /*Médico fora conta*/
	select	sum(a.vl_medico_fora_conta)
	into STRICT	vl_retorno_w
	from	conta_paciente_resumo a
	where	a.nr_interno_conta	= nr_interno_conta_p
	and	((coalesce(cd_classif_setor_p::text, '') = '' and coalesce(cd_setor_atendimento_p::text, '') = '') or
		exists (SELECT	1
			from	setor_atendimento x
			where	x.cd_setor_atendimento	= a.cd_setor_atendimento
			and (x.cd_setor_atendimento	= cd_setor_atendimento_p
				or ' ' || cd_classif_setor_w || ' '	like	'%' || x.cd_classif_setor || '%')));




end if;

return	coalesce(vl_retorno_w, 0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_conta_resumo (nr_interno_conta_p bigint, ie_tipo_valor_p bigint, cd_setor_atendimento_p bigint, cd_classif_setor_p text) FROM PUBLIC;

