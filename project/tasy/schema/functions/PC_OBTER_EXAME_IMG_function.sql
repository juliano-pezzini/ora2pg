-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pc_obter_exame_img (nr_atendimento_p atendimento_paciente.nr_atendimento%type) RETURNS varchar AS $body$
DECLARE


  --1. O paciente possui exames solicitados, mas nenhum com resultado liberado; AMARELO (Y)

  --2. Paciente possui exames parcialmente liberados/aprovados;                 AZUL    (B)

  --3. Todos resultados do paciente estao aprovados/laudados.                   VERDE   (G)
  count_yelow_w integer := 0;
  count_blue_w integer := 0;
  valid_proc_type_w integer := 0;
  return_w varchar(1) := NULL;


BEGIN

  if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
    select count(*)
      into STRICT valid_proc_type_w
      from prescr_medica pm,
           prescr_procedimento pp,
           procedimento p
     where pm.nr_atendimento = nr_atendimento_p
       and pm.nr_prescricao = pp.nr_prescricao
       and pp.cd_procedimento = p.cd_procedimento
       and pp.ie_origem_proced = p.ie_origem_proced
       and p.cd_tipo_procedimento in (SELECT a.ie_tipo_procedimento from TIPO_PROC_NAO_LAB_PANORAMA a);

    if (valid_proc_type_w > 0) then
      select count(*)
        into STRICT count_yelow_w
        from prescr_procedimento p,
             prescr_medica m
       where p.nr_prescricao = m.nr_prescricao
         and ie_status_execucao < '40'
         and coalesce(nr_seq_exame::text, '') = ''
         and nr_atendimento = nr_atendimento_p;

      select count(*)
        into STRICT count_blue_w
        from prescr_procedimento p,
             prescr_medica m
       where p.nr_prescricao = m.nr_prescricao
         and ie_status_execucao >= '40'
         and coalesce(nr_seq_exame::text, '') = ''
         and nr_atendimento = nr_atendimento_p;

      if (count_yelow_w = 0 and count_blue_w > 0) then
        return_w := 'G';
      elsif (count_blue_w > 0) then
        return_w := 'B';
      elsif (count_yelow_w > 0) then
        return_w := 'Y';
      end if;

    end if;
  end if;

  return return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION pc_obter_exame_img (nr_atendimento_p atendimento_paciente.nr_atendimento%type) FROM PUBLIC;

