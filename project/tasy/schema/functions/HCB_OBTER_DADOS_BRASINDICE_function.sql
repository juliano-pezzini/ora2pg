-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hcb_obter_dados_brasindice (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, dt_vigencia_p timestamp, cd_material_p bigint, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_cgc_fornecedor_p text, qt_idade_p bigint, nr_sequencia_p bigint, cd_plano_p text, cd_proc_referencia_p bigint, ie_origem_proc_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


nr_dec_unitario_w			smallint;
ie_origem_preco_w			smallint;
ie_origem_preco_maior_w		smallint;
ie_origem_preco_ww		smallint;
ie_tipo_rounded_w			varchar(1);
tx_ajuste_mat_w			double precision	:= 0;
tx_afaturar_w			double precision	:= 0;
cd_tab_preco_material_w		smallint	:= 0;
dt_base_fixo_w			timestamp;
dt_base_bras_w			timestamp;
dt_vigencia_w			timestamp	:= clock_timestamp() - interval '1000 days';
dt_vigencia_maior_w		timestamp	:= clock_timestamp() - interval '1000 days';
dt_vigencia_orig_w			timestamp	:= clock_timestamp();
nr_seq_mat_simpro_w		bigint;
nr_seq_simpro_preco_w		bigint;

vl_material_w			double precision 	:= 0;
vl_material_orig_w			double precision 	:= 0;

ie_preco_informado_w		varchar(1)	:= 'N';
ie_glosa_w			varchar(1)	:= '';
cd_cgc_fornecedor_w		varchar(14);
tx_brasindice_pfb_w		REGRA_AJUSTE_MATERIAL.TX_BRASINDICE_PFB%type :=0;--number(15,4)	:= 0;
tx_brasindice_pmc_w		CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type := 0;--number(15,4)	:= 0;
tx_pmc_neg_w			CONVENIO_BRASINDICE.TX_PMC_NEG%type :=0;--number(15,4)	:= 0;
tx_pmc_pos_w			CONVENIO_BRASINDICE.TX_PMC_POS%type :=0;--number(15,4)	:= 0;
qt_dia_fixo_w			integer	:= 0;
tx_simpro_pfb_w			double precision;
tx_simpro_pmc_w			double precision;
ie_precedencia_w			varchar(01);
ie_origem_w			varchar(05);
ie_origem_ww			varchar(01);
ie_preced_conv_w			varchar(01);
ie_atend_retorno_w		varchar(01);
ie_origem_conv_w			varchar(05);

ie_preced_conv_estab_w		varchar(01);
ie_origem_conv_estab_w		varchar(05);

pr_glosa_w			double precision 	:= 0;
vl_glosa_w			double precision 	:= 0;
vl_material_inf_w			double precision;
cd_tabela_preco_w			bigint;
cd_motivo_exc_conta_w		bigint;
cd_moeda_w			smallint;
cd_moeda_padrao_w		smallint;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
tx_ajuste_periodo_w		double precision;
nr_seq_regra_w			bigint;
ie_tipo_preco_conv_w		varchar(03);
cd_tiss_w				varchar(40);
vl_maior_preco_w			double precision;
qt_conversao_w			double precision;
ie_autor_particular_w		varchar(1);
cd_convenio_glosa_ww		integer:= 0;
cd_categoria_glosa_ww		varchar(10):= ' ';
nr_atendimento_w	bigint;

ie_preco_custo_w	  		varchar(01);
cd_tabela_custo_w			bigint;
dt_ref_custo_w			timestamp;
vl_custo_w			double precision;
ie_apuracao_custo_w		varchar(10);
vl_custo_unitario_w			double precision;
pr_imposto_w			double precision	:= 0;
ds_criterio_w			varchar(20);

tx_pfb_neg_w			CONVENIO_BRASINDICE.TX_PFB_NEG%type;--number(15,4);
tx_pfb_pos_w			CONVENIO_BRASINDICE.TX_PFB_POS%type;--number(15,4);
tx_ajuste_mat_orig_w		double precision	:= 0;

ds_origem_w			varchar(100):='';
ds_precedencia_w			varchar(100):='';
ds_valor_w			varchar(2000):='';
ds_valor_vig_w			varchar(2000):=null;

ie_gravar_log_w			varchar(1):= 'N';
qt_material_w			double precision;
cd_material_w			integer;
ie_valor_mat_estoque_w		varchar(2);
cd_material_estoque_w		integer;
cd_grupo_material_w		smallint;
ie_fora_vig_w			varchar(1);

qt_conv_estoque_consumo_w	double precision;

dt_entrada_w			timestamp;

tx_brasindice_pmc_neg_w		CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type := 0;--number(15,4)	:= 0;
tx_brasindice_pmc_pos_w		CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type := 0;--number(15,4)	:= 0;
ie_fixar_vig_brasindice_w	varchar(1)	:= 'N';

cd_laboratorio_w		varchar(6);
cd_medicamento_w		varchar(6);
cd_apresentacao_w		varchar(6);
ds_laboratorio_w		varchar(40) 	:= '';
ds_medicamento_w		varchar(80) 	:= '';
ds_apresentacao_w		varchar(155)	:= '';
ie_versao_atual_w		bigint;
vl_neutro_w				varchar(10);
ie_tipo_material_w		varchar(3);
cd_subgrupo_material_w		smallint;
cd_classe_material_w		integer;
tx_simpro_pos_pfb_w		double precision;
tx_simpro_neg_pfb_w		double precision;
tx_simpro_pos_pmc_w		double precision;
tx_simpro_neg_pmc_w		double precision;

nr_seq_marca_w 			material_lote_fornec.nr_seq_marca%type;
nr_seq_lote_fornec_w	material_atend_paciente.nr_seq_lote_fornec%type;

c01 CURSOR FOR
SELECT	/*+index (a prcmate_pk) */	a.vl_preco_venda,
	a.dt_inicio_vigencia,
	b.cd_tab_preco_mat,
	a.cd_moeda,
	coalesce(a.qt_conversao,1)
from	preco_material 		a,
	convenio_preco_mat	b
where	a.cd_tab_preco_mat	= b.cd_tab_preco_mat
and	b.cd_convenio		= cd_convenio_p
and	b.cd_categoria		= cd_categoria_p
and	a.cd_estabelecimento 	= cd_estabelecimento_p
and	a.cd_estabelecimento 	= b.cd_estabelecimento
and	a.cd_material        	= cd_material_w
and	coalesce(cd_tabela_preco_w, a.cd_tab_preco_mat) = a.cd_tab_preco_mat
and	coalesce(a.ie_situacao,'A')	= 'A'
and	coalesce(b.ie_situacao,'A')	= 'A'
and	coalesce(b.ie_tab_adicional,'N')	= 'N'
and	((coalesce(cd_cgc_fornecedor_w::text, '') = '') or (coalesce(a.cd_cgc_fornecedor,cd_cgc_fornecedor_w) = cd_cgc_fornecedor_w))
and	dt_vigencia_w between coalesce(b.dt_inicio_vigencia, dt_vigencia_w)	and coalesce(b.dt_final_vigencia, dt_vigencia_w)
and	a.dt_inicio_vigencia	<= dt_vigencia_p
order by
	CASE WHEN ie_precedencia_w='D' THEN 0  ELSE coalesce(b.nr_prioridade,1) END  desc,
	CASE WHEN ie_origem_ww='T' THEN coalesce(b.nr_prioridade,1)  ELSE 0 END  desc,
	coalesce(a.cd_cgc_fornecedor,'0'),
	a.dt_inicio_vigencia,
	a.vl_preco_venda;
	
	
C02 CURSOR FOR
	SELECT	coalesce(coalesce(tx_brasindice_pfb_w,tx_preco_fabrica),1),
		coalesce(coalesce(tx_brasindice_pmc_w,tx_brasindice_pmc),1),
		coalesce(tx_pmc_neg_w,tx_pmc_neg),
		coalesce(tx_pmc_pos_w,tx_pmc_pos),
		coalesce(qt_dia_fixo,0),
		coalesce(dt_base_fixo, dt_vigencia_p),
		coalesce(tx_brasindice_pmc_neg_w, tx_pfb_neg),
		coalesce(tx_brasindice_pmc_pos_w, tx_pfb_pos)
	from	convenio_brasindice
	where	cd_convenio		= cd_convenio_p
	and	((coalesce(cd_categoria::text, '') = '')	or (cd_categoria = cd_categoria_p))
	and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
	and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
	and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
	and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrutura,cd_material_w) = 'S'))
	and 	((coalesce(ie_tipo_material::text, '') = '') or (ie_tipo_material = ie_tipo_material_w))
	and	((coalesce(ie_tipo_atendimento::text, '') = '') or (ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)))
	and	cd_estabelecimento	= cd_estabelecimento_p
	and	coalesce(ie_situacao,'A')	= 'A'
	and	dt_inicio_vigencia	= (
		SELECT max(a.dt_inicio_vigencia)
		from	convenio_brasindice a
		where	a.cd_convenio		= cd_convenio_p
		and	((coalesce(cd_categoria::text, '') = '')	or (cd_categoria = cd_categoria_p))
		and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
		and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
		and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
		and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrutura,cd_material_w) = 'S'))
		and 	((coalesce(a.ie_tipo_material::text, '') = '') or (a.ie_tipo_material = ie_tipo_material_w))
		and	((coalesce(a.ie_tipo_atendimento::text, '') = '') or (a.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)))
		and	cd_estabelecimento	= cd_estabelecimento_p
		and	coalesce(a.ie_situacao,'A')= 'A'
		and	a.dt_inicio_vigencia <= dt_vigencia_p)
	order by coalesce(cd_categoria,'0'),
		coalesce(nr_seq_estrutura,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_classe_material,0),
		coalesce(ie_tipo_material,'0'),
		coalesce(ie_tipo_atendimento,0);
		
c03 CURSOR FOR
SELECT	/*+index (a prcmate_pk) */	a.vl_preco_venda,
	a.dt_inicio_vigencia,
	b.cd_tab_preco_mat,
	a.cd_moeda,
	coalesce(a.qt_conversao,1)
from	preco_material 		a,
	convenio_preco_mat	b
where	a.cd_tab_preco_mat	= b.cd_tab_preco_mat
and	b.cd_convenio		= cd_convenio_p
and	b.cd_categoria		= cd_categoria_p
and	a.cd_estabelecimento 	= cd_estabelecimento_p
and	a.cd_estabelecimento 	= b.cd_estabelecimento
and	a.cd_material        	= cd_material_w
and	coalesce(cd_tabela_preco_w, a.cd_tab_preco_mat) = a.cd_tab_preco_mat
and	coalesce(a.ie_situacao,'A')	= 'A'
and	coalesce(b.ie_situacao,'A')	= 'A'
and	coalesce(b.ie_tab_adicional,'N')	= 'S'
and	((coalesce(cd_cgc_fornecedor_w::text, '') = '') or (coalesce(a.cd_cgc_fornecedor,cd_cgc_fornecedor_w) = cd_cgc_fornecedor_w))
and	dt_vigencia_w between coalesce(b.dt_inicio_vigencia, dt_vigencia_w)	and coalesce(b.dt_final_vigencia, dt_vigencia_w)
and	a.dt_inicio_vigencia	<= dt_vigencia_p
order by
	CASE WHEN ie_precedencia_w='D' THEN 0  ELSE coalesce(b.nr_prioridade,1) END  desc,
	CASE WHEN ie_origem_ww='T' THEN coalesce(b.nr_prioridade,1)  ELSE 0 END  desc,
	coalesce(a.cd_cgc_fornecedor,'0'),
	a.dt_inicio_vigencia,
	a.vl_preco_venda;

BEGIN

cd_material_w		:= cd_material_p;
cd_material_estoque_w	:= Obter_Dados_Material(cd_material_w,'EST');

select	coalesce(max(ie_valor_mat_estoque),'N')
into STRICT	ie_valor_mat_estoque_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_p;

<<Inicio>>

select 	max(coalesce(Grava_log_calculo_pck.get_ie_gravar_log,'N'))
into STRICT	ie_gravar_log_w
;

if (ie_gravar_log_w = 'S') and (coalesce(nr_sequencia_p,0) > 0) then
	select	coalesce(max(qt_material),1)
	into STRICT	qt_material_w
	from 	material_atend_paciente
	where	nr_sequencia = nr_sequencia_p;
	
	delete  from material_log_calculo
	where nr_seq_matpaci = nr_sequencia_p;

end if;

if (coalesce(nr_sequencia_p,0) > 0) then
	select	coalesce(max(nr_atendimento),0)
	into STRICT	nr_atendimento_w
	from 	material_atend_paciente
	where	nr_sequencia = nr_sequencia_p;
	
	if (nr_atendimento_w > 0) then
		select	CASE WHEN coalesce(nr_atend_original::text, '') = '' THEN  'N'  ELSE 'S' END ,
			dt_entrada
		into STRICT	ie_atend_retorno_w,
			dt_entrada_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_w;
	end if;	
end if;

vl_maior_preco_w	:= 0;
dt_vigencia_w		:= trunc(dt_vigencia_p, 'dd');

cd_cgc_fornecedor_w	:= cd_cgc_fornecedor_p;

select	coalesce(max(ie_preco_custo), 'N')
into STRICT	ie_preco_custo_w
from	categoria_convenio
where	cd_convenio		= cd_convenio_p
and	cd_categoria		= cd_categoria_p;


select	max(ie_origem_preco),
	max(ie_precedencia_preco),
	coalesce(max(ie_fixar_vig_brasindice),'N')
into STRICT	ie_origem_conv_estab_w,
	ie_preced_conv_estab_w,
	ie_fixar_vig_brasindice_w
from	convenio_estabelecimento
where	cd_convenio		= cd_convenio_p
and	cd_estabelecimento	= cd_estabelecimento_p;

select	coalesce(max(ie_origem_preco),'BT'),
	coalesce(max(ie_precedencia_preco),'D')
into STRICT	ie_origem_conv_w,
	ie_preced_conv_w
from	convenio
where	cd_convenio	= cd_convenio_p;

if (ie_origem_conv_estab_w IS NOT NULL AND ie_origem_conv_estab_w::text <> '') then
	ie_origem_conv_w := ie_origem_conv_estab_w;
end if;

if (ie_preced_conv_estab_w IS NOT NULL AND ie_preced_conv_estab_w::text <> '') then
	ie_preced_conv_w := ie_preced_conv_estab_w;
end if;

SELECT * FROM obter_regra_ajuste_mat(
	cd_estabelecimento_p, 		--cd_estabelecimento_p
	cd_convenio_p,                   --cd_convenio_p
	cd_categoria_p,                  --cd_categoria_p
	cd_material_w,                   --cd_material_p
	dt_vigencia_p,                   --dt_vigencia_p
	cd_tipo_acomodacao_p,            --cd_tipo_acomodacao_p
	ie_tipo_atendimento_p,           --ie_tipo_atendimento_p
	cd_setor_atendimento_p,          --cd_setor_atendimento_p
	qt_idade_p,                      --qt_idade_p
	nr_sequencia_p, 			--nr_sequencia_p
	cd_plano_p,       		--cd_plano_p
	cd_proc_referencia_p,            --cd_proc_referencia_p
	ie_origem_proc_p,                --ie_origem_proced_p
	null,                            --nr_seq_proc_interno_p
	dt_entrada_w,                    --dt_entrada_p
	tx_ajuste_mat_w,                 --OUT tx_ajuste_p
	vl_material_w,                   --OUT vl_negociado_p
	ie_preco_informado_w,            --OUT ie_preco_informado_p
	ie_glosa_w,                      --OUT ie_glosa_p
	tx_brasindice_pfb_w,             --OUT tx_brasindice_pfb_p
	tx_brasindice_pmc_w,             --OUT tx_brasindice_pmc_p
	tx_pmc_neg_w,                    --OUT tx_pmc_neg_p
	tx_pmc_pos_w,                    --OUT tx_pmc_pos_p
	tx_afaturar_w,                   --OUT tx_afaturar_p
	tx_simpro_pfb_w,                 --OUT tx_simpro_pfb_p
	tx_simpro_pmc_w,                 --OUT tx_simpro_pmc_p
	ie_origem_w,                     --OUT ie_origem_preco_p
	ie_precedencia_w,                --OUT ie_precedencia_p
	pr_glosa_w, 			--OUT pr_glosa_p
	vl_glosa_w, 			--OUT vl_glosa_p
	cd_tabela_preco_w,               --OUT cd_tabela_preco_p
	cd_motivo_exc_conta_w,           --OUT cd_motivo_exc_conta_p
	nr_seq_regra_w,                  --OUT nr_seq_regra_p
	ie_autor_particular_w,           --OUT ie_autor_particular_p
	cd_convenio_glosa_ww,            --OUT cd_convenio_glosa_p
	cd_categoria_glosa_ww,           --OUT cd_categoria_glosa_p
	ie_atend_retorno_w,              --ie_atend_retorno_p
	tx_brasindice_pmc_neg_w,         --OUT tx_pfb_neg_p 
	tx_brasindice_pmc_pos_w,         --OUT tx_pfb_pos_p
	vl_neutro_w,                     --OUT ie_ignora_preco_venda_p
	tx_simpro_pos_pfb_w,             --OUT tx_simpro_pos_pfb_p
	tx_simpro_neg_pfb_w,             --OUT tx_simpro_neg_pfb_p
	tx_simpro_pos_pmc_w,             --OUT tx_simpro_pos_pmc_p
	tx_simpro_neg_pmc_w,             --OUT tx_simpro_neg_pmc_p
	null,                            --nr_seq_origem_p
	null,                            --nr_seq_cobertura_p
	0,                               --qt_dias_internacao_p
	null,                            --nr_seq_regra_lanc_p
	null,                            --nr_seq_lib_dieta_conv_p
	null,                            --ie_clinica_p
	null,                            --cd_usuario_convenio_p
	null) INTO STRICT 
	tx_ajuste_mat_w, 
	vl_material_w, 
	ie_preco_informado_w, 
	ie_glosa_w, 
	tx_brasindice_pfb_w, 
	tx_brasindice_pmc_w, 
	tx_pmc_neg_w, 
	tx_pmc_pos_w, 
	tx_afaturar_w, 
	tx_simpro_pfb_w, 
	tx_simpro_pmc_w, 
	ie_origem_w, 
	ie_precedencia_w, 
	pr_glosa_w, 
	vl_glosa_w, 
	cd_tabela_preco_w, 
	cd_motivo_exc_conta_w, 
	nr_seq_regra_w, 
	ie_autor_particular_w, 
	cd_convenio_glosa_ww, 
	cd_categoria_glosa_ww, 
	tx_brasindice_pmc_neg_w, 
	tx_brasindice_pmc_pos_w, 
	vl_neutro_w, 
	tx_simpro_pos_pfb_w, 
	tx_simpro_neg_pfb_w, 
	tx_simpro_pos_pmc_w, 
	tx_simpro_neg_pmc_w;                          --nr_seq_classif_atend_p
vl_material_inf_w		:= vl_material_w;
ie_origem_w			:= coalesce(ie_origem_w,ie_origem_conv_w);
ie_precedencia_w		:= coalesce(ie_precedencia_w,ie_preced_conv_w);
ie_origem_preco_w 		:= 0;
ie_origem_preco_ww		:= 0;
cd_tab_preco_material_w		:= 0;
ie_origem_preco_maior_w		:= 0;

select 	obter_valor_dominio(1152,ie_origem_w),
	obter_valor_dominio(1153,ie_precedencia_w)
into STRICT	ds_origem_w,
	ds_precedencia_w
;


if (ie_preco_informado_w = 'N') then
	vl_material_w		:= 0;
else
	ie_precedencia_w	:= 'O';
end if;

FOR i IN 1 .. 3 LOOP
	BEGIN
	vl_material_orig_w		:= 0;
	dt_vigencia_orig_w		:= clock_timestamp() - interval '2000 days';
	if	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V'))) and (substr(ie_origem_w,i,1) = 'T')	then
	     	begin
		ie_origem_ww	:= 'T';
		open c01;
		loop
		fetch c01 	into
       		vl_material_orig_w,
            		dt_vigencia_orig_w,
			cd_tab_preco_material_w,
			cd_moeda_w,	
			qt_conversao_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
       		vl_material_orig_w	:= vl_material_orig_w;
		
		select	CASE WHEN coalesce(qt_conversao_w,1)=0 THEN 1  ELSE qt_conversao_w END
		into STRICT	qt_conversao_w
		;
		
		vl_material_orig_w	:= (vl_material_orig_w / qt_conversao_w);		
		
		end loop;
		close c01;

		select	coalesce(max(cd_moeda_padrao),0)
		into STRICT	cd_moeda_padrao_w
		from	parametro_compras
		where	cd_estabelecimento = cd_estabelecimento_p;

		if (cd_moeda_padrao_w <> 0) and (cd_moeda_w <> cd_moeda_padrao_w) then
			select	coalesce(max(vl_cotacao),1)
			into STRICT	vl_cotacao_w
			from 	cotacao_moeda
			where	cd_moeda	= cd_moeda_w
			and 	dt_cotacao	= (	SELECT	max(dt_cotacao)
							from 	cotacao_moeda
							where 	cd_moeda = cd_moeda_w
							and 	dt_cotacao <= dt_vigencia_p);
			vl_material_orig_w	:= vl_material_orig_w * vl_cotacao_w;
		end if;
		ie_origem_preco_ww		:= 2;
		--297033 = Tabela Material; 297035 = valor		
		ds_valor_w:= ds_valor_w || ' ['|| wheb_mensagem_pck.get_texto(297033) ||' - '|| wheb_mensagem_pck.get_texto(297035) ||': ' || vl_material_orig_w || ']';
		

		if (vl_maior_preco_w < vl_material_orig_w) then
			vl_maior_preco_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;
		
		if	(vl_maior_preco_w < (vl_material_orig_w * tx_ajuste_mat_w)) and (ie_precedencia_w = 'V') then  /*  Coloquei esse if "tratamento" para considerar a taxa a Tabela Interna quando for Maior Vigencia entre as origens  OS 103054*/
			vl_maior_preco_w 	:= vl_material_orig_w * tx_ajuste_mat_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
		end if;

     		end;
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V'))) and (substr(ie_origem_w,i,1) = 'A')	then
	     	begin
		ie_origem_ww	:= 'A';
		open c03;
		loop
		fetch c03 	into
       		vl_material_orig_w,
            		dt_vigencia_orig_w,
			cd_tab_preco_material_w,
			cd_moeda_w,	
			qt_conversao_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
       		vl_material_orig_w	:= vl_material_orig_w;
		
		select	CASE WHEN coalesce(qt_conversao_w,1)=0 THEN 1  ELSE qt_conversao_w END
		into STRICT	qt_conversao_w
		;
		
		vl_material_orig_w	:= (vl_material_orig_w / qt_conversao_w);		
		end loop;
		close c03;

		select	coalesce(max(cd_moeda_padrao),0)
		into STRICT	cd_moeda_padrao_w
		from	parametro_compras
		where	cd_estabelecimento = cd_estabelecimento_p;

		if (cd_moeda_padrao_w <> 0) and (cd_moeda_w <> cd_moeda_padrao_w) then
			select	coalesce(max(vl_cotacao),1)
			into STRICT	vl_cotacao_w
			from 	cotacao_moeda
			where	cd_moeda	= cd_moeda_w
			and 	dt_cotacao	= (	SELECT	max(dt_cotacao)
							from 	cotacao_moeda
							where 	cd_moeda = cd_moeda_w
							and 	dt_cotacao <= dt_vigencia_p);
			vl_material_orig_w	:= vl_material_orig_w * vl_cotacao_w;
		end if;
		ie_origem_preco_ww		:= 2;
		-- 297037 = Tabela Adicional 
		ds_valor_w:= ds_valor_w || ' ['|| wheb_mensagem_pck.get_texto(297037) ||' - '|| wheb_mensagem_pck.get_texto(297035) ||': ' || vl_material_orig_w || ']';

		if (vl_maior_preco_w < vl_material_orig_w) then
			vl_maior_preco_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;
		
		if	(vl_maior_preco_w < (vl_material_orig_w * tx_ajuste_mat_w)) and (ie_precedencia_w = 'V') then  /*  Coloquei esse if "tratamento" para considerar a taxa a Tabela Interna quando for Maior Vigencia entre as origens  OS 103054*/
			vl_maior_preco_w 	:= vl_material_orig_w * tx_ajuste_mat_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
		end if;

     		end;
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V'))) and (substr(ie_origem_w,i,1) = 'B')	then
		begin
		ie_origem_ww	:= 'B';
		
		select 	max(cd_grupo_material),
			max(cd_subgrupo_material),
			max(cd_classe_material),
			max(ie_tipo_material)
		into STRICT	cd_grupo_material_w,
			cd_subgrupo_material_w,
			cd_classe_material_w,
			ie_tipo_material_w
		from 	estrutura_material_v
		where 	cd_material = cd_material_w;

		open C02;
		loop
		fetch C02 into	
			tx_brasindice_pfb_w,
			tx_brasindice_pmc_w,
			tx_pmc_neg_w,
			tx_pmc_pos_w,
			qt_dia_fixo_w,
			dt_base_fixo_w,
			tx_pfb_neg_w,
			tx_pfb_pos_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			tx_brasindice_pfb_w	:=	tx_brasindice_pfb_w;
			tx_brasindice_pmc_w	:=	tx_brasindice_pmc_w;
			tx_pmc_neg_w		:=	tx_pmc_neg_w;
			tx_pmc_pos_w		:=	tx_pmc_pos_w;
			qt_dia_fixo_w		:=	qt_dia_fixo_w;
			dt_base_fixo_w		:=	dt_base_fixo_w;
			tx_pfb_neg_w		:=	tx_pfb_neg_w;
			tx_pfb_pos_w		:=	tx_pfb_pos_w;
			end;
		end loop;
		close C02;

		tx_pmc_neg_w	:= coalesce(tx_pmc_neg_w, tx_brasindice_pmc_w);
		tx_pmc_pos_w	:= coalesce(tx_pmc_pos_w, tx_brasindice_pmc_w);
		dt_base_bras_w		:= dt_vigencia_p;
		if (qt_dia_fixo_w	<> 0) then
			begin
			dt_base_fixo_w		:= trunc(dt_base_fixo_w,'dd');
			while(dt_base_fixo_w + qt_dia_fixo_w < dt_base_bras_w) loop
				dt_base_fixo_w	:= dt_base_fixo_w + qt_dia_fixo_w;
			end loop;
			dt_base_bras_w		:= dt_base_fixo_w;
			end;
		end if;
		
		if (qt_dia_fixo_w	= 0) and (ie_fixar_vig_brasindice_w = 'S') and (dt_base_fixo_w IS NOT NULL AND dt_base_fixo_w::text <> '') then
			begin
			dt_base_bras_w		:= dt_base_fixo_w;
			end;
		end if;

	     	SELECT * FROM hcb_obter_preco_brasindice(
			cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, cd_material_w, dt_base_bras_w, tx_brasindice_pmc_w, tx_brasindice_pfb_w, tx_pfb_pos_w, tx_pfb_neg_w, tx_pmc_neg_w, tx_pmc_pos_w, vl_material_orig_w, dt_vigencia_orig_w, cd_laboratorio_w, cd_medicamento_w, cd_apresentacao_w, qt_conversao_w, ie_versao_atual_w) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w, cd_laboratorio_w, cd_medicamento_w, cd_apresentacao_w, qt_conversao_w, ie_versao_atual_w;

		ie_origem_preco_ww		:= 1;

		if (vl_maior_preco_w < vl_material_orig_w) then
			vl_maior_preco_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;

		end;
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V'))) and (substr(ie_origem_w,i,1) = 'S')	then
		begin
		ie_origem_ww	:= 'S';
		ie_fora_vig_w	:= 'N';
		begin
		select	CASE WHEN coalesce(tx_simpro_pfb_w::text, '') = '' THEN tx_preco_fabrica  ELSE tx_simpro_pfb_w END ,
			CASE WHEN coalesce(tx_simpro_pmc_w::text, '') = '' THEN coalesce(tx_pmc,1)  ELSE tx_simpro_pmc_w END ,
			coalesce(qt_dia_fixo,0),
			dt_base_fixo,
			ie_tipo_preco
		into STRICT	tx_simpro_pfb_w,
			tx_simpro_pmc_w,
			qt_dia_fixo_w,
			dt_base_fixo_w,
			ie_tipo_preco_conv_w
		from	convenio_simpro
		where	cd_convenio		= cd_convenio_p
		and	cd_categoria		= cd_categoria_p
		and	coalesce(ie_situacao,'A')	= 'A'
		and	coalesce(cd_estabelecimento, cd_estabelecimento_p)	= cd_estabelecimento_p
		and	dt_inicio_vigencia	= (
			SELECT max(a.dt_inicio_vigencia)
			from	convenio_simpro a
			where	a.cd_convenio         = cd_convenio_p
			and	a.cd_categoria        = cd_categoria_p
			and	coalesce(a.ie_situacao,'A')= 'A'
			and	coalesce(a.cd_estabelecimento, cd_estabelecimento_p)	= cd_estabelecimento_p
			and	a.dt_inicio_vigencia <= dt_vigencia_p);
		exception
			when others then
			tx_simpro_pfb_w	:=	1;
			tx_simpro_pmc_w	:=	1;
			qt_dia_fixo_w	:=	0;
			dt_base_fixo_w	:=	clock_timestamp();
			ie_tipo_preco_conv_w:=	'C';
			ie_fora_vig_w:= 'S';			
		end;
		
		dt_base_bras_w		:= dt_vigencia_p;
		if (qt_dia_fixo_w	<> 0) then
			begin
			dt_base_fixo_w		:= trunc(dt_base_fixo_w,'dd');
			while(dt_base_fixo_w + qt_dia_fixo_w < dt_base_bras_w) loop
				dt_base_fixo_w	:= dt_base_fixo_w + qt_dia_fixo_w;
			end loop;
			dt_base_bras_w		:= dt_base_fixo_w;
			end;
		end if;
		if (ie_fora_vig_w = 'N') then
			
			nr_seq_marca_w := 0;
			if (coalesce(nr_sequencia_p,0) > 0) then
				select	coalesce(max(nr_seq_lote_fornec),0)
				into STRICT nr_seq_lote_fornec_w
				from 	material_atend_paciente
				where	nr_sequencia = nr_sequencia_p;
				
				if (coalesce(nr_seq_marca_w,0) = 0) and (coalesce(nr_seq_lote_fornec_w,0) > 0) then
					select	max(nr_seq_marca)
					into STRICT	nr_seq_marca_w
					from	material_lote_fornec
					where	nr_sequencia = nr_seq_lote_fornec_w;
				end if;
			end if;
			
			SELECT * FROM calcular_preco_simpro(
				cd_estabelecimento_p, cd_convenio_p, cd_material_w, tx_simpro_pfb_w, tx_simpro_pmc_w, dt_base_bras_w, ie_tipo_preco_conv_w, vl_material_orig_w, dt_vigencia_orig_w, 1, 1, 1, 1, 'N', 'N', nr_seq_marca_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w;
		end if;
		
		ie_origem_preco_ww		:= 4;
		-- 297038 = Simpro; 297040 = Vigência Simpro
		ds_valor_w:= ds_valor_w || ' ['|| wheb_mensagem_pck.get_texto(297035) ||' - '|| wheb_mensagem_pck.get_texto(297035) ||': ' || vl_material_orig_w || ']';
		ds_valor_vig_w:= ds_valor_vig_w || ' ['|| wheb_mensagem_pck.get_texto(297040) ||': ' || dt_vigencia_orig_w || ']';
		
		if (vl_maior_preco_w < vl_material_orig_w) then
			vl_maior_preco_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;

		end;
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V'))) and (substr(ie_origem_w,i,1) = 'C')	then
		
		select	coalesce(max(qt_conv_estoque_consumo),1)
		into STRICT	qt_conv_estoque_consumo_w
		from 	material
		where 	cd_material = cd_material_w;
		--297042 = Custo Médio;
		vl_material_orig_w:= obter_custo_medio_material(cd_estabelecimento_p, dt_vigencia_p, cd_material_w) / qt_conv_estoque_consumo_w;
		ie_origem_preco_ww:= 5;
		ds_valor_w:= ds_valor_w || ' ['|| wheb_mensagem_pck.get_texto(297042) ||' - '|| wheb_mensagem_pck.get_texto(297035) ||': ' || vl_material_orig_w || ']';
		
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V'))) and (substr(ie_origem_w,i,1) = 'A')	then
		vl_material_orig_w := obter_preco_conv_mat_fornec(	cd_convenio_p, cd_cgc_fornecedor_p, cd_material_w, dt_vigencia_p, vl_material_orig_w);
	end if;

	if (vl_material_orig_w > 0) and
		((ie_precedencia_w = 'O') or (vl_material_w = 0) or (dt_vigencia_orig_w	> dt_vigencia_w)) then
		begin
		dt_vigencia_w		:= dt_vigencia_orig_w;
		vl_material_w		:= vl_material_orig_w;
		ie_origem_preco_w	:= ie_origem_preco_ww;
		end;
	end if;

	END;
END LOOP;

if 	(ie_origem_preco_maior_w = 2 AND ie_precedencia_w = 'V') then  /* Fabrício em 02/08/2008  OS 103054*/
	tx_ajuste_mat_w	:= tx_ajuste_mat_w;
elsif (ie_origem_preco_w <> 2) then
	tx_ajuste_mat_w		:= 1;
end if;

if (vl_material_w > 0) then
	begin
		
	if (ie_glosa_w	= 'I') then
	
		if (ie_origem_preco_w	= 1) then
			ie_origem_ww	:= 'B';
		elsif (ie_origem_preco_w	= 2) then
			ie_origem_ww	:= 'T';
		elsif (ie_origem_preco_w	= 4) then
			ie_origem_ww	:= 'S';
		end if;
		tx_ajuste_mat_orig_w 	:= tx_ajuste_mat_w;
		tx_ajuste_periodo_w := obter_ajuste_mat_periodo(nr_seq_regra_w, vl_material_w, tx_ajuste_mat_w, ie_origem_ww, tx_ajuste_periodo_w);
		tx_ajuste_mat_w		:= tx_ajuste_periodo_w;
	end if;
	

	-- Edgar 31/07/2007, OS 61450, inclui selecat abaixo
	select	max(nr_dec_unitario),
		max(ie_arredondamento)
	into STRICT	nr_dec_unitario_w,
		ie_tipo_rounded_w
	from	convenio_estabelecimento
	where	cd_convenio		= cd_convenio_p
	and	cd_estabelecimento	= cd_estabelecimento_p;
	
	
	-- Conforme 'Regra de arredondamento',  Fabrício em 15/06/2009 OS 133672
	if (ie_tipo_rounded_w = 'R') then
	
		select 	obter_regra_arredondamento(cd_convenio_p, cd_categoria_p, cd_material_p, null, cd_estabelecimento_p, dt_vigencia_p, 'M', 1),
			obter_regra_arredondamento(cd_convenio_p, cd_categoria_p, cd_material_p, null, cd_estabelecimento_p, dt_vigencia_p, 'M', 2)
		into STRICT	ie_tipo_rounded_w,
			nr_dec_unitario_w
		;
		
	end if;
	

	if (coalesce(nr_dec_unitario_w::text, '') = '') then
		/* obter parametros de arredondamento */

		select	coalesce(max(coalesce(vl_parametro, vl_parametro_padrao)),4)
		into STRICT 	nr_dec_unitario_w
		from 	funcao_parametro
		where 	cd_funcao = 81
		and 	nr_sequencia = 1;
	end if;

	if (coalesce(ie_tipo_rounded_w::text, '') = '') then
		select	coalesce(max(coalesce(vl_parametro, vl_parametro_padrao)), 'P')
		into STRICT	ie_tipo_rounded_w
		from 	funcao_parametro
		where 	cd_funcao = 81
		and 	nr_sequencia = 3;
	end if;

	vl_material_orig_w:=  vl_material_w;
	vl_material_w := (vl_material_w * tx_ajuste_mat_w * tx_afaturar_w);	
	vl_material_w := arredondamento(vl_material_w, nr_dec_unitario_w, ie_tipo_rounded_w);
		
	if (ie_glosa_w		= 'I') and (ie_precedencia_w 	= 'V') and (tx_ajuste_mat_w	<> tx_ajuste_mat_orig_w) then /*Felipe Martini em 04/09/2008 OS106608*/
		vl_material_orig_w:=  vl_maior_preco_w;
		vl_maior_preco_w := (vl_maior_preco_w * tx_ajuste_mat_w * tx_afaturar_w);
		vl_maior_preco_w := arredondamento(vl_maior_preco_w, nr_dec_unitario_w, ie_tipo_rounded_w);		
	end if;
	
	end;
end if;


if (ie_preco_custo_w	= 'S') and (coalesce(nr_seq_regra_w, 0) = 0) then
	begin

	select	max(cd_tabela_venda),
		max(dt_referencia),
		coalesce(max(ds_criterio_aloc_mat),'ERT')
	into STRICT	cd_tabela_custo_w,
		dt_ref_custo_w,
		ds_criterio_w
	from	parametro_custo a
	where	cd_estabelecimento 	= cd_estabelecimento_p;


	SELECT * FROM Obter_Custo_material(cd_estabelecimento_p, cd_material_w, cd_estabelecimento_p, cd_tabela_custo_w, cd_setor_Atendimento_p, cd_convenio_p, vl_material_w, 'TER', null, dt_ref_custo_w, ie_apuracao_custo_w, vl_custo_unitario_w, pr_imposto_w, null, null, null, 'N', null, 0, 0, null) INTO STRICT ie_apuracao_custo_w, vl_custo_unitario_w, pr_imposto_w;

	vl_custo_w	:=	vl_custo_unitario_w;

	if (coalesce(pr_imposto_w, 0) > 0) then
		vl_custo_w	:= vl_custo_w  + (vl_custo_w * pr_imposto_w);
	end if;

	ie_preco_informado_w	:= 'N';

	end;
end if;

if (ie_valor_mat_estoque_w		='S') and
	--(vl_material_p			= 0) and
	(cd_material_w <> cd_material_estoque_w) then
	ie_valor_mat_estoque_w	:= 'N';
	cd_material_w		:= cd_material_estoque_w;
	goto	Inicio;
end if;


if (ie_opcao_p = 'CLAB') then
	Return cd_laboratorio_w;
elsif (ie_opcao_p = 'DLAB') then
	if (cd_laboratorio_w IS NOT NULL AND cd_laboratorio_w::text <> '') then
		select coalesce(max(ds_laboratorio), wheb_mensagem_pck.get_texto(297045) ||' :' || cd_laboratorio_w) -- 297045 = Laboratório não encontrado
		into STRICT ds_laboratorio_w
		from brasindice_laboratorio
		where cd_laboratorio = cd_laboratorio_w;
	end if;
	Return ds_laboratorio_w;
elsif (ie_opcao_p = 'CMED') then
	Return cd_medicamento_w;
elsif (ie_opcao_p = 'DMED') then
	if (cd_medicamento_w IS NOT NULL AND cd_medicamento_w::text <> '') then
		select coalesce(max(ds_medicamento), wheb_mensagem_pck.get_texto(297048) ||' :' || cd_medicamento_w) -- 297048 = Medicamento não encontrado
		into STRICT ds_medicamento_w
		from brasindice_medicamento
		where cd_medicamento 		= cd_medicamento_w;
	end if;
	Return ds_medicamento_w;
elsif (ie_opcao_p = 'CAPR') then
	Return cd_apresentacao_w;
elsif (ie_opcao_p = 'DAPR') then
	if (cd_apresentacao_w IS NOT NULL AND cd_apresentacao_w::text <> '') then
		select coalesce(max(ds_apresentacao), wheb_mensagem_pck.get_texto(297050) ||' :' || cd_apresentacao_w) -- 297050 = Apresentação não encontrada
		into STRICT ds_apresentacao_w
		from brasindice_apresentacao
		where cd_apresentacao 		= cd_apresentacao_w;
	end if;
	Return ds_apresentacao_w;
elsif (ie_opcao_p = 'VERS') then	
	Return ie_versao_atual_w;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION hcb_obter_dados_brasindice (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, dt_vigencia_p timestamp, cd_material_p bigint, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_cgc_fornecedor_p text, qt_idade_p bigint, nr_sequencia_p bigint, cd_plano_p text, cd_proc_referencia_p bigint, ie_origem_proc_p bigint, ie_opcao_p text) FROM PUBLIC;

