-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tx_infec_inst_niss (setor_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


inst_sangue_w		double precision;
inst_respiratoria_w	double precision;
inst_urinaria_w		double precision;
cd_estab_w		smallint   := wheb_usuario_pck.get_cd_estabelecimento;
qt_regra_w		integer;


BEGIN

select  count(*)
into STRICT	qt_regra_w
from   	niss_taxa_referencia a,
	niss_classif_setor b,
	setor_atendimento c
where  	a.nr_seq_classif_setor =  b.nr_sequencia
and	c.nr_seq_classif_niss  =  b.nr_sequencia
and     a.cd_estabelecimento   =  cd_estab_w
and	c.cd_setor_atendimento =  setor_p;

if (qt_regra_w > 0) then
	select 		max(a.qt_tx_inf_inst_sangue),
			max(a.qt_tx_inf_inst_respiratoria),
			max(a.qt_tx_inf_inst_urinaria)
	into STRICT		inst_sangue_w,
			inst_respiratoria_w,
			inst_urinaria_w
	from   		niss_taxa_referencia a,
			niss_classif_setor b,
			setor_atendimento c
	where  		a.nr_seq_classif_setor  = b.nr_sequencia
	and	   	c.nr_seq_classif_niss 	= b.nr_sequencia
	and	   	c.cd_setor_atendimento  = setor_p
	and	   	a.cd_estabelecimento    = cd_estab_w;


else
	select      max(b.qt_tx_inf_inst_sangue),
		max(b.qt_tx_inf_inst_respiratoria),
		max(b.qt_tx_inf_inst_urinaria)
	into STRICT	inst_sangue_w,
		inst_respiratoria_w,
		inst_urinaria_w
	from    setor_atendimento a,
		niss_classif_setor b
	where   a.nr_seq_classif_niss = b.nr_sequencia
	and	a.cd_setor_atendimento = setor_p;

end if;

if (ie_opcao_p = 'IS') then
	return inst_sangue_w;
elsif (ie_opcao_p = 'IR') then
	return	inst_respiratoria_w;
elsif (ie_opcao_p = 'IU') then
	return	inst_urinaria_w;
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tx_infec_inst_niss (setor_p bigint, ie_opcao_p text) FROM PUBLIC;

