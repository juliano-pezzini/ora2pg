-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_case ( nr_sequencia_p bigint, ie_opcao_p text, nr_atendimento_p bigint default null) RETURNS varchar AS $body$
DECLARE


/*ie_opcao_p
VDRG 	- Valor da DRG do último atendimento do Case
E 	- Dias de internação do último atendimento do Case
*/
nr_atendimento_w	atendimento_paciente.nr_atendimento%type;
vl_liquido_w		episodio_paciente_drg.vl_liquido%type;
vl_desconto_w		episodio_paciente_drg.vl_desconto%type;
ds_retorno_w		varchar(255);

BEGIN
if (ie_opcao_p = 'VDRG') then
	vl_liquido_w := 0;
	begin
		select	vl_liquido,
			vl_desconto
		into STRICT	vl_liquido_w,
			vl_desconto_w
		from	episodio_paciente_drg
		where	1 = 1
		and 	((coalesce(nr_atendimento_p::text, '') = '' and nr_seq_episodio_paciente = nr_sequencia_p) or nr_atendimento = nr_atendimento_p)
		and	ie_situacao = 'A'  LIMIT 1;
	exception
	when others then
		vl_liquido_w := 0;
		vl_desconto_w := 0;
	end;
	if (vl_desconto_w < 0) then
		ds_retorno_w	:= vl_liquido_w - (vl_desconto_w * -1);
	else
		ds_retorno_w	:= vl_liquido_w;
	end if;
elsif (ie_opcao_p = 'E') then
	if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
		select	max(a.nr_atendimento)
		into STRICT	nr_atendimento_w
		from	atendimento_paciente a
		where	a.nr_seq_episodio	= nr_sequencia_p
		and	a.dt_entrada =
			(SELECT	max(x.dt_entrada)
			from	atendimento_paciente x
			where	x.nr_seq_episodio = nr_sequencia_p);
	else
		nr_atendimento_w := nr_atendimento_p;
	end if;
	ds_retorno_w := Obter_Dias_Internacao(nr_atendimento_w);
end if;
return	ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_case ( nr_sequencia_p bigint, ie_opcao_p text, nr_atendimento_p bigint default null) FROM PUBLIC;

