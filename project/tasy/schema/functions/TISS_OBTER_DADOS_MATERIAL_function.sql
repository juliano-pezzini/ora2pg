-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tiss_obter_dados_material (cd_material_p bigint, cd_estabelecimento_p bigint, nr_seq_marca_p bigint, nr_seq_tuss_mat_item_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*ie_opcao_p
RA	Registro Anvisa
DV	Data Validade Anvisa
RF 	Referência
IV Vigente Anvisa*/
cd_referencia_w		varchar(255);
nr_registro_marca_w	varchar(255);
dt_validade_w		timestamp;
ds_retorno_w		varchar(255);
ie_vigente_anvisa_w	material_marca.ie_vigente_anvisa%type;


BEGIN

if (nr_seq_marca_p IS NOT NULL AND nr_seq_marca_p::text <> '') then

	select	max(nr_registro_anvisa),
		max(dt_validade_reg_anvisa),
		max(cd_referencia),
		max(ie_vigente_anvisa)
	into STRICT	nr_registro_marca_w,
		dt_validade_w,
		cd_referencia_w,
		ie_vigente_anvisa_w
	from	material_marca
	where	nr_sequencia		= nr_seq_marca_p
	and	cd_material		= cd_material_p
	AND	coalesce(ie_situacao,'A') 	= 'A'
	and (cd_estabelecimento	= cd_estabelecimento_p or coalesce(cd_estabelecimento::text, '') = '');

else
	select	max(nr_registro_anvisa),
		max(dt_validade_reg_anvisa),
		max(ie_vigente_anvisa)
	into STRICT	nr_registro_marca_w,
		dt_validade_w,
		ie_vigente_anvisa_w
	from	material_estab
	where	cd_material 		= cd_material_p
	and	cd_estabelecimento 	= cd_estabelecimento_p;

end if;

--Prioridade da referência do fabricante é da carga TUSS, se não tiver, pega do cadastro do material
if (nr_seq_tuss_mat_item_p IS NOT NULL AND nr_seq_tuss_mat_item_p::text <> '') then

	begin
	select	cd_ref_fabricante
	into STRICT	cd_referencia_w
	from	tuss_material_item
	where	nr_sequencia	= nr_seq_tuss_mat_item_p  LIMIT 1;
	exception
	when others then
		null;
	end;

	--Na carga pode vir este 'Ref: ' desnecessáriamente
	cd_referencia_w	:= replace(cd_referencia_w,'Ref: ','');

end if;

/* Se ainda não encontrou, buscar na tabela material */

if (coalesce(nr_registro_marca_w::text, '') = '') and (coalesce(dt_validade_w::text, '') = '') then
	select	max(nr_registro_anvisa),
		max(dt_validade_reg_anvisa)
	into STRICT	nr_registro_marca_w,
		dt_validade_w
	from	material
	where	cd_material	= cd_material_p;
end if;

if (ie_opcao_p = 'RA') then
	ds_retorno_w	:= nr_registro_marca_w;
elsif (ie_opcao_p = 'DV') then
	ds_retorno_w	:= dt_validade_w;
elsif (ie_opcao_p = 'RF') then
	ds_retorno_w	:= cd_referencia_w;
elsif (ie_opcao_p = 'IV') then
	ds_retorno_w	:= coalesce(ie_vigente_anvisa_w, 'N');
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_obter_dados_material (cd_material_p bigint, cd_estabelecimento_p bigint, nr_seq_marca_p bigint, nr_seq_tuss_mat_item_p bigint, ie_opcao_p text) FROM PUBLIC;

