-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dose_um_desc_prescr ( nr_prescricao_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


cd_unidade_medida_dose_w 	unidade_medida.ds_unidade_medida%type;
qt_dose_w            		varchar(30);
qt_solucao_w           		double precision;
ds_prescr_w            		varchar(30);
ds_prescricao_w            	varchar(120);
ds_dose_diferenciada_w      varchar(50);
ds_retorno_w            	varchar(160);
nr_agrupamento_w        	double precision;
qt_reg_w            		bigint;
nr_seq_w            		bigint;
ie_via_w            		varchar(5);
ie_agrupador_w            	smallint;
qt_dose_especial_w        	double precision;
hr_dose_especial_w        	varchar(5);


BEGIN

select	converte_fracao_dose(a.cd_unidade_medida_dose, a.qt_dose)  qt_dose,
	Obter_Desc_Unid_Med(a.cd_unidade_medida_dose),
	substr(c.ds_prescricao,1,30),
	a.ds_dose_diferenciada,
	qt_solucao,
	a.nr_agrupamento,
	a.ie_via_aplicacao,
	a.ie_agrupador,
	a.qt_dose_especial,
	a.hr_dose_especial
into STRICT	qt_dose_w,
	cd_unidade_medida_dose_w,
	ds_prescr_w,
	ds_dose_diferenciada_w,
	qt_solucao_w,
	nr_agrupamento_w,
	ie_via_w,
	ie_agrupador_w,
	qt_dose_especial_w,
	hr_dose_especial_w
FROM material b, prescr_material a
LEFT OUTER JOIN intervalo_prescricao c ON (a.cd_intervalo = c.cd_intervalo)
WHERE a.cd_material    	= b.cd_material  and a.nr_prescricao  	= nr_prescricao_p and a.nr_sequencia		= nr_sequencia_p;

if (substr(qt_dose_w,1,1) = ',') then
	qt_dose_w	:= '0' || qt_dose_w;
end if;
qt_dose_w	:= replace(qt_dose_w,'.',',');


select	count(*),
	min(nr_sequencia)
into STRICT	qt_reg_w,
	nr_seq_w
from	prescr_material
where	nr_prescricao		= nr_prescricao_p
  and	ie_agrupador		= 1
  and	nr_agrupamento		= nr_agrupamento_w;

if (qt_reg_w > 1) and (nr_sequencia_p <> nr_seq_w) then
	ds_prescricao_w	:= substr(ds_prescr_w,1,120);
	ie_via_w		:= '';
elsif (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
	ds_prescricao_w	:= substr(ds_dose_diferenciada_w || ' ' || cd_unidade_medida_dose_w,1,120);
	cd_unidade_medida_dose_w	:= '';
	qt_dose_w			:= '';
else
	ds_prescricao_w	:= substr(ds_prescr_w,1,120);
end if;



/* Ivan em 08/02/2008 OS82257 - Incluída consistência para comparar o qt_dosagem_w somente no agrupador 1 */

if 	((ie_agrupador_w <> 1) or (ie_agrupador_w = 1) and ((coalesce(qt_solucao_w::text, '') = '') or (qt_solucao_w = 0))) then
	ds_retorno_w	:= substr(qt_dose_w || ' ' || cd_unidade_medida_dose_w ||
			'   ' ||ds_prescricao_w || '   ' || ie_via_w,1,255);
else
	if (qt_solucao_w IS NOT NULL AND qt_solucao_w::text <> '') then
		ds_retorno_w	:= substr(qt_solucao_w || ' ml ' || ds_prescricao_w || '   ' || ie_via_w,1,255);
		if (substr(ds_retorno_w,1,1) = ',') then
			ds_retorno_w	:= substr('0' || ds_retorno_w,1,255);
		end if;
	else
		ds_retorno_w	:= substr(ds_prescricao_w || '   ' || ie_via_w,1,255);
	end if;
end if;

if (qt_dose_especial_w IS NOT NULL AND qt_dose_especial_w::text <> '') then
	ds_retorno_w	:= substr(ds_retorno_w || '  DE ' || to_char(qt_dose_especial_w) || ' ' || cd_unidade_medida_dose_w || '(' || hr_dose_especial_w || ')',1,255);
end if;

RETURN ds_retorno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dose_um_desc_prescr ( nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

