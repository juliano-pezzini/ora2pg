-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dias_internacao ( nr_atendimento_p bigint) RETURNS bigint AS $body$
DECLARE


qt_dias_internacao_w	bigint := 0;
dt_entrada_w		atendimento_paciente.dt_entrada%type;
dt_alta_w		atendimento_paciente.dt_alta%type;
isPlanned_w             char(1);
nr_sequencia_w          atendimento_paciente.nr_seq_episodio%type;
nr_atendimento_w        atendimento_paciente.nr_atendimento%type;


BEGIN

if (coalesce(nr_atendimento_p,0) > 0) then

    isPlanned_w := 'N';
    nr_atendimento_w := nr_atendimento_p;

	if (coalesce(obter_uso_case(wheb_usuario_pck.get_nm_usuario), 'N') = 'S') then

		select  max(ap.nr_seq_episodio)
		into STRICT    nr_sequencia_w
		from    atendimento_paciente ap
		where   ap.nr_atendimento =  nr_atendimento_p;

		select  max(apt.nr_atendimento)
		into STRICT    nr_atendimento_w
		from    atendimento_paciente apt
		where   apt.nr_seq_episodio = nr_sequencia_w
		and     coalesce(apt.dt_cancelamento::text, '') = ''
		and     coalesce(apt.dt_alta::text, '') = ''
		and	existe_atend_controle(apt.nr_atendimento, apt.nr_seq_episodio) = 'N'
		and     apt.ie_tipo_atendimento = 1;
		
		if (coalesce(nr_atendimento_w,0) > 0) then
			select obter_se_atendimento_futuro(nr_atendimento_w)
			into STRICT   isPlanned_w
			;
		end if;
    	end if;

	if (isPlanned_w = 'N') and (coalesce(nr_atendimento_w,0) > 0) then
		select	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_entrada),
			ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(dt_alta, clock_timestamp()))
        	into STRICT	dt_entrada_w,
			dt_alta_w
        	from	atendimento_paciente
	        where	nr_atendimento = nr_atendimento_w;

        	qt_dias_internacao_w := (dt_alta_w - dt_entrada_w) + 1;
    	else
        	qt_dias_internacao_w := null;
    	end if;
end if;

return qt_dias_internacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dias_internacao ( nr_atendimento_p bigint) FROM PUBLIC;

