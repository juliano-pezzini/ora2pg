-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION proj_obter_media_escore ( dt_referencia_p timestamp) RETURNS bigint AS $body$
DECLARE



qt_escore_w			bigint	:= 0;
qt_escore_acum_w			bigint	:= 0;
qt_ocorrencia_w			bigint	:= 0;
vl_retorno_w			double precision	:= 0;
dt_inicio_w			timestamp;
dt_fim_w				timestamp;

C01 CURSOR FOR
	SELECT 	qt_escore
	from	Proj_escore
	where	dt_escore between dt_inicio_w and dt_fim_w
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');


BEGIN

dt_inicio_w			:= trunc(dt_referencia_p,'month');
dt_fim_w				:= Last_day(dt_inicio_w) + 86399/86400;

Open C01;
loop
fetch C01 into
	qt_escore_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	if (qt_escore_w > 40) then
		qt_escore_acum_w		:= qt_escore_acum_w + qt_escore_w;
		qt_ocorrencia_w		:= qt_ocorrencia_w + 1;
	end if;
end loop;
close C01;

if (qt_ocorrencia_w > 0) then
	vl_retorno_w	:= round((dividir(qt_escore_acum_w, qt_ocorrencia_w))::numeric,0);
else
	vl_retorno_w	:= 60;
end if;

return	vl_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION proj_obter_media_escore ( dt_referencia_p timestamp) FROM PUBLIC;

