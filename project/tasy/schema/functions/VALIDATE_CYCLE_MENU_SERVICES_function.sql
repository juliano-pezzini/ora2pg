-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION validate_cycle_menu_services (nr_seq_cardapio_dia_p bigint, nr_seq_receipt_p bigint, dt_service_p timestamp, nr_atendimento_p bigint, ie_param_122_p text, nr_seq_acompanhante_p bigint) RETURNS varchar AS $body$
DECLARE


cd_dieta_w	 		bigint;
nr_seq_grupo_producao_w		bigint;
nr_seq_cycle_w			bigint;
ie_retorno_w			varchar(1) := 'N';


BEGIN

if (nr_seq_cardapio_dia_p IS NOT NULL AND nr_seq_cardapio_dia_p::text <> '')	then

	select	coalesce(max(cd_dieta), 0),
		coalesce(max(nr_seq_grupo_producao), 0),
		coalesce(max(nr_seq_cycle), 0)
	into STRICT	cd_dieta_w,
		nr_seq_grupo_producao_w,
		nr_seq_cycle_w
	from	nut_cardapio_dia
	where	nr_sequencia = nr_seq_cardapio_dia_p;

	if (nr_seq_cycle_w > 0 and (cd_dieta_w > 0 or nr_seq_grupo_producao_w > 0))	then

		if (coalesce(nr_seq_acompanhante_p, 0) > 0) then
			SELECT	coalesce(max('S'), 'N')
			into STRICT	ie_retorno_w
			FROM   	nut_atend_acompanhante a,
				nut_atend_acomp_dieta b
			WHERE  	a.nr_sequencia 		= b.nr_seq_atend_acomp
			and	a.nr_sequencia		= nr_seq_acompanhante_p
			and b.cd_dieta = cd_dieta_w;
			
			if (ie_retorno_w = 'N') and (nr_seq_grupo_producao_w IS NOT NULL AND nr_seq_grupo_producao_w::text <> '') then
				SELECT	coalesce(max('S'), 'N')
				into STRICT	ie_retorno_w
				FROM   	nut_atend_acompanhante a,
					nut_atend_acomp_dieta b
				WHERE  	a.nr_sequencia 		= b.nr_seq_atend_acomp
				and	a.nr_sequencia		= nr_seq_acompanhante_p
				and 	b.cd_dieta in (	SELECT 	g.cd_dieta
								from 	nut_grupo_producao_dieta g 
								where 	g.nr_seq_grupo_producao = nr_seq_grupo_producao_w);
			end if;
			
		else
			select	coalesce(max('S'), 'N')
			into STRICT	ie_retorno_w
			from	cpoe_dieta cd,
				nut_dieta_rec r
			where (r.nr_seq_receita = nr_seq_receipt_p or coalesce(ie_param_122_p, 'N') = 'N')
			and (r.cd_dieta = cd.cd_dieta)
			and	cd.nr_atendimento = nr_atendimento_p
			and	dt_service_p between pkg_date_utils.start_of(cd.dt_inicio, 'dd')
			and	coalesce(cd.dt_suspensao, coalesce(cd.dt_fim, to_date('31-12-9999', 'dd-mm-yyyy')))
			and	((cd_dieta_w > 0 and cd.cd_dieta = cd_dieta_w)
			or (cd_dieta_w = 0 and cd.cd_dieta in (SELECT g.cd_dieta from nut_grupo_producao_dieta g where g.nr_seq_grupo_producao = nr_seq_grupo_producao_w)));
		end if;

	end if;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION validate_cycle_menu_services (nr_seq_cardapio_dia_p bigint, nr_seq_receipt_p bigint, dt_service_p timestamp, nr_atendimento_p bigint, ie_param_122_p text, nr_seq_acompanhante_p bigint) FROM PUBLIC;

