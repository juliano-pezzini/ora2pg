-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_bed_status ( cd_operational_status_p text, ie_option_p text, cd_establishment_p bigint, ie_fhir_p text default 'N') RETURNS varchar AS $body$
DECLARE

/*
    Function responsible for getting the information if a bed should be considered in census calculation (IE_TOTAL_BEDS) and
    the general status (IE_CENSUS) based on the option passed as parameter

    ie_option_p - T = IE_TOTAL_BEDS / C = IE_CENSUS
    ie_fhir - Y = use fhir definition / N = use tasy definition

    Return types
    IE_TOTAL_BEDS
     Y = Consider in census and capacity
     N = Do not consider in census and capacity

    IE_CENSUS
     A = Consider as an available bed
     B = Consider as a blocked bed
     null = Do not consider
*/
operational_status_w    varchar(2);
ie_total_beds_w         varchar(2);
ie_census_w             varchar(2);
ie_exist_rule_w         varchar(2);
return_w                varchar(2);


BEGIN
    if (ie_fhir_p = 'Y') then
        operational_status_w := cd_operational_status_p;
    else
        operational_status_w := pfcs_get_bed_mapping(cd_operational_status_p, 'T');
    end if;

    select coalesce(max('Y'), 'N') into STRICT ie_exist_rule_w
    from pfcs_set_bed_status_estab
    where (cd_establishment = cd_establishment_p
        or coalesce(cd_establishment::text, '') = '');

    select max(ie_total_beds), max(ie_census)
    into STRICT ie_total_beds_w, ie_census_w
    from (
        SELECT b.ie_total_beds ie_total_beds,
            b.ie_census ie_census
        from pfcs_set_bed_status_estab e,
            pfcs_set_bed_status b
        where b.nr_seq_bed_status_estab = e.nr_sequencia
            and b.cd_status_bed = operational_status_w
            and ((e.cd_establishment = cd_establishment_p) or (coalesce(e.cd_establishment::text, '') = ''))
        order by e.cd_establishment asc
    ) alias6 LIMIT 1;

    if ((ie_exist_rule_w = 'N') or (operational_status_w = 'O')) then
        ie_total_beds_w :=
        CASE
            WHEN upper(operational_status_w) = 'U' THEN 'Y'
            WHEN upper(operational_status_w) = 'I' THEN 'Y'
            WHEN upper(operational_status_w) = 'C' THEN 'N'
            WHEN upper(operational_status_w) = 'K' THEN 'N'
            WHEN upper(operational_status_w) = 'H' THEN 'Y'
            ELSE 'Y'
        END;

        ie_census_w :=
        CASE
            WHEN upper(operational_status_w) = 'U' THEN 'A'
            WHEN upper(operational_status_w) = 'I' THEN 'A'
            WHEN upper(operational_status_w) = 'C' THEN 'B'
            WHEN upper(operational_status_w) = 'K' THEN 'B'
            WHEN upper(operational_status_w) = 'H' THEN 'A'
            ELSE 'A'
        END;
    end if;

    if (ie_option_p = 'T') then
        return_w := ie_total_beds_w;
    elsif (ie_option_p = 'C') then
        return_w := ie_census_w;
    end if;

    RETURN return_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_bed_status ( cd_operational_status_p text, ie_option_p text, cd_establishment_p bigint, ie_fhir_p text default 'N') FROM PUBLIC;

