-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_conta_retorno (nr_seq_retorno_p bigint, nr_interno_conta_p bigint) RETURNS varchar AS $body$
DECLARE

 
ie_guia_retorno_w	varchar(1)	:= 'S';
qt_regra_movto_w	bigint;
ie_tipo_atendimento_w	smallint;
cd_procedimento_real_w	bigint;
ie_origem_proc_real_w	bigint;
ie_tipo_financiamento_w	varchar(4);	
ie_complexidade_w	varchar(2);
nr_seq_grupo_w		bigint;
nr_seq_subgrupo_w	bigint;
count_w			bigint;
dt_mesano_referencia_w	timestamp;


BEGIN 
 
select	count(*) 
into STRICT	qt_regra_movto_w 
from	convenio_ret_regra_imp a 
where	a.nr_seq_retorno	= nr_seq_retorno_p;
 
if (qt_regra_movto_w	> 0) then 
 
	select	max(b.ie_tipo_atendimento), 
		coalesce(max(a.dt_mesano_referencia),clock_timestamp()) 
	into STRICT	ie_tipo_atendimento_w, 
		dt_mesano_referencia_w 
	from	atendimento_paciente b, 
		conta_paciente a 
	where	a.nr_atendimento	= b.nr_atendimento 
	and	a.nr_interno_conta	= nr_interno_conta_p;
	 
	select	count(*) 
	into STRICT	count_w 
	from	sus_aih_unif 
	where	nr_interno_conta	= nr_interno_conta_p;
	 
	if (count_w > 0) then 
		 
		select	max(a.cd_procedimento), 
			max(a.ie_origem_proced) 
		into STRICT	cd_procedimento_real_w, 
			ie_origem_proc_real_w 
		from	procedimento_paciente a 
		where	a.nr_interno_conta	= nr_interno_conta_p 
		and	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
		and	(sus_obter_tiporeg_proc(a.cd_procedimento,a.ie_origem_proced,'C',13))::numeric  in (3,6)--procedimento principa AIH 
		and	a.vl_procedimento	= 
						(SELECT	max(x.vl_procedimento) 
						from	procedimento_paciente x 
						where	x.nr_interno_conta	= nr_interno_conta_p 
						and	coalesce(x.cd_motivo_exc_conta::text, '') = '' 
						and	(sus_obter_tiporeg_proc(x.cd_procedimento,x.ie_origem_proced,'C',13))::numeric  in (3,6));
 
		if (cd_procedimento_real_w IS NOT NULL AND cd_procedimento_real_w::text <> '') then 
			 
			select	max(ie_tipo_financiamento), 
				max(ie_complexidade), 
				max(nr_seq_grupo), 
				max(nr_seq_subgrupo) 
			into STRICT	ie_tipo_financiamento_w, 
				ie_complexidade_w, 
				nr_seq_grupo_w, 
				nr_seq_subgrupo_w 
			from	sus_estrutura_procedimento_v a 
			where	a.cd_procedimento		= cd_procedimento_real_w 
			and	a.ie_origem_proced		= ie_origem_proc_real_w;
 
		end if;
	end if;
 
	select	count(*) 
	into STRICT	qt_regra_movto_w 
	from	convenio_ret_regra_imp a 
	where	coalesce(a.ie_tipo_atendimento,coalesce(ie_tipo_atendimento_w,0))		= coalesce(ie_tipo_atendimento_w,0) 
	and	coalesce(a.nr_seq_grupo,coalesce(nr_seq_grupo_w,0))			= coalesce(nr_seq_grupo_w,0) 
	and	coalesce(a.nr_seq_subgrupo,coalesce(nr_seq_subgrupo_w,0))			= coalesce(nr_seq_subgrupo_w,0) 
	and	coalesce(a.ie_complexidade,coalesce(ie_complexidade_w,'X'))		= coalesce(ie_complexidade_w,'X') 
	and	coalesce(a.ie_tipo_financiamento,coalesce(ie_tipo_financiamento_w,'X'))	= coalesce(ie_tipo_financiamento_w,'X') 
	and	dt_mesano_referencia_w between coalesce(dt_ref_inicio,dt_mesano_referencia_w-1) and coalesce(dt_ref_final,clock_timestamp() + interval '1 days') 
	and	a.nr_seq_retorno	= nr_seq_retorno_p;
 
	if (qt_regra_movto_w	= 0) then 
		ie_guia_retorno_w	:= 'N';
	end if;
 
end if;
 
RETURN ie_guia_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_conta_retorno (nr_seq_retorno_p bigint, nr_interno_conta_p bigint) FROM PUBLIC;

