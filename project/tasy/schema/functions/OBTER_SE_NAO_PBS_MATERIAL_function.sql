-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_nao_pbs_material ( cd_material_p prescr_material.cd_material%type, nr_atendimento_p atend_categoria_convenio.nr_atendimento%type) RETURNS varchar AS $body$
DECLARE


cd_convenio_w           atend_categoria_convenio.cd_convenio%type;
cd_plano_convenio_w     atend_categoria_convenio.cd_plano_convenio%type;
ie_nopbs_w              material.ie_nopbs%type;
ie_eps_w                convenio_plano.ie_eps%type;


BEGIN

	select	cd_convenio, 
			cd_plano_convenio
	into STRICT	cd_convenio_w,
			cd_plano_convenio_w
	from (	SELECT	acc.cd_convenio cd_convenio,
					acc.cd_plano_convenio cd_plano_convenio
			from	atend_categoria_convenio acc
			where	acc.nr_atendimento = nr_atendimento_p
			and		trunc(acc.dt_inicio_vigencia) <= trunc(clock_timestamp())
			and (coalesce(acc.dt_final_vigencia::text, '') = '' or trunc(acc.dt_final_vigencia) >= trunc(clock_timestamp()))
			order	by acc.dt_inicio_vigencia desc) alias8 LIMIT 1;

	/*ie_nopbs com base no material */

	select  coalesce(max(a.ie_nopbs), 'N')
	into STRICT    ie_nopbs_w
	from    material a
	where   a.cd_material = cd_material_p;

	/*ie_eps com base no codigo do plano e convenio do atendimento */

	select  coalesce(max(a.ie_eps), 'N')
	into STRICT    ie_eps_w
	from    convenio_plano a
	where   a.cd_convenio = cd_convenio_w
	and     a.cd_plano = cd_plano_convenio_w;

return case when ie_nopbs_w = 'S' and ie_eps_w = 'S' then 'S' else 'N' end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_nao_pbs_material ( cd_material_p prescr_material.cd_material%type, nr_atendimento_p atend_categoria_convenio.nr_atendimento%type) FROM PUBLIC;

