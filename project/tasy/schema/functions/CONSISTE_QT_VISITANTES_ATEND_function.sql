-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_qt_visitantes_atend ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, nr_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ds_forma_cons_acomp_w	varchar(5);
ds_acompanhante_w		varchar(1);
qt_perm_acomp_w		integer;
qt_atend_acomp_w		integer;
ds_retorno_w		varchar(255);


BEGIN

qt_perm_acomp_w	:= 0;
qt_atend_acomp_w	:= 0;

-- Controle de Visitas - Parâmetro [38] - Forma de consistir a quantidade de acompanhantes
ds_forma_cons_acomp_w := obter_param_usuario(8014, 38, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_forma_cons_acomp_w);

if (ds_forma_cons_acomp_w = 'EA') then
	if ((cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') and
		(cd_unidade_basica_p IS NOT NULL AND cd_unidade_basica_p::text <> '') and
		(cd_unidade_compl_p IS NOT NULL AND cd_unidade_compl_p::text <> '')) then
		select	coalesce(sum(qt_max_acomp), 0)
		into STRICT	qt_perm_acomp_w
		from	unidade_atendimento
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	cd_unidade_basica	= cd_unidade_basica_p
		and	cd_unidade_compl	= cd_unidade_compl_p;
	end if;
elsif (ds_forma_cons_acomp_w = 'UEU') then
	SELECT 	max(nr_acompanhante)
	into STRICT 	qt_perm_acomp_w
	FROM 	atend_categoria_convenio
	WHERE 	nr_atendimento = nr_atendimento_p
	AND 	nr_seq_interno = (	SELECT 	Max(nr_seq_interno)
					FROM 	atend_categoria_convenio
					WHERE 	nr_atendimento = nr_atendimento_p);
elsif (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	select	coalesce(sum(nr_acompanhante), 0)
	into STRICT	qt_perm_acomp_w
	from	atend_categoria_convenio
	where	nr_atendimento	= nr_atendimento_p;
end if;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	select	count(*)
	into STRICT	qt_atend_acomp_w
	from	atendimento_acompanhante
	where	nr_atendimento	= nr_atendimento_p
	and	coalesce(dt_saida::text, '') = '';
end if;

if (qt_atend_acomp_w >= qt_perm_acomp_w) then
	begin
	-- Ocupação hospitalar - Parâmetro [23] - Ação sistema quanto ao número de acompanhantes
	ds_acompanhante_w := obter_param_usuario(44, 23, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_acompanhante_w);

	if (ds_acompanhante_w = 'B') then
		ds_retorno_w	:= substr(obter_texto_tasy(42048, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	elsif (ds_acompanhante_w = 'A') then
		ds_retorno_w	:= substr(obter_texto_tasy(42049, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	end if;
	end;
end if;

return	ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_qt_visitantes_atend ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, nr_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

