-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pc_obter_exame_lab (nr_atendimento_p atendimento_paciente.nr_atendimento%type) RETURNS varchar AS $body$
DECLARE


count_yelow_w	integer := 0;
count_blue_w	integer := 0;
count_red_w		integer := 0;
return_w		varchar(1) := '';


BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	select 	count(*)
	into STRICT	count_yelow_w
	from prescr_procedimento p,
		 prescr_medica m 
	where 	p.nr_prescricao = m.nr_prescricao
	and		ie_status_atend < 35
	and 	(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '')
	and 	nr_atendimento = nr_atendimento_p;

	select 	count(*)
	into STRICT	count_blue_w 
	from prescr_procedimento p,
		 prescr_medica m 
	where 	p.nr_prescricao = m.nr_prescricao
	and 	ie_status_atend >= 35
	and 	(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '')
	and 	nr_atendimento = nr_atendimento_p;

	select 	count(*)
	into STRICT	count_red_w
	from exame_lab_result_item a,
		 exame_lab_resultado b,
		 prescr_medica m
	where 	b.nr_prescricao = m.nr_prescricao
	and 	a.nr_seq_resultado = b.nr_seq_resultado
	and 	ie_resultado_critico = 'S'
	and 	m.nr_atendimento = nr_atendimento_p;


	if (count_red_w > 0) then
		return_w := 'R';
	elsif (count_yelow_w = 0 and count_blue_w > 0) then
		return_w := 'G';
	elsif (count_blue_w > 0) then
		return_w := 'B';
	elsif (count_yelow_w > 0) then
		return_w := 'Y';
	end if;
end if;

return return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION pc_obter_exame_lab (nr_atendimento_p atendimento_paciente.nr_atendimento%type) FROM PUBLIC;

