-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_local_estoque_regra_ged ( cd_setor_atendimento_p bigint, nr_prescricao_p bigint default null, nr_seq_material_p bigint default null, ie_opcao_p text default null, dt_horario_p timestamp default null, ie_dose_especial_p text default 'N') RETURNS bigint AS $body$
DECLARE


/*
ie_opcao_p
S = Sequencia da regra.
*/
cd_local_estoque_w			smallint	:= null;
cd_grupo_material_w			smallint 	:= null;
cd_subgrupo_material_w		smallint 	:= null;
cd_classe_material_w		integer 	:= null;
cd_material_w				integer 	:= null;
nr_seq_familia_w			bigint 	:= null;
cd_material_estoque_w		smallint 	:= null;
ie_via_aplicacao_w			varchar(5) := null;
cd_setor_prescricao_w		integer 	:= null;
cd_local_estoque_prescr_w	smallint := null;
ie_urgencia_w				varchar(1);
ie_acm_w					varchar(1);
ie_se_necessario_w			varchar(1);
nr_sequencia_w				bigint;
nr_retorno_w				bigint;
qt_minuto_w					bigint;
qt_dose_especial_w			double precision;
ie_dose_espec_agora_w		varchar(1);
ie_classif_urgente_w		prescr_mat_hor.ie_classif_urgente%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ie_item_fracionado_w		varchar(1);
qt_dose_w					prescr_material.qt_dose%type;
cd_um_dose_w				prescr_material.cd_unidade_medida_dose%type;
qt_dose_total_medic_w		material.qt_conv_estoque_consumo%type;
cd_um_consumo_med_w			material.cd_unidade_medida_consumo%type;
ie_agrupador_w              prescr_material.ie_agrupador%type;
nr_seq_mat_cpoe_w           prescr_material.nr_seq_mat_cpoe%type;
ie_tipo_solucao_w           cpoe_material.ie_tipo_solucao%type;
ie_tipo_bomba_w             cpoe_material.ie_bomba_infusao%type;
nr_sequencia_solucao_w      prescr_material.nr_sequencia_solucao%type;

C01 CURSOR FOR
	SELECT	a.cd_local_estoque,
			a.nr_sequencia
	from	regra_local_disp_gedipa a
	where	coalesce(a.cd_setor_atendimento, coalesce(cd_setor_atendimento_p,0))	= coalesce(cd_setor_atendimento_p,0)
  and   coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_w,0))	= coalesce(cd_estabelecimento_w,0)
	and 	coalesce(a.cd_setor_prescricao,coalesce(cd_setor_prescricao_w,0))		= coalesce(cd_setor_prescricao_w,0)
	and		coalesce(a.cd_grupo_material, coalesce(cd_grupo_material_w,0))		= coalesce(cd_grupo_material_w,0)
	and		coalesce(a.cd_subgrupo_material, coalesce(cd_subgrupo_material_w,0))	= coalesce(cd_subgrupo_material_w,0)
	and		coalesce(a.cd_classe_material, coalesce(cd_classe_material_w,0))		= coalesce(cd_classe_material_w,0)
	and		coalesce(a.cd_material, coalesce(cd_material_w,0))					= coalesce(cd_material_w,0)
	and		coalesce(nr_seq_familia, coalesce(nr_seq_familia_w,0))				= coalesce(nr_seq_familia_w,0)
	--and		qt_minuto_w between nvl(qt_min_inicio,-999999999) and nvl(qt_max_inicio,999999999)
	and		coalesce(a.ie_via_aplicacao, coalesce(ie_via_aplicacao_w,'XX'))		= coalesce(ie_via_aplicacao_w,'XX')
	and		((coalesce(ie_agora,'N') = 'N') or (ie_agora = 'S' AND ie_urgencia_w = 'S'))
	and		(((coalesce(ie_somente_acmsn,'N') = 'G') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S') or (ie_urgencia_w = 'S'))) or
			((coalesce(ie_somente_acmsn,'N') = 'S') and ((ie_acm_w = 'S') or (ie_se_necessario_w = 'S'))) or
			((coalesce(ie_somente_acmsn,'N') = 'A') and (ie_acm_w = 'S') and (ie_se_necessario_w = 'N')) or
			((coalesce(ie_somente_acmsn,'N') = 'C') and (ie_acm_w = 'N') and (ie_se_necessario_w = 'S')) or (coalesce(ie_somente_acmsn,'N') = 'N'))
	and 	((coalesce(ie_dose_especial,'N') = 'N') or ((coalesce(ie_dose_especial,'N') = 'S') and (ie_dose_especial_p = 'S')))
	and     ((coalesce(ie_tipo_lote,'X') = 'X') or (ie_tipo_lote = 'A' and ie_classif_urgente_w = 'A') or (ie_tipo_lote = 'N' and ie_classif_urgente_w = 'N') or (ie_tipo_lote = 'E' and ie_classif_urgente_w = 'E'))
	and 	((coalesce(a.ie_somente_fracionados, 'N') = 'S' and coalesce(ie_item_fracionado_w, 'N') = 'S') or (coalesce(a.ie_somente_fracionados, 'N') = 'N'))
    and     coalesce(a.ie_tipo_solucao, ie_tipo_solucao_w, 'XPTO') = coalesce(ie_tipo_solucao_w, 'XPTO')
    and     coalesce(a.ie_bomba_infusao, ie_tipo_bomba_w, 'XPTO') = coalesce(ie_tipo_bomba_w, 'XPTO')
	order by coalesce(a.cd_material,0),
			coalesce(ie_agora,'AAAAA'),
			coalesce(cd_setor_atendimento,0000000),			
			coalesce(a.cd_grupo_material,0),
			coalesce(a.cd_subgrupo_material,0),
			coalesce(a.cd_classe_material,0),
			coalesce(nr_seq_familia,0),
			coalesce(a.ie_via_aplicacao,'AAAAA'),
			coalesce(a.ie_dose_especial,'AAAA'),
			coalesce(ie_tipo_lote,'AAAA'),
			coalesce(ie_somente_fracionados, 'AAAA');


BEGIN

qt_minuto_w := coalesce(Obter_Min_Entre_Datas(clock_timestamp(),dt_horario_p,1),0);

if (coalesce(nr_prescricao_p,0) > 0) and (coalesce(nr_seq_material_p,0) > 0) then

	select	max(coalesce(a.ie_via_aplicacao,'XPTO')),
			max(b.cd_grupo_material),
			max(b.cd_subgrupo_material),
			max(b.cd_classe_material),
			max(b.cd_material),
			max(coalesce(b.nr_seq_familia,0)),
			max(coalesce((substr(obter_setor_prescricao(a.nr_prescricao,'C'),1,5))::numeric ,0)),
			max(obter_local_estoque_setor(c.cd_setor_atendimento, c.cd_estabelecimento)),
			max(coalesce(ie_urgencia,'N')),
			max(coalesce(a.ie_acm, 'N')),
			max(coalesce(a.ie_se_necessario,'N')),
			max(coalesce(qt_dose_especial,0)),
			max(ie_dose_espec_agora),			
			max(c.cd_estabelecimento),
			max(coalesce(a.qt_dose,0)),
			max(coalesce(a.cd_unidade_medida_dose,'XPTO')),
      max(a.ie_agrupador),
      max(a.nr_seq_mat_cpoe),
      max(a.nr_sequencia_solucao)
	into STRICT	ie_via_aplicacao_w,
			cd_grupo_material_w,
			cd_subgrupo_material_w,
			cd_classe_material_w,
			cd_material_w,
			nr_seq_familia_w,
			cd_setor_prescricao_w,
			cd_local_estoque_prescr_w,
			ie_urgencia_w,
			ie_acm_w,
			ie_se_necessario_w,
			qt_dose_especial_w,
			ie_dose_espec_agora_w,
			cd_estabelecimento_w,
			qt_dose_w,
			cd_um_dose_w,
      ie_agrupador_w,
      nr_seq_mat_cpoe_w,
      nr_sequencia_solucao_w
	from	prescr_medica c,
			estrutura_material_v b,
			prescr_material a
	where	b.cd_material		= a.cd_material
	and		a.nr_prescricao		= nr_prescricao_p
	and		a.nr_prescricao		= c.nr_prescricao
	and 	nr_sequencia 		= nr_seq_material_p;

    if (ie_agrupador_w = 4) then
        if (nr_seq_mat_cpoe_w IS NOT NULL AND nr_seq_mat_cpoe_w::text <> '') then
            select  coalesce(max(converte_ie_tipo_solucao_cpoe(a.nr_sequencia)), 0),
                    coalesce(max(a.ie_bomba_infusao), 'XPTO')
            into STRICT    ie_tipo_solucao_w,
                    ie_tipo_bomba_w
            from    cpoe_material a
            where   a.nr_sequencia = nr_seq_mat_cpoe_w;
        else
            select  coalesce(max(converte_ie_tipo_solucao(a.nr_prescricao, a.nr_seq_solucao)), 0),
                    coalesce(max(a.ie_bomba_infusao), 'XPTO')
            into STRICT    ie_tipo_solucao_w,
                    ie_tipo_bomba_w
            from    prescr_solucao a
            where   a.nr_prescricao = nr_prescricao_p
            and     a.nr_seq_solucao = nr_sequencia_solucao_w;
        end if;
    end if;

	
	cd_um_consumo_med_w	:= upper(substr(obter_dados_material_estab(cd_material_w,cd_estabelecimento_w,'UMS'),1,30));

	if (upper(cd_um_consumo_med_w) = upper(cd_um_dose_w)) then
		qt_dose_total_medic_w	:=	obter_dados_material_estab(cd_material_w,cd_estabelecimento_w,'QEC');
	else
		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_dose_total_medic_w
		from	material_conversao_unidade
		where	cd_material	= cd_material_w
		and	upper(cd_unidade_medida)	= upper(cd_um_dose_w);
	end if;

	if (mod(qt_dose_w,qt_dose_total_medic_w) = 0) then
		ie_item_fracionado_w	:= 'N';
	else
		ie_item_fracionado_w	:= 'S';
	end if;

elsif (coalesce(nr_prescricao_p,0) > 0) then

	select	max(obter_local_estoque_setor(cd_setor_atendimento, cd_estabelecimento)),
			max(cd_setor_atendimento),
      max(cd_estabelecimento)
	into STRICT	cd_local_estoque_prescr_w,
			cd_setor_prescricao_w,
      cd_estabelecimento_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;

end if;

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and
	(nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '' AND nr_seq_material_p > 0) and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') then

	select	max(coalesce(ie_classif_urgente,'X'))
	into STRICT 	ie_classif_urgente_w
	from 	prescr_mat_hor
	where 	nr_prescricao 	= nr_prescricao_p
	and 	nr_seq_material	= nr_seq_material_p
	and 	dt_horario 		= dt_horario_p;

end if;
open C01;
loop
fetch C01 into
	cd_local_estoque_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	cd_local_estoque_w	:= cd_local_estoque_w;
	nr_sequencia_w		:= nr_sequencia_w;
	end;
end loop;
close C01;

nr_retorno_w := coalesce(cd_local_estoque_w,cd_local_estoque_prescr_w);

if (coalesce(ie_opcao_p,'X') = 'S') then
	nr_retorno_w := coalesce(nr_sequencia_w,0);
end if;

return nr_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_local_estoque_regra_ged ( cd_setor_atendimento_p bigint, nr_prescricao_p bigint default null, nr_seq_material_p bigint default null, ie_opcao_p text default null, dt_horario_p timestamp default null, ie_dose_especial_p text default 'N') FROM PUBLIC;

