-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION validate_storage_log ( cd_establishment_p bigint, cd_profile_p bigint, cd_department_p bigint, cd_function_p bigint, nr_seq_fun_schematic_p bigint, nr_seq_obj_schematic_p bigint, nm_user_p text) RETURNS SETOF LOG_SETTINGS_TABLE AS $body$
DECLARE
 TYPE cursor_ref REFCURSOR;

settings_r	log_settings_row := log_settings_row(null,null,null,null);
found_rule_w varchar(1) := 'N';
nr_seq_obj_schematic_w bigint;
nr_seq_fun_schematic_w bigint;

c01 CURSOR FOR
	SELECT 	ie_storage_access_log,
			ie_storage_repeated_access_log,
			ie_storage_filter_log,
			nr_sequencia
	from	access_item
	where	cd_estabelecimento = cd_establishment_p
	and		cd_funcao = cd_function_p
	and		nr_seq_obj_schematic = nr_seq_obj_schematic_w
	and   	ie_situacao = 'A'
	and   	dt_effective < clock_timestamp()
	and		nr_seq_funcao_schematic = nr_seq_fun_schematic_w
	and		coalesce(nm_usuario_regra,coalesce(nm_user_p,'')) = coalesce(nm_user_p,'')
	and		coalesce(cd_perfil,coalesce(cd_profile_p,0)) = coalesce(cd_profile_p,0)
	and		coalesce(cd_setor,coalesce(cd_department_p,0)) = coalesce(cd_department_p,0)
	order by cd_perfil, cd_setor, nm_usuario_regra;

c02 CURSOR FOR
	SELECT 	ie_storage_access_log,
			ie_storage_repeated_access_log,
			ie_storage_filter_log,
			nr_sequencia
	from	access_item
	where	cd_estabelecimento = cd_establishment_p
	and		cd_funcao = cd_function_p
	and		nr_seq_funcao_schematic = nr_seq_fun_schematic_w
	and		coalesce(nr_seq_obj_schematic::text, '') = ''
	and   	ie_situacao = 'A'
	and   	dt_effective < clock_timestamp()
	and		coalesce(nm_usuario_regra,coalesce(nm_user_p,'')) = coalesce(nm_user_p,'')
	and		coalesce(cd_perfil,coalesce(cd_profile_p,0)) = coalesce(cd_profile_p,0)
	and		coalesce(cd_setor,coalesce(cd_department_p,0)) = coalesce(cd_department_p,0)
	order by cd_perfil, cd_setor, nm_usuario_regra;


BEGIN
if (cd_establishment_p IS NOT NULL AND cd_establishment_p::text <> '') then
	begin
	 if (nr_seq_obj_schematic_p IS NOT NULL AND nr_seq_obj_schematic_p::text <> '') then
		begin
		nr_seq_obj_schematic_w := nr_seq_obj_schematic_p;
		nr_seq_fun_schematic_w := nr_seq_fun_schematic_p;

		if (coalesce(nr_seq_fun_schematic_w::text, '') = '') and (cd_function_p IS NOT NULL AND cd_function_p::text <> '') then
			begin
			select 	max(nr_sequencia)
			into STRICT	nr_seq_fun_schematic_w
			from	funcao_schematic
			where	cd_funcao = cd_function_p
			and		ie_situacao_funcao = 'A';
			end;
		end if;

		while(found_rule_w = 'N') and (nr_seq_obj_schematic_w IS NOT NULL AND nr_seq_obj_schematic_w::text <> '') loop
			open c01;
			loop
			fetch c01
			into	settings_r.ie_storage_access,
					settings_r.ie_storage_repeated_access,
					settings_r.ie_storage_filter,
					settings_r.nr_sequence_record;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				begin
				found_rule_w := 'S';
				RETURN NEXT settings_r;
				end;
			end loop;
			close c01;
			if (found_rule_w = 'N') then
				begin
				begin
				nr_seq_obj_schematic_w := schematic_obter_parent_nav(nr_seq_obj_schematic_w);
				exception
				when no_data_found then
					nr_seq_obj_schematic_w := null;
				end;

				if (coalesce(nr_seq_obj_schematic_w::text, '') = '') then
					begin
					open c02;
					loop
					fetch c02
					into	settings_r.ie_storage_access,
							settings_r.ie_storage_repeated_access,
							settings_r.ie_storage_filter,
							settings_r.nr_sequence_record;
					EXIT WHEN NOT FOUND; /* apply on c02 */
						begin
						RETURN NEXT settings_r;
						end;
					end loop;
					close c02;
					end;
				end if;
				end;
			end if;
		end loop;
		end;
	else
		begin
		if (nr_seq_fun_schematic_p IS NOT NULL AND nr_seq_fun_schematic_p::text <> '') then
			begin
			nr_seq_fun_schematic_w := nr_seq_fun_schematic_p;
			end;
		elsif (cd_function_p IS NOT NULL AND cd_function_p::text <> '') then
			begin
			select 	max(nr_sequencia)
			into STRICT	nr_seq_fun_schematic_w
			from	funcao_schematic
			where	cd_funcao = cd_function_p
			and		ie_situacao_funcao = 'A';
			end;
		end if;

		open c02;
		loop
		fetch c02
		into	settings_r.ie_storage_access,
				settings_r.ie_storage_repeated_access,
				settings_r.ie_storage_filter,
				settings_r.nr_sequence_record;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			RETURN NEXT settings_r;
			end;
		end loop;
		close c02;
		end;
	end if;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION validate_storage_log ( cd_establishment_p bigint, cd_profile_p bigint, cd_department_p bigint, cd_function_p bigint, nr_seq_fun_schematic_p bigint, nr_seq_obj_schematic_p bigint, nm_user_p text) FROM PUBLIC;

