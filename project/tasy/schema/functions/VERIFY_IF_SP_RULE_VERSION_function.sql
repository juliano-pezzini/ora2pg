-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION verify_if_sp_rule_version ( cd_versao_p text, dt_liberacao_p timestamp, ds_hotfix_p text ) RETURNS varchar AS $body$
DECLARE

ie_libera_w				varchar(1) 	:= 'S';
qt_existe_w				bigint	:= 0;
qt_liberado_w				bigint	:= 0;
ds_hotfix_w				varchar(255);
instance_name_w     varchar(50) := null;
user_w              varchar(50) := null;
dblink_w            varchar(50) := null;

sql_regra_versao_sp_w varchar(32767) := '
select	count(*)
from	#@user#@regra_versao_sp#@dblink#@
where	cd_versao 		= :cd_versao_p
and	sysdate between dt_inicio_regra and dt_termino_regra
and	NVL(ds_hotfix,''0'') = NVL(:ds_hotfix_p,''0'')
';


BEGIN

    instance_name_w := sys_context('userenv','instance_name');

    if (instance_name_w = 'PHDEV') then
        dblink_w := '@whebl01_dbcorp';
        user_w := 'corp.';
    end if;

    sql_regra_versao_sp_w := replace(sql_regra_versao_sp_w,'#@user#@',user_w);
    sql_regra_versao_sp_w := replace(sql_regra_versao_sp_w,'#@dblink#@',dblink_w);

    EXECUTE sql_regra_versao_sp_w 
    into STRICT qt_existe_w 
    using cd_versao_p, ds_hotfix_p;

	if (qt_existe_w > 0) then
		if (coalesce(dt_liberacao_p::text, '') = '') then
			ie_libera_w	:= 'N';
		else
			ie_libera_w	:= 'S';
		end if;
	else
		ie_libera_w	:= 'S';
	end if;

return ie_libera_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION verify_if_sp_rule_version ( cd_versao_p text, dt_liberacao_p timestamp, ds_hotfix_p text ) FROM PUBLIC;

