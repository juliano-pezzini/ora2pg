-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_mat_lib_prof_exec ( cd_pessoa_fisica_p text, cd_material_p bigint, ie_entrega_retira_p text) RETURNS varchar AS $body$
DECLARE


ie_existe_regra_w		varchar(1);
ie_libera_profissional_w	varchar(1);
cd_classe_material_w		integer;
cd_subgrupo_material_w		integer;
cd_grupo_material_w		integer;

/*
ie_entrega_retira_p
E - Entrega
R - Retira
*/
BEGIN

select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_existe_regra_w
from 	regra_lib_mat_profissional;

if (ie_existe_regra_w = 'S') then
	select	Obter_estrutura_material(cd_material,'G'),
		Obter_estrutura_material(cd_material,'S'),
		cd_classe_material
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w
	from 	material
	where	cd_material = cd_material_p;------
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_libera_profissional_w
	from 	regra_lib_mat_profissional a,
		profssional_regra_lib_mat b
	where 	a.nr_sequencia						= b.nr_seq_regra
	and	b.cd_profissional 					= cd_pessoa_fisica_p
	and 	coalesce(b.cd_estabelecimento,coalesce(wheb_usuario_pck.get_cd_estabelecimento,0))  =  coalesce(wheb_usuario_pck.get_cd_estabelecimento,0)
	and	coalesce(cd_material,cd_material_p) 				= cd_material_p
	and	coalesce(cd_grupo_material,cd_grupo_material_w) 		= cd_grupo_material_w
	and	coalesce(cd_subgrupo_material,cd_subgrupo_material_w)	= cd_subgrupo_material_w
	and	coalesce(cd_classe_material,cd_classe_material_w) 		= cd_classe_material_w
	and	(((ie_entrega_retira_p = 'R') and (coalesce(ie_permite_cirurgia,'S') = 'S')) or
		 ((ie_entrega_retira_p = 'E') and (coalesce(ie_permite_entregar,'S') = 'S')));
else
	ie_libera_profissional_w	:= 'S';
end if;

return	ie_libera_profissional_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_mat_lib_prof_exec ( cd_pessoa_fisica_p text, cd_material_p bigint, ie_entrega_retira_p text) FROM PUBLIC;

