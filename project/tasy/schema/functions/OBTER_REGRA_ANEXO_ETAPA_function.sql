-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_anexo_etapa ( nr_seq_etapa_dest_p regra_valida_anexo_etapa.nr_seq_etapa_dest%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type) RETURNS varchar AS $body$
DECLARE


nr_seq_classificacao_w		atendimento_paciente.nr_seq_classificacao%type;
nr_seq_etapa_w			conta_paciente_etapa.nr_seq_etapa%type;
ie_valida_anexo_w		regra_valida_anexo_etapa.ie_valida_anexo%type;
ie_primeiro_atend_ciclo_w	regra_valida_anexo_etapa.ie_primeiro_atend_ciclo%type := 'S';

qt_attach_w		bigint;
qt_first_cycle_att_w	bigint;

c01 CURSOR FOR
SELECT  ie_valida_anexo
from	regra_valida_anexo_etapa
where (coalesce(nr_seq_etapa_dest::text, '') = '' or nr_seq_etapa_dest	= coalesce(nr_seq_etapa_w, 0))
and (coalesce(nr_seq_classificacao::text, '') = '' or nr_seq_classificacao = coalesce(nr_seq_classificacao_w, 0))
and	ie_primeiro_atend_ciclo = ie_primeiro_atend_ciclo_w
order by nr_seq_etapa_dest,
	 nr_seq_classificacao;


BEGIN

select	count(1)
into STRICT	qt_attach_w
from	conta_paciente_anexo
where	nr_interno_conta = nr_interno_conta_p  LIMIT 1;

if (qt_attach_w = 0) then

	nr_seq_etapa_w	:= nr_seq_etapa_dest_p;

	select	max(nr_seq_classificacao)
	into STRICT	nr_seq_classificacao_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;
	
	select  count(1)
	into STRICT	qt_first_cycle_att_w
	from    paciente_atendimento
	where   nr_atendimento = nr_atendimento_p
	and     nr_ciclo = 1
	and     ds_dia_ciclo = 'D1'  LIMIT 1;
	if (qt_first_cycle_att_w = 0) then
		ie_primeiro_atend_ciclo_w := 'N';
	end if;

	open C01;
	loop
	fetch C01 into
		ie_valida_anexo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_valida_anexo_w := ie_valida_anexo_w;
		end;
	end loop;
	close C01;
	
else
	ie_valida_anexo_w := 'N';
end if;

return	coalesce(ie_valida_anexo_w, 'N');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_anexo_etapa ( nr_seq_etapa_dest_p regra_valida_anexo_etapa.nr_seq_etapa_dest%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type) FROM PUBLIC;

