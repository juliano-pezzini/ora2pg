-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_pcs (cd_empresa_p bigint, nr_seq_regional_p bigint, nr_seq_segmento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, cd_estabelecimento_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*Código empresa 	= cd_empresa_p
Código regional    	= nr_seq_regional_p
Código estabelecimento	= cd_estabelecimento_p
Código segmento 	=  nr_seq_segmento_p
Código do material	=  cd_material_p
ie_opcao		= ie_opcao_p*/
CD_EMPRESA_W			smallint;
DS_EMPRESA_W			varchar(100);
CD_GRUPAMENTO_W			bigint;
DS_GRUPAMENTO_W			varchar(255);
CD_SEGMENTO_W			bigint;
DS_SEGMENTO_W			varchar(255);
CD_MATERIAL_W			bigint;
DS_MATERIAL_W			varchar(255);
CD_ESTAB_W			smallint;
DS_ESTAB_W			varchar(255);
CD_REGIONAL_W			bigint;
DS_REGIONAL_W			varchar(255);
DT_EMISSAO_OC_W			timestamp;
NR_ORDEM_COMPRA_W		bigint;
IE_OC_APROVADA_W		varchar(1);
DS_FORNEC_OC_W			varchar(255);
NM_PESSOA_FISICA_W		varchar(255);
QT_PEDIDO_W			double precision;
DT_PREV_ENTREGA_W		timestamp;
NM_COMPRADOR_W			varchar(80);
QT_CDA_W			double precision;
QT_CD07_W			double precision;
QT_CD15_W			double precision;
QT_CD30_W			double precision;
QT_CD60_W			double precision;
QT_CD90_W			double precision;
QT_CD120_W			double precision;
QT_CD150_W			double precision;
QT_CD180_W			double precision;
QT_MAIOR_CONS_3M_W		double precision;
QT_COBERTURA_ALMOX_W		double precision;
QT_COBERTURA_FARM_W		double precision;
QT_SALDO_ALMOX_W		double precision;
QT_SALDO_FARM_W			double precision;
QT_SALDO_TOTAL_W		double precision;
VL_SALDO_TOTAL_W		double precision;
QT_ORDENS_TOTAL_W		double precision;
VL_CUSTO_MEDIO_W		double precision;
QT_MELHOR_COMPRA_W		double precision;
QT_LEAD_TIME_W			double precision;
QT_ESTOQUE_MINIMO_W		double precision;
DT_INICIO_FALTA_W		timestamp;
IE_FALTA_SOLUCIONADA_W		varchar(1);
DS_MOTIVO_FALTA_W		varchar(255);
QT_SALDO_EXTERNO_W		double precision;
DS_MODALIDADE_W			varchar(255);
IE_MODALIDADE_W			varchar(15);
VL_FATUR_MINIMO_W		double precision;
DS_FORNEC_CONTRAT_W		varchar(255);
NM_COMPRADOR_REGRA_W		varchar(80);
NR_SOLIC_COMPRA_W		bigint;
QT_PENDENTE_OC_W		double precision;
NR_DOCUMENTO_W			bigint;
TP_DOCUMENTO_W			varchar(14);
QT_PEND_DOC_W			double precision;
QT_PENDENTE_W			double precision;
QT_POLITICA_W			bigint;
QT_FREQUENCIA_W			bigint;
QT_MARGEM_DIAS_W		bigint;
QT_MIN_ESTOQUE_W		double precision;
QT_MAX_ESTOQUE_W		double precision;
DS_RETORNO_W			varchar(255);
QT_MEDIA_CONSUMO_MES01_W	double precision;
QT_MEDIA_CONSUMO_MES02_W	double precision;
QT_MEDIA_CONSUMO_MES03_W	double precision;
QT_MEDIA_CONSUMO_X_W		double precision;
QT_MEDIA_CONSUMO_U_W		double precision;
QT_MEDIA_MAIOR_W		double precision;
CD_COMPRADOR_W			varchar(10);
CD_COMPRADOR_REGRA_W		varchar(10);
CD_PESSOA_FISICA_W		varchar(10);
QT_EXISTE_POLITICA_W		bigint;
QT_MATERIAL_W			double precision;
DT_PREVISTA_SOLIC_W		timestamp;
QT_CONSUMO_BASE_CALCULO_W	double precision;
CD_ESTABELECIMENTO_W		smallint;
QT_EXISTE_W			bigint;
QT_DIA_RESSUP_FORN_W		smallint;
CD_CNPJ_CONTRATADO_W		varchar(14);
CD_CGC_FORNECEDOR_W		varchar(14);
QT_SALDO_W			double precision;
NR_SEQ_RELATORIO_W		pcs_segmento_compras_rel.nr_sequencia%type;
IE_PERIODO_REFERENCIA_W		pcs_regra_estatistica.ie_periodo_referencia%type;
QT_PERIODO_X_W			pcs_regra_estatistica.qt_periodo_x%type;
QT_PERIODO_U_W			pcs_regra_estatistica.qt_periodo_u%type;
NR_SEQ_REGRA_W			pcs_regra_estatistica.nr_sequencia%type;
PR_CONFIANCA_W			pcs_anal_reg_estatistica.pr_confianca%type;
VL_INT_CONFIANCA_Z_SUP_W	double precision;
VL_INT_CONFIANCA_Z_INF_W	double precision;
VL_TESTE_Z_W			double precision;
VL_INT_CONFIANCA_T_SUP_W	double precision;
VL_INT_CONFIANCA_T_INF_W	double precision;
VL_TESTE_T_W			double precision;
QT_MEDIA_DESVIO_PADRAO_X_W	double precision;
QT_MEDIA_DESVIO_PADRAO_U_W	double precision;
CD_GRUPO_MATERIAL_W		pcs_regra_estatistica.cd_grupo_material%type;
CD_SUBGRUPO_MATERIAL_W		pcs_regra_estatistica.cd_subgrupo_material%type;
CD_CLASSE_MATERIAL_W		pcs_regra_estatistica.cd_classe_material%type;
NR_SEQ_FAMILIA_W		pcs_regra_estatistica.nr_seq_familia%type;
QT_COBERTURA_REGRA_W		double precision;


BEGIN

cd_estabelecimento_w := cd_estabelecimento_p;

if (ie_opcao_p in ('CD_EMPRESA','DS_EMPRESA')) then

	select 	cd_empresa,
		substr(nm_razao_social,1,100)
	into STRICT   	cd_empresa_w,
		ds_empresa_w
	from 	empresa
	where	cd_empresa = cd_empresa_p;

end if;

if (ie_opcao_p in ('CD_ESTAB','DS_ESTAB')) then

select	cd_estabelecimento,
	nm_fantasia_estab
into STRICT	cd_estab_w,
	ds_estab_w
from	estabelecimento
where	cd_estabelecimento = cd_estabelecimento_p;

end if;

if (nr_seq_segmento_p IS NOT NULL AND nr_seq_segmento_p::text <> '') and (ie_opcao_p in ('CD_GRUPAMENTO','DS_GRUPAMENTO','QT_POLITICA', 'QT_FREQUENCIA')) then

	select	max(a.nr_sequencia),
		max(a.ds_grupamento)
	into STRICT	cd_grupamento_w,
		ds_grupamento_w
	from	pcs_grupamentos a
	where	a.ie_situacao = 'A'
	and	exists (	SELECT	1
			from	pcs_segmento x
			where	x.nr_seq_grupamento = a.nr_sequencia
			and	x.ie_situacao = 'A'
			and	nr_sequencia = nr_seq_segmento_p);
end if;

if (ie_opcao_p in ('CD_SEGMENTO','DS_SEGMENTO')) then

	select	a.nr_sequencia,
		a.ds_segmento
	into STRICT	cd_segmento_w,
		ds_segmento_w
	from	pcs_segmento a
	where	a.nr_sequencia = nr_seq_segmento_p;
end if;

if (ie_opcao_p in ('CD_MATERIAL', 'DS_MATERIAL')) then
	select	cd_material,
		ds_material
	into STRICT	cd_material_w,
		ds_material_w
	from	material
	where	cd_material = cd_material_p;
end if;

if (ie_opcao_p = 'QT_MELHOR_COMPR') then
	select coalesce((obter_dados_material(cd_material_p,'MC'))::numeric ,0)
	into STRICT	qt_melhor_compra_w
	;
end if;

if (nr_seq_regional_p IS NOT NULL AND nr_seq_regional_p::text <> '') and (ie_opcao_p in ('CD_REGIONAL', 'DS_REGIONAL')) then
	select	nr_sequencia,
		ds_regional
	into STRICT	cd_regional_w,
		ds_regional_w
	from	pcs_regionais
	where	nr_sequencia = nr_seq_regional_p;
end if;

if (ie_opcao_p in ('NR_ORDEM_COMPRA', 'DT_PREV_ENTREGA', 'NR_DOCUMENTO', 'QT_LEAD_TIME', 'DS_FORNEC_OC', 'NM_PESSOA_FISIC')) then

	select	max(a.nr_ordem_compra),
		max(PKG_DATE_UTILS.start_of(b.dt_prevista_entrega,'dd',0)),
		coalesce(max(Obter_Dias_Entre_Datas(trunc(b.dt_prevista_entrega),trunc(clock_timestamp()))),0) --QT_LEAD_TIME_W
	into STRICT	nr_ordem_Compra_w,
		dt_prev_entrega_w,
		qt_lead_time_w
	from	ordem_compra a,
		ordem_compra_v b
	where	a.nr_ordem_compra = b.nr_ordem_compra
	and	coalesce(a.dt_baixa::text, '') = ''
	and	coalesce(a.nr_seq_motivo_cancel::text, '') = ''
	and	a.cd_estabelecimento = cd_estabelecimento_p
	and	b.cd_material = cd_material_p
	and	coalesce(b.dt_cancelamento::text, '') = ''
	and	coalesce(b.qt_real_entrega,0) < b.qt_prevista_entrega
	order by dt_prevista_entrega desc;

	if (nr_ordem_compra_w IS NOT NULL AND nr_ordem_compra_w::text <> '') then
		select	max(PKG_DATE_UTILS.start_of(a.dt_ordem_compra,'dd',0)),
			max(a.cd_cgc_fornecedor),
			max(a.cd_pessoa_fisica),
			CASE WHEN max(a.dt_aprovacao)='' THEN 'N'  ELSE 'S' END ,
			max(a.cd_comprador)
		into STRICT	dt_emissao_oc_w,
			cd_cgc_fornecedor_w,
			cd_pessoa_fisica_w,
			ie_oc_aprovada_w,
			cd_comprador_w
		from	ordem_Compra a
		where	nr_ordem_compra = nr_ordem_Compra_w;

		if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') then

			select	max(nm_guerra)
			into STRICT	nm_comprador_w
			from	comprador
			where	cd_pessoa_fisica = cd_comprador_w;

		end if;

		if (cd_cgc_fornecedor_w IS NOT NULL AND cd_cgc_fornecedor_w::text <> '') and (ie_opcao_p = 'DS_FORNEC_OC')	then
			select	nm_fantasia
			into STRICT	ds_fornec_oc_w
			from	pessoa_juridica
			where 	cd_cgc = cd_cgc_fornecedor_w;
		elsif (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (ie_opcao_p = 'NM_PESSOA_FISIC') then
			select	SUBSTR(OBTER_NOME_PF(CD_PESSOA_FISICA),0,255)
			into STRICT	nm_pessoa_fisica_w
			from	pessoa_fisica
			where	cd_pessoa_fisica = cd_pessoa_fisica_w;
		end if;
	end if;

end if;

select	max(nr_sequencia)
into STRICT	nr_seq_relatorio_w
from	pcs_segmento_compras_rel;

-- DS_FORNEC_OC NM_PESSOA_FISIC NM_COMPRADOR_W DT_EMISSAO_OC_W CD_CGC_FORNECEDOR_W DT_PREV_ENTREGA NR_ORDEM_COMPRA_W
if (ie_opcao_p = 'CDA') then
	/*CONSUMO DIA ANTERIOR*/

	/*select	nvl(sum(qt_consumo),0) qt_consumo_ant
	into	qt_cda_w
	from   	movimento_estoque_v a,
		material m
	where  	a.cd_material_estoque	= m.cd_material_estoque
	and  	m.cd_material         	= cd_material_p
	and  	a.cd_estabelecimento 	= cd_estabelecimento_p
	and  	trunc(dt_movimento_estoque,'dd') = trunc(sysdate-1,'dd')
	and 	((not exists(
			select   1
			from	operacao_nota x
			where	x.cd_operacao_estoque = a.cd_operacao_estoque
			and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
			and	(a.cd_centro_custo is not null));  */
	/*CONSUMO DIA ANTERIOR*/

	select	coalesce(sum(qt_consumo_dia_ant),0)
	into STRICT	qt_cda_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;


end if;

if (ie_opcao_p in ('CD07','CD15','CD30','CD60','CD90','CD120','CD150','CD180','QT_COBERTURA_AX','QT_COBERTURA_FM')) then

	if (ie_opcao_p in ('CD07','QT_COBERTURA_AX','QT_COBERTURA_FM')) then
		/*CONSUMO 7 DIAS*/

		/*select	dividir(nvl(sum(qt_consumo),0),7) qt_consumo_ant
		into	qt_cd07_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and  	m.cd_material         	= cd_material_p
		and  	a.cd_estabelecimento 	= cd_estabelecimento_p
		and  	trunc(dt_movimento_estoque,'dd') between trunc(sysdate-6,'dd') and trunc(sysdate,'dd')
		and 	((not exists(
				select   1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
				and	(a.cd_centro_custo is not null));*/
		select	coalesce(sum(qt_consumo_7_dias),0)
		into STRICT	qt_cd07_w
		from 	pcs_seg_compras_rel_item
		where	cd_material    = cd_material_p
		and	nr_seq_relatorio = nr_seq_relatorio_w
		and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;


	elsif (ie_opcao_p in ('CD15','QT_COBERTURA_AX','QT_COBERTURA_FM')) then

		/*CONSUMO 15 DIAS*/

		/*select	dividir(nvl(sum(qt_consumo),0),15) qt_consumo_ant
		into	qt_cd15_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and  	m.cd_material         	= cd_material_p
		and  	a.cd_estabelecimento 	= cd_estabelecimento_p
		and  	trunc(dt_movimento_estoque,'dd') between trunc(sysdate-14,'dd') and trunc(sysdate,'dd')
		and 	((not exists(
				select	1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
				and	(a.cd_centro_custo is not null));*/
		select	coalesce(sum(qt_consumo_15_dias),0)
		into STRICT	qt_cd15_w
		from 	pcs_seg_compras_rel_item
		where	cd_material    = cd_material_p
		and	nr_seq_relatorio = nr_seq_relatorio_w
		and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;




	elsif (ie_opcao_p in ('CD30','QT_COBERTURA_AX','QT_COBERTURA_FM')) then

		/*CONSUMO 30 DIAS*/

		/*select	dividir(nvl(sum(qt_consumo),0),30) qt_consumo_ant
		into	qt_cd30_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and  	m.cd_material         	= cd_material_p
		and  	a.cd_estabelecimento 	= cd_estabelecimento_p
		and  	trunc(dt_movimento_estoque,'dd') between trunc(sysdate-29,'dd') and trunc(sysdate,'dd')
		and 	((not exists(
				select  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
				and 	(a.cd_centro_custo is not null));*/
		select	coalesce(sum(qt_consumo_30_dias),0)
		into STRICT	qt_cd30_w
		from 	pcs_seg_compras_rel_item
		where	cd_material    = cd_material_p
		and	nr_seq_relatorio = nr_seq_relatorio_w
		and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;


	elsif (ie_opcao_p in ('CD60','QT_COBERTURA_AX','QT_COBERTURA_FM')) then

		/*CONSUMO 60 DIAS*/

		/*select	dividir(nvl(sum(qt_consumo),0),60) qt_consumo_ant
		into	qt_cd60_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and  	m.cd_material         	= cd_material_p
		and  	a.cd_estabelecimento 	= cd_estabelecimento_p
		and  	trunc(dt_movimento_estoque,'dd') between trunc(sysdate-59,'dd') and trunc(sysdate,'dd')
		and 	((not exists(
				select	1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
				and	(a.cd_centro_custo is not null));*/
		select	coalesce(sum(qt_consumo_60_dias),0)
		into STRICT	qt_cd60_w
		from 	pcs_seg_compras_rel_item
		where	cd_material    = cd_material_p
		and	nr_seq_relatorio = nr_seq_relatorio_w
		and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;


	elsif (ie_opcao_p in ('CD90','QT_COBERTURA_AX','QT_COBERTURA_FM')) then

		/*CONSUMO 90 DIAS*/

		/*select	dividir(nvl(sum(qt_consumo),0),90) qt_consumo_ant
		into	qt_cd90_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and  	m.cd_material         	= cd_material_p
		and  	a.cd_estabelecimento 	= cd_estabelecimento_p
		and  	trunc(dt_movimento_estoque,'dd') between trunc(sysdate-89,'dd') and trunc(sysdate,'dd')
		and 	((not exists (
				select	1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
				and	(a.cd_centro_custo is not null));*/
		select	coalesce(sum(qt_consumo_90_dias),0)
		into STRICT	qt_cd90_w
		from 	pcs_seg_compras_rel_item
		where	cd_material    = cd_material_p
		and	nr_seq_relatorio = nr_seq_relatorio_w
		and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;


	elsif (ie_opcao_p in ('CD120','QT_COBERTURA_AX','QT_COBERTURA_FM')) then

		/*CONSUMO 120 DIAS*/

		/*select	dividir(nvl(sum(qt_consumo),0),120) qt_consumo_ant
		into	qt_cd120_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and  	m.cd_material         	= cd_material_p
		and  	a.cd_estabelecimento 	= cd_estabelecimento_p
		and  	trunc(dt_movimento_estoque,'dd') between trunc(sysdate-119,'dd') and trunc(sysdate,'dd')
		and 	((not exists (
				select	1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
				and	(a.cd_centro_custo is not null));*/
		select	coalesce(sum(qt_consumo_120_dias),0)
		into STRICT	qt_cd120_w
		from 	pcs_seg_compras_rel_item
		where	cd_material    = cd_material_p
		and	nr_seq_relatorio = nr_seq_relatorio_w
		and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;


	elsif (ie_opcao_p in ('CD150','QT_COBERTURA_AX','QT_COBERTURA_FM')) then

		/*CONSUMO 150 DIAS*/

		/*select	dividir(nvl(sum(qt_consumo),0),150) qt_consumo_ant
		into	qt_cd150_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and  	m.cd_material         	= cd_material_p
		and  	a.cd_estabelecimento 	= cd_estabelecimento_p
		and  	trunc(dt_movimento_estoque,'dd') between trunc(sysdate-149,'dd') and trunc(sysdate,'dd')
		and 	((not exists (
				select	1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
				and	(a.cd_centro_custo is not null));*/
		select	coalesce(sum(qt_consumo_150_dias),0)
		into STRICT	qt_cd150_w
		from 	pcs_seg_compras_rel_item
		where	cd_material    = cd_material_p
		and	nr_seq_relatorio = nr_seq_relatorio_w
		and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

	elsif (ie_opcao_p in ('CD180','QT_COBERTURA_AX','QT_COBERTURA_FM')) then

		/*CONSUMO 180 DIAS*/

		/*select	dividir(nvl(sum(qt_consumo),0),180) qt_consumo_ant
		into	qt_cd180_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and  	m.cd_material         	= cd_material_p
		and  	a.cd_estabelecimento 	= cd_estabelecimento_p
		and  	trunc(dt_movimento_estoque,'dd') between trunc(sysdate-179,'dd') and trunc(sysdate,'dd')
		and 	((not exists (
				select	1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
				and	(a.cd_centro_custo is not null));*/
		select	coalesce(sum(qt_consumo_180_dias),0)
		into STRICT	qt_cd180_w
		from 	pcs_seg_compras_rel_item
		where	cd_material    = cd_material_p
		and	nr_seq_relatorio = nr_seq_relatorio_w
		and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

	end if;

end if;

------------ média de Consumo
if (ie_opcao_p = 'QT_MAIOR_CONS_3M_W') then
	/*MEDIA DO CONSUMO DO MES ANTERIOR*/

	/*select	dividir(nvl(sum(qt_consumo),0),obter_qt_dias_mes(add_months(trunc(sysdate,'mm'),-1)))
	into	qt_media_consumo_mes01_w
	from   	movimento_estoque_v a,
		material m
	where  	a.cd_material_estoque	= m.cd_material_estoque
	and  	m.cd_material         	= cd_material_p
	and  	a.cd_estabelecimento 	= cd_estabelecimento_p
	and  	a.dt_mesano_referencia = add_months(trunc(sysdate,'mm'),-1)
	and 	((not exists (
				select  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
				and 	(a.cd_centro_custo is not null));*/
	/*MEDIA DO CONSUMO DO 2º MES ANTERIOR*/

	/*select	dividir(nvl(sum(qt_consumo),0),obter_qt_dias_mes(add_months(trunc(sysdate,'mm'),-2)))
	into	qt_media_consumo_mes02_w
	from   	movimento_estoque_v a,
		material m
	where  	a.cd_material_estoque	= m.cd_material_estoque
	and  	m.cd_material         	= cd_material_p
	and  	a.cd_estabelecimento 	= cd_estabelecimento_p
	and  	a.dt_mesano_referencia = add_months(trunc(sysdate,'mm'),-2)
	and 	((not exists(
			select	1
			from	operacao_nota x
			where	x.cd_operacao_estoque = a.cd_operacao_estoque
			and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
			and 	(a.cd_centro_custo is not null));*/
	/*MEDIA DO CONSUMO DO 3º MES ANTERIOR*/

	/*select	dividir(nvl(sum(qt_consumo),0),obter_qt_dias_mes(add_months(trunc(sysdate,'mm'),-3)))
	into	qt_media_consumo_mes03_w
	from   	movimento_estoque_v a,
		material m
	where  	a.cd_material_estoque	= m.cd_material_estoque
	and  	m.cd_material         	= cd_material_p
	and  	a.cd_estabelecimento 	= cd_estabelecimento_p
	and  	a.dt_mesano_referencia = add_months(trunc(sysdate,'mm'),-3)
	and 	((not exists(
			select  1
			from	operacao_nota x
			where	x.cd_operacao_estoque = a.cd_operacao_estoque
			and	nvl(x.ie_transferencia_estab, 'N') = 'S'))
			and 	(a.cd_centro_custo is not null));*/
	--qt_maior_cons_3m_w	:= qt_media_consumo_mes01_w;
	/*if	(qt_media_consumo_mes02_w > qt_maior_cons_3m_w) then
		qt_maior_cons_3m_w := qt_media_consumo_mes02_w;
	end if;

	if	(qt_media_consumo_mes03_w > qt_maior_cons_3m_w) then
		qt_maior_cons_3m_w := qt_media_consumo_mes03_w;
	end if;*/
	select	sum(coalesce(qt_maior_media_cons_3_meses,0))
	into STRICT	qt_maior_cons_3m_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

end if;

------------ média de Consumo
if (ie_opcao_p in ('QT_SALDO_ALMOX','QT_COBERTURA_AX')) then
	/*select	nvl(sum(obter_saldo_disp_estoque(cd_estabelecimento_p, cd_material_p, cd_local_estoque, trunc(sysdate,'mm'))),0)
	into	qt_saldo_almox_w
	from	local_estoque
	where	ie_tipo_local = 4
	and	cd_estabelecimento = cd_estabelecimento_p;*/
	select	sum(coalesce(qt_saldo_almox,0))
	into STRICT	qt_saldo_almox_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

end if;

if (ie_opcao_p in ('QT_SALDO_FARM','QT_COBERTURA_FM')) then
	/*select	nvl(sum(obter_saldo_disp_estoque(cd_estabelecimento_p, cd_material_p, cd_local_estoque, trunc(sysdate,'mm'))),0)
	into	qt_saldo_farm_w
	from	local_estoque
	where	ie_tipo_local in (1,2)
	and	cd_estabelecimento = cd_estabelecimento_p;*/
	select	sum(coalesce(qt_saldo_farmacia,0))
	into STRICT	qt_saldo_farm_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

end if;

if ((ie_opcao_p = 'QT_COBERTURA_AX') or (ie_opcao_p = 'QT_COBERTURA_FM'))	then
	begin
	/*qt_consumo_base_calculo_w := qt_cd07_w;
	if	(qt_consumo_base_calculo_w = 0) then
		qt_consumo_base_calculo_w := qt_cd15_w;
	elsif	(qt_consumo_base_calculo_w = 0) then
		qt_consumo_base_calculo_w := qt_cd30_w;
	elsif	(qt_consumo_base_calculo_w = 0) then
		qt_consumo_base_calculo_w := qt_cd60_w;
	elsif	(qt_consumo_base_calculo_w = 0) then
		qt_consumo_base_calculo_w := qt_cd90_w;
	elsif	(qt_consumo_base_calculo_w = 0) then
		qt_consumo_base_calculo_w := qt_cd120_w;
	elsif	(qt_consumo_base_calculo_w = 0) then
		qt_consumo_base_calculo_w := qt_cd150_w;
	elsif	(qt_consumo_base_calculo_w = 0) then
		qt_consumo_base_calculo_w := qt_cd180_w;
	end if;

	qt_cobertura_almox_w	:= nvl(dividir(qt_saldo_almox_w,qt_consumo_base_calculo_w),0);

	qt_cobertura_farm_w	:= nvl(dividir(qt_saldo_farm_w,qt_consumo_base_calculo_w),0);*/
	select	coalesce(sum(qt_cobertura_almox),0)
	into STRICT	qt_cobertura_almox_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

	select	coalesce(sum(qt_cobertura_farmacia),0)
	into STRICT	qt_cobertura_farm_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;


	end;
end if;

if (ie_opcao_p = 'QT_COB_REGRA') then

	select 	max(qt_cobertura_regra)
	into STRICT	qt_cobertura_regra_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p
	and	nr_seq_relatorio = nr_seq_relatorio_w;


end if;

if (ie_opcao_p in ('VL_SALDO_TOTAL','QT_SALDO_TOTAL','VL_CUSTO_MEDIO')) then

	/*select	nvl(sum(obter_saldo_disp_estoque(a.cd_estabelecimento, cd_material, cd_local_estoque, dt_mesano_referencia)),0),
		nvl(max(vl_custo_medio),0)
	into	qt_saldo_total_w,
		vl_custo_medio_w
	from	saldo_estoque a
	where	a.dt_mesano_referencia = trunc(sysdate,'mm')
	and	a.cd_estabelecimento = cd_Estabelecimento_p
	and	a.cd_material = cd_material_p;*/
	select	coalesce(sum(qt_saldo_total),0),
		coalesce(sum(vl_custo_medio),0)
	into STRICT	qt_saldo_total_w,
		vl_custo_medio_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;


	if (ie_opcao_p = 'VL_SALDO_TOTAL') then
		vl_saldo_total_w := qt_saldo_total_w * vl_custo_medio_w;
	end if;

end if;

if (ie_opcao_p = 'QT_ORDENS_TOTAL') then

	select	coalesce(sum(qt_compra),0)
	into STRICT	qt_ordens_total_w
	from	compra_pendente_v2
	where	cd_material = cd_material_p
	and	cd_estabelecimento = cd_estabelecimento_p
	and	nr_documento > 0;

end if;

if (ie_opcao_p = 'QT_ESTOQUE_MINIMO') then

	/*select	count(*)	--QT_ESTOQUE_MINIMO
	into	qt_existe_w
	from	material_estab
	where	cd_material = cd_material_p
	and	cd_estabelecimento = cd_estabelecimento_p;

	if	(qt_existe_w > 0) then
		select	nvl(qt_dia_estoque_minimo,0)
		into	qt_estoque_minimo_w
		from	material_estab
		where	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;*/
	select	sum(coalesce(qt_estoque_minimo,0))
	into STRICT	qt_estoque_minimo_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

end if;


if (ie_opcao_p = 'QT_SALDO_EXT') then
	/*select	nvl(sum(obter_saldo_disp_estoque(cd_estabelecimento_w, cd_material_p, cd_local_estoque, trunc(sysdate,'mm'))),0)
	into	qt_saldo_externo_w
	from	local_estoque
	where	nvl(ie_externo,'N') = 'S'
	and	cd_estabelecimento = cd_estabelecimento_p;*/
	select	coalesce(sum(qt_saldo_externo),0)
	into STRICT	qt_saldo_externo_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

end if;

select	obter_item_contrato_mercado(cd_material_p, cd_Estabelecimento_p)
into STRICT	ie_modalidade_w
;


if (ie_opcao_p in ('VL_FATUR_MINIMO','DS_MODALIDADE')) then

	/*if	(ie_modalidade_w = 'C') then
		ds_modalidade_w	:= 'Contrato';

		if (ie_opcao_p in ('VL_FATUR_MINIMO','CD_CNPJ_CONTRATADO','DS_FORNEC_CONTR')) then
			select	to_number(obter_dados_contrato_item(cd_material_p, 'FM')),
					obter_dados_contrato_item(cd_material_p, 'PJ')
			into	vl_fatur_minimo_w,
				cd_cnpj_contratado_w
			from	dual;

			if (cd_cnpj_contratado_w is not null) then
				ds_fornec_contrat_w := 	substr(obter_dados_pf_pj(null,cd_cnpj_contratado_w,'N'),1,255);
			end if;

		end if;
	elsif	(ie_modalidade_w = 'M') then
		ds_modalidade_w	:= 'Mercado';
	end if;*/
	select	coalesce(vl_fatur_minimo,0),
		cd_cnpj_contratado,
		ds_modalidade_w
	into STRICT	vl_fatur_minimo_w,
		cd_cnpj_contratado_w,
		ds_modalidade_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;


	if (cd_cnpj_contratado_w IS NOT NULL AND cd_cnpj_contratado_w::text <> '') then
		ds_fornec_contrat_w := 	substr(obter_dados_pf_pj(null,cd_cnpj_contratado_w,'N'),1,255);
	end if;


end if;

if (ie_opcao_p = 'NM_COMPRADOR_REGRA') then

	/*select	obter_comprador_material(cd_material_p, 'N', cd_estabelecimento_p)  --NM_COMPRADOR_REGRA
	into	cd_comprador_regra_w
	from	dual;

	if (cd_comprador_regra_w is not null) then
		select	max(nm_guerra)
		into	nm_comprador_regra_w
		from	comprador
		where	cd_pessoa_fisica = cd_comprador_regra_w;
	end if;*/
	select	max(cd_comprador_regra)
	into STRICT	cd_comprador_regra_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

	if (cd_comprador_regra_w IS NOT NULL AND cd_comprador_regra_w::text <> '') then
		select	max(nm_guerra)
		into STRICT	nm_comprador_regra_w
		from	comprador
		where	cd_pessoa_fisica = cd_comprador_regra_w;
	end if;

end if;

if (ie_opcao_p = 'QT_PENDENTE_OC') then
	/*select	nvl(sum(qt_compra),0)
	into	qt_pendente_oc_w
	from	compra_pendente_v2
	where	cd_material = cd_material_p
	and	cd_estabelecimento = cd_estabelecimento_p
	and	nr_documento > 0;*/
	select	coalesce(sum(qt_pendente_oc),0)
	into STRICT	qt_pendente_oc_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;


end if;

if (ie_opcao_p = 'QT_PEDIDO') then

	select	coalesce(sum(qt_pendente_oc),0)
	into STRICT	qt_pedido_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

end if;

if (ie_opcao_p in ('NR_SOLIC_COMPRA', 'NR_DOCUMENTO', 'TP_DOCUMENTO', 'QT_PEND_DOC')) then

	select	max(a.nr_solic_compra),
		max(PKG_DATE_UTILS.start_of(c.dt_entrega_solicitada,'dd',0))
	into STRICT	nr_solic_compra_w,
		dt_prevista_solic_w
	from	solic_compra a,
		solic_compra_item b,
		solic_compra_item_entrega c
	where	a.nr_solic_compra = b.nr_solic_compra
	and	b.nr_solic_compra = c.nr_solic_compra
	and	b.nr_item_solic_compra = c.nr_item_solic_compra
	and	coalesce(a.nr_seq_motivo_cancel::text, '') = ''
	and	a.cd_estabelecimento = cd_estabelecimento_p
	and	b.cd_material = cd_material_p
	and	coalesce(b.dt_baixa::text, '') = ''
	order by dt_entrega_solicitada desc;


	if	((coalesce(dt_prev_entrega_w::text, '') = '') or (dt_prev_entrega_w > dt_prevista_solic_w)) then

		nr_documento_w	:= nr_solic_compra_w;

		if (nr_documento_w > 0) then
			tp_documento_w	:= 'SC';
			select	coalesce(sum(qt_material),0)
			into STRICT	qt_pendente_w
			from	solic_compra_item
			where	nr_solic_compra = nr_solic_compra_w
			and	cd_material	= cd_material_p;
		end if;
	else
		nr_documento_w	:= nr_ordem_compra_w;
		if (nr_documento_w > 0) then
			tp_documento_w	:= 'OC';
			select	coalesce(sum(qt_material),0)
			into STRICT	qt_material_w
			from	ordem_compra_item a
			where	nr_ordem_compra = nr_ordem_compra_w
			and	cd_Material = cd_material_p;
		end if;

	end if;

	qt_pend_doc_w := qt_pendente_w + qt_material_w;

end if;

if (ie_opcao_p in ('QT_POLITICA','QT_MARGEM_DIAS','QT_FREQUENCIA')) then

	select	count(*)
	into STRICT	qt_existe_politica_w
	from	pcs_politicas_grupamento
	where	cd_estab_regra = cd_estabelecimento_p
	and	nr_seq_grupamento = cd_grupamento_w
	and	nr_seq_regional = nr_seq_regional_p;

	if (qt_existe_politica_w > 0) then
		select	max(coalesce(qt_politica,0)),
				max(coalesce(qt_margem_dias,0)),
			max(coalesce(qt_frequencia,0))
		into STRICT	qt_politica_w,
			qt_margem_dias_w,
			qt_frequencia_w
		from	pcs_politicas_grupamento
		where	((cd_estab_regra = cd_estabelecimento_p and (cd_estab_regra IS NOT NULL AND cd_estab_regra::text <> '')) or (nr_seq_regional = nr_seq_regional_p and (nr_seq_regional IS NOT NULL AND nr_seq_regional::text <> '')))
		and	nr_seq_grupamento = cd_grupamento_w;
	else
		select	max(coalesce(a.qt_politica,0)),
				max(coalesce(a.qt_margem_dias,0)),
				max(coalesce(a.qt_frequencia,0))
		into STRICT	qt_politica_w,
				qt_margem_dias_w,
				qt_frequencia_w
		from	pcs_grupamentos a
		where	cd_empresa = cd_empresa_p
		and	nr_sequencia = cd_grupamento_w
		and	a.ie_situacao = 'A'
		and	exists (	SELECT	1
				from	pcs_segmento x
				where	x.nr_seq_grupamento = a.nr_sequencia
				and	x.ie_situacao = 'A'
				and	nr_sequencia = nr_seq_segmento_p);

	end if;

end if;


if (ie_opcao_p in ('QT_MIN_ESTOQUE','QT_MAX_ESTOQUE')) then

	begin

	select	coalesce(qt_minima,0),
		coalesce(qt_maxima,0)
	into STRICT	qt_min_estoque_w,
		qt_max_estoque_w
	from	pcs_estrutura_segmento
	where	nr_seq_segmento = nr_seq_segmento_p
	and	cd_material = cd_material_p
	and	cd_estabelecimento = cd_estabelecimento_w;

	exception
	when others then
		qt_min_estoque_w :=0;
		qt_max_estoque_w := 0;
	end;

end if;

select	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	nr_seq_familia
into STRICT	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	nr_seq_familia_w
from	estrutura_material_v
where	cd_material = cd_material_p;


select 	max(a.ie_periodo_referencia),
	max(a.qt_periodo_x),
	max(a.qt_periodo_u),
	max(a.nr_sequencia)
into STRICT	ie_periodo_referencia_w,
        qt_periodo_x_w,
        qt_periodo_u_w,
	nr_seq_regra_w
from	pcs_regra_estatistica a
where	clock_timestamp() between inicio_dia(a.dt_inicio_vigencia) and fim_dia(a.dt_fim_vigencia)
and	((a.cd_estabelecimento	= cd_estabelecimento_p) or (coalesce(a.cd_estabelecimento::text, '') = ''))
and	coalesce(a.cd_grupo_material,coalesce(cd_grupo_material_w,0))	= coalesce(cd_grupo_material_w, 0)
and	coalesce(a.cd_subgrupo_material,coalesce(cd_subgrupo_material_w,0)) = coalesce(cd_subgrupo_material_w, 0)
and	coalesce(a.cd_classe_material,coalesce(cd_classe_material_w,0))	= coalesce(cd_classe_material_w, 0)
and	coalesce(a.nr_seq_familia,coalesce(nr_seq_familia_w,0))	= coalesce(nr_seq_familia_w, 0)
and	coalesce(a.cd_material,coalesce(cd_material_p,0))	= coalesce(cd_material_p, 0);


if (ie_opcao_p in ('VL_INTERVALO_SUP_Z','VL_INTERVALO_INF_Z')) then

	select	count(*)
	into STRICT	qt_existe_w
	from	pcs_anal_reg_estatistica
	where	cd_tipo_analise = 'Z'
	and	nr_seq_regra = nr_seq_regra_w;

	if (qt_existe_w > 0) then
		select 	pr_confianca
		into STRICT	pr_confianca_w
		from	pcs_anal_reg_estatistica
		where	cd_tipo_analise = 'Z'
		and	nr_seq_regra = nr_seq_regra_w;

	end if;

	/*Calculo da media utilizando x*/

	if (ie_periodo_referencia_w = 'MES') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),(qt_periodo_x_w)) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));



	elsif (ie_periodo_referencia_w = 'ANO') then

		select	dividir(sum(coalesce(a.qt_consumo,0)),qt_periodo_x_w) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-pls_obter_meses_entre_datas(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0),clock_timestamp()),0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-pls_obter_meses_entre_datas(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0),clock_timestamp()),0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	elsif (ie_periodo_referencia_w = 'DIA') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),qt_periodo_x_w) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	PKG_DATE_UTILS.start_of(a.dt_movimento_estoque,'dd',0) between(PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)-qt_periodo_x_w) and PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	PKG_DATE_UTILS.start_of(a.dt_movimento_estoque,'dd',0) between(PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)-qt_periodo_x_w) and PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	end if;

	if (ie_opcao_p = 'VL_INTERVALO_INF_Z') then
		select	qt_media_consumo_x_w - (pr_confianca_w * dividir(qt_media_desvio_padrao_x_w,sqrt(qt_periodo_u_w)))
		into STRICT	vl_int_confianca_z_inf_w
		;
	elsif (ie_opcao_p = 'VL_INTERVALO_SUP_Z') then
		select	qt_media_consumo_x_w + (pr_confianca_w * dividir(qt_media_desvio_padrao_x_w,sqrt(qt_periodo_u_w)))
		into STRICT	vl_int_confianca_z_sup_w
		;
	end if;



end if;


if (ie_opcao_p = 'TESTE_Z') then

	select	count(*)
	into STRICT	qt_existe_w
	from	pcs_anal_reg_estatistica
	where	cd_tipo_analise = 'TZ'
	and	nr_seq_regra = nr_seq_regra_w;

	if (qt_existe_w > 0) then
		select 	pr_confianca
		into STRICT	pr_confianca_w
		from	pcs_anal_reg_estatistica
		where	cd_tipo_analise = 'TZ'
		and	nr_seq_regra = nr_seq_regra_w;

	end if;

	/*Calculo da media utilizando x*/

	if (ie_periodo_referencia_w = 'MES') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),(qt_periodo_x_w)) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	elsif (ie_periodo_referencia_w = 'ANO') then

		select	dividir(sum(coalesce(a.qt_consumo,0)),qt_periodo_x_w) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-pls_obter_meses_entre_datas(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0),clock_timestamp()),0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-pls_obter_meses_entre_datas(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0),clock_timestamp()),0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	elsif (ie_periodo_referencia_w = 'DIA') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),qt_periodo_x_w) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	PKG_DATE_UTILS.start_of(a.dt_movimento_estoque,'dd',0) between(PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)-qt_periodo_x_w) and PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	PKG_DATE_UTILS.start_of(a.dt_movimento_estoque,'dd',0) between(PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)-qt_periodo_x_w) and PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	end if;

	/*Calculo da media utilizando u*/

	if (ie_periodo_referencia_w = 'MES') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),(qt_periodo_u_w)) qt_consumo
		into STRICT	qt_media_consumo_u_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_u_w,0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));



	elsif (ie_periodo_referencia_w = 'ANO') then

		select	dividir(sum(coalesce(a.qt_consumo,0)),(qt_periodo_u_w)) qt_consumo
		into STRICT	qt_media_consumo_u_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-pls_obter_meses_entre_datas(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_u_w,0),clock_timestamp()),0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));



	elsif (ie_periodo_referencia_w = 'DIA') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),(qt_periodo_u_w)) qt_consumo
		into STRICT	qt_media_consumo_u_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	PKG_DATE_UTILS.start_of(a.dt_movimento_estoque,'dd',0) between(PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)-qt_periodo_u_w) and PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	end if;

	begin
	select	dividir((qt_media_consumo_x_w - qt_media_consumo_u_w),(dividir(qt_media_desvio_padrao_x_w,sqrt(qt_periodo_u_w))))
	into STRICT	vl_teste_z_w
	;
	exception
	when others then
		vl_teste_z_w := 0;
	end;


end if;


if (ie_opcao_p in ('VL_INTERVALO_SUP_T','VL_INTERVALO_INF_T')) then

	select	count(*)
	into STRICT	qt_existe_w
	from	pcs_anal_reg_estatistica
	where	cd_tipo_analise = 'T'
	and	nr_seq_regra = nr_seq_regra_w;

	if (qt_existe_w > 0) then
		select 	substr(pcs_obter_vl_confiabilidade_t(pr_confianca_t),1,5)
		into STRICT	pr_confianca_w
		from	pcs_anal_reg_estatistica
		where	cd_tipo_analise = 'T'
		and	nr_seq_regra = nr_seq_regra_w;

	end if;

	/*Calculo da media utilizando x*/

	if (ie_periodo_referencia_w = 'MES') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),(qt_periodo_x_w)) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));



	elsif (ie_periodo_referencia_w = 'ANO') then

		select	dividir(sum(coalesce(a.qt_consumo,0)),qt_periodo_x_w) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-pls_obter_meses_entre_datas(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0),clock_timestamp()),0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-pls_obter_meses_entre_datas(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0),clock_timestamp()),0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	elsif (ie_periodo_referencia_w = 'DIA') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),qt_periodo_x_w) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	PKG_DATE_UTILS.start_of(a.dt_movimento_estoque,'dd',0) between(PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)-qt_periodo_x_w) and PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	PKG_DATE_UTILS.start_of(a.dt_movimento_estoque,'dd',0) between(PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)-qt_periodo_x_w) and PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	end if;

	if (ie_opcao_p = 'VL_INTERVALO_INF_T') then
		select	qt_media_consumo_x_w - (pr_confianca_w * dividir(qt_media_desvio_padrao_x_w,sqrt(qt_periodo_u_w)))
		into STRICT	vl_int_confianca_t_inf_w
		;
	elsif (ie_opcao_p = 'VL_INTERVALO_SUP_T') then
		select	qt_media_consumo_x_w + (pr_confianca_w * dividir(qt_media_desvio_padrao_x_w,sqrt(qt_periodo_u_w)))
		into STRICT	vl_int_confianca_t_sup_w
		;
	end if;



end if;

if (ie_opcao_p = 'TESTE_T') then

	select	count(*)
	into STRICT	qt_existe_w
	from	pcs_anal_reg_estatistica
	where	cd_tipo_analise = 'TT'
	and	nr_seq_regra = nr_seq_regra_w;

	if (qt_existe_w > 0) then
		select 	substr(pcs_obter_vl_confiabilidade_t(pr_confianca),1,5)
		into STRICT	pr_confianca_w
		from	pcs_anal_reg_estatistica
		where	cd_tipo_analise = 'TT'
		and	nr_seq_regra = nr_seq_regra_w;

	end if;

	/*Calculo da media utilizando x*/

	if (ie_periodo_referencia_w = 'MES') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),(qt_periodo_x_w)) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	elsif (ie_periodo_referencia_w = 'ANO') then

		select	dividir(sum(coalesce(a.qt_consumo,0)),qt_periodo_x_w) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-pls_obter_meses_entre_datas(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0),clock_timestamp()),0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-pls_obter_meses_entre_datas(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_x_w,0),clock_timestamp()),0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	elsif (ie_periodo_referencia_w = 'DIA') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),qt_periodo_x_w) qt_consumo
		into STRICT	qt_media_consumo_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	PKG_DATE_UTILS.start_of(a.dt_movimento_estoque,'dd',0) between(PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)-qt_periodo_x_w) and PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

		select	stddev(coalesce(a.qt_consumo,0))
		into STRICT	qt_media_desvio_padrao_x_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	PKG_DATE_UTILS.start_of(a.dt_movimento_estoque,'dd',0) between(PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)-qt_periodo_x_w) and PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	end if;

	/*Calculo da media utilizando u*/

	if (ie_periodo_referencia_w = 'MES') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),(qt_periodo_u_w)) qt_consumo
		into STRICT	qt_media_consumo_u_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_u_w,0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));



	elsif (ie_periodo_referencia_w = 'ANO') then

		select	dividir(sum(coalesce(a.qt_consumo,0)),(qt_periodo_u_w)) qt_consumo
		into STRICT	qt_media_consumo_u_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	pkg_date_utils.start_of(a.dt_mesano_referencia,'MONTH',0) between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-pls_obter_meses_entre_datas(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(),'MONTH',0),-qt_periodo_u_w,0),clock_timestamp()),0) and pkg_date_utils.start_of(clock_timestamp(),'MONTH',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));



	elsif (ie_periodo_referencia_w = 'DIA') then
		select	dividir(sum(coalesce(a.qt_consumo,0)),(qt_periodo_u_w)) qt_consumo
		into STRICT	qt_media_consumo_u_w
		from   	movimento_estoque_v a,
			material m
		where  	a.cd_material_estoque	= m.cd_material_estoque
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_material		= cd_material_p
		and	PKG_DATE_UTILS.start_of(a.dt_movimento_estoque,'dd',0) between(PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)-qt_periodo_u_w) and PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)
		and 	((not exists (
				SELECT  1
				from	operacao_nota x
				where	x.cd_operacao_estoque = a.cd_operacao_estoque
				and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
				and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


	end if;

	begin
	select	dividir((qt_media_consumo_x_w - qt_media_consumo_u_w),(dividir(qt_media_desvio_padrao_x_w,sqrt(qt_periodo_u_w))))
	into STRICT	vl_teste_t_w
	;
	exception
	when others then
		vl_teste_t_w := 0;
	end;


end if;

/*if	(cd_local_estoque_p is not null) then
	select	sum(obter_saldo_disp_estoque(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, trunc(sysdate,'month')))
	into	qt_saldo_w
	from	dual;
end if; */
/*select	count(*)
into	qt_existe_local_w
from 	dual
where 	ie_opcao_p in select	(distinct 'QT_SALDO_' || cd_local_estoque ||'_' || substr(replace(obter_desc_local_estoque(cd_local_estoque),' ','_'),1,15) cd_dominio,
								'Saldo disponível do local de estoque ' || cd_local_estoque || ' - ' || substr(obter_desc_local_estoque(cd_local_estoque),1,20)  ds_observacao
								from	pcs_local_estoque_grup);*/
if (ie_opcao_p = 'CD_EMPRESA') then
	ds_retorno_w := cd_empresa_w;
elsif (ie_opcao_p = 'CD_ESTAB') then
	ds_retorno_w := cd_estab_w;
elsif (ie_opcao_p = 'CD_GRUPAMENTO') then
	ds_retorno_w := cd_grupamento_w;
elsif (ie_opcao_p = 'CD_MATERIAL') then
	ds_retorno_w := cd_material_w;
elsif (ie_opcao_p = 'CD_REGIONAL') then
	ds_retorno_w := cd_regional_w;
elsif (ie_opcao_p = 'CD_SEGMENTO') then
	ds_retorno_w := cd_segmento_w;
elsif (ie_opcao_p = 'DS_SEGMENTO') then
	ds_retorno_w := ds_segmento_w;
elsif (ie_opcao_p = 'CDA') then
	ds_retorno_w := qt_cda_w;
elsif (ie_opcao_p = 'CD07') then
	ds_retorno_w := qt_cd07_w;
elsif (ie_opcao_p = 'CD15') then
	ds_retorno_w := qt_cd15_w;
elsif (ie_opcao_p = 'CD30') then
	ds_retorno_w := qt_cd30_w;
elsif (ie_opcao_p = 'CD60') then
	ds_retorno_w := qt_cd60_w;
elsif (ie_opcao_p = 'CD90') then
	ds_retorno_w := qt_cd90_w;
elsif (ie_opcao_p = 'CD120') then
	ds_retorno_w := qt_cd120_w;
elsif (ie_opcao_p = 'CD150') then
	ds_retorno_w := qt_cd150_w;
elsif (ie_opcao_p = 'CD180') then
	ds_retorno_w := qt_cd180_w;
elsif (ie_opcao_p = 'DS_EMPRESA') then
	ds_retorno_w := ds_empresa_w;
elsif (ie_opcao_p = 'DS_ESTAB') then
	ds_retorno_w := ds_estab_w;
elsif (ie_opcao_p = 'DS_FORNEC_CONTR') then
	ds_retorno_w := ds_fornec_contrat_w;
elsif (ie_opcao_p = 'DS_FORNEC_OC') then
	ds_retorno_w := ds_fornec_oc_w;
elsif (ie_opcao_p = 'DS_GRUPAMENTO') then
	ds_retorno_w := ds_grupamento_w;
elsif (ie_opcao_p = 'DS_MATERIAL') then
	ds_retorno_w := ds_material_w;
elsif (ie_opcao_p = 'DS_MODALIDADE') then
	ds_retorno_w := ds_modalidade_w;
elsif (ie_opcao_p = 'DS_MOTIVO_FALTA') then
	begin
	select	max(ds_motivo)
	into STRICT	ds_motivo_falta_w
	from	material_falta
	where	cd_material		= cd_material_p
	and	cd_estabelecimento	= cd_Estabelecimento_p
	and	coalesce(ie_solucao,'N')	= 'N';

	ds_retorno_w := ds_motivo_falta_w;
	end;
elsif (ie_opcao_p = 'DS_REGIONAL') then
	ds_retorno_w := ds_regional_w;
elsif (ie_opcao_p = 'DT_EMISSAO_OC') then
	ds_retorno_w := dt_emissao_oc_w;
elsif (ie_opcao_p = 'DT_INICIO_FALTA') then
	begin
	select	max(dt_falta)
	into STRICT	dt_inicio_falta_w
	from	material_falta
	where	cd_material		= cd_material_p
	and	cd_estabelecimento	= cd_Estabelecimento_p
	and	coalesce(ie_solucao,'N')	= 'N';

	ds_retorno_w := dt_inicio_falta_w;

	end;
elsif (ie_opcao_p = 'DT_PREV_ENTREGA') then
	ds_retorno_w := dt_prev_entrega_w;
elsif (ie_opcao_p = 'IE_FALTA_SOLUCI') then
	begin

	/*select	max(ie_solucao)
	into	ie_falta_solucionada_w
	from	material_falta
	where	cd_material		= cd_material_p
	and	cd_estabelecimento	= cd_Estabelecimento_p
	and	nvl(ie_solucao,'N')	= 'N';*/
	select 	max(ie_falta_solucionada)
	into STRICT	ie_falta_solucionada_w
	from 	pcs_seg_compras_rel_item
	where	cd_material    = cd_material_p
	and	nr_seq_relatorio = nr_seq_relatorio_w;

	ds_retorno_w := ie_falta_solucionada_w;

	end;
elsif (ie_opcao_p = 'IE_OC_APROVADA') then
	ds_retorno_w := ie_oc_aprovada_w;
elsif (ie_opcao_p = 'NM_COMPRADOR') then
	ds_retorno_w := nm_comprador_w;
elsif (ie_opcao_p = 'NM_COMPRA_REGRA') then
	ds_retorno_w := nm_comprador_regra_w;
elsif (ie_opcao_p = 'NM_PESSOA_FISIC') then
	ds_retorno_w := nm_pessoa_fisica_w;
elsif (ie_opcao_p = 'NR_DOCUMENTO') then
	ds_retorno_w := nr_documento_w;
elsif (ie_opcao_p = 'NR_SOLIC_COMPRA') then
	ds_retorno_w := nr_solic_compra_w;
elsif (ie_opcao_p = 'NR_ORDEM_COMPRA') then
	ds_retorno_w := nr_ordem_compra_w;
elsif (ie_opcao_p = 'QT_COBERTURA_AX') then
	ds_retorno_w := qt_cobertura_almox_w;
elsif (ie_opcao_p = 'QT_COBERTURA_FM') then
	ds_retorno_w := qt_cobertura_farm_w;
elsif (ie_opcao_p = 'QT_COB_REGRA') then
	ds_retorno_w := qt_cobertura_regra_w;
elsif (ie_opcao_p = 'QT_ESTOQUE_MIN') then
	ds_retorno_w := qt_estoque_minimo_w;
elsif (ie_opcao_p = 'QT_FREQUENCIA') then
	ds_retorno_w := qt_frequencia_w;
elsif (ie_opcao_p = 'QT_LEAD_TIME') then
	ds_retorno_w := qt_lead_time_w;
elsif (ie_opcao_p = 'QT_MAIOR_CONS_3') then
	ds_retorno_w := qt_maior_cons_3m_w;
elsif (ie_opcao_p = 'QT_MARGEM_DIAS') then
	ds_retorno_w := qt_margem_dias_w;
elsif (ie_opcao_p = 'QT_MAX_ESTOQUE') then
	ds_retorno_w := qt_max_estoque_w;
elsif (ie_opcao_p = 'QT_MIN_ESTOQUE') then
	ds_retorno_w := qt_min_estoque_w;
elsif (ie_opcao_p = 'QT_ORDENS_TOTAL') then
	ds_retorno_w := qt_ordens_total_w;
elsif (ie_opcao_p = 'QT_PEDIDO') then
	ds_retorno_w := qt_pedido_w;
elsif (ie_opcao_p = 'QT_PEND_DOC') then
	ds_retorno_w := coalesce(qt_pend_doc_w,0);
elsif (ie_opcao_p = 'QT_PENDENTE_OC') then
	ds_retorno_w := qt_pendente_oc_w;
elsif (ie_opcao_p = 'QT_POLITICA') then
	ds_retorno_w := qt_politica_w;
elsif (ie_opcao_p = 'QT_SALDO_ALMOX') then
	ds_retorno_w := qt_saldo_almox_w;
elsif (ie_opcao_p = 'QT_SALDO_EXT') then
	ds_retorno_w := qt_saldo_externo_w;
elsif (ie_opcao_p = 'QT_SALDO_FARM') then
	ds_retorno_w := qt_saldo_farm_w;
elsif (ie_opcao_p = 'QT_SALDO_TOTAL') then
	ds_retorno_w := qt_saldo_total_w;
elsif (ie_opcao_p = 'TP_DOCUMENTO') then
	ds_retorno_w := tp_documento_w;
elsif (ie_opcao_p = 'VL_CUSTO_MEDIO') then
	ds_retorno_w := vl_custo_medio_w;
elsif (ie_opcao_p = 'VL_FATUR_MINIMO') then
	ds_retorno_w := vl_fatur_minimo_w;
elsif (ie_opcao_p = 'VL_SALDO_TOTAL') then
	ds_retorno_w := vl_saldo_total_w;
elsif (ie_opcao_p = 'VL_INTERVALO_INF_Z') then
	ds_retorno_w := vl_int_confianca_z_inf_w;
elsif (ie_opcao_p = 'VL_INTERVALO_SUP_Z') then
	ds_retorno_w := vl_int_confianca_z_sup_w;
elsif (ie_opcao_p = 'TESTE_Z') then
	ds_retorno_w := vl_teste_z_w;
elsif (ie_opcao_p = 'VL_INTERVALO_INF_T') then
	ds_retorno_w := vl_int_confianca_t_inf_w;
elsif (ie_opcao_p = 'VL_INTERVALO_SUP_T') then
	ds_retorno_w := vl_int_confianca_t_sup_w;
elsif (ie_opcao_p = 'TESTE_T') then
	ds_retorno_w := vl_teste_t_w;
--elsif (cd_local_estoque_p is not null) then
--	ds_retorno_w := qt_saldo_w;
elsif (ie_opcao_p = 'QT_MELHOR_COMPR') then
	ds_retorno_w := qt_melhor_compra_w;

end if;



return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_pcs (cd_empresa_p bigint, nr_seq_regional_p bigint, nr_seq_segmento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, cd_estabelecimento_p bigint, ie_opcao_p text) FROM PUBLIC;

