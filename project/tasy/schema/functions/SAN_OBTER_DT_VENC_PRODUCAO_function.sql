-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION san_obter_dt_venc_producao (nr_seq_producao_p bigint) RETURNS timestamp AS $body$
DECLARE


dt_retorno_w			timestamp;
dt_vencimento_w			timestamp;
dt_vencimento_lavado_w		timestamp;
dt_validade_conservante_w	timestamp;
dt_validade_apos_filtragem_w	timestamp;
ie_irradiado_w			varchar(1);
ie_lavado_w			varchar(1);
ie_filtrado_w			varchar(1);
ie_aliquotado_w			varchar(1);
ds_horario_param_w		varchar(10);


BEGIN
ds_horario_param_w := obter_param_usuario(450, 305, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ds_horario_param_w);

if (nr_seq_producao_p IS NOT NULL AND nr_seq_producao_p::text <> '') then

	select	ie_irradiado,
		ie_lavado,
		ie_filtrado,
		ie_aliquotado,
		dt_validade_conservante,
		dt_vencimento,
		dt_validade_apos_filtragem
	into STRICT	ie_irradiado_w,
		ie_lavado_w,
		ie_filtrado_w,
		ie_aliquotado_w,
		dt_validade_conservante_w,
		dt_vencimento_w,
		dt_validade_apos_filtragem_w
	from 	san_producao
	where	nr_sequencia = nr_seq_producao_p;

	if (ie_irradiado_w = 'S') then
		select	min(dt_validade)
		into STRICT	dt_retorno_w
		from	san_envio_derivado_val
		where	nr_seq_producao = nr_seq_producao_p;
	end if;

	if (ie_filtrado_w = 'S') and ((coalesce(dt_retorno_w::text, '') = '') or (dt_validade_apos_filtragem_w < dt_retorno_w)) then
		dt_retorno_w := dt_validade_apos_filtragem_w;
	end if;

	if (ie_aliquotado_w = 'S') and ((coalesce(dt_retorno_w::text, '') = '') or (dt_vencimento_w < dt_retorno_w)) then
		dt_retorno_w := dt_vencimento_w;
	end if;

	if (ie_lavado_w = 'S') then
		select	min(dt_vencimento)
		into STRICT	dt_vencimento_lavado_w
		from	san_producao_lavagem
		where	nr_seq_producao = nr_seq_producao_p;

		if (coalesce(dt_retorno_w::text, '') = '') or (dt_vencimento_lavado_w < dt_retorno_w) then
			dt_retorno_w := dt_vencimento_lavado_w;
		end if;
	end if;

	if (coalesce(dt_retorno_w::text, '') = '') and (dt_validade_conservante_w IS NOT NULL AND dt_validade_conservante_w::text <> '') then
		dt_retorno_w := dt_validade_conservante_w;
	end if;

	if (coalesce(dt_retorno_w::text, '') = '') then
		dt_retorno_w := dt_vencimento_w;
	end if;

	dt_retorno_w := to_date(to_char(dt_retorno_w,'dd/mm/yyyy')||' '||ds_horario_param_w,'dd/mm/yyyy hh24:mi;ss');
end if;

return	dt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION san_obter_dt_venc_producao (nr_seq_producao_p bigint) FROM PUBLIC;

