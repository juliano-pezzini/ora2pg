-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_regra_os_vinc_evento ( ie_evento_p text, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


/*	ie_evento_p
	1 - Alterar estágio
	2 - Alterar tipo solução
	3 - Alterar tipo OS cliente
	4 - Alterar causa dano
	5 - Alterar a complexidade
	6 - Liberar um histórico
	7 - Gerar os executores previstos
	8 - Encerrar OS via webservice	*/
ds_retorno_w			varchar(1) := 'N';
qt_existe_w			bigint;

C01 CURSOR FOR
	SELECT	ie_acao
	from	man_regra_acao_os_vinc
	where	ie_situacao	= 'A'
	and	ie_evento	= ie_evento_p
	order by nr_sequencia;


BEGIN

if (coalesce(ie_evento_p,'0') <> '0') and (coalesce(nr_sequencia_p,0) > 0) then
	begin
	select	count(*)
	into STRICT	qt_existe_w
	from	man_ordem_servico b,
		man_ordem_serv_vinc a
	where	b.nr_sequencia = a.nr_seq_os_vinculada
	and	b.ie_status_ordem <> '3'
	and	coalesce(b.dt_fim_real::text, '') = ''
	and (ie_evento_p <> 8 or (ie_evento_p = 8 and coalesce(b.nr_seq_wheb::text, '') = ''))
	and	a.nr_seq_ordem_servico = nr_sequencia_p;

	if (qt_existe_w > 0) then
		open C01;
		loop
		fetch C01 into
			ds_retorno_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		end loop;
		close C01;
	end if;
	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_regra_os_vinc_evento ( ie_evento_p text, nr_sequencia_p bigint) FROM PUBLIC;

