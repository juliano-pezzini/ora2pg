-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_proc_tabela ( nr_seq_regra_preco_p pls_regra_preco_proc.nr_sequencia%type, cd_procedimento_p pls_conta_proc.cd_procedimento%type, ie_origem_proced_p pls_conta_proc.ie_origem_proced%type, dt_referencia_p timestamp, cd_moeda_p moeda.cd_moeda%type) RETURNS varchar AS $body$
DECLARE



ie_retorno_w		varchar(1)	:= 'S';
nr_seq_cbhpm_edicao_w	pls_regra_preco_proc.nr_seq_cbhpm_edicao%type;
cd_edicao_amb_w         pls_regra_preco_proc.cd_edicao_amb%type;
dt_inicio_vigencia_w	pls_regra_preco_proc.dt_inicio_vigencia%type;
ie_origem_proced_w	pls_conta_proc.ie_origem_proced%type;
ie_calculo_tuss_w	edicao_amb.ie_calculo_tuss%type;
qt_procedimento_w	integer;
dt_inicio_vig_edicao_w	cbhpm_edicao.dt_vigencia%type;

BEGIN

select	nr_seq_cbhpm_edicao,
	cd_edicao_amb,
	dt_inicio_vigencia
into STRICT	nr_seq_cbhpm_edicao_w,
	cd_edicao_amb_w,
	dt_inicio_vigencia_w
from	pls_regra_preco_proc
where	nr_sequencia	= nr_seq_regra_preco_p;

begin
	select	coalesce(ie_origem_proced, ie_origem_proced_p),
		ie_calculo_tuss
	into STRICT	ie_origem_proced_w,
		ie_calculo_tuss_w
	from	edicao_amb
	where	cd_edicao_amb	= cd_edicao_amb_w;
exception
when others then
	ie_origem_proced_w	:= ie_origem_proced_p;
end;

if (ie_origem_proced_w = 1) or (ie_origem_proced_w = 4) or
	(ie_origem_proced_w = 8 AND ie_calculo_tuss_w = 'A') then
	if (ie_origem_proced_w = 8) then
		begin
			select	count(1)
			into STRICT	qt_procedimento_w
			from	preco_tuss	a
			where	a.cd_edicao_amb		= cd_edicao_amb_w
			and	a.cd_procedimento	= cd_procedimento_p
			and (coalesce(cd_moeda_p::text, '') = '' or coalesce(a.cd_moeda, cd_moeda_p) = cd_moeda_p)
			and	coalesce(a.dt_inicio_vigencia, clock_timestamp() - interval '3650 days')	=
						(	SELECT	max(coalesce(b.dt_inicio_vigencia, clock_timestamp() - interval '3650 days'))
							from	preco_tuss b
							where	b.cd_edicao_amb		= cd_edicao_amb_w
							and		b.cd_procedimento	= cd_procedimento_p
							and	coalesce(b.dt_inicio_vigencia, clock_timestamp() - interval '3650 days') <= dt_referencia_p
							and (coalesce(cd_moeda_p::text, '') = '' or coalesce(b.cd_moeda, cd_moeda_p) = cd_moeda_p)
						);
		exception
		when others then
			begin
			qt_procedimento_w	:= 0;
			end;
		end;
	else
		/* obter os valores da tabela AMB   */

		begin
			select	count(1)
			into STRICT	qt_procedimento_w
			from	preco_amb a
			where	a.cd_edicao_amb		= cd_edicao_amb_w
			and		a.cd_procedimento	= cd_procedimento_p
			and (coalesce(cd_moeda_p::text, '') = '' or coalesce(a.cd_moeda, cd_moeda_p) = cd_moeda_p)
			and		coalesce(a.dt_inicio_vigencia, clock_timestamp() - interval '3650 days')	=
					(	SELECT	max(coalesce(b.dt_inicio_vigencia, clock_timestamp() - interval '3650 days'))
						from	preco_amb b
						where	b.cd_edicao_amb		= cd_edicao_amb_w
						and		b.cd_procedimento	= cd_procedimento_p
						and	trunc(dt_referencia_p,'dd') between coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days') and coalesce(b.dt_final_vigencia, dt_referencia_p)
						and (coalesce(cd_moeda_p::text, '') = '' or coalesce(b.cd_moeda, cd_moeda_p) = cd_moeda_p)
					);
		exception
		when others then
			begin
			qt_procedimento_w := 0;
			end;
		end;
	end if;

elsif (ie_origem_proced_w = 5) or
	(ie_origem_proced_w = 8 AND ie_calculo_tuss_w = 'C') then
	if (ie_origem_proced_w = 8) then
		begin
			select  count(1)
			into STRICT	qt_procedimento_w
			from	preco_tuss	a
			where	a.cd_procedimento	= cd_procedimento_p
			and		a.ie_origem_proced	= ie_origem_proced_w
			and (coalesce(cd_moeda_p::text, '') = '' or coalesce(a.cd_moeda, cd_moeda_p) = cd_moeda_p)
			and		coalesce(a.dt_inicio_vigencia, clock_timestamp() - interval '3650 days')	=
						(	SELECT	max(coalesce(b.dt_inicio_vigencia, clock_timestamp() - interval '3650 days'))
							from	preco_tuss b
							where	b.cd_procedimento	= cd_procedimento_p
							and	b.ie_origem_proced	= ie_origem_proced_w
							and	coalesce(b.dt_inicio_vigencia, clock_timestamp() - interval '3650 days') <= dt_referencia_p
							and (coalesce(cd_moeda_p::text, '') = '' or coalesce(b.cd_moeda, cd_moeda_p) = cd_moeda_p)
						);
		exception
			when others then
			begin
			qt_procedimento_w	:= 0;
			end;
		end;
	else
		/* obter os valores da tabela CBHPM */

		select	max(dt_vigencia)
		into STRICT	dt_inicio_vig_edicao_w
		from	cbhpm_edicao
		where	nr_sequencia	= nr_seq_cbhpm_edicao_w;

		if ( coalesce(dt_inicio_vig_edicao_w::text, '') = '') then
			dt_inicio_vig_edicao_w	:= dt_inicio_vigencia_w;
		end if;

		select	count(1)
		into STRICT	qt_procedimento_w
		from	cbhpm_preco a
		where	a.cd_procedimento	= cd_procedimento_p
		and	a.ie_origem_proced	= ie_origem_proced_w
		and	a.dt_vigencia		=
			(SELECT max(coalesce(x.dt_vigencia,clock_timestamp() - interval '3650 days'))
				from 	cbhpm_preco x
				where x.cd_procedimento		= cd_procedimento_p
				and	x.ie_origem_proced	= ie_origem_proced_w
				and	x.dt_vigencia		<= dt_referencia_p
				and	x.dt_vigencia		<= coalesce(dt_inicio_vig_edicao_w, dt_referencia_p));
	end if;

end if;

if (qt_procedimento_w	= 0) then
	ie_retorno_w	:= 'N';
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_proc_tabela ( nr_seq_regra_preco_p pls_regra_preco_proc.nr_sequencia%type, cd_procedimento_p pls_conta_proc.cd_procedimento%type, ie_origem_proced_p pls_conta_proc.ie_origem_proced%type, dt_referencia_p timestamp, cd_moeda_p moeda.cd_moeda%type) FROM PUBLIC;

