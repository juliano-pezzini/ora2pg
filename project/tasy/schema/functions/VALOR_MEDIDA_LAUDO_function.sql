-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION valor_medida_laudo ( nr_seq_medida_p bigint, nr_seq_laudo_p bigint, ie_campo_p text) RETURNS varchar AS $body$
DECLARE

			
qt_medida_w             varchar(80);
ds_unidade_medida_w     varchar(80);
qt_aux_w                bigint := 0;
qt_idade_w              bigint;
qt_peso_w               bigint;
ie_sexo_w		varchar(1);
ds_valor_medida_w       laudo_paciente_medida.ds_valor_medida%TYPE;
cd_pessoa_fisica_w	varchar(10);
nr_prescricao_w		bigint;
ie_tipo_medida_w	varchar(15);

C01 CURSOR FOR
	SELECT  ds_medida_referencia
	from    medida_exame_refer
	where   nr_seq_medida = nr_seq_medida_p
	and     coalesce(qt_idade_w, 0) between coalesce(qt_idade_minima,0) and coalesce(qt_idade_maxima,9999)
	and     coalesce(qt_peso_w, 0)  between coalesce(qt_peso_minimo,0)  and coalesce(qt_peso_maximo,9999)
	and (coalesce(ie_tipo_medida,1) = coalesce(coalesce(ie_tipo_medida_w, ie_tipo_medida) ,1))	
	and (ie_sexo = ie_sexo_w or ie_sexo = 'A')
	order 	by coalesce(qt_idade_minima,0),
		   coalesce(qt_idade_maxima,9999),
		   ie_sexo;


BEGIN


if         ((ie_campo_p = 'V') or (ie_campo_p = 'N') or (ie_campo_p = 'D')) then
	begin
	
	select  max(e.ds_unidade_medida),
		max(to_char(m.qt_medida)),
		max(m.ds_valor_medida)
	into STRICT    ds_unidade_medida_w,
		qt_medida_w,
		ds_valor_medida_w
	from    medida_exame_laudo e,
		laudo_paciente_medida m
	where   m.nr_seq_medida = e.nr_sequencia
	and     m.nr_seq_laudo  = nr_seq_laudo_p
	and     m.nr_seq_medida = nr_seq_medida_p;
	
	if (ie_campo_p = 'V') then
		return        qt_medida_w;
	elsif (ie_campo_p = 'N') then
		return        ds_unidade_medida_w;
	else
		return        ds_valor_medida_w;
	end if;
	
	end;
elsif (ie_campo_p = 'R') then
	begin

	select  count(*)
	into STRICT    qt_aux_w
	from    medida_exame_refer
	where   nr_seq_medida = nr_seq_medida_p;

	if (qt_aux_w > 0) then
	
		select  obter_pessoa_atendimento(nr_atendimento,'C'),
			obter_idade_pf(obter_pessoa_atendimento(nr_atendimento,'C'), dt_laudo,'A'),
			nr_prescricao,
			ie_tipo_medida
		into STRICT	cd_pessoa_fisica_w,
			qt_idade_w,
			nr_prescricao_w,
			ie_tipo_medida_w
		from    laudo_paciente
		where   nr_sequencia            = nr_seq_laudo_p;


		select  obter_peso_prescr_sinal(nr_prescricao_w)
		into STRICT	qt_peso_w
		;


		select  coalesce(ie_sexo,'A')
		into STRICT    ie_sexo_w
		from    pessoa_fisica
		where   cd_pessoa_fisica = cd_pessoa_fisica_w;

		open c01;
		loop
		fetch c01 into
			ds_unidade_medida_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			ds_unidade_medida_w := ds_unidade_medida_w;
			end;
		end loop;
		close c01;
		
	else
	
		select  ds_medida_referencia
		into STRICT    ds_unidade_medida_w
		from    medida_exame_laudo
		where   nr_sequencia = nr_seq_medida_p;
		
	end if;
	
	return  ds_unidade_medida_w;
	
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION valor_medida_laudo ( nr_seq_medida_p bigint, nr_seq_laudo_p bigint, ie_campo_p text) FROM PUBLIC;

