-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_descricao_const_recusa (nr_sequencia_p text) RETURNS varchar AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	 nr_sequencia, nr_nota_fiscal, cd_serie_nf, dt_emissao
	from	 nota_fiscal
	where	 nr_sequencia_ref = nr_sequencia_p
	and	 ie_tipo_nota = 'EP'
	and	 ie_situacao  = '1'
	order by nr_sequencia asc;

vet01		c01%RowType;

ds_retorno_w	varchar(2000)	:= '';


BEGIN

open C01;
loop
fetch C01 into
	vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (coalesce(ds_retorno_w::text, '') = '') then
			      --Já existe(m) nota(s) de recusa já gerada(s) para esta nota :
		ds_retorno_w := wheb_mensagem_pck.get_texto(350400) || chr(13) || chr(10) ||
			      --Nr. Sequência: #@NR_SEQUENCIA#@ Nr. Nota Fiscal: #@NR_NOTA_FISCAL#@ Série: #@CD_SERIE_NF#@ Data de Emissão: #@DT_EMISSAO#@
				wheb_mensagem_pck.get_texto(350401,'NR_SEQUENCIA=' || vet01.nr_sequencia || ';NR_NOTA_FISCAL=' || vet01.nr_nota_fiscal || ';CD_SERIE_NF=' ||
								vet01.cd_serie_nf || ';DT_EMISSAO=' || to_char(vet01.dt_emissao,'dd/mm/yyyy')) || chr(13) || chr(10);

	else
		ds_retorno_w := substr(ds_retorno_w || wheb_mensagem_pck.get_texto(350401,'NR_SEQUENCIA=' || vet01.nr_sequencia || ';NR_NOTA_FISCAL=' || vet01.nr_nota_fiscal || ';CD_SERIE_NF=' ||
								vet01.cd_serie_nf || ';DT_EMISSAO=' || to_char(vet01.dt_emissao,'dd/mm/yyyy')) || chr(13) || chr(10),1,2000);
	end if;


	end;
end loop;
close C01;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_descricao_const_recusa (nr_sequencia_p text) FROM PUBLIC;

