-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_bloq_mesmo_dia_turno (CD_AGENDA_P bigint, DT_AGENDA_P timestamp) RETURNS varchar AS $body$
DECLARE

/*	 
	IE_BLOQ_MESMO_DIA_TURNO_W 
	'N' = NÃƒO BLOQUEIA 
	'T' = BLOQUEIA TURNO 
	'D' = BLOQUEIA DIA 
 */
 
IE_BLOQ_MESMO_DIA_TURNO_W	AGENDA.IE_BLOQ_MESMO_DIA_TURNO%TYPE;
HR_QUEBRA_TURNO_W		AGENDA.HR_QUEBRA_TURNO%TYPE;
HR_QUEBRA_TURNO_NOT_W		AGENDA.HR_QUEBRA_TURNO_NOT%TYPE;
QT_MIN_QUEBRA_TURNO_W		AGENDA.QT_MIN_QUEBRA_TURNO%TYPE;
DS_RETORNO_W			varchar(1) := 'N';
/*	 
	TURNOS 
 */
CD_TURNO_MAT_W			varchar(1) := '0';
CD_TURNO_VES_W			varchar(1) := '1';
CD_TURNO_NOT_W			varchar(1) := '3';

CD_TURNO_ATUAL_W		varchar(1) := CD_TURNO_MAT_W;
CD_TURNO_PARAM_W		varchar(1) := CD_TURNO_MAT_W;


BEGIN 
 
SELECT	coalesce(IE_BLOQ_MESMO_DIA_TURNO,'N'), 
	coalesce(HR_QUEBRA_TURNO,12), 
	HR_QUEBRA_TURNO_NOT, 
	coalesce(QT_MIN_QUEBRA_TURNO,0) 
INTO STRICT	IE_BLOQ_MESMO_DIA_TURNO_W, 
	HR_QUEBRA_TURNO_W, 
	HR_QUEBRA_TURNO_NOT_W, 
	QT_MIN_QUEBRA_TURNO_W 
FROM	AGENDA 
WHERE	CD_AGENDA = CD_AGENDA_P;
 
IF (IE_BLOQ_MESMO_DIA_TURNO_W != 'N') THEN 
	IF (IE_BLOQ_MESMO_DIA_TURNO_W = 'T') THEN 
		IF (PKG_DATE_UTILS.GET_DIFFDATE(clock_timestamp(), PKG_DATE_UTILS.GET_TIME(HR_QUEBRA_TURNO_W), 'HOUR%') > 0) OR 
			((PKG_DATE_UTILS.GET_DIFFDATE(clock_timestamp(), PKG_DATE_UTILS.GET_TIME(HR_QUEBRA_TURNO_W), 'HOUR%') = 0) AND (PKG_DATE_UTILS.GET_DIFFDATE(clock_timestamp(), PKG_DATE_UTILS.GET_TIME(HR_QUEBRA_TURNO_W) + QT_MIN_QUEBRA_TURNO_W / 1440, 'HOUR%') > 0 )) THEN 
			CD_TURNO_ATUAL_W := CD_TURNO_VES_W;
		ELSIF (HR_QUEBRA_TURNO_NOT_W IS NOT NULL AND HR_QUEBRA_TURNO_NOT_W::text <> '') AND (PKG_DATE_UTILS.GET_DIFFDATE(clock_timestamp(), PKG_DATE_UTILS.GET_TIME(HR_QUEBRA_TURNO_NOT_W), 'HOUR%') >= 0) THEN 
			CD_TURNO_ATUAL_W := CD_TURNO_NOT_W;
		END IF;
		 
		IF (PKG_DATE_UTILS.GET_DIFFDATE(DT_AGENDA_P, PKG_DATE_UTILS.GET_TIME(HR_QUEBRA_TURNO_W), 'HOUR%') > 0) OR 
			((PKG_DATE_UTILS.GET_DIFFDATE(DT_AGENDA_P, PKG_DATE_UTILS.GET_TIME(HR_QUEBRA_TURNO_W), 'HOUR%') = 0) AND (PKG_DATE_UTILS.GET_DIFFDATE(DT_AGENDA_P, PKG_DATE_UTILS.GET_TIME(HR_QUEBRA_TURNO_W) + QT_MIN_QUEBRA_TURNO_W / 1440, 'HOUR%') > 0 )) THEN 
			CD_TURNO_PARAM_W := CD_TURNO_VES_W;
		ELSIF (HR_QUEBRA_TURNO_NOT_W IS NOT NULL AND HR_QUEBRA_TURNO_NOT_W::text <> '') AND (PKG_DATE_UTILS.GET_DIFFDATE(DT_AGENDA_P, PKG_DATE_UTILS.GET_TIME(HR_QUEBRA_TURNO_NOT_W), 'HOUR%') >= 0) THEN 
			CD_TURNO_PARAM_W := CD_TURNO_NOT_W;
		END IF;
		 
		IF (CD_TURNO_ATUAL_W = CD_TURNO_PARAM_W) AND (PKG_DATE_UTILS.START_OF(clock_timestamp(),'DD') = PKG_DATE_UTILS.START_OF(DT_AGENDA_P,'DD')) THEN 
			DS_RETORNO_W := 'S';
		END IF;
	ELSE 
		IF (PKG_DATE_UTILS.START_OF(clock_timestamp(),'DD') = PKG_DATE_UTILS.START_OF(DT_AGENDA_P,'DD')) THEN 
			DS_RETORNO_W := 'S';
		END IF;
	END IF;
END IF;
 
RETURN DS_RETORNO_W;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_bloq_mesmo_dia_turno (CD_AGENDA_P bigint, DT_AGENDA_P timestamp) FROM PUBLIC;

