-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_status_valor_disc ( nr_seq_discussao_p pls_contestacao_discussao.nr_sequencia%type, nr_seq_disc_proc_p pls_discussao_proc.nr_sequencia%type, nr_seq_disc_mat_p pls_discussao_mat.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) RETURNS varchar AS $body$
DECLARE

 
qt_registro_w			integer := 0;
ds_retorno_w			varchar(255) := null;
vl_auxiliar_w			double precision := 0;
vl_aux_proc_w			double precision := 0;
vl_aux_mat_w			double precision := 0;
vl_ndc_w			double precision := 0;
vl_ndc_proc_w			double precision := 0;
vl_ndc_mat_w			double precision := 0;
vl_reconhecido_w		double precision := 0;
vl_reconhec_proc_w		double precision := 0;
vl_reconhec_mat_w		double precision := 0;
ie_tipo_arquivo_w		pls_lote_discussao.ie_tipo_arquivo%type;
nr_seq_disc_w			pls_contestacao_discussao.nr_sequencia%type;
nr_seq_motivo_glosa_neg_w	pls_discussao_proc.nr_seq_motivo_glosa_neg%type;
nr_seq_lote_contest_w		pls_lote_contestacao.nr_sequencia%type;
ie_pagamento_w			varchar(2);
nr_seq_contestacao_proc_w	pls_discussao_proc.nr_seq_contestacao_proc%type;
nr_seq_contestacao_mat_w	pls_discussao_mat.nr_seq_contestacao_mat%type;


BEGIN 
-- Painel "Discussão" 
if (nr_seq_discussao_p IS NOT NULL AND nr_seq_discussao_p::text <> '') then 
	select	coalesce(max(ie_tipo_arquivo),0), 
		max(nr_seq_lote_contest) 
	into STRICT	ie_tipo_arquivo_w, 
		nr_seq_lote_contest_w 
	from	pls_lote_discussao 
	where	nr_sequencia = (	SELECT	max(nr_seq_lote) 
					from	pls_contestacao_discussao 
					where	nr_sequencia = nr_seq_discussao_p);
	 
	-- Tipo de pagamento 
	ie_pagamento_w := pls_obter_dados_lote_contest( nr_seq_lote_contest_w, 'PC');
		 
	-- Somente lote de fechamento 
	if (ie_tipo_arquivo_w not in (1,2,3,4)) then 
		select	sum(coalesce(vl_prestador,0)) + sum(coalesce(vl_assumido,0)) 
		into STRICT	vl_aux_proc_w 
		from	pls_discussao_proc 
		where	nr_seq_contestacao_proc in (SELECT	nr_seq_contestacao_proc 
							from	pls_discussao_proc 
							where	nr_seq_discussao	= nr_seq_discussao_p 
							and	coalesce(nr_seq_motivo_glosa_neg::text, '') = '');
		 
		if (coalesce(vl_aux_proc_w,0) = 0) then 
			select	sum(coalesce(vl_prestador,0)) + sum(coalesce(vl_assumido,0)) 
			into STRICT	vl_aux_mat_w 
			from	pls_discussao_mat 
			where	nr_seq_contestacao_mat in (SELECT	nr_seq_contestacao_mat 
								from	pls_discussao_mat 
								where	nr_seq_discussao	= nr_seq_discussao_p 
								and	coalesce(nr_seq_motivo_glosa_neg::text, '') = '');
		end if;
		 
		if (coalesce(vl_aux_proc_w,0) + coalesce(vl_aux_mat_w,0) > 0) then 
			qt_registro_w := 1;
		end if;		
		 
		if (ie_tipo_arquivo_w = 1) then 
			ds_retorno_w := 'Não necessita ação';
			 
		elsif (qt_registro_w > 0) then 
			ds_retorno_w := 'Ação pendente';
		else 
			ds_retorno_w := 'Ação finalizada';
		end if;
		 
		-- Verificar pagamento Integral 
		if (ie_pagamento_w = 'I') then 
			qt_registro_w := 0;
				 
			select	sum(coalesce(vl_ndc,0)) 
			into STRICT	vl_ndc_proc_w 
			from	pls_discussao_proc 
			where	nr_seq_contestacao_proc in (SELECT	nr_seq_contestacao_proc 
								from	pls_discussao_proc 
								where	nr_seq_discussao	= nr_seq_discussao_p 
								and	coalesce(nr_seq_motivo_glosa_neg::text, '') = '');
			 
			if (coalesce(vl_ndc_proc_w,0) = 0) then 
				select	sum(coalesce(vl_ndc,0)) 
				into STRICT	vl_ndc_mat_w 
				from	pls_discussao_mat 
				where	nr_seq_contestacao_mat in (SELECT	nr_seq_contestacao_mat 
									from	pls_discussao_mat 
									where	nr_seq_discussao	= nr_seq_discussao_p 
									and	coalesce(nr_seq_motivo_glosa_neg::text, '') = '');
			end if;
			 
			if (coalesce(vl_ndc_proc_w,0) + coalesce(vl_ndc_mat_w,0) > 0) then 
				qt_registro_w := 1;
			end if;
				 
			if (qt_registro_w = 0) then 
				ds_retorno_w := 'Não necessita ação';
			else 
				ds_retorno_w := 'Ação pendente';
			end if;
		 
		-- Verificar pagamento Parcial 
		elsif (ie_pagamento_w = 'P') then 
			qt_registro_w := 0;
				 
			select	sum(coalesce(vl_aceito,0)) 
			into STRICT	vl_reconhec_proc_w 
			from	pls_discussao_proc 
			where	nr_seq_contestacao_proc in (SELECT	nr_seq_contestacao_proc 
								from	pls_discussao_proc 
								where	nr_seq_discussao	= nr_seq_discussao_p 
								and	coalesce(nr_seq_motivo_glosa_neg::text, '') = '');
			 
			if (coalesce(vl_reconhec_proc_w,0) = 0) then 
				select	sum(coalesce(vl_aceito,0)) 
				into STRICT	vl_reconhec_mat_w 
				from	pls_discussao_mat 
				where	nr_seq_contestacao_mat in (SELECT	nr_seq_contestacao_mat 
									from	pls_discussao_mat 
									where	nr_seq_discussao	= nr_seq_discussao_p 
									and	coalesce(nr_seq_motivo_glosa_neg::text, '') = '');
			end if;
			 
			if (coalesce(vl_reconhec_proc_w,0) + coalesce(vl_reconhec_mat_w,0) > 0) then 
				qt_registro_w := 1;
			end if;
				 
			if (qt_registro_w = 0) then 
				ds_retorno_w := 'Não necessita ação';
			else 
				ds_retorno_w := 'Ação pendente';
			end if;
		end if;
	 
	-- Arquivo de inclusão de questionamento ou de fechameno parcial "Não necessita" 
	elsif (ie_tipo_arquivo_w in (1,2,3,4)) then 
		ds_retorno_w := 'Não necessita ação';
	end if;
 
-- Painel "Discussão Procedimento" 
elsif (nr_seq_disc_proc_p IS NOT NULL AND nr_seq_disc_proc_p::text <> '') then 
	select	max(i.nr_seq_contestacao_proc), 
		max(i.nr_seq_discussao) 
	into STRICT	nr_seq_contestacao_proc_w, 
		nr_seq_disc_w 
	from	pls_discussao_proc	i 
	where	i.nr_sequencia	= nr_seq_disc_proc_p;
 
	select	sum(coalesce(i.vl_prestador,0)) + sum(coalesce(i.vl_assumido,0)), 
		max(i.nr_seq_motivo_glosa_neg), 
		sum(coalesce(i.vl_aceito,0)), 
		sum(coalesce(i.vl_ndc,0)) 
	into STRICT	vl_auxiliar_w, 
		nr_seq_motivo_glosa_neg_w, 
		vl_reconhecido_w, 
		vl_ndc_w 
	from	pls_discussao_proc		i, 
		pls_contestacao_discussao	c, 
		pls_lote_discussao		l 
	where	l.nr_sequencia			= c.nr_seq_lote 
	and	c.nr_sequencia			= i.nr_seq_discussao 
	and	l.ie_status			!= 'C' 
	and	i.nr_seq_contestacao_proc	= nr_seq_contestacao_proc_w;
	 
-- Painel "Discussão Material" 
elsif (nr_seq_disc_mat_p IS NOT NULL AND nr_seq_disc_mat_p::text <> '') then 
	select	max(i.nr_seq_contestacao_mat), 
		max(i.nr_seq_discussao) 
	into STRICT	nr_seq_contestacao_mat_w, 
		nr_seq_disc_w 
	from	pls_discussao_mat	i 
	where	i.nr_sequencia	= nr_seq_disc_mat_p;
 
	select	sum(coalesce(i.vl_prestador,0)) + sum(coalesce(i.vl_assumido,0)), 
		max(i.nr_seq_motivo_glosa_neg), 
		sum(coalesce(i.vl_aceito,0)), 
		sum(coalesce(i.vl_ndc,0)) 
	into STRICT	vl_auxiliar_w, 
		nr_seq_motivo_glosa_neg_w, 
		vl_reconhecido_w, 
		vl_ndc_w 
	from	pls_discussao_mat		i, 
		pls_contestacao_discussao	c, 
		pls_lote_discussao		l 
	where	l.nr_sequencia			= c.nr_seq_lote 
	and	c.nr_sequencia			= i.nr_seq_discussao 
	and	l.ie_status			!= 'C' 
	and	i.nr_seq_contestacao_mat	= nr_seq_contestacao_mat_w;
	 
end if;
 
-- Painel "Discussão Procedimento" / "Discussão Material" 
if (nr_seq_disc_w IS NOT NULL AND nr_seq_disc_w::text <> '') then 
	select	coalesce(max(ie_tipo_arquivo),0), 
		max(nr_seq_lote_contest) 
	into STRICT	ie_tipo_arquivo_w, 
		nr_seq_lote_contest_w 
	from	pls_lote_discussao 
	where	nr_sequencia = (	SELECT	max(nr_seq_lote) 
					from	pls_contestacao_discussao 
					where	nr_sequencia = nr_seq_disc_w );
					 
	ie_pagamento_w := pls_obter_dados_lote_contest( nr_seq_lote_contest_w, 'PC');
	 
	if (coalesce(nr_seq_motivo_glosa_neg_w::text, '') = '') and (vl_auxiliar_w = 0) and (ie_tipo_arquivo_w != 1) then 
		ds_retorno_w	:= 'Necessita ação';
		 
	elsif (nr_seq_motivo_glosa_neg_w IS NOT NULL AND nr_seq_motivo_glosa_neg_w::text <> '') or (vl_auxiliar_w > 0) or (ie_tipo_arquivo_w = 1) then 
		ds_retorno_w	:= 'Não necessita ação';
		 
		if (nr_seq_motivo_glosa_neg_w IS NOT NULL AND nr_seq_motivo_glosa_neg_w::text <> '') or (vl_auxiliar_w > 0) then 
			ds_retorno_w := 'Ação realizada';
		end if;
	end if;
	 
	-- Pagamento Integral 
	if (ie_pagamento_w = 'I') then 
		if (vl_ndc_w = 0) then 
			ds_retorno_w := 'Não necessita ação';
		 
		elsif (coalesce(nr_seq_motivo_glosa_neg_w::text, '') = '') then 
			ds_retorno_w := 'Ação pendente';
		end if;
		 
	-- Pagamento Parcial 
	elsif (ie_pagamento_w = 'P') then 
		if (vl_reconhecido_w = 0) then 
			ds_retorno_w := 'Não necessita ação';
		 
		elsif (coalesce(nr_seq_motivo_glosa_neg_w::text, '') = '') then 
			ds_retorno_w := 'Ação pendente';
		end if;
	end if;
	 
	-- Arquivo de inclusão de questionamento ou de fechameno parcial "Não necessita" 
	if (ie_tipo_arquivo_w in (1,2,3,4)) then 
		ds_retorno_w := 'Não necessita ação';
	end if;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_status_valor_disc ( nr_seq_discussao_p pls_contestacao_discussao.nr_sequencia%type, nr_seq_disc_proc_p pls_discussao_proc.nr_sequencia%type, nr_seq_disc_mat_p pls_discussao_mat.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

