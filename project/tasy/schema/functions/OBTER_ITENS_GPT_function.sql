-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_itens_gpt (nr_atendimento_p bigint, ie_liberacao_p text, ds_item_p text) RETURNS varchar AS $body$
DECLARE


qt_item_w 			bigint;
ie_retorno_w 		varchar(1) := 'N';
ie_tipo_usuario_w	varchar(1);


BEGIN

ie_tipo_usuario_w := coalesce(obter_valor_param_usuario(252, 1, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento), 'N');	
	
--- Procedimento
if (ds_item_p like 'EP') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_procedimento a,
			prescr_procedimento b,
			prescr_medica c
	where	a.nr_sequencia = b.nr_seq_proc_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;
	
--- Medicamento
if (ds_item_p like 'M') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_material a,
			prescr_material b,
			prescr_medica c
	where	a.nr_sequencia = b.nr_seq_mat_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		b.ie_agrupador = 1
	and		coalesce(a.ie_controle_tempo,'N') = 'N'
	and		coalesce(a.ie_material,'N') = 'N'
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	--- Include Procedure Associated Items
	
	if (qt_item_w < 1) then
	
		select	count(*)
		into STRICT	qt_item_w
		from	cpoe_procedimento a,
				prescr_procedimento d,
				prescr_material b,
				prescr_medica c
		where	a.nr_atendimento = c.nr_atendimento
		and		b.nr_prescricao = c.nr_prescricao
		and		b.nr_prescricao = d.nr_prescricao
		and		b.nr_sequencia_proc = d.nr_sequencia
		and		d.nr_seq_proc_cpoe = a.nr_sequencia
		and		c.nr_prescricao = d.nr_prescricao
		and		b.ie_agrupador = 5
		and		obter_se_classif_material(b.cd_material,'D') = 'S'
		and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
		and		(
			-- Todos
			(ie_liberacao_p = '2') or
			-- Pendente
			(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
			-- Liberados
			(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
		)
		and		a.nr_atendimento = nr_atendimento_p;
	
	end if;
	
	goto final;
	
end if;
	
--- Dieta Enteral
if (ds_item_p like 'E') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_dieta a,
			prescr_material b,
			prescr_medica c
	where	a.nr_sequencia = b.nr_seq_dieta_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		b.ie_agrupador = 8
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;
	
--- Suplemento Oral
if (ds_item_p like 'S') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_dieta  a,
			prescr_material b,
			prescr_medica  c
	where	a.nr_sequencia = b.nr_seq_dieta_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		b.ie_agrupador = 12
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;
	
--- Solucao
if (ds_item_p like 'SOL') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	prescr_solucao
	where	nr_prescricao	in (
		SELECT	distinct c.nr_prescricao
		from	cpoe_material a,
				prescr_material b,
				prescr_medica c
		where	a.nr_sequencia = b.nr_seq_mat_cpoe
		and		a.nr_atendimento = c.nr_atendimento
		and		b.nr_prescricao = c.nr_prescricao
		and		b.ie_agrupador = 4
		and		coalesce(a.ie_controle_tempo,'N') = 'S'
		and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
		and		(
			-- Todos
			(ie_liberacao_p = '2') or
			-- Pendente
			(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
			-- Liberados
			(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
		)
		and		a.nr_atendimento = nr_atendimento_p);
	
	goto final;
	
end if;
	
--- Hemodialise
if (ds_item_p like 'DI') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_dialise a,
			hd_prescricao b,
			prescr_medica c
	where	a.nr_sequencia = b.nr_seq_dialise_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		a.ie_tipo_dialise = 'DI'
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;
	
--- Dialise Peritoneal
if (ds_item_p like 'DP') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_dialise a,
			hd_prescricao b,
			prescr_medica c
	where	a.nr_sequencia = b.nr_seq_dialise_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		a.ie_tipo_dialise = 'DP'
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;
	
--- Dieta Oral
if (ds_item_p like 'O') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_dieta a,
			prescr_dieta b,
			prescr_medica c
	where	a.nr_sequencia = b.nr_seq_dieta_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;
	
--- Jejum
if (ds_item_p like 'J') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_dieta a,
			rep_jejum b,
			prescr_medica c
	where	a.nr_sequencia = b.nr_seq_dieta_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;
	
--- Recomendacao
if (ds_item_p like 'R') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_recomendacao a,
			prescr_recomendacao b,
			prescr_medica c
	where	a.nr_sequencia = b.nr_seq_rec_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;
	
--- Hemoterapia
if (ds_item_p like 'H') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_hemoterapia a,
			prescr_solic_bco_sangue b,
			prescr_medica c
	where	a.nr_sequencia = b.nr_seq_hemo_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;
	
--- leites e Derivados
if (ds_item_p like 'L') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_dieta 		a,
			prescr_leite_deriv	b,
			prescr_medica 	c
	where	a.nr_sequencia = b.nr_seq_dieta_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;
	
--- Gasoterapia
if (ds_item_p like 'G') then
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_gasoterapia a,
			prescr_gasoterapia b,
			prescr_medica c
	where	a.nr_sequencia = b.nr_seq_gas_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;

--A NPT Adulta
if (ds_item_p like 'NPTA') then
	
	select 	count(*)
	into STRICT	qt_item_w
	from	cpoe_dieta a,
			nut_pac b,
			prescr_medica c
	where   a.nr_sequencia = b.nr_seq_npt_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		a.ie_tipo_dieta = 'P'
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	goto final;
	
end if;

--I NPT Infantil
if (ds_item_p like 'NPTI') then

	select 	count(*)
	into STRICT	qt_item_w
	from	cpoe_dieta a,
			nut_pac b,
			prescr_medica c
	where  	a.nr_sequencia = b.nr_seq_npt_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		a.ie_tipo_dieta = 'I'
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;

	goto final;
	
end if;

--- Material
if (ds_item_p like 'MA') then	
	
	select	count(*)
	into STRICT	qt_item_w
	from	cpoe_material a,
			prescr_material b,
			prescr_medica c
	where	a.nr_sequencia = b.nr_seq_mat_cpoe
	and		a.nr_atendimento = c.nr_atendimento
	and		b.nr_prescricao = c.nr_prescricao
	and		b.ie_agrupador = 2
	and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
	and		(
		-- Todos
		(ie_liberacao_p = '2') or
		-- Pendente
		(ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
		-- Liberados
		(ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
	)
	and		a.nr_atendimento = nr_atendimento_p;
	
	-- Include Procedure Associated Items
	if (qt_item_w < 1) then

		select	count(*)
		into STRICT	qt_item_w
		from	cpoe_procedimento a,
				prescr_procedimento d,
				prescr_material b,
				prescr_medica c
		where	a.nr_atendimento = c.nr_atendimento
		and		b.nr_prescricao = c.nr_prescricao
		and		b.nr_prescricao = d.nr_prescricao
		and		b.nr_sequencia_proc = d.nr_sequencia
		and		d.nr_seq_proc_cpoe = a.nr_sequencia
		and		c.nr_prescricao = d.nr_prescricao
		and		b.ie_agrupador = 5
		and		obter_se_classif_material(b.cd_material,'M') = 'S'
		and		((a.dt_fim > clock_timestamp()) or (coalesce(a.dt_fim::text, '') = ''))
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		((coalesce(a.dt_suspensao::text, '') = '') and (coalesce(c.dt_suspensao::text, '') = ''))
		and		(
            -- Todos
            (ie_liberacao_p = '2') or
            -- Pendente
            (ie_liberacao_p = '1' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm coalesce(END::text, '') = '') or
            -- Liberados
            (ie_liberacao_p = '0' and CASE WHEN ie_tipo_usuario_w='E' THEN  a.dt_liberacao_enf  ELSE a.dt_liberacao_farm (END IS NOT NULL AND END::text <> ''))
        )
		and		a.nr_atendimento = nr_atendimento_p;
			
	end if;
	
	goto final;
	
end if;
	
<<final>>
if (qt_item_w > 0) then
	ie_retorno_w := 'S';
end if;
	
return ie_retorno_w;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_itens_gpt (nr_atendimento_p bigint, ie_liberacao_p text, ds_item_p text) FROM PUBLIC;

