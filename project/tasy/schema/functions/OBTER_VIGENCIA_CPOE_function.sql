-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_vigencia_cpoe ( nm_tabela_p text, nr_seq_cpoe_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint) RETURNS varchar AS $body$
DECLARE


ds_vigencia_w	varchar(200);
ie_duracao_w    varchar(3);
ds_inicio_w     varchar(10);
ds_fim_w  		varchar(10);


BEGIN

if (nr_seq_cpoe_p > 0) or (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '')  then
	if (nm_tabela_p = 'PRESCR_MATERIAL') then 
	
		select  max(ie_duracao),
				max(to_char(dt_inicio,'dd/mm/yy')) dt_inicio,
				max(to_char(CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(dt_fim_cih,dt_fim)  ELSE coalesce(dt_suspensao,dt_fim) END ,'dd/mm/yy')) dt_fim    
		into STRICT    ie_duracao_w,
				ds_inicio_w,
				ds_fim_w
		from 	cpoe_material
		where	nr_sequencia = nr_seq_cpoe_p;
		
	elsif (nm_tabela_p = 'PRESCR_SOLUCAO') then
	
		select	max(ie_duracao),
				max(to_char(dt_inicio,'dd/mm/yy')) dt_inicio,
				max(to_char(CASE WHEN coalesce(c.dt_lib_suspensao::text, '') = '' THEN  coalesce(c.dt_fim_cih,c.dt_fim)  ELSE coalesce(c.dt_suspensao,c.dt_fim) END ,'dd/mm/yy')) dt_fim    
		into STRICT	ie_duracao_w,
				ds_inicio_w,
				ds_fim_w
		from	prescr_solucao a , 
				prescr_material b, 
				cpoe_material c
		where	a.nr_prescricao = nr_prescricao_p
		and		c.nr_sequencia = b.nr_seq_mat_cpoe 
		and		a.nr_seq_solucao = nr_seq_solucao_p
		and		a.nr_prescricao = b.nr_prescricao 
		and		a.nr_seq_solucao = b.nr_sequencia_solucao LIMIT 1;
			
	elsif (nm_tabela_p = 'PRESCR_PROCEDIMENTO') then 
	
		select  max(ie_duracao),
				max(to_char(dt_inicio,'dd/mm/yy')) dt_inicio,
				max(to_char(CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END ,'dd/mm/yy')) dt_fim     
		into STRICT	ie_duracao_w,
				ds_inicio_w,
				ds_fim_w
		from	cpoe_procedimento
		where	nr_sequencia = nr_seq_cpoe_p;
		
	elsif (nm_tabela_p = 'PRESCR_RECOMENDACAO') then
	
		select  max(ie_duracao),
				max(to_char(dt_inicio,'dd/mm/yy')) dt_inicio,
				max(to_char(CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END ,'dd/mm/yy')) dt_fim    
		into STRICT	ie_duracao_w,
				ds_inicio_w,
				ds_fim_w
		from 	cpoe_recomendacao
		where	nr_sequencia = nr_seq_cpoe_p;		
	
	
	elsif (nm_tabela_p = 'PRESCR_GASOTERAPIA') then
	
		select  max(ie_duracao),
				max(to_char(dt_inicio,'dd/mm/yy')) dt_inicio,
				max(to_char(CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END ,'dd/mm/yy')) dt_fim  
		into STRICT	ie_duracao_w,
				ds_inicio_w,
				ds_fim_w
		from	cpoe_gasoterapia
		where	nr_sequencia = nr_seq_cpoe_p;		

	elsif (nm_tabela_p = 'CPOE_DIALISE') then
	
		select  max(ie_duracao),
				max(to_char(dt_inicio,'dd/mm/yy')) dt_inicio,
				max(to_char(CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END ,'dd/mm/yy')) dt_fim     
		into STRICT	ie_duracao_w,
				ds_inicio_w,
				ds_fim_w
		from	cpoe_dialise
		where	nr_sequencia = nr_seq_cpoe_p;		
		
	elsif (nm_tabela_p = 'PRESCR_DIETA') then
	
		select  max(ie_duracao),
				max(to_char(dt_inicio,'dd/mm/yy')) dt_inicio,
				max(to_char(CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  dt_fim  ELSE coalesce(dt_suspensao,dt_fim) END ,'dd/mm/yy')) dt_fim     
		into STRICT	ie_duracao_w,
				ds_inicio_w,
				ds_fim_w
		from	cpoe_dieta
		where	nr_sequencia = nr_seq_cpoe_p;	
		
	end if;
end if;

if (ie_duracao_w = 'C' ) and (coalesce(ds_fim_w::text, '') = '') then
   ds_vigencia_w := ds_inicio_w  || ' - ' || wheb_mensagem_pck.get_texto(351819);
elsif (ds_fim_w IS NOT NULL AND ds_fim_w::text <> '') then
   ds_vigencia_w  := ds_inicio_w  || ' - ' || ds_fim_w;
else
	ds_vigencia_w := '';
end if;

return ds_vigencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_vigencia_cpoe ( nm_tabela_p text, nr_seq_cpoe_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint) FROM PUBLIC;

