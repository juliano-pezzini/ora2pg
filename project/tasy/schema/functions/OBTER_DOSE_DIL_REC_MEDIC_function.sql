-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dose_dil_rec_medic ( nr_prescricao_p bigint, nr_sequencia_p bigint) RETURNS bigint AS $body$
DECLARE


cd_material_w					integer;
cd_medic_w						integer;
qt_dose_w						double precision;
qt_dose_ml_w					double precision;
cd_unid_med_dose_w				varchar(30) := '';
ie_possui_diluente_w			varchar(1);
ds_hora_w						varchar(10) := '';
ie_administrar_ui_w				varchar(10) := '';
ie_aplicar_medic_w				varchar(10) := '';
ie_aplicar_ww					varchar(10) := '';
ie_um_prescrita_w				varchar(10);
ie_agrupador_w					smallint;
ie_agrupador_ww					smallint;
nr_casas_w						bigint;
qt_dose_mat_w					double precision;
cd_setor_prescr_w				double precision;
cont_ww							double precision;
qt_dose_ml_teste_w				double precision;
qt_volume_cad_w					double precision;
qt_volume_ww					double precision;
cd_mat_ww						bigint;
qt_dose_mat_str_w				varchar(20) := '';
ie_separar_w					varchar(2);
cd_unid_med_dose_mat_w			varchar(30) := '';
qt_solucao_w					double precision := 0;
qt_solucao_str_w				varchar(10) :='';
ds_dose_diferenciada_w			varchar(50);
ie_ordem_w						smallint;
qt_solucao_ww					double precision := 0;
qt_min_aplicacao_w				smallint  := 0;
qt_min_aplicacao_ant_w			smallint  := 0;
qt_hora_aplicacao_ant_w			smallint  := 0;
qt_hora_aplicacao_w				smallint  := 0;
cd_volume_final_w				double precision := 0;
mascara_w						smallint := 0;
qt_dose_str_w					varchar(20) := '';
cd_volume_final_str_w			varchar(20) := '';
qt_diluicao_w					double precision := 0;
qt_conversao_w					double precision;
cd_diluente_w					integer  := 0;
qt_diluicao_str_w				varchar(20) := '';
cd_unidade_medida_w				varchar(30);
cd_estabelecimento_w			smallint;
qt_registro_w					smallint := 0;
ie_descr_redu_dil_w				varchar(1);
ds_aux_diluir_w					varchar(30);
ie_via_aplicacao_w				varchar(5);
cd_intervalo_w					varchar(7);
qt_ml_diluente_w				double precision;
ds_volume_w						varchar(100);
ds_tempo_w						varchar(100);
qt_dose_medic_ml_w				double precision;
ie_aplicar_w					varchar(1);
ds_dose_diluicao_w				varchar(100);
qt_dose_unid_med_cons_w			double precision;
qt_vol_adic_reconst_w			double precision;
ie_indice_w						smallint;
cd_material_red_w				integer;
qt_dose_red_w					double precision;
cd_unid_med_dose_red_w			varchar(30) := '';
qt_solucao_red_w				double precision := 0;
qt_dose_ml_red_w				double precision;
qt_diluicao_aux_w				double precision;
cd_unid_med_diluente_aux_w		varchar(50);
ie_mostrar_estabilidade_w		varchar(1);
qt_estagio_armazenamento_w		bigint;
ds_estagio_armazenamento_w		varchar(255);
qt_estabilidade_w				bigint;
ds_tempo_estabilidade_w			varchar(255);
ie_higroscopico_w				varchar(1);
ie_fotosensivel_w				varchar(1);
ie_termolabil_w					varchar(1);
nr_casas_diluicao_w				bigint;
ie_consist_dose_cons_medic_w	varchar(1) := 'S';
qt_unit_medic_w					double precision;
qt_unit_medic_div_w				double precision;
qt_volume_adic_w				double precision;
ie_apres_vol_reconst_w			varchar(1);
qt_retorno_w					double precision := 0;

c00 CURSOR FOR
SELECT	b.qt_dose,
		b.qt_min_aplicacao,
		b.qt_hora_aplicacao,
		b.cd_unidade_medida_dose,
		b.qt_solucao,
		b.cd_unidade_medida,
		b.cd_material,
		a.cd_estabelecimento,
		b.cd_intervalo,
		b.ie_via_aplicacao,
		b.ds_dose_diferenciada,
		1 ie_indice,
		null ds_hora,
		1 ie_ordem,
		0 qt_diluicao,
		null cd_unid_med_diluente,
		a.cd_setor_atendimento,
		b.qt_unitaria,
		b.ie_agrupador
from 	prescr_material b,
		prescr_medica a
where 	a.nr_prescricao	= b.nr_prescricao
and	b.nr_sequencia	= nr_sequencia_p
and	a.nr_prescricao	= nr_prescricao_p
and	b.ie_agrupador	in (1, 5, 8, 12, 14)
and	not exists (	select	1
			from	prescr_mat_diluicao x
			where	x.nr_prescricao	= b.nr_prescricao
			and	x.nr_seq_material = b.nr_sequencia)

union

select	coalesce(c.qt_dose_diferenciada, b.qt_dose),
		coalesce(c.qt_min_aplicacao, b.qt_min_aplicacao),
		b.qt_hora_aplicacao,
		b.cd_unidade_medida_dose,
		b.qt_solucao,
		b.cd_unidade_medida,
		b.cd_material,
		a.cd_estabelecimento,
		b.cd_intervalo,
		b.ie_via_aplicacao,
		b.ds_dose_diferenciada,
		2 ie_indice,
		c.ds_hora,
		c.ie_ordem,
		c.qt_diluicao,
		c.cd_unid_med_diluente,
		a.cd_setor_atendimento,
		b.qt_unitaria,
		b.ie_agrupador
from 	prescr_mat_diluicao c,
		prescr_material b,
		prescr_medica a
where 	a.nr_prescricao	= b.nr_prescricao
and	c.nr_prescricao	= b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_sequencia	= nr_sequencia_p
and	a.nr_prescricao	= nr_prescricao_p
and	b.ie_agrupador	in (1,5,8,12, 14)
order by ie_ordem;

c01 CURSOR FOR
SELECT	a.cd_material,
		a.qt_dose,
		coalesce(a.qt_vol_adic_reconst,0),
		a.qt_min_aplicacao,
		a.qt_hora_aplicacao,
		a.cd_unidade_medida_dose,
		a.ie_agrupador,
		a.qt_solucao,
		obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose),
		ie_diluir_inteiro,
		x.qt_volume
FROM material b, prescr_material a
LEFT OUTER JOIN material_diluicao x ON (a.nr_seq_mat_diluicao = x.nr_seq_interno)
WHERE ((a.nr_sequencia_diluicao = nr_sequencia_p) or (a.nr_sequencia = nr_sequencia_p)) and a.nr_prescricao		= nr_prescricao_p  and a.cd_material = b.cd_material and a.ie_agrupador IN (3,7,9) order by a.ie_agrupador desc;


BEGIN

select	max(a.cd_material),
		max(coalesce(b.ie_aplicar,'S')),
		max(coalesce(a.ie_aplicar,'S'))
into STRICT	cd_mat_ww,
		ie_aplicar_medic_w,
		ie_aplicar_ww
from	prescr_material a,
		material b
where	a.cd_material	= b.cd_material
and		a.nr_prescricao	= nr_prescricao_p
and		a.nr_sequencia	= nr_sequencia_p;

if (ie_aplicar_ww = 'N') then
	ie_aplicar_medic_w	:= 'N';
end if;

--if	(ds_diluicao_edit_w is null) then
	ie_possui_diluente_w	:= 'N';

	open C00;
	loop
	fetch C00 into
		qt_dose_mat_w,
		qt_min_aplicacao_w,
		qt_hora_aplicacao_w,
		cd_unid_med_dose_mat_w,
		qt_solucao_ww,
		cd_unidade_medida_w,
		cd_medic_w,
		cd_estabelecimento_w,
		cd_intervalo_w,
		ie_via_aplicacao_w,
		ds_dose_diferenciada_w,
		ie_indice_w,
		ds_hora_w,
		ie_ordem_w,
		qt_diluicao_aux_w,
		cd_unid_med_diluente_aux_w,
		cd_setor_prescr_w,
		qt_unit_medic_w,
		ie_agrupador_ww;
	EXIT WHEN NOT FOUND; /* apply on C00 */

		select	coalesce(max(ie_separar),'S'),
				coalesce(max(ie_administrar_ui),'N'),
				coalesce(max(ie_aplicar),'N'),
				coalesce(max(ie_descr_redu_dil),'N'),
				coalesce(max(ie_mostrar_estabilidade),'N'),
				coalesce(max(ie_apres_vol_reconst),'N')
		into STRICT	ie_separar_w,
				ie_administrar_ui_w,
				ie_aplicar_w,
				ie_descr_redu_dil_w,
				ie_mostrar_estabilidade_w,
				ie_apres_vol_reconst_w
		from	parametro_medico
		where	cd_estabelecimento	= cd_estabelecimento_w;

		select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
		-- Hudson
		--into	qt_retorno_w
		into STRICT	qt_retorno_w
		;

		select	coalesce(max(ie_um_prescrita),'N')
		into STRICT	ie_um_prescrita_w
		from	regra_unid_med_diluente
		where	cd_setor_atendimento 	= cd_setor_prescr_w
		and	cd_unidade_medida	= cd_unid_med_dose_mat_w;

		if (ie_um_prescrita_w = 'S') then
			qt_retorno_w	:= 0;
		end if;

		qt_dose_mat_str_w	:= qt_dose_mat_w;

		open c01;
		loop
		fetch c01 into
			cd_material_w,
			qt_dose_w,
			qt_vol_adic_reconst_w,
			qt_min_aplicacao_ant_w,
			qt_hora_aplicacao_ant_w,
			cd_unid_med_dose_w,
			ie_agrupador_w,
			qt_solucao_w,
			qt_dose_ml_w,
			ie_consist_dose_cons_medic_w,
			qt_volume_cad_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

			select	CASE WHEN qt_unit_medic_w=0 THEN 1  ELSE qt_unit_medic_w END
			into STRICT	qt_unit_medic_div_w
			;

			if (ie_consist_dose_cons_medic_w = 'S') then

				qt_dose_mat_w	:= obter_dose_convertida(cd_medic_w, ceil(qt_unit_medic_w),
									cd_unidade_medida_w,cd_unid_med_dose_mat_w);
				select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
				into STRICT	qt_retorno_w
				;

				select	coalesce(max(ie_um_prescrita),'N')
				into STRICT	ie_um_prescrita_w
				from	regra_unid_med_diluente
				where	cd_setor_atendimento 	= cd_setor_prescr_w
				and	cd_unidade_medida	= cd_unid_med_dose_mat_w;

				if (ie_um_prescrita_w = 'S') then
					qt_retorno_w	:= 0;
				end if;

				qt_dose_mat_str_w	:= qt_dose_mat_w;
			end if;

			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 9) and (coalesce(qt_registro_w,0) = 0) then
				begin
				select	obter_conversao_ml(cd_material_w,qt_dose_w + qt_vol_adic_reconst_w,cd_unid_med_dose_w)
				into STRICT	qt_retorno_w
				;

				select	coalesce(max(ie_um_prescrita),'N')
				into STRICT	ie_um_prescrita_w
				from	regra_unid_med_diluente
				where	cd_setor_atendimento 	= cd_setor_prescr_w
				and	cd_unidade_medida	= cd_unid_med_dose_w;

				if (ie_um_prescrita_w = 'S') then
					qt_retorno_w	:= 0;
				end if;

				if (upper(cd_unid_med_dose_mat_w) = upper(obter_unid_med_usua('ML'))) then
					begin
					qt_retorno_w	:= qt_dose_mat_w;
					end;
				else
					begin
					qt_dose_unid_med_cons_w	:= obter_conversao_unid_med_cons(cd_medic_w,cd_unid_med_dose_mat_w,qt_dose_mat_w);
					qt_retorno_w		:= qt_dose_unid_med_cons_w * qt_retorno_w;
					end;
				end if;

			/*
				select	max(qt_conversao)
				into	qt_conversao_w
				from	material_conversao_unidade
				where	cd_material		= cd_medic_w
				and	cd_unidade_medida	= cd_unidade_medida_w;

				if	(ie_apres_vol_reconst_w = 'S') and
					(qt_vol_adic_reconst_w > 0) then

					select	obter_conversao_ml(cd_material_w,qt_dose_w + qt_vol_adic_reconst_w,cd_unid_med_dose_w)
					into	qt_volume_adic_w
					from	dual;

					ds_total_reconst_w := ' (Volume total após reconstituição '|| qt_volume_adic_w ||' ml).';
				end if;

				if	(qt_conversao_w is null) then
					ds_reconstituir_w := 	ds_reconstituir_w ||'Reconstituir cada ' ||cd_unidade_medida_w||
							' em '||replace(qt_dose_str_w,'.',',')||' '||cd_unid_med_dose_w||
							' de '||ds_material_w || nvl(ds_total_reconst_w,'.') || chr(13) || chr(10);
				else
					ds_reconstituir_w := 	ds_reconstituir_w ||'Reconstituir cada ' || qt_conversao_w || ' ' ||cd_unidade_medida_w||
							' em '||replace(qt_dose_str_w,'.',',')||' '||cd_unid_med_dose_w||
							' de '||ds_material_w || nvl(ds_total_reconst_w,'.') || chr(13) || chr(10);
				end if;
				*/
				end;
			end if;
			/*
			if 	(ie_indice_w		= 2) and
				(nvl(qt_registro_w,0)	= 0) and
				(ds_rediluir_w is null) then

				select	max(a.cd_material),
						max(a.qt_dose),
						max(a.cd_unidade_medida_dose),
						max(a.qt_solucao),
						max(obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose))
				into	cd_material_red_w,
						qt_dose_red_w,
						cd_unid_med_dose_red_w,
						qt_solucao_red_w,
						qt_dose_ml_red_w
				from 	material b,
						prescr_material a
				where 	((a.nr_sequencia_diluicao = nr_sequencia_p) or
					 (a.nr_sequencia = nr_sequencia_p))
				  and 	a.nr_prescricao = nr_prescricao_p
				  and	a.cd_material = b.cd_material
				  and	a.ie_agrupador = 7;

				if	(cd_material_red_w is not null) and
					(qt_dose_red_w is not null) and
					(cd_unid_med_dose_red_w is not null) then

					if	(qt_solucao_red_w < 1) or
						(mod(qt_solucao_red_w, trunc(qt_solucao_red_w)) <> 0) then
						mascara_w	:= 0;
					else
						mascara_w	:= 1;
					end if;

					ds_dose_diluicao_w	:= replace(qt_dose_ml_red_w,'.',',') ||' ml';
					if	(qt_dose_ml_red_w = 0) then
						begin
						ds_dose_diluicao_w	:= replace(qt_dose_red_w,'.',',') ||' '||cd_unid_med_dose_red_w;
						end;
					end if;

					select 	decode(mascara_w, 0, campo_mascara(qt_solucao_red_w, 2), campo_mascara(qt_solucao_red_w, 0))
					into	qt_solucao_str_w
					from 	dual;

					if	(ie_separar_w = 'S') then
						ds_rediluir_w := ds_rediluir_w||'Separar '||replace(qt_solucao_str_w,'.',',')||' ml'||' desta solução em '||
								ds_dose_diluicao_w ||' de '||ds_material_red_w || chr(13) || chr(10);
					else
						ds_rediluir_w := ds_rediluir_w||'Rediluir '||replace(qt_solucao_str_w,'.',',')||' ml'||' desta solução em '||
								ds_dose_diluicao_w ||' de '||ds_material_red_w || chr(13) || chr(10);
					end if;
				end if;
			end if;
*/
			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 3) then
			   	begin
				qt_ml_diluente_w	:= qt_dose_ml_w;
				/*
				if	(ie_agrupador_ww = 8) or
					(ie_agrupador_ww = 12) then
					ds_aux_diluir_w	:= ' do produto';
				else
					ds_aux_diluir_w	:= ' do medicamento';
				end if;
				if	(ds_reconstituir_w is not null) then
					ds_aux_diluir_w	:= ' da reconstituição';
				end if;
				if	(nr_casas_diluicao_w = 0) then
					ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' ml';
				else
					ds_dose_diluicao_w	:= replace(round(qt_dose_ml_w,nr_casas_diluicao_w),'.',',') ||' ml';
				end if;

				if	(qt_dose_ml_w = 0) then
					begin
					ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') ||' '||cd_unid_med_dose_w;
					end;
				end if;
				*/
				if (coalesce(qt_solucao_w,0)	> 0) then
					if (qt_volume_cad_w	> 0) then

						select	max(obter_conversao_ml(cd_material_w,qt_dose_w,cd_unid_med_dose_w))
						into STRICT	qt_dose_ml_teste_w
						;

						qt_retorno_w	:= qt_dose_ml_teste_w;
					else
						qt_retorno_w	:= qt_solucao_w;
					end if;
				end if;

				select	coalesce(max(ie_um_prescrita),'N')
				into STRICT	ie_um_prescrita_w
				from	regra_unid_med_diluente
				where	cd_setor_atendimento 	= cd_setor_prescr_w
				and	cd_unidade_medida	= cd_unid_med_dose_mat_w;

				if (ie_um_prescrita_w = 'S') then
					qt_retorno_w	:= 0;
				end if;

				if (ie_indice_w = 2) then/*
					if	(ie_agrupador_ww = 8) or
						(ie_agrupador_ww = 12) then
						ds_aux_diluir_w	:= ' do produto';
					else
						ds_aux_diluir_w	:= ' do medicamento';
					end if;
					if	(ds_reconstituir_w is not null) then
						ds_aux_diluir_w	:= ' da reconstituição';
					end if;

					if	(nr_casas_diluicao_w > 0) then
						ds_volume_w	:= ' '||to_char(round(qt_retorno_w + qt_ml_diluente_w,nr_casas_diluicao_w)) ||' ml';
						if	(ie_consist_dose_cons_medic_w = 'S') then
							ds_volume_w	:= ' '||to_char(round((((qt_retorno_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w)),nr_casas_diluicao_w)) ||' ml';
						end if;
						if	(ie_administrar_ui_w = 'S') then
							select	count(*)
							into	cont_ww
							from	material_conversao_unidade
							where	cd_material	= cd_mat_ww
							and	cd_unidade_medida = 'UI';

							if	(cont_ww > 0) then
								select	count(*)
								into	cont_ww
								from	regra_setor_conv_unid
								where	cd_material	= cd_mat_ww
								and	cd_unidade_medida = 'UI'
								and	cd_setor_atendimento = cd_setor_prescr_w;

								if	(cont_ww > 0) then
									ds_adm_ui_w	:= ' '||to_char(Obter_dose_convertida(cd_mat_ww,round(qt_retorno_w + qt_ml_diluente_w,nr_casas_diluicao_w), 'ml','UI')) ||' UI';
								end if;
							end if;
						end if;
					else
						ds_volume_w	:= ' '||to_char(qt_retorno_w + qt_ml_diluente_w) ||' ml';
						if	(ie_consist_dose_cons_medic_w = 'S') then
							ds_volume_w	:= ' '||to_char((((qt_retorno_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w))) ||' ml';
						end if;
						if	(ie_administrar_ui_w = 'S') then
							select	count(*)
							into	cont_ww
							from	material_conversao_unidade
							where	cd_material = cd_mat_ww
							and	cd_unidade_medida = 'UI';

							if	(cont_ww > 0) then

								select	count(*)
								into	cont_ww
								from	regra_setor_conv_unid
								where	cd_material	= cd_mat_ww
								and	cd_unidade_medida = 'UI'
								and	cd_setor_atendimento = cd_setor_prescr_w;

								if	(cont_ww > 0) then
									ds_adm_ui_w	:= ' '||to_char(Obter_dose_convertida(cd_mat_ww, (qt_retorno_w + qt_ml_diluente_w),'ml','UI')) ||' UI';
								end if;
							end if;
						end if;
					end if;

					if	(ds_volume_w is not null) then
						ds_aplicar_w	:= 'Administrar'|| replace(ds_volume_w,'.',',') || ' '|| ds_tempo_w;
						if	(ds_adm_ui_w is not null) then
							ds_aplicar_w	:= ds_aplicar_w || chr(13) || ' Administrar'|| replace(ds_adm_ui_w,'.',',') || ' '|| ds_tempo_w;
						end if;
					elsif	(ds_tempo_w is not null) then
						ds_aplicar_w	:= 'Administrar'||ds_tempo_w;
					end if;
					*/
					select	max(obter_conversao_ml(cd_material_w,qt_diluicao_aux_w,cd_unid_med_diluente_aux_w))
					into STRICT	qt_dose_ml_w
					;
					/*
					if	(nr_casas_diluicao_w = 0) then
						ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' ml';
					else
						ds_dose_diluicao_w	:= replace(round(qt_dose_ml_w,nr_casas_diluicao_w),'.',',') ||' ml';
					end if;

					if	(qt_dose_ml_w = 0) then
						ds_dose_diluicao_w	:= replace(qt_diluicao_aux_w,'.',',') ||' '||cd_unid_med_diluente_aux_w;
					end if;


					if	(ie_separar_w = 'S') then
						ds_diluir_w := 	ds_diluir_w ||'Separar '||replace(qt_dose_mat_str_w,'.',',')||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w||' em '||
								ds_dose_diluicao_w ||' de '||ds_material_w || chr(13) || chr(10) ||
								ds_rediluir_w || ds_aplicar_w || chr(13) || chr(10);
					else
						ds_diluir_w := 	ds_diluir_w ||'Diluir '||replace(qt_dose_mat_str_w,'.',',')||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w||' em '||
								ds_dose_diluicao_w ||' de '||ds_material_w || chr(13) || chr(10) ||
								ds_rediluir_w || ds_aplicar_w || chr(13) || chr(10);
					end if;

				elsif	(ds_conv_ml_w is null) and
					(ds_diluir_w is null) then
					if	(ds_dose_diferenciada_w is not null) then
						if	(ie_agrupador_ww = 8) or
							(ie_agrupador_ww = 12) then
							ds_aux_diluir_w	:= 'produto';
						else
							ds_aux_diluir_w	:= 'medicamento';
						end if;

						if	(ds_reconstituir_w is not null) then
							ds_aux_diluir_w	:= 'reconstituição';
						end if;
						if	(ie_separar_w = 'S') then
							ds_diluir_w := 	ds_diluir_w ||'Separar '|| ds_aux_diluir_w || ' conforme dose do horário ('||ds_dose_diferenciada_w||') em '||
								ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);
						else
							ds_diluir_w := 	ds_diluir_w ||'Diluir '|| ds_aux_diluir_w || ' conforme dose do horário ('||ds_dose_diferenciada_w||') em '||
								ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);
						end if;
					elsif	(ie_separar_w = 'S') then
						ds_diluir_w := 	ds_diluir_w ||'Separar '||replace(qt_dose_mat_str_w,'.',',')||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w||' em '||
							ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);
					else
						ds_diluir_w := 	ds_diluir_w ||'Diluir '||replace(qt_dose_mat_str_w,'.',',')||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w||' em '||
							ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);
					end if;
				elsif	(ds_diluir_w is null) then

					if	(ds_dose_diferenciada_w is not null) then
						if	(ie_agrupador_ww = 8) or
							(ie_agrupador_ww = 12) then
							ds_aux_diluir_w	:= 'produto';
						else
							ds_aux_diluir_w	:= 'medicamento';
						end if;

						if	(ds_reconstituir_w is not null) then
							ds_aux_diluir_w	:= 'reconstituição';
						end if;

						if	(ie_separar_w = 'S') then
							ds_diluir_w := 	ds_diluir_w ||'Separar '||ds_aux_diluir_w||' conforme dose do horário ('||ds_dose_diferenciada_w||') em '||
								ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);
						else
							ds_diluir_w := 	ds_diluir_w ||'Diluir '||ds_aux_diluir_w||' conforme dose do horário ('||ds_dose_diferenciada_w||') em '||
								ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);
						end if;
					elsif	(ie_separar_w = 'S') then
						ds_diluir_w := 	ds_diluir_w ||'Separar ' ||ds_conv_ml_w ||ds_aux_diluir_w||' em '||
							ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);
					else
						ds_diluir_w := 	ds_diluir_w ||'Diluir ' ||ds_conv_ml_w ||ds_aux_diluir_w||' em '||
							ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);
					end if;
				elsif	(ie_separar_w = 'S') then
					ds_diluir_w := 	ds_diluir_w ||'Separar ' || 'a solução em '||
						ds_dose_diluicao_w ||' de '||ds_material_w || chr(13) || chr(10);
				else
					ds_diluir_w := 	ds_diluir_w ||'Diluir ' || 'a solução em '||
						ds_dose_diluicao_w ||' de '||ds_material_w || chr(13) || chr(10);*/
				end if;
			   	end;
			end if;

			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 7) and (ie_indice_w <> 2) then
			   	begin

				cd_volume_final_w := qt_dose_ml_w + qt_solucao_w;
			/*
				if	(qt_solucao_w < 1) or
					(mod(qt_solucao_w, trunc(qt_solucao_w)) <> 0) then
					mascara_w	:= 0;
				else
					mascara_w	:= 1;
				end if;

				ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' ml';
				if	(qt_dose_ml_w = 0) then
					begin
					ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') ||' '||cd_unid_med_dose_w;
					end;
				end if;

				if	(ie_separar_w = 'S') then
					ds_rediluir_w := ds_rediluir_w||'Separar '||replace(qt_solucao_str_w,'.',',')||' ml'||' desta solução em '||
							ds_dose_diluicao_w ||' de '||ds_material_w || chr(13) || chr(10);
				else
					ds_rediluir_w := ds_rediluir_w||'Rediluir '||replace(qt_solucao_str_w,'.',',')||' ml'||' desta solução em '||
							ds_dose_diluicao_w ||' de '||ds_material_w || chr(13) || chr(10);
				end if;*/
			   	end;
			end if;
			end;

			ie_possui_diluente_w	:= 'S';

		end loop;
		close c01;

		qt_registro_w	:= qt_registro_w + 1;

	end loop;
	close C00;

	/*ds_aplicar_w	:= '';

	Select 	decode(mascara_w, 0, campo_mascara(cd_volume_final_w, 2), campo_mascara(cd_volume_final_w, 0))
	into	cd_volume_final_str_w
	from 	dual;

	if	(qt_min_aplicacao_w is not null) and
		(qt_hora_aplicacao_w is not null) and
		((nvl(qt_min_aplicacao_w,0) > 0) and
		(nvl(qt_hora_aplicacao_w,0) > 0))then
		ds_tempo_w	:=  ' em ' || to_char(qt_hora_aplicacao_w) || ' h. e '|| to_char(qt_min_aplicacao_w) || ' min.';
	elsif	(qt_min_aplicacao_w is null) and
		(qt_hora_aplicacao_w is not null) then
		ds_tempo_w	:= ' em ' || to_char(qt_hora_aplicacao_w) || ' h.';
	elsif	(qt_min_aplicacao_w is not null) and
		(qt_hora_aplicacao_w is null) then
		ds_tempo_w	:= ' em ' || to_char(qt_min_aplicacao_w) || ' min.';
	end if;

	ds_volume_w := null;
	if	(qt_solucao_ww is not null) and
		(qt_solucao_ww > 0) then
		if	(nr_casas_diluicao_w > 0) then
			ds_volume_w	:= ' '||to_char(round(qt_solucao_ww,nr_casas_diluicao_w)) ||' ml';
			qt_volume_ww	:= round(qt_solucao_ww,nr_casas_diluicao_w);
		else
			ds_volume_w	:= ' '||to_char(qt_solucao_ww) ||' ml';
			qt_volume_ww	:= qt_solucao_ww;
		end if;
	elsif	(ie_aplicar_w = 'S') then
		begin
		if	(ds_rediluir_w is not null) then
			ds_volume_w	:= ' '||cd_volume_final_str_w ||' ml';
		elsif	(ds_diluir_w is not null) then
			if	(nr_casas_diluicao_w > 0) then
				ds_volume_w	:= ' '||to_char(round(qt_retorno_w + qt_ml_diluente_w,nr_casas_diluicao_w)) ||' ml';
				qt_volume_ww	:= round(qt_retorno_w + qt_ml_diluente_w,nr_casas_diluicao_w);
				if	(ie_consist_dose_cons_medic_w = 'S') then
					ds_volume_w	:= ' '||to_char(round(((qt_retorno_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w),nr_casas_diluicao_w)) ||' ml';
					qt_volume_ww	:= round(((qt_retorno_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w),nr_casas_diluicao_w);
				end if;
			else
				ds_volume_w	:= ' '||to_char(qt_retorno_w + qt_ml_diluente_w) ||' ml';
				qt_volume_ww	:= qt_retorno_w + qt_ml_diluente_w;
				if	(ie_consist_dose_cons_medic_w = 'S') then
					ds_volume_w	:= ' '||to_char((((qt_retorno_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w))) ||' ml';
					qt_volume_ww	:= (((qt_retorno_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w));
				end if;
			end if;
		end if;

		end;
	end if;


	if	(ie_indice_w <> 2) or
		(ie_possui_diluente_w = 'N') then

		if	(ds_volume_w is not null) then
			ds_aplicar_w	:= 'Administrar'|| replace(ds_volume_w,'.',',') || ' ('||ds_intervalo_w||') '|| ds_tempo_w;
			if	(ie_administrar_ui_w = 'S') then

				select	count(*)
				into	cont_ww
				from	material_conversao_unidade
				where	cd_material	= cd_mat_ww
				and	cd_unidade_medida = 'UI';

				if	(cont_ww > 0) then

					select	count(*)
					into	cont_ww
					from	regra_setor_conv_unid
					where	cd_material	= cd_mat_ww
					and	cd_unidade_medida = 'UI'
					and	cd_setor_atendimento = cd_setor_prescr_w;

					if	(cont_ww > 0) then
						ds_adm_ui_w	:= 'Administrar '|| to_char(Obter_dose_convertida(cd_mat_ww,qt_volume_ww, 'ml','UI')) ||' UI' || ' (' || ds_intervalo_w ||') '|| ds_tempo_w;
						ds_aplicar_w	:= ds_aplicar_w || chr(13) || chr(10) ||ds_adm_ui_w;
					end if;
				end if;
			end if;


		elsif	(ds_tempo_w is not null) then
			ds_aplicar_w	:= 'Administrar'||ds_tempo_w;
		end if;
	else
		ds_rediluir_w	:= '';
	end if;

	if	(ie_aplicar_medic_w = 'N') then
		ds_aplicar_w	:= '';
	end if;

	ds_retorno_w 	:= ds_reconstituir_w || ds_diluir_w || ds_rediluir_w || ds_aplicar_w;
	ds_retorno_w	:= replace(ds_retorno_w,' ,',' 0,');
	ds_retorno_w	:= replace(ds_retorno_w,' .',' 0,');

	select	cd_material
	into	cd_material_w
	from	prescr_material
	where	nr_sequencia = nr_sequencia_p
	and	nr_prescricao = nr_prescricao_p;

	if	(ie_mostrar_estabilidade_w = 'S') then

		select  nvl(max(nr_seq_estagio),0),
			max(substr(obter_estagio_armazenamento(nr_seq_estagio),1,255)),
			max(qt_estabilidade),
			max(substr(obter_valor_dominio(1246,ie_tempo_estab),1,255))
		into	qt_estagio_armazenamento_w,
			ds_estagio_armazenamento_w,
			qt_estabilidade_w,
			ds_tempo_estabilidade_w
		from 	mat_estagio_armaz b,
			material_armazenamento a
		where 	b.nr_sequencia	= a.nr_seq_estagio
		and	a.cd_material	= cd_material_w
		and	b.ie_estagio	= '1';

		if	(ie_possui_diluente_w = 'S') and
			(qt_estagio_armazenamento_w > 0) then
			if	(ds_retorno_w is null) then
				ds_retorno_w := 'Estabilidade: ' || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w;
			else
				ds_retorno_w := ds_retorno_w || chr(13) || chr(10) ||'Estabilidade: ' || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w;
			end if;
		elsif	(qt_estagio_armazenamento_w = 0) and
			(ie_possui_diluente_w = 'S') then
			select  nvl(max(nr_seq_estagio),0),
				max(substr(obter_estagio_armazenamento(nr_seq_estagio),1,255)),
				max(qt_estabilidade),
				max(substr(obter_valor_dominio(1246,ie_tempo_estab),1,255))
			into	qt_estagio_armazenamento_w,
				ds_estagio_armazenamento_w,
				qt_estabilidade_w,
				ds_tempo_estabilidade_w
			from 	mat_estagio_armaz b,
				material_armazenamento a
			where 	b.nr_sequencia	= a.nr_seq_estagio
			and	a.cd_material	= cd_material_w
			and	b.ie_estagio	= '2'
			and	nvl(cd_estabelecimento,nvl(cd_estabelecimento_w,0)) = nvl(cd_estabelecimento_w,0);

			if	(qt_estagio_armazenamento_w > 0) then
				if	(ds_retorno_w is null) then
					ds_retorno_w := 'Estabilidade: ' || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w;
				else
					ds_retorno_w := ds_retorno_w || chr(13) || chr(10) ||'Estabilidade: ' || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w;
				end if;
			end if;

		end if;
	end if;

	select  nvl(max(ie_higroscopico),'N'),
		nvl(max(ie_fotosensivel),'N'),
		nvl(max(ie_termolabil),'N')
	into	ie_higroscopico_w,
		ie_fotosensivel_w,
		ie_termolabil_w
	from 	material
	where 	cd_material = cd_material_w;

	ds_inf_adic_w := 'Material ';
	if	(ie_fotosensivel_w = 'S') then
		ds_inf_adic_w := ds_inf_adic_w ||'fotossensível';
	end if;
	if	(ie_higroscopico_w = 'S') then
		if	(ds_inf_adic_w <> 'Material ') then
			ds_inf_adic_w := ds_inf_adic_w ||', higroscópico';
		else
			ds_inf_adic_w := ds_inf_adic_w ||'higroscópico';
		end if;
	end if;
	if	(ie_termolabil_w = 'S') then
		if	(ds_inf_adic_w <> 'Material ') then
			ds_inf_adic_w := ds_inf_adic_w ||' e termolábil';
		else
			ds_inf_adic_w := ds_inf_adic_w ||'termolábil';
		end if;
	end if;
	ds_inf_adic_w := ds_inf_adic_w ||'.';
	if	(ds_inf_adic_w <> 'Material .') then
		if	(ds_retorno_w is null) then
			ds_retorno_w := ds_inf_adic_w;
		else
			ds_retorno_w := ds_retorno_w || chr(13) || chr(10) ||ds_inf_adic_w;
		end if;
	end if;

else
	ds_retorno_w	:= ds_diluicao_edit_w;
end if;*/
return qt_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dose_dil_rec_medic ( nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

