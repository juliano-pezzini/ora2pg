-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_compatibilidade_opm ( cd_material_p material.cd_material%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type) RETURNS varchar AS $body$
DECLARE

						 
ie_compativel_sus_w	varchar(15);
ie_possui_cid_w		varchar(15);
ie_possui_vinculo_sus_w	varchar(15);
ds_retorno_w		varchar(15);
cd_doenca_w		diagnostico_doenca.cd_doenca%type;
cd_procedimento_w	procedimento.cd_procedimento%type;
nm_usuario_w		usuario.nm_usuario%type;

						 
c01 CURSOR FOR						 
	SELECT	a.cd_doenca 
	from  diagnostico_medico  b, 
		diagnostico_doenca  a, 
		atendimento_paciente x 
	where  a.nr_atendimento   	= x.nr_atendimento 
	and 	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.nm_usuario = nm_usuario_w)) 
	and   x.cd_pessoa_fisica  	= cd_pessoa_fisica_p 
	and	a.nr_atendimento   	= b.nr_atendimento 
	and	a.dt_diagnostico   	= b.dt_diagnostico 
	and	coalesce(a.ie_classificacao_doenca,'P') = 'P' 
	and 	coalesce(a.dt_inativacao::text, '') = '';
	
 
 

BEGIN 
nm_usuario_w		:= wheb_usuario_pck.get_nm_usuario;
ie_compativel_sus_w	:= 'N';
ie_possui_cid_w		:= 'N';
ie_possui_vinculo_sus_w	:= 'N';
 
if (coalesce(cd_material_p,0) > 0) then 
	cd_procedimento_w	:= sus_obter_proc_material_opm(cd_material_p);
end if;
	 
open C01;
loop 
fetch C01 into	 
	cd_doenca_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ie_possui_cid_w := 'S';
	if (cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '') then 
		ie_possui_vinculo_sus_w := 'S';
		if (sus_obter_se_cid_proc_compat(cd_procedimento_w,7,cd_doenca_w) = 'S') then 
			ie_compativel_sus_w := 'S';
		end if;	
	end if;	
	end;
end loop;
close C01;
 
if (ie_possui_cid_w = 'N') then 
	ds_retorno_w	:= 'SD';
elsif (ie_possui_vinculo_sus_w = 'N') then 
	ds_retorno_w	:= 'SP';
elsif (ie_compativel_sus_w = 'N') then	 
	ds_retorno_w	:= 'I';
elsif (ie_compativel_sus_w = 'S') then	 
	ds_retorno_w	:= 'C';
end if;	
 
return	ds_retorno_w;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_compatibilidade_opm ( cd_material_p material.cd_material%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type) FROM PUBLIC;

