-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_carencia_life ( nr_seq_segurado_p bigint, ie_posicao_carencia_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(255);
dt_contratacao_w	timestamp;
ds_carencia_w		varchar(255);
dt_carencia		varchar(20);
i_w			bigint;

C01 CURSOR FOR
	SELECT	substr(ds_carencia,1,27),
		dt_carencia
	from (	SELECT	b.ds_carencia,
				CASE WHEN a.qt_dias='0' THEN 'CUMPRIDA'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_contratacao_w)+a.qt_dias),'dd/mm/yyyy') END  dt_carencia,
				coalesce(b.nr_apresentacao,10) nr_apresentacao,
				'N' ie_preenche_vazio
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	a.nr_seq_segurado	= c.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
			and	b.ie_cpt	= 'N'
			
union all

			select	b.ds_carencia,
				CASE WHEN a.qt_dias='0' THEN 'CUMPRIDA'  ELSE to_char(coalesce(a.dt_fim_vigencia,coalesce(a.dt_inicio_vigencia,dt_contratacao_w)+a.qt_dias),'dd/mm/yyyy') END ,
				coalesce(b.nr_apresentacao,10),
				'N' ie_preenche_vazio
			from	pls_carencia		a,
				pls_tipo_carencia	b,
				pls_segurado		c,
				pls_plano		d
			where	a.nr_seq_tipo_carencia	= b.nr_sequencia
			and	c.nr_seq_plano		= d.nr_sequencia
			and	a.nr_seq_plano		= d.nr_sequencia
			and	c.nr_sequencia		= nr_seq_segurado_p
			and	coalesce(b.ie_padrao_carteira,'N')	= 'S'
			and	b.ie_cpt	= 'N'
			and (	select	count(*)
					from	pls_carencia		a,
						pls_tipo_carencia	b,
						pls_segurado		c
					where	a.nr_seq_tipo_carencia	= b.nr_sequencia
					and	a.nr_seq_segurado	= c.nr_sequencia
					and	c.nr_sequencia		= nr_seq_segurado_p
					and	b.ie_cpt		= 'N') = 0) alias13
	orDER	BY	nr_apresentacao;


BEGIN

select	dt_contratacao
into STRICT	dt_contratacao_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;

i_w	:= 0;

open C01;
loop
fetch C01 into
	ds_carencia_w,
	dt_carencia;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	i_w	:= i_w + 1;

	if (dt_carencia <> 'CUMPRIDA') AND (to_date(dt_carencia,'dd/mm/yyyy') < clock_timestamp()) then
		dt_carencia	:= 'CUMPRIDA';
	end if;

	if (i_w = ie_posicao_carencia_p) then
		ds_retorno_w	:= ds_carencia_w||';'||dt_carencia;

		goto final;

	end if;

	end;
end loop;
close C01;

<<final>>
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_carencia_life ( nr_seq_segurado_p bigint, ie_posicao_carencia_p bigint) FROM PUBLIC;

