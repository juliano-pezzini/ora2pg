-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION phi_obter_hor_com ( cd_estabelecimento_p bigint, dt_inicio_p timestamp, qt_min_p bigint) RETURNS timestamp AS $body$
DECLARE


qt_min_w		numeric(22);
qt_min_dia_w		numeric(22);
dt_inicio_comercial_w	timestamp;
dt_fim_comercial_w	timestamp;
dt_referencia_w		timestamp;
dt_retorno_w		timestamp;


BEGIN

dt_retorno_w	:= dt_inicio_p + (qt_min_p / 1440);
qt_min_w	:= qt_min_p;
dt_referencia_w	:= dt_inicio_p;

dt_inicio_comercial_w	:= pkg_date_utils.get_time(dt_referencia_w,'08');
dt_fim_comercial_w	:= pkg_date_utils.get_time(dt_referencia_w,'18');

/**
* First we need to standarize the date, so if the hours are earlier than
* 08:00 a.m. or after 18:00 p.m., we should normalize those dates to the edge of
* the business day
*/
if (dt_referencia_w < dt_inicio_comercial_w) then
	dt_referencia_w := dt_inicio_comercial_w;
elsif (dt_referencia_w > dt_fim_comercial_w) then
	dt_referencia_w := dt_fim_comercial_w;
end if;

while(qt_min_w >= 0) loop
	begin

	dt_fim_comercial_w	:= pkg_date_utils.get_time(dt_referencia_w,'18');

	/**
	* In case the day is a Saturday or a Sunday, we should set the reference
	* to the next day, at 08:00 a.m.
	* Same thing on holidays.
	*/
	if (pkg_date_utils.is_business_day(dt_referencia_w) = 0) then
		dt_referencia_w := pkg_date_utils.get_time(dt_referencia_w + 1,'08');
	elsif (obter_se_feriado(cd_estabelecimento_p,dt_referencia_w) > 0) then
		dt_referencia_w := pkg_date_utils.get_time(dt_referencia_w + 1,'08');
	else
		begin
		/**
		* Get the remaining minutes between the reference and end of
		* business hours.
		*/
		qt_min_dia_w := (dt_fim_comercial_w - dt_referencia_w) * 1440;
		
		if (qt_min_w <= qt_min_dia_w) then
			begin
			dt_retorno_w := dt_referencia_w + (qt_min_w / 1440);
			qt_min_w := -1;
			end;
		else
			qt_min_w := qt_min_w - qt_min_dia_w;
			dt_referencia_w := pkg_date_utils.get_time(dt_referencia_w + 1,'08');
		end if;
		end;
	end if;	
	end;
end loop;

return dt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION phi_obter_hor_com ( cd_estabelecimento_p bigint, dt_inicio_p timestamp, qt_min_p bigint) FROM PUBLIC;

