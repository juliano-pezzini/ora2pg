-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION kpi_obter_absenteismo (nr_seq_gerencia_p bigint, nr_seq_grupo_p bigint, cd_pessoa_fisica_p text, dt_referencia_p timestamp) RETURNS bigint AS $body$
DECLARE


resultado_w				double precision;
dt_inicial_w			timestamp;
dt_final_w				timestamp;
nm_usuario_exec_w		varchar(255);
qt_min_total_w			bigint;
qt_min_nreg_w			bigint;
qt_min_registrados_w	bigint;
qt_min_intervalo_w		bigint;
qt_min_lanche_w			bigint;
qt_min_os_w				bigint;
qt_registrada_w			bigint;
qt_mes_disp_w			bigint;
qt_min_tab_ponto_w		bigint;
nr_seq_diretoria_w		ppm_objetivo.nr_seq_diretoria%type;
nr_seq_gerencia_w		ppm_objetivo.nr_seq_gerencia%type;
nr_seq_grupo_w			ppm_objetivo.nr_seq_grupo%type;


BEGIN
dt_inicial_w := pkg_date_utils.start_of(dt_referencia_p,'MONTH');
dt_final_w := fim_mes(dt_referencia_p);

select	max(nm_usuario)
into STRICT	nm_usuario_exec_w
from	usuario
where	cd_pessoa_fisica = cd_pessoa_fisica_p
and		ie_situacao = 'A';

nr_seq_gerencia_w:= nr_seq_gerencia_p;
nr_seq_grupo_w:= nr_seq_grupo_p;

if (nr_seq_gerencia_w IS NOT NULL AND nr_seq_gerencia_w::text <> '') then

	select	sum(coalesce(qt_min_total,0)),
			sum(coalesce(qt_min_intervalo,0)),
			sum(coalesce(qt_min_lanche,0)),
			sum(coalesce(qt_min_os,0))
	into STRICT	qt_min_total_w,
			qt_min_intervalo_w,
			qt_min_lanche_w,
			qt_min_os_w
	from	usuario_controle a,
			usuario u,
			grupo_desenvolvimento b,
			usuario_grupo_des c,
			gerencia_wheb g
	where	u.nm_usuario = c.NM_USUARIO_GRUPO
	and		c.nr_seq_grupo = b.nr_sequencia
	and		b.nr_seq_gerencia = g.nr_sequencia
	and		a.nm_usuario = u.nm_usuario
	and		(a.dt_saida IS NOT NULL AND a.dt_saida::text <> '')
	and		b.ie_situacao = 'A'
	and		obter_se_dia_util(a.dt_entrada,1) = 'S'
	and		OBTER_SE_USUARIO_AUSENTE(c.NM_USUARIO_GRUPO, a.dt_entrada) = 'N'
	and		a.dt_entrada between dt_inicial_w and dt_final_w
	and		g.nr_sequencia = nr_seq_gerencia_w;


	select	sum(a.qt_min_trab)
	into STRICT	qt_min_tab_ponto_w
	from	PF_HORA_TRABALHADA a,
			usuario u,
			grupo_desenvolvimento b,
			usuario_grupo_des c,
			gerencia_wheb g
	where	u.nm_usuario = c.NM_USUARIO_GRUPO
	and		c.nr_seq_grupo = b.nr_sequencia
	and		b.nr_seq_gerencia = g.nr_sequencia
	and		a.cd_pessoa_fisica = u.cd_pessoa_fisica
	and		b.ie_situacao = 'A'
	and		trunc(dt_referencia_p,'MONTH') = trunc(a.dt_referencia,'MONTH')
	and		a.cd_sistema in (1,303,304,305,306)
	and		g.nr_sequencia = nr_seq_gerencia_w;



elsif (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then

	select	sum(coalesce(qt_min_total,0)),
			sum(coalesce(qt_min_intervalo,0)),
			sum(coalesce(qt_min_lanche,0)),
			sum(coalesce(qt_min_os,0))
	into STRICT	qt_min_total_w,
			qt_min_intervalo_w,
			qt_min_lanche_w,
			qt_min_os_w
	from	usuario_controle a,
			usuario u,
			grupo_desenvolvimento b,
			usuario_grupo_des c,
			gerencia_wheb g
	where   u.nm_usuario = c.NM_USUARIO_GRUPO
	and		c.nr_seq_grupo = b.nr_sequencia
	and		b.nr_seq_gerencia = g.nr_sequencia
	and		a.nm_usuario = u.nm_usuario
	and		obter_se_dia_util(a.dt_entrada,1) = 'S'
	and		OBTER_SE_USUARIO_AUSENTE(c.NM_USUARIO_GRUPO, a.dt_entrada) = 'N'
	and		a.dt_entrada between dt_inicial_w and dt_final_w
	and		b.nr_sequencia = nr_seq_grupo_w;

	select	sum(a.qt_min_trab)
	into STRICT	qt_min_tab_ponto_w
	from	PF_HORA_TRABALHADA a,
			usuario u,
			grupo_desenvolvimento b,
			usuario_grupo_des c,
			gerencia_wheb g
	where   u.nm_usuario = c.NM_USUARIO_GRUPO
	and		c.nr_seq_grupo = b.nr_sequencia
	and		b.nr_seq_gerencia = g.nr_sequencia
	and		a.cd_pessoa_fisica = u.cd_pessoa_fisica
	and		trunc(dt_referencia_p,'MONTH') = trunc(a.dt_referencia,'MONTH')
	and		a.cd_sistema in (1,303,304,305,306)
	and		b.nr_sequencia = nr_seq_grupo_w;

elsif (nm_usuario_exec_w IS NOT NULL AND nm_usuario_exec_w::text <> '') then

	select	sum(coalesce(qt_min_total,0)),
			sum(coalesce(qt_min_intervalo,0)),
			sum(coalesce(qt_min_lanche,0)),
			sum(coalesce(qt_min_os,0)),
			count(a.dt_entrada)
	into STRICT	qt_min_total_w,
			qt_min_intervalo_w,
			qt_min_lanche_w,
			qt_min_os_w,
			qt_registrada_w
	from	usuario_controle a
	where	a.nm_usuario = nm_usuario_exec_w
	and		OBTER_SE_USUARIO_AUSENTE(nm_usuario_exec_w, a.dt_entrada) = 'N'
	and		(a.dt_saida IS NOT NULL AND a.dt_saida::text <> '')
	and		obter_se_dia_util(a.dt_entrada,1) = 'S'
	and		a.dt_entrada between dt_inicial_w and dt_final_w;

	select	sum(a.qt_min_trab)
	into STRICT	qt_min_tab_ponto_w
	from	PF_HORA_TRABALHADA a
	where	trunc(dt_referencia_p,'MONTH') = trunc(a.dt_referencia,'MONTH')
	and		a.cd_pessoa_fisica = cd_pessoa_fisica_p
	and		a.cd_sistema in (1,303,304,305,306);

end if;

qt_mes_disp_w := OBTER_QT_DIA_UTIL_PERIODO(dt_inicial_w, dt_final_w, 1);

if  qt_registrada_w < qt_mes_disp_w then
    qt_min_total_w := qt_min_total_w + ((qt_mes_disp_w-qt_registrada_w) * 7);
end if;

qt_min_registrados_w   := qt_min_total_w - qt_min_intervalo_w - qt_min_lanche_w;

/*
1 Trabalhando
700 Horas Sobreaviso
303	Horas Extra 100%
304 Horas Extra 100% Not
305 Hora Extra 70%
306 Hora Extras 70% Not
*/
resultado_w:= trunc(dividir(qt_min_registrados_w,qt_min_tab_ponto_w) * 100);

if (resultado_w > 100) then
	resultado_w     := 100;
end if;

return resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION kpi_obter_absenteismo (nr_seq_gerencia_p bigint, nr_seq_grupo_p bigint, cd_pessoa_fisica_p text, dt_referencia_p timestamp) FROM PUBLIC;

