-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_order_search_names (ds_type_p text, nm_filter_p text) RETURNS varchar AS $body$
DECLARE


format_w	varchar(500);
ds_order_w	varchar(500);
component_w	varchar(2000);
sep_w		integer;
KEY_GIVEN 	constant varchar(30) := 'givenName';
KEY_FAMILY 	constant varchar(30) := 'familyName';
KEY_COMPONENT_1 constant varchar(30) := 'componentName1';
KEY_COMPONENT_2 constant varchar(30) := 'componentName2';
KEY_COMPONENT_3 constant varchar(30) := 'componentName3';



BEGIN
	select replace(replace(replace(replace(ds_format,'${',''),'}',';'),'}',''),',','')
	into STRICT   format_w
	from (  SELECT	coalesce(max(ds_format),'${givenName}') ds_format
		from	person_name_format
		where	coalesce(ds_locale, 'pt_BR') = pkg_i18n.get_user_locale
		and	ds_type = coalesce(ds_type_p, 'full')
	     ) alias8 LIMIT 1;
		
	if (format_w IS NOT NULL AND format_w::text <> '') then
		while (format_w IS NOT NULL AND format_w::text <> '') loop
		   sep_w := position(';' in format_w);
		   if (sep_w > 0) then
			component_w  := substr(format_w, 1, sep_w - 1);
			format_w     := trim(both substr(format_w, sep_w + 1, length(format_w)));
			
			if (component_w = KEY_GIVEN) then
				ds_order_w := ds_order_w || 'nvl(tasyautocomplete.getscore(upper(ds_given_name), strarray(upper(' || chr(39) || nm_filter_p || chr(39) ||'))).itemscore, 0) desc,' || chr(13) || chr(10);
			elsif (component_w = KEY_FAMILY) then
				ds_order_w := ds_order_w || 'nvl(tasyautocomplete.getscore(upper(ds_family_name), strarray(upper('|| chr(39) || nm_filter_p || chr(39) ||'))).itemscore, 0) desc,' || chr(13) || chr(10);
			elsif (component_w = KEY_COMPONENT_1) then
				ds_order_w := ds_order_w || 'nvl(tasyautocomplete.getscore(upper(ds_component_name_1), strarray(upper('|| chr(39) || nm_filter_p || chr(39) ||'))).itemscore, 0) desc,' || chr(13) || chr(10);
			elsif (component_w = KEY_COMPONENT_2) then
				ds_order_w := ds_order_w || 'nvl(tasyautocomplete.getscore(upper(ds_component_name_2), strarray(upper('|| chr(39) || nm_filter_p || chr(39) ||'))).itemscore, 0) desc,' || chr(13) || chr(10);
			elsif (component_w = KEY_COMPONENT_3) then
				ds_order_w := ds_order_w || 'nvl(tasyautocomplete.getscore(upper(ds_component_name_3), strarray(upper('|| chr(39) || nm_filter_p || chr(39) ||'))).itemscore, 0) desc,' || chr(13) || chr(10);
			end if;
		   end if;
		end loop;
		
		ds_order_w := ds_order_w || 'nm_pessoa_fisica';
	
	else
		return 'nvl(tasyautocomplete.getscore(upper(ds_given_name), strarray(upper('|| nm_filter_p || '))).itemscore, 0) desc,' || chr(13) || chr(10) || 'nm_pessoa_fisica';
	end if;
	
	return ds_order_w;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_order_search_names (ds_type_p text, nm_filter_p text) FROM PUBLIC;

