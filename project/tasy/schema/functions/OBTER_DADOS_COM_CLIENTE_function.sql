-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_com_cliente ( nr_seq_cliente_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
/* 	UH - Último Histórico 
	C - CNPJ cliente 
	D - Razão Social 
	F - Nome Fantasia	 
	V - Vínculo	 
	A - Atuacao - Identifica se existe canal sem data de atuacao 
	CI - Cidade 
	P - Produto 
	*/
 
 
 
cd_cnpj_w				varchar(14);
ds_cliente_w				varchar(255);
ds_retorno_w				varchar(255);
dt_historico_w				varchar(20);
nm_fantasia_w				varchar(80);
ie_vinculo_w				varchar(2);
qt_clientes_vinculados_w	 		bigint;
qt_vinculo_w				bigint;
ds_municipio_w				varchar(255);


BEGIN 
 
ie_vinculo_w := 'N';
 
select	cd_cnpj 
into STRICT	cd_cnpj_w 
from	com_cliente 
where	nr_sequencia = nr_seq_cliente_p;
 
select	substr(obter_nome_pf_pj(null,a.cd_cgc),1,255), 
	nm_fantasia, 
	ds_municipio 
into STRICT	ds_cliente_w, 
	nm_fantasia_w, 
	ds_municipio_w 
from	pessoa_juridica a 
where	a.cd_cgc	= cd_cnpj_w;
 
select	to_char(max(a.dt_historico),'dd/mm/yyyy hh24:mi:ss') 
into STRICT	dt_historico_w 
from	com_cliente_hist a 
where	a.nr_seq_cliente	= nr_seq_cliente_p;
 
select	count(*) /* Paulo 13/12/2007 - Verifica se possui clientes vinculados */
 
into STRICT	qt_clientes_vinculados_w 
from	com_cliente_vinculo a, 
	com_cliente b 
where	a.nr_seq_cliente	= b.nr_sequencia 
and	b.nr_sequencia		= nr_seq_cliente_p;
 
if (qt_clientes_vinculados_w > 0) then 
	ie_vinculo_w := 'CV';
end if;
 
select	count(*) /* Paulo 13/12/2007 - Verifica se cliente está vinculado a outro cliente */
 
into STRICT	qt_vinculo_w 
from	com_cliente_vinculo 
where	nr_seq_cliente_vinculo = nr_seq_cliente_p;
 
if (qt_vinculo_w > 0) then 
	ie_vinculo_w := 'V';
end if;
 
if (ie_opcao_p = 'C') then 
	ds_retorno_w := cd_cnpj_w;
elsif (ie_opcao_p = 'D') then 
	ds_retorno_w := ds_cliente_w;
elsif (ie_opcao_p = 'UH') then 
	ds_retorno_w := dt_historico_w;
elsif (ie_opcao_p = 'F') then 
	ds_retorno_w := nm_fantasia_w;
elsif (ie_opcao_p = 'V') then 
	ds_retorno_w := ie_vinculo_w;
elsif (ie_opcao_p = 'A') then 
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
	into STRICT	ds_retorno_w 
	from	com_canal_cliente 
	where	nr_seq_cliente = nr_seq_cliente_p 
	and	coalesce(dt_fim_atuacao::text, '') = '';
elsif (ie_opcao_p = 'CI') then 
	ds_retorno_w := ds_municipio_w;
elsif (ie_opcao_p = 'P') then 
	select	substr(obter_valor_dominio(2668, ie_produto),1,200) 
	into STRICT 	ds_retorno_w 
	from	com_cliente 
	where	nr_sequencia = nr_seq_cliente_p;
end if;
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_com_cliente ( nr_seq_cliente_p bigint, ie_opcao_p text) FROM PUBLIC;

