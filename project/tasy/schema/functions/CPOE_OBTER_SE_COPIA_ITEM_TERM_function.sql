-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_se_copia_item_term ( ds_horarios_p cpoe_material.ds_horarios%type, cd_intervalo_p intervalo_prescricao.cd_intervalo%type, dt_inicial_p timestamp, dt_fim_p timestamp ) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(1) := 'S';
ie_operacao_w	intervalo_prescricao.ie_operacao%type;
qt_operacao_w	intervalo_prescricao.qt_operacao%type;
ie_24_h_w		intervalo_prescricao.ie_24_h%type;
ds_horarios_w	cpoe_material.ds_horarios%type;
ds_hora_w		varchar(255) := '';
dt_ultimo_hor_w	timestamp;
qt_dia_adic_w	integer := 0;
i_pos 			integer;
ds_lang_tag_w	user_locale.ds_locale%type;
ds_date_mask_shortdate_w	locale_formats.ds_localized_mask%type;
ds_date_mask_timestamp_w	locale_formats.ds_localized_mask%type;


BEGIN

	ds_lang_tag_w := pkg_date_formaters.getUserLanguageTag(cd_estabelcimento_p => wheb_usuario_pck.get_cd_estabelecimento, nm_usuario_p => wheb_usuario_pck.get_nm_usuario);
	ds_date_mask_shortdate_w := pkg_date_formaters.localize_mask(ds_mask => 'shortDate', lang_tag => ds_lang_tag_w);
	ds_date_mask_timestamp_w := pkg_date_formaters.localize_mask(ds_mask => 'timestamp', lang_tag => ds_lang_tag_w);

	if (dt_fim_p IS NOT NULL AND dt_fim_p::text <> '') and (dt_inicial_p IS NOT NULL AND dt_inicial_p::text <> '')  then
		ds_horarios_w := padroniza_horario_prescr(ds_horarios_p, dt_inicial_p);

		if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
			select max(a.ie_operacao),
				   max(a.qt_operacao),
				   max(a.ie_24_h)
			  into STRICT ie_operacao_w,
				   qt_operacao_w,
				   ie_24_h_w
			  from intervalo_prescricao a
			 where a.cd_intervalo = cd_intervalo_p;
		end if;

		if ((ie_operacao_w = 'H') and (qt_operacao_w > 24) and (ie_24_h_w = 'S')) then
		
			if ((position('A' in ds_horarios_w) > 0) and (qt_dia_adic_w = 0)) then
				qt_dia_adic_w := 1;
			elsif (position('AA' in ds_horarios_w) > 0) then
				qt_dia_adic_w := 2;
			end if;
			
			ds_hora_w := obter_prim_dsHorarios(replace(ds_horarios_w, 'A', ''));
			
			dt_ultimo_hor_w := to_date(to_char(dt_inicial_p, ds_date_mask_shortdate_w) || ' ' || replace(ds_hora_w, 'A', ''), ds_date_mask_timestamp_w) + qt_dia_adic_w;
		
			if (dt_ultimo_hor_w > dt_fim_p) then
				ds_retorno_w := 'N';
			end if;
		else

			<<loop_horarios>>
			while (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') loop
				i_pos := position(' ' in ds_horarios_w);

				if (i_pos > 1) and ((substr(ds_horarios_w, 1, i_pos-1) IS NOT NULL AND (substr(ds_horarios_w, 1, i_pos-1))::text <> '')) then
					ds_hora_w := replace(substr(ds_horarios_w, 1, i_pos-1), ' ', '');
					ds_horarios_w := substr(ds_horarios_w, i_pos + 1, 2000);
				elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then
					ds_hora_w := replace(ds_horarios_w, ' ', '');
					ds_horarios_w := '';
				end if;

				if ((position('A' in ds_hora_w) > 0) and (qt_dia_adic_w = 0)) then
					qt_dia_adic_w := 1;
				elsif (position('AA' in ds_hora_w) > 0) then
					qt_dia_adic_w := qt_dia_adic_w + 1;
				end if;

				dt_ultimo_hor_w := to_date(to_char(dt_inicial_p, ds_date_mask_shortdate_w) || ' ' || replace(ds_hora_w, 'A', ''), ds_date_mask_timestamp_w) + qt_dia_adic_w;
			
				if (dt_ultimo_hor_w > dt_fim_p) then
					ds_retorno_w := 'N';
					ds_horarios_w := null;
				else
					/* Se houver pelo menos um horario do DS_HORARIOS na vigencia ja pode retornar S */

				    ds_retorno_w := 'S';
					ds_horarios_w := null;
				end if;
			end loop loop_horarios;

		end if;

	end if;

	return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_se_copia_item_term ( ds_horarios_p cpoe_material.ds_horarios%type, cd_intervalo_p intervalo_prescricao.cd_intervalo%type, dt_inicial_p timestamp, dt_fim_p timestamp ) FROM PUBLIC;

