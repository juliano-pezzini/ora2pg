-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION proj_consiste_risco_proj ( nm_usuario_p text, nr_seq_proj_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(255);
cd_coordenador_w		varchar(10);
nm_usuario_coordenador_w	varchar(15);
nm_usuario_responsavel_w	varchar(15);
nm_usuario_pessoa_fisica_w	varchar(15);
cd_responsavel_w		varchar(10);
cd_pessoa_fisica_w		varchar(10);
nr_seq_tipo_w			bigint;
dt_prev_solucao_w		timestamp;
dt_repactuada_sol_w		timestamp;
ds_titulo_w			varchar(80);
ie_grau_risco_w			varchar(2);
nr_seq_risco_w			bigint;
nr_seq_risco_ww			bigint;
ie_risco_pend_w			varchar(1);

C01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_responsavel,
		cd_pessoa_fisica,
		nr_seq_tipo,
		dt_prev_solucao,
		dt_repactuada_sol,
		ds_titulo,
		ie_grau_risco
	from	proj_risco_implantacao
	where	nr_seq_proj = nr_seq_proj_p
	and	coalesce(dt_fim_real::text, '') = '';


BEGIN

ds_retorno_w := '';
ie_risco_pend_w := 'N';

select	max(cd_coordenador)
into STRICT	cd_coordenador_w
from	proj_projeto
where	nr_sequencia = nr_seq_proj_p;

if (cd_coordenador_w IS NOT NULL AND cd_coordenador_w::text <> '') then
	select 	max(nm_usuario)
	into STRICT	nm_usuario_coordenador_w
	from	usuario
	where	cd_pessoa_fisica	= cd_coordenador_w;
end if;

open C01;
loop
fetch C01 into
	nr_seq_risco_w,
	cd_responsavel_w,
	cd_pessoa_fisica_w,
	nr_seq_tipo_w,
	dt_prev_solucao_w,
	dt_repactuada_sol_w,
	ds_titulo_w,
	ie_grau_risco_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (cd_responsavel_w IS NOT NULL AND cd_responsavel_w::text <> '') then
		select 	max(nm_usuario)
		into STRICT	nm_usuario_responsavel_w
		from	usuario
		where	cd_pessoa_fisica	= cd_responsavel_w;
	end if;

	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
		select 	max(nm_usuario)
		into STRICT	nm_usuario_pessoa_fisica_w
		from	usuario
		where	cd_pessoa_fisica	= cd_pessoa_fisica_w;
	end if;

	if (((coalesce(ie_grau_risco_w::text, '') = '') and (ds_titulo_w = ' ') and (coalesce(nr_seq_tipo_w::text, '') = '')) or (coalesce(dt_repactuada_sol_w,dt_prev_solucao_w) < clock_timestamp())) and
		((nm_usuario_p = nm_usuario_pessoa_fisica_w) or (nm_usuario_p = nm_usuario_responsavel_w) or (nm_usuario_p = nm_usuario_coordenador_w)) then

		if (coalesce(ds_retorno_w::text, '') = '') then
			ds_retorno_w := replace(obter_desc_expressao(922370), '#@DS_RISCO#@', '');
			ds_retorno_w := ds_retorno_w|| nr_seq_risco_w||'; ';
		else
			ds_retorno_w := substr(ds_retorno_w|| nr_seq_risco_w||'; ',1,255);
		end if;
	end if;
	end;
end loop;
close C01;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION proj_consiste_risco_proj ( nm_usuario_p text, nr_seq_proj_p bigint) FROM PUBLIC;

