-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function obter_prescr_item_cpoe as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE FUNCTION obter_prescr_item_cpoe ( nr_sequencia_p bigint, ie_tipo_item_p text, nr_atendimento_p bigint default null, cd_pessoa_fisica_p text default null) RETURNS bigint AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

	v_ret	bigint;
BEGIN
	v_query := 'SELECT * FROM obter_prescr_item_cpoe_atx ( ' || quote_nullable(nr_sequencia_p) || ',' || quote_nullable(ie_tipo_item_p) || ',' || quote_nullable(nr_atendimento_p) || ',' || quote_nullable(cd_pessoa_fisica_p) || ' )';
	SELECT * INTO v_ret FROM dblink(v_conn_str, v_query) AS p (ret bigint);
	RETURN v_ret;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE FUNCTION obter_prescr_item_cpoe_atx ( nr_sequencia_p bigint, ie_tipo_item_p text, nr_atendimento_p bigint default null, cd_pessoa_fisica_p text default null) RETURNS bigint AS $body$
DECLARE


  nr_prescricao_w		bigint;
  NR_SEQ_MAT_CPOE_W bigint;
  NR_ATENDIMENTO_W  bigint;
BEGIN

if (ie_tipo_item_p		= 'D') then
	select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	prescr_dieta b
	where	nr_seq_dieta_cpoe	= nr_sequencia_p;
elsif (ie_tipo_item_p		in ('SNE','S')) then
	select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	prescr_material
	where	nr_seq_dieta_cpoe = nr_sequencia_p;
elsif (ie_tipo_item_p	= 'LD') then
	select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	prescr_leite_deriv
	where	nr_seq_dieta_cpoe = nr_sequencia_p;
elsif (ie_tipo_item_p		= 'J') then
	select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	rep_jejum b
	where	nr_seq_dieta_cpoe = nr_sequencia_p;
elsif (ie_tipo_item_p		in ('M','SOL','MAT')) then
	select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	prescr_material
	where	nr_seq_mat_cpoe	= nr_sequencia_p;
elsif (ie_tipo_item_p		in ('P','HM','AP')) then
	select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	prescr_procedimento
	where	nr_seq_proc_cpoe = nr_sequencia_p;
elsif (ie_tipo_item_p		= 'O') then
	select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	prescr_gasoterapia
	where	nr_seq_gas_cpoe	= nr_sequencia_p;
elsif (ie_tipo_item_p		= 'R') then
	select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	prescr_recomendacao
	where	nr_seq_rec_cpoe	= nr_sequencia_p;	
elsif (ie_tipo_item_p	in ('NPTA','NPTI')) then
	select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	nut_pac b
	where	b.nr_seq_npt_cpoe	= nr_sequencia_p;
elsif (ie_tipo_item_p		= 'DI') then
	select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	prescr_solucao
	where	nr_seq_dialise_cpoe = nr_sequencia_p;
elsif (ie_tipo_item_p		= 'cpin') then
    select  max(b.nr_prescricao)
    into STRICT	nr_prescricao_w
    FROM pe_prescr_proc a
LEFT OUTER JOIN pe_prescricao b ON (a.nr_seq_prescr = b.nr_sequencia)
LEFT OUTER JOIN pe_procedimento c ON (a.nr_seq_proc = c.nr_sequencia)
WHERE (a.nr_seq_prescr IS NOT NULL AND a.nr_seq_prescr::text <> '')   and a.nr_sequencia = nr_sequencia_p;
ELSIF (IE_TIPO_ITEM_P = 'BI') THEN
  SELECT BI.NR_ATENDIMENTO,
         BI.NR_SEQ_MAT_CPOE
    INTO STRICT NR_ATENDIMENTO_W,
         NR_SEQ_MAT_CPOE_W
    FROM BOMBA_INFUSAO BI
   WHERE BI.NR_SEQUENCIA = NR_SEQUENCIA_P;

  SELECT coalesce(MAX(PM.NR_PRESCRICAO), 0)
    INTO STRICT NR_PRESCRICAO_W
    FROM PRESCR_MEDICA PM, PRESCR_MATERIAL PMT
   WHERE PM.NR_PRESCRICAO = PMT.NR_PRESCRICAO
     AND PM.NR_ATENDIMENTO = coalesce(NR_ATENDIMENTO_P, NR_ATENDIMENTO_W)
     AND PMT.NR_SEQ_MAT_CPOE = NR_SEQ_MAT_CPOE_W
     AND PM.DT_VALIDADE_PRESCR >= clock_timestamp()
     AND PM.DT_INICIO_PRESCR <= clock_timestamp();

  IF (NR_PRESCRICAO_W = 0) THEN
    SELECT PM.NR_PRESCRICAO
      INTO STRICT NR_PRESCRICAO_W
      FROM PRESCR_MEDICA PM, PRESCR_MATERIAL PMT
     WHERE PM.NR_PRESCRICAO = PMT.NR_PRESCRICAO
       AND PM.NR_ATENDIMENTO = coalesce(NR_ATENDIMENTO_P, NR_ATENDIMENTO_W)
       AND PMT.NR_SEQ_MAT_CPOE = NR_SEQ_MAT_CPOE_W
       AND PM.DT_VALIDADE_PRESCR < clock_timestamp()
     ORDER BY PM.DT_VALIDADE_PRESCR DESC LIMIT 1;
  END IF;
end if;

return	nr_prescricao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prescr_item_cpoe ( nr_sequencia_p bigint, ie_tipo_item_p text, nr_atendimento_p bigint default null, cd_pessoa_fisica_p text default null) FROM PUBLIC; -- REVOKE ALL ON FUNCTION obter_prescr_item_cpoe_atx ( nr_sequencia_p bigint, ie_tipo_item_p text, nr_atendimento_p bigint default null, cd_pessoa_fisica_p text default null) FROM PUBLIC;

