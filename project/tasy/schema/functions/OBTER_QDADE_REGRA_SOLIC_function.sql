-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qdade_regra_solic ( cd_material_p bigint, cd_local_estoque_p bigint, cd_opcao_p text) RETURNS bigint AS $body$
DECLARE

/*
Somente  para a utilização do Coretqff
 	'919'  - Requisição de consumo
	'919x' - Requisição de transferência
	'109' - Atendimento da requisição
	'-109' - Atendimento da requisição - transferência
	'36' - Prescrição(Devolução)
	'24' - Execução(Devolução)
	'146' - TRansferencia de estoque

Utilizado na função Atendimento da prescrição
	'36x'  Atendimento da prescrição
Utilizado na função Atendimento dos lotes da prescrição - PDA
	'88 Atendimento lote palm web'

Utilizado na função Solicitação de compra:
	'913' Solicitação de compra considerando a quantidade mínima
	'913x' Solicitação de compra considerando multiplo

Utilizado na função Gestão de cirurgias - Parâmetro [44]
	'900' Gestão de cirurgias

Utilizado na função Atendimento do lote da prescrição
	'7029' Atendimento do lote da prescrição

Utilizado na função PDA - Atendimento da Requisição
	'389' PDA - Atendimento da Requisição
*/
retorno_qtade_w			double precision;
cd_estabelecimento_w		smallint;


BEGIN
cd_estabelecimento_w		:= coalesce(wheb_usuario_pck.get_cd_estabelecimento,1);

if (cd_opcao_p = '24') then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_execucao = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
end if;

if (cd_opcao_p = '24x') then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_execucao_dev = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
end if;

if (cd_opcao_p = '36') then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_prescricao = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
end if;

if (cd_opcao_p in ('919', '109')) then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_requisicao = 'S'
		order by cd_local_estoque) alias7 LIMIT 1;
end if;

if (cd_opcao_p in ('919x', '-109')) then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_requisicao_transf = 'S'
		order by cd_local_estoque) alias7 LIMIT 1;
end if;

if (cd_opcao_p = '36x') then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_prescricao_atend = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
end if;

if (cd_opcao_p = '88') then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_atend_lote_pda = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
end if;

if (cd_opcao_p = '146') then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_transf_estoque = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
end if;

if (cd_opcao_p = '913') then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_solic_compra = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
end if;

if (cd_opcao_p = '913x') then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_solic_compra_mult = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
end if;

if (cd_opcao_p = '900') then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	coalesce(ie_gestao_cirurgia,'N') = 'S'
		order by cd_local_estoque) alias7 LIMIT 1;
end if;

if (cd_opcao_p = '7029') then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	coalesce(ie_atend_lote,'N') = 'S'
		order by cd_local_estoque) alias7 LIMIT 1;
end if;

if (cd_opcao_p = '389') then
	select	max(qt_min_solicitacao)
	into STRICT	retorno_qtade_w
	from (	SELECT	coalesce(qt_minimo_multiplo_solic,0) qt_min_solicitacao
		from 	regra_solic_minima_mat
		where  	cd_material = cd_material_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	coalesce(cd_local_estoque,coalesce(cd_local_estoque_p,0)) = coalesce(cd_local_estoque_p,0)
		and	ie_atend_req_pda = 'S'
		order by cd_local_estoque) alias6 LIMIT 1;
end if;

return	retorno_qtade_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qdade_regra_solic ( cd_material_p bigint, cd_local_estoque_p bigint, cd_opcao_p text) FROM PUBLIC;

