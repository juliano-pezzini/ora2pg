-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_titulo_nf (nr_sequencia_nf_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(1) := 'N';
nr_titulo_w		titulo_pagar.nr_titulo%type;
ie_consistido_w		varchar(1) := 'N';
vl_saldo_titulo_w	titulo_receber.vl_saldo_titulo%type;
vl_titulo_w		titulo_receber.vl_titulo%type;
count_w			bigint;

C01 CURSOR FOR  -- Cursor para buscar todos os títulos a receber que estão vinculados a essa NF 
	SELECT	a.nr_titulo 
	from	titulo_receber a 
	where	a.nr_seq_nf_saida = nr_sequencia_nf_p;

BEGIN
 
if (nr_sequencia_nf_p > 0) then 
 
	open C01;
	loop 
	fetch C01 into	 
		nr_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		if ( ie_consistido_w = 'N' ) then 
		 
			select	a.vl_saldo_titulo, 
				a.vl_titulo 
			into STRICT	vl_saldo_titulo_w, 
				vl_titulo_w 
			from	titulo_receber a 
			where	a.nr_titulo = nr_titulo_w;
	 
			if ( vl_saldo_titulo_w <> vl_titulo_w ) then -- Consiste pois saldo é diferente do valor do titulo. 
				ds_retorno_w 	:= 'S';
				ie_consistido_w := 'S';
			else  
				select	count(*) 
				into STRICT	count_w 
				from	titulo_receber_liq a 
				where  a.nr_titulo = nr_titulo_w 
				and   a.vl_recebido > 0 
				and   not exists ( SELECT 1 
						   from  titulo_receber_liq x 
						   where x.nr_seq_liq_origem	= a.nr_sequencia 
						   and  x.nr_titulo		= a.nr_titulo ) 
				and   coalesce(a.nr_seq_liq_origem::text, '') = '';
				 
				if (count_w > 0) then --Possui baixas que não estão estornadas, deve consistir 
 
					ds_retorno_w 	:= 'S';
					ie_consistido_w := 'S';
				end if;
			end if;
		 
		end if;
		 
		end;
	end loop;
	close C01;
	 
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_titulo_nf (nr_sequencia_nf_p bigint) FROM PUBLIC;

