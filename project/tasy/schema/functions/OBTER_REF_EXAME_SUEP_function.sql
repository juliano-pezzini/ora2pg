-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ref_exame_suep (cd_pessoa_fisica_p text, nr_seq_exame_p bigint, qt_resultado_p bigint, nr_prescricao_p exame_lab_resultado.nr_prescricao%type, nr_seq_prescr_p exame_lab_result_item.nr_seq_prescr%type, nr_seq_resultado_p bigint default 0, nr_seq_lab_result_item_p bigint default 0) RETURNS varchar AS $body$
DECLARE

/*
Referencia = 0
Aceitavel = 1
Nao aceitavel = 2
*/
				
				
ds_retorno_w	varchar(255);
qt_idade_w		bigint;
ie_sexo_w		varchar(1);
ie_resultado_critico_w exame_lab_result_item.ie_resultado_critico%type;

c01 CURSOR FOR
SELECT	qt_minima, qt_maxima, ie_tipo_valor
from exame_lab_padrao
where nr_seq_exame = nr_seq_exame_p
and	qt_idade_w between coalesce(qt_idade_min, 0) and coalesce(qt_idade_max, 999)
and	((ie_sexo = ie_sexo_w) or (ie_sexo = '0') or (coalesce(ie_sexo::text, '') = ''))		
and ie_tipo_valor in (0, 1, 2);

BEGIN
  ds_retorno_w := 'thirdCell:#FFFFFF;';

  select 	coalesce(max(ie_resultado_critico),'N')
  into STRICT	ie_resultado_critico_w
  from exame_lab_result_item
  where nr_seq_resultado = nr_seq_resultado_p
  and nr_sequencia = nr_seq_lab_result_item_p;

  if (ie_resultado_critico_w = 'S') then
    return	'thirdCell:#FF0000;';
  end if;

  select 	coalesce(max(ie_resultado_critico),'N')
  into STRICT	ie_resultado_critico_w
  from 	exame_lab_resultado b,
      exame_lab_result_item a
  where	a.nr_seq_resultado = b.nr_seq_resultado
  and	b.nr_prescricao = nr_prescricao_p
  and	a.nr_seq_prescr = nr_seq_prescr_p;

  if (ie_resultado_critico_w = 'S') then
    return	'thirdCell:#FF0000;';
  else

    select	obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'A'),
        obter_sexo_pf(cd_pessoa_fisica_p, 'C')
    into STRICT	qt_idade_w,
        ie_sexo_w
;

    FOR reg IN c01 LOOP

      if (reg.ie_tipo_valor = 0) and (qt_resultado_p between reg.qt_minima and reg.qt_maxima) then
        ds_retorno_w := 'thirdCell:#FFFFFF;'; -- White
      elsif (reg.ie_tipo_valor = 1) and (qt_resultado_p between reg.qt_minima and reg.qt_maxima) then
        ds_retorno_w := 'thirdCell:#FFFF00;'; -- Yellow
      elsif (reg.ie_tipo_valor = 2) and (qt_resultado_p between reg.qt_minima and reg.qt_maxima) then	
        ds_retorno_w := 'thirdCell:#FF0000;'; -- Red
      end if;

    END LOOP;

  end if;

  return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ref_exame_suep (cd_pessoa_fisica_p text, nr_seq_exame_p bigint, qt_resultado_p bigint, nr_prescricao_p exame_lab_resultado.nr_prescricao%type, nr_seq_prescr_p exame_lab_result_item.nr_seq_prescr%type, nr_seq_resultado_p bigint default 0, nr_seq_lab_result_item_p bigint default 0) FROM PUBLIC;

