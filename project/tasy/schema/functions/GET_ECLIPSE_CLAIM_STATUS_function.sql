-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_eclipse_claim_status ( nr_interno_conta_w dva_claim.nr_interno_conta%type, ie_option_p text) RETURNS varchar AS $body$
 -- we can either check the 'claim' status or the 'report' status 
DECLARE



ds_interface_system_w            varchar(50);


/*ECLIPSE*/

result_w                eclipse_status_codes.ds_code%type;
status_display_w        varchar(50);
claim_status_w          dva_claim.ie_status%type;
nr_seq_transaction_w    dva_claim.nr_seq_transaction%type;
report_status_w         dvr_request.ie_status%type;
cd_response_code_w	ihc_claim.cd_response_code%type;
cd_status_w		ihc_response.cd_status%type;

/*DC*/

ie_response_w           varchar(3);
ie_era_w                smallint;
nr_invoice_w            varchar(50);
ie_patient_claim_w      smallint;
ie_status_tasy_w 	varchar(1);


BEGIN

ds_interface_system_w        :=        get_integration_system;

if (ds_interface_system_w = 'ECLIPSE') then
	if (get_eclipse_claim_type(nr_interno_conta_w) = 'DVA') then
		-- check which type of message we should be calling
		select	coalesce(max(a.ie_status),'XPO'),
				coalesce(max(a.nr_seq_transaction),'0')
		into STRICT    claim_status_w,
				nr_seq_transaction_w
		from    dva_claim a
		where   a.nr_sequencia = (SELECT    max(x.nr_sequencia)
								from        dva_claim x
								where       x.nr_interno_conta = nr_interno_conta_w)  LIMIT 1;

		select	coalesce(max(a.ie_status),'XPO')
		into STRICT    report_status_w
		from    dvr_request a,
				convenio_retorno_item b,
				dva_claim c
		where   c.nr_seq_transaction = nr_seq_transaction_w
		and     c.nr_seq_transaction = a.nr_seq_transaction
		and     c.nr_interno_conta = b.nr_interno_conta  LIMIT 1;

		if (ie_option_p = 'CLAIM') then
			if (coalesce(claim_status_w,'XPO') = 'XPO') then
					status_display_w := '11';  -- pending
			elsif (claim_status_w = '0') then
					status_display_w := '12';  -- completed
			else
					status_display_w := '10';  -- underprocessing
			end if;
		elsif ( ie_option_p = 'REPORT' ) then
			if (coalesce(report_status_w,'XPO') = 'XPO') then
				status_display_w := '11';  -- pending
			elsif (report_status_w = '0')             then
				status_display_w := '12';  -- completed
			else
                status_display_w := '10';  -- underprocessing
			end if;
		end if;
	elsif (get_eclipse_claim_type(nr_interno_conta_w) = 'DBS') then
		-- check which type of message we should be calling
		select	coalesce(max(a.ie_status),'XPO'),
				coalesce(max(a.nr_seq_transaction),'0')
		into STRICT    claim_status_w,
				nr_seq_transaction_w
		from    dbs_claim a
		where   a.nr_sequencia = (SELECT    max(x.nr_sequencia)
								from        dbs_claim x
								where       x.nr_seq_account = nr_interno_conta_w)  LIMIT 1;

		select	coalesce(max(c.ie_status),'XPO')
		into STRICT    report_status_w
		from    dpr_request a,
				convenio_retorno_item b,
				dbs_claim c
		where   c.nr_seq_transaction = nr_seq_transaction_w
		and     c.nr_seq_transaction = a.nr_seq_transaction
		and     c.nr_seq_account = b.nr_interno_conta  LIMIT 1;

		if (ie_option_p = 'CLAIM') then
			if (coalesce(claim_status_w,'XPO') = 'XPO') then
					status_display_w := '11';  -- pending
			elsif (claim_status_w = '0') then
					status_display_w := '12';  -- completed
			else
					status_display_w := '10';  -- underprocessing
			end if;
		elsif ( ie_option_p = 'REPORT' ) then
			if (coalesce(report_status_w,'XPO') = 'XPO') then
				status_display_w := '11';  -- pending
			elsif (report_status_w = '0')             then
				status_display_w := '12';  -- completed
			else
                status_display_w := '10';  -- underprocessing
			end if;
		end if;
	elsif (get_eclipse_claim_type(nr_interno_conta_w) = 'IHC') then
		if (ie_option_p = 'CLAIM') then
			select	coalesce(max(cd_response_code),'X')
			into STRICT	cd_response_code_w
			from	ihc_claim
			where	nr_account	= nr_interno_conta_w;
			
			if (cd_response_code_w = 'X') then
				status_display_w	:= '11'; -- Pending
			elsif (cd_response_code_w in ('0','1716','3040')) then	
				status_display_w	:= '12'; -- Completed
			else
				status_display_w	:= '10';  -- underprocessing
			end if;
		elsif (ie_option_p = 'REPORT') then
			select 	max(ie_status_tasy)
			into STRICT 	ie_status_tasy_w
			from 	ihc_claim
			where 	nr_account = nr_interno_conta_w;

			if (ie_status_tasy_w = 'S') then
				status_display_w := '10';
			else
				select	coalesce(max(CD_STATUS),'X')
				into STRICT	cd_status_w
				from	ihc_claim		b,
						ihc_response	a
				where	a.nr_seq_claim	= b.nr_sequencia
				and		b.nr_account	= nr_interno_conta_w
				and		b.nr_sequencia	= (SELECT max(c.nr_sequencia) from ihc_claim c where c.nr_account = b.nr_account);
			
				if (cd_status_w = 'X') then
						status_display_w := '11'; -- Pending
				elsif (cd_status_w = '0') then
						status_display_w := '12'; -- Completed
				else
						status_display_w := '10';
				end if;		
			end if;
		end if;
	elsif (get_eclipse_claim_type(nr_interno_conta_w) = 'IMC') then
		select	coalesce(max(a.IE_STATUS_TASY),'XPO'),
			coalesce(max(a.NR_SEQ_TRANSACTION),'0')
		into STRICT    claim_status_w,
			nr_seq_transaction_w
		from    imc_claim a
		where   a.nr_sequencia = (SELECT    max(x.nr_sequencia)
								from        imc_claim x
								where       x.NR_SEQ_ACCOUNT = nr_interno_conta_w)  LIMIT 1;

		select	coalesce(max(c.IE_STATUS_TASY),'XPO')
		into STRICT    report_status_w
		from    imc_response a,
				convenio_retorno_item b,
				imc_claim c
		where   c.nr_seq_transaction = nr_seq_transaction_w
		and     c.nr_seq_transaction = a.CD_TRANSACTION
		and     c.nr_seq_account = b.nr_interno_conta  LIMIT 1;

		if (ie_option_p = 'CLAIM') then
			if    ((coalesce(claim_status_w,'XPO') = 'XPO') or  claim_status_w in ('0')) then
					status_display_w := '11';  -- pending
			elsif (claim_status_w in ('1716')) then
					status_display_w := '12';  -- completed
			else
					status_display_w := '10';  -- underprocessing
			end if;
		elsif ( ie_option_p = 'REPORT' ) then
			if (coalesce(report_status_w,'XPO') = 'XPO') then
				status_display_w := '11';  -- pending
			elsif (report_status_w in ('0','1716'))             then
				status_display_w := '12';  -- completed
			else
                status_display_w := '10';  -- underprocessing
			end if;
		end if;	

    elsif (get_eclipse_claim_type(nr_interno_conta_w) = 'OVS') then
		select	coalesce(max(a.IE_STATUS_TASY),'XPO'),
			coalesce(max(a.NR_SEQ_TRANSACTION),'0')
		into STRICT    claim_status_w,
			nr_seq_transaction_w
		from    OVS_CLAIM a
		where   a.nr_sequencia = (SELECT    max(x.nr_sequencia)
								from        OVS_CLAIM x
								where       x.NR_SEQ_ACCOUNT = nr_interno_conta_w)  LIMIT 1;

--		select	nvl(max(c.IE_STATUS_TASY),'XPO')
--		into    report_status_w
--		from    imc_response a,
--				convenio_retorno_item b,
--				imc_claim c
--		where   c.nr_seq_transaction = nr_seq_transaction_w
--		and     c.nr_seq_transaction = a.CD_TRANSACTION
--		and     c.nr_seq_account = b.nr_interno_conta
--		and     rownum = 1;
		if (ie_option_p = 'CLAIM') then
			if (coalesce(claim_status_w,'XPO') = 'XPO') then
					status_display_w := '11';  -- pending
			elsif (claim_status_w in ('0','1716')) then
					status_display_w := '12';  -- completed
			else
					status_display_w := '10';  -- underprocessing
			end if;
		elsif ( ie_option_p = 'REPORT' ) then
			if (coalesce(report_status_w,'XPO') = 'XPO') then
				status_display_w := '11';  -- pending
			elsif (report_status_w = '0')             then
				status_display_w := '12';  -- completed
			else
                status_display_w := '10';  -- underprocessing
			end if;
		end if;	

	
	end if;

	if (status_display_w IS NOT NULL AND status_display_w::text <> '') then
		-- fetch the display code
		select	max(a.ds_code)
		into STRICT    result_w
		from    eclipse_status_codes a
		where   a.cd_code = status_display_w  LIMIT 1;
	end if;

elsif (ds_interface_system_w = 'Direct control') then
    select  coalesce(max(ie_response),'XPO')
    into STRICT    ie_response_w
    from    transmit_ihc_response
    where   nr_account = nr_interno_conta_w
    and     dt_response = (SELECT max(x.dt_response)
                            from    transmit_ihc_response x
                            where    x.nr_account = nr_interno_conta_w);

    select  coalesce(max(1),0)
    into STRICT    ie_patient_claim_w
    from    pci_claim
    where   nr_account = nr_interno_conta_w
    and     ie_account_paid = 'Y';

    if (ie_patient_claim_w <> 1) then
      select   obter_conversao_externa_int(null, 'CONTA_PACIENTE','CD_AUTORIZACAO',nr_interno_conta_w,'DC')
      into STRICT     nr_invoice_w
;

      select  coalesce(max(1),0)
      into STRICT    ie_era_w
      from    dc_era_report
      where   nr_invoice_id = nr_invoice_w;
   else
    ie_era_w := 1;
   end if;
	if (ie_option_p = 'CLAIM') then

      if (ie_response_w = 'XPO') then
          status_display_w := 'Pending';       -- pending / 11
      elsif (ie_era_w = 1) then
          status_display_w := 'Completed'; -- completed /12
      elsif (ie_response_w = 'N') then
          status_display_w    := 'Transmission failure';     -- Transmission failure / 1007
      elsif (ie_response_w = 'S') then
          status_display_w := 'Underprocessing';          -- underprocessing / 10
      end if;

	elsif ( ie_option_p = 'REPORT' ) then
		if (ie_era_w = 0) then
          status_display_w := 'Pending';          -- pending / 11
		elsif (ie_era_w = 1) then
          status_display_w := 'Completed';  -- completed /12
		end if;
	end if;

	result_w := status_display_w;
end if;

return result_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_eclipse_claim_status ( nr_interno_conta_w dva_claim.nr_interno_conta%type, ie_option_p text) FROM PUBLIC;

