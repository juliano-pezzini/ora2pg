-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_ibpt (ie_tipo_ibpt_p text, ie_tipo_retorno_p text, vl_entrada_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) RETURNS bigint AS $body$
DECLARE


vl_retorno_w		double precision;
pr_ibpt_mens_fed_w	pls_parametros.pr_ibpt_mens_fed%type;
pr_ibpt_mens_est_w	pls_parametros.pr_ibpt_mens_est%type;
pr_ibpt_mens_mun_w	pls_parametros.pr_ibpt_mens_mun%type;


/*
ie_tipo_ibpt_p
FED 	-	Federal
EST	-	Estadual
MUN	-	Municipal
TOTAL	-	Soma de todos os IBPT

ie_tipo_retorno_p
P	-	Percentual
V	-	Valor
*/
BEGIN

select	coalesce(max(pr_ibpt_mens_fed), 0),
	coalesce(max(pr_ibpt_mens_est), 0),
	coalesce(max(pr_ibpt_mens_mun), 0)
into STRICT	pr_ibpt_mens_fed_w,
	pr_ibpt_mens_est_w,
	pr_ibpt_mens_mun_w
from	pls_parametros
where	cd_estabelecimento = cd_estabelecimento_p;

if (ie_tipo_retorno_p = 'P') then
	if (ie_tipo_ibpt_p = 'FED') then
		vl_retorno_w	:= pr_ibpt_mens_fed_w;
	elsif (ie_tipo_ibpt_p = 'EST') then
		vl_retorno_w	:= pr_ibpt_mens_est_w;
	elsif (ie_tipo_ibpt_p = 'MUN') then
		vl_retorno_w	:= pr_ibpt_mens_mun_w;
	elsif (ie_tipo_ibpt_p = 'TOTAL') then
		vl_retorno_w	:= pr_ibpt_mens_fed_w + pr_ibpt_mens_est_w + pr_ibpt_mens_mun_w;
	end if;
elsif	(ie_tipo_retorno_p = 'V' AND vl_entrada_p IS NOT NULL AND vl_entrada_p::text <> '') then
	if (ie_tipo_ibpt_p = 'FED') then
		vl_retorno_w	:= round((vl_entrada_p/100) * pr_ibpt_mens_fed_w,2);
	elsif (ie_tipo_ibpt_p = 'EST') then
		vl_retorno_w	:= round((vl_entrada_p/100) * pr_ibpt_mens_est_w,2);
	elsif (ie_tipo_ibpt_p = 'MUN') then
		vl_retorno_w	:= round((vl_entrada_p/100) * pr_ibpt_mens_mun_w,2);
	elsif (ie_tipo_ibpt_p = 'TOTAL') then
		vl_retorno_w	:= round((vl_entrada_p/100) * (pr_ibpt_mens_fed_w + pr_ibpt_mens_est_w + pr_ibpt_mens_mun_w),2);
	end if;
end if;

return	coalesce(vl_retorno_w, 0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_ibpt (ie_tipo_ibpt_p text, ie_tipo_retorno_p text, vl_entrada_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

