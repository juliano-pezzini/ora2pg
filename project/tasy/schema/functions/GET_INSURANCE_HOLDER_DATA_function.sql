-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_insurance_holder_data ( cd_pessoa_fisica_p bigint, cd_convenio_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

  cd_pessoa_fisica_w pessoa_fisica.cd_pessoa_fisica%type                 := null;
  ds_ie_grau_dependencia_w varchar(255)                                 := null;
  ie_grau_dependencia_w pessoa_titular_convenio.ie_grau_dependencia%type := null;
  /* ie_opcao_p
  c - code
  l - relationship
  */
BEGIN
  if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (ie_opcao_p IS NOT NULL AND ie_opcao_p::text <> '') and (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '') then
    if (ie_opcao_p        = 'C') then
      begin
        select ie_grau_dependencia
        into STRICT ie_grau_dependencia_w
        from pessoa_titular_convenio
        where cd_pessoa_fisica = cd_pessoa_fisica_p
        and cd_convenio        = cd_convenio_p  LIMIT 1; -- limit to one line
      exception
      when others then -- if it returns an error, set the default value manually
        ie_grau_dependencia_w := null;
      end;
      if (ie_grau_dependencia_w in (2, 3, 9)) then
        begin
          select cd_pessoa_titular
          into STRICT cd_pessoa_fisica_w
          from pessoa_titular_convenio
          where cd_pessoa_fisica = cd_pessoa_fisica_p
          and cd_convenio        = cd_convenio_p  LIMIT 1; -- limit to one line
        exception
        when others then -- if it returns an error, set the default value manually
          cd_pessoa_fisica_w := null;
        end;
        if (coalesce(cd_pessoa_fisica_w::text, '') = '') then
          begin
            select cd_pessoa_fisica
            into STRICT cd_pessoa_fisica_w
            from pessoa_titular_convenio
            where cd_pessoa_fisica = cd_pessoa_fisica_p
            and cd_convenio        = cd_convenio_p  LIMIT 1; -- limit to one line
          exception
          when others then -- if it returns an error, set the default value manually
            cd_pessoa_fisica_w := null;
          end;
        end if;
      elsif (ie_grau_dependencia_w = 1) then
        begin
          select cd_pessoa_fisica
          into STRICT cd_pessoa_fisica_w
          from pessoa_titular_convenio
          where cd_pessoa_fisica = cd_pessoa_fisica_p
          and cd_convenio        = cd_convenio_p  LIMIT 1; -- limit to one line
        exception
        when others then -- if it returns an error, set the default value manually
          cd_pessoa_fisica_w := null;
        end;
      end if;
      return cd_pessoa_fisica_w;
    elsif (ie_opcao_p = 'L') then
      begin
        select ie_grau_dependencia
        into STRICT ie_grau_dependencia_w
        from pessoa_titular_convenio
        where cd_pessoa_fisica = cd_pessoa_fisica_p
        and cd_convenio        = cd_convenio_p  LIMIT 1; -- limit to one line
      exception
      when others then -- if it returns an error, set the default value manually
        ie_grau_dependencia_w := null;
      end;
      begin
        select obter_valor_dominio_idioma(1034,ie_grau_dependencia_w,wheb_usuario_pck.get_nr_seq_idioma) ds
        into STRICT ds_ie_grau_dependencia_w
        from pessoa_titular_convenio
        where cd_pessoa_fisica = cd_pessoa_fisica_p
        and cd_convenio        = cd_convenio_p  LIMIT 1; -- limit to one line
      exception
      when others then -- if it returns an error, set the default value manually
        ds_ie_grau_dependencia_w := null;
      end;
      return ds_ie_grau_dependencia_w;
    end if;
  end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_insurance_holder_data ( cd_pessoa_fisica_p bigint, cd_convenio_p bigint, ie_opcao_p text) FROM PUBLIC;

