-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_periodo_os ( nr_seq_ordem_serv_p bigint) RETURNS varchar AS $body$
DECLARE


dt_inicio_w			timestamp;
dt_termino_w			timestamp;
total_horas_w			bigint;
ds_retorno_w			varchar(30);
percentual_w			bigint;
total_horas_percorridas_w	bigint;
ds_teste_w			varchar(255);


BEGIN

select	a.dt_termino_prev,
	a.dt_inicio_prev,
	dividir((100 * (((clock_timestamp() - a.DT_INICIO_PREV)*24))),(((a.DT_TERMINO_PREV - a.DT_INICIO_PREV)*24)))
into STRICT	dt_termino_w,
	dt_inicio_w,
	percentual_w
from  	man_ordem_serv_sla	a
where 	a.nr_seq_ordem	= nr_seq_ordem_serv_p;


if (percentual_w > 0 and percentual_w <= 25) then
	ds_retorno_w	:= 'G';
elsif (percentual_w between 26 and 75) then
	ds_retorno_w	:= 'W';
elsif (percentual_w between  76 and 100) then
	ds_retorno_w	:= 'C';
elsif (clock_timestamp() >  dt_termino_w )then
	ds_retorno_w	:= 'B';
end if;

return	ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_periodo_os ( nr_seq_ordem_serv_p bigint) FROM PUBLIC;

