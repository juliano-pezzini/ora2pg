-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION adep_obter_medic_comp (nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_dil_obs_w	varchar(2000);
ds_dil_w	varchar(2000);
ds_obs_med_w	varchar(4000);
ds_obs_enf_w	varchar(2000);
ds_obs_far_w	varchar(2000);
ds_comp_w	varchar(2000);
ds_dose_ml_w	varchar(80);
ie_agrupador_w	smallint;


BEGIN
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then

	select	
		substr(obter_desc_diluicao_medic_adep(nr_seq_item_p,nr_prescricao,nr_seq_horario_p),1,2000),
		substr(plt_obter_compostos(nr_prescricao, nr_sequencia, nr_agrupamento, 'M'),1,2000),
		ds_observacao,
		ds_observacao_enf,
		ds_observacao_far,
		substr(obter_conversao_ml(cd_material, qt_dose, cd_unidade_medida_dose),1,80),
		ie_agrupador
	into STRICT	ds_dil_w,
		ds_comp_w,
		ds_obs_med_w,
		ds_obs_enf_w,
		ds_obs_far_w,
		ds_dose_ml_w,
		ie_agrupador_w
	from	prescr_material
	where	nr_prescricao 	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;
	
	if (substr(ds_dose_ml_w,1,1) = ',') then
		ds_dose_ml_w	:= '0'||ds_dose_ml_w;
	end if;
	
	if (ds_dil_w IS NOT NULL AND ds_dil_w::text <> '') then
	
		ds_dil_obs_w := ds_dil_w;
		
	elsif (ds_dose_ml_w IS NOT NULL AND ds_dose_ml_w::text <> '') and (ds_dose_ml_w <> '0') and (ie_agrupador_w <> 12) and (ie_agrupador_w <> 1) then
	
		ds_dil_obs_w := wheb_mensagem_pck.get_texto(306812, 'DS_DOSE_ML_W=' || ds_dose_ml_w); -- Aspirar #@DS_DOSE_ML_W#@ ml
		
	end if;

	if (ds_comp_w IS NOT NULL AND ds_comp_w::text <> '') and (ie_agrupador_w <> 12) then
		
		if (ds_dil_obs_w IS NOT NULL AND ds_dil_obs_w::text <> '') then
			ds_dil_obs_w := substr(ds_dil_obs_w || chr(10) || wheb_mensagem_pck.get_texto(306813, null) || ds_comp_w,1,2000) || ';'; -- - ITENS COMPOSTOS: 
		else
			ds_dil_obs_w := substr( wheb_mensagem_pck.get_texto(306813, null) || ds_comp_w,1,2000) || ';'; -- - ITENS COMPOSTOS: 
		end if;	
		
	end if;		

end if;

return ds_dil_obs_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION adep_obter_medic_comp (nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint default null) FROM PUBLIC;

