-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_rotina_esp ( nr_sequencia_p bigint, ie_tipo_exame_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

/*
--------- Tipo Exame ----------------------
L - Exames
P - Procedimentos não laboratoriais
--------- Opção ---------------------------
Q - Quantidade
CP - Código Procedimento (Tipo de exame 'P')  --- se aplica somente se o item em questão tiver apenas um procedimento cadastrado
OP - Origem Procedimento (Tipo de exame 'P') --- se aplica somente se o item em questão tiver apenas um procedimento cadastrado
PI - Sequencia Procedimento Interno(Tipo de exame 'P') --- se aplica somente se o item em questão tiver apenas um procedimento cadastrado
*/
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_proc_interno_w	bigint;
qt_itens_w				bigint;
ds_retorno_w			varchar(255);

BEGIN
if (ie_tipo_exame_p = 'P') then
	select	count(*)
	into STRICT	qt_itens_w
	from	procedimento_rotina
	where	nr_seq_rotina = nr_sequencia_p;
else
	select	count(*)
	into STRICT	qt_itens_w
	from	exame_lab_rotina
	where	nr_seq_rotina = nr_sequencia_p;
end if;

if (ie_opcao_p = 'Q') then
	ds_retorno_w := qt_itens_w;
else
	select	max(cd_procedimento),
			max(ie_origem_proced),
			max(nr_proc_interno)
	into STRICT	cd_procedimento_w,
			ie_origem_proced_w,
			nr_seq_proc_interno_w
	from	procedimento_rotina
	where	nr_seq_rotina = nr_sequencia_p;
	if (ie_opcao_p = 'CP') and (ie_tipo_exame_p = 'P') and (qt_itens_w = 1) then
		ds_retorno_w := cd_procedimento_w;
	elsif (ie_opcao_p = 'OP') and (ie_tipo_exame_p = 'P') and (qt_itens_w = 1) then
		ds_retorno_w := ie_origem_proced_w;
	elsif (ie_opcao_p = 'PI') and (ie_tipo_exame_p = 'P') and (qt_itens_w = 1) then
		ds_retorno_w := nr_seq_proc_interno_w;
	end if;
end if;

return ds_retorno_w;
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_rotina_esp ( nr_sequencia_p bigint, ie_tipo_exame_p text, ie_opcao_p text) FROM PUBLIC;

