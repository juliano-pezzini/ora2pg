-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_ajuste_conta (nr_seq_ajuste_conta_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
/* 
FO	- Sequência da fatura original 
SP	- Status pagamento 
AC	- Análise da conta 
SEQP	- Sequência do pagador 
NP	- Nome do pagador 
SEQA 	- Sequência da análise 
VTC	- Valor original faturado da conta 
VAC	- Valor ajustado da conta (pls_conta_pos_estabelecido) 
VRF	- Valor refaturado 
SNF	- Sequência nova fatura 
NNF	- Número nova fatura 
NC	- Número da nova conta 
OBSNC 	- Observação da nova conta 
PRNC	- Protocolo da nova conta 
NCA	- Número da analise da nova conta 
*/
 
 
ds_retorno_w		varchar(4000) := '';
ie_situacao_w		varchar(255) := '';
nr_seq_conta_w		bigint;
nr_seq_pag_item_w	bigint;
nr_seq_pls_pag_prest_w	bigint;
nr_titulo_w		bigint;
nr_seq_analise_w	bigint;
nr_seq_lote_fatura_w	bigint;
nr_seq_fatura_orig_w	bigint;
nr_seq_ajuste_fatura_w	bigint;
nr_seq_pagador_w	bigint;

 

BEGIN 
 
if (ie_opcao_p	= 'FO') then 
 
	select	max(nr_seq_ajuste_fatura) 
	into STRICT	nr_seq_ajuste_fatura_w 
	from	pls_ajuste_fatura_conta 
	where	nr_sequencia	= nr_seq_ajuste_conta_p;
 
	select	max(nr_seq_fatura) 
	into STRICT	ds_retorno_w 
	from	pls_ajuste_fatura 
	where	nr_sequencia	= nr_seq_ajuste_fatura_w;
 
 
elsif (ie_opcao_p	= 'SEQP') then 
 
	select	max(nr_seq_ajuste_fatura) 
	into STRICT	nr_seq_ajuste_fatura_w 
	from	pls_ajuste_fatura_conta 
	where	nr_sequencia	= nr_seq_ajuste_conta_p;
 
	select	max(nr_seq_fatura) 
	into STRICT	nr_seq_fatura_orig_w 
	from	pls_ajuste_fatura 
	where	nr_sequencia	= nr_seq_ajuste_fatura_w;
 
	select	max(nr_seq_pagador) 
	into STRICT	ds_retorno_w 
	from	pls_fatura 
	where	nr_sequencia	= nr_seq_fatura_orig_w;
 
elsif (ie_opcao_p	= 'NP') then 
 
	select	max(nr_seq_ajuste_fatura) 
	into STRICT	nr_seq_ajuste_fatura_w 
	from	pls_ajuste_fatura_conta 
	where	nr_sequencia	= nr_seq_ajuste_conta_p;
 
	select	max(nr_seq_fatura) 
	into STRICT	nr_seq_fatura_orig_w 
	from	pls_ajuste_fatura 
	where	nr_sequencia	= nr_seq_ajuste_fatura_w;
 
	select	max(nr_seq_pagador) 
	into STRICT	nr_seq_pagador_w 
	from	pls_fatura 
	where	nr_sequencia	= nr_seq_fatura_orig_w;
 
	ds_retorno_w	:= pls_obter_dados_pagador(nr_seq_pagador_w,'NF');
 
elsif (ie_opcao_p	= 'AC') then 
 
	-- Obter a conta e a fatura original 
	select	max(nr_seq_conta), 
		max(nr_seq_fatura_orig) 
	into STRICT	nr_seq_conta_w, 
		nr_seq_fatura_orig_w 
	from	pls_ajuste_fatura_conta 
	where	nr_sequencia	= nr_seq_ajuste_conta_p;
 
	-- obter o lote da fatura original 
	select	max(nr_seq_lote) 
	into STRICT	nr_seq_lote_fatura_w 
	from	pls_fatura 
	where	nr_sequencia	= nr_seq_fatura_orig_w;
 
	-- obter a análise da conta pós estabelecido da conta original 
	select	max(nr_seq_analise) 
	into STRICT	nr_seq_analise_w 
	from	pls_conta_pos_estabelecido 
	where	nr_seq_conta	= nr_seq_conta_w 
	and	nr_seq_lote_fat	= nr_seq_lote_fatura_w 
	and	((ie_situacao		= 'A') or (coalesce(ie_situacao::text, '') = ''));
 
	ds_retorno_w		:= nr_seq_analise_w;
 
elsif (ie_opcao_p	= 'SP') then 
 
	ds_retorno_w		:= 'Em aberto';
 
	-- Obter a conta 
	select	max(nr_seq_conta) 
	into STRICT	nr_seq_conta_w 
	from	pls_ajuste_fatura_conta 
	where	nr_sequencia	= nr_seq_ajuste_conta_p;
 
	if (nr_seq_conta_w IS NOT NULL AND nr_seq_conta_w::text <> '') then -- Obter o pagamento item da conta 
		 
		select	max(nr_seq_pag_item) 
		into STRICT	nr_seq_pag_item_w 
		from	pls_conta_medica_resumo 
		where	nr_seq_conta		= nr_seq_conta_w 
		and	(nr_seq_pag_item IS NOT NULL AND nr_seq_pag_item::text <> '');
 
		if (nr_seq_pag_item_w IS NOT NULL AND nr_seq_pag_item_w::text <> '') then -- Obter o pagamento prestador do pagamento item 
			 
			select	max(nr_seq_pagamento) 
			into STRICT	nr_seq_pls_pag_prest_w 
			from	pls_pagamento_item 
			where	nr_sequencia	= nr_seq_pag_item_w;
 
			if (nr_seq_pls_pag_prest_w IS NOT NULL AND nr_seq_pls_pag_prest_w::text <> '') then -- Obter o título do pagamento prestador 
 
				select	max(nr_titulo) 
				into STRICT	nr_titulo_w 
				from	titulo_pagar 
				where	nr_seq_pls_pag_prest	= nr_seq_pls_pag_prest_w;
 
				if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then 	-- Obter a situacao do titulo 
 
					select	max(ie_situacao) 
					into STRICT	ie_situacao_w 
					from	titulo_pagar 
					where	nr_titulo	= nr_titulo_w;
 
					if (ie_situacao_w = 'L') then 
						ds_retorno_w		:= 'Pago';
					end if;
				end if;
			end if;
		end if;
	end if;
elsif (ie_opcao_p	= 'SEQA') then 
	select	max(b.nr_seq_analise) 
	into STRICT	ds_retorno_w 
	from	pls_conta_pos_estabelecido b, 
		pls_ajuste_fatura_conta a 
	where	a.nr_seq_conta	= b.nr_seq_conta 
	and	((b.ie_situacao		= 'A') or (coalesce(b.ie_situacao::text, '') = '')) 
	and	coalesce(b.nr_seq_conta_rec::text, '') = '' 
	and	coalesce(b.nr_seq_disc_proc::text, '') = '' 
	and	coalesce(b.nr_seq_disc_mat::text, '') = '' 
	and	a.nr_sequencia	= nr_seq_ajuste_conta_p;
elsif (ie_opcao_p	= 'VTC') then 
	select	coalesce(max(b.vl_faturado),0)+coalesce(max(b.vl_faturado_ndc),0) 
	into STRICT	ds_retorno_w 
	from	pls_fatura_evento d, 
		pls_ajuste_fatura c, 
		pls_fatura_conta b, 
		pls_ajuste_fatura_conta a 
	where	a.nr_seq_conta		= b.nr_seq_conta 
	and	a.nr_seq_ajuste_fatura	= c.nr_sequencia 
	and	d.nr_sequencia		= b.nr_seq_fatura_evento 
	and	d.nr_seq_fatura		= c.nr_seq_fatura 
	and	a.nr_sequencia		= nr_seq_ajuste_conta_p;
elsif (ie_opcao_p	= 'VAC') then 
	select	coalesce(sum(b.vl_beneficiario),0) 
	into STRICT	ds_retorno_w 
	from	pls_conta_pos_estabelecido b, 
		pls_ajuste_fatura_conta a 
	where	a.nr_seq_conta	= b.nr_seq_conta 
	and	a.nr_sequencia	= nr_seq_ajuste_conta_p 
	and	((b.ie_situacao		= 'A') or (coalesce(b.ie_situacao::text, '') = '')) 
	and	b.ie_status_faturamento in ('L','P');
elsif (ie_opcao_p in ('VRF','SNF','NNF')) then 
	select	CASE WHEN ie_opcao_p='VRF' THEN coalesce(max(c.vl_faturado),0)+coalesce(max(c.vl_faturado_ndc),0) WHEN ie_opcao_p='SNF' THEN max(e.nr_sequencia) WHEN ie_opcao_p='NNF' THEN max(e.nr_fatura) END  
	into STRICT	ds_retorno_w 
	from	pls_fatura e, 
		pls_fatura_evento d, 
		pls_fatura_conta c, 
		pls_conta_pos_estabelecido b, 
		pls_ajuste_fatura_conta a 
	where	d.nr_sequencia	= c.nr_seq_fatura_evento 
	and	d.nr_seq_fatura	= e.nr_sequencia 
	and	c.nr_seq_conta	= b.nr_seq_conta 
	and	a.nr_seq_conta	= b.nr_seq_conta 
	and	a.nr_sequencia	= nr_seq_ajuste_conta_p 
	and	((b.ie_situacao		= 'A') or (coalesce(b.ie_situacao::text, '') = '')) 
	and	coalesce(e.ie_cancelamento::text, '') = '' 
	and	(e.nr_titulo IS NOT NULL AND e.nr_titulo::text <> '');
elsif (ie_opcao_p	= 'NC') then 
	select	max(nr_sequencia) 
	into STRICT	ds_retorno_w 
	from	pls_conta 
	where	nr_seq_ajuste_fat	= nr_seq_ajuste_conta_p;
elsif (ie_opcao_p	= 'OBSNC') then 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_conta_w 
	from	pls_conta 
	where	nr_seq_ajuste_fat	= nr_seq_ajuste_conta_p;
 
	select	max(ds_observacao) 
	into STRICT	ds_retorno_w 
	from	pls_conta 
	where	nr_sequencia	= nr_seq_conta_w;
elsif (ie_opcao_p	= 'PRNC') then 
	select	max(nr_seq_protocolo) 
	into STRICT	ds_retorno_w 
	from	pls_conta 
	where	nr_seq_ajuste_fat	= nr_seq_ajuste_conta_p;
	 
elsif (ie_opcao_p	= 'NCA') then 
	select	max(nr_sequencia) 
	into STRICT	ds_retorno_w 
	from	pls_conta 
	where	nr_seq_ajuste_fat	= nr_seq_ajuste_conta_p;
	 
	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then 
		select	max(b.nr_seq_analise) 
		into STRICT	ds_retorno_w 
		from	pls_conta_pos_estabelecido b 
		where	b.nr_seq_conta	= ds_retorno_w;
	end if;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_ajuste_conta (nr_seq_ajuste_conta_p bigint, ie_opcao_p text) FROM PUBLIC;

