-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_infor_hor_prescr (nr_atendimento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE



dt_horario_w		timestamp;
dt_horario_ant_w	timestamp := to_date('01/01/2000','dd/mm/yyyy');
ie_situacao_w 		varchar(1);
dt_horarios_w		varchar(2000) := ' ';


C01 CURSOR FOR
SELECT	DISTINCT h.dt_horario,
		 CASE WHEN obter_status_hor_prescr(h.nr_sequencia,'M')='S' THEN '#' WHEN obter_status_hor_prescr(h.nr_sequencia,'M')='A' THEN '-' WHEN obter_status_hor_prescr(h.nr_sequencia,'M')='N' THEN '' END
FROM		 prescr_material a,
		 prescr_mat_hor h,
		 prescr_medica m
	WHERE	h.nr_prescricao = m.nr_prescricao
	AND	a.nr_prescricao = m.nr_prescricao
	AND	a.cd_material 	= h.cd_material
	AND	m.nr_atendimento = nr_atendimento_p
	AND	m.nr_prescricao = nr_prescricao_p
	AND	coalesce(a.ie_se_necessario,'N') = 'N'
	AND     a.nr_sequencia  = nr_sequencia_p
	AND	coalesce(a.ie_acm,'N') = 'N'
	AND	Obter_se_horario_liberado(h.dt_lib_horario, h.dt_horario) = 'S';


BEGIN
open c01;
loop
fetch c01 into
	dt_horario_w,
	ie_situacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	if (trunc(dt_horario_ant_w) <> trunc(dt_horario_w)) then

		dt_horarios_w := dt_horarios_w || chr(13) || chr(10) || '  ' || replace(to_char(dt_horario_w,'dd/mm hh24:mi'),':00','') || ' ' ||ie_situacao_w;
	else
		dt_horarios_w := dt_horarios_w ||'  ' ||  replace(to_char(dt_horario_w,'hh24:mi'),':00','') || ' ' || ie_situacao_w;
	end if;

	dt_horario_ant_w := dt_horario_w;

	end;
end loop;
close c01;

return	substr(dt_horarios_w,4,length(dt_horarios_w) - 3);



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_infor_hor_prescr (nr_atendimento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

