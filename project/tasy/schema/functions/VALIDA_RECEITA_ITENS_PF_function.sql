-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION valida_receita_itens_pf ( nr_seq_receita_p bigint, tp_receita_p text, nm_usuario_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(1);
cd_receita_especial_w	varchar(1);
qt_itens_w		bigint := 0;


BEGIN

cd_receita_especial_w := obter_valor_param_usuario(10015, 114, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);

if	((nr_seq_receita_p IS NOT NULL AND nr_seq_receita_p::text <> '') and (tp_receita_p IS NOT NULL AND tp_receita_p::text <> '') and (cd_receita_especial_w IS NOT NULL AND cd_receita_especial_w::text <> '')) then

	-- Receita atual é receita especial, exige apenas medicamentos especiais
	if (tp_receita_p = cd_receita_especial_w) then
		SELECT 	COUNT(*)		-- Se > 0 entao não validou itens;
		into STRICT	qt_itens_w
		FROM	fa_receita_farmacia_item a,
			material b
		WHERE 	a.cd_material = b.cd_material
		AND   	a.nr_seq_receita = nr_seq_receita_p
		AND   	coalesce(b.ie_receita,'N') = 'N';
	else
		SELECT 	COUNT(*)		-- Se > 0 entao não validou itens;
		into STRICT	qt_itens_w
		FROM	fa_receita_farmacia_item a,
			material b
		WHERE 	a.cd_material = b.cd_material
		AND   	a.nr_seq_receita = nr_seq_receita_p
		AND   	coalesce(b.ie_receita,'N') = 'S';
	end if;
end if;

if (qt_itens_w > 0) then
	ie_retorno_w := 'N';	-- Não validou itens
else
	ie_retorno_w := 'S';	-- Validou itens
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION valida_receita_itens_pf ( nr_seq_receita_p bigint, tp_receita_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

