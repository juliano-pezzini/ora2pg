-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_adic_ap_lote ( cd_material_p bigint, nr_sequencia_p bigint, nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


cd_codigo_inf_adic_w		bigint;
cd_local_estoque_w		smallint;
cd_unidade_medida_w		varchar(30);
qt_dose_w			double precision;
cd_unidade_medida_dose_w	varchar(30);
ie_via_aplicacao_w		varchar(5);
ie_acm_w			varchar(1);
ds_acm_w			varchar(10);
ie_se_necessario_w		varchar(1);
ds_se_necessario_w		varchar(10);
ie_urgencia_w			varchar(1);
ds_urgencia_w			varchar(10);
nr_prescricao_w			bigint;
cd_intervalo_w			varchar(7);
ds_horarios_w			varchar(2000);
ds_justificativa_w		varchar(2000);
ds_observacao_w			varchar(4000);
qt_existe_w			integer;
ds_horarios_sol_w		varchar(2000);
ds_kit_material_w		varchar(255);
ds_doctor_name_w		varchar(255);
ie_pais_w	valor_dominio.vl_dominio%type;

ds_informacao_w			varchar(4000) := '';
sim_w				varchar(10) := wheb_mensagem_pck.get_texto(314261);
nao_w				varchar(10) := wheb_mensagem_pck.get_texto(314263);

c01 CURSOR FOR
	SELECT	cd_codigo_inf_adic
	from	regra_inf_lote_prescr
	where	cd_estabelecimento = cd_estabelecimento_p
	order by 1;


BEGIN

begin
	ie_pais_w	:=	coalesce(pkg_i18n.get_user_locale, 'pt_BR');
exception when others then
	ie_pais_w := 'pt_BR';
end;


if (ie_pais_w = 'en_AU') then
select	coalesce(max(coalesce(h.cd_local_estoque,p.cd_local_estoque)),0),
	coalesce(max(h.cd_unidade_medida),'0'),
	coalesce(max(h.qt_dose),0),
	coalesce(max(h.cd_unidade_medida_dose),'0'),
	coalesce(max(p.ie_via_aplicacao),'0'),
	coalesce(max(p.ie_acm),'0'),
	coalesce(max(p.ie_se_necessario),'0'),
	coalesce(max(p.ie_urgencia),'0'),
	coalesce(max(p.nr_prescricao),0),
	coalesce(max(p.cd_intervalo),'0'),
	coalesce(max(p.ds_horarios),'0'),
	-- nvl(max(p.ds_justificativa),'0'),
	coalesce(max(c.DS_JUSTIFICATIVA),'0'),
	coalesce(max(p.ds_observacao),'0'),
	coalesce(max(substr(obter_desc_kit(p.cd_kit_material),1,100)),'0')
into STRICT	cd_local_estoque_w,
	cd_unidade_medida_w,
	qt_dose_w,
	cd_unidade_medida_dose_w,
	ie_via_aplicacao_w,
	ie_acm_w,
	ie_se_necessario_w,
	ie_urgencia_w,
	nr_prescricao_w,
	cd_intervalo_w,
	ds_horarios_w,
	ds_justificativa_w,
	ds_observacao_w,
	ds_kit_material_w
from	prescr_mat_hor h,
	prescr_material p,
	cpoe_material c
where	h.nr_seq_lote = nr_seq_lote_p
and	p.nr_sequencia = nr_sequencia_p
and	h.nr_prescricao = p.nr_prescricao
and	h.nr_seq_material = p.nr_sequencia
and c.nr_sequencia = p.nr_seq_mat_cpoe
and c.cd_material = p.cd_material;

else
select	coalesce(max(coalesce(h.cd_local_estoque,p.cd_local_estoque)),0),
	coalesce(max(h.cd_unidade_medida),'0'),
	coalesce(max(h.qt_dose),0),
	coalesce(max(h.cd_unidade_medida_dose),'0'),
	coalesce(max(p.ie_via_aplicacao),'0'),
	coalesce(max(p.ie_acm),'0'),
	coalesce(max(p.ie_se_necessario),'0'),
	coalesce(max(p.ie_urgencia),'0'),
	coalesce(max(p.nr_prescricao),0),
	coalesce(max(p.cd_intervalo),'0'),
	coalesce(max(p.ds_horarios),'0'),
	coalesce(max(p.ds_justificativa),'0'),
	coalesce(max(p.ds_observacao),'0'),
	coalesce(max(substr(obter_desc_kit(p.cd_kit_material),1,100)),'0')
into STRICT	cd_local_estoque_w,
	cd_unidade_medida_w,
	qt_dose_w,
	cd_unidade_medida_dose_w,
	ie_via_aplicacao_w,
	ie_acm_w,
	ie_se_necessario_w,
	ie_urgencia_w,
	nr_prescricao_w,
	cd_intervalo_w,
	ds_horarios_w,
	ds_justificativa_w,
	ds_observacao_w,
	ds_kit_material_w
from	prescr_mat_hor h,
	prescr_material p
where	h.nr_seq_lote = nr_seq_lote_p
and	p.nr_sequencia = nr_sequencia_p
and	h.nr_prescricao = p.nr_prescricao
and	h.nr_seq_material = p.nr_sequencia;
end if;

select	coalesce(max(s.ds_horarios),'0')
into STRICT	ds_horarios_sol_w
from	prescr_solucao s,
	prescr_mat_hor h,
	prescr_material p
where	h.nr_seq_lote = nr_seq_lote_p
and	p.nr_sequencia = nr_sequencia_p
and	s.nr_prescricao = p.nr_prescricao
and	s.nr_seq_solucao = p.nr_sequencia_solucao
and	h.nr_prescricao = p.nr_prescricao
and	h.nr_seq_material = p.nr_sequencia;

select	OBTER_NOME_MEDICO(p.CD_MEDICO,'ps')
into STRICT	ds_doctor_name_w
from	prescr_mat_hor h,
	prescr_medica p
where	h.nr_seq_lote = nr_seq_lote_p
and	h.nr_prescricao = p.nr_prescricao  LIMIT 1;

select	count(*)
into STRICT	qt_existe_w
from	regra_inf_lote_prescr
where	cd_estabelecimento = cd_estabelecimento_p
order by 1;

if (qt_existe_w > 0) then

	open c01;
	loop
	fetch c01 into
		cd_codigo_inf_adic_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		if (cd_codigo_inf_adic_w = 1) then
			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314267)||': '|| substr(obter_desc_mat_generico(cd_material_p),1,120) || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 2) and (cd_local_estoque_w > 0) then
			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314273)||': '|| substr(obter_localizacao_material(cd_material_p,cd_local_estoque_w),1,100) || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 3) and (cd_unidade_medida_w <> '0') then
			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314294)||': '|| substr(obter_unidade_medida_mat(cd_unidade_medida_w, cd_material_p),1,120) || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 4) and (qt_dose_w > 0) then
			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314295)||': ' || qt_dose_w || cd_unidade_medida_dose_w ||  ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 5) and (ie_via_aplicacao_w <> '0') then
			ds_informacao_w := substr(ds_informacao_w ||wheb_mensagem_pck.get_texto(314296)||': ' || substr(obter_via_aplicacao(ie_via_aplicacao_w,'D'),1,120) || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 6) and (ie_acm_w <> '0') then

			select	CASE WHEN ie_acm_w='S' THEN sim_w  ELSE nao_w END
			into STRICT	ds_acm_w
			;

			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314297)||': ' || ds_acm_w || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 7) and (ie_se_necessario_w <> '0') then

			select	CASE WHEN ie_se_necessario_w='S' THEN sim_w  ELSE nao_w END
			into STRICT	ds_se_necessario_w
			;

			ds_informacao_w := substr(ds_informacao_w ||wheb_mensagem_pck.get_texto(314298)||': ' || ds_se_necessario_w || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 8) and (ie_urgencia_w <> '0') then

			select	CASE WHEN ie_urgencia_w='S' THEN sim_w  ELSE nao_w END
			into STRICT	ds_urgencia_w
			;

			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314300)||': ' || ds_urgencia_w || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 9) and (nr_prescricao_w > 0) then
			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314301)||': ' || substr(obter_diluicao_medic(nr_sequencia_p,nr_prescricao_w),1,900) || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 10) and (cd_intervalo_w <> '0') then
			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314302)||': ' || substr(obter_desc_intervalo(cd_intervalo_w),1,150) || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 11) and (ds_horarios_w <> '0') then
			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314303)||': ' || ds_horarios_w || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 15) and (ds_horarios_sol_w <> '0') then
			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314304)||': ' || ds_horarios_sol_w || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 12) and (nr_prescricao_w > 0) then
			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314307)||': ' || substr(obter_se_medic_lib_cih(nr_prescricao_w,nr_sequencia_p,nm_usuario_p),1,50) || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 13) then
			if (ds_justificativa_w <> '0') then
				ds_informacao_w := substr(ds_informacao_w ||wheb_mensagem_pck.get_texto(314309)||': ' || ds_justificativa_w || ';',1,4000);
			end if;
		
			if (ie_pais_w = 'en_AU') 	and (coalesce(nr_seq_lote_p,0) > 0) then
	
				select	max(ds_log)
				into STRICT	ds_justificativa_w
				from	ap_lote_historico
				where	nr_seq_lote = nr_seq_lote_p
				and 	ie_tipo_motivo 	= 'DM';
				
				if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
					ds_informacao_w := substr(ds_informacao_w ||obter_desc_expressao(608812)||': ' || ds_justificativa_w || ';',1,4000);
				end if;
			
			end if;

		elsif (cd_codigo_inf_adic_w = 14) and (ds_observacao_w <> '0') then
			ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314310)||': ' || ds_observacao_w || ';',1,4000);

		elsif (cd_codigo_inf_adic_w = 16) and (ds_kit_material_w <> '0') then
			ds_informacao_w	:= substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314311)||': '|| ds_kit_material_w,1,4000);

		elsif (cd_codigo_inf_adic_w = 17) and (ds_doctor_name_w <> '0') then
			ds_informacao_w	:= substr(ds_informacao_w || wheb_mensagem_pck.get_texto(1121689)||': '|| ds_doctor_name_w,1,4000);
		end if;

		end;
	end loop;
	close c01;

else

	ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314267)||': '|| substr(obter_desc_mat_generico(cd_material_p),1,120) || ';',1,4000);

	if (cd_local_estoque_w > 0) then
		ds_informacao_w := substr(ds_informacao_w ||wheb_mensagem_pck.get_texto(314273)||': '|| substr(obter_localizacao_material(cd_material_p,cd_local_estoque_w),1,100) || ';',1,4000);
	end if;

	if (cd_unidade_medida_w <> '0') then
		ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314294) ||': '|| substr(obter_unidade_medida_mat(cd_unidade_medida_w, cd_material_p),1,120) || ';',1,4000);
	end if;

	if (qt_dose_w > 0) then
		ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314295)||': ' || qt_dose_w || cd_unidade_medida_dose_w || ';',1,4000);
	end if;

	if (ie_via_aplicacao_w <> '0') then
		ds_informacao_w := substr(ds_informacao_w ||wheb_mensagem_pck.get_texto(314296)||': ' || substr(obter_via_aplicacao(ie_via_aplicacao_w,'D'),1,120) || ';',1,4000);
	end if;

	if (ie_acm_w <> '0') then
		select	CASE WHEN ie_acm_w='S' THEN sim_w  ELSE nao_w END
		into STRICT	ds_acm_w
		;

		ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314297)||': '|| ds_acm_w || ';',1,4000);
	end if;

	if (ie_se_necessario_w <> '0') then
		select	CASE WHEN ie_se_necessario_w='S' THEN sim_w  ELSE nao_w END
		into STRICT	ds_se_necessario_w
		;

		ds_informacao_w := substr(ds_informacao_w ||wheb_mensagem_pck.get_texto(314298)||': ' || ds_se_necessario_w || ';',1,4000);
	end if;

	if (ie_urgencia_w <> '0') then
		select	CASE WHEN ie_urgencia_w='S' THEN sim_w  ELSE nao_w END
		into STRICT	ds_urgencia_w
		;

		ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314300)||': '  || ds_urgencia_w || ';',1,4000);
	end if;

	if (nr_prescricao_w > 0) then
		ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314301)||': ' || substr(obter_diluicao_medic(nr_sequencia_p,nr_prescricao_w),1,900) || ';',1,4000);
	end if;

	if (cd_intervalo_w <> '0') then
		ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314302)||': ' ||substr(obter_desc_intervalo(cd_intervalo_w),1,150) || ';',1,4000);
	end if;

	if (ds_horarios_w <> '0') then
		ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314303)||': ' ||ds_horarios_w || ';',1,4000);
	end if;

	if (ds_horarios_sol_w <> '0') then
		ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314304)||': ' || ds_horarios_sol_w || ';',1,4000);
	end if;

	if (nr_prescricao_w > 0) then
		ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314307)||': ' || substr(obter_se_medic_lib_cih(nr_prescricao_w,nr_sequencia_p,nm_usuario_p),1,50) || ';',1,4000);
	end if;

	if (ds_justificativa_w <> '0') then
		ds_informacao_w := substr(ds_informacao_w ||wheb_mensagem_pck.get_texto(314309)||': '  || ds_justificativa_w || ';',1,4000);
	end if;

	if (ds_observacao_w <> '0') then
		ds_informacao_w := substr(ds_informacao_w || wheb_mensagem_pck.get_texto(314310)||': ' || ds_observacao_w || ';',1,4000);
	end if;

	if (ds_kit_material_w <> '0') then
		ds_informacao_w	:= substr(ds_informacao_w ||wheb_mensagem_pck.get_texto(314311)||': '|| ds_kit_material_w,1,4000);
	end if;

	if (ds_doctor_name_w <> '0') then
		ds_informacao_w	:= substr(ds_informacao_w ||wheb_mensagem_pck.get_texto(1121689)||': '|| ds_doctor_name_w,1,4000);
  end if;
end if;

return	ds_informacao_w;

end;
		
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_adic_ap_lote ( cd_material_p bigint, nr_sequencia_p bigint, nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

