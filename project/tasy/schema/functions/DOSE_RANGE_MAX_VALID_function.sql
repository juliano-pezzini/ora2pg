-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE Vetor AS (	qt_dose_total	double precision,
			dt_ult_horario	timestamp);


CREATE OR REPLACE FUNCTION dose_range_max_valid ( nr_seq_cpoe_p bigint, nr_prescricao_p bigint, qt_dose_adm_p bigint, dt_horario_adm_p timestamp, dt_aprazamento_p timestamp, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


dt_horario_anterior_w	timestamp		:= null;
indice_w		integer		:= 1;
ds_result_w		varchar(10)	:= 'S';
ie_validate_range_w	varchar(10)	:= 'S';
qt_soma_w		double precision	:= 0;
qt_interv_w		double precision;
qt_last_dose_w		cpoe_material.qt_dose_range_max%type;
qt_dose_range_max_w	cpoe_material.qt_dose_range_max%type;
nr_atendimento_w	cpoe_material.nr_atendimento%type;
cd_intervalo_w		cpoe_material.cd_intervalo%type;
cd_material_w		cpoe_material.cd_material%type;

C01 CURSOR FOR
	SELECT 	dt_horario,
		coalesce(obter_dose_adm_hor(nr_sequencia), qt_dose) qt_dose
	from	prescr_mat_hor
	where 	nr_atendimento 		= nr_atendimento_w
	and	cd_material 		= cd_material_w
	and 	coalesce(dt_suspensao::text, '') = ''
	and 	(dt_fim_horario IS NOT NULL AND dt_fim_horario::text <> '')
	and	ie_horario_especial	= 'N'
	order by dt_horario;

type doseMaximaVetor is table of Vetor index by integer;
Controle_Vetor_w		doseMaximaVetor;

	function interval_range_valid( 	qt_interv_p		bigint,
						dt_horario_atual_p	timestamp,
						dt_horario_anterior_p	timestamp) return text is

	ds_retorno_w	varchar(1) := 'N';
	qt_interv_hor_w	double precision;

	
BEGIN
	
	if (qt_interv_p > 0 and (dt_horario_anterior_p IS NOT NULL AND dt_horario_anterior_p::text <> '')) then
		qt_interv_hor_w	:= (dt_horario_atual_p - dt_horario_anterior_p) * 24;
			
		if (qt_interv_hor_w >= qt_interv_p) then
			ds_retorno_w	:= 'S';
		end if;

	end if;

	return ds_retorno_w;

	end;

begin

if (pkg_i18n.get_user_locale() = 'en_AU') then

	select	max(qt_dose_range_max),
		max(nr_atendimento),
		max(cd_material),
		max(cd_intervalo)
	into STRICT	qt_dose_range_max_w,
		nr_atendimento_w,
		cd_material_w,
		cd_intervalo_w
	from	cpoe_material
	where	nr_sequencia = nr_seq_cpoe_p;
	
	select	coalesce(max(ie_check_max_dose), 'N'),
		coalesce(max(obter_ocorrencia_intervalo(cd_intervalo,24,'H')), 0)
	into STRICT	ie_validate_range_w,
		qt_interv_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_w;
	
	if ((coalesce(dt_horario_adm_p::text, '') = '') and (coalesce(qt_dose_range_max_w::text, '') = '' or ie_validate_range_w = 'N')) then
		return 'N';
	end if;
	
	if (qt_dose_range_max_w IS NOT NULL AND qt_dose_range_max_w::text <> '') and (ie_validate_range_w = 'S') then
		
		select	max(qt_dose_adm)
		into STRICT	qt_last_dose_w
		from	prescr_mat_alteracao a
		where	a.nr_prescricao		= nr_prescricao_p
		and	a.cd_item		= cd_material_w
		and	a.ie_alteracao		= 3
		and	coalesce(a.ie_evento_valido,'S') = 'S'
		and	a.dt_alteracao	= (	SELECT	max(x.dt_alteracao)
						from	prescr_mat_alteracao x
						where	x.nr_prescricao 	= a.nr_prescricao
						and	x.nr_seq_prescricao 	= a.nr_seq_prescricao
						and	x.ie_alteracao		= 3
						and	x.dt_alteracao 		< dt_aprazamento_p
						and	x.cd_item		= a.cd_item
						and	coalesce(x.ie_evento_valido,'S') = 'S');
						
		if (qt_last_dose_w IS NOT NULL AND qt_last_dose_w::text <> '') and (qt_last_dose_w	>= qt_dose_range_max_w) then
			ds_result_w	:= 'N';
		else
		
			for r_c01 in c01 loop
				begin

				if (interval_range_valid(qt_interv_w, r_c01.dt_horario, dt_horario_anterior_w) = 'S') then
					qt_soma_w	:= 0;
					Controle_Vetor_w[indice_w].qt_dose_total := 0;
				end if;

				Controle_Vetor_w[indice_w].dt_ult_horario		:= r_c01.dt_horario;
				Controle_Vetor_w[indice_w].qt_dose_total		:= coalesce(Controle_Vetor_w[indice_w].qt_dose_total,0) + r_c01.qt_dose;
				
				qt_soma_w	:= qt_soma_w + r_c01.qt_dose;
				
				if (qt_soma_w	>= qt_dose_range_max_w) then
					qt_soma_w	:= 0;
					indice_w	:= indice_w + 1;
				end if;
				
				dt_horario_anterior_w := r_c01.dt_horario;
				
				end;
			end loop;

			if (Controle_Vetor_w.count	> 0) then

				indice_w	:= Controle_Vetor_w.count;

				if (coalesce(qt_dose_adm_p, 0) > 0) then
					if	((Controle_Vetor_w[indice_w].qt_dose_total + qt_dose_adm_p)	> qt_dose_range_max_w) and (interval_range_valid(qt_interv_w, dt_horario_adm_p, Controle_Vetor_w[indice_w].dt_ult_horario) = 'N')then
						ds_result_w	:= 'N';
					end if;
				elsif	((Controle_Vetor_w[indice_w].qt_dose_total)	>= qt_dose_range_max_w) then
					ds_result_w	:= 'N';
				end if;
			end if;
		end if;
		
	end if;
else
	ds_result_w	:= 'N';
end if;

return ds_result_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION dose_range_max_valid ( nr_seq_cpoe_p bigint, nr_prescricao_p bigint, qt_dose_adm_p bigint, dt_horario_adm_p timestamp, dt_aprazamento_p timestamp, nm_usuario_p text) FROM PUBLIC;

