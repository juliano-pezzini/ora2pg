-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_deleg_nutricao ( nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(2000);
ie_delegacao_total_w		varchar(1);
ie_dieta_oral_w			varchar(15);
ie_npt_w			varchar(15);
ie_enteral_w			varchar(15);
ie_suplemento_w			varchar(15);



BEGIN

select	coalesce(max(ie_delegacao_total),'N'),
	coalesce(max(ie_dieta_oral),'N'),
	coalesce(max(ie_npt),'N'),
	coalesce(max(ie_enteral),'N'),
	coalesce(max(ie_suplemento),'N')
into STRICT	ie_delegacao_total_w,
	ie_dieta_oral_w,
	ie_npt_w,
	ie_enteral_w,
	ie_suplemento_w
from	prescr_nutricao
where	nr_prescricao	= nr_prescricao_p;

if (ie_delegacao_total_w = 'S') then
	ds_retorno_w	:= wheb_mensagem_pck.get_texto(308099); -- O médico delega a equipe de nutrição a prescrição de todas as dietas.
else
	begin
	if (ie_dieta_oral_w = 'D') then
		ds_retorno_w	:= ' ' || wheb_mensagem_pck.get_texto(308101) ||','; -- Dieta oral
	end if;
	if (ie_suplemento_w = 'D') then
		ds_retorno_w	:= ds_retorno_w || ' ' || wheb_mensagem_pck.get_texto(308103) ||','; -- Suplemento oral
	end if;

	if (ie_enteral_w = 'D') then
		ds_retorno_w	:= ds_retorno_w || ' ' || wheb_mensagem_pck.get_texto(308104) || ','; -- Dieta enteral
	end if;

	if (ie_npt_w = 'D') then
		ds_retorno_w	:= ds_retorno_w || ' ' || wheb_mensagem_pck.get_texto(308105) || ','; -- NPT
	end if;

	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		ds_retorno_w	:= wheb_mensagem_pck.get_texto(308106, 'DS_DIETAS=' || substr(ds_retorno_w,1,length(ds_retorno_w)-1));
						-- O médico delega a equipe de nutrição a prescrição das seguintes dietas: #@DS_DIETAS#@
	end if;
	end;
end if;

RETURN ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_deleg_nutricao ( nr_prescricao_p bigint) FROM PUBLIC;

