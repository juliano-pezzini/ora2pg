-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_prof_escala_dia (cd_dia_p text, cd_mes_p text, cd_ano_p text, cd_profissional_p text, nr_seq_escala_p text, cd_estabelecimento_p bigint, ie_parametro_p text) RETURNS varchar AS $body$
DECLARE


ie_pertence_w		varchar(25);
dt_escala_w		varchar(15);
ds_cor_padrao_w		varchar(15);


BEGIN

select	cd_dia_p||'/'||cd_mes_p||'/'||cd_ano_p
into STRICT	dt_escala_w
;

select	max(ds_cor_fundo)
into STRICT	ds_cor_padrao_w
from	tasy_padrao_cor
where	nr_sequencia = 2072;

if (ie_parametro_p = 'S') and
	((obter_cod_dia_Semana(to_date(dt_escala_w,'dd/mm/yyyy')) in (1,7)) or (obter_se_feriado(cd_estabelecimento_p,to_date(dt_escala_w,'dd/mm/yyyy')) > 0)) then
	ie_pertence_w	:= ds_cor_padrao_w;
else
	begin
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'X' END
	into STRICT	ie_pertence_w
	from	escala_diaria d,
		escala_grupo g,
		escala_classif c,
		escala	e,
		escala_diaria_adic f
	where	c.nr_sequencia = g.nr_seq_classif
	and	g.nr_sequencia = e.nr_seq_grupo
	and	e.nr_sequencia = d.nr_seq_escala
	and	f.nr_seq_escala_diaria = d.nr_sequencia
	and     obter_tipo_classif_escala(e.nr_sequencia)  in ('S','L')
	and	trunc(dt_inicio) = dt_escala_w
	and	f.cd_pessoa_fisica = cd_profissional_p
	and	e.nr_sequencia = nr_seq_escala_p
	and	not exists (SELECT 	1
			    from	escala_afastamento_prof a,
					motivo_afast_escala b
			    where	a.nr_seq_motivo_afast = b.nr_sequencia
			    and		a.cd_profissional = cd_profissional_p
			    and		((a.nr_seq_escala = nr_seq_escala_p) or (coalesce(a.nr_seq_escala::text, '') = ''))
			    and		dt_escala_w between trunc(a.dt_inicio) and trunc(a.dt_final));

	if (ie_pertence_w = 'N') then

			select	CASE WHEN count(*)=0 THEN ''  ELSE b.ds_cor END
			into STRICT	ie_pertence_w
			from	escala_afastamento_prof a,
				motivo_afast_escala b
			where	a.nr_seq_motivo_afast = b.nr_sequencia
			and	a.cd_profissional = cd_profissional_p
			and	((a.nr_seq_escala = nr_seq_escala_p) or (coalesce(a.nr_seq_escala::text, '') = ''))
			and	dt_escala_w between trunc(a.dt_inicio) and trunc(a.dt_final)
			group by b.ds_cor;

	end if;
	end;
end if;

return ie_pertence_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_prof_escala_dia (cd_dia_p text, cd_mes_p text, cd_ano_p text, cd_profissional_p text, nr_seq_escala_p text, cd_estabelecimento_p bigint, ie_parametro_p text) FROM PUBLIC;

