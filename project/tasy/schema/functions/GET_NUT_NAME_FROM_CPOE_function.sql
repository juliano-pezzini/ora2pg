-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_nut_name_from_cpoe ( nr_sequencia_p bigint DEFAULT NULL, ie_nut_type_p text  DEFAULT NULL) RETURNS varchar AS $body$
DECLARE

    ret_w   varchar(60) := '';
    ds_return_w varchar(32767) := '';


BEGIN

BEGIN
  if (ie_nut_type_p = 'B' or ie_nut_type_p = 'S') then
    SELECT DISTINCT 
        nut.ds_composicao
    INTO STRICT ret_w
    FROM
        prescr_dieta             prd,
        nut_atend_serv_dia       nasd,
        nut_atend_serv_dia_rep   narp,
        nut_composicao           nut,
        cpoe_dieta               cd
    WHERE
        nasd.nr_sequencia = nr_sequencia_p
        AND nasd.nr_sequencia = narp.nr_seq_serv_dia
        AND narp.nr_prescr_oral = prd.nr_prescricao
        AND prd.nr_seq_dieta_cpoe = cd.nr_sequencia
        AND ( ( ie_nut_type_p = 'B'
                AND nut.nr_sequencia = cd.nr_seq_beverage )
              OR ( ie_nut_type_p = 'S'
                   AND nut.nr_sequencia = cd.nr_seq_staple_food ) );
  elsif ie_nut_type_p = 'C' then
    SELECT rtrim(xmlagg(XMLELEMENT(name e, B.DS_COMMENT, '|')
           order by B.DS_COMMENT).extract['//text()'].getclobval(), ',') as COMMENTS_LIST
      INTO STRICT ds_return_w
    FROM
        prescr_dieta             prd,
        nut_atend_serv_dia       nasd,
        nut_atend_serv_dia_rep   narp,
        cpoe_dieta               cd,
        cpoe_std_comment b,
        CPOE_COMMENT_LINKAGE a
    WHERE
        nasd.nr_sequencia = nr_sequencia_p
        AND a.nr_seq_std_comment = b.nr_sequencia
        AND a.nr_seq_cpoe_nutricao = cd.nr_sequencia
        AND nasd.nr_sequencia = narp.nr_seq_serv_dia
        AND narp.nr_prescr_oral = prd.nr_prescricao
        AND prd.nr_seq_dieta_cpoe = cd.nr_sequencia;
  end if;
  if (ie_nut_type_p = 'B' or ie_nut_type_p = 'S') then
    RETURN ret_w;
  else
    RETURN ds_return_w;
  end if;
END;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_nut_name_from_cpoe ( nr_sequencia_p bigint DEFAULT NULL, ie_nut_type_p text  DEFAULT NULL) FROM PUBLIC;

