-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sip_obter_item_assistencial ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_guia_p text, nr_seq_cbo_saude_p bigint, nr_seq_tipo_atendimento_p bigint, nr_seq_clinica_p bigint, qt_idade_p bigint, cd_doenca_cid_p text, ie_regime_internacao_p text, nr_seq_material_p bigint, ie_sexo_p text, ie_parto_normal_p text, ie_nascido_vivo_p text) RETURNS bigint AS $body$
DECLARE


nr_seq_item_assitencial_w	bigint;
ie_origem_proced_w		bigint;
cd_grupo_proc_w			bigint;
cd_especialidade_w		bigint;
cd_area_procedimento_w		bigint;
ie_materiais_w			varchar(1)	:= 'N';

C01 CURSOR FOR
	SELECT	a.nr_seq_item_assist
	from	sip_item_assist_regra	a
	where	a.ie_situacao	= 'A'
	and	coalesce(a.cd_procedimento, coalesce(cd_procedimento_p,0))		= coalesce(cd_procedimento_p,0)
	and	coalesce(a.ie_origem_proced, coalesce(ie_origem_proced_w,0))		= coalesce(ie_origem_proced_w,0)
	and	coalesce(a.cd_grupo_proc, coalesce(cd_grupo_proc_w,0))			= coalesce(cd_grupo_proc_w,0)
	and	coalesce(a.cd_especialidade, coalesce(cd_especialidade_w,0))		= coalesce(cd_especialidade_w,0)
	and	coalesce(a.cd_area_procedimento, coalesce(cd_area_procedimento_w,0)) 	= coalesce(cd_area_procedimento_w,0)
	and	coalesce(a.nr_seq_tipo_atendimento, coalesce(nr_seq_tipo_atendimento_p, 0)) = coalesce(nr_seq_tipo_atendimento_p,0)
	and	coalesce(a.nr_seq_clinica, coalesce(nr_seq_clinica_p, 0)) = coalesce(nr_seq_clinica_p,0)
	and	coalesce(a.ie_regime_internacao, coalesce(ie_regime_internacao_p, 0)) 	= coalesce(ie_regime_internacao_p,0)
	and	coalesce(a.nr_seq_cbo_saude, coalesce(nr_seq_cbo_saude_p, 0))		= coalesce(nr_seq_cbo_saude_p, 0)
	and	coalesce(a.ie_tipo_guia, coalesce(ie_tipo_guia_p, 'X'))			= coalesce(ie_tipo_guia_p, 'X')
	and	coalesce(a.cd_doenca_cid, coalesce(cd_doenca_cid_p, 'X'))			= coalesce(cd_doenca_cid_p, 'X')
	and	qt_idade_p between coalesce(qt_idade_inicial,qt_idade_p) and coalesce(qt_idade_final,qt_idade_p)
	and (coalesce(a.ie_materiais,'N')		= ie_materiais_w)
	--and	(nvl(ie_parto_normal,'N')	= ie_parto_normal_p) OS - 305282
	and (coalesce(ie_nascido_vivo,'N')	= ie_nascido_vivo_p)
	and	((ie_sexo	= ie_sexo_p)	or (coalesce(ie_sexo::text, '') = ''))
	and	exists (SELECT 1 from sip_item_assist_regra x where x.nr_sequencia = a.nr_sequencia)
	order by
		coalesce(a.nr_seq_tipo_atendimento,0),
		coalesce(a.cd_doenca_cid,0),
		coalesce(a.nr_seq_clinica,0),
		coalesce(a.nr_seq_cbo_saude,0),
		coalesce(a.cd_area_procedimento,0),
		coalesce(a.cd_especialidade,0),
		coalesce(a.cd_grupo_proc,0),
		coalesce(a.cd_procedimento,0);


BEGIN
SELECT * FROM pls_obter_estrut_proc(cd_procedimento_p, ie_origem_proced_p, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w) INTO STRICT cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w;

if (coalesce(nr_seq_material_p,0) > 0) then
	ie_materiais_w	:= 'S';
end if;

/*
if	(nr_seq_cbo_saude_p	= 42) then
	insert into fka values('cd_procedimento_p='||cd_procedimento_p||';ie_origem_proced_w='||ie_origem_proced_w||
		';cd_grupo_proc_w='||cd_grupo_proc_w||';cd_especialidade_w='||cd_especialidade_w||
		';cd_area_procedimento_w='||cd_area_procedimento_w||';nr_seq_tipo_atendimento_p='||nr_seq_tipo_atendimento_p||
		';nr_seq_cbo_saude_p='||nr_seq_cbo_saude_p||';ie_tipo_guia_p='||chr(39)||ie_tipo_guia_p||chr(39)||
		';cd_doenca_cid_p='||chr(39)||cd_doenca_cid_p||chr(39)||';qt_idade_p='||qt_idade_p ||
		';ie_materiais_w='||chr(39)||ie_materiais_w||chr(39) ||';ie_sexo_p='|| chr(39) ||ie_sexo_p || chr(39) ||
		';nr_seq_clinica_p='|| nr_seq_clinica_p || ';ie_regime_internacao_p=' || ie_regime_internacao_p);
end if;
*/
open C01;
loop
fetch C01 into
	nr_seq_item_assitencial_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;

return	nr_seq_item_assitencial_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sip_obter_item_assistencial ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_guia_p text, nr_seq_cbo_saude_p bigint, nr_seq_tipo_atendimento_p bigint, nr_seq_clinica_p bigint, qt_idade_p bigint, cd_doenca_cid_p text, ie_regime_internacao_p text, nr_seq_material_p bigint, ie_sexo_p text, ie_parto_normal_p text, ie_nascido_vivo_p text) FROM PUBLIC;

