-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_analise_adesao ( nr_seq_analise_adesao_p pls_analise_adesao.nr_sequencia%type, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(255) := null;
nr_seq_proposta_w		pls_analise_adesao.nr_seq_proposta%type;
nr_seq_prop_online_w		pls_analise_adesao.nr_seq_prop_online%type;
nr_seq_prop_benef_online_w	pls_analise_adesao.nr_seq_prop_benef_online%type;
cd_pessoa_fisica_w		pls_analise_adesao.cd_pessoa_fisica%type;
nr_seq_declaracao_w		pls_declaracao_segurado.nr_sequencia%type;
nr_seq_pessoa_proposta_w	pls_analise_adesao.nr_seq_pessoa_proposta%type;

/*ie_opcao
	HA = hora de analise
	HT = hora de atendimento
	DP = data proposta
	ED = Estagio da declaracao de saude
	PA = Protocolo ANS
*/
BEGIN

if (ie_opcao_p = 'HA') then
	select	to_char(dt_analise,'hh24:mi:ss')
	into STRICT	ds_retorno_w
	from	pls_analise_adesao
	where	nr_sequencia	= nr_seq_analise_adesao_p;
elsif (ie_opcao_p = 'HT') then
	select	to_char(dt_atendimento,'hh24:mi:ss')
	into STRICT	ds_retorno_w
	from	pls_analise_adesao
	where	nr_sequencia	= nr_seq_analise_adesao_p;
elsif (ie_opcao_p = 'DP') then
	select	nr_seq_proposta,
		nr_seq_prop_online
	into STRICT	nr_seq_proposta_w,
		nr_seq_prop_online_w
	from	pls_analise_adesao
	where	nr_sequencia	= nr_seq_analise_adesao_p;
	
	if (nr_seq_proposta_w IS NOT NULL AND nr_seq_proposta_w::text <> '') then
		select	to_char(dt_inicio_proposta,'dd/mm/yyyy')
		into STRICT	ds_retorno_w
		from	pls_proposta_adesao
		where	nr_sequencia = nr_seq_proposta_w;
	elsif (nr_seq_prop_online_w IS NOT NULL AND nr_seq_prop_online_w::text <> '') then
		select	to_char(dt_criacao,'dd/mm/yyyy')
		into STRICT	ds_retorno_w
		from	pls_proposta_online
		where	nr_sequencia = nr_seq_prop_online_w;
	end if;
elsif (ie_opcao_p = 'ED') then
	select	cd_pessoa_fisica,
		nr_seq_proposta,
		nr_seq_prop_benef_online
	into STRICT	cd_pessoa_fisica_w,
		nr_seq_proposta_w,
		nr_seq_prop_benef_online_w
	from	pls_analise_adesao
	where	nr_sequencia	= nr_seq_analise_adesao_p;
	
	if (nr_seq_prop_benef_online_w IS NOT NULL AND nr_seq_prop_benef_online_w::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_declaracao_w
		from	pls_declaracao_segurado
		where	nr_seq_prop_benef_online = nr_seq_prop_benef_online_w;
	elsif (nr_seq_proposta_w IS NOT NULL AND nr_seq_proposta_w::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_declaracao_w
		from	pls_declaracao_segurado
		where	nr_seq_proposta_adesao	= nr_seq_proposta_w
		and	cd_pessoa_fisica	= cd_pessoa_fisica_w;
	else
		nr_seq_declaracao_w	:= null;
	end if;
	
	if (nr_seq_declaracao_w IS NOT NULL AND nr_seq_declaracao_w::text <> '') then
		select	ie_status
		into STRICT	ds_retorno_w
		from	pls_declaracao_segurado
		where	nr_sequencia	= nr_seq_declaracao_w;
	else
		ds_retorno_w	:= null;
	end if;
elsif (ie_opcao_p = 'PA') then
	select	nr_seq_pessoa_proposta,
		nr_seq_prop_online
	into STRICT	nr_seq_pessoa_proposta_w,
		nr_seq_prop_online_w
	from	pls_analise_adesao
	where	nr_sequencia	= nr_seq_analise_adesao_p;
	
	if (nr_seq_pessoa_proposta_w IS NOT NULL AND nr_seq_pessoa_proposta_w::text <> '') then
		select	max(b.nr_protocolo_ans)
		into STRICT	ds_retorno_w
		from	pls_proposta_beneficiario a,
			pls_plano b
		where  	a.nr_seq_plano	= b.nr_sequencia
		and    	a.nr_sequencia	= nr_seq_pessoa_proposta_w;
	elsif (nr_seq_prop_online_w IS NOT NULL AND nr_seq_prop_online_w::text <> '') then
		select	max(b.nr_protocolo_ans)
		into STRICT	ds_retorno_w
		from	pls_proposta_online a,
			pls_plano b
		where	a.nr_seq_plano = b.nr_sequencia
		and	a.nr_sequencia = nr_seq_prop_online_w;
	end if;	
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_analise_adesao ( nr_seq_analise_adesao_p pls_analise_adesao.nr_sequencia%type, ie_opcao_p text) FROM PUBLIC;

