-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION validar_datas_carteiras ( nr_atendimento_p bigint , dt_inicial_p timestamp , dt_final_p timestamp) RETURNS varchar AS $body$
DECLARE

return_w varchar(1);
nr_seq_interno_w atend_categoria_convenio.nr_seq_interno%type;
nr_sequencia_w  atendimento_paciente_inf.nr_sequencia%type;


BEGIN
  return_w := 'N';

   select coalesce(max(conv.nr_seq_interno),0)
     into STRICT nr_seq_interno_w
	 from atend_categoria_convenio conv
    where conv.nr_atendimento 	= nr_atendimento_p
	  and conv.dt_inicio_vigencia = (SELECT max(conv_b.dt_inicio_vigencia)
	    							   from atend_categoria_convenio conv_b
    							 	  where conv_b.nr_atendimento =  nr_atendimento_p)
 	  and (conv.dt_validade_carteira >= dt_inicial_p and conv.dt_validade_carteira <=  dt_final_p);

  if nr_seq_interno_w > 0 then
      return_w := 'S';
  end if;


 select  coalesce(max(atend_inf.nr_sequencia),0)
   into STRICT nr_sequencia_w
   from atendimento_paciente_inf atend_inf
  where atend_inf.nr_atendimento = nr_atendimento_p
    and (atend_inf.dt_inicio_validade >= dt_inicial_p
    and atend_inf.dt_inicio_validade <= dt_final_p
        or (atend_inf.dt_validade >= dt_inicial_p 
       and atend_inf.dt_validade <= dt_final_p));

 if nr_sequencia_w > 0 then 
      return_w := 'S';
  end if;
  
return return_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION validar_datas_carteiras ( nr_atendimento_p bigint , dt_inicial_p timestamp , dt_final_p timestamp) FROM PUBLIC;

