-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nfce_obter_chave_acesso (nr_seq_nota_p bigint, ie_tipo_retorno_w text default 'CH') RETURNS varchar AS $body$
DECLARE

			 
/* 
CH -> chave de acesso 
DV digito 
 
*/
			 
 
chave_acesso_w	varchar(50);
cDV		double precision;
soma_total_w	double precision;
multiplicador_w	bigint;
chave_adicional_w	varchar(50);
ds_retorno_w	varchar(10);
valor_aux_w	varchar(10);
valor_w		double precision;
			

BEGIN 
 
select	obter_valor_dominio(3620,nfe_obter_dados_pj(cd_cgc_emitente,'UF')) || 
	to_char(dt_emissao,'yymm') || 
	LPAD(cd_cgc_emitente,14,'0') || 
	65 || 
	LPAD(cd_serie_nf,3,'0') || 
	LPAD(nr_nota_fiscal,9,'0') || 
	1 || 
	LPAD(nr_sequencia,8,'0') 
into STRICT	chave_acesso_w	 
from	nota_fiscal 
where	nr_sequencia = nr_seq_nota_p;
 
multiplicador_w := 2;
soma_total_w := 0;
chave_adicional_w := chave_acesso_w;
 
while length(chave_adicional_w) > 0 loop 
	valor_aux_w := substr(chave_adicional_w,length(chave_adicional_w),1);
	valor_w := (valor_aux_w)::numeric;
	soma_total_w := soma_total_w + (valor_w * multiplicador_w);
	chave_adicional_w := substr(chave_adicional_w,1,length(chave_adicional_w)-1);
	multiplicador_w := multiplicador_w + 1;
	if (multiplicador_w > 9) then 
		multiplicador_w := 2;
	end if;
end loop;
 
cDv := (soma_total_w mod 11);
 
if (cDV = 1) or (cDv = 0) then 
	cDV := '0';
else 
	cDV := 11 - cDV;
end if;
 
if (ie_tipo_retorno_w = 'CH') then 
	return	chave_acesso_w || cDV;
else 
	return cDV;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nfce_obter_chave_acesso (nr_seq_nota_p bigint, ie_tipo_retorno_w text default 'CH') FROM PUBLIC;

