-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_liber_agenda (nr_seq_agenda_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE



qt_regra_w		integer	:= 0;
qt_regra_ww		integer	:= 0;
ie_libera_w		varchar(1)	:= 'S';
cd_perfil_w		bigint;
cd_setor_atendimento_w	integer;
cd_pessoa_fisica_w	varchar(10);
cd_cargo_w		bigint;

c01 CURSOR FOR
	SELECT	cd_perfil
	from 	usuario_perfil
	where 	nm_usuario = nm_usuario_p;


BEGIN


select 	count(*)
into STRICT	qt_regra_w
from 	tre_agenda_regra
where 	nr_seq_agenda = nr_seq_agenda_p
and	((obter_se_contido_char(nm_usuario_p,nm_usuario_regra) = 'S') or (coalesce(nm_usuario_regra::text, '') = ''))
and	((tre_obter_se_usuario_grupo(ds_grupo,nm_usuario_p) = 'S') or (coalesce(ds_grupo::text, '') = ''));

if (qt_regra_w > 0) then

	select 	max(cd_setor_atendimento),
		max(cd_pessoa_fisica)
	into STRICT	cd_setor_atendimento_w,
		cd_pessoa_fisica_w
	from 	usuario
	where	upper(nm_usuario) = upper(nm_usuario_p);

	if (cd_pessoa_fisica_w <> '') then
		select 	max(cd_cargo)
		into STRICT	cd_cargo_w
		from 	pessoa_fisica
		where 	cd_pessoa_fisica = cd_pessoa_fisica_w;
	end if;

	OPEN C01;
	LOOP
	FETCH C01 into
		cd_perfil_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select 	count(*)
		into STRICT	qt_regra_ww
		from 	tre_agenda_regra
		where 	nr_seq_agenda = nr_seq_agenda_p
		and 	coalesce(cd_setor_atendimento_w,0) = coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0))
		and 	coalesce(cd_perfil_w,0) = coalesce(cd_perfil, coalesce(cd_perfil_w,0))
		and 	coalesce(cd_cargo_w,0) = coalesce(cd_cargo, coalesce(cd_cargo_w,0));
		if (qt_regra_ww > 0) then
			ie_libera_w:= 'S';
			exit;
		else
			ie_libera_w:= 'N';
		end if;

		end;
	END LOOP;
	CLOSE C01;

end if;

return ie_libera_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_liber_agenda (nr_seq_agenda_p bigint, nm_usuario_p text) FROM PUBLIC;

