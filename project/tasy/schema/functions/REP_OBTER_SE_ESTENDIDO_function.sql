-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION rep_obter_se_estendido (dt_fim_extensao_p timestamp, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
ie_estendido_w			varchar(1);
cd_pessoa_fisica_w		varchar(10);
nr_seq_derivado_w		bigint;
cd_procedimento_w		bigint;
ie_suspenso_w			varchar(1)	:= 'N';
cd_dieta_w			bigint;
dt_suspensao_w			timestamp;
nr_seq_gas_w			bigint;
nr_seq_tipo_w			bigint;
ie_se_necessario_w		varchar(1);
nr_seq_leite_deriv_w		bigint;
cd_intervalo_w			varchar(7);
ie_via_leite_w			varchar(15);
nr_seq_disp_succao_w		bigint;
cd_material_w			integer;
qt_dose_w			double precision;
cd_unidade_medida_dose_w	varchar(30);
ie_via_aplicacao_w		varchar(15);
ie_origem_proced_w		bigint;
nr_seq_prot_glic_w		bigint;
ds_recomendacao_w		varchar(4000);
cd_recomendacao_w		bigint;
ds_solucao_w			varchar(100);
ds_componentes_w		varchar(2000);
ie_identica_w			varchar(10);


BEGIN 
 
select	max(cd_pessoa_fisica) 
into STRICT	cd_pessoa_fisica_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_p;
 
if (ie_tipo_item_p	in ('HM','P','I')) then 
 
		select	max(cd_procedimento), 
			max(nr_seq_derivado), 
			max(dt_suspensao), 
			coalesce(max(ie_suspenso),'N'), 
			max(ie_origem_proced), 
			max(nr_seq_prot_glic) 
		into STRICT	cd_procedimento_w, 
			nr_seq_derivado_w, 
			dt_suspensao_w, 
			ie_suspenso_w, 
			ie_origem_proced_w, 
			nr_seq_prot_glic_w 
		from	prescr_procedimento 
		where	nr_prescricao = nr_prescricao_p 
		and	nr_sequencia = nr_seq_item_p;
 
elsif (ie_tipo_item_p	in ('S','SNE','M','MAT', 'IA', 'IAG','LD')) then 
 
	select	max(nr_seq_leite_deriv), 
		max(cd_material), 
		max(cd_intervalo), 
		max(ie_se_necessario), 
		max(dt_suspensao), 
		coalesce(max(ie_suspenso),'N'), 
		max(qt_dose), 
		max(ie_via_aplicacao), 
		max(cd_unidade_medida_dose) 
	into STRICT	nr_seq_leite_deriv_w, 
		cd_material_w, 
		cd_intervalo_w, 
		ie_se_necessario_w, 
		dt_suspensao_w, 
		ie_suspenso_w, 
		qt_dose_w, 
		ie_via_aplicacao_w, 
		cd_unidade_medida_dose_w 
	from	prescr_material 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_seq_item_p;
	 
elsif (ie_tipo_item_p in ('SOL')) then	 
	 
	select	coalesce(max(ie_se_necessario),'N'), 
		max(dt_suspensao), 
		coalesce(max(ie_suspenso),'N'), 
		coalesce(max(ds_solucao),'XPTO'), 
		max(obter_componentes_solucao(nr_prescricao, nr_seq_solucao, 'N', nm_usuario_p, cd_estabelecimento_p)) 
	into STRICT	ie_se_necessario_w, 
		dt_suspensao_w, 
		ie_suspenso_w, 
		ds_solucao_w, 
		ds_componentes_w 
	from	prescr_solucao 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_seq_solucao	= nr_seq_item_p;
	 
elsif (ie_tipo_item_p in ('NAN','NPN')) then 
 
	select	max(dt_suspensao), 
		coalesce(max(ie_suspenso),'N') 
	into STRICT	dt_suspensao_w, 
		ie_suspenso_w 
	from	nut_pac 
	where	nr_sequencia	= nr_seq_item_p 
	and	nr_prescricao	= nr_prescricao_p;
	 
end if;
 
if (ie_tipo_item_p	= 'HM') then 
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_estendido_w 
	from	prescr_procedimento b, 
		prescr_medica a 
	where	a.nr_prescricao = b.nr_prescricao 
	and	coalesce(b.dt_extensao, a.dt_validade_prescr) = dt_fim_extensao_p 
	and	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
	and	b.cd_procedimento = cd_procedimento_w 
	and	b.nr_seq_derivado = nr_seq_derivado_w 
	and	(coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao, a.dt_liberacao_medico))::text <> '') 
	and	coalesce(b.ie_suspenso,'N') <> 'S';
 
elsif (ie_tipo_item_p	= 'D') then 
 
	select	coalesce(max(ie_suspenso),'N'), 
		max(cd_dieta), 
		max(dt_suspensao) 
	into STRICT	ie_suspenso_w, 
		cd_dieta_w, 
		dt_suspensao_w 
	from	prescr_dieta 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_seq_item_p;
	 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_estendido_w 
	from	prescr_dieta b, 
		prescr_medica a 
	where	a.nr_prescricao		= b.nr_prescricao 
	and	coalesce(b.dt_extensao, a.dt_validade_prescr) = dt_fim_extensao_p 
	and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w 
	and	(coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao, a.dt_liberacao_medico))::text <> '') 
	and	b.cd_dieta		= cd_dieta_w 
	and	coalesce(b.ie_suspenso,'N')	<> 'S';	
	 
elsif (ie_tipo_item_p = 'O') then 
 
	select	max(nr_seq_gas), 
		coalesce(max(ie_suspenso),'N'), 
		max(dt_suspensao) 
	into STRICT	nr_seq_gas_w, 
		ie_suspenso_w, 
		dt_suspensao_w 
	from	prescr_gasoterapia 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_seq_item_p;
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_estendido_w 
	from	prescr_gasoterapia a, 
		prescr_medica b 
	where	a.nr_prescricao = b.nr_prescricao 
	and	b.cd_pessoa_fisica = cd_pessoa_fisica_w 
	and	coalesce(a.dt_extensao, b.dt_validade_prescr) = dt_fim_extensao_p 
	and	a.nr_seq_gas	= nr_seq_gas_w 
	and	(coalesce(b.dt_liberacao, b.dt_liberacao_medico) IS NOT NULL AND (coalesce(b.dt_liberacao, b.dt_liberacao_medico))::text <> '') 
	and	coalesce(a.ie_suspenso,'N') <> 'S';
 
elsif (ie_tipo_item_p	= 'J') then 
 
	select	nr_seq_tipo, 
		coalesce(ie_suspenso,'N') 
	into STRICT	nr_seq_tipo_w, 
		ie_suspenso_w 
	from	rep_jejum 
	where	nr_sequencia	= nr_seq_item_p 
	and	nr_prescricao	= nr_prescricao_p;
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_estendido_w 
	from	rep_jejum a, 
		prescr_medica b 
	where	a.nr_prescricao	= b.nr_prescricao 
	and	coalesce(a.dt_extensao, b.dt_validade_prescr) = dt_fim_extensao_p 
	and	b.cd_pessoa_fisica = cd_pessoa_fisica_w 
	and	(coalesce(b.dt_liberacao, b.dt_liberacao_medico) IS NOT NULL AND (coalesce(b.dt_liberacao, b.dt_liberacao_medico))::text <> '') 
	and	a.ie_suspenso	<> 'S' 
	and	a.nr_seq_tipo	= nr_seq_tipo_w;
 
elsif (ie_tipo_item_p	= 'LD') then 
		 
	select	cd_intervalo, 
		nr_seq_disp_succao, 
		ie_via_aplicacao, 
		ie_se_necessario 
	into STRICT	cd_intervalo_w, 
		nr_seq_disp_succao_w, 
		ie_via_leite_w, 
		ie_se_necessario_w 
	from	prescr_leite_deriv 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_sequencia	= nr_seq_leite_deriv_w;	
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_estendido_w 
	from	prescr_material a, 
		prescr_leite_deriv c, 
		prescr_medica b 
	where	b.nr_prescricao	= a.nr_prescricao 
	and	b.nr_prescricao	= c.nr_prescricao 
	and	a.nr_prescricao	= c.nr_prescricao 
	and	a.nr_seq_leite_deriv = c.nr_sequencia 
	and	coalesce(a.dt_extensao, b.dt_validade_prescr) = dt_fim_extensao_p 
	and	coalesce(c.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_w,'XPTO') 
	and	coalesce(c.ie_via_aplicacao,'XPTO') = coalesce(ie_via_leite_w,'XPTO') 
	and	coalesce(c.ie_se_necessario,'N') = coalesce(ie_se_necessario_w,'N') 
	and	coalesce(c.nr_seq_disp_succao,0) = coalesce(nr_seq_disp_succao_w,0) 
	and	b.cd_pessoa_fisica	= cd_pessoa_fisica_w 
	and	(coalesce(b.dt_liberacao, b.dt_liberacao_medico) IS NOT NULL AND (coalesce(b.dt_liberacao, b.dt_liberacao_medico))::text <> '') 
	and	a.cd_material	= cd_material_w 
	and	coalesce(a.ie_suspenso,'N')	<> 'S';	
 
elsif (ie_tipo_item_p	in ('S','SNE','M')) then 
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_estendido_w 
	from	prescr_material a, 
		prescr_medica b 
	where	b.nr_prescricao	= a.nr_prescricao 
	and	b.cd_pessoa_fisica	= cd_pessoa_fisica_w 
	and	coalesce(a.dt_extensao, b.dt_validade_prescr) = dt_fim_extensao_p 
	and	a.cd_material	= cd_material_w 
	and	a.cd_intervalo	= cd_intervalo_w 
	and	a.qt_dose	= qt_dose_w	 
	and	a.cd_unidade_medida_dose	= cd_unidade_medida_dose_w 
	and	a.ie_via_aplicacao		= ie_via_aplicacao_w 
	and	(coalesce(b.dt_liberacao, b.dt_liberacao_medico) IS NOT NULL AND (coalesce(b.dt_liberacao, b.dt_liberacao_medico))::text <> '') 
	and	coalesce(a.ie_suspenso,'N')	<> 'S';	
	 
elsif (ie_tipo_item_p	= 'NAN') then	 
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_estendido_w 
	from	nut_pac a, 
		prescr_medica b 
	where	a.nr_prescricao 	= b.nr_prescricao 
	and	a.ie_npt_adulta 	= 'S' 
	and	coalesce(a.dt_extensao, b.dt_validade_prescr) = dt_fim_extensao_p 
	and	(coalesce(b.dt_liberacao, b.dt_liberacao_medico) IS NOT NULL AND (coalesce(b.dt_liberacao, b.dt_liberacao_medico))::text <> '') 
	and	b.cd_pessoa_fisica 	= cd_pessoa_fisica_w;
	 
elsif (ie_tipo_item_p	= 'NPN') then	 
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_estendido_w 
	from	nut_pac a, 
		prescr_medica b 
	where	a.nr_prescricao 	= b.nr_prescricao 
	and	a.ie_npt_adulta 	= 'N' 
	and	coalesce(a.dt_extensao, b.dt_validade_prescr) = dt_fim_extensao_p 
	and	(coalesce(b.dt_liberacao, b.dt_liberacao_medico) IS NOT NULL AND (coalesce(b.dt_liberacao, b.dt_liberacao_medico))::text <> '') 
	and	b.cd_pessoa_fisica 	= cd_pessoa_fisica_w;
		 
elsif (ie_tipo_item_p	= 'P') then 
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_estendido_w 
	from	prescr_procedimento b, 
		prescr_medica a 
	where	a.nr_prescricao		= b.nr_prescricao 
	and	coalesce(b.dt_extensao, a.dt_validade_prescr) = dt_fim_extensao_p 
	and	a.cd_pessoa_fisica 	= cd_pessoa_fisica_w 
	and	b.cd_procedimento	= cd_procedimento_w 
	and	b.ie_origem_proced	= ie_origem_proced_w 
	and	coalesce(b.ie_suspenso,'N')	<> 'S' 
	and	coalesce(b.nr_seq_solic_sangue::text, '') = '' 
	and	(coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao, a.dt_liberacao_medico))::text <> '') 
	and	coalesce(b.nr_seq_prot_glic,0)	= coalesce(nr_seq_prot_glic_w,0);
 
elsif (ie_tipo_item_p = 'R') then	 
		 
	select 	max(substr(coalesce(b.ds_tipo_recomendacao,a.ds_recomendacao),1,4000)), 
		max(a.cd_recomendacao), 
		max(a.dt_suspensao), 
		max(coalesce(a.ie_suspenso,'N')) 
	into STRICT	ds_recomendacao_w, 
		cd_recomendacao_w, 
		dt_suspensao_w, 
		ie_suspenso_w 
	FROM prescr_recomendacao a
LEFT OUTER JOIN tipo_recomendacao b ON (a.cd_recomendacao = b.cd_tipo_recomendacao)
WHERE a.nr_prescricao		= nr_prescricao_p and a.nr_sequencia		= nr_seq_item_p;		
		 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_estendido_w 
	from	prescr_recomendacao b, 
		prescr_medica a 
	where	a.nr_prescricao = b.nr_prescricao 
	and	coalesce(b.dt_extensao, a.dt_validade_prescr) = dt_fim_extensao_p 
	and	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
	and	(coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao, a.dt_liberacao_medico))::text <> '') 
	and	((b.cd_recomendacao = cd_recomendacao_w) or 
		 ((coalesce(b.cd_recomendacao::text, '') = '') and (b.ds_recomendacao = ds_recomendacao_w))) 
	and	coalesce(b.ie_suspenso,'N') <> 'S';		
		 
elsif (ie_tipo_item_p	= 'SOL') then		 
 
	select	coalesce(max(CASE WHEN ie_solucao_continua='CDVF' THEN 'A'  ELSE ie_solucao_continua END ),'A') -- Identificação Sol contínua 
	into STRICT	ie_identica_w 
	from	parametro_medico 
	where	cd_estabelecimento = cd_estabelecimento_p;
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_estendido_w 
	from	atendimento_paciente c, 
		prescr_medica a, 
		prescr_solucao b 
	where	a.nr_prescricao = b.nr_prescricao 
	and	a.nr_atendimento = c.nr_atendimento 
	and	c.cd_pessoa_fisica = a.cd_pessoa_fisica 
	and	coalesce(b.dt_extensao, a.dt_validade_prescr) = dt_fim_extensao_p 
	and	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
	and	(coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao, a.dt_liberacao_medico))::text <> '') 
	and	(((coalesce(b.ds_solucao,'XPTO') = ds_solucao_w) and (b.ds_solucao IS NOT NULL AND b.ds_solucao::text <> '') and (ie_identica_w = 'T')) or 
		 ((coalesce(b.ds_solucao,'XPTO') = ds_solucao_w) and (obter_componentes_solucao(b.nr_prescricao, b.nr_seq_solucao, 'N', nm_usuario_p, cd_estabelecimento_p) = ds_componentes_w) and (ie_identica_w = 'A')) or 
		 ((obter_componentes_solucao(b.nr_prescricao, b.nr_seq_solucao, 'N', nm_usuario_p, cd_estabelecimento_p) = ds_componentes_w) and (ie_identica_w = 'C'))) 
	and	coalesce(b.ie_suspenso,'N') <> 'S';
 
end if;
 
return	ie_estendido_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION rep_obter_se_estendido (dt_fim_extensao_p timestamp, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

