-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_gera_sepsis (nr_atendimento_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


c01 CURSOR FOR
	SELECT ie_status, qt_horas
	from   sepse_horas_status
	where  coalesce(ie_situacao,'A') = 'A';
	
qt_horas_sepsis_w bigint;
qt_reg_w          bigint;
ds_status_sepse_w varchar(80);

BEGIN
ds_status_sepse_w := '';
if (nr_atendimento_p > 0) then

	for regras in c01 loop

		select count(1)
		into STRICT   qt_reg_w
		from   escala_sepse
		where  nr_atendimento = nr_atendimento_p
		and    coalesce(dt_inativacao::text, '') = ''
		and    coalesce(ie_situacao,'A') = 'A'
		and    obter_se_contido_char(ie_status_sepsis,obter_des_status_sepse(regras.ie_status,'C')) = 'S'
		and    dt_liberacao_status between (clock_timestamp()  - (1/24 * regras.qt_horas)) and clock_timestamp();
		
		if (qt_reg_w > 0) then
			exit;
		end if;
		ds_status_sepse_w := concat(concat(ds_status_sepse_w, ','), obter_des_status_sepse(regras.ie_status,'C'));
	end loop;

	if (qt_reg_w > 0) then
		return 'N';
	else
		
		Select  max(QT_HORAS_SEPSIS)
		into STRICT	qt_horas_sepsis_w
		from 	parametro_medico
		where	cd_estabelecimento = cd_estabelecimento_p;
		
		if (coalesce(qt_horas_sepsis_w,0) > 0) then
		
			Select  count(*)
			into STRICT	qt_reg_w
			from	escala_sepse
			where 	nr_atendimento = nr_atendimento_p
			and	    dt_atualizacao_nrec between (clock_timestamp()  - (1/24 * qt_horas_sepsis_w)) and clock_timestamp()
			and	    coalesce(ie_situacao,'A') = 'A'
			and	obter_se_contido_char(ie_status_sepsis, ds_status_sepse_w) != 'S';
		
		end if;
		
		if (qt_reg_w > 0) then
			return 'N';
		else
			return 'S';
		end if;
		
	end if;

else
	return 'S';	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_gera_sepsis (nr_atendimento_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

