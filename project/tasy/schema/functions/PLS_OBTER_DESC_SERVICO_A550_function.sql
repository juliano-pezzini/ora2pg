-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_desc_servico_a550 ( nr_seq_ptu_quest_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, cd_servico_p bigint, ie_origem_proced_p bigint, ie_tipo_tabela_p bigint ) RETURNS varchar AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Retornar a descricao do servico referente ao PTU_QUESTIONAMENTO - A550
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:	ESTA ROTINA E ESPECIFICA PARA RETORNO DA 
			DESCRICAO DO SERVICO A550
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/ds_retorno_w			varchar(4000) := null;			
nr_seq_material_w		pls_material.nr_sequencia%type;
ds_servico_w			ptu_questionamento.ds_servico%type;
nr_seq_pls_fatura_w		pls_lote_contestacao.nr_seq_pls_fatura%type;
cd_servico_w			ptu_questionamento.cd_servico%type;
ie_origem_proced_w		ptu_questionamento.ie_origem_proced%type := ie_origem_proced_p;


BEGIN
-- PROCEDIMENTOS / SERVICOS
if (ie_tipo_tabela_p in (0,1,4,18,22,98,00)) then
	if (coalesce(ie_origem_proced_w::text, '') = '') then
		select	max(ns.ie_origem_proced),
			max(ns.ds_servico)
		into STRICT	ie_origem_proced_w,
			ds_servico_w
		from	ptu_nota_servico	ns,
			ptu_questionamento	q
		where	ns.nr_sequencia	= q.nr_seq_nota_servico
		and	q.nr_sequencia	= nr_seq_ptu_quest_p;
	end if;

	select	coalesce(substr(obter_descricao_procedimento( cd_servico_p, ie_origem_proced_w),1,255),ds_servico_w)
	into STRICT	ds_retorno_w
	;

-- MATERIAIS / MEDICAMENTOS
elsif (ie_tipo_tabela_p in (2,3,5,6,19,20)) then
	select	max(nr_seq_material)
	into STRICT	nr_seq_material_w
	from	ptu_nota_servico
	where	nr_seq_conta_mat	= nr_seq_conta_mat_p;
	
	if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
		begin
		select	ds_material
		into STRICT	ds_retorno_w
		from	pls_material
		where	nr_sequencia	= nr_seq_material_w;
		exception
		when others then
			ds_retorno_w := null;
		end;
	end if;
end if;

-- Se for codigo generico e de OPS - Faturamento, mostrar descricao que veio no A550
if (cd_servico_p in (99999919,99999927,99999935,99999943)) then
	select	max(q.ds_servico),
		max(l.nr_seq_pls_fatura)
	into STRICT	ds_servico_w,
		nr_seq_pls_fatura_w
	from	pls_lote_contestacao	l,
		ptu_camara_contestacao	c,
		ptu_questionamento	q
	where	l.nr_sequencia		= c.nr_seq_lote_contest
	and	c.nr_sequencia		= q.nr_seq_contestacao
	and	q.nr_sequencia		= nr_seq_ptu_quest_p;

	if (nr_seq_pls_fatura_w IS NOT NULL AND nr_seq_pls_fatura_w::text <> '') then
		ds_retorno_w := ds_servico_w;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_desc_servico_a550 ( nr_seq_ptu_quest_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, cd_servico_p bigint, ie_origem_proced_p bigint, ie_tipo_tabela_p bigint ) FROM PUBLIC;

