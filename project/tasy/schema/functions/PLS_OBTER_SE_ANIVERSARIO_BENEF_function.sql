-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_aniversario_benef (cd_pessoa_fisica_p text, dt_inicial_p timestamp, dt_final_p timestamp) RETURNS varchar AS $body$
DECLARE



dt_nascimento_w			timestamp;
ie_aniversario_w		varchar(001) := 'N';
dt_aniversario_w		timestamp;
ds_ano_w			varchar(4);


BEGIN

select	to_char(dt_inicial_p,'yyyy')
into STRICT	ds_ano_w
;

select	dt_nascimento
into STRICT	dt_nascimento_w
from	pessoa_fisica
where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

if (dt_nascimento_w IS NOT NULL AND dt_nascimento_w::text <> '')	and (trunc(dt_nascimento_w,'month') <> trunc(dt_inicial_p,'month')) then
	begin
	-- Tratar aniversÃ¡rio em 29/02
	if ((to_char(dt_nascimento_w, 'dd'))::numeric  >
		 (to_char(
				fim_mes(
					to_date(
						to_char(trunc(dt_nascimento_w, 'month'),'dd/mm') || '/' || ds_ano_w
						, 'dd/mm/yyyy')
					)
				, 'dd')
			 )::numeric
		) then
		dt_aniversario_w		:= fim_mes(to_date(to_char(trunc(dt_nascimento_w, 'month'),'dd/mm') || '/' || ds_ano_w, 'dd/mm/yyyy'));
	else
		dt_aniversario_w		:= to_date((to_char(trunc(dt_nascimento_w),'dd/mm') || '/' || ds_ano_w),'dd/mm/yyyy');
	end if;
	exception
		when others then
			/* #@DS_ERRO#@
			#@DT_ANIVERSARIO#@ */
			CALL wheb_mensagem_pck.exibir_mensagem_abort(266947, 'DS_ERRO=' || sqlerrm || ';DT_ANIVERSARIO=' || to_char(trunc(dt_nascimento_w, 'month'),'dd/mm') || '/' || ds_ano_w);
	end;

	begin
	select	coalesce(max('S'),'N')
	into STRICT	ie_aniversario_w
	
	where	dt_aniversario_w between dt_inicial_p and fim_dia(dt_final_p);
	exception
		when others then
			ie_aniversario_w	:= 'N';
	end;
end if;

return	ie_aniversario_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_aniversario_benef (cd_pessoa_fisica_p text, dt_inicial_p timestamp, dt_final_p timestamp) FROM PUBLIC;

