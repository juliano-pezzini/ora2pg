-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION validar_atend_regra_triagem ( cd_estabelecimento_p bigint, ie_clinica_p bigint, hr_geracao_p text, nr_seq_classificacao_p bigint) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(2)	:= 'N';
cd_estabelecimento_w	smallint;
ie_clinica_w		integer;
ie_possui_regra_w	varchar(1);
ie_possui_count_w       integer;
nr_seq_classificacao_w  bigint;

C01 CURSOR FOR
	SELECT	cd_estabelecimento,
		ie_clinica,
		nr_seq_classificacao
	from	atend_regra_triagem
	where	ie_situacao = 'A'
	and	(((coalesce(hr_inicial::text, '') = '') or (coalesce(hr_final::text, '') = '')) or ((to_char(to_date(hr_geracao_p,'dd/mm/yyyy hh24:mi:ss'),'hh24')||to_char(to_date(hr_geracao_p,'dd/mm/yyyy hh24:mi:ss'),'mi'))::numeric  between
			(to_char(hr_inicial,'hh24')||to_char(hr_inicial,'mi'))::numeric  and (to_char(hr_final,'hh24')||to_char(hr_final,'mi'))::numeric ));


BEGIN
Select 	count(*)
into STRICT 	ie_possui_count_w
from	atend_regra_triagem
where 	cd_estabelecimento = cd_estabelecimento_p;

select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_possui_regra_w
from	atend_regra_triagem
where	cd_estabelecimento = cd_estabelecimento_p
and	((coalesce(ie_clinica, ie_clinica_p) = ie_clinica_p) or (ie_clinica_p = 0))
and	((coalesce(nr_seq_classificacao, nr_seq_classificacao_p) = nr_seq_classificacao_p) or (nr_seq_classificacao_p = 0));

if (ie_possui_regra_w = 'N') and (coalesce(ie_possui_count_w,0) = 0) then
		ie_retorno_w := 'S';
end if;

if (ie_possui_regra_w = 'S') then
	open C01;
	loop
	fetch C01 into
		cd_estabelecimento_w,
		ie_clinica_w,
		nr_seq_classificacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (cd_estabelecimento_p = cd_estabelecimento_w) and (nr_seq_classificacao_p = coalesce(nr_seq_classificacao_w, nr_seq_classificacao_p) or (nr_seq_classificacao_p = 0)) and
			((coalesce(ie_clinica_w, ie_clinica_p) = ie_clinica_p) OR (ie_clinica_p = 0)) then
			ie_retorno_w := 'S';

		end if;

		end;

	end loop;

	close C01;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION validar_atend_regra_triagem ( cd_estabelecimento_p bigint, ie_clinica_p bigint, hr_geracao_p text, nr_seq_classificacao_p bigint) FROM PUBLIC;

