-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_if_department_shift_arg ( nr_seq_agenda_p agenda_paciente.nr_sequencia%TYPE, cd_departamento_medico_lista_p text, dt_agenda_p timestamp, hora_agenda_p timestamp ) RETURNS varchar AS $body$
DECLARE


    cd_agenda_w      agenda_paciente.cd_agenda%TYPE;
    hr_inicio_w      agenda_paciente.hr_inicio%TYPE;
    ie_dia_semana_w  bigint;
    ie_liberado_w    varchar(01) := 'S';

BEGIN
    SELECT
        MAX(ap.cd_agenda),
        MAX(ap.hr_inicio)
    INTO STRICT
        cd_agenda_w,
        hr_inicio_w
    FROM
        agenda_paciente ap
    WHERE
        ap.nr_sequencia = nr_seq_agenda_p;

    SELECT
        pkg_date_utils.get_weekday(hr_inicio_w)
    INTO STRICT ie_dia_semana_w
;

    SELECT
        CASE
            WHEN coalesce(MAX(a.cd_agenda)::text, '') = '' THEN
                'N'
            ELSE
                'S'
        END
    INTO STRICT ie_liberado_w
    FROM
        agenda_horario  ah,
        agenda          a
    WHERE
            a.cd_agenda = cd_agenda_w
        AND a.cd_agenda = ah.cd_agenda
        AND ( ( ah.dt_dia_semana = ie_dia_semana_w )
              OR ( ah.dt_dia_semana = 9
                   AND ie_dia_semana_w NOT IN ( 1, 7 ) ) )
        AND ( ah.cd_departamento_medico IN (WITH RECURSIVE cte AS (

            SELECT
                (trim(both regexp_substr(cd_departamento_medico_lista_p, '[^,]+', 1, level)))::numeric
            
            instr(cd_departamento_medico_lista_p, ',', 1, level - 1) > 0
          UNION ALL

            SELECT
                (trim(both regexp_substr(cd_departamento_medico_lista_p, '[^,]+', 1, level)))::numeric 
            
            instr(cd_departamento_medico_lista_p, ',', 1, level - 1) > 0
         JOIN cte c ON ()

) SELECT * FROM cte;
)
              OR ( get_if_shift_has_free_hours(dt_agenda_p, ah.hr_inicial, ah.hr_final, ah.nr_minuto_intervalo) < ah.qt_horas_ant_agenda )
              OR coalesce(ah.cd_departamento_medico::text, '') = '' )
        AND get_composite_date_time(clock_timestamp(), hr_inicio_w) BETWEEN get_composite_date_time(clock_timestamp(), ah.hr_inicial) AND get_composite_date_time(
        clock_timestamp(), ah.hr_final);

    RETURN ie_liberado_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_if_department_shift_arg ( nr_seq_agenda_p agenda_paciente.nr_sequencia%TYPE, cd_departamento_medico_lista_p text, dt_agenda_p timestamp, hora_agenda_p timestamp ) FROM PUBLIC;

