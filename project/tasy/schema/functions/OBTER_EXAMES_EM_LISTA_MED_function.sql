-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_exames_em_lista_med (ds_lista_exames_p text) RETURNS varchar AS $body$
DECLARE


ds_lista_retorno varchar(4000);
ds_lista_w       varchar(4000);

nr_seq_interno_lista_w bigint;
nr_seq_interno_w       bigint;
qt_existe_virgula_w    bigint;
tam_lista_w            bigint;
ie_pos_virgula_w       smallint;


BEGIN
  ds_lista_w := ds_lista_exames_p;
  ds_lista_retorno := '';

  SELECT position(',' in ds_lista_w)
  INTO STRICT   qt_existe_virgula_w
;

  IF (qt_existe_virgula_w = 0) THEN
    ds_lista_w := ds_lista_w || ',';
  END IF;

  IF (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') THEN
  BEGIN
    WHILE(ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') LOOP
    BEGIN
      tam_lista_w := LENGTH(ds_lista_w);
      ie_pos_virgula_w := position(',' in ds_lista_w);

      IF (ie_pos_virgula_w <> 0) THEN
        nr_seq_interno_w := (SUBSTR(ds_lista_w, 1, (ie_pos_virgula_w - 1)))::numeric;
        ds_lista_w := substr(ds_lista_w, ( ie_pos_virgula_w + 1 ), tam_lista_w);
      END IF;

      SELECT coalesce(MAX(pp.nr_seq_interno), -1)
      INTO STRICT nr_seq_interno_lista_w
      FROM prescr_procedimento pp
      RIGHT JOIN lista_central_exame lce ON pp.nr_prescricao = lce.nr_prescricao
        AND  pp.nr_sequencia = lce.nr_sequencia_prescricao
      WHERE pp.nr_seq_interno = nr_seq_interno_w;

      IF (nr_seq_interno_lista_w > -1) THEN
        ds_lista_retorno := ds_lista_retorno || nr_seq_interno_lista_w || ';';
      END IF;
    END;
    END LOOP;
  END;
  END IF;

  RETURN ds_lista_retorno;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_exames_em_lista_med (ds_lista_exames_p text) FROM PUBLIC;

