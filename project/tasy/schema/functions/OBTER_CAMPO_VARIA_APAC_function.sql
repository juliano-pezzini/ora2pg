-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_campo_varia_apac (nr_sequencia_p bigint, cd_varia_atrib_p text) RETURNS varchar AS $body$
DECLARE


ds_varia_w		varchar(60);
nr_tamanho_w		smallint;


BEGIN

select	coalesce(max(length(nr_apac)),11)
into STRICT	nr_tamanho_w
from	sus_apac_movto
where	nr_sequencia	= nr_sequencia_p;

/* Tipo de atendimento 13 - Terapia Renal Substitutiva  */

/* Tipo de tratamento 27 - Varia 27 Exemplo de Proc = 27031187   */

if (cd_varia_atrib_p in ('27')) then
	begin
	select
		coalesce(to_char(a.dt_inicio_tratamento,'YYYYMM'),'      ')||
		substr(a.cd_cid_principal||'    ',1,4)||'  '||
		substr(a.cd_cid_secundario||'    ',1,4)||'  '||
		coalesce(a.ie_indicado_tx,' ')||
		coalesce(a.ie_inscrito_tx,' ')||
		coalesce(to_char(a.dt_inscricao_tx,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_primeiro_tx,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_segundo_tx,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_terceiro_tx,'YYYYMM'),'      ')||
		to_char(coalesce(a.qt_tx_realizado,0))||
		coalesce(replace(to_char(a.qt_creatinina,'FM00.0'),'.',''),'   ')||
		coalesce(replace(to_char(a.qt_ureia_pre,'FM000.0'),'.',''),'    ')||
		coalesce(replace(to_char(a.qt_ureia_pos,'FM000.0'),'.',''),'    ')||
		coalesce(a.ie_hepatite_c,' ')||
		coalesce(a.ie_hbsag,' ')||
		coalesce(a.ie_hiv,' ')||
		coalesce(a.ie_hla,' ')
	into STRICT	ds_varia_w
	from	sus_apac_movto a
	where	a.nr_sequencia	= nr_sequencia_p;
	exception
		when others then
		ds_varia_w := null;
	end;
end if;

/* Tipo de atendimento 04 - Assistência Farmacêutica  */

/* Tipo de tratamento 36 - Varia 36 Exemplo de Proc = 36011010  */

if (cd_varia_atrib_p in ('36')) then
	begin
	select
		coalesce(to_char(a.dt_inicio_tratamento,'YYYYMM'),'      ')||
		substr(a.cd_cid_principal||'    ',1,4)||'  '||
		substr(a.cd_cid_secundario||'    ',1,4)||'  '||
		coalesce(a.ie_indicado_tx,' ')||
		coalesce(a.ie_inscrito_tx,' ')||
		coalesce(to_char(a.dt_inscricao_tx,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_primeiro_tx,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_segundo_tx,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_terceiro_tx,'YYYYMM'),'      ')||
		to_char(coalesce(a.qt_tx_realizado,0))||
		'               '
	into STRICT	ds_varia_w
	from	sus_apac_movto a
	where	a.nr_sequencia	= nr_sequencia_p;
	exception
		when others then
		ds_varia_w := null;
	end;
end if;

/* Tipo de atendimento 14 - Radioterapia  */

/* Tipo de tratamento 28 - Varia 28  Exemplo de Proc = 28011015   */

if (cd_varia_atrib_p in ('28')) then
	begin
	select
		coalesce(to_char(a.dt_inicio_tratamento,'YYYYMM'),'      ')||
		substr(a.cd_cid_topografia||'    ',1,4)||'  '||
		substr(a.cd_cid_morfologia||'M00000',1,6)||
		coalesce(a.ie_metastase,' ')||
		coalesce(a.ie_finalidade,' ')||
		coalesce(to_char(a.dt_diagnostico,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_pri_tratamento,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_seg_tratamento,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_ter_tratamento,'YYYYMM'),'      ')||
		coalesce(to_char(a.cd_estagio),' ')||
		substr(a.cd_cid_pri_radiacao||'    ',1,4)||
		substr(a.cd_cid_seg_radiacao||'    ',1,4)||
		substr(a.cd_cid_ter_radiacao||'    ',1,4)||
		coalesce(to_char(a.qt_campo_planejado,'FM000'),'000')
	into STRICT	ds_varia_w
	from	sus_apac_movto a
	where	a.nr_sequencia	= nr_sequencia_p;
	exception
		when others then
		ds_varia_w := null;
	end;
end if;

/* Tipo de atendimento 15 - Quimioterapia  */

/* Tipo de tratamento 29 - Varia 29  Exemplo de Proc = 29011019 */

if (cd_varia_atrib_p in ('29')) then
	begin
	select
		coalesce(to_char(a.dt_inicio_tratamento,'YYYYMM'),'      ')||
		substr(a.cd_cid_topografia||'    ',1,4)||'  '||
		substr(a.cd_cid_morfologia||'M00000',1,6)||
		coalesce(a.ie_metastase,' ')||' '||
		coalesce(to_char(a.dt_diagnostico,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_pri_tratamento,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_seg_tratamento,'YYYYMM'),'      ')||
		coalesce(to_char(a.dt_ter_tratamento,'YYYYMM'),'      ')||
		coalesce(to_char(a.cd_estagio),' ')||
		coalesce(to_char(a.qt_meses_prev,'FM000'),'000')||
		'            '
	into STRICT	ds_varia_w
	from	sus_apac_movto a
	where	a.nr_sequencia	= nr_sequencia_p;
	exception
		when others then
		ds_varia_w := null;
	end;
end if;

/* Tipo de atendimento (19,26,35,13)  */

/* Tipo de tratamento (19,26,35,13) - Varia 11  Exemplo de Proc = 19083025,26011026 */

if (cd_varia_atrib_p in ('11')) then
	begin
	select
		coalesce(to_char(a.ie_resultado_exame),'0')||'     '||
		substr(a.cd_cid_principal||'    ',1,4)
	into STRICT	ds_varia_w
	from	sus_apac_movto a
	where	a.nr_sequencia	= nr_sequencia_p;
	exception
		when others then
		ds_varia_w := null;
	end;
end if;


/* Tipo de atendimento (38)  */

/* Tipo de tratamento (38) - Varia A2  Exemplo de Proc = 38011026 */

if (cd_varia_atrib_p in ('A2')) then
	begin
	select	'      '||
		substr(a.cd_cid_principal||'    ',1,4)||'  '||
		CASE WHEN nr_tamanho_w=13 THEN coalesce(to_char(a.nr_aih_tx,'FM0000000000000'),'0000000000000')					  ELSE coalesce(to_char(a.nr_aih_tx,'FM0000000000'),'0000000000') END ||
		coalesce(to_char(a.cd_proc_tx,'FM00000000'),'00000000')||
		coalesce(to_char(a.dt_transplante,'YYYYMMDD'),'        ')
	into STRICT	ds_varia_w
	from	sus_apac_movto a
	where	a.nr_sequencia	= nr_sequencia_p;
	exception
		when others then
		ds_varia_w := null;
	end;
end if;
/* Tipo de tratamento (38) - Varia A1  Exemplo de Proc = 38011018 */

if (cd_varia_atrib_p in ('A1')) then
	begin
	select	'      '||
		substr(a.cd_cid_principal||'    ',1,4)||'  '||
		CASE WHEN nr_tamanho_w=13 THEN coalesce(to_char(a.nr_aih_tx,'FM0000000000000'),'0000000000000')				     ELSE coalesce(to_char(a.nr_aih_tx,'FM0000000000'),'0000000000') END ||'        '||
		coalesce(to_char(a.dt_transplante,'YYYYMMDD'),'        ')
	into STRICT	ds_varia_w
	from	sus_apac_movto a
	where	a.nr_sequencia	= nr_sequencia_p;
	exception
		when others then
		ds_varia_w := null;
	end;
end if;

/* Falta base para teste não aceita nenhum CID e recebe somente o CID como informação */

/* proc - 19162022,21031088,38061015 */

if (cd_varia_atrib_p in ('08','10','19','21')) then
	begin
	select	'      '||
		substr(a.cd_cid_principal||'    ',1,4)
	into STRICT	ds_varia_w
	from	sus_apac_movto a
	where	a.nr_sequencia	= nr_sequencia_p;
	exception
		when others then
		ds_varia_w := null;
	end;
end if;

/*  Retirado em 22/03/05 por Edilson. Tem que gravar o CID principal para esses tipos
/* Falta base para teste não aceita nenhuma atividade e não tem informação para o varia - proc 38111004
if	(cd_varia_atrib_p in('08','10','19','21')) then
	begin
	ds_varia_w	:= null;
	end;
end if;

*/
RETURN ds_varia_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_campo_varia_apac (nr_sequencia_p bigint, cd_varia_atrib_p text) FROM PUBLIC;

