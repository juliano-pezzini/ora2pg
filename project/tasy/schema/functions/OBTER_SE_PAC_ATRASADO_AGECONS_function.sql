-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_pac_atrasado_agecons ( nr_seq_agenda_p bigint, ie_opcao_p text default 'D') RETURNS varchar AS $body$
DECLARE

			 
/* 
ie_opcao_p 
D - Descrição (Sim/Não, Yes/No) 
IE - retorna (S,N) 
 
Incluído em 11/01/2017 por lhalves, para utilizar no HTML5, pois é necessário apenas o valor e não a descrição, já que o campo será apresentado como tipo checkbox no grid. 
*/
			 
 
ie_retorno_w	varchar(255) := '';			
dt_chegada_w	timestamp;
dt_agenda_w	timestamp;
cd_agenda_w	bigint;
nr_min_atraso_w	bigint;
cd_estabelecimento_w	smallint;			
nr_minutos_atraso_w	bigint;


BEGIN 
 
select	max(a.dt_chegada), 
	max(a.dt_agenda), 
	max(b.cd_estabelecimento), 
	max(b.cd_agenda) 
into STRICT	dt_chegada_w, 
	dt_agenda_w, 
	cd_estabelecimento_w, 
	cd_agenda_w 
from	agenda_consulta a, 
	agenda b 
where	a.cd_agenda	= b.cd_agenda 
and	a.nr_sequencia	= nr_seq_agenda_p;
 
select	max(nr_min_atraso) 
into STRICT	nr_min_atraso_w 
from	agenda_tempo_atraso 
where	cd_agenda = cd_agenda_w;
 
if (coalesce(nr_min_atraso_w::text, '') = '') then 
	select	max(nr_min_atraso) 
	into STRICT	nr_min_atraso_w 
	from	parametro_agenda 
	where	cd_estabelecimento = cd_estabelecimento_w;
end if;
 
if (dt_chegada_w IS NOT NULL AND dt_chegada_w::text <> '') then 
	if (nr_min_atraso_w IS NOT NULL AND nr_min_atraso_w::text <> '') then 
		nr_minutos_atraso_w	:= round(((dt_chegada_w - dt_agenda_w) * 1440),2);
		if (nr_minutos_atraso_w > nr_min_atraso_w) then 
			--ie_retorno_w	:= wheb_mensagem_pck.get_texto(306949); -- Sim 
			ie_retorno_w	:= 'S';
		else 
			--ie_retorno_w	:= wheb_mensagem_pck.get_texto(306950); -- Não 
			ie_retorno_w	:= 'N';
		end if;		
	elsif (dt_chegada_w > dt_agenda_w) then 
		--ie_retorno_w	:= wheb_mensagem_pck.get_texto(306949); -- Sim 
		ie_retorno_w	:= 'S';
	else 
		--ie_retorno_w	:= wheb_mensagem_pck.get_texto(306950); -- Não 
		ie_retorno_w	:= 'N';
	end if;
	 
	if (coalesce(ie_opcao_p,'D') = 'D') then 
		if (ie_retorno_w = 'S') then 
			ie_retorno_w	:= wheb_mensagem_pck.get_texto(306949); -- Sim 
		elsif (ie_retorno_w = 'N') then
			ie_retorno_w	:= wheb_mensagem_pck.get_texto(306950); -- Não 
		end if;
	end if;
	 
end if;
 
return	ie_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_pac_atrasado_agecons ( nr_seq_agenda_p bigint, ie_opcao_p text default 'D') FROM PUBLIC;

