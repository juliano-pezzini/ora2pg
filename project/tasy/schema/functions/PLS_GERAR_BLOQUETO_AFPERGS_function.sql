-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_gerar_bloqueto_afpergs ( nr_titulo_p bigint) RETURNS varchar AS $body$
DECLARE


nr_bloqueto_w			varchar(255);
cd_agencia_w			varchar(255);
cd_conta_w			varchar(255);
dt_vencimento_w			timestamp;
nr_titulo_w			bigint;
vl_saldo_titulo_w		double precision;
vl_bloqueto_w			bigint;
nr_digito_w			bigint;
cd_fator_w			bigint	:= 0;
ds_campo_livre_w		varchar(255);
cd_digito_w			bigint;
ie_tipo_cobranca_bloqueto_w	varchar(255);
cd_conta_bloqueto_w		varchar(255);
cd_carteira_w			varchar(255);
cd_convenio_banco_w		varchar(255);

cd_cod_banco_w			bigint;
cd_estabelecimento_w		smallint;
ie_juros_multa_barras_bloq_w	varchar(1)	:= 'N';


BEGIN

select	coalesce(max(ie_juros_multa_barras_bloq),'N')
into STRICT	ie_juros_multa_barras_bloq_w
from	parametro_contas_receber;

select	coalesce('1000','0'),
	coalesce('0129800','0'),
	coalesce(cd_conta_bloqueto,'0'),
	coalesce(ie_tipo_cobranca_bloqueto,'003'),
	a.dt_pagamento_previsto,
	a.vl_saldo_titulo,
	a.nr_titulo,
	coalesce(d.cd_carteira, substr(coalesce(b.cd_carteira,'0'), 1,3)),
	b.cd_banco,
	coalesce(d.cd_convenio_banco, b.cd_convenio_banco),
	b.cd_estabelecimento
into STRICT	cd_agencia_w,
	cd_conta_w,
	cd_conta_bloqueto_w,
	ie_tipo_cobranca_bloqueto_w,
	dt_vencimento_w,
	vl_saldo_titulo_w,
	nr_titulo_w,
	cd_carteira_w,
	cd_cod_banco_w,
	cd_convenio_banco_w,
	cd_estabelecimento_w
FROM moeda c, banco_estabelecimento b, titulo_receber a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.nr_seq_conta_banco	= b.nr_sequencia and a.cd_moeda   		= c.cd_moeda  and a.nr_titulo 		= nr_titulo_p;

if (ie_juros_multa_barras_bloq_w = 'S') then
	vl_saldo_titulo_w	:= vl_saldo_titulo_w + obter_juros_multa_titulo(nr_titulo_w, clock_timestamp(), 'R','A');
end if;

vl_bloqueto_w	:= vl_saldo_titulo_w * 100;

cd_fator_w	:= trunc(dt_vencimento_w,'dd') - to_date('07/10/1997','dd/mm/yyyy');

ds_campo_livre_w :=	'21' ||
			to_char(Somente_Numero(substr(cd_agencia_w,1,4)),'FM0000') ||
			to_char(Somente_numero(substr(cd_conta_w,1,7)),'FM0000000') ||
			to_char(Somente_numero(substr(nr_titulo_w,1,9)),'FM0000000')||'0'||
			'41';

nr_bloqueto_w	:= 	'0419' || '?' ||
			to_char(cd_fator_w,'FM0000') ||
			to_char(Somente_Numero(substr(vl_bloqueto_w,1,14)),'FM0000000000') ||
			'21' ||
			to_char(Somente_Numero(substr(cd_agencia_w,1,4)),'FM0000') ||
			to_char(Somente_numero(substr(cd_conta_w,1,7)),'FM0000000') ||
			to_char(Somente_numero(substr(nr_titulo_w,1,9)),'FM0000000')||'0'||
			'41'||lpad(to_char(calcula_digito('BANRISUL',ds_campo_livre_w)),2,'0');


nr_digito_w		:= Calcula_Digito('Bloqueto', nr_bloqueto_w);


nr_bloqueto_w		:= substr(nr_bloqueto_w,1,4) || nr_digito_w || substr(nr_bloqueto_w,6,39);

return nr_bloqueto_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_gerar_bloqueto_afpergs ( nr_titulo_p bigint) FROM PUBLIC;

