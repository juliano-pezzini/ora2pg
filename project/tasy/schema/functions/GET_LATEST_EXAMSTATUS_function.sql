-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_latest_examstatus (cd_pessoa_fisica_p text, hr_inicio_p timestamp, exam_type_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_status_w   varchar(254);
nr_sequencia_exam_w   bigint;
ds_status_w           varchar(254);

c01 CURSOR FOR
    SELECT
        a.ie_status_agenda
    FROM
        agenda_paciente   a,
        proc_interno      b
    WHERE
        a.cd_pessoa_fisica = cd_pessoa_fisica_p
        AND a.hr_inicio BETWEEN trunc(hr_inicio_p) AND trunc(hr_inicio_p) + 86399 / 86400
        AND ie_status_agenda <> 'C'
        AND a.nr_seq_proc_interno = b.nr_sequencia
        AND b.nr_seq_classif = nr_sequencia_exam_w
        AND (a.nr_seq_proc_interno IS NOT NULL AND a.nr_seq_proc_interno::text <> '');


BEGIN
    SELECT
        nr_sequencia
    INTO STRICT nr_sequencia_exam_w
    FROM (   SELECT nr_sequencia,row_number() OVER () AS rn from (SELECT 	a.nr_sequencia
            FROM	proc_interno_classif a
            WHERE	a.ie_con_epc = 'S'
            ORDER BY	a.nr_sequencia DESC) alias0
        ) alias1
    WHERE	rn = exam_type_p;

    OPEN c01;
    LOOP
        FETCH c01 INTO ds_status_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
        IF ( ds_status_w != 'E' ) THEN
            ds_retorno_status_w := obter_desc_expressao(312911);
        END IF;

        IF ( coalesce(ds_retorno_status_w::text, '') = '' AND ds_status_w = 'E' ) THEN
            ds_retorno_status_w := obter_desc_expressao(289766);
        END IF;

    END LOOP;

    CLOSE c01;
    RETURN ds_retorno_status_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_latest_examstatus (cd_pessoa_fisica_p text, hr_inicio_p timestamp, exam_type_p bigint) FROM PUBLIC;

