-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_reprov_lib_comunic_cih ( nr_prescricao_p bigint, nr_seq_material_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(4000);
qt_dose_w			prescr_material.qt_dose%type;
cd_unid_med_w			prescr_material.cd_unidade_medida_dose%type;
qt_dias_solic_w			prescr_material.qt_dias_solicitado%type;
qt_dias_lib_w			prescr_material.qt_dias_liberado%type;
cd_intervalo_w			prescr_material.cd_intervalo%type;
ie_via_aplicacao_w			prescr_material.ie_via_aplicacao%type;
ds_material_w			varchar(255);
ds_usuario_w			varchar(255);


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then
	SELECT 		obter_desc_material(MAX(a.cd_material)),
			MAX(a.cd_unidade_medida_dose),
			MAX(a.ie_via_aplicacao),
			MAX(a.cd_intervalo),
			MAX(a.qt_dose),
			MAX(a.qt_dias_liberado),
			MAX(a.qt_dias_solicitado)
	INTO STRICT		ds_material_w,
			cd_unid_med_w,
			ie_via_aplicacao_w,
			cd_intervalo_w,
			qt_dose_w,
			qt_dias_lib_w,
			qt_dias_solic_w
	FROM 		prescr_material a
	WHERE 		a.nr_prescricao  = nr_prescricao_p
	AND		a.nr_sequencia   = nr_seq_material_p;
end if;

ds_usuario_w:= obter_desc_usuario(nm_usuario_p);

ds_retorno_w:= WHEB_MENSAGEM_PCK.get_texto(458134,'ds_usuario='||ds_usuario_w||';ds_material='||ds_material_w||
               	';qt_dose='||qt_dose_w||';cd_unid_med='||cd_unid_med_w||';desc_intervalo_prescr='||obter_desc_intervalo_prescr(cd_intervalo_w)||
               	';desc_via='||obter_desc_via(ie_via_aplicacao_w)||';qt_dias_solic='||qt_dias_solic_w||';qt_dias_lib='||qt_dias_lib_w);

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_reprov_lib_comunic_cih ( nr_prescricao_p bigint, nr_seq_material_p bigint, nm_usuario_p text) FROM PUBLIC;

