-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nut_obter_derivados_prod (nr_seq_producao_p bigint, cd_material_p bigint, nr_prescricao_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(4000);
ds_derivado_w	varchar(255);
qt_porcentagem_w	double precision;

C01 CURSOR FOR
	SELECT  DISTINCT e.ds_material ds_derivado,
	coalesce(d.qt_porcentagem,0) qt_porcentagem
	FROM 	material e,
		nut_prod_lac_item a,
		nut_prod_lac_item_adic d,
		prescr_material f
	WHERE   a.cd_material = e.cd_material
    AND	  a.nr_sequencia = d.nr_seq_prod_item
    AND	  f.nr_prescricao = d.nr_prescricao
    AND 	d.nr_prescricao = nr_prescricao_p
    AND	  f.nr_sequencia = d.nr_seq_material
    AND   a.nr_seq_prod_princ = nr_seq_producao_p
    AND	  a.cd_material = cd_material_p
	ORDER BY 1;


BEGIN

OPEN C01;
LOOP
FETCH C01 INTO
	ds_derivado_w,
	qt_porcentagem_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN
	IF (ie_opcao_p = 'D') THEN
		ds_retorno_w := ds_retorno_w || ds_derivado_w || ' (' || qt_porcentagem_w || '%), ';
	ELSIF (ie_opcao_p = 'C') THEN
		ds_retorno_w := ds_retorno_w || qt_porcentagem_w;
	ELSIF (ie_opcao_p = 'T') THEN
	    ds_retorno_w  := ds_retorno_w || round(qt_porcentagem_w);
	END IF;

	END;
END LOOP;
CLOSE C01;

IF (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') AND (ie_opcao_p = 'D') THEN
	ds_retorno_w := SUBSTR(ds_retorno_w,1,LENGTH(ds_retorno_w)-2);
END IF;

RETURN	ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nut_obter_derivados_prod (nr_seq_producao_p bigint, cd_material_p bigint, nr_prescricao_p bigint, ie_opcao_p text) FROM PUBLIC;

