-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cp_get_diagnoses_assoc ( nr_seq_care_plan_p bigint, nr_seq_prescr_p bigint, ie_newline_p text default 'N') RETURNS varchar AS $body$
DECLARE

								
ds_diagnoses_w	varchar(4000)	:= null;
nr_atendimento_w	atendimento_paciente.nr_atendimento%type;
cd_pessoa_fisica_w	atendimento_paciente.cd_pessoa_fisica%type;
newline_w		varchar(100) := chr(13) || chr(10);
space_w			varchar(100) := '            ';

c01 CURSOR FOR
SELECT	obter_desc_expressao(847943,'Diagnóstico médico') || ': ' || substr(c.ds_doenca_cid,1,255) ds_clinical_term
from	cid_doenca c,
		atendimento_paciente c,
		diagnostico_doenca b,
		cp_clinical_term ct,
		cp_clinical_term_assoc cta
where	b.nr_atendimento = c.nr_atendimento
and		b.cd_doenca = c.cd_doenca_cid
and		b.nr_atendimento = nr_atendimento_w
and		cta.nr_seq_clin_term = ct.nr_sequencia
and		cta.nr_seq_care_plan = nr_seq_care_plan_p
and		upper(ct.cd_clinical_term) = b.cd_doenca
and		ct.si_type_of_term  = 'CID10'
and		b.ie_situacao = 'A'
and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
and		coalesce(b.dt_inativacao::text, '') = ''

union all

SELECT	obter_desc_expressao(847943,'Diagnóstico médico') || ': ' || substr(c.ds_doenca_cid,1,255) ds_clinical_term
from	cid_doenca c,
		diagnostico_doenca b,
		atendimento_paciente c,
		cp_clinical_term ct,
		cp_clinical_term_assoc cta
where	b.nr_atendimento = c.nr_atendimento
and		b.cd_doenca = c.cd_doenca_cid
and		c.cd_pessoa_fisica = cd_pessoa_fisica_w
and		cta.nr_seq_clin_term = ct.nr_sequencia
and		cta.nr_seq_care_plan = nr_seq_care_plan_p
and		upper(ct.cd_clinical_term) = b.cd_doenca
and		ct.si_type_of_term  = 'CID10'
and		coalesce(nr_atendimento_w::text, '') = ''
and		b.ie_situacao = 'A'
and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
and		coalesce(b.dt_inativacao::text, '') = ''

union all

select	obter_desc_expressao(671311,'Diagnóstico de enfermagem') || ': ' || substr(d.ds_diagnostico,1,255) ds_clinical_term
from	pe_diagnostico d,
		pe_prescr_diag c,
		pe_prescricao a,
		cp_clinical_term ct,
		cp_clinical_term_assoc cta
where	c.nr_seq_diag = d.nr_sequencia
and		a.nr_sequencia = c.nr_seq_prescr
and		a.nr_sequencia = nr_seq_prescr_p
and		cta.nr_seq_clin_term = ct.nr_sequencia
and		cta.nr_seq_care_plan = nr_seq_care_plan_p
and		upper(ct.cd_clinical_term) = upper(d.cd_externo)
and		ct.si_type_of_term = 'NURSING';
								
BEGIN

if (nr_seq_care_plan_p IS NOT NULL AND nr_seq_care_plan_p::text <> '') and (nr_seq_prescr_p IS NOT NULL AND nr_seq_prescr_p::text <> '') then
	select	a.nr_atendimento,
			a.cd_pessoa_fisica
	into STRICT	nr_atendimento_w,
			cd_pessoa_fisica_w
	from	pe_prescricao a
	where	a.nr_sequencia = nr_seq_prescr_p;
	
	for r_c01 in c01 loop
		if (coalesce(ds_diagnoses_w::text, '') = '') then
			if (ie_newline_p = 'Y') then			
				ds_diagnoses_w	:= substr(space_w || r_c01.ds_clinical_term,1,4000);
			else
				ds_diagnoses_w	:= substr(r_c01.ds_clinical_term,1,4000);
			end if;
		else	
			if (ie_newline_p = 'Y') then
				ds_diagnoses_w	:= substr(ds_diagnoses_w || ', ' || newline_w || space_w || r_c01.ds_clinical_term,1,4000);
			else
				ds_diagnoses_w	:= substr(ds_diagnoses_w || ', ' || r_c01.ds_clinical_term,1,4000);
			end if;
		end if;
	end loop;
end if;

return ds_diagnoses_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cp_get_diagnoses_assoc ( nr_seq_care_plan_p bigint, nr_seq_prescr_p bigint, ie_newline_p text default 'N') FROM PUBLIC;

