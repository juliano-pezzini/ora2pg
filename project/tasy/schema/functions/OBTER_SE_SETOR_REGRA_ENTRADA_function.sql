-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_setor_regra_entrada (cd_setor_atendimento_p bigint, ie_clinica_p bigint, ie_tipo_atendimento_p bigint, ie_regra_p text, nr_seq_classificacao_p bigint, cd_convenio_p bigint, cd_categoria_p bigint, nm_usuario_p text, nr_atendimento_p bigint default null) RETURNS varchar AS $body$
DECLARE


ie_liberado_w			varchar(01) := 'N';
cd_classif_setor_w		varchar(02);
qt_setor_usuario_w		bigint;
qt_regra_convenio_w		integer;
ie_tipo_convenio_w		smallint;
qt_regra_tipo_convenio_w	integer;
qt_regra_categoria_w		integer;
ie_verifica_se_gv_w		varchar(2);
cd_medico_resp_w		varchar(10);
cd_estabelecimento_w		smallint;
cd_especialidade_medico_w	varchar(4000);
cd_especialidade_medico_ww	especialidade_medica.cd_especialidade%type;
nr_seq_regra_perfil_w		bigint;
cd_estabelecimento_ww		smallint;
qt_regra_clinica_setor_w   	smallint;
ie_categoria_convenio_w    	varchar(2);
qt_regra_clinica_w		bigint;
nr_seq_classif_w		bigint;
ie_nivel_atencao_usuario_w 	varchar(1) := 'T';
cd_estabelecimento_base_w	setor_atendimento.cd_estabelecimento_base%type;

C01 CURSOR FOR
	SELECT a.cd_especialidade
	FROM	especialidade_medica b,
		medico_especialidade a
	WHERE 	a.cd_especialidade	= b.cd_especialidade
	AND	a.cd_pessoa_fisica	= cd_medico_resp_w;


BEGIN
ie_liberado_w		:= 'N';

if (coalesce(cd_estabelecimento_ww::text, '') = '') then
	cd_estabelecimento_ww := wheb_usuario_pck.get_cd_estabelecimento;
end if;

select	max(cd_classif_setor),
		coalesce(max(ie_verifica_se_gv),'N'),
		max(cd_estabelecimento_base)
into STRICT	cd_classif_setor_w,
		ie_verifica_se_gv_w,
		cd_estabelecimento_base_w
from	setor_atendimento
where	cd_setor_atendimento	= cd_setor_atendimento_p;

if (ie_tipo_atendimento_p	in (7,8)) and (cd_classif_setor_w	= '5') and (ie_regra_p	not in ('SCCSS','SSU','CTA','SCCTA','SSC', 'SEM','SPU', 'SCLU','SCTP')) then
	ie_liberado_w		:= 'S';
end if;

if (ie_tipo_atendimento_p	= 8) then

	ie_nivel_atencao_usuario_w := wheb_assist_pck.get_nivel_atencao_perfil;

	if ( ie_nivel_atencao_usuario_w  = 'P') then

	    ie_liberado_w := 'S';

	end if;

end if;

if (ie_liberado_w = 'N') then
	begin

	if	((ie_regra_p	= 'S') or (ie_regra_p	= 'T')) and (cd_classif_setor_w in ('1','2','3','4','5','7','8','9','10','12','13')) then
		ie_liberado_w		:= 'S';
		
	elsif (ie_regra_p	= 'N') and (cd_classif_setor_w in ('1','2','3','4','8','9','12','13')) then
		ie_liberado_w		:= 'S';
		
	elsif (ie_regra_p	= 'E') and (cd_classif_setor_w in ('1','2','3','4','5','8','12','13')) then
		ie_liberado_w		:= 'S';
		
	elsif (ie_regra_p	= 'PS') and (cd_classif_setor_w = '1') then
		ie_liberado_w		:= 'S';
		
	elsif (ie_regra_p	= 'RN') and (cd_classif_setor_w = '9') then
		ie_liberado_w		:= 'S';
		
	elsif (ie_regra_p	= 'SU') and (cd_classif_setor_w in ('1','2','3','4','5','8','10','12','13')) then

		select	count(*)
		into STRICT	qt_setor_usuario_w
		from	usuario_setor
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	nm_usuario_param	= nm_usuario_p;

		if (qt_setor_usuario_w > 0) then
			ie_liberado_w		:= 'S';
		end if;
	elsif (ie_regra_p	= 'SSU') then
		select	count(*)
		into STRICT	qt_setor_usuario_w
		from	usuario_setor
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	nm_usuario_param	= nm_usuario_p;

		if (qt_setor_usuario_w > 0) then
			ie_liberado_w		:= 'S';
		end if;
	elsif (ie_regra_p	= 'TA') then
		if (cd_classif_setor_w in ('2','3','4')) and (ie_tipo_atendimento_p = 1) then
			ie_liberado_w		:= 'S';
		elsif (cd_classif_setor_w = '1') and (ie_tipo_atendimento_p = 3) then
			ie_liberado_w		:= 'S';
		elsif (cd_classif_setor_w	= '5') and (ie_tipo_atendimento_p	in (7,8)) then
			ie_liberado_w		:= 'S';
		end if;
	elsif (ie_regra_p = 'TACG') then
        if (cd_classif_setor_w in ('2','3','4')) and (ie_tipo_atendimento_p = 1) then
            ie_liberado_w := 'S';
        elsif (cd_classif_setor_w = '2') and (ie_tipo_atendimento_p = 8) then
            ie_liberado_w := 'S';
		elsif (cd_classif_setor_w = '1') and (ie_tipo_atendimento_p = 8) then
            ie_liberado_w := 'S';
		elsif (cd_classif_setor_w	= '5') and (ie_tipo_atendimento_p in (7,8)) then
            ie_liberado_w := 'S';
		end if;
	elsif (ie_regra_p	= 'TSP') and (cd_classif_setor_w in ('1','2','3','4','5','6','7','8','9','10','12','13')) then
		ie_liberado_w		:= 'S';		
	elsif	((ie_regra_p	= 'TACC') or (ie_regra_p	= 'TACCE'))then
		if (cd_classif_setor_w in ('3','4')) and (ie_tipo_atendimento_p = 1) then
			ie_liberado_w		:= 'S';
		elsif (cd_classif_setor_w = '1') and (ie_tipo_atendimento_p = 3) then
			ie_liberado_w		:= 'S';
		elsif (cd_classif_setor_w	in ('5','2')) and (ie_tipo_atendimento_p	in (7,8)) then
			ie_liberado_w		:= 'S';
		end if;
		
		if (ie_regra_p	= 'TACCE' and ie_liberado_w = 'S') then			
			begin
				select	'S'
				into STRICT	ie_liberado_w
				
				where	obter_se_usuario_estab(nm_usuario_p,cd_estabelecimento_base_w) = 'S';
			exception
			when others then
				ie_liberado_w := 'N';
			end;
		end if;
		
	elsif (ie_regra_p	= 'SC') then
		begin

		select	coalesce(max('S'), 'N')
		into STRICT	ie_liberado_w
		from 	regra_clinica_setor
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	ie_clinica		= ie_clinica_p
		and	coalesce(cd_estabelecimento,cd_estabelecimento_ww) = cd_estabelecimento_ww;
	
		end;
	elsif (ie_regra_p	= 'SSC') then
		begin
		select	coalesce(max('S'), 'N')
		into STRICT	ie_liberado_w
		from 	regra_clinica_setor
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	ie_clinica		= ie_clinica_p
		and	coalesce(cd_estabelecimento,cd_estabelecimento_ww) = cd_estabelecimento_ww;
		end;
	elsif (ie_regra_p= 'SCCSS') then
		begin
		
		select	coalesce(max('S'), 'N')
		into STRICT	ie_liberado_w
		from 	regra_classificacao_setor
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	nr_seq_classificacao	= nr_seq_classificacao_p;	
		
		end;	
	elsif (ie_regra_p	= 'SCC') then
		begin

		select	coalesce(max('S'), 'N')
		into STRICT	ie_liberado_w
		from 	regra_classificacao_setor
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	nr_seq_classificacao	= nr_seq_classificacao_p;
	
		end;
	elsif (ie_regra_p	= 'SCCTA') then
		begin

		select	coalesce(max('S'), 'N')
		into STRICT	ie_liberado_w
		from 	regra_classificacao_setor
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	nr_seq_classificacao	= nr_seq_classificacao_p;
		
		if (ie_liberado_w	= 'S') then
			ie_liberado_w	:= 'N';
			
			if (cd_classif_setor_w in ('2','3','4','12')) and (ie_tipo_atendimento_p = 1) then
				ie_liberado_w		:= 'S';
			elsif (cd_classif_setor_w = '1') and (ie_tipo_atendimento_p = 3) then
				ie_liberado_w		:= 'S';
			elsif (cd_classif_setor_w	= '5') and (ie_tipo_atendimento_p	in (7,8)) then
				ie_liberado_w		:= 'S';
			end if;
			
		end if;
	
		end;
	elsif (ie_regra_p	= 'CLATIA') then
		begin

		select	coalesce(max('S'), 'N')
		into STRICT	ie_liberado_w
		from 	regra_classificacao_setor
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	nr_seq_classificacao	= nr_seq_classificacao_p;
		
			
		if	(((cd_classif_setor_w in ('2','3','4','12')) and (ie_tipo_atendimento_p = 1)) or (ie_liberado_w = 'S')) then
			ie_liberado_w		:= 'S';
		elsif	((cd_classif_setor_w = '1' AND ie_tipo_atendimento_p = 3) or (ie_liberado_w = 'S')) then
			ie_liberado_w		:= 'S';
		elsif	((cd_classif_setor_w	= '5') and (ie_tipo_atendimento_p	in (7,8)) or (ie_liberado_w = 'S')) then
			ie_liberado_w		:= 'S';
		end if;
	
		end;
	elsif (ie_regra_p	= 'SE') then	
		
		if (ie_verifica_se_gv_w = 'S') then
			ie_liberado_w		:= 'S';
		end if;
			
	elsif (ie_regra_p	= 'C') then
		
		select	max(ie_tipo_convenio)
		into STRICT	ie_tipo_convenio_w
		from	convenio
		where	cd_convenio	= cd_convenio_p;
	
		select	count(*)
		into STRICT	qt_regra_tipo_convenio_w
		from	regra_convenio_setor
		where	ie_tipo_convenio	= ie_tipo_convenio_w;
	
		select	count(*)
		into STRICT	qt_regra_convenio_w
		from	regra_convenio_setor
		where	cd_convenio	= cd_convenio_p;
		
		select	count(*)
		into STRICT	qt_regra_categoria_w
		from	regra_convenio_setor
		where	cd_convenio	= cd_convenio_p
		and		cd_categoria = cd_categoria_p;
		
		if (qt_regra_convenio_w	> 0) or (qt_regra_tipo_convenio_w > 0) then
			select	coalesce(max('S'),'N')
			into STRICT	ie_liberado_w
			from	regra_convenio_setor
			where	cd_setor_atendimento	= cd_setor_atendimento_p
			and	((cd_convenio		= cd_convenio_p)	
			and cd_categoria = coalesce(cd_categoria_p,cd_categoria)
			or (qt_regra_categoria_w = 0) and ie_tipo_convenio	= ie_tipo_convenio_w);
		else
			ie_liberado_w	:= 'S';
		end if;
	elsif (ie_regra_p	= 'CTA') then
		
		select	max(ie_tipo_convenio)
		into STRICT	ie_tipo_convenio_w
		from	convenio
		where	cd_convenio	= cd_convenio_p;
	
		select	count(*)
		into STRICT	qt_regra_tipo_convenio_w
		from	regra_convenio_setor
		where	ie_tipo_convenio	= ie_tipo_convenio_w;
	
		select	count(*)
		into STRICT	qt_regra_convenio_w
		from	regra_convenio_setor
		where	cd_convenio	= cd_convenio_p;
		
		select	count(*)
		into STRICT	qt_regra_categoria_w
		from	regra_convenio_setor
		where	cd_convenio	= cd_convenio_p
		and		cd_categoria = cd_categoria_p;
		
		if (qt_regra_convenio_w	> 0) or (qt_regra_tipo_convenio_w > 0) then
			select	coalesce(max('S'),'N')
			into STRICT	ie_liberado_w
			from	regra_convenio_setor
			where	cd_setor_atendimento	= cd_setor_atendimento_p
			and	((cd_convenio		= cd_convenio_p)	
			and cd_categoria = coalesce(cd_categoria_p,cd_categoria)
			or (qt_regra_categoria_w = 0) and ie_tipo_convenio	= ie_tipo_convenio_w);
		else
			ie_liberado_w	:= 'S';
		end if;
		
		if (ie_liberado_w = 'S') then
			if (cd_classif_setor_w in ('2','3','4','12')) and (ie_tipo_atendimento_p = 1) then
				ie_liberado_w		:= 'S';
			elsif (cd_classif_setor_w = '1') and (ie_tipo_atendimento_p = 3) then
				ie_liberado_w		:= 'S';
			elsif (cd_classif_setor_w	= '5') and (ie_tipo_atendimento_p	in (7,8)) then
				ie_liberado_w		:= 'S';
			else
				ie_liberado_w		:= 'N';
			end if;
		end if;
		
	elsif (ie_regra_p	= 'CTV') then
		
		select (coalesce(obter_se_vagas_clinica(ie_clinica_p,cd_setor_atendimento_p,cd_convenio_p),'N'))
		into STRICT	ie_liberado_w
		;
		
	elsif (ie_regra_p	= 'SEM') then
	
		if (coalesce(nr_atendimento_p,0) > 0) then

			select	cd_medico_resp,
				cd_estabelecimento
			into STRICT	cd_medico_resp_w,
				cd_estabelecimento_w
			from	atendimento_paciente
			where	nr_atendimento = nr_atendimento_p;
			
			if (cd_medico_resp_w IS NOT NULL AND cd_medico_resp_w::text <> '') then
				open C01;
				loop
				fetch C01 into	
					cd_especialidade_medico_ww;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					begin
					if (coalesce(cd_especialidade_medico_w::text, '') = '') then
						cd_especialidade_medico_w := cd_especialidade_medico_ww|| ',';
					else
						cd_especialidade_medico_w := cd_especialidade_medico_w ||','|| cd_especialidade_medico_ww;
					end if;
					
					end;
				end loop;
				close C01;			
			
				if (cd_especialidade_medico_w IS NOT NULL AND cd_especialidade_medico_w::text <> '') then
			
					select	coalesce(max('S'), 'N')
					into STRICT	ie_liberado_w
					from 	regra_especialidade_setor
					where	cd_setor_atendimento	= cd_setor_atendimento_p
					and	obter_se_contido_entre_virgula(cd_especialidade_medico_w, cd_especialidade) = 'S'
					and	cd_estabelecimento	= cd_estabelecimento_w;
				
				end if;
			end if;
		
		end if;
	elsif (ie_regra_p = 'SPU') then -- Regra de liberações por perfil (Shift + F11)
		
		select	max(cd_estabelecimento),
			coalesce(max(nr_seq_classificacao),0)
		into STRICT	cd_estabelecimento_w,
			nr_seq_classif_w
		from	atendimento_paciente
		where	nr_atendimento = coalesce(nr_atendimento_p,0);

		if (coalesce(cd_estabelecimento_w::text, '') = '') then
			cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
		end if;
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_regra_perfil_w
		from	regra_perfil_recepcao
		where	cd_perfil = coalesce(obter_perfil_ativo,0)
		and	cd_estabelecimento = cd_estabelecimento_w
		and (coalesce(ie_tipo_atendimento,ie_tipo_atendimento_p) = ie_tipo_atendimento_p)
		and	ie_situacao = 'A';
		
		if (nr_seq_regra_perfil_w > 0) then			
			select	coalesce(max('S'), 'N')
			into STRICT	ie_liberado_w
			from	regra_perfil_set_recepcao
			where	nr_seq_regra_perfil = nr_seq_regra_perfil_w
			and	cd_setor_Atendimento = cd_setor_atendimento_p
			and (coalesce(nr_seq_classificacao,nr_seq_classif_w) = nr_seq_classif_w)
			and  	ie_situacao = 'A';
		else	
			ie_liberado_w := 'S';
		end if;
	elsif (ie_regra_p = 'SCLU') then -- Setores por clínica, somente setores liberados para o usuário
		
		select	coalesce(max('S'), 'N')
		into STRICT	ie_liberado_w
		from 	regra_clinica_setor
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	ie_clinica		= ie_clinica_p
		and	coalesce(cd_estabelecimento,cd_estabelecimento_ww) = cd_estabelecimento_ww;
		
		select	count(*)
		into STRICT	qt_setor_usuario_w
		from	usuario_setor
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	nm_usuario_param	= nm_usuario_p;

		if (qt_setor_usuario_w = 0) then
			ie_liberado_w	:= 'N';
		end if;
	elsif (ie_regra_p	= 'CSSC') then
		select	count(*)
		into STRICT	qt_regra_clinica_w
		from 	regra_clinica_setor
		where	ie_clinica		= ie_clinica_p
		and	coalesce(cd_estabelecimento,cd_estabelecimento_ww) = cd_estabelecimento_ww
		and	coalesce(cd_convenio,cd_convenio_p) = cd_convenio_p;
		
		if (qt_regra_clinica_w > 0) then
			select	count(*)
			into STRICT	qt_regra_clinica_setor_w
			from 	regra_clinica_setor
			where	cd_setor_atendimento	= cd_setor_atendimento_p
			and	ie_clinica		= ie_clinica_p
			and	coalesce(cd_estabelecimento,cd_estabelecimento_ww) = cd_estabelecimento_ww
			and	coalesce(cd_convenio,cd_convenio_p) = cd_convenio_p;
			
			if (qt_regra_clinica_setor_w > 0) then
				ie_liberado_w := 'S';	
			end if;	

		elsif (qt_regra_clinica_w = 0 ) then
			select	max(ie_tipo_convenio)
			into STRICT	ie_tipo_convenio_w
			from	convenio
			where	cd_convenio	= cd_convenio_p;
		
			select	count(*)
			into STRICT	qt_regra_tipo_convenio_w
			from	regra_convenio_setor
			where	coalesce(ie_tipo_convenio,ie_tipo_convenio_w)	= ie_tipo_convenio_w;
		
			select	count(*)
			into STRICT	qt_regra_convenio_w
			from	regra_convenio_setor
			where	coalesce(cd_convenio,cd_convenio_p)	= cd_convenio_p;
			
			select	count(*)
			into STRICT	qt_regra_categoria_w
			from	regra_convenio_setor
			where	cd_convenio	= cd_convenio_p
			and	coalesce(cd_categoria,cd_categoria_p) = cd_categoria_p;
			
			if (qt_regra_categoria_w > 0) and ((qt_regra_convenio_w	> 0) or (qt_regra_tipo_convenio_w > 0)) then
				select	coalesce(max('S'),'N')
				into STRICT	ie_liberado_w
				from	regra_convenio_setor
				where	cd_setor_atendimento	= cd_setor_atendimento_p
				and	((cd_convenio		= cd_convenio_p)	
				and coalesce(cd_categoria,cd_categoria_p) = coalesce(cd_categoria_p,cd_categoria)
				or (qt_regra_categoria_w = 0) and ie_tipo_convenio	= ie_tipo_convenio_w);
				
			elsif (qt_regra_categoria_w = 0) and ((qt_regra_convenio_w = 0) or (qt_regra_tipo_convenio_w = 0)) and (qt_regra_clinica_w = 0) then
				ie_liberado_w := 'S';
			end if;
		end if;
	elsif (ie_regra_p = 'SCTP') then
		begin
		select	coalesce(max('S'), 'N')
		into STRICT	ie_liberado_w
		from 	regra_clinica_setor
		where	cd_setor_atendimento	= cd_setor_atendimento_p
		and	ie_clinica		= ie_clinica_p
		and	coalesce(cd_estabelecimento,cd_estabelecimento_ww) = cd_estabelecimento_ww
		and	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_p) = ie_tipo_atendimento_p;
		end;
	elsif (obter_se_contido_char(cd_setor_atendimento_p,ie_regra_p)	= 'S') then
		ie_liberado_w		:= 'S';
	end if;
	end;
end if;
return	ie_liberado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_setor_regra_entrada (cd_setor_atendimento_p bigint, ie_clinica_p bigint, ie_tipo_atendimento_p bigint, ie_regra_p text, nr_seq_classificacao_p bigint, cd_convenio_p bigint, cd_categoria_p bigint, nm_usuario_p text, nr_atendimento_p bigint default null) FROM PUBLIC;

