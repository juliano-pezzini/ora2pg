-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_nome_masc_arq_fat ( nr_seq_guia_arquivo_p pls_fat_guia_arquivo.nr_sequencia%type, nr_seq_fatura_p pls_fatura.nr_sequencia%type, ds_mascara_p pls_regra_arquivo_fatura.nm_mascara_arquivo%type, ds_mascara_zip_p pls_regra_arquivo_fatura.nm_mascara_arquivo_zip%type, ds_mascara_adic_p pls_regra_arquivo_fatura.nm_mascara_arquivo%type, qt_arquivo_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_regra_p pls_regra_arquivo_fatura.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE

					
ds_retorno_w			varchar(255) := null;
ds_mascara_w			pls_regra_arquivo_fatura.nm_mascara_arquivo%type;
qt_arquivo_w			integer;
nr_seq_pagador_w		pls_contrato_pagador.nr_sequencia%type;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
nr_seq_intercambio_w		pls_intercambio.nr_sequencia%type;
nr_contrato_w			pls_contrato.nr_contrato%type;
vl_fat_total_w			varchar(255);
dt_ano_referencia_w		varchar(4);
dt_mes_referencia_w		varchar(2);
nr_fatura_w			ptu_fatura.nr_fatura%type;
nr_nota_credito_debito_w	ptu_fatura.nr_nota_credito_debito%type;
cd_unimed_origem_w		pls_congenere.cd_cooperativa%type;
qt_caracter_w			integer;
ds_valor_w			varchar(255);
ds_caracter_w			varchar(255);
nr_titulo_w			pls_fatura.nr_titulo%type;
nr_titulo_ndc_w			pls_fatura.nr_titulo_ndc%type;
ie_tipo_guia_w			pls_fat_guia_arquivo.ie_tipo_guia%type;
ie_tipo_guia_fund_w		pls_fat_guia_arquivo.ie_tipo_guia%type;
cd_operadora_empresa_w		pls_segurado.cd_operadora_empresa%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;

function  pls_obter_versao_tiss_de_para( nr_seq_regra_arq_p		pls_regra_arquivo_fatura.nr_sequencia%type ) return text is

cd_versao_w		pls_versao_tiss.cd_versao_tiss%type;


BEGIN

if (nr_seq_regra_arq_p IS NOT NULL AND nr_seq_regra_arq_p::text <> '') then
	select	CASE WHEN nr_seq_esquema_xml=101200 THEN  '2.02.03' WHEN nr_seq_esquema_xml=101252 THEN  '3.02.00' WHEN nr_seq_esquema_xml=101499 THEN  '3.02.01' WHEN nr_seq_esquema_xml=101809 THEN  '3.02.02' WHEN nr_seq_esquema_xml=101810 THEN  '3.03.01' WHEN nr_seq_esquema_xml=101985 THEN  '3.03.02' WHEN nr_seq_esquema_xml=102274 THEN  '3.03.03' WHEN nr_seq_esquema_xml=102626 THEN  '3.04.00' WHEN nr_seq_esquema_xml=102906 THEN  '3.04.01' WHEN nr_seq_esquema_xml=102932 THEN  '3.05.00' END
	into STRICT	cd_versao_w
	from	pls_regra_arquivo_fatura
	where	nr_sequencia = nr_seq_regra_arq_p
	and	(nr_seq_esquema_xml IS NOT NULL AND nr_seq_esquema_xml::text <> '');
end if;

return	cd_versao_w;

end;

begin

-- MASCARA
if (ds_mascara_p IS NOT NULL AND ds_mascara_p::text <> '') then
	ds_mascara_w := upper(ds_mascara_p);
	
	if (nr_seq_fatura_p IS NOT NULL AND nr_seq_fatura_p::text <> '') and (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') then
		ds_retorno_w := ds_mascara_w;
		qt_arquivo_w := qt_arquivo_p;
		cd_unimed_origem_w := pls_obter_unimed_estab(cd_estabelecimento_p);
		
		select	max(b.nr_seq_pagador),
			campo_mascara_virgula(coalesce(max(b.vl_fatura),0) + coalesce(max(b.vl_total_ndc),0)),
			to_char(max(a.dt_mesano_referencia),'yyyy'),
			to_char(max(a.dt_mesano_referencia),'mm'),
			max(b.nr_titulo)
		into STRICT	nr_seq_pagador_w,
			vl_fat_total_w,
			dt_ano_referencia_w,
			dt_mes_referencia_w,
			nr_titulo_w
		from	pls_fatura b,
			pls_lote_faturamento a
		where	a.nr_sequencia	= b.nr_seq_lote
		and	b.nr_sequencia	= nr_seq_fatura_p;
		
		select	max(nr_fatura),
			max(nr_nota_credito_debito)
		into STRICT	nr_fatura_w,
			nr_nota_credito_debito_w
		from	ptu_fatura
		where	nr_seq_pls_fatura = nr_seq_fatura_p;
		
		nr_fatura_w := coalesce(coalesce(nr_fatura_w, to_char(nr_titulo_w)), nr_seq_fatura_p);
		
		--inicio Pegar a sequencia do segurado jtrindade OS 1940383
		select	max(fc.nr_seq_segurado)
		into STRICT	nr_seq_segurado_w
		from	pls_fatura_conta	fc,
			pls_fatura_evento	fe,
			pls_fatura		f
		where	fe.nr_sequencia	= fc.nr_seq_fatura_evento
		and	f.nr_sequencia	= fe.nr_seq_fatura
		and	f.nr_sequencia	= nr_seq_fatura_p;
		
		-- obeter o codigo da empresa passando a sequencia do segurado
		select	substr(pls_obter_dados_segurado(nr_seq_segurado_w,'CDE'),1,255)
		into STRICT	cd_operadora_empresa_w
		;
		
		if (coalesce(cd_operadora_empresa_w::text, '') = '') then
			select	substr(pls_obter_dados_segurado(nr_seq_segurado_w,'CR'),5,4)
			into STRICT	cd_operadora_empresa_w
			;
		end if;
		
		-- caso nao encontre o codigo da empresa, pega da PLS_SEGURADADO
		if (coalesce(cd_operadora_empresa_w::text, '') = '') then
			select	max(cd_operadora_empresa)
			into STRICT	cd_operadora_empresa_w
			from	pls_segurado
			where	nr_seq_pagador	= nr_seq_pagador_w;
		end if; -- fim
		
		select	max(nr_seq_contrato),
			max(nr_seq_intercambio)
		into STRICT	nr_seq_contrato_w,
			nr_seq_intercambio_w
		from	pls_segurado
		where	nr_seq_pagador	= nr_seq_pagador_w;
		
		if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
			select	max(nr_contrato)
			into STRICT	nr_contrato_w
			from	pls_contrato
			where	nr_sequencia	= nr_seq_contrato_w;
		end if;
		
		nr_contrato_w := coalesce(coalesce(coalesce(nr_contrato_w, substr(pls_obter_dados_segurado(nr_seq_segurado_w, 'CR'), 5, 4)), nr_seq_intercambio_w), nr_seq_contrato_w);
		
		select	max(a.ie_tipo_guia),						-- Regra Tasy | 3 - Consulta | 4 -SADT | 5 - Internacao | 6 - Honorario Individual
			CASE WHEN max(a.ie_tipo_guia)='3' THEN '1' WHEN max(a.ie_tipo_guia)='4' THEN '2' WHEN max(a.ie_tipo_guia)='5' THEN '3' WHEN max(a.ie_tipo_guia)='6' THEN '4' END 	-- Regra estipulada pela Federacao SC | 1 - Consulta | 2 -SADT | 3 - Internacao | 4 - Honorario Individual
		into STRICT	ie_tipo_guia_w,
			ie_tipo_guia_fund_w
		from	pls_fat_guia_arquivo	a
		where	a.nr_sequencia		= nr_seq_guia_arquivo_p
		and	a.nr_seq_lote 		= (	SELECT	max( b.nr_sequencia )
							from	pls_lote_fat_guia_envio b
							where	b.nr_seq_fatura 	= nr_seq_fatura_p);
							
		if (ds_mascara_w like '%C%') then
			if (length(replace(ds_mascara_w, 'C', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'C', ''));
			ds_caracter_w := lpad('C',qt_caracter_w,'C');
			
			ds_valor_w := substr(coalesce(nr_contrato_w,0),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%V%') then
			if (length(replace(ds_mascara_w, 'V', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'V', ''));
			ds_caracter_w := lpad('V',qt_caracter_w,'V');
			
			ds_valor_w := substr(coalesce(elimina_caractere_especial(vl_fat_total_w),0),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace( ds_retorno_w ,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%A%') then
			if (length(replace(ds_mascara_w, 'A', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'A', ''));
			ds_caracter_w := lpad('A',qt_caracter_w,'A');
			
			ds_valor_w := substr(dt_ano_referencia_w,1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%M%') then
			if (length(replace(ds_mascara_w, 'M', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'M', ''));
			ds_caracter_w := lpad('M',qt_caracter_w,'M');
			
			ds_valor_w := substr(dt_mes_referencia_w,1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%F%') then
			if (length(replace(ds_mascara_w, 'F', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'F', ''));
			ds_caracter_w := lpad('F',qt_caracter_w,'F');
			
			ds_valor_w := substr(coalesce(nr_fatura_w,0),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%S%') then
			if (length(replace(ds_mascara_w, 'S', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'S', ''));
			ds_caracter_w := lpad('S',qt_caracter_w,'S');
			
			ds_valor_w := substr(coalesce(qt_arquivo_w,1),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%U%') then
			if (length(replace(ds_mascara_w, 'U', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'U', ''));
			ds_caracter_w := lpad('U',qt_caracter_w,'U');
			
			ds_valor_w := substr(somente_numero(cd_unimed_origem_w),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%N%') then			
			if (length(replace(ds_mascara_w, 'N', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'N', ''));
			ds_caracter_w := lpad('N',qt_caracter_w,'N');
			
			ds_valor_w := substr(somente_numero(coalesce(pls_obter_versao_tiss_de_para(nr_seq_regra_p),pls_obter_versao_tiss)),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%T%') then
			if (length(replace(ds_mascara_w, 'T', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'T', ''));
			ds_caracter_w := lpad('T',qt_caracter_w,'T');
			
			ds_valor_w := substr(somente_numero(ie_tipo_guia_w),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%G%') then		-- Regra estipulada pela Federacao SC
			if (length(replace(ds_mascara_w, 'G', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'G', ''));
			ds_caracter_w := lpad('G',qt_caracter_w,'G');
			
			ds_valor_w := substr(somente_numero(ie_tipo_guia_fund_w),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%E%') then
			if (length(replace(ds_mascara_w, 'E', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'E', ''));
			ds_caracter_w := lpad('E',qt_caracter_w,'E');
			
			ds_valor_w := substr(coalesce(cd_operadora_empresa_w,'0'),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
	end if;
	
-- MASCARA PARA ARQUIVO ZIP
elsif (ds_mascara_zip_p IS NOT NULL AND ds_mascara_zip_p::text <> '') then
	ds_mascara_w := upper(ds_mascara_zip_p);
	
	if (nr_seq_fatura_p IS NOT NULL AND nr_seq_fatura_p::text <> '') and (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') then
		ds_retorno_w := ds_mascara_w;
		qt_arquivo_w := qt_arquivo_p;
		cd_unimed_origem_w := pls_obter_unimed_estab(cd_estabelecimento_p);
		
		select	max(b.nr_seq_pagador),
			campo_mascara_virgula(coalesce(max(b.vl_fatura),0) + coalesce(max(b.vl_total_ndc),0)),
			to_char(max(a.dt_mesano_referencia),'yyyy'),
			to_char(max(a.dt_mesano_referencia),'mm'),
			max(b.nr_titulo)
		into STRICT	nr_seq_pagador_w,
			vl_fat_total_w,
			dt_ano_referencia_w,
			dt_mes_referencia_w,
			nr_titulo_w
		from	pls_fatura b,
			pls_lote_faturamento a
		where	a.nr_sequencia	= b.nr_seq_lote
		and	b.nr_sequencia	= nr_seq_fatura_p;
		
		select	max(nr_fatura),
			max(nr_nota_credito_debito)
		into STRICT	nr_fatura_w,
			nr_nota_credito_debito_w
		from	ptu_fatura
		where	nr_seq_pls_fatura = nr_seq_fatura_p;
		
		nr_fatura_w := coalesce(coalesce(nr_fatura_w, to_char(nr_titulo_w)), nr_seq_fatura_p);
		
		--inicio Pegar a sequencia do segurado jtrindade OS 1940383
		select	max(fc.nr_seq_segurado)
		into STRICT	nr_seq_segurado_w
		from	pls_fatura_conta	fc,
			pls_fatura_evento	fe,
			pls_fatura		f
		where	fe.nr_sequencia	= fc.nr_seq_fatura_evento
		and	f.nr_sequencia	= fe.nr_seq_fatura
		and	f.nr_sequencia	= nr_seq_fatura_p;
		
		-- obeter o codigo da empresa passando a sequencia do segurado
		select	substr(pls_obter_dados_segurado(nr_seq_segurado_w,'CDE'),1,255)
		into STRICT	cd_operadora_empresa_w
		;
		
		if (coalesce(cd_operadora_empresa_w::text, '') = '') then
			select	substr(pls_obter_dados_segurado(nr_seq_segurado_w,'CR'),5,4)
			into STRICT	cd_operadora_empresa_w
			;
		end if;
		
		-- caso nao encontre o codigo da empresa, pega da PLS_SEGURADADO
		if (coalesce(cd_operadora_empresa_w::text, '') = '') then
			select	max(cd_operadora_empresa)
			into STRICT	cd_operadora_empresa_w
			from	pls_segurado
			where	nr_seq_pagador	= nr_seq_pagador_w;
		end if; -- fim
			
		select	max(nr_seq_contrato),
			max(nr_seq_intercambio)
		into STRICT	nr_seq_contrato_w,
			nr_seq_intercambio_w
		from	pls_segurado
		where	nr_seq_pagador	= nr_seq_pagador_w;
		
		if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
			select	max(nr_contrato)
			into STRICT	nr_contrato_w
			from	pls_contrato
			where	nr_sequencia	= nr_seq_contrato_w;
		end if;
		
		nr_contrato_w := coalesce(coalesce(nr_contrato_w,nr_seq_intercambio_w),nr_seq_contrato_w);
		
		select	max(a.ie_tipo_guia),						-- Regra Tasy | 3 - Consulta | 4 -SADT | 5 - Internacao | 6 - Honorario Individual
			CASE WHEN max(a.ie_tipo_guia)='3' THEN '1' WHEN max(a.ie_tipo_guia)='4' THEN '2' WHEN max(a.ie_tipo_guia)='5' THEN '3' WHEN max(a.ie_tipo_guia)='6' THEN '4' END 	-- Regra estipulada pela Federacao SC | 1 - Consulta | 2 -SADT | 3 - Internacao | 4 - Honorario Individual
		into STRICT	ie_tipo_guia_w,
			ie_tipo_guia_fund_w
		from	pls_fat_guia_arquivo	a
		where	a.nr_sequencia		= nr_seq_guia_arquivo_p
		and	a.nr_seq_lote 		= (	SELECT	max( b.nr_sequencia )
							from	pls_lote_fat_guia_envio b
							where	b.nr_seq_fatura 	= nr_seq_fatura_p);
							
		if (ds_mascara_w like '%C%') then
			if (length(replace(ds_mascara_w, 'C', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'C', ''));
			ds_caracter_w := lpad('C',qt_caracter_w,'C');
			
			ds_valor_w := substr(coalesce(nr_contrato_w,0),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%V%') then
			if (length(replace(ds_mascara_w, 'V', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'V', ''));
			ds_caracter_w := lpad('V',qt_caracter_w,'V');
			
			ds_valor_w := substr(coalesce(elimina_caractere_especial(vl_fat_total_w),0),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%A%') then
			if (length(replace(ds_mascara_w, 'A', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'A', ''));
			ds_caracter_w := lpad('A',qt_caracter_w,'A');
			
			ds_valor_w := substr(dt_ano_referencia_w,1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%M%') then
			if (length(replace(ds_mascara_w, 'M', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'M', ''));
			ds_caracter_w := lpad('M',qt_caracter_w,'M');
			
			ds_valor_w := substr(dt_mes_referencia_w,1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%F%') then
			if (length(replace(ds_mascara_w, 'F', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'F', ''));
			ds_caracter_w := lpad('F',qt_caracter_w,'F');
			
			ds_valor_w := substr(coalesce(nr_fatura_w,0),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%S%') then
			if (length(replace(ds_mascara_w, 'S', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'S', ''));
			ds_caracter_w := lpad('S',qt_caracter_w,'S');
			
			ds_valor_w := substr(coalesce(qt_arquivo_w,1),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%U%') then
			if (length(replace(ds_mascara_w, 'U', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'U', ''));
			ds_caracter_w := lpad('U',qt_caracter_w,'U');
			
			ds_valor_w := substr(somente_numero(cd_unimed_origem_w),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%N%') then
			if (length(replace(ds_mascara_w, 'N', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'N', ''));
			ds_caracter_w := lpad('N',qt_caracter_w,'N');
			
			ds_valor_w := substr(somente_numero(coalesce(pls_obter_versao_tiss_de_para(nr_seq_regra_p),pls_obter_versao_tiss)),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%T%') then
			if (length(replace(ds_mascara_w, 'T', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'T', ''));
			ds_caracter_w := lpad('T',qt_caracter_w,'T');
			
			ds_valor_w := substr(somente_numero(ie_tipo_guia_w),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%G%') then		-- Regra estipulada pela Federacao SC
			if (length(replace(ds_mascara_w, 'G', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'G', ''));
			ds_caracter_w := lpad('G',qt_caracter_w,'G');
			
			ds_valor_w := substr(somente_numero(ie_tipo_guia_fund_w),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%E%') then
			if (length(replace(ds_mascara_w, 'E', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'E', ''));
			ds_caracter_w := lpad('E',qt_caracter_w,'E');
			
			ds_valor_w := substr(coalesce(cd_operadora_empresa_w,'0'),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
	end if;
	
-- MASCARA PARA ARQUIVO ADICIONAL
elsif (ds_mascara_adic_p IS NOT NULL AND ds_mascara_adic_p::text <> '') then
	ds_mascara_w := upper(ds_mascara_adic_p);
	
	if (nr_seq_fatura_p IS NOT NULL AND nr_seq_fatura_p::text <> '') and (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') then
		ds_retorno_w := ds_mascara_w;
		qt_arquivo_w := qt_arquivo_p;
		cd_unimed_origem_w := pls_obter_unimed_estab(cd_estabelecimento_p);
		
		select	max(b.nr_seq_pagador),
			campo_mascara_virgula(coalesce(max(b.vl_fatura),0) + coalesce(max(b.vl_total_ndc),0)),
			to_char(max(a.dt_mesano_referencia),'yyyy'),
			to_char(max(a.dt_mesano_referencia),'mm'),
			max(b.nr_titulo)
		into STRICT	nr_seq_pagador_w,
			vl_fat_total_w,
			dt_ano_referencia_w,
			dt_mes_referencia_w,
			nr_titulo_w
		from	pls_fatura b,
			pls_lote_faturamento a
		where	a.nr_sequencia	= b.nr_seq_lote
		and	b.nr_sequencia	= nr_seq_fatura_p;
		
		select	max(nr_fatura),
			max(nr_nota_credito_debito)
		into STRICT	nr_fatura_w,
			nr_nota_credito_debito_w
		from	ptu_fatura
		where	nr_seq_pls_fatura = nr_seq_fatura_p;
		
		nr_fatura_w := coalesce(coalesce(nr_fatura_w, to_char(nr_titulo_w)), nr_seq_fatura_p);
		
		--inicio Pegar a sequencia do segurado jtrindade OS 1940383
		select	max(fc.nr_seq_segurado)
		into STRICT	nr_seq_segurado_w
		from	pls_fatura_conta	fc,
			pls_fatura_evento	fe,
			pls_fatura		f
		where	fe.nr_sequencia	= fc.nr_seq_fatura_evento
		and	f.nr_sequencia	= fe.nr_seq_fatura
		and	f.nr_sequencia	= nr_seq_fatura_p;
		
		-- obeter o codigo da empresa passando a sequencia do segurado
		select	substr(pls_obter_dados_segurado(nr_seq_segurado_w,'CDE'),1,255)
		into STRICT	cd_operadora_empresa_w
		;
		
		if (coalesce(cd_operadora_empresa_w::text, '') = '') then
			select	substr(pls_obter_dados_segurado(nr_seq_segurado_w,'CR'),5,4)
			into STRICT	cd_operadora_empresa_w
			;
		end if;
		
		-- caso nao encontre o codigo da empresa, pega da PLS_SEGURADADO
		if (coalesce(cd_operadora_empresa_w::text, '') = '') then
			select	max(cd_operadora_empresa)
			into STRICT	cd_operadora_empresa_w
			from	pls_segurado
			where	nr_seq_pagador	= nr_seq_pagador_w;
		end if; -- fim
		
		select	max(nr_seq_contrato),
			max(nr_seq_intercambio)
		into STRICT	nr_seq_contrato_w,
			nr_seq_intercambio_w
		from	pls_segurado
		where	nr_seq_pagador	= nr_seq_pagador_w;
		
		if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
			select	max(nr_contrato)
			into STRICT	nr_contrato_w
			from	pls_contrato
			where	nr_sequencia	= nr_seq_contrato_w;
		end if;
		
		nr_contrato_w := coalesce(coalesce(nr_contrato_w,nr_seq_intercambio_w),nr_seq_contrato_w);
		
		select	max(a.ie_tipo_guia),						-- Regra Tasy | 3 - Consulta | 4 -SADT | 5 - Internacao | 6 - Honorario Individual
			CASE WHEN max(a.ie_tipo_guia)='3' THEN '1' WHEN max(a.ie_tipo_guia)='4' THEN '2' WHEN max(a.ie_tipo_guia)='5' THEN '3' WHEN max(a.ie_tipo_guia)='6' THEN '4' END 	-- Regra estipulada pela Federacao SC | 1 - Consulta | 2 -SADT | 3 - Internacao | 4 - Honorario Individual
		into STRICT	ie_tipo_guia_w,
			ie_tipo_guia_fund_w
		from	pls_fat_guia_arquivo	a
		where	a.nr_sequencia		= nr_seq_guia_arquivo_p
		and	a.nr_seq_lote 		= (	SELECT	max( b.nr_sequencia )
							from	pls_lote_fat_guia_envio b
							where	b.nr_seq_fatura 	= nr_seq_fatura_p);
							
		if (ds_mascara_w like '%C%') then
			if (length(replace(ds_mascara_w, 'C', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'C', ''));
			ds_caracter_w := lpad('C',qt_caracter_w,'C');
			
			ds_valor_w := substr(coalesce(nr_contrato_w,0),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%V%') then
			if (length(replace(ds_mascara_w, 'V', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'V', ''));
			ds_caracter_w := lpad('V',qt_caracter_w,'V');
			
			ds_valor_w := substr(coalesce(elimina_caractere_especial(vl_fat_total_w),0),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%A%') then
			if (length(replace(ds_mascara_w, 'A', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'A', ''));
			ds_caracter_w := lpad('A',qt_caracter_w,'A');
			
			ds_valor_w := substr(dt_ano_referencia_w,1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%M%') then
			if (length(replace(ds_mascara_w, 'M', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'M', ''));
			ds_caracter_w := lpad('M',qt_caracter_w,'M');
			
			ds_valor_w := substr(dt_mes_referencia_w,1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%F%') then
			if (length(replace(ds_mascara_w, 'F', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'F', ''));
			ds_caracter_w := lpad('F',qt_caracter_w,'F');
			
			ds_valor_w := substr(coalesce(nr_fatura_w,0),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%S%') then
			if (length(replace(ds_mascara_w, 'S', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'S', ''));
			ds_caracter_w := lpad('S',qt_caracter_w,'S');
			
			ds_valor_w := substr(coalesce(qt_arquivo_w,1),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%U%') then
			if (length(replace(ds_mascara_w, 'U', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'U', ''));
			ds_caracter_w := lpad('U',qt_caracter_w,'U');
			
			ds_valor_w := substr(somente_numero(cd_unimed_origem_w),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%N%') then
			if (length(replace(ds_mascara_w, 'N', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'N', ''));
			ds_caracter_w := lpad('N',qt_caracter_w,'N');
			
			ds_valor_w := substr(somente_numero(coalesce(pls_obter_versao_tiss_de_para(nr_seq_regra_p),pls_obter_versao_tiss)),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%T%') then
			if (length(replace(ds_mascara_w, 'T', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'T', ''));
			ds_caracter_w := lpad('T',qt_caracter_w,'T');
			
			ds_valor_w := substr(somente_numero(ie_tipo_guia_w),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%G%') then		-- Regra estipulada pela Federacao SC
			if (length(replace(ds_mascara_w, 'G', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'G', ''));
			ds_caracter_w := lpad('G',qt_caracter_w,'G');
			
			ds_valor_w := substr(somente_numero(ie_tipo_guia_fund_w),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
		
		if (ds_mascara_w like '%E%') then
			if (length(replace(ds_mascara_w, 'E', '')) is null) then
				ds_mascara_w := ' ' || ds_mascara_w;
			end if;
			
			qt_caracter_w := length(ds_mascara_w) - length(replace(ds_mascara_w, 'E', ''));
			ds_caracter_w := lpad('E',qt_caracter_w,'E');
			
			ds_valor_w := substr(coalesce(cd_operadora_empresa_w,'0'),1,qt_caracter_w);
			ds_valor_w := lpad(ds_valor_w,qt_caracter_w,'0');
			
			ds_retorno_w := replace(ds_retorno_w,ds_caracter_w,ds_valor_w);
		end if;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_nome_masc_arq_fat ( nr_seq_guia_arquivo_p pls_fat_guia_arquivo.nr_sequencia%type, nr_seq_fatura_p pls_fatura.nr_sequencia%type, ds_mascara_p pls_regra_arquivo_fatura.nm_mascara_arquivo%type, ds_mascara_zip_p pls_regra_arquivo_fatura.nm_mascara_arquivo_zip%type, ds_mascara_adic_p pls_regra_arquivo_fatura.nm_mascara_arquivo%type, qt_arquivo_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_regra_p pls_regra_arquivo_fatura.nr_sequencia%type) FROM PUBLIC;

