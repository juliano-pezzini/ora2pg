-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION km_obter_ultimo_quest_lib ( ie_tipo_conhecimento_p km_questionario.ie_tipo_conhecimento%type, cd_funcao_p funcao.cd_funcao%type default null, nr_seq_habilidade_p km_habilidade_tecnica.nr_sequencia%type default null, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type DEFAULT NULL, nm_usuario_p usuario.nm_usuario%type DEFAULT NULL) RETURNS KM_QUESTIONARIO.NR_SEQUENCIA%TYPE AS $body$
DECLARE


/*
IE_TIPO_CONHECIMENTO_P:
	S - Habilidade;
	P - Produto;
*/
nr_seq_questionario_w	km_questionario.nr_sequencia%type;


BEGIN


select	kq.nr_sequencia nr_seq_questionario
into STRICT	nr_seq_questionario_w
from	km_questionario kq
where	(kq.dt_liberacao IS NOT NULL AND kq.dt_liberacao::text <> '')
and	kq.ie_situacao = 'A'
/* Apenas os que sao liberados para o setor de atendimento */

and	exists (	SELECT	1
			from	km_questionario_lib ql
			where	ql.cd_setor_atendimento = cd_setor_atendimento_p
			and	(ql.dt_liberacao IS NOT NULL AND ql.dt_liberacao::text <> '')
			and	ql.ie_situacao = 'A')
/* E que foi liberado por ultimo */

and	kq.dt_liberacao = (	select	max(dt_liberacao)
				from	km_questionario kq2
				where	coalesce(kq2.cd_funcao,0) = coalesce(cd_funcao_p,0)
				and	coalesce(kq2.nr_seq_habilidade,0) = coalesce(nr_seq_habilidade_p,0)
				and	kq2.ie_situacao = 'A'
				/* Apenas os que sao liberados para o setor de atendimento */

				and	exists (	select	1
							from	km_questionario_lib ql
							where	ql.nr_seq_questionario = kq2.nr_sequencia
							and	ql.cd_setor_atendimento = cd_setor_atendimento_p
							and	(ql.dt_liberacao IS NOT NULL AND ql.dt_liberacao::text <> '')
							and	ql.ie_situacao = 'A'));

return nr_seq_questionario_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION km_obter_ultimo_quest_lib ( ie_tipo_conhecimento_p km_questionario.ie_tipo_conhecimento%type, cd_funcao_p funcao.cd_funcao%type default null, nr_seq_habilidade_p km_habilidade_tecnica.nr_sequencia%type default null, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type DEFAULT NULL, nm_usuario_p usuario.nm_usuario%type DEFAULT NULL) FROM PUBLIC;

