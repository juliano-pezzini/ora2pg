-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_usuario_exec ( nr_ordem_servico_p bigint, nm_usuario_p text, ie_opcao_p bigint) RETURNS varchar AS $body$
DECLARE


/*	ie_opção_p
	0 - Ambos
	1 - Executor (Responsável pela ordem)
	2 - Executor previsto

	-- Dom 3323:
	3 - Responsável pela execução
	4 - Acompanhamento da OS
	5 - Responsável pela análise da OS
	6 - Responsável pela validação

*/
ie_executor_w		varchar(01);
nm_usuario_w		varchar(15);
qt_usuario_prev_w		smallint;


BEGIN
if (ie_opcao_p in (0,1)) then
	begin
	select	nm_usuario_exec
	into STRICT	nm_usuario_w
	from	man_ordem_servico
	where	nr_sequencia 		= nr_ordem_servico_p;
	exception
	when others then
		nm_usuario_w := '';
	end;

end if;

if (ie_opcao_p in (0,2)) then
	begin
	select	1
	into STRICT	qt_usuario_prev_w
	from	man_ordem_servico_exec
	where	nr_seq_ordem		= nr_ordem_servico_p
	and	nm_usuario_exec		= nm_usuario_p  LIMIT 1;
	exception
	when others then
		qt_usuario_prev_w := 0;
	end;
end if;

ie_executor_w			:= 'N';

if (ie_opcao_p = 0) then
	if (nm_usuario_p = nm_usuario_w) or (qt_usuario_prev_w > 0) then
		ie_executor_w	:= 'S';
	end if;
elsif (ie_opcao_p = 1) then
	if (nm_usuario_p = nm_usuario_w) then
		ie_executor_w	:= 'S';
	end if;
elsif (ie_opcao_p = 2) then
	if (qt_usuario_prev_w > 0) then
		ie_executor_w	:= 'S';
	end if;
elsif (ie_opcao_p = 3) then
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_executor_w
	from	man_tipo_executor b,
		man_ordem_servico_exec a
	where	a.nr_seq_ordem		= nr_ordem_servico_p
	and	b.nr_sequencia		= a.nr_seq_tipo_exec
	and	upper(a.nm_usuario_exec)	= upper(nm_usuario_p)
	and	b.ie_tipo_executor 		= '1';
elsif (ie_opcao_p = 4) then
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_executor_w
	from	man_tipo_executor b,
		man_ordem_servico_exec a
	where	a.nr_seq_ordem		= nr_ordem_servico_p
	and	b.nr_sequencia		= a.nr_seq_tipo_exec
	and	upper(a.nm_usuario_exec)	= upper(nm_usuario_p)
	and	b.ie_tipo_executor	 	= '2';
elsif (ie_opcao_p = 5) then
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_executor_w
	from	man_tipo_executor b,
		man_ordem_servico_exec a
	where	a.nr_seq_ordem		= nr_ordem_servico_p
	and	b.nr_sequencia		= a.nr_seq_tipo_exec
	and	upper(a.nm_usuario_exec)	= upper(nm_usuario_p)
	and	b.ie_tipo_executor 		= '3';
elsif (ie_opcao_p = 6) then
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_executor_w
	from	man_tipo_executor b,
		man_ordem_servico_exec a
	where	a.nr_seq_ordem		= nr_ordem_servico_p
	and	b.nr_sequencia		= a.nr_seq_tipo_exec
	and	upper(a.nm_usuario_exec)	= upper(nm_usuario_p)
	and	b.ie_tipo_executor 		= '4';
end if;

RETURN ie_executor_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_usuario_exec ( nr_ordem_servico_p bigint, nm_usuario_p text, ie_opcao_p bigint) FROM PUBLIC;

