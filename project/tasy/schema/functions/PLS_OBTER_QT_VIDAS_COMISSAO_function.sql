-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_qt_vidas_comissao ( nr_seq_contrato_p bigint, nr_seq_intercambio_p bigint, dt_mesano_referencia_p timestamp, ie_acao_contrato_p text, nr_contrato_principal_p bigint, ie_referencia_vidas_p text, ie_considerar_ativos_p text) RETURNS bigint AS $body$
DECLARE


qt_vidas_w			integer;
qt_vidas_cont_princ_w		integer;
nr_seq_grupo_intercambio_w	pls_intercambio.nr_seq_grupo_intercambio%type;
nr_seq_grupo_w			pls_contrato_grupo.nr_seq_grupo%type;
nr_contrato_principal_w		pls_contrato.nr_contrato_principal%type;

/*
Criado índice :
*/
BEGIN

qt_vidas_w := 0;

if (ie_referencia_vidas_p = 'C') then -- C = Contrato
	--Contrato
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then
		--Verifica apenas ativos
		if (ie_considerar_ativos_p = 'S') then
			select	count(1)
			into STRICT	qt_vidas_w
			from	pls_segurado	a
			where	a.nr_seq_contrato = nr_seq_contrato_p
			and	((coalesce(dt_rescisao::text, '') = '') or ((dt_rescisao IS NOT NULL AND dt_rescisao::text <> '') and dt_rescisao > trunc(dt_mesano_referencia_p,'dd')) or ((dt_rescisao IS NOT NULL AND dt_rescisao::text <> '') and (dt_reativacao IS NOT NULL AND dt_reativacao::text <> '') and dt_reativacao > dt_rescisao and dt_reativacao < trunc(dt_mesano_referencia_p,'dd')));
		--verifica todos
		elsif (ie_considerar_ativos_p = 'N') then
			select	count(1)
			into STRICT	qt_vidas_w
			from	pls_segurado	a
			where	a.nr_seq_contrato = nr_seq_contrato_p;
		end if;
	--Intercâmbio
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then
		--Verifica apenas ativos
		if (ie_considerar_ativos_p = 'S') then
			select	count(1)
			into STRICT	qt_vidas_w
			from	pls_segurado	a
			where	a.nr_seq_intercambio = nr_seq_intercambio_p
			and	((coalesce(dt_rescisao::text, '') = '') or ((dt_rescisao IS NOT NULL AND dt_rescisao::text <> '') and dt_rescisao > trunc(dt_mesano_referencia_p,'dd')) or ((dt_rescisao IS NOT NULL AND dt_rescisao::text <> '') and (dt_reativacao IS NOT NULL AND dt_reativacao::text <> '') and dt_reativacao > dt_rescisao and dt_reativacao < trunc(dt_mesano_referencia_p,'dd')));
		--verifica todos
		elsif (ie_considerar_ativos_p = 'N') then
			select	count(1)
			into STRICT	qt_vidas_w
			from	pls_segurado	a
			where	a.nr_seq_intercambio = nr_seq_intercambio_p;
		end if;

	end if;
elsif (ie_referencia_vidas_p = 'G') then -- G = Grupo contratual
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then
		if (nr_contrato_principal_p IS NOT NULL AND nr_contrato_principal_p::text <> '') then
			--Verifica apenas ativos
			if (ie_considerar_ativos_p = 'S') then
				select	count(1)
				into STRICT	qt_vidas_cont_princ_w
				from	pls_contrato	b,
					pls_segurado 	a
				where	b.nr_sequencia	= a.nr_seq_contrato
				and	b.nr_sequencia	= nr_contrato_principal_p
				and	((coalesce(a.dt_rescisao::text, '') = '') or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and a.dt_rescisao > trunc(dt_mesano_referencia_p,'dd')) or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and (a.dt_reativacao IS NOT NULL AND a.dt_reativacao::text <> '') and a.dt_reativacao > a.dt_rescisao and a.dt_reativacao < trunc(dt_mesano_referencia_p,'dd')));

				select	count(1)
				into STRICT	qt_vidas_w
				from	pls_contrato	b,
					pls_segurado 	a
				where	b.nr_sequencia	= a.nr_seq_contrato
				and	b.nr_contrato_principal = nr_contrato_principal_p
				and	((coalesce(a.dt_rescisao::text, '') = '') or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and a.dt_rescisao > trunc(dt_mesano_referencia_p,'dd')) or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and (a.dt_reativacao IS NOT NULL AND a.dt_reativacao::text <> '') and a.dt_reativacao > a.dt_rescisao and a.dt_reativacao < trunc(dt_mesano_referencia_p,'dd')));
			--verifica todos
			elsif (ie_considerar_ativos_p = 'N') then
				select	count(1)
				into STRICT	qt_vidas_cont_princ_w
				from	pls_contrato	b,
					pls_segurado 	a
				where	b.nr_sequencia	= a.nr_seq_contrato
				and	b.nr_sequencia	= nr_contrato_principal_p;

				select	count(1)
				into STRICT	qt_vidas_w
				from	pls_contrato	b,
					pls_segurado 	a
				where	b.nr_sequencia	= a.nr_seq_contrato
				and	b.nr_contrato_principal = nr_contrato_principal_p;
			end if;

			qt_vidas_w	:= qt_vidas_w + qt_vidas_cont_princ_w;
		else
			select	max(nr_contrato_principal)
			into STRICT	nr_contrato_principal_w
			from	pls_contrato
			where	nr_sequencia	= nr_seq_contrato_p;

			--Verifica pelo contrato principal
			if (nr_contrato_principal_w IS NOT NULL AND nr_contrato_principal_w::text <> '') then
				--Verifica apenas ativos
				if (ie_considerar_ativos_p = 'S') then
					select	count(1)
					into STRICT	qt_vidas_cont_princ_w
					from	pls_contrato	b,
						pls_segurado 	a
					where	b.nr_sequencia	= a.nr_seq_contrato
					and	b.nr_sequencia	= nr_contrato_principal_w
					and	((coalesce(a.dt_rescisao::text, '') = '') or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and a.dt_rescisao > trunc(dt_mesano_referencia_p,'dd')) or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and (a.dt_reativacao IS NOT NULL AND a.dt_reativacao::text <> '') and a.dt_reativacao > a.dt_rescisao and a.dt_reativacao < trunc(dt_mesano_referencia_p,'dd')));

					select	count(1)
					into STRICT	qt_vidas_w
					from	pls_contrato	b,
						pls_segurado 	a
					where	b.nr_sequencia	= a.nr_seq_contrato
					and	b.nr_contrato_principal = nr_contrato_principal_w
					and	((coalesce(a.dt_rescisao::text, '') = '') or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and a.dt_rescisao > trunc(dt_mesano_referencia_p,'dd')) or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and (a.dt_reativacao IS NOT NULL AND a.dt_reativacao::text <> '') and a.dt_reativacao > a.dt_rescisao and a.dt_reativacao < trunc(dt_mesano_referencia_p,'dd')));
				--verifica todos
				elsif (ie_considerar_ativos_p = 'N') then
					select	count(1)
					into STRICT	qt_vidas_cont_princ_w
					from	pls_contrato	b,
						pls_segurado 	a
					where	b.nr_sequencia	= a.nr_seq_contrato
					and	b.nr_sequencia	= nr_contrato_principal_w;

					select	count(1)
					into STRICT	qt_vidas_w
					from	pls_contrato	b,
						pls_segurado 	a
					where	b.nr_sequencia	= a.nr_seq_contrato
					and	b.nr_contrato_principal = nr_contrato_principal_w;
				end if;

				qt_vidas_w	:= qt_vidas_w + qt_vidas_cont_princ_w;
			else
				--Verifica apenas ativos
				if (ie_considerar_ativos_p = 'S') then
					select	count(1)
					into STRICT	qt_vidas_cont_princ_w
					from	pls_contrato	b,
						pls_segurado 	a
					where	b.nr_sequencia	= a.nr_seq_contrato
					and	b.nr_sequencia	= nr_seq_contrato_p
					and	((coalesce(a.dt_rescisao::text, '') = '') or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and a.dt_rescisao > trunc(dt_mesano_referencia_p,'dd')) or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and (a.dt_reativacao IS NOT NULL AND a.dt_reativacao::text <> '') and a.dt_reativacao > a.dt_rescisao and a.dt_reativacao < trunc(dt_mesano_referencia_p,'dd')));

					select	count(1)
					into STRICT	qt_vidas_w
					from	pls_contrato	b,
						pls_segurado 	a
					where	b.nr_sequencia	= a.nr_seq_contrato
					and	b.nr_contrato_principal	= nr_seq_contrato_p
					and	((coalesce(a.dt_rescisao::text, '') = '') or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and a.dt_rescisao > trunc(dt_mesano_referencia_p,'dd')) or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and (a.dt_reativacao IS NOT NULL AND a.dt_reativacao::text <> '') and a.dt_reativacao > a.dt_rescisao and a.dt_reativacao < trunc(dt_mesano_referencia_p,'dd')));
				--verifica todos
				elsif (ie_considerar_ativos_p = 'N') then
					select	count(1)
					into STRICT	qt_vidas_cont_princ_w
					from	pls_contrato	b,
						pls_segurado 	a
					where	b.nr_sequencia	= a.nr_seq_contrato
					and	b.nr_sequencia	= nr_seq_contrato_p;

					select	count(1)
					into STRICT	qt_vidas_w
					from	pls_contrato	b,
						pls_segurado 	a
					where	b.nr_sequencia	= a.nr_seq_contrato
					and	b.nr_contrato_principal	= nr_seq_contrato_p;
				end if;

				qt_vidas_w	:= qt_vidas_w + qt_vidas_cont_princ_w;
			end if;
		end if;
	--Verifica para intercâmbio
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then
		select	max(nr_seq_grupo_intercambio)
		into STRICT	nr_seq_grupo_intercambio_w
		from	pls_intercambio
		where	nr_sequencia = nr_seq_intercambio_p;

		--Verifica apenas ativos
		if (ie_considerar_ativos_p = 'S') then
			select	count(1)
			into STRICT	qt_vidas_w
			from	pls_intercambio	b,
				pls_segurado 	a
			where	a.nr_seq_intercambio = b.nr_sequencia
			and	((b.nr_sequencia in (nr_seq_intercambio_p, nr_seq_grupo_intercambio_w)) or (b.nr_seq_grupo_intercambio in (nr_seq_intercambio_p, nr_seq_grupo_intercambio_w)))
			and	((coalesce(a.dt_rescisao::text, '') = '') or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and a.dt_rescisao > trunc(dt_mesano_referencia_p,'dd')) or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and (a.dt_reativacao IS NOT NULL AND a.dt_reativacao::text <> '') and a.dt_reativacao > a.dt_rescisao and a.dt_reativacao < trunc(dt_mesano_referencia_p,'dd')));
		--verifica todos
		elsif (ie_considerar_ativos_p = 'N') then
			select	count(1)
			into STRICT	qt_vidas_w
			from	pls_intercambio	b,
				pls_segurado 	a
			where	a.nr_seq_intercambio = b.nr_sequencia
			and	((b.nr_sequencia in (nr_seq_intercambio_p, nr_seq_grupo_intercambio_w)) or (b.nr_seq_grupo_intercambio in (nr_seq_intercambio_p, nr_seq_grupo_intercambio_w)));
		end if;
	end if;
elsif (ie_referencia_vidas_p = 'R') then -- R = Grupo relacion. cliente
	if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then
		begin
		select	max(nr_seq_grupo)
		into STRICT	nr_seq_grupo_w
		from	pls_contrato_grupo
		where	nr_seq_contrato = nr_seq_contrato_p;
		exception
		when others then
			nr_seq_grupo_w	:= null;
		end;

		if (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then
			--Verifica apenas ativos
			if (ie_considerar_ativos_p = 'S') then
				select	count(1) qt_beneficiarios
				into STRICT	qt_vidas_w
				from	pls_segurado		a,
					pls_contrato		b,
					pls_contrato_grupo	d,
					pls_grupo_contrato	c
				where	a.nr_seq_contrato	= b.nr_sequencia
				and	d.nr_seq_contrato	= b.nr_sequencia
				and	d.nr_seq_grupo		= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_grupo_w
				and	((coalesce(a.dt_rescisao::text, '') = '') or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and a.dt_rescisao > trunc(dt_mesano_referencia_p,'dd')) or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and (a.dt_reativacao IS NOT NULL AND a.dt_reativacao::text <> '') and a.dt_reativacao > a.dt_rescisao and a.dt_reativacao < trunc(dt_mesano_referencia_p,'dd')));
			--verifica todos
			elsif (ie_considerar_ativos_p = 'N') then
				select	count(1) qt_beneficiarios
				into STRICT	qt_vidas_w
				from	pls_segurado		a,
					pls_contrato		b,
					pls_contrato_grupo	d,
					pls_grupo_contrato	c
				where	a.nr_seq_contrato	= b.nr_sequencia
				and	d.nr_seq_contrato	= b.nr_sequencia
				and	d.nr_seq_grupo		= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_grupo_w;
			end if;
		end if;
	elsif (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then
		begin
		select	max(nr_seq_grupo)
		into STRICT	nr_seq_grupo_w
		from	pls_contrato_grupo
		where	nr_seq_intercambio = nr_seq_intercambio_p;
		exception
		when others then
			nr_seq_grupo_w	:= null;
		end;

		if (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then
			--Verifica apenas ativos
			if (ie_considerar_ativos_p = 'S') then
				select	count(1) qt_beneficiarios
				into STRICT	qt_vidas_w
				from	pls_segurado		a,
					pls_intercambio		b,
					pls_contrato_grupo	d,
					pls_grupo_contrato	c
				where	a.nr_seq_intercambio	= b.nr_sequencia
				and	d.nr_seq_intercambio	= b.nr_sequencia
				and	d.nr_seq_grupo		= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_grupo_w
				and	((coalesce(a.dt_rescisao::text, '') = '') or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and a.dt_rescisao > trunc(dt_mesano_referencia_p,'dd')) or ((a.dt_rescisao IS NOT NULL AND a.dt_rescisao::text <> '') and (a.dt_reativacao IS NOT NULL AND a.dt_reativacao::text <> '') and a.dt_reativacao > a.dt_rescisao and a.dt_reativacao < trunc(dt_mesano_referencia_p,'dd')));
			--verifica todos
			elsif (ie_considerar_ativos_p = 'N') then
				select	count(1) qt_beneficiarios
				into STRICT	qt_vidas_w
				from	pls_segurado		a,
					pls_intercambio		b,
					pls_contrato_grupo	d,
					pls_grupo_contrato	c
				where	a.nr_seq_intercambio	= b.nr_sequencia
				and	d.nr_seq_intercambio	= b.nr_sequencia
				and	d.nr_seq_grupo		= c.nr_sequencia
				and	c.nr_sequencia		= nr_seq_grupo_w;
			end if;
		end if;
	end if;
end if;

return	qt_vidas_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_qt_vidas_comissao ( nr_seq_contrato_p bigint, nr_seq_intercambio_p bigint, dt_mesano_referencia_p timestamp, ie_acao_contrato_p text, nr_contrato_principal_p bigint, ie_referencia_vidas_p text, ie_considerar_ativos_p text) FROM PUBLIC;

