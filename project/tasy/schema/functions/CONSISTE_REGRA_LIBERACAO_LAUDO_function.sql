-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_regra_liberacao_laudo (nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


ds_mensagem_w		varchar(255);
ie_tipo_grupo_w 	varchar(15);
ie_libera_w		varchar(1);

c01 CURSOR FOR
 	SELECT	c.ie_tipo_grupo
	from 	regra_lib_laudo_que_item c,
		regra_lib_laudo_questao b,
		laudo_paciente a
	where 	b.nr_seq_proc_interno = obter_nr_seq_proc_interno(a.nr_prescricao,a.nr_seq_prescricao)
	and 	c.nr_seq_regra_lib = b.nr_sequencia
	and	b.ie_situacao = 'A'
	and	a.nr_sequencia = nr_sequencia_p
	and	((coalesce(c.ie_exame_complementar,'N') = 'N') or ( exists (SELECT 1 from laudo_pac_exame_compl where nr_seq_laudo = a.nr_sequencia)));


BEGIN

ds_mensagem_w := '';

open C01;
loop
fetch C01 into
	ie_tipo_grupo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

		select 	coalesce(max('S'),'N')
		into STRICT	ie_libera_w
		from   	laudo_paciente x,
			laudo_questao_item i,
			laudo_grupo_questao g,
			grupo_questao_laudo o,
			prescr_proc_peca p,
			tipo_amostra_patologia d
		where 	x.nr_sequencia 		= g.nr_seq_laudo
		and   	i.nr_seq_laudo_grupo   	= g.nr_sequencia
		and   	g.nr_seq_peca 		= p.nr_sequencia
		and   	p.nr_seq_amostra_princ 	= d.nr_sequencia
		and   	g.nr_seq_grupo_questao 	= o.nr_sequencia
		and	ie_texto_grupo		= ie_tipo_grupo_w
		and   	x.nr_sequencia 		= nr_sequencia_p
		and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '');

	end if;

	if (ie_libera_w = 'N') then
		ds_mensagem_w := obter_desc_expressao(779453);
		exit;
	end if;
	end;
end loop;
close C01;

return	ds_mensagem_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_regra_liberacao_laudo (nr_sequencia_p bigint) FROM PUBLIC;

