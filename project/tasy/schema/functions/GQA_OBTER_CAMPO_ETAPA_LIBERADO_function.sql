-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gqa_obter_campo_etapa_liberado (nr_seq_etapa_p gqa_protocolo_etapa_pac.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


nr_seq_score_flex_ii_w    gqa_protocolo_etapa_pac.nr_seq_score_flex_ii%type;
nr_seq_avaliacao_w        gqa_protocolo_etapa_pac.nr_seq_avaliacao%type;
nr_seq_evolucao_w         gqa_protocolo_etapa_pac.nr_seq_evolucao%type;
nr_seq_acao_w             gqa_protocolo_etapa_pac.nr_seq_acao%type;

ie_tipo_acao_w            gqa_acao.ie_tipo_acao%type;
contador                  smallint := 0;


BEGIN
  select
          nr_seq_acao,
          nr_seq_score_flex_ii,
          nr_seq_avaliacao,
          nr_seq_evolucao
  into STRICT
          nr_seq_acao_w,
          nr_seq_score_flex_ii_w,
          nr_seq_avaliacao_w,
          nr_seq_evolucao_w
  from gqa_protocolo_etapa_pac
  where nr_sequencia = nr_seq_etapa_p;

  select ie_tipo_acao into STRICT ie_tipo_acao_w from gqa_acao where nr_sequencia = nr_seq_acao_w;

  begin
    if (ie_tipo_acao_w = 'ES') then
      select count(1) into STRICT contador from escala_eif_ii where nr_sequencia = nr_seq_score_flex_ii_w and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
    elsif (ie_tipo_acao_w = 'AV') then
      select count(1) into STRICT contador from med_avaliacao_paciente where nr_sequencia = nr_seq_avaliacao_w and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
    elsif (ie_tipo_acao_w = 'NC') then
      select count(1) into STRICT contador from evolucao_paciente where cd_evolucao = nr_seq_evolucao_w and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
    end if;
  exception when no_data_found then
    contador := 0;
  end;

  if ((contador IS NOT NULL AND contador::text <> '') and contador > 0) then
    return 'S';
  else
    return 'N';
  end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gqa_obter_campo_etapa_liberado (nr_seq_etapa_p gqa_protocolo_etapa_pac.nr_sequencia%type) FROM PUBLIC;

