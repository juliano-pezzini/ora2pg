-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_inutil_prod_aut_ok (nr_seq_doacao_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(1) := 'S';
qt_volume_bolsa_w		bigint;
nr_seq_analis_cri_w		bigint;
nr_seq_regra_w			bigint;
nr_seq_san_regra_deriv_w	bigint;
nr_seq_motivo_inutil_w		bigint;
ie_inutilizar_w			varchar(1);
ie_existe_anals_crit_w		varchar(1);


BEGIN

if (coalesce(nr_seq_doacao_p,0) > 0) then

	select	coalesce(a.qt_volume_real, a.qt_coletada)
	into STRICT	qt_volume_bolsa_w
	from	san_doacao a
	where	a.nr_sequencia = nr_seq_doacao_p;

	select	max(x.nr_sequencia)
	into STRICT	nr_seq_san_regra_deriv_w
	from	san_regra_volume_frac x
	where	x.ie_situacao = 'A'
	and	qt_volume_bolsa_w between x.qt_volume_min and x.qt_volume_max;

	if (coalesce(nr_seq_san_regra_deriv_w::text, '') = '') then
		ds_retorno_w := 'S';
	end if;

	if (coalesce(nr_seq_san_regra_deriv_w,0) > 0)  then

		select	max(CASE WHEN coalesce(x.ie_inutilizar,'N')='S' THEN  x.nr_seq_motivo_inut  ELSE 0 END )
		into STRICT	nr_seq_motivo_inutil_w
		from	san_regra_volume_frac x
		where	x.nr_sequencia = nr_seq_san_regra_deriv_w;

	end if;

	if (coalesce(nr_seq_motivo_inutil_w,0) > 0) then

		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ds_retorno_w
		from	san_inutilizacao x
		where	coalesce(x.dt_fechamento::text, '') = ''
		and	x.nr_sequencia = nr_seq_motivo_inutil_w;

	end if;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_inutil_prod_aut_ok (nr_seq_doacao_p bigint) FROM PUBLIC;

