-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_ult_compra_data_2 (cd_estabelecimento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, dt_final_p timestamp, qt_dias_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*
'DT' -> Data da útima compra
'CM' -> Custo médio NF
*/
ds_retorno_w			varchar(255);
nr_sequencia_w			bigint;
dt_emissao_w			timestamp;
vl_custo_medio_nf_w		double precision;
dt_final_w			timestamp;


BEGIN
dt_final_w := (TRUNC(coalesce(dt_final_p,clock_timestamp()),'dd') + 86399/86400);

if (coalesce(qt_dias_p,0) <> 0) then
	select 	dt_emissao,
		vl_custo_medio_nf
	into STRICT	dt_emissao_w,
		vl_custo_medio_nf_w
	from	(SELECT a.dt_emissao dt_emissao,
		CASE WHEN b.vl_liquido=0 THEN 0  ELSE dividir(b.vl_liquido, b.qt_item_estoque) END  vl_custo_medio_nf
		from	nota_fiscal a,
			nota_fiscal_item b,
			natureza_operacao c,
			operacao_nota d
		where	a.nr_sequencia = b.nr_sequencia
		and 	a.dt_emissao between(dt_final_p - coalesce(qt_dias_p,0)) and dt_final_p
		and	a.cd_natureza_operacao = c.cd_natureza_operacao
		and	a.cd_operacao_nf = d.cd_operacao_nf
		and	((a.cd_estabelecimento = cd_estabelecimento_p) OR (coalesce(cd_estabelecimento_p::text, '') = ''))
		and	((b.cd_local_estoque = cd_local_estoque_p) OR (coalesce(cd_local_estoque_p,0) = 0))
		and	b.cd_material = cd_material_p
		and	a.ie_situacao = '1'
		and	c.ie_entrada_saida = 'E'
		and	d.ie_ultima_compra = 'S') a
	where   a.vl_custo_medio_nf = (select max(a.vl_custo_medio_nf) )  LIMIT 1;
else
	select	max(a.dt_emissao)
	into STRICT	dt_emissao_w
	from	nota_fiscal a,
		nota_fiscal_item b,
		natureza_operacao c,
		operacao_nota d
	where	a.nr_sequencia = b.nr_sequencia
	and 	a.dt_emissao <= dt_final_w
	and	a.cd_natureza_operacao = c.cd_natureza_operacao
	and	a.cd_operacao_nf = d.cd_operacao_nf
	and	((a.cd_estabelecimento = cd_estabelecimento_p) OR (coalesce(cd_estabelecimento_p::text, '') = ''))
	and	((b.cd_local_estoque = cd_local_estoque_p) OR (coalesce(cd_local_estoque_p,0) = 0))
	and	b.cd_material = cd_material_p
	and	a.ie_situacao = '1'
	and	c.ie_entrada_saida = 'E'
	and	d.ie_ultima_compra = 'S';

	select	max(CASE WHEN b.vl_liquido=0 THEN 0  ELSE dividir(b.vl_liquido, b.qt_item_estoque) END )
	into STRICT	vl_custo_medio_nf_w
	from	nota_fiscal a,
		nota_fiscal_item b,
		natureza_operacao c,
		operacao_nota d
	where	a.nr_sequencia = b.nr_sequencia
	and 	a.dt_emissao  = dt_emissao_w
	and	a.cd_natureza_operacao = c.cd_natureza_operacao
	and	a.cd_operacao_nf = d.cd_operacao_nf
	and	((a.cd_estabelecimento = cd_estabelecimento_p) OR (coalesce(cd_estabelecimento_p::text, '') = ''))
	and	((b.cd_local_estoque = cd_local_estoque_p) OR (coalesce(cd_local_estoque_p,0) = 0))
	and	b.cd_material = cd_material_p
	and	a.ie_situacao = '1'
	and	c.ie_entrada_saida = 'E'
	and	d.ie_ultima_compra = 'S';
end if;

if (ie_opcao_p = 'DT') then
	ds_retorno_w := trunc(dt_emissao_w, 'dd');
elsif (ie_opcao_p = 'CM') then
	ds_retorno_w := vl_custo_medio_nf_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_ult_compra_data_2 (cd_estabelecimento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, dt_final_p timestamp, qt_dias_p bigint, ie_opcao_p text) FROM PUBLIC;

