-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cih_obter_pacientes_vigilancia ( dt_inicial_p timestamp, dt_final_p timestamp) RETURNS bigint AS $body$
DECLARE

nr_retorno_w	bigint;

/* function criada para Hospital Banco de Olhos */
 

BEGIN 
 
select	((a.NR_INTERNACAO_CIRURG + b.NR_INTERNACAO_CIRURG) + 
	(a.NR_CIRURGIA_AMB + b.NR_CIRURGIA_AMB) + 
	(a.NR_INTERNACAO_CLINICA + b.NR_INTERNACAO_CLINICA)) NR_INTERNACAO 
into STRICT	nr_retorno_w 
from	( 
SELECT	b.NR_INTERNACAO_CIRURG NR_INTERNACAO_CIRURG, 
	NR_CIRURGIA_AMB, 
	e.qt_atend_sem_cirurgia NR_INTERNACAO_CLINICA 
from (SELECT	count(c.nr_atendimento) NR_INTERNACAO_CIRURG 
		from	atendimento_paciente c 
		where	c.ie_tipo_atendimento = 1 
		and	not exists (select 1 from cih_ficha_ocorrencia a where a.nr_atendimento = c.nr_atendimento) 
		and	exists (select 1 from cirurgia a where a.nr_atendimento = c.nr_atendimento) 
		and	c.dt_entrada between dt_inicial_p and fim_dia(dt_final_p)) b, 
	(select	count(c.nr_atendimento) NR_CIRURGIA_AMB 
	from	atendimento_paciente c 
	where	c.ie_tipo_atendimento <> 1 
	and	not exists (select 1 from cih_ficha_ocorrencia a where a.nr_atendimento = c.nr_atendimento) 
	and	exists (select 1 from cirurgia a where a.nr_atendimento = c.nr_atendimento) 
	and	c.dt_entrada between dt_inicial_p and fim_dia(dt_final_p)) b, 
		(select	count(nr_cirurgia) qt_total_cirurgia 
		from	cirurgia 
		where	dt_inicio_prevista between dt_inicial_p and fim_dia(dt_final_p) 
		and	obter_tipo_atendimento(nr_atendimento) <> 1) c, 
	(select	count(a.nr_atendimento) qt_atend_sem_cirurgia 
	from	atendimento_paciente a 
	where	a.ie_tipo_atendimento = 1 
	and	a.dt_entrada between dt_inicial_p and fim_dia(dt_final_p) 
	and	not exists (select 1 from cih_ficha_ocorrencia c where a.nr_atendimento = c.nr_atendimento) 
	and	not exists (select 1 from cirurgia b where b.nr_atendimento = a.nr_atendimento)) e) a, 
(select	sum(nr_cirurgia_amb) nr_internacao_cirurg, 
	sum(nr_internacao_cirurg) nr_cirurgia_amb, 
	sum(nr_internacao_clinica) nr_internacao_clinica 
from ( 
	select 	count(a.nr_atendimento) nr_cirurgia_amb, 
		0 nr_internacao_cirurg, 
		0 nr_internacao_clinica 
	from	cih_ficha_ocorrencia a, 
		atendimento_paciente b, 
		cih_cirurgia c, 
		cih_local_infeccao d 
	where	a.nr_atendimento = b.nr_atendimento 
	and	a.nr_ficha_ocorrencia = c.nr_ficha_ocorrencia 
	and	d.nr_ficha_ocorrencia = a.nr_ficha_ocorrencia 
	and	b.ie_tipo_atendimento <> 1 
	and	b.dt_entrada between dt_inicial_p and fim_dia(dt_final_p) 
	and	d.cd_caso_infeccao in (2,3, 5,6, 7,8) 
	
union
 
	select 	0 nr_cirurgia_amb, 
		count(a.nr_atendimento) nr_internacao_cirurg, 
		0 nr_internacao_clinica 
	from	cih_ficha_ocorrencia a, 
		atendimento_paciente b, 
		cih_cirurgia c, 
		cih_local_infeccao d 
	where	a.nr_atendimento = b.nr_atendimento 
	and	a.nr_ficha_ocorrencia = c.nr_ficha_ocorrencia 
	and	d.nr_ficha_ocorrencia = a.nr_ficha_ocorrencia 
	and	b.ie_tipo_atendimento = 1 
	and	b.dt_entrada between dt_inicial_p and fim_dia(dt_final_p) 
	and	d.cd_caso_infeccao in (2,3, 5, 6, 7,8) 
	
union
 
	select 	0 nr_cirurgia_amb, 
		0 nr_internacao_cirurg, 
		count(a.nr_atendimento) nr_internacao_clinica 
	from	cih_ficha_ocorrencia a, 
		atendimento_paciente b, 
		cih_local_infeccao d 
	where	a.nr_atendimento = b.nr_atendimento 
	and	d.nr_ficha_ocorrencia = a.nr_ficha_ocorrencia 
	and	b.ie_tipo_atendimento = 1 
	and	b.dt_entrada between dt_inicial_p and fim_dia(dt_final_p) 
	and	not exists (select 1 from cih_cirurgia c where c.nr_ficha_ocorrencia = a.nr_ficha_ocorrencia) 
	and	d.cd_caso_infeccao in (2,3, 5,6, 7,8)) alias37) b;
 
return	coalesce(nr_retorno_w,0);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cih_obter_pacientes_vigilancia ( dt_inicial_p timestamp, dt_final_p timestamp) FROM PUBLIC;

