-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_batch_from_cpoe ( nr_seq_mat_cpoe_p bigint, nr_seq_mat_hor_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_etapa_sol_p bigint, ie_tipo_item_p text) RETURNS bigint AS $body$
DECLARE


c01 CURSOR FOR
	SELECT 	nr_prescricao,
		nr_sequencia
	from 	prescr_material
	where	nr_seq_mat_cpoe = nr_seq_mat_cpoe_p
	order by dt_atualizacao_nrec desc;

c02 CURSOR(	nr_prescricao_p		bigint,
		nr_seq_material_p	bigint,
		dt_horario_p		timestamp) FOR
	SELECT 	nr_seq_lote
	from 	prescr_mat_hor
	where 	nr_prescricao 	= nr_prescricao_p
	and 	nr_seq_material	= nr_seq_material_p
	and	dt_horario	< dt_horario_p
	order by dt_atualizacao_nrec desc;
	
nr_seq_lote_w	prescr_mat_hor.nr_seq_lote%type;
dt_horario_w	prescr_mat_hor.dt_horario%type;
BEGIN

if (ie_tipo_item_p = 'SOL') then
	select 	coalesce(max(nr_seq_lote),0),
		max(dt_horario)
	into STRICT	nr_seq_lote_w,
		dt_horario_w
	from 	prescr_mat_hor
	where 	nr_prescricao 	= nr_prescricao_p
	and	nr_seq_solucao 	= nr_seq_item_p
	and 	nr_etapa_sol	= nr_etapa_sol_p;
else
	select 	coalesce(max(nr_seq_lote),0),
		max(dt_horario)
	into STRICT	nr_seq_lote_w,
		dt_horario_w
	from 	prescr_mat_hor
	where 	nr_sequencia = nr_seq_mat_hor_p;
end if;

if (coalesce(nr_seq_lote_w,0) = 0) then

	for r_c01 in c01 loop
		begin
		
		for r_c02 in c02(r_c01.nr_prescricao, r_c01.nr_sequencia, dt_horario_w) loop
			begin
				
			if (coalesce(r_c02.nr_seq_lote,0) > 0) then
				nr_seq_lote_w := r_c02.nr_seq_lote;
				exit;
			end if;
			
			end;
		end loop;

		end;
	end loop;

end if;

if (coalesce(nr_seq_lote_w,0) > 0) then
	select 	coalesce(max(nr_sequencia), 0)
	into STRICT	nr_seq_lote_w
	from	ap_lote
	where   nr_sequencia = nr_seq_lote_w
	and 	ie_status_lote	in ('A','R','D','E');
end if;

return nr_seq_lote_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_batch_from_cpoe ( nr_seq_mat_cpoe_p bigint, nr_seq_mat_hor_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_etapa_sol_p bigint, ie_tipo_item_p text) FROM PUBLIC;

