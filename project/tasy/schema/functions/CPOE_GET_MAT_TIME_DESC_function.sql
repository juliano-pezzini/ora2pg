-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_get_mat_time_desc ( cd_intervalo_p text, ds_hora_p text ) RETURNS varchar AS $body$
DECLARE


ds_return_w 	varchar(500) := null;
ds_hor_w 	varchar(5) := null;
ds_n_w 		bigint := 0;
qt_period_w 	bigint := 0;
dt_horario_w	timestamp;
ds_horarios_w intervalo_prescricao.ds_horarios%type;


BEGIN

dt_horario_w := pkg_date_utils.get_Time(clock_timestamp(), ds_hora_p);

select  i.ds_horarios,
	( 	select  count(1)
		from    intervalo_prescr_period p
		where   p.cd_intervalo = i.cd_intervalo
	) qt_period
into STRICT    ds_horarios_w,
	qt_period_w
from    intervalo_prescricao i
where   i.cd_intervalo = cd_intervalo_p;

-- horario fixo com nome
if (qt_period_w > 0) then
	select  max(p.nm_period)
into STRICT    ds_return_w
from    prescr_interval_period p,
		intervalo_prescr_period i
where   i.nr_seq_period = p.nr_sequencia
and 	i.cd_intervalo =  cd_intervalo_p
and 	dt_horario_w > pkg_date_utils.get_DateTime(clock_timestamp(), p.hr_start_time) and
		((pkg_date_utils.get_DiffDate(pkg_date_utils.get_DateTime(clock_timestamp(), p.hr_start_time), pkg_date_utils.get_DateTime(clock_timestamp(), p.hr_end_time), 'MINUTE') > 0
		and dt_horario_w <= pkg_date_utils.get_DateTime(clock_timestamp(), p.hr_end_time))
		or (pkg_date_utils.get_DiffDate(pkg_date_utils.get_DateTime(clock_timestamp(), p.hr_start_time), pkg_date_utils.get_DateTime(clock_timestamp(), p.hr_end_time), 'MINUTE') <= 0
		and dt_horario_w <= pkg_date_utils.get_DateTime(clock_timestamp() + interval '1 days', p.hr_end_time)));
end if;

-- horario fixo sem nome
ds_horarios_w := ds_horarios_w || ' ';
while(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (position(' ' in ds_horarios_w) > 0) and (coalesce(ds_return_w::text, '') = '') loop
	ds_n_w := ds_n_w + 1;
	ds_hor_w := substr(substr(ds_horarios_w, 1, position(' ' in ds_horarios_w) - 1), 1, 5);
	
	if (ds_hor_w = ds_hora_p) then
		ds_return_w := wheb_mensagem_pck.get_texto(1163940, 'NR_TIME='||ds_n_w);
	end if;
	
	ds_horarios_w := substr(ds_horarios_w, position(' ' in ds_horarios_w) + 1, length(ds_horarios_w));

end loop;

return ds_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_get_mat_time_desc ( cd_intervalo_p text, ds_hora_p text ) FROM PUBLIC;

