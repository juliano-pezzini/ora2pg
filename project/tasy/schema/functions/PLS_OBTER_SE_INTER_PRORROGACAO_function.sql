-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_inter_prorrogacao ( cd_guia_p text, nr_seq_segurado_p bigint, ie_tipo_p text) RETURNS varchar AS $body$
DECLARE

/*
 P - Guia principal
 R - Guia prorrogação
*/
ds_retorno_w			varchar(1) := 'N';
qt_reg_w			bigint;

dt_alta_w			timestamp;


BEGIN

if (ie_tipo_p = 'P') then
	select	count(*)
	into STRICT	qt_reg_w
	from	pls_conta
	where	cd_guia = cd_guia_p
	and	nr_seq_segurado = nr_seq_segurado_p
	and	ie_tipo_guia	= '5';

	if (qt_reg_w > 0) then
		select	count(*)
		into STRICT	qt_reg_w
		from	pls_conta
		where	cd_guia = cd_guia_p
		and	nr_seq_segurado = nr_seq_segurado_p
		and	ie_tipo_guia	= '5'
		and	coalesce(dt_alta::text, '') = '';

		if (qt_reg_w > 0) then
			ds_retorno_w	:= 'S';
		else
			select	count(*)
			into STRICT	qt_reg_w
			from	pls_guia_plano
			where	cd_guia_principal = cd_guia_p
			and	cd_guia	<> cd_guia_p;

			if (qt_reg_w > 0) then
				select	count(*)
				into STRICT	qt_reg_w
				from	pls_conta
				where	cd_guia in (	SELECT	cd_guia
							from	pls_guia_plano
							where	cd_guia_principal = cd_guia_p
							and	cd_guia	<> cd_guia_p)
				and	nr_seq_segurado = nr_seq_segurado_p
				and	ie_tipo_guia	= '5';

				if (qt_reg_w > 0) then
					select	count(*)
					into STRICT	qt_reg_w
					from	pls_conta
					where	cd_guia in (	SELECT	cd_guia
								from	pls_guia_plano
								where	cd_guia_principal = cd_guia_p
								and	cd_guia	<> cd_guia_p)
					and	nr_seq_segurado = nr_seq_segurado_p
					and	ie_tipo_guia	= '5';

					if (qt_reg_w > 0) then
						ds_retorno_w	:= 'S';
					end if;
				else
					ds_retorno_w	:= 'S';
				end if;
			end if;
		end if;
	else
		ds_retorno_w	:= 'S';
	end if;
end if;

if (ie_tipo_p = 'R') then
	select	count(*)
	into STRICT	qt_reg_w
	from	pls_conta
	where	cd_guia = cd_guia_p
	and	nr_seq_segurado = nr_seq_segurado_p
	and	ie_tipo_guia	= '5';

	if (qt_reg_w > 0) then
		select	count(*)
		into STRICT	qt_reg_w
		from	pls_conta
		where	cd_guia = cd_guia_p
		and	nr_seq_segurado = nr_seq_segurado_p
		and	ie_tipo_guia	= '5'
		and	coalesce(dt_alta::text, '') = '';

		if (qt_reg_w > 0) then
			ds_retorno_w	:= 'S';
		end if;
	else
		ds_retorno_w	:= 'S';
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_inter_prorrogacao ( cd_guia_p text, nr_seq_segurado_p bigint, ie_tipo_p text) FROM PUBLIC;

