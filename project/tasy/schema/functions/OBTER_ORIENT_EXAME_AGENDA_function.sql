-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_orient_exame_agenda (cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_convenio_p bigint, nr_seq_proc_interno_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_funcao_p bigint, cd_plano_convenio_p text default null, cd_categoria_p text default null, nr_seq_agenda_p bigint default null, ie_consulta_p text default 'N') RETURNS varchar AS $body$
DECLARE


ds_orientacao_w	varchar(4000) := '';
ds_orient_convenio_w	varchar(2000) := '';
ds_orientacao_usuario_w	varchar(4000) := '';
ie_orientacao_w		varchar(01);
ie_tipo_orientacao_w	varchar(02);
qt_idade_w		bigint;
ds_orientacao_ageint_w 	text := '';
ds_orientacao_ageint_w2 text := '';
nr_seq_topografia_w	agenda_paciente.cd_topografia_proced%type;
ie_tipo_atendimento_w	agenda_paciente.ie_tipo_atendimento%type;
nr_seq_item_w	agenda_integrada_item.nr_sequencia%type;
nr_seq_prep_w	ageint_orient_preparo.nr_sequencia%type;

C01 CURSOR FOR
	SELECT  ds_orientacao
	from	proc_interno_conv_orient
	where	coalesce(nr_seq_proc_interno,coalesce(nr_seq_proc_interno_p,0)) = coalesce(nr_seq_proc_interno_p,0)
	and	((cd_convenio = cd_convenio_p) or (coalesce(cd_convenio::text, '') = ''))
	AND 	coalesce(cd_categoria, coalesce(cd_categoria_p,'0'))   = coalesce(cd_categoria_p,'0')
	AND	coalesce(cd_plano, coalesce(cd_plano_convenio_p, '0')) = coalesce(cd_plano_convenio_p, '0')
	and	qt_idade_w between coalesce(qt_idade_min, qt_idade_w) and coalesce(qt_idade_max, qt_idade_w)
	order by coalesce(nr_seq_proc_interno,0),	
		 coalesce(nr_seq_classif,0),
		 coalesce(qt_idade_min,0),
		 coalesce(qt_idade_max,0);
		
c02 CURSOR FOR
  	SELECT	ds_orientacao_preparo,
			nr_sequencia
	from (SELECT	aop.nr_sequencia,
             		aopr.nr_seq_orient_preparo,
               		aop.ds_orientacao_preparo
        	from 	ageint_orient_preparo    aop,
             		ageint_orient_prep_regra aopr
        	where 	aop.nr_sequencia = aopr.nr_seq_orient_preparo
        	and 	coalesce(aopr.nr_seq_proc_interno, nr_seq_proc_interno_p) = nr_seq_proc_interno_p
        	and 	coalesce(aopr.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p
		and	coalesce(aopr.nr_seq_topografia, coalesce(nr_seq_topografia_w,0)) = coalesce(nr_seq_topografia_w,0)
		and	coalesce(aopr.ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0)) = coalesce(ie_tipo_atendimento_w,0)
        	and 	aop.ie_situacao = 'A'
			and 	coalesce(aop.ie_tipo_orient, 'P') = 'P'
		and	coalesce(aopr.ie_consulta,'N') = ie_consulta_p
        	order by coalesce(aopr.nr_seq_apres,999), aop.nr_sequencia) alias11;		
	

BEGIN
select	max(ds_orientacao)
into STRICT	ds_orientacao_w
from	procedimento
where	cd_procedimento = cd_procedimento_p
and	ie_origem_proced = ie_origem_proced_p;

ie_tipo_orientacao_w := Obter_Param_Usuario(820, 67, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_tipo_orientacao_w);


if (coalesce(nr_seq_proc_interno_p,0) > 0) then
	select	max(ie_orientacao),
			max(ds_orientacao_pac),
			max(ds_orientacao_usuario)
	into STRICT	ie_orientacao_w,
			ds_orientacao_w,
			ds_orientacao_usuario_w
	from	proc_interno
	where	nr_sequencia = nr_seq_proc_interno_p;
	
	select	coalesce(max(qt_idade_paciente),0),
		coalesce(max(ie_tipo_atendimento),0),
		coalesce(max(cd_topografia_proced),0)
	into STRICT	qt_idade_w,
		ie_tipo_atendimento_w,
		nr_seq_topografia_w
	from	agenda_paciente
	where	nr_sequencia	= nr_seq_agenda_p;
	
	open C01;
	loop
	fetch C01 into	
		ds_orient_convenio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_orient_convenio_w := ds_orient_convenio_w;
		end;
	end loop;
	close C01;
	
	if (coalesce(ie_consulta_p,'N') = 'S') then
		begin
		select max(nr_sequencia)
		into STRICT nr_seq_item_w
		from agenda_integrada_item
		where nr_seq_agenda_exame = nr_seq_agenda_p;
		
		open c02;
		loop
		fetch c02 into
			ds_orientacao_ageint_w,
			nr_seq_prep_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			if (ds_orientacao_ageint_w IS NOT NULL AND ds_orientacao_ageint_w::text <> '') then
				if (nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') then
					ds_orientacao_ageint_w2 := obter_texto_macro_prep_ageint(nr_seq_prep_w, nr_seq_item_w, ds_orientacao_ageint_w);
				end if;
	        	ds_orientacao_ageint_w2 := ds_orientacao_ageint_w2 || ds_orientacao_ageint_w || chr(10);
	    	end if;
			end;
		end loop;
		close c02;
		
		exception
			when others then
			ds_orientacao_ageint_w2	:= '';
		end;	
	end if;
	
	if (ds_orientacao_ageint_w2 IS NOT NULL AND ds_orientacao_ageint_w2::text <> '') then
    		ds_orientacao_w := substr(ds_orientacao_ageint_w2,1,4000);
	elsif (ie_orientacao_w = 'C') then
		ds_orientacao_w := ds_orient_convenio_w;
	elsif (ie_orientacao_w = 'A') and ((ie_tipo_orientacao_w = 'P') or (cd_funcao_p <> 820)) then
		ds_orientacao_w := substr(ds_orientacao_w || chr(13) || chr(10) || ds_orient_convenio_w, 1, 4000);
	elsif (ie_orientacao_w = 'A') and (ie_tipo_orientacao_w = 'U') and (cd_funcao_p = 820) then
		ds_orientacao_w := substr(ds_orientacao_usuario_w || chr(13) || chr(10) || ds_orient_convenio_w, 1, 4000);
	elsif (ie_tipo_orientacao_w = 'U') and (cd_funcao_p = 820) then
		ds_orientacao_w := ds_orientacao_usuario_w;
	elsif (ie_orientacao_w = 'A') and (ie_tipo_orientacao_w = 'PU') and (cd_funcao_p = 820) then
		ds_orientacao_w := substr(ds_orientacao_w || chr(13) || chr(10) || ds_orient_convenio_w || chr(13) || chr(10) ||ds_orientacao_usuario_w, 1, 4000);
	elsif (ie_tipo_orientacao_w = 'PU') and (cd_funcao_p = 820) then
		ds_orientacao_w := substr(ds_orientacao_w || chr(13) || chr(10) || ds_orientacao_usuario_w, 1, 4000);
	end if;
end if;

return ds_orientacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_orient_exame_agenda (cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_convenio_p bigint, nr_seq_proc_interno_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_funcao_p bigint, cd_plano_convenio_p text default null, cd_categoria_p text default null, nr_seq_agenda_p bigint default null, ie_consulta_p text default 'N') FROM PUBLIC;

