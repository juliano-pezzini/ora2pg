-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_guia_value_without_taxes ( nr_atendimento_p conta_paciente.nr_atendimento%type, nr_interno_conta_p conta_paciente_consiste_v.nr_interno_conta%type, ie_mexico_p text, ie_tipo_convenio_p bigint, nr_doc_convenio_p text default null, ie_conta_paciente_p text default 'N', ds_nao_informado_p text default 'N', nr_doc_select_p text default 'X') RETURNS bigint AS $body$
DECLARE


vl_item_sem_imposto_w       conta_paciente_consiste_v.vl_item_sem_imposto%type;


BEGIN

if (pkg_i18n.get_user_locale = 'es_BO') then

    if (nr_doc_select_p = 'X' and ie_conta_paciente_p = 'N') then
        select  sum(x.vl_item_sem_imposto)
        into STRICT    vl_item_sem_imposto_w
        from (
                SELECT 	a.vl_item_sem_imposto,
                        b.nr_atendimento,
                        coalesce(a.nr_doc_convenio,to_char(b.nr_conta_convenio),substr(ds_nao_informado_p,1,255)) nr_doc_convenio
                from	conta_paciente_consiste_v a,
                        conta_paciente b
                where	a.nr_interno_conta	= nr_interno_conta_p
                and	b.nr_interno_conta	= nr_interno_conta_p
                and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
                and	((ie_mexico_p = 'S' and (coalesce(nr_seq_proc_pacote::text, '') = '' or (a.ie_proc_mat = 1 and nr_sequencia = nr_seq_proc_pacote))) or (ie_mexico_p = 'N' and (coalesce(nr_seq_proc_pacote::text, '') = '' or nr_sequencia <> nr_seq_proc_pacote)))
                and	nr_doc_select_p 	= 'X'
                and	(coalesce(a.dt_acerto_conta, a.dt_conta) IS NOT NULL AND (coalesce(a.dt_acerto_conta, a.dt_conta))::text <> '')
                and a.nr_atendimento = nr_atendimento_p        
                group by b.nr_atendimento, coalesce(a.nr_doc_convenio,to_char(b.nr_conta_convenio),substr(ds_nao_informado_p,1,255)),
                         a.nr_sequencia, a.ie_proc_mat, a.vl_item_sem_imposto
        ) x 
        where x.nr_atendimento = nr_atendimento_p
        and x.nr_doc_convenio = nr_doc_convenio_p;

    elsif (nr_doc_select_p <> 'X' and ie_conta_paciente_p = 'N') then
        
        select  sum(x.vl_item_sem_imposto)
        into STRICT    vl_item_sem_imposto_w
        from (
                SELECT 	a.vl_item_sem_imposto,
                        b.nr_atendimento
                from	conta_paciente_consiste_v a,
                        conta_paciente b
                where	a.nr_interno_conta	= nr_interno_conta_p
                and	b.nr_interno_conta	= nr_interno_conta_p
                and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
                and	((ie_mexico_p = 'S' and (coalesce(nr_seq_proc_pacote::text, '') = '' or (a.ie_proc_mat = 1 and nr_sequencia = nr_seq_proc_pacote))) or (ie_mexico_p = 'N' and (coalesce(nr_seq_proc_pacote::text, '') = '' or nr_sequencia <> nr_seq_proc_pacote)))
                and	((ie_tipo_convenio_p <> 3) or (a.ie_proc_mat = 1))              
                and	nr_doc_select_p <> 'X'                
                and	(coalesce(a.dt_acerto_conta, a.dt_conta) IS NOT NULL AND (coalesce(a.dt_acerto_conta, a.dt_conta))::text <> '')
                and a.nr_atendimento = nr_atendimento_p                
                group by b.nr_atendimento, nr_doc_select_p, a.nr_sequencia, a.ie_proc_mat, a.vl_item_sem_imposto
        ) x
        where x.nr_atendimento = nr_atendimento_p;
    else
        select  sum(x.vl_item_sem_imposto)
        into STRICT    vl_item_sem_imposto_w
        from (
                SELECT 	a.vl_item_sem_imposto
                from	conta_paciente_consiste_v a
                where	a.nr_interno_conta	= nr_interno_conta_p
                and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
                and	((ie_mexico_p = 'S' and (coalesce(nr_seq_proc_pacote::text, '') = '' or (a.ie_proc_mat = 1 and nr_sequencia = nr_seq_proc_pacote))) or (ie_mexico_p = 'N' and (coalesce(nr_seq_proc_pacote::text, '') = '' or nr_sequencia <> nr_seq_proc_pacote)))
                and	((ie_tipo_convenio_p <> 3) or (a.ie_proc_mat = 1)) 
                group by a.nr_sequencia, a.ie_proc_mat, a.vl_item_sem_imposto
        ) x;
    end if;
else
    vl_item_sem_imposto_w := 0;
end if;


return vl_item_sem_imposto_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION get_guia_value_without_taxes ( nr_atendimento_p conta_paciente.nr_atendimento%type, nr_interno_conta_p conta_paciente_consiste_v.nr_interno_conta%type, ie_mexico_p text, ie_tipo_convenio_p bigint, nr_doc_convenio_p text default null, ie_conta_paciente_p text default 'N', ds_nao_informado_p text default 'N', nr_doc_select_p text default 'X') FROM PUBLIC;

