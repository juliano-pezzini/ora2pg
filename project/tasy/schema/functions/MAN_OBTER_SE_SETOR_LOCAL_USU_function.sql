-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_se_setor_local_usu ( nr_seq_equip_p bigint, nr_seq_local_p bigint, nm_usuario_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*	S - Localização e localização/adicional equipamento
	L - Localização
	E - Localização/adicional equipamento	*/
ds_retorno_w		varchar(1) := 'N';
ie_equip_w		varchar(1) := 'N';
ie_local_w		varchar(1) := 'N';
ie_local_adic_w		varchar(1) := 'N';
ie_controle_setor_w		varchar(15);
qt_existe_w		bigint;
cd_setor_usuario_w		integer;


BEGIN
if (coalesce(nm_usuario_p,'X') <> 'X') then
	begin
	select	max(cd_setor_atendimento)
	into STRICT	cd_setor_usuario_w
	from	usuario
	where	nm_usuario = nm_usuario_p;

	begin
	select	ie_controle_setor
	into STRICT	ie_controle_setor_w
	from	man_equipamento
	where	nr_sequencia = nr_seq_equip_p;
	exception
	when others then
		ie_controle_setor_w := 'N';
	end;

	if (ie_opcao_p in ('S','X')) then
		begin
		if (ie_controle_setor_w = 'S') then
			begin

			/*Verifica se o setor da localização está liberado - Originalmente o valor SIM fazia um or entre setor da localizacao e setor do equipamento */

			begin
			select	obter_se_setor_usuario(a.cd_setor,nm_usuario_p)
			into STRICT	ie_local_w
			from	man_localizacao a
			where	a.nr_sequencia 	= nr_seq_local_p;
			exception
			when others then
				ie_local_w := 'N';
			end;

			/*Verifica se o setor da localização do equipamento está liberado*/

			begin
			select	obter_se_setor_usuario(b.cd_setor,nm_usuario_p)
			into STRICT	ie_equip_w
			from 	man_localizacao b,
				man_equipamento a
			where	b.nr_sequencia = a.nr_seq_local
			and	a.nr_sequencia = nr_seq_equip_p;
			exception
			when others then
				ie_equip_w := 'N';
			end;

			if (ie_opcao_p = 'S') then
				begin
				/*Verifica se tem localização adicional*/

				select	count(*)
				into STRICT	qt_existe_w
				from	man_equip_local_adic
				where	nr_seq_equipamento = nr_seq_equip_p;

				/*Verifica se o setor das localizações adicionais do equipamento está liberado*/

				if (qt_existe_w > 0) then
					begin
					select	'S'
					into STRICT	ie_local_adic_w
					from 	man_localizacao b,
						man_equip_local_adic a
					where	b.nr_sequencia = a.nr_seq_local
					and	obter_se_setor_usuario(b.cd_setor,nm_usuario_p) = 'S'
					and	a.nr_seq_equipamento = nr_seq_equip_p  LIMIT 1;
					exception
					when others then
						ie_local_adic_w := 'N';
					end;
				end if;
				end;
			end if;

			if (ie_equip_w = 'N') or (ie_local_w = 'N') or
				((ie_opcao_p = 'S') and (qt_existe_w > 0) and (ie_local_adic_w = 'N')) then
				ds_retorno_w := 'N';
			else
				ds_retorno_w := 'S';
			end if;

			end;
		else
			ds_retorno_w := 'S';
		end if;
		end;
	elsif (ie_opcao_p = 'L') then
		begin
		/*Somente localização da OS*/

		begin
		select	obter_se_setor_usuario(cd_setor,nm_usuario_p)
		into STRICT	ds_retorno_w
		from	man_localizacao
		where	nr_sequencia = nr_seq_local_p;
		exception
		when others then
			ds_retorno_w := 'N';
		end;
		end;
	elsif (ie_opcao_p in ('E','O')) then
		begin
		/*Localizações do equipamento (principal e adicionais)*/

		if (ie_controle_setor_w = 'S') then
			begin
			/*Principal*/

			if (ds_retorno_w = 'N') then
				begin
				if (ie_opcao_p = 'E') then
					begin
					select	obter_se_setor_usuario(b.cd_setor,nm_usuario_p)
					into STRICT	ds_retorno_w
					from 	man_localizacao b,
						man_equipamento a
					where	b.nr_sequencia = a.nr_seq_local
					and	a.nr_sequencia = nr_seq_equip_p;
					exception
					when others then
						ds_retorno_w := 'N';
					end;
				elsif (ie_opcao_p = 'O') then
					begin
					select	'S'
					into STRICT	ds_retorno_w
					from 	man_localizacao b,
						man_equipamento a
					where	b.nr_sequencia	= a.nr_seq_local
					and	a.nr_sequencia 	= nr_seq_equip_p
					and	b.cd_setor	= cd_setor_usuario_w  LIMIT 1;
					exception
					when others then
						ds_retorno_w := 'N';
					end;
				end if;
				end;
			end if;
			/*Adicionais*/

			if (ds_retorno_w = 'N') then
				begin
				if (ie_opcao_p = 'E') then
					begin
					select	'S'
					into STRICT	ds_retorno_w
					from 	man_localizacao b,
						man_equip_local_adic a
					where	b.nr_sequencia 		= a.nr_seq_local
					and	obter_se_setor_usuario(b.cd_setor,nm_usuario_p) = 'S'
					and	a.nr_seq_equipamento 	= nr_seq_equip_p  LIMIT 1;
					exception
					when others then
						ds_retorno_w := 'N';
					end;
				elsif (ie_opcao_p = 'O') then
					begin
					select	'S'
					into STRICT	ds_retorno_w
					from 	man_localizacao b,
						man_equip_local_adic a
					where	b.nr_sequencia 		= a.nr_seq_local
					and	b.cd_setor		= cd_setor_usuario_w
					and	a.nr_seq_equipamento 	= nr_seq_equip_p  LIMIT 1;
					exception
					when others then
						ds_retorno_w := 'N';
					end;
				end if;
				end;
			end if;
			end;
		else
			ds_retorno_w := 'S';
		end if;
		end;
	end if;
	end;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_se_setor_local_usu ( nr_seq_equip_p bigint, nr_seq_local_p bigint, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

