-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_horas_doses_vanco_nsv ( nr_prescricao_p bigint, qt_doses_p bigint) RETURNS bigint AS $body$
DECLARE

 
nr_seq_vanco_w			prescr_material.nr_sequencia%type;
nr_seq_manut_w			prescr_material.nr_sequencia%type;

qt_caracter_espaco_w	prescr_medica.qt_caracter_espaco%type;
qt_horas_w				prescr_medica.qt_hor_exame_vanco%type := 48;

cd_intervalo_w			intervalo_prescricao.cd_intervalo%type;

cd_material_w			material.cd_material%type;

nr_posicao_ini_w		bigint;
k						bigint;
i						bigint;
qt_doses_perc_w			bigint;
qt_operacao_w			bigint;
qt_operacao_interv_w	bigint;
qt_min_intervalo_w		bigint := 0;
qt_hora_intervalo_w		bigint := 0;
nr_horas_validade_w		bigint := 168;
nr_horas_intervalo_w	double precision;
qt_min_intervalo_regra_w double precision;
qt_dia_adic_w			double precision;
qt_pertence_w			double precision;

ds_horarios_w			varchar(4000);
ds_horarios_ww			varchar(4000);
ds_horarios_orig_w		varchar(4000);
ds_horarios2_w			varchar(4000);
ds_horario_mat_w		varchar(4000);
ds_prescricao_w			varchar(4000);
ds_horarios_fixo_w		varchar(4000);
hr_prim_horario_w		varchar(5);
mascara_data_w			varchar(30);
ds_caracter_espaco_w	varchar(30);
ie_dose_diferenciada_w	varchar(30);
ie_utiliza_quantidade_w	varchar(30);
ds_hora_w				varchar(255);
ie_utiliza_mascara_w	varchar(255);
ds_dt_prescr_w			varchar(255);
ie_controle_w			varchar(255);
ie_operacao_w			varchar(255);

dt_ini_medicacao_w		timestamp;
dt_fim_medicacao_w		timestamp;
dt_inicio_prescr_w		timestamp;
dt_prox_horario_w		timestamp;
dt_prescricao_w			timestamp;
dt_aux_w				timestamp;
hr_prescricao_w			timestamp;
dt_horario_w			timestamp;
dt_validade_prescr_w	timestamp;

c01 CURSOR FOR 
SELECT	qt_min_intervalo 
from	intervalo_minuto 
where	cd_intervalo	= cd_intervalo_w 
order by nr_seq_apres;


BEGIN 
 
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (coalesce(qt_doses_p,0) > 1) then 
	select	max(dt_prescricao), 
			coalesce(max(qt_caracter_espaco),1) 
	into STRICT	dt_prescricao_w, 
			qt_caracter_espaco_w 
	from	prescr_medica 
	where	nr_prescricao = nr_prescricao_p;
	 
	dt_inicio_prescr_w		:= dt_prescricao_w;
	dt_validade_prescr_w	:= dt_prescricao_w + nr_horas_validade_w/24;
	 
	ds_caracter_espaco_w	:= ' ';
	if (qt_caracter_espaco_w = 2) then 
		ds_caracter_espaco_w	:= ' ';
	elsif (qt_caracter_espaco_w = 3) then 
		ds_caracter_espaco_w	:= '  ';
	elsif (qt_caracter_espaco_w = 4) then 
		ds_caracter_espaco_w	:= '  ';
	elsif (qt_caracter_espaco_w > 4) then 
		ds_caracter_espaco_w	:= '   ';
	end if;
 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_vanco_w 
	from	prescr_material a 
	where	coalesce(coalesce(a.nr_sequencia_solucao, a.nr_sequencia_dieta, a.nr_sequencia_diluicao)::text, '') = '' 
	and		coalesce(a.nr_seq_medic_material::text, '') = '' 
	and   obter_se_mat_vancomicina(a.cd_material) = 'S' 
	and   a.ie_agrupador = 1	 
	and		a.nr_prescricao = nr_prescricao_p;
	 
	select	coalesce(max(nr_sequencia), nr_seq_vanco_w) 
	into STRICT	nr_seq_manut_w 
	from	prescr_material a 
	where	coalesce(coalesce(a.nr_sequencia_solucao, a.nr_sequencia_dieta, a.nr_sequencia_diluicao)::text, '') = '' 
	and		a.nr_seq_medic_material = nr_seq_vanco_w 
	and   obter_se_mat_vancomicina(a.cd_material) = 'S' 
	and   a.ie_agrupador = 1	 
	and		a.nr_prescricao = nr_prescricao_p;	
	 
	qt_doses_perc_w		:= 0;
 
	select	round(to_date(to_char(dt_prescricao_w, 'dd/mm/yyyy ') || coalesce(max(hr_prim_horario), to_char(dt_inicio_prescr_w,'hh24:mi')), 'dd/mm/yyyy hh24:mi') + coalesce(max(qt_dia_prim_hor),0), 'hh24') 
	into STRICT	dt_ini_medicacao_w 
	from	prescr_material 
	where	nr_sequencia = coalesce(nr_seq_vanco_w, nr_seq_manut_w) 
	and		nr_prescricao = nr_prescricao_p;
	 
	if (nr_seq_manut_w <> nr_seq_vanco_w) then 
		nr_seq_vanco_w		:= nr_seq_manut_w;
	end if;
	 
	select	max(cd_intervalo) 
	into STRICT	cd_intervalo_w 
	from	prescr_material 
	where	nr_sequencia = nr_seq_vanco_w 
	and		nr_prescricao = nr_prescricao_p;
	 
	ds_horarios_w		:= substr(ds_horarios_w, position(' ' in ds_horarios_w), length(ds_horarios_w));
	dt_fim_medicacao_w	:= dt_ini_medicacao_w;
 
	select	coalesce(max(qt_operacao), 1), 
			max(ie_operacao) 
	into STRICT	qt_operacao_interv_w, 
			ie_operacao_w 
	from	intervalo_prescricao 
	where	cd_intervalo = cd_intervalo_w;
		 
	if (qt_doses_perc_w < qt_doses_p+1) then 
		if (qt_operacao_interv_w > 24) then 
			begin 
			if (ie_operacao_w = 'H') then 
				while(qt_doses_perc_w < qt_doses_p-1) loop 
					dt_fim_medicacao_w	:= dt_fim_medicacao_w + qt_operacao_interv_w/24;
					qt_doses_perc_w		:= qt_doses_perc_w + 1;
				end loop;
			else 
				dt_fim_medicacao_w	:= dt_fim_medicacao_w+2;
			end if;
			end;
		else 
			begin 
			qt_operacao_w	:= 0;
 
			--- INÍCIO: Rotina CALCULAR_HORARIO_PRESCR 
			--qt_min_intervalo_w	:= (nvl(qt_hora_intervalo_p,0) * 60) + nvl(qt_min_intervalo_p,0); 
 
			select	max(ds_horarios) 
			into STRICT	ds_horario_mat_w 
			from	intervalo_material 
			where	cd_intervalo	= cd_intervalo_w 
			and		cd_material	= cd_material_w;
				 
			select	replace(coalesce(max(coalesce(ds_horario_mat_w, ds_horarios)),''), ds_caracter_espaco_w, ' '), 
					coalesce(max(ie_operacao),''), 
					coalesce(max(qt_operacao),1), 
					coalesce(max(ds_prescricao),''), 
					coalesce(max(ie_dose_diferenciada),'N'), 
					coalesce(max(ie_utiliza_quantidade),'N') 
			into STRICT	ds_horarios_w, 
					ie_operacao_w, 
					qt_operacao_w, 
					ds_prescricao_w, 
					ie_dose_diferenciada_w, 
					ie_utiliza_quantidade_w 
			from	intervalo_prescricao 
			where	cd_intervalo = cd_intervalo_w;
 
			if (to_char(dt_prescricao_w, 'mi') <> '00') or 
				((coalesce(qt_min_intervalo_w,0) > 0) and (ie_operacao_w = 'X')) then 
				Mascara_data_w 			:= 'hh24:mi';
			else 
				Mascara_data_w 			:= 'hh24';
			end if;
			 
			--begin 
			if (ie_operacao_w = 'D') then 
				qt_operacao_w		  	:= 1;
				if (coalesce(ds_horarios_w::text, '') = '') then 
					if (to_char(dt_prescricao_w,'mi') = '00') then 
						ds_horarios_w			:= to_char(dt_prescricao_w,'hh24');
					else 
						ds_horarios_w			:= to_char(dt_prescricao_w,'hh24:mi');
					end if;
				else 
					ds_horarios_w			:= ds_horarios_w;
				end if;
			elsif (ie_operacao_w = 'M') then 
 
				qt_operacao_w		:= 1;
				ds_horarios_w		:= to_char(dt_prescricao_w,'hh24:mi');
				dt_prox_horario_w	:= to_date(ds_dt_prescr_w ||' '||to_char(dt_prescricao_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
				 
				open C01;
				loop 
				fetch C01 into	 
					qt_min_intervalo_regra_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					qt_operacao_w	:= qt_operacao_w + 1;
					dt_prox_horario_w := dt_prox_horario_w + (qt_min_intervalo_regra_w/1440);
					ds_horarios_w	:= ds_horarios_w || ds_caracter_espaco_w || to_char(dt_prox_horario_w,'hh24:mi');		
				end loop;
				close C01;
				 
			elsif (ie_operacao_w = 'F') and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
				begin 
			  	qt_operacao_w		  	:= qt_operacao_w;
				end;
			elsif (ie_operacao_w = 'V') and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
				begin 
				 
				ie_utiliza_mascara_w	:= 'S';
				if (position(':' in ds_horarios_w) = 0) then 
					ie_utiliza_mascara_w	:= 'N';
				end if;
				ds_horarios_ww := replace(ds_horarios_w, ds_caracter_espaco_w, ' ');
				ds_horarios_w	:= padroniza_horario_prescr(reordenar_horarios(dt_ini_medicacao_w,ds_horarios_ww), to_char(dt_inicio_prescr_w,'dd/mm/yyyy hh24:mi:ss')) || ds_caracter_espaco_w;
				 
				 
				qt_operacao_w	:= 0;
				 
				while	(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') LOOP 
					begin 
					k	:= position(' ' in ds_horarios_w);
					 
					if (k > 1) and ((substr(ds_horarios_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_w, 1, k -1))::text <> '')) then 
						begin 
						ds_hora_w		:= substr(ds_horarios_w, 1, k-1);
						ds_hora_w		:= replace(ds_hora_w, ds_caracter_espaco_w,'');
						ds_horarios_w		:= substr(ds_horarios_w, k + 1, 2000);
						 
						if (ie_controle_w = 0) and (ds_hora_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then 
							qt_dia_adic_w	:= 1;
						elsif (position('A' in ds_hora_w) > 0) and (qt_dia_adic_w = 0) then 
							qt_dia_adic_w	:= 1;
						elsif (position('AA' in ds_hora_w) > 0) then 
							qt_dia_adic_w	:= qt_dia_adic_w + 1;
						end if;
						ie_controle_w	:= 1;
						ds_hora_w	:= replace(ds_hora_w,'A','');
						ds_hora_w	:= replace(ds_hora_w,'A','');
 
						dt_horario_w	:= to_date(to_char(dt_inicio_prescr_w + qt_dia_adic_w,'dd/mm/yyyy')||' '||replace(ds_hora_w,'A','')||':00','dd/mm/yyyy hh24:mi:ss');
						 
						qt_pertence_w	:= 0;
						 
						if (dt_horario_w >= dt_ini_medicacao_w) and (dt_horario_w < dt_validade_prescr_w) then 
							qt_pertence_w	:= 1;
						end if;
						 
						if (qt_pertence_w > 0) then 
							begin 
							if (ie_utiliza_mascara_w	= 'N') then 
								ds_hora_w	:= substr(ds_hora_w,1,2);
							end if;
							ds_horarios_fixo_w	:= ds_horarios_fixo_w || ds_hora_w ||ds_caracter_espaco_w;
							qt_operacao_w		:= qt_operacao_w + 1;
							end;
						end if;
 
						end;
					elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
						begin 
						ds_horarios_w		:= '';
						end;
					end if;
					 
					end;
				END LOOP;
				ds_horarios_w	:= ds_horarios_fixo_w;
				end;
			else 
			  begin 
				 
				if (qt_operacao_w > 0) then 
					if (ie_operacao_w = 'H') then 
						nr_Horas_intervalo_w 	:= qt_operacao_w;
					else 
						if (coalesce(ie_utiliza_quantidade_w,'N') = 'N') then 
							nr_Horas_intervalo_w 	:= Trunc(nr_horas_validade_w / qt_operacao_w);
						else 
							nr_Horas_intervalo_w	:= qt_operacao_w;
						end if;
					end if;
			  	elsif (ie_operacao_w = 'H') then 
			    	begin 
			    	nr_Horas_intervalo_w  := qt_operacao_w;
			    	qt_operacao_w     := CEIL(nr_horas_validade_w / nr_Horas_intervalo_w);
			    	end;
			  	elsif (ie_operacao_w = 'X') then 
			    	begin 
					if (coalesce(ie_utiliza_quantidade_w,'N') = 'N') then 
						qt_operacao_w		:= Ceil(nr_horas_validade_w / (24 / qt_operacao_w));
					else 
						qt_operacao_w	:= qt_operacao_w;
					end if;
			    	nr_Horas_intervalo_w  	:= floor(24/qt_operacao_w);
					if (coalesce(qt_min_intervalo_w,0) > 0) and (nr_Horas_intervalo_w >= floor(dividir(qt_min_intervalo_w,60))) then 
						nr_Horas_intervalo_w	:= qt_min_intervalo_w / 60;
					end if;
					 
					if (qt_operacao_w = 0) or (coalesce(qt_operacao_w::text, '') = '') then 
						qt_operacao_w := 1;
					end if;
			    	end;
			  	else 
			    	begin 
			    	qt_operacao_w     	:= 1;
			    	nr_Horas_intervalo_w  	:= 0;
			    	end;
				end if;
 
				ds_horarios_w			:= '';
				hr_prescricao_w      	:= dt_ini_medicacao_w;
								 
				for i in 1.. qt_operacao_w LOOP 
					begin 
					ds_hora_w		:= to_char(hr_prescricao_w, Mascara_data_w);
					ds_horarios_w	:= ds_horarios_w || ds_hora_w || ds_caracter_espaco_w;
					hr_prescricao_w := hr_prescricao_w + (nr_Horas_intervalo_w / 24);
					end;
				end loop;				
				end;
			end if;
 
			if (qt_operacao_w = 0) then 
			  	qt_operacao_w			:= 1;
			end if;
 
			if (qt_operacao_w = 1) and (ds_prescricao_w in ('ACM', 'SN')) then 
				begin 
				ds_horarios_w 			:= substr(ds_prescricao_w,1,4000);
				end;
			else 
				begin 
				ds_horarios_w			:= substr(ds_horarios_w,1,4000);
				end;
			end if;
			--- FIM: Rotina CALCULAR_HORARIO_PRESCR 
 
			ds_horarios_orig_w	:= replace(ds_horarios_w, ds_caracter_espaco_w, ' ');
					 
			if (coalesce(substr(ds_horarios_w, length(ds_horarios_w)), 'X') <> ' ') then 
				ds_horarios_w	:= ds_horarios_w || ' ';
			end if;
 
			nr_posicao_ini_w	:= position(' ' in ds_horarios_w);
			dt_fim_medicacao_w	:= dt_ini_medicacao_w;
			 
			qt_doses_perc_w	:= 0;
			 
			while	((ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (qt_doses_perc_w < qt_doses_p) and (nr_posicao_ini_w > 0)) loop 
				begin 
				 
				if (position(':' in ds_horarios_w) = 0) then 
					hr_prim_horario_w	:= substr(ds_horarios_w, 1, nr_posicao_ini_w-1) || ':00';
				else 
					hr_prim_horario_w	:= substr(ds_horarios_w, 1, nr_posicao_ini_w-1);
				end if;
				 
				dt_aux_w			:= to_date(to_char(dt_fim_medicacao_w,'dd/mm/yyyy ') || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');
				 
				if (dt_aux_w < dt_fim_medicacao_w) then 
					dt_aux_w		:= dt_aux_w + 1;
				end if;
								 
				dt_fim_medicacao_w	:= dt_aux_w;
				 
				ds_horarios_w		:= substr(ds_horarios_w, nr_posicao_ini_w+1, length(ds_horarios_w));	
				 
				qt_doses_perc_w		:= qt_doses_perc_w+1;
				nr_posicao_ini_w	:= position(' ' in ds_horarios_w);
				 
				end;
			end loop;	
			end;
		end if;
		 
		qt_horas_w	:= round((dt_fim_medicacao_w - dt_ini_medicacao_w)*24);
	end if;
end if;
 
if (qt_horas_w = 0) then 
	qt_horas_w := 48;
end if;
 
return	qt_horas_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_horas_doses_vanco_nsv ( nr_prescricao_p bigint, qt_doses_p bigint) FROM PUBLIC;

