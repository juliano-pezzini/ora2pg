-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_marca_ordem ( nr_ordem_compra_p bigint, nr_item_oci_p bigint) RETURNS varchar AS $body$
DECLARE

 
cd_cgc_fornecedor_w		varchar(14);
nr_seq_marca_w			bigint;
cd_material_w			bigint;
resultado_w	 		varchar(80);


BEGIN 
 
select	max(nr_seq_marca), 
	max(cd_material) 
into STRICT	nr_seq_marca_w, 
	cd_material_w 
from	ordem_compra_item 
where	nr_ordem_compra	= nr_ordem_compra_p 
and	nr_item_oci	= nr_item_oci_p;
 
if (nr_seq_marca_w IS NOT NULL AND nr_seq_marca_w::text <> '') then 
	select	ds_marca 
	into STRICT	resultado_w 
	from	marca 
	where	nr_sequencia	= nr_seq_marca_w;
else 
	select	coalesce(cd_cgc_fornecedor,'0') 
	into STRICT	cd_cgc_fornecedor_w 
	from	ordem_compra 
	where	nr_ordem_compra	= nr_ordem_compra_p;
 
	if (cd_cgc_fornecedor_w <> '0') then 
		begin 
 
		select	max(substr(CASE WHEN position('(' in i.ds_marca)=0 THEN i.ds_marca  ELSE substr(i.ds_marca,1,position('(' in i.ds_marca)-1) END ,1,30)) 
		into STRICT	Resultado_w 
		from	ordem_compra_item o, 
			cot_compra_forn_item i 
		where	o.nr_ordem_compra		= i.nr_ordem_compra 
		and	o.nr_cot_compra		= i.nr_cot_compra 
		and	o.nr_item_cot_compra	= i.nr_item_cot_compra 
		and	o.nr_ordem_compra		= nr_ordem_compra_p 
		and	o.nr_item_oci		= nr_item_oci_p 
		and	i.cd_cgc_fornecedor	= cd_cgc_fornecedor_w;
 
		end;
	end if;
end if;
 
return resultado_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_marca_ordem ( nr_ordem_compra_p bigint, nr_item_oci_p bigint) FROM PUBLIC;

