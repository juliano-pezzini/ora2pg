-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_contab_resumo ( nr_seq_item_pp_p pls_pp_item_lote.nr_sequencia%type, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*Opcoes
CC - Conta contabil credito
DC - Descricao conta credito
CD - Conta contabil debito
DD - Descricao conta debito
CLC - Classificacao credito
CLD - Classificacao debito
HP - Historico padrao
DH - Descricao historico padrao
E - Esquema
LC - Lote contabil*/
qt_outro_w			integer;
qt_prest_pgto_w			integer;
dt_mes_competencia_w		pls_pp_lote.dt_mes_competencia%type;
ds_historico_w			historico_padrao.ds_historico%type;
cd_historico_w			historico_padrao.cd_historico%type;
ds_conta_contabil_w		conta_contabil.ds_conta_contabil%type;
cd_classif_cred_w		conta_contabil.cd_classificacao_atual%type;
cd_classif_deb_w		conta_contabil.cd_classificacao_atual%type;
cd_conta_contabil_w		conta_contabil.cd_conta_contabil%type;
cd_conta_cred_w			conta_contabil.cd_conta_contabil%type;
cd_conta_deb_w			conta_contabil.cd_conta_contabil%type;
nr_seq_esquema_w		pls_esquema_contabil.nr_sequencia%type;
nr_lote_contabil_w		lote_contabil.nr_lote_contabil%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_seq_resumo_rec_w		pls_conta_rec_resumo_item.nr_sequencia%type;
nr_seq_resumo_w			pls_conta_medica_resumo.nr_sequencia%type;
nr_seq_conta_w			pls_conta.nr_sequencia%type;
ie_tipo_item_w			pls_pp_item_lote.ie_tipo_item%type;


BEGIN

if (nr_seq_item_pp_p IS NOT NULL AND nr_seq_item_pp_p::text <> '') then
	select	max(l.dt_mes_competencia),
		max(l.cd_estabelecimento),
		max(i.nr_seq_conta),
		max(i.nr_seq_resumo),
		max(i.nr_seq_resumo_rec),
		max(ie_tipo_item),
		max(	select	CASE WHEN ie_status_prov_pagto='F' THEN 1  ELSE 0 END
			from	pls_parametro_contabil
			where	cd_estabelecimento = l.cd_estabelecimento)
	into STRICT	dt_mes_competencia_w,
		cd_estabelecimento_w,
		nr_seq_conta_w,
		nr_seq_resumo_w,
		nr_seq_resumo_rec_w,
		ie_tipo_item_w,
		qt_prest_pgto_w
	from	pls_pp_lote		l,
		pls_pp_item_lote	i
	where	l.nr_sequencia	= i.nr_seq_lote
	and	i.nr_sequencia	= nr_seq_item_pp_p;
	
	/*
	select	sum(decode(ie_prestador_codificacao, 'P', 1, 0)) qt_prest_pgto,
		sum(decode(ie_prestador_codificacao, 'P', 0, 1)) qt_outro
	into	qt_prest_pgto_w,
		qt_outro_w
	from	pls_esquema_contabil
	where	ie_tipo_regra		= 'PM'
	and	cd_estabelecimento	= cd_estabelecimento_w
	and	dt_mes_competencia_w between dt_inicio_vigencia and nvl(dt_fim_vigencia, dt_mes_competencia_w);

	if	(qt_prest_pgto_w > 0) and 
		(qt_outro_w > 0) then
		return null;
	end if;
	*/

	
	-- Contas medicas

	-- Nivel de conta
	if (qt_prest_pgto_w > 0) and (ie_tipo_item_w = '1') and (nr_seq_resumo_w IS NOT NULL AND nr_seq_resumo_w::text <> '') then
		select	max(coalesce(a.cd_classif_cred,a.cd_classif_prov_cred)),
			max(coalesce(a.cd_classif_deb,a.cd_classif_prov_deb)),
			max(coalesce(a.cd_conta_cred,a.cd_conta_prov_cred)),
			max(coalesce(a.cd_conta_deb,a.cd_conta_prov_deb)),
			max(cd_historico),
			max(nr_seq_esquema),
			max(nr_lote_contabil_pag)
		into STRICT	cd_classif_cred_w,
			cd_classif_deb_w,
			cd_conta_cred_w,
			cd_conta_deb_w,
			cd_historico_w,
			nr_seq_esquema_w,
			nr_lote_contabil_w
		from	pls_conta_medica_resumo a
		where	nr_sequencia	= nr_seq_resumo_w
		and	nr_seq_conta	= nr_seq_conta_w;
			
	-- Contas medicas

	-- Nivel de procedimentos e materiais
	elsif (qt_prest_pgto_w = 0) and (ie_tipo_item_w	= '1') and (nr_seq_resumo_w IS NOT NULL AND nr_seq_resumo_w::text <> '') then
		select	max(cd_classif_cred),
			max(cd_classif_deb),
			max(cd_conta_cred),
			max(cd_conta_deb),
			max(cd_historico),
			max(nr_seq_esquema),
			max(nr_lote_contabil)
		into STRICT	cd_classif_cred_w,
			cd_classif_deb_w,
			cd_conta_cred_w,
			cd_conta_deb_w,
			cd_historico_w,
			nr_seq_esquema_w,
			nr_lote_contabil_w
		from (SELECT	coalesce(p.cd_classif_cred, p.cd_classif_prov_cred) cd_classif_cred,
				coalesce(p.cd_classif_deb, p.cd_classif_prov_deb) cd_classif_deb,
				coalesce(p.cd_conta_cred, p.cd_conta_provisao_cred) cd_conta_cred,
				coalesce(p.cd_conta_deb, p.cd_conta_provisao_deb) cd_conta_deb,
				p.cd_historico,
				p.nr_seq_esquema,
				p.nr_lote_contabil
			from	pls_conta_medica_resumo	r,
				pls_conta_proc		p
			where	p.nr_sequencia	= r.nr_seq_conta_proc
			and	p.nr_seq_conta	= r.nr_seq_conta
			and	r.nr_sequencia	= nr_seq_resumo_w
			and	r.nr_seq_conta	= nr_seq_conta_w
			
union all

			SELECT	coalesce(p.cd_classif_cred, p.cd_classif_prov_cred) cd_classif_cred,
				coalesce(p.cd_classif_deb, p.cd_classif_prov_deb) cd_classif_deb,
				coalesce(p.cd_conta_cred, p.cd_conta_provisao_cred) cd_conta_cred,
				coalesce(p.cd_conta_deb, p.cd_conta_provisao_deb) cd_conta_deb,
				p.cd_historico,
				p.nr_seq_esquema,
				p.nr_lote_contabil
			from	pls_conta_medica_resumo	r,
				pls_conta_mat		p
			where	p.nr_sequencia	= r.nr_seq_conta_mat
			and	p.nr_seq_conta	= r.nr_seq_conta
			and	r.nr_sequencia	= nr_seq_resumo_w
			and	r.nr_seq_conta	= nr_seq_conta_w) alias18;
		
	-- Recurso de glosa
	elsif (ie_tipo_item_w	= '8') and (nr_seq_resumo_rec_w IS NOT NULL AND nr_seq_resumo_rec_w::text <> '') then
		select	max(cd_classif_cred_pag),
			max(cd_classif_deb_pag),
			max(cd_conta_cred_pag),
			max(cd_conta_deb_pag),
			max(cd_historico_pag),
			max(nr_seq_esquema_pag),
			max(nr_lote_contabil_pag)
		into STRICT	cd_classif_cred_w,
			cd_classif_deb_w,
			cd_conta_cred_w,
			cd_conta_deb_w,
			cd_historico_w,
			nr_seq_esquema_w,
			nr_lote_contabil_w
		from	pls_conta_rec_resumo_item i
		where	i.nr_sequencia	= nr_seq_resumo_rec_w;
	end if;
else
	return null;
end if;

if (ie_opcao_p = 'DC') then
	cd_conta_contabil_w	:= cd_conta_cred_w;
elsif (ie_opcao_p = 'DD') then
	cd_conta_contabil_w	:= cd_conta_deb_w;
end if;

if (ie_opcao_p in ('DC','DD')) and (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') then
	select	max(ds_conta_contabil)
	into STRICT	ds_conta_contabil_w
	from	conta_contabil
	where	cd_conta_contabil	= cd_conta_contabil_w;
end if;

if (ie_opcao_p = 'DH') then
	select	ds_historico
	into STRICT	ds_historico_w
	from	historico_padrao
	where	cd_historico = cd_historico_w;

	return ds_historico_w;
end if;

case ie_opcao_p
	when 'CC' then
		return cd_conta_cred_w;
	when 'CD' then
		return cd_conta_deb_w;
	when 'CLC' then
		return cd_classif_cred_w;
	when 'CLD' then
		return cd_classif_deb_w;
	when 'HP' then
		return to_char(cd_historico_w);
	when 'E' then
		return to_char(nr_seq_esquema_w);
	when 'DC' then
		return ds_conta_contabil_w;
	when 'DD' then
		return ds_conta_contabil_w;
	when 'LC' then
		return to_char(nr_lote_contabil_w);
	else
		return null;
end case;

return null;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_contab_resumo ( nr_seq_item_pp_p pls_pp_item_lote.nr_sequencia%type, ie_opcao_p text) FROM PUBLIC;

