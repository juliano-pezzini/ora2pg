-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_nut_atend_serv ( nr_atendimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_opcao_p text, ie_ignorar_datas_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(255);
dt_bloqueio_w		varchar(255);
ds_justificativa_w	varchar(255);
nm_usuario_bloq_w	varchar(15);
ds_servico_w		varchar(60);
ds_servico_todos_w	varchar(4000);


C01 CURSOR FOR
	SELECT  distinct a.ds_servico
	from	nut_atend_serv_dia x,
		nut_servico a,
	  	nut_atend_serv_dia_rep y
	where	a.nr_sequencia 		= x.nr_seq_servico
	and	x.nr_sequencia		= y.nr_seq_serv_dia
	and	x.nr_atendimento 	=  nr_atendimento_p
	and	(x.dt_bloqueio IS NOT NULL AND x.dt_bloqueio::text <> '')
	and	((x.dt_servico between dt_inicial_p and dt_final_p AND ie_ignorar_datas_p = 'N') or (ie_ignorar_datas_p = 'S'))
	order by 1;

/*
ie_opcao_p: 'DB' = Data de bloqueio
	'JB' = Justificativa do bloqueio
	'UB' = Usuário que realizou o bloqueio
	'SB' = Serviços bloqueados
*/
BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then


	open C01;
	loop
	fetch C01 into
		ds_servico_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_servico_todos_w := ds_servico_todos_w ||'; '||ds_servico_w;
		end;
	end loop;
	close C01;

	ds_servico_todos_w:= substr(ds_servico_todos_w,2,255);

	select	max(to_char(x.dt_bloqueio, 'dd/mm/yyyy hh:mm:ss')),
		max(Obter_justif_bloq_dieta(x.nr_seq_justif_bloqueio)),
		max(x.nm_usuario_bloqueio)
	into STRICT	dt_bloqueio_w,
		ds_justificativa_w,
		nm_usuario_bloq_w
	from	nut_atend_serv_dia x,
	  	nut_atend_serv_dia_rep y
	where	x.nr_atendimento = nr_atendimento_p
	and	x.nr_sequencia 	= y.nr_seq_serv_dia
	and	(x.dt_bloqueio IS NOT NULL AND x.dt_bloqueio::text <> '')
	and	((x.dt_servico between dt_inicial_p and dt_final_p AND ie_ignorar_datas_p = 'N') or (ie_ignorar_datas_p = 'S'));

	if (ie_opcao_p = 'DB') then
		ds_retorno_w := dt_bloqueio_w;
	elsif (ie_opcao_p = 'JB') then
		ds_retorno_w := ds_justificativa_w;
	elsif (ie_opcao_p = 'UB') then
		ds_retorno_w := nm_usuario_bloq_w;
	elsif (ie_opcao_p = 'SB') then
		ds_retorno_w := ds_servico_todos_w;
	end if;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_nut_atend_serv ( nr_atendimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_opcao_p text, ie_ignorar_datas_p text) FROM PUBLIC;

