-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_max_dt_prev_execucao (nr_prescricao_p bigint) RETURNS timestamp AS $body$
DECLARE

 
dt_prev_execucao_w	timestamp;
ie_agrupa_ficha_w	varchar(1);

BEGIN
 
 
select	l.ie_agrupa_ficha_fleury 
into STRICT	ie_agrupa_ficha_w 
from	lab_parametro l, 
	prescr_medica p 
where	l.cd_estabelecimento = p.cd_estabelecimento 
and	p.nr_prescricao	= nr_prescricao_p;
 
if (ie_agrupa_ficha_w <> 'N') then 
 
	select	max(dt_prev_execucao) 
	into STRICT	dt_prev_execucao_w 
	from	prescr_procedimento 
	where	nr_prescricao = nr_prescricao_p 
	and		nr_grupo_integracao = obter_grupo_prescr_proc_fleury(nr_prescricao_p);
 
else 
 
	select	max(dt_prev_execucao) 
	into STRICT	dt_prev_execucao_w 
	from	prescr_procedimento 
	where	nr_prescricao = nr_prescricao_p 
	AND ((obter_sigla_exame_fleury(nr_prescricao, nr_sequencia) IS NOT NULL AND (obter_sigla_exame_fleury(nr_prescricao, nr_sequencia))::text <> '') or (obter_sigla_exame_fleury_diag(nr_prescricao, nr_sequencia) IS NOT NULL AND (obter_sigla_exame_fleury_diag(nr_prescricao, nr_sequencia))::text <> ''));
 
end if;
 
 
return	dt_prev_execucao_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_max_dt_prev_execucao (nr_prescricao_p bigint) FROM PUBLIC;

