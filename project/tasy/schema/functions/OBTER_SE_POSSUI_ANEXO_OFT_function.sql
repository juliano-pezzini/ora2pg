-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_possui_anexo_oft (cd_pessoa_fisica_p bigint) RETURNS varchar AS $body$
DECLARE


ds_item_w   		varchar(255);
nr_seq_angio_retino_w   bigint;
nr_seq_biometria_w	bigint;
nr_seq_campimetria_w 	bigint;
nr_seq_cerastocopia_w 	bigint;
nr_seq_microscopia_w 	bigint;
nr_seq_oct_w 		bigint;
nr_seq_tomografia_w	bigint;
nr_seq_topografia_w	bigint;
nr_seq_conduta_w	bigint;	
nr_seq_consulta_w	bigint;
nr_seq_fundoscopia_w bigint;
nr_seq_biomicroscopia_w bigint;
nr_seq_oft_exame_externo_w bigint;
nr_seq_paquimetria_w bigint;
nr_seq_ultrassonografia_w  bigint;
nr_seq_mapeamento_w  bigint;
nr_seq_aberrometria_w bigint;
ie_ceratoscopia_w	varchar(1);	
ie_tipo_registro_w   varchar(15);	
ie_Altera_pasta_cerat_comp_w	varchar(1);		
	  

BEGIN

ie_altera_pasta_cerat_comp_w := Obter_Param_Usuario(3010, 125, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_altera_pasta_cerat_comp_w);

select 	max(nr_seq_angio_retino),
	max(nr_seq_biometria), 
	max(nr_seq_campimetria), 
	max(nr_seq_cerastocopia),  
	max(nr_seq_microscopia), 
	max(nr_seq_oct), 
	max(nr_seq_tomografia), 
	max(nr_seq_topografia),
	max(ie_ceratoscopia),
   max(nr_seq_fundoscopia), 
   max(nr_seq_biomicroscopia), 
   max(nr_seq_oft_exame_externo), 
   max(nr_seq_paquimetria), 
   max(nr_seq_ultrassonografia), 
   max(nr_seq_mapeamento), 
   max(nr_seq_aberrometria)
into STRICT	nr_seq_angio_retino_w, 
	nr_seq_biometria_w, 
	nr_seq_campimetria_w, 
	nr_seq_cerastocopia_w,  
	nr_seq_microscopia_w, 
	nr_seq_oct_w, 
	nr_seq_tomografia_w, 
	nr_seq_topografia_w,
	ie_ceratoscopia_w,
   nr_seq_fundoscopia_w, 
   nr_seq_biomicroscopia_w, 
   nr_seq_oft_exame_externo_w, 
   nr_seq_paquimetria_w, 
   nr_seq_ultrassonografia_w, 
   nr_seq_mapeamento_w, 
   nr_seq_aberrometria_w
from    oft_imagem_exame
where   nr_seq_consulta  in (SELECT c.nr_sequencia 
                                       from     atendimento_paciente b, 
                                                oft_consulta c 
                                        where   c.nr_atendimento = b.nr_atendimento 
                                        and     b.cd_pessoa_fisica = cd_pessoa_fisica_p 
													 and		coalesce(c.dt_cancelamento::text, '') = ''
                                        
union
                                         
                                        SELECT  a.nr_sequencia       
                                        from    oft_consulta a       
                                        where   a.cd_pessoa_fisica = cd_pessoa_fisica_p
													 and		coalesce(a.dt_cancelamento::text, '') = '');
					
select 	max(nr_seq_conduta)
into STRICT	nr_seq_conduta_w
from    oft_anexo
where   nr_seq_consulta  in (SELECT c.nr_sequencia
                                       from     atendimento_paciente b, 
                                                oft_consulta c 
                                        where   c.nr_atendimento = b.nr_atendimento 
                                        and     b.cd_pessoa_fisica = cd_pessoa_fisica_p
													 and		coalesce(c.dt_cancelamento::text, '') = ''	
                                        
union
                                         
                                        SELECT  a.nr_sequencia       
                                        from    oft_consulta a       
                                        where   a.cd_pessoa_fisica = cd_pessoa_fisica_p
													 and		coalesce(a.dt_cancelamento::text, '') = '');
					
select 	max(nr_seq_consulta)
into STRICT	nr_seq_consulta_w
from    oft_anexo
where   nr_seq_consulta  in (SELECT c.nr_sequencia
                                       from     atendimento_paciente b, 
                                                oft_consulta c 
                                        where   c.nr_atendimento = b.nr_atendimento 
                                        and     b.cd_pessoa_fisica = cd_pessoa_fisica_p 
													 and		coalesce(c.dt_cancelamento::text, '') = ''
                                        
union
                                         
                                        SELECT  a.nr_sequencia       
                                        from    oft_consulta a       
                                        where   a.cd_pessoa_fisica = cd_pessoa_fisica_p
													 and		coalesce(a.dt_cancelamento::text, '') = '');
				

if (nr_seq_angio_retino_w IS NOT NULL AND nr_seq_angio_retino_w::text <> '') then
   select   coalesce(max(ie_tipo_registro),'A')
   into STRICT     ie_tipo_registro_w
   from     oft_angio_retino
   where    nr_sequencia = nr_seq_angio_retino_w;
   if (ie_tipo_registro_w = 'A') then
      ds_item_w := '71' || ',';
   else
      ds_item_w := '298' || ',';
   end if;
end if;

if (nr_seq_biometria_w IS NOT NULL AND nr_seq_biometria_w::text <> '') then
	ds_item_w := ds_item_w || '78' || ',';	
end if;

if (nr_seq_campimetria_w IS NOT NULL AND nr_seq_campimetria_w::text <> '') then
	ds_item_w := ds_item_w || '171' || ',';
end if;

if (nr_seq_cerastocopia_w IS NOT NULL AND nr_seq_cerastocopia_w::text <> '') then
	ds_item_w := ds_item_w || '175' || ',';
end if;

if (nr_seq_microscopia_w IS NOT NULL AND nr_seq_microscopia_w::text <> '') then
	ds_item_w := ds_item_w || '80' || ',';
end if;

if (nr_seq_oct_w IS NOT NULL AND nr_seq_oct_w::text <> '') then
	ds_item_w := ds_item_w || '177' || ',';
end if;

if (nr_seq_tomografia_w IS NOT NULL AND nr_seq_tomografia_w::text <> '') then
	ds_item_w := ds_item_w || '173' || ',';
end if;

if (ie_Altera_pasta_cerat_comp_w = 'N' AND nr_seq_topografia_w IS NOT NULL AND nr_seq_topografia_w::text <> '') then
	ds_item_w := ds_item_w || '168' || ',';
end if;

if (ie_Altera_pasta_cerat_comp_w = 'S' AND ie_ceratoscopia_w = 'S') then
    ds_item_w := ds_item_w || '168' || ',';
end if;

if (nr_seq_conduta_w IS NOT NULL AND nr_seq_conduta_w::text <> '') then
	ds_item_w := ds_item_w || '24' || ',';
end if;

if (nr_seq_consulta_w IS NOT NULL AND nr_seq_consulta_w::text <> '') then
	ds_item_w := ds_item_w || '31' || ',';
end if;

if (nr_seq_fundoscopia_w IS NOT NULL AND nr_seq_fundoscopia_w::text <> '') then
	ds_item_w := ds_item_w || '9' || ',';
end if;

if (nr_seq_biomicroscopia_w IS NOT NULL AND nr_seq_biomicroscopia_w::text <> '') then
	ds_item_w := ds_item_w || '10' || ',';
end if;

if (nr_seq_oft_exame_externo_w IS NOT NULL AND nr_seq_oft_exame_externo_w::text <> '') then
	ds_item_w := ds_item_w || '6' || ',';
end if;

if (nr_seq_paquimetria_w IS NOT NULL AND nr_seq_paquimetria_w::text <> '') then
	ds_item_w := ds_item_w || '84' || ',';
end if;

if (nr_seq_ultrassonografia_w IS NOT NULL AND nr_seq_ultrassonografia_w::text <> '') then
	ds_item_w := ds_item_w || '277' || ',';
end if;

if (nr_seq_mapeamento_w IS NOT NULL AND nr_seq_mapeamento_w::text <> '') then
	ds_item_w := ds_item_w || '276' || ',';
end if;

if (nr_seq_aberrometria_w IS NOT NULL AND nr_seq_aberrometria_w::text <> '') then
	ds_item_w := ds_item_w || '302' || ',';
end if;


ds_item_w := SUBSTR(ds_item_w,1,LENGTH(ds_item_w)-1);

return ds_item_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_possui_anexo_oft (cd_pessoa_fisica_p bigint) FROM PUBLIC;

