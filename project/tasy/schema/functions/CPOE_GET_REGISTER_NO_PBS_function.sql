-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_get_register_no_pbs ( NR_ATENDIMENTO_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE, TYPE_PRESCRIPTION_P text, NR_SEQ_ITEM_PRESCRIPTION_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE) RETURNS varchar AS $body$
DECLARE

  IS_EPS_CONVENIO_W     CONVENIO_PLANO.IE_EPS%TYPE;
  NM_USUARIO_W          CPOE_MATERIAL.NM_USUARIO%TYPE;
  DS_RESULT_W           varchar(1);

BEGIN
  NM_USUARIO_W := WHEB_USUARIO_PCK.GET_NM_USUARIO;

  SELECT  MAX(IS_EPS_CONVENIO(B.CD_CONVENIO, B.CD_PLANO_CONVENIO))
  INTO STRICT    IS_EPS_CONVENIO_W
  FROM    ATEND_CATEGORIA_CONVENIO B
  WHERE   B.NR_ATENDIMENTO = NR_ATENDIMENTO_P;

      IF (IS_EPS_CONVENIO_W = 'N') THEN
        DS_RESULT_W := NULL;
      ELSE
        IF (TYPE_PRESCRIPTION_P IN ('M', 'MA')) THEN
            SELECT  MAX(1)
            INTO STRICT    DS_RESULT_W
            FROM    CPOE_MATERIAL A
            WHERE   A.NR_ATENDIMENTO = NR_ATENDIMENTO_P
            AND     coalesce(A.DT_SUSPENSAO::text, '') = ''
            AND     coalesce(A.DT_LIBERACAO::text, '') = ''
            AND     A.NM_USUARIO = NM_USUARIO_W
            AND     A.NR_SEQUENCIA = NR_SEQ_ITEM_PRESCRIPTION_P
            AND     CPOE_GET_NOPBS_MATERIAL(A.CD_MATERIAL) = 'S';

            IF (coalesce(DS_RESULT_W::text, '') = '') THEN
              SELECT  MAX(1)
              INTO STRICT    DS_RESULT_W
              FROM    CPOE_MATERIAL A
              WHERE   NR_ATENDIMENTO = NR_ATENDIMENTO_P
              AND     coalesce(A.DT_SUSPENSAO::text, '') = ''
              AND     coalesce(A.DT_LIBERACAO::text, '') = ''
              AND     A.NM_USUARIO = NM_USUARIO_W
              AND     A.NR_SEQUENCIA = NR_SEQ_ITEM_PRESCRIPTION_P
              AND ( CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_COMP1) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_COMP2) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_COMP3) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_COMP4) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_COMP5) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_COMP6) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_COMP7) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_DIL) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_RECONS) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_RECONS1) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_RECONS2) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_RECONS3) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_RECONS4) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_RECONS5) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_RECONS6) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_RECONS7) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_RED) = 'S'
                      );
            END IF;

        ELSIF (TYPE_PRESCRIPTION_P = 'P') THEN
            IF (coalesce(DS_RESULT_W::text, '') = '') THEN
              SELECT  MAX(1)
              INTO STRICT    DS_RESULT_W
              FROM    CPOE_PROCEDIMENTO A
              WHERE   A.NR_ATENDIMENTO = NR_ATENDIMENTO_P
              AND     coalesce(A.DT_SUSPENSAO::text, '') = ''
              AND     coalesce(A.DT_LIBERACAO::text, '') = ''
              AND     A.NM_USUARIO = NM_USUARIO_W
              AND     A.NR_SEQUENCIA = NR_SEQ_ITEM_PRESCRIPTION_P
              AND     A.NR_SEQ_PROC_INTERNO = (
                                                SELECT  X.NR_SEQUENCIA
                                                FROM    PROC_INTERNO X,
                                                        PROCEDIMENTO Y
                                                WHERE   X.NR_SEQUENCIA = A.NR_SEQ_PROC_INTERNO
                                                AND     X.CD_PROCEDIMENTO_LOC = Y.CD_PROCEDIMENTO_LOC
                                                AND     coalesce(Y.IE_NOPBS, 'N') = 'S'
                                                AND     Y.IE_ORIGEM_PROCED = 4
                                              );
            END IF;

            IF (coalesce(DS_RESULT_W::text, '') = '') THEN
              select  max(1)
              into STRICT    ds_result_w
              from    cpoe_procedimento cp
              where   cp.nr_atendimento = nr_atendimento_p
              and     coalesce(cp.dt_suspensao::text, '') = ''
              and     coalesce(cp.dt_liberacao::text, '') = ''
              and     cp.nm_usuario = nm_usuario_w
              and     cp.nr_sequencia = nr_seq_item_prescription_p
              and     exists (
                SELECT  1
                from    material mat
                where   coalesce(mat.ie_nopbs, 'N') = 'S'
                and     mat.cd_material in (
                                              cp.cd_mat_proc1, cp.cd_mat_proc2, cp.cd_mat_proc3, 
                                              cp.cd_mat_proc4, cp.cd_mat_proc5, cp.cd_mat_proc6,
                                              cp.cd_mat_proc7
                                            )
              );
            END IF;

        ELSIF (TYPE_PRESCRIPTION_P = 'N') THEN
            IF (coalesce(DS_RESULT_W::text, '') = '') THEN
              SELECT  MAX(1)
              INTO STRICT    DS_RESULT_W
              FROM    CPOE_DIETA A
              WHERE   A.NR_ATENDIMENTO = NR_ATENDIMENTO_P
              AND     coalesce(A.DT_SUSPENSAO::text, '') = ''
              AND     coalesce(A.DT_LIBERACAO::text, '') = ''
              AND     A.IE_TIPO_DIETA IN ('E','S','L')
              AND     A.NM_USUARIO = NM_USUARIO_W
              AND ( CPOE_GET_NOPBS_MATERIAL(A.CD_MATERIAL) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_PROD1) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_PROD_ADIC1) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_PROD_ADIC2) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_PROD_ADIC3) = 'S'
                        OR  CPOE_GET_NOPBS_MATERIAL(A.CD_MAT_PROD_ADIC4) = 'S'
                        )
              AND     A.NR_SEQUENCIA = NR_SEQ_ITEM_PRESCRIPTION_P
              AND     CPOE_GET_NOPBS_MATERIAL(A.CD_MATERIAL) = 'S';
            END IF;

        ELSIF (TYPE_PRESCRIPTION_P = 'G') THEN
            IF (coalesce(DS_RESULT_W::text, '') = '') THEN
              SELECT  MAX(1)
              INTO STRICT    DS_RESULT_W
              FROM    CPOE_GASOTERAPIA A,
                      CPOE_MATERIAL_GASO_V V
              WHERE   A.NR_ATENDIMENTO = NR_ATENDIMENTO_P
              AND     coalesce(A.DT_SUSPENSAO::text, '') = ''
              AND     coalesce(A.DT_LIBERACAO::text, '') = ''
              AND     A.NM_USUARIO = NM_USUARIO_W
              AND     A.NR_SEQUENCIA = NR_SEQ_ITEM_PRESCRIPTION_P
              AND     V.NR_SEQ_GASOTERAPIA = A.NR_SEQUENCIA
              AND     CPOE_GET_NOPBS_MATERIAL(V.CD_MATERIAL) = 'S';
            END IF;

        ELSIF (TYPE_PRESCRIPTION_P = 'AP') THEN
            IF (coalesce(DS_RESULT_W::text, '') = '') THEN
              SELECT  MAX(1)
              INTO STRICT    DS_RESULT_W
              FROM    CPOE_ANATOMIA_PATOLOGICA A,
                      PROC_INTERNO B,
                      PROCEDIMENTO C
              WHERE   A.NR_ATENDIMENTO = NR_ATENDIMENTO_P
              AND     coalesce(A.DT_LIBERACAO::text, '') = ''
              AND     coalesce(A.DT_SUSPENSAO::text, '') = ''
              AND     A.NM_USUARIO = NM_USUARIO_W
              AND     A.NR_SEQUENCIA = NR_SEQ_ITEM_PRESCRIPTION_P
              AND     B.NR_SEQUENCIA = A.NR_SEQ_PROC_INTERNO
              AND     C.CD_PROCEDIMENTO = B.CD_PROCEDIMENTO
              AND     coalesce(C.IE_NOPBS, 'N') = 'S';
            END IF;

        ELSIF (TYPE_PRESCRIPTION_P = 'R') THEN
            IF (coalesce(DS_RESULT_W::text, '') = '') THEN
              SELECT  MAX(1)
              INTO STRICT    DS_RESULT_W
              FROM    CPOE_RECOMENDACAO A,
                      REGRA_PROCED_RECOMENDACAO B,
                      PROCEDIMENTO C
              WHERE   A.NR_ATENDIMENTO = NR_ATENDIMENTO_P
              AND     coalesce(A.DT_LIBERACAO::text, '') = ''
              AND     (A.CD_RECOMENDACAO IS NOT NULL AND A.CD_RECOMENDACAO::text <> '')
              AND     A.NM_USUARIO = NM_USUARIO_W
              AND     A.NR_SEQUENCIA = NR_SEQ_ITEM_PRESCRIPTION_P
              AND     B.CD_TIPO_RECOMENDACAO = A.CD_RECOMENDACAO
              AND     C.CD_PROCEDIMENTO = B.CD_PROCEDIMENTO
              AND     C.IE_ORIGEM_PROCED = B.IE_ORIGEM_PROCED
              AND     coalesce(C.IE_NOPBS,'N') = 'S';
            END IF;

            IF (coalesce(DS_RESULT_W::text, '') = '') THEN
              SELECT  MAX(1)
              INTO STRICT    DS_RESULT_W
              FROM (SELECT
                        *
                  FROM
                        cpoe_recomendacao          a,
                        atend_categoria_convenio   b,
                        componente_kit             c
                  WHERE a.nr_atendimento = b.nr_atendimento
                        AND c.cd_kit_material = obter_kit_mat_rec(a.cd_recomendacao, obter_perfil_ativo, b.cd_convenio, obter_setor_atendimento(nr_atendimento_p))
                        AND a.nr_atendimento = nr_atendimento_p
                        AND a.nm_usuario = nm_usuario_w
                        and a.nr_sequencia = nr_seq_item_prescription_p
                        AND coalesce(a.dt_liberacao::text, '') = ''
                        AND coalesce(a.dt_suspensao::text, '') = '') a,
              material b
              WHERE b.cd_material = a.cd_material
                    AND coalesce(b.ie_nopbs,'N') = 'S';
            END IF;

        ELSIF (TYPE_PRESCRIPTION_P in ('PH', 'MAH','PRH')) THEN
			if (coalesce(ds_result_w::text, '') = '' ) then
				select  max(1)
				into STRICT	ds_result_w
				from	cpoe_hemoterapia hem,
						san_derivado sd,
						proc_interno pri,
						procedimento prc
				where   hem.nr_seq_derivado      = sd.nr_sequencia
				and     sd.nr_seq_proc_interno   = pri.nr_sequencia
				and     pri.cd_procedimento      = prc.cd_procedimento
				and     pri.ie_origem_proced     = prc.ie_origem_proced
				and     hem.nr_atendimento       = nr_atendimento_p
				and     hem.nr_sequencia         = nr_seq_item_prescription_p
				and     coalesce(hem.dt_liberacao::text, '') = ''
				and     coalesce(hem.dt_suspensao::text, '') = '';
			end if;
			
			if (coalesce(ds_result_w::text, '') = '' ) then
				select  max(1)
				into STRICT	ds_result_w
				from    cpoe_material cmt,
						cpoe_hemoterapia hem,
						material m
				where   m.cd_material in (
										   cmt.cd_material, cmt.cd_mat_comp1, cmt.cd_mat_comp2, cmt.cd_mat_comp3,
										   cmt.cd_mat_comp4, cmt.cd_mat_comp5, cmt.cd_mat_comp6, cmt.cd_mat_comp7,
										   cmt.cd_mat_dil, cmt.cd_mat_red, cmt.cd_mat_recons, cmt.cd_mat_recons1,
										   cmt.cd_mat_recons2, cmt.cd_mat_recons3, cmt.cd_mat_recons4,
										   cmt.cd_mat_recons5, cmt.cd_mat_recons6, cmt.cd_mat_recons7
										  )
				and     cmt.nr_seq_hemoterapia = hem.nr_sequencia
				and     hem.nr_sequencia       = nr_seq_item_prescription_p
				and     coalesce(hem.dt_liberacao::text, '') = ''
				and     coalesce(hem.dt_suspensao::text, '') = '';
			end if;

			if (coalesce(ds_result_w::text, '') = '' ) then
				select  max(1)
				into STRICT	ds_result_w
				from 	cpoe_hemoterapia hem,
						cpoe_procedimento cpp,
						proc_interno pri,
						procedimento prc
				where 	hem.nr_sequencia        = cpp.nr_seq_hemoterapia
				and     hem.nr_seq_proc_interno = pri.nr_sequencia
				and     pri.cd_procedimento     = prc.cd_procedimento
				and     pri.ie_origem_proced    = prc.ie_origem_proced
				and     hem.nr_sequencia        = nr_seq_item_prescription_p
				and     coalesce(hem.dt_liberacao::text, '') = ''
				and     coalesce(hem.dt_suspensao::text, '') = '';
			end if;
        END IF;
    END IF;

  RETURN DS_RESULT_W;
EXCEPTION
  WHEN no_data_found THEN RETURN NULL;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_get_register_no_pbs ( NR_ATENDIMENTO_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE, TYPE_PRESCRIPTION_P text, NR_SEQ_ITEM_PRESCRIPTION_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE) FROM PUBLIC;

