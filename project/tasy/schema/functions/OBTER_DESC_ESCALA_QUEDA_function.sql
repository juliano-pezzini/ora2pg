-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_desc_escala_queda ( cd_setor_atendimento_p bigint, nr_atendimento_p bigint, ie_opcao_p text ) RETURNS varchar AS $body$
DECLARE

/*
ie_opcao_p	Opcao
Descricao da escala	D
Risco	R
*/
nr_seq_setor_w					pan_configuracao_setor.nr_sequencia%Type;
nr_seq_escala_w					pan_configuracao_queda.nr_seq_escala%Type;
nr_seq_score_flex_w				pan_configuracao_queda.nr_seq_score_flex%Type;
ds_score_flex_w					varchar(255);	
ds_escala_w						varchar(255);
dt_avalicao_w					timestamp;
qt_pontuacao_w					bigint;
ds_titulo_w						varchar(1000);
ds_risco_w						varchar(1000);
nr_seq_cad_queda_w				bigint;
ds_retorno_w					varchar(1000);

dt_avalicao_ret_w				timestamp;
qt_pontuacao_ret_w				bigint;
ds_risco_ret_w					varchar(1000);
nr_seq_cad_queda_ret_w			bigint;
ds_titulo_ret_w					varchar(1000);

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pan_configuracao_setor
	where	cd_setor_atendimento = cd_setor_atendimento_p
	and	coalesce(ie_situacao,'A')= 'A'
	order by nr_sequencia;
	
C02 CURSOR FOR
	SELECT	a.nr_seq_escala,
			a.nr_seq_score_flex,
			substr(obter_desc_regra_score_flex(a.nr_seq_score_flex,nr_seq_escala,'R'),1,255),
			substr(coalesce(obter_caption_escala(a.nr_seq_escala),obter_valor_dominio(1799,a.nr_seq_escala)),1,255),
			a.nr_sequencia
	from	pan_configuracao_queda a	
	where	a.nr_seq_setor = nr_seq_setor_w
	order by a.nr_sequencia;
			

BEGIN

if (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '' AND nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

	open C01;
	loop
	fetch C01 into	
		nr_seq_setor_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
			open C02;
			loop
			fetch C02 into	
				nr_seq_escala_w,
				nr_seq_score_flex_w,
				ds_score_flex_w,
				ds_escala_w,
				nr_seq_cad_queda_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				
				if ( nr_seq_escala_w = 89) then --morse
				
					Select 	max(dt_avaliacao),
							max(qt_pontuacao),
							max(substr(Obter_desc_escala_morse(qt_pontuacao),1,100))
					into STRICT	dt_avalicao_w,
							qt_pontuacao_w,
							ds_risco_w
					from    escala_morse
					where   nr_sequencia = (SELECT  max(nr_sequencia)
											from    escala_morse
											where   nr_atendimento = nr_atendimento_p
											and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
											and		coalesce(dt_inativacao::text, '') = '');
											
											
					ds_titulo_w := ds_escala_w;
											
											
				elsif ( nr_seq_escala_w = 120) then --stratfy
					
					Select 	max(dt_avaliacao),
							max(qt_score),
							max(subStr(obter_desc_escala_stratify(qt_score),1,1000))
					into STRICT	dt_avalicao_w,
							qt_pontuacao_w,
							ds_risco_w
					from    escala_stratify
					where   nr_atendimento = nr_atendimento_p
					and     nr_sequencia = (SELECT  max(nr_sequencia)
											from    escala_stratify
											where   nr_atendimento = nr_atendimento_p
											and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
											and		coalesce(dt_inativacao::text, '') = '');
											
											
					ds_titulo_w := ds_escala_w;
											

				elsif ( nr_seq_escala_w = 94) then --eark
					select  max(dt_avaliacao),
							max(qt_pontuacao),
							max(substr(obter_descr_escala_earq(qt_pontuacao), 1, 255))
					into STRICT	dt_avalicao_w,
							qt_pontuacao_w,
							ds_risco_w
					from    escala_earq
					where   nr_atendimento = nr_atendimento_p
					and     nr_sequencia = (SELECT  max(nr_sequencia)
								from    escala_earq
								where   nr_atendimento = nr_atendimento_p
								and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
								and	coalesce(dt_inativacao::text, '') = '');
								
					ds_titulo_w := ds_escala_w;							
								
				
				elsif ( nr_seq_escala_w = 173) then --frat
					select  max(dt_avaliacao),
							max(qt_pontuacao),
							max(substr(obter_resultado_jh_frat(qt_pontuacao), 1, 255))
					into STRICT	dt_avalicao_w,
							qt_pontuacao_w,
							ds_risco_w
					from    escala_frat
					where   nr_atendimento = nr_atendimento_p
					and     nr_sequencia = (SELECT  max(nr_sequencia)
								from    escala_frat
								where   nr_atendimento = nr_atendimento_p
								and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
								and	coalesce(dt_inativacao::text, '') = '');
								
					ds_titulo_w := ds_escala_w;
				
				elsif ( nr_seq_escala_w = 78) then --downton
					select  max(dt_avaliacao),
							max(qt_pontuacao),
							max(substr(obter_descr_escala_downton(qt_pontuacao), 1, 255))
					into STRICT	dt_avalicao_w,
							qt_pontuacao_w,
							ds_risco_w
					from    escala_downton
					where   nr_atendimento = nr_atendimento_p
					and     nr_sequencia = (SELECT  max(nr_sequencia)
											from    escala_downton
											where   nr_atendimento = nr_atendimento_p
											and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
											and	coalesce(dt_inativacao::text, '') = '');
								
					ds_titulo_w := ds_escala_w;
				
				
				elsif ( nr_seq_escala_w = 124) then --score flex
					select  max(dt_avaliacao),
							max(substr(obter_resultado_escala_eif(nr_sequencia,'T'),1,255)),
							max(substr(obter_resultado_escala_eif(nr_sequencia, 'D'),1,255))
					into STRICT	dt_avalicao_w,
							qt_pontuacao_w,
							ds_risco_w
					from    escala_eif
					where   nr_atendimento = nr_atendimento_p
					and     nr_sequencia = (SELECT  max(nr_sequencia)
											from    escala_eif
											where   nr_atendimento = nr_atendimento_p
											and 	nr_seq_escala = nr_seq_score_flex_w
											and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
											and		coalesce(dt_inativacao::text, '') = '');
				
				ds_titulo_w := ds_score_flex_w;
				
					
				elsif ( nr_seq_escala_w = 142) then --score flex II
					select  max(dt_avaliacao),
							max(qt_pontos),
							max(substr(obter_desc_resul_score_flex_2(qt_pontos,nr_seq_escala),1,255))
					into STRICT	dt_avalicao_w,
							qt_pontuacao_w,
							ds_risco_w
					from    escala_eif_ii
					where   nr_atendimento = nr_atendimento_p
					and     nr_sequencia = (SELECT  max(nr_sequencia)
											from    escala_eif_ii
											where   nr_atendimento = nr_atendimento_p
											and 	nr_seq_escala = nr_seq_score_flex_w
											and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
											and		coalesce(dt_inativacao::text, '') = '');


					ds_titulo_w := ds_score_flex_w;
				
				end if;
				
				
				if ( coalesce(dt_avalicao_ret_w::text, '') = '' or dt_avalicao_ret_w < dt_avalicao_w ) then
				
					dt_avalicao_ret_w			:= dt_avalicao_w;
					qt_pontuacao_ret_w			:= qt_pontuacao_w;
					ds_risco_ret_w				:= ds_risco_w;
					nr_seq_cad_queda_ret_w		:= nr_seq_cad_queda_w;
					ds_titulo_ret_w				:= ds_titulo_w;
				
				end if;
				
				end;
			end loop;
			close C02;		
			
		end;
	end loop;
	close C01;

end if;

if ( ie_opcao_p = 'D' ) then
	
	ds_retorno_w := substr( ds_titulo_ret_w ||' - ' ||ds_risco_ret_w || ' - '||dt_avalicao_ret_w,1,1000);

elsif ( ie_opcao_p = 'R' ) then

	if ( coalesce(nr_seq_cad_queda_ret_w,0) > 0) then
	
		Select  coalesce(max(ie_risco_queda),'N')
		into STRICT	ds_risco_w
		from	pan_configuracao_queda_po
		where	nr_seq_config_queda = nr_seq_cad_queda_ret_w
		and		qt_pontuacao_ret_w between coalesce(vl_minimo,0) and coalesce(vl_maximo,9999);
	
	end if;	

	ds_retorno_w := coalesce(ds_risco_w,'N');	
	
end if;


return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_desc_escala_queda ( cd_setor_atendimento_p bigint, nr_atendimento_p bigint, ie_opcao_p text ) FROM PUBLIC;

