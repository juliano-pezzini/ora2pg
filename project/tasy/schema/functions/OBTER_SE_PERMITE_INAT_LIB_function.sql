-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_permite_inat_lib ( nm_usuario_reg_p text, nr_seq_obj_schematic_p text, ie_opcao_p text, ie_integracao_p text default 'N') RETURNS varchar AS $body$
DECLARE


/*Descrição					ie_opcao_p
Inativar					I
Liberar					L
*/
ie_permite_w				varchar(1) := 'S';
ie_regra_w					varchar(1) := 'N';
ie_regra_cad_w				varchar(1) := 'N';
ie_regra_inativar_w			varchar(1) := 'V';
cd_perfil_w					bigint;
cd_estabelecimento_w		bigint;
nm_usuario_w				varchar(15);

C01 CURSOR FOR
	SELECT	coalesce(ie_inativar,'V')
	from	tabela_crud_param
	where (nr_seq_obj_schematic = nr_seq_obj_schematic_p or nr_seq_visao = nr_seq_obj_schematic_p)
	and		coalesce(NM_USUARIO_PARAM, nm_usuario_w) 	= nm_usuario_w
	and		coalesce(cd_perfil, cd_perfil_w) 	= cd_perfil_w
	and		coalesce(cd_estabelecimento, cd_estabelecimento_w) 	= cd_estabelecimento_w
	order by 	coalesce(nm_usuario,'AAA'),
				coalesce(cd_perfil,0),
				coalesce(cd_estabelecimento,0);


BEGIN

cd_perfil_w := wheb_usuario_pck.get_cd_perfil;
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

if ( ie_opcao_p = 'I') then

	select	coalesce(max('S'),'N')
	into STRICT	ie_regra_w
	from	TABELA_CRUD_PARAM;

	if ( ie_regra_w = 'S') then

		open C01;
		loop
		fetch C01 into
			ie_regra_cad_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			ie_regra_inativar_w := ie_regra_cad_w;
			end;
		end loop;
		close C01;


		if ( ie_regra_inativar_w <> 'V') then

			ie_permite_w := 'N';

			if ( ie_regra_inativar_w = 'S') and ( nm_usuario_reg_p = nm_usuario_w) then

				ie_permite_w := 'S';

			elsif ( ie_regra_inativar_w = 'T') then

				ie_permite_w := 'T';

			elsif ( ie_regra_inativar_w = 'I') and
				   ((nm_usuario_reg_p = nm_usuario_w) or (coalesce(ie_integracao_p,'N') = 'S'))then

				ie_permite_w := 'S';

			end if;

		end if;


	end if;


end if;

return	ie_permite_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_permite_inat_lib ( nm_usuario_reg_p text, nr_seq_obj_schematic_p text, ie_opcao_p text, ie_integracao_p text default 'N') FROM PUBLIC;

