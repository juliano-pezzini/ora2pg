-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_prescr_apae ( nr_prescricao_p bigint ) RETURNS varchar AS $body$
DECLARE



ds_dieta_w		varchar(500);
ds_dietas_w		varchar(500) := null;
ds_medicamento_w	varchar(500);
ds_medicamentos_w	varchar(500) := null;
ds_material_w 		varchar(500);
ds_materiais_w		varchar(500) := null;
ds_recomendacao_w 	varchar(2000);
ds_recomendacoes_w	varchar(500) := null;
ds_procedimento_w	varchar(500);
ds_procedimentos_w	varchar(500) := null;
ds_retorno_w		varchar(2000);


c01 CURSOR FOR
	SELECT		obter_desc_expressao(670822)/*'Dieta: '*/
 || substr(obter_nome_dieta(cd_dieta),1,40) || chr(13) ||
			CASE WHEN coalesce(ds_observacao::text, '') = '' THEN null  ELSE 'Obs.: ' END  || substr(ds_observacao,1,200)
	from		prescr_dieta
	where		nr_prescricao	= nr_prescricao_p
	and		ie_suspenso <> 'S'
	order by	1;

c02 CURSOR FOR
	SELECT		obter_desc_expressao(330076)/*'Medicamento: '*/
 || substr(b.ds_material,1,40) || chr(13) ||
			'Dos.: ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, a.nr_sequencia),1,40) || chr(13) ||
			CASE WHEN coalesce(ds_observacao::text, '') = '' THEN null  ELSE 'Obs.: ' END  || substr(ds_observacao,1,200)
	from  		material b,
			prescr_material a
	where 		a.cd_material    	= b.cd_material
	and 		a.nr_prescricao  	= nr_prescricao_p
	and 		coalesce(a.nr_sequencia_solucao::text, '') = ''
	and 		coalesce(a.nr_sequencia_proc::text, '') = ''
	and 		coalesce(a.nr_sequencia_diluicao::text, '') = ''
	and 		coalesce(a.nr_sequencia_dieta::text, '') = ''
	and		a.ie_agrupador		= 1
	and		a.ie_suspenso		<> 'S'
	order by 	a.nr_agrupamento,
	  		a.nr_sequencia;
c04 CURSOR FOR
	SELECT		obter_desc_expressao(329898)/*'Recomendação: '*/
 || substr(obter_rec_prescricao(nr_sequencia, nr_prescricao),1,255) || chr(13) ||
			CASE WHEN coalesce(ds_observacao::text, '') = '' THEN null  ELSE 'Obs.: ' END  || substr(ds_recomendacao,1,255)
	from		prescr_recomendacao
	where		nr_prescricao	= nr_prescricao_p
	and		ie_suspenso <> 'S';

c05 CURSOR FOR
	SELECT		obter_desc_expressao(296423)/*'Proced.: '*/
 || substr(obter_desc_prescr_proc(a.cd_procedimento,a.ie_origem_proced, a.nr_seq_proc_interno),1,240) || chr(13) ||
			CASE WHEN coalesce(ds_observacao::text, '') = '' THEN null  ELSE 'Obs.: ' END  || substr(ds_observacao,1,200)
	from   		prescr_procedimento a
	where  		a.nr_prescricao      	= nr_prescricao_p
	and		obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'O') = 'S'
	and		coalesce(a.nr_seq_solic_sangue::text, '') = ''
	and		a.ie_suspenso		<> 'S'
	and		coalesce(a.nr_seq_origem::text, '') = ''
	order by 	a.nr_agrupamento;


BEGIN

OPEN C01;
LOOP
FETCH C01 into
	ds_dieta_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	ds_dietas_w		:=	substr(ds_dietas_w || ds_dieta_w || chr(13),1,500);
	end;
END LOOP;
CLOSE C01;

OPEN C02;
LOOP
FETCH C02 into
	ds_medicamento_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	ds_medicamentos_w	:=	substr(ds_medicamentos_w || ds_medicamento_w || chr(13),1,500);
	end;
END LOOP;
CLOSE C02;

OPEN C04;
LOOP
FETCH C04 into
	ds_recomendacao_w;
EXIT WHEN NOT FOUND; /* apply on c04 */
	begin
	ds_recomendacoes_w	:=	substr(ds_recomendacoes_w || ds_recomendacao_w || chr(13),1,500);
	end;
END LOOP;
CLOSE C04;

OPEN C05;
LOOP
FETCH C05 into
	ds_procedimento_w;
EXIT WHEN NOT FOUND; /* apply on c05 */
	begin
	ds_procedimentos_w	:=	substr(ds_procedimentos_w || ds_procedimento_w || chr(13),1,500);
	end;
END LOOP;
CLOSE C05;

if (ds_dietas_w IS NOT NULL AND ds_dietas_w::text <> '') and (length(ds_retorno_w || ds_dietas_w) < 1995) then
	ds_retorno_w	:= substr(ds_retorno_w || ds_dietas_w || chr(13),1,2000);
end if;

if (ds_medicamentos_w IS NOT NULL AND ds_medicamentos_w::text <> '') and (length(ds_retorno_w || ds_medicamentos_w) < 1995) then
	ds_retorno_w	:= substr(ds_retorno_w || ds_medicamentos_w || chr(13),1,2000);
end if;

if (ds_materiais_w IS NOT NULL AND ds_materiais_w::text <> '') and (length(ds_retorno_w || ds_materiais_w) < 1995) then
	ds_retorno_w	:= substr(ds_retorno_w || ds_materiais_w || chr(13),1,2000);
end if;

if (ds_recomendacoes_w IS NOT NULL AND ds_recomendacoes_w::text <> '') and (length(ds_retorno_w || ds_recomendacoes_w) < 1995)  then
	ds_retorno_w	:= substr(ds_retorno_w || ds_recomendacoes_w || chr(13),1,2000);
end if;

if (ds_procedimentos_w IS NOT NULL AND ds_procedimentos_w::text <> '') and (length(ds_retorno_w || ds_procedimentos_w) < 1995)  then
	ds_retorno_w	:= substr(ds_retorno_w || ds_procedimentos_w || chr(13),1,2000);
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_prescr_apae ( nr_prescricao_p bigint ) FROM PUBLIC;

