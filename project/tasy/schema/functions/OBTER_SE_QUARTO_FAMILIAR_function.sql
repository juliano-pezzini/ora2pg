-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_quarto_familiar ( CD_SETOR_DESEJADO_P integer, CD_UNIDADE_BASICA_P text, CD_UNIDADE_COMPL_P text, CD_PESSOA_FISICA_P text ) RETURNS varchar AS $body$
DECLARE

    V_QUARTO_FAMILIAR varchar(1);
	V_PACIENTE_RESERVA integer;

BEGIN
	V_PACIENTE_RESERVA	:=	0;
	V_QUARTO_FAMILIAR	:=	'N';
	--Obtem se neste quarto eh possivel internar familiares de sexos diferentes
    if (CD_UNIDADE_BASICA_P IS NOT NULL AND CD_UNIDADE_BASICA_P::text <> '') then
		select	coalesce(IE_FAMILY_ROOM,'N')
		into STRICT 	V_QUARTO_FAMILIAR
		from	UNIDADE_ATENDIMENTO
		where	CD_SETOR_ATENDIMENTO	= CD_SETOR_DESEJADO_P
		and 	CD_UNIDADE_BASICA 		= CD_UNIDADE_BASICA_P
		and		CD_UNIDADE_COMPL		= CD_UNIDADE_COMPL_P;
    end if;
	--Obtem se o paciente parente esta associado ao paciente do quarto
	if (V_QUARTO_FAMILIAR = 'S') then
		SELECT COUNT(*)
        INTO STRICT v_paciente_reserva
        FROM
            pf_relacao_parentesco
        WHERE ( cd_pessoa_parente IN (
                SELECT
                    cd_paciente_reserva
                FROM
                    unidade_atendimento
                WHERE
                    cd_setor_atendimento = cd_setor_desejado_p
                    AND cd_unidade_basica = cd_unidade_basica_p
            )
              OR cd_pessoa_parente IN (
                SELECT
                    apa.cd_pessoa_fisica
                FROM
                    unidade_atendimento    ua,
                    atendimento_paciente   apa
                WHERE
                    ua.nr_atendimento = apa.nr_atendimento
                    AND ua.cd_setor_atendimento = cd_setor_desejado_p
                    AND ua.cd_unidade_basica = cd_unidade_basica_p
            ) )
            AND cd_pessoa_fisica = cd_pessoa_fisica_p;
	end if;
	if (V_PACIENTE_RESERVA > 0) then
		V_QUARTO_FAMILIAR := 'S';
	else
		V_QUARTO_FAMILIAR := 'N';
	end if;
    return V_QUARTO_FAMILIAR;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_quarto_familiar ( CD_SETOR_DESEJADO_P integer, CD_UNIDADE_BASICA_P text, CD_UNIDADE_COMPL_P text, CD_PESSOA_FISICA_P text ) FROM PUBLIC;

