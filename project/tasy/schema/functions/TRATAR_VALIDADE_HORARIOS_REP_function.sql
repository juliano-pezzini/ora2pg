-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tratar_validade_horarios_rep (nr_prescricao_p bigint, ds_horarios_p text, hr_prim_horario_p text) RETURNS varchar AS $body$
DECLARE


dt_prescricao_w		timestamp;
dt_inicio_prescr_w		timestamp;
dt_validade_prescr_w	timestamp;
dt_inicio_medic_w		timestamp;
ds_horarios_w		varchar(2000);
ds_horarios_validade_w	varchar(2000);
i			integer;
ie_loop_w		smallint 	:= 0;
qt_dia_add_w		bigint	:= 0;
hr_horario_w		varchar(7);
dt_horario_w		timestamp;
ie_valido_w		smallint;


BEGIN
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (ds_horarios_p IS NOT NULL AND ds_horarios_p::text <> '') then

	select	dt_prescricao,
		dt_inicio_prescr,
		dt_validade_prescr,
		obter_data_medic_dose_dif(nr_prescricao,hr_prim_horario_p) dt_inicio_medic
	into STRICT	dt_prescricao_w,
		dt_inicio_prescr_w,
		dt_validade_prescr_w,
		dt_inicio_medic_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	select	padroniza_horario(reordenar_horarios(dt_inicio_medic_w,ds_horarios_p)) || ' '
	into STRICT	ds_horarios_w
	;

	while(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') loop
		begin
		select	position(' ' in ds_horarios_w)
		into STRICT	i
		;

		if (i > 1) and ((substr(ds_horarios_w, 1, i-1) IS NOT NULL AND (substr(ds_horarios_w, 1, i-1))::text <> '')) then
			hr_horario_w	:= substr(ds_horarios_w, 1, i-1);
			hr_horario_w	:= replace(hr_horario_w, ' ', '');
			ds_horarios_w	:= substr(ds_horarios_w, i+1, 2000);

			if (ie_loop_w = 0) and (hr_horario_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then
				qt_dia_add_w	:= 1;
			elsif (position('A' in hr_horario_w) > 0) and (qt_dia_add_w = 0) then
				qt_dia_add_w	:= 1;
			elsif (position('AA' in hr_horario_w) > 0) then
				qt_dia_add_w	:= qt_dia_add_w + 1;
			end if;

			ie_loop_w	:= 1;
			hr_horario_w	:= replace(hr_horario_w,'A','');
			hr_horario_w	:= replace(hr_horario_w,'A','');
			dt_horario_w	:= to_date(to_char(dt_prescricao_w + qt_dia_add_w,'dd/mm/yyyy') || ' ' || replace(hr_horario_w, 'A', '') || ':00','dd/mm/yyyy hh24:mi:ss');

			select	count(*)
			into STRICT	ie_valido_w
			
			where	dt_horario_w >= dt_inicio_medic_w
			and	dt_horario_w < dt_validade_prescr_w;

			if (ie_valido_w > 0) then
				ds_horarios_validade_w	:= ds_horarios_validade_w || hr_horario_w ||' ';
				--nr_intervalo_p	:= nr_intervalo_p + 1;
			end if;

		elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then
			ds_horarios_w	:= '';
		end if;
		end;
	end loop;

end if;

return ds_horarios_validade_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tratar_validade_horarios_rep (nr_prescricao_p bigint, ds_horarios_p text, hr_prim_horario_p text) FROM PUBLIC;

