-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_duracao_classif_agecons ( CD_AGENDA_P bigint, DT_MARCACAO_P timestamp, NR_SEQ_AGEINT_P bigint, NR_SEQ_ITEM_P bigint, CD_MEDICO_P text, nm_usuario_p text, CD_ESTABELECIMENTO_P bigint) RETURNS bigint AS $body$
DECLARE

 
ie_utiliza_dur_classif_w	parametro_agenda_integrada.ie_utiliza_dur_classif%type;
ie_classif_agenda_w			agenda_integrada_item.ie_classif_agenda%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
qt_duracao_classif_w		bigint := 0;
ie_cons_dur_exames_adic_w	varchar(1);
nr_seq_exame_adic_w			ageint_exame_adic_item.nr_seq_proc_interno%type;
ie_lado_adic_w				ageint_exame_adic_item.ie_lado%type;
cd_pessoa_fisica_w			agenda_integrada.cd_pessoa_fisica%type;
cd_convenio_w				agenda_integrada.cd_convenio%type;
cd_categoria_w				agenda_integrada.cd_categoria%type;
cd_plano_w					agenda_integrada.cd_plano%type;
qt_minuto_aux_adic_w		bigint	:= 0;
qt_minuto_tot_adic_w		bigint 	:= 0;
cd_tipo_agenda_w			agenda.cd_tipo_agenda%type;
nr_seq_agenda_w				agenda_consulta.nr_sequencia%type;

C01 CURSOR FOR 
		SELECT	nr_seq_proc_interno, 
				ie_lado 
		from	ageint_exame_adic_item 
		where	nr_seq_item	= nr_seq_item_p;	
 

BEGIN 
 
select 	max(cd_estabelecimento), 
		max(cd_tipo_agenda) 
into STRICT	cd_estabelecimento_w, 
		cd_tipo_agenda_w 
from 	agenda 
where	cd_agenda = cd_agenda_p;
 
if (cd_tipo_agenda_w = 3) then 
	--"Consistir duração dos exames adicionais com base nas regras 'Tempo proced', para atualização da duração do agendamento" 
	select	coalesce(max(obter_valor_param_usuario(869, 303, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento)), 'N') 
	into STRICT	ie_cons_dur_exames_adic_w 
	;
 
	select 	coalesce(max(ie_utiliza_dur_classif),'N') 
	into STRICT	ie_utiliza_dur_classif_w 
	from	parametro_agenda_integrada 
	where	cd_estabelecimento = cd_estabelecimento_p;
 
	select	max(ie_classif_agenda) 
	into STRICT	ie_classif_agenda_w 
	from	agenda_integrada_item 
	where	nr_sequencia = nr_seq_item_p;
 
	if (coalesce(ie_classif_agenda_w,'XPTO') <> 'XPTO') then	 
										 
		select 	coalesce(Ageint_Obter_Dur_Classif(ie_classif_agenda_w, coalesce(cd_estabelecimento_w,cd_estabelecimento_p), cd_medico_p, DT_MARCACAO_P),0) 
		into STRICT	qt_duracao_classif_w 
		;
 
	end if;
	 
	select max(cd_pessoa_fisica), 
			max(cd_convenio), 
			max(cd_categoria), 
			max(cd_plano) 
	into STRICT  cd_pessoa_fisica_w, 
			cd_convenio_w, 
			cd_categoria_w, 
			cd_plano_w 
	from  agenda_integrada 
	where  nr_sequencia  = nr_seq_ageint_p;
	 
	select coalesce(max(nr_sequencia),0) 
	into STRICT  nr_seq_agenda_w 
	from  agenda_consulta 
	where  cd_agenda    = cd_agenda_p 
	and   dt_agenda    = DT_MARCACAO_P;
 
	/*INICIO - Tratamento para atualização correta das durações dos exames, com base nas regras de "Tempo Proced", para os exames adicionais do item*/
 
	if (ie_cons_dur_exames_adic_w = 'S') then				 
		--Exame adicional 
		open C01;
		loop 
		fetch C01 into	 
			nr_seq_exame_adic_w, 
			ie_lado_adic_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			if (nr_seq_exame_adic_w IS NOT NULL AND nr_seq_exame_adic_w::text <> '')then 
				qt_minuto_aux_adic_w := Obter_Tempo_Padrao_Ageint(	nr_seq_exame_adic_w, null, null, cd_medico_p, cd_agenda_p, cd_pessoa_fisica_w, qt_minuto_aux_adic_w, ie_lado_adic_w, cd_convenio_w, cd_categoria_w, cd_plano_w, nr_seq_agenda_w, null);
											 
				if (qt_minuto_aux_adic_w IS NOT NULL AND qt_minuto_aux_adic_w::text <> '')then 
					qt_minuto_tot_adic_w := qt_minuto_aux_adic_w + qt_minuto_tot_adic_w;
				end if;
			end if;
			end;
		end loop;
		close C01;
	end if;
 
	if 	(qt_duracao_classif_w > 0 AND ie_utiliza_dur_classif_w = 'S') then 
		qt_duracao_classif_w := qt_minuto_tot_adic_w + qt_duracao_classif_w;
	end if;
end if;
 
return	qt_duracao_classif_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_duracao_classif_agecons ( CD_AGENDA_P bigint, DT_MARCACAO_P timestamp, NR_SEQ_AGEINT_P bigint, NR_SEQ_ITEM_P bigint, CD_MEDICO_P text, nm_usuario_p text, CD_ESTABELECIMENTO_P bigint) FROM PUBLIC;

