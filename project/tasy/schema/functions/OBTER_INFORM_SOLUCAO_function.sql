-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inform_solucao ( nr_prescricao_p bigint, nr_seq_material_p bigint, ie_horario_acm_p text, ie_horario_sn_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*Opção
Q - Quantidade de solução
H - Horários solução
EP - Etapa especial
*/
ds_retorno_w 		varchar(2000) := null;
ds_horarios_w		varchar(2000) := null;
ds_horarios_ww		varchar(2000);
hr_prim_horario_w 	varchar(10);
qt_dia_prim_hor_w 	bigint;
k					integer;
y					integer;


BEGIN

if (ie_opcao_p = 'Q') then
	select	count(*)
	into STRICT	ds_retorno_w
	from	prescr_solucao b,
			prescr_material a
	where	a.nr_sequencia_solucao	= b.nr_seq_solucao
	and		a.nr_prescricao		= b.nr_Prescricao
	and		a.nr_sequencia		= nr_seq_material_p
	and		a.ie_agrupador		in (4,13)
	and		a.nr_prescricao		= nr_prescricao_p
	and	((b.ie_acm			= 'S' and
		coalesce(ie_horario_acm_p,'S')	= 'N') or
		((b.ie_se_necessario		= 'S') and (coalesce(ie_horario_sn_p,'S')	= 'N')));

elsif (ie_opcao_p = 'EP') then
	select	coalesce(b.ie_etapa_especial,'N')
	into STRICT	ds_retorno_w
	from	prescr_solucao b,
			prescr_material a
	where	a.nr_sequencia_solucao	= b.nr_seq_solucao
	and		a.nr_prescricao		= b.nr_Prescricao
	and		a.nr_sequencia		= nr_seq_material_p
	and		a.ie_agrupador		in (4,13)
	and		a.nr_prescricao		= nr_prescricao_p;
else
	Select 	coalesce(elimina_acentuacao(c.ds_horarios),' '),
			c.hr_prim_horario,
			coalesce(b.qt_dia_prim_hor,0)
	into STRICT	ds_horarios_w,
			hr_prim_horario_w,
			qt_dia_prim_hor_w
	from    prescr_solucao c,
			prescr_material b
	where	c.nr_prescricao 		= b.nr_prescricao
	and		b.nr_sequencia_solucao	= c.nr_seq_solucao
	and		c.nr_Prescricao 		= nr_Prescricao_p
	and		b.nr_sequencia 			= nr_seq_material_p
	and		b.ie_agrupador			in (4,13);

	while	position(' as' in ds_horarios_w) > 0 loop
		k	:= position(' as' in ds_horarios_w);
		y	:= position(';' in ds_horarios_w);
		if (y > 0) then
			ds_horarios_w	:= substr(substr(ds_horarios_w,1,k-1) ||substr(ds_horarios_w,y+1,length(ds_horarios_w)),1,2000);
		else
			ds_horarios_w	:= substr(substr(ds_horarios_w,1,k-1),1,2000);
		end if;
	end loop;

	select	replace(padroniza_horario(ds_horarios_w),'A','')
	into STRICT	ds_horarios_w
	;

	if (ds_horarios_w <> ' ') then
		Select  padroniza_horario_prescr(ds_horarios_w, CASE WHEN coalesce(qt_dia_prim_hor_w,0)=0 THEN CASE WHEN substr(Obter_Se_horario_hoje(a.dt_prescricao,a.dt_primeiro_horario,hr_prim_horario_w),1,1)='N' THEN '01/01/2000 23:59:59'  ELSE to_char(coalesce(a.dt_primeiro_horario,a.dt_prescricao),'dd/mm/yyyy hh24:mi:ss') END   ELSE '01/01/2000 23:59:59' END )
		into STRICT	ds_horarios_ww
		from	prescr_medica a
		where 	a.nr_Prescricao = nr_Prescricao_p;
	else
		ds_horarios_ww := ' ';
	end if;

	ds_retorno_w := ds_horarios_ww;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inform_solucao ( nr_prescricao_p bigint, nr_seq_material_p bigint, ie_horario_acm_p text, ie_horario_sn_p text, ie_opcao_p text) FROM PUBLIC;

