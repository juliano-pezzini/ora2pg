-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_regra_med_repasse (nr_seq_material_p bigint, nr_seq_procedimento_p bigint, ie_regra_medico_p text) RETURNS varchar AS $body$
DECLARE


cd_medico_tratamento_w		varchar(15);
ds_retorno_w				varchar(15);
cd_medico_prescr_w			varchar(15);
cd_medico_resp_w			varchar(15);
cd_medico_clinico_w			varchar(15);
cd_medico_atendimento_w		varchar(15);
nr_prescricao_w				varchar(15);
nr_atendimento_w			varchar(15);
cd_medico_w					varchar(15);
ie_corpo_clinico_w		medico.ie_corpo_clinico%type;


BEGIN

ds_retorno_w			:= 'S';

if (ie_regra_medico_p IS NOT NULL AND ie_regra_medico_p::text <> '') then

	ds_retorno_w		:= 'N';

	if (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then
	
			select	coalesce(c.cd_medico,'-1'),
				b.cd_medico_resp,
				a.nr_prescricao,
				b.nr_atendimento
			into STRICT	cd_medico_tratamento_w,
				cd_medico_resp_w,
				nr_prescricao_w,
				nr_atendimento_w
			from	pessoa_fisica c,
				atendimento_paciente b,
				material_atend_paciente a
			where	c.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	b.nr_atendimento	= a.nr_atendimento
			and	a.nr_sequencia		= nr_seq_material_p;

		if (ie_regra_medico_p = 'PT') then		-- verificar se o medico da prescricao e tratamento sao iguais
			select	coalesce(max(b.cd_medico),'0')
			into STRICT	cd_medico_prescr_w
			from	prescr_medica b
			where	b.nr_prescricao	= nr_prescricao_w;

			if (cd_medico_prescr_w = cd_medico_tratamento_w) then
				ds_retorno_w		:= 'S';
			end if;

		elsif (ie_regra_medico_p = 'AT') then		-- verificar se o medico do atendimento e tratamento sao iguais
			if (cd_medico_resp_w = cd_medico_tratamento_w) then
				ds_retorno_w		:= 'S';
			end if;
		
		elsif (ie_regra_medico_p = 'MP' OR ie_regra_medico_p = 'MN') then	--Medico prescricao pertencer ao corpo clinico/Medico da prescricao nao for do corpo clinico
			
			select	coalesce(max(b.cd_medico),'0')
			into STRICT	cd_medico_prescr_w
			from	prescr_medica b
			where	b.nr_prescricao	= nr_prescricao_w;
			
			select	max(ie_corpo_clinico)
			into STRICT	ie_corpo_clinico_w
			from	medico
			where	cd_pessoa_fisica = cd_medico_prescr_w;
			
			if	((ie_corpo_clinico_w = 'S' and ie_regra_medico_p = 'MP')
				OR (ie_corpo_clinico_w = 'N' and ie_regra_medico_p = 'MN')) then
				ds_retorno_w		:= 'S';
			end if;

			
		elsif (ie_regra_medico_p = 'PA' or ie_regra_medico_p = 'PN') then	--Medico da prescricao for o medico do atendimento/Medico da prescricao nao for o medico do atendimento
			select	coalesce(max(b.cd_medico),'0')
			into STRICT	cd_medico_prescr_w
			from	prescr_medica b
			where	b.nr_prescricao	= nr_prescricao_w;
			
			if ((cd_medico_prescr_w = cd_medico_resp_w and ie_regra_medico_p = 'PA')
			or (cd_medico_prescr_w <> cd_medico_resp_w and ie_regra_medico_p = 'PN')) then
				ds_retorno_w		:= 'S';
			end if;

		end if;

	elsif (nr_seq_procedimento_p IS NOT NULL AND nr_seq_procedimento_p::text <> '') then
		null;
	end if;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_regra_med_repasse (nr_seq_material_p bigint, nr_seq_procedimento_p bigint, ie_regra_medico_p text) FROM PUBLIC;

