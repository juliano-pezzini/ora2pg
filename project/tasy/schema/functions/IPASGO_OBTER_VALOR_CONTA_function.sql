-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ipasgo_obter_valor_conta ( nr_interno_conta_p bigint, ie_valor_p integer) RETURNS bigint AS $body$
DECLARE



ie_proc_mat_w		bigint;
vl_item_w			double precision;
nr_seq_proc_pacote_w	bigint;
ie_tipo_convenio_w		smallint;
ie_tipo_atendimento_w	smallint;
cd_estabelecimento_w	smallint;
cd_cgc_prestador_w	varchar(14);
cd_convenio_w		integer;
vl_resultado_w		double precision := 0;
nr_seq_tipo_fatura_w	bigint;
cd_tipo_fatura_w		integer;
qt_pacote_w		bigint;
ie_somente_anest_w	varchar(15) := 'S';

C01 CURSOR FOR
SELECT	1 ie_proc_mat,
	coalesce(a.nr_seq_proc_pacote,0) nr_seq_proc_pacote,
	coalesce(sum(a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE', a.nr_sequencia)),0) vl_item
from	procedimento c,
	procedimento_paciente a
where	a.cd_procedimento	= c.cd_procedimento
and	a.ie_origem_proced	= c.ie_origem_proced
and	a.nr_interno_conta	= nr_interno_conta_p
and (a.cd_cgc_prestador = cd_cgc_prestador_w or coalesce(a.cd_cgc_prestador::text, '') = '')
and	coalesce(ipasgo_obter_se_respcred_soma(coalesce(a.ie_responsavel_credito,'0')),'N') = 'N'
--and	nvl(a.ie_responsavel_credito,'0') not in ('M','IPH') OS 664785
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	coalesce(a.nr_seq_proc_pacote,0) <> a.nr_sequencia
and (obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced) <> 2)	/*no reg. 10 nao pode ter taxas*/
and	((cd_cgc_prestador_w not in ('02780488000142','02780488000223','02780488000304','26878439000105') and c.cd_tipo_procedimento in (1,2,3,4,5,10,12,13,14,15,16,20,25,26,30,31,33,34,39,73,74,75,80,85,91,92,94,95,96,97,103,116)) or (cd_cgc_prestador_w in ('02780488000142','02780488000223','02780488000304','26878439000105') and c.nr_seq_grupo_rec = 5))
group by	coalesce(a.nr_seq_proc_pacote,0)
having	coalesce(sum(a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE', a.nr_sequencia)),0) > 0	

union all

SELECT	1 ie_proc_mat,
	coalesce(a.nr_seq_proc_pacote,0) nr_seq_proc_pacote,
	coalesce(sum(CASE WHEN(a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE', a.nr_sequencia))=0 THEN			coalesce(a.vl_procedimento,0)  ELSE (a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE', a.nr_sequencia)) END ),0) vl_item
from	procedimento c,
	procedimento_paciente a
where	a.cd_procedimento	= c.cd_procedimento
and	a.ie_origem_proced	= c.ie_origem_proced
and	a.nr_interno_conta	= nr_interno_conta_p
and (a.cd_cgc_prestador 	= cd_cgc_prestador_w or coalesce(a.cd_cgc_prestador::text, '') = '')
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	cd_tipo_fatura_w 	not in (8,3)
and	coalesce(a.nr_seq_proc_pacote,0) <> a.nr_sequencia
and (obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced) in (2,3))	/*Somar os procedimentos do tipo 08 geral*/
group by coalesce(a.nr_seq_proc_pacote,0)
having	coalesce(sum(CASE WHEN(a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE', a.nr_sequencia))=0 THEN 			coalesce(a.vl_procedimento,0)  ELSE (a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE', a.nr_sequencia)) END ),0) > 0

union all

select	1 ie_proc_mat,
	coalesce(a.nr_seq_proc_pacote,0) nr_seq_proc_pacote,
	coalesce(sum(CASE WHEN(a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE', a.nr_sequencia))=0 THEN 			coalesce(a.vl_procedimento,0)  ELSE (a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE', a.nr_sequencia)) END ),0) vl_item
from	procedimento c,
	procedimento_paciente a
where	a.cd_procedimento	= c.cd_procedimento
and	a.ie_origem_proced	= c.ie_origem_proced
and	a.nr_interno_conta	= nr_interno_conta_p
and (a.cd_cgc_prestador = cd_cgc_prestador_w or coalesce(a.cd_cgc_prestador::text, '') = '')
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	coalesce(a.nr_seq_proc_pacote,0) <> a.nr_sequencia
and	cd_tipo_fatura_w 	= 8
and	coalesce(a.ie_proc_princ_atend,'S') <> 'S'
and (obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced) in (2,3))	/*Quando for Box Hora, somar todos menos a taxa principal 08*/
group by coalesce(a.nr_seq_proc_pacote,0)

union all

select	1 ie_proc_mat,
	coalesce(a.nr_seq_proc_pacote,0) nr_seq_proc_pacote,
	coalesce(sum(a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPAC', a.nr_sequencia)),0) vl_item
from	procedimento c,
	procedimento_paciente a
where	a.cd_procedimento	= c.cd_procedimento
and	a.ie_origem_proced	= c.ie_origem_proced
and	a.nr_interno_conta	= nr_interno_conta_p
and (a.cd_cgc_prestador 	= cd_cgc_prestador_w or coalesce(a.cd_cgc_prestador::text, '') = '')
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	coalesce(a.nr_seq_proc_pacote,0) <> a.nr_sequencia
and	cd_tipo_fatura_w 	= 3
and	coalesce(a.ie_proc_princ_atend,'S') = 'S'
and	coalesce(a.ie_valor_informado,'N') = 'N'
and	a.cd_procedimento_convenio in (70025,70033) /*Quando for Alto Custo soma junto no tipo 8*/
group by coalesce(a.nr_seq_proc_pacote,0)

union all

select	1 ie_proc_mat,
	coalesce(a.nr_seq_proc_pacote,0) nr_seq_proc_pacote,
	coalesce(sum(CASE WHEN(a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE', a.nr_sequencia))=0 THEN 			coalesce(a.vl_procedimento,0)  ELSE (a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE', a.nr_sequencia)) END ),0) vl_item
from	procedimento c,
	procedimento_paciente a
where	a.cd_procedimento	= c.cd_procedimento
and	a.ie_origem_proced	= c.ie_origem_proced
and	a.nr_interno_conta	= nr_interno_conta_p
and (a.cd_cgc_prestador = cd_cgc_prestador_w or coalesce(a.cd_cgc_prestador::text, '') = '')
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	coalesce(a.nr_seq_proc_pacote,0) <> a.nr_sequencia
and	cd_tipo_fatura_w 	= 3
and	coalesce(a.ie_proc_princ_atend,'S') <> 'S'
and	a.cd_procedimento_convenio not in (70025,70033)
and (obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced) in (2,3))	/*Quando for tipo 3 (ex>: quimio) e nao for alto custo somar no 08*/
group by coalesce(a.nr_seq_proc_pacote,0)

union all

select	1 ie_proc_mat,
	coalesce(a.nr_seq_proc_pacote,0) nr_seq_proc_pacote,
	coalesce(sum(a.qt_procedimento * Obter_preco_proc_ipasgo_atend(a.nr_atendimento,a.dt_conta,a.cd_procedimento,a.ie_origem_proced,a.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE', a.nr_sequencia)),0) vl_item
from	procedimento c,
	procedimento_paciente a
where	a.cd_procedimento	= c.cd_procedimento
and	a.ie_origem_proced	= c.ie_origem_proced
and	a.nr_interno_conta	= nr_interno_conta_p
and (a.cd_cgc_prestador = cd_cgc_prestador_w or coalesce(a.cd_cgc_prestador::text, '') = '')
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	cd_tipo_fatura_w 	= 1
and	coalesce(a.nr_seq_proc_pacote,0) <> a.nr_sequencia
and (obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced) <> 2)	/*no reg. 10 nao pode ter taxas*/
and (c.cd_tipo_procedimento in (71))/*Somar os procedimentos do tipo 10*/
group by	coalesce(a.nr_seq_proc_pacote,0)

union all

select	2 ie_proc_mat,
	x.nr_seq_proc_pacote,
	coalesce(sum(x.vl_unitario * x.qt_material),0) vl_item
from	material w,
	material_atend_paciente x
where	x.cd_material           = w.cd_material
and	x.nr_interno_conta	= nr_interno_conta_p
and	coalesce(x.nr_seq_proc_pacote,0) <> x.nr_sequencia
and	coalesce(x.cd_motivo_exc_conta::text, '') = ''
and (x.cd_cgc_prestador = cd_cgc_prestador_w or coalesce(x.cd_cgc_prestador::text, '') = '')
group by x.nr_seq_proc_pacote

union all

select	1 ie_proc_mat,
	coalesce(a.nr_seq_proc_pacote,0) nr_seq_proc_pacote,
	coalesce(sum(a.qt_procedimento * a.vl_materiais),0) vl_item
from	procedimento c,
	procedimento_paciente a
where	a.cd_procedimento	= c.cd_procedimento
and	a.ie_origem_proced	= c.ie_origem_proced
and	a.nr_interno_conta	= nr_interno_conta_p
and (a.cd_cgc_prestador 	= cd_cgc_prestador_w or coalesce(a.cd_cgc_prestador::text, '') = '')
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	coalesce(a.nr_seq_proc_pacote,0) <> a.nr_sequencia
and	cd_tipo_fatura_w 	= 3
and	coalesce(a.ie_proc_princ_atend,'S') = 'S'
and	coalesce(a.ie_valor_informado,'N') = 'S'
and	a.cd_procedimento_convenio in (70025,70033) /*Quando for Alto Custo soma junto no tipo 8*/
group by coalesce(a.nr_seq_proc_pacote,0)

union all

select    1 ie_proc_mat,
    coalesce(a.nr_seq_proc_pacote,0) nr_seq_proc_pacote,
    coalesce(sum(a.vl_procedimento),0) vl_item
from    procedimento c,
    procedimento_paciente a
where    a.cd_procedimento    = c.cd_procedimento
and    a.ie_origem_proced    = c.ie_origem_proced
and    a.nr_interno_conta    = nr_interno_conta_p
and (a.cd_cgc_prestador     = cd_cgc_prestador_w or coalesce(a.cd_cgc_prestador::text, '') = '')
and    coalesce(a.cd_motivo_exc_conta::text, '') = ''
and    (a.cd_medico_executor IS NOT NULL AND a.cd_medico_executor::text <> '')
and    c.cd_tipo_procedimento not in (1,2,3,4,5,12,13,14,15,16,20,25,26,30,31,33,34,39,74,75,80,85,91,92,94,95,96,97,103,116)
and    coalesce(ipasgo_obter_se_respcred_soma(coalesce(a.ie_responsavel_credito,'0')),'N') = 'S'
and    coalesce(a.nr_seq_proc_pacote,0) <> a.nr_sequencia
and    obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced) = 1
and    cd_tipo_fatura_w = 4
group by coalesce(a.nr_seq_proc_pacote,0)
having    coalesce(sum(a.vl_procedimento),0) > 0

union all

select	1 ie_proc_mat,
	coalesce(b.nr_seq_proc_pacote,0) nr_seq_proc_pacote,
	sum(CASE WHEN ie_somente_anest_w='S' THEN 		CASE WHEN obter_se_proc_anestesista(b.nr_sequencia)='S' THEN 		coalesce((b.qt_procedimento * Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE', b.nr_sequencia)),0)  ELSE (coalesce((b.qt_procedimento * Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M', b.nr_sequencia)),0) + 		coalesce((b.qt_procedimento * Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'F', b.nr_sequencia)),0)) END   ELSE coalesce((b.qt_procedimento * Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE', b.nr_sequencia)),0) END ) vl_item
from	procedimento a,
	procedimento_paciente b
where	b.nr_interno_conta	= nr_interno_conta_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
and	a.cd_procedimento	= b.cd_procedimento
and	b.cd_cgc_prestador <> cd_cgc_prestador_w
and	a.ie_origem_proced	= b.ie_origem_proced
and (obter_classif_material_proced(null, b.cd_procedimento, b.ie_origem_proced) <> 2)	/*no reg. 10 nao pode ter taxas*/
and	((cd_cgc_prestador_w not in ('02780488000142','02780488000223','02780488000304','26878439000105') and a.cd_tipo_procedimento in (1,2,3,4,5,12,13,14,15,16,20,25,26,30,31,33,34,39,74,75,85,87,91,92,94,96,97,103,116)) or (cd_cgc_prestador_w in ('02780488000142','02780488000223','02780488000304','26878439000105') and a.nr_seq_grupo_rec = 5))
and	coalesce(b.nr_seq_proc_pacote::text, '') = ''
and	coalesce(b.nr_ato_ipasgo,0) = 0
and	(CASE WHEN ie_somente_anest_w='S' THEN 		CASE WHEN obter_se_proc_anestesista(b.nr_sequencia)='S' THEN 		coalesce((b.qt_procedimento * Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE', b.nr_sequencia)),0)  ELSE (coalesce((b.qt_procedimento * Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M', b.nr_sequencia)),0) + 		coalesce((b.qt_procedimento * Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'F', b.nr_sequencia)),0)) END   ELSE coalesce((b.qt_procedimento * Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE', b.nr_sequencia)),0) END ) > 0
group by coalesce(b.nr_seq_proc_pacote,0)

union all

select	1 ie_proc_mat,	
	coalesce(b.nr_seq_proc_pacote,0) nr_seq_proc_pacote,
	sum(coalesce((b.qt_procedimento * Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE', b.nr_sequencia)),0)) vl_item
from	procedimento a,
	procedimento_paciente b
where	b.nr_interno_conta	= nr_interno_conta_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
and	a.cd_procedimento	= b.cd_procedimento
and	a.ie_origem_proced	= b.ie_origem_proced
and	b.cd_cgc_prestador <> cd_cgc_prestador_w
and (obter_classif_material_proced(null, b.cd_procedimento, b.ie_origem_proced) <> 2)	/*no reg. 10 nao pode ter taxas*/
and (cd_cgc_prestador_w not in ('02780488000142','02780488000223','02780488000304','26878439000105') and a.cd_tipo_procedimento in (80))
and	somente_numero(coalesce(b.cd_procedimento_convenio,b.cd_procedimento)) <> 20010	/*Gerar todas as hemoterapias menos 20010 */
and	coalesce(b.nr_seq_proc_pacote::text, '') = ''
and	coalesce(b.nr_ato_ipasgo,0) = 0
and	coalesce((b.qt_procedimento * Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE', b.nr_sequencia)),0) > 0
group by coalesce(b.nr_seq_proc_pacote,0)
order by 1;


BEGIN



begin
select	a.ie_tipo_convenio,
	c.ie_tipo_atendimento,
	a.cd_convenio,
	b.nr_seq_tipo_fatura
into STRICT	ie_tipo_convenio_w,
	ie_tipo_atendimento_w,
	cd_convenio_w,
	nr_seq_tipo_fatura_w
from	atendimento_paciente c,
	conta_paciente b,
	convenio	a
where	a.cd_convenio	= b.cd_convenio_parametro
and	b.nr_atendimento	= c.nr_atendimento
and	b.nr_interno_conta	= nr_interno_conta_p;
exception
	when others then
	ie_tipo_convenio_w	:= 0;
	ie_tipo_atendimento_w	:= 0;
end;

select	cd_tipo_fatura
into STRICT	cd_tipo_fatura_w
from	fatur_tipo_fatura
where	nr_sequencia = nr_seq_tipo_fatura_w;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_p;

select	cd_cgc
into STRICT	cd_cgc_prestador_w
from	estabelecimento
where	cd_estabelecimento 	= cd_estabelecimento_w;

ie_somente_anest_w	:= coalesce(obter_valor_param_usuario(999,89,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario,cd_estabelecimento_w),'S');

select	count(*)
into STRICT	qt_pacote_w
from	procedimento_paciente
where	nr_interno_conta 		= nr_interno_conta_p
and	nr_sequencia		= nr_seq_proc_pacote;


if (qt_pacote_w = 0) then
	begin
	open C01;
	loop
	fetch C01 into
		ie_proc_mat_w,
		nr_seq_proc_pacote_w,
		vl_item_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		RAISE NOTICE '%', vl_item_w;
		if (ie_valor_p = 0) then
			vl_resultado_w := coalesce(vl_resultado_w,0) + coalesce(vl_item_w,0);
		end if;
	end loop;
	close C01;
	end;
else
	select	sum(vl_item)
	into STRICT	vl_resultado_w
	from (	SELECT	coalesce(sum(vl_procedimento),0) vl_item
		from	procedimento_paciente
		where	nr_interno_conta 	= nr_interno_conta_p
		and	nr_sequencia	= nr_seq_proc_pacote
		
union

		SELECT	coalesce(sum(x.vl_unitario * x.qt_material),0) vl_item
		from	material w,
			material_atend_paciente x
		where	x.cd_material           = w.cd_material
		and	x.nr_interno_conta	= nr_interno_conta_p
		and	coalesce(x.nr_seq_proc_pacote::text, '') = ''
		and	coalesce(x.cd_motivo_exc_conta::text, '') = ''
		and (x.cd_cgc_prestador = cd_cgc_prestador_w or coalesce(x.cd_cgc_prestador::text, '') = '')
		
union

		select	sum(x.qt_procedimento * Obter_preco_proc_ipasgo_atend(x.nr_atendimento,x.dt_conta,x.cd_procedimento,x.ie_origem_proced,x.nr_seq_proc_interno,x.ie_responsavel_credito,'IPDE', x.nr_sequencia)) vl_item
		from	procedimento_paciente x
		where	x.nr_interno_conta	= nr_interno_conta_p
		and	coalesce(x.nr_seq_proc_pacote::text, '') = ''
		and	coalesce(x.cd_motivo_exc_conta::text, '') = ''
		and (x.cd_cgc_prestador = cd_cgc_prestador_w or coalesce(x.cd_cgc_prestador::text, '') = '')
		and (coalesce(vl_procedimento,0) > 0)) alias17;
end if;

return coalesce(vl_resultado_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ipasgo_obter_valor_conta ( nr_interno_conta_p bigint, ie_valor_p integer) FROM PUBLIC;

