-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_presc_ultimo_sae ( nr_atendimento_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*  opção				                */


/* 	S = numero  prescrição ultimo sae	*/


/* 	DI = data inicio sae 		            	*/


/*	DF = data fim sae 		              	*/


/*	DP = data prescrição                	*/


/*	PR = nome profissional              	*/


/*	DT = Data Liberação                 	*/


/*	O  = Sae origem                     		*/


/*  	NC = Nivel de complexidade   		*/

nr_prescricao_var_w	bigint;
dt_inicio_w		timestamp;
dt_fim_w		            	timestamp;
nm_profissional_w	      	varchar(60);
dt_prescricao_w		timestamp;

ds_retorno_w		varchar(60);
nr_sequencia_w		bigint;
nr_sae_origem_w         	varchar(255);
dt_liberacao_w          	timestamp;
ds_nivel_complexidade_w 	pe_prescricao.ds_nivel_complexidade%type;


BEGIN

SELECT MAX(b.nr_sequencia)
into STRICT	nr_sequencia_w
FROM 	pe_prescricao b
where	b.nr_atendimento = nr_atendimento_p
and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
and	coalesce(b.dt_inativacao::text, '') = '';

if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
	SELECT	nr_sequencia,
		DT_INICIO_PRESCR,
		DT_VALIDADE_PRESCR,
		dt_prescricao,
		substr(obter_nome_pf(CD_PRESCRITOR),1,60),
		dt_liberacao,
		nr_sae_origem,
    		obter_paciente_compl_assist(nr_atendimento, cd_pessoa_fisica)
	into STRICT	nr_prescricao_var_w,
		dt_inicio_w,
		dt_fim_w,
		dt_prescricao_w,
		nm_profissional_w,
		dt_liberacao_w,
		nr_sae_origem_w,
    		ds_nivel_complexidade_w
	FROM	pe_prescricao
	WHERE	nr_sequencia = nr_sequencia_w;

	if (ie_opcao_p = 'S') then
		ds_retorno_w := nr_prescricao_var_w;
	elsif (ie_opcao_p = 'DI') then
		ds_retorno_w := to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss');
	elsif (ie_opcao_p = 'DF') then
		ds_retorno_w := to_char(dt_fim_W,'dd/mm/yyyy hh24:mi:ss');
	elsif (ie_opcao_p = 'DP') then
		ds_retorno_w := to_char(dt_prescricao_w,'dd/mm/yyyy hh24:mi:ss');
	elsif (ie_opcao_p = 'DT') then
		ds_retorno_w := to_char(dt_liberacao_w,'dd/mm/yyyy hh24:mi:ss');
	elsif (ie_opcao_p = 'PR') then
		ds_retorno_w := nm_profissional_w;
	elsif (ie_opcao_p = 'O') then
		ds_retorno_w := nr_sae_origem_w;
  	elsif (ie_opcao_p = 'NC') then
    		ds_retorno_w := ds_nivel_complexidade_w;
	end if;
end if;
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_presc_ultimo_sae ( nr_atendimento_p text, ie_opcao_p text) FROM PUBLIC;

