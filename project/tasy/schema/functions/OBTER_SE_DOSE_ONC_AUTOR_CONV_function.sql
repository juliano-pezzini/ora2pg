-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_dose_onc_autor_conv ( nr_seq_atendimento_p bigint, cd_material_p bigint, qt_dose_prescr_p bigint, nr_seq_interno_p bigint default null, cd_convenio_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	  		varchar(1):= 'S';
ie_autorizado_w			varchar(1);
nr_ciclo_w				bigint;			
cd_convenio_w			bigint;
qt_dose_autorizado_w	double precision := 0;
nr_seq_paciente_w		bigint;
qt_dose_utilizada_w	double precision := 0;
ie_regra_apres_autor_quimio_w	varchar(1) := 'N';



BEGIN

If (nr_seq_atendimento_p IS NOT NULL AND nr_seq_atendimento_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (qt_dose_prescr_p IS NOT NULL AND qt_dose_prescr_p::text <> '') then
	
	Select  max(nr_ciclo),
		max(nr_seq_paciente)
	into STRICT	nr_ciclo_w,
		nr_seq_paciente_w
	from	paciente_atendimento
	where	nr_seq_atendimento = nr_seq_atendimento_p;
	
	select 	Obter_Se_Dia_Ciclo_Autorizado(nr_seq_atendimento_p,nr_ciclo_w)
	into STRICT   	ie_autorizado_w
	;
	
	If (ie_autorizado_w = 'S') then		
	
	
		if (nr_seq_interno_p IS NOT NULL AND nr_seq_interno_p::text <> '') then
		
			select	coalesce(sum(x.qt_dose_prescricao),0)
			into STRICT	qt_dose_utilizada_w
			from	PACIENTE_ATEND_MEDIC x
			where	nr_seq_atendimento = nr_seq_atendimento_p
			and	x.nr_seq_interno  <> nr_seq_interno_p
			and	x.cd_material	  = cd_material_p;
		
		end if;
		
		if (coalesce(cd_convenio_p,0) > 0) then
		
			cd_convenio_w := cd_convenio_p;
		
		else
		
			Select  max(cd_convenio)
			into STRICT	cd_convenio_w
			from	autorizacao_convenio a
			where	a.nr_seq_paciente = nr_seq_atendimento_p;
			
		
		end if;
		
		
		if (coalesce(cd_convenio_w,0) > 0) then
		
			select	coalesce(max(ie_regra_apres_autor_quimio),'N')
			into STRICT	ie_regra_apres_autor_quimio_w
			from	convenio_estabelecimento
			where	cd_convenio		= cd_convenio_w
			and	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento;		
			
		end if;
		
		if (ie_regra_apres_autor_quimio_w = 'S') then
		
			Select	coalesce(sum(Obter_conversao_mat_onco(cd_material_p,b.cd_material,nr_seq_atendimento_p,nr_seq_interno_p,b.qt_autorizada)),0)
			into STRICT	qt_dose_autorizado_w
			from	autorizacao_convenio a,
				material_autorizado b
			where (a.nr_seq_paciente = nr_seq_atendimento_p or a.nr_seq_paciente_setor = nr_seq_paciente_w)
			and	b.nr_sequencia_autor = a.nr_sequencia
			and	((b.cd_material = cd_material_p) or (obter_se_mat_conv_autorizado(b.cd_material, cd_material_p, b.nr_seq_regra_quimio) = 'S'));		
	
		else
		
	
			Select	coalesce(max(b.qt_autorizada),0)
			into STRICT	qt_dose_autorizado_w
			from	autorizacao_convenio a,
					material_autorizado b
			where (a.nr_seq_paciente = nr_seq_atendimento_p or a.nr_seq_paciente_setor = nr_seq_paciente_w)
			and		b.nr_sequencia_autor = a.nr_sequencia
			and		b.cd_material = cd_material_p;
	
	
			
		end if;
			
		if (qt_dose_autorizado_w > 0) then
		
				If	( (qt_dose_utilizada_w + qt_dose_prescr_p) > qt_dose_autorizado_w ) then
				
					ds_retorno_w := 'N';
				
				end if;
		
		end if;	
		
	
	end if;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_dose_onc_autor_conv ( nr_seq_atendimento_p bigint, cd_material_p bigint, qt_dose_prescr_p bigint, nr_seq_interno_p bigint default null, cd_convenio_p bigint default null) FROM PUBLIC;

