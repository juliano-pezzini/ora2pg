-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_visita_excedeu_tempo ( nr_seq_visitante_p bigint) RETURNS varchar AS $body$
DECLARE

 
dt_inicio_visita_w	  	timestamp;
dt_fim_visita_w	        timestamp;
dt_entrada_w			timestamp;
qt_horario_visita_w		bigint;
cd_tipo_acomod_w		integer;
cd_setor_atendimento_w		bigint;
cd_unidade_basica_w		varchar(10);
cd_unidade_compl_w		varchar(10);
ie_visita_excede_horario_w 	varchar(5);
nr_seq_tipo_visitante_w		bigint;
nr_atendimento_w		bigint;
qt_minutos_permanencia_w	bigint;
qt_permanencia_w		bigint;

C01 CURSOR FOR 
	SELECT	dt_inicio_visita, 
		dt_fim_visita, 
		qt_minutos_permanencia 
	from	setor_atend_hor_visita 
	where	cd_setor_atendimento = cd_setor_atendimento_w 
	and	((coalesce(cd_tipo_acomodacao::text, '') = '') or (cd_tipo_acomodacao = cd_tipo_acomod_w)) 
	and	( ((ie_dia_semana = pkg_date_utils.get_WeekDay(dt_entrada_w)) OR  
		 ((ie_dia_semana = 9) and (pkg_date_utils.is_business_day(dt_entrada_w) = 1))) or coalesce(ie_dia_semana::text, '') = '')	 
	and	((nr_seq_tipo_visitante_w = nr_seq_tipo) or (coalesce(nr_seq_tipo::text, '') = '')) 
	and	((coalesce(ie_isolamento,'N') = 'N') or (obter_se_pac_isolamento(nr_atendimento_w) = 'S')) 
	and	((coalesce(cd_convenio::text, '') = '') or (obter_convenio_atendimento(nr_atendimento_w) = cd_convenio)) 
	order by CASE WHEN coalesce(ie_isolamento,'N')='S' THEN 0  ELSE 1 END , CASE WHEN coalesce(cd_convenio::text, '') = '' THEN 1  ELSE 0 END , nr_sequencia;


BEGIN 
 
select	max(nr_seq_tipo), 
	max(nr_atendimento), 
	max(dt_entrada) 
into STRICT	nr_seq_tipo_visitante_w, 
	nr_atendimento_w, 
	dt_entrada_w 
from	atendimento_visita 
where	nr_sequencia = nr_seq_visitante_p;
 
select	coalesce(max(cd_tipo_acomodacao),0), 
	coalesce(max(cd_setor_atendimento),0) 
into STRICT	cd_tipo_acomod_w, 
	cd_setor_atendimento_w 
from	atend_paciente_unidade 
where	nr_seq_interno = obter_atepacu_paciente(nr_atendimento_w,'A');
 
ie_visita_excede_horario_w := 'N';
 
open C01;
loop 
fetch C01 into 
	dt_inicio_visita_w, 
	dt_fim_visita_w, 
	qt_minutos_permanencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	if (ie_visita_excede_horario_w = 'N') then 
		if (to_char(dt_entrada_w,'hh24:mi') > to_char(dt_inicio_visita_w,'hh24:mi')) 
		and (to_char(dt_entrada_w,'hh24:mi') < to_char(dt_fim_visita_w,'hh24:mi')) 
		and (qt_minutos_permanencia_w > 0) then 
			 
			select	coalesce(obter_min_entre_datas(dt_entrada_w, clock_timestamp(), 1),0) 
			into STRICT	qt_permanencia_w 
			;
			 
			If (qt_permanencia_w > qt_minutos_permanencia_w) then 
				ie_visita_excede_horario_w := 'S';
			End if;			
		end if;
	end if;
	end;
end loop;
close C01;
 
return ie_visita_excede_horario_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_visita_excedeu_tempo ( nr_seq_visitante_p bigint) FROM PUBLIC;

