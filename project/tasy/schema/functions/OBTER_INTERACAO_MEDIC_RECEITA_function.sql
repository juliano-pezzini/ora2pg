-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_interacao_medic_receita ( nr_receita_p bigint) RETURNS varchar AS $body$
DECLARE

				
cd_material_w				integer;
ds_retorno_w				varchar(8000) := '';
ds_material_w				varchar(300);
ds_material_ww				varchar(300);
ds_interacao_w				varchar(4000) := '';
ds_principio_ativo_w		varchar(300);
ds_tipo_w					varchar(300);
ds_severidade_w				varchar(300);
ds_reacao_w					varchar(300);
ds_orientacao_w				varchar(2000);
ds_interacao_alimento_w		varchar(2000);
ds_ref_bibliografica_w		varchar(4000) := '';
ie_mensagem_cadastrada_w	varchar(1);
varMostraReacoes_w			varchar(10);
nr_seq_ficha_tecnica_w		bigint;
varcosiderafichatecnica_w	varchar(1);
cd_estabelecimento_w		bigint;
nr_dias_interacao_w			bigint;
nr_atendimento_w			bigint;

C01 CURSOR FOR
SELECT	distinct
	a.cd_material,
	substr(b.ds_material,1,100)
from	material b,
	fa_receita_farmacia_item a
where	a.nr_seq_receita	= nr_receita_p
and	a.cd_material		= b.cd_material;

C02 CURSOR FOR
SELECT	distinct substr(obter_desc_material(a.cd_material_interacao),1,100),
	CASE WHEN coalesce(a.ie_mensagem_cadastrada,'S')='N' THEN  CASE WHEN coalesce(ds_tipo::text, '') = '' THEN  ''  ELSE ' '||wheb_mensagem_pck.get_texto(351081,'DS_TIPO='|| ds_tipo) END   ELSE ' ' || ds_tipo END ,
	CASE WHEN coalesce(a.ie_exibir_gravidade,'S')='S' THEN  CASE WHEN substr(obter_valor_dominio(1325, ie_severidade),1,254) IS NULL THEN  ''  ELSE '. '|| obter_desc_expressao(291030) ||': ' || substr(obter_valor_dominio(1325, ie_severidade),1,254) END   ELSE '' END ,
	coalesce(a.ie_mensagem_cadastrada,'S'),
	a.ds_orientacao,
	substr(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo,
	a.ds_ref_bibliografica
from	material_interacao_medic a,
	fa_receita_farmacia_item b
where	a.cd_material		= cd_material_w
and	b.nr_seq_receita	= nr_receita_p
and	a.cd_material_interacao	= b.cd_material;

c03 CURSOR FOR
SELECT	a.cd_material,
		a.ds_material
from	material a,
	fa_receita_farmacia_item b
where	a.cd_material = b.cd_material
and	b.nr_seq_receita = nr_receita_p;


BEGIN
varMostraReacoes_w := obter_param_usuario(924, 48, obter_perfil_Ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, varMostraReacoes_w);
varCosideraFichaTecnica_w := obter_param_usuario(924, 617, obter_perfil_Ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, varCosideraFichaTecnica_w);

select	max(nr_atendimento),
	max(cd_estabelecimento)
into STRICT	nr_atendimento_w,
	cd_estabelecimento_w
from	fa_receita_farmacia
where	nr_sequencia = nr_receita_p;

select	max(nr_dias_interacao)
into STRICT	nr_dias_interacao_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_w;

open C01;
loop
fetch C01 into
	cd_material_w,
	ds_material_ww;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_interacao_w := '';
	
	open C02;
	loop
	fetch C02 into
		ds_material_w,
		ds_tipo_w,
		ds_severidade_w,
		ie_mensagem_cadastrada_w,
		ds_orientacao_w,
		ds_principio_ativo_w,
		ds_ref_bibliografica_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */	
		begin
		if (coalesce(length(ds_interacao_w),0) < 3000) then
			begin
			if (coalesce(ds_interacao_w::text, '') = '') then
				ds_interacao_w := substr(Wheb_mensagem_pck.get_texto(305981, 'DS_MATERIAL_A='||ds_material_ww||';DS_MATERIAL_B='||ds_material_w),1,4000);
			else
				ds_interacao_w := substr(ds_interacao_w  || chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(305981, 'DS_MATERIAL_A='||ds_material_ww||';DS_MATERIAL_B='||ds_material_w),1,4000);
			end if;
			
			--OS 150881
			if (ie_mensagem_cadastrada_w = 'S') and (ds_tipo_w IS NOT NULL AND ds_tipo_w::text <> '') then
				ds_interacao_w	:= '';
			end if;
			
			if (ds_tipo_w IS NOT NULL AND ds_tipo_w::text <> '') and (ie_mensagem_cadastrada_w	<> 'N') then
				ds_interacao_w := substr(ds_interacao_w  || ds_tipo_w,1,4000);
			end if;
			
			if (ds_severidade_w IS NOT NULL AND ds_severidade_w::text <> '') then
				--ds_interacao_w := ds_interacao_w  || ds_severidade_w;
				ds_severidade_w := ds_severidade_w;
			end if;
			
			if (ds_principio_ativo_w IS NOT NULL AND ds_principio_ativo_w::text <> '') then
				ds_interacao_w	:= substr(ds_interacao_w || '. ' || Wheb_mensagem_pck.get_texto(306016) || ' ' || ds_principio_ativo_w,1,4000);
			end if;
			
			ds_interacao_w := substr(ds_interacao_w || chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(351085) || ': ' || ds_orientacao_w,1,4000);
			
			if (ie_mensagem_cadastrada_w = 'B') and (ds_ref_bibliografica_w IS NOT NULL AND ds_ref_bibliografica_w::text <> '') then
				ds_interacao_w	:= substr(ds_interacao_w || chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(351086) || ': ' || ds_ref_bibliografica_w,1,4000);
			end if;
			
			ds_interacao_w := substr(ds_interacao_w,1,3995) || chr(13) || chr(10);
			end;
		end if;
	
		end;
	end loop;
	close C02;
		
	if (ds_interacao_w IS NOT NULL AND ds_interacao_w::text <> '') and (coalesce(length(ds_retorno_w),0) < 8000) then
		if (coalesce(ds_retorno_w::text, '') = '') then
			ds_retorno_w := substr(upper(ds_severidade_w) || chr(13) || chr(10) || ds_interacao_w ||chr(13) || chr(10),1,8000);
		else
			ds_retorno_w := substr(ds_retorno_w ||chr(13) || chr(10) || upper(ds_severidade_w) || chr(13) || chr(10) ||ds_interacao_w,1,8000);
		end if;
	end if;
	
	if (varMostraReacoes_w = 'T') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		select	substr(max(b.ds_reacao),1,200)
		into STRICT	ds_reacao_w
		from	material_reacao b,
				material a
		where	a.cd_material	= b.cd_material
		and		a.cd_material	= cd_material_w;
		
		if (ds_reacao_w IS NOT NULL AND ds_reacao_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w ||chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(351087)||': ' ||ds_reacao_w,1,8000);
		end if;
	end if;

	
	end;
end loop;
close C01;

open C03;
loop
fetch C03 into	
	cd_material_w,
	ds_material_ww;
EXIT WHEN NOT FOUND; /* apply on C03 */
	select	max(ds_interacao)
	into STRICT	ds_interacao_alimento_w
	from	medic_interacao_alimento a
	where	cd_material	= cd_material_w;

	if (ds_interacao_alimento_w IS NOT NULL AND ds_interacao_alimento_w::text <> '') then
		ds_retorno_w	:= substr(ds_retorno_w || chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(351088, 'DS_MATERIAL_WW='||ds_material_ww||';DS_INTERACAO_ALIMENTO_W='||ds_interacao_alimento_w),1,8000);
	end if;
end loop;
close C03;

return substr(ds_retorno_w,1,4000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_interacao_medic_receita ( nr_receita_p bigint) FROM PUBLIC;

