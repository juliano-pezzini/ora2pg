-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_gas_hor ( nr_seq_gasoterapia_p bigint, nr_seq_horario_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*
 C - Codigo
D - Descricao 
*/
					
ie_status_w			varchar(10);
dt_liberacao_w		timestamp;
qt_hor_pendente_w	bigint;
nr_sequencia_w		prescr_gasoterapia.nr_sequencia%type;
nr_seq_horario_w	prescr_gasoterapia_hor.nr_sequencia%type;
nr_seq_evento_w		prescr_gasoterapia_evento.nr_sequencia%type;
ie_troca_etapa_w	varchar(1);


BEGIN

nr_sequencia_w		:= nr_seq_gasoterapia_p;
nr_seq_horario_w	:= coalesce(nr_seq_horario_p,0);

if (coalesce(nr_seq_gasoterapia_p::text, '') = '') and (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then

	select 	max(nr_seq_gasoterapia)
	into STRICT	nr_sequencia_w
	from	prescr_gasoterapia_hor
	where	nr_sequencia = nr_seq_horario_p;

end if;

select	coalesce(max(a.ie_suspenso),'N'),
		max(b.dt_liberacao)
into STRICT	ie_status_w,
		dt_liberacao_w
from	prescr_gasoterapia a,
		prescr_medica b
where	a.nr_prescricao	= b.nr_prescricao
and		a.nr_sequencia	= nr_sequencia_w;

if (ie_status_w = 'N') then
	select	max(ie_evento)
	into STRICT	ie_status_w
	from	prescr_gasoterapia_evento a
	where	a.nr_seq_gasoterapia	= nr_sequencia_w
	and		coalesce(a.ie_evento_valido,'S') = 'S'
	and		((coalesce(a.nr_seq_horario, nr_seq_horario_w) = nr_seq_horario_w) or (nr_seq_horario_w = 0))
	and		obter_se_valor_contido(a.ie_evento,'V,AI,A,O,RV,IS,IM,OM') = 'N'
	and		a.nr_sequencia	= (	SELECT	max(b.nr_sequencia)
								from	prescr_gasoterapia_evento b
								where	b.nr_seq_gasoterapia	= nr_sequencia_w
								and		((coalesce(b.nr_seq_horario, nr_seq_horario_w) = nr_seq_horario_w) or (nr_seq_horario_w = 0))
								and		obter_se_valor_contido(b.ie_evento,'V,AI,A,O,RV,IS,IM,OM') = 'N'
								and		coalesce(b.ie_evento_valido,'S') = 'S');
								
	

	if	(((coalesce(ie_status_w::text, '') = '') and (coalesce(dt_liberacao_w::text, '') = '')) or (ie_status_w = 'RP')) then
		ie_status_w := 'P';
	elsif (coalesce(ie_status_w::text, '') = '') then
		ie_status_w := 'N';
	elsif (ie_status_w = 'A') then
		ie_status_w := 'N';
	elsif (ie_status_w in ('SM','SS','SP','SH')) then
		ie_status_w := 'S';
	elsif (ie_status_w in ('TE','IN')) then
	
		select	count(a.nr_sequencia)
		into STRICT	qt_hor_pendente_w
		from	prescr_gasoterapia b,
				prescr_gasoterapia_hor a
		where	a.nr_prescricao		= b.nr_prescricao
		and		a.nr_seq_gasoterapia	= b.nr_sequencia
		and		b.nr_sequencia		= nr_sequencia_w
		and		coalesce(a.dt_suspensao::text, '') = ''
		and		coalesce(a.dt_fim_horario::text, '') = '' LIMIT 1;
		
		if (qt_hor_pendente_w	= 0) then
			ie_status_w := 'T';
		elsif (ie_status_w = 'IN') then
		
			select	max(nr_sequencia)
			into STRICT	nr_seq_evento_w
			from	prescr_gasoterapia_evento a
			where	a.nr_seq_gasoterapia	= nr_sequencia_w
			and		coalesce(a.ie_evento_valido,'S') = 'S'
			and		((coalesce(a.nr_seq_horario, nr_seq_horario_w) = nr_seq_horario_w) or (nr_seq_horario_w = 0))
			and		obter_se_valor_contido(a.ie_evento,'V,AI,A,O,RV,IS,IM') = 'N'
			and		a.nr_sequencia	= (	SELECT	max(b.nr_sequencia)
										from	prescr_gasoterapia_evento b
										where	b.nr_seq_gasoterapia	= nr_sequencia_w
										and		coalesce(b.nr_seq_horario, nr_seq_horario_w) = nr_seq_horario_w
										and		obter_se_valor_contido(b.ie_evento,'V,AI,A,O,RV,IS,IM') = 'N'
										and		coalesce(b.ie_evento_valido,'S') = 'S');
			select	coalesce(max(ie_troca_etapa), 'S')	
			into STRICT	ie_troca_etapa_w
			from	motivo_evento_gas
			where	nr_sequencia in (	SELECT	coalesce(max(nr_seq_motivo),0)
										from	prescr_gasoterapia_evento
										where	nr_sequencia = nr_seq_evento_w);

			select	count(a.nr_sequencia)
			into STRICT	qt_hor_pendente_w
			from	prescr_gasoterapia b,
					prescr_gasoterapia_hor a
			where	a.nr_prescricao		= b.nr_prescricao
			and		a.nr_seq_gasoterapia	= b.nr_sequencia
			and		b.nr_sequencia		= nr_sequencia_w
			and		a.nr_sequencia = 	nr_seq_horario_w
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(a.dt_fim_horario::text, '') = '' LIMIT 1;
			
			if (ie_troca_etapa_w = 'S') and
			   (qt_hor_pendente_w = 0 AND nr_seq_horario_w > 0)then
				ie_status_w := 'T';
			end if;
		end if;
	end if;
end if;

if (coalesce(ie_status_w,'0') <> '0') then
	if (ie_opcao_p	= 'D') then
		ie_status_w	:= substr(obter_valor_dominio(2702, ie_status_w),1,255);
	end if;
end if;

return	ie_status_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_gas_hor ( nr_seq_gasoterapia_p bigint, nr_seq_horario_p bigint, ie_opcao_p text) FROM PUBLIC;

