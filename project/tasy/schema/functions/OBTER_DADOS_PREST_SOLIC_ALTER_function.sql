-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_prest_solic_alter ( nr_seq_solic_alter_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
cd_pessoa_fisica_w  varchar(30);
cd_cgc_w      varchar(30);
cd_prestador_w    varchar(30);
nm_prestador_w    varchar(80);
ds_retorno_w    varchar(80);

/* 
N - Nome Prestador 
CD - Código Prestador 
*/
 
 

BEGIN 
cd_prestador_w    := '';
nm_prestador_w    := '';
ds_retorno_w     := '';
 
--Pega Pessoa física se tiver. 
begin 
  select  c.cd_prestador, 
      substr(pls_obter_dados_prestador(c.nr_sequencia, 'N'),1,80) nm_prestador 
  into STRICT   cd_prestador_w, 
      nm_prestador_w 
  from  tasy_solic_alteracao a, 
      tasy_solic_alt_campo b, 
      pls_prestador     c 
  where   a.nr_sequencia      =   b.nr_seq_solicitacao 
  and    (b.ds_chave_simples    = c.cd_pessoa_fisica 
  or     substr(b.ds_chave_composta,1,length(b.ds_chave_composta)-1)= ('CD_PESSOA_FISICA=' || c.cd_pessoa_fisica || '#@#@IE_TIPO_COMPLEMENTO=') 
  or     b.ds_chave_composta   =   'CD_PESSOA_FISICA=' || c.cd_pessoa_fisica 
  or     b.ds_chave_composta   =   'CD_PESSOA_FISICA=' || q'{'}' || c.cd_pessoa_fisica || q'{'}' ) --Formato portal 
  and   a.ie_tipo_solicitacao  =   'P' 
  and    a.nr_sequencia      =  NR_SEQ_SOLIC_ALTER_P  LIMIT 1;
  exception 
  when no_data_found then 
      cd_pessoa_fisica_w  := null;
end;
--Pega Pessoa jurídica se tiver. 
if (coalesce(cd_prestador_w::text, '') = '' and coalesce(nm_prestador_w::text, '') = '') then 
 
	select	c.cd_prestador, 
		substr(pls_obter_dados_prestador(c.nr_sequencia, 'N'),1,80) nm_prestador		 
	into STRICT	cd_prestador_w, 
		nm_prestador_w 
	from	tasy_solic_alteracao	a, 
		tasy_solic_alt_campo	b, 
		pls_prestador		c 
	where	a.nr_sequencia		= b.nr_seq_solicitacao 
	and	(b.ds_chave_simples	= c.cd_cgc 
		or	substr(b.ds_chave_composta,1,position('#@#@IE_TIPO_COMPLEMENTO=' in b.ds_chave_composta) + length('#@#@IE_TIPO_COMPLEMENTO=') -1)	= ('CD_CGC=' || c.cd_cgc || '#@#@IE_TIPO_COMPLEMENTO=') 
		or	b.ds_chave_composta   = 'CD_CGC=' || c.cd_cgc 
		or	b.ds_chave_composta   = 'CD_CGC=' || q'{'}' || c.cd_cgc || q'{'}') --Formato portal 
	and	a.ie_tipo_solicitacao	=   'P' 
	and	a.nr_sequencia	=  nr_seq_solic_alter_p  LIMIT 1;
end if;
 
--Se a opção for 'N' retorna Nome. 
if (IE_OPCAO_P = 'N') then 
  ds_retorno_w := nm_prestador_w;
--Se a opção for 'CD' retorna Código. 
elsif (IE_OPCAO_P = 'CD') then 
  ds_retorno_w := cd_prestador_w;
end if;
 
return ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_prest_solic_alter ( nr_seq_solic_alter_p bigint, ie_opcao_p text) FROM PUBLIC;

