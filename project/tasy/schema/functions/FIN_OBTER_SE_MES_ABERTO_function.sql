-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION fin_obter_se_mes_aberto ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, ie_cp_cr_p text, ie_tipo_titulo_cpa_p text, cd_convenio_p bigint, nr_interno_conta_p bigint, nr_seq_retorno_p bigint) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(50);
cont_w			bigint;
nr_interno_conta_w		bigint;
ie_desdobrando_w		bigint;
ie_forma_fechamento_w	varchar(1)	:= 'M';
cd_perfil_w		integer;
nm_usuario_w		varchar(15);


BEGIN
cd_perfil_w	:= coalesce(obter_perfil_ativo, 0);
nm_usuario_w	:= coalesce(obter_usuario_ativo, 'X');

if (ie_cp_cr_p	= 'CR') then
	select	coalesce(max(ie_forma_fechamento),'M')
	into STRICT	ie_forma_fechamento_w
	from	parametro_contas_receber
	where	cd_estabelecimento	= cd_estabelecimento_p;
elsif (ie_cp_cr_p	= 'CP') then
	select	coalesce(max(ie_forma_fechamento),'M')
	into STRICT	ie_forma_fechamento_w
	from	parametros_contas_pagar
	where	cd_estabelecimento	= cd_estabelecimento_p;
elsif (ie_cp_cr_p	= 'A') then
	select	coalesce(max(ie_forma_fechamento),'M')
	into STRICT	ie_forma_fechamento_w
	from	parametro_contas_receber
	where	cd_estabelecimento	= cd_estabelecimento_p;
	
	if (ie_forma_fechamento_w = 'D') then
		select	coalesce(max(ie_forma_fechamento),'M')
		into STRICT	ie_forma_fechamento_w
		from	parametros_contas_pagar
		where	cd_estabelecimento	= cd_estabelecimento_p;	
	end if;		
end if;

select	count(*)
into STRICT	cont_w
from	fin_mes_ref
where	cd_estabelecimento	 = cd_estabelecimento_p;

if (cont_w = 0) then
	ie_retorno_w	:= 'S';
else
	begin
	begin
	select	nr_interno_conta
	into STRICT	nr_interno_conta_w
	from	conta_paciente
	where	nr_interno_conta = nr_interno_conta_p;	
	exception
	when others then
		nr_interno_conta_w := null;
	end;
	
	if (ie_forma_fechamento_w = 'D') then
		-- verificar se tem dia aberto
		select	count(*)
		into STRICT	cont_w
		from	fin_mes_ref a
		where	cd_estabelecimento		= cd_estabelecimento_p
		and	trunc(dt_referencia, 'dd') 	= trunc(dt_referencia_p, 'dd')
		and	(coalesce(dt_fechamento::text, '') = '' or
			(SELECT	count(*)
			from	fin_mes_ref_fora x
			where	coalesce(cd_perfil_lib, cd_perfil_w) = cd_perfil_w
			and	coalesce(nm_usuario_lib, nm_usuario_w) = nm_usuario_w
			and (coalesce(x.ie_baixa_retorno,'N') = 'N' or coalesce(nr_seq_retorno_p,0) <> 0)
			and	((ie_cancel_conta_pac = 'N') or (ie_cancel_conta_pac = 'S' and nr_interno_conta_w > 0))
			and	coalesce(coalesce(x.cd_convenio, cd_convenio_p),0) = coalesce(cd_convenio_p,0)
			and	coalesce(x.ie_tipo_titulo_cpa,coalesce(ie_tipo_titulo_cpa_p,'X')) = coalesce(ie_tipo_titulo_cpa_p,'X')
			and	x.nr_seq_fin_mes = a.nr_sequencia) > 0)
		and (coalesce(ie_cp_cr,'A') = coalesce(ie_cp_cr_p,'A') or coalesce(ie_cp_cr,'A') = 'A');
	else
		-- verificar se tem mes aberto
		select	count(*)
		into STRICT	cont_w
		from	fin_mes_ref a
		where	cd_estabelecimento		= cd_estabelecimento_p
		and	trunc(dt_referencia, 'month') 	= trunc(dt_referencia_p, 'month')
		and	(coalesce(dt_fechamento::text, '') = '' or
			(SELECT	count(*)
			from	fin_mes_ref_fora x
			where	coalesce(cd_perfil_lib, cd_perfil_w) = cd_perfil_w
			and	coalesce(nm_usuario_lib, nm_usuario_w) = nm_usuario_w
			and (coalesce(x.ie_baixa_retorno,'N') = 'N' or coalesce(nr_seq_retorno_p,0) <> 0)
			and	((coalesce(ie_cancel_conta_pac,'N') = 'N') or (ie_cancel_conta_pac = 'S' and nr_interno_conta_w > 0))
			and	coalesce(coalesce(x.cd_convenio, cd_convenio_p),0) = coalesce(cd_convenio_p,0)
			and	coalesce(x.ie_tipo_titulo_cpa,coalesce(ie_tipo_titulo_cpa_p,'X')) = coalesce(ie_tipo_titulo_cpa_p,'X')
			and	x.nr_seq_fin_mes = a.nr_sequencia) > 0)
		and (coalesce(ie_cp_cr,'A') = coalesce(ie_cp_cr_p,'A') or coalesce(ie_cp_cr,'A') = 'A');
	end if;

	if (cont_w > 0) then
		ie_retorno_w		:= 'S';
	else
		-- edgar 26/09/2008, os 84045, deixar desdobrar o titulo em mes fechado
		select	count(*)
		into STRICT	ie_desdobrando_w
		from	v$session
		where	audsid = (SELECT userenv('sessionid') )
		and	upper(action) = 'DESDOBRAMENTO_TITULO';

		if (ie_desdobrando_w = 0) then
			ie_retorno_w	:= 'N';
		else
			ie_retorno_w	:= 'S';
		end if;
	end if;
	end;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION fin_obter_se_mes_aberto ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, ie_cp_cr_p text, ie_tipo_titulo_cpa_p text, cd_convenio_p bigint, nr_interno_conta_p bigint, nr_seq_retorno_p bigint) FROM PUBLIC;

