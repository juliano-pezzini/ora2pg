-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION round_abnt ( vl_arredondar_p bigint, qt_decimais_p bigint default 0) RETURNS bigint AS $body$
DECLARE


/*
Objetivo
Apresentar as regras vigentes de arredondamento definidas pela ABNT que estão sendo usadas como regra de arredondamento em alguns ECF.

ATENÇÃO
Estas regras de arredondamento são aplicadas somente para números ou valores monetários, não devem ser aplicadas à unidades de medida.
-------------------------------------
         Passo a Passo
-------------------------------------
Regra 1
Se o último algarismo a ser conservado for seguido de um algarismo inferior a cinco, basta apenas retirar os algarismos após o algarismo que queremos conservar.

Regra 2
Se o último algarismo a ser conservado for seguido de um algarismo superior a cinco, aumenta-se uma unidade a este último algarismo e retira-se os posteriores.

Regra 3
Se o último algarismo a ser conservado for seguido de um algarismo igual a cinco, devemos seguir um dos seguintes procedimentos:

	A)
	Se o algarismo a ser conservado for ímpar, soma-se uma unidade ao algarismo a ser conservado e retira-se os posteriores.

	B)
	Se o algarismo a ser conservado for par, seguido do algarismo 5 e um dos números seguintes ao 5 for um algarismo diferente de zero, soma-se uma unidade ao algarismo a ser conservado e retira-se os posteriores.

	C)
	Se o algarismo a ser conservado for par e ao algarismo 5 subsequente for seguido somente algarismos zero, não haverá modificação, somente retira-se os algarismos posteriores.

FONTE: Regras de arredondamento na Numeração Decimal.
Norma ABNT NBR 5891. Dezembro de 1977.
*/
vl_retorno_w		double precision; -- Numérico de  15 por 5.
ds_calculo_w		varchar(10);
qt_decimais_w		smallint;


BEGIN

if (qt_decimais_p > 5) then
	begin
	/* Número inválido de posições decimais, informe um valor igual ou inferior a 5. */

	CALL Wheb_mensagem_pck.exibir_mensagem_abort(317054);
	end;
end if;

if (length(trunc(vl_arredondar_p)) > 15) then
	begin
	/* Número inválido para ser arredondado, informar com no máximo 15 posições antes da vírgula. */

	CALL Wheb_mensagem_pck.exibir_mensagem_abort(317055);
	end;
end if;

qt_decimais_w	:= trunc(qt_decimais_p);

/*
Se o valor for nulo retorna nulo se for 0 retorna 0
*/
if (coalesce(vl_arredondar_p,0) = 0) then
	begin
	vl_retorno_w	:= vl_arredondar_p;
	end;
/*
Caso os parâmetro de decimais seja negativo ou
Caso o valor não possua casas decimais, arredondamento normal do oracle
*/
elsif (qt_decimais_w < 1) or (trunc(vl_arredondar_p) = vl_arredondar_p) then
	begin
	vl_retorno_w	:= round(vl_arredondar_p, qt_decimais_w);
	end;
/*
Fazer o arredondamento conforma Norma ABNT NBR 5891 de Dezembro de 1977.
*/
else
	begin

	ds_calculo_w	:= substr(rpad(to_char(vl_arredondar_p - trunc(vl_arredondar_p)),7,'0'),2,7);

	if (substr(ds_calculo_w,qt_decimais_w + 1,1) = '5') then
		begin
		if (mod((substr(ds_calculo_w,qt_decimais_w,1))::numeric ,2) = 0) then
			begin
			if (coalesce(substr(vl_arredondar_p - trunc(vl_arredondar_p),qt_decimais_w + 3),0) = 0) then
				begin
				vl_retorno_w	:= trunc(vl_arredondar_p, qt_decimais_w);
				end;
			else
				begin
				vl_retorno_w	:= round(vl_arredondar_p, qt_decimais_w);
				end;
			end if;
			end;
		else
			begin
			vl_retorno_w	:= round(vl_arredondar_p, qt_decimais_w);
			end;
		end if;
		end;
	else
		begin
		vl_retorno_w	:= round(vl_arredondar_p, qt_decimais_w);
		end;
	end if;
	end;
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION round_abnt ( vl_arredondar_p bigint, qt_decimais_p bigint default 0) FROM PUBLIC;

