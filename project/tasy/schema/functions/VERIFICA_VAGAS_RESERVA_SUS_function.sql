-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION verifica_vagas_reserva_sus (cd_agenda_p bigint, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, cd_setor_p bigint, cd_perfil_p bigint, nr_seq_agenda_p bigint, dt_agenda_p timestamp, nm_usuario_p text, cd_convenio_p bigint) RETURNS varchar AS $body$
DECLARE

 
 ie_permite_agendamento_w varchar(1);
 cd_tipo_agenda_w     bigint;
 ie_tipo_convenio_w    bigint;
 nr_seq_regra_w	     bigint;
 cd_estabelecimento_w	  bigint;
 cd_agenda_w				    bigint;
 dt_inicio_regra_w		   timestamp;
 dt_final_regra_w		   timestamp;
 qt_regra_w		    	 bigint	:= 0;
 pr_permissao_w		   	 bigint	:= 0;
 qt_agendamento_w		   bigint	:= 0;
 qt_total_w        bigint	:= 0;
 qt_restante_w      bigint	:= 0;
 pr_restante_w		    	 bigint	:= 0;
 pr_agendamento_w		  	 bigint	:= 0;
 qt_agendamento_sus_w		 bigint	:= 0;
 pr_agendamento_sus_w		 bigint	:= 0;

 C01 CURSOR FOR 
	SELECT nr_sequencia, cd_estabelecimento, cd_agenda 
  from agenda_regra_estab 
	 where cd_estabelecimento = cd_estabelecimento_p 
	  and ((cd_agenda = cd_agenda_p) or (coalesce(cd_agenda::text, '') = '')) 
	  and ((ie_tipo_atendimento = ie_tipo_atendimento_p) or (coalesce(ie_tipo_atendimento::text, '') = '')) 
	  and ((cd_tipo_agenda	= cd_tipo_agenda_w) 	or (coalesce(cd_tipo_agenda, 0) = 0)) 
   and ((cd_setor = cd_setor_p) or (coalesce(cd_setor::text, '') = '')) 
   and ((cd_perfil = cd_perfil_p) or (coalesce(cd_perfil::text, '') = '')) 
	  and ((obter_cod_dia_semana(dt_agenda_p) = ie_dia_semana) or (ie_dia_semana = 9) or (coalesce(ie_dia_semana::text, '') = ''))	 
	  and dt_agenda_p between to_date(to_char(dt_agenda_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_inicial,'hh24:mi:ss'), '00:00:00'),'dd/mm/yyyy hh24:mi:ss') 	 
             and to_date(to_char(dt_agenda_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_final,'hh24:mi:ss'), '23:59:59'),'dd/mm/yyyy hh24:mi:ss')	 
   and ie_situacao = 'A'           
order by coalesce(qt_regra, 0), coalesce(pr_permissao, 0), coalesce(cd_agenda, 0), coalesce(ie_tipo_atendimento,0);

BEGIN
 ie_permite_agendamento_w := 'S';
  
 select coalesce(max(cd_tipo_agenda), 0) 
  into STRICT cd_tipo_agenda_w 
  from agenda 
  where cd_agenda = cd_agenda_p;
 
 open C01;
  loop 
  fetch C01 into	 
   nr_seq_regra_w, 
   cd_estabelecimento_w, 
   cd_agenda_w;
   EXIT WHEN NOT FOUND; /* apply on C01 */
	  begin 
    nr_seq_regra_w 		:= nr_seq_regra_w;
 
    select to_date(to_char(dt_agenda_p, 'dd/mm/yyyy')||' '||to_char(coalesce(hr_inicial, to_date('30/12/1899 00:00:01', 'dd/mm/yyyy hh24:mi:ss')), 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss'), 
		      to_date(to_char(dt_agenda_p, 'dd/mm/yyyy')||' '||to_char(coalesce(hr_final, to_date('30/12/1899 23:59:59', 'dd/mm/yyyy hh24:mi:ss')), 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
	    into STRICT dt_inicio_regra_w, dt_final_regra_w 
	    from agenda_regra_estab 
	    where nr_sequencia	= nr_seq_regra_w;
 	 end;
  end loop;
 close C01;
 
 if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then 
RAISE NOTICE '3';
  select max(qt_regra), max(pr_permissao) 
	  into STRICT qt_regra_w, pr_permissao_w 
   from agenda_regra_estab 
   where nr_sequencia = nr_seq_regra_w;
   
  if (cd_tipo_agenda_w = 2) then   
   select count(*) 
    into STRICT qt_agendamento_w 
    from agenda_paciente 
    inner join convenio on convenio.cd_convenio = agenda_paciente.cd_convenio and convenio.ie_tipo_convenio <> 3 
    where ie_status_agenda not in ('F','I','C','L','B','R') 
     and hr_inicio between dt_inicio_regra_w and dt_final_regra_w 
		   and cd_agenda = coalesce(cd_agenda_w, cd_agenda) 
		   and nr_sequencia	<> nr_seq_agenda_p;
     
   select count(*) 
    into STRICT qt_agendamento_sus_w 
    from agenda_paciente 
    inner join convenio on convenio.cd_convenio = agenda_paciente.cd_convenio and convenio.ie_tipo_convenio = 3 
    where ie_status_agenda not in ('F','I','C','L','B','R') 
     and hr_inicio between dt_inicio_regra_w and dt_final_regra_w 
		   and cd_agenda = coalesce(cd_agenda_w, cd_agenda) 
		   and nr_sequencia	<> nr_seq_agenda_p;
     
   select count(*) 
    into STRICT qt_total_w 
    from agenda_paciente     
    where hr_inicio between dt_inicio_regra_w and dt_final_regra_w 
		   and cd_agenda = coalesce(cd_agenda_w, cd_agenda);
     
  elsif (cd_tipo_agenda_w in (3,5)) then 
  		select count(*) 
		  into STRICT qt_agendamento_w 
		  from agenda_consulta 
    inner join convenio on convenio.cd_convenio = agenda_consulta.cd_convenio and convenio.ie_tipo_convenio <> 3 
		  where ie_status_agenda not in ('F','I','C','L','B','R') 
		   and dt_agenda between dt_inicio_regra_w and dt_final_regra_w 
     and cd_agenda = coalesce(cd_agenda_w, cd_agenda) 
		   and nr_sequencia 	<> nr_seq_agenda_p;		
     
  		select count(*) 
		  into STRICT qt_agendamento_sus_w 
		  from agenda_consulta 
    inner join convenio on convenio.cd_convenio = agenda_consulta.cd_convenio and convenio.ie_tipo_convenio = 3 
		  where ie_status_agenda not in ('F','I','C','L','B','R') 
		   and dt_agenda between dt_inicio_regra_w and dt_final_regra_w 
     and cd_agenda = coalesce(cd_agenda_w, cd_agenda) 
		   and nr_sequencia 	<> nr_seq_agenda_p;		
     
   select count(*) 
    into STRICT qt_total_w 
    from agenda_consulta 
    where dt_agenda between dt_inicio_regra_w and dt_final_regra_w 
		   and cd_agenda = coalesce(cd_agenda_w, cd_agenda);
     
  end if;
   
  if (cd_estabelecimento_w = cd_estabelecimento_p) then 
   select ie_tipo_convenio 
    into STRICT ie_tipo_convenio_w 
    from convenio 
    where cd_convenio = cd_convenio_p;
    
   if (ie_tipo_convenio_w <> 3) then 
    qt_agendamento_w := qt_agendamento_w + 1;
   else  
    qt_agendamento_sus_w := qt_agendamento_sus_w + 1;
   end if;
  end if;
   
  if (pr_permissao_w > 0) then 
   if (ie_tipo_convenio_w <> 3) then   
    pr_restante_w  := 100 - pr_permissao_w;
    pr_agendamento_w := ROUND(((100 * qt_agendamento_w) / qt_total_w),0);
     
    if (pr_agendamento_w > pr_restante_w) then 
     ie_permite_agendamento_w:= 'N';
    end if;
   else 
    pr_agendamento_sus_w := ROUND(((100 * qt_agendamento_sus_w) / qt_total_w),0);
    
    if (pr_agendamento_sus_w > pr_permissao_w) then 
     ie_permite_agendamento_w:= 'N';
    end if;
   end if;
  else 
   if (ie_tipo_convenio_w <> 3) then 
    qt_restante_w := qt_total_w - qt_regra_w;
 
    if (qt_agendamento_w > qt_restante_w) then 
     ie_permite_agendamento_w:= 'N';
    end if;
   else  
    qt_restante_w := qt_regra_w - qt_agendamento_sus_w;
 
    if (qt_agendamento_sus_w > qt_restante_w) then 
     ie_permite_agendamento_w:= 'N';
    end if;
   end if;
  end if;
   
 end if;
 
 return ie_permite_agendamento_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION verifica_vagas_reserva_sus (cd_agenda_p bigint, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, cd_setor_p bigint, cd_perfil_p bigint, nr_seq_agenda_p bigint, dt_agenda_p timestamp, nm_usuario_p text, cd_convenio_p bigint) FROM PUBLIC;

