-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_inf_exames_laborat ( nr_seq_exame_p bigint, nr_prescricao_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE



ds_exame_w	varchar(4000) := '';
dt_coleta_w	timestamp;
dt_aprovacao_w	timestamp;
nr_resultado_w	bigint;


BEGIN
if (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then


	nr_resultado_w  := obter_param_usuario(281, 17, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, nr_resultado_w );

	if ( coalesce(nr_resultado_w,1)  = 1 ) then


		select	max(coalesce(k.dt_coleta,B.dt_coleta)),
			max(Obter_data_aprov_lab(k.nr_prescricao,k.nr_sequencia))
		into STRICT	dt_coleta_w,
			dt_aprovacao_w
		from	grupo_exame_lab c,
			exame_laboratorio e,
			exame_lab_result_item b,
			prescr_procedimento k,
			prescr_medica x,
			exame_lab_resultado a
		where	a.nr_seq_resultado	= b.nr_seq_resultado
		and	b.nr_seq_exame		= e.nr_seq_exame
		and	e.nr_seq_grupo		= c.nr_sequencia
		and	x.nr_prescricao		= a.nr_prescricao
		and	k.nr_sequencia		= b.nr_seq_prescr
		and	x.nr_prescricao		= k.nr_prescricao
		and	x.nr_prescricao		= nr_prescricao_p
		and	b.nr_seq_exame		= nr_seq_exame_p;


		ds_exame_w := wheb_mensagem_pck.get_texto(308348,	'DT_COLETA_W=' || to_char(dt_coleta_w, 'dd/mm/yyyy hh24:mi:ss') || ';' ||
															'DT_APROVACAO_W=' || to_char(dt_aprovacao_w, 'dd/mm/yyyy hh24:mi:ss'));
					/*
						Data coleta do exame: #@DT_COLETA_W#@
						Data de aprovação do exame: #@DT_APROVACAO_W#@
					*/
	elsif ( coalesce(nr_resultado_w,4)  = 4 ) then
		select	max(coalesce(k.dt_coleta,B.dt_coleta)),
				max(Obter_data_aprov_lab(k.nr_prescricao,k.nr_sequencia))
		into STRICT	dt_coleta_w,
				dt_aprovacao_w
		from	grupo_exame_lab c,
			exame_laboratorio e,
			exame_lab_result_item b,
			prescr_procedimento k,
			prescr_medica x,
			exame_lab_resultado a
		where	a.nr_seq_resultado	= b.nr_seq_resultado
		and	b.nr_seq_exame		= e.nr_seq_exame
		and	e.nr_seq_grupo		= c.nr_sequencia
		and	x.nr_prescricao		= a.nr_prescricao
		and	k.nr_sequencia		= b.nr_seq_prescr
		and	x.nr_prescricao		= k.nr_prescricao
		and	x.nr_prescricao		= nr_prescricao_p
		and	((b.nr_seq_exame = nr_seq_exame_p) or (e.nr_seq_exame_pep = nr_seq_exame_p));

		ds_exame_w := wheb_mensagem_pck.get_texto(308348,	'DT_COLETA_W=' || to_char(dt_coleta_w, 'dd/mm/yyyy hh24:mi:ss') || ';' ||
															'DT_APROVACAO_W=' || to_char(dt_aprovacao_w, 'dd/mm/yyyy hh24:mi:ss'));
					/*
						Data coleta do exame: #@DT_COLETA_W#@
						Data de aprovação do exame: #@DT_APROVACAO_W#@
					*/
	else

		select 	max(b.dt_coleta),
			max(b.dt_aprovacao)
		into STRICT	dt_coleta_w,
			dt_aprovacao_w
		from   	exame_lab_result_item b,
			exame_lab_resultado a
		where 	a.nr_seq_resultado	= b.nr_seq_resultado
		and	a.nr_prescricao 	= nr_prescricao_p
		and	b.nr_seq_exame		= nr_seq_exame_p;

		ds_exame_w := wheb_mensagem_pck.get_texto(308348,	'DT_COLETA_W=' || to_char(dt_coleta_w, 'dd/mm/yyyy hh24:mi:ss') || ';' ||
															'DT_APROVACAO_W=' || to_char(dt_aprovacao_w, 'dd/mm/yyyy hh24:mi:ss'));
					/*
						Data coleta do exame: #@DT_COLETA_W#@
						Data de aprovação do exame: #@DT_APROVACAO_W#@
					*/
	end if;

end if;


return  substr(ds_exame_w,1,255);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_inf_exames_laborat ( nr_seq_exame_p bigint, nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

