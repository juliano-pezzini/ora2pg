-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE lista_autorizacoes AS (cd_autorizacao_v		varchar(20),
		nr_atendimento_v		bigint,
		nr_seq_agenda_v			autorizacao_convenio.nr_seq_agenda%type,
		nr_seq_agenda_consulta_v	autorizacao_convenio.nr_seq_agenda_consulta%type,
		nr_seq_age_integ_v		autorizacao_convenio.nr_seq_age_integ%type,
		nr_seq_gestao_v			bigint,
		nr_seq_paciente_v		bigint,
		nr_seq_paciente_setor_v		bigint,
		nr_seq_rxt_tratamento_v		bigint);


CREATE OR REPLACE FUNCTION tiss_obter_guia_pric_autor (cd_estabelecimento_p bigint, cd_convenio_p bigint, nr_sequencia_autor_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

		
/*ie_opcao_p
	GP - Guia principal
	GO - Guia operadora
*/
cd_autorizacao_w		varchar(20);
cd_senha_w			varchar(20);
cd_senha_provisoria_w		varchar(20);
ie_guia_princ_autor_w		varchar(10);
ds_retorno_w			varchar(255);
ie_guia_operadora_autor_w	varchar(10);
nr_atendimento_w		bigint;
cd_autorizacao_internacao_w	varchar(20);
nr_doc_conv_principal_w		varchar(20);
nr_seq_agenda_w			autorizacao_convenio.nr_seq_agenda%type;
nr_seq_age_integ_w		autorizacao_convenio.nr_seq_age_integ%type;
nr_seq_agenda_consulta_w	autorizacao_convenio.nr_seq_agenda_consulta%type;
nr_seq_gestao_w			bigint;
nr_seq_paciente_w		bigint;
nr_seq_paciente_setor_w		bigint;
nr_seq_rxt_tratamento_w		bigint;	
cd_pessoa_fisica_w		varchar(10);
cd_estab_w			estabelecimento.cd_estabelecimento%type;
i				integer;
j				integer;
		
type lista_autorizacoes_vt is table of lista_autorizacoes index 	by integer;
lista_autorizacoes_w			lista_autorizacoes_vt;


C01 CURSOR FOR
	SELECT 	a.cd_autorizacao,
		a.nr_atendimento,
		a.nr_seq_agenda,
		a.nr_seq_agenda_consulta,
		a.nr_seq_age_integ,
		a.nr_seq_gestao,
		a.nr_seq_paciente,
		a.nr_seq_paciente_setor,
		a.nr_seq_rxt_tratamento
	from 	autorizacao_convenio a,
		estagio_autorizacao  b
	where 	((a.ie_tipo_autorizacao 	= '1') or (ie_guia_princ_autor_w = 'M'))
	and  	a.nr_seq_estagio 	= b.nr_sequencia
	and 	b.ie_interno 		not in ('70','90')
	and 	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
	and	a.cd_convenio		= cd_convenio_p
	and	a.cd_estabelecimento	= cd_estab_w
	and	(a.cd_autorizacao IS NOT NULL AND a.cd_autorizacao::text <> '')
	order by a.ie_tipo_autorizacao asc,
		 a.nr_sequencia desc;
		
C01_w	c01%rowtype;		


BEGIN
select	max(cd_autorizacao),
	max(cd_senha),
	max(cd_senha_provisoria),
	max(nr_atendimento),
	max(nr_seq_agenda),
	max(nr_seq_age_integ),
	max(nr_seq_agenda_consulta),
	max(nr_seq_gestao),
	max(nr_seq_paciente),
	max(nr_seq_paciente_setor),
	max(nr_seq_rxt_tratamento),
	max(cd_pessoa_fisica),
	max(cd_estabelecimento)
into STRICT	cd_autorizacao_w,
	cd_senha_w,
	cd_senha_provisoria_w,
	nr_atendimento_w,
	nr_seq_agenda_w,
	nr_seq_age_integ_w,
	nr_seq_agenda_consulta_w,
	nr_seq_gestao_w,
	nr_seq_paciente_w,
	nr_seq_paciente_setor_w,
	nr_seq_rxt_tratamento_w,	
	cd_pessoa_fisica_w,
	cd_estab_w
from	autorizacao_convenio
where	nr_sequencia	= nr_sequencia_autor_p;

select	coalesce(max(ie_guia_princ_autor),'G'),
	coalesce(max(ie_guia_operadora_autor),'G')
into STRICT	ie_guia_princ_autor_w,
	ie_guia_operadora_autor_w
from	tiss_parametros_convenio
where	cd_estabelecimento	= cd_estabelecimento_p
and	cd_convenio		= cd_convenio_p;


if	((ie_opcao_p = 'GP') and (ie_guia_princ_autor_w in ('I','D','M'))) then
	lista_autorizacoes_w.delete;
	i := 0;
	open C01;
	loop
	fetch C01 into	
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	
		lista_autorizacoes_w[i].cd_autorizacao_v		:= c01_w.cd_autorizacao;
		lista_autorizacoes_w[i].nr_atendimento_v		:= c01_w.nr_atendimento;
		lista_autorizacoes_w[i].nr_seq_agenda_v			:= c01_w.nr_seq_agenda;
		lista_autorizacoes_w[i].nr_seq_agenda_consulta_v	:= c01_w.nr_seq_agenda_consulta;
		lista_autorizacoes_w[i].nr_seq_age_integ_v		:= c01_w.nr_seq_age_integ;
		lista_autorizacoes_w[i].nr_seq_gestao_v			:= c01_w.nr_seq_gestao;
		lista_autorizacoes_w[i].nr_seq_paciente_v		:= c01_w.nr_seq_paciente;
		lista_autorizacoes_w[i].nr_seq_paciente_setor_v		:= c01_w.nr_seq_paciente_setor;
		lista_autorizacoes_w[i].nr_seq_rxt_tratamento_v		:= c01_w.nr_seq_rxt_tratamento;
		
		RAISE NOTICE 'i: %', i;
		
		i := i + 1;
	end loop;
	close C01;
	
	j	:= 0;
	cd_autorizacao_internacao_w := null;
	for j in 0..lista_autorizacoes_w.count - 1 loop

		
		if	((coalesce(cd_autorizacao_internacao_w::text, '') = '') and (lista_autorizacoes_w[j].nr_atendimento_v = nr_atendimento_w)) then
			cd_autorizacao_internacao_w := lista_autorizacoes_w[j].cd_autorizacao_v;
			RAISE NOTICE '% atend:%;autor: %', j, lista_autorizacoes_w[j].nr_atendimento_v, lista_autorizacoes_w[j].cd_autorizacao_v;
			RAISE NOTICE '% atendw:%', j, nr_atendimento_w;
		end if;
		
	end loop;
	j	:= 0;
	for j in 0..lista_autorizacoes_w.count - 1 loop
	
		if	((coalesce(cd_autorizacao_internacao_w::text, '') = '') and (lista_autorizacoes_w[j].nr_seq_agenda_v = nr_seq_agenda_w)) then
			--dbms_output.put_line(j||' agenda:'||lista_autorizacoes_w(j).nr_seq_agenda_v||' ;autor: '|| lista_autorizacoes_w(j).cd_autorizacao_v);
			cd_autorizacao_internacao_w := lista_autorizacoes_w[j].cd_autorizacao_v;
		end if;
		
	end loop;
		
	j	:= 0;
	for j in 0..lista_autorizacoes_w.count - 1 loop	
	
		if	((coalesce(cd_autorizacao_internacao_w::text, '') = '') and (lista_autorizacoes_w[j].nr_seq_age_integ_v = nr_seq_age_integ_w)) then
			--dbms_output.put_line(j||' consulta:'||lista_autorizacoes_w(j).nr_seq_agenda_consulta_v||' ;autor: '|| lista_autorizacoes_w(j).cd_autorizacao_v);
			cd_autorizacao_internacao_w := lista_autorizacoes_w[j].cd_autorizacao_v;
		end if;
		
	end loop;
	
	j	:= 0;
	for j in 0..lista_autorizacoes_w.count - 1 loop
	
		if	((coalesce(cd_autorizacao_internacao_w::text, '') = '') and (lista_autorizacoes_w[j].nr_seq_agenda_consulta_v = nr_seq_agenda_consulta_w)) then
			--dbms_output.put_line(j||' integrada:'||lista_autorizacoes_w(j).nr_seq_age_integ_v||' ;autor: '|| lista_autorizacoes_w(j).cd_autorizacao_v);
			cd_autorizacao_internacao_w := lista_autorizacoes_w[j].cd_autorizacao_v;
		end if;
		
	end loop;
	j	:= 0;
	for j in 0..lista_autorizacoes_w.count - 1 loop
	
		if	((coalesce(cd_autorizacao_internacao_w::text, '') = '') and (lista_autorizacoes_w[j].nr_seq_paciente_v = nr_seq_paciente_w)) then
			--dbms_output.put_line(j||' paciente atend ciclo:'||lista_autorizacoes_w(j).nr_seq_paciente_v||' ;autor: '|| lista_autorizacoes_w(j).cd_autorizacao_v);
			cd_autorizacao_internacao_w := lista_autorizacoes_w[j].cd_autorizacao_v;
		end if;
	end loop;	
	
	j	:= 0;
	for j in 0..lista_autorizacoes_w.count - 1 loop
	
		if	((coalesce(cd_autorizacao_internacao_w::text, '') = '') and (lista_autorizacoes_w[j].nr_seq_gestao_v = nr_seq_gestao_w)) then
			--dbms_output.put_line(j||' vaga:'||lista_autorizacoes_w(j).nr_seq_gestao_v||' ;autor: '|| lista_autorizacoes_w(j).cd_autorizacao_v);
			cd_autorizacao_internacao_w := lista_autorizacoes_w[j].cd_autorizacao_v;
		end if;
	end loop;
	
		
	j	:= 0;
	for j in 0..lista_autorizacoes_w.count - 1 loop
	
		if	((coalesce(cd_autorizacao_internacao_w::text, '') = '') and (lista_autorizacoes_w[j].nr_seq_paciente_setor_v = nr_seq_paciente_setor_w)) then
			--dbms_output.put_line(j||' paciente quim:'||lista_autorizacoes_w(j).nr_seq_paciente_setor_v||' ;autor: '|| lista_autorizacoes_w(j).cd_autorizacao_v);
			cd_autorizacao_internacao_w := lista_autorizacoes_w[j].cd_autorizacao_v;
		end if;
		
	end loop;
	
	j	:= 0;
	for j in 0..lista_autorizacoes_w.count - 1 loop
	
		if	((coalesce(cd_autorizacao_internacao_w::text, '') = '') and (lista_autorizacoes_w[j].nr_seq_rxt_tratamento_v = nr_Seq_rxt_tratamento_w)) then
			--dbms_output.put_line(j||' radio:'||lista_autorizacoes_w(j).nr_seq_rxt_tratamento_v||' ;autor: '|| lista_autorizacoes_w(j).cd_autorizacao_v);
			cd_autorizacao_internacao_w := lista_autorizacoes_w[j].cd_autorizacao_v;
		end if;
		
	end loop;
	
	j	:= 0;
	for j in 0..lista_autorizacoes_w.count - 1 loop
		
		if	((coalesce(cd_autorizacao_internacao_w::text, '') = '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')) then
			--dbms_output.put_line(j||' Pessoa fisica: autor: '|| lista_autorizacoes_w(j).cd_autorizacao_v);
			cd_autorizacao_internacao_w := lista_autorizacoes_w[j].cd_autorizacao_v;
		end if;
		
	end loop;
	
	
end if;




if (ie_opcao_p = 'GP') then	
	if (ie_guia_princ_autor_w = 'G') then
		ds_retorno_w	:= cd_autorizacao_w;
	elsif (ie_guia_princ_autor_w = 'S') then
		ds_retorno_w	:= cd_senha_w;
	elsif (ie_guia_princ_autor_w = 'P') then	
		ds_retorno_w	:= cd_senha_provisoria_w;
	elsif (ie_guia_princ_autor_w = 'I') then	
		ds_retorno_w	:= cd_autorizacao_internacao_w;
	elsif (ie_guia_princ_autor_w = 'A') then

		select	max(a.nr_doc_conv_principal)
		into STRICT	nr_doc_conv_principal_w
		from	atend_categoria_convenio a,
			autorizacao_convenio b
		where	a.nr_atendimento	= b.nr_atendimento
		and	b.cd_convenio		= a.cd_convenio
		and	b.nr_sequencia		= nr_sequencia_autor_p;

	
		ds_retorno_w	:= nr_doc_conv_principal_w;
	elsif (ie_guia_princ_autor_w = 'D') then
	
	
		select	max(a.nr_doc_conv_principal)
		into STRICT	nr_doc_conv_principal_w
		from	atend_categoria_convenio a,
			autorizacao_convenio b
		where	a.nr_atendimento	= b.nr_atendimento
		and	b.cd_convenio		= a.cd_convenio
		and	b.nr_sequencia		= nr_sequencia_autor_p;
	
		ds_retorno_w	:= coalesce(nr_doc_conv_principal_w,cd_autorizacao_internacao_w);
	elsif (ie_guia_princ_autor_w = 'M') then
		ds_retorno_w := cd_autorizacao_internacao_w;
	end if;
elsif (ie_opcao_p = 'GO') then
	if (ie_guia_operadora_autor_w = 'G') then
		ds_retorno_w	:= cd_autorizacao_w;
	elsif (ie_guia_operadora_autor_w = 'S') then
		ds_retorno_w	:= cd_senha_w;
	elsif (ie_guia_operadora_autor_w = 'P') then	
		ds_retorno_w	:= cd_senha_provisoria_w;
	end if;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION tiss_obter_guia_pric_autor (cd_estabelecimento_p bigint, cd_convenio_p bigint, nr_sequencia_autor_p bigint, ie_opcao_p text) FROM PUBLIC;

