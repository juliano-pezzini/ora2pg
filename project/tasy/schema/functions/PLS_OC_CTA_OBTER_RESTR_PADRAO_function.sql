-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_oc_cta_obter_restr_padrao ( ie_opcao_p text, dados_consistencia_p pls_tipos_ocor_pck.dados_consistencia, nr_id_transacao_p pls_oc_cta_selecao_ocor_v.nr_id_transacao%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, ie_incidencia_regra_p text, nr_cursor_p integer, dados_filtro_p pls_tipos_ocor_pck.dados_filtro, dados_forma_geracao_ocor_p pls_tipos_ocor_pck.dados_forma_geracao_ocor, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_por_array_p text default 'N', ie_obter_total_reg_p text default 'N', qt_registro_selecao_p integer default 0) RETURNS PLS_TIPOS_OCOR_PCK.DADOS_RESTRICAO_SELECT AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Retornar ou atualizar os binds dos selects padrao da PLS_OC_CTA_APLICAR_FILTROS
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[ X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
Cuidar com os ALIAS... Dar nome padronizado, para facilitar identificacao e nao repetir..

ie_opcao_p

RESTRICAO - Ira retorna as restricoes dos selects.
BINDS - Ira atualizar o valor das binds do curso no sql dinamico

Alteracoes:
 -----------------------------------------------------------------------------------------------------------------

 jjung OS 709376 - 03/03/2014
 
 Alteracao:	Adicionado restricao por liberacao da ocorrencia para a guia quando a regra tiver
	Consistncia web marcado como Ambos tambm. 
	
Motivo:	Cliente identificou que quando a regra tinha este campo marcado a liberao no era processada
	no complemento.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
dados_restricao_w	pls_tipos_ocor_pck.dados_restricao_select;
qt_filtro_conta_w	integer;


BEGIN
-- Inicializar o retorno
dados_restricao_w.ds_restricao_lote		:= null;
dados_restricao_w.ds_restricao_protocolo	:= null;
dados_restricao_w.ds_restricao_conta		:= null;
dados_restricao_w.ds_restricao_proc		:= null;
dados_restricao_w.ds_restricao_mat		:= null;
dados_restricao_w.ds_restricao_mat		:= null;
dados_restricao_w.ds_restricao_partic		:= null;
dados_restricao_w.ds_campos_sql			:= null;
dados_restricao_w.ds_restricao_minus		:= null;

-- Verificaes dos parmetros, caso tenha valor informado ser adicionado a restrio para o mesmo.

-- Sempre agrupar cada adio de restrio com a atualizao da varivel.

-- Sempre esta verificao por primeiro.
if (nr_id_transacao_p IS NOT NULL AND nr_id_transacao_p::text <> '') then

	-- se a excecao foi informada
	if (ie_por_array_p = 'S') then

		if (ie_opcao_p = 'RESTRICAO') then

			-- Verificar a sequencia ou as sequencias do item e seus filhos.
			dados_restricao_w.ds_campos_sql :=	',' || pls_tipos_ocor_pck.enter_w ||
								'	pls_tipos_ocor_pck.obter_sequencia_selecao ( ' || pls_tipos_ocor_pck.enter_w ||
								'		null, null, conta.nr_sequencia, ' || pls_tipos_ocor_pck.enter_w ||
								'		:nr_id_transacao, :ie_filtro_excecao, ' || pls_tipos_ocor_pck.enter_w ||
								'		:nr_seq_filtro, :ie_regra_excecao, ''F'') nr_seq_selecao';

			-- Verificar o tipo de incidncia da regra para identificar os itens a serem buscados.

			-- Procedimento
			if (ie_incidencia_regra_p = 'P') then

				dados_restricao_w.ds_campos_sql :=	',' || pls_tipos_ocor_pck.enter_w ||
									'	pls_tipos_ocor_pck.obter_sequencia_selecao ( ' || pls_tipos_ocor_pck.enter_w ||
									'		proc.nr_sequencia, null, conta.nr_sequencia, ' || pls_tipos_ocor_pck.enter_w ||
									'		:nr_id_transacao, :ie_filtro_excecao, ' || pls_tipos_ocor_pck.enter_w ||
									'		:nr_seq_filtro, :ie_regra_excecao, ''F'') nr_seq_selecao';
			-- Material
			elsif (ie_incidencia_regra_p = 'M') then

				dados_restricao_w.ds_campos_sql :=	',' || pls_tipos_ocor_pck.enter_w ||
									'	pls_tipos_ocor_pck.obter_sequencia_selecao ( ' || pls_tipos_ocor_pck.enter_w ||
									'		null, mat.nr_sequencia, conta.nr_sequencia, ' || pls_tipos_ocor_pck.enter_w ||
									'		:nr_id_transacao, :ie_filtro_excecao, ' || pls_tipos_ocor_pck.enter_w ||
									'		:nr_seq_filtro, :ie_regra_excecao, ''F'') nr_seq_selecao';
			-- Ambos.
			elsif (ie_incidencia_regra_p = 'PM' or ie_incidencia_regra_p = 'RV') then

				-- Prodedimento est selecionado por primeiro na montagem do select padro.
				dados_restricao_w.ds_campos_sql :=	',' || pls_tipos_ocor_pck.enter_w ||
									'	pls_tipos_ocor_pck.obter_sequencia_selecao ( ' || pls_tipos_ocor_pck.enter_w ||
									'		proc.nr_sequencia, null, conta.nr_sequencia, ' || pls_tipos_ocor_pck.enter_w ||
									'		:nr_id_transacao, :ie_filtro_excecao, ' || pls_tipos_ocor_pck.enter_w ||
									'		:nr_seq_filtro, :ie_regra_excecao, ''F'') nr_seq_selecao';
				-- Materiais esto aps o union no select padro
				dados_restricao_w.ds_campos_union :=	',' || pls_tipos_ocor_pck.enter_w ||
									'	pls_tipos_ocor_pck.obter_sequencia_selecao ( ' || pls_tipos_ocor_pck.enter_w ||
									'		null, mat.nr_sequencia, conta.nr_sequencia, ' || pls_tipos_ocor_pck.enter_w ||
									'		:nr_id_transacao, :ie_filtro_excecao, ' || pls_tipos_ocor_pck.enter_w ||
									'		:nr_seq_filtro, :ie_regra_excecao, ''F'') nr_seq_selecao';
			end if;

		-- Quando for para atualizar o valor das BINDS.
		elsif (ie_opcao_p = 'BINDS') then

			dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_filtro', dados_filtro_p.nr_sequencia);
			dbms_sql.bind_variable(nr_cursor_p, ':ie_filtro_excecao', dados_filtro_p.ie_excecao);
			dbms_sql.bind_variable(nr_cursor_p, ':ie_regra_excecao', dados_regra_p.ie_excecao);
			dbms_sql.bind_variable(nr_cursor_p, ':nr_id_transacao', nr_id_transacao_p);
		end if;
	end if;

	-- Liberao de Ocorrncias X Guia XML

	-- Sempre que for importao do XML ou digitao de contas pelo portal, deve ser verificado se no existe liberao para ocorrncia para a guia.
	if	((dados_forma_geracao_ocor_p.ie_evento = 'IMP') or (dados_forma_geracao_ocor_p.ie_evento = 'PW' and dados_forma_geracao_ocor_p.ie_portal_web = 'CG')) then

		if (ie_opcao_p = 'RESTRICAO') then

			dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
								'and	not exists(	select	1 ' || pls_tipos_ocor_pck.enter_w ||
								'			from	pls_guia_lib_ocor_web lib_guia ' || pls_tipos_ocor_pck.enter_w ||
								'			where	lib_guia.nr_seq_guia = conta.nr_seq_guia ' || pls_tipos_ocor_pck.enter_w ||
								'			and	lib_guia.nr_seq_ocorrencia = :nr_seq_ocorrencia ' || pls_tipos_ocor_pck.enter_w ||
								'			and	lib_guia.dt_inicio_vigencia <= sysdate ' || pls_tipos_ocor_pck.enter_w ||
								'			and	(lib_guia.dt_fim_vigencia is null or lib_guia.dt_fim_vigencia >= sysdate) ' || pls_tipos_ocor_pck.enter_w ||
								'		) ';
		else
			dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_ocorrencia', dados_regra_p.nr_seq_ocorrencia);
		end if;
	end if;

	if (ie_obter_total_reg_p = 'S') then
		
		qt_filtro_conta_w := 0;
	else
		qt_filtro_conta_w := qt_registro_selecao_p;
	end if;
	
	-- se j existir registro na tabela de seleo, coloca um exists
	if (qt_filtro_conta_w > 0) then

		-- Quando for para montar a restrio.
		if (ie_opcao_p = 'RESTRICAO') then
			
			if (ie_incidencia_regra_p in ('C','P','M')) then
				-- monta a restrio para verificar se a conta se encaixou nos filtros da regra.
				dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
									'and	exists		(select	1 ' || pls_tipos_ocor_pck.enter_w ||
									'			from	pls_oc_cta_selecao_ocor_v x' || pls_tipos_ocor_pck.enter_w ||
									'			where	x.nr_id_transacao = :nr_id_transacao_exists' || pls_tipos_ocor_pck.enter_w ||
									'			and	x.nr_seq_conta = conta.nr_sequencia';
				
				-- Quando a regra for de exceo, qualquer filtro dela, de exceo ou no, pode mexer em qualquer outro filtro.
				if (dados_regra_p.ie_excecao = 'N') then

					dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
						'			and	x.ie_valido = ''S'' ';

					-- Se o filtro for de exceo deve ser verificado o campo nr_seq_filtro, por que os registros de execo so vlidos para a regra inteira.

					-- Se o filtro no for um filtro de exceo ento ele s poder alterar os registros dele mesmo.
					if (dados_filtro_p.ie_excecao = 'N') then

						dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
											'			and	x.nr_seq_filtro = :nr_seq_filtro_exists ';
					elsif (dados_filtro_p.ie_excecao = 'S') then

						dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
											'			and	x.ie_excecao = ''S'' ';
					end if;
				else
					-- Se o filtro for de exceo deve ser verificado o campo nr_seq_filtro, por que os registros de execo so vlidos para a regra inteira.

					-- Se o filtro no for um filtro de exceo ento ele s poder alterar os registros dele mesmo.
					if (dados_filtro_p.ie_excecao = 'N') then

						dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
											'			and	x.ie_excecao = ''S'' ';
					elsif (dados_filtro_p.ie_excecao = 'S') then

						dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
											'			and	x.ie_excecao_excecao = ''S'' ';
					end if;
				end if;
				
				-- Verifica se procedimento/material  o mesmo. evitando  gerar ocorrencias quando houver o mesmo proc/mat mais de uma vez na mesma conta - OS 702461 Dcio/Joatan
				if (ie_incidencia_regra_p = 'P') then
				
					dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
									'			and	x.nr_seq_conta_proc = proc.nr_sequencia ';
									
				elsif (ie_incidencia_regra_p = 'M') then
				
					dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
									'			and	x.nr_seq_conta_mat = mat.nr_sequencia ';
				end if;
				
				dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || ')';
								
			elsif (ie_incidencia_regra_p in ('PM','RV')) then
				
				-- monta a restrio para verificar se a conta se encaixou nos filtros da regra.
				dados_restricao_w.ds_restricao_proc := dados_restricao_w.ds_restricao_proc || pls_tipos_ocor_pck.enter_w ||
									'and	exists		(select	1 ' || pls_tipos_ocor_pck.enter_w ||
									'			from	pls_oc_cta_selecao_ocor_v x' || pls_tipos_ocor_pck.enter_w ||
									'			where	x.nr_id_transacao = :nr_id_transacao_exists' || pls_tipos_ocor_pck.enter_w ||
									'			and	x.nr_seq_conta = conta.nr_sequencia';
				
				dados_restricao_w.ds_restricao_mat := dados_restricao_w.ds_restricao_mat || pls_tipos_ocor_pck.enter_w ||
									'and	exists		(select	1 ' || pls_tipos_ocor_pck.enter_w ||
									'			from	pls_oc_cta_selecao_ocor_v x' || pls_tipos_ocor_pck.enter_w ||
									'			where	x.nr_id_transacao = :nr_id_transacao_exists' || pls_tipos_ocor_pck.enter_w ||
									'			and	x.nr_seq_conta = conta.nr_sequencia';
				
				-- Quando a regra for de exceo, qualquer filtro dela, de exceo ou no, pode mexer em qualquer outro filtro.
				if (dados_regra_p.ie_excecao = 'N') then

					dados_restricao_w.ds_restricao_proc := dados_restricao_w.ds_restricao_proc || pls_tipos_ocor_pck.enter_w ||
						'			and	x.ie_valido = ''S'' ';
						
					dados_restricao_w.ds_restricao_mat := dados_restricao_w.ds_restricao_mat || pls_tipos_ocor_pck.enter_w ||
						'			and	x.ie_valido = ''S'' ';

					-- Se o filtro for de exceo deve ser verificado o campo nr_seq_filtro, por que os registros de execo so vlidos para a regra inteira.

					-- Se o filtro no for um filtro de exceo ento ele s poder alterar os registros dele mesmo.
					if (dados_filtro_p.ie_excecao = 'N') then

						dados_restricao_w.ds_restricao_proc := dados_restricao_w.ds_restricao_proc || pls_tipos_ocor_pck.enter_w ||
											'			and	x.nr_seq_filtro = :nr_seq_filtro_exists ';
											
						dados_restricao_w.ds_restricao_mat := dados_restricao_w.ds_restricao_mat || pls_tipos_ocor_pck.enter_w ||
											'			and	x.nr_seq_filtro = :nr_seq_filtro_exists ';
					elsif (dados_filtro_p.ie_excecao = 'S') then

						dados_restricao_w.ds_restricao_proc := dados_restricao_w.ds_restricao_proc || pls_tipos_ocor_pck.enter_w ||
											'			and	x.ie_excecao = ''S'' ';
						
						dados_restricao_w.ds_restricao_mat := dados_restricao_w.ds_restricao_mat || pls_tipos_ocor_pck.enter_w ||				
											'			and	x.ie_excecao = ''S'' ';
					end if;
				else
					-- Se o filtro for de exceo deve ser verificado o campo nr_seq_filtro, por que os registros de execo so vlidos para a regra inteira.

					-- Se o filtro no for um filtro de exceo ento ele s poder alterar os registros dele mesmo.
					if (dados_filtro_p.ie_excecao = 'N') then

						dados_restricao_w.ds_restricao_proc := dados_restricao_w.ds_restricao_proc || pls_tipos_ocor_pck.enter_w ||
											'			and	x.ie_excecao = ''S'' ';
											
						dados_restricao_w.ds_restricao_mat := dados_restricao_w.ds_restricao_mat || pls_tipos_ocor_pck.enter_w ||				
											'			and	x.ie_excecao = ''S'' ';
					elsif (dados_filtro_p.ie_excecao = 'S') then

						dados_restricao_w.ds_restricao_proc := dados_restricao_w.ds_restricao_proc || pls_tipos_ocor_pck.enter_w ||
											'			and	x.ie_excecao_excecao = ''S'' ';
											
						dados_restricao_w.ds_restricao_mat := dados_restricao_w.ds_restricao_mat || pls_tipos_ocor_pck.enter_w ||
											'			and	x.ie_excecao_excecao = ''S'' ';
					end if;
				end if;
				
				dados_restricao_w.ds_restricao_proc := dados_restricao_w.ds_restricao_proc || pls_tipos_ocor_pck.enter_w ||
								'			and	x.nr_seq_conta_proc = proc.nr_sequencia) ';
								
				dados_restricao_w.ds_restricao_mat := dados_restricao_w.ds_restricao_mat || pls_tipos_ocor_pck.enter_w ||
								'			and	x.nr_seq_conta_mat = mat.nr_sequencia) ';
											
			end if;

			
		-- Quando for para atualizar os BINDS.
		elsif (ie_opcao_p = 'BINDS') then

			--atualizar as binds se existir filtro de conta
			dbms_sql.bind_variable(nr_cursor_p, ':nr_id_transacao_exists', nr_id_transacao_p);

			-- Quando a regra for de exceo, qualquer filtro dela, de exceo ou no, pode mexer em qualquer outro filtro.
			if (dados_regra_p.ie_excecao = 'N') then

				-- Se for um filtro de exceo ir olhar todas as contas que esto na seleo pois a exceo vale para a regra inteira.

				-- Se nao deve valer apenas os registros que foram selecionados neste filtro e que esto vlidos.
				if (dados_filtro_p.ie_excecao = 'N') then

					dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_filtro_exists', dados_filtro_p.nr_sequencia);
				end if;
			end if;
		end if;
	end if;

	-- Se for infromado o lote da funo OPS - Produo - Processo contas mdicas ento busca apenas as contas que estiverem no lote.
	if (dados_consistencia_p.nr_seq_lote_processo IS NOT NULL AND dados_consistencia_p.nr_seq_lote_processo::text <> '') then

		if (ie_opcao_p = 'RESTRICAO') then

			dados_restricao_w.ds_restricao_conta :=	dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
								'and     exists (select 1 ' || pls_tipos_ocor_pck.enter_w ||
								'		from   pls_cta_lote_proc_conta processo ' || pls_tipos_ocor_pck.enter_w ||
								'		where  processo.nr_seq_lote_processo = :nr_seq_lote_processo ' || pls_tipos_ocor_pck.enter_w ||
								'		and    processo.nr_seq_conta = conta.nr_sequencia)';
		elsif (ie_opcao_p = 'BINDS') then

			dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_lote_processo', dados_consistencia_p.nr_seq_lote_processo);
		end if;
	end if;

	-- Verifica a data de incio e fim de vigncia

	-- se ambas forem informadas faz um between, seno testa pelo maior ou menor logo abaixo no else
	if (dados_regra_p.dt_inicio_vigencia IS NOT NULL AND dados_regra_p.dt_inicio_vigencia::text <> '' AND dados_regra_p.dt_fim_vigencia IS NOT NULL AND dados_regra_p.dt_fim_vigencia::text <> '') then

		if (ie_opcao_p = 'RESTRICAO') then
			-- A data de atendimento da conta deve ser maior ou igual a data de incio de vigncia da regra
			dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
							'and	conta.dt_atendimento between :dt_inicio_vigencia and fim_dia(:dt_fim_vigencia) ';
		else
			dbms_sql.bind_variable(nr_cursor_p, ':dt_inicio_vigencia', dados_regra_p.dt_inicio_vigencia);
			dbms_sql.bind_variable(nr_cursor_p, ':dt_fim_vigencia', dados_regra_p.dt_fim_vigencia);
		end if;
	else
		if (dados_regra_p.dt_inicio_vigencia IS NOT NULL AND dados_regra_p.dt_inicio_vigencia::text <> '') then
			-- Aqui verifica se  para montar a restrio ou atualizar o valor das binds.
			if (ie_opcao_p = 'RESTRICAO') then
				-- A data de atendimento da conta deve ser maior ou igual a data de incio de vigncia da regra
				dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
								'and	conta.dt_atendimento >= :dt_inicio_vigencia ';
			else
				dbms_sql.bind_variable(nr_cursor_p, ':dt_inicio_vigencia', dados_regra_p.dt_inicio_vigencia);
			end if;
		end if;
		if (dados_regra_p.dt_fim_vigencia IS NOT NULL AND dados_regra_p.dt_fim_vigencia::text <> '') then
			-- Aqui verifica se  para montar a restrio ou atualizar o valor das binds.
			if (ie_opcao_p = 'RESTRICAO') then
				-- A data de atendimento da conta deve ser maior ou igual a data de incio de vigncia da regra
				dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w ||
								'and	conta.dt_atendimento <= fim_dia(:dt_fim_vigencia) ';
			else
				dbms_sql.bind_variable(nr_cursor_p, ':dt_fim_vigencia', dados_regra_p.dt_fim_vigencia);
			end if;
		end if;
	end if;

	-- Se for para filtrar por estabelecimento ser verificado o estabelecimento do protocolo apenas.
	if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then

		if (ie_opcao_p = 'RESTRICAO') then

			dados_restricao_w.ds_restricao_protocolo := dados_restricao_w.ds_restricao_protocolo || pls_tipos_ocor_pck.enter_w || 'and 	prot.cd_estabelecimento = :cd_estabelecimento';
		elsif (ie_opcao_p = 'BINDS') then

			dbms_sql.bind_variable(nr_cursor_p, ':cd_estabelecimento', cd_estabelecimento_p);
		end if;
	end if;

	-- Se houver nmero do lote informado buscar os protocolos do lote.
	if (dados_consistencia_p.nr_seq_lote IS NOT NULL AND dados_consistencia_p.nr_seq_lote::text <> '') then
		if (ie_opcao_p = 'RESTRICAO') then

			dados_restricao_w.ds_restricao_lote := dados_restricao_w.ds_restricao_lote || pls_tipos_ocor_pck.enter_w || 'and	prot.nr_seq_lote_conta = :nr_seq_lote_conta';
		elsif (ie_opcao_p = 'BINDS') then

			dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_lote_conta', dados_consistencia_p.nr_seq_lote);
		end if;
	end if;
	-- Se houver protocolo informado buscar apenas aquele protocolo.
	if (dados_consistencia_p.nr_seq_protocolo IS NOT NULL AND dados_consistencia_p.nr_seq_protocolo::text <> '') then
		if (ie_opcao_p = 'RESTRICAO') then

			dados_restricao_w.ds_restricao_protocolo := dados_restricao_w.ds_restricao_protocolo || pls_tipos_ocor_pck.enter_w || 'and	prot.nr_sequencia = :nr_seq_protocolo';
		elsif (ie_opcao_p = 'BINDS') then

			dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_protocolo', dados_consistencia_p.nr_seq_protocolo);
		end if;
	end if;
	-- Se houver conta informada s ir consistir a conta e seus itens.
	if (dados_consistencia_p.nr_seq_conta IS NOT NULL AND dados_consistencia_p.nr_seq_conta::text <> '') then
		if (ie_opcao_p = 'RESTRICAO') then

			dados_restricao_w.ds_restricao_conta := dados_restricao_w.ds_restricao_conta || pls_tipos_ocor_pck.enter_w || 'and	conta.nr_sequencia = :nr_seq_conta';
		elsif (ie_opcao_p = 'BINDS') then

			dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_conta', dados_consistencia_p.nr_seq_conta);
		end if;
	end if;
	-- Sempre que houver os itens informados deve ser verificado se a incidncia da regra  para itens, pois se no teremos problemas na hora de buscar os dados para popular a atabela de seleo.
	if (ie_incidencia_regra_p in ('P', 'M', 'PM')) then

		-- S ir verificar se  para verificar um nico procedimento quando a incidncia da regra permitir trabalhar com itens.

		-- Somente Procedimento e Procedimento ou Material
		if (ie_incidencia_regra_p in ('P', 'PM')) then
			-- Se for informado o proceidmento ento ir consistir somente aquele procedimento. Comum nos itens da anlise durante a execuo de aes como aceite ou ajuste de valores.
			if (dados_consistencia_p.nr_seq_conta_proc IS NOT NULL AND dados_consistencia_p.nr_seq_conta_proc::text <> '') then
				if (ie_opcao_p = 'RESTRICAO') then

					dados_restricao_w.ds_restricao_proc := dados_restricao_w.ds_restricao_proc || pls_tipos_ocor_pck.enter_w || 'and	proc.nr_sequencia = :nr_seq_conta_proc';
				elsif (ie_opcao_p = 'BINDS') then

					dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_conta_proc', dados_consistencia_p.nr_seq_conta_proc);
				end if;
			end if;
		end if;

		-- S ir verificar se  para verificar um nico material quando a incidncia da regra permitir trabalhar com itens.

		-- Somente Material e Procedimento ou Material.
		if (ie_incidencia_regra_p in ('M', 'PM')) then
			-- Se for informado o material ento ir consistir somente aquele material. Comum nos itens da anlise durante a execuo de aes como aceite ou ajuste de valores.
			if (dados_consistencia_p.nr_seq_conta_mat IS NOT NULL AND dados_consistencia_p.nr_seq_conta_mat::text <> '') then
				if (ie_opcao_p = 'RESTRICAO') then

					dados_restricao_w.ds_restricao_mat := dados_restricao_w.ds_restricao_mat || pls_tipos_ocor_pck.enter_w || 'and	mat.nr_sequencia = :nr_seq_conta_mat';
				elsif (ie_opcao_p = 'BINDS') then

					dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_conta_mat', dados_consistencia_p.nr_seq_conta_mat);
				end if;
			end if;
		end if;
	end if;
	
end if;

return dados_restricao_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_oc_cta_obter_restr_padrao ( ie_opcao_p text, dados_consistencia_p pls_tipos_ocor_pck.dados_consistencia, nr_id_transacao_p pls_oc_cta_selecao_ocor_v.nr_id_transacao%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, ie_incidencia_regra_p text, nr_cursor_p integer, dados_filtro_p pls_tipos_ocor_pck.dados_filtro, dados_forma_geracao_ocor_p pls_tipos_ocor_pck.dados_forma_geracao_ocor, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_por_array_p text default 'N', ie_obter_total_reg_p text default 'N', qt_registro_selecao_p integer default 0) FROM PUBLIC;

