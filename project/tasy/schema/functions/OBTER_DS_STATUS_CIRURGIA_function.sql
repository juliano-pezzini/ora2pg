-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ds_status_cirurgia ( nr_cirurgia_p bigint ) RETURNS varchar AS $body$
DECLARE


    ds_retorno_w                  varchar(255);
    nr_cirurgia_descricao_w       cirurgia_descricao.nr_cirurgia%TYPE := NULL;
    dt_liberacao_descricao_w      cirurgia_descricao.dt_liberacao%TYPE := NULL;
    nr_cirurgia_participante_w    cirurgia_participante.nr_cirurgia%TYPE := NULL;
    dt_liberacao_participante_w   cirurgia_participante.dt_liberacao%TYPE := NULL;
    nr_prescricao_procedimento_w  prescr_procedimento.nr_prescricao%TYPE := NULL;

    c01 CURSOR FOR
    SELECT
        a.dt_liberacao,
        a.nr_cirurgia
    FROM
        cirurgia_participante a
    WHERE
            a.nr_cirurgia = nr_cirurgia_p 
    ORDER BY
        a.dt_atualizacao DESC LIMIT 1;

    c02 CURSOR FOR
    SELECT
        b.nr_prescricao
    FROM
             prescr_procedimento b
        JOIN cirurgia c ON b.nr_prescricao = c.nr_prescricao
    WHERE
            c.nr_cirurgia = nr_cirurgia_p
    ORDER BY
        b.dt_atualizacao DESC LIMIT 1;

    c03 CURSOR FOR
    SELECT
        d.nr_cirurgia,
        d.dt_liberacao
    FROM
        cirurgia_descricao d
    WHERE
            d.nr_cirurgia = nr_cirurgia_p
    ORDER BY
        d.dt_atualizacao DESC LIMIT 1;


BEGIN
    OPEN c01;
    FETCH c01 INTO
        dt_liberacao_participante_w,
        nr_cirurgia_participante_w;
    CLOSE c01;

    OPEN c02;
    FETCH c02 INTO nr_prescricao_procedimento_w;
    CLOSE c02;

    OPEN c03;
    FETCH c03 INTO
        nr_cirurgia_descricao_w,
        dt_liberacao_descricao_w;
    CLOSE c03;

    IF ( (nr_cirurgia_descricao_w IS NOT NULL AND nr_cirurgia_descricao_w::text <> '') OR (nr_cirurgia_participante_w IS NOT NULL AND nr_cirurgia_participante_w::text <> '') OR coalesce(nr_prescricao_procedimento_w::text, '') = '' ) THEN
        ds_retorno_w := obter_desc_expressao(312354); --Aberto
    END IF;

    IF (
        (nr_cirurgia_descricao_w IS NOT NULL AND nr_cirurgia_descricao_w::text <> '')
        AND (dt_liberacao_descricao_w IS NOT NULL AND dt_liberacao_descricao_w::text <> '')
        AND (nr_cirurgia_participante_w IS NOT NULL AND nr_cirurgia_participante_w::text <> '')
        AND (dt_liberacao_participante_w IS NOT NULL AND dt_liberacao_participante_w::text <> '')
        AND (nr_prescricao_procedimento_w IS NOT NULL AND nr_prescricao_procedimento_w::text <> '')
    ) THEN
        ds_retorno_w := obter_desc_expressao(290046); --Fechado
    END IF;

    IF (
        coalesce(nr_cirurgia_descricao_w::text, '') = ''
        AND coalesce(dt_liberacao_descricao_w::text, '') = ''
        AND coalesce(nr_cirurgia_participante_w::text, '') = ''
        AND coalesce(dt_liberacao_participante_w::text, '') = ''
        AND coalesce(nr_prescricao_procedimento_w::text, '') = ''
    ) THEN
        ds_retorno_w := obter_desc_expressao(305327); --Novo
    END IF;

    IF ( coalesce(ds_retorno_w::text, '') = '' ) THEN
        ds_retorno_w := obter_desc_expressao(305327); --Novo
    END IF;

    RETURN ds_retorno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ds_status_cirurgia ( nr_cirurgia_p bigint ) FROM PUBLIC;

