-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_taxa_adicional ( nr_prescricao_p prescr_solucao_evento.nr_prescricao%type, nr_seq_solucao_p prescr_solucao_evento.nr_seq_solucao%type, qt_dosagem_p prescr_solucao_evento.qt_dosagem%type, ie_tipo_dosagem_p prescr_solucao_evento.ie_tipo_dosagem%type ) RETURNS varchar AS $body$
DECLARE


  ds_retorno_w		        varchar(1);
  dt_idade_min_w          timestamp;
  dt_idade_pac_w          timestamp;
  qt_min_dosagem_w        route_adm_additional_fee.qt_min_dosagem%type;
  ie_min_tipo_dosagem_w   route_adm_additional_fee.ie_min_tipo_dosagem%type;
  ie_via_aplicacao_w      prescr_material.ie_via_aplicacao%type;
  si_precise_cont_intravenous_w material.si_precise_cont_intravenous%type;

  c01 CURSOR FOR
  SELECT coalesce(a.si_precise_cont_intravenous, 'N'),
          b.ie_via_aplicacao
  from  material a,
        prescr_material b
  where a.cd_material = b.cd_material	
  and b.nr_sequencia_solucao	= nr_seq_solucao_p
  and	b.nr_prescricao		= nr_prescricao_p;

  c02 CURSOR FOR
  SELECT add_months(dt_idade_pac_w, (coalesce(qt_idade_min, 0) * 12) + coalesce(qt_idade_min_mes, 0)) + coalesce(qt_idade_min_dia,0),
        qt_min_dosagem,
        ie_min_tipo_dosagem
  from  route_adm_additional_fee
  where ie_via_aplicacao = ie_via_aplicacao_w;


BEGIN
  ds_retorno_w := 'N';
  select min(b.dt_nascimento)
  into STRICT dt_idade_pac_w
  from prescr_medica a,
        pessoa_fisica b
  where a.cd_pessoa_fisica = b.cd_pessoa_fisica
  and   nr_prescricao = nr_prescricao_p;

  open c01;
	loop
	fetch c01 into	si_precise_cont_intravenous_w,
                  ie_via_aplicacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
      if (si_precise_cont_intravenous_w = 'S') then
        open c02;
        loop
        fetch c02 into	dt_idade_min_w,
                        qt_min_dosagem_w,
                        ie_min_tipo_dosagem_w;
        EXIT WHEN NOT FOUND; /* apply on c02 */
          begin
            if (dt_idade_min_w > clock_timestamp()) then
              if (converte_vel_infusao(ie_tipo_dosagem_p, ie_min_tipo_dosagem_w, qt_dosagem_p) < qt_min_dosagem_w) then
                ds_retorno_w := 'S';
              end if;

            end if;
          end;
        end loop;
        close c02;
      end if;
		end;
	end loop;
	close c01;
return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_taxa_adicional ( nr_prescricao_p prescr_solucao_evento.nr_prescricao%type, nr_seq_solucao_p prescr_solucao_evento.nr_seq_solucao%type, qt_dosagem_p prescr_solucao_evento.qt_dosagem%type, ie_tipo_dosagem_p prescr_solucao_evento.ie_tipo_dosagem%type ) FROM PUBLIC;

