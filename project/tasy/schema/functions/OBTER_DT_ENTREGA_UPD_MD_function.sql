-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dt_entrega_upd_md ( dt_entrada_p timestamp, ds_hora_fixa_p text, qt_dia_entrega_entrada_p bigint, qt_min_entrega_p bigint, ie_dia_semana_final_p bigint, dt_prescricao_p timestamp, qt_dia_entrega_coleta_p bigint, dt_coleta_p timestamp, ie_retorno_p bigint ) RETURNS timestamp AS $body$
DECLARE

    dt_entrega_upd_w     timestamp;
    ie_dia_semana_upd_w  smallint;
    qt_min_entrega_w     double precision;

BEGIN
    if qt_min_entrega_p = 0 then
      qt_min_entrega_w := 0;
    else
      qt_min_entrega_w := dividir_md(qt_min_entrega_p, 1440);
    end if;

    IF ( ie_retorno_p = 1 ) THEN

        dt_entrega_upd_w := (
                             (trunc(dt_entrada_p) + (dividir_md(ds_hora_fixa_p , 24))) +
                             coalesce(qt_dia_entrega_entrada_p, 0) +
                             qt_min_entrega_w
                            );

        IF ( ie_dia_semana_final_p > 0 ) THEN

            ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);

            WHILE( ie_dia_semana_upd_w <> ie_dia_semana_final_p ) LOOP
                dt_entrega_upd_w := dt_entrega_upd_w + 1;
                SELECT
                    pkg_date_utils.get_weekday(dt_entrega_upd_w)
                INTO STRICT ie_dia_semana_upd_w
;

                ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);

            END LOOP;

        END IF;

        IF ( dt_prescricao_p > dt_entrega_upd_w ) THEN
            dt_entrega_upd_w := dt_entrega_upd_w + 1;
        END IF;
    END IF;

    IF ( ie_retorno_p = 2 ) THEN

       dt_entrega_upd_w := dt_entrada_p + coalesce(qt_dia_entrega_entrada_p, 0) + qt_min_entrega_w;

        IF ( ie_dia_semana_final_p > 0 ) THEN
            SELECT
                pkg_date_utils.get_weekday(dt_entrega_upd_w)
            INTO STRICT ie_dia_semana_upd_w
;

            WHILE( ie_dia_semana_upd_w <> ie_dia_semana_final_p ) LOOP
                dt_entrega_upd_w := dt_entrega_upd_w + 1;

                ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);
            END LOOP;

        END IF;

    END IF;

    IF ( ie_retorno_p = 3 ) THEN

        dt_entrega_upd_w := (trunc(dt_coleta_p) + (dividir_md(ds_hora_fixa_p , 24))) +
                             coalesce(qt_dia_entrega_coleta_p, 0) +
                             qt_min_entrega_w;

        IF ( ie_dia_semana_final_p > 0 ) THEN

            ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);
            WHILE( ie_dia_semana_upd_w <> ie_dia_semana_final_p ) LOOP
                dt_entrega_upd_w := dt_entrega_upd_w + 1;

                ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);

            END LOOP;

        END IF;

        IF ( dt_prescricao_p > dt_entrega_upd_w ) THEN
            dt_entrega_upd_w := dt_entrega_upd_w + 1;
        END IF;
    END IF;

    IF ( ie_retorno_p = 4 ) THEN
        
        dt_entrega_upd_w := dt_coleta_p + coalesce(qt_dia_entrega_coleta_p, 0) + qt_min_entrega_w;

        IF ( ie_dia_semana_final_p > 0 ) THEN
            ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);
            WHILE( ie_dia_semana_upd_w <> ie_dia_semana_final_p ) LOOP
                dt_entrega_upd_w := dt_entrega_upd_w + 1;
                ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);

            END LOOP;

        END IF;

    END IF;

    IF ( ie_retorno_p = 5 ) THEN

        dt_entrega_upd_w := (
                             (trunc(dt_entrada_p) + (dividir_md(ds_hora_fixa_p , 24))) +
                             coalesce(qt_dia_entrega_entrada_p, 0) +
                             qt_min_entrega_w
                             );

        IF ( ie_dia_semana_final_p > 0 ) THEN
            ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);
            WHILE( ie_dia_semana_upd_w <> ie_dia_semana_final_p ) LOOP
                dt_entrega_upd_w := dt_entrega_upd_w + 1;
                ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);

            END LOOP;

        END IF;

        IF ( dt_prescricao_p > dt_entrega_upd_w ) THEN
            dt_entrega_upd_w := dt_entrega_upd_w + 1;
        END IF;
    END IF;

    IF ( ie_retorno_p = 6 ) THEN

        dt_entrega_upd_w := dt_entrada_p + coalesce(qt_dia_entrega_entrada_p, 0) + qt_min_entrega_w;

        IF ( ie_dia_semana_final_p > 0 ) THEN

            ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);

            WHILE( ie_dia_semana_upd_w <> ie_dia_semana_final_p ) LOOP

                ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);

            END LOOP;

        END IF;

    END IF;

    IF ( ie_retorno_p = 7 ) THEN

        dt_entrega_upd_w := (trunc(dt_coleta_p) + (dividir_md(ds_hora_fixa_p , 24))) +
                             coalesce(qt_dia_entrega_coleta_p, 0) +
                             qt_min_entrega_w;

        IF ( ie_dia_semana_final_p > 0 ) THEN
            ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);
            WHILE( ie_dia_semana_upd_w <> ie_dia_semana_final_p ) LOOP
                dt_entrega_upd_w := dt_entrega_upd_w + 1;
                ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);
            END LOOP;
        END IF;

        IF ( dt_prescricao_p > dt_entrega_upd_w ) THEN
            dt_entrega_upd_w := dt_entrega_upd_w + 1;
        END IF;
    END IF;

    IF ( ie_retorno_p = 8 ) THEN
        dt_entrega_upd_w := dt_coleta_p + coalesce(qt_dia_entrega_coleta_p, 0) + qt_min_entrega_w;
        IF ( ie_dia_semana_final_p > 0 ) THEN
            ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);
            WHILE( ie_dia_semana_upd_w <> ie_dia_semana_final_p ) LOOP
                dt_entrega_upd_w := dt_entrega_upd_w + 1;
                ie_dia_semana_upd_w := pkg_date_utils.get_weekday(dt_entrega_upd_w);

            END LOOP;

        END IF;

    END IF;

    RETURN dt_entrega_upd_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dt_entrega_upd_md ( dt_entrada_p timestamp, ds_hora_fixa_p text, qt_dia_entrega_entrada_p bigint, qt_min_entrega_p bigint, ie_dia_semana_final_p bigint, dt_prescricao_p timestamp, qt_dia_entrega_coleta_p bigint, dt_coleta_p timestamp, ie_retorno_p bigint ) FROM PUBLIC;

