-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_permite_qt_req_dia ( nr_requisicao_p bigint) RETURNS varchar AS $body$
DECLARE


cd_estabelecimento_w		bigint;
cd_local_estoque_w		bigint;
cd_centro_custo_w			bigint;
cd_operacao_estoque_w		bigint;
cd_local_estoque_destino_w		bigint;
dt_solicitacao_requisicao_w		timestamp;
cd_grupo_material_w		bigint;
cd_subgrupo_material_w		bigint;
cd_classe_material_w		bigint;
cd_material_w			bigint;
ie_urgente_w			varchar(1);
cd_unidade_medida_w		varchar(30);
cd_setor_atendimento_w		bigint;
qt_requisicao_dia_w		bigint;
qt_registro_w			bigint;
ds_retorno_w			varchar(1) := 'S';


cd_estabelecimento_ww		bigint;
cd_operacao_estoque_ww		bigint;
cd_centro_custo_ww		bigint;
cd_local_estoque_ww		bigint;
cd_local_estoque_destino_ww	bigint;
cd_setor_entrega_ww		bigint;
cd_grupo_material_ww		bigint;
cd_subgrupo_material_ww		bigint;
cd_classe_material_ww		bigint;
cd_material_ww			bigint;

c01 CURSOR FOR
SELECT	a.cd_estabelecimento,
	a.cd_local_estoque,
	a.cd_centro_custo,
	a.cd_operacao_estoque,
	a.cd_local_estoque_destino,
	a.dt_solicitacao_requisicao,
	a.cd_setor_entrega,
	e.cd_grupo_material,
	e.cd_subgrupo_material,
	e.cd_classe_material,
	b.cd_material
from	requisicao_material a,
	item_requisicao_material b,
	estrutura_material_v e
where	a.nr_requisicao = b.nr_requisicao
and	b.cd_material = e.cd_material
and	a.nr_requisicao = nr_requisicao_p;

c02 CURSOR FOR
SELECT	qt_requisicao_dia,
	cd_estabelecimento,
	cd_operacao_estoque,
	cd_centro_custo,
	cd_local_estoque,
	cd_local_estoque_destino,
	cd_setor_entrega,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_material
from	regra_req_permissao_qtde
where	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_w,0))			= coalesce(cd_estabelecimento_w,0)
and	coalesce(cd_operacao_estoque, cd_operacao_estoque_w)			= cd_operacao_estoque_w
and	coalesce(cd_centro_custo, coalesce(cd_centro_custo_w, 0))				= coalesce(cd_centro_custo_w, 0)
and	coalesce(cd_local_estoque, cd_local_estoque_w)				= cd_local_estoque_w
and	coalesce(cd_local_estoque_destino, coalesce(cd_local_estoque_destino_w,0))		= coalesce(cd_local_estoque_destino_w,0)
and	coalesce(cd_setor_entrega, coalesce(cd_setor_atendimento_w,0))			= coalesce(cd_setor_atendimento_w,0)
and	coalesce(cd_grupo_material, cd_grupo_material_w) 				= cd_grupo_material_w
and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)			= cd_subgrupo_material_w
and	coalesce(cd_classe_material, cd_classe_material_w) 				= cd_classe_material_w
and	coalesce(cd_material, cd_material_w)		 			= cd_material_w
and	coalesce(ie_requisicao_manual,'S')						= 'S'
order by	coalesce(cd_material,0),
	coalesce(cd_classe_material,0),
	coalesce(cd_subgrupo_material,0),
	coalesce(cd_grupo_material,0);

BEGIN

open C01;
loop
fetch C01 into
	cd_estabelecimento_w,
	cd_local_estoque_w,
	cd_centro_custo_w,
	cd_operacao_estoque_w,
	cd_local_estoque_destino_w,
	dt_solicitacao_requisicao_w,
	cd_setor_atendimento_w,
	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	open C02;
	loop
	fetch C02 into
		qt_requisicao_dia_w,
		cd_estabelecimento_ww,
		cd_operacao_estoque_ww,
		cd_centro_custo_ww,
		cd_local_estoque_ww,
		cd_local_estoque_destino_ww,
		cd_setor_entrega_ww,
		cd_grupo_material_ww,
		cd_subgrupo_material_ww,
		cd_classe_material_ww,
		cd_material_ww;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		select	count(*)
		into STRICT	qt_registro_w
		from	requisicao_material a,
			item_requisicao_material b,
			estrutura_material_v e
		where	a.nr_requisicao = b.nr_requisicao
		and	b.cd_material = e.cd_material
		and	trunc(a.dt_solicitacao_requisicao,'dd') = trunc(clock_timestamp(),'dd')
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and	((coalesce(cd_estabelecimento_w::text, '') = '') or (coalesce(cd_estabelecimento_ww::text, '') = '') or (coalesce(a.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))
		and	((coalesce(cd_operacao_estoque_w::text, '') = '') or (coalesce(cd_operacao_estoque_ww::text, '') = '') or (coalesce(a.cd_operacao_estoque, cd_operacao_estoque_w) = cd_operacao_estoque_w))
		and	((coalesce(cd_centro_custo_w::text, '') = '') or (coalesce(cd_centro_custo_ww::text, '') = '') or (coalesce(a.cd_centro_custo, cd_centro_custo_w) = cd_centro_custo_w))
		and	((coalesce(cd_local_estoque_w::text, '') = '') or (coalesce(cd_local_estoque_ww::text, '') = '') or (coalesce(a.cd_local_estoque, cd_local_estoque_w)  = cd_local_estoque_w))
		and	((coalesce(cd_local_estoque_destino_w::text, '') = '') or (coalesce(cd_local_estoque_destino_ww::text, '') = '') or (coalesce(a.cd_local_estoque_destino, cd_local_estoque_destino_w) = cd_local_estoque_destino_w))
		and	((coalesce(cd_setor_atendimento_w::text, '') = '') or (coalesce(cd_setor_entrega_ww::text, '') = '') or (coalesce(a.cd_setor_atendimento, cd_setor_atendimento_w) = cd_setor_atendimento_w))
		and	((coalesce(cd_grupo_material_w::text, '') = '') or (coalesce(cd_grupo_material_ww::text, '') = '') or (coalesce(e.cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w))
		and	((coalesce(cd_subgrupo_material_w::text, '') = '') or (coalesce(cd_subgrupo_material_ww::text, '') = '') or (coalesce(e.cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w))
		and	((coalesce(cd_classe_material_w::text, '') = '') or (coalesce(cd_classe_material_ww::text, '') = '') or (coalesce(e.cd_classe_material, cd_classe_material_w) = cd_classe_material_w))
		and	((coalesce(cd_material_w::text, '') = '') or (coalesce(cd_material_ww::text, '') = '') or (coalesce(b.cd_material, cd_material_w) = cd_material_w));

		if (qt_registro_w >= qt_requisicao_dia_w) then
			ds_retorno_w := 'N';
		end if;

		end;
	end loop;
	close C02;

	end;
end loop;
close C01;


return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_permite_qt_req_dia ( nr_requisicao_p bigint) FROM PUBLIC;

