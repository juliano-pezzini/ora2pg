-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_item_contrato_sc (cd_material_p bigint, nr_solic_compra_p bigint, nr_contrato_p bigint, nr_seq_contrato_p bigint) RETURNS varchar AS $body$
DECLARE


qt_registros_w			integer	:= 0;
cd_estabelecimento_w		integer	:= wheb_usuario_pck.get_cd_estabelecimento;
nm_usuario_w			varchar(15)	:= wheb_usuario_pck.get_nm_usuario;
ie_forma_visualizar_w		varchar(1);


BEGIN

select	substr(coalesce(obter_valor_param_usuario(913, 226, Obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w),'S'),1,1)
into STRICT	ie_forma_visualizar_w
;

select	count(*)
into STRICT	qt_registros_w
from(	SELECT	1
	from	solic_compra a,
		solic_compra_item b,
		contrato c,
		contrato_regra_nf f
	where	a.nr_solic_compra = b.nr_solic_compra
	and	b.nr_contrato = c.nr_sequencia
	and	f.nr_seq_contrato = c.nr_sequencia
	and	b.cd_material = cd_material_p
	and	a.nr_solic_compra = nr_solic_compra_p
	and	b.nr_contrato = nr_contrato_p
	and	f.nr_sequencia = nr_seq_contrato_p
	and	((lic_obter_tipo_forma_compra(a.nr_seq_forma_compra) = 'C') or (a.IE_TIPO_SERVICO IS NOT NULL AND a.IE_TIPO_SERVICO::text <> ''))
	and	ie_forma_visualizar_w = 'S'
	
union all

	SELECT	1
	from	contrato_regra_nf f,
		contrato c
	where	f.nr_seq_contrato = c.nr_sequencia
	and	coalesce(f.cd_material, cd_material_p) = cd_material_p
	and	substr(obter_dados_pf_pj(null,c.cd_cgc_contratado,'S'),1,1) = 'A'
	and	((coalesce(f.dt_inicio_vigencia::text, '') = '') or (trunc(f.dt_inicio_vigencia,'dd') <= trunc(clock_timestamp(),'dd')))
	and	((coalesce(f.dt_fim_vigencia::text, '') = '') or (trunc(f.dt_fim_vigencia,'dd') >= trunc(clock_timestamp(),'dd')))
    and (coalesce(f.ie_situacao::text, '') = '' or f.ie_situacao = 'A')
	and	coalesce(cd_pessoa_contratada::text, '') = ''
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	ie_forma_visualizar_w = 'C'
	
union all

	select	1	
	from	contrato_regra_nf f,
		contrato c
	where	f.nr_seq_contrato = c.nr_sequencia
	and	coalesce(f.cd_material, cd_material_p) = cd_material_p
	and	((coalesce(f.dt_inicio_vigencia::text, '') = '') or (trunc(f.dt_inicio_vigencia,'dd') <= trunc(clock_timestamp(),'dd')))
	and	((coalesce(f.dt_fim_vigencia::text, '') = '') or (trunc(f.dt_fim_vigencia,'dd') >= trunc(clock_timestamp(),'dd')))
    and (coalesce(f.ie_situacao::text, '') = '' or f.ie_situacao = 'A')
	and	(cd_pessoa_contratada IS NOT NULL AND cd_pessoa_contratada::text <> '')
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	ie_forma_visualizar_w = 'C');

if (qt_registros_w > 0) then
	return	'S';
else
	return	'N';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_item_contrato_sc (cd_material_p bigint, nr_solic_compra_p bigint, nr_contrato_p bigint, nr_seq_contrato_p bigint) FROM PUBLIC;

