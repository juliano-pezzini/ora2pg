-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_exige_just_material ( cd_material_p bigint, cd_setor_prescr_p bigint, cd_estabelecimento_p bigint, ie_via_aplicacao_p text, nr_prescricao_p bigint, cd_intervalo_p text, ie_se_necessario_p text, ie_agrupador_p bigint ) RETURNS varchar AS $body$
DECLARE

 
cd_pessoa_fisica_w			varchar(30);
cd_prescritor_w				varchar(50);
cd_setor_atendimento_w		integer;
nr_seq_agrupamento_w		bigint;
qt_idade_w					bigint;
qt_idade_dia_w				double precision;
qt_idade_mes_w				double precision;
qt_peso_w					real;
qt_regra					bigint;
ie_exige_justificativa_w	varchar(2);
			

BEGIN 
 
 
 
select	count(*) 
into STRICT	qt_regra 
from	material_prescr 
where	cd_material	= cd_material_p 
and		(((coalesce(ie_tipo_item,'TOD') = 'SOL') and (ie_agrupador_p = 4)) or 
		 ((coalesce(ie_tipo_item,'TOD') = 'OUT') and (ie_agrupador_p <> 4)) or (coalesce(ie_tipo_item,'TOD') = 'TOD'));
 
if (qt_regra > 0) then 
	begin 
	 
	if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then 
 
		select	max(cd_prescritor), 
				max(cd_setor_atendimento), 
				(obter_idade_pf(max(cd_pessoa_fisica), clock_timestamp(), 'A'))::numeric , 
				coalesce(max(qt_peso),0), 
				max(cd_pessoa_fisica) 
		into STRICT	cd_prescritor_w, 
				cd_setor_atendimento_w, 
				qt_idade_w, 
				qt_peso_w, 
				cd_pessoa_fisica_w	 
		from	prescr_medica 
		where	nr_prescricao	= nr_prescricao_p;
		 
		-- obterndo a idade do paciente 
		select	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DI')), 
				max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'MM')) 
		into STRICT	qt_idade_dia_w, 
				qt_idade_mes_w 
		from	pessoa_fisica b 
		where	b.cd_pessoa_fisica	= cd_pessoa_fisica_w;
		 
		select	max(nr_seq_agrupamento) 
		into STRICT	nr_seq_agrupamento_w 
		from	setor_atendimento 
		where	cd_setor_atendimento = cd_setor_atendimento_w;
 
	end if;	
 
	-- Obtendo o valor da regra 
	select	coalesce(max(ie_exige_justificativa),'N') 
	into STRICT	ie_exige_justificativa_w 
	from	material_prescr 
	where	coalesce(cd_setor_atendimento, coalesce( cd_setor_prescr_p,0))	= coalesce( cd_setor_prescr_p,0) 
	and		cd_material		= cd_material_p 
	and		coalesce(cd_estabelecimento, cd_estabelecimento_p ) = cd_estabelecimento_p 
	and		coalesce(cd_setor_atendimento, coalesce( cd_setor_atendimento_w ,0)) = coalesce( cd_setor_atendimento_w,0) 
	and		coalesce(ie_via_aplicacao, coalesce( ie_via_aplicacao_p,0)) = coalesce( ie_via_aplicacao_p,0) 
	and		coalesce(cd_intervalo_filtro, coalesce(cd_intervalo_p,0)) = coalesce(cd_intervalo_p,0) 
	and		coalesce(ie_somente_sn, coalesce(ie_se_necessario_p,0)) = coalesce(ie_se_necessario_p,0) 
	and		qt_idade_dia_w between coalesce(qt_idade_min_dia,0) and coalesce(qt_idade_max_dia,55000) 
	and		qt_idade_mes_w between coalesce(qt_idade_min_mes,0) and coalesce(qt_idade_max_mes,55000) 
	and		((coalesce(nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento = nr_seq_agrupamento_w )) 
	and		coalesce(qt_idade_w,0) between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,999) 
	and		coalesce(qt_peso_w,0) between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999) 
	and		Obter_se_setor_regra_prescr( nr_sequencia, cd_setor_atendimento_w ) = 'S' 
	and		((coalesce(cd_especialidade::text, '') = '') or (obter_se_especialidade_medico( cd_prescritor_w, cd_especialidade ) = 'S')) 
	and		(((coalesce(ie_tipo_item,'TOD') = 'SOL') and (ie_agrupador_p = 4)) or 
			 ((coalesce(ie_tipo_item,'TOD') = 'OUT') and (ie_agrupador_p <> 4)) or (coalesce(ie_tipo_item,'TOD') = 'TOD'));
	--and		nvl(ie_obedecer_limite,'N') = 'S'; 
	--and		qt_limite_pessoa is not null; 
	 
	end;
end if;
	 
return	coalesce( ie_exige_justificativa_w, 'N' );
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_exige_just_material ( cd_material_p bigint, cd_setor_prescr_p bigint, cd_estabelecimento_p bigint, ie_via_aplicacao_p text, nr_prescricao_p bigint, cd_intervalo_p text, ie_se_necessario_p text, ie_agrupador_p bigint ) FROM PUBLIC;

