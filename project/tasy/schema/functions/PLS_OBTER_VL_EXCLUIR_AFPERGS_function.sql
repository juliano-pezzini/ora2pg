-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_vl_excluir_afpergs ( vl_incluir_p bigint, dt_referencia_p timestamp, nr_titulo_p bigint, ie_tipo_item_p text, ie_virgula_p text) RETURNS bigint AS $body$
DECLARE

/*
ie_tipo_item_p
I	= Incluir
E	= Excluir
T	= Se existe alteração no valor da mensalidade
TI	= Total incluir
TE	= Total excluir
VI	= Verifica se existe valor à incluir
VE	= Verifica se existe valor à excluir
*/
ds_retorno_w		double precision := 0;
nr_seq_pagador_w	bigint;
nr_lote_desc_folha_w	bigint;
vl_cobranca_w		double precision;
nr_titulo_w		bigint;
nr_seq_mensalidade_w	bigint;


BEGIN

select	max(a.nr_seq_pagador)
into STRICT	nr_seq_pagador_w
from	pls_mensalidade	a,
	titulo_receber	b
where	b.nr_titulo =  nr_titulo_p
and	b.nr_seq_mensalidade	= a.nr_sequencia;

select	max(a.nr_sequencia),
	max(b.nr_titulo)
into STRICT	nr_seq_mensalidade_w,
	nr_titulo_w
from	pls_mensalidade	a,
	titulo_receber	b
where	a.nr_seq_pagador = nr_seq_pagador_w
and	b.nr_seq_mensalidade	= a.nr_sequencia
and	coalesce(a.ie_cancelamento::text, '') = ''
and	trunc(dt_referencia, 'mm') = trunc(add_months(dt_referencia_p,-1), 'mm');

select	max(a.nr_sequencia)
into STRICT	nr_lote_desc_folha_w
from	cobranca_escritural	a,
	titulo_receber_cobr	b
where	a.nr_sequencia = b.nr_seq_cobranca
and	b.nr_seq_mensalidade = nr_seq_mensalidade_w;

select	max(vl_cobranca)
into STRICT	vl_cobranca_w
from	titulo_receber_cobr
where	nr_seq_cobranca	= nr_lote_desc_folha_w
and	nr_titulo	= nr_titulo_w;

if (ie_tipo_item_p = 'I') then
	if (vl_incluir_p > coalesce(vl_cobranca_w,0)) then
		ds_retorno_w	:= vl_incluir_p - coalesce(vl_cobranca_w,0);
	end if;
elsif (ie_tipo_item_p = 'E') then
	if (vl_incluir_p < coalesce(vl_cobranca_w,0)) then
		ds_retorno_w	:= coalesce(vl_cobranca_w,0) - vl_incluir_p;
	end if;
elsif (ie_tipo_item_p = 'TI') then /* Total incluir */
	ds_retorno_w	:= vl_incluir_p;
elsif (ie_tipo_item_p = 'TE') then /* Total excluir */
	ds_retorno_w	:= vl_cobranca_w;
elsif (ie_tipo_item_p	= 'VI') then /* Verifica se existe valor à incluir */
	if (coalesce(vl_incluir_p,0) <> 0) then
	ds_retorno_w := 1;
	end if;
elsif (ie_tipo_item_p	= 'VE') then /* Verifica se existe valor à exlcuir */
	if (coalesce(vl_cobranca_w,0) <> 0) then
	ds_retorno_w := 1;
	end if;
end if;

if (coalesce(vl_cobranca_w,0) = vl_incluir_p) then
	ds_retorno_w := 0;
end if;

if (ie_virgula_p	= 'N') then
ds_retorno_w	:= obter_Valor_sem_virgula(coalesce(ds_retorno_w,0));
end if;

if (ie_tipo_item_p = 'T') then
	if (vl_incluir_p <> coalesce(vl_cobranca_w,0)) then
		ds_retorno_w	:= 1;
	end if;
end if;

return	coalesce(ds_retorno_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_vl_excluir_afpergs ( vl_incluir_p bigint, dt_referencia_p timestamp, nr_titulo_p bigint, ie_tipo_item_p text, ie_virgula_p text) FROM PUBLIC;

