-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION rxt_obter_tumor_status_protoc ( nr_seq_tumor_p rxt_tumor.nr_sequencia%TYPE, vl_dominio_p valor_dominio.vl_dominio%TYPE ) RETURNS varchar AS $body$
DECLARE


nr_count_w smallint;


BEGIN

    CASE(vl_dominio_p)
    -- Cancelado
    WHEN 'C' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND (dt_suspensao IS NOT NULL AND dt_suspensao::text <> '');

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Interrompido
    WHEN 'I' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND (dt_cancelamento IS NOT NULL AND dt_cancelamento::text <> '');

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Finalizado
    WHEN 'F' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_finalizado(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Liberado
    WHEN 'L' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Aguardando autorização
    WHEN 'AA' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_ag_autorizacao(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Pendente agendamento de simulação
    WHEN 'PAS' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_pend_agend_simu(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Pendente simulação
    WHEN 'PS' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_pend_simu(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Pendente de imagens
    WHEN 'PI' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_pend_imagens(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Pendente prescrição médico
    WHEN 'PPM' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_pend_prescr_med(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Aguardando planejamento do físico
    WHEN 'APF' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_ag_prim_fisico(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Aguardando aprovação do médico
    WHEN 'AAM' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_ag_aprov_med(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Aguardando planejamento do segundo físico
    WHEN 'APSF' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_ag_seg_fisico(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Pendente checagem experimental (QA)
    WHEN 'PCE' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_pend_qa(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Pendente elaboração da ficha técnica
    WHEN 'PEFT' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_pend_ficha(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    -- Pendente customização do bloco
    WHEN 'PCB' THEN
        SELECT COUNT(nr_sequencia)
        INTO STRICT nr_count_w
        FROM rxt_tratamento
        WHERE nr_seq_tumor = nr_seq_tumor_p
        AND rxt_tratamento_pend_bloco(nr_sequencia) = 'S';

        IF (nr_count_w > 0) THEN
            RETURN 'S';
        END IF;
        RETURN 'N';

    END CASE;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION rxt_obter_tumor_status_protoc ( nr_seq_tumor_p rxt_tumor.nr_sequencia%TYPE, vl_dominio_p valor_dominio.vl_dominio%TYPE ) FROM PUBLIC;

