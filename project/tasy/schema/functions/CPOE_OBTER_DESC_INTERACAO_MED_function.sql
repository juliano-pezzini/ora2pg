-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_desc_interacao_med ( nr_seq_interaca_medc_p bigint, ie_html_p text DEFAULT 'N', cd_src_material_p bigint DEFAULT null, cd_interact_material_p bigint DEFAULT null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w				varchar(8000) := '';
ds_tipo_w					varchar(300);
ie_mensagem_cadastrada_w	varchar(1);
ds_orientacao_w				varchar(2000);
ds_principio_ativo_w		varchar(300);
ds_ref_bibliografica_w		varchar(4000) := '';
ds_obs_precautions_w		varchar(4000) := '';
ds_severidade_w				varchar(300);
ie_param_cpoe_64_w varchar(2) := 'N';

ds_span_w					varchar(20) := '<span>';
ds_barra_span_w				varchar(20) := '</span>';
ds_br_w						varchar(20) := '<br>';

ds_obs_text_w	varchar(255) := '';
ds_precaution_text_w varchar(255) := '';
ds_observation_notes_w	MATERIAL_INTERACAO_MEDIC.DS_OBSERVATION_NOTES%TYPE;
ds_precaution_notes_w	MATERIAL_INTERACAO_MEDIC.DS_PRECAUTION_NOTES%TYPE;
nr_seq_ficha_interacao_w	MATERIAL_INTERACAO_MEDIC.NR_SEQ_FICHA_INTERACAO%TYPE;
ds_src_material_w		MATERIAL.DS_MATERIAL%TYPE := '';
ds_interact_material_W	MATERIAL.DS_MATERIAL%TYPE := '';
cd_dcb_src_mat_w	DCB_MEDIC_CONTROLADO.CD_DCB%TYPE;
cd_dcb_interact_mat_w	DCB_MEDIC_CONTROLADO.CD_DCB%TYPE;
cd_dcb_mat_interacao_medic_w	DCB_MEDIC_CONTROLADO.CD_DCB%TYPE;


BEGIN

IF (nr_seq_interaca_medc_p IS NOT NULL AND nr_seq_interaca_medc_p::text <> '') THEN

	BEGIN
		ds_obs_text_w := SUBSTR(expressao_pck.obter_desc_expressao(10652086, PKG_I18N.get_user_locale()), 1, 255);
		ds_precaution_text_w := SUBSTR(expressao_pck.obter_desc_expressao(303248, PKG_I18N.get_user_locale()), 1, 255);
		ie_param_cpoe_64_w := Obter_param_Usuario(2314, 64, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_param_cpoe_64_w);
	EXCEPTION WHEN OTHERS THEN
		ie_param_cpoe_64_w := 'N';
	END;

	SELECT	CASE WHEN coalesce(a.ie_mensagem_cadastrada,'S')='N' THEN  CASE WHEN coalesce(a.ds_tipo::text, '') = '' THEN  ''  ELSE ' '|| wheb_mensagem_pck.get_texto(351081,'DS_TIPO='|| a.ds_tipo) END   ELSE ' ' || a.ds_tipo END  ds_tipo,
			coalesce(a.ie_mensagem_cadastrada,'S')  ie_mensagem_cadastrada,
			a.ds_orientacao,
			SUBSTR(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo,
			a.ds_ref_bibliografica,
			CASE WHEN coalesce(a.ie_exibir_gravidade,'S')='S' THEN  CASE WHEN SUBSTR(obter_valor_dominio(1325, ie_severidade),1,254) IS NULL THEN  ''  ELSE obter_desc_expressao(291030) ||': ' || SUBSTR(obter_valor_dominio(1325, ie_severidade),1,254) END   ELSE '' END ,
			ds_observation_notes,
			ds_precaution_notes,
			nr_seq_ficha_interacao
	INTO STRICT	ds_tipo_w,
			ie_mensagem_cadastrada_w,
			ds_orientacao_w,
			ds_principio_ativo_w,
			ds_ref_bibliografica_w,
			ds_severidade_w,
			ds_observation_notes_w,
			ds_precaution_notes_w,
			nr_seq_ficha_interacao_w
	FROM	material_interacao_medic a
	WHERE	a.nr_sequencia = nr_seq_interaca_medc_p
	AND		a.ie_mensagem_cadastrada <> 'N'
  AND   coalesce(a.ie_situacao, 'A') = 'A';

	IF ((trim(both ds_tipo_w) IS NOT NULL AND (trim(both ds_tipo_w))::text <> '')) THEN
		ds_retorno_w := SUBSTR(ds_span_w||Wheb_mensagem_pck.get_texto(451200) || ': '||ds_tipo_w ||ds_barra_span_w|| CHR(13) || CHR(10)||ds_br_w,1,4000);
	END IF;

	IF (ds_principio_ativo_w IS NOT NULL AND ds_principio_ativo_w::text <> '') THEN
		ds_retorno_w	:= SUBSTR(ds_retorno_w || ds_span_w||Wheb_mensagem_pck.get_texto(306016) || ' ' || ds_principio_ativo_w ||ds_barra_span_w|| CHR(13) || CHR(10)||ds_br_w,1,4000);
	END IF;

	IF (ds_severidade_w IS NOT NULL AND ds_severidade_w::text <> '') THEN
		ds_retorno_w	:= SUBSTR(ds_retorno_w ||ds_span_w|| ds_severidade_w ||ds_barra_span_w|| CHR(13) || CHR(10)||ds_br_w,1,4000);
	END IF;
	IF ((trim(both ds_orientacao_w) IS NOT NULL AND (trim(both ds_orientacao_w))::text <> '')) THEN
		ds_retorno_w := SUBSTR(ds_retorno_w ||ds_span_w|| Wheb_mensagem_pck.get_texto(351085) || ': '|| ds_orientacao_w ||ds_barra_span_w|| CHR(13) || CHR(10)||ds_br_w,1,4000);
	END IF;

	IF (ie_mensagem_cadastrada_w = 'B') AND (ds_ref_bibliografica_w IS NOT NULL AND ds_ref_bibliografica_w::text <> '') THEN
		
		IF ( (ie_html_p = 'S') and (coalesce(ie_param_cpoe_64_w,'N') = 'S') ) THEN
			
			ds_obs_precautions_w := '';
			if ( coalesce(length(trim(both ds_observation_notes_w )), 0) > 0 ) then
				BEGIN
					IF (coalesce(cd_src_material_p,0) > 0) THEN
						ds_src_material_w := obter_desc_material((cd_src_material_p)::numeric );
						select a.cd_dcb
							into STRICT cd_dcb_src_mat_w from
							DCB_MEDIC_CONTROLADO a, MEDIC_FICHA_TECNICA b, MATERIAL C
							where c.cd_material=cd_src_material_p 
							and c.NR_SEQ_FICHA_TECNICA=b.nr_sequencia
							and b.nr_seq_dcb = a.nr_sequencia
              and coalesce(b.ie_situacao, 'A') = 'A';
					END IF;
					
					IF (coalesce(cd_interact_material_p,0) > 0) THEN
						ds_interact_material_W := obter_desc_material((cd_interact_material_p)::numeric );
						select a.cd_dcb
							into STRICT cd_dcb_interact_mat_w from
							DCB_MEDIC_CONTROLADO a, MEDIC_FICHA_TECNICA b, MATERIAL C
							where c.cd_material=cd_interact_material_p 
							and c.NR_SEQ_FICHA_TECNICA=b.nr_sequencia
							and b.nr_seq_dcb = a.nr_sequencia
              and coalesce(b.ie_situacao, 'A') = 'A';
	
					END IF;
					
					select a.cd_dcb
						into STRICT cd_dcb_mat_interacao_medic_w from 
						DCB_MEDIC_CONTROLADO a, MEDIC_FICHA_TECNICA b, MATERIAL_INTERACAO_MEDIC c
						where c.nr_sequencia = nr_seq_interaca_medc_p
						and c.NR_SEQ_FICHA_INTERACAO = b.nr_sequencia
						and b.nr_seq_dcb = a.nr_sequencia
            and coalesce(b.ie_situacao, 'A') = 'A';
					
					IF ( (cd_dcb_mat_interacao_medic_w IS NOT NULL AND cd_dcb_mat_interacao_medic_w::text <> '') and (cd_dcb_interact_mat_w IS NOT NULL AND cd_dcb_interact_mat_w::text <> '') and (cd_dcb_mat_interacao_medic_w = cd_dcb_interact_mat_w)) THEN
						ds_observation_notes_w := SUBSTR(trim(both ds_src_material_w)||' '||trim(both ds_observation_notes_w )||' '||trim(both ds_interact_material_W), 1, 4000);
					ELSIF ( (cd_dcb_mat_interacao_medic_w IS NOT NULL AND cd_dcb_mat_interacao_medic_w::text <> '') and (cd_dcb_src_mat_w IS NOT NULL AND cd_dcb_src_mat_w::text <> '') and (cd_dcb_mat_interacao_medic_w = cd_dcb_src_mat_w)) THEN
						ds_observation_notes_w := SUBSTR(trim(both ds_interact_material_W)||' '||trim(both ds_observation_notes_w )||' '||trim(both ds_src_material_w), 1, 4000);
					END IF;
					
					ds_obs_precautions_w := SUBSTR(ds_obs_text_w||': ' ||trim(both ds_observation_notes_w)||ds_br_w, 1, 4000);
					
				EXCEPTION WHEN OTHERS THEN
					ds_obs_precautions_w := SUBSTR(ds_obs_text_w||': ' ||trim(both ds_observation_notes_w)||ds_br_w, 1, 4000);
				END;
			end if;
			
			ds_obs_precautions_w := SUBSTR(ds_obs_precautions_w || ds_precaution_text_w||': ' ||ds_precaution_notes_w, 1, 4000);
			ds_retorno_w := SUBSTR(ds_retorno_w ||ds_span_w||ds_obs_precautions_w||ds_barra_span_w|| CHR(13) || CHR(10)||ds_br_w,1,4000);
		END IF;
		
		ds_retorno_w := SUBSTR(ds_retorno_w ||ds_span_w|| Wheb_mensagem_pck.get_texto(351086) || ': ' || ds_ref_bibliografica_w ||ds_barra_span_w|| CHR(13) || CHR(10)||ds_br_w,1,4000);
	END IF;

	ds_retorno_w := SUBSTR(ds_retorno_w,1,3995) || CHR(13) || CHR(10);

	IF ((ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') AND (ie_html_p = 'N' OR coalesce(ie_html_p::text, '') = '')) THEN
		ds_retorno_w := replace(ds_retorno_w, ds_span_w, '');
		ds_retorno_w := replace(ds_retorno_w, ds_barra_span_w, '');
		ds_retorno_w := replace(ds_retorno_w, ds_br_w, '');
	END IF;

END IF;

RETURN SUBSTR(trim(both ds_retorno_w),1,4000);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_desc_interacao_med ( nr_seq_interaca_medc_p bigint, ie_html_p text DEFAULT 'N', cd_src_material_p bigint DEFAULT null, cd_interact_material_p bigint DEFAULT null) FROM PUBLIC;

