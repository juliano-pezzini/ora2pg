-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_consiste_tp_guia_aut_apres ( nr_seq_conta_p bigint, nr_seq_regra_tipo_guia_p bigint) RETURNS varchar AS $body$
DECLARE


cd_guia_referencia_w		varchar(15);
cd_guia_imp_w			varchar(15);
cd_guia_solic_imp_w		varchar(15);
ie_tipo_guia_guia_w		varchar(5);
ie_tipo_guia_conta_w		varchar(5);
ie_tipo_guia_autor_w		varchar(5);
ie_gera_ocorr_w			varchar(1)	:= 'N';
ie_tipo_guia_autor_regra_w	varchar(2);
nr_seq_segurado_conta_w		bigint;
qt_apresentada_w		bigint	:= 0;
qt_autorizado_w			bigint	:= 0;
nr_seq_protocolo_w		bigint;
ie_origem_protocolo_w		varchar(2);


BEGIN

begin



/*Utilizar a procedure PLS_VALIDA_TP_GUIA_AUT_APRES para esta validação */

ie_gera_ocorr_w := 'N';



end;
/*Informações da rega de tipo de guia aprensetada */

/*select 	ie_tipo_guia_autor
into	ie_tipo_guia_autor_regra_w
from 	pls_regra_tipo_guia_apres
where 	nr_sequencia	= nr_seq_regra_tipo_guia_p
and	ie_situacao	= 'A';
exception
when others then
	ie_gera_ocorr_w	:= 'S';
	goto final;
end;*/
/*Obtem informacoes da conta do portal */

/*if	(nvl(nr_seq_conta_p,0) > 0) then
	select 	nr_seq_protocolo
	into	nr_seq_protocolo_w
	from	pls_conta
	where	nr_sequencia = nr_seq_conta_p;

	begin
	select 	ie_origem_protocolo
	into	ie_origem_protocolo_w
	from	pls_protocolo_conta
	where	nr_sequencia = nr_seq_protocolo_w;
	exception
	when others then
		ie_origem_protocolo_w	:= 'X';
	end;

	if	(ie_origem_protocolo_w = 'E')	then
		begin
		select	ie_tipo_guia,
			nr_seq_segurado,
			cd_guia_imp
		into	ie_tipo_guia_conta_w,
			nr_seq_segurado_conta_w,
			cd_guia_referencia_w
		from 	pls_conta a
		where 	a.nr_sequencia	= nr_seq_conta_p;
		exception
		when others then
			ie_gera_ocorr_w	:= 'S';
			goto final;
		end;
	else
		begin
		select	ie_tipo_guia,
			nr_seq_segurado,
			nvl(cd_guia_referencia,cd_guia)
		into	ie_tipo_guia_conta_w,
			nr_seq_segurado_conta_w,
			cd_guia_referencia_w
		from 	pls_conta a
		where 	a.nr_sequencia	= nr_seq_conta_p;
		exception
		when others then
			ie_gera_ocorr_w	:= 'S';
			goto final;
		end;
	end if;
end if;

cd_guia_referencia_w	:= pls_converte_cd_guia_pesquisa(cd_guia_referencia_w);

begin
select	ie_tipo_guia
into	ie_tipo_guia_autor_w
from	pls_guia_plano
where	cd_guia_pesquisa	= cd_guia_referencia_w
and	nr_seq_segurado		= nr_seq_segurado_conta_w;
exception
when others then
	ie_tipo_guia_autor_w	:= '0';
end;

select	count(1)
into	qt_apresentada_w
from	pls_regra_tipo_guia_apres
where   nr_sequencia		= nr_seq_regra_tipo_guia_p
and	ie_tipo_guia_autor	= ie_tipo_guia_autor_w;


if	(qt_apresentada_w > 0) then

	select	count(1)
	into	qt_autorizado_w
	from	pls_regra_tp_guia_ap_item
	where   nr_seq_regra		= nr_seq_regra_tipo_guia_p
	and	ie_tipo_guia_apres	= ie_tipo_guia_conta_w
	and	rownum 	< 2;


	if	(qt_autorizado_w > 0) then
		ie_gera_ocorr_w	:= 'S';
	end if;
else
	ie_gera_ocorr_w	:= 'S';
end if;*/
<<final>>
return	ie_gera_ocorr_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_consiste_tp_guia_aut_apres ( nr_seq_conta_p bigint, nr_seq_regra_tipo_guia_p bigint) FROM PUBLIC;

