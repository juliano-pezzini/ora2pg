-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_nota_fiscal_aidf ( nr_sequencia_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


nr_nota_fiscal_w		varchar(255);
cd_serie_nf_w			nota_fiscal.cd_serie_nf%type;
cd_estabelecimento_w		smallint;
cd_opcao_w			varchar(20);
cnpj_grafica_w			varchar(14);

/*Utilizada para buscar dados da autorizacao de impressão de documento fiscal - AIDF da nota fiscalk*/

/*
ie_opcao_p
'N' = Numero
'A' = Ano
'S' - Serie
'C' - Cnpj da gráfica
'NI' - nr_nota_ini
'NF' - nr_nota_fim


*/
BEGIN

select	nr_nota_fiscal,
		cd_estabelecimento,
		cd_serie_nf
into STRICT	nr_nota_fiscal_w,
		cd_estabelecimento_w,
		cd_serie_nf_w
from	nota_fiscal
where	nr_sequencia = nr_sequencia_p;

if (ie_opcao_p = 'N') then

    select	max(NR_AIDF)
    into STRICT	cd_opcao_w
    from	nota_fiscal_aidf
    where	cd_serie_nf = cd_serie_nf_w
    and	(nr_nota_fiscal_w)::numeric  between nr_nota_ini and nr_nota_fim;

elsif (ie_opcao_p = 'A') then

    select	to_char(dt_autorizacao,'yyyy')
    into STRICT	cd_opcao_w
    from	nota_fiscal_aidf
    where	cd_serie_nf = cd_serie_nf_w
    and	(nr_nota_fiscal_w)::numeric  between nr_nota_ini and nr_nota_fim;

elsif (ie_opcao_p = 'C') then

    select	cnpj_grafica
    into STRICT	cd_opcao_w
    from	nota_fiscal_aidf
    where	cd_serie_nf = cd_serie_nf_w
    and	(nr_nota_fiscal_w)::numeric  between nr_nota_ini and nr_nota_fim;


elsif (ie_opcao_p = 'S') then

    select	cd_serie_nf_w
    into STRICT	cd_opcao_w
    from	nota_fiscal_aidf
    where	cd_serie_nf = cd_serie_nf_w
    and	(nr_nota_fiscal_w)::numeric  between nr_nota_ini and nr_nota_fim;

elsif (ie_opcao_p = 'NI') then

    select	nr_nota_ini
    into STRICT	cd_opcao_w
    from	nota_fiscal_aidf
    where	upper(cd_serie_nf) = upper(cd_serie_nf_w)
    and	(nr_nota_fiscal_w)::numeric  between nr_nota_ini and nr_nota_fim;

elsif (ie_opcao_p = 'NF') then

    select	nr_nota_fim
    into STRICT	cd_opcao_w
    from	nota_fiscal_aidf
    where	upper(cd_serie_nf) = upper(cd_serie_nf_w)
    and	(nr_nota_fiscal_w)::numeric  between nr_nota_ini and nr_nota_fim;

end if;

return	cd_opcao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_nota_fiscal_aidf ( nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

