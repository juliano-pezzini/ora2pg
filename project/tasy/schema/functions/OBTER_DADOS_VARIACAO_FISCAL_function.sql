-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_variacao_fiscal ( nr_sequencia_p bigint, cd_material_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

/*ie_opcao_p 
S - NR_SEQUENCIA 
N - CD_NATUREZA_OPERACAO*/
 
 
nr_retorno_w			bigint;
cd_grupo_material_w		smallint;
cd_subgrupo_material_w		smallint;
cd_classe_material_w		integer;
ie_tipo_material_w			varchar(3);
cd_operacao_nf_w			smallint;
cd_pessoa_fisica_w		varchar(10);
cd_cgc_w			varchar(14);
cd_cgc_emitente_w		varchar(14);
sg_estado_w			pessoa_juridica.sg_estado%type;
nr_sequencia_w			bigint;
cd_natureza_operacao_w		bigint;
			
c01 CURSOR FOR 
SELECT 	nr_sequencia 
from	fis_variacao_fiscal 
where	dt_inicio_vigencia <= clock_timestamp() 
and	dt_fim_vigencia >= clock_timestamp() 
and	( 
	(cd_pessoa_fisica = cd_pessoa_fisica_w) or (coalesce(cd_pessoa_fisica::text, '') = '')) 
and	((cd_cnpj = cd_cgc_w) or (coalesce(cd_cnpj::text, '') = '')) 
and	((cd_material = cd_material_p) or (coalesce(cd_material::text, '') = '')) 
and	((cd_grupo_material = cd_grupo_material_w) or (coalesce(cd_grupo_material::text, '') = '')) 
and	((cd_subgrupo_material = cd_subgrupo_material_w) or (coalesce(cd_subgrupo_material::text, '') = '')) 
and	((cd_classe_material = cd_classe_material_w) or (coalesce(cd_classe_material::text, '') = '')) 
and	((cd_tipo_material = ie_tipo_material_w) or (coalesce(cd_tipo_material::text, '') = '')) 
and	((cd_operacao_nf = cd_operacao_nf_w) or (coalesce(cd_operacao_nf::text, '') = '')) 
and	((sg_estado = sg_estado_w) or (coalesce(sg_estado::text, '') = '')) 
and	ie_situacao = 'A' 
order by 	coalesce(cd_material,999999) desc,	 
	coalesce(cd_classe_material,999999)desc,	 
	coalesce(cd_subgrupo_material,999999) desc, 
	coalesce(cd_grupo_material,999999) desc, 
	CASE WHEN length(cd_cnpj)=0 THEN 999999  ELSE 1 END  desc, 
	CASE WHEN length(cd_pessoa_fisica)=0 THEN 999999  ELSE 1 END  desc, 
	coalesce(cd_tipo_material,999999) desc, 
	coalesce(cd_operacao_nf,999999) desc, 
	CASE WHEN length(sg_estado)=2 THEN 1  ELSE 999999 END;			
			 
			 

BEGIN 
if (cd_material_p > 0) then /*Fiz esse if porque quando a nota tem procedimento, o cd_material por der nulo*/
 
 
	select	e.cd_grupo_material, 
		e.cd_subgrupo_material, 
		e.cd_classe_material, 
		fis_obter_tipo_mat_fiscal(a.ie_tipo_material) 
	into STRICT	cd_grupo_material_w, 
		cd_subgrupo_material_w, 
		cd_classe_material_w, 
		ie_tipo_material_w 
	from	material a, 
		estrutura_material_v e 
	where	a.cd_material = e.cd_material 
	and	a.cd_material = cd_material_p;	
	 
	select	cd_operacao_nf, 
		cd_pessoa_fisica, 
		cd_cgc, 
		obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'UF') 
	into STRICT	cd_operacao_nf_w, 
		cd_pessoa_fisica_w, 
		cd_cgc_w, 
		sg_estado_w 
	from	nota_fiscal 
	where	nr_sequencia = nr_sequencia_p;
 
	open C01;
	loop 
	fetch C01 into	 
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		nr_sequencia_w			:= nr_sequencia_w;
		end;
	end loop;
	close C01;
	 
	if (nr_sequencia_w > 0) then 
		select	cd_natureza_operacao 
		into STRICT	cd_natureza_operacao_w 
		from	fis_variacao_fiscal 
		where	nr_Sequencia = nr_sequencia_w;
	end if;
	 
	if (ie_opcao_p = 'S') then 
		nr_retorno_w := nr_Sequencia_w;
	elsif (ie_opcao_p = 'N') then 
		nr_retorno_w := cd_natureza_operacao_w;
	end if;
end if;
 
return nr_retorno_w;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_variacao_fiscal ( nr_sequencia_p bigint, cd_material_p bigint, ie_opcao_p text) FROM PUBLIC;

