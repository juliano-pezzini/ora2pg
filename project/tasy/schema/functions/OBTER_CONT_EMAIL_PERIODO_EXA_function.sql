-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_cont_email_periodo_exa ( dt_agenda_p timestamp, cd_agenda_p bigint, dt_agenda_fim_p timestamp default null) RETURNS varchar AS $body$
DECLARE

 
ds_conteudo_w		varchar(6000);
ds_agenda_w		varchar(100);
hr_inicio_w		varchar(100);
nm_paciente_w		varchar(100);
ds_procedimento_w 	PROCEDIMENTO.DS_PROCEDIMENTO%type;
nm_medico_w		varchar(100);	
dt_agenda_fim_w		timestamp;
			
c01 CURSOR FOR 
	SELECT	substr(wheb_mensagem_pck.get_texto(791362) || ' ' || Obter_Nome_Agenda(cd_agenda),1,100) ds_agenda, 
		substr(wheb_mensagem_pck.get_texto(791363) || ' ' || obter_nome_medico(cd_medico,'NC'),1,100) nm_medico, 
		wheb_mensagem_pck.get_texto(793494) || ': ' || to_char(hr_inicio, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario))) hr_inicio, 
		(wheb_mensagem_pck.get_texto(791350) || ': ' || nm_paciente) nm_paciente, 
		substr(wheb_mensagem_pck.get_texto(795138) || ': ' || obter_exame_agenda(cd_procedimento, ie_origem_proced, nr_seq_proc_interno),1,255) ds_procedimento 
	from	agenda_paciente 
	where	dt_agenda between dt_agenda_p and dt_agenda_fim_w 
	and	ie_status_agenda not in ('L','C') 
	and	obter_tipo_agenda(cd_agenda) = 2 
--	and	(cd_medico = cd_medico_p or cd_medico_p = 0) 
	and (cd_agenda = cd_agenda_p or cd_agenda_p = 0) 
	order by	ds_agenda, 
			dt_agenda desc, 
			hr_inicio desc;
			

BEGIN 
 
if (coalesce(dt_agenda_fim_p::text, '') = '') then 
	dt_agenda_fim_w	:= fim_dia(dt_agenda_p);
else 
	dt_agenda_fim_w := fim_dia(dt_agenda_fim_p);
end if;
 
open c01;
loop 
fetch c01 into 
	ds_agenda_w, 
	nm_medico_w, 
	hr_inicio_w, 
	nm_paciente_w, 
	ds_procedimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ds_conteudo_w	:= 	substr(ds_agenda_w || chr(13) || chr(10) || 
				nm_medico_w || chr(13) || chr(10) || 
				hr_inicio_w || chr(13) || chr(10) || 
				nm_paciente_w || chr(13) || chr(10) || 
				ds_procedimento_w || chr(13) || chr(10) || chr(13) || chr(10) || 
				ds_conteudo_w,1,6000);	
end loop;
close c01;
 
return 	substr(ds_conteudo_w,1,6000);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_cont_email_periodo_exa ( dt_agenda_p timestamp, cd_agenda_p bigint, dt_agenda_fim_p timestamp default null) FROM PUBLIC;

