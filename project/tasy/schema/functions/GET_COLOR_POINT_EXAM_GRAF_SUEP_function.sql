-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_color_point_exam_graf_suep (nr_seq_exame_p bigint, nr_seq_suep_p item_suep.nr_seq_suep%type, ie_card_type_p text, nr_pontuacao_p bigint, cd_pessoa_fisica_p text) RETURNS varchar AS $body$
DECLARE

   ds_retorno_w        varchar(200);
   qt_idade_w          bigint;
   ie_sexo_w           pessoa_fisica.ie_sexo%type;

   c01 CURSOR FOR
      SELECT CASE WHEN ie_tipo_valor=0 THEN  'gray' WHEN ie_tipo_valor=1 THEN  'yellow' WHEN ie_tipo_valor=2 THEN  'red' END  color,
          qt_minima, qt_maxima, qt_idade_min, qt_idade_max, ie_sexo 
        from exame_lab_padrao 
        where nr_seq_exame = nr_seq_exame_p 
          and ie_tipo_valor in (0,1,2);

BEGIN
   ds_retorno_w := 'gray';

   select obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'A'),
           obter_sexo_pf(cd_pessoa_fisica_p, 'C')
      into STRICT qt_idade_w, ie_sexo_w
;

  for r_c01 in c01 loop
      if ( (nr_pontuacao_p >= r_c01.qt_minima) and (nr_pontuacao_p <= r_c01.qt_maxima) and (r_c01.qt_idade_min <= qt_idade_w ) and (r_c01.qt_idade_max >= qt_idade_w ) and (ie_sexo_w = r_c01.ie_sexo or r_c01.ie_sexo = '0') ) then
            ds_retorno_w := r_c01.color;
      end if;

  end loop;

  return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_color_point_exam_graf_suep (nr_seq_exame_p bigint, nr_seq_suep_p item_suep.nr_seq_suep%type, ie_card_type_p text, nr_pontuacao_p bigint, cd_pessoa_fisica_p text) FROM PUBLIC;

