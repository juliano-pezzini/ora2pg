-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ageint_consiste_tempo_salas ( cd_agenda_p bigint, hr_Agenda_p timestamp, nr_minuto_duracao_p bigint, nr_Seq_ageint_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(1)	:= 'S';
nr_Seq_marcacao_w	bigint;
hr_Agenda_w		timestamp;
nr_minuto_duracao_w	bigint;
cd_Agenda_w		bigint;
qt_tempo_sala_w		bigint;
qt_sobra_w		bigint;
hr_max_agenda_w		timestamp;
hr_min_agenda_w		timestamp;
ds_retorno_max_w	varchar(1)	:= 'S';
ds_Retorno_min_w	varchar(1)	:= 'S';


BEGIN

select 	max(hr_Agenda)
into STRICT	hr_max_agenda_w
from 	ageint_marcacao_usuario b
where 	b.nr_seq_ageint					= nr_Seq_Ageint_p
and	b.nm_usuario					= nm_usuario_p
and	b.hr_Agenda + (nr_minuto_duracao / 1440)	<= hr_Agenda_p
and	coalesce(b.ie_Gerado, 'N')				= 'N';

select 	min(hr_Agenda)
into STRICT	hr_min_agenda_w
from 	ageint_marcacao_usuario b
where 	b.nr_seq_ageint		= nr_Seq_Ageint_p
and	b.nm_usuario		= nm_usuario_p
and	b.hr_Agenda		>= hr_Agenda_p + (nr_minuto_duracao_p / 1440)
and	coalesce(b.ie_Gerado, 'N')	= 'N';

if (hr_max_agenda_w IS NOT NULL AND hr_max_agenda_w::text <> '') then

	select	max(a.nr_Sequencia)
	into STRICT	nr_seq_marcacao_w
	from	ageint_marcacao_usuario a
	where	a.nr_seq_ageint		= nr_Seq_ageint_p
	and	a.nm_usuario		= nm_usuario_p
	and	a.hr_Agenda		= hr_max_agenda_w
	and	coalesce(a.ie_Gerado, 'N')	= 'N';

	if (nr_Seq_marcacao_w IS NOT NULL AND nr_Seq_marcacao_w::text <> '') then
		select	hr_Agenda,
			nr_minuto_duracao,
			cd_agenda
		into STRICT	hr_Agenda_w,
			nr_minuto_duracao_w,
			cd_Agenda_w
		from	ageint_marcacao_usuario
		where	nr_Sequencia	= nr_seq_marcacao_w;

		select	Ageint_Obter_tempo_entre_salas(cd_agenda_w, cd_Agenda_p, cd_estabelecimento_p)
		into STRICT	qt_tempo_sala_w
		;

		select	Obter_Min_Entre_Datas((hr_Agenda_w + nr_minuto_duracao_w / 1440), hr_Agenda_p, 1)
		into STRICT	qt_sobra_w
		;

		if (qt_sobra_w	< qt_tempo_sala_w) then
			ds_retorno_max_w	:= 'N';
		else
			ds_Retorno_max_w	:= 'S';
		end if;
	end if;
end if;

if (hr_min_agenda_w IS NOT NULL AND hr_min_agenda_w::text <> '') then

	select	max(a.nr_Sequencia)
	into STRICT	nr_seq_marcacao_w
	from	ageint_marcacao_usuario a
	where	a.nr_seq_ageint		= nr_Seq_ageint_p
	and	a.nm_usuario		= nm_usuario_p
	and	a.hr_Agenda		= hr_min_agenda_w
	and	coalesce(a.ie_Gerado, 'N')	= 'N';

	if (nr_Seq_marcacao_w IS NOT NULL AND nr_Seq_marcacao_w::text <> '') then
		select	hr_Agenda,
			nr_minuto_duracao,
			cd_agenda
		into STRICT	hr_Agenda_w,
			nr_minuto_duracao_w,
			cd_Agenda_w
		from	ageint_marcacao_usuario
		where	nr_Sequencia	= nr_seq_marcacao_w;

		select	Ageint_Obter_tempo_entre_salas(cd_agenda_w, cd_Agenda_p, cd_estabelecimento_p)
		into STRICT	qt_tempo_sala_w
		;

		select	Obter_Min_Entre_Datas((hr_Agenda_p + nr_minuto_duracao_p / 1440), hr_Agenda_w, 1)
		into STRICT	qt_sobra_w
		;

		if (qt_sobra_w	< qt_tempo_sala_w) then
			ds_retorno_min_w	:= 'N';
		else
			ds_Retorno_min_w	:= 'S';
		end if;
	end if;
end if;

if (ds_retorno_min_w	= 'N') or (ds_retorno_max_w	= 'N') then
	ds_Retorno_w	:= 'N';
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ageint_consiste_tempo_salas ( cd_agenda_p bigint, hr_Agenda_p timestamp, nr_minuto_duracao_p bigint, nr_Seq_ageint_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

