-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_allergy_medic_receita ( cd_material_p text, nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(8000) 	:= '';
ie_allergic_med_w 	varchar(1)	:='N';
ie_duplicity_med_w 	varchar(1)	:='N';
ds_mensagem_w		varchar(2000)	:= null;
cd_pessoa_fisica_w	varchar(200);
ie_severidade_w		paciente_alergia.ie_intensidade%type;
nr_seq_reacao_w		paciente_alergia.nr_seq_reacao%type;
nr_seq_ficha_tecnica_w	paciente_alergia.nr_seq_ficha_tecnica%type;


BEGIN
cd_pessoa_fisica_w 	:= obter_pessoa_atendimento(nr_atendimento_p,'C');
SELECT * FROM cpoe_verifica_se_pac_alergico(cd_pessoa_fisica_w, cd_material_p, ie_allergic_med_w, ds_mensagem_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_allergic_med_w, ds_mensagem_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;

if (ie_allergic_med_w = 'S') then
	ds_retorno_w:= ds_mensagem_w;
else
	SELECT * FROM cpoe_check_pac_cross_sens(cd_pessoa_fisica_w, cd_material_p, ie_allergic_med_w, ds_mensagem_w) INTO STRICT ie_allergic_med_w, ds_mensagem_w;
	
	if (ie_allergic_med_w = 'S') then
		ds_retorno_w:= ds_mensagem_w;
	end if;
end if;

select CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
into STRICT ie_duplicity_med_w
from	material b,
	fa_receita_farmacia_item a,
  fa_receita_farmacia b
where b.nr_sequencia = a.NR_SEQ_RECEITA
and b.nr_atendimento	= nr_atendimento_p
and	a.cd_material		= cd_material_p
and b.ie_situacao = 'A'
and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
and coalesce(b.DT_CANCELAMENTO::text, '') = ''
and (coalesce(b.DT_VALIDADE_RECEITA::text, '') = '' or b.DT_VALIDADE_RECEITA > clock_timestamp());

if (ie_duplicity_med_w = 'S') then
 ds_retorno_w:= ds_retorno_w || obter_desc_expressao(317560)|| Obter_Desc_Material(cd_material_p);
end if;

return substr(ds_retorno_w,1,4000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_allergy_medic_receita ( cd_material_p text, nr_atendimento_p bigint) FROM PUBLIC;

