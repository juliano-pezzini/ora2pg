-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_pac_ultimo_leito (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

				 
dt_entrada_unidade_w	timestamp;
nr_seq_interno_w		bigint;
ie_paciente_leito_w		varchar(1) := 'N';
ie_status_unidade_w		varchar(3);
nr_atendimento_w		bigint;
nr_atepacu_w			bigint;


BEGIN 
nr_atepacu_w := Obter_Atepacu_paciente(nr_atendimento_p, 'IAA');
 
if (coalesce(nr_atendimento_p,0) > 0)	then 
	select	max(dt_entrada_unidade), 
			max(nr_seq_interno) 
	into STRICT	dt_entrada_unidade_w, 
			nr_seq_interno_w 
	from 	setor_atendimento b, 
			atend_paciente_unidade a 
	where	a.nr_atendimento		= nr_atendimento_p 
	and		a.cd_setor_atendimento 	= b.cd_setor_atendimento 
	and		coalesce(a.nr_seq_interno,nr_atepacu_w) = nr_atepacu_w 
	and		a.dt_saida_unidade = (SELECT max(x.dt_saida_unidade) 
								from	 atend_paciente_unidade x 
								where	 x.nr_atendimento = a.nr_atendimento) 
	order by	CASE WHEN b.cd_classif_setor=3 THEN  1 WHEN b.cd_classif_setor=4 THEN  1 WHEN b.cd_classif_setor=8 THEN  1  ELSE 0 END , 
				a.dt_saida_unidade, 
				a.dt_entrada_unidade;
 
	if (coalesce(nr_seq_interno_w,0) > 0)	then 
		select 	max(b.ie_status_unidade), 
				max(b.nr_atendimento) 
		into STRICT	ie_status_unidade_w, 
				nr_atendimento_w 
		from 	unidade_atendimento b, 
				atend_paciente_unidade a 
		where 	a.nr_atendimento 		= nr_atendimento_p 
		and 	a.nr_seq_interno		= nr_seq_interno_w 
		and 	a.cd_setor_atendimento	= b.cd_setor_atendimento 
		and 	a.cd_unidade_basica		= b.cd_unidade_basica 
		and 	a.cd_unidade_compl		= b.cd_unidade_compl;
		 
		if (ie_status_unidade_w = 'P') and (nr_atendimento_w <> nr_atendimento_p)	then 
			ie_paciente_leito_w := 'S';
		else 
			ie_paciente_leito_w	:= 'N';
		end if;
	end if;
end if;	
 
 
return	ie_paciente_leito_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_pac_ultimo_leito (nr_atendimento_p bigint) FROM PUBLIC;

