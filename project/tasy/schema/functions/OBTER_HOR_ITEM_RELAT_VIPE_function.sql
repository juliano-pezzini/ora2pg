-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_hor_item_relat_vipe ( cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, dt_referencia_p timestamp, ie_tipo_item_p text, ie_exibir_realizados_p text, ie_exibir_suspensos_p text, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


/*
FUNCTION CRIADA COM BASE NA PACKAGE DA VIPE - VERSÃO 871
*/
ds_horarios_w			varchar(4000);
dt_horario_w			varchar(255);
cd_item_w			varchar(255);
ds_item_w			varchar(255);
ds_dosagem_w			varchar(255);
ds_prescricao_w			varchar(2000);
ie_data_lib_prescr_w		varchar(15);
ie_acm_sn_w			varchar(15);
ie_exibe_sem_lib_farm_w		varchar(15);
ie_considera_horario_w		varchar(15);
ie_utiliza_serv_w		varchar(15);
ie_exibe_dietas_w		varchar(15);
ie_agrupar_acm_sn_w		varchar(15);
ie_agrupa_item_igual_w		varchar(15);
ie_agrupa_coletas_w		varchar(15);
ie_mostrar_subs_w		varchar(15);
ie_agrupar_dose_esp_w		varchar(15);
ie_agrupar_associados_w		varchar(15);
qt_horas_anteriores_w		bigint := 0;
qt_horas_adicionais_w		bigint := 0;
qt_horas_vigencia_w		bigint := 0;
cont_linha_w			bigint := 0;
nr_prescricao_w			bigint;
nr_seq_item_w			bigint;
cd_setor_usuario_w		integer;
dt_fim_w			timestamp;
dt_validade_limite_w		timestamp;
dt_inicial_horarios_w		timestamp;
dt_final_horarios_w		timestamp;

C01 CURSOR FOR  --Suplemento Oral
SELECT	to_char(c.dt_horario,'dd/mm hh24:mi')
FROM prescr_material x, prescr_medica a, prescr_mat_hor c
LEFT OUTER JOIN nut_atend_serv_dia s ON (c.nr_sequencia = s.nr_seq_horario)
WHERE x.nr_prescricao		= c.nr_prescricao and x.nr_sequencia		= c.nr_seq_material and x.nr_prescricao		= a.nr_prescricao and c.nr_prescricao 	= a.nr_prescricao  and a.nr_atendimento	= nr_atendimento_p and a.dt_validade_prescr	between dt_validade_limite_w and dt_fim_w and x.nr_prescricao = nr_prescricao_p and x.nr_sequencia = nr_seq_item_p and coalesce(a.dt_suspensao::text, '') = '' and Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S' and ((obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S') or
	((ie_exibe_sem_lib_farm_w = 'S') and (coalesce(a.IE_PRESCR_NUTRICAO, 'N') = 'S'))) and x.ie_agrupador		= 12 and ((coalesce(ie_utiliza_serv_w,'N') <> 'S') or (s.nr_seq_horario IS NOT NULL AND s.nr_seq_horario::text <> '')) and ((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = '')) and coalesce(c.ie_situacao,'A')	= 'A' and c.ie_agrupador		= 12 and c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w and ((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> '')) and ((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = '')) and ((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = '')) and ((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S')) group by
	c.dt_horario;

C02 CURSOR FOR  --Solução
SELECT	to_char(c.dt_horario,'dd/mm hh24:mi')
from	prescr_solucao x,
	prescr_mat_hor c,
	prescr_medica a
where	x.nr_prescricao = c.nr_prescricao
and	x.nr_seq_solucao = c.nr_seq_solucao
and	x.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = nr_prescricao_p
and	c.nr_seq_solucao = nr_seq_item_p
and	coalesce(a.dt_suspensao::text, '') = ''
and	((coalesce(x.ie_acm,'N') = 'N') or (coalesce(c.ie_aprazado,'N') = 'S'))
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr between dt_validade_limite_w and  dt_fim_w
and	obter_se_prescr_lib_vipe(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w,c.dt_lib_horario) = 'S'
and	coalesce(x.nr_seq_dialise::text, '') = ''
and	coalesce(x.ie_hemodialise,'N') = 'N'
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	c.ie_agrupador = 4
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	adep_obter_se_gerar_sol_hor(c.dt_horario, c.dt_inicio_horario, c.dt_fim_horario, c.dt_suspensao, dt_inicial_horarios_w, dt_final_horarios_w) = 'S'
and	c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w
and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
group by
	c.dt_horario;

C03 CURSOR FOR  --Suporte Nutricional Enteral
SELECT	to_char(c.dt_horario,'dd/mm hh24:mi')
from	prescr_material x,
	prescr_mat_hor c,
	prescr_medica a
where	x.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	x.nr_sequencia	= c.nr_seq_material
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	coalesce(a.dt_suspensao::text, '') = ''
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
and	((obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S') or
	((ie_exibe_sem_lib_farm_w = 'S') and (coalesce(a.IE_PRESCR_NUTRICAO, 'N') = 'S')))
and	x.ie_agrupador = 8
and 	ie_utiliza_serv_w = 'N'
and	((x.ie_status in ('I','INT')) or
	 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)) or
	 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')))
and	((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T'))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)
group by c.dt_horario

union all

select	to_char(b.dt_servico,'dd/mm hh24:mi')
from	prescr_material x,
	nut_atend_serv_dia b,
	prescr_medica a
where	x.nr_prescricao = a.nr_prescricao
and 	b.nr_prescricao = x.nr_prescricao
and	b.nr_seq_material = x.nr_sequencia
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	((obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S') or
	((ie_exibe_sem_lib_farm_w = 'S') and (coalesce(a.IE_PRESCR_NUTRICAO, 'N') = 'S')))
and	x.ie_agrupador = 8
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	b.DT_SERVICO between dt_inicial_horarios_w and dt_final_horarios_w
and	((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T'))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and 	ie_utiliza_serv_w = 'S'
group by
	b.dt_servico;

C04 CURSOR FOR  --NPT Adulta
SELECT	to_char(x.dt_status,'dd/mm hh24:mi')
from	nut_pac x,
	prescr_medica a
where	x.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	((obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S') or
	((ie_exibe_sem_lib_farm_w = 'S') and (coalesce(a.ie_prescr_nutricao, 'N') = 'S')))
and	x.ie_status = 'N'
and	x.dt_status between dt_inicial_horarios_w and dt_final_horarios_w
and	((x.ie_status in ('I','INT')) or (x.dt_status between dt_inicial_horarios_w and dt_final_horarios_w))
and	((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T'))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
group by
	x.dt_status;

C05 CURSOR FOR  --Hemoterapias
SELECT	coalesce(to_char(x.dt_status,'dd/mm hh24:mi'),to_char(x.dt_prev_execucao,'dd/mm hh24:mi'))
from	prescr_procedimento x,
	prescr_medica a
where	x.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	coalesce(x.nr_seq_proc_interno::text, '') = ''
and	coalesce(x.nr_seq_exame::text, '') = ''
and	(x.nr_seq_solic_sangue IS NOT NULL AND x.nr_seq_solic_sangue::text <> '')
and	(x.nr_seq_derivado IS NOT NULL AND x.nr_seq_derivado::text <> '')
and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
and	coalesce(a.dt_suspensao::text, '') = ''
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	coalesce(x.ie_status,'N') = 'N'
and	coalesce(x.dt_status,x.dt_prev_execucao) between dt_inicial_horarios_w and dt_final_horarios_w
and	((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T'))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
group by coalesce(to_char(x.dt_status,'dd/mm hh24:mi'),to_char(x.dt_prev_execucao,'dd/mm hh24:mi'))

union all

select	coalesce(to_char(x.dt_status,'dd/mm hh24:mi'),to_char(x.dt_prev_execucao,'dd/mm hh24:mi'))
from	proc_interno w,
	prescr_procedimento x,
	prescr_medica a
where	w.nr_sequencia = x.nr_seq_proc_interno
and	x.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	w.ie_tipo <> 'G'
and	w.ie_tipo <> 'BS'
and	coalesce(w.ie_ivc,'N') <> 'S'
and	coalesce(w.ie_ctrl_glic,'NC') = 'NC'
and	coalesce(a.dt_suspensao::text, '') = ''
and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
and	coalesce(x.nr_seq_prot_glic::text, '') = ''
and	coalesce(x.nr_seq_exame::text, '') = ''
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	(x.nr_seq_solic_sangue IS NOT NULL AND x.nr_seq_solic_sangue::text <> '')
and	(x.nr_seq_derivado IS NOT NULL AND x.nr_seq_derivado::text <> '')
and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
and	coalesce(x.ie_status,'N') = 'N'
and	coalesce(x.dt_status,x.dt_prev_execucao) between dt_inicial_horarios_w and dt_final_horarios_w
and	((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T'))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
group by coalesce(to_char(x.dt_status,'dd/mm hh24:mi'),to_char(x.dt_prev_execucao,'dd/mm hh24:mi'));

C06 CURSOR FOR  --Medicamentos
SELECT	to_char(c.dt_horario,'dd/mm hh24:mi')
from	prescr_material x,
	prescr_mat_hor c,
	prescr_medica a
where	x.nr_prescricao	= c.nr_prescricao
and	x.nr_sequencia = c.nr_seq_material
and	x.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	coalesce(a.dt_suspensao::text, '') = ''
and	obter_se_prescr_lib_vipe(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w,c.dt_lib_horario) = 'S'
and	x.ie_agrupador = 1
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	((ie_mostrar_subs_w	= 'S') or (coalesce(x.nr_seq_substituto::text, '') = ''))
and	c.ie_agrupador = 1
and	c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
group by
	c.dt_horario;

C07 CURSOR FOR  --Procedimentos
SELECT	to_char(c.dt_horario,'dd/mm hh24:mi')
from	prescr_procedimento x,
	prescr_proc_hor c,
	prescr_medica a
where	x.nr_prescricao = c.nr_prescricao
and	x.nr_sequencia = c.nr_seq_procedimento
and	x.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	coalesce(a.dt_suspensao::text, '') = ''
and	coalesce(x.nr_seq_proc_interno::text, '') = ''
and	coalesce(x.nr_seq_exame::text, '') = ''
and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	coalesce(x.nr_seq_derivado::text, '') = ''
and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
and	coalesce(x.nr_seq_prot_glic::text, '') = ''
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and	coalesce(c.ie_situacao,'A') = 'A'
and	c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
group by
	c.dt_horario

union all

select	to_char(c.dt_horario,'dd/mm hh24:mi')
from	proc_interno w,
	prescr_procedimento x,
	prescr_proc_hor c,
	prescr_medica a
where	w.nr_sequencia = x.nr_seq_proc_interno
and	w.nr_sequencia = c.nr_seq_proc_interno
and	x.nr_prescricao = c.nr_prescricao
and	x.nr_sequencia = c.nr_seq_procedimento
and	x.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	coalesce(a.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	w.ie_tipo <> 'G'
and	w.ie_tipo <> 'BS'
and	coalesce(w.ie_ivc,'N') <> 'S'
and	coalesce(w.ie_ctrl_glic,'NC') = 'NC'
and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
and	coalesce(x.nr_seq_prot_glic::text, '') = ''
and	coalesce(x.nr_seq_exame::text, '') = ''
and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
and	coalesce(x.nr_seq_derivado::text, '') = ''
and	coalesce(x.nr_seq_prot_glic::text, '') = ''
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and	coalesce(c.ie_situacao,'A') = 'A'
and	c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
group by
	c.dt_horario;

C08 CURSOR FOR  --Controles de Glicemia
SELECT	to_char(c.dt_horario,'dd/mm hh24:mi')
from	proc_interno w,
	prescr_procedimento x,
	prescr_proc_hor c,
	prescr_medica a
where	w.nr_sequencia = x.nr_seq_proc_interno
and	w.nr_sequencia = c.nr_seq_proc_interno
and	x.nr_prescricao = c.nr_prescricao
and	x.nr_sequencia = c.nr_seq_procedimento
and	x.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	w.ie_tipo <> 'G'
and	w.ie_tipo <> 'BS'
and	coalesce(w.ie_ivc,'N') <> 'S'
and	w.ie_ctrl_glic = 'CCG'
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	coalesce(a.dt_suspensao::text, '') = ''
and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
and	(x.nr_seq_prot_glic IS NOT NULL AND x.nr_seq_prot_glic::text <> '')
and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
and	coalesce(x.nr_seq_derivado::text, '') = ''
and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and	coalesce(c.ie_situacao,'A') = 'A'
and	c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
group by
	c.dt_horario;

C09 CURSOR FOR  --Controles de Glicemia - Itens Associados
SELECT	to_char(c.dt_horario,'dd/mm hh24:mi')
from	proc_interno w,
	prescr_procedimento y,
	prescr_material x,
	prescr_mat_hor c,
	prescr_medica a
where	w.nr_sequencia = y.nr_seq_proc_interno
and	y.nr_prescricao = x.nr_prescricao
and	y.nr_sequencia = x.nr_sequencia_proc
and	y.nr_prescricao = a.nr_prescricao
and	x.nr_prescricao = c.nr_prescricao
and	x.nr_sequencia = c.nr_seq_material
and	x.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	coalesce(a.dt_suspensao::text, '') = ''
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	w.ie_tipo <> 'BS'
and	w.ie_ivc <> 'S'
and	coalesce(w.ie_ctrl_glic,'NC') = 'CCG'
and	(y.nr_seq_proc_interno IS NOT NULL AND y.nr_seq_proc_interno::text <> '')
and	(y.nr_seq_prot_glic IS NOT NULL AND y.nr_seq_prot_glic::text <> '')
and	coalesce(y.nr_seq_exame::text, '') = ''
and	coalesce(y.nr_seq_solic_sangue::text, '') = ''
and	coalesce(y.nr_seq_derivado::text, '') = ''
and	coalesce(y.nr_seq_exame_sangue::text, '') = ''
and	x.ie_agrupador = 5
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	c.ie_agrupador = 5
and	c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
group by
	c.dt_horario;

C10 CURSOR FOR  --Coletas
SELECT	to_char(c.dt_horario,'dd/mm hh24:mi')
from	prescr_procedimento x,
	prescr_proc_hor c,
	prescr_medica a
where	x.nr_prescricao = c.nr_prescricao
and	x.nr_sequencia = c.nr_seq_procedimento
and	x.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	coalesce(a.dt_suspensao::text, '') = ''
and	coalesce(x.nr_seq_proc_interno::text, '') = ''
and	(x.nr_seq_exame IS NOT NULL AND x.nr_seq_exame::text <> '')
and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
and	coalesce(x.nr_seq_derivado::text, '') = ''
and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and	coalesce(c.ie_situacao,'A') = 'A'
and	c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
group by
	c.dt_horario

union all

select	to_char(c.dt_horario,'dd/mm hh24:mi')
from	proc_interno w,
	prescr_procedimento x,
	prescr_proc_hor c,
	prescr_medica a
where	w.nr_sequencia = x.nr_seq_proc_interno
and	w.nr_sequencia = c.nr_seq_proc_interno
and	x.nr_prescricao = c.nr_prescricao
and	x.nr_sequencia = c.nr_seq_procedimento
and	x.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	w.ie_tipo <> 'G'
and	w.ie_tipo <> 'BS'
and	w.ie_ivc <> 'S'
and	coalesce(a.dt_suspensao::text, '') = ''
and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
and	coalesce(x.nr_seq_prot_glic::text, '') = ''
and	(x.nr_seq_exame IS NOT NULL AND x.nr_seq_exame::text <> '')
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
and	coalesce(x.nr_seq_derivado::text, '') = ''
and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and	coalesce(c.ie_situacao,'A') = 'A'
and	c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
group by
	c.dt_horario;

C11 CURSOR FOR  --Recomendações/Ordens
SELECT	to_char(c.dt_horario,'dd/mm hh24:mi')
from	prescr_recomendacao x,
	prescr_rec_hor c,
	prescr_medica a
where	x.nr_prescricao = c.nr_prescricao
and	x.nr_sequencia = c.nr_seq_recomendacao
and	x.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_sequencia = nr_seq_item_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	coalesce(a.dt_suspensao::text, '') = ''
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	((ie_data_lib_prescr_w = 'F') or (obter_se_prescr_lib_vipe(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w, c.dt_lib_horario) = 'S'))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and	coalesce(c.ie_situacao,'A') = 'A'
and	c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
group by
	c.dt_horario;

C12 CURSOR FOR  --Diálise
SELECT	to_char(c.dt_horario,'dd/mm hh24:mi')
from	prescr_solucao x,
	prescr_mat_hor c,
	prescr_medica a
where	x.nr_prescricao = c.nr_prescricao
and	x.nr_seq_solucao = c.nr_seq_solucao
and	x.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	coalesce(a.dt_suspensao::text, '') = ''
and	((coalesce(x.ie_acm,'N') = 'N') or (coalesce(c.ie_aprazado,'N') = 'S'))
and	a.nr_atendimento = nr_atendimento_p
and	x.nr_prescricao = nr_prescricao_p
and	x.nr_seq_solucao = nr_seq_item_p
and	obter_se_prescr_lib_vipe(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w,c.dt_lib_horario) = 'S'
and	(x.nr_seq_dialise IS NOT NULL AND x.nr_seq_dialise::text <> '')
and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	c.ie_agrupador = 13
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	adep_obter_se_gerar_sol_hor(c.dt_horario, c.dt_inicio_horario, c.dt_fim_horario, c.dt_suspensao, dt_inicial_horarios_w, dt_final_horarios_w) = 'S'
and	c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w
and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
group by
	c.dt_horario;


BEGIN

cd_setor_usuario_w := wheb_usuario_pck.get_cd_setor_atendimento;

ie_agrupar_acm_sn_w := Obter_Param_Usuario(8030, 17, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupar_acm_sn_w);
ie_data_lib_prescr_w := Obter_Param_Usuario(8030, 16, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_data_lib_prescr_w);
ie_agrupar_dose_esp_w := Obter_Param_Usuario(8030, 19, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupar_dose_esp_w);
ie_mostrar_subs_w := Obter_Param_Usuario(8030, 28, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_mostrar_subs_w);
ie_agrupar_associados_w := Obter_Param_Usuario(8030, 25, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupar_associados_w);
ie_exibe_sem_lib_farm_w := Obter_Param_Usuario(8030, 30, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_exibe_sem_lib_farm_w);
ie_exibe_dietas_w := Obter_Param_Usuario(8030, 31, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_exibe_dietas_w);
ie_considera_horario_w := Obter_Param_Usuario(8030, 46, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_considera_horario_w);
ie_agrupa_coletas_w := Obter_Param_Usuario(8030, 48, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupa_coletas_w);
ie_utiliza_serv_w := Obter_Param_Usuario(8030, 49, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_utiliza_serv_w);
ie_agrupa_item_igual_w := Obter_Param_Usuario(8030, 55, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupa_item_igual_w);

if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then
	begin
	dt_validade_limite_w	:= dt_referencia_p - 1/86400;
	dt_inicial_horarios_w	:= dt_referencia_p;
	dt_final_horarios_w	:= (dt_inicial_horarios_w + 1) - 1/86400;
	end;
else
	begin
	dt_validade_limite_w	:= clock_timestamp() - dividir(qt_horas_vigencia_w,24);
	dt_inicial_horarios_w	:= to_date(to_char(trunc(clock_timestamp() - dividir(qt_horas_anteriores_w,24),'hh24'),'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
	dt_final_horarios_w	:= to_date(to_char(trunc(clock_timestamp() + dividir(qt_horas_adicionais_w,24),'hh24'),'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
	end;
end if;

dt_fim_w := dt_validade_limite_w + 3;

if (ie_tipo_item_p = 'S') then
	open C01;
	loop
	fetch C01 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C01;
elsif (ie_tipo_item_p = 'SOL') then
	open C02;
	loop
	fetch C02 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C02;
elsif (ie_tipo_item_p = 'SNE') then
	open C03;
	loop
	fetch C03 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C03;
elsif (ie_tipo_item_p = 'NAN') then
	open C04;
	loop
	fetch C04 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C04;
elsif (ie_tipo_item_p = 'HM') then
	open C05;
	loop
	fetch C05 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C05;
elsif (ie_tipo_item_p = 'M') then
	open C06;
	loop
	fetch C06 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C06;
elsif (ie_tipo_item_p = 'P') then
	open C07;
	loop
	fetch C07 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C07 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C07;
elsif (ie_tipo_item_p = 'CCG') then
	open C08;
	loop
	fetch C08 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C08 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C08;
elsif (ie_tipo_item_p = 'IAG') then
	open C09;
	loop
	fetch C09 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C09 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C09;
elsif (ie_tipo_item_p = 'L') then
	open C10;
	loop
	fetch C10 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C10 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C10;
elsif (ie_tipo_item_p = 'R') then
	open C11;
	loop
	fetch C11 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C11 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C11;
elsif (ie_tipo_item_p = 'MD') then
	open C12;
	loop
	fetch C12 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C12 */

		if (cont_linha_w = 2) then
		cont_linha_w	:= 0;
		end if;
		if (cont_linha_w	= 0) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w;
			cont_linha_w	:= cont_linha_w + 1;
		elsif (cont_linha_w	= 1) then
			ds_horarios_w := ds_horarios_w || '    ' || dt_horario_w || chr(13) || chr(10);
			cont_linha_w	:= cont_linha_w + 1;
		end if;

	end loop;
	close C12;
end if;


return	ds_horarios_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_hor_item_relat_vipe ( cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, dt_referencia_p timestamp, ie_tipo_item_p text, ie_exibir_realizados_p text, ie_exibir_suspensos_p text, nm_usuario_p text) FROM PUBLIC;

