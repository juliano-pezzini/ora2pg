-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_diagnostico_panorama_ger (nr_atendimento_p bigint, ie_tipo_informacao text) RETURNS varchar AS $body$
DECLARE


    w_retorno triagem_pronto_atend.ds_queixa_princ%type := null;

BEGIN
    if (ie_tipo_informacao = 'A') then
        select  max(obter_desc_cid(diadoe.cd_doenca))
        into STRICT    w_retorno
        from    diagnostico_doenca diadoe
        where   diadoe.nr_atendimento = nr_atendimento_p
        and     diadoe.ie_diag_princ_episodio = 'S'
        and     (diadoe.dt_liberacao IS NOT NULL AND diadoe.dt_liberacao::text <> '')
        and     coalesce(diadoe.dt_inativacao::text, '') = ''
        and     diadoe.dt_atualizacao = (SELECT max(dido.dt_atualizacao)
                                         from   diagnostico_doenca dido
                                         where  dido.nr_atendimento = diadoe.nr_atendimento
                                         and    dido.ie_diag_princ_episodio = 'S'
                                         and    (dido.dt_liberacao IS NOT NULL AND dido.dt_liberacao::text <> '')
                                         and    coalesce(dido.dt_inativacao::text, '') = '');

        if (coalesce(w_retorno::text, '') = '') then
            select  max(obter_desc_cid(diadoe.cd_doenca))
            into STRICT    w_retorno
            from    diagnostico_doenca diadoe
            where   diadoe.nr_atendimento = nr_atendimento_p
            and     diadoe.ie_diag_admissao = 'S'
            and     diadoe.dt_atualizacao = (SELECT max(dido.dt_atualizacao)
                                             from   diagnostico_doenca dido
                                             where  dido.nr_atendimento = diadoe.nr_atendimento
                                             and    dido.ie_diag_admissao = 'S');
        end if;

        if (coalesce(w_retorno::text, '') = '') then
            select  max(obter_desc_cid(diadoe.cd_doenca))
            into STRICT    w_retorno
            from    diagnostico_doenca diadoe
            where   diadoe.nr_atendimento = nr_atendimento_p
            and     (diadoe.dt_liberacao IS NOT NULL AND diadoe.dt_liberacao::text <> '')
            and     coalesce(diadoe.dt_inativacao::text, '') = ''
            and     diadoe.dt_atualizacao = (SELECT max(dido.dt_atualizacao)
                                             from   diagnostico_doenca dido
                                             where  dido.nr_atendimento = diadoe.nr_atendimento
                                              and     (dido.dt_liberacao IS NOT NULL AND dido.dt_liberacao::text <> '')
                                              and     coalesce(dido.dt_inativacao::text, '') = '');
        end if;
        --
        if (coalesce(w_retorno::text, '') = '') then
            select  substr(obter_desc_cid(obter_cid_atendimento(nr_atendimento_p,'P')),1,240)
            into STRICT    w_retorno
;
        end if;
        --
    elsif (ie_tipo_informacao = 'P') then
        select  max(obter_desc_cid(diadoe.cd_doenca))
        into STRICT    w_retorno
        from    diagnostico_doenca diadoe
        where   diadoe.nr_atendimento = nr_atendimento_p
        and     diadoe.ie_diag_princ_episodio = 'S'
        and     (diadoe.dt_liberacao IS NOT NULL AND diadoe.dt_liberacao::text <> '')
        and     coalesce(diadoe.dt_inativacao::text, '') = ''
        and     diadoe.dt_atualizacao = (SELECT max(dido.dt_atualizacao)
                                         from   diagnostico_doenca dido
                                         where  dido.nr_atendimento = diadoe.nr_atendimento
                                         and     (dido.dt_liberacao IS NOT NULL AND dido.dt_liberacao::text <> '')
                                         and     coalesce(dido.dt_inativacao::text, '') = ''
                                         and    dido.ie_diag_princ_episodio = 'S');
    elsif (ie_tipo_informacao = 'I') then
            select  max(obter_desc_cid(diadoe.cd_doenca))
            into STRICT    w_retorno
            from    diagnostico_doenca diadoe
            where   diadoe.nr_atendimento = nr_atendimento_p
            and     diadoe.ie_diag_admissao = 'S'
            and     (diadoe.dt_liberacao IS NOT NULL AND diadoe.dt_liberacao::text <> '')
            and     coalesce(diadoe.dt_inativacao::text, '') = ''
            and     diadoe.dt_atualizacao = (SELECT max(dido.dt_atualizacao)
                                             from   diagnostico_doenca dido
                                             where  dido.nr_atendimento = diadoe.nr_atendimento
                                             and    dido.ie_diag_admissao = 'S'
                                             and    (dido.dt_liberacao IS NOT NULL AND dido.dt_liberacao::text <> '')
                                             and    coalesce(dido.dt_inativacao::text, '') = '');
    elsif (ie_tipo_informacao = 'D') then
            select  max(tpa.ds_queixa_princ)
            into STRICT    w_retorno
            from    triagem_pronto_atend tpa
            where   tpa.nr_atendimento = nr_atendimento_p
            and     (tpa.ds_queixa_princ IS NOT NULL AND tpa.ds_queixa_princ::text <> '')
            and     tpa.dt_atualizacao = (SELECT max(trprat.dt_atualizacao)
                                          from   triagem_pronto_atend trprat
                                          where  trprat.nr_atendimento = tpa.nr_atendimento
                                          and    (trprat.ds_queixa_princ IS NOT NULL AND trprat.ds_queixa_princ::text <> ''));
    end if;
    --
    return w_retorno;
    --
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_diagnostico_panorama_ger (nr_atendimento_p bigint, ie_tipo_informacao text) FROM PUBLIC;

