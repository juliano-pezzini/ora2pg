-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_indicacao ( nr_seq_pessoa_proposta_p pls_proposta_beneficiario.nr_sequencia%type, ie_opcao_p text ) RETURNS varchar AS $body$
DECLARE

 
/* ie_opcao_p: 
	* CB - Código do beneficiário de indicação 
	* DB - Descrição do beneficiário de indicação 
	* CF - Código da pessoa física de indicação 
	* DF - Descrição da pessoa física de indicação 
	* CJ - Código da pessoa jurídica de indicação 
	* DJ - Descriçãoo da pessoa jurídica de indicação 
*/
 
 
ds_retorno_w		varchar(255) := null;
nr_seq_segurado_w	pls_indicacao_venda.nr_seq_segurado%type;
cd_pessoa_fisica_w	pls_indicacao_venda.cd_pessoa_fisica%type;
cd_cgc_w		pls_indicacao_venda.cd_cgc%type;
			

BEGIN 
 
if (nr_seq_pessoa_proposta_p IS NOT NULL AND nr_seq_pessoa_proposta_p::text <> '') then 
	begin 
	select	nr_seq_segurado, 
		cd_pessoa_fisica, 
		cd_cgc 
	into STRICT	nr_seq_segurado_w, 
		cd_pessoa_fisica_w, 
		cd_cgc_w 
	from (SELECT	b.nr_seq_segurado, 
			b.cd_pessoa_fisica, 
			b.cd_cgc		 
		from	pls_proposta_beneficiario	a, 
			pls_indicacao_venda		b 
		where	b.nr_seq_segurado_prop 	= a.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_pessoa_proposta_p 
		
union all
 
		SELECT	b.nr_seq_segurado, 
			b.cd_pessoa_fisica, 
			b.cd_cgc 
		from	pls_proposta_beneficiario	a, 
			pls_indicacao_venda		b, 
			pls_proposta_adesao		c 
		where	b.nr_seq_proposta 	= c.nr_sequencia 
		and	a.nr_seq_proposta 	= c.nr_sequencia 
		and	a.nr_sequencia 		= nr_seq_pessoa_proposta_p 
		and	not exists (select	1 
					from	pls_proposta_beneficiario	x, 
						pls_indicacao_venda		y 
					where	y.nr_seq_segurado_prop	= x.nr_sequencia 
					and	x.nr_sequencia = a.nr_sequencia)) alias2;
	exception 
	when others then 
		nr_seq_segurado_w	:= null;
		cd_pessoa_fisica_w	:= null;
		cd_cgc_w		:= null;
	end;
 
	if (ie_opcao_p = 'CB') then -- CB - Código do beneficiário de indicação 
		 
		ds_retorno_w := nr_seq_segurado_w;
		 
	elsif (ie_opcao_p = 'DB') then -- DB - Descrição do beneficiário de indicação 
		if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then	 
			ds_retorno_w := substr(pls_obter_dados_segurado(nr_seq_segurado_w,'N'),1,255);
		end if;
	elsif (ie_opcao_p = 'CF') then -- CF - Código da pessoa física de indicação 
 
		ds_retorno_w := cd_pessoa_fisica_w;
 
	elsif (ie_opcao_p = 'DF') then -- DF - Descrição da pessoa física de indicação 
		if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then	 
			ds_retorno_w := substr(obter_nome_pf(cd_pessoa_fisica_w),1,255);
		end if;	
	elsif (ie_opcao_p = 'CJ') then -- CJ - Código da pessoa jurídica de indicação 
 
		ds_retorno_w := cd_cgc_w;
		 
	elsif (ie_opcao_p = 'DJ') then -- DJ - Descriçãoo da pessoa jurídica de indicação 
		if (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then	 
			ds_retorno_w := substr(obter_nome_pf_pj(null, cd_cgc_w),1,255);
		end if;	
	end if;		
end if;	
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_indicacao ( nr_seq_pessoa_proposta_p pls_proposta_beneficiario.nr_sequencia%type, ie_opcao_p text ) FROM PUBLIC;

