-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prescr_onc_autor (nr_seq_autor_p bigint) RETURNS varchar AS $body$
DECLARE


nr_presricao_w autorizacao_convenio.ds_observacao%type;

  R RECORD;

BEGIN

for R in (
    SELECT p.NR_PRESCRICAO
      from autorizacao_convenio a, paciente_atendimento p 
     where nr_sequencia = nr_seq_autor_p
       and a.ie_tipo_dia = 'D'
       and a.ds_dia_ciclo = p.ds_dia_ciclo
       and a.nr_seq_paciente  = p.nr_seq_atendimento
    
union

    SELECT p.NR_PRESCRICAO 
      from autorizacao_convenio a, paciente_atendimento p 
     where nr_sequencia = nr_seq_autor_p
       and a.ie_tipo_dia = 'C'
       and a.nr_ciclo = p.nr_ciclo
       and a.nr_seq_paciente_setor  = p.nr_seq_paciente
) loop
    if (R.nr_prescricao IS NOT NULL AND R.nr_prescricao::text <> '') then
        nr_presricao_w := nr_presricao_w||trim(both R.nr_prescricao)||',';
    end if;
end loop;

return SUBSTR(nr_presricao_w,1,LENGTH(nr_presricao_w)-1);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prescr_onc_autor (nr_seq_autor_p bigint) FROM PUBLIC;

