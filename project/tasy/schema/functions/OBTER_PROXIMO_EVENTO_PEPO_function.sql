-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_proximo_evento_pepo ( nr_cirurgia_p bigint, cd_perfil_ativo_p bigint, ie_estrutura_pepo text default 'N', ie_tipo_item_p text default 'P', nr_seq_pepo_p bigint default null) RETURNS bigint AS $body$
DECLARE


nr_seq_exec_max_registrado_w    bigint;
nr_seq_exec_min_disponivel_w    bigint;
nr_sequencia_proximo_evento_w   bigint;
cd_estabelecimento_w            bigint := wheb_usuario_pck.get_cd_estabelecimento;


BEGIN

if (ie_estrutura_pepo = 'N') then
    select  max(a.nr_seq_execucao)
    into STRICT    nr_seq_exec_max_registrado_w
    from    evento_cirurgia a,
            evento_cirurgia_paciente b
    where   b.nr_seq_evento = a.nr_sequencia
    and     b.nr_cirurgia = nr_cirurgia_p
    and     coalesce(b.ie_situacao,'A') = 'A';
elsif (ie_estrutura_pepo = 'S' and coalesce(nr_seq_pepo_p::text, '') = '') then
    select  max(a.nr_seq_execucao)
    into STRICT    nr_seq_exec_max_registrado_w
    from    evento_cirurgia a,
            evento_cirurgia_paciente b
    where   b.nr_seq_evento = a.nr_sequencia
    and     b.nr_seq_pepo = nr_cirurgia_p
    and     coalesce(b.ie_situacao,'A') = 'A';
elsif (ie_estrutura_pepo = 'S' and (nr_seq_pepo_p IS NOT NULL AND nr_seq_pepo_p::text <> '')) then
    select  max(a.nr_seq_execucao)
    into STRICT    nr_seq_exec_max_registrado_w
    from    evento_cirurgia a,
            evento_cirurgia_paciente b
    where   b.nr_seq_evento = a.nr_sequencia
    and     ((coalesce(b.nr_cirurgia, 0) = coalesce(nr_cirurgia_p, 0) and b.nr_seq_pepo = coalesce(nr_seq_pepo_p, 0)) or (coalesce(b.nr_cirurgia::text, '') = '' and b.nr_seq_pepo = coalesce(nr_seq_pepo_p, 0)))
    and     coalesce(b.ie_situacao,'A') = 'A';
end if;

if (ie_estrutura_pepo = 'N') then  	
    select  min(nr_seq_execucao)
    into STRICT    nr_seq_exec_min_disponivel_w
    from    evento_cirurgia
    where   substr(obter_se_mostra_evento(nr_cirurgia_p,null,nr_sequencia, cd_perfil_ativo_p),1,1) = 'S'
    and     ie_situacao = 'A'
    and     ((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
    and (coalesce(nr_seq_exec_max_registrado_w::text, '') = '' or nr_seq_execucao > nr_seq_exec_max_registrado_w);
elsif (ie_estrutura_pepo = 'S' and coalesce(nr_seq_pepo_p::text, '') = '') then
    select  min(nr_seq_execucao)
    into STRICT    nr_seq_exec_min_disponivel_w
    from    evento_cirurgia
    where   ((substr(obter_se_mostra_evento(null,nr_cirurgia_p,nr_sequencia, cd_perfil_ativo_p),1,1) = 'S') or (substr(obter_se_mostra_evento(nr_cirurgia_p,null,nr_sequencia, cd_perfil_ativo_p),1,1) = 'S'))
    and     ie_situacao = 'A'
    and     ((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
    and (coalesce(nr_seq_exec_max_registrado_w::text, '') = '' or nr_seq_execucao > nr_seq_exec_max_registrado_w)
    and     ((coalesce(ie_tipo_item, ie_tipo_item_p) = ie_tipo_item_p) or (ie_tipo_item = 'A') );
elsif (ie_estrutura_pepo = 'S' and (nr_seq_pepo_p IS NOT NULL AND nr_seq_pepo_p::text <> '')) then
    select  min(nr_seq_execucao)
    into STRICT    nr_seq_exec_min_disponivel_w
    from    evento_cirurgia
    where (substr(obter_se_mostra_evento(nr_cirurgia_p,nr_seq_pepo_p,nr_sequencia, cd_perfil_ativo_p),1,1) = 'S')
    and     ie_situacao = 'A'
    and     ((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
    and (coalesce(nr_seq_exec_max_registrado_w::text, '') = '' or nr_seq_execucao > nr_seq_exec_max_registrado_w)
    and     ((coalesce(ie_tipo_item, ie_tipo_item_p) = ie_tipo_item_p) or (ie_tipo_item = 'A') );
end if;

if (nr_seq_exec_min_disponivel_w IS NOT NULL AND nr_seq_exec_min_disponivel_w::text <> '') then
    if (ie_estrutura_pepo = 'N') then
        select  max(a.nr_sequencia)
        into STRICT    nr_sequencia_proximo_evento_w
        from    evento_cirurgia a
        where (substr(obter_se_mostra_evento(nr_cirurgia_p,null,nr_sequencia, cd_perfil_ativo_p),1,1) = 'S')
        and     a.nr_seq_execucao = nr_seq_exec_min_disponivel_w
        and     ((a.cd_estabelecimento = cd_estabelecimento_w) or (coalesce(a.cd_estabelecimento::text, '') = ''))
        and     a.ie_situacao = 'A'
        and     ((coalesce(ie_tipo_item, ie_tipo_item_p) = ie_tipo_item_p) or (ie_tipo_item = 'A') );
    elsif (ie_estrutura_pepo = 'S') then
        select  max(a.nr_sequencia)
        into STRICT    nr_sequencia_proximo_evento_w
        from    evento_cirurgia a
        where   (((substr(obter_se_mostra_evento(null,nr_cirurgia_p,nr_sequencia, cd_perfil_ativo_p),1,1) = 'S') and coalesce(nr_seq_pepo_p::text, '') = '') or
                ((substr(obter_se_mostra_evento(nr_cirurgia_p, nr_seq_pepo_p, nr_sequencia, cd_perfil_ativo_p),1,1) = 'S') and (nr_seq_pepo_p IS NOT NULL AND nr_seq_pepo_p::text <> '')))
        and     a.nr_seq_execucao = nr_seq_exec_min_disponivel_w
        and     ((a.cd_estabelecimento = cd_estabelecimento_w) or (coalesce(a.cd_estabelecimento::text, '') = ''))
        and     a.ie_situacao = 'A'
        and     ((coalesce(ie_tipo_item, ie_tipo_item_p) = ie_tipo_item_p) or (ie_tipo_item = 'A') );
    end if;
end if;

return coalesce(nr_sequencia_proximo_evento_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_proximo_evento_pepo ( nr_cirurgia_p bigint, cd_perfil_ativo_p bigint, ie_estrutura_pepo text default 'N', ie_tipo_item_p text default 'P', nr_seq_pepo_p bigint default null) FROM PUBLIC;

