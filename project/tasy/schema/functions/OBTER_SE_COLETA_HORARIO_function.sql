-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_coleta_horario (nr_atendimento_p bigint, nr_seq_horario_p bigint) RETURNS varchar AS $body$
DECLARE


nr_prescricao_w	bigint;
nr_seq_item_w		bigint;
dt_horario_w		timestamp;
cd_material_exame_w	varchar(20);
ie_coleta_horario_w	varchar(1) := 'N';


BEGIN
if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then
	/* obter dados horÃ¡rio */

	select	coalesce(max(nr_prescricao),0),
		coalesce(max(nr_seq_procedimento),0),
		coalesce(max(dt_horario),null)
	into STRICT	nr_prescricao_w,
		nr_seq_item_w,
		dt_horario_w
	from	prescr_proc_hor
	where	nr_sequencia = nr_seq_horario_p
	and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

	/* obter material exame */

	if (nr_prescricao_w > 0) and (nr_seq_item_w > 0) and (dt_horario_w IS NOT NULL AND dt_horario_w::text <> '') then
		select	coalesce(max(cd_material_exame),'0')
		into STRICT	cd_material_exame_w
		from	prescr_procedimento
		where	nr_prescricao	= nr_prescricao_w
		and	nr_sequencia	= nr_seq_item_w;

		/* obter coleta material horario */

		if (coalesce(cd_material_exame_w,'0') <> '0') then
			select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
			into STRICT	ie_coleta_horario_w
			from	prescr_proc_hor c,
				prescr_procedimento b,
				prescr_medica a
			where	c.nr_seq_procedimento = b.nr_sequencia
			and	c.nr_prescricao = b.nr_prescricao
			and	b.nr_prescricao = a.nr_prescricao
			and	substr(obter_status_hor_prescr(c.nr_sequencia, 'P'),1,1) = 'N'
			and	coalesce(c.ie_horario_especial,'N') = 'N'
			and	b.ie_origem_inf = '1'
			and	c.dt_horario = dt_horario_w
			and	b.cd_material_exame = cd_material_exame_w
			and (b.nr_sequencia <> nr_seq_item_w or b.nr_prescricao <> nr_prescricao_w)
			and	a.nr_atendimento = nr_atendimento_p
			and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S';
		end if;
	end if;
end if;

if (ie_coleta_horario_w = 'S') then
	return cd_material_exame_w;
else
	return ie_coleta_horario_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_coleta_horario (nr_atendimento_p bigint, nr_seq_horario_p bigint) FROM PUBLIC;

