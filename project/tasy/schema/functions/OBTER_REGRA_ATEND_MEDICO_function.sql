-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_atend_medico ( nr_atendimento_p bigint, cd_medico_p text) RETURNS varchar AS $body$
DECLARE

 
ie_pasta_w			varchar(03)	:= null;
cd_setor_atendimento_w	integer;
ie_clinica_w			integer;
cd_estabelecimento_w		integer;
cd_pessoa_fisica_w		varchar(10);
qt_atendimento_w		integer;

c01 CURSOR FOR 
SELECT ie_pasta 
from 	Regra_Atend_medico 
where	cd_estabelecimento						= cd_estabelecimento_w	 
 and	coalesce(cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w 
 and	coalesce(ie_clinica, ie_clinica_w)				= ie_clinica_w 
 and	coalesce(cd_medico, cd_medico_p)					= cd_medico_p 
 and ((qt_atendimento_w > 1) or (ie_prim_atend = 'N')) 
 and	qt_atendimento_w	> 0 
order by 
	coalesce(cd_setor_atendimento,0), 
	coalesce(ie_clinica,0), 
	coalesce(cd_medico,0);


BEGIN 
 
select	max(cd_estabelecimento), 
	max(ie_clinica), 
	max(cd_setor_atendimento), 
	max(cd_pessoa_fisica) 
into STRICT	cd_estabelecimento_w, 
	ie_clinica_w, 
	cd_setor_atendimento_w, 
	cd_pessoa_fisica_w 
from	atendimento_paciente_v 
where	nr_atendimento	= nr_atendimento_p;
 
select count(*) 
into STRICT	qt_atendimento_w 
from	atendimento_paciente 
where	cd_pessoa_fisica	= coalesce(cd_pessoa_fisica_w,0);
 
OPEN C01;
LOOP 
	FETCH C01 into 
		ie_pasta_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		ie_pasta_w		:= ie_pasta_w;
END LOOP;
CLOSE C01;
 
RETURN coalesce(ie_pasta_w,'E');
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_atend_medico ( nr_atendimento_p bigint, cd_medico_p text) FROM PUBLIC;

