-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_atend_episodio_interg ( nr_episodio_p text, dt_integracao_p text default null) RETURNS bigint AS $body$
DECLARE

  nr_atendimento_w atendimento_paciente.nr_atendimento%type;
  nr_seq_episodio_w episodio_paciente.nr_sequencia%type;

BEGIN

	if (dt_integracao_p IS NOT NULL AND dt_integracao_p::text <> '') then
		select 	max(nr_atendimento)
		into STRICT	nr_atendimento_w
		from 	atendimento_paciente
		where 	nr_seq_episodio in (SELECT nr_sequencia
									from EPISODIO_PACIENTE
									where nr_episodio = nr_episodio_p)
		and 	dt_entrada >= to_date(dt_integracao_p, 'yyyy/mm/dd hh24:mi:ss');

		if (coalesce(nr_atendimento_w::text, '') = '') then
			select 	max(nr_atendimento)
			into STRICT 	nr_atendimento_w
			from 	atendimento_paciente
			where 	nr_seq_episodio = nr_episodio_p
			and 	dt_entrada >= to_date(dt_integracao_p, 'yyyy/mm/dd hh24:mi:ss');
		end if;

	end if;

	if (coalesce(nr_atendimento_w::text, '') = '' or coalesce(dt_integracao_p::text, '') = '')then
		select max(nr_sequencia)
		into STRICT nr_seq_episodio_w
		from episodio_paciente
		where NR_EPISODIO = nr_episodio_p;

		select max(nr_atendimento)
		into STRICT nr_atendimento_w
		from atendimento_paciente
		where nr_seq_episodio = nr_seq_episodio_w;

		if (coalesce(nr_atendimento_w::text, '') = '') then
			select max(nr_atendimento)
			into STRICT nr_atendimento_w
			from atendimento_paciente
			where nr_seq_episodio = nr_episodio_p;
		end if;
	end if;
return nr_atendimento_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_atend_episodio_interg ( nr_episodio_p text, dt_integracao_p text default null) FROM PUBLIC;

