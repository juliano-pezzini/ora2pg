-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_perda_cre ( nr_seq_perda_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(255);

nm_pessoa_w		varchar(255);
vl_saldo_w		double precision;
vl_perdas_w		double precision;
nr_titulo_w		bigint;
nr_seq_baixa_w		bigint;
nr_interno_conta_w	bigint;
nr_seq_cheque_w		bigint;
nm_paciente_w		varchar(255);
nr_seq_trans_financ_w	bigint;
cd_pessoa_fisica_w	varchar(10);

/* 
np - nome da pessoa da perda 
vs - valor de saldo da perda 
vp - valor da perda 
dc- dados complementares (saldo + valor + pessoa) 
nc - número da conta paciente 
pc - nome do paciente 
cp - código do paciente 
tf - transação financeira 
vj - valor total de juros nas baixas 
vd - valor total de desconto nas baixas 
*/
 
 

BEGIN 
if (nr_seq_perda_p > 0) then 
	begin 
	begin 
	select	vl_saldo, 
		vl_perdas, 
		nr_titulo, 
		nr_seq_baixa, 
		nr_seq_cheque 
	into STRICT	vl_saldo_w, 
		vl_perdas_w, 
		nr_titulo_w, 
		nr_seq_baixa_w, 
		nr_seq_cheque_w 
	from	perda_contas_receber 
	where	nr_sequencia = nr_seq_perda_p;
	 
	if (ie_opcao_p = 'NP') then 
		select	obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc) 
		into STRICT	ds_retorno_w 
		from	perda_contas_receber 
		where	nr_sequencia = nr_seq_perda_p;
	elsif (ie_opcao_p = 'VS') then 
		ds_retorno_w := to_char(vl_saldo_w);
	elsif (ie_opcao_p = 'VP') then 
		ds_retorno_w := to_char(vl_perdas_w);
	elsif (ie_opcao_p = 'DC') then 
		begin 
		select	obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc) 
		into STRICT	nm_pessoa_w 
		from	perda_contas_receber 
		where	nr_sequencia = nr_seq_perda_p;
				 
		ds_retorno_w := substr(WHEB_MENSAGEM_PCK.get_texto(308154,'VL_PERDAS_W=' || campo_mascara_virgula(vl_perdas_w) || ';' || 
									'VL_SALDO_W=' || campo_mascara_virgula(vl_saldo_w) || ';' || 
									'NM_PESSOA_W=' || nm_pessoa_w),1,255);
		end;
	elsif (ie_opcao_p = 'NC') then 
	 
		if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then 
		 
			select	max(b.nr_interno_conta) 
			into STRICT	nr_interno_conta_w 
			from	convenio_retorno_item b, 
				titulo_receber_liq a 
			where	a.nr_seq_ret_item	= b.nr_sequencia 
			and	a.nr_titulo		= nr_titulo_w 
			and	a.nr_sequencia		= nr_seq_baixa_w;
			 
			if (coalesce(nr_interno_conta_w::text, '') = '') then 
				nr_interno_conta_w := substr(obter_dados_titulo_receber(nr_titulo_w,'NIC'),1,10);
			end if;
			 
			ds_retorno_w	:= nr_interno_conta_w;					
		end if;		
	elsif (ie_opcao_p = 'PC') then	 
		if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then		 
			select	max(substr(obter_nome_pf_pj(d.cd_pessoa_fisica,null),1,255)) 
			into STRICT	nm_paciente_w 
			from	atendimento_paciente d, 
				conta_paciente c, 
				convenio_retorno_item b, 
				titulo_receber_liq a 
			where	a.nr_seq_ret_item	= b.nr_sequencia 
			and	c.nr_interno_conta	= b.nr_interno_conta 
			and	c.nr_atendimento	= d.nr_atendimento 
			and	a.nr_titulo		= nr_titulo_w 
			and	a.nr_sequencia		= nr_seq_baixa_w;
			 
			if (coalesce(nm_paciente_w::text, '') = '') then 
				nm_paciente_w := substr(obter_dados_titulo_receber(nr_titulo_w,'PA'),1,255);
			end if;	
		 
			ds_retorno_w	:= nm_paciente_w;
		else 
			nm_paciente_w	:= substr(obter_dados_cheque_cr(nr_seq_cheque_w, 'NP'),1,255);
			 
			ds_retorno_w	:= nm_paciente_w;
		end if;
	elsif (ie_opcao_p in ('TF','DTF')) then 
		begin 
		nr_seq_trans_financ_w := null;
		 
		if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then 
			select	max(nr_seq_trans_fin) 
			into STRICT	nr_seq_trans_financ_w 
			from	titulo_receber_liq a 
			where	a.nr_titulo		= nr_titulo_w 
			and	a.nr_sequencia	= nr_seq_baixa_w;
		elsif (nr_seq_cheque_w IS NOT NULL AND nr_seq_cheque_w::text <> '') then 
			select	max(a.nr_seq_trans_financ) 
			into STRICT	nr_seq_trans_financ_w 
			from	caixa_receb a, 
				cheque_cr_perda b 
			where	a.nr_sequencia	= b.nr_seq_caixa_rec 
			and	b.nr_seq_cheque	= nr_seq_cheque_w;
		end if;
		 
		if (ie_opcao_p = 'TF') then 
			ds_retorno_w := to_char(nr_seq_trans_financ_w);
		elsif (ie_opcao_p = 'DTF') then 
			select	substr(max(ds_transacao),1,255) 
			into STRICT	ds_retorno_w 
			from	transacao_financeira 
			where	nr_sequencia	= nr_seq_trans_financ_w;
		end if;
		end;
	elsif (ie_opcao_p = 'VJ') then 
		select	sum(vl_baixa) 
		into STRICT	ds_retorno_w 
		from	perda_contas_receb_baixa a, 
			fin_tipo_baixa_perda b 
		where	a.nr_seq_tipo_baixa = b.nr_sequencia 
		and	b.ie_tipo_consistencia = 3 
		and	nr_seq_perda = nr_seq_perda_p;
	elsif (ie_opcao_p = 'VD') then 
		select	sum(vl_baixa) 
		into STRICT	ds_retorno_w 
		from	perda_contas_receb_baixa a, 
			fin_tipo_baixa_perda b 
		where	a.nr_seq_tipo_baixa = b.nr_sequencia 
		and	b.ie_tipo_consistencia = 1 
		and	nr_seq_perda = nr_seq_perda_p;
	elsif (ie_opcao_p = 'CP') then	 
		if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then		 
			select	max(d.cd_pessoa_fisica) 
			into STRICT	cd_pessoa_fisica_w 
			from	atendimento_paciente d, 
				conta_paciente c, 
				titulo_receber b, 
				titulo_receber_liq a 
			where	a.nr_titulo		= b.nr_titulo 
			and	c.nr_interno_conta	= b.nr_interno_conta 
			and	c.nr_atendimento	= d.nr_atendimento 
			and	a.nr_titulo		= nr_titulo_w 
			and	a.nr_sequencia		= nr_seq_baixa_w;
			 
			if (coalesce(cd_pessoa_fisica_w::text, '') = '') then 
				cd_pessoa_fisica_w := substr(obter_dados_titulo_receber(nr_titulo_w,'CP'),1,255);
			end if;	
		 
			ds_retorno_w		:= cd_pessoa_fisica_w;
		else 
			cd_pessoa_fisica_w	:= substr(obter_dados_cheque_cr(nr_seq_cheque_w, 'CP'),1,255);
			 
			ds_retorno_w		:= cd_pessoa_fisica_w;
		end if;
	end if;	
	exception 
	when others then 
		ds_retorno_w := null;
	end;
	end;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_perda_cre ( nr_seq_perda_p bigint, ie_opcao_p text) FROM PUBLIC;

