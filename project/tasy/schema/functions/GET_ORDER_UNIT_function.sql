-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_order_unit (nr_prescricao_p text, nr_sequencia_p text) RETURNS varchar AS $body$
DECLARE

  NR_ORDER_UNIT_W varchar(20);

BEGIN
    NR_ORDER_UNIT_W := NULL;

    IF (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') AND (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') THEN
    SELECT  MAX(O.NR_ORDER_UNIT)
    into STRICT    NR_ORDER_UNIT_W
    FROM   MATERIAL M,
           CPOE_MATERIAL A,
           PRESCR_MEDICA B,
           PRESCR_MATERIAL C,
           PRESCR_MAT_HOR D,
           CPOE_ORDER_UNIT O,
           CPOE_RP R
    WHERE  M.CD_MATERIAL = A.CD_MATERIAL
           AND C.CD_MATERIAL = A.CD_MATERIAL
           AND B.NR_PRESCRICAO = C.NR_PRESCRICAO
           AND B.NR_PRESCRICAO = D.NR_PRESCRICAO
           AND C.NR_SEQUENCIA = D.NR_SEQ_MATERIAL
           AND A.NR_SEQ_CPOE_ORDER_UNIT = O.NR_SEQUENCIA
           AND A.NR_SEQUENCIA = C.NR_SEQ_MAT_CPOE
           AND A.NR_SEQ_CPOE_RP = R.NR_SEQUENCIA
           AND (A.NR_SEQ_CPOE_RP IS NOT NULL AND A.NR_SEQ_CPOE_RP::text <> '')
           AND D.NR_PRESCRICAO = nr_prescricao_p
           AND O.NR_SEQ_LOTE = nr_sequencia_p;
    END IF;

    RETURN NR_ORDER_UNIT_W;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_order_unit (nr_prescricao_p text, nr_sequencia_p text) FROM PUBLIC;

