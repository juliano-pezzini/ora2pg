-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_if_activation_key_valid ( ds_key_p text, cd_cgc_cliente_p text) RETURNS bigint AS $body$
DECLARE


ds_key_w varchar(255);
dt_validade_w timestamp;
cd_funcao_w bigint;
ie_checksum_w varchar(1);
cd_cgc_cliente_w varchar(14);


BEGIN
  begin
      ds_key_w := substr(wheb_seguranca.decrypt(ds_key_p),1,255);
      select to_date(substr(ds_key_w,1,8),'ddmmyyyy'),
        trim(both substr(ds_key_w,9,5)),
        substr(ds_key_w,14,14),
        substr(ds_key_w,length(ds_key_w),1)
      into STRICT dt_validade_w,
        cd_funcao_w,
        cd_cgc_cliente_w,
        ie_checksum_w
;

  exception when others then
      return null;
  end;

  if (GET_CHECKSUM_ACTIVATION(substr(ds_key_w,1,length(ds_key_w)-1)) <> ie_checksum_w) then
    return null;
  elsif (dt_validade_w < clock_timestamp()) then
    return null;
  elsif (trim(both cd_cgc_cliente_w) <> trim(both cd_cgc_cliente_p)) then
    return null;
  end if;

  return cd_funcao_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_if_activation_key_valid ( ds_key_p text, cd_cgc_cliente_p text) FROM PUBLIC;

