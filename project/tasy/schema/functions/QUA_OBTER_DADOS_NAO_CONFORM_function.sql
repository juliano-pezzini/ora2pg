-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION qua_obter_dados_nao_conform ( nr_sequencia_p bigint, ie_tipo_dado_p text) RETURNS varchar AS $body$
DECLARE

 
nm_resp_eficacia_w		varchar(100);
cd_pf_resp_eficacia_w		varchar(10);
qr_dia_analise_eficacia_w		bigint;
ds_retorno_w			varchar(100);
ie_status_w			varchar(15);
dt_fim_ultima_acao_w		timestamp;

/* ie_tipo_dado 
RE - Nome responsável eficácia 
CE - Código responsável eficácia 
DE - Dias para análise eficácia 
ST - Status da não conformidade 
AAE- Atraso da análise da eficácia - Retorna S ou N 
*/
 
 

BEGIN 
 
select	substr(obter_nome_pessoa_fisica(cd_pf_resp_eficacia, null),1,100), 
	cd_pf_resp_eficacia, 
	qr_dia_analise_eficacia, 
	ie_status 
into STRICT	nm_resp_eficacia_w, 
	cd_pf_resp_eficacia_w, 
	qr_dia_analise_eficacia_w, 
	ie_status_w 
from	qua_nao_conformidade 
where	nr_sequencia = nr_sequencia_p;
 
if (ie_tipo_dado_p = 'RE') then 
	ds_retorno_w	:= nm_resp_eficacia_w;
elsif (ie_tipo_dado_p = 'CE') then 
	ds_retorno_w	:= cd_pf_resp_eficacia_w;
elsif (ie_tipo_dado_p = 'DE') then 
	ds_retorno_w	:= qr_dia_analise_eficacia_w;
elsif (ie_tipo_dado_p = 'ST') then 
	ds_retorno_w	:= ie_status_w;
elsif (ie_tipo_dado_p = 'AAE') then 
	ds_retorno_w := 'N';
	 
	select	max(dt_fim_real) 
	into STRICT	dt_fim_ultima_acao_w 
	from	man_ordem_servico 
	where	nr_seq_nao_conform = nr_sequencia_p;
	 
	if (dt_fim_ultima_acao_w IS NOT NULL AND dt_fim_ultima_acao_w::text <> '') and (obter_dias_entre_datas(dt_fim_ultima_acao_w, clock_timestamp()) > qr_dia_analise_eficacia_w) then 
		ds_retorno_w := 'S';
	end if;
end if;
 
return	ds_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION qua_obter_dados_nao_conform ( nr_sequencia_p bigint, ie_tipo_dado_p text) FROM PUBLIC;

