-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_envio_lacre (nr_envio_lacre_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/* D = dt_dispensacao, E = dt_entrega, R = dt_recebimento, S = status_maleta */

dt_agendamento_w  varchar(20);
dt_dispensacao_w  varchar(20);
dt_retirada_w     varchar(20);
dt_entrega_w      varchar(20);
dt_recebimento_w  varchar(20);
ds_retorno_w      varchar(20) := '';


BEGIN
if (nr_envio_lacre_p IS NOT NULL AND nr_envio_lacre_p::text <> '') THEN

  SELECT  To_Char(a.dt_agendamento, 'dd/mm/yyyy hh24:mi') dt_agendamento,
          To_Char(Max(c.dt_retirada), 'dd/mm/yyyy hh24:mi') dt_dispensacao,
          To_Char(a.dt_retirada, 'dd/mm/yyyy hh24:mi') dt_retirada,
          To_Char(Max(c.dt_entrega), 'dd/mm/yyyy hh24:mi') dt_entrega,
          To_Char(Max(c.dt_recebimento), 'dd/mm/yyyy hh24:mi') dt_recebimento
  INTO STRICT
          dt_agendamento_w,
          dt_dispensacao_w,
          dt_retirada_w,
          dt_entrega_w,
          dt_recebimento_w
  from  envio_lacre a,
        envio_lacre_processo b,
        adep_processo c
  where a.ds_lacre = nr_envio_lacre_p
  and   a.nr_sequencia = b.nr_seq_envio_lacre
  and   b.nr_seq_processo_gedipa = c.nr_sequencia
  group by a.ds_lacre, a.dt_agendamento, a.dt_retirada;

  if (ie_opcao_p = 'D') THEN
    ds_retorno_w := dt_dispensacao_w;
  elsif (ie_opcao_p = 'E') then
    ds_retorno_w := dt_entrega_w;
  elsif (ie_opcao_p = 'R') then
    ds_retorno_w := dt_recebimento_w;
  elsif (ie_opcao_p = 'S') then

    if (dt_agendamento_w IS NOT NULL AND dt_agendamento_w::text <> '') then
      ds_retorno_w := obter_desc_expressao(309688);
    end if;
    if (dt_dispensacao_w IS NOT NULL AND dt_dispensacao_w::text <> '') then
      ds_retorno_w := obter_desc_expressao(311227);
    end if;
    if (dt_retirada_w IS NOT NULL AND dt_retirada_w::text <> '') then
      ds_retorno_w := obter_desc_expressao(331555); --retirada
    end if;
    if (dt_entrega_w IS NOT NULL AND dt_entrega_w::text <> '') then
      ds_retorno_w := obter_desc_expressao(289288); --Entregue
    end if;
    if (dt_recebimento_w IS NOT NULL AND dt_recebimento_w::text <> '') then
      ds_retorno_w := obter_desc_expressao(297308);
    end if;

  end if;

end if;

return ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_envio_lacre (nr_envio_lacre_p text, ie_opcao_p text) FROM PUBLIC;

