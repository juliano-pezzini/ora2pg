-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gerar_recibo_matricial (nr_seq_caixa_rec_p text, ie_tipo_documento_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

	
ds_retorno_w		varchar(4000);
nr_atendimento_w	bigint;
nr_titulo_w		bigint;


BEGIN
if (ie_tipo_documento_p = 'T') then

	select	max(a.nr_titulo)
	into STRICT	nr_titulo_w
	from	titulo_receber a,
		titulo_receber_liq b,
		caixa_receb c
	where	a.nr_titulo = b.nr_titulo
	and	b.nr_seq_caixa_rec = c.nr_sequencia
	and	b.nr_seq_caixa_rec = nr_seq_caixa_rec_p;

	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	titulo_receber
	where	nr_titulo	= nr_titulo_w;
	
	select	substr(ptu_somente_caracter_permitido(obter_nome_estabelecimento(cd_estabelecimento_p), 'ANSE'),1,40) || '|' ||
		substr(ptu_somente_caracter_permitido(obter_dados_estab(cd_estabelecimento_p, 3), 'ANSE'),1,40) || '|' ||
		Wheb_mensagem_pck.get_texto(301708) || ': ' || (to_char(clock_timestamp(), 'dd/mm/yyyy')) || '          ' || Wheb_mensagem_pck.get_texto(301710) || ': ' || (to_char(clock_timestamp(), 'hh24:mm:ss')) || '|' ||
		LPAD('-',45,'-')  || '|' ||
		Wheb_mensagem_pck.get_texto(301732,'NR_SEQ_RECIBO=' || MAX(c.nr_recibo)) || '|' ||
		Wheb_mensagem_pck.get_texto(301713) || ': ' || SUBSTR(ptu_somente_caracter_permitido(obter_nome_pf_pj(MAX(a.cd_pessoa_fisica), MAX(a.cd_cgc)), 'ANSE'),1,40) || '|' ||
		Wheb_mensagem_pck.get_texto(301715) || '   : ' || SUBSTR(ptu_somente_caracter_permitido(obter_paciente_titulo(MAX(a.nr_titulo), 'X' ), 'ANSE'),1,40) || '|' || 
		Wheb_mensagem_pck.get_texto(301716) || '	    : ' || substr(ptu_somente_caracter_permitido(obter_dados_atendimento(nr_atendimento_w, 'NMR'), 'ANSE'),1,40) || '|' || 
		Wheb_mensagem_pck.get_texto(301717) || ' : ' || TO_CHAR(MAX(a.dt_vencimento), 'dd/mm/yyyy') || '|' ||
		Wheb_mensagem_pck.get_texto(301718) || '  : ' || TO_CHAR(MAX(b.dt_recebimento), 'dd/mm/yyyy') || '|' ||
		Wheb_mensagem_pck.get_texto(301719) || ' : ' || campo_mascara(SUM(a.vl_titulo),2) || '|' ||
		Wheb_mensagem_pck.get_texto(301720) || ': ' || campo_mascara(SUM(b.vl_descontos),2) || '|' ||
		ptu_somente_caracter_permitido(Wheb_mensagem_pck.get_texto(301721), 'ANSE') || '  : ' || campo_mascara(SUM(b.vl_outros_acrescimos),2) || '|' ||
		Wheb_mensagem_pck.get_texto(301722) || '      : ' || campo_mascara(SUM(b.vl_juros),2) || '|' ||
		Wheb_mensagem_pck.get_texto(301723) || ': ' || campo_mascara(coalesce((SUM(a.vl_saldo_titulo) + SUM(b.vl_outros_acrescimos) + SUM(b.vl_juros)) - SUM(b.vl_descontos),0),2)  || '|' ||
		Wheb_mensagem_pck.get_texto(301724) || '      : ' || campo_mascara(coalesce(SUM(a.vl_saldo_titulo), 0),2) || '|' ||
		LPAD('-',45,'-')  || '|' ||
		Wheb_mensagem_pck.get_texto(301725) || '|' ||
		LPAD('-',45,'-')  || '|' ||
		Wheb_mensagem_pck.get_texto(301726) || '|' ||
		Wheb_mensagem_pck.get_texto(301728) || '|' ||
		Wheb_mensagem_pck.get_texto(301729) || '|'
	into STRICT 	ds_retorno_w
	from	titulo_receber a, 
		titulo_receber_liq b,
		caixa_receb c
	where	a.nr_titulo = b.nr_titulo
	and	b.nr_seq_caixa_rec = c.nr_sequencia
	and	b.nr_seq_caixa_rec = nr_seq_caixa_rec_p;
	
elsif (ie_tipo_documento_p = 'A') then
	select	substr(ptu_somente_caracter_permitido(obter_nome_estabelecimento(cd_estabelecimento_p), 'ANSE'),1,40) || '|' ||
		substr(ptu_somente_caracter_permitido(obter_dados_estab(cd_estabelecimento_p, 3), 'ANSE'),1,40) || '|' ||
		Wheb_mensagem_pck.get_texto(301708) || ': ' || (to_char(clock_timestamp(), 'dd/mm/yyyy')) || '          ' || Wheb_mensagem_pck.get_texto(301710) || ': ' || (to_char(clock_timestamp(), 'hh24:mm:ss')) || '|' ||
		LPAD('-',45,'-')  || '|' ||
		Wheb_mensagem_pck.get_texto(301732,'NR_SEQ_RECIBO=' || MAX(b.nr_recibo)) || '|' ||
		Wheb_mensagem_pck.get_texto(301751) || '    : ' || substr(ptu_somente_caracter_permitido(obter_nome_pf_pj(max(a.cd_pessoa_fisica), max(a.cd_cgc)), 'ANSE'),1,40) || '|' ||
		Wheb_mensagem_pck.get_texto(301717) || ' : ' || '|' ||
		Wheb_mensagem_pck.get_texto(301718) || '  : ' || to_char(max(a.dt_baixa), 'dd/mm/yyyy') || '|' ||
		Wheb_mensagem_pck.get_texto(301719) || ' : ' || campo_mascara(sum(a.vl_adiantamento),2) || '|' ||
		Wheb_mensagem_pck.get_texto(301720) || ': ' || '|' ||
		ptu_somente_caracter_permitido(Wheb_mensagem_pck.get_texto(301721), 'ANSE') || '  : ' || '|' ||
		Wheb_mensagem_pck.get_texto(301722) || '      : ' || '|' ||
		Wheb_mensagem_pck.get_texto(301723) || ': ' || campo_mascara(sum(a.vl_adiantamento),2) || '|' ||
		Wheb_mensagem_pck.get_texto(301724) || '      : ' || campo_mascara(coalesce(sum(a.vl_saldo), 0),2) || '|' ||
		LPAD('-',45,'-')  || '|' ||
		Wheb_mensagem_pck.get_texto(301725) || '|' ||
		LPAD('-',45,'-')  || '|' ||
		Wheb_mensagem_pck.get_texto(301726) || '|' ||
		Wheb_mensagem_pck.get_texto(301728) || '|' ||
		Wheb_mensagem_pck.get_texto(301729) || '|'
	into STRICT	ds_retorno_w
	from	adiantamento a, 
		caixa_receb b
	where	a.nr_seq_caixa_rec = b.nr_sequencia
	and	a.nr_seq_caixa_rec = nr_seq_caixa_rec_p;

elsif (ie_tipo_documento_p = 'M') then
	select	substr(ptu_somente_caracter_permitido(obter_nome_estabelecimento(cd_estabelecimento_p), 'ANSE'),1,40) || '|' ||
		substr(ptu_somente_caracter_permitido(obter_dados_estab(cd_estabelecimento_p, 3), 'ANSE'),1,40) || '|' ||
		Wheb_mensagem_pck.get_texto(301708) || ': ' || (to_char(clock_timestamp(), 'dd/mm/yyyy')) || '          ' || Wheb_mensagem_pck.get_texto(301710) || ': ' || (to_char(clock_timestamp(), 'hh24:mm:ss')) || '|' ||
		LPAD('-',45,'-')  || '|' ||
		Wheb_mensagem_pck.get_texto(301732,'NR_SEQ_RECIBO=' || MAX(b.nr_recibo)) || '|' ||
		Wheb_mensagem_pck.get_texto(301751) || '    : ' || substr(ptu_somente_caracter_permitido(obter_nome_pf_pj(max(a.cd_pessoa_fisica), max(a.cd_cgc)), 'ANSE'),1,40) || '|' ||
		Wheb_mensagem_pck.get_texto(301717) || ' : 0,00 ' || '|' ||
		Wheb_mensagem_pck.get_texto(301718) || '  : ' || to_char(max(a.dt_transacao), 'dd/mm/yyyy') || '|' ||
		Wheb_mensagem_pck.get_texto(301719) || ' : ' || campo_mascara(sum(a.vl_transacao),2) || '|' ||
		Wheb_mensagem_pck.get_texto(301720) || ': 0,00 ' || '|' ||
		ptu_somente_caracter_permitido(Wheb_mensagem_pck.get_texto(301721), 'ANSE') || '  : 0,00 ' || '|' ||
		Wheb_mensagem_pck.get_texto(301722) || '      : 0,00 ' || '|' ||
		Wheb_mensagem_pck.get_texto(301723) || ': ' || campo_mascara(sum(a.vl_transacao),2) || '|' ||
		Wheb_mensagem_pck.get_texto(301724) || '      : ' || campo_mascara(coalesce(sum(a.vl_transacao),0) - coalesce(sum(a.vl_recebido), 0),2) || '|' ||
		LPAD('-',45,'-')  || '|' ||
		Wheb_mensagem_pck.get_texto(301725) || '|' ||
		LPAD('-',45,'-')  || '|' ||
		Wheb_mensagem_pck.get_texto(301726) || '|' ||
		Wheb_mensagem_pck.get_texto(301728) || '|' ||
		Wheb_mensagem_pck.get_texto(301729) || '|'
	into STRICT	ds_retorno_w
	from	movto_trans_financ a,
		caixa_receb b
	where	a.nr_seq_caixa_rec = b.nr_sequencia
	and	a.nr_seq_caixa_rec = nr_seq_caixa_rec_p;
end if;

return substr(ds_retorno_w,1,4000);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gerar_recibo_matricial (nr_seq_caixa_rec_p text, ie_tipo_documento_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

