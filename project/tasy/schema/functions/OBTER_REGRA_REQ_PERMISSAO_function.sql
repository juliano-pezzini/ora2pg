-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_req_permissao ( cd_local_estoque_destino_p bigint, cd_operacao_estoque_p bigint, cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_material_p bigint, ie_urgente_p text, dt_requisicao_p timestamp, cd_setor_entrega_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE



cd_unidade_medida_consumo_w	varchar(30);
cd_grupo_material_w		smallint;
cd_subgrupo_material_w		smallint;
cd_classe_material_w		integer;
cd_local_estoque_w		bigint;
cd_centro_custo_w			integer;
qt_registro_w			bigint;
ie_permissao_w			varchar(1) := 'S';
ds_retorno_w			varchar(1) := 'S';
ie_receita_w			varchar(1);

C01 CURSOR FOR
SELECT	coalesce(a.ie_permissao,'S')
from	regra_requisicao_permissao a
where	coalesce(cd_operacao_estoque,cd_operacao_estoque_p)	= cd_operacao_estoque_p
and	coalesce(cd_centro_custo,coalesce(cd_centro_custo_p, 0))		= coalesce(cd_centro_custo_p, 0)
and	coalesce(cd_local_estoque,cd_local_estoque_p)		= cd_local_estoque_p
and	coalesce(cd_local_estoque_destino,coalesce(cd_local_estoque_destino_p,0)) = coalesce(cd_local_estoque_destino_p,0)
and	coalesce(cd_perfil,cd_perfil_p)				= cd_perfil_p
and	coalesce(nm_usuario_regra,nm_usuario_p) 			= nm_usuario_p
and	coalesce(a.cd_grupo_material,cd_grupo_material_w) 		= cd_grupo_material_w
and	coalesce(a.cd_subgrupo_material,cd_subgrupo_material_w)	= cd_subgrupo_material_w
and	coalesce(a.cd_setor_entrega,coalesce(cd_setor_entrega_p,0))		= coalesce(cd_setor_entrega_p,0)
and	coalesce(a.cd_estabelecimento,coalesce(cd_estabelecimento_p,0))	= coalesce(cd_estabelecimento_p,0)
and	coalesce(a.cd_classe_material,cd_classe_material_w) 		= cd_classe_material_w
and	coalesce(a.cd_material,cd_material_p) 			= cd_material_p
and	((a.ie_urgente = ie_urgente_p) or (coalesce(a.ie_urgente, 'A') = 'A'))
and	((coalesce(a.ie_receita,'A') = 'A') or (a.ie_receita = ie_receita_w))
and (coalesce(a.cd_unidade_medida, cd_unidade_medida_consumo_w) = cd_unidade_medida_consumo_w)
and	((coalesce(ie_dia_semana::text, '') = '') or
	((ie_dia_semana IS NOT NULL AND ie_dia_semana::text <> '') and (ie_dia_semana = 9) and (substr(obter_cod_dia_semana(dt_requisicao_p), 1,1) in (2,3,4,5,6))) or
	((ie_dia_semana IS NOT NULL AND ie_dia_semana::text <> '') and (ie_dia_semana <> 9) and (substr(obter_cod_dia_semana(dt_requisicao_p), 1,1) = ie_dia_semana)))
and (to_char(hr_inicio,'hh24:mi:ss') < to_char(dt_requisicao_p,'hh24:mi:ss') or
	coalesce(hr_inicio::text, '') = '')
and (to_char(hr_fim,'hh24:mi:ss') > to_char(dt_requisicao_p,'hh24:mi:ss') or
	coalesce(hr_fim::text, '') = '')
and (cd_material_p <> 0)
and	((cd_grupo_material IS NOT NULL AND cd_grupo_material::text <> '') or (cd_subgrupo_material IS NOT NULL AND cd_subgrupo_material::text <> '') or (cd_classe_material IS NOT NULL AND cd_classe_material::text <> '') or (cd_material IS NOT NULL AND cd_material::text <> '') or (cd_unidade_medida IS NOT NULL AND cd_unidade_medida::text <> '') or (coalesce(a.ie_receita,'A') <> 'A'))
order by	coalesce(cd_material,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		nm_usuario_regra desc,
		coalesce(cd_perfil,0),
		coalesce(cd_centro_custo,0);

c02 CURSOR FOR
SELECT	coalesce(ie_permissao,'S')
from	regra_requisicao_permissao
where	coalesce(cd_operacao_estoque,cd_operacao_estoque_p)	= cd_operacao_estoque_p
and	coalesce(cd_centro_custo,coalesce(cd_centro_custo_p, 0))		= coalesce(cd_centro_custo_p, 0)
and	coalesce(cd_local_estoque,cd_local_estoque_p)		= cd_local_estoque_p
and	coalesce(cd_local_estoque_destino, coalesce(cd_local_estoque_destino_p, 0)) = coalesce(cd_local_estoque_destino_p, 0)
and	coalesce(cd_perfil,cd_perfil_p)				= cd_perfil_p
and	coalesce(nm_usuario_regra,nm_usuario_p) 			= nm_usuario_p
and	coalesce(cd_setor_entrega,coalesce(cd_setor_entrega_p,0))		= coalesce(cd_setor_entrega_p,0)
and	coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_p,0))	= coalesce(cd_estabelecimento_p,0)
and	((ie_urgente = ie_urgente_p) or (coalesce(ie_urgente, 'A') = 'A'))
and	((coalesce(ie_dia_semana::text, '') = '') or
	((ie_dia_semana IS NOT NULL AND ie_dia_semana::text <> '') and (ie_dia_semana = 9) and (substr(obter_cod_dia_semana(dt_requisicao_p), 1,1) in (2,3,4,5,6))) or
	((ie_dia_semana IS NOT NULL AND ie_dia_semana::text <> '') and (ie_dia_semana <> 9) and (substr(obter_cod_dia_semana(dt_requisicao_p), 1,1) = ie_dia_semana)))
and (to_char(hr_inicio,'hh24:mi:ss') < to_char(dt_requisicao_p,'hh24:mi:ss') or
	coalesce(hr_inicio::text, '') = '')
and (to_char(hr_fim,'hh24:mi:ss') > to_char(dt_requisicao_p,'hh24:mi:ss') or
	coalesce(hr_fim::text, '') = '')
and	coalesce(IE_RECEITA,'A') = 'A'
and	coalesce(cd_unidade_medida::text, '') = ''
and	coalesce(cd_grupo_material::text, '') = ''
and	coalesce(cd_subgrupo_material::text, '') = ''
and	coalesce(cd_classe_material::text, '') = ''
and	coalesce(cd_material::text, '') = ''
order by  cd_operacao_estoque desc,
	cd_centro_custo desc,
	cd_local_estoque desc,
	cd_local_estoque_destino desc,
	cd_estabelecimento desc,
	nm_usuario_regra desc,
	coalesce(ie_permissao,'S');


BEGIN

if (coalesce(cd_material_p, 0) = 0) then
	open c02;
	loop
	fetch c02 into
		ie_permissao_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		ds_retorno_w	:= ie_permissao_w;
		end;
	end loop;
	close c02;
elsif (coalesce(cd_material_p,0) <> 0) then
	begin
	select	cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w
	from	estrutura_material_v
	where	cd_material	= cd_material_p;

	select	ie_receita,
		substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo
	into STRICT	ie_receita_w,
		cd_unidade_medida_consumo_w
	from	material
	where	cd_material	= cd_material_p;

	open C01;
	loop
	fetch C01 into
		ie_permissao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_retorno_w	:= ie_permissao_w;
		end;
	end loop;
	close C01;
	end;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_req_permissao ( cd_local_estoque_destino_p bigint, cd_operacao_estoque_p bigint, cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_material_p bigint, ie_urgente_p text, dt_requisicao_p timestamp, cd_setor_entrega_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

