-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obtain_dept_stay_days (cd_setor_atendimento_p bigint,nr_attendimento_p bigint,isDay text) RETURNS bigint AS $body$
DECLARE
 number_of_days bigint := 0;

BEGIN
  SELECT Count(*)
  INTO STRICT   number_of_days 
  FROM   atend_paciente_unidade a 
  WHERE  a.nr_atendimento=nr_attendimento_p 
  AND    a.cd_setor_atendimento=cd_setor_atendimento_p 
  AND    a.cd_setor_atendimento=CASE WHEN Get_conversion_qhapdc('HCP_DEPART_TYPE', 'SETOR_ATENDIMENTO', NULL, a.cd_setor_atendimento, 'I')=4 THEN  a.cd_setor_atendimento  ELSE -99 END;

  IF (number_of_days>0 and isDay='S')then 
  SELECT pkg_date_utils.get_DiffDate(a.dt_entrada_unidade,a.dt_saida_unidade,'DAY') 
  INTO STRICT number_of_days
  from   atend_paciente_unidade a 
  WHERE  a.nr_atendimento=nr_attendimento_p 
  AND    a.cd_setor_atendimento=cd_setor_atendimento_p 
  AND    a.cd_setor_atendimento=CASE WHEN get_conversion_qhapdc('HCP_DEPART_TYPE', 'SETOR_ATENDIMENTO', NULL, a.cd_setor_atendimento, 'I')=4 THEN  a.cd_setor_atendimento  ELSE -99 END;

  RETURN number_of_days;
  
  ELSIF (number_of_days>0 and isDay='N') then
  SELECT pkg_date_utils.get_DiffDate(a.dt_entrada_unidade,a.dt_saida_unidade,'HOUR') 
  INTO STRICT number_of_days
  from   atend_paciente_unidade a 
  WHERE  a.nr_atendimento=nr_attendimento_p 
  AND    a.cd_setor_atendimento=cd_setor_atendimento_p 
  AND    a.cd_setor_atendimento=CASE WHEN get_conversion_qhapdc('HCP_DEPART_TYPE', 'SETOR_ATENDIMENTO', NULL, a.cd_setor_atendimento, 'I')=4 THEN  a.cd_setor_atendimento  ELSE -99 END;

  RETURN number_of_days;
  ELSE
  RETURN number_of_days;
END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obtain_dept_stay_days (cd_setor_atendimento_p bigint,nr_attendimento_p bigint,isDay text) FROM PUBLIC;

