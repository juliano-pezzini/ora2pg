-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_xml_nota_fiscal ( nr_sequencia_p nota_fiscal.nr_sequencia%type) RETURNS text AS $body$
DECLARE


nr_seq_log_int_xml_w	log_integracao_xml.nr_sequencia%type;
nr_nota_fiscal_w	nota_fiscal.nr_nota_fiscal%type;
ds_retorno_w		text;

c01 CURSOR(	nr_seq_nota_fiscal_pc	 nota_fiscal.nr_sequencia%type ) FOR
	SELECT	c.nr_sequencia nr_seq_xml,
		convert_long_('LOG_INTEGRACAO_XML','DS_XML',' NR_SEQUENCIA = '||c.nr_sequencia) ds_xml
	from    nfe_transmissao_nf a,
		log_integracao_xml c,
		log_integracao d,
		informacao_integracao e
	where	trunc(d.dt_atualizacao_nrec) between trunc(a.dt_atualizacao_nrec) and trunc(a.dt_atualizacao_nrec+1)
	and	c.nr_seq_log = d.nr_sequencia
	and	d.nr_seq_informacao = e.nr_sequencia
	and	e.nr_seq_evento in (167,168)
	and	c.nm_usuario = 'WebService'
	and	c.ie_envio_retorno = 'E'
	and	(c.ds_xml IS NOT NULL AND c.ds_xml::text <> '')
	and	a.nr_seq_nota_fiscal = nr_seq_nota_fiscal_pc;

BEGIN

select	max(c.nr_sequencia)
into STRICT	nr_seq_log_int_xml_w
from    nfe_transmissao_nf a,
	nfe_transmissao b,
	log_integracao_xml c,
	log_integracao d,
	informacao_integracao e
where	b.nr_sequencia = a.nr_seq_transmissao
and	b.nr_seq_log = c.nr_seq_log
and	c.nr_seq_log = d.nr_sequencia
and	d.nr_seq_informacao = e.nr_sequencia
and	e.nr_seq_evento in (167,168)
and	c.nm_usuario = 'WebService'
and	c.ie_envio_retorno = 'E'
and	(c.ds_xml IS NOT NULL AND c.ds_xml::text <> '')
and	a.nr_seq_nota_fiscal = nr_sequencia_p;

-- Nem sempre tem NR_SEQ_LOG na tabela NFE_TRANSMISSAO
if (coalesce(nr_seq_log_int_xml_w::text, '') = '') then
	begin
	select	nr_nota_fiscal
	into STRICT	nr_nota_fiscal_w
	from	nota_fiscal
	where	nr_sequencia = nr_sequencia_p;
	exception
	when no_data_found or too_many_rows then
		nr_nota_fiscal_w := null;
	end;

	-- Pegar o XML conforme o numero da nota fiscal
	if (nr_nota_fiscal_w IS NOT NULL AND nr_nota_fiscal_w::text <> '') then
	
		for r_C01_w in C01( nr_sequencia_p ) loop
			if (r_C01_w.ds_xml like '%>'||nr_nota_fiscal_w||'<%') then
				nr_seq_log_int_xml_w := r_C01_w.nr_seq_xml;
			end if;
		end loop;
	
	end if;
	
	if (coalesce(nr_seq_log_int_xml_w::text, '') = '') then
		select	max(c.nr_sequencia)
		into STRICT	nr_seq_log_int_xml_w
		from    nfe_transmissao_nf a,
			log_integracao_xml c,
			log_integracao d,
			informacao_integracao e
		where	a.dt_atualizacao_nrec = d.dt_atualizacao_nrec
		and	c.nr_seq_log = d.nr_sequencia
		and	d.nr_seq_informacao = e.nr_sequencia
		and	e.nr_seq_evento in (167,168)
		and	c.nm_usuario = 'WebService'
		and	c.ie_envio_retorno = 'E'
		and	(c.ds_xml IS NOT NULL AND c.ds_xml::text <> '')
		and	a.nr_seq_nota_fiscal = nr_sequencia_p;
	end if;
end if;

if (nr_seq_log_int_xml_w IS NOT NULL AND nr_seq_log_int_xml_w::text <> '') then
	select	replace(replace(convert_long_('LOG_INTEGRACAO_XML','DS_XML',' NR_SEQUENCIA = '||nr_seq_log_int_xml_w),'<sis:','<'),'</sis:','</')
	into STRICT	ds_retorno_w
	;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_xml_nota_fiscal ( nr_sequencia_p nota_fiscal.nr_sequencia%type) FROM PUBLIC;

