-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_prescr_hor ( nr_atendimento_p bigint, cd_pessoa_fisica_p text) RETURNS varchar AS $body$
DECLARE


dt_prescr_mat_hor_w	        varchar(4000);
dt_prescr_gasoterapia_hor_w	varchar(4000);
dt_prescr_rec_hor_w	        varchar(4000);
dt_prescr_proc_hor_w	      varchar(4000);
dt_prescr_dieta_hor_w	      varchar(4000);
dt_prescr_mat_hor_ww	        varchar(4000);
dt_prescr_gasoterapia_hor_ww	varchar(4000);
dt_prescr_rec_hor_ww	        varchar(4000);
dt_prescr_proc_hor_ww	      varchar(4000);
dt_prescr_dieta_hor_ww	      varchar(4000);


BEGIN
if ((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') or (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '')) then

	select to_char(min(dt_horario), 'dd/mm/yyyy hh24:mi:ss') dt_horario
	into STRICT dt_prescr_mat_hor_w
	from prescr_mat_hor
	where nr_prescricao in ( SELECT	nr_prescricao
							from	prescr_medica
							where	nr_atendimento = nr_atendimento_p
							or		cd_pessoa_fisica = cd_pessoa_fisica_p
							and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
							and		coalesce(nr_seq_motivo_susp::text, '') = ''
	)
	and dt_horario >= clock_timestamp();

	select to_char(min(dt_horario), 'dd/mm/yyyy hh24:mi:ss') dt_horario
	into STRICT dt_prescr_gasoterapia_hor_w
	from prescr_gasoterapia_hor
	where nr_prescricao in ( SELECT	nr_prescricao
							from	prescr_medica
							where	nr_atendimento = nr_atendimento_p
							or		cd_pessoa_fisica = cd_pessoa_fisica_p
							and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
							and		coalesce(nr_seq_motivo_susp::text, '') = ''
	)
	and dt_horario >= clock_timestamp();

	select to_char(min(dt_horario), 'dd/mm/yyyy hh24:mi:ss') dt_horario
	into STRICT dt_prescr_rec_hor_w
	from prescr_rec_hor
	where nr_prescricao in ( SELECT	nr_prescricao
							from	prescr_medica
							where	nr_atendimento = nr_atendimento_p
							or		cd_pessoa_fisica = cd_pessoa_fisica_p
							and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
							and		coalesce(nr_seq_motivo_susp::text, '') = ''
	)
	and dt_horario >= clock_timestamp();

	select to_char(min(dt_horario), 'dd/mm/yyyy hh24:mi:ss') dt_horario
	into STRICT dt_prescr_proc_hor_w
	from prescr_proc_hor
	where nr_prescricao in ( SELECT	nr_prescricao
							from	prescr_medica
							where	nr_atendimento = nr_atendimento_p
							or		cd_pessoa_fisica = cd_pessoa_fisica_p
							and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
							and		coalesce(nr_seq_motivo_susp::text, '') = ''
	)
	and dt_horario >= clock_timestamp();

	select to_char(min(dt_horario), 'dd/mm/yyyy hh24:mi:ss') dt_horario
	into STRICT dt_prescr_dieta_hor_w
	from prescr_dieta_hor
	where nr_prescricao in ( SELECT	nr_prescricao
							from	prescr_medica
							where	nr_atendimento = nr_atendimento_p
							or		cd_pessoa_fisica = cd_pessoa_fisica_p
							and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
							and		coalesce(nr_seq_motivo_susp::text, '') = ''
	)
	and dt_horario >= clock_timestamp();

	select max(dt_prescr_mat_hor_w)
	into STRICT dt_prescr_mat_hor_ww
	 
	where to_date(dt_prescr_mat_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_gasoterapia_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss')) 
	and to_date(dt_prescr_mat_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_rec_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
	and to_date(dt_prescr_mat_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_proc_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
	and to_date(dt_prescr_mat_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_dieta_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'));

	if (dt_prescr_mat_hor_ww IS NOT NULL AND dt_prescr_mat_hor_ww::text <> '') then

		return	dt_prescr_mat_hor_ww;

	else
		
		select max(dt_prescr_gasoterapia_hor_w)
		into STRICT dt_prescr_gasoterapia_hor_ww
		 
		where to_date(dt_prescr_gasoterapia_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_mat_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss')) 
		and to_date(dt_prescr_gasoterapia_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_rec_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
		and to_date(dt_prescr_gasoterapia_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_proc_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
		and to_date(dt_prescr_gasoterapia_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_dieta_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'));

		if (dt_prescr_gasoterapia_hor_ww IS NOT NULL AND dt_prescr_gasoterapia_hor_ww::text <> '') then
		
			return	dt_prescr_gasoterapia_hor_ww;
		
		else
			
			select max(dt_prescr_rec_hor_w)
			into STRICT dt_prescr_rec_hor_ww
			 
			where to_date(dt_prescr_rec_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_mat_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss')) 
			and to_date(dt_prescr_rec_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_gasoterapia_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
			and to_date(dt_prescr_rec_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_proc_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
			and to_date(dt_prescr_rec_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_dieta_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'));
			
			if (dt_prescr_rec_hor_ww IS NOT NULL AND dt_prescr_rec_hor_ww::text <> '') then
			
				return	dt_prescr_rec_hor_ww;

			else
				
				select max(dt_prescr_proc_hor_w)
				into STRICT dt_prescr_proc_hor_ww 
				 
				where to_date(dt_prescr_proc_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_mat_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss')) 
				and to_date(dt_prescr_proc_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_gasoterapia_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
				and to_date(dt_prescr_proc_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_rec_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
				and to_date(dt_prescr_proc_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_dieta_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'));

				if (dt_prescr_proc_hor_ww IS NOT NULL AND dt_prescr_proc_hor_ww::text <> '') then
				
					return	dt_prescr_proc_hor_ww;
				
				else
					
					select max(dt_prescr_dieta_hor_w)
					into STRICT dt_prescr_dieta_hor_ww
					 
					where to_date(dt_prescr_dieta_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_mat_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss')) 
					and to_date(dt_prescr_dieta_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_gasoterapia_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
					and to_date(dt_prescr_dieta_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_rec_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'))
					and to_date(dt_prescr_dieta_hor_w, 'dd/mm/yyyy hh24:mi:ss') <= coalesce(to_date(dt_prescr_proc_hor_w, 'dd/mm/yyyy hh24:mi:ss'), to_date('01/01/2999 00:00:00', 'dd/mm/yyyy hh24:mi:ss'));
					
					if (dt_prescr_dieta_hor_ww IS NOT NULL AND dt_prescr_dieta_hor_ww::text <> '') then
			
						return	dt_prescr_dieta_hor_ww;
			
					else

						return	null;

					end if;
					
				end if;
				
			end if;
		
		end if;
		
	end if;

end if;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_prescr_hor ( nr_atendimento_p bigint, cd_pessoa_fisica_p text) FROM PUBLIC;

