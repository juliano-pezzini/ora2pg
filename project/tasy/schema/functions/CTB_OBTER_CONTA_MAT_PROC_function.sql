-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_conta_mat_proc ( cd_estabelecimento_p bigint, nr_interno_conta_p bigint, nr_atendimento_p bigint, cd_material_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_conta_p bigint) RETURNS varchar AS $body$
DECLARE


cd_conta_contabil_w			varchar(20);
cd_setor_atendimento_w		bigint;
cd_centro_custo_w			integer;
cd_local_estoque_w			smallint;
dt_atendimento_w			timestamp;
dt_procedimento_w			timestamp;
cd_plano_w					varchar(10);
ie_complexidade_sus_w		varchar(2);
ie_tipo_convenio_w			smallint;
ie_tipo_financ_sus_w		varchar(4);
ie_regra_pacote_w			varchar(1);
nr_seq_mat_proc_w			bigint;
nr_atendimento_w			bigint;
ie_clinica_w				integer;
cd_convenio_w				integer;
ie_classif_convenio_w		varchar(1);
ie_tipo_atendimento_w		smallint;
cd_categoria_convenio_w		varchar(10);
nr_seq_proc_interno_w		procedimento_paciente.nr_seq_proc_interno%type;


BEGIN

select	ie_clinica,
		ie_tipo_atendimento
into STRICT	ie_clinica_w,
		ie_tipo_atendimento_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

select	cd_convenio_parametro,
		cd_categoria_parametro
into STRICT	cd_convenio_w,
		cd_categoria_convenio_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_p;

if (coalesce(cd_convenio_w,0) <> 0) then

	select	ie_classif_contabil,
			ie_tipo_convenio
	into STRICT	ie_classif_convenio_w,
			ie_tipo_convenio_w
	from	convenio
	where	cd_convenio = cd_convenio_w;

end if;

if (coalesce(cd_procedimento_p,0) <> 0) then

	select	max(nr_sequencia),
		max(nr_seq_proc_interno_w)
	into STRICT 	nr_seq_mat_proc_w,
		nr_seq_proc_interno_w
	from	procedimento_paciente
	where	nr_atendimento 	= nr_atendimento_p
	and		coalesce(nr_interno_conta,nr_interno_conta_p) = nr_interno_conta_p
	and		cd_procedimento 	= cd_procedimento_p
	and		ie_origem_proced	= ie_origem_proced_p;
				
	if (coalesce(nr_seq_mat_proc_w,0) = 0) then
	
		select	max(nr_sequencia)
		into STRICT 	nr_seq_mat_proc_w
		from	procedimento_paciente
		where	nr_atendimento 		<> nr_atendimento_p
		and		nr_interno_conta	= nr_interno_conta_p
		and		cd_procedimento 	= cd_procedimento_p
		and		ie_origem_proced	= ie_origem_proced_p;
		
	end if;

	begin
	select	max(ie_complexidade),
			max(ie_tipo_financiamento)
	into STRICT	ie_complexidade_sus_w,
			ie_tipo_financ_sus_w
	from	sus_procedimento
	where	cd_procedimento		= cd_procedimento_p
	and	ie_origem_proced	= ie_origem_proced_p;
	exception when others then
		ie_complexidade_sus_w	:= null;
		ie_tipo_financ_sus_w	:= null;
	end;
	
	select	dt_procedimento,
			substr(CASE WHEN coalesce(nr_seq_proc_pacote,0)=0 THEN 'N'  ELSE 'S' END ,1,1) ie_regra_pacote,
			cd_setor_atendimento
	into STRICT	dt_procedimento_w,
			ie_regra_pacote_w,
			cd_setor_atendimento_w
	from	procedimento_paciente
	where	nr_sequencia		= nr_seq_mat_proc_w;
	
	select	max(cd_plano_convenio)
	into STRICT	cd_plano_w
	from	atend_categoria_convenio
	where	obter_atecaco_atendimento(nr_atendimento_p) = nr_seq_interno;
	
	SELECT * FROM define_conta_procedimento(
		cd_estabelecimento_p, cd_procedimento_p, ie_origem_proced_p, ie_tipo_conta_p, ie_clinica_w, cd_setor_atendimento_w, ie_classif_convenio_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_convenio_w, dt_procedimento_w, cd_conta_contabil_w, cd_centro_custo_w, cd_plano_w, ie_regra_pacote_w, ie_complexidade_sus_w, ie_tipo_financ_sus_w, null, null, null, null, null, nr_seq_proc_interno_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
		
elsif (coalesce(cd_material_p,0) <> 0) then
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_mat_proc_w
	from	material_atend_paciente
	where	nr_atendimento = nr_atendimento_p
	and		coalesce(nr_interno_conta,nr_interno_conta_p) = nr_interno_conta_p
	and		cd_material = cd_material_p;
	
	if (coalesce(nr_seq_mat_proc_w,0) = 0) then
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_mat_proc_w
		from	material_atend_paciente
		where	nr_atendimento <> nr_atendimento_p
		and		nr_interno_conta = nr_interno_conta_p
		and		cd_material = cd_material_p;
		
	end if;
	
	select	dt_atendimento,
			substr(CASE WHEN coalesce(nr_seq_proc_pacote,0)=0 THEN 'N'  ELSE 'S' END ,1,1) ie_regra_pacote,
			cd_setor_atendimento
	into STRICT	dt_atendimento_w,
			ie_regra_pacote_w,
			cd_setor_atendimento_w
	from	material_atend_paciente
	where	nr_sequencia		= nr_seq_mat_proc_w;
	
	select	max(cd_plano_convenio)
	into STRICT	cd_plano_w
	from	atend_categoria_convenio
	where	obter_atecaco_atendimento(nr_atendimento_p) = nr_seq_interno;
	
	SELECT * FROM define_conta_material(
		cd_estabelecimento_p, cd_material_p, ie_tipo_conta_p, ie_clinica_w, cd_setor_atendimento_w, ie_classif_convenio_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_convenio_w, cd_local_estoque_w, Null, dt_atendimento_w, cd_conta_contabil_w, cd_centro_custo_w, cd_plano_w, ie_regra_pacote_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;	

end if;

return	cd_conta_contabil_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_conta_mat_proc ( cd_estabelecimento_p bigint, nr_interno_conta_p bigint, nr_atendimento_p bigint, cd_material_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_conta_p bigint) FROM PUBLIC;

