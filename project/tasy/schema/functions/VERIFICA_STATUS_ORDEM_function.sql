-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION verifica_status_ordem ( nr_prescricao_p bigint, nr_seq_ordem_p bigint) RETURNS varchar AS $body$
DECLARE

ie_status_w			    varchar(1);
dt_inicio_adm_w         timestamp;
dt_termino_adm_w        timestamp;
dt_suspensao_w          timestamp;


BEGIN

select  c.dt_inicio_medic dt_inicio_adm,
        a.dt_administracao dt_termino_adm,
        c.DT_SUSPENSAO dt_suspensao
into STRICT    dt_inicio_adm_w,
        dt_termino_adm_w,
        dt_suspensao_w
from    can_ordem_prod a,
        prescr_material c
where   a.nr_prescricao = c.nr_prescricao
and     a.nr_prescricao = nr_prescricao_p
and     a.nr_sequencia  = c.nr_seq_ordem_prod
and     a.nr_sequencia  = nr_seq_ordem_p
and     coalesce(c.nr_sequencia_diluicao::text, '') = '' 
and     a.ie_cancelada = 'N' 
and     (a.dt_fim_preparo IS NOT NULL AND a.dt_fim_preparo::text <> '') 
and     c.ie_agrupador = 1 
and     ((c.ie_se_necessario = 'N') or (c.ie_urgencia = 'S'))
and     (c.nr_seq_ordem_prod IS NOT NULL AND c.nr_seq_ordem_prod::text <> '');

ie_status_w := 'P';

if (dt_inicio_adm_w IS NOT NULL AND dt_inicio_adm_w::text <> '') then
	ie_status_w := 'I';
end if;
if (dt_termino_adm_w IS NOT NULL AND dt_termino_adm_w::text <> '') then
	ie_status_w := 'C';
end if;
if (dt_suspensao_w IS NOT NULL AND dt_suspensao_w::text <> '') then
	ie_status_w := 'S';
end if;

RETURN ie_status_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION verifica_status_ordem ( nr_prescricao_p bigint, nr_seq_ordem_p bigint) FROM PUBLIC;

