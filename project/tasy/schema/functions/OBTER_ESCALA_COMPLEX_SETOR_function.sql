-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_escala_complex_setor ( cd_setor_atendimento_p bigint, nr_seq_interno_p bigint, ie_complexidade_p bigint) RETURNS varchar AS $body$
DECLARE


ds_escalas_w			varchar(4000);

ie_escala_1_w			varchar(15);
ds_escala_1_w			varchar(255);

ie_escala_2_w			varchar(15);
ds_escala_2_w			varchar(255);

ie_escala_3_w			varchar(15);
ds_escala_3_w			varchar(255);

ie_escala_4_w			varchar(15);
ds_escala_4_w			varchar(255);

nr_atendimento_w 		bigint;

ie_opcao_w				varchar(10);
ds_valor_escala_w		varchar(255);

nr_seq_score_flex_ca1_w  bigint;
nr_seq_score_flex_ca2_w  bigint;
nr_seq_score_flex_ca3_w  bigint;
nr_seq_score_flex_ca4_w  bigint;


BEGIN

select	max(nr_atendimento)
into STRICT	nr_atendimento_w
from	UNIDADE_ATENDIMENTO
where	nr_seq_interno = nr_seq_interno_p;

select	max(ie_complexidade_assit),
	max(substr(obter_valor_dominio(1893, ie_complexidade_assit),1,255)) ds_complexidade_assist,
	max(ie_complexidade_assit2),
	max(substr(obter_valor_dominio(1893, ie_complexidade_assit2),1,255)) ds_complexidade_assist2,
	max(ie_complexidade_assit3),
	max(substr(obter_valor_dominio(1893, ie_complexidade_assit3),1,255)) ds_complexidade_assist3,
	max(ie_complexidade_assit4),
	max(substr(obter_valor_dominio(1893, ie_complexidade_assit4),1,255)) ds_complexidade_assist4,
	max(nr_seq_score_flex_ca1),
	max(nr_seq_score_flex_ca2),
	max(nr_seq_score_flex_ca3),
	max(nr_seq_score_flex_ca4)
into STRICT	ie_escala_1_w,
		ds_escala_1_w,
		ie_escala_2_w,
		ds_escala_2_w,
		ie_escala_3_w,
		ds_escala_3_w,
		ie_escala_4_w,
		ds_escala_4_w,
		nr_seq_score_flex_ca1_w,
		nr_seq_score_flex_ca2_w,
		nr_seq_score_flex_ca3_w,
		nr_seq_score_flex_ca4_w
from	SETOR_ATENDIMENTO
where	cd_setor_atendimento = cd_setor_atendimento_p;



ie_opcao_w	:= 'PC';

if (ie_escala_1_w IS NOT NULL AND ie_escala_1_w::text <> '') and ( ie_complexidade_p = 1 ) then

	ds_valor_escala_w	:= substr(obter_complexidade_assist(nr_atendimento_w, cd_setor_atendimento_p, ie_opcao_w, '1'),1,100);

	if ( ie_escala_1_w =  'SF' and (nr_seq_score_flex_ca1_w IS NOT NULL AND nr_seq_score_flex_ca1_w::text <> '')) then

		ds_escala_1_w := substr(obter_desc_regra_score_flex(nr_seq_score_flex_ca1_w,346),1,255);

	elsif ( ie_escala_1_w =  'SFII' and (nr_seq_score_flex_ca1_w IS NOT NULL AND nr_seq_score_flex_ca1_w::text <> '')) then

		ds_escala_1_w := substr(obter_desc_regra_score_flex(nr_seq_score_flex_ca1_w,347),1,255);

	end if;

	if (ds_valor_escala_w IS NOT NULL AND ds_valor_escala_w::text <> '') then
		ds_escalas_w:= ds_escalas_w || ds_escala_1_w || ': ' || ds_valor_escala_w || '<br>';
	end if;
end if;

if (ie_escala_2_w IS NOT NULL AND ie_escala_2_w::text <> '') and ( ie_complexidade_p = 2)then

	ds_valor_escala_w	:= SUBSTR(obter_complexidade_assist(nr_atendimento_w, cd_setor_atendimento_p, ie_opcao_w,'2'),1,100);

	if ( ie_escala_2_w =  'SF' and (nr_seq_score_flex_ca2_w IS NOT NULL AND nr_seq_score_flex_ca2_w::text <> '')) then

		ds_escala_2_w := substr(obter_desc_regra_score_flex(nr_seq_score_flex_ca2_w,346),1,255);

	elsif ( ie_escala_2_w =  'SFII' and (nr_seq_score_flex_ca2_w IS NOT NULL AND nr_seq_score_flex_ca2_w::text <> '')) then

		ds_escala_2_w := substr(obter_desc_regra_score_flex(nr_seq_score_flex_ca2_w,347),1,255);

	end if;

	if (ds_valor_escala_w IS NOT NULL AND ds_valor_escala_w::text <> '') then
		ds_escalas_w:= ds_escalas_w || ds_escala_2_w || ': ' || ds_valor_escala_w || '<br>';
	end if;
end if;

if (ie_escala_3_w IS NOT NULL AND ie_escala_3_w::text <> '')  and (ie_complexidade_p = 3)then

	ds_valor_escala_w	:= SUBSTR(obter_complexidade_assist(nr_atendimento_w, cd_setor_atendimento_p, ie_opcao_w,'3'),1,100);

	if ( ie_escala_3_w =  'SF' and (nr_seq_score_flex_ca3_w IS NOT NULL AND nr_seq_score_flex_ca3_w::text <> '')) then

		ds_escala_3_w := substr(obter_desc_regra_score_flex(nr_seq_score_flex_ca3_w,346),1,255);

	elsif ( ie_escala_3_w =  'SFII' and (nr_seq_score_flex_ca3_w IS NOT NULL AND nr_seq_score_flex_ca3_w::text <> '')) then

		ds_escala_3_w := substr(obter_desc_regra_score_flex(nr_seq_score_flex_ca3_w,347),1,255);

	end if;

	if (ds_valor_escala_w IS NOT NULL AND ds_valor_escala_w::text <> '') then
		ds_escalas_w:= ds_escalas_w || ds_escala_3_w || ': ' || ds_valor_escala_w || '<br>';
	end if;
end if;

if (ie_escala_4_w IS NOT NULL AND ie_escala_4_w::text <> '') and (ie_complexidade_p = 4) then

	ds_valor_escala_w	:= SUBSTR(obter_complexidade_assist(nr_atendimento_w, cd_setor_atendimento_p, ie_opcao_w,'4'),1,100);

	if ( ie_escala_4_w =  'SF' and (nr_seq_score_flex_ca4_w IS NOT NULL AND nr_seq_score_flex_ca4_w::text <> '')) then

		ds_escala_4_w := substr(obter_desc_regra_score_flex(nr_seq_score_flex_ca4_w,346),1,255);

	elsif ( ie_escala_4_w =  'SFII' and (nr_seq_score_flex_ca4_w IS NOT NULL AND nr_seq_score_flex_ca4_w::text <> '')) then

		ds_escala_4_w := substr(obter_desc_regra_score_flex(nr_seq_score_flex_ca4_w,347),1,255);

	end if;

	if (ds_valor_escala_w IS NOT NULL AND ds_valor_escala_w::text <> '') then
		ds_escalas_w:= ds_escalas_w || ds_escala_4_w || ': ' || ds_valor_escala_w || '<br>';
	end if;
end if;

return ds_escalas_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_escala_complex_setor ( cd_setor_atendimento_p bigint, nr_seq_interno_p bigint, ie_complexidade_p bigint) FROM PUBLIC;

