-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_rat ( nr_seq_rat_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*
IE_OPCAO_P
E  - Executor
ID - Initial date
FD - Final date
SD - Submission date
SU - Submission user 
AD - Approval date
AU - Approval user
RD - Receipt date
TH - Total hours
S  - Schedule
P  - Project
*/
ds_retorno_w		varchar(255);
cd_executor_w		proj_rat.cd_executor%type;
dt_inicio_w		timestamp;
dt_final_w		timestamp;
dt_liberacao_w		timestamp;
nm_usuario_lib_w	proj_rat.nm_usuario_lib%type;
dt_aprovacao_w		timestamp;
nm_usuario_aprov_w	proj_rat.nm_usuario_aprov%type;
dt_receb_rat_w		timestamp;
qt_total_hora_w		proj_rat.qt_total_hora%type;
nr_seq_cronograma_w	proj_cronograma.nr_sequencia%type;
nr_seq_proj_w		proj_projeto.nr_sequencia%type;


BEGIN

if (nr_seq_rat_p IS NOT NULL AND nr_seq_rat_p::text <> '') then
	select	max(a.cd_executor),
		max(a.dt_inicio),
		max(a.dt_final),
		max(a.dt_liberacao),
		max(a.nm_usuario_lib),
		max(a.dt_aprovacao),
		max(a.nm_usuario_aprov),
		max(a.dt_receb_rat),
		coalesce(max(a.qt_total_hora), 0),
		max(c.nr_seq_proj)
	into STRICT	cd_executor_w,
		dt_inicio_w,
		dt_final_w,
		dt_liberacao_w,
		nm_usuario_lib_w,
		dt_aprovacao_w,
		nm_usuario_aprov_w,
		dt_receb_rat_w,
		qt_total_hora_w,
		nr_seq_proj_w
	from	proj_rat a,
		via_viagem b,
		via_destino c
        where	1 = 1
        and	a.nr_seq_proj = c.nr_seq_proj
        and	a.cd_executor = b.cd_pessoa_fisica
        and	c.nr_seq_viagem = b.nr_sequencia
	and	a.nr_sequencia = nr_seq_rat_p;

        select	max(d.nr_sequencia)
        into STRICT	nr_seq_cronograma_w
        from	proj_rat a,
		proj_rat_ativ b,
		proj_cron_etapa c,
		proj_cronograma d
        where	1 = 1
        and	a.nr_sequencia = b.nr_seq_rat
        and	c.nr_sequencia = b.nr_seq_etapa_cron
        and	d.nr_sequencia = c.nr_seq_cronograma
        and	a.nr_sequencia = nr_seq_rat_p;

end if;

if (ie_opcao_p = 'E') then
	ds_retorno_w := cd_executor_w;
elsif (ie_opcao_p = 'ID') then
	ds_retorno_w := dt_inicio_w;
elsif (ie_opcao_p = 'FD') then
	ds_retorno_w := dt_final_w;		
elsif (ie_opcao_p = 'SD') then
	ds_retorno_w := dt_liberacao_w;
elsif (ie_opcao_p = 'SU') then
	ds_retorno_w := nm_usuario_lib_w;
elsif (ie_opcao_p = 'AD') then
	ds_retorno_w := dt_aprovacao_w;
elsif (ie_opcao_p = 'AU') then
	ds_retorno_w := nm_usuario_aprov_w;
elsif (ie_opcao_p = 'RD') then
	ds_retorno_w := dt_receb_rat_w;
elsif (ie_opcao_p = 'TH') then
	ds_retorno_w := qt_total_hora_w;
elsif (ie_opcao_p = 'S') then
	ds_retorno_w := nr_seq_cronograma_w;
elsif (ie_opcao_p = 'P') then
	ds_retorno_w := nr_seq_proj_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 IMMUTABLE;
-- REVOKE ALL ON FUNCTION obter_dados_rat ( nr_seq_rat_p bigint, ie_opcao_p text) FROM PUBLIC;

