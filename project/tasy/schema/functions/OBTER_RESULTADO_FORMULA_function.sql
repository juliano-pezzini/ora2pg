-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_resultado_formula (ds_formula_p text, nr_seq_contrato_p bigint, nr_parcela_p bigint, dt_vencimento_parcela_p timestamp) RETURNS bigint AS $body$
DECLARE


vl_formula_retorno_w bigint;
ds_formula_ajustada_w varchar(4000);


BEGIN

  if (ds_formula_p IS NOT NULL AND ds_formula_p::text <> '') then

    ds_formula_ajustada_w := ds_formula_p;
    ds_formula_ajustada_w := REGEXP_REPLACE(ds_formula_ajustada_w, '(\S+\s?)\*\*(\s?\S+)', 'POWER(\1,\2)');
    ds_formula_ajustada_w := replace(ds_formula_ajustada_w, '#:I:#', 'obter_resultado_formula_indice(''');
    ds_formula_ajustada_w := replace(ds_formula_ajustada_w, '!', ''', to_date(''' || dt_vencimento_parcela_p || '''))');
    ds_formula_ajustada_w := replace(replace(replace(ds_formula_ajustada_w, '#:', 'nvl('), ':#', '.'),'@',',0)');

    EXECUTE
      'select ' || ds_formula_ajustada_w || ' ' ||
      'from contrato c,
             contrato_bndes b,
             indice_reajuste_anual_fin a,
             emprest_financ_parc p
       where c.nr_sequencia = ' || nr_seq_contrato_p || '
       and b.nr_seq_contrato = c.nr_sequencia
       and a.nr_seq_contrato_bndes(+) = b.nr_sequencia
       and p.nr_seq_contrato = c.nr_sequencia
       and p.dt_cancelamento is null
       and p.nr_parcela = ' || nr_parcela_p
    into STRICT vl_formula_retorno_w;

    if coalesce(vl_formula_retorno_w::text, '') = '' then
      vl_formula_retorno_w := 0;
    end if;

  else
    vl_formula_retorno_w := 0;
  end if;

  return vl_formula_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_resultado_formula (ds_formula_p text, nr_seq_contrato_p bigint, nr_parcela_p bigint, dt_vencimento_parcela_p timestamp) FROM PUBLIC;

