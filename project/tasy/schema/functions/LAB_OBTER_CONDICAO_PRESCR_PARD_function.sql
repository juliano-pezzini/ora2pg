-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_condicao_prescr_pard ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_exame_p bigint, nr_seq_amostra_p bigint, nr_Seq_lote_exter_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

qt_exame_iguais_w	integer;
qt_exame_total_igual_w	integer;
ds_retorno_w		varchar(255);
material_exame_integr_w	varchar(255);
exame_integr_w		varchar(255);

/* ie_opcao_p
1	- descrição amostra
2	- amostra
*/
BEGIN
select	max(coalesce(substr(Obter_Equipamento_Exame_dados(a.nr_seq_exame,null,b.nr_sequencia,'PARDINI','M'),1,50),coalesce(cd_material_integracao,b.cd_material_exame))),
	max(coalesce(coalesce(Obter_Equipamento_Exame_Mat(a.nr_seq_exame,null,b.nr_sequencia,'PARDINI'),cd_exame_integracao),cd_exame))
into STRICT	material_exame_integr_w,
	exame_integr_w
from	prescr_procedimento a,
	material_exame_lab b,
	exame_laboratorio c
where	a.cd_material_exame = b.cd_material_exame
and	a.nr_seq_exame = c.nr_Seq_exame
and	a.nr_prescricao = nr_prescricao_p
and	a.nr_sequencia	= nr_seq_prescr_p
and	a.nr_seq_exame	= nr_seq_exame_p;

qt_exame_iguais_w	:= 1;

if (material_exame_integr_w IS NOT NULL AND material_exame_integr_w::text <> '' AND exame_integr_w IS NOT NULL AND exame_integr_w::text <> '') then

	if (coalesce(nr_seq_amostra_p,0) > 0) then

		select 	count(*)
		into STRICT	qt_exame_total_igual_w
		from 	exame_laboratorio c,
			prescr_proc_material e,
			prescr_procedimento a,
			material_exame_lab b
		where	a.cd_material_exame 			= b.cd_material_exame
		and	e.nr_prescricao				= a.nr_prescricao
		and	e.nr_seq_material 			= b.nr_sequencia
		and	CASE WHEN e.nr_Seq_grupo=0 THEN c.nr_seq_grupo  ELSE e.nr_Seq_grupo END 	= c.nr_seq_grupo
		and	a.nr_Seq_exame				= c.nr_seq_exame
		and	a.nr_seq_exame				= nr_seq_exame_p
		and	a.nr_prescricao 			= nr_prescricao_p
		and	a.nr_Seq_lote_externo			= nr_Seq_lote_exter_p
		and (coalesce(substr(Obter_Equipamento_Exame_dados(a.nr_seq_exame,null,b.nr_sequencia,'PARDINI','M'),1,50),coalesce(cd_material_integracao,b.cd_material_exame))) = material_exame_integr_w
		and (coalesce(coalesce(Obter_Equipamento_Exame_Mat(a.nr_seq_exame,null,b.nr_sequencia,'PARDINI'),cd_exame_integracao),cd_exame)) = exame_integr_w;

		select 	count(*)
		into STRICT	qt_exame_iguais_w
		from 	exame_laboratorio c,
			prescr_proc_material e,
			prescr_procedimento a,
			material_exame_lab b
		where	a.cd_material_exame 			= b.cd_material_exame
		and	e.nr_prescricao				= a.nr_prescricao
		and	a.nr_Seq_lote_externo			= nr_Seq_lote_exter_p
		and	e.nr_seq_material 			= b.nr_sequencia
		and	CASE WHEN e.nr_Seq_grupo=0 THEN c.nr_seq_grupo  ELSE e.nr_Seq_grupo END 	= c.nr_seq_grupo
		and	a.nr_Seq_exame				= c.nr_seq_exame
		and	a.nr_seq_exame				= nr_seq_exame_p
		and	a.nr_prescricao 			= nr_prescricao_p
		and (coalesce(substr(Obter_Equipamento_Exame_dados(a.nr_seq_exame,null,b.nr_sequencia,'PARDINI','M'),1,50),coalesce(cd_material_integracao,b.cd_material_exame))) = material_exame_integr_w
		and (coalesce(coalesce(Obter_Equipamento_Exame_Mat(a.nr_seq_exame,null,b.nr_sequencia,'PARDINI'),cd_exame_integracao),cd_exame)) = exame_integr_w
		and	a.nr_sequencia	<= nr_seq_prescr_p
		and	e.nr_sequencia <= nr_seq_amostra_p;


	else

		select 	count(*)
		into STRICT	qt_exame_total_igual_w
		from 	prescr_procedimento a,
			material_exame_lab b,
			exame_Laboratorio d
		where	a.cd_material_exame 		= b.cd_material_exame
		and	a.nr_seq_exame			= nr_seq_exame_p
		and	a.nr_Seq_lote_externo		= nr_Seq_lote_exter_p
		and 	a.nr_Seq_exame			= d.nr_seq_exame
		and	a.nr_prescricao			= nr_prescricao_p
		and (coalesce(substr(Obter_Equipamento_Exame_dados(a.nr_seq_exame,null,b.nr_sequencia,'PARDINI','M'),1,50),coalesce(cd_material_integracao,b.cd_material_exame))) = material_exame_integr_w
		and (coalesce(coalesce(Obter_Equipamento_Exame_Mat(a.nr_seq_exame,null,b.nr_sequencia,'PARDINI'),cd_exame_integracao),cd_exame)) = exame_integr_w;

		select 	count(*)
		into STRICT	qt_exame_iguais_w
		from 	prescr_procedimento a,
			material_exame_lab b,
			exame_Laboratorio d
		where	a.cd_material_exame 		= b.cd_material_exame
		and 	a.nr_Seq_exame			= d.nr_seq_exame
		and	a.nr_Seq_lote_externo		= nr_Seq_lote_exter_p
		and	a.nr_seq_exame			= nr_seq_exame_p
		and	a.nr_prescricao 		= nr_prescricao_p
		and (coalesce(substr(Obter_Equipamento_Exame_dados(a.nr_seq_exame,null,b.nr_sequencia,'PARDINI','M'),1,50),coalesce(cd_material_integracao,b.cd_material_exame))) = material_exame_integr_w
		and (coalesce(coalesce(Obter_Equipamento_Exame_Mat(a.nr_seq_exame,null,b.nr_sequencia,'PARDINI'),cd_exame_integracao),cd_exame)) = exame_integr_w
		and	a.nr_sequencia	<= nr_seq_prescr_p;
	end if;

end if;

if (qt_exame_total_igual_w > 1)	then

	if (ie_opcao_p = 1) then
		ds_retorno_w	:= qt_exame_iguais_w || 'ª Amostra';
	end if;

end if;

if (ie_opcao_p = 2) then
	ds_retorno_w	:= coalesce(qt_exame_iguais_w,1);
end if;

return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_condicao_prescr_pard ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_exame_p bigint, nr_seq_amostra_p bigint, nr_Seq_lote_exter_p bigint, ie_opcao_p text) FROM PUBLIC;

