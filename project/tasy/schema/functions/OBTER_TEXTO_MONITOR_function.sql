-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_texto_monitor ( nm_maquina_p text, nr_seq_fila_p bigint, cd_senha_p text, nm_paciente_p text, ds_guiche_p text, nm_medico_p text, dt_chamada_p timestamp) RETURNS varchar AS $body$
DECLARE

 
cd_estabelecimento_w	bigint;
nr_seq_maquina_w	bigint;
ds_regra_cursor_w	varchar(255);
ds_regra_w		varchar(255);

C01 CURSOR FOR 
	SELECT	ds_regra 
	from	configuracao_voz_senha 
	where	((coalesce(nr_seq_fila_espera_senha::text, '') = '') or (nr_seq_fila_espera_senha = nr_seq_fila_p)) 
	and	((coalesce(nr_seq_local_chamada::text, '') = '') or (nr_seq_local_chamada = nr_seq_maquina_w)) 
	order by nr_seq_fila_espera_senha, nr_seq_local_chamada;


BEGIN 
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
 
select	coalesce(max(a.nr_sequencia), 0) 
into STRICT	nr_seq_maquina_w 
from	maquina_local_senha a, 
	computador b 
where	a.nr_seq_computador	= b.nr_sequencia 
and	a.cd_estabelecimento 	= coalesce(cd_estabelecimento_w, 1) 
and	nm_computador_pesquisa 	= padronizar_nome(upper(nm_maquina_p)) 
and	coalesce(a.ie_situacao, 'A') = 'A';
 
if (nr_seq_maquina_w <= 0) then 
	select	coalesce(max(a.nr_sequencia), 0) 
	into STRICT	nr_seq_maquina_w 
	from	maquina_local_senha a, 
		computador b, 
		maquina_monitor_adicional c 
	where	a.nr_seq_computador	= c.nr_seq_local 
	and	c.nr_seq_comp_monitor	= b.nr_sequencia 
	and	a.cd_estabelecimento 	= coalesce(cd_estabelecimento_w, 1) 
	and	nm_computador_pesquisa 	= padronizar_nome(upper(nm_maquina_p)) 
	and	coalesce(a.ie_situacao, 'A') = 'A';
end if;
 
open C01;
loop 
fetch C01 into	 
	ds_regra_cursor_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	if (coalesce(ds_regra_w::text, '') = '') then 
		ds_regra_w := ds_regra_cursor_w;
	end if;
end loop;
close C01;
 
ds_regra_w := replace_macro(ds_regra_w, '@PACIENTE', nm_paciente_p);
ds_regra_w := replace_macro(ds_regra_w, '@SENHA', cd_senha_p);
ds_regra_w := replace_macro(ds_regra_w, '@MEDICO', nm_medico_p);
ds_regra_w := replace_macro(ds_regra_w, '@DTCHAMADA', to_char(dt_chamada_p, 'dd/mm/yyyy hh24:mi:ss'));
ds_regra_w := replace_macro(ds_regra_w, '@GUICHE', ds_guiche_p);
 
return	ds_regra_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_texto_monitor ( nm_maquina_p text, nr_seq_fila_p bigint, cd_senha_p text, nm_paciente_p text, ds_guiche_p text, nm_medico_p text, dt_chamada_p timestamp) FROM PUBLIC;

