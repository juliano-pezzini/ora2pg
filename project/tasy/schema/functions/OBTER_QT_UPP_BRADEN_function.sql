-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_upp_braden ( nr_sequencia_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/*	IE_OPCAO_P
DP = Primeiro registro de braden do atendimento
DU = Houve ficha UPP apÃ³s primeiro registro de braden do atendimento
*/
nr_atendimento_w		bigint;
nr_sequencia_w			bigint;
qt_reg_w			bigint := 0;
dt_avaliacao_w			timestamp;
dt_evento_w			timestamp;


BEGIN
select  max(a.nr_atendimento),
	max(a.dt_avaliacao)
into STRICT	nr_atendimento_w,
	dt_avaliacao_w
from	atend_escala_braden a
where	a.nr_sequencia  = nr_sequencia_p;

if (ie_opcao_p = 'DP') and (nr_atendimento_w > 0) then

	select	min(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	atend_escala_braden x
	where	x.nr_atendimento = nr_atendimento_w
	and		(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
	and		coalesce(x.dt_inativacao::text, '') = '';

	if (nr_sequencia_w = nr_sequencia_p) then
		qt_reg_w := 1;
	end if;

elsif (ie_opcao_p = 'DU') and (nr_atendimento_w > 0) then

	Select 	min(b.dt_evento)
	into STRICT	dt_evento_w
	FROM atend_escala_braden d, qua_evento_paciente b
LEFT OUTER JOIN cur_ferida c ON (b.nr_sequencia = c.nr_seq_evento)
WHERE c.ie_admitido_ferida = 'N'  and coalesce(c.dt_inativacao::text, '') = '' and b.nr_atendimento = d.nr_atendimento and d.nr_atendimento = nr_atendimento_w;


	if (trunc(dt_avaliacao_w) = trunc(dt_evento_w)) then

		qt_reg_w := 1;

	end if;


end if;

return	qt_reg_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_upp_braden ( nr_sequencia_p bigint, ie_opcao_p text) FROM PUBLIC;

