-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_horario_apraz_bolsa ( cd_perfil_p bigint, nr_prescricao_p bigint, nr_seq_procedimento_p bigint) RETURNS timestamp AS $body$
DECLARE

qt_seg_margem_w		smallint;
qt_min_apraz_w		smallint;
qt_seg_dif_w		bigint;
qt_bolsas_w		bigint;
cd_setor_prescricao_w	integer;
dt_ultimo_reg_w		timestamp;
dt_horario_w		timestamp;
nr_seq_derivado_w   prescr_procedimento.nr_seq_derivado%type;
dt_inicio_prescr_w	prescr_medica.dt_inicio_prescr%type;

C01 CURSOR FOR
SELECT	qt_minutos_margem,
	qt_minutos_apraz
from	regra_aprazamento_bolsa
where	coalesce(cd_perfil,cd_perfil_p) = cd_perfil_p
and	coalesce(cd_setor_atendimento,cd_setor_prescricao_w) = cd_setor_prescricao_w
and	coalesce(nr_seq_derivado,nr_seq_derivado_w) = nr_seq_derivado_w
order by coalesce(cd_perfil,0),
     coalesce(nr_seq_derivado,0),
	 qt_minutos_margem;
			

BEGIN

select	max(a.dt_inicio_prescr)
into STRICT	dt_inicio_prescr_w
from	prescr_medica a
where	a.nr_prescricao = nr_prescricao_p;

select nr_seq_derivado
into STRICT nr_seq_derivado_w
from prescr_procedimento
where nr_prescricao = nr_prescricao_p
and nr_sequencia = nr_seq_procedimento_p;

select	max(cd_setor_atendimento)
into STRICT	cd_setor_prescricao_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

open C01;
loop
fetch C01 into	
	qt_seg_margem_w,
	qt_min_apraz_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;

select	max(dt_atualizacao_nrec),
	max(dt_horario)
into STRICT	dt_ultimo_reg_w,
	dt_horario_w
from	prescr_proc_hor
where	nr_prescricao = nr_prescricao_p
and	nr_seq_procedimento = nr_seq_procedimento_p;

select	count(*)
into STRICT	qt_bolsas_w
from	prescr_proc_bolsa
where	nr_prescricao = nr_prescricao_p
and	nr_seq_procedimento = nr_seq_procedimento_p
and	coalesce(dt_cancelamento::text, '') = '';

if (qt_bolsas_w = 1) then
	select	max(dt_atualizacao_nrec)
	into STRICT	dt_ultimo_reg_w
	from	prescr_proc_bolsa
	where	nr_prescricao = nr_prescricao_p
	and	nr_seq_procedimento = nr_seq_procedimento_p
	and	coalesce(dt_cancelamento::text, '') = '';
end if;

qt_seg_dif_w := ceil((clock_timestamp() - dt_ultimo_reg_w) * 86400);

if (qt_seg_dif_w <= qt_seg_margem_w) or ((dt_inicio_prescr_w IS NOT NULL AND dt_inicio_prescr_w::text <> '') and
	(dt_horario_w IS NOT NULL AND dt_horario_w::text <> '') and
	clock_timestamp() > dt_inicio_prescr_w) then
	dt_horario_w := dt_horario_w + qt_min_apraz_w/1440;
else	
	dt_horario_w := clock_timestamp();	
end if;

return	trunc(dt_horario_w,'mi');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_horario_apraz_bolsa ( cd_perfil_p bigint, nr_prescricao_p bigint, nr_seq_procedimento_p bigint) FROM PUBLIC;

