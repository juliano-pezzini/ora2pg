-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_justifica_sepsis ( nr_seq_escala_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


qt_pontuacao_w			bigint := 0;
qt_reg_w				bigint;
qt_valor_w				double precision;
ie_regra_w				varchar(1);
qt_pont_w				bigint;
cd_setor_atendimento_w  integer;
cd_classif_setor_w		varchar(2);
qt_regra_HP_w			bigint;
qt_regra_discrasia_w	bigint;
ie_resultado_w			varchar(1);
ds_modificado_w			varchar(1);
nr_seq_atrib_w			bigint;
ie_result_w				varchar(1);
nr_atendimento_w		bigint;
ie_atributo_w			varchar(60);
ie_versao_sepse_w       varchar(10);

C01 CURSOR FOR
	SELECT	nr_seq_atributo, coalesce(ie_resultado,'N')
	from	escala_sepse_item
	where	nr_seq_escala = nr_seq_escala_p
	and 	((ie_versao_sepse_w = '1' and nr_seq_atributo in (8,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,30,31,32,34))
	or (ie_versao_sepse_w = '2' and nr_seq_atributo in (51,54,55,56,59,60,61,62,65,66,67,41,42,72,76,77)))
	order by nr_sequencia;


BEGIN

ds_modificado_w := 'N';

select	max(nr_atendimento)
into STRICT	nr_atendimento_w
from	escala_sepse
where	nr_sequencia = nr_seq_escala_p;

select coalesce(ie_versao_sepse,'1')
into STRICT   ie_versao_sepse_w
from   parametro_medico
where  cd_estabelecimento = obter_estabelecimento_ativo;

open C01;
loop
fetch C01 into
	nr_seq_atrib_w,
	ie_resultado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		if (ie_resultado_w = 'N') then

			SELECT * FROM obter_dados_escala_sepse(nr_atendimento_w, nr_seq_atrib_w, nm_usuario_p) INTO STRICT qt_valor_w, ie_regra_w, qt_pont_w, ie_atributo_w;

			select	count(*)
			into STRICT	qt_reg_w
			from	sepse_atributo_cliente
			where	nr_seq_atributo = nr_seq_atrib_w;

			if (qt_reg_w > 0) and (ie_regra_w = 'S') then

				select	max(qt_pontuacao)
				into STRICT	qt_pontuacao_w
				from	sepse_atributo_cliente b
				where	b.nr_seq_atributo = nr_seq_atrib_w
				and		qt_valor_w between coalesce(qt_valor_min,0) and coalesce(qt_valor_max,99999);
			end if;


			if (nr_seq_atrib_w in (8,17,18,19,30,31,32, 51,59,60,61,41,42)) then

				Select 	Obter_Setor_Atendimento(nr_atendimento_w)
				into STRICT	cd_setor_atendimento_w
				;

				if (coalesce(cd_setor_atendimento_w,0) > 0 ) then

					Select  max(cd_classif_setor)
					into STRICT	cd_classif_setor_w
					from	SETOR_ATENDIMENTO
					where	cd_setor_atendimento = cd_setor_atendimento_w;


					if ( coalesce(cd_classif_setor_w,'0') = '2') then

						qt_pont_w := 0;
						qt_valor_w := 0;

					end if;

				end if;
			end if;

			if (nr_seq_atrib_w in (17,30,31,32, 59,41,42))then

				Select  coalesce(sum(qt_pontuacao),0)
				into STRICT	qt_regra_HP_w
				from	escala_sepse_item
				where	nr_seq_escala = nr_seq_escala_p
				and	nr_seq_atributo in (17,30,31,32,59,41,42);

				if ( qt_regra_HP_w = 0) then
					select 	CASE WHEN coalesce(qt_pont_w,0)=0 THEN 'N'  ELSE 'S' END
					into STRICT	ie_result_w
					;
				end if;

			elsif (nr_seq_atrib_w in (21,34)) then

				Select  coalesce(sum(qt_pontuacao),0)
				into STRICT	qt_regra_discrasia_w
				from	escala_sepse_item
				where	nr_seq_escala = nr_seq_escala_p
				and	nr_seq_atributo in (21,34);

				if ( qt_regra_discrasia_w = 0) then
					select 	CASE WHEN coalesce(qt_pont_w,0)=0 THEN 'N'  ELSE 'S' END
					into STRICT	ie_result_w
					;
				end if;

			else
				select 	CASE WHEN coalesce(qt_pont_w,0)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_result_w
				;
			end if;

			if (ie_result_w = 'S') then
				ds_modificado_w := 'S';
				exit;
			end if;

		end if;
	end;
end loop;
close C01;

return ds_modificado_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_justifica_sepsis ( nr_seq_escala_p bigint, nm_usuario_p text) FROM PUBLIC;

