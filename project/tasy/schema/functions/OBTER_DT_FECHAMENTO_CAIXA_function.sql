-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dt_fechamento_caixa ( dt_saldo_p text, nr_seq_caixa_p bigint) RETURNS varchar AS $body$
DECLARE


dt_fechamento_w	timestamp;
ds_retorno_w	varchar(2);
cont_w			bigint;


BEGIN

if (dt_saldo_p IS NOT NULL AND dt_saldo_p::text <> '') and (nr_seq_caixa_p IS NOT NULL AND nr_seq_caixa_p::text <> '') then

	select	count(*) /*Verificar se existem saldos no caixa com essa dalta, idependente de estar fechado ou aberto*/
	into STRICT	cont_w
	from 	caixa_saldo_diario
	where  	trunc(dt_saldo)   		= to_date(dt_saldo_p) 
	and  	nr_seq_caixa  	= nr_seq_caixa_p;
	
	if (cont_w > 0) then /*Se existir saldo no caixa para essa data entao verifica se ele esta fechado ou aberto*/
		select  max(dt_fechamento) 
		into STRICT  	dt_fechamento_w
		from 	caixa_saldo_diario 
		where  trunc(dt_saldo)   		= to_date(dt_saldo_p) 
		and  	nr_seq_caixa  	= nr_seq_caixa_p;

		if (coalesce(dt_fechamento_w::text, '') = '') then /*Se possuir NAO possuir data de fechamento, retorna S pois pode prosseguir*/
			ds_retorno_w :='S';	
		else
			ds_retorno_w :='N';	 /*se possuir data fechamento, retorna Nao pois nao pode prosseguir*/
		end if;	
		
	else /*Se nao possuir saldo com essa data, fechado ou aberto, nunca deve prosseguir, retornando N*/
	ds_retorno_w := 'N';
	end if;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dt_fechamento_caixa ( dt_saldo_p text, nr_seq_caixa_p bigint) FROM PUBLIC;

