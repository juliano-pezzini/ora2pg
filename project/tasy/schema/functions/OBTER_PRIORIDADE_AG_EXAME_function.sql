-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prioridade_ag_exame ( nr_seq_agenda_p bigint, nr_seq_proc_interno_p bigint, cd_estabelecimento_p bigint, dt_agenda_p timestamp) RETURNS bigint AS $body$
DECLARE

 
nr_seq_prioridade_w	smallint;
cd_area_procedimento_w	integer;
cd_especialidade_w	integer;
cd_grupo_proc_w		bigint;
vl_retorno_w		smallint	:= 999;
	
cd_convenio_w		integer;
cd_categoria_w		varchar(10);	
	 
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;	
cd_plano_w		varchar(10);
cd_tipo_acomodacao_w	smallint;
	
C01 CURSOR FOR 
	SELECT	nr_seq_apres 
	from	ageint_regra_prioridade 
	where	coalesce(cd_area_procedimento, cd_area_procedimento_w)	= cd_area_procedimento_w 
	and	coalesce(cd_Especialidade, cd_especialidade_w)		= cd_especialidade_w 
	and	coalesce(cd_grupo_proc, cd_grupo_proc_w)			= cd_grupo_proc_w 
	and	coalesce(nr_seq_proc_interno, nr_seq_proc_interno_p)		= nr_seq_proc_interno_p 
	and	ie_situacao = 'A' 
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p)		= cd_estabelecimento_p 
	and	((dt_agenda_p						>= dt_vigencia_inicial) or (coalesce(dt_vigencia_inicial::text, '') = '')) 
	and 	((dt_agenda_p						<= dt_vigencia_final) or (coalesce(dt_vigencia_final::text, '') = '')) 
	order by coalesce(nr_seq_proc_interno, 0), 
		coalesce(cd_grupo_proc, 0), 
		coalesce(cd_Especialidade, 0), 
		coalesce(cd_area_procedimento, 0);
			

BEGIN 
 
select	max(cd_convenio), 
	max(cd_categoria), 
	max(cd_plano), 
	max(cd_tipo_acomodacao) 
into STRICT	cd_convenio_w, 
	cd_categoria_w, 
	cd_plano_w, 
	cd_tipo_acomodacao_w 
from	agenda_paciente 
where	nr_sequencia	= nr_seq_agenda_p;
 
SELECT * FROM obter_proc_tab_interno_conv( 
			nr_seq_proc_interno_p, cd_estabelecimento_p, cd_convenio_w, cd_categoria_w, cd_plano_w, null, cd_procedimento_w, ie_origem_proced_w, null, clock_timestamp(), cd_tipo_acomodacao_w, null, null, null, null, null, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
 
			 
select	coalesce(max(cd_area_procedimento),0), 
	coalesce(max(cd_especialidade),0), 
	coalesce(max(cd_grupo_proc),0) 
into STRICT	cd_area_procedimento_w, 
	cd_especialidade_w, 
	cd_grupo_proc_w 
from	estrutura_procedimento_v 
where	cd_procedimento = cd_procedimento_w 
and	ie_origem_proced = ie_origem_proced_w;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_prioridade_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	vl_retorno_w	:= nr_seq_prioridade_w;
	end;
end loop;
close C01;
 
return	vl_Retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prioridade_ag_exame ( nr_seq_agenda_p bigint, nr_seq_proc_interno_p bigint, cd_estabelecimento_p bigint, dt_agenda_p timestamp) FROM PUBLIC;

