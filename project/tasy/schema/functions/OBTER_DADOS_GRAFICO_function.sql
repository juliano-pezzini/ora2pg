-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_grafico (cd_setor_p bigint, ie_opcao_p text, pr_considerar_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
qt_nao_estendido_w	bigint;
qt_Total_setor_w	bigint;
ds_retorno_w		varchar(255);

/*	ie_opcao_p 
	'NE'	- Percentual de atendimentos sem plano para o dia seguinte. 
*/
 
 

BEGIN 
 
if (ie_opcao_p = 'NE') then 
	 
	select	count(a.nr_atendimento) 
	into STRICT	qt_Total_setor_w 
	from	pessoa_fisica m, 
		pessoa_fisica p, 
		unidade_atendimento b, 
		setor_atendimento c, 
		atendimento_paciente a 
	where	c.cd_setor_atendimento		= b.cd_setor_atendimento 
	and	b.nr_atendimento		= a.nr_atendimento 
	and	a.cd_pessoa_fisica		= p.cd_pessoa_fisica 
	and	a.cd_medico_resp		= m.cd_pessoa_fisica 
	and	c.ie_situacao			= 'A' 
	and	c.ie_adep			<> 'N' 
	and	a.cd_estabelecimento		= cd_estabelecimento_p 
	and	c.cd_setor_atendimento		= cd_setor_p 
	and	coalesce(a.dt_alta::text, '') = '' 
	and   not exists ( 
				SELECT	1 
				from	cirurgia x 
				where	x.cd_pessoa_fisica = a.cd_pessoa_fisica 
				and	x.dt_inicio_real between clock_timestamp() - interval '1 days' and clock_timestamp() + interval '1 days' 
				and	(x.dt_entrada_recup IS NOT NULL AND x.dt_entrada_recup::text <> '') 
				and	coalesce(X.dt_saida_recup::text, '') = '');
 
	select	count(a.nr_atendimento) 
	into STRICT	qt_nao_estendido_w 
	from	pessoa_fisica m, 
		pessoa_fisica p, 
		unidade_atendimento b, 
		setor_atendimento c, 
		atendimento_paciente a 
	where	c.cd_setor_atendimento		= b.cd_setor_atendimento 
	and	b.nr_atendimento		= a.nr_atendimento 
	and	a.cd_pessoa_fisica		= p.cd_pessoa_fisica 
	and	a.cd_medico_resp		= m.cd_pessoa_fisica 
	and	c.ie_situacao			= 'A' 
	and	c.ie_adep			<> 'N' 
	and	a.cd_estabelecimento		= cd_estabelecimento_p 
	and	c.cd_setor_atendimento		= cd_setor_p 
	and	coalesce(a.dt_alta::text, '') = '' 
	and	Obter_porcent_plano_estend(a.nr_atendimento,cd_perfil_p,a.cd_estabelecimento,nm_usuario_p)	>= coalesce(pr_considerar_p,0) 
	and   not exists ( 
				SELECT	1 
				from	cirurgia x 
				where	x.cd_pessoa_fisica = a.cd_pessoa_fisica 
				and	x.dt_inicio_real between clock_timestamp() - interval '1 days' and clock_timestamp() + interval '1 days' 
				and	(x.dt_entrada_recup IS NOT NULL AND x.dt_entrada_recup::text <> '') 
				and	coalesce(X.dt_saida_recup::text, '') = '');				
	 
	if (qt_Total_setor_w	> 0) then 
		ds_retorno_w	:= to_char(trunc(qt_nao_estendido_w * 100 / qt_Total_setor_w));
	end if;	
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_grafico (cd_setor_p bigint, ie_opcao_p text, pr_considerar_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

