-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ie_curta_duracao ( nr_prescricao_p bigint, hr_final_prescr_p timestamp, cd_perfil_p bigint, cd_medico_p text, cd_especialidade_p bigint) RETURNS varchar AS $body$
DECLARE


ie_curta_duracao_w	char(1) := 'N';
cd_perfil_w			perfil.cd_perfil%type;
cd_especialidade_w	especialidade_medica.cd_especialidade%type;

--      L   -  Prescrição de curta duração liberada
--      S   - Prescrição de curta duração não liberada
--      N   - Não é prescrição de curta duração
BEGIN
select	coalesce(max('S'),'N')
into STRICT	ie_curta_duracao_w
from	regra_plt_curta_duracao LIMIT 1;

if (ie_curta_duracao_w = 'S') then
	cd_perfil_w			:= coalesce(cd_perfil_p,0);
	cd_especialidade_w	:= coalesce(cd_especialidade_p, coalesce(obter_especialidade_medico2(cd_medico_p),0));

	select	coalesce(max('S'),'N')
	into STRICT	ie_curta_duracao_w
	from	regra_plt_curta_duracao
	where	coalesce(cd_perfil,cd_perfil_w) = cd_perfil_w
	and		coalesce(cd_especialidade,cd_especialidade_w) = cd_especialidade_w;

	if (ie_curta_duracao_w = 'S') then
		ie_curta_duracao_w	:= 'N';

		if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (hr_final_prescr_p IS NOT NULL AND hr_final_prescr_p::text <> '') then

			select	coalesce(max('L'),'N')
			into STRICT 	ie_curta_duracao_w
			from	prescr_medica where		nr_prescricao = nr_prescricao_p
			and		to_char(dt_validade_prescr, 'hh24:mi:ss') <> to_char(hr_final_prescr_p, 'hh24:mi:ss')
			and	   	((dt_liberacao_medico IS NOT NULL AND dt_liberacao_medico::text <> '') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''))
			and		nr_horas_validade < 24 LIMIT 1;

			if (ie_curta_duracao_w = 'N') then
				select	coalesce(max('S'),'N')
				into STRICT 	ie_curta_duracao_w
				from	prescr_medica where		nr_prescricao = nr_prescricao_p
				and		to_char(dt_validade_prescr, 'hh24:mi:ss') <> to_char(hr_final_prescr_p, 'hh24:mi:ss')
				and		nr_horas_validade < 24 LIMIT 1;
			end if;
		end if;
	end if;
end if;

return	ie_curta_duracao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ie_curta_duracao ( nr_prescricao_p bigint, hr_final_prescr_p timestamp, cd_perfil_p bigint, cd_medico_p text, cd_especialidade_p bigint) FROM PUBLIC;

