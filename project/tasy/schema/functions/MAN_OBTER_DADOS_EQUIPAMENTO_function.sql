-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_obter_dados_equipamento ( nr_seq_equipamento_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_equipamento_w 			varchar(80);
ie_situacao_w			varchar(1);
cd_imobilizado_w			varchar(20);
cd_imobilizado_ext_w		varchar(20);
ds_marca_w			varchar(50);
ds_modelo_w			varchar(50);
nr_seq_fabricante_w		bigint;
nr_serie_w			varchar(30);
nr_seq_local_w			bigint;
ds_retorno_w			varchar(255);
nr_seq_enc_w			bigint;
qt_altura_w			man_equipamento.qt_altura%type;
qt_comprimento_w			man_equipamento.qt_comprimento%type;
qt_largura_w			man_equipamento.qt_largura%type;
qt_peso_w			man_equipamento.qt_peso%type;
ds_categoria_w			varchar(50);
nr_seq_categoria_w		bigint;
cd_centro_custo_w			integer;
dt_aquisicao_w			timestamp;
nr_seq_tipo_w			bigint;
nr_seq_marca_w			bigint;
nr_seq_modelo_w			bigint;
ie_propriedade_w			varchar(1);
nr_seq_planej_w			bigint;
ds_endereco_w			varchar(255);
cd_estab_contabil_w		smallint;
dt_inicio_garantia_w		timestamp;
dt_fim_garantia_w		timestamp;
cd_material_w			integer;

/*ie_opcao_p
S - Situacao
I - Imobilizado
D - Descrição
M - Marca
F - Fabricante
O - Modelo
E - Serie
L - Localização
UE - Ultimo tipo de encaminhamento sem retorno (	para identificar se um equipamento está emprestado por exemplo)
A -  Qt altura
C - Qt comprimento
G -  Qt largura
P - Qt Peso
CE - Categoria Equipamento
PS - Existe Protocolo solicitação
PR - Existe Protocolo requisição
CC - Centro de custo
DA - data de aquisição
T - Tipo do equipamento
SL - Sequencia da localizacao.
SM - Sequencia da marca
CM - Sequencia modelo
PRO - Propriedade
ST - Setor
CST - Código do setor da localização
SGP - Sequência do grupo de planejamento
DGP - Descrição do grupo de planejamento
DTE - Descrição do tipo do equipamento
LE - Localização do equipamento (sem o setor)
EM - Endereço  - (IP)
EST - Estabelecimento
IG - Início Garantia
FG - Fim Garantia
CMA - Codigo Material
*/
BEGIN

/*select	max(ds_equipamento),
	max(ie_situacao),
	max(cd_imobilizado),
	max(ds_marca),
	max(ds_modelo),
	max(nr_serie),
	max(nr_seq_local),
	max(nr_seq_fabricante),
	max(cd_imobilizado_ext),
	max(qt_altura), 
	max(qt_comprimento), 
	max(qt_largura),
	max(qt_peso),
	max(nr_seq_categoria),
	max(cd_centro_custo),
	max(dt_aquisicao),
	max(nr_seq_tipo_equip),
	max(nr_seq_marca),
	max(nr_seq_modelo),
	max(ie_propriedade),
	max(nr_seq_planej),
	max(ds_endereco),
	max(dt_inicio_garantia),
	max(dt_fim_garantia),
	max(cd_material)
into	ds_equipamento_w,
	ie_situacao_w,
	cd_imobilizado_w,
	ds_marca_w,
	ds_modelo_w,
	nr_serie_w,
	nr_seq_local_w,
	nr_seq_fabricante_w,
	cd_imobilizado_ext_w,
	qt_altura_w, 
	qt_comprimento_w, 
	qt_largura_w,
	qt_peso_w,
	nr_seq_categoria_w,
	cd_centro_custo_w,
	dt_aquisicao_w,
	nr_seq_tipo_w,
	nr_seq_marca_w,
	nr_seq_modelo_w,
	ie_propriedade_w,
	nr_seq_planej_w,
	ds_endereco_w,
	dt_inicio_garantia_w,
	dt_fim_garantia_w,
	cd_material_w	
from	man_equipamento a
where	nr_sequencia = nr_seq_equipamento_p;*/
if (ie_opcao_p = 'S') then
	select	max(ie_situacao)
	into STRICT	ie_situacao_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;
	
	ds_retorno_w	:= ie_situacao_w;
elsif (ie_opcao_p = 'I') then
	select	max(cd_imobilizado)
	into STRICT	cd_imobilizado_w	
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;
	
	ds_retorno_w	:= cd_imobilizado_w;
elsif (ie_opcao_p = 'D') then
	select	max(ds_equipamento)
	into STRICT	ds_equipamento_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w	:= ds_equipamento_w;
elsif (ie_opcao_p = 'M') then
	select	max(ds_marca)
	into STRICT	ds_marca_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w	:= ds_marca_w;
elsif (ie_opcao_p = 'O') then
	begin
	select	max(ds_modelo),
		max(nr_seq_modelo)
	into STRICT	ds_modelo_w,
		nr_seq_modelo_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;
	
	if (coalesce(ds_modelo_w::text, '') = '') and (coalesce(nr_seq_modelo_w,0) <> 0) then

		select	ds_modelo
		into STRICT	ds_retorno_w
		from	man_modelo
		where	nr_sequencia = nr_seq_modelo_w;

	else
		ds_retorno_w	:= ds_modelo_w;		
	end if;

	end;
elsif (ie_opcao_p = 'E') then
	select	max(nr_serie)
	into STRICT	nr_serie_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w	:= nr_serie_w;
elsif (ie_opcao_p = 'A') then
	select	max(qt_altura)
	into STRICT	qt_altura_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w 	:= qt_altura_w;	
elsif (ie_opcao_p = 'C' ) then
	select	max(qt_comprimento)
	into STRICT	qt_comprimento_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w 	:= qt_comprimento_w;	
elsif (ie_opcao_p = 'G') then
	select	max(qt_largura)
	into STRICT	qt_largura_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w 	:= qt_largura_w;
elsif (ie_opcao_p = 'P') then
	select	max(qt_peso)
	into STRICT	qt_peso_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w 	:= qt_peso_w;	
elsif (ie_opcao_p = 'X') then
	select	max(cd_imobilizado_ext)
	into STRICT	cd_imobilizado_ext_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w	:= cd_imobilizado_ext_w;	
elsif (ie_opcao_p = 'L') then
	select	max(nr_seq_local)
	into STRICT	nr_seq_local_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	select	substr(ds_localizacao || ' / ' || substr(obter_nome_setor(cd_setor),1,50),1,255)
	into STRICT	ds_retorno_w
	from	man_localizacao
	where	nr_sequencia = nr_seq_local_w;
elsif (ie_opcao_p = 'F') then
	select	max(nr_seq_fabricante)
	into STRICT	nr_seq_fabricante_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	if (nr_seq_fabricante_w > 0) then
		select ds_fabricante
		into STRICT   ds_retorno_w
		from   man_fabricante
		where  nr_sequencia = nr_seq_fabricante_w;
	end if;
elsif (ie_opcao_p = 'UE') then
	begin
	select	max(y.nr_sequencia)
	into STRICT	nr_seq_enc_w
	from	man_ordem_servico x,
		man_ordem_serv_externo y
	where	x.nr_sequencia		= y.nr_seq_ordem_serv
	and	x.nr_seq_equipamento 	= nr_seq_equipamento_p
	and	coalesce(y.dt_retorno::text, '') = '';
	
	if (coalesce(nr_seq_enc_w,0) > 0) then
		select	substr(obter_valor_dominio(3264, ie_tipo_enc),1,255)
		into STRICT	ds_retorno_w
		from	man_ordem_serv_externo
		where	nr_sequencia = nr_seq_enc_w;
		null;
	end if;
	end;
elsif (ie_opcao_p = 'CE') then
	begin
	select	max(a.nr_seq_categoria)
	into STRICT	nr_seq_categoria_w
	from	man_equipamento a
	where	a.nr_sequencia	= nr_seq_equipamento_p;
		
	select	ds_categoria
	into STRICT	ds_retorno_w
	from	man_categoria_equip	b
	where	nr_sequencia = nr_seq_categoria_w;
	end;
elsif (ie_opcao_p = 'PR') then
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ds_retorno_w
	from	prot_requisicao
	where	nr_seq_equipamento = nr_seq_equipamento_p;
elsif (ie_opcao_p = 'PS') then
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ds_retorno_w
	from	prot_solic_compra
	where	nr_seq_equipamento = nr_seq_equipamento_p;
elsif (ie_opcao_p = 'CC') then
	select	max(cd_centro_custo)
	into STRICT	cd_centro_custo_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w := cd_centro_custo_w;
elsif (ie_opcao_p = 'DA') then
	select	max(dt_aquisicao)
	into STRICT	dt_aquisicao_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w := to_char(dt_aquisicao_w,'dd/mm/yyyy');
elsif (ie_opcao_p = 'T') then
	select	max(nr_seq_tipo_equip)
	into STRICT	nr_seq_tipo_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w := nr_seq_tipo_w;	
elsif (ie_opcao_p = 'SL') then
	select	max(nr_seq_local)
	into STRICT	nr_seq_local_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w := nr_seq_local_w;
elsif (ie_opcao_p = 'SM') then
	select	max(nr_seq_marca)
	into STRICT	nr_seq_marca_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w := nr_seq_marca_w;
elsif (ie_opcao_p = 'CM') then
	select	max(nr_seq_modelo)
	into STRICT	nr_seq_modelo_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w := nr_seq_modelo_w;
elsif (ie_opcao_p = 'PRO') then
	select	max(ie_propriedade)
	into STRICT	ie_propriedade_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w := ie_propriedade_w;
elsif (ie_opcao_p = 'ST') then
	select	max(nr_seq_local)
	into STRICT	nr_seq_local_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	select	substr(obter_nome_setor(cd_setor),1,255)
	into STRICT	ds_retorno_w
	from	man_localizacao
	where	nr_sequencia = nr_seq_local_w;
elsif (ie_opcao_p = 'CST') then
	select	max(nr_seq_local)
	into STRICT	nr_seq_local_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	select	cd_setor
	into STRICT	ds_retorno_w
	from	man_localizacao
	where	nr_sequencia = nr_seq_local_w;
elsif (ie_opcao_p = 'SGP') then
	select	max(nr_seq_planej)
	into STRICT	nr_seq_planej_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w := nr_seq_planej_w;
elsif (ie_opcao_p = 'DGP') then
	select	max(nr_seq_planej)
	into STRICT	nr_seq_planej_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	select	ds_grupo_planej
	into STRICT	ds_retorno_w
	from	man_grupo_planejamento
	where	nr_sequencia = nr_seq_planej_w;
elsif (ie_opcao_p = 'DTE') then
	select	max(nr_seq_tipo_equip)
	into STRICT	nr_seq_tipo_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	select	ds_tipo_equip
	into STRICT	ds_retorno_w
	from	man_tipo_equipamento
	where	nr_sequencia = nr_seq_tipo_w;
elsif (ie_opcao_p = 'LE') then
	select	max(nr_seq_local)
	into STRICT	nr_seq_local_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	select	ds_localizacao
	into STRICT	ds_retorno_w
	from	man_localizacao
	where	nr_sequencia = nr_seq_local_w;
elsif (ie_opcao_p = 'EM') then
	select	max(ds_endereco)
	into STRICT	ds_endereco_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w := ds_endereco_w;
elsif (ie_opcao_p = 'EST') then
	ds_retorno_w := cd_estab_contabil_w;
elsif (ie_opcao_p = 'IG') then
	select	max(dt_inicio_garantia)
	into STRICT	dt_inicio_garantia_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w := TO_CHAR(dt_inicio_garantia_w,'dd/mm/yyyy');
elsif (ie_opcao_p = 'FG') then
	select	max(dt_fim_garantia)
	into STRICT	dt_fim_garantia_w
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;

	ds_retorno_w := TO_CHAR(dt_fim_garantia_w,'dd/mm/yyyy');
elsif (ie_opcao_p = 'CMA') then
	select	max(cd_material)
	into STRICT	cd_material_w	
	from	man_equipamento a
	where	nr_sequencia = nr_seq_equipamento_p;
	
	ds_retorno_w := cd_material_w;	
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_obter_dados_equipamento ( nr_seq_equipamento_p bigint, ie_opcao_p text) FROM PUBLIC;

