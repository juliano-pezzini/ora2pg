-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_item_release_profile ( nr_cirurgia_p bigint, nr_seq_pepo_p bigint, nr_seq_item_pepo_p bigint) RETURNS varchar AS $body$
DECLARE


ds_return_w					varchar(1)	:=	'N';
ie_released_profile_w 		varchar(1);
ie_tipo_item_w				varchar(15);
cd_perfil_w					integer;
ie_fanep_w					varchar(1) := 'N';
ie_atualizar_w				varchar(1);
cd_estabelecimento_w		integer;
nm_usuario_w				varchar(15);
ie_estrutura_pepo_w			varchar(15);


BEGIN
cd_perfil_w 			:= wheb_usuario_pck.get_cd_perfil;
nm_usuario_w 			:= wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;

ie_estrutura_pepo_w := obter_param_usuario(872, 158, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_estrutura_pepo_w);

if (coalesce(nr_seq_pepo_p,0) > 0) then
	select	coalesce(max('N'),'S')
	into STRICT	ie_fanep_w
	from	cirurgia
	where	nr_seq_pepo = nr_seq_pepo_p;
end if;

if (ie_fanep_w = 'N') then
	select	coalesce(max('S'),'N'),
			coalesce(max(ie_tipo_item),'A'),
			coalesce(max(ie_atualizar),'S')
	into STRICT	ie_released_profile_w,
			ie_tipo_item_w,
			ie_atualizar_w
	from	perfil_item_pepo
	where	nr_seq_item_pepo 	= nr_seq_item_pepo_p
	and		cd_perfil			= cd_perfil_w;
else
	ie_tipo_item_w := 'A';
	select	coalesce(max('S'),'N'),
			coalesce(max(ie_atualizar),'S')
	into STRICT	ie_released_profile_w,
			ie_atualizar_w
	from	perfil_item_fanep
	where	nr_seq_item 		= nr_seq_item_pepo_p
	and		cd_perfil			= cd_perfil_w;
end if;

if (ie_atualizar_w = 'S') and (ie_released_profile_w = 'S') and (ie_tipo_item_w in ('P','A')) and (coalesce(nr_cirurgia_p,0) > 0) then
	ds_return_w := 'S';
elsif (ie_atualizar_w = 'S') and (ie_released_profile_w = 'S') and (ie_tipo_item_w in ('C','A')) and (coalesce(nr_seq_pepo_p,0) > 0) then
	ds_return_w := 'S';
elsif (ie_fanep_w = 'N') and (ie_estrutura_pepo_w = 'N') and (ie_released_profile_w = 'S') and (ie_atualizar_w = 'S') then
	ds_return_w := 'S';
end if;

return ds_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_item_release_profile ( nr_cirurgia_p bigint, nr_seq_pepo_p bigint, nr_seq_item_pepo_p bigint) FROM PUBLIC;

