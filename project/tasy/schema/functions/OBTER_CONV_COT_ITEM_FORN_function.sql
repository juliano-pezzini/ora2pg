-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_conv_cot_item_forn (nr_sequencia_p bigint) RETURNS bigint AS $body$
DECLARE


qt_conv_compra_est_w		double precision := 0;
cd_material_w			integer;
nr_cot_compra_w			bigint;
nr_item_cot_compra_w		integer;
nr_seq_marca_w			bigint;
ds_marca_w			cot_compra_forn_item.ds_marca%type;
cd_estabelecimento_w		smallint;
ie_conversao_marca_w		varchar(1);



BEGIN



select	a.cd_material,
	a.nr_cot_compra,
	a.nr_item_cot_compra,
	coalesce(substr(a.ds_marca,1,position('(' in a.ds_marca)-1),a.ds_marca),
	b.cd_estabelecimento
into STRICT	cd_material_w,
	nr_cot_compra_w,
	nr_item_cot_compra_w,
	ds_marca_w,
	cd_estabelecimento_w
from	cot_compra_forn_item a,
	cot_compra b
where	nr_sequencia = nr_sequencia_p
and	a.nr_cot_compra = b.nr_cot_compra;

select	max(b.nr_sequencia)
into STRICT	nr_seq_marca_w
from	marca a,
	material_marca b
where	elimina_acentuacao(upper(ds_marca)) = elimina_acentuacao(upper(ds_marca_w))
and	a.nr_sequencia = b.nr_sequencia
and	b.cd_material = cd_material_w;

select	coalesce(ie_conversao_marca,'N')
into STRICT	ie_conversao_marca_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

if (ie_conversao_marca_w = 'S') then
	select	obter_conver_marca_mat(cd_material_w, nr_seq_marca_w, cd_estabelecimento_w)
	into STRICT	qt_conv_compra_est_w
	;
end if;

if (coalesce(qt_conv_compra_est_w,0) = 0) then
	select	(substr(obter_descricao_padrao(	'MATERIAL', 'QT_CONV_COMPRA_ESTOQUE',
						coalesce(cd_material_w, obter_atributo_cot_compra(nr_cot_compra_w, nr_item_cot_compra_w,'CD_MATERIAL'))),1,80))::numeric
	into STRICT	qt_conv_compra_est_w
	;
end if;

return	qt_conv_compra_est_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_conv_cot_item_forn (nr_sequencia_p bigint) FROM PUBLIC;

