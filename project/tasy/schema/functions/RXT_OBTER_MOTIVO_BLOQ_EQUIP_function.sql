-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION rxt_obter_motivo_bloq_equip (nr_seq_equip_p bigint, dt_agenda_p timestamp, hr_horario_p timestamp) RETURNS varchar AS $body$
DECLARE


motivo_bloqueio_w     		varchar(15)    := '';
nr_seq_bloqueio_w			bigint;
hr_inicial_bloqueio_w		timestamp;
hr_final_bloqueio_w			timestamp;
dt_inicial_bloqueio_w		timestamp;
dt_final_bloqueio_w			timestamp;
ie_motivo_bloqueio_w		varchar(15)    := '';

c01 CURSOR FOR
SELECT  nr_sequencia,
	trunc(dt_inicial),
	trunc(dt_final),
	TO_DATE(TO_CHAR(dt_agenda_p,'dd/mm/yyyy') || ' ' || TO_CHAR(hr_inicio_bloqueio,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss'),
	TO_DATE(TO_CHAR(dt_agenda_p,'dd/mm/yyyy') || ' ' || TO_CHAR(hr_final_bloqueio,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss'),
	IE_MOTIVO_BLOQUEIO
FROM rxt_agenda_bloqueio
WHERE 1 = 1
AND nr_seq_equipamento = nr_seq_equip_p
AND (TRUNC(dt_agenda_p) BETWEEN TRUNC(dt_inicial) AND TRUNC(dt_final));



BEGIN

motivo_bloqueio_w := '';

OPEN c01;
	LOOP
	FETCH c01 INTO	nr_seq_bloqueio_w,
		dt_inicial_bloqueio_w,
		dt_final_bloqueio_w,
		hr_inicial_bloqueio_w,
		hr_final_bloqueio_w,
		ie_motivo_bloqueio_w;

		EXIT WHEN NOT FOUND OR (motivo_bloqueio_w = '');  /* apply on c01 */
			BEGIN
			IF ((dt_agenda_p >= dt_inicial_bloqueio_w AND dt_agenda_p <= dt_final_bloqueio_w) AND
				((hr_inicial_bloqueio_w = dt_agenda_p AND hr_final_bloqueio_w = dt_agenda_p) OR (hr_horario_p >= hr_inicial_bloqueio_w AND hr_final_bloqueio_w = dt_agenda_p) OR (hr_inicial_bloqueio_w = dt_agenda_p AND hr_horario_p <= hr_final_bloqueio_w ) OR (hr_horario_p >= hr_inicial_bloqueio_w AND hr_horario_p <= hr_final_bloqueio_w))) THEN
				motivo_bloqueio_w := ie_motivo_bloqueio_w;
			ELSE
				motivo_bloqueio_w := '';
			END IF;
			END;

			END LOOP;
			CLOSE C01;

return	motivo_bloqueio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION rxt_obter_motivo_bloq_equip (nr_seq_equip_p bigint, dt_agenda_p timestamp, hr_horario_p timestamp) FROM PUBLIC;

