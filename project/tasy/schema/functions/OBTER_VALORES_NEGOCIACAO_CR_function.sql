-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valores_negociacao_cr ( nr_seq_negociacao_p bigint, ie_tipo_valor_p text) RETURNS bigint AS $body$
DECLARE


/*
ie_tipo_valor_p

VP - Valor do pagamento (Soma dos valores monetários da negociação)
VS - Valor saldo (valor que falta para fechar a negociação)
VA - Valor dos acrescimos
VT - Valor total da negociação
*/
vl_retorno_w		double precision;
vl_negociacao_w		double precision;
vl_cheque_w		double precision;
vl_cartao_w		double precision;
vl_especie_w		double precision;
vl_boleto_w		double precision;
vl_debito_w		double precision;
vl_juros_w		double precision;
vl_multa_w		double precision;
vl_desconto_w		double precision;
tx_negociacao_w		double precision;
vl_mensalidade_w	double precision;
vl_deposito_w		double precision;


BEGIN

vl_retorno_w	:= null;

if (nr_seq_negociacao_p IS NOT NULL AND nr_seq_negociacao_p::text <> '') then
	select	a.vl_negociado,
		coalesce(a.vl_juros,0),
		coalesce(a.vl_multa,0),
		coalesce(a.vl_desconto,0),
		coalesce(a.tx_negociacao,0)
	into STRICT	vl_negociacao_w,
		vl_juros_w,
		vl_multa_w,
		vl_desconto_w,
		tx_negociacao_w
	from	negociacao_cr a
	where	a.nr_sequencia	= nr_seq_negociacao_p;

	/* Cheques */

	select	coalesce(sum(a.vl_cheque),0)
	into STRICT	vl_cheque_w
	from	negociacao_cr_cheque a
	where	a.nr_seq_negociacao	= nr_seq_negociacao_p;

	/* Cartão */

	select	coalesce(sum(a.vl_transacao),0)
	into STRICT	vl_cartao_w
	from	negociacao_cr_cartao a
	where	a.nr_seq_negociacao	= nr_seq_negociacao_p;

	/* Espécie */

	select	coalesce(sum(a.vl_especie),0)
	into STRICT	vl_especie_w
	from	negociacao_cr_especie a
	where	a.nr_seq_negociacao	= nr_seq_negociacao_p;

	/* Boleto */

	select	coalesce(sum(a.vl_parcela),0)
	into STRICT	vl_boleto_w
	from	negociacao_cr_boleto a
	where	a.nr_seq_negociacao	= nr_seq_negociacao_p;

	/* Débito em conta */

	select	coalesce(sum(a.vl_debito),0)
	into STRICT	vl_debito_w
	from	negociacao_cr_deb_cc a
	where	a.nr_seq_negociacao	= nr_seq_negociacao_p;

	/* Mensalidade */

	select	coalesce(sum(a.vl_mensalidade),0)
	into STRICT	vl_mensalidade_w
	from	negociacao_cr_pls_mens a
	where	a.nr_seq_negociacao	= nr_seq_negociacao_p;

	/* Depósito identificado */

	select	sum(a.vl_deposito)
	into STRICT	vl_deposito_w
	from	negociacao_cr_dep_ident	a
	where	a.nr_seq_negociacao	= nr_seq_negociacao_p;

	if (ie_tipo_valor_p = 'VP') then
		vl_retorno_w	:= vl_cheque_w + vl_cartao_w + vl_especie_w + vl_boleto_w + vl_debito_w + vl_mensalidade_w + vl_deposito_w;
	elsif (ie_tipo_valor_p = 'VS') then
		vl_retorno_w	:= coalesce((vl_negociacao_w + vl_juros_w + vl_multa_w + tx_negociacao_w - vl_desconto_w) -
				(vl_cheque_w + vl_cartao_w + vl_especie_w + vl_boleto_w + vl_debito_w + vl_mensalidade_w + vl_deposito_w),0);
	elsif (ie_tipo_valor_p = 'VA') then
		vl_retorno_w	:= vl_juros_w + vl_multa_w + tx_negociacao_w;
	elsif (ie_tipo_valor_p = 'VT') then
		vl_retorno_w	:= (vl_negociacao_w + vl_juros_w + vl_multa_w + tx_negociacao_w - vl_desconto_w);
	end if;
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valores_negociacao_cr ( nr_seq_negociacao_p bigint, ie_tipo_valor_p text) FROM PUBLIC;

