-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_tit_cheque_filtro_rel (nr_titulo_p bigint, nr_seq_cheque_p bigint, ds_lista_conta_financ_p text, ds_lista_convenio_p text, ds_lista_estab_p text) RETURNS varchar AS $body$
DECLARE

 
ds_lista_convenio_w		varchar(4000);
ie_todos_menos_convenio_w	varchar(1)	:= 'N';
ds_lista_conta_financ_w		varchar(4000);
ie_todos_menos_conta_w		varchar(1)	:= 'N';
ds_lista_estab_w		varchar(4000);
ie_todos_menos_estab_w		varchar(1)	:= 'N';
ie_existe_conv_w		varchar(1)	:= 'S';
ie_existe_conta_w		varchar(1)	:= 'S';
ie_existe_estab_w		varchar(1)	:= 'S';
ie_retorno_w			varchar(1)	:= 'S';


BEGIN 
 
if (substr(ds_lista_convenio_p,1,1) = '-') then 
	ie_todos_menos_convenio_w	:= 'S';
end if;
 
if (substr(ds_lista_conta_financ_p,1,1) = '-') then 
	ie_todos_menos_conta_w		:= 'S';
end if;
 
if (substr(ds_lista_estab_p,1,1) = '-') then 
	ie_todos_menos_estab_w		:= 'S';
end if;
 
ds_lista_convenio_w	:= ' ' || replace(replace(replace(replace(ds_lista_convenio_p,'-',''),'(',' '),')',' '),',',' ') || ' ';
ds_lista_conta_financ_w	:= ' ' || replace(replace(replace(replace(ds_lista_conta_financ_p,'-',''),'(',' '),')',' '),',',' ') || ' ';
ds_lista_estab_w	:= ' ' || replace(replace(replace(replace(ds_lista_estab_p,'-',''),'(',' '),')',' '),',',' ') || ' ';
 
if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') then 
 
	/* filtrar conta financeira */
 
	if (ds_lista_conta_financ_p IS NOT NULL AND ds_lista_conta_financ_p::text <> '') then 
 
		if (ie_todos_menos_conta_w = 'N') then 
			select	coalesce(max('S'),'N') 
			into STRICT	ie_existe_conta_w 
			from	titulo_receber a 
			where	a.nr_titulo	= nr_titulo_p 
			and	exists (SELECT	1 
					from	titulo_receber_classif x 
					where	x.nr_titulo	= a.nr_titulo 
					and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %');
		else 
			select	coalesce(max('S'),'N') 
			into STRICT	ie_existe_conta_w 
			from	titulo_receber a 
			where	a.nr_titulo	= nr_titulo_p 
			and	not exists (SELECT	1 
					from	titulo_receber_classif x 
					where	x.nr_titulo	= a.nr_titulo 
					and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %');
		end if;
 
	end if;
 
	/* filtrar convÃªnio */
 
	if (ds_lista_convenio_p IS NOT NULL AND ds_lista_convenio_p::text <> '') then 
 
		if (ie_todos_menos_convenio_w = 'N') then 
			select	coalesce(max('S'),'N') 
			into STRICT	ie_existe_conv_w 
			from	titulo_receber a 
			where	a.nr_titulo	= nr_titulo_p 
			and	ds_lista_convenio_w like '% ' || coalesce(obter_convenio_tit_rec(a.nr_titulo),0) || ' %';
		else	 
			select	coalesce(max('S'),'N') 
			into STRICT	ie_existe_conv_w 
			from	titulo_receber a 
			where	a.nr_titulo	= nr_titulo_p 
			and	ds_lista_convenio_w not like '% ' || coalesce(obter_convenio_tit_rec(a.nr_titulo),0) || ' %';
		end if;
 
	end if;
 
	/* filtrar estabelecimento */
 
	if (ds_lista_estab_p IS NOT NULL AND ds_lista_estab_p::text <> '') then 
 
		if (ie_todos_menos_estab_w = 'N') then 
			select	coalesce(max('S'),'N') 
			into STRICT	ie_existe_estab_w 
			from	titulo_receber a 
			where	a.nr_titulo	= nr_titulo_p 
			and	ds_lista_estab_w like '% ' || a.cd_estabelecimento || ' %';
		else	 
			select	coalesce(max('S'),'N') 
			into STRICT	ie_existe_estab_w 
			from	titulo_receber a 
			where	a.nr_titulo	= nr_titulo_p 
			and	ds_lista_estab_w not like '% ' || a.cd_estabelecimento || ' %';
		end if;
 
	end if;
 
	if (ie_existe_conta_w = 'N') or (ie_existe_conv_w = 'N') or (ie_existe_estab_w = 'N') then 
		ie_retorno_w	:= 'N';
	end if;
 
elsif (nr_seq_cheque_p IS NOT NULL AND nr_seq_cheque_p::text <> '') and (coalesce(ds_lista_convenio_p::text, '') = '') then 
 
	/* filtrar conta financeira */
 
	if (ds_lista_conta_financ_p IS NOT NULL AND ds_lista_conta_financ_p::text <> '') then 
	 
		if (ie_todos_menos_conta_w = 'N') then 
			select	coalesce(max('S'),'N') 
			into STRICT	ie_existe_conta_w 
			from	cheque_cr a 
			where	a.nr_seq_cheque	= nr_seq_cheque_p 
			and	ds_lista_conta_financ_w like '% ' || 
					coalesce(obter_conta_financ_cheque_cr(a.nr_seq_cheque,obter_status_cheque(a.nr_seq_cheque)),0) || ' %';
		else 
			select	coalesce(max('S'),'N') 
			into STRICT	ie_existe_conta_w 
			from	cheque_cr a 
			where	a.nr_seq_cheque	= nr_seq_cheque_p 
			and	ds_lista_conta_financ_w not like '% ' || 
					coalesce(obter_conta_financ_cheque_cr(a.nr_seq_cheque,obter_status_cheque(a.nr_seq_cheque)),0) || ' %';
		end if;
 
	end if;
 
	/* filtrar estabelecimento */
 
	if (ds_lista_estab_p IS NOT NULL AND ds_lista_estab_p::text <> '') then 
 
		if (ie_todos_menos_estab_w = 'N') then 
			select	coalesce(max('S'),'N') 
			into STRICT	ie_existe_estab_w 
			from	cheque_cr a 
			where	a.nr_seq_cheque	= nr_seq_cheque_p 
			and	ds_lista_estab_w like '% ' || a.cd_estabelecimento || ' %';
		else	 
			select	coalesce(max('S'),'N') 
			into STRICT	ie_existe_estab_w 
			from	cheque_cr a 
			where	a.nr_seq_cheque	= nr_seq_cheque_p 
			and	ds_lista_estab_w not like '% ' || a.cd_estabelecimento || ' %';
		end if;
 
	end if;
 
	if (ie_existe_conta_w = 'N') or (ie_existe_estab_w = 'N') then 
		ie_retorno_w	:= 'N';
	end if;
 
else 
	ie_retorno_w	:= 'N';
 
end if;
 
return ie_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_tit_cheque_filtro_rel (nr_titulo_p bigint, nr_seq_cheque_p bigint, ds_lista_conta_financ_p text, ds_lista_convenio_p text, ds_lista_estab_p text) FROM PUBLIC;

