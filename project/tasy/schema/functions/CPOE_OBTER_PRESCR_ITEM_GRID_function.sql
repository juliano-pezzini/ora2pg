-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_prescr_item_grid ( nm_tabela_p text, nr_sequencia_p bigint, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_tipo_dieta_p text) RETURNS bigint AS $body$
DECLARE

 
nr_prescricao_w		prescr_medica.nr_prescricao%type;
ie_tipo_dieta_w		cpoe_dieta.ie_tipo_dieta%type;
ie_tipo_item_w		varchar(10);

/* Procedure created just to be used on the CPOE activation 
	For other usages can be used the followed procedures: 
		- obter_prescr_item_cpoe(nr_sequencia_p number, ie_tipo_item_p varchar2) 
		- cpoe_obter_tipo_item(nm_tabela_p varchar2, nr_sequencia_p number) 
*/
 
 

BEGIN 
 
	if (nm_tabela_p	= 'CPOE_MATERIAL') then	 
		select	max(a.nr_prescricao) 
		into STRICT	nr_prescricao_w 
		from	prescr_medica a, 
			prescr_material b 
		where	a.nr_prescricao	= b.nr_prescricao 
		and ((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
		and	b.nr_seq_mat_cpoe	= nr_sequencia_p;
		 
	elsif (nm_tabela_p	= 'CPOE_DIETA') and (ie_tipo_dieta_p IS NOT NULL AND ie_tipo_dieta_p::text <> '') then		 
		case	ie_tipo_dieta_p 
			when 'O' then 
				ie_tipo_item_w	:= 'D';
			when 'J' then 
				ie_tipo_item_w	:= 'J';
			when 'E' then 
				ie_tipo_item_w	:= 'SNE';
			when 'L' then 
				ie_tipo_item_w	:= 'LD';
			when 'S' then 
				ie_tipo_item_w	:= 'S';	
			when 'P' then 
				ie_tipo_item_w	:= 'NPTA';
			when 'I' then 
				ie_tipo_item_w	:= 'NPTI';
		end case;
		 
		if (ie_tipo_item_w		= 'D') then 
		 
			select	max(a.nr_prescricao) 
			into STRICT	nr_prescricao_w 
			from	prescr_medica a, 
				prescr_dieta b 
			where	a.nr_prescricao	= b.nr_prescricao 
			and ((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
			and	b.nr_seq_dieta_cpoe	= nr_sequencia_p;
			 
		elsif (ie_tipo_item_w		in ('SNE','S','LD')) then 
			select	max(a.nr_prescricao) 
			into STRICT	nr_prescricao_w 
			from	prescr_medica a, 
				prescr_material b 
			where	a.nr_prescricao	= b.nr_prescricao 
			and ((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
			and	b.nr_seq_dieta_cpoe	= nr_sequencia_p;
			 
		elsif (ie_tipo_item_w		= 'J') then 
			select	max(a.nr_prescricao) 
			into STRICT	nr_prescricao_w 
			from	prescr_medica a, 
				rep_jejum b 
			where	a.nr_prescricao	= b.nr_prescricao 
			and ((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
			and	b.nr_seq_dieta_cpoe	= nr_sequencia_p;
			 
		elsif (ie_tipo_item_w		in ('NPTA', 'NPTI')) then 
			select	max(a.nr_prescricao) 
			into STRICT	nr_prescricao_w 
			from	prescr_medica a, 
				nut_pac b 
			where	a.nr_prescricao	= b.nr_prescricao 
			and ((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
			and	b.nr_seq_npt_cpoe	= nr_sequencia_p;
		end if;
 
	elsif (nm_tabela_p	= 'CPOE_GASOTERAPIA') then	 
	 
		select	max(a.nr_prescricao) 
		into STRICT	nr_prescricao_w 
		from	prescr_medica a, 
			prescr_gasoterapia b 
		where	a.nr_prescricao	= b.nr_prescricao 
		and ((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
		and	b.nr_seq_gas_cpoe	= nr_sequencia_p;
		 
	elsif (nm_tabela_p	= 'CPOE_RECOMENDACAO') then		 
 
		select	max(a.nr_prescricao) 
		into STRICT	nr_prescricao_w 
		from	prescr_medica a, 
			prescr_recomendacao b 
		where	a.nr_prescricao	= b.nr_prescricao 
		and ((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
		and	b.nr_seq_rec_cpoe	= nr_sequencia_p;
		 
	elsif (nm_tabela_p	= 'CPOE_DIALISE') then	 
		 
		select	max(a.nr_prescricao) 
		into STRICT	nr_prescricao_w 
		from	prescr_medica a, 
			prescr_solucao b 
		where	a.nr_prescricao	= b.nr_prescricao 
		and ((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
		and	b.nr_seq_dialise_cpoe	= nr_sequencia_p;
		 
	elsif (nm_tabela_p	= 'CPOE_PROCEDIMENTO') then 
		ie_tipo_item_w	:= 'P';
		 
	elsif (nm_tabela_p	= 'CPOE_HEMOTERAPIA') then 
		ie_tipo_item_w	:= 'HM';
		 
	elsif (nm_tabela_p	= 'CPOE_ANATOMIA_PATOLOGICA') then	 
		ie_tipo_item_w	:= 'AP';	
 
	elsif (nm_tabela_p	= 'CPOE_INTERVENCAO') then 
 
		select max(a.nr_prescricao) 
		into STRICT	nr_prescricao_w 
		from pe_prescricao a, 
			pe_prescr_proc b 
		where a.nr_sequencia = b.nr_seq_prescr 
		and ((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
		and b.nr_seq_cpoe_interv = nr_sequencia_p;
		 
	end if;
	 
	if (ie_tipo_item_w	in ('P','HM','AP')) then 
		select	max(a.nr_prescricao) 
		into STRICT	nr_prescricao_w 
		from	prescr_medica a, 
			prescr_procedimento b 
		where	a.nr_prescricao	= b.nr_prescricao 
		and ((a.nr_atendimento = nr_atendimento_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
		and	b.nr_seq_proc_cpoe	= nr_sequencia_p;
	end if;
 
 
return	nr_prescricao_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_prescr_item_grid ( nm_tabela_p text, nr_sequencia_p bigint, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_tipo_dieta_p text) FROM PUBLIC;

