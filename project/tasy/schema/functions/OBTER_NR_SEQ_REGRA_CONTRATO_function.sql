-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_nr_seq_regra_contrato ( cd_cnpj_p text, cd_pessoa_fisica_p text, cd_material_p bigint ) RETURNS bigint AS $body$
DECLARE


nr_sequencia_w contrato_regra_nf.nr_sequencia%type;


BEGIN

select max(a.nr_sequencia)
into STRICT   nr_sequencia_w
from   contrato_regra_nf a,
       contrato b
where  a.nr_seq_contrato = b.nr_sequencia
and    a.cd_material = cd_material_p
and    ((cd_cnpj_p IS NOT NULL AND cd_cnpj_p::text <> '' AND b.cd_cgc_contratado = cd_cnpj_p) or
       (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '' AND b.cd_pessoa_contratada = cd_pessoa_fisica_p))
and    b.dt_inicio <= clock_timestamp()
and    coalesce(b.dt_fim,clock_timestamp()) >= clock_timestamp()
and    coalesce(a.dt_inicio_vigencia,clock_timestamp()) <= clock_timestamp()
and    coalesce(a.dt_fim_vigencia,clock_timestamp()) >= clock_timestamp()
and    coalesce(a.cd_estab_regra,wheb_usuario_pck.get_cd_estabelecimento) = wheb_usuario_pck.get_cd_estabelecimento
and    coalesce(b.ie_situacao,'A') = 'A'
and    coalesce(b.ie_finalizado,'N') = 'N'
and    coalesce(b.ie_estagio,'C') <> 'E'
and (coalesce(a.ie_situacao::text, '') = '' or a.ie_situacao = 'A');

return nr_sequencia_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_nr_seq_regra_contrato ( cd_cnpj_p text, cd_pessoa_fisica_p text, cd_material_p bigint ) FROM PUBLIC;

