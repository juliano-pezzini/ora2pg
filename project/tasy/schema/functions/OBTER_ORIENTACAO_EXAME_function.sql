-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_orientacao_exame ( nr_seq_exame_p bigint, cd_material_exame_p text, ie_mostra_obs_tecnica_p text default null, ie_mostra_obs_usuario_p text default null) RETURNS varchar AS $body$
DECLARE

ds_unidade_medida_w        varchar(20);
qt_decimais_w              smallint;
ds_formula_w               varchar(255);
ie_formato_resultado_w     varchar(3);
ds_orientacao_usuario_w    varchar(4000);
ds_pseudo_w    		   varchar(4000);
ds_orientacao_tecnica_w    varchar(4000);
ds_material_w              varchar(4000);
ds_retorno_w               varchar(4000);

C01 CURSOR FOR
SELECT     coalesce(b.ds_unidade_medida, a.ds_unidade_medida),
           coalesce(b.qt_decimais, a.qt_decimais),
           coalesce(b.ds_formula, a.ds_formula),
           coalesce(b.ie_formato_resultado, a.ie_formato_resultado),
           a.ds_orientacao_usuario,
	       coalesce(b.ds_orientacao_tecnica,a.ds_orientacao_tecnica),
	   d.ds_pseudo
FROM material_exame_lab c, exame_laboratorio a
LEFT OUTER JOIN exame_lab_material b ON (a.nr_seq_exame = b.nr_seq_exame)
LEFT OUTER JOIN exame_lab_pseudo d ON (a.nr_seq_exame = d.nr_seq_exame)
WHERE b.nr_seq_material            = c.nr_sequencia  and a.nr_seq_exame               = nr_seq_exame_p order by b.ie_prioridade desc;

C02 CURSOR FOR
   SELECT b.ds_material_exame || '(' ||
            b.cd_material_exame || ') Un.:' ||
            a.ds_unidade_medida
   from    material_exame_lab b,
           exame_lab_material a
   where a.nr_seq_material = b.nr_sequencia
     and a.nr_seq_exame    = nr_seq_exame_p
     and b.cd_material_exame = cd_material_exame_p
   order by a.ie_prioridade;


BEGIN

select	ds_orientacao_usuario,
	ds_orientacao_tecnica
into STRICT	ds_orientacao_usuario_w,
	ds_orientacao_tecnica_w
from	exame_laboratorio
where	nr_seq_exame = nr_seq_exame_p;

open C01;
loop
   fetch C01 into  ds_unidade_medida_w,
                           qt_decimais_w,
                           ds_formula_w,
                           ie_formato_resultado_w,
                           ds_orientacao_usuario_w,
			   ds_orientacao_tecnica_w,
			   ds_pseudo_w;
   EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close c01;

if (ds_orientacao_usuario_w IS NOT NULL AND ds_orientacao_usuario_w::text <> '') and (coalesce(ie_mostra_obs_usuario_p,'S') = 'S') then
	ds_retorno_w := substr(obter_desc_expressao(715516)||': '  || ds_orientacao_usuario_w || chr(10),1,4000);
end if;

if (ds_orientacao_tecnica_w IS NOT NULL AND ds_orientacao_tecnica_w::text <> '') and (coalesce(ie_mostra_obs_tecnica_p,'S') = 'S') then
	ds_retorno_w := substr(ds_retorno_w || obter_desc_expressao(710637)||' ' || ds_orientacao_tecnica_w || chr(10),1,4000);
end if;

if (ds_pseudo_w IS NOT NULL AND ds_pseudo_w::text <> '') then
	ds_retorno_w := substr(ds_retorno_w ||' '||substr(wheb_mensagem_pck.get_texto(805431,'PSEUDONIMO= '||ds_pseudo_w),1,2000) || chr(10),1,4000);
end if;

open C02;
loop
fetch C02 into  ds_material_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
   ds_retorno_w := substr(ds_retorno_w || ds_material_w || chr(10),1,4000);
end loop;
close c02;

if (ds_orientacao_usuario_w IS NOT NULL AND ds_orientacao_usuario_w::text <> '') then
	return ds_retorno_w;
else
	return '';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_orientacao_exame ( nr_seq_exame_p bigint, cd_material_exame_p text, ie_mostra_obs_tecnica_p text default null, ie_mostra_obs_usuario_p text default null) FROM PUBLIC;

