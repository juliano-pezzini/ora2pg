-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_valor_prov_resumo ( nr_seq_conta_p bigint, nr_seq_conta_resumo_p bigint, vl_apresentado_p bigint, vl_calculado_p bigint, vl_liberado_p bigint, vl_taxa_adm_p bigint, vl_taxa_adm_co_p bigint, vl_taxa_adm_mat_p bigint, ie_forma_contab_taxa_pgto_p text, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


nr_seq_item_recalculo_w		pls_item_recalculo.nr_sequencia%type;
qt_registros_w			bigint;
vl_ajuste_w			pls_conta_medica_resumo.vl_apresentado%type;
vl_item_w			pls_conta_medica_resumo.vl_apresentado%type;
vl_glosa_w			pls_conta_medica_resumo.vl_glosa%type;
vl_taxas_w			double precision;


/*
OPCOES
A: Valor de Ajuste
P: Valor de Provisao
L: Liberado
*/
BEGIN

select	coalesce(max(vl_glosa), 0)
into STRICT	vl_glosa_w
from	pls_conta_medica_resumo r
where	r.nr_sequencia = nr_seq_conta_resumo_p
and	r.nr_seq_conta = nr_seq_conta_p;

select	max(r.nr_sequencia)
into STRICT	nr_seq_item_recalculo_w
from	pls_item_recalculo r
where	r.nr_seq_conta_resumo 	= nr_seq_conta_resumo_p
and	r.nr_seq_cta_conta 	= nr_seq_conta_p;

/*Caso o item esteja vinculado a um lote de recalculo*/

if (coalesce(nr_seq_item_recalculo_w,0) > 0) then

	/*Verificar se o lote de recalculo eh de recalculo dos recursos proprios*/

	select	count(*)
	into STRICT	qt_registros_w
	from	pls_regra_lote_recalculo r,
		pls_lote_recalculo l,
		pls_conta_recalculo c,
		pls_item_recalculo i
	where	r.nr_sequencia = l.nr_seq_regra
	and	l.nr_sequencia = c.nr_seq_lote
	and	c.nr_sequencia = i.nr_seq_conta
	and	i.nr_sequencia = nr_seq_item_recalculo_w
	and	r.ie_tipo_regra in ('1', '3');

	/*Caso seja recalculo dos recursos proprios, deve retornar esse valor*/

	if (qt_registros_w > 0) then
		select	coalesce(sum(vl_item),0)
		into STRICT	vl_item_w
		from	pls_item_recalculo i
		where	i.nr_sequencia = nr_seq_item_recalculo_w;
			
		/*Se o item eh de recalculo, nao tem valor de ajuste*/

		vl_ajuste_w := 0;
	else
		/*Caso nao seja recalculo de recurso proprio, deve retornar o valor apresentado ou calculado da conta. Aqui seta zero para que entre na proxima verificacao*/

		nr_seq_item_recalculo_w := 0;
	end if;

end if;

/*Caso nao esteja vinculado a um lote de recalculo, ou o lote de recalculo nao seja recalculo dos recursos proprios*/

if (coalesce(nr_seq_item_recalculo_w,0) = 0) then
	vl_taxas_w := 0;	

	if (coalesce(ie_forma_contab_taxa_pgto_p,'N') <> 'N') then
		vl_taxas_w := coalesce(vl_taxa_adm_p,0) + coalesce(vl_taxa_adm_co_p,0) + coalesce(vl_taxa_adm_mat_p,0);
	end if;

	/* Retorna o valor calculado caso: Nao tenha valor apresentado, tenha valor calculado e (tenha valor liberado ou tenha valor de glosa)
	Caso exista valor apresentado, retorna esse valor*/
	if 	((coalesce(vl_apresentado_p,0) = 0) and (coalesce(vl_calculado_p,0) != 0)) then
		if ((coalesce(vl_liberado_p,0) = 0) and (coalesce(vl_glosa_w, 0) = 0)) then
			vl_item_w := 0;
		else
			vl_item_w := vl_calculado_p;
		end if;
	elsif (coalesce(vl_apresentado_p,0) != 0) then
		vl_item_w := vl_apresentado_p;
	end if;
	
	if (ie_opcao_p = 'L') then
		vl_item_w := vl_liberado_p;
	end if;
	
	/*Se o item nao eh de recalculo, tem valor de ajuste (Valor Liberado - Valor da Provisao)*/

	vl_ajuste_w := (vl_liberado_p + vl_taxas_w) - coalesce(vl_item_w,0);
end if;

if (ie_opcao_p = 'A') then
	return	vl_ajuste_w;
elsif (ie_opcao_p = 'P') then
	return	vl_item_w;
elsif (ie_opcao_p = 'L') then
	return	vl_item_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_valor_prov_resumo ( nr_seq_conta_p bigint, nr_seq_conta_resumo_p bigint, vl_apresentado_p bigint, vl_calculado_p bigint, vl_liberado_p bigint, vl_taxa_adm_p bigint, vl_taxa_adm_co_p bigint, vl_taxa_adm_mat_p bigint, ie_forma_contab_taxa_pgto_p text, ie_opcao_p text) FROM PUBLIC;

