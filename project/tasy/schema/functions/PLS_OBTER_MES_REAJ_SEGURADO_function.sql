-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_mes_reaj_segurado ( nr_seq_segurado_p bigint, ie_formato_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(15)	:= null;
dt_retorno_w			timestamp 		:= null;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
nr_seq_intercambio_w		pls_intercambio.nr_sequencia%type;
dt_reajuste_benef_w		pls_segurado.dt_reajuste%type;
ie_reajuste_w			pls_contrato.ie_reajuste%type;
dt_reajuste_contrato_w		pls_contrato.dt_reajuste%type;


BEGIN

select	nr_seq_contrato,
	nr_seq_intercambio,
	coalesce(dt_reajuste,dt_contratacao) dt_reajuste
into STRICT	nr_seq_contrato_w,
	nr_seq_intercambio_w,
	dt_reajuste_benef_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;

if (coalesce(nr_seq_contrato_w,0) <> 0) then
	select	ie_reajuste,
		coalesce(dt_reajuste,add_months(dt_contrato,coalesce(qt_intervalo,12))) dt_reajuste_contrato_w
	into STRICT	ie_reajuste_w,
		dt_reajuste_contrato_w
	from	pls_contrato
	where	nr_sequencia	= nr_seq_contrato_w;

	if (ie_reajuste_w = 'A') then
		dt_retorno_w	:= dt_reajuste_benef_w;
	else
		select	max(c.dt_reajuste)
		into STRICT	dt_retorno_w
		from	pls_contrato		a,
			pls_contrato_grupo	b,
			pls_grupo_contrato	c
		where	a.nr_sequencia 		= b.nr_seq_contrato
		and	b.nr_seq_grupo		= c.nr_sequencia
		and	b.ie_reajuste_grupo	= 'S'
		and	a.nr_sequencia 		= nr_seq_contrato_w;

		if (coalesce(dt_retorno_w::text, '') = '') then
			dt_retorno_w	:= dt_reajuste_contrato_w;
		end if;
	end if;
elsif (coalesce(nr_seq_intercambio_w,0) <> 0) then
	select	max(b.dt_reajuste)
	into STRICT	dt_retorno_w
	from	pls_regra_grupo_inter	b,
		pls_intercambio		a
	where	a.nr_seq_grupo_intercambio	= b.nr_sequencia
	and	a.nr_sequencia 			= nr_seq_intercambio_w;

	if (coalesce(dt_retorno_w::text, '') = '') then
		select	max(dt_inclusao)
		into STRICT	dt_retorno_w
		from	pls_intercambio
		where	nr_sequencia = nr_seq_intercambio_w;
	end if;
end if;

if (dt_retorno_w IS NOT NULL AND dt_retorno_w::text <> '') then
	ds_retorno_w := to_char(dt_retorno_w,ie_formato_p);
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_mes_reaj_segurado ( nr_seq_segurado_p bigint, ie_formato_p text) FROM PUBLIC;

