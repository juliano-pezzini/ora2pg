-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hmsj_obter_valor_brasindice ( cd_material_p bigint, ie_tipo_preco_p text ) RETURNS bigint AS $body$
DECLARE


vl_preco_medicamento_w	double precision;
cd_laboratorio_w	varchar(6);
cd_medicamento_w	varchar(6);
cd_apresentacao_w	varchar(6);
qt_conversao_w		double precision;

C01 CURSOR FOR
	SELECT	a.cd_medicamento,
		a.cd_laboratorio,
		a.cd_apresentacao,
		coalesce(qt_conversao,0)
	from	material_brasindice a,
		material b
	where 	a.cd_material = b.cd_material
	and 	a.cd_material = cd_material_p
	order by dt_final_vigencia;


BEGIN

open C01;
loop
fetch C01 into
	cd_medicamento_w,
	cd_laboratorio_w,
	cd_apresentacao_w,
	qt_conversao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	cd_medicamento_w	:= cd_medicamento_w;
	cd_laboratorio_w	:= cd_laboratorio_w;
	cd_apresentacao_w	:= cd_apresentacao_w;
	qt_conversao_w		:= qt_conversao_w;
	end;
end loop;
close C01;

begin
select	max(coalesce(a.vl_preco_medicamento * (1 + coalesce(a.pr_ipi,0)/100),0))
into STRICT	vl_preco_medicamento_w
from	brasindice_preco a
where	a.cd_laboratorio = cd_laboratorio_w
and 	a.cd_medicamento = cd_medicamento_w
and 	a.cd_apresentacao = cd_apresentacao_w
and	a.ie_tipo_preco = ie_tipo_preco_p
and 	a.dt_inicio_vigencia = (SELECT	max(b.dt_inicio_vigencia)
				from	brasindice_preco b
				where	b.cd_laboratorio = a.cd_laboratorio
				and	b.cd_medicamento = a.cd_medicamento
				and 	b.cd_apresentacao = a.cd_apresentacao);
exception
	when others then
		vl_preco_medicamento_w := 0;
end;

vl_preco_medicamento_w := dividir(vl_preco_medicamento_w, qt_conversao_w);

return	vl_preco_medicamento_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hmsj_obter_valor_brasindice ( cd_material_p bigint, ie_tipo_preco_p text ) FROM PUBLIC;

