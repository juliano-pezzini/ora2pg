-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tiss_obter_se_partic (nr_seq_procedimento_p bigint) RETURNS bigint AS $body$
DECLARE


nr_retorno_w		numeric(20);
cont_partic_w		bigint;
cd_medico_executor_w	bigint;
cd_convenio_parametro_w	bigint;
cd_estabelecimento_w	conta_paciente.cd_estabelecimento%type;
cd_setor_atendimento_w	procedimento_paciente.cd_setor_atendimento%type;
nr_seq_atepacu_w	procedimento_paciente.nr_seq_atepacu%type;
ie_origem_proced_w	procedimento_paciente.ie_origem_proced%type;
cd_procedimento_w	procedimento_paciente.cd_procedimento%type;
dt_procedimento_w	procedimento_paciente.dt_procedimento%type;
qt_w			bigint;
nr_interno_conta_w	conta_paciente.nr_interno_conta%type;
qt_reg_w		bigint;


BEGIN

select	max(a.cd_medico_executor),
	max(b.cd_convenio_parametro),
	max(b.cd_estabelecimento),
	max(a.dt_procedimento),
	max(a.cd_setor_atendimento),
	max(a.cd_procedimento),
	max(a.ie_origem_proced),
	max(a.nr_seq_atepacu),
	max(a.nr_interno_conta)
into STRICT	cd_medico_executor_w,
	cd_convenio_parametro_w,
	cd_estabelecimento_w,
	dt_procedimento_w,
	cd_setor_atendimento_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	nr_seq_atepacu_w,
	nr_interno_conta_w
from	conta_paciente b,
	procedimento_paciente a
where	a.nr_interno_conta	= b.nr_interno_conta
and	a.nr_sequencia		= nr_seq_procedimento_p;

select	sum(qt_procedimento) --buscando se o item eh anulado por algum outro procedimento negativo
into STRICT	qt_w
from	procedimento_paciente
where	nr_interno_conta 	= nr_interno_conta_w
and	dt_procedimento 	= dt_procedimento_w
and	cd_setor_atendimento 	= cd_setor_atendimento_w
and	cd_procedimento 	= cd_procedimento_w
and	ie_origem_proced 	= ie_origem_proced_w
and 	nr_seq_atepacu 		= nr_seq_atepacu_w;

if (coalesce(qt_w,0) = 0)  then
	return 0;
end if;

select	count(*)
into STRICT	qt_reg_w
from	procedimento_paciente
where	nr_interno_conta 	= nr_interno_conta_w
and	dt_procedimento 	= dt_procedimento_w
and	cd_setor_atendimento 	= cd_setor_atendimento_w
and	cd_procedimento 	= cd_procedimento_w
and	ie_origem_proced 	= ie_origem_proced_w
and 	nr_seq_atepacu 		= nr_seq_atepacu_w
and	cd_motivo_exc_conta	is  	null
and	cd_medico_executor	is 	not null
and	qt_procedimento < 0
and	vl_procedimento < 0;


if coalesce(qt_reg_w, 0) > 0 then

	-- item possui ajuste p/ negativo

	-- buscar sequencia do item que nao esta negativado

	-- para permitir group by no c01 da tiss_gerar_conta_proc
	
	select	max(nr_sequencia)
	into STRICT 	nr_retorno_w
	from	procedimento_paciente
	where	nr_interno_conta 	= nr_interno_conta_w
	and	dt_procedimento 	= dt_procedimento_w
	and	cd_setor_atendimento 	= cd_setor_atendimento_w
	and	cd_procedimento 	= cd_procedimento_w
	and	ie_origem_proced 	= ie_origem_proced_w
	and 	nr_seq_atepacu 		= nr_seq_atepacu_w
	and	cd_motivo_exc_conta	is 	null
	and	cd_medico_executor	is 	not null
	and	qt_procedimento		> 0
	and	vl_procedimento		> 0;
	
	return	nr_retorno_w;
end if;

if (cd_medico_executor_w IS NOT NULL AND cd_medico_executor_w::text <> '') then
	nr_retorno_w	:= nr_seq_procedimento_p;
else
	select	count(*)
	into STRICT	cont_partic_w
	from	procedimento_participante
	where	nr_sequencia	= nr_seq_procedimento_p
	and	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '');

	if (coalesce(cont_partic_w,0) > 0) then
		nr_retorno_w	:= nr_seq_procedimento_p;
	else
		select	count(*)
		into STRICT	cont_partic_w
		from	tiss_regra_prest_equipe
		where	cd_convenio	= cd_convenio_parametro_w
		and	cd_estabelecimento	= cd_estabelecimento_w;

		if (coalesce(cont_partic_w,0) > 0) then
			nr_retorno_w	:= nr_seq_procedimento_p;
		else
			nr_retorno_w	:= 0;
		end if;
	end if;
end if;

return nr_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tiss_obter_se_partic (nr_seq_procedimento_p bigint) FROM PUBLIC;

