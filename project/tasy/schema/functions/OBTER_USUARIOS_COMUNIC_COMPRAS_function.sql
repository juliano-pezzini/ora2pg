-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_usuarios_comunic_compras ( nr_documento_p bigint, nr_seq_processo_p bigint, cd_evento_p bigint, nr_seq_regra_evento_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


nr_documento_w				bigint;
cd_estabelecimento_w			smallint;
ie_aviso_aprov_oc_w			varchar(1);
nr_solic_compra_w				bigint;
nr_seq_evento_w				bigint;
nm_usuarios_w				varchar(255) := '';
ie_usuario_w				varchar(03);
nm_usuario_solicitante_w			varchar(255);
nm_usuario_solicitante_ww			varchar(255);
nm_usuario_solicitante_sc_w			varchar(15);
nm_usuario_del_solicitante_w			varchar(15);
nm_usuario_requisitante_w			varchar(15);
nm_usuario_item_solic_w			varchar(15);
nm_usuario_resp_matricial_w			varchar(15);
nm_usuario_item_ordem_w			varchar(15);
nm_usuario_comprador_w			varchar(15);
nm_usuarios_cad_compr_w			varchar(15);
nm_usuario_del_comprador_w		varchar(15);
nm_usuario_solic_padrao_w			varchar(15);
nm_usuario_del_solic_padrao_w		varchar(15);
nm_usuario_comprador_padrao_w		varchar(15);
nm_usuario_resp_compras_w			varchar(15);
nm_usuario_aprovacao_w			varchar(15);
nm_usuario_compr_resp_w			varchar(15);
nm_usuario_del_compra_resp_w		varchar(15);
nm_usuario_solic_ordem_w			varchar(15);
nm_usuario_aprovador_w			varchar(15);
nm_usuario_resp_fiscal_w			varchar(15);
nm_usuario_lib_w				varchar(15);
nm_usuarios_adic_w			varchar(255);
nm_usuario_resp_w				varchar(15);
nm_usuario_nrec_w				varchar(15);
ie_tipo_registro_w				varchar(1);
cd_solicitante_w				varchar(10);
nm_usuario_envio_w			varchar(15);
nr_seq_proj_gpi_w				bigint;
nm_usuario_gpi_w				varchar(60);

c01 CURSOR FOR
SELECT	distinct ie_usuario,
	nm_usuario_envio
from	regra_envio_comunic_usu
where	nr_seq_evento = nr_seq_regra_evento_p;

c02 CURSOR FOR
SELECT	distinct nm_usuario
from	Processo_aprov_Compra
where	nr_sequencia		= nr_documento_p
and	nr_seq_proc_aprov	= nr_seq_processo_p;

c03 CURSOR FOR
SELECT	substr(obter_usuario_pf(cd_pessoa_fisica),1,15)
from	comprador
where	ie_situacao = 'A';

c04 CURSOR FOR
SELECT	distinct
	substr(obter_usuario_pf(cd_pessoa_fisica),1,15)
from (
	SELECT	a.cd_pessoa_fisica
	from	processo_aprov_compra a,
		pessoa_fisica b
	where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	a.nr_sequencia in (select	distinct
			nr_seq_aprovacao
		from	ordem_compra_item
		where	nr_ordem_compra = nr_documento_p)
	
union

	select	c.cd_pessoa_fisica
	from	processo_aprov_compra a,
     		cargo b,
		pessoa_fisica c
	where	a.cd_cargo = b.cd_cargo
	and	c.cd_cargo = b.cd_cargo
	and	a.nr_sequencia in (select	distinct
			nr_seq_aprovacao
       		from	ordem_compra_item
       		where	nr_ordem_compra = nr_documento_p)) alias4
where	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '');

c05 CURSOR FOR
SELECT	distinct
	substr(obter_usuario_pf(cd_pessoa_fisica),1,15)
from (
	SELECT	a.cd_pessoa_fisica
	from	processo_aprov_compra a,
		pessoa_fisica b
	where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	a.ie_aprov_reprov = 'P'
	and	a.nr_sequencia in (select	distinct
			nr_seq_aprovacao
		from	solic_compra_item
		where	nr_solic_compra = nr_documento_p)
	
union

	select	c.cd_pessoa_fisica
	from	processo_aprov_compra a,
     		cargo b,
		pessoa_fisica c
	where	a.cd_cargo = b.cd_cargo
	and	c.cd_cargo = b.cd_cargo
	and	a.ie_aprov_reprov = 'P'
	and	a.nr_sequencia in (select	distinct
			nr_seq_aprovacao
       		 from	solic_compra_item
       		 where	nr_solic_compra = nr_documento_p)) alias4
where	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '');

c06 CURSOR FOR
SELECT	distinct
	substr(obter_usuario_pf(cd_pessoa_fisica),1,15)
from (
	SELECT	a.cd_pessoa_fisica
	from	processo_aprov_compra a,
		pessoa_fisica b
	where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	a.nr_sequencia in (select	distinct
			nr_seq_aprovacao
		from	item_requisicao_material
		where	nr_requisicao = nr_documento_p)
	
union

	select	c.cd_pessoa_fisica
	from	processo_aprov_compra a,
     		cargo b,
		pessoa_fisica c
	where	a.cd_cargo = b.cd_cargo
	and	c.cd_cargo = b.cd_cargo
	and	a.nr_sequencia in (select	distinct
			nr_seq_aprovacao
		from	item_requisicao_material
		where	nr_requisicao = nr_documento_p)) alias4
where	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '');

c07 CURSOR FOR
SELECT	distinct
	nm_usuario
from	pessoas_processo_aprovacao_v
where	nr_sequencia in (
		SELECT	distinct
			nr_seq_aprovacao
		from	cot_compra_item
		where	nr_cot_compra = nr_documento_p);

c08 CURSOR FOR
SELECT	substr(obter_usuario_pf(cd_pessoa_fisica),1,60)
from	gpi_proj_equipe_membro a,
	gpi_proj_equipe b
where	a.nr_seq_equipe = b.nr_sequencia
and	b.nr_seq_proj_gpi = nr_seq_proj_gpi_w

union all

select	substr(obter_usuario_pf(cd_patrocinador),1,60)
from	gpi_projeto a
where	a.nr_sequencia = nr_seq_proj_gpi_w
and	(cd_patrocinador IS NOT NULL AND cd_patrocinador::text <> '')

union all

select	substr(obter_usuario_pf(cd_gestor_funcional),1,60)
from	gpi_projeto a
where	a.nr_sequencia = nr_seq_proj_gpi_w
and	(cd_gestor_funcional IS NOT NULL AND cd_gestor_funcional::text <> '')

union all

select	substr(obter_usuario_pf(cd_pf_gestor),1,60)
from	gpi_projeto a
where	a.nr_sequencia = nr_seq_proj_gpi_w
and	(cd_pf_gestor IS NOT NULL AND cd_pf_gestor::text <> '');

c09 CURSOR FOR
SELECT  substr(obter_usuario_pf(d.cd_pessoa_fisica),1,60)
from    nota_fiscal a,
        nota_fiscal_item b,
        material c,
        material_resp_matricial d
where	a.nr_sequencia  = b.nr_sequencia
and     b.cd_material   = c.cd_material
and     c.cd_material   = d.cd_material
and	a.nr_sequencia  = nr_documento_p
and	substr(obter_usuario_pf(d.cd_pessoa_fisica),1,60) is not null;

c10 CURSOR FOR
SELECT	substr(obter_usuario_pf(d.cd_pessoa_solicitante),1,15) nm_usuario
from 	Solic_Compra d,
		Solic_compra_item c,
		Ordem_compra_item b,
		inspecao_recebimento a
where	a.nr_seq_registro = nr_documento_p
and		a.nr_ordem_compra = b.nr_ordem_compra
and		a.nr_item_oci = b.nr_item_oci
and		b.nr_cot_compra = c.nr_cot_compra
and		b.nr_item_cot_compra = c.nr_item_cot_compra
and		c.nr_solic_compra = d.nr_solic_compra
and		(obter_usuario_pf(d.cd_pessoa_solicitante) IS NOT NULL AND (obter_usuario_pf(d.cd_pessoa_solicitante))::text <> '')
group by substr(obter_usuario_pf(d.cd_pessoa_solicitante),1,15);


BEGIN

if (cd_evento_p in (1,2)) then

	select	coalesce(max(nr_solic_compra),0)
	into STRICT	nr_documento_w
	from	solic_compra_item
	where	nr_seq_aprovacao = nr_documento_p;

	if (nr_documento_w = 0) then
		select	coalesce(max(nr_solic_compra),0)
		into STRICT	nr_documento_w
		from	ordem_compra_item
		where	nr_seq_aprovacao = nr_documento_p;
	end if;

	if (nr_documento_w > 0) then

		select	cd_estabelecimento,
			substr(obter_usuario_pf(cd_pessoa_solicitante),1,15),
			substr(obter_usuario_pf(obter_pessoa_delegacao(cd_pessoa_solicitante,'RC',clock_timestamp())),1,15),
			substr(obter_usuario_pf(cd_comprador_resp),1,15),
			substr(obter_usuario_pf(obter_pessoa_delegacao(cd_comprador_resp,'RC',clock_timestamp())),1,15),
			nm_usuario_lib,
			nr_seq_proj_gpi
		into STRICT	cd_estabelecimento_w,
			nm_usuario_solicitante_w,
			nm_usuario_del_solicitante_w,
			nm_usuario_compr_resp_w,
			nm_usuario_del_comprador_w,
			nm_usuario_lib_w,
			nr_seq_proj_gpi_w
		from	solic_compra
		where	nr_solic_compra = nr_documento_w;

		select	max(nm_usuario)
		into STRICT	nm_usuario_item_solic_w
		from	solic_compra_item
		where	nr_solic_compra = nr_documento_w;
	end if;

	select	coalesce(max(nr_ordem_compra),0)
	into STRICT	nr_documento_w
	from	ordem_compra_item
	where	nr_seq_aprovacao = nr_documento_p;

	if (nr_documento_w > 0) then

		select	cd_estabelecimento,
			substr(obter_usuario_pf(cd_pessoa_solicitante),1,15),
			substr(obter_usuario_pf(obter_pessoa_delegacao(cd_pessoa_solicitante,'RC',clock_timestamp())),1,15),
			substr(obter_usuario_pf(cd_comprador),1,15),
			substr(obter_usuario_pf(obter_pessoa_delegacao(cd_comprador,'RC',clock_timestamp())),1,15)
		into STRICT	cd_estabelecimento_w,
			nm_usuario_solic_ordem_w,
			nm_usuario_del_solicitante_w,
			nm_usuario_comprador_w,
			nm_usuario_del_comprador_w
		from	ordem_compra
		where	nr_ordem_compra = nr_documento_w;

		select	max(nm_usuario),
			coalesce(max(nr_solic_compra),0)
		into STRICT	nm_usuario_item_ordem_w,
			nr_solic_compra_w
		from	ordem_compra_item
		where	nr_ordem_compra = nr_documento_w;

		if (nr_solic_compra_w > 0) then
			select	coalesce(ie_aviso_aprov_oc,'N'),
				nm_usuario_lib
			into STRICT	ie_aviso_aprov_oc_w,
				nm_usuario_lib_w
			from	solic_compra
			where	nr_solic_compra = nr_solic_compra_w;

			if (ie_aviso_aprov_oc_w = 'S') then
				select	substr(obter_usuario_pf(cd_pessoa_solicitante),1,15),
					substr(obter_usuario_pf(obter_pessoa_delegacao(cd_pessoa_solicitante,'RC',clock_timestamp())),1,15),
					substr(obter_usuario_pf(cd_comprador_resp),1,15),
					substr(obter_usuario_pf(obter_pessoa_delegacao(cd_comprador_resp,'RC',clock_timestamp())),1,15)
				into STRICT	nm_usuario_solicitante_w,
					nm_usuario_del_solicitante_w,
					nm_usuario_compr_resp_w,
					nm_usuario_del_comprador_w
				from	solic_compra
				where	nr_solic_compra = nr_solic_compra_w;
			end if;
		end if;
	end if;

	select	coalesce(max(nr_requisicao),0)
	into STRICT	nr_documento_w
	from	item_requisicao_material
	where	nr_seq_aprovacao = nr_documento_p;

	if (nr_documento_w > 0) then
		select	cd_estabelecimento,
			substr(obter_usuario_pf(cd_pessoa_solicitante),1,15) nm_usuario_solicitante,
			substr(obter_usuario_pf(cd_pessoa_requisitante),1,15) nm_usuario_requisitante
		into STRICT	cd_estabelecimento_w,
			nm_usuario_solicitante_w,
			nm_usuario_requisitante_w
		from	requisicao_material
		where	nr_requisicao = nr_documento_w;
	end if;

	select	substr(obter_usuario_pf(cd_pessoa_solic_padrao),1,15),
		substr(obter_usuario_pf(obter_pessoa_delegacao(cd_pessoa_solic_padrao,'RC',clock_timestamp())),1,15),
		substr(obter_usuario_pf(cd_comprador_padrao),1,15),
		substr(obter_usuario_pf(cd_responsavel_compras),1,15),
		substr(obter_usuario_pf(cd_responsavel_fiscal),1,15)
	into STRICT	nm_usuario_solic_padrao_w,
		nm_usuario_del_solic_padrao_w,
		nm_usuario_comprador_padrao_w,
		nm_usuario_resp_compras_w,
		nm_usuario_resp_fiscal_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_w;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;
	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_usuario_w in ('SSC','ARS')) and (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		elsif (ie_usuario_w = 'UDS') and (nm_usuario_del_solicitante_w IS NOT NULL AND nm_usuario_del_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_del_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_del_solicitante_w || ',',1,255);
		elsif (ie_usuario_w = 'CRS') and (nm_usuario_compr_resp_w IS NOT NULL AND nm_usuario_compr_resp_w::text <> '') and (obter_se_contido_char(nm_usuario_compr_resp_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_compr_resp_w || ',',1,255);
		elsif (ie_usuario_w = 'UCO') and (nm_usuario_comprador_w IS NOT NULL AND nm_usuario_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_comprador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_comprador_w || ',',1,255);
		elsif (ie_usuario_w = 'UDC') and (nm_usuario_del_comprador_w IS NOT NULL AND nm_usuario_del_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_del_comprador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_del_comprador_w || ',',1,255);
		elsif (ie_usuario_w = 'SPC') and (nm_usuario_solic_padrao_w IS NOT NULL AND nm_usuario_solic_padrao_w::text <> '') and (obter_se_contido_char(nm_usuario_solic_padrao_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solic_padrao_w || ',',1,255);
		elsif (ie_usuario_w = 'UDS') and (nm_usuario_del_solic_padrao_w IS NOT NULL AND nm_usuario_del_solic_padrao_w::text <> '') and (obter_se_contido_char(nm_usuario_del_solic_padrao_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_del_solic_padrao_w || ',',1,255);
		elsif (ie_usuario_w = 'CPC') and (nm_usuario_comprador_padrao_w IS NOT NULL AND nm_usuario_comprador_padrao_w::text <> '') and (obter_se_contido_char(nm_usuario_comprador_padrao_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_comprador_padrao_w || ',',1,255);
		elsif (ie_usuario_w = 'RSC') and (nm_usuario_resp_compras_w IS NOT NULL AND nm_usuario_resp_compras_w::text <> '') and (obter_se_contido_char(nm_usuario_resp_compras_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_resp_compras_w || ',',1,255);
		elsif (ie_usuario_w = 'UOI') and (nm_usuario_item_ordem_w IS NOT NULL AND nm_usuario_item_ordem_w::text <> '') and (obter_se_contido_char(nm_usuario_item_ordem_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_item_ordem_w || ',',1,255);
		elsif (ie_usuario_w = 'USI') and (nm_usuario_item_solic_w IS NOT NULL AND nm_usuario_item_solic_w::text <> '') and (obter_se_contido_char(nm_usuario_item_solic_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_item_solic_w || ',',1,255);
		elsif (ie_usuario_w = 'SOC') and (nm_usuario_solic_ordem_w IS NOT NULL AND nm_usuario_solic_ordem_w::text <> '') and (obter_se_contido_char(nm_usuario_solic_ordem_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solic_ordem_w || ',',1,255);
		elsif (ie_usuario_w = 'ULS') and (nm_usuario_lib_w IS NOT NULL AND nm_usuario_lib_w::text <> '') and (obter_se_contido_char(nm_usuario_lib_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_lib_w || ',',1,255);
		elsif (ie_usuario_w = 'URF') and (nm_usuario_resp_fiscal_w IS NOT NULL AND nm_usuario_resp_fiscal_w::text <> '') and (obter_se_contido_char(nm_usuario_resp_fiscal_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_resp_fiscal_w || ',',1,255);
		elsif (ie_usuario_w = 'ARR') and (nm_usuario_requisitante_w IS NOT NULL AND nm_usuario_requisitante_w::text <> '') and (obter_se_contido_char(nm_usuario_requisitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_requisitante_w || ',',1,255);
		elsif (ie_usuario_w = 'UPC') and (cd_evento_p = 2) then

			open C02;
			loop
			fetch C02 into
				nm_usuario_aprovacao_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				if (obter_se_contido_char(nm_usuario_aprovacao_w,nm_usuarios_w) = 'N') then
					nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_aprovacao_w || ',',1,255);
				end if;
				end;
			end loop;
			close C02;
		elsif (ie_usuario_w = 'GPI') and (cd_evento_p in (1,2,16)) and (nr_seq_proj_gpi_w > 0) then

			open c08;
			loop
			fetch c08 into
				nm_usuario_gpi_w;
			EXIT WHEN NOT FOUND; /* apply on c08 */
				begin
				if (obter_se_contido_char(nm_usuario_gpi_w,nm_usuarios_w) = 'N') then
					nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_gpi_w || ',',1,255);
				end if;
				end;
			end loop;
			close c08;

		end if;
		end;
	end loop;
	close C01;
elsif (cd_evento_p in (6,7)) then
	select	max(nr_sequencia),
		obter_tipo_docto_compras_proc(nr_documento_p,'0')
	into STRICT	nr_seq_evento_w,
		ie_tipo_registro_w
	from	regra_envio_comunic_evento
	where	cd_evento = cd_evento_p;

	select	max(nr_documento)
	into STRICT	nr_documento_w
	from	processo_aprov_compra_pend_v
	where	nr_sequencia = nr_documento_p;

	if (ie_tipo_registro_w = 'S') then
		select	cd_pessoa_solicitante
		into STRICT	cd_solicitante_w
		from	solic_compra
		where	nr_solic_compra = nr_documento_w;
	elsif (ie_tipo_registro_w = 'C') then
		select	cd_pessoa_solicitante
		into STRICT	cd_solicitante_w
		from	cot_compra
		where	nr_cot_compra = nr_documento_w;
	elsif (ie_tipo_registro_w = 'O') then
		select	cd_pessoa_solicitante
		into STRICT	cd_solicitante_w
		from	ordem_compra
		where	nr_ordem_compra = nr_documento_w;
	elsif (ie_tipo_registro_w = 'R') then
		select	coalesce(cd_pessoa_solicitante,0)
		into STRICT	cd_solicitante_w
		from	requisicao_material
		where	nr_requisicao = nr_documento_w;
	end if;

	select	max(nm_usuario)
	into STRICT	nm_usuario_solicitante_w
	from	usuario
	where	cd_pessoa_fisica = cd_solicitante_w;

	open c01;
	loop
	fetch c01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (ie_usuario_w = 'SPR') then
			if (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
				nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
			end if;

		elsif (cd_evento_p = 6) and (ie_usuario_w = 'URP') and (obter_se_contido_char(nm_usuario_p,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_p || ',',1,255);

		elsif (cd_evento_p = 7) and (ie_usuario_w = 'USP') and (obter_se_contido_char(nm_usuario_p,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_p || ',',1,255);

		end if;
		end;
	end loop;
	close c01;

elsif (cd_evento_p = 27) then
	select	max(substr(obter_usuario_pf(cd_responsavel_fiscal),1,15))
	into STRICT	nm_usuario_resp_fiscal_w
	from	parametro_compras;

	nr_seq_evento_w := nr_seq_regra_evento_p;
	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	if (ie_usuario_w = 'URF') and (nm_usuario_resp_fiscal_w IS NOT NULL AND nm_usuario_resp_fiscal_w::text <> '') and (obter_se_contido_char(nm_usuario_resp_fiscal_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_resp_fiscal_w || ',',1,255);
	end if;
	end loop;
	close C01;

elsif (cd_evento_p in (3,4,8,9,10,15,28,47,52,57,72)) then

	select	cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	from	solic_compra
	where	nr_solic_compra = nr_documento_p;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	select	substr(obter_usuario_pf(cd_responsavel_compras),1,15)
	into STRICT	nm_usuario_resp_compras_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_w;

	select	substr(obter_usuario_pf(cd_pessoa_solicitante),1,15),
		substr(obter_usuario_pf(obter_pessoa_delegacao(cd_pessoa_solicitante, 'RC', clock_timestamp())),1,15),
		substr(obter_usuario_pf(cd_comprador_resp),1,15),
		substr(obter_usuario_pf(obter_pessoa_delegacao(cd_comprador_resp,'RC',clock_timestamp())),1,15)
	into STRICT	nm_usuario_solicitante_w,
	        nm_usuario_del_solicitante_w,
		nm_usuario_compr_resp_w,
		nm_usuario_del_comprador_w
	from	solic_compra
	where	nr_solic_compra = nr_documento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (ie_usuario_w = 'SSC') and (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		elsif (ie_usuario_w = 'UDS') and (nm_usuario_del_solicitante_w IS NOT NULL AND nm_usuario_del_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_del_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_del_solicitante_w || ',',1,255);
		elsif (ie_usuario_w = 'CRS') and (nm_usuario_compr_resp_w IS NOT NULL AND nm_usuario_compr_resp_w::text <> '') and (obter_se_contido_char(nm_usuario_compr_resp_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_compr_resp_w || ',',1,255);
		elsif (ie_usuario_w = 'UDC') and (nm_usuario_del_comprador_w IS NOT NULL AND nm_usuario_del_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_del_comprador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_del_comprador_w || ',',1,255);
		elsif (ie_usuario_w = 'RSC') and (nm_usuario_resp_compras_w IS NOT NULL AND nm_usuario_resp_compras_w::text <> '') and (obter_se_contido_char(nm_usuario_resp_compras_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_resp_compras_w || ',',1,255);
		elsif (ie_usuario_w = 'COM') then
			open C03;
			loop
			fetch C03 into
				nm_usuarios_cad_compr_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				if (nm_usuarios_cad_compr_w IS NOT NULL AND nm_usuarios_cad_compr_w::text <> '') and (obter_se_contido_char(nm_usuarios_cad_compr_w,nm_usuarios_w) = 'N') then
					nm_usuarios_w := substr(nm_usuarios_w || nm_usuarios_cad_compr_w || ',',1,255);
				end if;
				end;
			end loop;
			close C03;
		elsif (ie_usuario_w = 'ASC') then
			open C05;
			loop
			fetch C05 into
				nm_usuario_aprovador_w;
			EXIT WHEN NOT FOUND; /* apply on C05 */
				begin
				if (nm_usuario_aprovador_w IS NOT NULL AND nm_usuario_aprovador_w::text <> '') and (obter_se_contido_char(nm_usuario_aprovador_w,nm_usuarios_w) = 'N') then
					nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_aprovador_w || ',',1,255);
				end if;
				end;
			end loop;
			close C05;
		end if;
		end;
	end loop;
	close C01;
elsif (cd_evento_p = 5) then

	select	cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	from	nota_fiscal
	where	nr_sequencia = nr_documento_p;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	select	max(substr(obter_usuario_pf(d.cd_pessoa_solicitante),1,15)),
		max(substr(obter_usuario_pf(obter_pessoa_delegacao(d.cd_pessoa_solicitante,'RC',clock_timestamp())),1,15)),
		max(substr(obter_usuario_pf(cd_comprador_resp),1,15)),
		max(substr(obter_usuario_pf(obter_pessoa_delegacao(cd_comprador_resp,'RC',clock_timestamp())),1,15))
	into STRICT	nm_usuario_solicitante_w,
		nm_usuario_del_solicitante_w,
		nm_usuario_compr_resp_w,
		nm_usuario_del_comprador_w
	from 	Nota_Fiscal e,
		Solic_Compra d,
		Solic_compra_item c,
		Ordem_compra_item b,
		nota_fiscal_item a
	where	a.nr_sequencia		= nr_documento_p
	and	a.nr_ordem_compra 	= b.nr_ordem_compra
	and	a.nr_item_oci		= b.nr_item_oci
	and	b.nr_cot_compra 		= c.nr_cot_compra
	and	b.nr_item_cot_compra 	= c.nr_item_cot_compra
	and	c.nr_solic_compra		= d.nr_solic_compra
	and	a.nr_sequencia		= e.nr_sequencia
	and	(obter_usuario_pf(d.cd_pessoa_solicitante) IS NOT NULL AND (obter_usuario_pf(d.cd_pessoa_solicitante))::text <> '');

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_usuario_w = 'SSC') and (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		elsif (ie_usuario_w = 'UDS') and (nm_usuario_del_solicitante_w IS NOT NULL AND nm_usuario_del_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_del_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_del_solicitante_w || ',',1,255);
		elsif (ie_usuario_w = 'CRS') and (nm_usuario_compr_resp_w IS NOT NULL AND nm_usuario_compr_resp_w::text <> '') and (obter_se_contido_char(nm_usuario_compr_resp_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_compr_resp_w || ',',1,255);
		elsif (ie_usuario_w = 'UDC') and (nm_usuario_del_comprador_w IS NOT NULL AND nm_usuario_del_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_del_comprador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_del_comprador_w || ',',1,255);
		end if;

		if (ie_usuario_w = 'RMM') and (nm_usuario_del_comprador_w IS NOT NULL AND nm_usuario_del_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_del_comprador_w,nm_usuarios_w) = 'N') then
			begin
			open C09;
			loop
			fetch C09 into
				nm_usuario_resp_matricial_w;
			EXIT WHEN NOT FOUND; /* apply on C09 */
			begin
				nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_resp_matricial_w || ',',1,255);
			end;
			end loop;
			close C09;
			end;
		end if;

		if (nm_usuario_envio_w IS NOT NULL AND nm_usuario_envio_w::text <> '') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_envio_w || ',',1,255);
		end if;

		end;
	end loop;
	close C01;

elsif (cd_evento_p in (11,12)) then

	select	coalesce(max(nr_ordem_compra),0)
	into STRICT	nr_documento_w
	from	ordem_compra_item
	where	nr_seq_aprovacao = nr_documento_p;

	select	cd_estabelecimento,
		substr(obter_usuario_pf(cd_comprador),1,15)
	into STRICT	cd_estabelecimento_w,
		nm_usuario_comprador_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_w;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (ie_usuario_w = 'UCO') and (nm_usuario_comprador_w IS NOT NULL AND nm_usuario_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_comprador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_comprador_w || ',',1,255);
		elsif (ie_usuario_w = 'COM') then
			open C03;
			loop
			fetch C03 into
				nm_usuarios_cad_compr_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				if (nm_usuarios_cad_compr_w IS NOT NULL AND nm_usuarios_cad_compr_w::text <> '') and (obter_se_contido_char(nm_usuarios_cad_compr_w,nm_usuarios_w) = 'N') then
					nm_usuarios_w := substr(nm_usuarios_w || nm_usuarios_cad_compr_w || ',',1,255);
				end if;
				end;
			end loop;
			close C03;

		elsif (ie_usuario_w = 'AOC') then
			open C04;
			loop
			fetch C04 into
				nm_usuario_aprovador_w;
			EXIT WHEN NOT FOUND; /* apply on C04 */
				begin
				if (nm_usuario_aprovador_w IS NOT NULL AND nm_usuario_aprovador_w::text <> '') and (obter_se_contido_char(nm_usuario_aprovador_w,nm_usuarios_w) = 'N') then
					nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_aprovador_w || ',',1,255);
				end if;
				end;
			end loop;
			close C04;
		end if;
		end;
	end loop;
	close C01;
elsif (cd_evento_p in (13)) then

	select	cd_estabelecimento,
		substr(obter_usuario_pf(cd_pessoa_solicitante),1,15) usuario_solicitante
	into STRICT	cd_estabelecimento_w,
		nm_usuario_solicitante_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;

	select	max(b.nm_usuarios_adic)
	into STRICT	nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = 13
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_usuario_w = 'SOC') and (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		end if;
		end;
	end loop;
	close C01;

	open C04;
	loop
	fetch C04 into
		nm_usuario_aprovador_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		if (nm_usuario_aprovador_w IS NOT NULL AND nm_usuario_aprovador_w::text <> '') and (obter_se_contido_char(nm_usuario_aprovador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_aprovador_w || ',',1,255);
		end if;
		end;
	end loop;
	close C04;
elsif (cd_evento_p in (51)) then

	nr_seq_evento_w := nr_seq_regra_evento_p;

	select	cd_estabelecimento,
		substr(obter_usuario_pf(cd_pessoa_solicitante),1,15) usuario_solicitante
	into STRICT	cd_estabelecimento_w,
		nm_usuario_solicitante_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;

	select	max(b.nm_usuarios_adic)
	into STRICT	nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = 51
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_usuario_w = 'SOC') and (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		end if;
		end;
	end loop;
	close C01;
elsif (cd_evento_p in (53)) then

	nr_seq_evento_w := nr_seq_regra_evento_p;

	select	coalesce(max(nr_solic_compra),0)
	into STRICT	nr_solic_compra_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_documento_p;

	select	cd_estabelecimento,
		substr(obter_usuario_pf(cd_pessoa_solicitante),1,15) usuario_solicitante
	into STRICT	cd_estabelecimento_w,
		nm_usuario_solicitante_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;

	if (nr_solic_compra_w > 0) then
		select	substr(obter_usuario_pf(cd_pessoa_solicitante),1,15) usuario_solicitante
		into STRICT	nm_usuario_solicitante_sc_w
		from	solic_compra
		where	nr_solic_compra = nr_solic_compra_w;
	end if;

	select	max(b.nm_usuarios_adic)
	into STRICT	nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = 53
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_usuario_w = 'SSC') and (nm_usuario_solicitante_sc_w IS NOT NULL AND nm_usuario_solicitante_sc_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_sc_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_sc_w || ',',1,255);
		end if;
		end;
	end loop;
	close C01;
elsif (cd_evento_p in (49,58)) then

	select	cd_estabelecimento,
		substr(obter_usuario_pf(cd_pessoa_solicitante),1,15) usuario_solicitante
	into STRICT	cd_estabelecimento_w,
		nm_usuario_solicitante_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;

	select	max(b.nm_usuarios_adic)
	into STRICT	nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	nr_seq_evento_w := nr_seq_regra_evento_p;
	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_usuario_w = 'SOC') and (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		end if;
		end;
	end loop;
	close C01;
elsif (cd_evento_p in (21,37,81)) then

	select	cd_estabelecimento,
		substr(obter_usuario_pf(cd_pessoa_solicitante),1,15),
		substr(obter_usuario_pf(cd_comprador),1,15)
	into STRICT	cd_estabelecimento_w,
		nm_usuario_solicitante_w,
		nm_usuario_comprador_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;


	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_usuario_w = 'SOC') and (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		elsif (ie_usuario_w = 'UCO') and (nm_usuario_comprador_w IS NOT NULL AND nm_usuario_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_comprador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_comprador_w || ',',1,255);
		end if;
		end;
	end loop;
	close C01;

elsif (cd_evento_p in (14)) and (nr_documento_p > 0) then
	begin
	select	cd_estabelecimento,
		substr(obter_usuario_pf(cd_pessoa_solicitante),1,15),
		substr(obter_usuario_pf(obter_pessoa_delegacao(cd_pessoa_solicitante,'RC',clock_timestamp())),1,15),
		substr(obter_usuario_pf(cd_comprador_resp),1,15),
		substr(obter_usuario_pf(obter_pessoa_delegacao(cd_comprador_resp,'RC',clock_timestamp())),1,15)
	into STRICT	cd_estabelecimento_w,
		nm_usuario_solicitante_w,
		nm_usuario_del_solicitante_w,
		nm_usuario_compr_resp_w,
		nm_usuario_del_comprador_w
	from	solic_compra
	where	nr_solic_compra = nr_documento_p;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (ie_usuario_w = 'SSC') and (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		elsif (ie_usuario_w = 'UDS') and (nm_usuario_del_solicitante_w IS NOT NULL AND nm_usuario_del_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_del_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_del_solicitante_w || ',',1,255);
		elsif (ie_usuario_w = 'CRS') and (nm_usuario_compr_resp_w IS NOT NULL AND nm_usuario_compr_resp_w::text <> '') and (obter_se_contido_char(nm_usuario_compr_resp_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_compr_resp_w || ',',1,255);
		elsif (ie_usuario_w = 'UDC') and (nm_usuario_del_comprador_w IS NOT NULL AND nm_usuario_del_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_del_comprador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_del_comprador_w || ',',1,255);
		end if;

		end;
	end loop;
	close C01;
	end;
elsif (cd_evento_p in (17,20)) then

	select	cd_estabelecimento,
		substr(obter_usuario_pf(cd_comprador),1,15)
	into STRICT	cd_estabelecimento_w,
		nm_usuario_comprador_w
	from	cot_compra
	where	nr_cot_compra = nr_documento_p;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (ie_usuario_w = 'CCC') and (nm_usuario_comprador_w IS NOT NULL AND nm_usuario_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_comprador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_comprador_w || ',',1,255);
		end if;
		end;
	end loop;
	close C01;
elsif (cd_evento_p in (76)) then

	select	cd_estabelecimento,
		substr(obter_usuario_pf(cd_comprador),1,15),
		substr(obter_usuario_pf(cd_pessoa_solicitante),1,15)
	into STRICT	cd_estabelecimento_w,
		nm_usuario_comprador_w,
		nm_usuario_solicitante_w
	from	cot_compra
	where	nr_cot_compra = nr_documento_p;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (ie_usuario_w = 'CCC') and (nm_usuario_comprador_w IS NOT NULL AND nm_usuario_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_comprador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_comprador_w || ',',1,255);
		elsif (ie_usuario_w = 'SCC') and (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		end if;
		end;
	end loop;
	close C01;

elsif (cd_evento_p in (18,19)) then

	select	cd_estabelecimento,
		obter_usuario_pf(cd_pessoa_resp),
		nm_usuario_nrec
	into STRICT	cd_estabelecimento_w,
		nm_usuario_resp_w,
		nm_usuario_nrec_w
	from	avf_resultado
	where	nr_sequencia = nr_documento_p;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (ie_usuario_w = 'RAF') and (nm_usuario_resp_w IS NOT NULL AND nm_usuario_resp_w::text <> '') and (obter_se_contido_char(nm_usuario_resp_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_resp_w || ',',1,255);
		elsif (ie_usuario_w = 'UCA') and (nm_usuario_nrec_w IS NOT NULL AND nm_usuario_nrec_w::text <> '') and (obter_se_contido_char(nm_usuario_nrec_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_nrec_w || ',',1,255);
		end if;

		end;
	end loop;
	close C01;

elsif (cd_evento_p = 22) and (nr_documento_p <> 0)then

	select	cd_estabelecimento,
		substr(obter_usuario_pf(cd_comprador),1,15)
	into STRICT	cd_estabelecimento_w,
		nm_usuario_comprador_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (ie_usuario_w = 'AOC') then
			open C04;
			loop
			fetch C04 into
				nm_usuario_aprovador_w;
			EXIT WHEN NOT FOUND; /* apply on C04 */
				begin
				if (nm_usuario_aprovador_w IS NOT NULL AND nm_usuario_aprovador_w::text <> '') and (obter_se_contido_char(nm_usuario_aprovador_w,nm_usuarios_w) = 'N') then
					nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_aprovador_w || ',',1,255);
				end if;
				end;
			end loop;
			close C04;
		end if;

		select	substr(obter_usuario_pf(cd_pessoa_solicitante),1,15)
		into STRICT	nm_usuario_solic_ordem_w
		from	ordem_compra
		where	nr_ordem_compra = nr_documento_p;

		if (ie_usuario_w = 'SOC') and (nm_usuario_solic_ordem_w IS NOT NULL AND nm_usuario_solic_ordem_w::text <> '') and (obter_se_contido_char(nm_usuario_solic_ordem_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solic_ordem_w || ',',1,255);
		end if;
		end;
	end loop;
	close C01;
elsif (cd_evento_p in (30,31,32,33,34,35,82)) and (nr_documento_p <> 0) then
	begin
	select	cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	select	substr(obter_usuario_pf(cd_pessoa_solicitante),1,15),
		substr(obter_usuario_pf(cd_comprador),1,15)
	into STRICT	nm_usuario_solic_ordem_w,
		nm_usuario_comprador_w
	from	ordem_compra
	where	nr_ordem_compra = nr_documento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_usuario_w = 'SOC') and (nm_usuario_solic_ordem_w IS NOT NULL AND nm_usuario_solic_ordem_w::text <> '') and (obter_se_contido_char(nm_usuario_solic_ordem_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solic_ordem_w || ',',1,255);
		elsif (ie_usuario_w = 'UCO') and (nm_usuario_comprador_w IS NOT NULL AND nm_usuario_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_comprador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_comprador_w || ',',1,255);
		end if;
		if (ie_usuario_w = 'RMM') and (nm_usuario_del_comprador_w IS NOT NULL AND nm_usuario_del_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_del_comprador_w,nm_usuarios_w) = 'N') then
			open C09;
			loop
			fetch C09 into
			nm_usuario_resp_matricial_w;
			EXIT WHEN NOT FOUND; /* apply on C09 */
			begin
				nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_resp_matricial_w || ',',1,255);
			end;
			end loop;
			close C09;
		end if;
		end;
	end loop;
	close C01;
	end;

elsif (cd_evento_p in (24,70)) and (nr_documento_p <> 0) then
	begin

	select	cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	from	requisicao_material
	where	nr_requisicao = nr_documento_p;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (coalesce(ie_usuario_w::text, '') = '') and (nm_usuario_envio_w IS NOT NULL AND nm_usuario_envio_w::text <> '') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_envio_w || ',',1,255);
		end if;

		if (ie_usuario_w = 'ARE') then
			begin
			open C06;
			loop
			fetch C06 into
				nm_usuario_aprovador_w;
			EXIT WHEN NOT FOUND; /* apply on C06 */
				begin

				if (nm_usuario_aprovador_w IS NOT NULL AND nm_usuario_aprovador_w::text <> '') and (obter_se_contido_char(nm_usuario_aprovador_w,nm_usuarios_w) = 'N') then
					nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_aprovador_w || ',',1,255);
				end if;
				end;
			end loop;
			close C06;
			end;
		end if;
		end;
	end loop;
	close C01;
	end;

elsif (cd_evento_p in (63,71)) then
	begin

	select	coalesce(max(nr_cot_compra),0)
	into STRICT	nr_documento_w
	from	cot_compra_item
	where	nr_seq_aprovacao = nr_documento_p;

	if (cd_evento_p = 71) then
		select	cd_estabelecimento,
			substr(obter_usuario_pf(cd_comprador),1,15),
			cd_pessoa_solicitante
		into STRICT	cd_estabelecimento_w,
			nm_usuario_comprador_w,
			cd_solicitante_w
		from	cot_compra
		where	nr_cot_compra = nr_documento_w;
	end if;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_usuario_w = 'CAC') then
			begin
			open C07;
			loop
			fetch C07 into
				nm_usuario_aprovador_w;
			EXIT WHEN NOT FOUND; /* apply on C07 */
				begin
				if (nm_usuario_aprovador_w IS NOT NULL AND nm_usuario_aprovador_w::text <> '') and (obter_se_contido_char(nm_usuario_aprovador_w,nm_usuarios_w) = 'N') then
					nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_aprovador_w || ',',1,255);
				end if;
				end;
			end loop;
			close C07;
			end;
		end if;

		if (ie_usuario_w = 'SPR') and (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		end if;

		if (ie_usuario_w = 'CCC') and (nm_usuario_comprador_w IS NOT NULL AND nm_usuario_comprador_w::text <> '') and (obter_se_contido_char(nm_usuario_comprador_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_comprador_w || ',',1,255);
		end if;

		end;
	end loop;
	close C01;

	end;
elsif (cd_evento_p =  65) and (coalesce(nr_documento_p,0) > 0) then
	begin

	select	cd_estabelecimento,
		substr(obter_usuario_pf(cd_pessoa_solicitante),1,15) nm_usuario_solicitante,
		substr(obter_usuario_pf(cd_pessoa_requisitante),1,15) nm_usuario_requisitante
	into STRICT	cd_estabelecimento_w,
		nm_usuario_solicitante_w,
		nm_usuario_requisitante_w
	from	requisicao_material
	where	nr_requisicao = nr_documento_p;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_usuario_w = 'ARS') and -- Solicitante da requisição
			(nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		end if;

		if (ie_usuario_w = 'ARR') and -- Requisitante da requisição
			(nm_usuario_requisitante_w IS NOT NULL AND nm_usuario_requisitante_w::text <> '') and (obter_se_contido_char(nm_usuario_requisitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_requisitante_w || ',',1,255);
		end if;
		end;
	end loop;
	close C01;

	end;
elsif (cd_evento_p =  73) and (coalesce(nr_documento_p,0) > 0) then
	begin

	select	a.cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	from	inspecao_registro a
	where	a.nr_sequencia = nr_documento_p;

	open C10;
	loop
	fetch C10 into
		nm_usuario_solicitante_ww;
	EXIT WHEN NOT FOUND; /* apply on C10 */
		begin
		if (nm_usuario_solicitante_ww IS NOT NULL AND nm_usuario_solicitante_ww::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_ww,nm_usuario_solicitante_w) = 'N') then
			if (coalesce(nm_usuario_solicitante_w::text, '') = '') then
				nm_usuario_solicitante_w := substr(nm_usuario_solicitante_ww,1,255);
			else
				nm_usuario_solicitante_w := substr(nm_usuario_solicitante_w || ',' || nm_usuario_solicitante_ww,1,255);
			end if;
		end if;
		end;
	end loop;
	close C10;

	select	coalesce(max(b.nr_sequencia),0),
		max(b.nm_usuarios_adic)
	into STRICT	nr_seq_evento_w,
		nm_usuarios_adic_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = cd_evento_p
	and	a.cd_estabelecimento = cd_estabelecimento_w
	and	b.nr_sequencia = nr_seq_regra_evento_p;

	open C01;
	loop
	fetch C01 into
		ie_usuario_w,
		nm_usuario_envio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_usuario_w = 'SSC') and (nm_usuario_solicitante_w IS NOT NULL AND nm_usuario_solicitante_w::text <> '') and (obter_se_contido_char(nm_usuario_solicitante_w,nm_usuarios_w) = 'N') then
			nm_usuarios_w := substr(nm_usuarios_w || nm_usuario_solicitante_w || ',',1,255);
		end if;
		end;
	end loop;
	close C01;

	end;
end if;

nm_usuarios_w := substr(nm_usuarios_w || nm_usuarios_adic_w,1,255);

return	nm_usuarios_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_usuarios_comunic_compras ( nr_documento_p bigint, nr_seq_processo_p bigint, cd_evento_p bigint, nr_seq_regra_evento_p bigint, nm_usuario_p text) FROM PUBLIC;

