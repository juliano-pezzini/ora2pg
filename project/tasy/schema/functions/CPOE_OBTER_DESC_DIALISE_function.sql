-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_desc_dialise ( ie_tipo_dialise_p text, nr_seq_protocolo_p protocolo_npt.nr_sequencia%type, dt_lib_suspensao_p timestamp default null, dt_suspensao_p timestamp default null, qt_fluxo_sangue_p bigint default null, qt_hora_min_sessao_p text default null, ie_html_p text default 'S', ie_hemodialise_p text default '', ie_tipo_peritoneal_p text default '', qt_volume_ciclo_p bigint default null, qt_hora_min_duracao_p text default null, ie_categoria_p text default null, dt_atualizacao_peso_p timestamp default null, ie_baixado_por_alta_p cpoe_dialise.ie_baixado_por_alta%type default null, dt_alta_medico_p cpoe_dialise.dt_alta_medico%type default null, ie_adep_p text default 'N', nr_seq_cpoe_p bigint default null, ds_horarios_p text default null, dt_fim_grid_p timestamp default null, ie_revalidacao_p text default 'N') RETURNS varchar AS $body$
DECLARE


ds_retorno_w				varchar(2000);
ie_altera_label_campo_w		varchar(1);
nr_prescricao_w				prescr_solucao.nr_prescricao%type;
nr_seq_solucao_w			prescr_solucao.nr_seq_solucao%type;
ie_tipo_solucao_w			prescr_solucao.ie_tipo_solucao%type;
qt_solucao_total_w			prescr_solucao.qt_solucao_total%type;
ds_tempo_adm_grid_w			varchar(100);
ds_retorno_tag_w varchar(1000);
ds_class_tag_w   varchar(5);
ie_needs_ackn_interface_w 	varchar(2);
ie_confirm_ackn_interface_w	varchar(2);
rule_quantity_w		integer;
cd_mat_soluc1_w				cpoe_dialise.cd_mat_soluc1%type;
cd_mat_soluc2_w				cpoe_dialise.cd_mat_soluc2%type;
cd_mat_soluc3_w				cpoe_dialise.cd_mat_soluc3%type;
cd_mat_soluc4_w				cpoe_dialise.cd_mat_soluc4%type;
cd_mat_soluc5_w				cpoe_dialise.cd_mat_soluc5%type;
ie_dbcheck_mat_soluc1_w		varchar(1) := 'N';
ie_dbcheck_mat_soluc2_w		varchar(1) := 'N';
ie_dbcheck_mat_soluc3_w		varchar(1) := 'N';
ie_dbcheck_mat_soluc4_w		varchar(1) := 'N';
ie_dbcheck_mat_soluc5_w		varchar(1) := 'N';

	function bold( ds_valor_p text) return text is
		;
BEGIN
		return '<strong>' ||ds_valor_p||'</strong>';
		end;
		
	function desc_peritoneal return varchar2 is
		begin
			if (ie_tipo_peritoneal_p = 'CAPD') then
				return ' ' || obter_desc_expressao(689353, null) || ' ';
			elsif (ie_tipo_peritoneal_p = 'DPA') then
				return ' ' || obter_desc_expressao(689355, null) || ' ';
			elsif (ie_tipo_peritoneal_p = 'DPI') then
				return ' ' || obter_desc_expressao(292175, null) || ' ';			
			end if;
			return null;
		end;
			
	function cpoe_add_span_adic_info(ds_informacao_p	varchar2, ds_style_adic_p varchar2) return  varchar2 is
				ds_span_w	varchar2(2000);
		begin
			if ((trim(both ds_informacao_p) IS NOT NULL AND (trim(both ds_informacao_p))::text <> '')) then
			begin
				ds_span_w	:= '<span class=''material-adic-info '|| ds_style_adic_p ||'''> '||ds_informacao_p||'</span>';
				end;
			end if;
			return ds_span_w;

		end;
	
	function obter_se_item_futuro(nr_seq_cpoe_p cpoe_dialise.nr_sequencia%type, ie_revalidacao_p varchar2)  return varchar2 is
		begin
			if (coalesce(ie_revalidacao_p,'N') = 'S') then
				select max(CPOE_obter_prox_adm_grid_ang(nr_sequencia,'D', nm_usuario, nr_atendimento, ie_administracao, null, coalesce(dt_prox_geracao, clock_timestamp()), dt_inicio,
					dt_fim, 'hd_prescricao','nr_seq_dialise_cpoe','prescr_mat_hor','nr_seq_dialise',null, dt_fim_grid_p, obter_funcao_ativa, ie_revalidacao_p)) ds_tempo_adm_grid
				into STRICT ds_tempo_adm_grid_w
				from cpoe_dialise			 
				where nr_sequencia = nr_seq_cpoe_p 
				and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 		 
				and coalesce(dt_lib_suspensao::text, '') = '';
				
				if (ds_tempo_adm_grid_w IS NOT NULL AND ds_tempo_adm_grid_w::text <> '') then
					return cpoe_add_span_adic_info(ds_tempo_adm_grid_w, 'cpoe_color_yellow cpoe_text_legend');
				end if;
			end if;
			return null;
		end;	
	
	function get_order_interface(	ie_tipo_item_p in varchar2,
									nr_sequencia_p in number) return varchar2 is
	
	begin
		ie_needs_ackn_interface_w := cpoe_integracao_count(ie_tipo_item_p, nr_sequencia_p, 'BTN');
		ie_confirm_ackn_interface_w := cpoe_integracao_count(ie_tipo_item_p, nr_sequencia_p, 'TAG');
		
		if (ie_adep_p = 'N') then
			ds_class_tag_w := 'adep';
		else
			ds_class_tag_w := 'gpt';
		end if;
		
		ds_retorno_tag_w := '</div><div class="legend-cell-status-text-' || ds_class_tag_w ||'" style="cursor: default; flex-wrap: wrap;">
                <div class="legend-cell-content-tag-' || ds_class_tag_w ||'" style="cursor: default;">';

                        
		
		if (ie_adep_p = 'S') then
			ds_retorno_tag_w := ds_retorno_tag_w || '<div class="legend-cell-tag-adep" style="background-color: #FFE9AB; cursor: default; margin-top: 4px;"</div>';			
		else
			ds_retorno_tag_w := ds_retorno_tag_w || '<div class="legend-cell-tag-gpt" style="background-color: #FFE9AB; cursor: default; margin-top: 4px;" </div>';
		end if;
		
		if (ie_needs_ackn_interface_w = 'S') then
			ds_retorno_tag_w :=  ds_retorno_tag_w || obter_desc_expressao_idioma(1000214, null, wheb_usuario_pck.get_nr_seq_idioma)
			|| ' </div>
              </div>
          </div><div style="display:none">;';
		elsif (ie_confirm_ackn_interface_w = 'S') then
			ds_retorno_tag_w :=  ds_retorno_tag_w || obter_desc_expressao_idioma(1012943, null, wheb_usuario_pck.get_nr_seq_idioma)
			|| ' </div>
              </div>
          </div><div style="display:none">;';
    else
      ds_retorno_tag_w := null;
		end if;

		return ds_retorno_tag_w;
	end;
	
	function verifyDoubleCheckItem(	ie_double_check_w in varchar2) return varchar2 is

	begin

		ds_class_tag_w := 'adep';

		ds_retorno_tag_w := '</div><div class="legend-cell-status-text-' || ds_class_tag_w ||'" style="cursor: default; flex-wrap: wrap;">
                <div class="legend-cell-content-tag-' || ds_class_tag_w ||'" style="cursor: default;">';

		ds_retorno_tag_w := ds_retorno_tag_w || '<div class="legend-cell-tag-adep" style="background-color: #97B326; cursor: default; margin-top: 4px;"</div>';
		
		if (ie_double_check_w = 'S') then
			ds_retorno_tag_w :=  ds_retorno_tag_w || obter_desc_expressao_idioma(729215, null, wheb_usuario_pck.get_nr_seq_idioma)
			|| ' </div>
              </div>';
		else
			ds_retorno_tag_w := null;
		end if;

		return ds_retorno_tag_w;
	end;
		
begin

ie_altera_label_campo_w := Obter_Param_Usuario(924, 1171, obter_perfil_ativo, Obter_Usuario_Ativo, obter_estabelecimento_ativo, ie_altera_label_campo_w);

if (ie_tipo_dialise_p = 'DI') then
	-- Hemodialise

	--ds_retorno_w	:= obter_desc_expressao(291247, null);
	if (ie_hemodialise_p = 'S') then
		ds_retorno_w	:= obter_desc_expressao(489925, '') ||' ';
	else
		ds_retorno_w	:= obter_desc_expressao(489926, '') ||' ';
	end if;
elsif (ie_tipo_dialise_p = 'DP') then
	-- Dialise peritoneal
	ds_retorno_w	:= initcap(obter_desc_expressao(314156, null) || desc_peritoneal());
end if;

if (ie_html_p  = 'S') then	
	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		ds_retorno_w	:= substr(bold(ds_retorno_w),1,500);
	end if;	

	if ((nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and coalesce(ie_adep_p, 'N') = 'S') then
		select	b.nr_prescricao,
				b.nr_seq_solucao
		into STRICT	nr_prescricao_w,
				nr_seq_solucao_w
		from	hd_prescricao a,
				prescr_solucao b
		where	a.nr_prescricao = b.nr_prescricao
		and		a.nr_sequencia = b.nr_seq_dialise
		and		a.nr_seq_dialise_cpoe = nr_seq_cpoe_p  LIMIT 1;
		
		if (coalesce(nr_prescricao_w,0) > 0 and coalesce(nr_seq_solucao_w,0) > 0) then
			select	a.ie_tipo_solucao,
					a.qt_solucao_total
			into STRICT	ie_tipo_solucao_w,
					qt_solucao_total_w
			from 	prescr_solucao a
			where	a.nr_prescricao = nr_prescricao_w
			and		a.nr_seq_solucao = nr_seq_solucao_w  LIMIT 1;

			if (qt_solucao_total_w IS NOT NULL AND qt_solucao_total_w::text <> '') then
				ds_retorno_w := substr(ds_retorno_w||cpoe_add_span(obter_desc_expressao(302288, null)||': '||qt_solucao_total_w), 1, 500);
			end if;
			
			select	cd_mat_soluc1,
					cd_mat_soluc2,
					cd_mat_soluc3,
					cd_mat_soluc4,
					cd_mat_soluc5
			into STRICT	cd_mat_soluc1_w,
					cd_mat_soluc2_w,
					cd_mat_soluc3_w,
					cd_mat_soluc4_w,
					cd_mat_soluc5_w
			from	cpoe_dialise
			where	nr_sequencia = nr_seq_cpoe_p;

			if (cd_mat_soluc1_w IS NOT NULL AND cd_mat_soluc1_w::text <> '') then
				ie_dbcheck_mat_soluc1_w := coalesce(obter_se_medic_dupla_chec(cd_mat_soluc1_w, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w),'N');
			end if;

			if (cd_mat_soluc2_w IS NOT NULL AND cd_mat_soluc2_w::text <> '') then
				ie_dbcheck_mat_soluc2_w := coalesce(obter_se_medic_dupla_chec(cd_mat_soluc2_w, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w),'N');
			end if;

			if (cd_mat_soluc3_w IS NOT NULL AND cd_mat_soluc3_w::text <> '') then
				ie_dbcheck_mat_soluc3_w := coalesce(obter_se_medic_dupla_chec(cd_mat_soluc3_w, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w),'N');
			end if;

			if (cd_mat_soluc4_w IS NOT NULL AND cd_mat_soluc4_w::text <> '') then
				ie_dbcheck_mat_soluc4_w := coalesce(obter_se_medic_dupla_chec(cd_mat_soluc4_w, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w),'N');
			end if;

			if (cd_mat_soluc5_w IS NOT NULL AND cd_mat_soluc5_w::text <> '') then
				ie_dbcheck_mat_soluc5_w := coalesce(obter_se_medic_dupla_chec(cd_mat_soluc5_w, wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_w),'N');
			end if;
			
		end if;
	end if;

	if (ie_tipo_dialise_p = 'DI') then
		if (coalesce(qt_fluxo_sangue_p,0) > 0) then
			-- Fluxo de sangue
			if (ie_categoria_p = 'C') and (coalesce(ie_altera_label_campo_w,'N') = 'S') then
				ds_retorno_w := substr(ds_retorno_w || cpoe_add_span('  ' || obter_desc_expressao(713194, null) || ': ' || qt_fluxo_sangue_p),1,500);
			else
				ds_retorno_w := substr(ds_retorno_w || '  ' || obter_desc_expressao(290190, null) || ': ' || qt_fluxo_sangue_p,1,500);
			end if;
		end if;

		if (coalesce(qt_hora_min_sessao_p,'00:00') <> '00:00') then
			-- Duracao (h/min)
			ds_retorno_w := substr(ds_retorno_w || cpoe_add_span('  ' || obter_desc_expressao(289010, null) || ': ' || qt_hora_min_sessao_p),1,500);
		end if;
		
		if (ds_horarios_p IS NOT NULL AND ds_horarios_p::text <> '') then
			ds_retorno_w := ds_retorno_w || CPOE_ADD_SPAN(ds_horarios_p);
		end if;
		
		if (dt_atualizacao_peso_p IS NOT NULL AND dt_atualizacao_peso_p::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || cpoe_add_span('  ' || obter_desc_expressao(714815,null) || ' ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_atualizacao_peso_p, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)),1,500);
		end if;
		
	elsif (ie_tipo_dialise_p = 'DP') then
		if (qt_volume_ciclo_p IS NOT NULL AND qt_volume_ciclo_p::text <> '') then
			-- Volume ciclo (ml)
			ds_retorno_w := substr(ds_retorno_w || cpoe_add_span('  ' || obter_desc_expressao(302247, null) || ': ' || qt_volume_ciclo_p),1,500);
		end if;
		
		if (coalesce(qt_hora_min_duracao_p,'00:00') <> '00:00') then
			-- Peso atual atualizado em:
			if (coalesce(ie_adep_p, 'N') = 'N') then
				ds_retorno_w := substr(ds_retorno_w || cpoe_add_span_mat_comp('  ' || obter_desc_expressao(284893, null) || ': ' || qt_hora_min_duracao_p),1,500);
			else
				ds_retorno_w := substr(ds_retorno_w || adep_add_span_mat_comp('  ' || obter_desc_expressao(284893, null) || ': ' || qt_hora_min_duracao_p),1,500);
			end if;
		end if;
	end if;

	if ((ie_baixado_por_alta_p = 'S') and (coalesce(dt_alta_medico_p, clock_timestamp()) <= clock_timestamp()) and (coalesce(dt_suspensao_p::text, '') = '')) then
		ds_retorno_w := ds_retorno_w || cpoe_add_span(bold(obter_desc_expressao(941910)));
	end if;

	if	((dt_lib_suspensao_p IS NOT NULL AND dt_lib_suspensao_p::text <> '') and (dt_suspensao_p IS NOT NULL AND dt_suspensao_p::text <> '')         and (dt_suspensao_p <= clock_timestamp())          and (ie_adep_p <> 'S'))	    	     or
	  	((coalesce(dt_lib_suspensao_p::text, '') = '')        and (dt_fim_grid_p <= clock_timestamp())   	     and 
		ie_adep_p = 'N') 
		then
		ds_retorno_w	:= '<del> ' || ds_retorno_w || '</del>';
	end if;
else
	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		ds_retorno_w	:= substr(ds_retorno_w,1,500);
	end if;	

	if (ie_tipo_dialise_p = 'DI') then
		if (coalesce(qt_fluxo_sangue_p,0) > 0) then
			-- Fluxo de sangue
			if (ie_categoria_p = 'C') and (coalesce(ie_altera_label_campo_w,'N') = 'S') then
				ds_retorno_w := substr(ds_retorno_w || cpoe_add_span('  ' || obter_desc_expressao(713194, null) || ': ' || qt_fluxo_sangue_p),1,500);
			else
				ds_retorno_w := substr(ds_retorno_w || '  ' || obter_desc_expressao(290190, null) || ': ' || qt_fluxo_sangue_p,1,500);
			end if;
		end if;

		if (coalesce(qt_hora_min_sessao_p,'00:00') <> '00:00') then
			-- Duracao (h/min)
			ds_retorno_w := substr(ds_retorno_w || '  ' || obter_desc_expressao(289010, null) || ': ' || qt_hora_min_sessao_p,1,500);
		end if;
		
		if (ds_horarios_p IS NOT NULL AND ds_horarios_p::text <> '') then
			ds_retorno_w := ds_retorno_w || CPOE_ADD_SPAN(ds_horarios_p);
		end if;
		
	elsif (ie_tipo_dialise_p = 'DP') then
		if (qt_volume_ciclo_p IS NOT NULL AND qt_volume_ciclo_p::text <> '') then
			-- Volume ciclo (ml)
			ds_retorno_w := substr(ds_retorno_w || '  ' || obter_desc_expressao(302247, null) || ': ' || qt_volume_ciclo_p,1,500);
		end if;
		
		if (coalesce(qt_hora_min_duracao_p,'00:00') <> '00:00') then
			-- Ciclo (h/min)
			ds_retorno_w := substr(ds_retorno_w || '  ' || obter_desc_expressao(284893, null) || ': ' || qt_hora_min_duracao_p,1,500);
		end if;
	end if;
end if;

ds_retorno_w := ds_retorno_w || obter_se_item_futuro(nr_seq_cpoe_p, ie_revalidacao_p);

if (ie_adep_p = 'S' and (ie_dbcheck_mat_soluc1_w = 'S' or ie_dbcheck_mat_soluc2_w = 'S' or ie_dbcheck_mat_soluc3_w = 'S' or ie_dbcheck_mat_soluc4_w = 'S' or
	ie_dbcheck_mat_soluc5_w = 'S')) then
	ds_retorno_w := ds_retorno_w || verifyDoubleCheckItem('S');
end if;

select	count(*)
into STRICT	rule_quantity_w
from	cpoe_regra_ator LIMIT 1;
		
if (rule_quantity_w > 0 and (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '')) then
	ds_retorno_w := substr( ds_retorno_w || get_order_interface('DI',nr_seq_cpoe_p), 1, 600);
end if;

return	ds_retorno_w;

-- REMOVER ESTAS DUAS ULTIMAS FUNCTIONS

-- cpoe_obter_desc_dialise_perit(ie_tipo_peritoneal, NR_SEQ_PROTOCOLO, dt_lib_suspensao, dt_suspensao, ie_administracao)

-- cpoe_obter_desc_hemodialise(NR_SEQ_PROTOCOLO, dt_lib_suspensao, dt_suspensao)
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_desc_dialise ( ie_tipo_dialise_p text, nr_seq_protocolo_p protocolo_npt.nr_sequencia%type, dt_lib_suspensao_p timestamp default null, dt_suspensao_p timestamp default null, qt_fluxo_sangue_p bigint default null, qt_hora_min_sessao_p text default null, ie_html_p text default 'S', ie_hemodialise_p text default '', ie_tipo_peritoneal_p text default '', qt_volume_ciclo_p bigint default null, qt_hora_min_duracao_p text default null, ie_categoria_p text default null, dt_atualizacao_peso_p timestamp default null, ie_baixado_por_alta_p cpoe_dialise.ie_baixado_por_alta%type default null, dt_alta_medico_p cpoe_dialise.dt_alta_medico%type default null, ie_adep_p text default 'N', nr_seq_cpoe_p bigint default null, ds_horarios_p text default null, dt_fim_grid_p timestamp default null, ie_revalidacao_p text default 'N') FROM PUBLIC;

