-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gpt_se_item_doc_reval ( nm_tabela_p text default null, nr_seq_cpoe_p bigint DEFAULT NULL, ie_gpt_item_p text default null, ie_opcao_p integer DEFAULT NULL) RETURNS varchar AS $body$
DECLARE


/*
ie_opcao_p:
1 - Retorna tipo do item se pendente
2 - Retorna se esta pendente (S)
*/
ds_retorno_w			varchar(5) := 'XPTO';
ie_tipo_item_w			varchar(5);
ie_existe_w				varchar(1);
ie_desc_horas_ant_w		parametro_medico.ie_desc_horas_ant%type;
qt_hors_copia_w			integer;


BEGIN

if ((nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '') or (ie_gpt_item_p IS NOT NULL AND ie_gpt_item_p::text <> '')) and (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and (ie_opcao_p IS NOT NULL AND ie_opcao_p::text <> '') then

		qt_hors_copia_w := get_qt_hours_after_copy_cpoe(cd_perfil_p => wheb_usuario_pck.get_cd_perfil,
														nm_usuario_p => wheb_usuario_pck.get_nm_usuario,
														cd_estabelecimento_p => wheb_usuario_pck.get_cd_estabelecimento);

	select	coalesce(max(ie_desc_horas_ant),'N')
	into STRICT	ie_desc_horas_ant_w
	from	parametro_medico
	where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

	select	coalesce(max(ie_existe), 'N') ie_existe,
			coalesce(max(ie_tipo_item), 'XPTO') ie_tipo_item
	into STRICT	ie_existe_w,
			ie_tipo_item_w
	from	(
				SELECT	'S' ie_existe,
						max(a.ie_tipo_item) ie_tipo_item
				from	gpt_doc_reval_events_v_atual	a
				where	a.nr_seq_cpoe = nr_seq_cpoe_p
				and		(((nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '') and a.nm_tabela = nm_tabela_p)
						or ((ie_gpt_item_p IS NOT NULL AND ie_gpt_item_p::text <> '') and a.ie_tipo_grupo = CASE WHEN ie_gpt_item_p='D' THEN  'DIA'  ELSE ie_gpt_item_p END ))
				and		gpt_se_item_doc_reval_atual(a.nm_tabela, a.nr_seq_cpoe, null, 1, a.nm_usuario_nrec, a.ie_tipo_item, a.ie_tipo_grupo) <> 'XPTO'
				and		((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, a.dt_prox_geracao + (qt_hors_copia_w/24), a.dt_final) = 'S')
						or ((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
				having	CASE WHEN ie_desc_horas_ant_w='S' THEN  min(a.dt_validacao)  ELSE min(a.dt_anterior) END  < trunc(clock_timestamp() + interval '1 days') - interval '1' second
			) alias22;

	if (ie_existe_w = 'S' and ie_tipo_item_w <> 'XPTO') then

		if (ie_opcao_p = 1) then
			ds_retorno_w := ie_tipo_item_w;
		else
			ds_retorno_w := 'S';
		end if;

	end if;

end if;

	return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gpt_se_item_doc_reval ( nm_tabela_p text default null, nr_seq_cpoe_p bigint DEFAULT NULL, ie_gpt_item_p text default null, ie_opcao_p integer DEFAULT NULL) FROM PUBLIC;

