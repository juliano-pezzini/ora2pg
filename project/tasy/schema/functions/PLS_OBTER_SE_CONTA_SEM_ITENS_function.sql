-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_conta_sem_itens ( nr_seq_analise_p bigint, nr_seq_conta_p bigint ) RETURNS bigint AS $body$
DECLARE

/*TEM A FINALIDADE DE VERIFICAR SE EXISTEM GLOSAS OU OCORRENCIAS DE CONTAS QUE NÃƒO POSSUEM PROC NEM MAT, SOMENTE A GLOSA/OCOR DA CONTA*/

ds_retorno_w	varchar(2);
qt_contas_w	bigint:= 0;


BEGIN
/*
select 	 count(1)
into	 qt_contas_w
from   	 pls_analise_conta_item b
where  	 b.nr_seq_analise = nr_seq_analise_p
and	not exists (
	select 1
	from   pls_analise_conta_item a
	where  ((a.nr_seq_conta_proc is not null) or (a.nr_seq_conta_mat is not null))
	and	a.nr_seq_conta 	 = b.nr_seq_conta
	and	a.nr_seq_analise = nr_seq_analise_p
)

order by nr_seq_conta;
*/
if ( coalesce(nr_seq_analise_p,0) > 0) then
	select count(a.nr_sequencia)
	into STRICT   qt_contas_w
	from   pls_conta a
	where  a.nr_seq_analise = nr_seq_analise_p
	and	   exists (
			  SELECT 1
			  from 	 pls_conta_glosa b
			  where	 b.nr_seq_conta = a.nr_sequencia
			
union

			  SELECT 1
			  from 	 pls_ocorrencia_benef b
			  where	 b.nr_seq_conta = a.nr_sequencia
	)
	and	not exists (
				  select  1
				  from	  pls_conta_proc b
				  where   b.nr_seq_conta = a.nr_Sequencia
				  
union

				  select  1
				  from	  pls_conta_mat b
				  where   b.nr_seq_conta = a.nr_Sequencia
	);

elsif (coalesce(nr_seq_conta_p,0) > 0) then
	select count(a.nr_sequencia)
	into STRICT   qt_contas_w
	from   pls_conta a
	where  a.nr_sequencia = nr_seq_conta_p
	and	   exists (
			  SELECT 1
			  from 	 pls_conta_glosa b
			  where	 b.nr_seq_conta = a.nr_sequencia
			
union

			  SELECT 1
			  from 	 pls_ocorrencia_benef b
			  where	 b.nr_seq_conta = a.nr_sequencia
	)
	and	not exists (
			  select  1
			  from	  pls_conta_proc b
			  where   b.nr_seq_conta = a.nr_Sequencia
			  
union

			  select  1
			  from	  pls_conta_mat b
			  where   b.nr_seq_conta = a.nr_Sequencia
	);

end if;


return	qt_contas_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_conta_sem_itens ( nr_seq_analise_p bigint, nr_seq_conta_p bigint ) FROM PUBLIC;

