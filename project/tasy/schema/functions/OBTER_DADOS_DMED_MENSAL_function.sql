-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_dmed_mensal ( nr_seq_dmed_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/* Opções
QT_RESP	: quantidade de responsáveis
QT_BENEF_PRES	: quantidade de beneficiários relativos à prestadora
VL_RESP	: valor total dos responsáveis
VL_BENEF_PRES	: valor total dos beneficiários relativos à prestadora
QT_TIT		: quantidade de titulares
QT_BENEF_OPS	: quantidade de beneficiários relativos à operadora
VL_TIT		: valor total dos titulares
VL_BENEF_OPS	: valor dos beneficiários relativos à operadora
RE_TIT		: valor total dos reembolsos dos titulares
RE_BEN		: valor total dos reembolsos dos beneficiários
VL_RE		: valor total do reembolso
*/
retorno_w	double precision;


BEGIN

if (ie_opcao_p = 'QT_RESP') then

	select 	count(distinct cd_pessoa_titular)
	into STRICT	retorno_w
	from 	dmed_titulos_mensal
	where	nr_seq_dmed_mensal = nr_seq_dmed_p
	and	cd_pessoa_titular = cd_pessoa_beneficiario
	and	ie_prestadora_ops = 'P';

elsif (ie_opcao_p = 'QT_BENEF_PRES') then

	select 	count(distinct cd_pessoa_beneficiario)
	into STRICT	retorno_w
	from 	dmed_titulos_mensal
	where	nr_seq_dmed_mensal = nr_seq_dmed_p
	and	cd_pessoa_titular <> cd_pessoa_beneficiario
	and	ie_prestadora_ops = 'P';

elsif (ie_opcao_p = 'VL_RESP') then

	select 	sum(vl_pago)
	into STRICT	retorno_w
	from 	dmed_titulos_mensal
	where	nr_seq_dmed_mensal = nr_seq_dmed_p
	and	ie_prestadora_ops = 'P'
	and	cd_pessoa_titular = cd_pessoa_beneficiario;

elsif (ie_opcao_p = 'VL_BENEF_PRES') then

	select 	sum(vl_pago)
	into STRICT	retorno_w
	from 	dmed_titulos_mensal
	where	nr_seq_dmed_mensal = nr_seq_dmed_p
	and	ie_prestadora_ops = 'P'
	and	cd_pessoa_titular <> cd_pessoa_beneficiario;

elsif (ie_opcao_p = 'QT_TIT') then

	select 	count(distinct cd_pessoa_titular)
	into STRICT	retorno_w
	from 	dmed_titulos_mensal
	where	nr_seq_dmed_mensal = nr_seq_dmed_p
	and	cd_pessoa_titular = cd_pessoa_beneficiario
	and	ie_prestadora_ops = 'O';

elsif (ie_opcao_p = 'QT_BENEF_OPS') then

	select 	count(distinct cd_pessoa_beneficiario)
	into STRICT	retorno_w
	from 	dmed_titulos_mensal
	where	nr_seq_dmed_mensal = nr_seq_dmed_p
	and	cd_pessoa_titular <> cd_pessoa_beneficiario
	and	ie_prestadora_ops = 'O';

elsif (ie_opcao_p = 'VL_TIT') then

	select (
				select	coalesce(sum(vl_pago),0)
		      		from	dmed_titulos_mensal
		      		where	nr_seq_dmed_mensal = nr_seq_dmed_p
		      		and	ie_prestadora_ops = 'O'
		      		and	cd_pessoa_titular = cd_pessoa_beneficiario
			)
    	    -
    	    (
				select	coalesce(sum(vl_reembolso),0)
				from (select	m.vl_pago vl_reembolso
				    	 from  	dmed_titulos_mensal m,
					                titulo_pagar t,
					                pls_protocolo_conta p,
    	      				      	pls_segurado a
				          	where	m.nr_documento = t.nr_titulo
					and	t.nr_seq_reembolso = p.nr_sequencia
					and	p.nr_seq_segurado = a.nr_sequencia
					and	m.nr_seq_dmed_mensal = nr_seq_dmed_p
					and	m.ie_tipo_documento = 'RE'
					and	(a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '')) alias7
    	    )
	into STRICT	retorno_w
	;

elsif (ie_opcao_p = 'VL_BENEF_OPS') then

	select (
				select 	coalesce(sum(vl_pago),0)
				from 	dmed_titulos_mensal
				where	nr_seq_dmed_mensal = nr_seq_dmed_p
				and	ie_prestadora_ops = 'O'
				and	cd_pessoa_titular <> cd_pessoa_beneficiario
			)
    	    -
    	    (
				select	coalesce(sum(vl_reembolso),0)
				from (select	m.vl_pago vl_reembolso
					from	dmed_titulos_mensal m,
						titulo_pagar t,
						pls_protocolo_conta p,
						pls_segurado a
					where	m.nr_documento = t.nr_titulo
					and	t.nr_seq_reembolso = p.nr_sequencia
					and	p.nr_seq_segurado = a.nr_sequencia
					and	m.nr_seq_dmed_mensal = nr_seq_dmed_p
					and	m.ie_tipo_documento = 'RE'
					and	coalesce(a.nr_seq_titular::text, '') = '') alias7
    	    )
	into STRICT	retorno_w
	;

elsif (ie_opcao_p = 'RE_TIT') then

	select	sum(vl_pago)
	into STRICT	retorno_w
	from (	SELECT	m.vl_pago vl_pago
				from	dmed_titulos_mensal m,
					titulo_pagar t,
					pls_protocolo_conta p,
					pls_segurado a
				where	m.nr_documento = t.nr_titulo
				and	t.nr_seq_reembolso = p.nr_sequencia
				and	p.nr_seq_segurado = a.nr_sequencia
				and	m.nr_seq_dmed_mensal = nr_seq_dmed_p
				and	m.ie_tipo_documento = 'RE'
				and	(a.nr_seq_titular IS NOT NULL AND a.nr_seq_titular::text <> '')) alias3;

elsif (ie_opcao_p = 'RE_BEN') then

	select	sum(vl_pago)
	into STRICT	retorno_w
	from (	SELECT	m.vl_pago vl_pago
				from	dmed_titulos_mensal m,
					titulo_pagar t,
					pls_protocolo_conta p,
					pls_segurado a
				where	m.nr_documento = t.nr_titulo
				and	t.nr_seq_reembolso = p.nr_sequencia
				and	p.nr_seq_segurado = a.nr_sequencia
				and	m.nr_seq_dmed_mensal = nr_seq_dmed_p
				and	m.ie_tipo_documento = 'RE'
				and	coalesce(a.nr_seq_titular::text, '') = '') alias3;

elsif (ie_opcao_p = 'VL_RE') then

	select	sum(vl_pago)
	into STRICT	retorno_w
	from (	SELECT	m.vl_pago vl_pago
				from	dmed_titulos_mensal m,
					titulo_pagar t,
					pls_protocolo_conta p,
					pls_segurado a
				where	m.nr_documento = t.nr_titulo
				and	t.nr_seq_reembolso = p.nr_sequencia
				and	p.nr_seq_segurado = a.nr_sequencia
				and	m.nr_seq_dmed_mensal = nr_seq_dmed_p
				and	m.ie_tipo_documento = 'RE') alias2;

elsif (ie_opcao_p = 'VL_TOT_PREST') then

	select 	sum(vl_pago)
	into STRICT	retorno_w
	from 	dmed_titulos_mensal
	where	nr_seq_dmed_mensal = nr_seq_dmed_p
	and		ie_prestadora_ops = 'P';

elsif (ie_opcao_p = 'VL_TOT_OPER') then

	select (
				select 	coalesce(sum(vl_pago),0)
				from 	dmed_titulos_mensal
				where	nr_seq_dmed_mensal = nr_seq_dmed_p
				and	ie_prestadora_ops = 'O'
			)
    	    -
    	    (
				select	coalesce(sum(vl_reembolso),0)
				from (select	m.vl_pago vl_reembolso
					from	dmed_titulos_mensal m,
						titulo_pagar t,
						pls_protocolo_conta p,
						pls_segurado a
					where	m.nr_documento = t.nr_titulo
					and	t.nr_seq_reembolso = p.nr_sequencia
					and	p.nr_seq_segurado = a.nr_sequencia
					and	m.nr_seq_dmed_mensal = nr_seq_dmed_p
					and	m.ie_tipo_documento = 'RE') alias6
    	    )
	into STRICT	retorno_w
	;

elsif (ie_opcao_p = 'VL_TOTAL') then

	select 	sum(vl_pago)
	into STRICT	retorno_w
	from 	dmed_titulos_mensal
	where	nr_seq_dmed_mensal = nr_seq_dmed_p;

end if;

return	retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_dmed_mensal ( nr_seq_dmed_p bigint, ie_opcao_p text) FROM PUBLIC;

