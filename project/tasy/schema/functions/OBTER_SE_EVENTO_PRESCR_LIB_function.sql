-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_evento_prescr_lib (nr_seq_evento_p bigint, nr_prescricao_p text, dt_liberacao_p timestamp, ie_evento_p text) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(2);				
dt_inicio_w		timestamp;
dt_fim_w		timestamp;
ie_dia_semana_w		varchar(10);
nr_atendimento_w	bigint;
cd_medico_resp_w	varchar(10);
qt_idade_w		bigint;
ie_sexo_w		varchar(5);
cd_estabelecimento_w	bigint;
ie_tipo_atendimento_w	integer;
ie_carater_inter_sus_w	varchar(2);
ie_clinica_w		integer;


BEGIN
	
select	ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_liberacao_p, coalesce(hr_inicial_geracao,dt_liberacao_p)),
		ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_liberacao_p, coalesce(hr_final_geracao,dt_liberacao_p)),
		ie_dia_semana
into STRICT	dt_inicio_w,
		dt_fim_w,
		ie_dia_semana_w
from 	ev_evento
where	nr_sequencia = nr_seq_evento_p;	

select	coalesce(max('S'),'N')
into STRICT	ie_retorno_w
from	prescr_medica a
where	dt_liberacao_p between dt_inicio_w and dt_fim_w
and		a.nr_prescricao = nr_prescricao_p
and		coalesce(ie_dia_semana_w,Obter_Cod_Dia_Semana(dt_liberacao_p)) = Obter_Cod_Dia_Semana(dt_liberacao_p);

if (ie_retorno_w = 'S') then

	select	max(nr_atendimento),
			max(cd_estabelecimento)
	into STRICT	nr_atendimento_w,
			cd_estabelecimento_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;
	
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	
		select	coalesce(max(obter_idade_pf(cd_pessoa_fisica,clock_timestamp(),'A')),0),
			max(Obter_sexo_pf(cd_pessoa_fisica,'C')),
			max(cd_medico_resp),
			coalesce(max(ie_carater_inter_sus),'0'),
			max(ie_tipo_atendimento),
			max(ie_clinica)
		into STRICT	qt_idade_w,
			ie_sexo_w,
			cd_medico_resp_w,
			ie_carater_inter_sus_w,
			ie_tipo_atendimento_w,
			ie_clinica_w
		from 	atendimento_paciente
		where	nr_atendimento = nr_atendimento_w;

		select	coalesce(max('S'),'N')
		into STRICT	ie_retorno_w
		FROM regra_envio_sms a
LEFT OUTER JOIN regra_envio_sms_atend b ON (a.nr_sequencia = b.nr_seq_regra)
WHERE a.nr_seq_evento = nr_seq_evento_p and a.cd_estabelecimento = cd_estabelecimento_w and a.ie_evento_disp = coalesce(ie_evento_p,'LP') and qt_idade_w between coalesce(a.qt_idade_min,0) and coalesce(a.qt_idade_max,9999) and coalesce(a.ie_sexo,ie_sexo_w) = ie_sexo_w and coalesce(a.cd_medico,coalesce(cd_medico_resp_w,'0')) = coalesce(cd_medico_resp_w,'0') and coalesce(b.ie_carater_inter_sus,ie_carater_inter_sus_w) = coalesce(ie_carater_inter_sus_w,'0') and coalesce(b.ie_tipo_atendimento,coalesce(ie_tipo_atendimento_w,'0')) = coalesce(ie_tipo_atendimento_w,'0') and coalesce(b.ie_clinica,coalesce(ie_clinica_w,0)) = coalesce(ie_clinica_w,'0') and coalesce(a.ie_situacao,'A') = 'A';

	end if;
end if;
	
return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_evento_prescr_lib (nr_seq_evento_p bigint, nr_prescricao_p text, dt_liberacao_p timestamp, ie_evento_p text) FROM PUBLIC;

