-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_leitura_barras ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_funcao_p bigint, ie_tipo_req_p text default 'X') RETURNS varchar AS $body$
DECLARE


cd_grupo_material_w		integer;
cd_subgrupo_material_w		integer;
cd_classe_material_w		integer;
ie_obriga_barras_w		varchar(01) := 'N';
qt_registro_w			bigint;


c01 CURSOR FOR
SELECT	coalesce(a.ie_obriga_barras,'N')
from	regra_leitura_barra_mat a
where (coalesce(cd_estabelecimento,cd_estabelecimento_p) = cd_estabelecimento_p)
and	a.cd_funcao				= cd_funcao_p
and (coalesce(a.cd_grupo_material::text, '') = '' or a.cd_grupo_material = cd_grupo_material_w)
and (coalesce(a.cd_subgrupo_material::text, '') = '' or a.cd_subgrupo_material = cd_subgrupo_material_w)
and (coalesce(a.cd_classe_material::text, '') = '' or a.cd_classe_material = cd_classe_material_w)
and (coalesce(a.cd_setor_atendimento::text, '') = '' or a.cd_setor_atendimento = wheb_usuario_pck.get_cd_setor_atendimento)
and (coalesce(a.cd_perfil::text, '') = '' or a.cd_perfil = wheb_usuario_pck.get_cd_perfil)
and (coalesce(a.cd_material::text, '') = '' or a.cd_material = cd_material_p)
and	(((cd_funcao = 109) and ((coalesce(ie_tipo_requisicao,'A') = 'A') or (coalesce(ie_tipo_requisicao,ie_tipo_req_p) = ie_tipo_req_p))) or (cd_funcao <> 109))
order by	coalesce(cd_estabelecimento,0),
		coalesce(cd_material,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_perfil,0),
		coalesce(cd_setor_atendimento,0);
	

BEGIN

select	count(*)
into STRICT	qt_registro_w
from	regra_leitura_barra_mat
where (coalesce(cd_estabelecimento,cd_estabelecimento_p) = cd_estabelecimento_p);

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (qt_registro_w > 0) then

	select	coalesce(max(cd_classe_material),0),
		coalesce(max(cd_subgrupo_material),0),
		coalesce(max(cd_grupo_material),0)
	into STRICT	cd_classe_material_w,
		cd_subgrupo_material_w,
		cd_grupo_material_w
	from	estrutura_material_v
	where	cd_material	= cd_material_p;

	
	
	open C01;
	loop
	fetch C01 into	
		ie_obriga_barras_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		ie_obriga_barras_w	:= ie_obriga_barras_w;
		end;
	end loop;
	close C01;
end if;

return	ie_obriga_barras_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_leitura_barras ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_funcao_p bigint, ie_tipo_req_p text default 'X') FROM PUBLIC;

