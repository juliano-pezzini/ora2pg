-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_resultado_microorganismo (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

ds_retorno_w			varchar(10000);
ds_resultado_w			varchar(10000);
nm_paciente_w			varchar(5000);
ds_resultado_concat_w		varchar(25000);

c01 CURSOR FOR 
 
SELECT DISTINCT obter_desc_expressao(780780)||' '||b.ds_microorganismo 
FROM 	 exame_lab_result_antib a, 
	 exame_lab_result_item c, 
	 exame_lab_resultado d, 
	 cih_microorganismo b, 
	 prescr_procedimento e, 
	 prescr_medica f 
WHERE 	 a.cd_microorganismo = b.cd_microorganismo	 	  
AND	 a.nr_seq_result_item = c.nr_sequencia 
AND	 a.nr_seq_resultado = d.nr_seq_resultado 
AND	 f.nr_prescricao = d.nr_prescricao 
AND	 f.nr_prescricao = e.nr_prescricao 
AND	 c.nr_seq_prescr = e.nr_sequencia 
AND	 f.nr_atendimento = nr_atendimento_p;


BEGIN 
 
SELECT DISTINCT CHR(13)||CHR(13)||obter_desc_expressao(779437)||CHR(13)||obter_desc_expressao(325811)||' '|| obter_nome_pf(f.cd_pessoa_fisica) 
into STRICT 	 nm_paciente_w 
FROM 	 exame_lab_result_antib a, 
	 exame_lab_result_item c, 
	 exame_lab_resultado d, 
	 cih_microorganismo b, 
	 prescr_procedimento e, 
	 prescr_medica f 
WHERE 	 a.cd_microorganismo = b.cd_microorganismo	 	  
AND	 a.nr_seq_result_item = c.nr_sequencia 
AND	 a.nr_seq_resultado = d.nr_seq_resultado 
AND	 f.nr_prescricao = d.nr_prescricao 
AND	 f.nr_prescricao = e.nr_prescricao 
AND	 c.nr_seq_prescr = e.nr_sequencia 
AND	 f.nr_atendimento = nr_atendimento_p;
 
OPEN c01;
LOOP 
FETCH c01 INTO	 
	ds_resultado_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN 
	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then 
		ds_retorno_w := ds_retorno_w || chr(13) ||ds_resultado_w;
	else 
		ds_retorno_w := chr(13) ||ds_resultado_w;	
	end if;
	 
	END;
END LOOP;
 
CLOSE c01;
 
ds_resultado_concat_w := nm_paciente_w || chr(13) ||ds_retorno_w;
 
RETURN SUBSTR(ds_resultado_concat_w,1,25000);
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_resultado_microorganismo (nr_atendimento_p bigint) FROM PUBLIC;

