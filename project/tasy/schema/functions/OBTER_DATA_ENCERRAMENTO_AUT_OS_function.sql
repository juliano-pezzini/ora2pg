-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_data_encerramento_aut_os ( NR_SEQ_OS_P bigint) RETURNS timestamp AS $body$
DECLARE

 IE_ENCERRADA_W   varchar(1) := 'N';
 NR_ULT_ESTAGIO_W bigint;
 PR_RETORNO_W	    timestamp := NULL;

BEGIN
  BEGIN
    SELECT CASE WHEN NR_SEQ_ESTAGIO=9 THEN  'S'  ELSE 'N' END
      INTO STRICT IE_ENCERRADA_W
      FROM MAN_ORDEM_SERVICO OS
     WHERE OS.NR_SEQUENCIA = NR_SEQ_OS_P;
  EXCEPTION
    WHEN no_data_found THEN
      IE_ENCERRADA_W := 'N';
    WHEN OTHERS THEN
      IE_ENCERRADA_W := 'N';
  END;

  IF IE_ENCERRADA_W = 'S' THEN
    BEGIN
      SELECT NR_SEQ_ESTAGIO
        INTO STRICT NR_ULT_ESTAGIO_W
        FROM MAN_ORDEM_SERV_ESTAGIO HES
       WHERE HES.NR_SEQ_ORDEM = NR_SEQ_OS_P
         AND HES.NR_SEQUENCIA IN (SELECT MAX(HES_S.NR_SEQUENCIA)
                                    FROM MAN_ORDEM_SERV_ESTAGIO HES_S
                                   WHERE HES_S.NR_SEQ_ORDEM = HES.NR_SEQ_ORDEM);
    EXCEPTION
      WHEN no_data_found THEN
        NR_ULT_ESTAGIO_W := NULL;
      WHEN OTHERS THEN
        NR_ULT_ESTAGIO_W := NULL;
    END;

    IF (NR_ULT_ESTAGIO_W IS NOT NULL AND NR_ULT_ESTAGIO_W::text <> '' AND NR_ULT_ESTAGIO_W <> 9) THEN
      BEGIN
        SELECT MAX(DT_ATUALIZACAO)
          INTO STRICT PR_RETORNO_W
          FROM MAN_ORDEM_SERV_TECNICO HOS
         WHERE HOS.NR_SEQ_ORDEM_SERV = NR_SEQ_OS_P
           AND HOS.NR_SEQ_TIPO       = 111
           AND coalesce(HOS.DT_INATIVACAO::text, '') = '';
      EXCEPTION
        WHEN no_data_found THEN
          PR_RETORNO_W := NULL;
        WHEN OTHERS THEN
          PR_RETORNO_W := NULL;
      END;
    END IF;
  END IF;

RETURN PR_RETORNO_W;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_data_encerramento_aut_os ( NR_SEQ_OS_P bigint) FROM PUBLIC;

