-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_get_food_allergies (nr_atendimento_p bigint DEFAULT NULL) RETURNS varchar AS $body$
DECLARE


    RSQL varchar(32767);
    C1 IS CURSOR
               WITH food_allergies AS
            (
                SELECT substr(coalesce(coalesce(coalesce(coalesce(obter_desc_dcb(pa.nr_seq_dcb),substr(obter_desc_material(pa.cd_material),1,254)),substr(obter_desc_classe_mat(pa.cd_classe_mat),1,255)),obter_desc_ficha_tecnica(pa.nr_seq_ficha_tecnica)),obter_desc_familia_mat(pa.nr_seq_familia)),1,255)ds_medic_grid,
                       substr(obter_desc_alergeno(pa.nr_seq_tipo),1,80) ds_tipo,
                       pa.ds_observacao notes
                  FROM paciente_alergia pa
LEFT OUTER JOIN tipo_alergia ta ON (pa.nr_seq_tipo = ta.nr_sequencia)
WHERE pa.cd_pessoa_fisica = ( SELECT pa.cd_pessoa_fisica cd_pessoa_fisica
                                                FROM atendimento_paciente pa
                                               WHERE pa.nr_atendimento = nr_atendimento_p
                                             ) AND ta.ie_nutricao = 'S' AND ta.ie_situacao = 'A'


UNION


                SELECT substr(coalesce(coalesce(coalesce(coalesce(obter_desc_dcb(pa.nr_seq_dcb),substr(obter_desc_material(pa.cd_material),1,254)),substr(obter_desc_classe_mat(pa.cd_classe_mat),1,255)),obter_desc_ficha_tecnica(pa.nr_seq_ficha_tecnica)),obter_desc_familia_mat(pa.nr_seq_familia)),1,255)ds_medic_grid,
                       substr(obter_desc_alergeno(pa.nr_seq_tipo),1,80) ds_tipo,
                       pa.ds_observacao notes
                  FROM paciente_alergia pa
LEFT OUTER JOIN tipo_alergia ta ON (pa.nr_seq_tipo = ta.nr_sequencia)
WHERE pa.cd_pessoa_fisica = ( SELECT pa.cd_pessoa_fisica cd_pessoa_fisica
                                                FROM atendimento_paciente pa
                                               WHERE pa.nr_atendimento = nr_atendimento_p
                                             ) AND ta.ie_alimento = 'S' AND ta.ie_situacao = 'A'

             
UNION
 

                SELECT substr(coalesce(coalesce(coalesce(coalesce(obter_desc_dcb(pa.nr_seq_dcb),substr(obter_desc_material(pa.cd_material),1,254)),substr(obter_desc_classe_mat(pa.cd_classe_mat),1,255)),obter_desc_ficha_tecnica(pa.nr_seq_ficha_tecnica)),obter_desc_familia_mat(pa.nr_seq_familia)),1,255)ds_medic_grid,
                       substr(obter_desc_alergeno(pa.nr_seq_tipo),1,80) ds_tipo,
                       pa.ds_observacao notes
                  FROM paciente_alergia pa
LEFT OUTER JOIN tipo_alergia ta ON (pa.nr_seq_tipo = ta.nr_sequencia)
WHERE pa.cd_pessoa_fisica = ( SELECT pa.cd_pessoa_fisica cd_pessoa_fisica
                                                FROM atendimento_paciente pa
                                               WHERE pa.nr_atendimento = nr_atendimento_p
                                             ) AND ta.ie_alimento = 'S' AND ta.ie_nutricao = 'S' AND ta.ie_situacao = 'A'

             
UNION


                SELECT substr(coalesce(coalesce(coalesce(coalesce(obter_desc_dcb(pa.nr_seq_dcb),substr(obter_desc_material(pa.cd_material),1,254)),substr(obter_desc_classe_mat(pa.cd_classe_mat),1,255)),obter_desc_ficha_tecnica(pa.nr_seq_ficha_tecnica)),obter_desc_familia_mat(pa.nr_seq_familia)),1,255)ds_medic_grid,
                       substr(obter_desc_alergeno(pa.nr_seq_tipo),1,80) ds_tipo,
                       pa.ds_observacao notes
                  FROM paciente_alergia pa
LEFT OUTER JOIN tipo_alergia ta ON (pa.nr_seq_tipo = ta.nr_sequencia)
LEFT OUTER JOIN material m ON (pa.cd_material = M.cd_material)
WHERE m.ie_tipo_material = '5' AND pa.cd_pessoa_fisica = ( SELECT pa.cd_pessoa_fisica cd_pessoa_fisica
                                                FROM atendimento_paciente pa
                                               WHERE pa.nr_atendimento = nr_atendimento_p
                                             )
             )
            SELECT RTRIM(XMLAGG(XMLELEMENT(name e, REPLACE(fa.ds_medic_grid ||' '|| fa.ds_tipo || ' ' || '('|| fa.notes || ')','()',''),'; ') ORDER BY REPLACE(fa.ds_medic_grid || fa.ds_tipo || ' ' || '('|| fa.notes || ')','()','') ).EXTRACT('//text()').getclobval(), ',') AS food_allergies   
              FROM food_allergies fa
;


BEGIN
    OPEN C1;
    FETCH C1 INTO RSQL;
    CLOSE C1;

    RETURN(RSQL);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_get_food_allergies (nr_atendimento_p bigint DEFAULT NULL) FROM PUBLIC;

