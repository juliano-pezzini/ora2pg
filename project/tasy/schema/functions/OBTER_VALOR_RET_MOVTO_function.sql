-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_ret_movto (nr_sequencia_p bigint, ie_valor_p text) RETURNS bigint AS $body$
DECLARE


qt_paga_w		double precision;
vl_pago_w		double precision;
vl_total_w		double precision;
vl_filme_w		double precision;

vl_resultado_w	double precision;

dt_mesano_pgto_w	timestamp;
dt_mesano_ant_w	timestamp;
vl_pago_ant_w	double precision;
vl_adicional_w	double precision;
vl_cobrado_w	double precision;
vl_pago_real_w	double precision;


BEGIN

vl_resultado_w		:= 0;

select 	coalesce(qt_paga,0),
	coalesce(vl_pago,0),
	coalesce(vl_total_pago,0),
	coalesce(vl_filme,0),
	coalesce(vl_pago_ant,0),
	dt_mesano_pagamento,
	dt_mesano_ant,
	coalesce(vl_cobrado,0)
into STRICT	qt_paga_w,
	vl_pago_w,
	vl_total_w,
	vl_filme_w,
	vl_pago_ant_w,
	dt_mesano_pgto_w,
	dt_mesano_ant_w,
	vl_cobrado_w
from 	convenio_retorno_movto
where 	nr_sequencia = nr_sequencia_p;

vl_resultado_w		:= coalesce(vl_total_w,0);

if (vl_resultado_w = 0) then
	vl_resultado_w := qt_paga_w * vl_pago_w;
	if (qt_paga_w <= 1) then
		vl_resultado_w := vl_pago_w;
	end if;
end if;

if (ie_valor_p = 'P') and (coalesce(dt_mesano_ant_w, coalesce(dt_mesano_pgto_w, clock_timestamp())) <> coalesce(dt_mesano_pgto_w, clock_timestamp())) then
	vl_resultado_w := vl_resultado_w - vl_pago_ant_w;
end if;

vl_resultado_w := vl_resultado_w + vl_filme_w;

if (ie_valor_p = 'A') then
	if (coalesce(dt_mesano_ant_w, coalesce(dt_mesano_pgto_w, clock_timestamp())) <> coalesce(dt_mesano_pgto_w, clock_timestamp())) then
		vl_resultado_w	:= vl_total_w - vl_pago_ant_w;
		vl_filme_w		:= 0;
	else
		vl_resultado_w 	:= 0;
	end if;
end if;

if (ie_valor_p = 'ADIC') then --Adicional do item, considerando o valor cobrado para o item. Ou seja, o valor adicional será sempre caso o valor pago seja maior que o cobrado.
	if (vl_resultado_w - vl_cobrado_w < 0) then
		vl_resultado_w	:= 0;
	else
		vl_resultado_w	:= vl_resultado_w - vl_cobrado_w;
	end if;
end if;

if (ie_valor_p = 'PR') then --Valor pago real para o item, com base no valor cobrado, ou seja, se o item foi cobrado 0 porém pago 50, então o pago real é 0 pois o 50 passa a ser adicional.
	if (vl_resultado_w > 0) then
		if (vl_cobrado_w = 0) then
			vl_pago_real_w	:= 0;
		elsif (vl_cobrado_w < vl_resultado_w) then
			/*vl_pago_real_w	:= vl_resultado_w - vl_cobrado_w;    Fabiano/Ronaldo  em 26 de julho 2016
							foi alterado esta linha por probelmas na OS 1077155. No caso em especifico o total da conta do cliente era de 3653,35 existia um item nessa conta no valor cobrado de
							R$74 e tinha sido pago 562,5: E a conta acabou ficando com os seguintes valores: o VL_PAGO_REAL_W dessa function ficou com 488,5 de acordo com a formula antes da minha alteraçao.
							Somando este valor de 488,5 com o restantes dos itens o valor total pago ficou R$4067,85 e o valor adicional de R$488,5
							Na pasta do retorno ficou correto o valor adicional de R$488,5, porém o valor pago ficou errado com o valor de R$4067,85, pois ficou superior ao valor da guia que é de R$3653,35,
							Por isso foi alterado esta linha para pegar o valor cobrado que é o valor real do item e somando todos os valores cobrados chega no valor correto do total da guia.
			*/
			vl_pago_real_w	:= vl_cobrado_w;
		elsif (vl_cobrado_w >= vl_resultado_w) then
			vl_pago_real_w	:= vl_resultado_w;
		end if;
	else
		vl_pago_real_w	:= 0;
	end if;

	vl_resultado_w	:= vl_pago_real_w;
end if;

Return vl_resultado_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_ret_movto (nr_sequencia_p bigint, ie_valor_p text) FROM PUBLIC;

