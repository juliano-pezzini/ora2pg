-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_certidao_pessoa ( cd_pessoa_fisica_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

/*	ie_opcao_p
	NR - Número da certidão
	TP - Tipo (1- Nascimento, 2- Casamento, 3- Divórcio)
	CT - Cartório
	LI - Livro
	FO - Folha
	DE - Data de emissão */
ds_retorno_w			varchar(255);
nr_cert_casamento_w		varchar(255);
nr_cert_nasc_w			varchar(255);
nr_cert_divorcio_w		varchar(20);

nr_seq_cartorio_w		bigint;
nr_livro_cert_w			bigint;
nr_folha_cert_w			bigint;
ie_tipo_w			varchar(1);
dt_emissao_w			timestamp;
nr_certidao_w			varchar(255);


BEGIN

select	nr_cert_casamento,
	nr_cert_nasc,
	nr_cert_divorcio
into STRICT	nr_cert_casamento_w,
	nr_cert_nasc_w,
	nr_cert_divorcio_w
from	pessoa_fisica
where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

if (coalesce(nr_cert_nasc_w,'0') <> '0') then
	select	nr_seq_cartorio_nasc,
		nr_livro_cert_nasc,
		nr_folha_cert_nasc,
		'1',
		dt_emissao_cert_nasc
	into STRICT	nr_seq_cartorio_w,
		nr_livro_cert_w,
		nr_folha_cert_w,
		ie_tipo_w,
		dt_emissao_w
	from	pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

	nr_certidao_w	:= nr_cert_nasc_w;
elsif (coalesce(nr_cert_casamento_w,'0') <> '0') then
	select	nr_seq_cartorio_casamento,
		nr_livro_cert_casamento,
		nr_folha_cert_casamento,
		'2',
		dt_emissao_cert_casamento
	into STRICT	nr_seq_cartorio_w,
		nr_livro_cert_w,
		nr_folha_cert_w,
		ie_tipo_w,
		dt_emissao_w
	from	pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

	nr_certidao_w	:= nr_cert_casamento_w;
elsif (coalesce(nr_cert_divorcio_w,'0') <> '0') then
	select	nr_seq_cartorio_divorcio,
		nr_livro_cert_divorcio,
		nr_folha_cert_div,
		'3',
		dt_emissao_cert_divorcio
	into STRICT	nr_seq_cartorio_w,
		nr_livro_cert_w,
		nr_folha_cert_w,
		ie_tipo_w,
		dt_emissao_w
	from	pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

	nr_certidao_w	:= nr_cert_divorcio_w;
end if;

if (ie_opcao_p	= 'TP') then
	ds_retorno_w	:= ie_tipo_w;
elsif (ie_opcao_p	= 'CT') then
	select	ds_cartorio
	into STRICT	ds_retorno_w
	from	cartorio
	where	nr_sequencia	= nr_seq_cartorio_w;
elsif (ie_opcao_p	= 'LI') then
	ds_retorno_w	:= nr_livro_cert_w;
elsif (ie_opcao_p	= 'FO') then
	ds_retorno_w	:= nr_folha_cert_w;
elsif (ie_opcao_p	= 'DE') then
	ds_retorno_w	:= to_char(dt_emissao_w,'dd/mm/yyyy');
elsif (ie_opcao_p	= 'NR') then
	ds_retorno_w	:= nr_certidao_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_certidao_pessoa ( cd_pessoa_fisica_p text, ie_opcao_p text) FROM PUBLIC;

