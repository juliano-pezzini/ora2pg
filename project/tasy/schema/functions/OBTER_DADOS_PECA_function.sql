-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_peca (ie_opcao_p text, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE
	
 
ds_valor_w	varchar(255);


BEGIN 
 
/* 
ie_opcao_p: 
P = Nome Pessoa Física 
C = Nr seq lab 
E = descição exame complementar 
T = Descrição tipo amostra patologia 
TC = Código do tipo de amostra patologia 
D = Descrição da amostra principal 
T = Descrição tipo amostra patologia 
DG = Descrição da amostra + grupo 
*/
 
 
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then 
 
	if (ie_opcao_p = 'P') then 
 
		select substr(obter_nome_pf(max(c.cd_pessoa_fisica)),1,255) nm_paciente 
		into STRICT	ds_valor_w 
		from	prescr_medica c, 
			prescr_procedimento b, 
			prescr_proc_peca a 
		where	b.nr_prescricao = c.nr_prescricao 
		and	a.nr_prescricao	= b.Nr_prescricao 
		and	a.nr_seq_prescr	= b.nr_sequencia 
		and 	a.nr_sequencia = nr_sequencia_p;
		 
	elsif (ie_opcao_p = 'C') then 
 
		select max(b.nr_seq_lab) 
		into STRICT 	ds_valor_w 
		from	prescr_procedimento b, 
			prescr_proc_peca a 
		where	a.nr_prescricao	= b.Nr_prescricao 
		and	a.nr_seq_prescr	= b.nr_sequencia 
		and 	a.nr_sequencia = nr_sequencia_p;
		 
	elsif (ie_opcao_p = 'E') then 
 
		select substr(obter_descricao_padrao('PATOLOGIA_EXAME_COMPL','DS_EXAME_COMPL',NR_SEQ_PATO_EXAME),1,255) ds_exame_compl 
		into STRICT	ds_valor_w 
		from	prescr_medica c, 
			prescr_procedimento b, 
			prescr_proc_peca a 
		where	b.nr_prescricao = c.nr_prescricao 
		and	a.nr_prescricao	= b.Nr_prescricao 
		and	a.nr_seq_prescr	= b.nr_sequencia 
		and 	a.nr_sequencia = nr_sequencia_p;
	 
	elsif (ie_opcao_p = 'T') then 
 
		select	max(t.ds_amostra) 
		into STRICT	ds_valor_w 
		from	prescr_proc_peca p, 
			tipo_amostra_patologia t 
		where	p.nr_seq_amostra_princ 	= t.nr_sequencia 
		and	p.nr_sequencia		= nr_sequencia_p;
 
	elsif (ie_opcao_p = 'TC') then 
 
		select	max(p.nr_seq_amostra_princ) 
		into STRICT	ds_valor_w 
		from	prescr_proc_peca p 
		where	p.nr_sequencia		= nr_sequencia_p;
	 
	elsif (ie_opcao_p = 'D') then 
 
		select max(a.ds_amostra_principal) 
		into STRICT 	ds_valor_w 
		from	prescr_proc_peca a 
		where	a.nr_sequencia = nr_sequencia_p;
 
	elsif (ie_opcao_p = 'TA') then 
 
		select	max(t.ds_amostra)||'-'||max(p.ds_amostra_principal) 
		into STRICT	ds_valor_w 
		from	prescr_proc_peca p, 
			tipo_amostra_patologia t 
		where	p.nr_seq_amostra_princ 	= t.nr_sequencia 
		and	p.nr_sequencia		= nr_sequencia_p;
		 
	elsif (ie_opcao_p = 'TAL') then 
 
		select	max(t.ds_amostra)||'-'||max(p.ds_amostra_principal)||'-'||max(substr(obter_valor_dominio(5356, p.ie_lado), 1, 150)) 
		into STRICT	ds_valor_w 
		from	prescr_proc_peca p, 
			tipo_amostra_patologia t 
		where	p.nr_seq_amostra_princ 	= t.nr_sequencia 
		and	p.nr_sequencia		= nr_sequencia_p;
		 
		 
	elsif (ie_opcao_p = 'DG') then 
	 
		select	max(d.ds_amostra || ' - ' ||o.ds_grupo) 
		into STRICT	ds_valor_w 
		from  	laudo_questao_item i, 
			laudo_grupo_questao g, 
			grupo_questao_laudo o, 
			prescr_proc_peca p, 
			tipo_amostra_patologia d 
		where 	i.nr_seq_laudo_grupo  = g.nr_sequencia 
		and	g.nr_seq_peca 	    = p.nr_sequencia 
		and	p.nr_seq_amostra_princ = d.nr_sequencia 
		and	g.nr_seq_grupo_questao = o.nr_sequencia 
		and	coalesce(p.ie_situacao,'A') = 'A' 
		and	i.nr_sequencia = nr_sequencia_p;
	 
	end if;
 
end if;
 
return	ds_valor_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_peca (ie_opcao_p text, nr_sequencia_p bigint) FROM PUBLIC;

