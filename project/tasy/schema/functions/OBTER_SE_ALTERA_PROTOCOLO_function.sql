-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_altera_protocolo ( cd_protocolo_p bigint, nr_seq_medic_p bigint, nm_usuario_p text ) RETURNS varchar AS $body$
DECLARE


ie_permissao_w		varchar(1);
cd_pessoa_fisica_w	varchar(10);
cd_pessoa_criacao_w	varchar(10);
ie_resp_princ_w		varchar(1) :=  null;
qt_reg_w		bigint;
nm_usuario_w		varchar(25);

BEGIN

select	Obter_Valor_Param_Usuario(281,79, obter_perfil_ativo, nm_usuario_p,0)
into STRICT	ie_permissao_w
;

if (ie_permissao_w = 'P') or (ie_permissao_w = 'O') then
	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	usuario
	where	nm_usuario	= nm_usuario_p;
end if;

if (ie_permissao_w in ('P', 'D')) then
	begin
	select	coalesce(max(ie_resp_princ),'U')
	into STRICT	ie_resp_princ_w
	from	protocolo_medic_resp
	where	cd_pessoa_fisica	= cd_pessoa_fisica_w
	and	cd_protocolo		= cd_protocolo_p
	and	nr_seq_medic		= nr_seq_medic_p;

	if (ie_resp_princ_w <> 'U') then
		ie_permissao_w	:= 'S';
	end if;

	select	count(*),
		max(nm_usuario)
	into STRICT	qt_reg_w,
		nm_usuario_w
	from	PROTOCOLO_MEDICACAO
	where	cd_protocolo		= cd_protocolo_p
	and	nr_sequencia		= nr_seq_medic_p;

	if	((coalesce(qt_reg_w,0)	= '0') or (nm_usuario_w = nm_usuario_p)) and (ie_permissao_w	= 'D') then
		ie_permissao_w	:= 'S';
	end if;

	end;
end if;

if (ie_permissao_w = 'O') then
	select	coalesce(max(cd_pessoa_criacao),'NULO')
	into STRICT	cd_pessoa_criacao_w
	from	protocolo
	where	cd_protocolo	= cd_protocolo_p;

	if (cd_pessoa_criacao_w = cd_pessoa_fisica_w) then
		ie_permissao_w	:= 'S';
	end if;
end if;

if	((ie_permissao_w = 'S') or (ie_permissao_w = 'N') or (ie_permissao_w = 'T')) then
	ie_permissao_w	:= 'S';
else
	ie_permissao_w	:= 'N';
end if;


return ie_permissao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_altera_protocolo ( cd_protocolo_p bigint, nr_seq_medic_p bigint, nm_usuario_p text ) FROM PUBLIC;

