-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_evolucao_mod_suep ( nr_seq_suep_p bigint, nr_atendimento_p bigint) RETURNS bigint AS $body$
DECLARE


cd_evolucao_w 			bigint;
ie_formato_busca_w		varchar(1);
ie_evolucao_clinica_w	varchar(10);
ie_tipo_evolucao_w		varchar(3);



BEGIN

Select 	coalesce(max(a.ie_formato_busca),'A') ie_formato_busca
into STRICT	ie_formato_busca_w
from	item_suep a,
		suep b
where	a.nr_seq_suep = b.nr_sequencia
and		a.ie_tipo_item = 'EV'
and		b.nr_sequencia = nr_seq_suep_p;

SELECT	obter_inf_suep(nr_seq_suep_p, 'EV', 'I') ie_evolucao_clinica,
		Obter_Dados_Usuario_Opcao(wheb_usuario_pck.get_nm_usuario,'F')
into STRICT	ie_evolucao_clinica_w,
		ie_tipo_evolucao_w
;


select	max(cd_evolucao)
into STRICT	cd_evolucao_w
from	evolucao_paciente a
where	((a.ie_evolucao_clinica = ie_evolucao_clinica_w) or (coalesce(ie_evolucao_clinica_w::text, '') = ''))
and   	coalesce(a.ie_tipo_evolucao,ie_tipo_evolucao_w) = ie_tipo_evolucao_w
and     obter_se_reg_lib_atencao(cd_pessoa_fisica, cd_medico, ie_nivel_atencao, nm_usuario,5) = 'S'
and		((ie_formato_busca_w = 'A' and	a.nr_atendimento = nr_atendimento_p) or (ie_formato_busca_w = 'P' and  a.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_p,'C')) or (ie_formato_busca_w = 'C' and  a.nr_atendimento in ( SELECT x.nr_atendimento from atendimento_paciente x where x.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_p,'C') and x.nr_seq_episodio = obter_episodio_atendimento(nr_atendimento_p))));


return	cd_evolucao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_evolucao_mod_suep ( nr_seq_suep_p bigint, nr_atendimento_p bigint) FROM PUBLIC;

