-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_cart_masc_benef ( nr_seq_segurado_p pls_segurado.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(255);
ds_mascara_w		varchar(255);
nr_cont_cart_w		bigint := 1;
i			bigint := 1;
nr_seq_emissor_w	pls_emissor_carteira.nr_sequencia%type;
cd_usuario_plano_w	pls_segurado_carteira.cd_usuario_plano%type;
				

BEGIN


select	max(cd_usuario_plano),
	max(nr_seq_emissor)
into STRICT	cd_usuario_plano_w,
	nr_seq_emissor_w
from	pls_segurado_carteira
where	nr_seq_segurado	= nr_seq_segurado_p;


	begin
		select	max(a.nr_cartao_intercambio),
			max(a.nr_seq_emissor)
		into STRICT	cd_usuario_plano_w,
			nr_seq_emissor_w
		from	pls_segurado_carteira a,
			pls_segurado b
		where	b.nr_sequencia	= a.nr_seq_segurado
		and	b.nr_sequencia	= nr_seq_segurado_p
		and (a.dt_validade_carteira >= clock_timestamp()
		or 	coalesce(a.dt_validade_carteira::text, '') = '');	
	exception
	when others then
		cd_usuario_plano_w	:= null;
		nr_seq_emissor_w	:= null;
	end;

	if (coalesce(cd_usuario_plano_w::text, '') = '') then	
		begin
			select	max(a.cd_usuario_plano),			
				max(a.nr_seq_emissor)
			into STRICT	cd_usuario_plano_w,
				nr_seq_emissor_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	b.nr_sequencia		= nr_seq_segurado_p;
		exception
		when others then
			cd_usuario_plano_w	:= null;
			nr_seq_emissor_w	:= null;
		end;
	end if;

	if (coalesce(cd_usuario_plano_w::text, '') = '') then	
		begin
			select	max(a.nr_cartao_intercambio),
				max(a.nr_seq_emissor)
			into STRICT	cd_usuario_plano_w,
				nr_seq_emissor_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	b.nr_sequencia	= a.nr_seq_segurado
			and	b.nr_sequencia	= nr_seq_segurado_p;
		exception
		when others then
			cd_usuario_plano_w	:= null;
			nr_seq_emissor_w	:= null;
		end;	
	end if;	



if (nr_seq_emissor_w IS NOT NULL AND nr_seq_emissor_w::text <> '') then
	ds_mascara_w := pls_obter_mascara_cartao_benef( nr_seq_emissor_w,'E', wheb_usuario_pck.get_cd_estabelecimento);
else
	ds_mascara_w := pls_obter_mascara_cartao_benef(null,'O', wheb_usuario_pck.get_cd_estabelecimento);
end if;


if (ds_mascara_w IS NOT NULL AND ds_mascara_w::text <> '') then
	while(nr_cont_cart_w <> length(cd_usuario_plano_w) + 1) loop
		begin	
		
		if (substr(ds_mascara_w, i, 1) in ('/','-','.',' ','_')) then
			ds_retorno_w := ds_retorno_w || substr(ds_mascara_w, i, 1);
		else
			ds_retorno_w := ds_retorno_w || substr(cd_usuario_plano_w, nr_cont_cart_w,1);
			nr_cont_cart_w := nr_cont_cart_w + 1;
		end if;	
		
		i := i + 1;
		
		end;
	end loop;
else
	ds_retorno_w	:= cd_usuario_plano_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_cart_masc_benef ( nr_seq_segurado_p pls_segurado.nr_sequencia%type) FROM PUBLIC;

