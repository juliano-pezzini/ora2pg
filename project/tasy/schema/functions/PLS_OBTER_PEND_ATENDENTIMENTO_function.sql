-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_pend_atendentimento ( cd_pessoa_p text, ie_tipo_pessoa text, nm_usuario_p text) RETURNS bigint AS $body$
DECLARE


ds_retorno_w 		bigint	:= 0;
qt_incosistencia_w	bigint	:= 0;
qt_contrato_w		bigint	:= 0;
qt_segurado_w		bigint	:= 0;
qt_guia_w 		bigint	:= 0;
qt_sac_boletim_w	bigint	:= 0;
qt_notif_atend_w	bigint	:= 0;
qt_liminar_w		bigint	:= 0;
qt_carencia_w		bigint	:= 0;
qt_cpt_w		bigint	:= 0;
qt_mensalidade_w	bigint	:= 0;
qt_pendencia_w		bigint	:= 0;
qt_pendencia_cobranca_w	bigint	:= 0;
qt_pendencia_susp_mens_w	bigint	:= 0;
ie_visual_mens_contrato_w varchar(1) := 'N';
ie_visual_boletim_ocorr_w varchar(1) := 'S';
ie_vencimento_original_w  varchar(1);
qt_pendencia_rescisao_w bigint	:= 0;


BEGIN

ie_visual_mens_contrato_w	:= obter_valor_param_usuario(1266, 1, Obter_Perfil_Ativo, nm_usuario_p, 0);
ie_visual_boletim_ocorr_w	:= obter_valor_param_usuario(1266, 2, Obter_Perfil_Ativo, nm_usuario_p, 0);
ie_vencimento_original_w	:= coalesce(obter_valor_param_usuario(1266, 3, Obter_Perfil_Ativo, nm_usuario_p, 0),'N');

if (coalesce(cd_pessoa_p,0) <> 0) then
	if (ie_tipo_pessoa = 'PF') then
		select	count(b.cd_inconsistencia)
		into STRICT	qt_incosistencia_w
		from	pls_cad_inconsist_pessoa	b,
			pls_inconsistencia_pessoa	a
		where	a.nr_seq_inconsistencia	= b.nr_sequencia
		and	cd_pessoa_fisica	= cd_pessoa_p;
		
		select	count(b.nr_sequencia)
		into STRICT	qt_contrato_w
		from	titulo_receber		c,
			pls_mensalidade		b,
			pls_contrato_pagador	a
		where	a.nr_sequencia		= b.nr_seq_pagador
		and	b.nr_sequencia		= c.nr_seq_mensalidade
		and	a.cd_pessoa_fisica	= cd_pessoa_p
		and	coalesce(c.dt_liquidacao::text, '') = '';
		
		select	sum(qt_pendencia)
		into STRICT	qt_mensalidade_w
		from	(SELECT	count(1) qt_pendencia
			from	titulo_receber		c,
				pls_mensalidade		b,
				pls_contrato_pagador	a
			where	a.nr_sequencia		= b.nr_seq_pagador
			and	b.nr_sequencia		= c.nr_seq_mensalidade
			and	a.cd_pessoa_fisica	= cd_pessoa_p
			and	coalesce(c.dt_liquidacao::text, '') = ''
			and	((ie_vencimento_original_w = 'S' and (trunc(c.dt_vencimento,'dd') 		< trunc(clock_timestamp(),'dd'))) or (ie_vencimento_original_w = 'N' and (trunc(c.dt_pagamento_previsto,'dd')	< trunc(clock_timestamp(),'dd'))))
			
union

			SELECT	count(1) qt_pendencia
			from	titulo_receber		d,
				pls_mensalidade		c,
				pls_mensalidade_segurado	b,
				pls_segurado		a
			where	a.nr_sequencia		= b.nr_seq_segurado
			and	b.nr_seq_mensalidade	= c.nr_sequencia
			and	c.nr_sequencia		= d.nr_seq_mensalidade
			and	a.cd_pessoa_fisica	= cd_pessoa_p
			and	ie_visual_mens_contrato_w = 'S'
			and	coalesce(d.dt_liquidacao::text, '') = ''
			and	((ie_vencimento_original_w = 'S' and (trunc(d.dt_vencimento,'dd') 		< trunc(clock_timestamp(),'dd'))) or (ie_vencimento_original_w = 'N' and (trunc(d.dt_pagamento_previsto,'dd')	< trunc(clock_timestamp(),'dd'))))
			
union

			select	count(1) qt_pendencia
			from	titulo_receber		d,
				pls_mensalidade		c,
				pls_contrato_pagador	b,
				pls_contrato		a
			where	c.nr_seq_pagador	= b.nr_sequencia
			and	b.nr_seq_contrato	= a.nr_sequencia
			and	c.nr_sequencia		= d.nr_seq_mensalidade
			and	a.cd_pf_estipulante	= cd_pessoa_p
			and	ie_visual_mens_contrato_w = 'S'
			and	coalesce(d.dt_liquidacao::text, '') = ''
			and	((ie_vencimento_original_w = 'S' and (trunc(d.dt_vencimento,'dd') 		< trunc(clock_timestamp(),'dd'))) or (ie_vencimento_original_w = 'N' and (trunc(d.dt_pagamento_previsto,'dd')	< trunc(clock_timestamp(),'dd'))))) alias40;		
		
		select	count(b.nr_sequencia)
		into STRICT	qt_segurado_w
		from	titulo_receber		c,
			pls_mensalidade		b,
			pls_contrato_pagador	a,
			pls_Segurado		s
		where	a.nr_sequencia		= b.nr_seq_pagador
		and	b.nr_sequencia		= c.nr_seq_mensalidade
		and	a.nr_sequencia		= s.nr_seq_pagador
		and	s.cd_pessoa_fisica	= cd_pessoa_p
		and	coalesce(c.dt_liquidacao::text, '') = '';
		
		select	count(a.cd_guia)
		into STRICT	qt_guia_w
		from 	pls_segurado	b,
			pls_guia_plano	a
		where 	a.nr_seq_segurado	= b.nr_sequencia
		and	a.ie_status 	= '2'
		and	b.cd_pessoa_fisica	= cd_pessoa_p;
		
		select	count(a.dt_ocorrencia)
		into STRICT	qt_sac_boletim_w
		from	sac_resp_bol_ocor		b,
			sac_boletim_ocorrencia	a,
			sac_responsavel		c
		where	a.nr_sequencia 		= b.nr_seq_bo
		and	b.nr_seq_responsavel	= c.nr_sequencia
		and	b.ie_status not in ('E','S')
		and	a.cd_pessoa_fisica	= cd_pessoa_p
		and	ie_visual_boletim_ocorr_w = 'S';
		
		select	count(*)
		into STRICT	qt_notif_atend_w
		from	pls_notificacao_atend	c,
			pls_auditoria		b,
			pls_segurado		a
		where	c.nr_seq_auditoria = b.nr_sequencia
		and	b.nr_seq_segurado = a.nr_sequencia
		and	a.cd_pessoa_fisica = cd_pessoa_p
		and	c.ie_status = 'AG';
		
		select	count(*)
		into STRICT	qt_liminar_w
		from	processo_judicial_liminar	b,
			pls_segurado			a
		where	b.nr_seq_segurado 	= a.nr_sequencia
		and	b.ie_estagio 		= 2
		and	a.cd_pessoa_fisica	= cd_pessoa_p
		and	clock_timestamp() between trunc(dt_inicio_validade) and fim_dia(coalesce(dt_fim_validade,clock_timestamp()));
		
		select	sum(qt_carencia)
		into STRICT	qt_carencia_w
		from (SELECT	count(*) qt_carencia
			from	pls_segurado	b,
				pls_carencia	a
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.ie_cpt		= 'N'
			and	b.ie_situacao_atend	= 'A'
			and	clock_timestamp() <= coalesce(a.dt_inicio_vigencia,b.dt_inclusao_operadora) + a.qt_dias
			and	b.cd_pessoa_fisica	= cd_pessoa_p
			
union all

			SELECT	count(*) qt_carencia
			from	pls_segurado	b,
				pls_carencia	a,
				pls_contrato	c
			where	a.nr_seq_contrato	= c.nr_sequencia
			and	b.nr_seq_contrato	= c.nr_sequencia
			and	a.ie_cpt		= 'N'
			and	b.ie_situacao_atend	= 'A'
			and	clock_timestamp() <= coalesce(a.dt_inicio_vigencia,b.dt_inclusao_operadora) + a.qt_dias
			and	b.cd_pessoa_fisica	= cd_pessoa_p
			and	not exists (	select	1
							from	pls_carencia	x
							where	x.nr_seq_segurado	= b.nr_sequencia
							and	x.ie_cpt		= 'N')
			
union all

			select	count(*) qt_carencia
			from	pls_segurado	b,
				pls_carencia	a,
				pls_plano	c
			where	a.nr_seq_plano		= c.nr_sequencia
			and	b.nr_seq_plano		= c.nr_sequencia
			and	a.ie_cpt		= 'N'
			and	b.ie_situacao_atend	= 'A'
			and	clock_timestamp() <= coalesce(a.dt_inicio_vigencia,b.dt_inclusao_operadora) + a.qt_dias
			and	b.cd_pessoa_fisica	= cd_pessoa_p
			and	not exists (	select	1
							from	pls_carencia	x
							where	x.nr_seq_segurado	= b.nr_sequencia
							and	x.ie_cpt		= 'N')
			and	not exists (	select	1
							from	pls_carencia	x
							where	x.nr_seq_contrato	= b.nr_seq_contrato
							and	x.ie_cpt		= 'N')
			
union all

			select	count(*) qt_pendencia
			from	pls_carencia_sca_v	a,
				pls_segurado		b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	b.cd_pessoa_fisica	= cd_pessoa_p
			and	b.ie_situacao_atend	= 'A'
			and	clock_timestamp() <= a.dt_inicio_vigencia + a.qt_dias) alias15;
		
		select	count(*)
		into STRICT	qt_cpt_w
		from	pls_segurado	b,
			pls_carencia	a
		where	a.nr_seq_segurado	= b.nr_sequencia
		and	a.ie_cpt		= 'S'
		and	clock_timestamp() <= coalesce(a.dt_inicio_vigencia,b.dt_inclusao_operadora) + a.qt_dias
		and	b.cd_pessoa_fisica	= cd_pessoa_p
		and	((coalesce(b.dt_rescisao::text, '') = '') or (b.dt_rescisao > clock_timestamp()));
		
		/* Solicitações de alterações cadastrais */

		select 	count(1)
		into STRICT	qt_pendencia_w
		from 	tasy_solic_alteracao c
		where 	exists (SELECT  1
				from   	tasy_solic_alteracao a, tasy_solic_alt_campo b
				where 	a.nr_sequencia 	= c.nr_sequencia
				and	a.nr_sequencia = b.nr_seq_solicitacao
				and	b.nm_tabela in ('PESSOA_FISICA','COMPL_PESSOA_FISICA')
				and (b.ds_chave_simples = cd_pessoa_p))
		and coalesce(dt_analise::text, '') = ''
		and ie_status = 'A';
				
		if (qt_pendencia_w = 0) then
			select 	count(1)
			into STRICT	qt_pendencia_w
			from 	tasy_solic_alteracao c
			where 	exists (SELECT  1
					from   	tasy_solic_alteracao a, tasy_solic_alt_campo b
					where 	a.nr_sequencia 	= c.nr_sequencia
					and	a.nr_sequencia = b.nr_seq_solicitacao
					and	b.nm_tabela in ('PESSOA_FISICA','COMPL_PESSOA_FISICA')
					and	(b.ds_chave_composta= ('CD_PESSOA_FISICA='||cd_pessoa_p||'#@#@IE_TIPO_COMPLEMENTO=1')))
			and coalesce(dt_analise::text, '') = ''
			and ie_status = 'A';

			if (qt_pendencia_w = 0) then
				select 	count(1)
				into STRICT	qt_pendencia_w
				from 	tasy_solic_alteracao c
				where 	exists (SELECT  1
						from   	tasy_solic_alteracao a, tasy_solic_alt_campo b
						where 	a.nr_sequencia 	= c.nr_sequencia
						and	a.nr_sequencia = b.nr_seq_solicitacao
						and	b.nm_tabela in ('PESSOA_FISICA','COMPL_PESSOA_FISICA')
						and	(b.ds_chave_composta= ('CD_PESSOA_FISICA='||cd_pessoa_p||'#@#@IE_TIPO_COMPLEMENTO=2')))
				and coalesce(dt_analise::text, '') = ''
				and ie_status = 'A';
						
				if (qt_pendencia_w = 0) then
					select 	count(1)
					into STRICT	qt_pendencia_w
					from 	tasy_solic_alteracao c
					where 	exists (SELECT  1
							from   	tasy_solic_alteracao a, tasy_solic_alt_campo b
							where 	a.nr_sequencia 	= c.nr_sequencia
							and	a.nr_sequencia = b.nr_seq_solicitacao
							and	b.nm_tabela in ('PESSOA_FISICA','COMPL_PESSOA_FISICA')
							and	(b.ds_chave_composta= ('CD_PESSOA_FISICA='||cd_pessoa_p||'#@#@IE_TIPO_COMPLEMENTO=3')))
					and coalesce(dt_analise::text, '') = ''
					and ie_status = 'A';
					
					if (qt_pendencia_w = 0) then
						select 	count(1)
						into STRICT	qt_pendencia_w
						from 	tasy_solic_alteracao c
						where 	exists (SELECT  1
								from   	tasy_solic_alteracao a, tasy_solic_alt_campo b
								where 	a.nr_sequencia 	= c.nr_sequencia
								and	a.nr_sequencia = b.nr_seq_solicitacao
								and	b.nm_tabela in ('PESSOA_FISICA','COMPL_PESSOA_FISICA')
								and	(b.ds_chave_composta= ('CD_PESSOA_FISICA='||cd_pessoa_p||'#@#@IE_TIPO_COMPLEMENTO=4')))
						and coalesce(dt_analise::text, '') = ''
						and ie_status = 'A';
		
						if (qt_pendencia_w = 0) then
							select 	count(1)
							into STRICT	qt_pendencia_w
							from 	tasy_solic_alteracao c
							where 	exists (SELECT  1
									from   	tasy_solic_alteracao a, tasy_solic_alt_campo b
									where 	a.nr_sequencia 	= c.nr_sequencia
									and	a.nr_sequencia = b.nr_seq_solicitacao
									and	b.nm_tabela in ('PESSOA_FISICA','COMPL_PESSOA_FISICA')
									and	(b.ds_chave_composta= ('CD_PESSOA_FISICA='||cd_pessoa_p||'#@#@IE_TIPO_COMPLEMENTO=5')))
							and coalesce(dt_analise::text, '') = ''
							and ie_status = 'A';
							if (qt_pendencia_w = 0) then
								select 	count(1)
								into STRICT	qt_pendencia_w
								from 	tasy_solic_alteracao c
								where 	exists (SELECT  1
										from   	tasy_solic_alteracao a, tasy_solic_alt_campo b
										where 	a.nr_sequencia 	= c.nr_sequencia
										and	a.nr_sequencia = b.nr_seq_solicitacao
										and	b.nm_tabela in ('PESSOA_FISICA','COMPL_PESSOA_FISICA')
										and	(b.ds_chave_composta= ('CD_PESSOA_FISICA='||cd_pessoa_p||'#@#@IE_TIPO_COMPLEMENTO=6')))
								and coalesce(dt_analise::text, '') = ''
								and ie_status = 'A';
								
								if (qt_pendencia_w = 0) then
									select 	count(1)
									into STRICT	qt_pendencia_w
									from 	tasy_solic_alteracao c
									where 	exists (SELECT  1
											from   	tasy_solic_alteracao a, tasy_solic_alt_campo b
											where 	a.nr_sequencia 	= c.nr_sequencia
											and	a.nr_sequencia = b.nr_seq_solicitacao
											and	b.nm_tabela in ('PESSOA_FISICA','COMPL_PESSOA_FISICA')
											and	(b.ds_chave_composta= ('CD_PESSOA_FISICA='||cd_pessoa_p||'#@#@IE_TIPO_COMPLEMENTO=7')))
									and coalesce(dt_analise::text, '') = ''
									and ie_status = 'A';
											
									if (qt_pendencia_w = 0) then
										select 	count(1)
										into STRICT	qt_pendencia_w
										from 	tasy_solic_alteracao c
										where 	exists (SELECT  1
												from   	tasy_solic_alteracao a, tasy_solic_alt_campo b
												where 	a.nr_sequencia 	= c.nr_sequencia
												and	a.nr_sequencia = b.nr_seq_solicitacao
												and	b.nm_tabela in ('PESSOA_FISICA','COMPL_PESSOA_FISICA')
												and	(b.ds_chave_composta= ('CD_PESSOA_FISICA='||cd_pessoa_p||'#@#@IE_TIPO_COMPLEMENTO=8')))
										and coalesce(dt_analise::text, '') = ''
										and ie_status = 'A';
									end if;
								end if;
							end if;
						end if;
					end if;
				end if;
			end if;
		end if;
		
		select	count(1)
		into STRICT	qt_pendencia_rescisao_w
		from	pls_solic_rescisao_benef a,
			pls_solicitacao_rescisao b,
			pls_segurado c
		where	b.nr_sequencia	= a.nr_seq_solicitacao
		and	c.nr_sequencia	= a.nr_seq_segurado
		and	c.cd_pessoa_fisica = cd_pessoa_p
		and	b.ie_status = 2;

		/*Cobrança*/

		select	count(1)
		into STRICT	qt_pendencia_cobranca_w
		from	cobranca	a
		where	ie_status	= 'P'
		and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')
		and	a.cd_pessoa_fisica	= cd_pessoa_p
		and	(a.nr_seq_etapa IS NOT NULL AND a.nr_seq_etapa::text <> '');

		/*Suspensão de cobrança mensalidade */

		select	count(1)
		into STRICT	qt_pendencia_susp_mens_w
		from	pls_contrato_susp_mens	a, 
			pls_contrato_pagador b
		where	a.nr_seq_pagador		= b.nr_sequencia
		and (coalesce(trunc(a.dt_fim_suspensao)::text, '') = '' 
		or 	trunc(a.dt_fim_suspensao) 	>= trunc(clock_timestamp()))
		and	(a.nr_seq_motivo_suspensao IS NOT NULL AND a.nr_seq_motivo_suspensao::text <> '')
		and	(b.cd_pessoa_fisica IS NOT NULL AND b.cd_pessoa_fisica::text <> '')
		and	b.cd_pessoa_fisica		= cd_pessoa_p;		
		
	elsif (ie_tipo_pessoa = 'PJ') then
		select	count(b.cd_inconsistencia)
		into STRICT	qt_incosistencia_w
		from	pls_cad_inconsist_pessoa	b,
			pls_inconsistencia_pessoa	a
		where	a.nr_seq_inconsistencia	= b.nr_sequencia
		and	cd_cgc			= cd_pessoa_p;	
		
		select	sum(qt_pendencia)
		into STRICT	qt_mensalidade_w
		from	(SELECT	count(1) qt_pendencia
			from	titulo_receber		c,
				pls_mensalidade		b,
				pls_contrato_pagador	a
			where	a.nr_sequencia		= b.nr_seq_pagador
			and	b.nr_sequencia		= c.nr_seq_mensalidade
			and	a.cd_cgc		= cd_pessoa_p
			and	coalesce(c.dt_liquidacao::text, '') = ''
			and	((ie_vencimento_original_w = 'S' and (trunc(c.dt_vencimento,'dd') 		< trunc(clock_timestamp(),'dd'))) or (ie_vencimento_original_w = 'N' and (trunc(c.dt_pagamento_previsto,'dd')	< trunc(clock_timestamp(),'dd'))))
			
union

			SELECT	count(1) qt_pendencia
			from	titulo_receber		d,
				pls_mensalidade		c,
				pls_contrato_pagador	b,
				pls_contrato		a
			where	c.nr_seq_pagador	= b.nr_sequencia
			and	b.nr_seq_contrato	= a.nr_sequencia
			and	c.nr_sequencia		= d.nr_seq_mensalidade
			and	a.cd_cgc_estipulante	= cd_pessoa_p
			and	ie_visual_mens_contrato_w = 'S'
			and	coalesce(d.dt_liquidacao::text, '') = ''
			and	((ie_vencimento_original_w = 'S' and (trunc(d.dt_vencimento,'dd') 		< trunc(clock_timestamp(),'dd'))) or (ie_vencimento_original_w = 'N' and (trunc(d.dt_pagamento_previsto,'dd')	< trunc(clock_timestamp(),'dd'))))) alias27;
		
		select	count(a.dt_ocorrencia)
		into STRICT	qt_sac_boletim_w
		from	sac_resp_bol_ocor		b,
			sac_boletim_ocorrencia	a,
			sac_responsavel		c
		where	a.nr_sequencia 		= b.nr_seq_bo
		and	b.nr_seq_responsavel	= c.nr_sequencia
		and	b.ie_status not in ('E','S')
		and	a.cd_cgc	= cd_pessoa_p
		and	ie_visual_boletim_ocorr_w = 'S';
		/*Cobrança*/

		
		select	count(1)
		into STRICT	qt_pendencia_cobranca_w
		from	cobranca	a
		where	ie_status	= 'P'
		and	(a.cd_cgc IS NOT NULL AND a.cd_cgc::text <> '')
		and	a.cd_cgc	= cd_pessoa_p
		and	(a.nr_seq_etapa IS NOT NULL AND a.nr_seq_etapa::text <> '');
		
		/*Suspensão de cobrança mensalidade */

		select	count(1)
		into STRICT	qt_pendencia_susp_mens_w
		from	pls_contrato_susp_mens	a, 
			pls_contrato_pagador b
		where	a.nr_seq_pagador		= b.nr_sequencia
		and (coalesce(trunc(a.dt_fim_suspensao)::text, '') = '' 
		or 	trunc(a.dt_fim_suspensao) 	>= trunc(clock_timestamp()))
		and	(a.nr_seq_motivo_suspensao IS NOT NULL AND a.nr_seq_motivo_suspensao::text <> '')
		and	(b.cd_cgc IS NOT NULL AND b.cd_cgc::text <> '')
		and	b.cd_cgc			= cd_pessoa_p;
					
	end if;
end if;

ds_retorno_w := (coalesce(qt_incosistencia_w,0) + coalesce(qt_mensalidade_w,0) + coalesce(qt_guia_w,0) + coalesce(qt_sac_boletim_w,0) + coalesce(qt_notif_atend_w,0)
		+ coalesce(qt_liminar_w,0) + coalesce(qt_carencia_w,0) + coalesce(qt_pendencia_w,0) + coalesce(qt_cpt_w,0) + coalesce(qt_pendencia_rescisao_w,0)+ coalesce(qt_pendencia_cobranca_w,0)+ coalesce(qt_pendencia_susp_mens_w,0));

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_pend_atendentimento ( cd_pessoa_p text, ie_tipo_pessoa text, nm_usuario_p text) FROM PUBLIC;

