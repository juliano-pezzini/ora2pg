-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_porte_anestesico (nr_cirurgia_p bigint, nr_seq_agenda_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_convenio_p bigint default null, cd_categoria_p text default null) RETURNS varchar AS $body$
DECLARE


qt_porte_anestesico_w	smallint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
cd_porte_w		varchar(15);
dt_cirurgia_w		timestamp;
cd_convenio_W		bigint;
CD_EDICAO_AMB_W		integer:= 0;
nr_atendimento_w	bigint;
cd_estabelecimento_w	smallint;
ie_prioridade_edicao_w	varchar(1);
cd_categoria_w		varchar(10);
VL_CH_HONORARIOS_W		double precision := 1;
VL_CH_CUSTO_OPER_W		double precision := 1;
VL_M2_FILME_W			double precision := 0;
dt_inicio_vigencia_w		timestamp;
tx_ajuste_geral_w		double precision;
nr_seq_cbhpm_edicao_w		bigint;


BEGIN

if (nr_cirurgia_p IS NOT NULL AND nr_cirurgia_p::text <> '') and (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') and (ie_origem_proced_p IS NOT NULL AND ie_origem_proced_p::text <> '') then
	begin
	cd_procedimento_w	:= cd_procedimento_p;
	ie_origem_proced_w	:= ie_origem_proced_p;

	select	coalesce(dt_inicio_real, dt_inicio_prevista),
		coalesce(nr_atendimento,0)
	into STRICT	dt_cirurgia_w,
		nr_atendimento_w
	from	cirurgia
	where	nr_cirurgia	= nr_cirurgia_p;

	select	obter_convenio_atendimento(nr_atendimento_w),
		obter_categoria_atendimento(nr_atendimento_w)
	into STRICT	cd_convenio_w,
		cd_categoria_w
	;

	select 	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from 	atendimento_paciente
	where 	nr_atendimento = nr_atendimento_w;

	if (coalesce(cd_estabelecimento_w,0) > 0) then
		select	coalesce(max(ie_prioridade_edicao_amb), 'N')
		into STRICT	ie_prioridade_edicao_w
		from	parametro_faturamento
		where	cd_estabelecimento	= cd_estabelecimento_w;

		/*      obter a edicao do convenio  */

		if (ie_prioridade_edicao_w	= 'N') then
			begin
			select 	coalesce(max(cd_edicao_amb),0)
			into STRICT   	cd_edicao_amb_w
			from 	convenio_amb
			where (cd_estabelecimento     = cd_estabelecimento_w)
			and (cd_convenio            = coalesce(cd_convenio_p,cd_convenio_w))
			and (cd_categoria           = coalesce(cd_categoria_p,cd_categoria_w))
			and (coalesce(ie_situacao,'A')	= 'A')
			and 	(dt_inicio_vigencia     =
				(SELECT max(dt_inicio_vigencia)
				from 	convenio_amb a
				where (a.cd_estabelecimento  = cd_estabelecimento_w)
				and (a.cd_convenio         = coalesce(cd_convenio_p,cd_convenio_w))
				and (a.cd_categoria        = coalesce(cd_categoria_p,cd_categoria_w))
				and (coalesce(a.ie_situacao,'A')= 'A')
				and (a.dt_inicio_vigencia <=  dt_cirurgia_w)));
			end;
		else
			SELECT * FROM Obter_Edicao_Proc_Conv(cd_estabelecimento_w, coalesce(cd_convenio_p,cd_convenio_w), coalesce(cd_categoria_p,cd_categoria_w), dt_cirurgia_w, cd_procedimento_w, cd_edicao_amb_w, vl_ch_honorarios_W, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w) INTO STRICT cd_edicao_amb_w, vl_ch_honorarios_W, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w;
		end if;

	end if;

	end;
elsif (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') and (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') and (ie_origem_proced_p IS NOT NULL AND ie_origem_proced_p::text <> '') then
	begin

	cd_procedimento_w := cd_procedimento_p;
	ie_origem_proced_w:= ie_origem_proced_p;
	select	dt_agenda,
		cd_convenio
	into STRICT	dt_cirurgia_w,
		cd_convenio_W
	from	agenda_paciente
	where	nr_sequencia	= nr_seq_agenda_p;
	end;
end if;


if (ie_origem_proced_w = 5) and
	((coalesce(CD_EDICAO_AMB_W,0) = 0) or (cd_edicao_amb_w in (2004,2005))) then
	begin

	select	coalesce(max(a.cd_porte),'X')
	into STRICT	cd_porte_w
	from	cbhpm_preco a
	where	a.cd_procedimento	= cd_procedimento_w
	and	a.ie_origem_proced	= ie_origem_proced_w
	and	a.dt_vigencia		=
		(SELECT max(coalesce(x.dt_vigencia,clock_timestamp() - interval '3650 days'))
		from 	cbhpm_preco x
		where	x.cd_procedimento	= cd_procedimento_w
		and	x.ie_origem_proced	= ie_origem_proced_w
		and	x.dt_vigencia		<= dt_cirurgia_w);

	return	cd_porte_w;

	end;
else
	begin

	if (coalesce(CD_EDICAO_AMB_W, 0) = 0) then
		SELECT	max(CD_EDICAO_AMB)
		into STRICT	CD_EDICAO_AMB_W
		FROM 	CONVENIO_AMB
		WHERE (CD_CONVENIO            = coalesce(cd_convenio_p,CD_CONVENIO_w))
		AND (coalesce(IE_SITUACAO,'A')	= 'A')
		and (cd_estabelecimento     = cd_estabelecimento_w)
		AND (CD_CATEGORIA 			= coalesce(CD_CATEGORIA_P,CD_CATEGORIA_W))
		AND 	(DT_INICIO_VIGENCIA     = (	SELECT MAX(DT_INICIO_VIGENCIA)
											FROM 	CONVENIO_AMB A
											WHERE (A.CD_CONVENIO         = coalesce(cd_convenio_p,CD_CONVENIO_w))
											AND (coalesce(A.IE_SITUACAO,'A')= 'A')
											AND (A.DT_INICIO_VIGENCIA <=  dt_cirurgia_w))
											and (cd_categoria = coalesce(cd_categoria_p,cd_categoria_w))
											and (cd_estabelecimento     = cd_estabelecimento_w));

	end if;

	select	coalesce(max(qt_porte_anestesico),0)
	into STRICT	qt_porte_anestesico_w
	FROM 	PRECO_AMB A
	WHERE (A.CD_EDICAO_AMB    	= CD_EDICAO_AMB_W)
	AND (A.CD_PROCEDIMENTO  	= cd_procedimento_w)
  	and 	 coalesce(a.dt_inicio_vigencia,clock_timestamp() - interval '3650 days')	=
			(SELECT max(coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days'))
			from  	preco_amb b
			where 	b.cd_edicao_amb		= cd_edicao_amb_w
			and	b.cd_procedimento		= cd_procedimento_w
			and	coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days') <= dt_cirurgia_w);

	return	qt_porte_anestesico_w;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_porte_anestesico (nr_cirurgia_p bigint, nr_seq_agenda_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_convenio_p bigint default null, cd_categoria_p text default null) FROM PUBLIC;

