-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_informacao_os_defeito (dt_parametro_p timestamp, ie_tipo_inf_p text, ie_produto_p text, nr_seq_gerencia_p bigint, ie_area_gerencia_p text, ie_tipo_valor_p text) RETURNS bigint AS $body$
DECLARE


/*
ie_tipo_inf_p

QTGD	- Quantidade geral de defeitos do produto
QTGDD	- Quantidade geral de defeitos Delphi
QTGDJ	- Quantidade geral de defeitos Java
QTGDH	- Quantidade geral de defeitos HTML5
QTDC	- Quantidade de defeitos identificados por clientes
QTGDDC	- Quantidade de defeitos Delphi identificados por clientes
QTGDJC	- Quantidade de defeitos Java identificados por clientes
QTGDHC	- Quantidade de defeitos HTML5 identificados por clientes
QTDI	- Quantidade de defeitos identificados internamente na Philips.
QTGDDI	- Quantidade de defeitos Delphi identificados internamente na Philips
QTGDJI	- Quantidade de defeitos Java identificados internamente na Philips
QTGDHI	- Quantidade de defeitos HTML5 identificados internamente na Philips


PRGD	- Percentual geral de defeitos do produto (calculado sobre o montante geral de OS abertas por cliente e internas)
PRGDD	- Percentual geral de defeitos Delphi (calculado sobre o montante geral de OS de Delphi abertas por cliente e internas)
PRGDJ	- Percentual geral de defeitos Java (calculado sobre o montante geral de OS de Java abertas por cliente e internas)
PRGDH	- Percentual geral de defeitos HTML5 (calculado sobre o montante geral de OS de HTML5 abertas por cliente e internas)

PRDCT	- Percentual de defeitos identificados por clientes (calculado sobre o montante geral de OS abertas por clientes e internas)
PRGDDCT	- Percentual de defeitos Delphi identificados por clientes (calculado sobre o montante de OS Delphi abertas por clientes e internas)
PRGDJCT	- Percentual de defeitos Java identificados por clientes (calculado sobre o montante de OS Java abertas por clientes e internas)
PRGDHCT	- Percentual de defeitos HTML5 identificados por clientes (calculado sobre o montante de OS HTML5 abertas por clientes e internas)

PRDC	- Percentual de defeitos identificados por clientes (calculado sobre o montante geral de OS abertas por clientes)
PRGDDC	- Percentual de defeitos Delphi identificados por clientes (calculado sobre o montante de OS Delphi abertas por clientes)
PRGDJC	- Percentual de defeitos Java identificados por clientes (calculado sobre o montante de OS Java abertas por clientes)
PRGDHC	- Percentual de defeitos HTML5 identificados por clientes (calculado sobre o montante de OS HTML5 abertas por clientes)

PRDI	- Percentual de defeitos identificados internamente na Philips. (calculado sobre o montante geral de OS abertas internamente pela Philips)
PRGDDI	- Percentual de defeitos Delphi identificados internamente na Philips (calculado sobre o montante de OS Delphi abertas internamente pela Philips)
PRGDJI	- Percentual de defeitos Java identificados internamente na Philips (calculado sobre o montante de OS Java abertas internamente pela Philips)
PRGDHI	- Percentual de defeitos HTML5 identificados internamente na Philips (calculado sobre o montante de OS HTML5 abertas internamente pela Philips)

*/
/*

ie_produto_p
A	- Ambos
P	- Prestador
O	- Operadora

*/
qt_defeito_w			double precision;
qt_os_recebida_w		double precision;
dt_ref_mes_w			timestamp;
dt_fim_mes_w			timestamp;



BEGIN

dt_ref_mes_w			:= trunc(dt_parametro_p,'month');
dt_fim_mes_w			:= last_day(dt_ref_mes_w) + 86399/86400;

if (ie_tipo_valor_p	= 'A') then /*Mês corrente*/
	dt_ref_mes_w		:= add_months(trunc(dt_parametro_p,'month'), -11);
	dt_fim_mes_w		:= trunc(dt_parametro_p,'month');
elsif (ie_tipo_valor_p	= 'AC') then /*Ano corrente de 01/01/xxxx até a data atual*/
	dt_ref_mes_w		:= trunc(dt_parametro_p,'YEAR');
	dt_fim_mes_w		:= last_day(TRUNC(dt_parametro_p)) + 86399/86400;
elsif (ie_tipo_valor_p	= 'ACM') then /*Ano corrente de 01/01/xxxx até o último mês cheio*/
	dt_ref_mes_w		:= trunc(dt_parametro_p,'YEAR');
	dt_fim_mes_w		:= last_day(TRUNC(dt_parametro_p,'month') - 1) + 86399/86400;
end if;


if (ie_tipo_inf_p in ('QTGD','PRGD')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('QTDC','PRDC','PRDCT')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	l.ie_terceiro		= 'S'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('QTDI','PRDI')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	l.ie_terceiro		= 'N'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));


elsif (ie_tipo_inf_p in ('QTGDD','PRGDD')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.ie_plataforma		= 'D'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('QTGDJ','PRGDJ')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.ie_plataforma		= 'S'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('QTGDH','PRGDH')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.ie_plataforma		= 'H'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('QTGDDC','PRGDDC','PRGDDCT')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'D'
	and	l.ie_terceiro		= 'S'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('QTGDJC','PRGDJC','PRGDJCT')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'S'
	and	l.ie_terceiro		= 'S'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('QTGDHC','PRGDHC','PRGDHCT')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'H'
	and	l.ie_terceiro		= 'S'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('QTGDDI','PRGDDI')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'D'
	and	l.ie_terceiro		= 'N'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('QTGDJI','PRGDJI')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'S'
	and	l.ie_terceiro		= 'N'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('QTGDHI','PRGDHI')) then

	select	count(*)
	into STRICT	qt_defeito_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_ERRO_GERENCIA_V a
	where	a.dt_liberacao between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'H'
	and	l.ie_terceiro		= 'N'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

end if;


if (ie_tipo_inf_p in ('PRGD','PRDCT')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('PRDC')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	l.ie_terceiro		= 'S'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('PRDI')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	l.ie_terceiro		= 'N'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));


elsif (ie_tipo_inf_p in ('PRGDD','PRGDDCT')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.ie_plataforma		= 'D'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('PRGDJ','PRGDJCT')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.ie_plataforma		= 'S'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('PRGDH','PRGDHCT')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.ie_plataforma		= 'H'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('PRGDDC')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'D'
	and	l.ie_terceiro		= 'S'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('PRGDJC')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'S'
	and	l.ie_terceiro		= 'S'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('PRGDHC')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'H'
	and	l.ie_terceiro		= 'S'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('PRGDDI')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'D'
	and	l.ie_terceiro		= 'N'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('PRGDJI')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'S'
	and	l.ie_terceiro		= 'N'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

elsif (ie_tipo_inf_p in ('PRGDHI')) then

	select	count(*)
	into STRICT	qt_os_recebida_w
	from	gerencia_wheb g,
		man_localizacao l,
		OS_RECEBIDA_GERENCIA_V a
	where	a.dt_ordem_servico between dt_ref_mes_w and dt_fim_mes_w
	and	a.nr_seq_gerencia	= g.nr_sequencia
	and	a.nr_seq_localizacao	= l.nr_sequencia
	and	a.ie_plataforma		= 'H'
	and	l.ie_terceiro		= 'N'
	and	((nr_seq_gerencia_p = 0) or (a.nr_seq_gerencia = nr_seq_gerencia_p))
	and	((coalesce(ie_area_gerencia_p::text, '') = '') or (g.ie_area_gerencia = ie_area_gerencia_p))
	and	((ie_produto_p = 'A') or (ie_produto_p = 'P' and g.nr_sequencia <> 7) or (ie_produto_p = 'O' and g.nr_sequencia = 7));

end if;

if (ie_tipo_inf_p in ('QTGD','QTDC','QTDI','QTGDD','QTGDJ','QTGDH','QTGDDC','QTGDJC','QTGDHC','QTGDDI','QTGDJI','QTGDHI')) then
	return qt_defeito_w;
elsif (ie_tipo_inf_p in ('PRGD','PRDC','PRDI','PRGDD','PRGDJ','PRGDH','PRGDDC','PRGDJC','PRGDHC','PRGDDI','PRGDJI','PRGDHI','PRGDHCT','PRGDJCT','PRGDDCT','PRDCT')) then
	return dividir(qt_defeito_w * 100,qt_os_recebida_w);
else
	return 0;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_informacao_os_defeito (dt_parametro_p timestamp, ie_tipo_inf_p text, ie_produto_p text, nr_seq_gerencia_p bigint, ie_area_gerencia_p text, ie_tipo_valor_p text) FROM PUBLIC;

