-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_diarias_permitida ( nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_execucao_p bigint, qt_diarias_permitida_p bigint, ie_guia_vinculada_p pls_validacao_aut_dia_perm.ie_guia_vinculada%type default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(1) := 'S';
qt_diarias_w			integer;
qt_diarias_vinculadas_w		integer := 0;
nr_seq_guia_principal_w		pls_guia_plano.nr_seq_guia_principal%type;
nr_seq_requisicao_w		pls_requisicao.nr_sequencia%type;


BEGIN

if (coalesce(ie_guia_vinculada_p,'N') = 'S') then
	if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
		begin
			select	nr_seq_guia_principal
			into STRICT	nr_seq_guia_principal_w
			from	pls_guia_plano
			where	nr_sequencia		= nr_seq_guia_p;
		exception
		when others then
			nr_seq_guia_principal_w := null;
		end;

		select	sum(qt_solicitada)
		into STRICT	qt_diarias_w
		from	pls_guia_plano_proc 	a,
			procedimento 		b
		where	a.nr_seq_guia		= nr_seq_guia_p
		and     b.cd_procedimento	= a.cd_procedimento
		and	b.ie_origem_proced	= a.ie_origem_proced
		and	b.ie_classificacao	= '3';

		if (nr_seq_guia_principal_w IS NOT NULL AND nr_seq_guia_principal_w::text <> '') then
			select	sum(qt_autorizada)
			into STRICT	qt_diarias_vinculadas_w
			from	pls_guia_plano_proc 	a,
				procedimento 		b
			where	a.nr_seq_guia in (	SELECT	c.nr_sequencia
							from	pls_guia_plano c
							where	((c.nr_seq_guia_principal = nr_seq_guia_principal_w
							or	c.nr_sequencia	= nr_seq_guia_principal_w)
							and	c.ie_tipo_guia	in ('1','8')
							and	c.ie_estagio	in (5,6,10)))
			and     b.cd_procedimento	= a.cd_procedimento
			and	b.ie_origem_proced	= a.ie_origem_proced
			and	b.ie_classificacao	= '3'
			and	a.ie_status		in ('L','P','S');
		end if;

		qt_diarias_w := qt_diarias_w + qt_diarias_vinculadas_w;
	elsif (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
		begin
			select	nr_seq_guia_principal
			into STRICT	nr_seq_guia_principal_w
			from	pls_requisicao
			where	nr_sequencia		= nr_seq_requisicao_p;
		exception
		when others then
			nr_seq_guia_principal_w := null;
		end;

		select	sum(qt_solicitado)
		into STRICT	qt_diarias_w
		from	pls_requisicao_proc 	a,
			procedimento		b
		where	a.nr_seq_requisicao	= nr_seq_requisicao_p
		and     b.cd_procedimento	= a.cd_procedimento
		and	b.ie_origem_proced	= a.ie_origem_proced
		and	b.ie_classificacao	= '3';

		if (nr_seq_guia_principal_w IS NOT NULL AND nr_seq_guia_principal_w::text <> '') then
			select	sum(qt_autorizada)
			into STRICT	qt_diarias_vinculadas_w
			from	pls_guia_plano_proc 	a,
				procedimento 		b
			where	a.nr_seq_guia in (	SELECT	c.nr_sequencia
							from	pls_guia_plano c
							where	((c.nr_seq_guia_principal = nr_seq_guia_principal_w
							or	c.nr_sequencia	= nr_seq_guia_principal_w)
							and	c.ie_tipo_guia	in ('1','8')
							and	c.ie_estagio	in (5,6,10)))
			and     b.cd_procedimento	= a.cd_procedimento
			and	b.ie_origem_proced	= a.ie_origem_proced
			and	b.ie_classificacao	= '3'
			and	a.ie_status		in ('L','P','S');
		end if;

		qt_diarias_w := qt_diarias_w + qt_diarias_vinculadas_w;
	elsif (nr_seq_execucao_p IS NOT NULL AND nr_seq_execucao_p::text <> '') then

		select	sum(qt_item)
		into STRICT	qt_diarias_w
		from	pls_execucao_req_item 	a,
			procedimento		b
		where	a.nr_seq_execucao	= nr_seq_execucao_p
		and     b.cd_procedimento	= a.cd_procedimento
		and	b.ie_origem_proced	= a.ie_origem_proced
		and	b.ie_classificacao	= '3';

		begin
			select	nr_seq_requisicao
			into STRICT	nr_seq_requisicao_w
			from	pls_execucao_requisicao
			where	nr_sequencia		= nr_seq_execucao_p;

			select	nr_seq_guia_principal
			into STRICT	nr_seq_guia_principal_w
			from	pls_requisicao
			where	nr_sequencia		= nr_seq_requisicao_w;
		exception
		when others then
			nr_seq_guia_principal_w := null;
		end;

		if (nr_seq_guia_principal_w IS NOT NULL AND nr_seq_guia_principal_w::text <> '') then
			select	sum(qt_autorizada)
			into STRICT	qt_diarias_vinculadas_w
			from	pls_guia_plano_proc 	a,
				procedimento 		b
			where	a.nr_seq_guia in (	SELECT	c.nr_sequencia
							from	pls_guia_plano c
							where	((c.nr_seq_guia_principal = nr_seq_guia_principal_w
							or	c.nr_sequencia	= nr_seq_guia_principal_w)
							and	c.ie_tipo_guia	in ('1','8')
							and	c.ie_estagio	in (5,6,10)))
			and     b.cd_procedimento	= a.cd_procedimento
			and	b.ie_origem_proced	= a.ie_origem_proced
			and	b.ie_classificacao	= '3'
			and	a.ie_status		in ('L','P','S');
		end if;

		qt_diarias_w := qt_diarias_w + qt_diarias_vinculadas_w;
	end if;
else
	if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then

		select	sum(qt_solicitada)
		into STRICT	qt_diarias_w
		from	pls_guia_plano_proc 	a,
			procedimento 		b
		where	a.nr_seq_guia		= nr_seq_guia_p
		and     b.cd_procedimento	= a.cd_procedimento
		and	b.ie_origem_proced	= a.ie_origem_proced
		and	b.ie_classificacao	= '3';

	elsif (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then

		select	sum(qt_solicitado)
		into STRICT	qt_diarias_w
		from	pls_requisicao_proc 	a,
			procedimento		b
		where	a.nr_seq_requisicao	= nr_seq_requisicao_p
		and     b.cd_procedimento	= a.cd_procedimento
		and	b.ie_origem_proced	= a.ie_origem_proced
		and	b.ie_classificacao	= '3';

	elsif (nr_seq_execucao_p IS NOT NULL AND nr_seq_execucao_p::text <> '') then

		select	sum(qt_item)
		into STRICT	qt_diarias_w
		from	pls_execucao_req_item 	a,
			procedimento		b
		where	nr_seq_execucao		= nr_seq_execucao_p
		and     b.cd_procedimento	= a.cd_procedimento
		and	b.ie_origem_proced	= a.ie_origem_proced
		and	b.ie_classificacao	= '3';

	end if;
end if;

if (qt_diarias_w > qt_diarias_permitida_p) then
	ds_retorno_w := 'N';
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_diarias_permitida ( nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_execucao_p bigint, qt_diarias_permitida_p bigint, ie_guia_vinculada_p pls_validacao_aut_dia_perm.ie_guia_vinculada%type default null) FROM PUBLIC;

