-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_limites_param_prescr ( cd_material_p bigint, ie_via_aplicacao_p text, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p text, qt_idade_p bigint, qt_peso_p bigint, ie_se_necessario_p text, ie_opcao_p text, cd_intervalo_p text, ie_agrupador_p bigint) RETURNS varchar AS $body$
DECLARE

/*
I - Intervalo
D - Dose
U - Unidade medida
J - Justificativa
A - Agora
SN - Se necessário
OL - Obedecer limite
HP   - Horários padrões
AM - Aplicação minima
AH - Aplicação máxima
*/
ds_retorno_w			varchar(255) := null;
cd_unidade_medida_w		varchar(30);
cd_intervalo_w			varchar(7);
ie_obriga_just_dose_w	varchar(1);
qt_dose_w				double precision;
ie_via_aplic_padrao_w	varchar(5);
ie_dispositivo_inf_w	varchar(1);
ds_mensagem_w			varchar(255);
qt_minuto_aplicacao_w	smallint;
qt_idade_w				double precision;
qt_idade_min_w			double precision;
qt_idade_max_w			double precision;
nr_seq_agrupamento_w	bigint;
qt_dias_solicitado_w	smallint;
ie_dose_w				varchar(2);
ie_diluicao_w			varchar(2);
ie_justificativa_padrao_w varchar(2);
ie_se_necessario_w		varchar(2);
qt_hora_aplicacao_w		smallint;
qt_solucao_w			double precision;
ds_justificativa_w		varchar(2000);
ie_dose_nula_w			varchar(2);
hr_prim_horario_w		varchar(200);
ie_urgencia_w			varchar(1);
ie_obedecer_limite_w	varchar(1);
qt_dose_terapeutica_w	double precision;
nr_seq_dose_terap_w		bigint;
ds_horarios_w			varchar(2000);
qt_aplic_min_w			smallint;
qt_aplic_max_w			smallint;

c01 CURSOR FOR
SELECT	qt_dose,
		substr(a.cd_intervalo,1,7),
		substr(a.cd_unidade_medida,1,30),
		a.ie_via_aplic_padrao,
		a.ie_dispositivo_infusao,
		a.qt_minuto_aplicacao,
		a.qt_dias_solicitado,
		a.ie_dose,
		a.ds_justificativa,
		a.qt_hora_aplicacao,
		a.qt_solucao,
		a.IE_DILUICAO,
		a.HR_PRIM_HORARIO,
		a.ie_se_necessario,
		obter_dados_medic_atb_var(a.cd_material,wheb_usuario_pck.get_cd_estabelecimento,a.ie_justificativa_padrao,'JP',null,null,null),
		coalesce(a.ie_dose_nula,'N'),
		coalesce(a.ie_gerar_agora,'N'),
		coalesce(Obter_idade_param_prescr2(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MIN'),0) qt_idade_min,
		coalesce(Obter_idade_param_prescr2(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MAX'),9999999) qt_idade_max,
		a.ie_obedecer_limite,
		a.ds_mensagem,
		a.ie_obriga_just_dose,
		a.qt_dose_terapeutica,
		a.nr_seq_dose_terap,
		a.ds_horarios,
		a.qt_aplicacao_max,
		a.qt_aplic_min
from	material_prescr a
where	a.cd_material	= cd_material_p
and	a.ie_tipo 	= '2'
and	coalesce(a.cd_setor_atendimento, coalesce(cd_setor_atendimento_p,0))	= coalesce(cd_setor_atendimento_p,0)
and	((coalesce(a.ie_via_aplicacao::text, '') = '') or (a.ie_via_aplicacao = ie_via_aplicacao_p))
and	coalesce(qt_peso_p,1) between coalesce(a.qt_peso_min,0) and coalesce(a.qt_peso_max,999999)
and	((coalesce(nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento	= nr_seq_agrupamento_w))
and	coalesce(qt_idade_w,1) between coalesce(Obter_idade_param_prescr2(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MIN'),0) and coalesce(Obter_idade_param_prescr2(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MAX'),9999999)
and not exists (select	1
		from	regra_setor_mat_prescr b
		where	a.nr_sequencia		= b.nr_seq_mat_prescr
		and	b.cd_setor_excluir	= cd_setor_atendimento_p)
and	((coalesce(a.ie_somente_sn,'N')	= 'N') or (ie_se_necessario_p = 'S'))
and	((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento))
and	((coalesce(a.cd_intervalo_filtro::text, '') = '') or (a.cd_intervalo_filtro = cd_intervalo_p))
and	(((coalesce(ie_tipo_item,'TOD') = 'SOL') and (ie_agrupador_p = 4)) or
	 ((coalesce(ie_tipo_item,'TOD') = 'OUT') and (ie_agrupador_p <> 4)) or (coalesce(ie_tipo_item,'TOD') = 'TOD'))
order by coalesce(a.cd_setor_atendimento,99999) desc,
	a.qt_idade_min,
	a.qt_idade_max,
	coalesce(a.ie_via_aplicacao, 'zzzzzzzz') desc,
	coalesce(a.qt_peso_min, 99999999) desc,
	a.nr_sequencia;


BEGIN

select	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA'))
into STRICT	qt_idade_w
from	pessoa_fisica b
where	b.cd_pessoa_fisica	= cd_pessoa_fisica_p;

select	max(nr_seq_agrupamento)
into STRICT	nr_seq_agrupamento_w
from	setor_atendimento
where	cd_setor_atendimento	= cd_setor_atendimento_p;

open c01;
loop
fetch c01 into
	qt_dose_w,
	cd_intervalo_w,
	cd_unidade_medida_w,
	ie_via_aplic_padrao_w,
	ie_dispositivo_inf_w,
	qt_minuto_aplicacao_w,
	qt_dias_solicitado_w,
	ie_dose_w,
	ds_justificativa_w,
	qt_hora_aplicacao_w,
	qt_solucao_w,
	ie_diluicao_w,
	hr_prim_horario_w,
	ie_se_necessario_w,
	ie_justificativa_padrao_w,
	ie_dose_nula_w,
	ie_urgencia_w,
	qt_idade_min_w,
	qt_idade_max_w,
	ie_obedecer_limite_w,
	ds_mensagem_w,
	ie_obriga_just_dose_w,
	qt_dose_terapeutica_w,
	nr_seq_dose_terap_w,
	ds_horarios_w,
	qt_aplic_max_w,
	qt_aplic_min_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (ie_opcao_p = 'I') then
		ds_retorno_w	:= cd_intervalo_w;
	elsif (ie_opcao_p = 'D') then
		if (coalesce(ie_dose_w,'F') = 'F') then
			ds_retorno_w	:= qt_dose_w;
		else
			ds_retorno_w	:= qt_dose_w * coalesce(qt_peso_p,1);
		end if;
	elsif (ie_opcao_p = 'U') then
		ds_retorno_w	:= cd_unidade_medida_w;
	elsif (ie_opcao_p = 'V') then
		ds_retorno_w	:= ie_via_aplic_padrao_w;
	elsif (ie_opcao_p = 'DI') then
		ds_retorno_w	:= ie_dispositivo_inf_w;
	elsif (ie_opcao_p = 'MA') then
		ds_retorno_w	:= qt_minuto_aplicacao_w;
	elsif (ie_opcao_p = 'HA') then
		ds_retorno_w	:= qt_hora_aplicacao_w;
	elsif (ie_opcao_p = 'S') then
		ds_retorno_w	:= qt_solucao_w;
	elsif (ie_opcao_p = 'J') then
		ds_retorno_w	:= substr(ds_justificativa_w,1,255);
	elsif (ie_opcao_p = 'L') then
		if (coalesce(ie_diluicao_w::text, '') = '') then
			select	max(ie_diluicao)
			into STRICT	ie_diluicao_w
			from	mat_via_aplic
			where	cd_material		= cd_material_p
			and	ie_via_aplicacao	= ie_via_aplicacao_p;
		else
			exit;
		end if;
		ds_retorno_w	:= ie_diluicao_w;
	elsif (ie_opcao_p = 'Q') then
		ds_retorno_w	:= qt_dias_solicitado_w;
	elsif (ie_opcao_p = 'H') then
		ds_retorno_w	:= hr_prim_horario_w;
	elsif (ie_opcao_p = 'JP') then
		ds_retorno_w	:= ie_justificativa_padrao_w;
	elsif (ie_opcao_p = 'SN') then
		ds_retorno_w	:= ie_se_necessario_w;
	elsif (ie_opcao_p = 'DB') then
		ds_retorno_w	:= ie_dose_nula_w;
	elsif (ie_opcao_p = 'A') then
		ds_retorno_w	:= ie_urgencia_w;
	elsif (ie_opcao_p = 'M') then
		ds_retorno_w	:= ds_mensagem_w;
	elsif (ie_opcao_p = 'M1') then
		ds_retorno_w	:= ie_obriga_just_dose_w;
	elsif (ie_opcao_p = 'QT') then
		ds_retorno_w	:= qt_dose_terapeutica_w;
	elsif (ie_opcao_p = 'TT') then
		ds_retorno_w	:= nr_seq_dose_terap_w;
	elsif (ie_opcao_p = 'OL') then
		ds_retorno_w	:= ie_obedecer_limite_w;
	elsif (ie_opcao_p = 'HP') then
		ds_retorno_w	:= ds_horarios_w;
	elsif (ie_opcao_p = 'AM') then
		ds_retorno_w := qt_aplic_min_w;
	elsif (ie_opcao_p = 'AH') then
		ds_retorno_w := qt_aplic_max_w;
	else
		ds_retorno_w	:= '';
	end if;
	end;
end loop;
close c01;

if (ie_opcao_p = 'L') then
	if (coalesce(ie_diluicao_w::text, '') = '') then
		select	max(ie_diluicao)
		into STRICT	ie_diluicao_w
		from	material
		where	cd_material		= cd_material_p;
		ds_retorno_w	:= ie_diluicao_w;
	end if;
	if (coalesce(ie_diluicao_w::text, '') = '') then
		select	max(ie_diluicao)
		into STRICT	ie_diluicao_w
		from	mat_via_aplic
		where	cd_material		= cd_material_p
		and	ie_via_aplicacao	= ie_via_aplicacao_p;

		ds_retorno_w	:= ie_diluicao_w;
	end if;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_limites_param_prescr ( cd_material_p bigint, ie_via_aplicacao_p text, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p text, qt_idade_p bigint, qt_peso_p bigint, ie_se_necessario_p text, ie_opcao_p text, cd_intervalo_p text, ie_agrupador_p bigint) FROM PUBLIC;

