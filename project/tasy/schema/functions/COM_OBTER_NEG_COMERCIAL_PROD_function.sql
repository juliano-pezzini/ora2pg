-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION com_obter_neg_comercial_prod ( dt_mes_inicio_p timestamp, dt_mes_fim_p timestamp, dt_mes_p timestamp, nr_seq_canal_p bigint, ie_opcao_p text, ie_tipo_prod_p text) RETURNS bigint AS $body$
DECLARE


			/*
ie_tipo_prod_p
A	- Ambos
O	- Operadora
P	- Prestador

ie_opcao_p

1	- Vl LUT prevista
2	- Vl CDU prevista
3	- Vl Atualização mensal prevista
4	- Vl LUT real
5	- Vl CDU real
6	- Vl Atualização mensal real
7	- Pr real LUT
8	- Pr real CDU
9	- Pr real Atualização mensal

*/
nr_seq_cliente_w		bigint;

vl_lic_prev_lut_w		double precision	:= 0;
vl_lic_prev_cdu_w		double precision	:= 0;
vl_lic_prev_am_w		double precision	:= 0;
vl_lic_real_lut_w		double precision	:= 0;
vl_lic_real_cdu_w		double precision	:= 0;
vl_lic_real_am_w		double precision	:= 0;
pr_lic_real_lut_w		double precision	:= 0;
pr_lic_real_cdu_w		double precision	:= 0;
pr_lic_real_am_w		double precision	:= 0;



BEGIN

if (ie_tipo_prod_p = 'P') then /*  Prestador */
	/* Valores previstos */

	select	sum(CASE WHEN b.nr_sequencia=1 THEN  coalesce(a.vl_licenca,0)  ELSE 0 END ) vl_lic_prev_cdu,
		sum(CASE WHEN b.nr_sequencia=7 THEN  coalesce(a.vl_licenca,0)  ELSE 0 END ) vl_lic_prev_am
	into STRICT	vl_lic_prev_cdu_w,
		vl_lic_prev_am_w
	from	com_modalidade_lic b,
		com_meta_venda a
	where	a.nr_seq_mod_licenc = b.nr_sequencia
	and (a.nr_seq_canal = nr_seq_canal_p or coalesce(nr_seq_canal_p,0) = 0)
	and	trunc(a.dt_mes_ref,'month') = trunc(dt_mes_p,'month')
	and	b.nr_sequencia in (1,7);

	/*  LUT */

	select	sum(CASE WHEN b.nr_sequencia=2 THEN  coalesce(a.vl_licenca,0)  ELSE 0 END ) vl_lic_prev_lut
	into STRICT	vl_lic_prev_lut_w
	from	com_modalidade_lic b,
		com_meta_venda a
	where	a.nr_seq_mod_licenc = b.nr_sequencia
	and (a.nr_seq_canal = nr_seq_canal_p or coalesce(nr_seq_canal_p,0) = 0)
	and	trunc(a.dt_mes_ref,'month') between trunc(dt_mes_inicio_p,'month') and trunc(dt_mes_p,'month')
	and	b.nr_sequencia = 2;

	/* Valores realizados */

	/*  LUT */

	select	sum(CASE WHEN b.nr_sequencia=2 THEN  a.vl_total  ELSE 0 END ) vl_lic_real_lut
	into STRICT	vl_lic_real_lut_w
	from	com_modalidade_lic b,
		com_cli_neg_lic d,
		com_cli_neg_lic_item a
	where	a.nr_seq_mod_licenc 	= b.nr_sequencia
	and	d.nr_sequencia 		= a.nr_seq_neg_lic
	and (a.nr_seq_canal 	= nr_seq_canal_p or coalesce(nr_seq_canal_p,0) = 0)
	and	trunc(a.dt_inicio_venc,'month') between trunc(dt_mes_inicio_p,'month') and trunc(dt_mes_p,'month')
	and	b.nr_sequencia = 2;

	/*  CDU */

	select	sum(vl_lic_real_cdu) vl_lic_real_cdu
	into STRICT	vl_lic_real_cdu_w
	from	(	SELECT	sum(CASE WHEN b.nr_sequencia=1 THEN  a.vl_total  ELSE 0 END ) vl_lic_real_cdu
			from	com_modalidade_lic b,
				com_cli_neg_lic d,
				com_cli_neg_lic_item a
			where	a.nr_seq_mod_licenc 	= b.nr_sequencia
			and	d.nr_sequencia 		= a.nr_seq_neg_lic
			and (a.nr_seq_canal 	= nr_seq_canal_p or coalesce(nr_seq_canal_p,0) = 0)
			and	trunc(a.dt_inicio_venc,'month') = trunc(dt_mes_p,'month')
			and	b.nr_sequencia = 1
			and	not exists (	select	1
						from	com_cli_neg_lic_parc x
						where	d.nr_sequencia = x.nr_seq_negoc_lic)
			
union all

			SELECT	sum(coalesce(c.vl_parcela,0)) vl_lic_real_cdu
			from	com_modalidade_lic b,
				com_cli_neg_lic d,
				com_cli_neg_lic_item a,
				com_cli_neg_lic_parc c
			where	a.nr_seq_mod_licenc = b.nr_sequencia
			and	d.nr_sequencia = c.nr_seq_negoc_lic
			and	d.nr_sequencia = a.nr_seq_neg_lic
			and	((a.nr_seq_canal = nr_seq_canal_p) or (coalesce(nr_seq_canal_p,0) = 0))
			and	trunc(c.dt_vencimento,'month') = trunc(dt_mes_p,'month')
			and	c.ie_origem_valor = 1) alias15;

	/*  Manutenção mensal */

	select	sum(CASE WHEN b.nr_sequencia=1 THEN  a.vl_manut_mensal  ELSE 0 END ) vl_lic_real_am
	into STRICT	vl_lic_real_am_w
	from	com_modalidade_lic b,
		com_cli_neg_lic d,
		com_cli_neg_lic_item a
	where	a.nr_seq_mod_licenc 	= b.nr_sequencia
	and	d.nr_sequencia 		= a.nr_seq_neg_lic
	and (a.nr_seq_canal 	= nr_seq_canal_p or coalesce(nr_seq_canal_p,0) = 0)
	and	trunc(a.dt_inicio_venc_manut,'month') between trunc(dt_mes_inicio_p,'month') and trunc(dt_mes_p,'month')
	and	b.nr_sequencia = 1;

elsif (ie_tipo_prod_p = 'O') then /*  Operadora */
	/* Valores previstos */

	select	sum(CASE WHEN b.nr_sequencia=6 THEN  coalesce(a.vl_licenca,0)  ELSE 0 END ) vl_lic_prev_cdu,
		sum(CASE WHEN b.nr_sequencia=8 THEN  coalesce(a.vl_licenca,0)  ELSE 0 END ) vl_lic_prev_am
	into STRICT	vl_lic_prev_cdu_w,
		vl_lic_prev_am_w
	from	com_modalidade_lic b,
		com_meta_venda a
	where	a.nr_seq_mod_licenc = b.nr_sequencia
	and (a.nr_seq_canal = nr_seq_canal_p or coalesce(nr_seq_canal_p,0) = 0)
	and	trunc(a.dt_mes_ref,'month') = trunc(dt_mes_p,'month')
	and	b.nr_sequencia in (6,8);

	/*  LUT */

	select	sum(CASE WHEN b.nr_sequencia=5 THEN  coalesce(a.vl_licenca,0)  ELSE 0 END ) vl_lic_prev_lut
	into STRICT	vl_lic_prev_lut_w
	from	com_modalidade_lic b,
		com_meta_venda a
	where	a.nr_seq_mod_licenc = b.nr_sequencia
	and (a.nr_seq_canal = nr_seq_canal_p or coalesce(nr_seq_canal_p,0) = 0)
	and	trunc(a.dt_mes_ref,'month') between trunc(dt_mes_inicio_p,'month') and trunc(dt_mes_p,'month')
	and	b.nr_sequencia = 5;

	/* Valores realizados */

	/*  LUT */

	select	sum(CASE WHEN b.nr_sequencia=5 THEN  a.vl_total  ELSE 0 END ) vl_lic_real_lut
	into STRICT	vl_lic_real_lut_w
	from	com_modalidade_lic b,
		com_cli_neg_lic d,
		com_cli_neg_lic_item a
	where	a.nr_seq_mod_licenc 	= b.nr_sequencia
	and	d.nr_sequencia 		= a.nr_seq_neg_lic
	and (a.nr_seq_canal 	= nr_seq_canal_p or coalesce(nr_seq_canal_p,0) = 0)
	and	trunc(a.dt_inicio_venc,'month') between trunc(dt_mes_inicio_p,'month') and trunc(dt_mes_p,'month')
	and	b.nr_sequencia = 5;

	/*  CDU */

	select	sum(CASE WHEN b.nr_sequencia=6 THEN  a.vl_total  ELSE 0 END ) vl_lic_real_cdu
	into STRICT	vl_lic_real_cdu_w
	from	com_modalidade_lic b,
		com_cli_neg_lic d,
		com_cli_neg_lic_item a
	where	a.nr_seq_mod_licenc 	= b.nr_sequencia
	and	d.nr_sequencia 		= a.nr_seq_neg_lic
	and (a.nr_seq_canal 	= nr_seq_canal_p or coalesce(nr_seq_canal_p,0) = 0)
	and	trunc(a.dt_inicio_venc,'month') = trunc(dt_mes_p,'month')
	and	b.nr_sequencia = 6;

	/*  Manutenção mensal */

	select	sum(CASE WHEN b.nr_sequencia=6 THEN  a.vl_manut_mensal  ELSE 0 END ) vl_lic_real_am
	into STRICT	vl_lic_real_am_w
	from	com_modalidade_lic b,
		com_cli_neg_lic d,
		com_cli_neg_lic_item a
	where	a.nr_seq_mod_licenc 	= b.nr_sequencia
	and	d.nr_sequencia 		= a.nr_seq_neg_lic
	and (a.nr_seq_canal 	= nr_seq_canal_p or coalesce(nr_seq_canal_p,0) = 0)
	and	trunc(a.dt_inicio_venc_manut,'month') between trunc(dt_mes_inicio_p,'month') and trunc(dt_mes_p,'month')
	and	b.nr_sequencia = 6;

end if;

if (vl_lic_prev_lut_w <> 0) then
	pr_lic_real_lut_w := (vl_lic_real_lut_w * 100) / vl_lic_prev_lut_w;
end if;
if (vl_lic_prev_cdu_w <> 0) then
	pr_lic_real_cdu_w := (vl_lic_real_cdu_w * 100) / vl_lic_prev_cdu_w;
end if;
if (vl_lic_prev_am_w <> 0) then
	pr_lic_real_am_w  := (vl_lic_real_am_w * 100) / vl_lic_prev_am_w;
end if;

if (ie_opcao_p = '1') then
	return vl_lic_prev_lut_w;
elsif (ie_opcao_p = '2') then
	return vl_lic_prev_cdu_w;
elsif (ie_opcao_p = '3') then
	return vl_lic_prev_am_w;
elsif (ie_opcao_p = '4') then
	return vl_lic_real_lut_w;
elsif (ie_opcao_p = '5') then
	return vl_lic_real_cdu_w;
elsif (ie_opcao_p = '6') then
	return vl_lic_real_am_w;
elsif (ie_opcao_p = '7') then
	return pr_lic_real_lut_w;
elsif (ie_opcao_p = '8') then
	return pr_lic_real_cdu_w;
elsif (ie_opcao_p = '9') then
	return pr_lic_real_am_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION com_obter_neg_comercial_prod ( dt_mes_inicio_p timestamp, dt_mes_fim_p timestamp, dt_mes_p timestamp, nr_seq_canal_p bigint, ie_opcao_p text, ie_tipo_prod_p text) FROM PUBLIC;

