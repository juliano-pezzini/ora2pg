-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_uso_qtde_proc ( nr_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, qt_procedimento_p bigint, cd_medico_p text, cd_setor_atendimento_p bigint, dt_procedimento_p timestamp, ie_opcao_p text, nr_seq_procedimento_p bigint, ie_via_acesso_p text, nr_interno_conta_p bigint, nr_seq_proc_interno_p bigint, cd_categoria_p text, cd_plano_p text, nr_seq_exame_p bigint) RETURNS varchar AS $body$
DECLARE


/*
ie_opcao_p		1 - IE_ACAO_EXCESSO
			2 - QT_EXCEDIDA
			3 - DS_ERRO
*/
ds_retorno_w			varchar(255);
nr_atendimento_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ie_acao_excesso_w		varchar(5);
ds_erro_w				varchar(255);
cd_convenio_w			integer;
ie_tipo_atendimento_w	smallint;
qt_permitida_w			double precision;
qt_horas_intervalo_w	integer;
qt_registros_w			integer;
dt_procedimento_w		timestamp;
qt_procedimento_w		double precision;
qt_executada_w			double precision;
qt_executada_dia_w		double precision;
qt_executada_mes_w		double precision;
qt_executada_ano_w		double precision;
qt_executada_atend_w	double precision;
qt_exec_conta_w			double precision	:= 0;
qt_executada_periodo_w	double precision;
qt_executada_conta_w	double precision	:= 0;
qt_exec_total_conta_w	double precision	:= 0;
qt_excedida_w			double precision	:= 0;
nr_seq_regra_uso_w		bigint;
ds_procedimento_w		varchar(254);
ie_tipo_qtde_w			varchar(01);
ie_tipo_uso_w			varchar(01);
cd_proc_referencia_w	bigint;
ie_origem_proc_refer_w	bigint;
pr_permitida_w			double precision;
cd_grupo_mat_w			smallint;
cd_subgrupo_mat_w		smallint;
cd_classe_mat_w			integer;
cd_material_w			bigint;
cd_area_procedimento_w	bigint;
cd_especialidade_w		bigint;
cd_grupo_proc_w			bigint;
nr_seq_grupo_w			bigint;
nr_seq_subgrupo_w		bigint;
nr_seq_forma_org_w		bigint;
ie_via_acesso_w			varchar(1);
ie_complexidade_w		varchar(2);
ie_tipo_financiamento_w	varchar(4);
nr_seq_proc_interno_w	bigint;
cd_pessoa_fisica_w		varchar(10);
qt_exec_paciente_w		bigint;
nr_seq_exame_w			bigint;
qt_dias_internacao_w	bigint;
cd_tipo_acomod_w		smallint;
ds_mensagem_w			varchar(255);
qt_exec_pac_mes_w		bigint;
qt_idade_w				double precision;
qt_executada_aih_w		bigint;
nr_seq_procedimento_w	procedimento_paciente.nr_sequencia%type;
ie_estrutura_proc_w	convenio_regra_qtde_proc.ie_estrutura_proc%type;

c01 CURSOR FOR
	SELECT 	a.qt_permitida,
			a.ie_acao_excesso,
			a.qt_horas_intervalo,
			a.ie_tipo_qtde,
			a.ie_tipo_uso,
			a.cd_proced_referencia,
			a.ie_origem_proc_ref,
			a.pr_permitida,
			a.nr_sequencia,
			a.ie_via_acesso,
			a.nr_seq_proc_interno,
			a.nr_seq_exame,
			a.ds_mensagem,
			a.ie_estrutura_proc
	from 	convenio_regra_qtde_proc a
	where	coalesce(a.cd_procedimento, cd_procedimento_p)		= cd_procedimento_p
	and	coalesce(a.ie_origem_proced, ie_origem_proced_p)		= ie_origem_proced_p
	and	coalesce(cd_area_procedimento, cd_area_procedimento_w)	= cd_area_procedimento_w
	and	coalesce(cd_especialidade, cd_especialidade_w)		= cd_especialidade_w
	and	coalesce(cd_grupo_proc, cd_grupo_proc_w)			= cd_grupo_proc_w
	and	coalesce(nr_seq_grupo, nr_seq_grupo_w)			= nr_seq_grupo_w
	and	coalesce(nr_seq_subgrupo, nr_seq_subgrupo_w)			= nr_seq_subgrupo_w
	and	coalesce(nr_seq_forma_org, nr_seq_forma_org_w)		= nr_seq_forma_org_w
	and	coalesce(ie_complexidade, coalesce(ie_complexidade_w,'0'))	= coalesce(ie_complexidade_w,'0')
	and	coalesce(ie_tipo_financiamento, coalesce(ie_tipo_financiamento_w,'0'))	= coalesce(ie_tipo_financiamento_w,'0')
	and	a.cd_convenio = cd_convenio_w
	and (a.cd_medico = cd_medico_p or coalesce(cd_medico::text, '') = '')
	and (a.ie_tipo_atendimento = ie_tipo_atendimento_w or coalesce(ie_tipo_atendimento::text, '') = '')
	and	(((coalesce(ie_tipo_setor,'A') = 'A') and (a.cd_setor_atendimento = cd_setor_atendimento_p or coalesce(cd_setor_atendimento::text, '') = '')) or
		((coalesce(ie_tipo_setor,'A') = 'P') and (a.cd_setor_atendimento = obter_setor_atendimento(nr_atendimento_p) or coalesce(cd_setor_atendimento::text, '') = '')))
	and 	((a.ie_via_acesso = ie_via_acesso_p) or (coalesce(a.ie_via_acesso::text, '') = ''))
	and	coalesce(a.nr_seq_proc_interno,coalesce(nr_seq_proc_interno_p,0)) = coalesce(nr_seq_proc_interno_p,0)
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0')) = coalesce(cd_categoria_p,'0')
	and	coalesce(a.cd_plano,coalesce(cd_plano_p,'0')) = coalesce(cd_plano_p,'0')	
	and	coalesce(nr_seq_exame,coalesce(nr_seq_exame_p,0)) = coalesce(nr_seq_exame_p,0)
	and	coalesce(cd_estabelecimento, coalesce(wheb_usuario_pck.get_cd_estabelecimento,0)) = coalesce(wheb_usuario_pck.get_cd_estabelecimento,0)
	and	qt_dias_internacao_w between coalesce(qt_dias_inter_inicio, qt_dias_internacao_w) and coalesce(qt_dias_inter_final, qt_dias_internacao_w)
	and	coalesce(qt_idade_w,1) between coalesce(obter_idade_regra_uso(a.nr_sequencia,'MIN','P'),0) and coalesce(obter_idade_regra_uso(a.nr_sequencia,'MAX','P'),9999999)
	and	coalesce(cd_tipo_acomodacao, coalesce(cd_tipo_acomod_w,0)) = coalesce(cd_tipo_acomod_w,0)
	and	coalesce(a.ie_situacao,'A') = 'A'
	and	coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) = coalesce(obter_perfil_ativo, 0)
	order by 	coalesce(cd_procedimento,0),
		 	coalesce(cd_grupo_proc,0),
	 		coalesce(cd_especialidade,0),
	 		coalesce(cd_area_procedimento,0),
			coalesce(a.ie_tipo_atendimento,'0'),
			coalesce(a.cd_setor_atendimento,'0'),
			coalesce(a.cd_medico,'0'),
			coalesce(ie_complexidade,'0'),
			coalesce(ie_tipo_financiamento,'0'),
			coalesce(a.nr_seq_exame,0),
			coalesce(cd_estabelecimento,0),
			coalesce(cd_perfil, 0);

c02 CURSOR FOR
	/* Obter Estrutura do material */

	SELECT	b.cd_grupo_material,
			b.cd_subgrupo_material,
			b.cd_classe_material,
			b.cd_material
	from	estrutura_material_v	b,
			material_atend_paciente	a
	where	a.cd_material		= b.cd_material
	and		a.nr_atendimento	= nr_atendimento_p
	and		coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and		(a.nr_interno_conta IS NOT NULL AND a.nr_interno_conta::text <> '');


BEGIN

nr_seq_procedimento_w	:= nr_seq_procedimento_p;

ds_erro_w		:= '';
ie_acao_excesso_w	:= '';

ie_complexidade_w	:= sus_obter_complexidade_proced(cd_procedimento_p, ie_origem_proced_p, 'C');
ie_tipo_financiamento_w	:= obter_tipo_financ_proc(cd_procedimento_p, ie_origem_proced_p, 1);

begin
select	cd_area_procedimento,
		cd_especialidade,
		cd_grupo_proc
into STRICT	cd_area_procedimento_w,
		cd_especialidade_w,
		cd_grupo_proc_w
from	estrutura_procedimento_v
where	cd_procedimento		= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_p;
exception
	when others then
	-- Problema no procedimento: #@CD_PROCEDIMENTO#@ - #@IE_ORIGEM_PROCED#@
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(185344,'CD_PROCEDIMENTO=' || cd_procedimento_p || ';IE_ORIGEM_PROCED=' || ie_origem_proced_p);
end;

/* Obter a estrutura de procedimento SUS Unificado*/

begin
select	nr_seq_grupo,
		nr_seq_subgrupo,
		nr_seq_forma_org
into STRICT	nr_seq_grupo_w,
		nr_seq_subgrupo_w,
		nr_seq_forma_org_w
from	sus_estrutura_procedimento_v
where	cd_procedimento		= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_p;
exception
	when others then
	nr_seq_grupo_w		:= 0;
	nr_seq_subgrupo_w	:= 0;
	nr_seq_forma_org_w	:= 0;
end;

select	count(*)
into STRICT	qt_registros_w
from	convenio_regra_qtde_proc where		coalesce(cd_procedimento, cd_procedimento_p)			= cd_procedimento_p
and		coalesce(cd_area_procedimento, cd_area_procedimento_w)	= cd_area_procedimento_w
and		coalesce(cd_especialidade, cd_especialidade_w)		= cd_especialidade_w
and		coalesce(cd_grupo_proc, cd_grupo_proc_w)			= cd_grupo_proc_w
and		coalesce(nr_seq_grupo, nr_seq_grupo_w)			= nr_seq_grupo_w
and		coalesce(nr_seq_subgrupo, nr_seq_subgrupo_w)			= nr_seq_subgrupo_w
and		coalesce(nr_seq_forma_org, nr_seq_forma_org_w)		= nr_seq_forma_org_w
and		coalesce(nr_seq_proc_interno,coalesce(nr_seq_proc_interno_p,0)) 	= coalesce(nr_seq_proc_interno_p,0)
and		coalesce(cd_categoria,coalesce(cd_categoria_p,'0'))		= coalesce(cd_categoria_p,'0')
and		coalesce(cd_plano,coalesce(cd_plano_p,'0'))			= coalesce(cd_plano_p,'0')
and		coalesce(nr_seq_exame,coalesce(nr_seq_exame_p,0)) = coalesce(nr_seq_exame_p,0)
and		coalesce(ie_situacao,'A') = 'A' LIMIT 1;

if (qt_registros_w	> 0) then
	begin
	
	cd_convenio_w		:= coalesce(obter_convenio_atendimento(nr_atendimento_p),0);
	cd_tipo_acomod_w	:= coalesce((obter_tipo_acomod_atend(nr_atendimento_p,'C'))::numeric ,0);

	select 	coalesce(max(ie_tipo_atendimento),0),
			coalesce(trunc(max(coalesce(dt_alta, clock_timestamp()) - dt_entrada)),0),
			max(cd_pessoa_fisica)
	into STRICT	ie_tipo_atendimento_w,
			qt_dias_internacao_w,
			cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento	= nr_atendimento_p;
	
	begin
	select	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA'))	
	into STRICT	qt_idade_w	
	from	pessoa_fisica b
	where	b.cd_pessoa_fisica	= cd_pessoa_fisica_w;
	exception
	when others then
		qt_idade_w	:= 0;
	end;

	exception
		when others then
			ie_tipo_qtde_w  :=  'X';
	end;

	OPEN C01;
	LOOP
	FETCH C01 into
		qt_permitida_w,
		ie_acao_excesso_w,
		qt_horas_intervalo_w,
		ie_tipo_qtde_w,
		ie_tipo_uso_w,
		cd_proc_referencia_w,
		ie_origem_proc_refer_w,
		pr_permitida_w,
		nr_seq_regra_uso_w,
		ie_via_acesso_w,
		nr_seq_proc_interno_w,
		nr_seq_exame_w,
		ds_mensagem_w,
		ie_estrutura_proc_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		qt_permitida_w		:= qt_permitida_w;
		ie_acao_excesso_w	:= ie_acao_excesso_w;
		qt_horas_intervalo_w	:= qt_horas_intervalo_w;
		ie_tipo_qtde_w		:= ie_tipo_qtde_w;
		nr_seq_regra_uso_w	:= nr_seq_regra_uso_w;
		end;
	END LOOP;
	CLOSE C01;

	if (ie_tipo_qtde_w <> 'X') then

		select 	coalesce(max(a.qt_procedimento),0),
			coalesce(max(a.dt_procedimento), clock_timestamp()),
			max(b.ds_procedimento)
		into STRICT	qt_executada_w,
			dt_procedimento_w,
			ds_procedimento_w
		from	procedimento b,
			procedimento_paciente a
		where	a.cd_procedimento	= b.cd_procedimento
		and	a.ie_origem_proced	= b.ie_origem_proced
		and	nr_sequencia		= 0;
	end if;

	-- TIPO DE USO: Quantidade
	if (ie_tipo_uso_w	= 'Q') then
		begin
		
		-- Dia
		if (ie_tipo_qtde_w = 'D') then
		
			if (coalesce(ie_estrutura_proc_w,0) = 'S') then

				select 	coalesce(sum(p.qt_procedimento),0)
				into STRICT	qt_executada_dia_w
				from	procedimento_paciente p,
					estrutura_procedimento_v b
				where	p.cd_procedimento  	= b.cd_procedimento
				and	p.ie_origem_proced  	= b.ie_origem_proced 	
				and	p.nr_atendimento		= nr_atendimento_p
				and	p.ie_origem_proced	= ie_origem_proced_p
				and	(p.nr_interno_conta IS NOT NULL AND p.nr_interno_conta::text <> '')
				and	p.nr_sequencia		<> nr_seq_procedimento_w
				and	pkg_date_utils.get_time(p.dt_procedimento,0,0,0)		= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)
				and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') 	or (p.ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') 	or (p.nr_seq_proc_interno 	= nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') 		or (p.nr_seq_exame 	= nr_seq_exame_w))
				and 	b.cd_procedimento		= coalesce(cd_procedimento_w,b.cd_procedimento)
				and 	b.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, b.cd_area_procedimento)
				and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
				and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);
			else
				select 	coalesce(sum(qt_procedimento),0)
				into STRICT	qt_executada_dia_w
				from	procedimento_paciente
				where	nr_atendimento		= nr_atendimento_p
				and	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= ie_origem_proced_p
				and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
				and	nr_sequencia		<> nr_seq_procedimento_w
				and	pkg_date_utils.get_time(dt_procedimento,0,0,0)	= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)
				and	coalesce(cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));
			
			end if;

			if	((qt_executada_dia_w + qt_procedimento_p)  > qt_permitida_w) then
				qt_excedida_w	:= qt_executada_dia_w - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297765); --'Ultrapassou a quantidade maxima do dia';
			end if;

		-- Todos atendimentos no dia
		elsif (ie_tipo_qtde_w = 'T') then

			if (coalesce(ie_estrutura_proc_w,0) = 'S') then
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_executada_dia_w
				from	conta_paciente b,
					procedimento_paciente a,
					estrutura_procedimento_v e
				where	a.nr_atendimento		= b.nr_atendimento
				and	a.cd_procedimento		= e.cd_procedimento
				and	a.ie_origem_proced  	= e.ie_origem_proced 				
				and	a.ie_origem_proced	= ie_origem_proced_p
				and	pkg_date_utils.get_time(a.dt_procedimento,0,0,0)	= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)
				and	b.cd_convenio_parametro		= cd_convenio_w
				and	nr_sequencia			<> nr_seq_procedimento_w
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (a.ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w))
				and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento)
				and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
				and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
				and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);
			else
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_executada_dia_w
				from	conta_paciente b,
					procedimento_paciente a
				where	a.nr_atendimento		= b.nr_atendimento
				and	a.cd_procedimento		= cd_procedimento_p
				and	a.ie_origem_proced		= ie_origem_proced_p
				and	pkg_date_utils.get_time(a.dt_procedimento,0,0,0)	= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)
				and	b.cd_convenio_parametro		= cd_convenio_w
				and	nr_sequencia			<> nr_seq_procedimento_w
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (a.ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));
			end if;
			

			if	((qt_executada_dia_w + qt_procedimento_p)  >= qt_permitida_w) then
				qt_excedida_w	:= qt_executada_dia_w - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297765); --'Ultrapassou a quantidade maxima do dia';
			end if;

		-- Mes
		elsif (ie_tipo_qtde_w = 'M') then

			if (coalesce(ie_estrutura_proc_w,0) = 'S') then
				select 	coalesce(sum(p.qt_procedimento),0)
				into STRICT	qt_executada_mes_w
				from	procedimento_paciente p,
					estrutura_procedimento_v e
				where	p.nr_atendimento		= nr_atendimento_p
				and	p.cd_procedimento		= e.cd_procedimento
				and	p.ie_origem_proced  	= e.ie_origem_proced
				and	p.ie_origem_proced	= ie_origem_proced_p
				and	(p.nr_interno_conta IS NOT NULL AND p.nr_interno_conta::text <> '')
				and	PKG_DATE_UTILS.start_of(p.dt_procedimento, 'month',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'month',0)
				and	p.nr_sequencia		<> nr_seq_procedimento_w
				and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (p.ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (p.nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (p.nr_seq_exame = nr_seq_exame_w))
				and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
				and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
				and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
				and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);
				
			else
				select 	coalesce(sum(qt_procedimento),0)
				into STRICT	qt_executada_mes_w
				from	procedimento_paciente
				where	nr_atendimento		= nr_atendimento_p
				and	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= ie_origem_proced_p
				and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
				and	PKG_DATE_UTILS.start_of(dt_procedimento, 'month',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'month',0)
				and	nr_sequencia		<> nr_seq_procedimento_w
				and	coalesce(cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));
			end if;	
		

			if	((qt_executada_mes_w + qt_procedimento_p)  >= qt_permitida_w) then
				qt_excedida_w	:= qt_executada_mes_w - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297766); --'Ultrapassou a quantidade maxima do mes';
			end if;

		-- Ano
		elsif (ie_tipo_qtde_w = 'Y') then

			if (coalesce(ie_estrutura_proc_w,0) = 'S') then
				select 	coalesce(sum(p.qt_procedimento),0)
				into STRICT	qt_executada_ano_w
				from	procedimento_paciente p,
					estrutura_procedimento_v e
				where	p.nr_atendimento		= nr_atendimento_p
				and	p.cd_procedimento		= e.cd_procedimento
				and	p.ie_origem_proced  	= e.ie_origem_proced
				and	p.ie_origem_proced	= ie_origem_proced_p
				and	(p.nr_interno_conta IS NOT NULL AND p.nr_interno_conta::text <> '')
				and	PKG_DATE_UTILS.start_of(p.dt_procedimento, 'Year',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'Year',0)
				and	p.nr_sequencia		<> nr_seq_procedimento_w
				and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (p.ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (p.nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (p.nr_seq_exame = nr_seq_exame_w))
				and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
				and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
				and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
				and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);
			else	
				select 	coalesce(sum(qt_procedimento),0)
				into STRICT	qt_executada_ano_w
				from	procedimento_paciente
				where	nr_atendimento		= nr_atendimento_p
				and	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= ie_origem_proced_p
				and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
				and	PKG_DATE_UTILS.start_of(dt_procedimento, 'Year',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'Year',0)
				and	nr_sequencia		<> nr_seq_procedimento_w
				and	coalesce(cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));
			end if;


			if	((qt_executada_ano_w + qt_procedimento_p)  >= qt_permitida_w) then
				qt_excedida_w	:= qt_executada_ano_w - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297779); --'Ultrapassou a quantidade maxima do ano';
			end if;

		-- Todos atendimentos no mes
		elsif (ie_tipo_qtde_w = 'Z') then

			if (coalesce(ie_estrutura_proc_w,0) = 'S') then
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_executada_mes_w
				from	conta_paciente b,
					procedimento_paciente a,
					estrutura_procedimento_v e
				where	a.nr_atendimento			= b.nr_atendimento
				and	a.cd_procedimento			= e.cd_procedimento
				and	a.ie_origem_proced  		= e.ie_origem_proced
				and	a.ie_origem_proced		= ie_origem_proced_p
				and	b.cd_convenio_parametro		= cd_convenio_w
				and	PKG_DATE_UTILS.start_of(a.dt_procedimento, 'month',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'month',0)
				and	nr_sequencia		<> nr_seq_procedimento_w
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (a.ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
				and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
				and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
				and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
				and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);
			else
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_executada_mes_w
				from	conta_paciente b,
					procedimento_paciente a
				where	a.nr_atendimento			= b.nr_atendimento
				and	a.cd_procedimento			= cd_procedimento_p
				and	a.ie_origem_proced			= ie_origem_proced_p
				and	b.cd_convenio_parametro		= cd_convenio_w
				and	PKG_DATE_UTILS.start_of(a.dt_procedimento, 'month',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'month',0)
				and	nr_sequencia		<> nr_seq_procedimento_w
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (a.ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));			
			end if;


			if	((qt_executada_mes_w + qt_procedimento_p)  >= qt_permitida_w) then
				qt_excedida_w	:= qt_executada_mes_w - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297766); --'Ultrapassou a quantidade maxima do mes'
			end if;

		-- Atendimento
		elsif (ie_tipo_qtde_w = 'A') then

			if (coalesce(ie_estrutura_proc_w,0) = 'S') then
				select 	coalesce(sum(p.qt_procedimento),0)
				into STRICT	qt_executada_atend_w
				from	procedimento_paciente p,
					estrutura_procedimento_v e
				where	p.nr_atendimento		= nr_atendimento_p
				and	p.cd_procedimento		= e.cd_procedimento
				and	p.ie_origem_proced  	= e.ie_origem_proced
				and	p.ie_origem_proced	= ie_origem_proced_p
				and	p.nr_sequencia		<> nr_seq_procedimento_w
				and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (p.ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (p.nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (p.nr_seq_exame = nr_seq_exame_w))
				and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
				and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
				and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
				and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);
			else
				select 	coalesce(sum(qt_procedimento),0)
				into STRICT	qt_executada_atend_w
				from	procedimento_paciente
				where	nr_atendimento		= nr_atendimento_p
				and	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= ie_origem_proced_p
				and	nr_sequencia		<> nr_seq_procedimento_w
				and	coalesce(cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));
			end if;

	
			if	((qt_executada_atend_w + qt_procedimento_p) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_executada_atend_w + qt_procedimento_p) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297767); --'Ultrapassou a quantidade maxima do atendimento'
	
			end if;

		-- Conta
		elsif (ie_tipo_qtde_w = 'C') then

			if (coalesce(ie_estrutura_proc_w,0) = 'S') then
				select 	coalesce(sum(p.qt_procedimento),0)
				into STRICT	qt_exec_conta_w
				from	procedimento_paciente p,
					estrutura_procedimento_v e
				where	p.nr_interno_conta	= nr_interno_conta_p
				and	p.cd_procedimento		= e.cd_procedimento
				and	p.ie_origem_proced  	= e.ie_origem_proced
				and	p.ie_origem_proced	= ie_origem_proced_p
				and	p.nr_sequencia		<> nr_seq_procedimento_w
				and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
				and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
				and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
				and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
				and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);				
			else
				select 	coalesce(sum(qt_procedimento),0)
				into STRICT	qt_exec_conta_w
				from	procedimento_paciente
				where	nr_interno_conta	= nr_interno_conta_p
				and		cd_procedimento		= cd_procedimento_p
				and		ie_origem_proced	= ie_origem_proced_p
				and		nr_sequencia		<> nr_seq_procedimento_w
				and		coalesce(cd_motivo_exc_conta::text, '') = '';	
			end if;
	
			if	((qt_exec_conta_w + qt_procedimento_p) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_exec_conta_w + qt_procedimento_p) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297780); --'Ultrapassou a quantidade maxima permitida por conta';
	
			end if;

		-- Paciente
		elsif (ie_tipo_qtde_w = 'P') then

			select 	coalesce(max(cd_pessoa_fisica),'0')
			into STRICT	cd_pessoa_fisica_w
			from 	atendimento_paciente
			where 	nr_atendimento = nr_atendimento_p;
		
			if (coalesce(ie_estrutura_proc_w,0) = 'S') then
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_exec_paciente_w
				from	procedimento_paciente 	a,
					conta_paciente		b,
					atendimento_paciente	c,
					estrutura_procedimento_v 	e
				where	b.nr_interno_conta 	= a.nr_interno_conta
				and 	c.nr_atendimento		= b.nr_atendimento
				and 	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
				and	a.cd_procedimento		= e.cd_procedimento
				and	a.ie_origem_proced  	= e.ie_origem_proced
				and	a.ie_origem_proced	= ie_origem_proced_p
				and	a.nr_sequencia		<> nr_seq_procedimento_w
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
				and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
				and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
				and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);				
			else
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_exec_paciente_w
				from	procedimento_paciente 	a,
					conta_paciente		b,
					atendimento_paciente	c
				where	b.nr_interno_conta 	= a.nr_interno_conta
				and 	c.nr_atendimento	= b.nr_atendimento
				and 	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
				and	a.cd_procedimento	= cd_procedimento_p
				and	a.ie_origem_proced	= ie_origem_proced_p
				and	a.nr_sequencia		<> nr_seq_procedimento_w
				and	coalesce(a.cd_motivo_exc_conta::text, '') = '';				
			end if;
	
			if	((qt_exec_paciente_w + qt_procedimento_p) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_exec_paciente_w + qt_procedimento_p) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297781); -- 'Ultrapassou a quantidade maxima permitida para o paciente';  
	
			end if;

		-- Horas (periodo)
		elsif (ie_tipo_qtde_w = 'H') then

			if (coalesce(ie_estrutura_proc_w,0) = 'S') then
				select 	coalesce(sum(p.qt_procedimento),0)
				into STRICT	qt_executada_periodo_w
				from	procedimento_paciente p,
					estrutura_procedimento_v 	e
				where	p.nr_atendimento		= nr_atendimento_p
				and	p.cd_procedimento		= e.cd_procedimento
				and	p.ie_origem_proced  	= e.ie_origem_proced
				and	p.ie_origem_proced	= ie_origem_proced_p
				and	p.nr_sequencia		<> nr_seq_procedimento_w
				and	p.dt_procedimento between
					(dt_procedimento_p - (qt_horas_intervalo_w * 60 /1440)) and dt_procedimento_p
				and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (p.ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (p.nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (p.nr_seq_exame = nr_seq_exame_w))
				and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
				and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
				and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
				and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);	
			else
				select 	coalesce(sum(qt_procedimento),0)
				into STRICT	qt_executada_periodo_w
				from	procedimento_paciente
				where	nr_atendimento		= nr_atendimento_p
				and	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= ie_origem_proced_p
				and	nr_sequencia		<> nr_seq_procedimento_w
				and	dt_procedimento between
					(dt_procedimento_p - (qt_horas_intervalo_w * 60 /1440)) and dt_procedimento_p
				and	coalesce(cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));
			end if;


			if	((qt_executada_periodo_w + qt_procedimento_p) > qt_permitida_w) then
				qt_excedida_w	:= qt_executada_periodo_w - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297768); --'Ultrapassou a quantidade maxima por periodo';
			end if;

		-- Setor
		elsif (ie_tipo_qtde_w = 'S') then
			
			if (coalesce(ie_estrutura_proc_w,0) = 'S') then
				select 	coalesce(sum(p.qt_procedimento),0)
				into STRICT	qt_executada_atend_w
				from	procedimento_paciente p,
					estrutura_procedimento_v e
				where	p.nr_atendimento		= nr_atendimento_p
				and	p.cd_procedimento		= e.cd_procedimento
				and	p.ie_origem_proced  	= e.ie_origem_proced
				and	p.ie_origem_proced	= ie_origem_proced_p
				and	p.nr_sequencia		<> nr_seq_procedimento_w
				and	p.cd_setor_atendimento	= cd_setor_atendimento_p
				and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (p.ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (p.nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (p.nr_seq_exame = nr_seq_exame_w))
				and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
				and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
				and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
				and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);
			else
				select 	coalesce(sum(qt_procedimento),0)
				into STRICT	qt_executada_atend_w
				from	procedimento_paciente
				where	nr_atendimento		= nr_atendimento_p
				and	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= ie_origem_proced_p
				and	nr_sequencia		<> nr_seq_procedimento_w
				and	cd_setor_atendimento	= cd_setor_atendimento_p
				and	coalesce(cd_motivo_exc_conta::text, '') = ''
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));
			end if;


			if	((qt_executada_atend_w + qt_procedimento_p) > qt_permitida_w ) then
				qt_excedida_w	:= qt_executada_atend_w - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297770); --'Ultrapassou a quantidade maxima do atendimento nesse setor'
			end if;

		-- Exclusivo por atendimento
		elsif (ie_tipo_qtde_W = 'E') then
			OPEN C02;
			LOOP
			FETCH C02 into
				cd_grupo_mat_w,
				cd_subgrupo_mat_w,
				cd_classe_mat_w,
				cd_material_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
				select	count(*)
				into STRICT	qt_executada_conta_w	
				from	conv_regra_mat_exclusivo
				where	coalesce(cd_material, cd_material_w)			= cd_material_w
				and	coalesce(cd_classe_material, cd_classe_mat_w) 	= cd_classe_mat_w
				and	coalesce(cd_subgrupo_material, cd_subgrupo_mat_w)	= cd_subgrupo_mat_w
				and	coalesce(cd_grupo_material, cd_grupo_mat_w) 		= cd_grupo_mat_w
				and	nr_seq_regra_uso_proc				= nr_seq_regra_uso_w;
				qt_exec_total_conta_w	:= qt_exec_total_conta_w + qt_executada_conta_w;
				end;
			END LOOP;
			CLOSE C02;
			if (qt_exec_total_conta_w	= 0) then
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297771); --'Nao ha na conta o material exclusivo desse procedimento'
			end if;
			
		-- Lancamento
		elsif (ie_tipo_qtde_w = 'L') then
	
			if (qt_procedimento_p > qt_permitida_w) then
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297782); --'Ultrapassou a quantidade maxima permitida por lancamento'
			end if;
			
		-- Mes/Paciente
		elsif (ie_tipo_qtde_w = 'N') then
		
			select 	coalesce(max(cd_pessoa_fisica),'0')
			into STRICT	cd_pessoa_fisica_w
			from 	atendimento_paciente
			where 	nr_atendimento = nr_atendimento_p;
			
			if (coalesce(ie_estrutura_proc_w,0) = 'S') then		
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_exec_pac_mes_w
				from	procedimento_paciente a,
					conta_paciente b,
					atendimento_paciente c,
					estrutura_procedimento_v e
				where	b.nr_interno_conta 	= a.nr_interno_conta
				and 	c.nr_atendimento 		= b.nr_atendimento
				and	a.cd_procedimento		= e.cd_procedimento
				and	a.ie_origem_proced  	= e.ie_origem_proced
				and	a.ie_origem_proced 	= ie_origem_proced_p
				and 	c.cd_pessoa_fisica 	= cd_pessoa_fisica_w
				and	PKG_DATE_UTILS.start_of(a.dt_procedimento,'Month',0) = PKG_DATE_UTILS.start_of(dt_procedimento_w,'Month',0)
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
				and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
				and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
				and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);				
			else
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_exec_pac_mes_w
				from	procedimento_paciente a,
					conta_paciente b,
					atendimento_paciente c
				where	b.nr_interno_conta = a.nr_interno_conta
				and 	c.nr_atendimento = b.nr_atendimento
				and	a.cd_procedimento = cd_procedimento_p
				and	a.ie_origem_proced = ie_origem_proced_p
				and 	c.cd_pessoa_fisica = cd_pessoa_fisica_w
				and	PKG_DATE_UTILS.start_of(a.dt_procedimento,'Month',0) = PKG_DATE_UTILS.start_of(dt_procedimento_w,'Month',0)
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
				and	coalesce(a.cd_motivo_exc_conta::text, '') = '';		
			end if;
			
			if	((qt_exec_pac_mes_w + qt_procedimento_p) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_exec_pac_mes_w + qt_procedimento_p) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297783); --'Ultrapassou a quantidade maxima permitida para o mes/paciente';
			end if;
			
		-- AIH
		elsif (ie_tipo_qtde_w = 'I') then

			if	((obter_dados_atendimento(nr_atendimento_p, 'TA') = 1) and (obter_tipo_convenio_atend(nr_atendimento_p) = 3)) then
				begin
				
				if (coalesce(ie_estrutura_proc_w,0) = 'S') then
					select	coalesce(sum(p.qt_procedimento),0)
					into STRICT	qt_executada_aih_w		
					from	sus_aih_unif a,
						conta_paciente c,
						procedimento_paciente p,
						estrutura_procedimento_v e
					where	c.nr_interno_conta = a.nr_interno_conta		
					and	p.nr_interno_conta = c.nr_interno_conta
					and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
					and	c.nr_atendimento = nr_atendimento_p
					and	p.cd_procedimento	= e.cd_procedimento
					and	p.ie_origem_proced  = e.ie_origem_proced
					and	p.ie_origem_proced = ie_origem_proced_p
					and	c.ie_status_acerto = 1
					and	p.nr_sequencia <> nr_seq_procedimento_w
					and 	((coalesce(ie_via_acesso_w::text, '') = '') or (p.ie_via_acesso = ie_via_acesso_p))
					and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (p.nr_seq_proc_interno = nr_seq_proc_interno_w))
					and	((coalesce(nr_seq_exame_w::text, '') = '') or (p.nr_seq_exame = nr_seq_exame_w))
					and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
					and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
					and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
					and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);	
					
					if (qt_executada_aih_w = 0) then
						select	coalesce(sum(p.qt_procedimento),0)
						into STRICT	qt_executada_aih_w		
						from	conta_paciente c,
							procedimento_paciente p,
							estrutura_procedimento_v e
						where	p.nr_interno_conta = c.nr_interno_conta
						and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
						and	c.nr_atendimento 		= nr_atendimento_p
						and	p.cd_procedimento		= e.cd_procedimento
						and	p.ie_origem_proced  	= e.ie_origem_proced
						and	p.ie_origem_proced 	= ie_origem_proced_p
						and	c.ie_status_acerto 	= 1
						and	p.nr_sequencia <> nr_seq_procedimento_w
						and 	((coalesce(ie_via_acesso_w::text, '') = '') or (p.ie_via_acesso = ie_via_acesso_p))
						and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (p.nr_seq_proc_interno = nr_seq_proc_interno_w))
						and	((coalesce(nr_seq_exame_w::text, '') = '') or (p.nr_seq_exame = nr_seq_exame_w))
						and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
						and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
						and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
						and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);
					end if;
				else
					select	coalesce(sum(p.qt_procedimento),0)
					into STRICT	qt_executada_aih_w		
					from	sus_aih_unif a,
							conta_paciente c,
							procedimento_paciente p
					where	c.nr_interno_conta = a.nr_interno_conta		
					and	p.nr_interno_conta = c.nr_interno_conta
					and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
					and	c.nr_atendimento = nr_atendimento_p
					and	p.cd_procedimento = cd_procedimento_p
					and	p.ie_origem_proced = ie_origem_proced_p
					and	c.ie_status_acerto = 1
					and	p.nr_sequencia <> nr_seq_procedimento_w
					and ((coalesce(ie_via_acesso_w::text, '') = '') or (p.ie_via_acesso = ie_via_acesso_p))
					and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (p.nr_seq_proc_interno = nr_seq_proc_interno_w))
					and	((coalesce(nr_seq_exame_w::text, '') = '') or (p.nr_seq_exame = nr_seq_exame_w));
					
					if (qt_executada_aih_w = 0) then
						select	coalesce(sum(p.qt_procedimento),0)
						into STRICT	qt_executada_aih_w		
						from	conta_paciente c,
								procedimento_paciente p
						where	p.nr_interno_conta = c.nr_interno_conta
						and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
						and	c.nr_atendimento = nr_atendimento_p
						and	p.cd_procedimento = cd_procedimento_p
						and	p.ie_origem_proced = ie_origem_proced_p
						and	c.ie_status_acerto = 1
						and	p.nr_sequencia <> nr_seq_procedimento_w
						and ((coalesce(ie_via_acesso_w::text, '') = '') or (p.ie_via_acesso = ie_via_acesso_p))
						and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (p.nr_seq_proc_interno = nr_seq_proc_interno_w))
						and	((coalesce(nr_seq_exame_w::text, '') = '') or (p.nr_seq_exame = nr_seq_exame_w));
					end if;
				end if;
				
				if	((qt_executada_aih_w + qt_procedimento_p) > qt_permitida_w ) then
					qt_excedida_w	:= (qt_executada_aih_w + qt_procedimento_p) - qt_permitida_w;
					ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297784); --'Ultrapassou a quantidade maxima permitida por AIH';
	
				end if;
								
				end;
			end if;
		
		-- Dia/Paciente
		elsif (ie_tipo_qtde_w = 'J') then
		
			select 	coalesce(max(cd_pessoa_fisica),'0')
			into STRICT	cd_pessoa_fisica_w
			from 	atendimento_paciente
			where 	nr_atendimento = nr_atendimento_p;
			
			if (coalesce(ie_estrutura_proc_w,0) = 'S') then		
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_exec_pac_mes_w
				from	procedimento_paciente a,
					conta_paciente b,
					atendimento_paciente c,
					estrutura_procedimento_v e
				where	b.nr_interno_conta 	= a.nr_interno_conta
				and 	c.nr_atendimento 		= b.nr_atendimento
				and	a.cd_procedimento		= e.cd_procedimento
				and	a.ie_origem_proced  	= e.ie_origem_proced
				and	a.ie_origem_proced 	= ie_origem_proced_p
				and 	c.cd_pessoa_fisica 	= cd_pessoa_fisica_w
				and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_procedimento) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_p)
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	e.cd_procedimento		= coalesce(cd_procedimento_w,e.cd_procedimento) 
				and 	e.cd_area_procedimento  	= coalesce(cd_area_procedimento_w, e.cd_area_procedimento)
				and	e.cd_especialidade	= coalesce(cd_especialidade_w, e.cd_especialidade)
				and	e.cd_grupo_proc		= coalesce(cd_grupo_proc_w, e.cd_grupo_proc);				
			else
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_exec_pac_mes_w
				from	procedimento_paciente a,
					conta_paciente b,
					atendimento_paciente c
				where	b.nr_interno_conta = a.nr_interno_conta
				and 	c.nr_atendimento = b.nr_atendimento
				and	a.cd_procedimento = cd_procedimento_p
				and	a.ie_origem_proced = ie_origem_proced_p
				and 	c.cd_pessoa_fisica = cd_pessoa_fisica_w
				and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_procedimento) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_p)
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
				and	coalesce(a.cd_motivo_exc_conta::text, '') = '';		
			end if;			
			
			if	((qt_exec_pac_mes_w + qt_procedimento_p) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_exec_pac_mes_w + qt_procedimento_p) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(1018531); --'Ultrapassou a quantidade maxima permitida para o dia/paciente';
			end if;
		
		end if;
		end;
	-- TIPO DE USO: Percentual proc referencia
	else
		begin

		-- Dia
		if (ie_tipo_qtde_w = 'D') then
			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_procedimento_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	pkg_date_utils.get_time(dt_procedimento,0,0,0)	= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));


			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_dia_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_proc_referencia_w
			and	ie_origem_proced	= ie_origem_proc_refer_w
			and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	pkg_date_utils.get_time(dt_procedimento,0,0,0)	= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));


			if	(dividir(((qt_procedimento_w + qt_procedimento_p) * 100), qt_executada_dia_w)  >= pr_permitida_w) then
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297785); --'Ultrapassou o percentual maximo do dia do procedimento de referencia';
			end if;

		-- Todos atendimentos no dia
		elsif (ie_tipo_qtde_w = 'T') then

			
			select 	coalesce(sum(a.qt_procedimento),0)
			into STRICT	qt_procedimento_w
			from	conta_paciente b,
				procedimento_paciente a
			where	a.nr_atendimento		= b.nr_atendimento
			and	a.cd_procedimento		= cd_procedimento_p
			and	a.ie_origem_proced		= ie_origem_proced_p
			and	a.nr_interno_conta		= b.nr_interno_conta
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	b.cd_convenio_parametro		= cd_convenio_w
			and	pkg_date_utils.get_time(a.dt_procedimento,0,0,0)	= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (a.ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));


			select 	coalesce(sum(a.qt_procedimento),0)
			into STRICT	qt_executada_dia_w
			from	conta_paciente b,
				procedimento_paciente a
			where	a.nr_atendimento		= b.nr_atendimento
			and	a.cd_procedimento		= cd_proc_referencia_w
			and	a.ie_origem_proced		= ie_origem_proc_refer_w
			and	a.nr_interno_conta		= b.nr_interno_conta
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	b.cd_convenio_parametro		= cd_convenio_w
			and	pkg_date_utils.get_time(a.dt_procedimento,0,0,0)	= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (a.ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));


			if	(dividir(((qt_procedimento_w + qt_procedimento_p) * 100), qt_executada_dia_w)  >= pr_permitida_w) then
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297785); --'Ultrapassou o percentual maximo do dia do procedimento de referencia';
			end if;

		-- Mes
		elsif (ie_tipo_qtde_w = 'M') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_procedimento_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	PKG_DATE_UTILS.start_of(dt_procedimento, 'month',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'month',0)
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));



			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_mes_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_proc_referencia_w
			and	ie_origem_proced	= ie_origem_proc_refer_w
			and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	PKG_DATE_UTILS.start_of(dt_procedimento, 'month',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'month',0)
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));


			if	(dividir(((qt_procedimento_w + qt_procedimento_p) * 100), qt_executada_mes_w)  >= pr_permitida_w) then
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297786); --'Ultrapassou o percentual maximo do mes do procedimento de referencia';
			end if;
			
		-- Ano
		elsif (ie_tipo_qtde_w = 'Y') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_procedimento_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	PKG_DATE_UTILS.start_of(dt_procedimento, 'Year',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'Year',0)
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));



			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_ano_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_proc_referencia_w
			and	ie_origem_proced	= ie_origem_proc_refer_w
			and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	PKG_DATE_UTILS.start_of(dt_procedimento, 'Year',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'Year',0)
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));


			if	(dividir(((qt_procedimento_w + qt_procedimento_p) * 100), qt_executada_ano_w)  >= pr_permitida_w) then
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297787); --'Ultrapassou o percentual maximo do ano do procedimento de referencia';
			end if;
			
		-- Todos atendimentos no mes
		elsif (ie_tipo_qtde_w = 'Z') then


			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_procedimento_w
			from	conta_paciente b,
				procedimento_paciente a
			where	a.nr_atendimento		= b.nr_atendimento
			and	a.cd_procedimento		= cd_procedimento_p
			and	a.ie_origem_proced		= ie_origem_proced_p
			and	a.nr_interno_conta 		= b.nr_interno_conta
			and	PKG_DATE_UTILS.start_of(dt_procedimento, 'month',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'month',0)
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	b.cd_convenio_parametro		= cd_convenio_w
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (a.ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));



			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_mes_w
			from	conta_paciente b,
				procedimento_paciente a
			where	a.nr_atendimento		= b.nr_atendimento
			and	cd_procedimento			= cd_proc_referencia_w
			and	ie_origem_proced		= ie_origem_proc_refer_w
			and	a.nr_interno_conta 		= B.nr_interno_conta
			and	b.cd_convenio_parametro		= cd_convenio_w
			and	b.cd_convenio_parametro		= cd_convenio_w
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	PKG_DATE_UTILS.start_of(dt_procedimento, 'month',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_p, 'month',0)
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (a.ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));


			if	(dividir(((qt_procedimento_w + qt_procedimento_p) * 100), qt_executada_mes_w)  >= pr_permitida_w) then
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297786); --'Ultrapassou o percentual maximo do mes do procedimento de referencia';
			end if;
		
		-- Atendimento
		elsif (ie_tipo_qtde_w = 'A') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_procedimento_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));


			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_atend_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_proc_referencia_w
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	ie_origem_proced	= ie_origem_proc_refer_w
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));

	
			if	(dividir(((qt_procedimento_w + qt_procedimento_p) * 100), qt_executada_atend_w)  >= pr_permitida_w) then
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297789); --'Ultrapassou o percentual maximo do atendimento do procedimento de referencia';
			end if;

		-- Horas (periodo)
		elsif (ie_tipo_qtde_w = 'H') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_procedimento_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	dt_procedimento between
				(dt_procedimento_p - (qt_horas_intervalo_w * 60 /1440)) and dt_procedimento_p
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));


			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_periodo_w
			from	procedimento_paciente a
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_proc_referencia_w
			and	ie_origem_proced	= ie_origem_proc_refer_w
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	dt_procedimento between
				(dt_procedimento_p - (qt_horas_intervalo_w * 60 /1440)) and dt_procedimento_p
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (a.ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));


			if	(dividir(((qt_procedimento_w + qt_procedimento_p) * 100), qt_executada_periodo_w)  >= pr_permitida_w) then
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297790); --'Ultrapassou o percentual maxima do periodo do procedimento de referencia';
			end if;

		-- Setor
		elsif (ie_tipo_qtde_w = 'S') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_procedimento_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	cd_setor_atendimento	= cd_setor_atendimento_p
			and	(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));



			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_atend_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_proc_referencia_w
			and	ie_origem_proced	= ie_origem_proc_refer_w
			and	cd_setor_atendimento	= cd_setor_atendimento_p
			and	nr_sequencia		<> nr_seq_procedimento_w
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));


			if	(dividir(((qt_procedimento_w + qt_procedimento_p) * 100), qt_executada_periodo_w)  >= pr_permitida_w) then
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297791); --'Ultrapassou o percentual maxima do setor do procedimento de referencia';
			end if;
		
		-- Exclusivo por atendimento
		elsif (ie_tipo_qtde_W = 'E') then
			OPEN C02;
			LOOP
			FETCH C02 into
				cd_grupo_mat_w,
				cd_subgrupo_mat_w,
				cd_classe_mat_w,
				cd_material_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
				select	count(*)
				into STRICT	qt_executada_conta_w	
				from	conv_regra_mat_exclusivo
				where	coalesce(cd_material, cd_material_w)			= cd_material_w
				and	coalesce(cd_classe_material, cd_classe_mat_w) 	= cd_classe_mat_w
				and	coalesce(cd_subgrupo_material, cd_subgrupo_mat_w)	= cd_subgrupo_mat_w
				and	coalesce(cd_grupo_material, cd_grupo_mat_w) 		= cd_grupo_mat_w
				and	nr_seq_regra_uso_proc				= nr_seq_regra_uso_w;
				qt_exec_total_conta_w	:= qt_exec_total_conta_w + qt_executada_conta_w;
				end;
			END LOOP;
			CLOSE C02;
			if (qt_exec_total_conta_w	= 0) then
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297793); --'Nao ha na conta o material exclusivo desse procedimento';
			end if;
			
		-- AIH
		elsif (ie_tipo_qtde_w = 'I') then
			
			if	((obter_dados_atendimento(nr_atendimento_p, 'TA') = 1) and (obter_tipo_convenio_atend(nr_atendimento_p) = 3)) then
				begin
				
				select	coalesce(sum(p.qt_procedimento),0)
				into STRICT	qt_procedimento_w		
				from	sus_aih_unif a,
						conta_paciente c,
						procedimento_paciente p
				where	c.nr_interno_conta = a.nr_interno_conta		
				and	p.nr_interno_conta = c.nr_interno_conta
				and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
				and	(p.nr_interno_conta IS NOT NULL AND p.nr_interno_conta::text <> '')
				and	c.nr_atendimento = nr_atendimento_p
				and	p.cd_procedimento = cd_procedimento_p
				and	p.ie_origem_proced = ie_origem_proced_p
				and	p.nr_sequencia <> nr_seq_procedimento_w
				and	c.ie_status_acerto = 1
				and	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso = ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));
				
				if (qt_procedimento_w = 0) then

					select	coalesce(sum(p.qt_procedimento),0)
					into STRICT	qt_procedimento_w		
					from	conta_paciente c,
							procedimento_paciente p
					where	p.nr_interno_conta = c.nr_interno_conta
					and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
					and	c.nr_atendimento = nr_atendimento_p
					and	p.cd_procedimento = cd_procedimento_p
					and	p.ie_origem_proced = ie_origem_proced_p
					and	p.nr_sequencia <> nr_seq_procedimento_w
					and	c.ie_status_acerto = 1
					and	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso = ie_via_acesso_p))
					and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
					and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));
				
				end if;
				
				select 	coalesce(sum(qt_procedimento),0)
				into STRICT	qt_executada_atend_w
				from	procedimento_paciente
				where	nr_atendimento		= nr_atendimento_p
				and	cd_procedimento		= cd_proc_referencia_w
				and	nr_sequencia		<> nr_seq_procedimento_w
				and	ie_origem_proced	= ie_origem_proc_refer_w
				and	coalesce(cd_motivo_exc_conta::text, '') = ''
				and	obter_status_conta(nr_interno_conta,'C') = 1
				and 	((coalesce(ie_via_acesso_w::text, '') = '') or (ie_via_acesso	= ie_via_acesso_p))
				and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
				and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w));

				if	(dividir(((qt_procedimento_w + qt_procedimento_p) * 100), qt_executada_atend_w)  >= pr_permitida_w) then
					ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(297794); --'Ultrapassou o percentual maximo sobre o procedimento de referencia na AIH';
				end if;
				
				end;
			end if;
			

		end if;

		end;

	end if;

end if;

if (ie_opcao_p	= '1') then
	ds_retorno_w	:= IE_ACAO_EXCESSO_w;
elsif (ie_opcao_p	= '2') then
	ds_retorno_w	:= qt_excedida_w;
else
	ds_retorno_w	:= ds_erro_w;
	if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') and (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
		ds_retorno_w := ds_mensagem_w;
	end if;
end if;

return	ds_retorno_w; /* Felipe - voltei para ds_retorno_w, pois no dia 12/03/2007 havia sido mudado para ds_erro_w */
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_uso_qtde_proc ( nr_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, qt_procedimento_p bigint, cd_medico_p text, cd_setor_atendimento_p bigint, dt_procedimento_p timestamp, ie_opcao_p text, nr_seq_procedimento_p bigint, ie_via_acesso_p text, nr_interno_conta_p bigint, nr_seq_proc_interno_p bigint, cd_categoria_p text, cd_plano_p text, nr_seq_exame_p bigint) FROM PUBLIC;

