-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_unid_setor_cirurgia ( nr_cirurgia_p bigint, ie_opcao_p text ) RETURNS varchar AS $body$
DECLARE


ds_setor_unid_w		varchar(255);
ds_setor_w		varchar(255);
ds_unidade_w		varchar(255);
nr_seq_interno_w	bigint;
dt_entrada_unidade_w	timestamp;
nr_atendimento_w	bigint;
cd_setor_atendimento_w	integer;
ds_unid_basica_w	unidade_atendimento.cd_unidade_basica%type;



BEGIN

if (coalesce(nr_cirurgia_p,0) > 0) then
	select	max(dt_entrada_unidade),
				max(nr_atendimento)
	into STRICT		dt_entrada_unidade_w,
				nr_atendimento_w
	from		cirurgia
	where		nr_cirurgia = nr_cirurgia_p;	

	if	(nr_atendimento_w > 0 AND dt_entrada_unidade_w IS NOT NULL AND dt_entrada_unidade_w::text <> '') then
		select	substr(max(b.ds_setor_atendimento),1,30) || ' ' || max(a.cd_unidade_basica) || ' ' || max(a.cd_unidade_compl),
			substr(max(b.ds_setor_atendimento),1,255),
			max(a.cd_unidade_basica) || ' ' || max(a.cd_unidade_compl),
			max(a.nr_seq_interno),
			max(a.cd_setor_atendimento),
			max(a.cd_unidade_basica)
		into STRICT	ds_setor_unid_w,
			ds_setor_w,
			ds_unidade_w,
			nr_seq_interno_w,
			cd_setor_atendimento_w,
			ds_unid_basica_w
		from	atend_paciente_unidade a,
			setor_atendimento b
		where	a.cd_setor_atendimento	=  b.cd_setor_atendimento
		and	a.nr_atendimento	= nr_atendimento_w
		and	a.dt_entrada_unidade	= dt_entrada_unidade_w;
	end if;

	if (ie_opcao_p = 'UN') then
		return	ds_unidade_w;
	elsif (ie_opcao_p = 'SS') then
		return	ds_setor_w;
	elsif (ie_opcao_p = 'S') then
		return	ds_setor_unid_w;
	elsif (ie_opcao_p = 'U') then
		return	ds_unid_basica_w;
	elsif (ie_opcao_p = 'C') then
		return	to_char(cd_setor_atendimento_w);
	else 	
		return	to_char(nr_seq_interno_w);
	end if;
else
	return null;
end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_unid_setor_cirurgia ( nr_cirurgia_p bigint, ie_opcao_p text ) FROM PUBLIC;

