-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_valores_prot_pag ( nr_seq_protocolo_p bigint, nr_seq_lote_pgto_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Obter valores de protocolos vinculados à pagamentos.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
/* ie_opcao_p
VLP 	- Valor liberado para pagamento
VL 	- Valor total liberado protocolo
VNL 	- Valor não liberado para pagamento
VLO 	- Valor liberado para outro pagamento
VGL	- Valor glosa liberado para pagamento
VGN	- Valor glosa não liberado para pagameto
VAP	- Valor apresentado para pagamento
VLC	- Valor total calculado do protocolo
*/
vl_retorno_w	double precision;


BEGIN
if (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '') and (nr_seq_lote_pgto_p IS NOT NULL AND nr_seq_lote_pgto_p::text <> '') and (ie_opcao_p IS NOT NULL AND ie_opcao_p::text <> '') then
	if (ie_opcao_p = 'VLP') then
		select	coalesce(sum(b.vl_liberado),0)
		into STRICT	vl_retorno_w
		from	pls_conta_medica_resumo	b,
			pls_conta		a
		where	a.nr_sequencia 		= b.nr_seq_conta
		and	b.nr_seq_lote_pgto 	= nr_seq_lote_pgto_p
		and	a.nr_seq_protocolo 	= nr_seq_protocolo_p
		and	coalesce(b.ie_situacao,'A') = 'A';
	elsif (ie_opcao_p = 'VL') then
		select	coalesce(a.vl_total,0)
		into STRICT	vl_retorno_w
		from	pls_protocolo_conta a
		where	a.nr_sequencia 		= nr_seq_protocolo_p;
	elsif (ie_opcao_p = 'VNL') then
		select	coalesce(sum(b.vl_liberado),0)
		into STRICT	vl_retorno_w
		from	pls_conta_medica_resumo	b,
			pls_conta		a
		where	a.nr_sequencia 		= b.nr_seq_conta
		and	a.nr_seq_protocolo 	= nr_seq_protocolo_p
		and	b.ie_tipo_item		<> 'I'
		and	coalesce(b.nr_seq_lote_pgto::text, '') = ''
		and	coalesce(b.ie_situacao,'A') = 'A';
	elsif (ie_opcao_p = 'VLO') then
		select	coalesce(sum(b.vl_liberado),0)
		into STRICT	vl_retorno_w
		from	pls_conta_medica_resumo	b,
			pls_conta		a
		where	a.nr_sequencia 		= b.nr_seq_conta
		and	b.nr_seq_lote_pgto 	<> nr_seq_lote_pgto_p
		and	a.nr_seq_protocolo 	= nr_seq_protocolo_p
		and	(b.nr_seq_lote_pgto IS NOT NULL AND b.nr_seq_lote_pgto::text <> '');
	elsif (ie_opcao_p = 'VGL') then
		select	coalesce(sum(b.vl_glosa),0)
		into STRICT	vl_retorno_w
		from	pls_conta_medica_resumo	b,
			pls_conta		a
		where	a.nr_sequencia 		= b.nr_seq_conta
		and	b.nr_seq_lote_pgto 	= nr_seq_lote_pgto_p
		and	a.nr_seq_protocolo 	= nr_seq_protocolo_p;
	elsif (ie_opcao_p = 'VGN') then
		select	coalesce(sum(vl_glosa_conta),0) - coalesce(sum(vl_glosa_pag),0)
		into STRICT	vl_retorno_w
		from	(SELECT	coalesce(a.vl_glosa,0) vl_glosa_conta,
				(select coalesce(sum(cr.vl_glosa),0)
				from 	pls_conta_medica_resumo cr
				where 	cr.nr_seq_conta = a.nr_sequencia
				and 	cr.ie_situacao 	= 'A') vl_glosa_pag
			from	pls_conta		a
			where	a.nr_seq_protocolo 	= nr_seq_protocolo_p) alias9;
	elsif (ie_opcao_p = 'VAP') then
		select	coalesce(sum(b.vl_apresentado),0)
		into STRICT	vl_retorno_w
		from	pls_conta_medica_resumo	b,
			pls_conta		a
		where	a.nr_sequencia 		= b.nr_seq_conta
		and	b.nr_seq_lote_pgto 	= nr_seq_lote_pgto_p
		and	a.nr_seq_protocolo 	= nr_seq_protocolo_p
		and	coalesce(b.ie_situacao,'A') = 'A';
	elsif (ie_opcao_p = 'VLC') then
		vl_retorno_w	:= pls_obter_valor_protocolo(nr_seq_protocolo_p,'CA');

	-- PAGAMENTO NOVO
	elsif (ie_opcao_p = 'NVLP') then
		select	coalesce(sum(b.vl_liberado),0)
		into STRICT	vl_retorno_w
		from	pls_conta_medica_resumo	b,
			pls_conta		a
		where	a.nr_sequencia 		= b.nr_seq_conta
		and	b.nr_seq_pp_lote 	= nr_seq_lote_pgto_p
		and	a.nr_seq_protocolo 	= nr_seq_protocolo_p
		and	coalesce(b.ie_situacao,'A') = 'A';
	elsif (ie_opcao_p = 'NVL') then
		select	coalesce(a.vl_total,0)
		into STRICT	vl_retorno_w
		from	pls_protocolo_conta a
		where	a.nr_sequencia 		= nr_seq_protocolo_p;
	elsif (ie_opcao_p = 'NVNL') then
		select	coalesce(sum(b.vl_liberado),0)
		into STRICT	vl_retorno_w
		from	pls_conta_medica_resumo	b,
			pls_conta		a
		where	a.nr_sequencia 		= b.nr_seq_conta
		and	a.nr_seq_protocolo 	= nr_seq_protocolo_p
		and	b.ie_tipo_item		<> 'I'
		and	coalesce(b.nr_seq_pp_lote::text, '') = ''
		and	coalesce(b.ie_situacao,'A') = 'A';
	elsif (ie_opcao_p = 'NVLO') then
		select	coalesce(sum(b.vl_liberado),0)
		into STRICT	vl_retorno_w
		from	pls_conta_medica_resumo	b,
			pls_conta		a
		where	a.nr_sequencia 		= b.nr_seq_conta
		and	b.nr_seq_pp_lote 	<> nr_seq_lote_pgto_p
		and	a.nr_seq_protocolo 	= nr_seq_protocolo_p
		and	(b.nr_seq_pp_lote IS NOT NULL AND b.nr_seq_pp_lote::text <> '');
	elsif (ie_opcao_p = 'NVGL') then
		select	coalesce(sum(b.vl_glosa),0)
		into STRICT	vl_retorno_w
		from	pls_conta_medica_resumo	b,
			pls_conta		a
		where	a.nr_sequencia 		= b.nr_seq_conta
		and	b.nr_seq_pp_lote 	= nr_seq_lote_pgto_p
		and	a.nr_seq_protocolo 	= nr_seq_protocolo_p;
	elsif (ie_opcao_p = 'NVGN') then
		select	coalesce(sum(vl_glosa_conta),0) - coalesce(sum(vl_glosa_pag),0)
		into STRICT	vl_retorno_w
		from	(SELECT	coalesce(a.vl_glosa,0) vl_glosa_conta,
				(select coalesce(sum(cr.vl_glosa),0)
				from 	pls_conta_medica_resumo cr
				where 	cr.nr_seq_conta = a.nr_sequencia
				and 	cr.ie_situacao 	= 'A') vl_glosa_pag
			from	pls_conta		a
			where	a.nr_seq_protocolo 	= nr_seq_protocolo_p) alias9;
	elsif (ie_opcao_p = 'NVAP') then
		select	coalesce(sum(b.vl_apresentado),0)
		into STRICT	vl_retorno_w
		from	pls_conta_medica_resumo	b,
			pls_conta		a
		where	a.nr_sequencia 		= b.nr_seq_conta
		and	b.nr_seq_pp_lote 	= nr_seq_lote_pgto_p
		and	a.nr_seq_protocolo 	= nr_seq_protocolo_p
		and	coalesce(b.ie_situacao,'A') = 'A';
	end if;
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_valores_prot_pag ( nr_seq_protocolo_p bigint, nr_seq_lote_pgto_p bigint, ie_opcao_p text) FROM PUBLIC;

