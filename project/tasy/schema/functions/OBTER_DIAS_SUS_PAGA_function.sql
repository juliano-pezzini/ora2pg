-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dias_sus_paga ( NR_ATENDIMENTO_P text, IE_OPCAO_P bigint) RETURNS varchar AS $body$
DECLARE

ds_descricao_w		varchar(255) := '';
cd_procedimento_w	bigint := 0;
ds_procedimento_w	varchar(254) := '';
qt_dias_w		smallint := 0;
vl_sus_paga_w		double precision := 0;

cd_estabelecimento_w	integer;
ie_versao_w		varchar(20);
dt_competencia_w	timestamp;

/* 
ie_opcao_p: 
	1- Cd Procedimento 
	2- Qt dias 
	3- Vl pago 
	4- Descricao procedimento 
*/
 

BEGIN 
 
if (ie_opcao_p > 0) then 
	select	coalesce(max(cd_estabelecimento),1) 
	into STRICT	cd_estabelecimento_w 
	from	atendimento_paciente 
	where	nr_atendimento = nr_atendimento_p;
 
	select	dt_competencia_aih, 
		ie_versao_aih 
	into STRICT	dt_competencia_w, 
		ie_versao_w 
	from	sus_parametros 
	where	cd_estabelecimento = cd_estabelecimento_w;
		 
	select	max(a.cd_procedimento), 
		max(a.qt_permanencia), 
    		sum(a.vl_matmed + a.vl_diaria + a.vl_taxas + a.vl_medico + a.vl_sadt) vl_sus_paga, 
		max(substr(obter_descricao_procedimento(a.cd_procedimento,a.ie_origem_proced),1,150)) ds_procedimento 
	into STRICT	cd_procedimento_w, 
		qt_dias_w, 
		vl_sus_paga_w, 
		ds_procedimento_w 
	from	sus_preco_procaih a, 
		sus_laudo_paciente b 
	where	a.cd_procedimento 	= b.cd_procedimento_solic 
	and	a.ie_origem_proced	= b.ie_origem_proced 
	and	b.nr_atendimento 	= nr_atendimento_p 
	and (ie_versao		= coalesce(ie_versao_w, ie_versao) 
		 or dt_competencia	= coalesce(dt_competencia_w, dt_competencia)) 
	and	b.ie_tipo_laudo_sus	<> 15; /* Felipe - 30/06/2006 - OS 34318*/
 
	if (ie_opcao_p = 1) then 
		ds_descricao_w := cd_procedimento_w;
	elsif (ie_opcao_p = 2) then 
		ds_descricao_w := qt_dias_w;
	elsif (ie_opcao_p = 3) then 
		ds_descricao_w := vl_sus_paga_w;
	elsif (ie_opcao_p = 4) then 
		ds_descricao_w := ds_procedimento_w;
	end if;
end if;
RETURN ds_descricao_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dias_sus_paga ( NR_ATENDIMENTO_P text, IE_OPCAO_P bigint) FROM PUBLIC;

