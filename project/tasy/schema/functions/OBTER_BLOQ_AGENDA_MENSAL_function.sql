-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_bloq_agenda_mensal (cd_agenda_p bigint default null, dt_agenda_in_p timestamp DEFAULT NULL, dt_agenda_out_p timestamp DEFAULT NULL, nr_seq_ageint_item_p text DEFAULT NULL) RETURNS varchar AS $body$
DECLARE


nr_seq_regra_w			agenda_bloqueio_geral.nr_sequencia%type;
cd_grupo_proc_w			grupo_proc.cd_grupo_proc%type;
cd_especialidade_w		especialidade_proc.cd_especialidade%type;
cd_area_procedimento_w		area_procedimento.cd_area_procedimento%type;
ie_dia_semana_w			smallint;
cd_tipo_agenda_w		agenda.cd_tipo_agenda%type;
cd_espec_agenda_w		agenda.cd_especialidade%type;
cd_estabelecimento_w		agenda.cd_estabelecimento%type;
cd_setor_agenda_w		setor_atendimento.cd_setor_atendimento%type;
cd_setor_exclusivo_w		setor_atendimento.cd_setor_atendimento%type;
cd_profissional_agenda_w	pessoa_fisica.cd_pessoa_fisica%type;
cd_procedimento_w		agenda_integrada_item.cd_procedimento%type;
ie_origem_proced_w		agenda_integrada_item.ie_origem_proced%type;
nr_seq_classif_agenda_w		agenda_integrada_item.nr_seq_classif_agenda%type;
nr_seq_proc_interno_w		agenda_integrada_item.nr_seq_proc_interno%type;
cd_espec_agendamento_w		agenda_integrada_item.cd_especialidade%type;
ie_classif_agenda_w		agenda_integrada_item.ie_classif_agenda%type;
cd_profissional_agendamento_w	agenda_integrada_item.cd_medico%type;
cd_setor_agendamento_w		bigint;
nm_usuario_ativo_w		usuario.nm_usuario%type;
dia_w				timestamp;
lista_dia_nr_seq_regra_w varchar(32000);
lista_nr_seq_regra_bloq_w	varchar(32000);


BEGIN

begin
select	cd_tipo_agenda,
	cd_especialidade,
	cd_setor_agenda,
	cd_setor_exclusivo,
	cd_pessoa_fisica,
	cd_estabelecimento
into STRICT	cd_tipo_agenda_w,
	cd_espec_agenda_w,
	cd_setor_agenda_w,
	cd_setor_exclusivo_w,
	cd_profissional_agenda_w,
	cd_estabelecimento_w
from	agenda
where	cd_agenda	 = cd_agenda_p;
exception
	when others then
	cd_tipo_agenda_w	:= 0;
end;

begin
select	cd_procedimento,
	ie_origem_proced,
  nr_seq_proc_interno,
	nr_seq_classif_agenda,
	cd_medico,
	ie_classif_agenda,
  cd_especialidade
into STRICT	cd_procedimento_w,
	ie_origem_proced_w,
  nr_seq_proc_interno_w,
	nr_seq_classif_agenda_w,
	cd_profissional_agendamento_w,
	ie_classif_agenda_w,
  cd_espec_agendamento_w
from	agenda_integrada_item
where	nr_sequencia	 	= nr_seq_ageint_item_p  LIMIT 1;
exception
	when others then
	cd_procedimento_w		:= 0;
	ie_origem_proced_w		:= 0;
  nr_seq_classif_agenda_w := 0;
  cd_profissional_agendamento_w := 0;
  ie_classif_agenda_w := 0;	
end;

begin
select	cd_grupo_proc,
	cd_especialidade,
	cd_area_procedimento
into STRICT	cd_grupo_proc_w,
	cd_especialidade_w,
	cd_area_procedimento_w
from	estrutura_procedimento_v
where	cd_procedimento	 	= cd_procedimento_w
and		ie_origem_proced	= ie_origem_proced_w  LIMIT 1;
exception
	when others then
	cd_grupo_proc_w			:= 0;
	cd_especialidade_w		:= 0;
	cd_area_procedimento_w		:= 0;
end;

lista_nr_seq_regra_bloq_w     := '0';
cd_setor_agendamento_w 	      := obter_setor_regras_ageint(cd_tipo_agenda_w,cd_agenda_p,cd_procedimento_w,'N',obter_usuario_ativo,cd_estabelecimento_w);

for dias_w in (to_char(dt_agenda_in_p, 'j'))::numeric ..(to_char(dt_agenda_out_p, 'j'))::numeric  loop
	
  dia_w := to_date(dias_w,'J');

	ie_dia_semana_w	:= Obter_Cod_Dia_Semana(dia_w);WITH RECURSIVE cte AS (


  begin

SELECT SUBSTR(nr_sequencia , 2) csv
INTO STRICT lista_dia_nr_seq_regra_w
      FROM (SELECT nr_sequencia , ROW_NUMBER() OVER (ORDER BY nr_sequencia ) rn,
                   COUNT(*) OVER () cnt
              FROM (

SELECT 	nr_sequencia
from	agenda_bloqueio_geral
where 	ie_situacao = 'A'
and	coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_w,0)) = coalesce(cd_estabelecimento_w,0)
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
and	((coalesce(cd_agenda,coalesce(cd_agenda_p,0)) = coalesce(cd_agenda_p,0)) OR coalesce(cd_agenda::text, '') = '')
and 	coalesce(cd_especialidade,coalesce(cd_especialidade_w,0)) = coalesce(cd_especialidade_w,0) 
and (coalesce(ie_dia_semana,coalesce(ie_dia_semana_w,0)) = coalesce(ie_dia_semana_w,0) or (ie_dia_semana = 9 and ie_dia_semana_w in (7,1))) 
and	coalesce(nr_seq_proc_interno,coalesce(nr_seq_proc_interno_w,0)) = coalesce(nr_seq_proc_interno_w,0)
and	coalesce(cd_procedimento,coalesce(cd_procedimento_w,0)) = coalesce(cd_procedimento_w,0) 
and	((coalesce(cd_procedimento,0) = 0) or coalesce(ie_origem_proced,coalesce(ie_origem_proced_w,0)) = coalesce(ie_origem_proced_w,0))
and	coalesce(cd_grupo_proc,coalesce(cd_grupo_proc_w,0)) = coalesce(cd_grupo_proc_w,0) 
and	coalesce(cd_area_procedimento,coalesce(cd_area_procedimento_w,0)) = coalesce(cd_area_procedimento_w,0)
AND Trunc(dia_w) BETWEEN coalesce(Trunc(dt_inicio_vigencia),Trunc(dia_w)) AND coalesce(Trunc(dt_fim_vigencia),Trunc(dia_w))
and	((coalesce(ie_setor_agenda,'N') = 'N') or (coalesce(cd_setor_atendimento,coalesce(cd_setor_agenda_w,0)) = coalesce(cd_setor_agenda_w,0)))
and 	((coalesce(ie_setor_agendamento,'N') = 'N') or (coalesce(cd_setor_atendimento,coalesce(cd_setor_agendamento_w,0)) = coalesce(cd_setor_agendamento_w,0)))
and 	((coalesce(ie_setor_exclusivo,'N') = 'N') or (coalesce(cd_setor_atendimento,coalesce(cd_setor_exclusivo_w,0)) = coalesce(cd_setor_exclusivo_w,0)))
and	((coalesce(ie_prof_agenda,'N') = 'N') or (coalesce(cd_pessoa_fisica,coalesce(cd_profissional_agenda_w,'0')) = coalesce(cd_profissional_agenda_w,'0')))
and	((coalesce(ie_prof_agendamento,'N') = 'N') or (coalesce(cd_pessoa_fisica,coalesce(cd_profissional_agendamento_w,'0')) = coalesce(cd_profissional_agendamento_w,'0')))
and 	((coalesce(ie_espec_agenda,'N') = 'N') or (coalesce(cd_espec_medica, coalesce(cd_espec_agenda_w,0)) = coalesce(cd_espec_agenda_w,0)))
and 	((coalesce(ie_espec_agendamento,'N') = 'N') or (coalesce(cd_espec_medica, coalesce(cd_espec_agendamento_w,0)) = coalesce(cd_espec_agendamento_w,0)))
and	( ((cd_tipo_agenda_w = 2) and (coalesce(nr_seq_classif_agenda,coalesce(nr_seq_classif_agenda_w,0)) = coalesce( nr_seq_classif_agenda_w,0)))
or 	  ((cd_tipo_agenda_w in (3,4,5)) and (coalesce(ie_classif_agenda,coalesce(ie_classif_agenda_w,'0')) = coalesce( ie_classif_agenda_w,'0'))) )
and	coalesce(cd_tipo_agenda,cd_tipo_agenda_w) = cd_tipo_agenda_w

) alias116              
              ) alias117
      WHERE rn = 1
  UNION ALL


  begin

SELECT c.lista_dia_nr_seq_regra_w || ',' || SUBSTR(nr_sequencia , 2) csv
INTO STRICT lista_dia_nr_seq_regra_w
      FROM (SELECT nr_sequencia , ROW_NUMBER() OVER (ORDER BY nr_sequencia ) rn,
                   COUNT(*) OVER () cnt
              FROM (

SELECT 	nr_sequencia
from	agenda_bloqueio_geral
where 	ie_situacao = 'A' 
and	coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_w,0)) = coalesce(cd_estabelecimento_w,0)
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
and	((coalesce(cd_agenda,coalesce(cd_agenda_p,0)) = coalesce(cd_agenda_p,0)) OR coalesce(cd_agenda::text, '') = '')
and 	coalesce(cd_especialidade,coalesce(cd_especialidade_w,0)) = coalesce(cd_especialidade_w,0) 
and (coalesce(ie_dia_semana,coalesce(ie_dia_semana_w,0)) = coalesce(ie_dia_semana_w,0) or (ie_dia_semana = 9 and ie_dia_semana_w in (7,1))) 
and	coalesce(nr_seq_proc_interno,coalesce(nr_seq_proc_interno_w,0)) = coalesce(nr_seq_proc_interno_w,0)
and	coalesce(cd_procedimento,coalesce(cd_procedimento_w,0)) = coalesce(cd_procedimento_w,0) 
and	((coalesce(cd_procedimento,0) = 0) or coalesce(ie_origem_proced,coalesce(ie_origem_proced_w,0)) = coalesce(ie_origem_proced_w,0))
and	coalesce(cd_grupo_proc,coalesce(cd_grupo_proc_w,0)) = coalesce(cd_grupo_proc_w,0) 
and	coalesce(cd_area_procedimento,coalesce(cd_area_procedimento_w,0)) = coalesce(cd_area_procedimento_w,0)
AND Trunc(dia_w) BETWEEN coalesce(Trunc(dt_inicio_vigencia),Trunc(dia_w)) AND coalesce(Trunc(dt_fim_vigencia),Trunc(dia_w))
and	((coalesce(ie_setor_agenda,'N') = 'N') or (coalesce(cd_setor_atendimento,coalesce(cd_setor_agenda_w,0)) = coalesce(cd_setor_agenda_w,0)))
and 	((coalesce(ie_setor_agendamento,'N') = 'N') or (coalesce(cd_setor_atendimento,coalesce(cd_setor_agendamento_w,0)) = coalesce(cd_setor_agendamento_w,0)))
and 	((coalesce(ie_setor_exclusivo,'N') = 'N') or (coalesce(cd_setor_atendimento,coalesce(cd_setor_exclusivo_w,0)) = coalesce(cd_setor_exclusivo_w,0)))
and	((coalesce(ie_prof_agenda,'N') = 'N') or (coalesce(cd_pessoa_fisica,coalesce(cd_profissional_agenda_w,'0')) = coalesce(cd_profissional_agenda_w,'0')))
and	((coalesce(ie_prof_agendamento,'N') = 'N') or (coalesce(cd_pessoa_fisica,coalesce(cd_profissional_agendamento_w,'0')) = coalesce(cd_profissional_agendamento_w,'0')))
and 	((coalesce(ie_espec_agenda,'N') = 'N') or (coalesce(cd_espec_medica, coalesce(cd_espec_agenda_w,0)) = coalesce(cd_espec_agenda_w,0)))
and 	((coalesce(ie_espec_agendamento,'N') = 'N') or (coalesce(cd_espec_medica, coalesce(cd_espec_agendamento_w,0)) = coalesce(cd_espec_agendamento_w,0)))
and	( ((cd_tipo_agenda_w = 2) and (coalesce(nr_seq_classif_agenda,coalesce(nr_seq_classif_agenda_w,0)) = coalesce( nr_seq_classif_agenda_w,0)))
or 	  ((cd_tipo_agenda_w in (3,4,5)) and (coalesce(ie_classif_agenda,coalesce(ie_classif_agenda_w,'0')) = coalesce( ie_classif_agenda_w,'0'))) )
and	coalesce(cd_tipo_agenda,cd_tipo_agenda_w) = cd_tipo_agenda_w

) alias116              
              ) JOIN cte c ON (c.rn + 1 = alias117.rn)

) SELECT * FROM cte WHERE rn = cnt;
;

exception
	when others then
	lista_dia_nr_seq_regra_w			:= '0';	
end;

lista_nr_seq_regra_bloq_w := lista_nr_seq_regra_bloq_w || ', ' || lista_dia_nr_seq_regra_w;

end loop;

return	lista_nr_seq_regra_bloq_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_bloq_agenda_mensal (cd_agenda_p bigint default null, dt_agenda_in_p timestamp DEFAULT NULL, dt_agenda_out_p timestamp DEFAULT NULL, nr_seq_ageint_item_p text DEFAULT NULL) FROM PUBLIC;

