-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_valor_franquia_prod (nr_seq_plano_p pls_plano.nr_sequencia%type, cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, cd_area_procedimento_p area_procedimento.cd_area_procedimento%type, cd_especialidade_p especialidade_medica.cd_especialidade%type, cd_grupo_proc_p procedimento.cd_grupo_proc%type, nr_seq_clinica_p pls_clinica.nr_sequencia%type) RETURNS bigint AS $body$
DECLARE


vl_franquia_w		double precision	:= 0;

C01 CURSOR FOR
	SELECT	c.nr_sequencia,
		a.vl_franquia
	from	pls_franquia_estrutura	c,
		pls_franquia_regra	a
	where	a.nr_seq_franquia_est	= c.nr_sequencia
	and	a.nr_seq_plano		= nr_seq_plano_p
	and	c.ie_situacao		= 'A'
	and	clock_timestamp() between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia,clock_timestamp())
	order by a.vl_franquia;

C02 CURSOR(nr_seq_franquia_est_pc	pls_franquia_estrutura.nr_sequencia%type) FOR
	SELECT	b.nr_sequencia
	from	pls_franquia_proc		b
	where	b.nr_seq_franquia_est		= nr_seq_franquia_est_pc
	and	((coalesce(b.cd_procedimento::text, '') = '') or (b.cd_procedimento = cd_procedimento_p AND b.ie_origem_proced = ie_origem_proced_p))
	and	((b.cd_area_procedimento	= cd_area_procedimento_p) or (coalesce(b.cd_area_procedimento::text, '') = ''))
	and	((b.cd_especialidade		= cd_especialidade_p) or (coalesce(b.cd_especialidade::text, '') = ''))
	and	((b.cd_grupo_proc		= cd_grupo_proc_p) or (coalesce(b.cd_grupo_proc::text, '') = ''))
	and	((b.nr_seq_clinica		= nr_seq_clinica_p) or (coalesce(b.nr_seq_clinica::text, '') = ''))
	and	b.ie_liberado			= 'S';
BEGIN

for	r_C01_w in C01() loop
	for	r_C02_w in C02(r_C01_w.nr_sequencia) loop
		vl_franquia_w	:= r_C01_w.vl_franquia;
	end loop;
end loop;

return vl_franquia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_valor_franquia_prod (nr_seq_plano_p pls_plano.nr_sequencia%type, cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, cd_area_procedimento_p area_procedimento.cd_area_procedimento%type, cd_especialidade_p especialidade_medica.cd_especialidade%type, cd_grupo_proc_p procedimento.cd_grupo_proc%type, nr_seq_clinica_p pls_clinica.nr_sequencia%type) FROM PUBLIC;

