-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION regra_plano_proced_valor (nr_seq_regra_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_procedimento_p bigint, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_plano_p bigint, ie_origem_proced_p bigint) RETURNS varchar AS $body$
DECLARE


qt_ponto_min_w   regra_convenio_plano.qt_ponto_min%type;
qt_ponto_max_w   regra_convenio_plano.qt_ponto_max%type;
ie_regra_valor_w regra_convenio_plano.ie_regra_valor%type;
ie_valor_w       regra_convenio_plano.ie_valor%type;
vl_procedimento_w		double precision	:= 0;
ie_aplica_w             varchar(1) := 'S';

C01 CURSOR FOR
SELECT	ie_valor,
	coalesce(qt_ponto_min, 0),
	coalesce(qt_ponto_max, 0),
    ie_regra_valor
from 	regra_Convenio_Plano
where	nr_sequencia							= nr_seq_regra_p;


BEGIN

 open c01;
	loop
	fetch c01 into
		ie_valor_w,
		qt_ponto_min_w,
		qt_ponto_max_w,
		ie_regra_valor_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
        if (ie_valor_w <> 'N') then		

            if (ie_origem_proced_p = 1) then 	/*AMB */
                if (ie_valor_w = 'PP') then
    
                    vl_procedimento_w	:= coalesce(obter_preco_procedimento(cd_estabelecimento_p,
                                                cd_convenio_p,
                                                cd_categoria_p,
                                                clock_timestamp(),
                                                cd_procedimento_p,
                                                ie_origem_proced_p,
                                                cd_tipo_acomodacao_p,
                                                ie_tipo_atendimento_p,
                                                cd_setor_atendimento_p,
                                                null,
                                                null,
                                                null,
                                                cd_plano_p,
                                                null,
                                                null,
                                                ie_valor_w),0);

                    if 	(ie_regra_valor_w = 'FF' AND vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) or
                        (ie_regra_valor_w = 'DF' AND not vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) then					
                        ie_aplica_w := 'N';
                    end if;
                elsif (ie_valor_w = 'P') then

                    vl_procedimento_w	:= coalesce(obter_preco_procedimento(cd_estabelecimento_p,
                                                cd_convenio_p,
                                                cd_categoria_p,
                                                clock_timestamp(),
                                                cd_procedimento_p,
                                                ie_origem_proced_p,
                                                cd_tipo_acomodacao_p,
                                                ie_tipo_atendimento_p,
                                                cd_setor_atendimento_p,
                                                null,
                                                null,
                                                null,
                                                cd_plano_p,
                                                null,
                                                null,
                                                ie_valor_w),0);

                    if 	(ie_regra_valor_w = 'FF' AND vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) or
                        (ie_regra_valor_w = 'DF' AND not vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) then						
                        ie_aplica_w := 'N';
                    end if;	
                else
                    vl_procedimento_w	:= obter_preco_amb(cd_procedimento_p,
                                cd_convenio_p,
                                cd_categoria_p,
                                cd_estabelecimento_p,
                                ie_valor_w);
                    if 	(ie_regra_valor_w = 'FF' AND vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) or
                        (ie_regra_valor_w = 'DF' AND not vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) then					
                        ie_aplica_w := 'N';
                    end if;
                end if;
            else
                /* CBHPM */

                if (ie_valor_w = 'CO') then
                    ie_valor_w	:= 'C';
                end if;

                vl_procedimento_w	:= obter_preco_procedimento(cd_estabelecimento_p,
                                        cd_convenio_p,
                                        cd_categoria_p,
                                        clock_timestamp(),
                                        cd_procedimento_p,
                                        ie_origem_proced_p,
                                        cd_tipo_acomodacao_p,
                                        ie_tipo_atendimento_p,
                                        cd_setor_atendimento_p,
                                        null,
                                        null,
                                        null,
                                        cd_plano_p,
                                        null,
                                        null,
                                        ie_valor_w);

                if 	(ie_regra_valor_w = 'FF' AND vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) or
                    (ie_regra_valor_w = 'DF' AND not vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) then				
                    ie_aplica_w := 'N';
                end if;

            end if;

            if (ie_origem_proced_p = 4) then --Origem Propio
                if (ie_valor_w = 'PP') then
                    vl_procedimento_w	:= coalesce(obter_preco_procedimento(cd_estabelecimento_p,
                                                cd_convenio_p,
                                                cd_categoria_p,
                                                clock_timestamp(),
                                                cd_procedimento_p,
                                                ie_origem_proced_p,
                                                cd_tipo_acomodacao_p,
                                                ie_tipo_atendimento_p,
                                                cd_setor_atendimento_p,
                                                null,
                                                null,
                                                null,
                                                cd_plano_p,
                                                null,
                                                null,
                                                ie_valor_w),0);

                    if 	(ie_regra_valor_w = 'FF' AND vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) or
                        (ie_regra_valor_w = 'DF' AND not vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) then
                        ie_aplica_w := 'N';
                    end if;
                else
                    vl_procedimento_w	:= coalesce(obter_preco_procedimento(cd_estabelecimento_p,
                                                cd_convenio_p,
                                                cd_categoria_p,
                                                clock_timestamp(),
                                                cd_procedimento_p,
                                                ie_origem_proced_p,
                                                cd_tipo_acomodacao_p,
                                                ie_tipo_atendimento_p,
                                                cd_setor_atendimento_p,
                                                null,
                                                null,
                                                null,
                                                cd_plano_p,
                                                null,
                                                null,
                                                ie_valor_w),0);

                    if 	(ie_regra_valor_w = 'FF' AND vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) or
                        (ie_regra_valor_w = 'DF' AND not vl_procedimento_w between qt_ponto_min_w and qt_ponto_max_w) then					
                        ie_aplica_w := 'N';
                    end if;
                end if;
            end if;

        end if;

    end loop;


    return ie_aplica_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION regra_plano_proced_valor (nr_seq_regra_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_procedimento_p bigint, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_plano_p bigint, ie_origem_proced_p bigint) FROM PUBLIC;

