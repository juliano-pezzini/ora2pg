-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_sne_pend ( nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


	ie_retorno_w	char(1)	:= 'N';
	dt_inicio_w		timestamp;
	ie_data_lib_prescr_w	varchar(1);


BEGIN

	if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

		dt_inicio_w	:= pkg_date_utils.start_of(clock_timestamp() - interval '5 days', 'DAY');
		ie_data_lib_prescr_w := Wheb_assist_pck.obterParametroFuncao(1113,115, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);

		select	coalesce(max('S'),'N')
		into STRICT	ie_retorno_w
		from	prescr_material x,
				prescr_medica a,
				prescr_mat_hor c
		where	x.nr_prescricao = a.nr_prescricao
		and		c.nr_prescricao = a.nr_prescricao
		and		a.nr_atendimento = nr_atendimento_p
		and		a.dt_validade_prescr between dt_inicio_w and clock_timestamp() + interval '2 days'
		and		((obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico,x.dt_lib_material), coalesce(a.dt_liberacao,x.dt_lib_material), coalesce(a.dt_liberacao_farmacia,x.dt_lib_material), ie_data_lib_prescr_w, a.ie_lib_farm) = 'S') or (coalesce(a.ie_prescr_nutricao, 'N') = 'S'))
		and		x.ie_agrupador = 8
		and		substr(obter_status_solucao_prescr(2,a.nr_prescricao,x.nr_sequencia),1,3) in ('I','R')
		and		x.dt_status between dt_inicio_w and clock_timestamp()
		and		coalesce(a.ie_recem_nato,'N') = 'N'
		and		x.ie_status <> 'T'
		and		((coalesce(x.dt_suspensao::text, '') = '') and (coalesce(x.ie_horario_susp,'N') <> 'S'))
		and		a.dt_inicio_prescr between dt_inicio_w and clock_timestamp()  LIMIT 1;

	end if;

	return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_sne_pend ( nr_atendimento_p bigint) FROM PUBLIC;

