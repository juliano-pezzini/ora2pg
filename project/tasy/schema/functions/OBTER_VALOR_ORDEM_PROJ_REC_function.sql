-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_ordem_proj_rec ( nr_ordem_compra_p bigint, nr_seq_proj_rec_p bigint) RETURNS bigint AS $body$
DECLARE

 
vl_item_w				double precision := 0;
pr_desconto_w				double precision := 0;
vl_desconto_w				double precision := 0;
vl_retorno_w				double precision := 0;
vl_frete_w				double precision := 0;
vl_despesa_acessoria_w			double precision := 0;
vl_seguro_w				double precision := 0;
vl_desconto_oc_w			double precision := 0;
ie_frete_w				varchar(01);
nr_item_oci_w				integer;
qt_prevista_entrega_w			double precision;
vl_liquido_unitario_w			double precision;
vl_cancelado_w				double precision := 0;
vl_cancelado_ww				double precision := 0;
cd_estabelecimento_w			smallint;
ie_desconsidera_cancel_w		varchar(1);
vl_despesa_doc_w			double precision;

c01 CURSOR FOR 
SELECT	b.nr_item_oci, 
	b.qt_prevista_entrega 
from	ordem_compra_item a, 
	ordem_compra_item_entrega b 
where	a.nr_ordem_compra = b.nr_ordem_compra 
and	a.nr_item_oci = b.nr_item_oci 
and	a.nr_ordem_compra = nr_ordem_compra_p 
and	(b.dt_cancelamento IS NOT NULL AND b.dt_cancelamento::text <> '') 
and	a.nr_seq_proj_rec = nr_seq_proj_rec_p;


BEGIN 
 
select	coalesce(max(pr_desconto),0), 
	coalesce(max(ie_frete),'C'), 
	coalesce(max(vl_frete),0), 
	coalesce(max(vl_despesa_acessoria),0), 
	coalesce(max(vl_despesa_doc),0), 
	coalesce(max(vl_desconto),0), 
	max(cd_estabelecimento), 
	coalesce(max(vl_seguro),0) 
into STRICT	pr_desconto_w, 
	ie_frete_w, 
	vl_frete_w, 
	vl_despesa_acessoria_w, 
	vl_despesa_doc_w, 
	vl_desconto_oc_w, 
	cd_estabelecimento_w, 
	vl_seguro_w 
from	ordem_compra 
where	nr_ordem_compra	= nr_ordem_compra_p;
 
select	coalesce(ie_desconsidera_vl_item_cancel,'N') 
into STRICT	ie_desconsidera_cancel_w 
from	parametro_compras 
where	cd_estabelecimento = cd_estabelecimento_w;
 
select	coalesce(sum(Obter_Valor_Liquido_Oci(nr_ordem_compra, nr_item_oci)),0) 
into STRICT	vl_item_w 
from	ordem_compra_item 
where	nr_ordem_compra = nr_ordem_compra_p 
and	coalesce(dt_reprovacao::text, '') = '' 
and	nr_seq_proj_rec = nr_seq_proj_rec_p;
 
if (pr_desconto_w > 0) then 
	vl_desconto_w	:= (vl_item_w * pr_desconto_w) / 100;
end if;
 
vl_retorno_w		:= (vl_item_w - vl_desconto_w) - coalesce(vl_desconto_oc_w,0);
 
if (vl_despesa_acessoria_w > 0) then 
	vl_retorno_w	:= (vl_retorno_w + vl_despesa_acessoria_w);
end if;
 
if (vl_despesa_doc_w > 0) then 
	vl_retorno_w	:= (vl_retorno_w + vl_despesa_doc_w);
end if;
 
if (ie_frete_w	= 'F')then 
	vl_retorno_w	:= (vl_retorno_w + vl_frete_w);	
end if;
 
if (vl_seguro_w > 0) then 
	vl_retorno_w	:= (vl_retorno_w + vl_seguro_w);
end if;
 
if (ie_desconsidera_cancel_w = 'S') then 
	 
	open C01;
	loop 
	fetch C01 into	 
		nr_item_oci_w, 
		qt_prevista_entrega_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		select	dividir(vl_item_liquido, qt_material) 
		into STRICT	vl_liquido_unitario_w 
		from	ordem_compra_item 
		where	nr_ordem_compra = nr_ordem_compra_p 
		and	nr_item_oci = nr_item_oci_w 
		and	nr_seq_proj_rec = nr_seq_proj_rec_p;
		 
		vl_cancelado_w 	:= qt_prevista_entrega_w * vl_liquido_unitario_w;
		vl_cancelado_ww	:= vl_cancelado_ww + vl_cancelado_w;
		 
		end;
	end loop;
	close C01;
end if;
 
if (vl_cancelado_ww > 0) then 
	vl_retorno_w	:= (vl_retorno_w - vl_cancelado_ww);
end if;
 
 
return vl_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_ordem_proj_rec ( nr_ordem_compra_p bigint, nr_seq_proj_rec_p bigint) FROM PUBLIC;

