-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION kpi_obter_absenteismo_util ( nr_seq_gerencia_p bigint, nr_seq_grupo_p bigint, cd_pessoa_fisica_p text, dt_referencia_p timestamp) RETURNS bigint AS $body$
DECLARE


resultado_w				double precision;
dt_inicial_w			timestamp;
dt_final_w				timestamp;
nm_usuario_w			varchar(255);
cd_pessoa_fisica_w		varchar(15);
qt_min_trab_w			bigint:= 0;
qt_total_disp_w			bigint:= 0;
qt_total_min_semana_w	bigint:= 0;
qt_dias_falta_w			bigint:= 0;

C01 CURSOR FOR
SELECT	u.nm_usuario,
		u.cd_pessoa_fisica
from	usuario u,
		grupo_desenvolvimento b,
		usuario_grupo_des c,
		gerencia_wheb g,
		pessoa_fisica p
where	u.nm_usuario = c.NM_USUARIO_GRUPO
and		c.nr_seq_grupo = b.nr_sequencia
and		b.nr_seq_gerencia = g.nr_sequencia
and		p.cd_pessoa_fisica = u.cd_pessoa_fisica
and		b.ie_situacao = 'A'
and		u.ie_situacao = 'A'
and		(((coalesce(nr_seq_gerencia_p::text, '') = '') or (g.nr_sequencia = nr_seq_gerencia_p)) or
		((coalesce(nr_seq_grupo_p::text, '') = '') or (b.nr_sequencia = nr_seq_grupo_p)) or 
		((coalesce(cd_pessoa_fisica_p::text, '') = '') or (u.cd_pessoa_fisica = cd_pessoa_fisica_p)))
and		p.cd_cargo not in (63,231,232,112, 841, 1350,1395,1626, 133, 825) -- Gerente Supervisor Estagiario
order by u.nm_usuario;


BEGIN

dt_inicial_w := pkg_date_utils.start_of(dt_referencia_p,'MONTH');
dt_final_w := fim_mes(dt_referencia_p);

open C01;
loop
fetch C01 into	
	nm_usuario_w,
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	/*
	1 Trabalhando
	700 Horas Sobreaviso
	303	Horas Extra 100%
	304 Horas Extra 100% Not
	305 Hora Extra 70%
	306 Hora Extras 70% Not
	*/
	
	select	coalesce(sum(a.qt_min_trab),0)
	into STRICT	qt_min_trab_w
	from	PF_HORA_TRABALHADA a
	where	trunc(dt_referencia_p,'MONTH') = trunc(a.dt_referencia,'MONTH')
	and		a.cd_pessoa_fisica = cd_pessoa_fisica_w
	and		a.cd_sistema in (1,303,304,305,306);	
	
	qt_total_disp_w := (qt_total_disp_w + qt_min_trab_w);
	
	select	sum(OBTER_QT_DIA_UTIL_PERIODO(DT_INICIO,DT_FIM,1))
	into STRICT	qt_dias_falta_w
	from (	SELECT	min(x.DT_INICIO) DT_INICIO,
					max(x.DT_FIM) DT_FIM
			from (	select	case when(trunc(A.DT_INICIO) < trunc(dt_referencia_p,'MONTH')) then
									trunc(dt_referencia_p,'MONTH')
								else
									trunc(A.DT_INICIO)
								end dt_inicio,
								case when(trunc(A.DT_FIM) > trunc(last_day(trunc(dt_referencia_p)))) then
										trunc(last_day(trunc(dt_referencia_p)))
								else 
									trunc(A.DT_FIM)
								end DT_FIM
						from	AUSENCIA_TASY a
						where	trunc(dt_referencia_p,'MONTH') BETWEEN trunc(A.DT_INICIO,'MONTH') AND trunc(A.DT_FIM,'MONTH')
						and		a.nm_usuario_ausente =  nm_usuario_w) x) alias22;

	qt_total_min_semana_w := ( qt_total_min_semana_w + ((OBTER_QT_DIA_UTIL_PERIODO( dt_inicial_w, dt_referencia_p, 1) - qt_dias_falta_w )*507));
	
	end;
end loop;
close C01;

resultado_w:= (dividir(qt_total_disp_w,qt_total_min_semana_w)*100);

if (resultado_w > 100) then
	resultado_w     := 100;
end if;

return resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION kpi_obter_absenteismo_util ( nr_seq_gerencia_p bigint, nr_seq_grupo_p bigint, cd_pessoa_fisica_p text, dt_referencia_p timestamp) FROM PUBLIC;

