-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_estagio_atual_prescricao (nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE


ie_estagio_w		varchar(5) := '';

BEGIN

select max('N')
into STRICT	ie_estagio_w
from 	prescr_opm b
where b.nr_prescricao = nr_prescricao_p
and 	(b.ie_estagio_atual IS NOT NULL AND b.ie_estagio_atual::text <> '');

if (ie_estagio_w = 'N') then
		select coalesce(max('PV'),'N')
		into STRICT   ie_estagio_w
		from   prescr_medica a
		where  a.nr_prescricao = nr_prescricao_p
		and	 exists (SELECT 1
							from prescr_opm b
							where a.nr_prescricao	= b.nr_prescricao
							and b.ie_estagio_atual	= 'PV');
end if;

if (ie_estagio_w = 'N') then
	   select coalesce(max('PA'),'N')
	   into STRICT   ie_estagio_w
	   from   prescr_medica a
	   where  a.nr_prescricao = nr_prescricao_p
	   and	 exists (SELECT 1
							from prescr_opm b
							where a.nr_prescricao	= b.nr_prescricao
							and b.ie_estagio_atual	= 'PA');
end if;

if (ie_estagio_w = 'N') then
	   select coalesce(max('OP'),'N')
	   into STRICT	ie_estagio_w
	   from  prescr_opm a
	   where a.nr_prescricao	= nr_prescricao_p
		and 	a.ie_estagio_atual= 'OP';
end if;

if (ie_estagio_w = 'N') then
	   select coalesce(max('FI'),'N')
	   into STRICT	ie_estagio_w
	   from  prescr_opm a
	   where a.nr_prescricao	= nr_prescricao_p
		and 	a.ie_estagio_atual= 'FI';
end if;


if (ie_estagio_w = 'N') then
	   ie_estagio_w := 'OC';
end if;

return ie_estagio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_estagio_atual_prescricao (nr_prescricao_p bigint) FROM PUBLIC;

