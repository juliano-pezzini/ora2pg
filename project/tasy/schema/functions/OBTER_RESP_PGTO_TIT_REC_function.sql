-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_resp_pgto_tit_rec ( nr_titulo_p bigint, tipo_retorno_p text default 'N') RETURNS varchar AS $body$
DECLARE

 
/* N = Nome 
  C -> Codigo 
 
*/
   
 
nm_pessoa_resp_w	varchar(80);
cd_pessoa_w		varchar(50);
nr_seq_resp_pgto_w	bigint;


BEGIN 
 
begin 
select	max(a.nr_sequencia) 
into STRICT	nr_seq_resp_pgto_w 
from	titulo_receber			b, 
	titulo_receber_resp_pgto	a 
where	b.nr_titulo		= a.nr_titulo 
and	b.nr_titulo		= nr_titulo_p 
and	trunc(b.dt_emissao,'dd') between trunc(a.dt_inicio_vigencia,'dd') and trunc(coalesce(a.dt_fim_vigencia,b.dt_emissao));
exception 
when others then 
	nr_seq_resp_pgto_w	:= null;
end;
 
 
if (nr_seq_resp_pgto_w IS NOT NULL AND nr_seq_resp_pgto_w::text <> '') then 
 
	select	max(cd_pessoa), 
		max(nm_pessoa) 
	into STRICT	cd_pessoa_w, 
		nm_pessoa_resp_w 
	from (SELECT	max(pf.cd_pessoa_fisica) cd_pessoa, 
			max(substr(obter_nome_pf(pf.cd_pessoa_fisica),1,255)) nm_pessoa 
		from	pessoa_fisica			pf, 
			titulo_receber_resp_pgto	a 
		where	pf.cd_pessoa_fisica	= a.cd_pessoa_fisica 
		and	a.nr_sequencia		= nr_seq_resp_pgto_w 
		
union all
 
		SELECT	max(pj.cd_cgc) cd_pessoa, 
			max(pj.ds_razao_social) nm_pessoa 
		from	pessoa_juridica			pj, 
			titulo_receber_resp_pgto	a 
		where	pj.cd_cgc	= a.cd_cgc 
		and	a.nr_sequencia	= nr_seq_resp_pgto_w 
		) alias9;
end if;
 
if (tipo_retorno_p = 'N') then 
	return	nm_pessoa_resp_w;
else 
	return	cd_pessoa_w;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_resp_pgto_tit_rec ( nr_titulo_p bigint, tipo_retorno_p text default 'N') FROM PUBLIC;

