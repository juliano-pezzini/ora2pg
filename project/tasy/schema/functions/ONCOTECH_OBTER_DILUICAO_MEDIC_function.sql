-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION oncotech_obter_diluicao_medic ( NR_SEQUENCIA_P bigint, NR_PRESCRICAO_P bigint) RETURNS varchar AS $body$
DECLARE


cd_material_w			integer;
cd_medic_w			integer;
qt_dose_w			double precision;
qt_dose_ml_w			double precision;
cd_unid_med_dose_w		varchar(30) := '';
ds_material_w			varchar(100);
ie_possui_diluente_w		varchar(1);
ds_material_ww			varchar(100);
ds_reduzida_w			varchar(100);
ds_diluir_w			varchar(4000) := '';
ds_rediluir_w			varchar(4000) := '';
ds_retorno_w			varchar(2000) := '';
ds_reconstituir_w		varchar(2000) := '';
ds_hora_w			varchar(10) := '';
ie_agrupador_w			smallint;
qt_dose_mat_w			double precision;
qt_dose_mat_str_w		varchar(20) := '';
cd_unid_med_dose_mat_w		varchar(30) := '';
qt_solucao_w			double precision := 0;
qt_solucao_str_w		varchar(10) :='';
ds_dose_diferenciada_w		varchar(50);
ds_erro_w			varchar(2000);
ie_ordem_w			smallint;
qt_solucao_ww			double precision := 0;
qt_min_aplicacao_w		smallint  := 0;
qt_min_aplicacao_ant_w		smallint  := 0;
qt_hora_aplicacao_ant_w		smallint  := 0;
qt_hora_aplicacao_w		smallint  := 0;
ds_min_aplicacao_w		varchar(255) := '';
cd_volume_final_w		double precision := 0;
mascara_w			smallint := 0;
qt_dose_str_w			varchar(20) := '';
cd_volume_final_str_w		varchar(20) := '';
qt_diluicao_w			double precision := 0;
qt_conversao_w			double precision;
cd_diluente_w			integer  := 0;
ds_diluente_w			varchar(100) := '';
qt_diluicao_str_w		varchar(20) := '';
ds_intervalo_w			varchar(50) := '';
cd_unidade_medida_w		varchar(30);
ds_conv_ml_w			varchar(20) := '';
qt_conv_ml_w			double precision;
qt_dose_onco_w			double precision;
cd_unidade_medida_dose_onco_w	varchar(30);
cd_estabelecimento_w		smallint;
qt_registro_w			smallint := 0;
ie_descr_redu_dil_w		varchar(1);

ds_aux_diluir_w			varchar(30);
ie_via_aplicacao_w		varchar(5);
cd_intervalo_w			varchar(7);
qt_ml_diluente_w		double precision;
ds_volume_w			varchar(100);
ds_tempo_w			varchar(100);
qt_dose_medic_ml_w		double precision;
ds_aplicar_w			varchar(200);
ds_diluicao_edit_w		varchar(2000);
ie_aplicar_w			varchar(1);
ds_dose_diluicao_w		varchar(100);
qt_dose_unid_med_cons_w		double precision;
qt_vol_adic_reconst_w		double precision;
ie_indice_w			smallint;

cd_material_red_w		integer;
qt_dose_red_w			double precision;
cd_unid_med_dose_red_w		varchar(30) := '';
qt_solucao_red_w		double precision := 0;
qt_dose_ml_red_w		double precision;
ds_material_red_ww		varchar(100);
ds_reduzida_red_w		varchar(100);
ds_material_red_w		varchar(100);
cd_volume_final_red_w		double precision := 0;
qt_diluicao_aux_w		double precision;
cd_unid_med_diluente_aux_w	varchar(50);

c00 CURSOR FOR
SELECT	b.qt_dose,
	b.qt_min_aplicacao,
	b.qt_hora_aplicacao,
	b.cd_unidade_medida_dose,
	b.qt_solucao,
	b.cd_unidade_medida,
	b.cd_material,
	a.cd_estabelecimento,
	b.cd_intervalo,
	b.ie_via_aplicacao,
	b.ds_dose_diferenciada,
	1 ie_indice,
	null ds_hora,
	1 ie_ordem,
	0 qt_diluicao,
	null cd_unid_med_diluente
from 	prescr_material b,
	prescr_medica a
where 	a.nr_prescricao	= b.nr_prescricao
and	b.nr_sequencia	= nr_sequencia_p
and	a.nr_prescricao	= nr_prescricao_p
and	b.ie_agrupador	in (1, 5, 8, 14)
and	not exists (	select	1
			from	prescr_mat_diluicao x
			where	x.nr_prescricao	= b.nr_prescricao
			and	x.nr_seq_material = b.nr_sequencia)

union

select	coalesce(c.qt_dose_diferenciada, b.qt_dose),
	coalesce(c.qt_min_aplicacao, b.qt_min_aplicacao),
	b.qt_hora_aplicacao,
	b.cd_unidade_medida_dose,
	b.qt_solucao,
	b.cd_unidade_medida,
	b.cd_material,
	a.cd_estabelecimento,
	b.cd_intervalo,
	b.ie_via_aplicacao,
	b.ds_dose_diferenciada,
	2 ie_indice,
	c.ds_hora,
	c.ie_ordem,
	c.qt_diluicao,
	c.cd_unid_med_diluente
from 	prescr_mat_diluicao c,
	prescr_material b,
	prescr_medica a
where 	a.nr_prescricao	= b.nr_prescricao
and	c.nr_prescricao	= b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_sequencia	= nr_sequencia_p
and	a.nr_prescricao	= nr_prescricao_p
and	b.ie_agrupador	in (1,5,8,14)
order by ie_ordem;

c01 CURSOR FOR
SELECT	a.cd_material,
	a.qt_dose,
	coalesce(a.qt_vol_adic_reconst,0),
	a.qt_min_aplicacao,
	a.qt_hora_aplicacao,
	a.cd_unidade_medida_dose,
	a.ie_agrupador,
	a.qt_solucao,
	obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose),
	substr(b.ds_material,1,100),
	substr(b.ds_reduzida,1,100)
from 	material b,
	prescr_material a
where 	((a.nr_sequencia_diluicao = nr_sequencia_p) or (a.nr_sequencia = nr_sequencia_p))
  and 	a.nr_prescricao = nr_prescricao_p
  and	a.cd_material = b.cd_material
  and	a.ie_agrupador IN (3,7,9)
order by a.ie_agrupador desc;


BEGIN

select	max(ds_diluicao_edit),
		max(qt_dose),
		max(cd_unidade_medida_dose)
into STRICT	ds_diluicao_edit_w,
		qt_dose_onco_w,
		cd_unidade_medida_dose_onco_w
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	nr_sequencia	= nr_sequencia_p;

if (coalesce(ds_diluicao_edit_w::text, '') = '') then

	ie_possui_diluente_w	:= 'N';

	open C00;
	loop
	fetch C00 into
		qt_dose_mat_w,
		qt_min_aplicacao_w,
		qt_hora_aplicacao_w,
		cd_unid_med_dose_mat_w,
		qt_solucao_ww,
		cd_unidade_medida_w,
		cd_medic_w,
		cd_estabelecimento_w,
		cd_intervalo_w,
		ie_via_aplicacao_w,
		ds_dose_diferenciada_w,
		ie_indice_w,
		ds_hora_w,
		ie_ordem_w,
		qt_diluicao_aux_w,
		cd_unid_med_diluente_aux_w;
	EXIT WHEN NOT FOUND; /* apply on C00 */

	/*select	b.qt_dose,
		b.qt_min_aplicacao,
		b.qt_hora_aplicacao,
		b.cd_unidade_medida_dose,
		b.qt_solucao,
		b.cd_unidade_medida,
		b.cd_material,
		a.cd_estabelecimento,
		b.cd_intervalo,
		b.ie_via_aplicacao,
		b.ds_dose_diferenciada
	into	qt_dose_mat_w,
		qt_min_aplicacao_w,
		qt_hora_aplicacao_w,
		cd_unid_med_dose_mat_w,
		qt_solucao_ww,
		cd_unidade_medida_w,
		cd_medic_w,
		cd_estabelecimento_w,
		cd_intervalo_w,
		ie_via_aplicacao_w,
		ds_dose_diferenciada_w
	from 	prescr_material b,
		prescr_medica a
	where 	a.nr_prescricao	= b.nr_prescricao
	and	b.nr_sequencia	= nr_sequencia_p
	and	a.nr_prescricao	= nr_prescricao_p
	and	b.ie_agrupador	in (1,8, 14);*/
		select	coalesce(max(ie_aplicar),'N')
		into STRICT	ie_aplicar_w
		from	parametro_medico
		where	cd_estabelecimento	= cd_estabelecimento_w;

		if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
			select	max(ds_prescricao)
			into STRICT	ds_intervalo_w
			from	intervalo_prescricao
			where	cd_intervalo	= cd_intervalo_w;

			if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
				ds_intervalo_w	:= ds_intervalo_w ||' '||ie_via_aplicacao_w;
			end if;
		end if;

		select	coalesce(max(ie_descr_redu_dil),'N')
		into STRICT	ie_descr_redu_dil_w
		from	parametro_medico
		where	cd_estabelecimento	= cd_estabelecimento_w;

		select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
		into STRICT	qt_conv_ml_w
		;

		if (qt_conv_ml_w > 0) and (upper(cd_unid_med_dose_mat_w) <> upper(obter_unid_med_usua('ML'))) then
			if (qt_conv_ml_w >= 1) then
				ds_conv_ml_w	:= to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
			else
				ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
			end if;
		end if;

		qt_dose_mat_str_w	:= qt_dose_mat_w;

		open c01;
		loop
		fetch c01 into
			cd_material_w,
			qt_dose_w,
			qt_vol_adic_reconst_w,
			qt_min_aplicacao_ant_w,
			qt_hora_aplicacao_ant_w,
			cd_unid_med_dose_w,
			ie_agrupador_w,
			qt_solucao_w,
			qt_dose_ml_w,
			ds_material_ww,
			ds_reduzida_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 9) and (coalesce(qt_registro_w,0) = 0) then
				begin

				select	obter_conversao_ml(cd_material_w,qt_dose_w + qt_vol_adic_reconst_w,cd_unid_med_dose_w)
				into STRICT	qt_conv_ml_w
				;

				if (upper(cd_unid_med_dose_mat_w) = upper(obter_unid_med_usua('ML'))) then
					begin
					qt_conv_ml_w	:= qt_dose_mat_w;
					end;
				else
					begin
					qt_dose_unid_med_cons_w	:= obter_conversao_unid_med_cons(cd_medic_w,cd_unid_med_dose_mat_w,qt_dose_mat_w);
					qt_conv_ml_w		:= qt_dose_unid_med_cons_w * qt_conv_ml_w;
					end;
				end if;

				if (qt_conv_ml_w > 0) then
					if (qt_conv_ml_w >= 1) then
						ds_conv_ml_w	:= to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
					else
						ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
					end if;
				end if;

				select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
			   	into STRICT	ds_material_w
			   	;

				if (qt_dose_w < 1) or (mod(qt_dose_w, trunc(qt_dose_w)) <> 0) then
					mascara_w	:= 0;
				else
					mascara_w	:= 1;
				end if;

				Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_dose_w, 2)  ELSE campo_mascara(qt_dose_w, 0) END
				into STRICT	qt_dose_str_w
				;

				select	max(qt_conversao)
				into STRICT	qt_conversao_w
				from	material_conversao_unidade
				where	cd_material		= cd_medic_w
				and	cd_unidade_medida	= cd_unidade_medida_w;

				if (coalesce(qt_conversao_w::text, '') = '') then
					ds_reconstituir_w := 	ds_reconstituir_w ||'Reconstituir cada ' ||cd_unidade_medida_w||
							' em '||replace(qt_dose_str_w,'.',',')||' '||cd_unid_med_dose_w||
							' de '||ds_material_w || chr(13) || chr(10);
				else
					ds_reconstituir_w := 	ds_reconstituir_w ||'Reconstituir cada ' || qt_conversao_w || ' ' ||cd_unidade_medida_w||
							' em '||replace(qt_dose_str_w,'.',',')||' '||cd_unid_med_dose_w||
							' de '||ds_material_w || chr(13) || chr(10);
				end if;
				end;
			end if;

			if (ie_indice_w		= 2) and (coalesce(qt_registro_w,0)	= 0) and (coalesce(ds_rediluir_w::text, '') = '') then

				select	max(a.cd_material),
					max(a.qt_dose),
					max(a.cd_unidade_medida_dose),
					max(a.qt_solucao),
					max(obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose)),
					max(substr(b.ds_material,1,100)),
					max(substr(b.ds_reduzida,1,100))
				into STRICT	cd_material_red_w,
					qt_dose_red_w,
					cd_unid_med_dose_red_w,
					qt_solucao_red_w,
					qt_dose_ml_red_w,
					ds_material_red_ww,
					ds_reduzida_red_w
				from 	material b,
					prescr_material a
				where 	((a.nr_sequencia_diluicao = nr_sequencia_p) or (a.nr_sequencia = nr_sequencia_p))
				  and 	a.nr_prescricao = nr_prescricao_p
				  and	a.cd_material = b.cd_material
				  and	a.ie_agrupador = 7;

				if (cd_material_red_w IS NOT NULL AND cd_material_red_w::text <> '') and (qt_dose_red_w IS NOT NULL AND qt_dose_red_w::text <> '') and (cd_unid_med_dose_red_w IS NOT NULL AND cd_unid_med_dose_red_w::text <> '') then

					select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_red_w  ELSE ds_material_red_ww END
					into STRICT	ds_material_red_w
					;

					cd_volume_final_red_w := qt_dose_ml_red_w + qt_solucao_red_w;

					if (qt_solucao_red_w < 1) or (mod(qt_solucao_red_w, trunc(qt_solucao_red_w)) <> 0) then
						mascara_w	:= 0;
					else
						mascara_w	:= 1;
					end if;

					ds_dose_diluicao_w	:= replace(qt_dose_ml_red_w,'.',',') ||' '||obter_unid_med_usua('ml');
					if (qt_dose_ml_red_w = 0) then
						begin
						ds_dose_diluicao_w	:= replace(qt_dose_red_w,'.',',') ||' '||cd_unid_med_dose_red_w;
						end;
					end if;

					select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_solucao_red_w, 2)  ELSE campo_mascara(qt_solucao_red_w, 0) END
					into STRICT	qt_solucao_str_w
					;

					ds_rediluir_w := ds_rediluir_w||'Rediluir '||replace(qt_solucao_str_w,'.',',')||' '||obter_unid_med_usua('ml')||' da solução em '||
							 ds_dose_diluicao_w ||' de '||ds_material_red_w || chr(13) || chr(10);
				end if;
			end if;

			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 3) then
			   	begin
				qt_ml_diluente_w	:= qt_dose_ml_w;
				select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
			   	into STRICT	ds_material_w
			   	;

				ds_aux_diluir_w	:= ' do medicamento';
				if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
					ds_aux_diluir_w	:= ' da reconstituição';
				end if;

				ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' '||obter_unid_med_usua('ml');
				if (qt_dose_ml_w = 0) then
					begin
					ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') ||' '||cd_unid_med_dose_w;
					end;
				end if;

				if (coalesce(qt_solucao_w,0)	> 0) then /*Caldas - OS153626 13/07/2009 */
					if (qt_solucao_w >= 1) then
						ds_conv_ml_w	:= to_char(qt_solucao_w)||' '||obter_unid_med_usua('ml');
					else
						ds_conv_ml_w	:= '0'||to_char(qt_solucao_w)||' '||obter_unid_med_usua('ml');
					end if;

					qt_conv_ml_w	:= qt_solucao_w;
				end if;

				if (ie_indice_w = 2) then
					ds_aux_diluir_w	:= ' do medicamento';
					if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
						ds_aux_diluir_w	:= ' da reconstituição';
					end if;

					if (qt_min_aplicacao_w IS NOT NULL AND qt_min_aplicacao_w::text <> '') then
						ds_tempo_w	:= 'em ' || to_char(qt_min_aplicacao_w) || ' min. no horário ' || ds_hora_w;
					end if;

					ds_volume_w	:= ' '||to_char(qt_conv_ml_w + qt_ml_diluente_w) ||' '||obter_unid_med_usua('ml');

					if (ds_volume_w IS NOT NULL AND ds_volume_w::text <> '') then
						ds_aplicar_w	:= 'Aplicar'|| replace(ds_volume_w,'.',',') || ' '|| ds_tempo_w;
					elsif (ds_tempo_w IS NOT NULL AND ds_tempo_w::text <> '') then
						ds_aplicar_w	:= 'Aplicar'||ds_tempo_w;
					end if;


					select	max(obter_conversao_ml(cd_material_w,qt_diluicao_aux_w,cd_unid_med_diluente_aux_w))
					into STRICT	qt_dose_ml_w
					;

					ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' '||obter_unid_med_usua('ml');
					if (qt_dose_ml_w = 0) then
						ds_dose_diluicao_w	:= replace(qt_diluicao_aux_w,'.',',') ||' '||cd_unid_med_diluente_aux_w;
					end if;

					ds_diluir_w := 	ds_diluir_w ||'Diluir '||replace(qt_dose_onco_w,'.',',')||' '||cd_unidade_medida_dose_onco_w|| ds_aux_diluir_w||' em '||
							ds_dose_diluicao_w ||' de '||ds_material_w || chr(13) || chr(10) ||
							ds_rediluir_w || ds_aplicar_w || chr(13) || chr(10);

				elsif (coalesce(ds_conv_ml_w::text, '') = '') and (coalesce(ds_diluir_w::text, '') = '') then

					if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then

						ds_aux_diluir_w	:= 'medicamento';
						if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
							ds_aux_diluir_w	:= 'reconstituição';
						end if;

						ds_diluir_w := 	ds_diluir_w ||'Diluir '|| ds_aux_diluir_w || ' conforme dose do horário ('||ds_dose_diferenciada_w||') em '||
							ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);
					else
						ds_diluir_w := 	ds_diluir_w ||'Diluir '||replace(qt_dose_onco_w,'.',',')||' '||cd_unidade_medida_dose_onco_w|| ds_aux_diluir_w||' em '||
							ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);

					end if;
				elsif (coalesce(ds_diluir_w::text, '') = '') then

					if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then

						ds_aux_diluir_w	:= 'medicamento';
						if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
							ds_aux_diluir_w	:= 'reconstituição';
						end if;

						ds_diluir_w := 	ds_diluir_w ||'Diluir '||ds_aux_diluir_w||' conforme dose do horário ('||ds_dose_diferenciada_w||') em '||
							ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);

					else
						ds_diluir_w := 	ds_diluir_w ||'Diluir '||qt_dose_onco_w||' '||cd_unidade_medida_dose_onco_w||' '||ds_aux_diluir_w||' em '||
							ds_dose_diluicao_w||' de '||ds_material_w || chr(13) || chr(10);
					end if;
				else
					ds_diluir_w := 	ds_diluir_w ||'Diluir a solução em '||
						ds_dose_diluicao_w ||' de '||ds_material_w || chr(13) || chr(10);
				end if;
			   	end;
			end if;

			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 7) and (ie_indice_w <> 2) then
			   	begin
				select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
			   	into STRICT	ds_material_w
			   	;

				cd_volume_final_w := qt_dose_ml_w + qt_solucao_w;

				if (qt_solucao_w < 1) or (mod(qt_solucao_w, trunc(qt_solucao_w)) <> 0) then
					mascara_w	:= 0;
				else
					mascara_w	:= 1;
				end if;

				ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' '||obter_unid_med_usua('ml');
				if (qt_dose_ml_w = 0) then
					begin
					ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') ||' '||cd_unid_med_dose_w;
					end;
				end if;

				Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_solucao_w, 2)  ELSE campo_mascara(qt_solucao_w, 0) END
				into STRICT	qt_solucao_str_w
				;

			   	ds_rediluir_w := ds_rediluir_w||'Rediluir '||replace(qt_solucao_str_w,'.',',')||' '||obter_unid_med_usua('ml')||' da solução em '||
						 ds_dose_diluicao_w ||' de '||ds_material_w || chr(13) || chr(10);
			   	end;
			end if;
			end;

			ie_possui_diluente_w	:= 'S';

		end loop;
		close c01;

		qt_registro_w	:= qt_registro_w + 1;

	end loop;
	close C00;

	ds_aplicar_w	:= '';

	if (cd_volume_final_w < 1) or (mod(cd_volume_final_w, trunc(cd_volume_final_w)) <> 0) then
		mascara_w	:= 0;
	else
		mascara_w	:= 1;
	end if;

	Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(cd_volume_final_w, 2)  ELSE campo_mascara(cd_volume_final_w, 0) END
	into STRICT	cd_volume_final_str_w
	;

	if (qt_min_aplicacao_w IS NOT NULL AND qt_min_aplicacao_w::text <> '') and (qt_hora_aplicacao_w IS NOT NULL AND qt_hora_aplicacao_w::text <> '') and
		((coalesce(qt_min_aplicacao_w,0) > 0) and (coalesce(qt_hora_aplicacao_w,0) > 0))then
		ds_tempo_w	:=  ' em ' || to_char(qt_hora_aplicacao_w) || ' h. e '|| to_char(qt_min_aplicacao_w) || ' min.';
	elsif (coalesce(qt_min_aplicacao_w::text, '') = '') and (qt_hora_aplicacao_w IS NOT NULL AND qt_hora_aplicacao_w::text <> '') then
		ds_tempo_w	:= ' em ' || to_char(qt_hora_aplicacao_w) || ' h.';
	elsif (qt_min_aplicacao_w IS NOT NULL AND qt_min_aplicacao_w::text <> '') and (coalesce(qt_hora_aplicacao_w::text, '') = '') then
		ds_tempo_w	:= ' em ' || to_char(qt_min_aplicacao_w) || ' min.';
	end if;

	ds_volume_w := null;
	if (qt_solucao_ww IS NOT NULL AND qt_solucao_ww::text <> '') and (qt_solucao_ww > 0) then
		ds_volume_w	:= ' '||to_char(qt_solucao_ww) ||' '||obter_unid_med_usua('ml');
	elsif (ie_aplicar_w = 'S') then
		begin
		if (ds_rediluir_w IS NOT NULL AND ds_rediluir_w::text <> '') then
			ds_volume_w	:= ' '||cd_volume_final_str_w ||' '||obter_unid_med_usua('ml');
		elsif (ds_diluir_w IS NOT NULL AND ds_diluir_w::text <> '') then
			ds_volume_w	:= ' '||to_char(qt_conv_ml_w + qt_ml_diluente_w) ||' '||obter_unid_med_usua('ml');
		elsif (ds_conv_ml_w IS NOT NULL AND ds_conv_ml_w::text <> '') then
			ds_volume_w	:= ' '||ds_conv_ml_w;
		end if;

		end;
	end if;

	if (ie_indice_w <> 2) or (ie_possui_diluente_w = 'N') then
		if (ds_volume_w IS NOT NULL AND ds_volume_w::text <> '') then
			ds_aplicar_w	:= 'Aplicar'|| replace(ds_volume_w,'.',',') || ' ('||ds_intervalo_w||') '|| ds_tempo_w;
		elsif (ds_tempo_w IS NOT NULL AND ds_tempo_w::text <> '') then
			ds_aplicar_w	:= 'Aplicar'||ds_tempo_w;
		end if;
	else
		ds_rediluir_w	:= '';
	end if;

	ds_retorno_w 	:= ds_reconstituir_w || ds_diluir_w || ds_rediluir_w || ds_aplicar_w;
	ds_retorno_w	:= replace(ds_retorno_w,' ,',' 0,');
	ds_retorno_w	:= replace(ds_retorno_w,' .',' 0,');

else
	ds_retorno_w	:= ds_diluicao_edit_w;
end if;

RETURN substr(ds_retorno_w,1,2000);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION oncotech_obter_diluicao_medic ( NR_SEQUENCIA_P bigint, NR_PRESCRICAO_P bigint) FROM PUBLIC;

