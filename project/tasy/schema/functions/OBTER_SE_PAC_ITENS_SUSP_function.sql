-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_pac_itens_susp (nr_atendimento_p bigint, ie_lista_tipos_p text default null, ie_lista_outros_p text default null, ie_restricao_prescritor_p text default null) RETURNS timestamp AS $body$
DECLARE


max_suspensao_w		timestamp;
max_suspensao_2w 	timestamp;
ie_lista_tipos_w	varchar(200);
nr_registro_w 		bigint;

C01 CURSOR FOR
	SELECT	nr_registro
	from	table(lista_pck.obter_lista(ie_lista_outros_p))
	order by nr_registro;

C02 CURSOR FOR
	SELECT	nr_registro
	from	table(lista_pck.obter_lista(ie_lista_tipos_p))
	order by nr_registro;

function buscar_todos(nr_registro_p bigint) return timestamp is
dt_suspensao_w	timestamp;

BEGIN

	select	max(dt_suspensao)
	into STRICT	dt_suspensao_w
	from	(SELECT	dt_suspensao
			from	cpoe_material a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and		((ie_controle_tempo = 'S' AND nr_registro_p = 16) or
					(ie_controle_tempo = 'N' AND nr_registro_p = 7) or
					(ie_material = 'S' AND nr_registro_p = 6))
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
			
union all

			SELECT	dt_suspensao
			from	cpoe_dieta a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and		((ie_tipo_dieta = 'O' AND nr_registro_p = 2) or
					(ie_tipo_dieta = 'E' AND nr_registro_p = 14) or
					(ie_tipo_dieta = 'S' AND nr_registro_p = 15) or
					(ie_tipo_dieta = 'J' AND nr_registro_p = 5) or
					(ie_tipo_dieta = 'L' AND nr_registro_p = 21) or (ie_tipo_dieta in ('P','I') and (nr_registro_p = 8)))
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
			
union all

			select	dt_suspensao
			from	cpoe_recomendacao a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and 	nr_registro_p = 13
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
			
union all

			select	dt_suspensao
			from	cpoe_gasoterapia a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and		nr_registro_p = 3
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
			
union all

			select	dt_suspensao
			from	cpoe_procedimento a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and		nr_registro_p = 12
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
			
union all

			select	dt_suspensao
			from	cpoe_dialise a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and		nr_registro_p = 1
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))) alias128;

	return	dt_suspensao_w;

end;

function buscar_outros(nr_registro_p number) return date is
dt_suspensao_w	date;
begin

	select	max(dt_suspensao)
	into STRICT	dt_suspensao_w
	from	(SELECT	dt_suspensao
			from	cpoe_material a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and		((ie_controle_tempo = 'S' AND nr_registro_p <> 16) or
					(ie_controle_tempo = 'N' AND nr_registro_p <> 7) or
					(ie_material = 'S' AND nr_registro_p <> 6))
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
			
union all

			SELECT	dt_suspensao
			from	cpoe_dieta a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and		((ie_tipo_dieta = 'O' AND nr_registro_p <> 2) or
					(ie_tipo_dieta = 'E' AND nr_registro_p <> 14) or
					(ie_tipo_dieta = 'S' AND nr_registro_p <> 15) or
					(ie_tipo_dieta = 'J' AND nr_registro_p <> 5) or
					(ie_tipo_dieta = 'L' AND nr_registro_p <> 21) or (ie_tipo_dieta in ('P','I') and (nr_registro_p <> 8)))
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
			
union all

			select	dt_suspensao
			from	cpoe_recomendacao a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and 	nr_registro_p <> 13
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
			
union all

			select	dt_suspensao
			from	cpoe_gasoterapia a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and		nr_registro_p <> 3
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
			
union all

			select	dt_suspensao
			from	cpoe_procedimento a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and		nr_registro_p <> 12
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
			
union all

			select	dt_suspensao
			from	cpoe_dialise a
			where	nr_atendimento = nr_atendimento_p
			and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and		nr_registro_p <> 1
			and		((ie_restricao_prescritor_p = 'A') or
					((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
					((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
					((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))) alias128;

	return	dt_suspensao_w;

end;

begin
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (obter_se_atendimento_alta(nr_atendimento_p) = 'N') then

	if (ie_lista_outros_p IS NOT NULL AND ie_lista_outros_p::text <> '') then

		open C01;
		loop
		fetch C01 into
			nr_registro_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			max_suspensao_2w := buscar_outros(nr_registro_w);

			if (coalesce(max_suspensao_w::text, '') = '') or (max_suspensao_2w > max_suspensao_w) then
				max_suspensao_w := max_suspensao_2w;
			end if;

			end;
		end loop;
		close C01;

	elsif (ie_lista_tipos_p IS NOT NULL AND ie_lista_tipos_p::text <> '') then

		open C02;
		loop
		fetch C02 into
			nr_registro_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			max_suspensao_2w := buscar_todos(nr_registro_w);

			if (coalesce(max_suspensao_w::text, '') = '') or (max_suspensao_2w > max_suspensao_w) then
				max_suspensao_w := max_suspensao_2w;
			end if;

			end;
		end loop;
		close C02;

	elsif (coalesce(ie_restricao_prescritor_p,'A') <> 'A') then

		select	max(dt_suspensao)
		into STRICT	max_suspensao_w
		from	(SELECT	dt_suspensao
				from	cpoe_material a
				where	nr_atendimento = nr_atendimento_p
				and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
				and		(((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
						((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
						((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
				
union all

				SELECT	dt_suspensao
				from	cpoe_dieta a
				where	nr_atendimento = nr_atendimento_p
				and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
				and		(((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
						((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
						((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
				
union all

				select	dt_suspensao
				from	cpoe_recomendacao a
				where	nr_atendimento = nr_atendimento_p
				and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
				and		(((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
						((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
						((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
				
union all

				select	dt_suspensao
				from	cpoe_gasoterapia a
				where	nr_atendimento = nr_atendimento_p
				and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
				and		(((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
						((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
						((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
				
union all

				select	dt_suspensao
				from	cpoe_procedimento a
				where	nr_atendimento = nr_atendimento_p
				and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
				and		(((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
						((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
						((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))
				
union all

				select	dt_suspensao
				from	cpoe_dialise a
				where	nr_atendimento = nr_atendimento_p
				and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
				and		(((ie_restricao_prescritor_p = 'M') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') = 'S')) or
						((ie_restricao_prescritor_p = 'F') and (obter_se_medico(obter_pf_usuario(coalesce(a.nm_usuario_nrec,a.nm_usuario),'C'),'M') <> 'S')) or
						((ie_restricao_prescritor_p = 'N') and (coalesce(nr_sequencia::text, '') = '')))) alias111;

	else

		select	max(dt_suspensao)
		into STRICT	max_suspensao_w
		from (SELECT	dt_suspensao
				from	cpoe_material a
				where	nr_atendimento = nr_atendimento_p
				
union all

				SELECT	dt_suspensao
				from	cpoe_dieta a
				where	nr_atendimento = nr_atendimento_p
				
union all

				select	dt_suspensao
				from	cpoe_recomendacao a
				where	nr_atendimento = nr_atendimento_p
				
union all

				select	dt_suspensao
				from	cpoe_gasoterapia a
				where	nr_atendimento = nr_atendimento_p
				
union all

				select	dt_suspensao
				from	cpoe_procedimento a
				where	nr_atendimento = nr_atendimento_p
				
union all

				select	dt_suspensao
				from	cpoe_dialise a
				where	nr_atendimento = nr_atendimento_p) alias1;

	end if;

end if;

return	max_suspensao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_pac_itens_susp (nr_atendimento_p bigint, ie_lista_tipos_p text default null, ie_lista_outros_p text default null, ie_restricao_prescritor_p text default null) FROM PUBLIC;

