-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_atepacu_data ( nr_atendimento_p bigint, /*					cd_setor_atendimento_p	Number,*/

 ie_opcao_p text, dt_referencia_p timestamp) RETURNS bigint AS $body$
DECLARE


/* UNIDADE DO PACIENTE				*/

/*	P = Primeira Unidade          		*/

/* 	A = Unidade Atual  			*/

/*	PI = Primeira Unidade Internação	*/

/*	IA = Internação Atual			*/

nr_seq_atepacu_w			bigint;


BEGIN

if (ie_opcao_p = 'P') then
	select	coalesce(min(nr_seq_interno),0)
	into STRICT	nr_seq_atepacu_w
	from 	atend_paciente_unidade a
	where	a.nr_atendimento 		= nr_atendimento_p
/*	  and  a.cd_setor_atendimento	= nvl(cd_setor_atendimento_p, a.cd_setor_atendimento)*/

	  and 	dt_entrada_unidade	=
		(SELECT min(dt_entrada_unidade)
		from atend_paciente_unidade b
		where nr_atendimento 		= nr_atendimento_p);
elsif (ie_opcao_p = 'A') then
	select	coalesce(max(nr_seq_interno),0)
	into STRICT	nr_seq_atepacu_w
	from	atend_paciente_unidade a
	where	a.nr_atendimento	= nr_atendimento_p
/*	  and  a.cd_setor_atendimento	= nvl(cd_setor_atendimento_p, a.cd_setor_atendimento)*/

	  and	coalesce(a.dt_saida_unidade, a.dt_entrada_unidade + 9999)	=
			(SELECT max(coalesce(b.dt_saida_unidade, b.dt_entrada_unidade + 9999))
			from atend_paciente_unidade b
			where b.nr_atendimento 	= nr_atendimento_p
			  and b.dt_entrada_unidade <= dt_referencia_p);
elsif (ie_opcao_p = 'PI') then

	select	coalesce(min(nr_seq_interno),0)
	into STRICT	nr_seq_atepacu_w
	from 	atend_paciente_unidade a
	where	a.nr_atendimento 		= nr_atendimento_p
/*	  and  a.cd_setor_atendimento	= nvl(cd_setor_atendimento_p, a.cd_setor_atendimento)*/

	  and dt_entrada_unidade	=
		(SELECT min(dt_entrada_unidade)
		from 	Setor_Atendimento y,
			atend_paciente_unidade b
		where 	nr_atendimento 		= nr_atendimento_p
		  and 	b.cd_setor_atendimento	= y.cd_setor_atendimento
		  and 	y.cd_classif_setor in (3,4,8));
elsif (ie_opcao_p = 'IA') then
	/* Ricardo 23/01/2004 - Incluí o teste da classificação do setor no select do nr_seq_interno
				(para solucionar dois unidades com a mesma unidade de saída) */
	select	coalesce(max(nr_seq_interno),0)
	into STRICT	nr_seq_atepacu_w
	from 	setor_atendimento b,
		atend_paciente_unidade a
	where	a.nr_atendimento 		= nr_atendimento_p
	  and 	a.cd_setor_atendimento		= b.cd_setor_atendimento
	  and 	b.cd_classif_setor in (3,4,8)
/*	  and  a.cd_setor_atendimento	= nvl(cd_setor_atendimento_p, a.cd_setor_atendimento)*/

	  and 	coalesce(a.dt_saida_unidade, a.dt_entrada_unidade + 9999)	=
		(SELECT max(coalesce(b.dt_saida_unidade, b.dt_entrada_unidade + 9999))
		from 	Setor_Atendimento y,
			atend_paciente_unidade b
		where nr_atendimento 	= nr_atendimento_p
		  and b.cd_setor_atendimento	= y.cd_setor_atendimento
		  and y.cd_classif_setor in (3,4,8)
		  and	b.dt_entrada_unidade <= dt_referencia_p);

end if;

RETURN nr_seq_atepacu_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_atepacu_data ( nr_atendimento_p bigint,  ie_opcao_p text, dt_referencia_p timestamp) FROM PUBLIC;

