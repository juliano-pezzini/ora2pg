-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_presc_order_type ( CD_PESSOA_FISICA_p text, DT_ATUALIZACAO_p timestamp, start_time_p timestamp, end_time_p timestamp ) RETURNS varchar AS $body$
DECLARE

    ds_others_w        varchar(3000);


BEGIN

 select   rtrim( XMLAGG(XMLELEMENT(name E,infusion, chr(10))).EXTRACT['//text()'].getclobval(), ',')
  into STRICT ds_others_w
  from (SELECT DISTINCT
   ds_horario|| ' '  || substr(obter_desc_material(c.cd_material),1,50)||
     CASE coalesce(WHEN(CD_MAT_DIL||CD_MAT_RECONS||CD_MAT_RED||CD_MAT_COMP1||CD_MAT_SOLUC1)::text, '') = '' THEN null  ELSE ', ' END ||
rpad(substr(rpad(obter_desc_material(c.CD_MAT_DIL),20,',')
||rpad(obter_desc_material(c.CD_MAT_RECONS),20,',')
||rpad(obter_desc_material(c.CD_MAT_RED),20,',')
||rpad(obter_desc_material(c.CD_MAT_COMP1),20,',')
||rpad(obter_desc_material(c.CD_MAT_SOLUC1),20),1,20),23,'...')

            ||chr(10)||(    SELECT   va.ds_via_aplicacao  FROM via_aplicacao va
        WHERE   va.ie_via_aplicacao = c.ie_via_aplicacao    )
            || ' '  || obter_valor_dominio(1573, c.ie_bomba_infusao) infusion
FROM
    material_order_type   mo,
    cpoe_tipo_pedido      ctp,
    prescr_mat_hor ph,
    prescr_material b,
 cpoe_material c
WHERE
    mo.ie_situacao = 'A'  and c.nr_sequencia = b.nr_seq_mat_cpoe
and  b.nr_sequencia = ph. nr_seq_material and b.nr_prescricao = ph.nr_prescricao
    AND ctp.nr_sequencia = mo.nr_seq_order_type
    AND c.cd_material = mo.cd_material
    AND c.CD_PESSOA_FISICA =CD_PESSOA_FISICA_p
    and (c.DT_LIBERACAO IS NOT NULL AND c.DT_LIBERACAO::text <> '')
    and coalesce(c.DT_SUSPENSAO::text, '') = ''
    and NR_SEQ_SUB_GRP ='I'
    and ph.ds_horario >=  to_Char(start_time_p,'hh24:mi:ss')
    and ph.ds_horario <= to_Char(end_time_p,'hh24:mi:ss')
   and to_date(c.DT_INICIO,'dd-mm-yy')=to_date(DT_ATUALIZACAO_p,'dd-mm-yy')) alias30;


  RETURN ds_others_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_presc_order_type ( CD_PESSOA_FISICA_p text, DT_ATUALIZACAO_p timestamp, start_time_p timestamp, end_time_p timestamp ) FROM PUBLIC;

