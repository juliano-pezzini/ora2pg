-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dt_rescisao_benef ( nr_seq_segurado_p bigint, nr_seq_motivo_cancel_p bigint, dt_rescisao_p timestamp, cd_estabelecimento_p text, nr_seq_rescisao_contrato_p pls_rescisao_contrato.nr_sequencia%type default null) RETURNS timestamp AS $body$
DECLARE

			
			
nr_seq_contrato_w		bigint;
qt_dia_rescisao_w		bigint;
nr_seq_regra_rescisao_w		bigint;
dt_rescisao_nova_w		timestamp;
dt_dia_rescisao_w		bigint;
ie_tipo_data_w			varchar(10);
qt_meses_sub_w			bigint;
ie_estipulante_w		varchar(10);
ie_data_alterada_regra_w	pls_rescisao_contrato.ie_data_alterada_regra%type;	
bad_date_format   		exception;

	
C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_regra_rescisao_benef
	where	nr_seq_contrato = nr_seq_contrato_w
	and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp())
	and	((qt_dia_rescisao_w	<= dt_limite_movimentacao) or (coalesce(dt_limite_movimentacao::text, '') = ''))
	and	((nr_seq_motivo_cancelamento	= nr_seq_motivo_cancel_p) or (coalesce(nr_seq_motivo_cancelamento::text, '') = ''))	
	order by dt_limite_movimentacao desc,
		coalesce(nr_seq_motivo_cancelamento,-1);

C02 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_regra_rescisao_benef
	where	coalesce(nr_seq_contrato::text, '') = ''
	and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp())
	and	((qt_dia_rescisao_w	<= dt_limite_movimentacao) or (coalesce(dt_limite_movimentacao::text, '') = ''))
	and	((nr_seq_motivo_cancelamento	= nr_seq_motivo_cancel_p) or (coalesce(nr_seq_motivo_cancelamento::text, '') = ''))
	and 	((ie_tipo_estipulante = ie_estipulante_w) or (ie_tipo_estipulante = 'A'))
	order by dt_limite_movimentacao desc,
		coalesce(nr_seq_motivo_cancelamento,-1);		


BEGIN

select	coalesce(max(ie_data_alterada_regra), 'N')
into STRICT	ie_data_alterada_regra_w
from	pls_rescisao_contrato
where	nr_sequencia = nr_seq_rescisao_contrato_p;

if (ie_data_alterada_regra_w = 'N') then
	select	CASE WHEN coalesce(max(b.cd_pf_estipulante)::text, '') = '' THEN 'PJ'  ELSE 'PF' END ,
		max(a.nr_seq_contrato)
	into STRICT	ie_estipulante_w,
		nr_seq_contrato_w
	from	pls_contrato b,
		pls_segurado a
	where	a.nr_seq_contrato	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_p;

	qt_dia_rescisao_w	:= (to_char(dt_rescisao_p,'dd'))::numeric;
	dt_rescisao_nova_w	:= dt_rescisao_p;

	open C01;
	loop
	fetch C01 into	
		nr_seq_regra_rescisao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;

	if (coalesce(nr_seq_regra_rescisao_w::text, '') = '') then
		open C02;
		loop
		fetch C02 into	
			nr_seq_regra_rescisao_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		end loop;
		close C02;
	end if;

	if (nr_seq_regra_rescisao_w IS NOT NULL AND nr_seq_regra_rescisao_w::text <> '') then
		select	dt_dia_inclusao,
			ie_tipo_data
		into STRICT	dt_dia_rescisao_w,
			ie_tipo_data_w
		from	pls_regra_rescisao_benef
		where	nr_sequencia	= nr_seq_regra_rescisao_w;
		
		qt_meses_sub_w	:= 0;
		
		if (ie_tipo_data_w = 'A') then
			qt_meses_sub_w	:= 0;
		elsif (ie_tipo_data_w = 'P') then
			qt_meses_sub_w	:= 1;
		elsif (ie_tipo_data_w = 'SP') then
			qt_meses_sub_w	:= 2;
		end if;
		
		begin
		dt_rescisao_nova_w	:= add_months(to_date(dt_dia_rescisao_w||'/'||to_char(dt_rescisao_p,'mm/yyyy')),qt_meses_sub_w);
		exception
		when bad_date_format then
			dt_rescisao_nova_w	:= add_months(last_day(dt_rescisao_p),qt_meses_sub_w);
		end;
	end if;
else
	dt_rescisao_nova_w := dt_rescisao_p;
end if;

return	dt_rescisao_nova_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dt_rescisao_benef ( nr_seq_segurado_p bigint, nr_seq_motivo_cancel_p bigint, dt_rescisao_p timestamp, cd_estabelecimento_p text, nr_seq_rescisao_contrato_p pls_rescisao_contrato.nr_sequencia%type default null) FROM PUBLIC;

