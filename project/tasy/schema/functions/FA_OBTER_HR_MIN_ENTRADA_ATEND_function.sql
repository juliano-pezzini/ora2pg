-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION fa_obter_hr_min_entrada_atend (/*nr_atendimento_p	number,*/
 dt_entrada_p timestamp, ie_resultado_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(30);
dt_aux_w		bigint;
ds_intev_15_w		bigint;
ds_intev_30_w		bigint;
ds_intev_45_w		bigint;
ds_intev_60_w		bigint;
ds_intervalo_w		varchar(30);
hr_formatada_w		varchar(30);
ie_tempo_defi_w		varchar(30);


BEGIN
if (coalesce(ie_opcao_p::text, '') = '') then
	if (dt_entrada_p IS NOT NULL AND dt_entrada_p::text <> '') then

		dt_aux_w := (to_char(dt_entrada_p,'mi'))::numeric;

		if (dt_aux_w > 0) and (dt_aux_w <=15) then
			ds_intev_15_w	:= 1;
			ds_intervalo_w	:= '15 min';
		elsif (dt_aux_w >=16) and (dt_aux_w <=30) then
			ds_intev_30_w	:= 1;
			ds_intervalo_w	:= '30 min';
		elsif (dt_aux_w >= 31) and (dt_aux_w <=45) then
			ds_intev_45_w	:= 1;
			ds_intervalo_w	:= '45 min';
		elsif 	(dt_aux_w >= 46 AND dt_aux_w <= 59) or (dt_aux_w = 00)  then
			ds_intev_60_w	:= 1;
			ds_intervalo_w	:= '60 min';
		end if;


		if (ie_resultado_p = 'I15') then
			ds_retorno_w	:=	coalesce(ds_intev_15_w,null);
		elsif (ie_resultado_p = 'I30') then
			ds_retorno_w	:=	coalesce(ds_intev_30_w,null);
		elsif (ie_resultado_p = 'I45') then
			ds_retorno_w	:=	coalesce(ds_intev_45_w,null);
		elsif (ie_resultado_p = 'I60') then
			ds_retorno_w	:=	coalesce(ds_intev_60_w,null);
		elsif (ie_resultado_p = 'DS') then
			ds_retorno_w	:=	coalesce(ds_intervalo_w, wheb_mensagem_pck.get_texto(307495)); -- Período não informado
		end if;

	end if;
elsif (ie_opcao_p = 'HR') then
	select	coalesce(obter_horario_formatado((to_char(dt_entrada_p,'hh24'))::numeric ),null)
	into STRICT	hr_formatada_w
	;

	if (ie_resultado_p = 'HR') then
		ds_retorno_w	:= hr_formatada_w;
	elsif (ie_resultado_p = 'TH') then
		ds_retorno_w	:=	wheb_mensagem_pck.get_texto(307494); -- Triagem(hora)
	elsif (ie_resultado_p = 'RH') then
		ds_retorno_w	:=	wheb_mensagem_pck.get_texto(307493); -- Recepção(hora)
	end if;

end if;

	/*select	to_char(to_date(to_char(a.dt_entrada, 'dd/mm/yyyy hh24'))+ 01/86400,'hh24:mi:ss')||'-'||to_char(to_date(to_char(a.dt_entrada, 'dd/mm/yyyy hh24'))+ 959/86400,'hh24:mi:ss'),
		to_char(to_date(to_char(a.dt_entrada, 'dd/mm/yyyy hh24'))+ 960/86400,'hh24:mi:ss')||'-'||to_char(to_date(to_char(a.dt_entrada, 'dd/mm/yyyy hh24'))+ 1859/86400,'hh24:mi:ss'),
		to_char(to_date(to_char(a.dt_entrada, 'dd/mm/yyyy hh24'))+ 1860/86400,'hh24:mi:ss')||'-'||to_char(to_date(to_char(a.dt_entrada, 'dd/mm/yyyy hh24'))+ 2759/86400,'hh24:mi:ss'),
		to_char(to_date(to_char(a.dt_entrada, 'dd/mm/yyyy hh24'))+ 2760/86400,'hh24:mi:ss')||'-'||to_char(to_date(to_char(a.dt_entrada, 'dd/mm/yyyy hh24'))+ 3600/86400,'hh24:mi:ss')
	into	ds_intev_15_w,	ds_intev_30_w,	ds_intev_45_w,	ds_intev_60_w
	from	atendimento_paciente a		where	a.nr_atendimento = nr_atendimento_p	and	a.dt_entrada between dt_entrada_p and dt_entrada_p	group by	a.dt_entrada, a.nr_atendimento;

	if	(ie_resultado_p = 'I15') then	ds_retorno_w	:=	to_char(ds_intev_15_w);
	elsif	(ie_resultado_p = 'I30') then	ds_retorno_w	:=	to_char(ds_intev_30_w);
	elsif	(ie_resultado_p = 'I45') then	ds_retorno_w	:=	to_char(ds_intev_45_w);
	elsif	(ie_resultado_p = 'I60') then	ds_retorno_w	:=	to_char(ds_intev_60_w);		end if;*/
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION fa_obter_hr_min_entrada_atend ( dt_entrada_p timestamp, ie_resultado_p text, ie_opcao_p text) FROM PUBLIC;

