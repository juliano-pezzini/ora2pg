-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION proj_obter_se_ata_lib_usu ( nr_seq_ata_p bigint, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(1) := 'N';
ie_forma_acesso_ata_w		varchar(15);
cd_resp_ata_w			varchar(15);
cd_pf_usuario_w			varchar(15);
ie_visu_ata_sem_lib_w		varchar(15);
qt_regra_w			bigint;
cd_setor_atendimento_w		integer := wheb_usuario_pck.get_cd_setor_atendimento;
cd_cargo_w			bigint;
cd_estabelecimento_w		smallint := wheb_usuario_pck.get_cd_estabelecimento;
dt_liberacao_w			timestamp;


BEGIN
ie_forma_acesso_ata_w := obter_param_usuario(1351, 2, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_forma_acesso_ata_w);
ie_visu_ata_sem_lib_w := obter_param_usuario(1351, 35, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_visu_ata_sem_lib_w);

if (coalesce(nr_seq_ata_p,0) > 0) then
	select	cd_consultor,
			dt_liberacao
	into STRICT	cd_resp_ata_w,
			dt_liberacao_w
	from	proj_ata
	where	nr_sequencia = nr_seq_ata_p;

	select	max(b.cd_cargo),
			max(a.cd_pessoa_fisica)
	into STRICT	cd_cargo_w,
			cd_pf_usuario_w
	from	usuario a,
			pessoa_fisica b
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and		a.nm_usuario 	= nm_usuario_p;


	if (coalesce(cd_pf_usuario_w,'0') <> '0') and /*Se o usuário é o responsável da ATA, visualiza*/
		(cd_resp_ata_w = cd_pf_usuario_w)then
		ds_retorno_w	:= 'S';
	end if;

	if (ds_retorno_w = 'N') and
		((ie_visu_ata_sem_lib_w = 'S') or
		(ie_visu_ata_sem_lib_w = 'N' AND dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '')) then
		begin


		if (ds_retorno_w = 'N') and (ie_forma_acesso_ata_w = 'N')	then /*Se restringe, participantes podem visualizar*/
			select CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT ds_retorno_w
			from proj_ata_participante
			where cd_pessoa_participante = cd_pf_usuario_w
			and nr_seq_ata = nr_seq_ata_p;
		end if;

		if (ds_retorno_w = 'N') and (ie_forma_acesso_ata_w = 'S') then /*Se não restringe, qualquer usuário pode visualizar*/
			ds_retorno_w	:= 'S';
		end if;


		if (ds_retorno_w = 'N') and (ie_forma_acesso_ata_w = 'D') then /*Se depende da regra*/
		begin

			select	count(*)
			into STRICT	qt_regra_w
			from	proj_ata_lib
			where	nr_seq_ata = nr_seq_ata_p;

			if (qt_regra_w = 0) then /*Se não existir nenhuma regra, está liberado para todos*/
				ds_retorno_w := 'S';
			end if;

			if (ds_retorno_w = 'N') then
				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  /*Se existir alguma regra geral, permite para todos*/
				into STRICT	ds_retorno_w
				from	proj_ata_lib
				where	nr_seq_ata = nr_seq_ata_p
				and	coalesce(cd_cargo::text, '') = ''
				and	coalesce(cd_setor_atendimento::text, '') = ''
				and	coalesce(nr_seq_grupo_usuario::text, '') = ''
				and	coalesce(nm_usuario_lib::text, '') = '';
			end if;

			if (ds_retorno_w = 'N') then

				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  /*Verifica se tem regra por cargo ou setor ou grupo de usuário*/
				into STRICT	ds_retorno_w
				from	proj_ata_lib
				where	nr_seq_ata = nr_seq_ata_p
				and		coalesce(cd_cargo,coalesce(cd_cargo_w,0))			= coalesce(cd_cargo_w,0)
				and		coalesce(cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0))	= coalesce(cd_setor_atendimento_w,0)
				and		coalesce(nm_usuario_lib,nm_usuario_p)			= nm_usuario_p
				and		((coalesce(nr_seq_grupo_usuario::text, '') = '') or (substr(obter_se_usuario_grupo(nr_seq_grupo_usuario, nm_usuario_p),1,2) = 'S'));

			end if;
		end;
		end if;
		end;
	end if;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION proj_obter_se_ata_lib_usu ( nr_seq_ata_p bigint, nm_usuario_p text) FROM PUBLIC;

