-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION manchester_valid_sexo_idade ( qt_idade_p bigint, ie_sexo_p text, nr_seq_fluxograma_p bigint, nr_atendimento_p bigint default 0) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(3);
ie_regra_w			varchar(3);
qt_dias_w			bigint;
qt_meses_w			bigint;
cd_pessoa_fisica_w	varchar(10);


BEGIN
if (nr_seq_fluxograma_p IS NOT NULL AND nr_seq_fluxograma_p::text <> '')  then

	select	coalesce(max('S'),'SE') retorno
	into STRICT	ds_retorno_w
	from	manchester_fluxograma
	where	nr_sequencia = nr_seq_fluxograma_p
	and		((ie_sexo = ie_sexo_p) or (coalesce(ie_sexo::text, '') = '') or (coalesce(ie_sexo_p::text, '') = '') or (ie_sexo_p = 'I') or (ie_sexo_p = 'D'));

	if (ds_retorno_w = 'S') then
	
		if (nr_atendimento_p > 0) then		
			cd_pessoa_fisica_w := OBTER_PESSOA_ATENDIMENTO(nr_atendimento_p,'C');		
			qt_dias_w := trunc(obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'DIA'));
			qt_meses_w	:= trunc(obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'M'));
		end if;
		
		if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'de_DE') then
			select	coalesce(max('S'),'N')
			into STRICT	ie_regra_w
			from	manchester_regra
			where	ds_item = (SELECT nm_fluxograma 
							from manchester_fluxograma
							where NR_sequencia = nr_seq_fluxograma_p);
							
			if (ie_regra_w = 'S') then
				select	coalesce(max('S'),'I') retorno
                into STRICT	ds_retorno_w
				from	manchester_regra
				where	ds_item = (	SELECT nm_fluxograma
									from manchester_fluxograma 
									where NR_sequencia = nr_seq_fluxograma_p)
				and ((qt_idade_p between qt_idade_min and qt_idade_max) or (coalesce(qt_idade_p::text, '') = '') or (coalesce(qt_idade_max::text, '') = '' and coalesce(qt_idade_min::text, '') = ''))
				and ((coalesce(qt_dias_w,0) between coalesce(qt_dia_min,0) and coalesce(qt_dia_max,999999)) or (coalesce(qt_dias_w::text, '') = ''))
				and	((coalesce(qt_meses_w,0) between coalesce(qt_meses_min,0) and coalesce(qt_meses_max,9999)) or (coalesce(qt_meses_w::text, '') = ''));
			
			end if;
		end if;

		if (ds_retorno_w = 'S') then
		
			select	coalesce(max('S'),'I') retorno
			into STRICT	ds_retorno_w
			from	manchester_fluxograma
			where	nr_sequencia = nr_seq_fluxograma_p
			and		((qt_idade_p between qt_idade_min and qt_idade_max) or (coalesce(qt_idade_p::text, '') = '') or (coalesce(qt_idade_max::text, '') = '' and coalesce(qt_idade_min::text, '') = ''))
			and 	((coalesce(qt_dias_w,0) between coalesce(qt_dias_min,0) and coalesce(qt_dias_max,999999)) or (coalesce(qt_dias_w::text, '') = ''))
			and		((coalesce(qt_meses_w,0) between coalesce(qt_meses_min,0) and coalesce(qt_meses_max,9999)) or (coalesce(qt_meses_w::text, '') = ''));
		
		end if;		
	end if;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION manchester_valid_sexo_idade ( qt_idade_p bigint, ie_sexo_p text, nr_seq_fluxograma_p bigint, nr_atendimento_p bigint default 0) FROM PUBLIC;

