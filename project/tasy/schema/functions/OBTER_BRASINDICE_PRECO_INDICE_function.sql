-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_brasindice_preco_indice ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_material_p bigint, dt_vigencia_p timestamp, ie_tipo_atendimento_p bigint) RETURNS bigint AS $body$
DECLARE


vl_brasindice_w		double precision := 0;
vl_retorno_w		double precision := 0;
tx_brasindice_pmc_w	CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type := 0;--number(15,4) := 0;
tx_brasindice_pfb_w	CONVENIO_BRASINDICE.TX_PRECO_FABRICA%type :=0;--number(15,4) := 0;
tx_pmc_neg_w		CONVENIO_BRASINDICE.TX_PMC_NEG%type := 0;--number(15,4) := 0;
tx_pmc_pos_w		CONVENIO_BRASINDICE.TX_PMC_POS%type := 0;--number(15,4) := 0;
dt_ult_vigencia_w	timestamp;
cd_tiss_w		varchar(40);

tx_pfb_neg_w		CONVENIO_BRASINDICE.TX_PFB_NEG%type;--number(15,4);
tx_pfb_pos_w		CONVENIO_BRASINDICE.TX_PFB_POS%type;--number(15,4);
cD_grupo_material_w	smallint;
cd_estabelecimento_w	smallint;
cd_classe_material_w	integer;
cd_subgrupo_material_w	smallint;
ie_tipo_material_w	varchar(3);
ie_data_fixa_w		varchar(1) := 'N';
nr_seq_bras_preco_w	bigint;
nr_seq_mat_bras_w	bigint;
nr_seq_conv_bras_w	bigint;

C01 CURSOR FOR
	SELECT	1,
		1,
		1,
		1,
		1,
		1,
		coalesce(ie_data_fixa,'N'),
		nr_sequencia 
	from	convenio_brasindice
	where	cd_convenio		= cd_convenio_p
	and	((coalesce(cd_categoria::text, '') = '')	or (cd_categoria = cd_categoria_p))
	and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
	and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
	and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
	and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrutura,cd_material_p) = 'S'))	
	and 	((coalesce(ie_tipo_material::text, '') = '') or (ie_tipo_material = ie_tipo_material_w))
	and	((coalesce(ie_tipo_atendimento::text, '') = '') or (ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)))
	and	cd_estabelecimento	= cd_estabelecimento_w
	and	dt_inicio_vigencia	= (	SELECT	max(dt_inicio_vigencia)
						from	convenio_brasindice
						where	cd_convenio		= cd_convenio_p
						and	((coalesce(cd_categoria::text, '') = '')	or (cd_categoria = cd_categoria_p))
						and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
						and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
						and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
						and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrutura,cd_material_p) = 'S'))
						and 	((coalesce(ie_tipo_material::text, '') = '') or (ie_tipo_material = ie_tipo_material_w))
						and	((coalesce(ie_tipo_atendimento::text, '') = '') or (ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)))
						and	clock_timestamp() between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_vigencia) and (ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(coalesce(dt_final_vigencia, clock_timestamp()))))						
						
						--and	dt_inicio_vigencia	<= sysdate)
	order by coalesce(cd_categoria,'0'),
		coalesce(nr_seq_estrutura,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_classe_material,0),
		coalesce(ie_tipo_material,'0'),
		coalesce(ie_tipo_atendimento,0);


BEGIN

select 	max(cd_grupo_material),
	max(cd_classe_material),
	max(cd_subgrupo_material),
	max(ie_tipo_material)
into STRICT	cd_grupo_material_w,
	cd_classe_material_w,
	cd_subgrupo_material_w,
	ie_tipo_material_w
from 	estrutura_material_v
where 	cd_material = cd_material_p;

select	coalesce(cd_estabelecimento_p, wheb_usuario_pck.get_cd_estabelecimento)
into STRICT	cd_estabelecimento_w
;

open C01;
loop
fetch C01 into	
	tx_brasindice_pmc_w,
	tx_brasindice_pfb_w,
	tx_pmc_neg_w,
	tx_pmc_pos_w,
	tx_pfb_neg_w,
	tx_pfb_pos_w,
	ie_data_fixa_w,
	nr_seq_conv_bras_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	tx_brasindice_pmc_w	:= 	tx_brasindice_pmc_w;
	tx_brasindice_pfb_w	:=	tx_brasindice_pfb_w;
	tx_pmc_neg_w		:=	tx_pmc_neg_w;
	tx_pmc_pos_w		:=	tx_pmc_pos_w;
	tx_pfb_neg_w		:=	tx_pfb_neg_w;
	tx_pfb_pos_w		:=	tx_pfb_pos_w;
	ie_data_fixa_w		:=	ie_data_fixa_w;
	nr_seq_conv_bras_w  :=  nr_seq_conv_bras_w;
	end;
end loop;
close C01;

SELECT * FROM obter_preco_brasindice(cd_estabelecimento_w, cd_convenio_p, cd_categoria_p, cd_material_p, dt_vigencia_p, tx_brasindice_pmc_w, tx_brasindice_pfb_w, tx_pfb_pos_w, tx_pfb_neg_w, tx_pmc_neg_w, tx_pmc_pos_w, ie_tipo_atendimento_p, null, vl_brasindice_w, dt_ult_vigencia_w, cd_tiss_w, null, ie_data_fixa_w, null, null, null, nr_seq_bras_preco_w, nr_seq_mat_bras_w, nr_seq_conv_bras_w) INTO STRICT vl_brasindice_w, dt_ult_vigencia_w, cd_tiss_w, nr_seq_bras_preco_w, nr_seq_mat_bras_w;

vl_retorno_w		:= vl_brasindice_w;

RETURN vl_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_brasindice_preco_indice ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_material_p bigint, dt_vigencia_p timestamp, ie_tipo_atendimento_p bigint) FROM PUBLIC;

