-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_classif_pac ( cd_estabelecimento_p bigint, cd_pessoa_fisica_p text, dt_agenda_p timestamp, nr_seq_agenda_p bigint default null) RETURNS varchar AS $body$
DECLARE



ds_retorno_w					varchar(1) := 'X';
nr_seq_classif_w				pessoa_classif.nr_seq_classif%type;
ie_formatar_se_classif_pac_w	varchar(1);
dt_agenda_w						timestamp;
ie_agenda_hora_w				varchar(1);
/*
ds_retorno_w
C - Pesquisa Clínica
E - Tratamento Externo
*/
BEGIN

ie_agenda_hora_w := Obter_param_Usuario(821, 481, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_agenda_hora_w);

select	coalesce(MAX(dt_agenda),dt_agenda_p)
into STRICT	dt_agenda_w
from 	agenda_quimio
where	nr_sequencia = nr_seq_agenda_p;

select	max(coalesce(ie_formatar_se_classif_pac,'N'))
into STRICT	ie_formatar_se_classif_pac_w
from	parametro_agenda
where	cd_estabelecimento = cd_estabelecimento_p;

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (dt_agenda_w IS NOT NULL AND dt_agenda_w::text <> '') and (ie_formatar_se_classif_pac_w = 'S') then

	--obter a última classif da pessoa de acordo com a data de vigência
	select	max(a.nr_seq_classif)
	into STRICT	nr_seq_classif_w
	from	pessoa_classif a
	where	(((ie_agenda_hora_w = 'N') and (trunc(dt_agenda_w) between coalesce(trunc(a.dt_inicio_vigencia), trunc(dt_agenda_w)) and coalesce(trunc(a.dt_final_vigencia), trunc(dt_agenda_w))))
			or ((ie_agenda_hora_w = 'S') and (dt_agenda_w between coalesce(a.dt_inicio_vigencia, dt_agenda_w) and coalesce(a.dt_final_vigencia, dt_agenda_w))))
	and		a.cd_pessoa_fisica	= cd_pessoa_fisica_p;


	if (nr_seq_classif_w IS NOT NULL AND nr_seq_classif_w::text <> '') then

		--Somente classif 'Pesquisa Clínica'
		select	CASE WHEN count(*)=0 THEN  null  ELSE 'C' END
		into STRICT	ds_retorno_w
		from	classif_pessoa
		where	nr_sequencia = nr_seq_classif_w
		and		upper(ds_classificacao)  like(upper('%Pesquisa Cl%'));

		if (coalesce(ds_retorno_w::text, '') = '') then

			--Somente classif 'Pesquisa Clínica'
			select	CASE WHEN count(*)=0 THEN  null  ELSE 'E' END
			into STRICT	ds_retorno_w
			from	classif_pessoa
			where	nr_sequencia = nr_seq_classif_w
			and		upper(ds_classificacao) like(upper('%Tratamento Externo%'));

		end if;
	end if;


end if;


return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_classif_pac ( cd_estabelecimento_p bigint, cd_pessoa_fisica_p text, dt_agenda_p timestamp, nr_seq_agenda_p bigint default null) FROM PUBLIC;

