-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION san_consiste_peso_doador ( qt_peso_p bigint, ie_pasta_p text, nr_seq_tipo_doacao_p bigint, ie_tipo_coleta_p bigint) RETURNS varchar AS $body$
DECLARE


ie_retorno_w		varchar(10) := 'N';
nr_regra_valida_w	smallint := 0;


BEGIN

if (qt_peso_p IS NOT NULL AND qt_peso_p::text <> '') then

	if (ie_pasta_p = 'CA') then
	   SELECT *
	   into STRICT	nr_regra_valida_w
	   FROM (
		SELECT	coalesce(max(a.nr_sequencia),0)
		from	SAN_REGRA_PESO_DOACAO a
		where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
		and 	qt_peso_p between a.qt_peso_min and a.qt_peso_max
		AND     coalesce(a.nr_seq_tipo_doacao, coalesce(nr_seq_tipo_doacao_p,999)) = coalesce(coalesce(nr_seq_tipo_doacao_p,999), a.nr_seq_tipo_doacao)
		AND     coalesce(a.ie_tipo_coleta, coalesce(ie_tipo_coleta_p,999)) = coalesce(coalesce(ie_tipo_coleta_p,999), a.ie_tipo_coleta)
		and 	a.ie_cadastro = 'S'
		and 	a.ie_situacao = 'A'
		ORDER BY a.nr_seq_tipo_doacao, a.ie_tipo_coleta
		) alias12 LIMIT 1;
	elsif (ie_pasta_p = 'TR') and (nr_regra_valida_w = 0) then
	   SELECT *
	   into STRICT	nr_regra_valida_w
	   FROM (
		SELECT	coalesce(max(a.nr_sequencia),0)
		from	SAN_REGRA_PESO_DOACAO a
		where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
		and 	qt_peso_p between a.qt_peso_min and a.qt_peso_max
		AND     coalesce(a.nr_seq_tipo_doacao, coalesce(nr_seq_tipo_doacao_p,999)) = coalesce(coalesce(nr_seq_tipo_doacao_p,999), a.nr_seq_tipo_doacao)
		AND     coalesce(a.ie_tipo_coleta, coalesce(ie_tipo_coleta_p,999)) = coalesce(coalesce(ie_tipo_coleta_p,999), a.ie_tipo_coleta)
		and 	a.ie_triagem_fisica = 'S'
		and 	a.ie_situacao = 'A'
		ORDER BY a.nr_seq_tipo_doacao, a.ie_tipo_coleta
		) alias12 LIMIT 1;
	elsif (ie_pasta_p = 'TC') and (nr_regra_valida_w = 0) then
	   SELECT *
	   into STRICT	nr_regra_valida_w
	   FROM (
		SELECT	coalesce(max(a.nr_sequencia),0)
		from	SAN_REGRA_PESO_DOACAO a
		where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
		and 	qt_peso_p between a.qt_peso_min and a.qt_peso_max
		AND     coalesce(a.nr_seq_tipo_doacao, coalesce(nr_seq_tipo_doacao_p,999)) = coalesce(coalesce(nr_seq_tipo_doacao_p,999), a.nr_seq_tipo_doacao)
		AND     coalesce(a.ie_tipo_coleta, coalesce(ie_tipo_coleta_p,999)) = coalesce(coalesce(ie_tipo_coleta_p,999), a.ie_tipo_coleta)
		and 	a.ie_triagem_clinica = 'S'
		and 	a.ie_situacao = 'A'
		ORDER BY a.nr_seq_tipo_doacao, a.ie_tipo_coleta
		) alias12 LIMIT 1;
	elsif (ie_pasta_p = 'CO') and (nr_regra_valida_w = 0) then
	   SELECT *
	   into STRICT	nr_regra_valida_w
	   FROM (
		SELECT	coalesce(max(a.nr_sequencia),0)
		from	SAN_REGRA_PESO_DOACAO a
		where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
		and 	qt_peso_p between a.qt_peso_min and a.qt_peso_max
		AND     coalesce(a.nr_seq_tipo_doacao, coalesce(nr_seq_tipo_doacao_p,999)) = coalesce(coalesce(nr_seq_tipo_doacao_p,999), a.nr_seq_tipo_doacao)
		AND     coalesce(a.ie_tipo_coleta, coalesce(ie_tipo_coleta_p,999)) = coalesce(coalesce(ie_tipo_coleta_p,999), a.ie_tipo_coleta)
		and 	a.ie_coleta = 'S'
		and 	a.ie_situacao = 'A'
		ORDER BY a.nr_seq_tipo_doacao, a.ie_tipo_coleta
		) alias12 LIMIT 1;
	end if;

	if (nr_regra_valida_w > 0) then
		ie_retorno_w := 'S';
	end if;

end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION san_consiste_peso_doador ( qt_peso_p bigint, ie_pasta_p text, nr_seq_tipo_doacao_p bigint, ie_tipo_coleta_p bigint) FROM PUBLIC;

