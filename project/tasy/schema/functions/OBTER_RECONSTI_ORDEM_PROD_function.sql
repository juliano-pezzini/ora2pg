-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_reconsti_ordem_prod ( nr_seq_ordem_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(255);
ds_material_w	varchar(80);
ds_unid_med_w	varchar(30);
qt_dose_w	varchar(20);
nr_sequencia_w	bigint;
nr_prescricao_w	bigint;
cd_material_w 	integer;


/* ie_opcao_p M - Material, D - dose U - unidade medida   C - CÃ³digo */

BEGIN


select	min(nr_sequencia)
into STRICT	nr_sequencia_w
from	can_ordem_item_prescr
where	nr_seq_ordem	= nr_seq_ordem_p
and	coalesce(nr_sequencia_diluente::text, '') = '';


select	cd_material,
	substr(obter_desc_material(cd_material),1,60),
	cd_unidade_medida,
	replace(qt_dose,'.',',')
into STRICT	cd_material_w,
	ds_material_w,
	ds_unid_med_w,
	qt_dose_w
from	can_ordem_item_prescr
where	nr_seq_ordem		= nr_seq_ordem_p
and	nr_sequencia_diluente	= nr_sequencia_w
and	nr_sequencia	= substr((	SELECT	min(nr_sequencia)
				from	can_ordem_item_prescr
				where	nr_seq_ordem	= nr_seq_ordem_p
				and	(nr_sequencia_diluente IS NOT NULL AND nr_sequencia_diluente::text <> '')
				and	((coalesce(ie_agrupador::text, '') = '') or (ie_agrupador = 9))),1,10);


if (ie_opcao_p = 'M') then
	ds_retorno_w	:= ds_material_w;
elsif (ie_opcao_p = 'D') then
	ds_retorno_w	:= qt_dose_w;
elsif (ie_opcao_p = 'U') then
	ds_retorno_w	:= ds_unid_med_w;
elsif (ie_opcao_p = 'C') then
	ds_retorno_w := to_char(cd_material_w);
end if;


return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_reconsti_ordem_prod ( nr_seq_ordem_p bigint, ie_opcao_p text) FROM PUBLIC;

