-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_inicio_cih_detail (nr_sequencia_p bigint, dt_referencia_p timestamp default clock_timestamp(), dt_inicio_cih_p timestamp default null, dt_inicio_p timestamp default null) RETURNS timestamp AS $body$
DECLARE


dt_return_w	timestamp := clock_timestamp();
ie_possui_hor_adm_w	varchar(1);

BEGIN
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	begin

		select	cpoe_obter_inicio_cih(cd_material, dt_referencia_p, dt_fim, dt_fim_cih, dt_suspensao, dt_lib_suspensao, hr_prim_horario,
									coalesce(cpoe_obter_dia_util_atb(nr_sequencia, cd_material, nr_dia_util, dt_inicio),nr_dia_util), nr_atendimento, 
									ie_reset_atb, nr_seq_cpoe_anterior, dt_inicio, dt_inicio_cih_p)
		into STRICT 	dt_return_w
		from	cpoe_material
		where	nr_sequencia = nr_sequencia_p
		and	coalesce(ie_antibiotico, 'N') = 'S';

		ie_possui_hor_adm_w := 'S';

		if (dt_inicio_p IS NOT NULL AND dt_inicio_p::text <> '') then
			select	coalesce(max('S'),'N')
			into STRICT	ie_possui_hor_adm_w
			from	prescr_material a,
					prescr_mat_hor b
			where	a.nr_prescricao = b.nr_prescricao
			and		a.nr_sequencia = b.nr_seq_material
			and		a.nr_seq_mat_cpoe = nr_sequencia_p
			and		(b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '');

			if (ie_possui_hor_adm_w = 'N') then
				/* Quando esse objeto for chamado na procedure CPOE_OBTER_DIAS_LIBERADOS_CIH a partir do metodo checkAutoLibCIH no backend, o registro da CPOE_MATERIAL ainda nao estara
				atualizado, pois o backend executa isso no evento beforePerform, ou seja, antes da alteracao (update) do registro ser salva na tabela. Entao, o parametro DT_INICIO_P
				recebe o valor atual do DT_INICIO em tela. Caso a data de inicio tenha vindo do backend e o item ainda nao tenha nenhum horario administrado, sera retornada essa data
				para que a procedure CPOE_OBTER_DIAS_LIBERADOS_CIH calcule o DT_FIM_CIH_P corretamente. */
				dt_return_w := dt_inicio_p;
			end if;
		end if;

	exception
      when no_data_found then
        /* O parametro DT_INICIO_P foi criado tambem para os itens que estao sendo salvos e ainda nao possuem registro (insert) na CPOE_MATERIAL. */

		dt_return_w	:= coalesce(dt_inicio_p, clock_timestamp());
    end;

end if;

return dt_return_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_inicio_cih_detail (nr_sequencia_p bigint, dt_referencia_p timestamp default clock_timestamp(), dt_inicio_cih_p timestamp default null, dt_inicio_p timestamp default null) FROM PUBLIC;

