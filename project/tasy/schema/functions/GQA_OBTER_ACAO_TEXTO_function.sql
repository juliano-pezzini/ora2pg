-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gqa_obter_acao_texto (nr_sequencia_p bigint) RETURNS text AS $body$
DECLARE


ie_tipo_acao_w        gqa_acao.ie_tipo_acao%type;
ds_texto_w            gqa_acao.ds_texto%type;
nr_seq_prot_ger_w     gqa_acao.nr_seq_protocolo_ger%type;
cd_doenca_w           gqa_acao.cd_doenca%type;
ds_retorno_w          text := null;
textolocal_a          varchar(4000);
textolocal_b          varchar(4000);


BEGIN

  if (coalesce(nr_sequencia_p::text, '') = '') then
    return ds_retorno_w;
  end if;

  begin
    select
            t.ie_tipo_acao, t.ds_texto, t.nr_seq_protocolo_ger, t.cd_doenca
            into STRICT ie_tipo_acao_w, ds_texto_w, nr_seq_prot_ger_w, cd_doenca_w
            from gqa_acao t where t.nr_sequencia = nr_sequencia_p  LIMIT 1;
  exception when no_data_found then
    return ds_retorno_w;
  end;

  if (coalesce(ie_tipo_acao_w::text, '') = '') then
    return ds_retorno_w;
  end if;

  if (ie_tipo_acao_w = 'PG') then
    textolocal_a := obter_desc_expressao(965378);

    begin
      select xx.DS_PENDENCIA into STRICT textolocal_b from gqa_pendencia xx where xx.nr_sequencia = nr_seq_prot_ger_w;
    exception when no_data_found then
      textolocal_b := null;
    end;

    if (coalesce(textolocal_b::text, '') = '' or LENGTH(trim(both textolocal_b)) = 0) then
      textolocal_a := replace(textolocal_a, '#@#@', '');
    else
      textolocal_a := replace(textolocal_a, '#@#@', '"' || textolocal_b || '"');
    end if;

	  select '<html tasy="html5"><p style="text-align:left;"><span style="font-size:16px;">' || textolocal_a || '</span></p></html>' into STRICT ds_retorno_w;

  elsif (ie_tipo_acao_w = 'MC') then
  
        select substr(obter_dados_tof_meta(NR_SEQ_META,'D'), 1,255) 
        into STRICT textolocal_a
        from gqa_acao where nr_sequencia = nr_sequencia_p;

        select '<html tasy="html5"><p style="text-align:left;"><span style="font-size:16px;">' || textolocal_a || '</span></p></html>' into STRICT ds_retorno_w;

  elsif (ie_tipo_acao_w = 'DL') then
    textolocal_a := obter_desc_expressao(965410);

    begin
      select zz.DS_DOENCA_CID into STRICT textolocal_b from CID_DOENCA zz where zz.CD_DOENCA_CID = cd_doenca_w  LIMIT 1;
    exception when no_data_found then
      textolocal_b := null;
    end;

    if (coalesce(textolocal_b::text, '') = '' or LENGTH(trim(both textolocal_b)) = 0) then
      textolocal_a := replace(textolocal_a, '#@#@', '');
    else
      textolocal_a := replace(textolocal_a, '#@#@', '"' || cd_doenca_w || ' - ' || textolocal_b || '"');
    end if;

	  select '<html tasy="html5"><p style="text-align:left;"><span style="font-size:16px;">' || textolocal_a || '</span></p></html>' into STRICT ds_retorno_w;
  else
    select ds_texto_w into STRICT ds_retorno_w;
  end if;

  return ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gqa_obter_acao_texto (nr_sequencia_p bigint) FROM PUBLIC;

