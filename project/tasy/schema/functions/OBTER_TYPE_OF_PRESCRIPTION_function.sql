-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_type_of_prescription (nr_atendimento_p bigint, ie_via_aplicacao_p text, nr_seq_order_unit_p bigint, dt_curr_p timestamp) RETURNS varchar AS $body$
DECLARE


si_type_of_atendimento_w       atendimento_paciente.ie_tipo_atendimento%type;
ds_retorno_w                   PESSOA_FISICA.CD_PESSOA_FISICA%type;
dt_limit_str_w                 cpoe_week_dispens_rule.DT_ATUALIZACAO%type;
hr_limit_time_w                cpoe_week_dispens_rule.hr_limit_time%type;
diff_hours_w                   atendimento_paciente.ie_tipo_atendimento%type;
cd_setor_atendimento_w         setor_atendimento.cd_setor_atendimento%type;


BEGIN

    select 	CASE WHEN obter_se_atend_internado(nr_atendimento_p)='S' THEN  1  ELSE 0 END
    into STRICT	si_type_of_atendimento_w
;

    select  max(obter_setor_atendimento(nr_atendimento_p))
	into STRICT    cd_setor_atendimento_w
	from    cpoe_order_unit
	where   nr_sequencia = nr_seq_order_unit_p;


	select	max(hr_limit_time)
	into STRICT    hr_limit_time_w
	from	cpoe_week_dispens_rule
	where	si_action = '5'
	and (cd_setor_atendimento = coalesce(cd_setor_atendimento_w,cd_setor_atendimento) or coalesce(cd_setor_atendimento::text, '') = '')
	and (ie_via_aplicacao = coalesce(ie_via_aplicacao_p, ie_via_aplicacao) or coalesce(ie_via_aplicacao::text, '') = '')
	order by cd_setor_atendimento, ie_via_aplicacao;

	select PKG_DATE_UTILS.get_Time(clock_timestamp(), PKG_DATE_UTILS.extract_field('HOUR', hr_limit_time_w)
	    || ':' || PKG_DATE_UTILS.extract_field('MINUTE', hr_limit_time_w))
	    into STRICT dt_limit_str_w
	;

    select PKG_DATE_UTILS.get_DiffDate(clock_timestamp(),dt_limit_str_w,'HOUR%')
    into STRICT diff_hours_w;

    
    if (trunc(dt_curr_p) <= trunc(clock_timestamp())) then
        if (si_type_of_atendimento_w = 1) then
            ds_retorno_w := 'INTI'; -- inpatient temporal
        else
            ds_retorno_w := 'OPTI'; -- outpatient temporal
        end if;

    elsif ((trunc(dt_curr_p) <= trunc(clock_timestamp() + interval '1 days')) and
            diff_hours_w < 0) then
            
        if (si_type_of_atendimento_w = 1) then
            ds_retorno_w := 'INTI'; -- inpatient temporal
        else
            ds_retorno_w := 'OPTI'; -- outpatient temporal
        end if;
    else
        if (si_type_of_atendimento_w = 1 ) then
            ds_retorno_w := 'IPSI'; -- inpatient scheduled
        else
            ds_retorno_w := 'OPSI';  -- outpatient scheduled
        end if;

    end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_type_of_prescription (nr_atendimento_p bigint, ie_via_aplicacao_p text, nr_seq_order_unit_p bigint, dt_curr_p timestamp) FROM PUBLIC;

