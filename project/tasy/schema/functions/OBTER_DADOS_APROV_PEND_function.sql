-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dados_aprov_pend (nr_seq_proc_aprov_p bigint, nr_documento_p bigint, nm_usuario_p text, ie_tipo_p text) RETURNS varchar AS $body$
DECLARE

 
/* 
NM - Nome 
CD- Cod 
*/
 
 
retorno_w	varchar(255);
ie_tipo_documento_w	processo_aprov_compra.ie_tipo%type;
nr_ordem_compra_nf_w	nota_fiscal.nr_ordem_compra%type;


BEGIN 
 
	select 	max(a.ie_tipo) 
	into STRICT	ie_tipo_documento_w 
	from 	processo_aprov_compra a, 
		w_processo_aprov_compra b 
	where 	a.nr_sequencia  	= b.nr_sequencia 
	and 	a.nr_seq_proc_aprov 	= b.nr_seq_proc_aprov 
	and 	b.nr_documento 		= nr_documento_p 
	and	a.nr_seq_proc_aprov 	= nr_seq_proc_aprov_p 
	and 	b.nm_usuario    	= nm_usuario_p;
 
	if (coalesce(ie_tipo_documento_w::text, '') = '') then 
	 
		select 	max(ie_tipo) 
		into STRICT	ie_tipo_documento_w 
		from 	processo_aprov_compra 
		where	nr_seq_proc_aprov 	= nr_seq_proc_aprov_p 
		and	nr_documento		= nr_documento_p;
	 
	end if;
	 
	 
	if ('NM' = upper(ie_tipo_p)) then 
		if ('S' = upper(ie_tipo_documento_w)) then --Solciitação de Compra 
			select substr(obter_nome_pessoa_fisica(cd_pessoa_solicitante,null),1,200) 
			into STRICT	retorno_w 
			from  solic_compra 
			where  nr_solic_compra = nr_documento_p;
		elsif ('R' = upper(ie_tipo_documento_w)) then --Requisição de Materiais e Medicamentos 
			select	substr(obter_nome_pessoa_fisica(cd_pessoa_requisitante,null),1,200) 
			into STRICT	retorno_w 
			from 	requisicao_material 
			where	nr_requisicao = nr_documento_p;
		elsif ('C' = upper(ie_tipo_documento_w)) then --Cotação de Compra 
			select 	substr(obter_nome_pessoa_fisica(cd_pessoa_solicitante,null),1,200) 
			into STRICT	retorno_w 
			from 	cot_compra 
			where	nr_cot_compra = nr_documento_p;
		elsif ('O' = upper(ie_tipo_documento_w)) then -- Ordem de Compra 
			select substr(obter_nome_pf_pj(cd_pessoa_solicitante,null),1,254) 
			into STRICT	retorno_w 
			from  ordem_compra 
			where  nr_ordem_compra = nr_documento_p;
		elsif ('N' = upper(ie_tipo_documento_w)) then --Nota Fiscal 
			select 	coalesce(nr_ordem_compra,0) 
			into STRICT	nr_ordem_compra_nf_w 
			from 	nota_fiscal 
			where	nr_sequencia = nr_documento_p;
 
			if (nr_ordem_compra_nf_w <> 0) then 
				select substr(obter_nome_pf_pj(cd_pessoa_solicitante,null),1,254) 
				into STRICT	retorno_w 
				from  ordem_compra 
				where  nr_ordem_compra = nr_ordem_compra_nf_w;
			end if;
		end if;
	elsif ('CD' = upper(ie_tipo_p)) then 
		if ('S' = upper(ie_tipo_documento_w)) then --Solciitação de Compra 
			select cd_pessoa_solicitante 
			into STRICT	retorno_w 
			from  solic_compra 
			where  nr_solic_compra = nr_documento_p;
		elsif ('R' = upper(ie_tipo_documento_w)) then --Requisição de Materiais e Medicamentos 
			select	cd_pessoa_requisitante 
			into STRICT	retorno_w 
			from 	requisicao_material 
			where	nr_requisicao = nr_documento_p;
		elsif ('C' = upper(ie_tipo_documento_w)) then --Cotação de Compra 
			select coalesce(cd_pessoa_solicitante,'') 
			into STRICT	retorno_w 
			from 	cot_compra 
			where	nr_cot_compra = nr_documento_p;
		elsif ('O' = upper(ie_tipo_documento_w)) then -- Ordem de Compra 
			select cd_pessoa_solicitante 
			into STRICT	retorno_w 
			from  ordem_compra 
			where  nr_ordem_compra = nr_documento_p;
		elsif ('N' = upper(ie_tipo_documento_w)) then --Nota Fiscal 
			select 	coalesce(nr_ordem_compra,0) 
			into STRICT	nr_ordem_compra_nf_w 
			from 	nota_fiscal 
			where	nr_sequencia = nr_documento_p;
 
			if (nr_ordem_compra_nf_w <> 0) then 
				select cd_pessoa_solicitante 
				into STRICT	retorno_w 
				from  ordem_compra 
				where  nr_ordem_compra = nr_ordem_compra_nf_w;
			end if;
		end if;
	end if;
 
return	retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dados_aprov_pend (nr_seq_proc_aprov_p bigint, nr_documento_p bigint, nm_usuario_p text, ie_tipo_p text) FROM PUBLIC;

