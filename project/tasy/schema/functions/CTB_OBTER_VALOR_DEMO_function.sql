-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE reg_fator AS (	nm_chave varchar(255),
				vl	 double precision);


CREATE OR REPLACE FUNCTION ctb_obter_valor_demo ( nr_seq_demo_p bigint, nr_seq_mes_ref_p bigint, ds_origem_p text, nr_seq_col_p bigint) RETURNS bigint AS $body$
DECLARE


type fator is table of reg_fator index by integer;

fatores_w			fator;

ds_origem_w			varchar(4000);
vl_fixo_w				double precision;
vl_saldo_w			double precision;
vl_result_w			double precision;
nr_seq_w				bigint;
ie_pos_w				integer;
ie_sinal_w			varchar(01)	:= '+';
ie_fixo_w				bigint	:= 0;
ind			bigint;
k			integer;
ds_valor_w			varchar(4000);
nm_param_w			varchar(255);
nm_chave_w			varchar(255);
ds_parametros_w			varchar(4000);
ie_existe_w			varchar(1)	:= 'N';
vl_result_ww			double precision;

qt_tamanho_w			bigint;
ie_caracter_w			varchar(1);
ds_regra_w			varchar(255);
ie_pos_regra_w			bigint;
BEGIN

ds_origem_w			:= ds_origem_p;
ds_origem_w			:= replace(ds_origem_w,' ','');
vl_result_w			:= 0;
ind				:= 0;
ds_valor_w			:= ds_origem_w;
qt_tamanho_w			:= coalesce(length(ds_origem_w),0);
fatores_w.delete;
ds_parametros_w			:= '';

for i in 1..qt_tamanho_w loop
	begin
	/* Caracter */

	ie_caracter_w	:= substr(ds_origem_w,i,1);

	if (ie_caracter_w in ('0','1','2','3','4','5','6','7','8','9')) then /* Numeros valor fixo ou Seq formula*/
		ds_regra_w	:= ds_regra_w || ie_caracter_w;
	elsif (ie_caracter_w = '#') then
		ie_fixo_w	:= i;
	else
		ie_pos_regra_w	:= i;
	end if;
	if (i = qt_tamanho_w) then
		ie_pos_regra_w	:= i;
	end if;
	/* Verifica se tem valor a calcular */

	if	((ie_caracter_w not in ('0','1','2','3','4','5','6','7','8','9','#')) or (i = qt_tamanho_w)) and (ds_regra_w IS NOT NULL AND ds_regra_w::text <> '') then
		begin

		if (ie_pos_regra_w <> 0) and /* Calcula valor da regra */
			(ie_pos_regra_w >= i) and (ie_fixo_w = 0) then
			begin

			nm_chave_w	:= ds_regra_w;
			nr_seq_w	:= campo_numerico(ds_regra_w);

			select	coalesce(sum(vl_referencia),0)
			into STRICT	vl_saldo_w
			from	ctb_demo_rubrica
			where	nr_seq_mes_ref	= nr_seq_mes_ref_p
			and	nr_seq_demo		= nr_seq_demo_p
			and	nr_seq_rubrica	= nr_seq_w
			and	nr_seq_col		= nr_seq_col_p;

			if (fatores_w.Count > 0) then
				begin
				ie_existe_w	:= 'N';
				for k in 1..fatores_w.Count loop
					begin
					if (fatores_w[k].nm_chave = nm_chave_w) and (ie_existe_w = 'N') then
						ind	:= k;
						ie_existe_w	:= 'S';
						exit;
					end if;
					end;
				end loop;
				end;
			end if;
			if (ie_existe_w = 'N') then
				ind	:= ind + 1;
			end if;

			fatores_w[ind].nm_chave	:= nm_chave_w;
			fatores_w[ind].vl	:= vl_saldo_w;
			nm_param_w		:= substr(':' || ind,1,255);
			ds_valor_w		:= substr(substituir_palavra_inteira(ds_valor_w,nm_chave_w,nm_param_w),1,4000);
			ie_pos_regra_w	:= 0;

			end;
		elsif (ie_fixo_w > 0) then
			vl_saldo_w	:= campo_numerico(ds_regra_w);
			ds_regra_w	:= '#' || ds_regra_w;
			ds_valor_w	:= substr(substituir_palavra_inteira(ds_valor_w,ds_regra_w,replace(vl_saldo_w,',','.')),1,4000);
			ie_fixo_w	:= 0;
		end if;
		ds_regra_w	:= '';
		end;
	end if;

	end;
end loop;

if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
	ds_valor_w	:= substr('SELECT ' || ds_valor_w || ' FROM DUAL',1,4000);

	for i in 1..fatores_w.Count loop
		begin
		nm_param_w	:= i || '=';
		ds_parametros_w	:= substr(ds_parametros_w || nm_param_w || fatores_w[i].vl || ';',1,4000);
		end;
	end loop;

	begin
	vl_result_w := obter_valor_dinamico_bv(ds_valor_w, ds_parametros_w, vl_result_w);
	exception when others then
		vl_result_w	:= 0;
	end;
	if (vl_result_w = 0) and (vl_result_ww > 0) then
		vl_result_w	:= vl_result_ww;
	end if;
end if;

return	vl_result_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ctb_obter_valor_demo ( nr_seq_demo_p bigint, nr_seq_mes_ref_p bigint, ds_origem_p text, nr_seq_col_p bigint) FROM PUBLIC;

