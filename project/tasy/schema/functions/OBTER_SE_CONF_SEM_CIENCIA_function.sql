-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_conf_sem_ciencia ( nr_prescricao_p bigint) RETURNS varchar AS $body$
DECLARE

  ie_retorno_w varchar(1) := 'N';
  c01 CURSOR FOR
    SELECT coalesce(MAX('S'), 'N')
    FROM prescr_material a,
      prescr_medica_erro b
    WHERE a.nr_prescricao    = b.nr_prescricao
    AND b.nr_seq_medic       = a.nr_sequencia
    AND a.nr_prescricao      = nr_prescricao_p
    AND a.ie_agrupador       in (1, 5)
    AND coalesce(b.ie_ciente,'N') = 'N'
    AND EXISTS (SELECT 1
      FROM regra_consiste_prescr d
      WHERE b.nr_regra                = d.nr_sequencia
      AND coalesce(ie_exibe_farmacia, 'S') = 'S'
      )

UNION

  SELECT coalesce(MAX('S'), 'N')
  FROM prescr_material a,
    prescr_medica_erro b,
    medicamento_risco c
  WHERE a.nr_prescricao              = b.nr_prescricao
  AND b.nr_seq_medic                 = a.nr_sequencia
  AND a.cd_material                  = c.cd_material
  AND a.nr_prescricao                = nr_prescricao_p
  AND a.ie_agrupador                 in (1, 5)
  AND coalesce(c.ie_nao_conformidade,'N') = 'S'
  AND coalesce(b.ie_ciente,'N')           = 'N'
  AND coalesce(c.ie_situacao, 'A')        = 'A'
  AND EXISTS (SELECT 1
    FROM regra_consiste_prescr d
    WHERE b.nr_regra                = d.nr_sequencia
    AND coalesce(ie_exibe_farmacia, 'S') = 'S'
    )
  
UNION

  SELECT coalesce(MAX('S'), 'N')
  FROM prescr_material a,
    prescr_medica_risco b,
    medicamento_risco c
  WHERE a.nr_prescricao              = b.nr_prescricao
  AND a.cd_material                  = c.cd_material
  AND a.nr_prescricao                = nr_prescricao_p
  AND a.ie_agrupador                 in (1, 5)
  AND coalesce(c.ie_nao_conformidade,'N') = 'S'
  AND coalesce(b.ie_ciente,'N')           = 'N'
  AND coalesce(c.ie_situacao, 'A')        = 'A';

BEGIN
  OPEN c01;
  LOOP
    FETCH c01 INTO ie_retorno_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
    NULL;
  END LOOP;
CLOSE c01;
RETURN ie_retorno_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_conf_sem_ciencia ( nr_prescricao_p bigint) FROM PUBLIC;

