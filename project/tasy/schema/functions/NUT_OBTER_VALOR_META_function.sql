-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION nut_obter_valor_meta (nr_sequencia_p bigint, ie_opcao bigint) RETURNS bigint AS $body$
DECLARE


vl_custo_total_w	double precision;
nr_seq_local_w	        bigint;
nr_seq_grupo_producao_w bigint;
cd_dieta_w              bigint;
nr_seq_servico_w        bigint;
nr_seq_composicao_w     bigint;
dt_cardapio_w		timestamp;

/*
1 - Servico
2 - Composicao
3 -  Meta di√°ria
*/
BEGIN

if (ie_opcao = 1) then

	select  max(nr_seq_servico),
		max(nr_seq_local),
		max(nr_seq_grupo_producao),
		max(cd_dieta),
		max(dt_cardapio)
	into STRICT 	nr_seq_servico_w,
		nr_seq_local_w,
		nr_seq_grupo_producao_w,
		cd_dieta_w,
		dt_cardapio_w
	from   	nut_cardapio_dia
	where  	nr_sequencia = nr_sequencia_p;


	select	max(b.vl_custo)
	into STRICT	vl_custo_total_w
	from    nut_meta_servico b
	where   b.nr_seq_servico 	= nr_seq_servico_w
	and (coalesce(nr_seq_local_w,0) 	= coalesce(b.nr_seq_local,0))
	and (coalesce(cd_dieta_w,0) 	= coalesce(b.cd_dieta,0))
	and (coalesce(nr_seq_grupo_producao_w,0) = coalesce(b.nr_seq_grupo_dieta,0))
	and     b.dt_vigencia_ini <= dt_cardapio_w
	and     b.dt_vigencia_fim >= dt_cardapio_w;

elsif (ie_opcao = 2) then

	select max(a.nr_seq_composicao),
	       max(b.dt_cardapio)
	into STRICT   nr_seq_composicao_w,
	       dt_cardapio_w
	from   nut_pac_opcao_rec a,
	       nut_cardapio_dia b
	where  b.nr_sequencia = a.nr_seq_cardapio_dia
	and    a.nr_sequencia = nr_sequencia_p;


	select 	max(vl_custo)
	into STRICT    vl_custo_total_w
	from	nut_composicao a,
		nut_meta_composicao b
	where   a.nr_sequencia = b.nr_seq_composicao
	and	b.dt_vigencia_ini <= dt_cardapio_w
	and     b.dt_vigencia_fim >= dt_cardapio_w
	and     b.nr_seq_composicao = nr_seq_composicao_w;

elsif (ie_opcao = 3) then

        select max(dt_cardapio)
	into STRICT   dt_cardapio_w
	from   nut_cardapio_dia
	where  nr_sequencia = nr_sequencia_p;

	select max(vl_custo)
	into STRICT   vl_custo_total_w
	from   nut_meta_diaria
	where  dt_vigencia_ini <= dt_cardapio_w
	and    dt_vigencia_fim >= dt_cardapio_w;

end if;


return vl_custo_total_w;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION nut_obter_valor_meta (nr_sequencia_p bigint, ie_opcao bigint) FROM PUBLIC;

