-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_instrucao_bol_estab_fin ( nr_titulo_p bigint, cd_banco_p bigint, nr_linha_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

			
/*		A T EN C A O
OS 1407542

ESSA ROTINA E COPIA DA ROTINA OBTER_INSTRUCAO_BOLETO_ESTAB
POREM SEM UTILIZAR REPLACE_MACRO_LONG E REPLACE_MACRO
NA SUBSTITUICAO DAS MACROS, DEVIDO A LENTIDAO DESSAS NOVAS FUNCTIONS

ESSA ROTINA DEVE SER UTILIZADA APENAS NO BR*/
				
				
ds_retorno_w			varchar(255);
ds_instrucao_w			varchar(255);
vl_titulo_w			double precision;
tx_juros_w			double precision;
tx_multa_w			double precision;
cd_tipo_taxa_juro_w		bigint;
cd_tipo_taxa_multa_w		bigint;
ds_tipo_taxa_juros_w		varchar(30);
ds_tipo_taxa_multa_w		varchar(30);
ie_tipo_taxa_w			varchar(1);
dt_emissao_w			timestamp;
nr_telefone_w			varchar(15);
cd_cgc_w			pessoa_juridica.cd_cgc%type;
nm_pessoa_w			varchar(255);
nr_seq_mensalidade_w		titulo_receber.nr_seq_mensalidade%type;
dt_mensalidade_w			timestamp;
tx_reajuste_pls_w			pls_reajuste.tx_reajuste%type;
vl_mensalidade_pls_w		pls_mensalidade.vl_mensalidade%type;
vl_reajuste_pls_w			double precision;
ds_plano_w			pls_plano.ds_plano%type;
cd_scpa_w			pls_plano.cd_scpa%type;
nr_protocolo_ans_w		pls_plano.nr_protocolo_ans%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
cd_usuario_plano_w		varchar(25);
ds_oficio_ans_w			pls_reajuste.ds_oficio_ans%type;
cd_juridico_liminar_w		processo_judicial_liminar.cd_juridico_liminar%type;
dt_reajuste_pls_w			timestamp;
nr_seq_contrato_w			pls_mensalidade.nr_seq_contrato%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
cd_cgc_outorgante_w		pls_outorgante.cd_cgc_outorgante%type;
ds_regra_w			banco_instrucao_boleto.ds_regra%type;
ds_valor_regra_w			banco_instrucao_boleto.ds_valor_regra%type;
ie_condicao_w			banco_instrucao_boleto.ie_condicao%type;
vl_reajuste_pls_etaria_w		double precision;
dt_reajuste_cobr_w			pls_mensalidade_segurado.dt_mesano_referencia%type;
dt_reajuste_mud_w			pls_mensalidade_segurado.dt_mesano_referencia%type;
dt_reajuste_var_w			pls_mensalidade_segurado.dt_mesano_referencia%type;
dt_reajuste_sca_w			pls_mensalidade_segurado.dt_mesano_referencia%type;
ds_obs_sca_w			pls_mensalidade_seg_item.ds_observacao%type;
vl_item_sca_w			pls_mensalidade_seg_item.vl_item%type;
ds_observacao_w			pls_mensalidade.ds_observacao%type;
ds_msg_quitacao_w		pls_mensalidade.ds_mensagem_quitacao%type;
ds_msg_reajuste_w			pls_mensalidade_seg_item.ds_mensagem_reajuste%type;
ds_msg_reajuste_w2		pls_mensalidade_seg_item.ds_mensagem_reajuste%type;
ds_portabilidade_w			pls_mensalidade.ds_observacao%type;
nr_seq_conta_proc_w		pls_conta_proc.nr_sequencia%type;
nr_seq_conta_mat_w		pls_conta_proc.nr_sequencia%type;
nm_prestador_w			varchar(255);
ds_fator_moderador_w		pls_conv_serv_extrat_mens.ds_servico_dest%type;
dt_fator_moderador_w		timestamp;
qt_fator_moderador_w		double precision;
vl_fator_moderador_w		double precision;

nm_beneficiario_w			varchar(255);	
dt_inclusao_w				varchar(255);			
ds_tp_contratacao_w			varchar(255);
nr_seq_mensalidade_seg_w	pls_mensalidade_segurado.nr_sequencia%type;		
ds_sca_w					varchar(255);
vl_sca_w					varchar(255);
nm_benef_coparticip_w		varchar(255);
dt_atendimento_w			varchar(255);
ds_prestador_executante_w	varchar(255);
ds_tipo_tratamento_w		varchar(255);
vl_coparticipacao_w			varchar(255);
ds_tp_contratacao_pj_w		varchar(255);
vl_mensalidades_pj_w		varchar(255);
vl_coparticipacao_pj_w		varchar(255);
ds_produto_ans_w			varchar(255);
dt_vencimento_w		titulo_receber.dt_vencimento%type;
vl_saldo_titulo_w		titulo_receber.vl_saldo_titulo%type;
dt_contrato_w				pls_contrato.dt_contrato%type;
dt_contrato_fim_w			timestamp;
nr_cartao_nac_sus_w		pessoa_fisica.nr_cartao_nac_sus%type;
vl_outros_w	                pls_mensalidade.vl_outros%type;


/*INICIO Essa macro e fixa conforme OS 799927. Nao existia essa macro nessa rotina, apenas na OBTER_INSTRUCAO_BOLETO_TAM, e repliquei a mesma para ca. */

nr_nota_fiscal_w		titulo_receber.nr_nota_fiscal%type;
nr_nfe_imp_w			varchar(255);
vl_desc_previsto_w		titulo_receber.vl_desc_previsto%type;
dt_pagamento_previsto_w		titulo_receber.dt_pagamento_previsto%type;
ds_coparticipacao_w		varchar(255);
ds_men_valor_produto_w		varchar(255);
ds_dt_aniv_plano_w		varchar(255);
/*FIM*/

c01 CURSOR FOR
	SELECT distinct c.ds_mensagem_reajuste
	from pls_mensalidade_segurado b,
	pls_mensalidade_seg_item c
	where b.nr_sequencia	= c.nr_seq_mensalidade_seg
	and b.nr_seq_mensalidade	= nr_seq_mensalidade_w
	and (c.ds_mensagem_reajuste IS NOT NULL AND c.ds_mensagem_reajuste::text <> '')
	and c.ie_tipo_item in ('4','5','25','35')
	order by c.ds_mensagem_reajuste desc;


BEGIN

if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') and (cd_banco_p IS NOT NULL AND cd_banco_p::text <> '') and (nr_linha_p IS NOT NULL AND nr_linha_p::text <> '') then
	select	a.vl_titulo,
		tx_juros,
		tx_multa,
		cd_tipo_taxa_juro,
		cd_tipo_taxa_multa,
		a.dt_emissao,
		substr(obter_dados_pf_pj(a.cd_pessoa_fisica,a.cd_cgc,'T'),1,15) nr_telefone,
		a.cd_cgc,
		substr(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc),1,255),
		a.nr_seq_mensalidade,
		a.cd_pessoa_fisica,
		a.dt_vencimento,
		a.vl_saldo_titulo,
		a.nr_nota_fiscal,
		substr(obter_dados_titulo_receber(a.nr_titulo,'NE'),1,100) nr_nfe_imp,
		a.vl_desc_previsto,
		a.dt_pagamento_previsto
	into STRICT	vl_titulo_w,
		tx_juros_w,
		tx_multa_w,
		cd_tipo_taxa_juro_w,
		cd_tipo_taxa_multa_w,
		dt_emissao_w,
		nr_telefone_w,
		cd_cgc_w,
		nm_pessoa_w,
		nr_seq_mensalidade_w,
		cd_pessoa_fisica_w,
		dt_vencimento_w,
		vl_saldo_titulo_w,
		nr_nota_fiscal_w,
		nr_nfe_imp_w,
		vl_desc_previsto_w,
		dt_pagamento_previsto_w
	from	titulo_receber a
	where	a.nr_titulo	= nr_titulo_p;
	
	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
		select	max(nr_cartao_nac_sus)
		into STRICT 	nr_cartao_nac_sus_w
		from	pessoa_fisica 
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;
	end if;

	select	substr(max(obter_valor_dominio(707,a.ie_tipo_taxa)),1,30),
		a.ie_tipo_taxa
	into STRICT	ds_tipo_taxa_juros_w,
		ie_tipo_taxa_w
	from	tipo_taxa a
	where	a.cd_tipo_taxa	= cd_tipo_taxa_juro_w
	group by a.ie_tipo_taxa;

	select	substr(max(obter_valor_dominio(707,a.ie_tipo_taxa)),1,30)
	into STRICT	ds_tipo_taxa_multa_w
	from	tipo_taxa a
	where	a.cd_tipo_taxa	= cd_tipo_taxa_multa_w;

	select	max(a.ds_instrucao),
		max(a.ds_regra),
		max(a.ds_valor_regra),
		coalesce(max(a.ie_condicao),'D')
	into STRICT	ds_instrucao_w,
		ds_regra_w,
		ds_valor_regra_w,
		ie_condicao_w
	from	banco_instrucao_boleto a
	where	coalesce(a.cd_estabelecimento,0)	= coalesce(cd_estabelecimento_p,coalesce(a.cd_estabelecimento,0))
	and	a.cd_banco	= cd_banco_p
	and	a.nr_linha	= nr_linha_p;

	if (ie_tipo_taxa_w = 'M') then
		tx_juros_w := dividir_sem_round((tx_juros_w)::numeric, 30);
	elsif (ie_tipo_taxa_w = 'A') then
		tx_juros_w := dividir_sem_round((tx_juros_w)::numeric, 365);
	end if;

	if (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '') then
	select	max(a.dt_referencia),
		max(a.nr_seq_contrato),
		a.ds_observacao,
		a.ds_mensagem_quitacao,
		a.vl_outros
	into STRICT	dt_mensalidade_w,
		nr_seq_contrato_w,
		ds_observacao_w,
		ds_msg_quitacao_w,
		vl_outros_w 
	from	pls_mensalidade a
	where	a.nr_sequencia		= nr_seq_mensalidade_w
	group by 	a.ds_observacao,
		a.ds_mensagem_quitacao,
		a.vl_outros;	
	end if;
	
	
	select	pls_obter_proximo_reajuste(nr_seq_contrato_w)
	into STRICT	dt_reajuste_pls_w
	;

	select	max(x.nr_seq_segurado)
	into STRICT	nr_seq_segurado_w
	from	pls_segurado y,
		pls_mensalidade_segurado x
	where	y.cd_pessoa_fisica		= cd_pessoa_fisica_w
	and	x.nr_seq_segurado		= y.nr_sequencia
	and	x.nr_seq_mensalidade	= nr_seq_mensalidade_w;

	if (coalesce(nr_seq_segurado_w::text, '') = '') then

		select	max(x.nr_seq_segurado)
		into STRICT	nr_seq_segurado_w
		from	pls_mensalidade_segurado x
		where	x.nr_seq_mensalidade	= nr_seq_mensalidade_w;

	end if;

	select	coalesce(sum(b.vl_item),0)
	into STRICT	vl_mensalidade_pls_w
	from	pls_mensalidade_seg_item b,
		pls_mensalidade_segurado a
	where	b.ie_tipo_item		in ('1','20')
	and	a.nr_sequencia		= b.nr_seq_mensalidade_seg
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;

	select	coalesce(sum(CASE WHEN b.ie_tipo_item='5' THEN b.vl_item  ELSE 0 END ),0),
		coalesce(sum(CASE WHEN b.ie_tipo_item='5' THEN 0  ELSE b.vl_item END ),0)
	into STRICT	vl_reajuste_pls_etaria_w,
		vl_reajuste_pls_w
	from	pls_mensalidade_seg_item b,
		pls_mensalidade_segurado a
	where	b.ie_tipo_item		in ('4','5','25')
	and	a.nr_sequencia		= b.nr_seq_mensalidade_seg
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;

	select	max(d.tx_reajuste),
		max(d.ds_oficio_ans)
	into STRICT	tx_reajuste_pls_w,
		ds_oficio_ans_w
	from	pls_reajuste d,
		pls_reajuste_preco c,
		pls_mensalidade_seg_item b,
		pls_mensalidade_segurado a
	where	c.nr_seq_reajuste		= d.nr_sequencia
	and	b.nr_seq_reajuste		= c.nr_sequencia
	and	b.ie_tipo_item		= '25'
	and	a.nr_sequencia		= b.nr_seq_mensalidade_seg
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;

	select	max(c.ds_plano),
		max(c.cd_scpa),
		max(c.nr_protocolo_ans),
		max(d.cd_cgc_outorgante)
	into STRICT	ds_plano_w,
		cd_scpa_w,
		nr_protocolo_ans_w,
		cd_cgc_outorgante_w
	from	pls_outorgante d,
		pls_plano c,
		pls_mensalidade_segurado b
	where	c.nr_seq_outorgante	= d.nr_sequencia
	and	b.nr_seq_plano		= c.nr_sequencia
	and	b.nr_seq_segurado		= nr_seq_segurado_w
	and	b.nr_seq_mensalidade	= nr_seq_mensalidade_w;

	select	ltrim(max(a.cd_usuario_plano),'0')
	into STRICT	cd_usuario_plano_w
	from	pls_segurado_carteira a,
		pls_segurado b
	where	a.nr_seq_segurado		= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_segurado_w;

	select	max(a.cd_juridico_liminar)
	into STRICT	cd_juridico_liminar_w
	from	processo_judicial_liminar a,
		pls_mensalidade_segurado b
	where	a.nr_seq_segurado		= b.nr_seq_segurado
	and	b.nr_seq_mensalidade	= nr_seq_mensalidade_w
	and	b.nr_seq_segurado		= nr_seq_segurado_w;
	
	select	max(a.dt_mesano_referencia)
	into STRICT	dt_reajuste_cobr_w
	from	pls_mensalidade_seg_item b,
		pls_mensalidade_segurado a
	where	b.ie_tipo_item		= '4'
	and	a.nr_sequencia		= b.nr_seq_mensalidade_seg
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;	
	
	select	max(a.dt_mesano_referencia)
	into STRICT	dt_reajuste_mud_w
	from	pls_mensalidade_seg_item b,
		pls_mensalidade_segurado a
	where	b.ie_tipo_item		= '5'
	and	a.nr_sequencia		= b.nr_seq_mensalidade_seg
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;	

	select	max(a.dt_mesano_referencia)
	into STRICT	dt_reajuste_var_w
	from	pls_mensalidade_seg_item b,
		pls_mensalidade_segurado a
	where	b.ie_tipo_item		= '25'
	and	a.nr_sequencia		= b.nr_seq_mensalidade_seg
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;	

	select	max(a.dt_mesano_referencia)
	into STRICT	dt_reajuste_sca_w
	from	pls_mensalidade_seg_item b,
		pls_mensalidade_segurado a
	where	b.ie_tipo_item		= '35'
	and	a.nr_sequencia		= b.nr_seq_mensalidade_seg
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;	
	
	select	max(b.ds_observacao),
		sum(b.vl_item)
	into STRICT	ds_obs_sca_w,
		vl_item_sca_w
	from	pls_mensalidade_seg_item b,
		pls_mensalidade_segurado a
	where	b.ie_tipo_item		= '15'
	and	a.nr_sequencia		= b.nr_seq_mensalidade_seg
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;		
	
	select 	max(nr_seq_conta_proc),
		max(nr_seq_conta_mat) 
	into STRICT	nr_seq_conta_proc_w,
		nr_seq_conta_mat_w	
	from (
		SELECT	f.nr_sequencia nr_seq_conta_proc,
			null nr_seq_conta_mat
		from	pls_conta_proc f,
			pls_conta e,
			pls_mensalidade_seg_item a,
			pls_mensalidade_segurado b,
			pls_mensalidade c,
			titulo_receber d
		where	b.nr_sequencia	= a.nr_seq_mensalidade_seg
		and	c.nr_sequencia	= b.nr_seq_mensalidade
		and	e.nr_sequencia	= a.nr_seq_conta
		and	e.nr_sequencia	= f.nr_seq_conta
		and	(a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')
		and	c.nr_sequencia	= d.nr_seq_mensalidade
		and	d.nr_titulo		= nr_titulo_p
		
union all

		SELECT	null nr_seq_conta_proc,
			f.nr_sequencia nr_seq_conta_mat		
		from	pls_conta_mat f,
			pls_conta e,
			pls_mensalidade_seg_item a,
			pls_mensalidade_segurado b,
			pls_mensalidade c,
			titulo_receber d
		where	b.nr_sequencia	= a.nr_seq_mensalidade_seg
		and	c.nr_sequencia	= b.nr_seq_mensalidade
		and	e.nr_sequencia	= a.nr_seq_conta
		and	e.nr_sequencia	= f.nr_seq_conta
		and	(a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')
		and	c.nr_sequencia	= d.nr_seq_mensalidade
		and	d.nr_titulo		= nr_titulo_p) alias4;	
	
	if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') or (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then

		select	max(nm_prestador),
			max(ds_fator_moderador),
			max(dt_fator_moderador),
			max(qt_fator_moderador),
			max(vl_fator_moderador)
		into STRICT	nm_prestador_w,
			ds_fator_moderador_w,
			dt_fator_moderador_w,
			qt_fator_moderador_w,
			vl_fator_moderador_w
		from	(SELECT	substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'N'),1,255) nm_prestador,
				coalesce(substr(pls_obter_conv_serv_extratmens(a.nr_sequencia,a.cd_procedimento,a.ie_origem_proced,null,null,null,null),1,55), substr(obter_descricao_procedimento(a.cd_procedimento,a.ie_origem_proced),1,48)) ds_fator_moderador,
				coalesce(a.dt_procedimento, b.dt_emissao) dt_fator_moderador,
				coalesce(	(select	sum(x.qt_liberada_copartic)
					from	pls_conta_coparticipacao x
					where	x.nr_seq_conta_proc	= a.nr_sequencia), a.qt_procedimento) qt_fator_moderador,
				coalesce(	(select	sum(x.vl_coparticipacao)
					from	pls_conta_coparticipacao x
					where	x.nr_seq_conta_proc	= a.nr_sequencia),0) vl_fator_moderador
			from	pls_conta b,
				pls_conta_proc a
			where	a.nr_seq_conta	= b.nr_sequencia
			and	a.nr_sequencia	= nr_seq_conta_proc_w
			
union

			SELECT	substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'N'),1,255) nm_prestador,
				coalesce(substr(pls_obter_conv_serv_extratmens(null,null,null,a.nr_seq_material,null,null,null),1,55), substr(pls_obter_desc_material(a.nr_seq_material),1,55)) ds_fator_moderador,
				coalesce(a.dt_atendimento, b.dt_emissao) dt_fator_moderador,
				coalesce((	select	sum(x.qt_liberada_copartic)
					from	pls_conta_coparticipacao x
					where	x.nr_seq_conta_mat	= a.nr_sequencia), a.qt_material) qt_fator_moderador,
				coalesce((	select	sum(x.vl_coparticipacao)
					from	pls_conta_coparticipacao x
					where	x.nr_seq_conta_mat	= a.nr_sequencia),0) vl_fator_moderador
			from	pls_conta b,
				pls_conta_mat a
			where	a.nr_seq_conta	= b.nr_sequencia
			and	a.nr_sequencia	= nr_seq_conta_mat_w) alias35;

	end if;	
	
	ds_msg_reajuste_w := null;	

	open C01;
	loop
	fetch C01 into	
		ds_msg_reajuste_w2;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (coalesce(ds_msg_reajuste_w::text, '') = '') then
			ds_msg_reajuste_w := ds_msg_reajuste_w2;
		else
			ds_msg_reajuste_w := substr(ds_msg_reajuste_w || ' ' || ds_msg_reajuste_w2, 1, 2000);
		end if;
		end;
	end loop;
	close C01;
	
	ds_coparticipacao_w	:= ' COPARTICIPACAO '; /*Essa macro e fixa conforme OS 799927. Nao existia essa macro nessa rotina, apenas na OBTER_INSTRUCAO_BOLETO_TAM, e repliquei a mesma para ca. */

	
	/*Essa macro e fixa conforme OS 799927. Nao existia essa macro nessa rotina, apenas na OBTER_INSTRUCAO_BOLETO_TAM, e repliquei a mesma para ca. */

	begin
	select ' '|| obter_valor_dominio(1930,max(b.ie_tipo_item)) || '   ' || campo_mascara_virgula(coalesce(max(b.vl_item),0)) || '   ' || coalesce(substr(pls_obter_dados_plano_mens(max(b.nr_sequencia)),1,255),'')||' '
	into STRICT	ds_men_valor_produto_w
	from	pls_mensalidade_seg_item b,
		pls_mensalidade_segurado a
	where	a.nr_sequencia  		= b.nr_seq_mensalidade_seg
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;
	exception when others then
		ds_men_valor_produto_w := null;
	end;
	
	/*Essa macro e fixa conforme OS 799927. Nao existia essa macro nessa rotina, apenas na OBTER_INSTRUCAO_BOLETO_TAM, e repliquei a mesma para ca. */

	begin
	select 	CASE WHEN coalesce(max(c.dt_contrato)::text, '') = '' THEN null  ELSE ' '|| obter_data_extenso(to_date(to_char(PKG_DATE_UTILS.start_of(max(c.dt_contrato),'MONTH', 0),'dd/mm') || '/' || PKG_DATE_UTILS.extract_field('YEAR',clock_timestamp())),0) || ' a ' || obter_data_extenso(trunc(pkg_date_utils.end_of(PKG_DATE_UTILS.ADD_MONTH(to_date(to_char(PKG_DATE_UTILS.start_of(max(c.dt_contrato),'MONTH', 0),'dd/mm') || '/' || PKG_DATE_UTILS.extract_field('YEAR',clock_timestamp())),3, 0), 'MONTH', 0)), 0)|| ' ' END
	into STRICT	ds_dt_aniv_plano_w
	from	pls_mensalidade_segurado a,
			pls_segurado b,
			pls_contrato c
	where	b.nr_sequencia		= a.nr_seq_segurado
	and	c.nr_sequencia		= b.nr_seq_contrato
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w
	and	PKG_DATE_UTILS.start_of(c.dt_contrato,'MONTH', 0)	=  PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.ADD_MONTH(clock_timestamp(),1, 0),'MONTH', 0);
	exception when others then
		ds_dt_aniv_plano_w := null;
	end;
	
	select max(a.ds_observacao)
	into STRICT ds_portabilidade_w
	from pls_mensalidade a
	where a.nr_sequencia	= nr_seq_mensalidade_w
	and lower(a.ds_observacao) like '%portabilidade%';

	/*Inicio macros OS950304*/

	begin
	select	substr(pls_obter_dados_segurado(max(nr_seq_segurado),'N'),1,255) nm_beneficiario,
			substr(pls_obter_dados_segurado(max(nr_seq_segurado),'D'),1,255) dt_inclusao,
			substr(pls_obter_dados_produto(max(nr_seq_plano),'C'),1,255) ds_tp_contratacao,
			max(nr_sequencia) nr_seq_mensalidade_seg
	into STRICT	nm_beneficiario_w,
			dt_inclusao_w,
			ds_tp_contratacao_w,
			nr_seq_mensalidade_seg_w
	from 	pls_mensalidade_segurado a
	where 	nr_seq_mensalidade = nr_seq_mensalidade_w;
	exception when others then
		null;
	end;

	begin
	select	substr(pls_obter_dados_vinc_bonific('',max(nr_seq_vinculo_sca),'N') ,1,255) ds_sca,
			substr(max(vl_item),1,255) vl_sca
	into STRICT	ds_sca_w,
			vl_sca_w
	from 	pls_mensalidade_seg_item
	where 	ie_tipo_item = 15
	and 	nr_seq_mensalidade_seg = nr_seq_mensalidade_w;
	exception when others then
		null;
	end;
	
	begin
	select	substr(pls_obter_dados_produto(max(nr_seq_plano),'C'),1,255) ds_tp_contratacao_pj,
			sum(a.vl_mensalidade) vl_mensalidades_pj,
			sum(a.vl_coparticipacao) vl_coparticipacao_pj,
			substr(to_char(max(nr_seq_plano))||' '||pls_obter_dados_produto(max(nr_seq_plano),'N')||' ('||pls_obter_dados_produto(max(nr_seq_plano),'ANS')||')',1,255) ds_produto_ans
	into STRICT	ds_tp_contratacao_pj_w,
			vl_mensalidades_pj_w,
			vl_coparticipacao_pj_w,
			ds_produto_ans_w
	from   	pls_mensalidade_segurado a
	where 	a.nr_seq_mensalidade = nr_seq_mensalidade_w;
	exception when others then
		null;
	end;	

	begin
	if (nr_seq_mensalidade_seg_w IS NOT NULL AND nr_seq_mensalidade_seg_w::text <> '') then
		select	substr(pls_obter_dados_conta(max(a.nr_seq_conta),'NB'),1,255) nm_benef_coparticip,
				substr(pls_obter_dados_conta(max(a.nr_seq_conta),'DTA'),1,255) dt_atendimento,
				substr(pls_obter_dados_conta(max(a.nr_seq_conta),'PE'),1,255) ds_prestador_executante,
				substr(pls_obter_dados_conta(max(a.nr_seq_conta),'TG'),1,255) ds_tipo_tratamento,
				substr(pls_obter_dados_conta(max(a.nr_seq_conta),'VC'),1,255) vl_coparticipacao
		into STRICT	nm_benef_coparticip_w,
				dt_atendimento_w,
				ds_prestador_executante_w,
				ds_tipo_tratamento_w,
				vl_coparticipacao_w
		from 	pls_mensalidade_seg_item a
		where 	a.ie_tipo_item = 3
		and 	a.nr_seq_mensalidade_seg = nr_seq_mensalidade_seg_w;
	end if;
	exception when others then
		null;
	end;
	/*fim macros OS950304*/
	
	
	if (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '') and (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then
	
		select 	max(c.dt_contrato)
		into STRICT	dt_contrato_w
		from	pls_mensalidade_segurado a,
				pls_segurado b,
				pls_contrato c
		where	b.nr_sequencia		= a.nr_seq_segurado
		and	c.nr_sequencia		= b.nr_seq_contrato
		and	a.nr_seq_segurado		= nr_seq_segurado_w
		and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;
		
		if (dt_contrato_w IS NOT NULL AND dt_contrato_w::text <> '') then
			dt_contrato_fim_w := PKG_DATE_UTILS.ADD_MONTH(dt_contrato_w,3, 0);
		end if;
	
	end if;

	if (ds_regra_w IS NOT NULL AND ds_regra_w::text <> '') then

		if (position('@VL_TITULO' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(coalesce(vl_titulo_w,0)) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_titulo_w::text, '') = '')) or (to_char(coalesce(vl_titulo_w,0)) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@TX_MULTA' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(coalesce(tx_multa_w,0)) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(tx_multa_w::text, '') = '')) or (to_char(coalesce(tx_multa_w,0)) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@TP_TX_JUROS' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_tipo_taxa_juros_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_tipo_taxa_juros_w::text, '') = '')) or (ds_tipo_taxa_juros_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@TP_TX_MULTA' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_tipo_taxa_multa_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_tipo_taxa_multa_w::text, '') = '')) or (ds_tipo_taxa_multa_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@TX_JUROS' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(coalesce(tx_juros_w,0)) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(tx_juros_w::text, '') = '')) or (to_char(coalesce(tx_juros_w,0)) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DT_EMISSAO' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(dt_emissao_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_emissao_w::text, '') = '')) or (to_char(dt_emissao_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@MES_ANO_EMISSAO' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(dt_emissao_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_emissao_w::text, '') = '')) or (to_char(dt_emissao_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@NR_TELEFONE' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND nr_telefone_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(nr_telefone_w::text, '') = '')) or (nr_telefone_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@NR_TITULO' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(nr_titulo_p) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(nr_titulo_p::text, '') = '')) or (to_char(nr_titulo_p) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@CD_CGC_OUTORGANTE' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND cd_cgc_outorgante_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(cd_cgc_outorgante_w::text, '') = '')) or (cd_cgc_outorgante_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@CD_CGC' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND cd_cgc_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(cd_cgc_w::text, '') = '')) or (cd_cgc_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@NM_PESSOA' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND nm_pessoa_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(nm_pessoa_w::text, '') = '')) or (nm_pessoa_w = ds_valor_regra_w)))) then
			
			ds_instrucao_w	:= null;			
			
		elsif (position('@DT_MENSALIDADE_PLS' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(dt_mensalidade_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_mensalidade_w::text, '') = '')) or (to_char(dt_mensalidade_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@VL_MENSALIDADE_PLS' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(coalesce(vl_mensalidade_pls_w,0)) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_mensalidade_pls_w::text, '') = '')) or (to_char(coalesce(vl_mensalidade_pls_w,0)) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DS_PLANO_PLS' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_plano_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_plano_w::text, '') = '')) or (ds_plano_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@CD_SCPA_PLS' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND cd_scpa_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(cd_scpa_w::text, '') = '')) or (cd_scpa_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@NR_PROTOCOLO_ANS_PLS' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND nr_protocolo_ans_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(nr_protocolo_ans_w::text, '') = '')) or (nr_protocolo_ans_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@CD_USUARIO_PLANO_PLS' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND cd_usuario_plano_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(cd_usuario_plano_w::text, '') = '')) or (cd_usuario_plano_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@CD_JURIDICO_LIMINAR_PLS' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (coalesce(cd_juridico_liminar_w,'X') <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(cd_juridico_liminar_w::text, '') = '')) or (cd_juridico_liminar_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@TX_REAJUSTE_PLS' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(coalesce(tx_reajuste_pls_w,0)) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(tx_reajuste_pls_w::text, '') = '')) or (to_char(coalesce(tx_reajuste_pls_w,0)) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DS_OFICIO_ANS_PLS' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_oficio_ans_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_oficio_ans_w::text, '') = '')) or (ds_oficio_ans_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@VL_REAJUSTE_PLS' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(coalesce(vl_reajuste_pls_w,0)) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_reajuste_pls_w::text, '') = '')) or (to_char(coalesce(vl_reajuste_pls_w,0)) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DT_REAJUSTE_PLS' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(dt_reajuste_pls_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_reajuste_pls_w::text, '') = '')) or (to_char(dt_reajuste_pls_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;
		
		elsif (position('@VL_ETARIA_PLS' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(vl_reajuste_pls_etaria_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_reajuste_pls_etaria_w::text, '') = '')) or (to_char(vl_reajuste_pls_etaria_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;
			
		elsif (position('@DT_REAJUSTE_COBR' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(dt_reajuste_cobr_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_reajuste_cobr_w::text, '') = '')) or (to_char(dt_reajuste_cobr_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;
			
		elsif (position('@DT_REAJUSTE_MUD' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(dt_reajuste_mud_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_reajuste_mud_w::text, '') = '')) or (to_char(dt_reajuste_mud_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DT_REAJUSTE_VAR' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(dt_reajuste_var_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_reajuste_var_w::text, '') = '')) or (to_char(dt_reajuste_var_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DT_REAJUSTE_SCA' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(dt_reajuste_sca_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_reajuste_sca_w::text, '') = '')) or (to_char(dt_reajuste_sca_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;			

		elsif (position('@NR_SEQ_MENSALIDADE' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND nr_seq_mensalidade_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(nr_seq_mensalidade_w::text, '') = '')) or (nr_seq_mensalidade_w = ds_valor_regra_w)))) then		

			ds_instrucao_w	:= null;			
			
		elsif (position('@VL_ITEM_SCA' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(coalesce(vl_item_sca_w,0)) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_item_sca_w::text, '') = '')) or (to_char(coalesce(vl_item_sca_w,0)) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;	

		elsif (position('@DS_OBS_SCA' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_obs_sca_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_obs_sca_w::text, '') = '')) or (ds_obs_sca_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;		

		elsif (position('@DS_OBS_PORTABILIDADE' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_portabilidade_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_portabilidade_w::text, '') = '')) or (ds_portabilidade_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;
			
		elsif (position('@DS_MENSAGEM_QUITACAO' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_msg_quitacao_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_msg_quitacao_w::text, '') = '')) or (ds_msg_quitacao_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;
		
		elsif (position('@DS_MENSAGEM_REAJUSTE' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (substr(ds_msg_reajuste_w,1,200) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(substr(ds_msg_reajuste_w,1,200)::text, '') = '')) or (substr(ds_msg_reajuste_w,1,200) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;
			
		elsif (position('@DS_MENSAGEM_2REAJUSTE' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (substr(ds_msg_reajuste_w,201,254) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(substr(ds_msg_reajuste_w,201,254)::text, '') = '')) or (substr(ds_msg_reajuste_w,201,254) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;	
			
		elsif (position('@NM_PRESTADOR' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND nm_prestador_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(nm_prestador_w::text, '') = '')) or (nm_prestador_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;			

		elsif (position('@DS_FATOR_MODERADOR' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_fator_moderador_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_fator_moderador_w::text, '') = '')) or (ds_fator_moderador_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DT_FATOR_MODERADOR' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(dt_fator_moderador_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_fator_moderador_w::text, '') = '')) or (to_char(dt_fator_moderador_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@QT_FATOR_MODERADOR' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND qt_fator_moderador_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(qt_fator_moderador_w::text, '') = '')) or (qt_fator_moderador_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@VL_FATOR_MODERADOR' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(coalesce(vl_fator_moderador_w,0)) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_fator_moderador_w::text, '') = '')) or (to_char(coalesce(vl_fator_moderador_w,0)) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

/*Inicio*/
	elsif (position('@NM_BENEFICIARIO' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND nm_beneficiario_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(nm_beneficiario_w::text, '') = '')) or (nm_beneficiario_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DT_INCLUSAO' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND dt_inclusao_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_inclusao_w::text, '') = '')) or (dt_inclusao_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DS_TP_CONTRATACAO' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_tp_contratacao_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_tp_contratacao_w::text, '') = '')) or (ds_tp_contratacao_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;	

		elsif (position('@DS_SCA' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_sca_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_sca_w::text, '') = '')) or (ds_sca_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;	

		elsif (position('@VL_SCA' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND vl_sca_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_sca_w::text, '') = '')) or (vl_sca_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;
		
		elsif (position('@VL_OUTROS' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND vl_outros_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_outros_w::text, '') = '')) or (vl_outros_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;		
			

		elsif (position('@DS_TP_CONTRATACAO_PJ' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_tp_contratacao_pj_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_tp_contratacao_pj_w::text, '') = '')) or (ds_tp_contratacao_pj_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@VL_MENSALIDADES_PJ' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND vl_mensalidades_pj_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_mensalidades_pj_w::text, '') = '')) or (vl_mensalidades_pj_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@VL_COPARTICIPACAO_PJ' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND vl_coparticipacao_pj_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_coparticipacao_pj_w::text, '') = '')) or (vl_coparticipacao_pj_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;	

		elsif (position('@DS_PRODUTO_ANS' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_produto_ans_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_produto_ans_w::text, '') = '')) or (ds_produto_ans_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@NM_BENEF_COPARTICIP' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND nm_benef_coparticip_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(nm_benef_coparticip_w::text, '') = '')) or (nm_benef_coparticip_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;	

		elsif (position('@DT_ATENDIMENTO' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND dt_atendimento_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_atendimento_w::text, '') = '')) or (dt_atendimento_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DS_PRESTADOR_EXECUTANTE' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_prestador_executante_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_prestador_executante_w::text, '') = '')) or (ds_prestador_executante_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;	

		elsif (position('@DS_TIPO_TRATAMENTO' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND ds_tipo_tratamento_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_tipo_tratamento_w::text, '') = '')) or (ds_tipo_tratamento_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;	

		elsif (position('@VL_COPARTICIPACAO' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND vl_coparticipacao_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_coparticipacao_w::text, '') = '')) or (vl_coparticipacao_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;			
/*fim 950304*/
						
		elsif (position('@DT_VENCIMENTO' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(dt_vencimento_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_vencimento_w::text, '') = '')) or (to_char(dt_vencimento_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;
			
		elsif (position('@VL_SALDO_TITULO' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(coalesce(vl_saldo_titulo_w,0)) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_saldo_titulo_w::text, '') = '')) or (to_char(coalesce(vl_saldo_titulo_w,0)) = ds_valor_regra_w)))) then


			ds_instrucao_w	:= null;

		elsif (position('@NR_NOTA_FISCAL' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND nr_nota_fiscal_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(nr_nota_fiscal_w::text, '') = '')) or (nr_nota_fiscal_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@NR_NFE_IMP' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND nr_nfe_imp_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(nr_nfe_imp_w::text, '') = '')) or (nr_nfe_imp_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@VL_DESC_PREVISTO' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(coalesce(vl_desc_previsto_w,0)) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(vl_desc_previsto_w::text, '') = '')) or (to_char(coalesce(vl_desc_previsto_w,0)) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DT_PRORROGACAO' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(dt_pagamento_previsto_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_pagamento_previsto_w::text, '') = '')) or (to_char(dt_pagamento_previsto_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DS_COPARTICIPACAO' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(ds_coparticipacao_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_coparticipacao_w::text, '') = '')) or (to_char(ds_coparticipacao_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DS_MEN_VALOR_PRODUTO' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(ds_men_valor_produto_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_men_valor_produto_w::text, '') = '')) or (to_char(ds_men_valor_produto_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DS_DT_ANIV_PLANO' in ds_regra_w) > 0) and
			(((ie_condicao_w = 'I') and (to_char(ds_dt_aniv_plano_w) <> ds_valor_regra_w)) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(ds_dt_aniv_plano_w::text, '') = '')) or (to_char(ds_dt_aniv_plano_w) = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@DT_CONTRATO_W' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND dt_contrato_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_contrato_w::text, '') = '')) or (dt_contrato_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;	

		elsif (position('@DT_CONTRATO_FIM_W' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND dt_contrato_fim_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(dt_contrato_fim_w::text, '') = '')) or (dt_contrato_fim_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;

		elsif (position('@NR_CARTAO_NAC_SUS' in ds_regra_w) > 0) and
			((ie_condicao_w = 'I' AND nr_cartao_nac_sus_w <> ds_valor_regra_w) or
			((ie_condicao_w = 'D') and
			(((coalesce(ds_valor_regra_w::text, '') = '') and (coalesce(nr_cartao_nac_sus_w::text, '') = '')) or (nr_cartao_nac_sus_w = ds_valor_regra_w)))) then

			ds_instrucao_w	:= null;			
		
		end if;

	end if;

	if (ds_instrucao_w IS NOT NULL AND ds_instrucao_w::text <> '') then

		ds_instrucao_w	:= replace(ds_instrucao_w,'@VL_TITULO',campo_mascara_virgula(vl_titulo_w));
		ds_instrucao_w  := replace(ds_instrucao_w,'@TX_MULTA',campo_mascara_virgula(tx_multa_w));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@TP_TX_JUROS',ds_tipo_taxa_juros_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@TP_TX_MULTA',ds_tipo_taxa_multa_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@TX_JUROS',campo_mascara_virgula(tx_juros_w));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_EMISSAO',to_char(dt_emissao_w,'dd/mm/yyyy'));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@MES_ANO_EMISSAO',substr(obter_data_extenso(dt_emissao_w,7),1,255));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@NR_TELEFONE',nr_telefone_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@NR_TITULO',nr_titulo_p);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@CD_CGC_OUTORGANTE',cd_cgc_outorgante_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@CD_CGC',cd_cgc_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@NM_PESSOA',nm_pessoa_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_MENSALIDADE_PLS',to_char(dt_mensalidade_w,'mm/yyyy'));
		if (vl_reajuste_pls_etaria_w > 0) then
			ds_instrucao_w	:= replace(ds_instrucao_w,'@VL_MENSALIDADE_PLS',campo_mascara_virgula(vl_mensalidade_pls_w + vl_reajuste_pls_etaria_w));
		else
			ds_instrucao_w	:= replace(ds_instrucao_w,'@VL_MENSALIDADE_PLS',campo_mascara_virgula(vl_mensalidade_pls_w));
		end if;
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DS_PLANO_PLS',ds_plano_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@CD_SCPA_PLS',cd_scpa_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@NR_PROTOCOLO_ANS_PLS',nr_protocolo_ans_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@CD_USUARIO_PLANO_PLS',cd_usuario_plano_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@CD_JURIDICO_LIMINAR_PLS',cd_juridico_liminar_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@TX_REAJUSTE_PLS',campo_mascara_virgula(tx_reajuste_pls_w));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DS_OFICIO_ANS_PLS',ds_oficio_ans_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@VL_REAJUSTE_PLS',campo_mascara_virgula(vl_reajuste_pls_w));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_REAJUSTE_PLS',to_char(dt_reajuste_pls_w,'mm/yyyy'));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@VL_ETARIA_PLS',campo_mascara_virgula(vl_reajuste_pls_etaria_w));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_REAJUSTE_COBR',to_char(dt_reajuste_cobr_w,'mm/yyyy'));		
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_REAJUSTE_MUD',to_char(dt_reajuste_mud_w,'mm/yyyy'));		
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_REAJUSTE_VAR',to_char(dt_reajuste_var_w,'mm/yyyy'));		
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_REAJUSTE_SCA',to_char(dt_reajuste_sca_w,'mm/yyyy'));		
		ds_instrucao_w	:= replace(ds_instrucao_w,'@NR_SEQ_MENSALIDADE',nr_seq_mensalidade_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@VL_ITEM_SCA',campo_mascara_virgula(vl_item_sca_w));
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DS_OBS_SCA',ds_obs_sca_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DS_OBS_PORTABILIDADE',ds_portabilidade_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DS_MENSAGEM_REAJUSTE',substr(ds_msg_reajuste_w,1,200)),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DS_MENSAGEM_2REAJUSTE',substr(ds_msg_reajuste_w,201,254)),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DS_MENSAGEM_QUITACAO',ds_msg_quitacao_w),1,255);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@NM_PRESTADOR',nm_prestador_w);		
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DS_FATOR_MODERADOR',ds_fator_moderador_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_FATOR_MODERADOR',to_char(dt_fator_moderador_w,'mm/yyyy'));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@QT_FATOR_MODERADOR',qt_fator_moderador_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@VL_FATOR_MODERADOR',campo_mascara_virgula(vl_fator_moderador_w));
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@NM_BENEFICIARIO',nm_beneficiario_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DT_INCLUSAO',dt_inclusao_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DS_TP_CONTRATACAO',ds_tp_contratacao_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DS_SCA',ds_sca_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@VL_SCA',vl_sca_w),1,255);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@VL_OUTROS',vl_outros_w);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DS_TP_CONTRATACAO_PJ',ds_tp_contratacao_pj_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@VL_MENSALIDADES_PJ',vl_mensalidades_pj_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@VL_COPARTICIPACAO_PJ',vl_coparticipacao_pj_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DS_PRODUTO_ANS',ds_produto_ans_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@NM_BENEF_COPARTICIP',nm_benef_coparticip_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DT_ATENDIMENTO',dt_atendimento_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DS_PRESTADOR_EXECUTANTE',ds_prestador_executante_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@DS_TIPO_TRATAMENTO',ds_tipo_tratamento_w),1,255);
		ds_instrucao_w	:= substr(replace(ds_instrucao_w,'@VL_COPARTICIPACAO',vl_coparticipacao_w),1,255);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_VENCIMENTO',to_char(dt_vencimento_w,'dd/mm/yyyy'));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@VL_SALDO_TITULO',campo_mascara_virgula(vl_saldo_titulo_w));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@NR_NOTA_FISCAL',nr_nota_fiscal_w);	
		ds_instrucao_w	:= replace(ds_instrucao_w,'@NR_NFE_IMP',nr_nfe_imp_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@VL_DESC_PREVISTO',campo_mascara_virgula(vl_desc_previsto_w));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_PRORROGACAO',to_char(dt_pagamento_previsto_w,'dd/mm/yyyy'));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DS_COPARTICIPACAO', ds_coparticipacao_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DS_MEN_VALOR_PRODUTO',ds_men_valor_produto_w);
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DS_DT_ANIV_PLANO',ds_dt_aniv_plano_w );
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_INI_CONTRATO',to_char(dt_contrato_w,'dd/mm/yyyy'));
		ds_instrucao_w	:= replace(ds_instrucao_w,'@DT_FIM_CONTRATO',to_char(dt_contrato_fim_w,'dd/mm/yyyy'));		
		ds_instrucao_w	:= replace(ds_instrucao_w,'@NR_CARTAO_NAC_SUS',nr_cartao_nac_sus_w);

	end if;

	ds_retorno_w	:= ds_instrucao_w;
end if;
return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_instrucao_bol_estab_fin ( nr_titulo_p bigint, cd_banco_p bigint, nr_linha_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

