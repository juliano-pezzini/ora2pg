-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_vl_acumulado_compra ( nr_seq_proj_rec_p bigint, nr_solic_compra_p bigint, nr_ordem_compra_p bigint, ie_chamado_p text) RETURNS bigint AS $body$
DECLARE

 
vl_acumulado_w		double precision := 0;
vl_total_solic_acum_w	double precision;
vl_total_solic_w	double precision;
vl_total_ordem_acum_w	double precision;
vl_total_ordem_w	double precision;
vl_total_solic_ordem_w	double precision;
/* 
ie_chamado_p - [S ] - consistir_solic_compra 
	    [O] - consiste_ordem_compra 
*/
	 

BEGIN 
 
if (ie_chamado_p = 'S') then 
	 
	select	coalesce(sum(b.qt_material * b.vl_unit_previsto),0) 
	into STRICT	vl_total_solic_acum_w 
	from	solic_compra a, 
		solic_compra_item b 
	where	a.nr_solic_compra = b.nr_solic_compra 
	and	b.nr_seq_proj_rec = nr_seq_proj_rec_p 
	and	a.nr_solic_compra <> nr_solic_compra_p 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
	and	b.vl_unit_previsto > 0 
	and	not exists (	SELECT	 1 
				from	ordem_compra x, 
					ordem_compra_item y 
				where	x.nr_ordem_compra = y.nr_ordem_compra 
				and	y.nr_solic_compra = a.nr_solic_compra 
				and	y.nr_item_solic_compra	= b.nr_item_solic_compra 
				and	substr(obter_se_item_oc_cancelado(x.nr_ordem_compra,y.nr_item_solic_compra),1,1) = 'N' 
				and	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> ''));
				 
	select	coalesce(sum(b.qt_material * b.vl_unit_previsto),0) 
	into STRICT	vl_total_solic_w 
	from	solic_compra a, 
		solic_compra_item b 
	where	a.nr_solic_compra = b.nr_solic_compra 
	and	b.nr_seq_proj_rec = nr_seq_proj_rec_p 
	and	a.nr_solic_compra = nr_solic_compra_p 
	and	b.vl_unit_previsto > 0;
	 
	select	coalesce(sum(obter_valor_ordem_proj_rec(a.nr_ordem_compra,nr_seq_proj_rec_p)),0) 
	into STRICT	vl_total_ordem_w 
	from	ordem_compra a 
	where	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and exists (	SELECT	1 
			from	ordem_compra_item b 
			where	a.nr_ordem_compra = b.nr_ordem_compra 
			and	b.nr_seq_proj_rec = nr_seq_proj_rec_p 
			and	substr(obter_se_item_oc_cancelado(b.nr_ordem_compra,b.nr_item_solic_compra),1,1) = 'N');		
 
	vl_acumulado_w := vl_total_solic_acum_w + vl_total_solic_w + vl_total_ordem_w;
	 
end if;	
								 
if (ie_chamado_p = 'O') then 
		 
	begin 
		 
	select	coalesce(sum(b.qt_material * b.vl_unit_previsto),0) 
	into STRICT	vl_total_solic_ordem_w 
	from	solic_compra a, 
		solic_compra_item b 
	where	a.nr_solic_compra = b.nr_solic_compra 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
	and	exists (SELECT 1 
			 from	ordem_compra_item x 
			 where 	x.nr_item_solic_compra = b.nr_item_solic_compra 
			 and	x.nr_solic_compra = b.nr_solic_compra 
			and	x.nr_ordem_compra = nr_ordem_compra_p 
			and	x.nr_seq_proj_rec = nr_seq_proj_rec_p);
	 
	exception 
	when others then 
		vl_total_solic_ordem_w := 0;
	end;
										 
	select	coalesce(sum(obter_valor_ordem_proj_rec(a.nr_ordem_compra,nr_seq_proj_rec_p)),0) 
	into STRICT	vl_total_ordem_acum_w 
	from	ordem_compra a 
	where	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and	a.nr_ordem_compra <> nr_ordem_compra_p 
	and exists (	SELECT	1 
			from	ordem_compra_item b 
			where	a.nr_ordem_compra = b.nr_ordem_compra 
			and	b.nr_seq_proj_rec = nr_seq_proj_rec_p);
 
			 
	select	coalesce(sum(obter_valor_ordem_proj_rec(a.nr_ordem_compra,nr_seq_proj_rec_p)),0) 
	into STRICT	vl_total_ordem_w 
	from	ordem_compra a 
	where	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
	and	a.nr_ordem_compra = nr_ordem_compra_p 
	and exists (	SELECT	1 
			from	ordem_compra_item b 
			where	a.nr_ordem_compra = b.nr_ordem_compra 
			and	substr(obter_se_item_oc_cancelado(b.nr_ordem_compra,b.nr_item_solic_compra),1,1) = 'N'				 
			and	b.nr_seq_proj_rec = nr_seq_proj_rec_p);
			 
	select	coalesce(sum(b.qt_material * b.vl_unit_previsto),0) 
	into STRICT	vl_total_solic_acum_w 
	from	solic_compra a, 
		solic_compra_item b 
	where	a.nr_solic_compra = b.nr_solic_compra 
	and	b.nr_seq_proj_rec = nr_seq_proj_rec_p 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
	and	b.vl_unit_previsto > 0 
	and	not exists (	SELECT	 1 
				from	ordem_compra x, 
					ordem_compra_item y 
				where	x.nr_ordem_compra = y.nr_ordem_compra 
				and	y.nr_solic_compra = a.nr_solic_compra 
				and	y.nr_item_solic_compra	= b.nr_item_solic_compra 
				and	substr(obter_se_item_oc_cancelado(y.nr_ordem_compra,y.nr_item_solic_compra),1,1) = 'N'					 
				and	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> ''));				
				 
	vl_acumulado_w := vl_total_ordem_acum_w + vl_total_ordem_w + vl_total_solic_acum_w - vl_total_solic_ordem_w;					
	 
end if;	
		 
return	vl_acumulado_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_vl_acumulado_compra ( nr_seq_proj_rec_p bigint, nr_solic_compra_p bigint, nr_ordem_compra_p bigint, ie_chamado_p text) FROM PUBLIC;

