-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tx_obter_pontuacao_meld ( vl_result_creat_p bigint, vl_result_rni_p bigint, vl_result_bil_p bigint, ie_realiza_dialise_p text, vl_result_albumina_p bigint DEFAULT NULL, ie_peld_meld_p text DEFAULT 'M', cd_pessoa_fisica_p text DEFAULT '') RETURNS bigint AS $body$
DECLARE


    vl_result_creat_w     double precision;
    vl_result_rni_w       double precision;
    vl_result_bil_w       double precision;
    ds_resultado_w        double precision;
    vl_result_albumina_w  double precision;
    ie_sexo_w             varchar(1);
    dt_meses_w            double precision;
    qt_altura_w           double precision;
    qt_peso_w             double precision;
    qt_deficit_w          double precision;
    peld_w                double precision := NULL;
    sql_w                 varchar(200);

BEGIN
    vl_result_creat_w := vl_result_creat_p;
    vl_result_rni_w := vl_result_rni_p;
    vl_result_bil_w := vl_result_bil_p;
    vl_result_albumina_w := vl_result_albumina_p;
    BEGIN
        sql_w := 'begin OBTER_RESULT_PONT_MELD_MD  (:1, :2, :3, :4, :5); end;';
        EXECUTE sql_w
            USING IN ie_realiza_dialise_p, IN OUT vl_result_creat_w, IN OUT vl_result_rni_w, IN OUT vl_result_bil_w, IN OUT vl_result_albumina_w;

    EXCEPTION
        WHEN OTHERS THEN
            vl_result_creat_w := NULL;
            vl_result_rni_w := NULL;
            vl_result_bil_w := NULL;
            vl_result_albumina_w := NULL;
    END;



    IF ( ie_peld_meld_p <> 'M' ) THEN
        SELECT
            obter_dados_pf(cd_pessoa_fisica, 'SE')                       ie_sexo,
            obter_idade(dt_nascimento, clock_timestamp(), 'M')                     dt_meses,
            obter_ultimo_sinal_vital_pf(cd_pessoa_fisica, 'ALTURA')      qt_altura,
            obter_ultimo_sinal_vital_pf(cd_pessoa_fisica, 'PESO')        qt_peso
        INTO STRICT
            ie_sexo_w,
            dt_meses_w,
            qt_altura_w,
            qt_peso_w
        FROM
            pessoa_fisica
        WHERE
            cd_pessoa_fisica = cd_pessoa_fisica_p;

        IF ( coalesce(qt_altura_w::text, '') = '' OR coalesce(qt_peso_w::text, '') = '' ) THEN
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1060387);
            RETURN 0;
        END IF;

        IF ( coalesce(ie_sexo_w::text, '') = '' ) THEN
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1060441);
            RETURN 0;
        END IF;

        SELECT
            obter_deficit_crescimento(dt_meses_w, qt_altura_w, qt_peso_w, ie_sexo_w)
        INTO STRICT peld_w
;

    END IF;

    BEGIN
        sql_w := 'CALL obter_des_result_pont_meld_md(:1, :2, :3, :4, :5, :6) INTO :ds_resultado_w';
        EXECUTE sql_w
            USING IN ie_peld_meld_p, IN vl_result_creat_w, IN vl_result_bil_w, IN vl_result_rni_w, IN peld_w, IN vl_result_albumina_w,
            OUT ds_resultado_w;

    EXCEPTION
        WHEN OTHERS THEN
            ds_resultado_w := NULL;
    END;


    RETURN ds_resultado_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tx_obter_pontuacao_meld ( vl_result_creat_p bigint, vl_result_rni_p bigint, vl_result_bil_p bigint, ie_realiza_dialise_p text, vl_result_albumina_p bigint DEFAULT NULL, ie_peld_meld_p text DEFAULT 'M', cd_pessoa_fisica_p text DEFAULT '') FROM PUBLIC;

