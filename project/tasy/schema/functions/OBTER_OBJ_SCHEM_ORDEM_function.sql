-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_obj_schem_ordem ( nr_seq_obj_sup_p bigint, nr_seq_obj_schematic_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_seq_apres_p objeto_schematic.nr_seq_apres%TYPE DEFAULT NULL) RETURNS bigint AS $body$
DECLARE


nr_seq_regra_w		bigint;
nr_ordem_w		bigint;
qt_regra_w		bigint;


BEGIN

nr_seq_regra_w := NULL;

BEGIN
SELECT	1
INTO STRICT	qt_regra_w
FROM	obj_schem_order
WHERE	nr_seq_obj_schematic = nr_seq_obj_sup_p  LIMIT 1;
EXCEPTION
WHEN OTHERS THEN
	qt_regra_w	:= 0;
END;

IF (qt_regra_w >= 1) THEN
	BEGIN
	SELECT	a.nr_sequencia
	INTO STRICT	nr_seq_regra_w
	FROM	obj_schem_order a
	WHERE	a.nr_seq_obj_schematic = nr_seq_obj_sup_p
	AND	EXISTS (SELECT	1
		FROM	obj_schem_order_usuario x
		WHERE	x.nr_seq_regra	= a.nr_sequencia
		AND	x.nm_usuario_regra = nm_usuario_p)
	AND	EXISTS (SELECT	1
		FROM	obj_schem_order_item y
		WHERE	y.nr_seq_regra = a.nr_sequencia
		AND	y.nr_seq_obj_schematic = nr_seq_obj_schematic_p)  LIMIT 1;
	EXCEPTION
	WHEN OTHERS THEN
		 NULL;
	END;

	IF (coalesce(nr_seq_regra_w::text, '') = '') THEN
	    BEGIN
		SELECT	a.nr_sequencia
		INTO STRICT	nr_seq_regra_w
		FROM	obj_schem_order a
		WHERE	a.nr_seq_obj_schematic = nr_seq_obj_sup_p
		AND	EXISTS (SELECT	1
			FROM	obj_schem_order_perfil x
			WHERE	x.nr_seq_regra	= a.nr_sequencia
			AND	x.cd_perfil = cd_perfil_p)
		AND	EXISTS (SELECT	1
			FROM	obj_schem_order_item y
			WHERE	y.nr_seq_regra = a.nr_sequencia
			AND	y.nr_seq_obj_schematic = nr_seq_obj_schematic_p)  LIMIT 1;
		EXCEPTION
		WHEN OTHERS THEN
			 NULL;
		END;
	END IF;

	IF (coalesce(nr_seq_regra_w::text, '') = '') THEN
	    BEGIN
		SELECT	a.nr_sequencia
		INTO STRICT	nr_seq_regra_w
		FROM	obj_schem_order a
		WHERE	a.nr_seq_obj_schematic = nr_seq_obj_sup_p
		AND	EXISTS (SELECT	1
			FROM	obj_schem_order_estab x
			WHERE	x.nr_seq_regra	= a.nr_sequencia
			AND	x.cd_estabelecimento = cd_estabelecimento_p)
		AND	EXISTS (SELECT	1
			FROM	obj_schem_order_item y
			WHERE	y.nr_seq_regra = a.nr_sequencia
			AND	y.nr_seq_obj_schematic = nr_seq_obj_schematic_p)  LIMIT 1;
		EXCEPTION
		WHEN OTHERS THEN
			NULL;
		END;
	END IF;

	IF (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') THEN

		SELECT	MAX(nr_ordem)
		INTO STRICT	nr_ordem_w
		FROM	OBJ_SCHEM_ORDER_ITEM
		WHERE	nr_seq_regra = nr_seq_regra_w
		AND	nr_seq_obj_schematic = nr_seq_obj_schematic_p;

	END IF;
END IF;

IF (coalesce(nr_ordem_w::text, '') = '') THEN
    IF (nr_seq_apres_p IS NOT NULL AND nr_seq_apres_p::text <> '') THEN
        nr_ordem_w := nr_seq_apres_p;
    ELSE
        SELECT	MAX(NR_SEQ_APRES)
        INTO STRICT	nr_ordem_w
        FROM	objeto_schematic
        WHERE	nr_sequencia	= nr_seq_obj_schematic_p;
    END IF;
END IF;

RETURN nr_ordem_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_obj_schem_ordem ( nr_seq_obj_sup_p bigint, nr_seq_obj_schematic_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_seq_apres_p objeto_schematic.nr_seq_apres%TYPE DEFAULT NULL) FROM PUBLIC;

