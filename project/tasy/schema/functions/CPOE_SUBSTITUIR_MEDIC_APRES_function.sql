-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_substituir_medic_apres ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type , cd_convenio_p convenio.cd_convenio%type , cd_material_p material.cd_material%type ) RETURNS integer AS $body$
DECLARE


nr_sequencia_w			cpoe_subs_apresentacao.nr_sequencia%type;
ie_regra_apresentacao_w		cpoe_subs_apresentacao.ie_regra_apresentacao%type;
cd_material_especifico_w	cpoe_subs_apresentacao.cd_material_especifico%type;
nr_seq_ficha_tecnica_w		material.nr_seq_ficha_tecnica%type;
cd_medicamento_w		material.cd_material%type;
nr_seq_fabric_w			material.nr_seq_fabric%type;
ie_tipo_material_w		material.ie_tipo_material%type;
ie_fabricante_w			varchar(1);

c00 CURSOR FOR
SELECT	coalesce(max(nr_sequencia), 0)
from	cpoe_subs_apresentacao
where	coalesce(cd_material,cd_material_p) = cd_material_p
and 	coalesce(cd_convenio, cd_convenio_p) = cd_convenio_p
order by cd_convenio asc;

c01 CURSOR FOR
SELECT	distinct
	b.nr_seq_fabric
from	material_estab c,
	material b,
	medic_ficha_tecnica a
where	b.nr_seq_ficha_tecnica = a.nr_sequencia
and	c.cd_material = b.cd_material
and	c.cd_estabelecimento = cd_estabelecimento_p
and	a.nr_sequencia = nr_seq_ficha_tecnica_w
and	(b.nr_seq_fabric IS NOT NULL AND b.nr_seq_fabric::text <> '')
and	b.cd_material <> cd_material_p
and	b.ie_situacao = 'A'
and	c.ie_prescricao = 'S'
and coalesce(a.ie_situacao, 'A') = 'A'
order by b.nr_seq_fabric;


BEGIN

if (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '' AND cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

	open c00;
	loop
	fetch c00 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c00 */

		if (nr_sequencia_w > 0) then
		
			select 	max(ie_regra_apresentacao),
				coalesce(max(cd_material_especifico),0)
			into STRICT 	ie_regra_apresentacao_w,
				cd_material_especifico_w
			from 	cpoe_subs_apresentacao
			where	nr_sequencia = nr_sequencia_w;
			
			select	coalesce(max(nr_seq_ficha_tecnica),0),
				max(ie_tipo_material)
			into STRICT 	nr_seq_ficha_tecnica_w,
				ie_tipo_material_w
			from 	material
			where 	cd_material = cd_material_p;

			if (ie_regra_apresentacao_w = 'ME' and cd_material_especifico_w > 0) then
			
				return cd_material_especifico_w;

			elsif (ie_regra_apresentacao_w in ('MF', 'MG')) then

				if (ie_regra_apresentacao_w = 'MF') then
					select 	coalesce(max(cd_material),0)
					into STRICT 	cd_medicamento_w
					from 	material
					where 	ie_tipo_material = 8
					and 	nr_seq_ficha_tecnica = nr_seq_ficha_tecnica_w
					and 	cd_material <> cd_material_p;
					
					if (cd_medicamento_w > 0) then
						return cd_medicamento_w;
					end if;
				else
					select 	coalesce(max(cd_material),0)
					into STRICT 	cd_medicamento_w
					from 	material
					where 	ie_tipo_material = 3
					and 	nr_seq_ficha_tecnica = nr_seq_ficha_tecnica_w
					and 	cd_material <> cd_material_p;
					
					if (cd_medicamento_w > 0) then
						return cd_medicamento_w;
					end if;
				end if;
			else
				IF (nr_seq_ficha_tecnica_w > 0) and (ie_tipo_material_w = '6') and (ie_regra_apresentacao_w = 'MA') then

					select	max(ie_fabricante_dist)
					into STRICT	ie_fabricante_w
					from	material
					where	cd_material = cd_material_p;

					select	coalesce(coalesce(ie_fabricante_w, max(ie_fabricante)),'N')
					into STRICT	ie_fabricante_w
					from	material_sem_apresentacao
					where	cd_material = cd_material_p;

					if (ie_fabricante_w = 'N') THEN
						
						open c01;
						loop
						fetch c01 into
							nr_seq_fabric_w;
						EXIT WHEN NOT FOUND; /* apply on c01 */
							nr_seq_fabric_w := nr_seq_fabric_w;
						end loop;
						close c01;
						
						select	coalesce(max(b.cd_material),0)
						into STRICT 	cd_medicamento_w
						from	material_estab c,
							material b,
							medic_ficha_tecnica a
						where	b.nr_seq_ficha_tecnica = a.nr_sequencia
						and	c.cd_material = b.cd_material
						and	c.cd_estabelecimento = cd_estabelecimento_p
						and	a.nr_sequencia = nr_seq_ficha_tecnica_w
						and	b.cd_material <> cd_material_p
						and	b.nr_seq_fabric = nr_seq_fabric_w
						and	b.ie_situacao = 'A'
						and	c.ie_prescricao = 'S'
						and 	b.ie_tipo_material <> '6'
						and not exists (SELECT 1
								from   cpoe_subs_apresentacao_exc a
								where  a.cd_material = b.cd_material
								and    a.nr_seq_regra = nr_sequencia_w)
            and coalesce(a.ie_situacao, 'A') = 'A';
					else

						select	coalesce(max(b.cd_material),0)
						into STRICT 	cd_medicamento_w
						from	material_estab c,
							material b,
							medic_ficha_tecnica a
						where	b.nr_seq_ficha_tecnica = a.nr_sequencia
						and	c.cd_material = b.cd_material
						and	c.cd_estabelecimento = cd_estabelecimento_p
						and	a.nr_sequencia = nr_seq_ficha_tecnica_w
						and	b.cd_material <> cd_material_p
						and	b.ie_situacao = 'A'
						and	c.ie_prescricao = 'S'
						and 	b.ie_tipo_material <> '6'
						and not exists (SELECT 1
								from   cpoe_subs_apresentacao_exc a
								where  a.cd_material = b.cd_material
								and    a.nr_seq_regra = nr_sequencia_w)
            and coalesce(a.ie_situacao, 'A') = 'A';
					end if;
					
					if (cd_medicamento_w > 0) then
						return cd_medicamento_w;
					end if;
				end if;
			end if;
		end if;
	end loop;
	close c00;
end if;

return 0;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_substituir_medic_apres ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type , cd_convenio_p convenio.cd_convenio%type , cd_material_p material.cd_material%type ) FROM PUBLIC;

