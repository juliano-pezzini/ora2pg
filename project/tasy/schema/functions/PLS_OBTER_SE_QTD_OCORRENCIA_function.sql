-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_se_qtd_ocorrencia ( nr_sequencia_p bigint, ie_tipo_item_p bigint, qt_liberada_p bigint, ie_tipo_qtde_p text, qt_tipo_quantidade_p bigint, ie_tipo_pessoa_qtde_p text, ie_regra_tipo_quant_p text, ie_somar_estrutura_p text, nr_seq_estrutura_p bigint, nr_seq_ocorrencia_p bigint, ie_qt_lib_posterior_p text, ie_somente_solicitacao_p text, ds_parametro_1_p text, ie_valida_cod_prestador_p text, cd_estabelecimento_p text) RETURNS varchar AS $body$
DECLARE


/*PARA A CONTA UTILIZAR A PLS_OBTER_SE_QTD_OC_CONTA*/

/* IE_TIPO_ITEM_P
	1 - Procedimento da Autorização
	2 - Material da Autorização
	3 - Procedimento da Conta
	4 - Material da Conta
	5 - Procedimento da Requisição
	6 - Material da Requisição
	7 -  Procedimento da importação
	8 - Material da Importação
*/
/* IE_TIPO_QTDE_P - Domínio 3540
	D - Dia
	M - Mês
	A - Ano
	G - Guia
	C - Conta
*/
ie_retorno_w			varchar(1)	:= 'S';
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_material_w		bigint;
nr_seq_segurado_w		bigint;
nr_seq_prestador_w		bigint;
nr_seq_guia_plano_w		bigint;
qt_solicitada_w			double precision	:= 0;
qt_liberacao_w			double precision;
dt_liberacao_w			timestamp;
dt_liberacao_ww			timestamp;
cd_guia_w			varchar(20);
cd_medico_executor_w		bigint;
nr_seq_conta_w			bigint;
cd_medico_solic_w		bigint;
nr_seq_proc_ref_w		bigint;
nr_seq_req_proc_w		bigint;
cd_procedimento_ww		bigint;
ie_origem_proced_ww		bigint;
qt_procedimento_w		bigint;
nr_seq_requisicao_w		bigint;
qt_solicitacao_w		bigint := 0;
cd_prestador_w			varchar(30);
ie_cursor_valida_restricao_w	varchar(1) := 'N';
nr_seq_segurado_cursor_w	bigint;
nr_seq_prestador_cursor_w	bigint;

C05 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_procedimento,
		b.nr_seq_segurado,
		b.nr_seq_prestador
	from	pls_requisicao				b,
		pls_requisicao_proc			a
	where	a.nr_seq_requisicao			= b.nr_sequencia
	and	((trunc(b.dt_requisicao) 		between dt_liberacao_ww and trunc(dt_liberacao_w)
	and	coalesce(a.nr_seq_motivo_exc::text, '') = ''
	and	b.ie_estagio				= 2
	and	ie_tipo_qtde_p <> 'G')
	or (b.nr_sequencia 	= nr_seq_requisicao_w and ie_tipo_qtde_p = 'G'))
	and	coalesce(a.ie_cobranca_previa_servico,'N')	<> 'S';

C06 CURSOR FOR
	SELECT 	sum(a.qt_material),
		count(1)
	into STRICT	qt_liberacao_w,
		qt_solicitacao_w
	from	pls_requisicao				b,
		pls_requisicao_mat			a
	where	a.nr_seq_requisicao	= b.nr_sequencia
	and	((ie_tipo_pessoa_qtde_p  = 'B' and b.nr_seq_segurado	= nr_seq_segurado_w )
	or (ie_tipo_pessoa_qtde_p 	= 'P' and b.nr_seq_prestador	= nr_seq_prestador_w)
	or (ie_tipo_pessoa_qtde_p  = 'A' and b.nr_seq_segurado	= nr_seq_segurado_w  and b.nr_seq_prestador	= nr_seq_prestador_w ))
	and	((trunc(b.dt_requisicao) between dt_liberacao_ww and trunc(dt_liberacao_w)
	and	coalesce(a.nr_seq_motivo_exc::text, '') = ''
	and	b.ie_estagio		= 2
	and	ie_tipo_qtde_p 		<> 'G')
	or (b.nr_sequencia 	= nr_seq_requisicao_w and ie_tipo_qtde_p = 'G'))
	and	a.nr_seq_material	= nr_seq_material_w
	and	coalesce(a.ie_cobranca_previa_servico,'N')	<> 'S';


BEGIN

if (ie_tipo_item_p	= 1) then
	select	a.cd_procedimento,
		a.ie_origem_proced,
		a.dt_liberacao,
		a.qt_solicitada,
		b.nr_seq_segurado,
		b.nr_seq_prestador,
		b.nr_sequencia,
		b.cd_medico_solicitante
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w,
		dt_liberacao_w,
		qt_solicitada_w,
		nr_seq_segurado_w,
		nr_seq_prestador_w,
		nr_seq_guia_plano_w,
		cd_medico_solic_w
	from	pls_guia_plano		b,
		pls_guia_plano_proc	a
	where	a.nr_seq_guia		= b.nr_sequencia
	and	a.nr_sequencia		= nr_sequencia_p;
elsif (ie_tipo_item_p	= 2) then
	select	a.nr_seq_material,
		a.dt_liberacao,
		a.qt_solicitada,
		b.nr_seq_segurado,
		b.nr_seq_prestador,
		b.nr_sequencia,
		b.cd_medico_solicitante
	into STRICT	nr_seq_material_w,
		dt_liberacao_w,
		qt_solicitada_w,
		nr_seq_segurado_w,
		nr_seq_prestador_w,
		nr_seq_guia_plano_w,
		cd_medico_solic_w
	from	pls_guia_plano		b,
		pls_guia_plano_mat	a
	where	a.nr_seq_guia		= b.nr_sequencia
	and	a.nr_sequencia		= nr_sequencia_p;
elsif (ie_tipo_item_p	= 3) then
	select	a.cd_procedimento,
		a.ie_origem_proced,
		coalesce(a.dt_procedimento,b.dt_emissao),
		b.nr_seq_segurado,
		b.nr_seq_prestador_exec,
		coalesce(b.cd_guia_referencia, b.cd_guia),
		b.cd_medico_executor,
		b.nr_sequencia,
		a.nr_seq_proc_ref
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w,
		dt_liberacao_w,
		nr_seq_segurado_w,
		nr_seq_prestador_w,
		cd_guia_w,
		cd_medico_executor_w,
		nr_seq_conta_w,
		nr_seq_proc_ref_w
	from	pls_conta	b,
		pls_conta_proc	a
	where	a.nr_seq_conta		= b.nr_sequencia
	and	a.nr_sequencia		= nr_sequencia_p;
elsif (ie_tipo_item_p	= 4) then
	select	a.nr_seq_material,
		coalesce(a.dt_atendimento,b.dt_emissao),
		b.nr_seq_segurado,
		b.nr_seq_prestador_exec,
		b.cd_medico_executor,
		b.nr_sequencia,
		coalesce(b.cd_guia_referencia, b.cd_guia)
	into STRICT	nr_seq_material_w,
		dt_liberacao_w,
		nr_seq_segurado_w,
		nr_seq_prestador_w,
		cd_medico_executor_w,
		nr_seq_conta_w,
		cd_guia_w
	from	pls_conta		b,
		pls_conta_mat	a
	where	a.nr_seq_conta		= b.nr_sequencia
	and	a.nr_sequencia		= nr_sequencia_p;
elsif (ie_tipo_item_p	= 5) then
	select	a.cd_procedimento,
		a.ie_origem_proced,
		b.dt_requisicao,
		a.qt_solicitado,
		b.nr_seq_segurado,
		b.nr_seq_prestador,
		b.nr_sequencia
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w,
		dt_liberacao_w,
		qt_solicitada_w,
		nr_seq_segurado_w,
		nr_seq_prestador_w,
		nr_seq_requisicao_w
	from	pls_requisicao		b,
		pls_requisicao_proc	a
	where	a.nr_seq_requisicao	= b.nr_sequencia
	and	a.nr_sequencia		= nr_sequencia_p;
elsif (ie_tipo_item_p	= 6) then
	select	a.nr_seq_material,
		b.dt_requisicao,
		a.qt_material,
		b.nr_seq_segurado,
		b.nr_seq_prestador,
		b.nr_sequencia
	into STRICT	nr_seq_material_w,
		dt_liberacao_w,
		qt_solicitada_w,
		nr_seq_segurado_w,
		nr_seq_prestador_w,
		nr_seq_requisicao_w
	from	pls_requisicao		b,
		pls_requisicao_mat	a
	where	a.nr_seq_requisicao	= b.nr_sequencia
	and	a.nr_sequencia		= nr_sequencia_p;
elsif (ie_tipo_item_p	= 10) then
	select	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_item,
		clock_timestamp(),
		a.nr_seq_segurado,
		b.nr_seq_prestador
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w,
		qt_solicitada_w,
		dt_liberacao_w,
		nr_seq_segurado_w,
		nr_seq_prestador_w
	from	pls_execucao_requisicao	b,
		pls_execucao_req_item	a
	where	a.nr_seq_execucao	= b.nr_sequencia
	and	a.nr_sequencia = nr_sequencia_p;
elsif (ie_tipo_item_p	= 11) then
	select	a.nr_seq_material,
		a.qt_item,
		clock_timestamp(),
		a.nr_seq_segurado,
		b.nr_seq_prestador
	into STRICT	nr_seq_material_w,
		qt_solicitada_w,
		dt_liberacao_w,
		nr_seq_segurado_w,
		nr_seq_prestador_w
	from	pls_execucao_requisicao	b,
		pls_execucao_req_item	a
	where	a.nr_seq_execucao	= b.nr_sequencia
	and	a.nr_sequencia = nr_sequencia_p;
elsif (ie_tipo_item_p = 7) then/* Procedimento da  conta - importação */
	begin
	select	a.cd_procedimento_imp,
		a.ie_origem_proced,
		coalesce(a.dt_procedimento_imp,b.dt_emissao_imp),
		substr(pls_obter_segurado_carteira(b.cd_usuario_plano_imp,cd_estabelecimento_p),1,10),
		b.nr_seq_prestador_exec_imp_ref nr_seq_prestador_exec_imp,
		coalesce(b.cd_guia_solic_imp, b.cd_guia_imp),
		coalesce(b.cd_medico_executor_imp,substr(pls_obter_dados_gerar_conta(b.nr_Sequencia,'M'),1,20)),
		b.nr_sequencia
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w,
		dt_liberacao_w,
		nr_seq_segurado_w,
		nr_seq_prestador_w,
		cd_guia_w,
		cd_medico_executor_w,
		nr_seq_conta_w
	from	pls_conta	b,
		pls_conta_proc	a
	where	a.nr_seq_conta		= b.nr_sequencia
	and	a.nr_sequencia		= nr_sequencia_p;
	exception
	when others then
		cd_procedimento_w := '';
	end;


elsif (ie_tipo_item_p = 8) then/* Material da  conta - importação*/
	begin
	select	a.nr_seq_material,
		coalesce(a.dt_atendimento_imp,b.dt_emissao_imp),
		substr(pls_obter_segurado_carteira(b.cd_usuario_plano_imp,cd_estabelecimento_p),1,10),
		b.nr_seq_prestador_exec_imp_ref nr_seq_prestador_exec_imp,
		coalesce(b.cd_medico_executor_imp,substr(pls_obter_dados_gerar_conta(b.nr_Sequencia,'M'),1,20) ),
		b.nr_sequencia,
		coalesce(b.cd_guia_solic_imp, b.cd_guia_imp)
	into STRICT	nr_seq_material_w,
		dt_liberacao_w,
		nr_seq_segurado_w,
		nr_seq_prestador_w,
		cd_medico_executor_w,
		nr_seq_conta_w,
		cd_guia_w
	from	pls_conta	b,
		pls_conta_mat	a
	where	a.nr_seq_conta		= b.nr_sequencia
	and	a.nr_sequencia		= nr_sequencia_p;
	exception
	when others then
		nr_seq_material_w := 0;
	end;
end if;

begin
	select	cd_prestador
	into STRICT	cd_prestador_w
	from	pls_prestador
	where	nr_sequencia	= nr_seq_prestador_w;
exception
when others then
	cd_prestador_w := null;
end;

if (ie_tipo_qtde_p	= 'D') then
	/*Diego OPS - OS 284525 - Tratamento realizado para que seja mantida uma lógica quanto a quantiade de dias.
			        Ou seja anteriormente se quisese que o não pode-se repetir o proedimento duas vezes no mesmo dia eu teria que cadastrar
			        a qt_dias como zero o que dificultava o entendimento do cliente.
	dt_liberacao_ww	:= trunc(dt_liberacao_w - qt_tipo_quantidade_p);*/
	dt_liberacao_ww	:= trunc(dt_liberacao_w - (qt_tipo_quantidade_p - 1));
	if (ie_qt_lib_posterior_p	= 'S') then
		dt_liberacao_w	:= trunc(dt_liberacao_w + (qt_tipo_quantidade_p - 1));
	end if;
elsif (ie_tipo_qtde_p	= 'M') then
	/*Diego OPS - OS 284577 - Removi os truncs por month pois pela definição do cliente deve-se haver a lógica de ano precisa.
	    Ou seja existindo a regra de 2º incidencia em 1 ano, eu posso executar hoje a exatamente 366 dias após.*/
	dt_liberacao_ww	:= (add_months(dt_liberacao_w, -qt_tipo_quantidade_p) + 1);
	if (ie_qt_lib_posterior_p	= 'S') then
		dt_liberacao_w	:= (add_months(dt_liberacao_w, qt_tipo_quantidade_p) + 1);
	end if;
elsif (ie_tipo_qtde_p	= 'A') then
	/*Diego OPS - OS 284577 - A lógica vista com o Srº Felipe Ambrósio é de que ao executar o procedimento dia 26/01/2011 poderei executa-lo exatamente dia 26/01/2012*/

	dt_liberacao_ww	:= (add_months(dt_liberacao_w, -qt_tipo_quantidade_p * 12) + 1); /* Vezes 12 meses ao ano */
	if (ie_qt_lib_posterior_p	= 'S') then
		dt_liberacao_w	:= (add_months(dt_liberacao_w, qt_tipo_quantidade_p * 12) + 1); /* Vezes 12 meses ao ano */
	end if;
elsif (ie_tipo_qtde_p = 'G') then
	dt_liberacao_ww := clock_timestamp();
end if;

/*Diego - 07/04/2011 -  Estava considerando todos os tipo de datas (ano/dia/mês) no calculo como se fosse dias.
if	(ie_qt_lib_posterior_p	= 'S') then
	/* Felipe - 29/03/2011 - OS 300273
	dt_liberacao_w	:= trunc(dt_liberacao_w + qt_tipo_quantidade_p);
end if;
*/
if (ie_tipo_item_p	= 1) then
	select 	coalesce(sum(a.qt_autorizada),0)
	into STRICT	qt_liberacao_w
	from	pls_guia_plano		b,
		pls_guia_plano_proc	a
	where	a.nr_seq_guia		= b.nr_sequencia
	and	((ie_tipo_pessoa_qtde_p  = 'B' and b.nr_seq_segurado	= nr_seq_segurado_w )
	or (ie_tipo_pessoa_qtde_p 	= 'P' and b.nr_seq_prestador	= nr_seq_prestador_w)
	or (ie_tipo_pessoa_qtde_p  = 'A' and b.nr_seq_segurado	= nr_seq_segurado_w  and b.nr_seq_prestador	= nr_seq_prestador_w ))
	and	((trunc(a.dt_liberacao) between dt_liberacao_ww and trunc(dt_liberacao_w)
	and (b.ie_status <> 3)
	and (ie_tipo_qtde_p <> 'G')
	and (b.nr_sequencia <> nr_seq_guia_plano_w))
	or (b.nr_sequencia 	= nr_seq_guia_plano_w and ie_tipo_qtde_p = 'G'))
	and	coalesce(a.nr_seq_motivo_exc::text, '') = ''
	and	(((coalesce(ie_somar_estrutura_p,'N') = 'N') and (a.cd_procedimento = cd_procedimento_w) and (a.ie_origem_proced = ie_origem_proced_w))
	or	((coalesce(ie_somar_estrutura_p,'N') = 'S')  and (pls_obter_se_estrut_ocorrencia(nr_seq_estrutura_p, a.cd_procedimento, a.ie_origem_proced, null) = 'S')))
	and	((coalesce(ie_regra_tipo_quant_p, 'N') = 'N') or (b.cd_medico_solicitante = cd_medico_solic_w));
elsif (ie_tipo_item_p	= 2) then
	select 	coalesce(sum(a.qt_autorizada),0)
	into STRICT	qt_liberacao_w
	from	pls_guia_plano		b,
		pls_guia_plano_mat	a
	where	a.nr_seq_guia		= b.nr_sequencia
	and	((ie_tipo_pessoa_qtde_p  = 'B' and b.nr_seq_segurado	= nr_seq_segurado_w )
	or (ie_tipo_pessoa_qtde_p 	= 'P' and b.nr_seq_prestador	= nr_seq_prestador_w)
	or (ie_tipo_pessoa_qtde_p  = 'A' and b.nr_seq_segurado	= nr_seq_segurado_w  and b.nr_seq_prestador	= nr_seq_prestador_w ))
	and	((trunc(a.dt_liberacao) between dt_liberacao_ww and trunc(dt_liberacao_w)
	and (b.ie_status <> 3)
	and (ie_tipo_qtde_p <> 'G')
	and (b.nr_sequencia <> nr_seq_guia_plano_w))
	or (b.nr_sequencia 	= nr_seq_guia_plano_w and ie_tipo_qtde_p = 'G'))
	and	coalesce(a.nr_seq_motivo_exc::text, '') = ''
	and	a.nr_seq_material	= nr_seq_material_w
	and	((coalesce(ie_regra_tipo_quant_p, 'N') = 'N') or (b.cd_medico_solicitante = cd_medico_solic_w));
elsif (ie_tipo_item_p	in (3,7)) then

	select	sum(qt_item)
	into STRICT	qt_liberacao_w from
	(
		SELECT 	sum(coalesce(a.qt_procedimento_imp,0)) qt_item
		from	pls_conta		b,
			pls_conta_proc		a
		where	a.nr_seq_conta			= b.nr_sequencia
		and	a.ie_status			not in ('U','D')
		and	coalesce(a.nr_seq_proc_ref,0)	= 0 /*Diego OS 314640 - Eliminar procedimentos referenciados*/
		and (b.nr_seq_segurado		= nr_seq_segurado_w and ie_tipo_pessoa_qtde_p  = 'B')
		and	(((ie_tipo_qtde_p not in ('G','C')) and (trunc(coalesce(a.dt_procedimento,b.dt_emissao)) between dt_liberacao_ww and trunc(dt_liberacao_w))) or
			((ie_tipo_qtde_p = 'G') and (coalesce(b.cd_guia_referencia,b.cd_guia) = cd_guia_w)) or
			(ie_tipo_qtde_p = 'C' AND b.nr_sequencia = nr_seq_conta_w))
		and	((ie_regra_tipo_quant_p = 'N') or (b.cd_medico_executor = cd_medico_executor_w))
		and	(((ie_somar_estrutura_p = 'N') and (a.cd_procedimento = cd_procedimento_w) and (a.ie_origem_proced = ie_origem_proced_w))--ie_origem_proced_w
		or	((ie_somar_estrutura_p = 'S')  and (pls_obter_se_estrut_ocorrencia(nr_seq_estrutura_p, a.cd_procedimento, a.ie_origem_proced, null) = 'S')))
		and	((not exists (	SELECT	1 					--Diego OS 292510 - Acrescentado o not exists para que seja contabilizado somente
					from	pls_ocorrencia_benef	x
					where	coalesce(x.nr_seq_guia_plano,0) = 0		--a sequencia que seja consistido sempre será aproveitado o máximo possivel de contas.
					and	coalesce(x.nr_seq_requisicao,0) = 0
					and	x.nr_seq_proc = a.nr_sequencia
					and	x.nr_seq_ocorrencia = nr_seq_ocorrencia_p)) or (a.nr_sequencia = nr_seq_proc_ref_w))
		
union

		select 	sum(coalesce(a.qt_procedimento_imp,0)) qt_item
		from	pls_conta		b,
			pls_conta_proc		a
		where	a.nr_seq_conta			= b.nr_sequencia
		and	a.ie_status			not in ('U','D')
		and	coalesce(a.nr_seq_proc_ref,0)	= 0 /*Diego OS 314640 - Eliminar procedimentos referenciados*/
		and (b.nr_seq_prestador_exec 	= nr_seq_prestador_w and ie_tipo_pessoa_qtde_p = 'P')
		and	(((ie_tipo_qtde_p not in ('G','C')) and (trunc(coalesce(a.dt_procedimento,b.dt_emissao)) between dt_liberacao_ww and trunc(dt_liberacao_w))) or
			((ie_tipo_qtde_p = 'G') and (coalesce(b.cd_guia_referencia,b.cd_guia) = cd_guia_w)) or
			(ie_tipo_qtde_p = 'C' AND b.nr_sequencia = nr_seq_conta_w))
		and	((ie_regra_tipo_quant_p = 'N') or (b.cd_medico_executor = cd_medico_executor_w))
		and	(((ie_somar_estrutura_p = 'N') and (a.cd_procedimento = cd_procedimento_w) and (a.ie_origem_proced = ie_origem_proced_w))--ie_origem_proced_w
		or	((ie_somar_estrutura_p = 'S')  and (pls_obter_se_estrut_ocorrencia(nr_seq_estrutura_p, a.cd_procedimento, a.ie_origem_proced, null) = 'S')))
		and	((not exists (	select	1 					--Diego OS 292510 - Acrescentado o not exists para que seja contabilizado somente
					from	pls_ocorrencia_benef	x
					where	coalesce(x.nr_seq_guia_plano,0) = 0		--a sequencia que seja consistido sempre será aproveitado o máximo possivel de contas.
					and	coalesce(x.nr_seq_requisicao,0) = 0
					and	x.nr_seq_proc = a.nr_sequencia
					and	x.nr_seq_ocorrencia = nr_seq_ocorrencia_p)) or (a.nr_sequencia = nr_seq_proc_ref_w))) alias75; --Para o caso do procedimento principal ter gerado ocorrencia. No anterior caso o proc principal tivesse ocorrencia o filho talvez não geraria
elsif (ie_tipo_item_p	in (4,8)) then
	select	sum(qt_item)
	into STRICT	qt_liberacao_w
	from	(
		SELECT 	sum(coalesce(a.qt_material_imp,0)) qt_item
		from	pls_conta		b,
			pls_conta_mat		a
		where	a.nr_seq_conta			= b.nr_sequencia
		and	a.ie_status			not in ('U','D')
		and (b.nr_seq_segurado		= nr_seq_segurado_w and ie_tipo_pessoa_qtde_p  = 'B')
		and	(((ie_tipo_qtde_p not in ('G','C')) and (trunc(coalesce(a.dt_atendimento,b.dt_emissao)) between dt_liberacao_ww and trunc(dt_liberacao_w))) or
			((ie_tipo_qtde_p = 'G') and (coalesce(b.cd_guia_referencia,b.cd_guia) = cd_guia_w)) or
			(ie_tipo_qtde_p = 'C' AND b.nr_sequencia = nr_seq_conta_w))
		and	((ie_regra_tipo_quant_p = 'N') or (b.cd_medico_executor = cd_medico_executor_w))
		and	((ie_somar_estrutura_p = 'N' AND a.nr_seq_material = nr_seq_material_w)
		or	((ie_somar_estrutura_p = 'S')  and (pls_obter_se_estrut_ocorrencia(nr_seq_estrutura_p, null, null, a.nr_seq_material) = 'S')))
		and	not exists (	SELECT	1 					--Diego OS 292510 - Acrescentado o not exists para que seja contabilizado somente
					from	pls_ocorrencia_benef	x
					where	coalesce(x.nr_seq_guia_plano,0) = 0		--a sequencia que seja consistido sempre será aproveitado o máximo possivel de contas.
					and	coalesce(x.nr_seq_requisicao,0) = 0
					and	x.nr_seq_mat = a.nr_sequencia
					and	x.nr_seq_ocorrencia = nr_seq_ocorrencia_p)
		
union

		select 	sum(coalesce(a.qt_material_imp,0)) qt_item
		from	pls_conta		b,
			pls_conta_mat		a
		where	a.nr_seq_conta			= b.nr_sequencia
		and	a.ie_status			not in ('U','D')
		and (b.nr_seq_prestador_exec	= nr_seq_prestador_w and ie_tipo_pessoa_qtde_p = 'P')
		and	(((ie_tipo_qtde_p not in ('G','C')) and (trunc(coalesce(a.dt_atendimento,b.dt_emissao)) between dt_liberacao_ww and trunc(dt_liberacao_w))) or
			((ie_tipo_qtde_p = 'G') and (coalesce(b.cd_guia_referencia,b.cd_guia) = cd_guia_w)) or
			(ie_tipo_qtde_p = 'C' AND b.nr_sequencia = nr_seq_conta_w))
		and	((ie_regra_tipo_quant_p = 'N') or (b.cd_medico_executor = cd_medico_executor_w))
		and	((ie_somar_estrutura_p = 'N' AND a.nr_seq_material = nr_seq_material_w)
		or	((ie_somar_estrutura_p = 'S')  and (pls_obter_se_estrut_ocorrencia(nr_seq_estrutura_p, null, null, a.nr_seq_material) = 'S')))
		and	not exists (	select	1 					--Diego OS 292510 - Acrescentado o not exists para que seja contabilizado somente
					from	pls_ocorrencia_benef	x
					where	coalesce(x.nr_seq_guia_plano,0) = 0		--a sequencia que seja consistido sempre será aproveitado o máximo possivel de contas.
					and	coalesce(x.nr_seq_requisicao,0) = 0
					and	x.nr_seq_mat = a.nr_sequencia
					and	x.nr_seq_ocorrencia = nr_seq_ocorrencia_p)) alias61;
elsif (ie_tipo_item_p	= 5) then
	qt_liberacao_w	:= 0;
	open C05;
	loop
	fetch C05 into
		nr_seq_req_proc_w,
		cd_procedimento_ww,
		ie_origem_proced_ww,
		qt_procedimento_w,
		nr_seq_segurado_cursor_w,
		nr_seq_prestador_cursor_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin
		if (ie_tipo_pessoa_qtde_p  = 'B' and nr_seq_segurado_cursor_w	= nr_seq_segurado_w)  then
			ie_cursor_valida_restricao_w := 'S';
		elsif	(ie_tipo_pessoa_qtde_p 	= 'P' and
			((ie_valida_cod_prestador_p = 'N' and nr_seq_prestador_cursor_w	= nr_seq_prestador_w) or (ie_valida_cod_prestador_p = 'S' and pls_obter_cod_prestador(nr_seq_prestador_cursor_w,null) = cd_prestador_w))) then
			ie_cursor_valida_restricao_w := 'S';
		elsif	(ie_tipo_pessoa_qtde_p  = 'A' and nr_seq_segurado_cursor_w	= nr_seq_segurado_w  and
			((ie_valida_cod_prestador_p = 'N' and nr_seq_prestador_cursor_w	= nr_seq_prestador_w) or (ie_valida_cod_prestador_p = 'S' and pls_obter_cod_prestador(nr_seq_prestador_cursor_w,null) = cd_prestador_w))) then
			ie_cursor_valida_restricao_w := 'S';
		else
			goto final5;
		end if;

		if	((ie_somar_estrutura_p = 'S')  and (pls_obter_se_estrut_ocorrencia(nr_seq_estrutura_p, cd_procedimento_ww, ie_origem_proced_ww, null) = 'S')) then
			ie_cursor_valida_restricao_w := 'S';
		elsif	(ie_somar_estrutura_p = 'N' AND cd_procedimento_ww = cd_procedimento_w AND ie_origem_proced_ww = ie_origem_proced_w) then
			ie_cursor_valida_restricao_w := 'S';
		else
			goto final5;
		end if;

		if (ie_cursor_valida_restricao_w = 'S') then
			qt_liberacao_w	:= qt_liberacao_w + qt_procedimento_w;
			qt_solicitacao_w := qt_solicitacao_w + 1;
		end if;

		<<final5>>
		ie_cursor_valida_restricao_w := 'N';
		end;
	end loop;
	close C05;

	if (coalesce(qt_liberacao_w::text, '') = '') then
		qt_liberacao_w	:= 0;
	end if;
elsif (ie_tipo_item_p	= 6) then
	select 	sum(a.qt_material),
		count(1)
	into STRICT	qt_liberacao_w,
		qt_solicitacao_w
	from	pls_requisicao				b,
		pls_requisicao_mat			a
	where	a.nr_seq_requisicao	= b.nr_sequencia
	and	((ie_tipo_pessoa_qtde_p  = 'B' and b.nr_seq_segurado	= nr_seq_segurado_w )
	or (ie_tipo_pessoa_qtde_p 	= 'P' and b.nr_seq_prestador	= nr_seq_prestador_w)
	or (ie_tipo_pessoa_qtde_p  = 'A' and b.nr_seq_segurado	= nr_seq_segurado_w  and b.nr_seq_prestador	= nr_seq_prestador_w ))
	and	((trunc(b.dt_requisicao) between dt_liberacao_ww and trunc(dt_liberacao_w)
	and	coalesce(a.nr_seq_motivo_exc::text, '') = ''
	and	b.ie_estagio		= 2
	and	ie_tipo_qtde_p 		<> 'G')
	or (b.nr_sequencia 	= nr_seq_requisicao_w and ie_tipo_qtde_p = 'G'))
	and	a.nr_seq_material	= nr_seq_material_w
	and	coalesce(a.ie_cobranca_previa_servico,'N')	<> 'S';

	if (coalesce(qt_liberacao_w::text, '') = '') then
		qt_liberacao_w	:= 0;
	end if;
elsif (ie_tipo_item_p	= 10) then
	select 	coalesce(sum(a.qt_item),0),
		count(1)
	into STRICT	qt_liberacao_w,
		qt_solicitacao_w
	from	pls_execucao_requisicao	b,
		pls_execucao_req_item	a
	where	a.nr_seq_execucao	= b.nr_sequencia
	and	((ie_tipo_pessoa_qtde_p  = 'B' and a.nr_seq_segurado	= nr_seq_segurado_w )
	or (ie_tipo_pessoa_qtde_p 	= 'P' and b.nr_seq_prestador	= nr_seq_prestador_w)
	or (ie_tipo_pessoa_qtde_p  = 'A' and a.nr_seq_segurado	= nr_seq_segurado_w  and b.nr_seq_prestador	= nr_seq_prestador_w ))
	and	trunc(b.dt_execucao) between dt_liberacao_ww and fim_dia(dt_liberacao_w)
	and	a.cd_procedimento 	= cd_procedimento_w
	and	a.ie_origem_proced 	= ie_origem_proced_w
	and	not exists (	SELECT	1
				from	pls_requisicao_proc			x
				where	x.nr_seq_requisicao			= b.nr_seq_requisicao
				and	coalesce(x.ie_cobranca_previa_servico,'N')	= 'S');
elsif (ie_tipo_item_p	= 11) then
	select 	coalesce(sum(a.qt_item),0),
		count(1)
	into STRICT	qt_liberacao_w,
		qt_solicitacao_w
	from	pls_execucao_requisicao	b,
		pls_execucao_req_item	a
	where	a.nr_seq_execucao	= b.nr_sequencia
	and	((ie_tipo_pessoa_qtde_p  = 'B' and a.nr_seq_segurado	= nr_seq_segurado_w)
	or (ie_tipo_pessoa_qtde_p 	= 'P' and b.nr_seq_prestador	= nr_seq_prestador_w)
	or (ie_tipo_pessoa_qtde_p  = 'A' and a.nr_seq_segurado	= nr_seq_segurado_w  and b.nr_seq_prestador	= nr_seq_prestador_w ))
	and	trunc(b.dt_execucao) 	between dt_liberacao_ww and fim_dia(dt_liberacao_w)
	and	a.nr_seq_material	= nr_seq_material_w
	and	not exists (	SELECT	1
				from	pls_requisicao_mat			y
				where	y.nr_seq_requisicao			= b.nr_seq_requisicao
				and	coalesce(y.ie_cobranca_previa_servico,'N')	= 'S');
end if;

--r(-20011,qt_liberacao_w||' - '||qt_solicitada_w||' - '||qt_liberada_p||'#@#@');
qt_liberacao_w := qt_liberacao_w + qt_solicitada_w;
/*Diego /Alexandre  - OS 264139 - Obs: retirado a verificação do qt_liberacao_w for igual ao qt_liberada_p  */

/*Djavan - OS 277771 - Obs: Alterada a comparação "if (qt_liberacao_w	> qt_liberada_p) then", para "if (qt_liberacao_w	>= qt_liberada_p) then", por solicitação do Adriano*/

/*Alexandre - OS 383499 - Caso o valor do parametro "ie_somente_solicitacao_p " for "N", segue a verificação atual, caso o valor seja "S", então sera verificado a quantidade de solicitações do item(numero de registros existem do item)
		e não a soma das quantidade do item. O campo "Valida somente solicitações" da regra de ocorrências é que determina o valor do parâmetro*/
if (qt_liberacao_w	>= qt_liberada_p) then
	ie_retorno_w	:= 'N';
end if;

if (coalesce(ie_somente_solicitacao_p,'N') = 'S') and (ie_tipo_item_p in (5,6,10,11)) then
	qt_solicitacao_w := qt_solicitacao_w + 1;
	if (qt_solicitacao_w >= qt_liberada_p) then
		ie_retorno_w	:= 'N';
	else
		ie_retorno_w	:= 'S';
	end if;
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_se_qtd_ocorrencia ( nr_sequencia_p bigint, ie_tipo_item_p bigint, qt_liberada_p bigint, ie_tipo_qtde_p text, qt_tipo_quantidade_p bigint, ie_tipo_pessoa_qtde_p text, ie_regra_tipo_quant_p text, ie_somar_estrutura_p text, nr_seq_estrutura_p bigint, nr_seq_ocorrencia_p bigint, ie_qt_lib_posterior_p text, ie_somente_solicitacao_p text, ds_parametro_1_p text, ie_valida_cod_prestador_p text, cd_estabelecimento_p text) FROM PUBLIC;

