-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_proximo_dia_trat (NR_CICLO_P bigint, NR_SEQ_PACIENTE_P bigint) RETURNS varchar AS $body$
DECLARE



TOTAL_DIAS_W varchar(500);
DIAS_APLICACAO_MEDIC_W varchar(4000);
ULTIMO_DIA_W varchar(10);
PROXIMA_DIA_W varchar(10);

C01 CURSOR FOR
    SELECT 	a.DS_DIAS_APLICACAO
    FROM 	PACIENTE_PROTOCOLO_MEDIC a
    WHERE  	NR_SEQ_PACIENTE =  NR_SEQ_PACIENTE_P;


BEGIN	

	OPEN C01;
	LOOP
	FETCH C01 INTO
		DIAS_APLICACAO_MEDIC_W;
	EXIT WHEN NOT FOUND; /* apply on C01 */

	IF (TOTAL_DIAS_W IS NOT NULL AND TOTAL_DIAS_W::text <> '') THEN
        TOTAL_DIAS_W := TOTAL_DIAS_W||',';
		END IF;	
		TOTAL_DIAS_W:= TOTAL_DIAS_W||DIAS_APLICACAO_MEDIC_W;
    end loop;
	close C01;


	select  coalesce(max(somente_numero(ds_dia_ciclo)),0)
	INTO STRICT 	ULTIMO_DIA_W
	from    paciente_atendimento
	where   nr_ciclo = NR_CICLO_P
	and     nr_seq_paciente = NR_SEQ_PACIENTE_P;


	SELECT MIN(diasTrat.Dias_Medic) INTO STRICT PROXIMA_DIA_W 
    FROM (WITH RECURSIVE cte AS (
SELECT distinct somente_numero(regexp_substr(TOTAL_DIAS_W,'[^,]+',1,level)) Dias_Medic		
		
		(regexp_substr(TOTAL_DIAS_W,'[^,]+',1,level) IS NOT NULL AND (regexp_substr(TOTAL_DIAS_W,'[^,]+',1,level))::text <> '')  UNION ALL
SELECT distinct somente_numero(regexp_substr(TOTAL_DIAS_W,'[^,]+',1,level)) Dias_Medic		
		
		(regexp_substr(TOTAL_DIAS_W,'[^,]+',1,level) IS NOT NULL AND (regexp_substr(TOTAL_DIAS_W,'[^,]+',1,level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte ORDER BY  Dias_Medic;
)  diasTrat 
	WHERE diasTrat.Dias_Medic > ULTIMO_DIA_W;

	RETURN PROXIMA_DIA_W;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_proximo_dia_trat (NR_CICLO_P bigint, NR_SEQ_PACIENTE_P bigint) FROM PUBLIC;

