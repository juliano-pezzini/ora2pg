-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION gerar_cron_expression_regra ( ie_regra_repet_p text, ie_dia_semana_p bigint, qt_intervalo_min_p bigint, hr_fixa_p text, nr_dia_fixo_p bigint) RETURNS varchar AS $body$
DECLARE



vseg_w varchar(10) := '0';
vmin_w varchar(10) := '*';
vhora_w varchar(10) := '*';
vdia_w varchar(10) := '*';
vmes_w varchar(10) := '*';
vdia_semana_w varchar(10) := '?';


BEGIN

if (ie_regra_repet_p = 'D') then
	
	vmin_w := to_char((to_char(to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_fixa_p||':00', 'dd/mm/yyyy hh24:mi:ss'),'mi'))::numeric );
	vhora_w := to_char((to_char(to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_fixa_p||':00', 'dd/mm/yyyy hh24:mi:ss'),'hh24'))::numeric );

elsif (ie_regra_repet_p = 'DFS') then
	vmin_w := to_char((to_char(to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_fixa_p||':00', 'dd/mm/yyyy hh24:mi:ss'),'mi'))::numeric );
	vhora_w := to_char((to_char(to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_fixa_p||':00', 'dd/mm/yyyy hh24:mi:ss'),'hh24'))::numeric );	
	
    vdia_w:= '?';

    CASE ie_dia_semana_p
    WHEN 1 THEN 
        vdia_semana_w := 'SUN';
    WHEN 2 THEN
        vdia_semana_w := 'MON';
    WHEN 3 THEN
        vdia_semana_w := 'TUE';
    WHEN 4 THEN
        vdia_semana_w := 'WED';
    WHEN 5 THEN
        vdia_semana_w := 'THU';
    WHEN 6 THEN
        vdia_semana_w := 'FRI';
    WHEN 7 THEN
        vdia_semana_w := 'SAT';
    WHEN 9 THEN
        vdia_semana_w := 'MON-FRI';
  END CASE;
	
elsif (ie_regra_repet_p	= 'IT') then
    
    if (qt_intervalo_min_p > 59)then
        vhora_w := TO_CHAR(TRUNC((qt_intervalo_min_p * 60) / 3600), 'FM990');
        vmin_w := TO_CHAR((TO_CHAR(TRUNC(MOD((qt_intervalo_min_p * 60), 3600) / 60), 'FM00'))::numeric );

        if (vhora_w >= 24) then
            vhora_w := 23;
        end if;

        vhora_w := '0/' || vhora_w;
    else
        vmin_w := '0/' || to_char(qt_intervalo_min_p);
    end if;

elsif (ie_regra_repet_p = 'M') then

	vmin_w := to_char((to_char(to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_fixa_p||':00', 'dd/mm/yyyy hh24:mi:ss'),'mi'))::numeric );
	vhora_w := to_char((to_char(to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_fixa_p||':00', 'dd/mm/yyyy hh24:mi:ss'),'hh24'))::numeric );
		
	if (nr_dia_fixo_p >= 28) then
		vdia_w := 'L';
	else
		vdia_w := coalesce(nr_dia_fixo_p,'1');
	end if;

end if;

return vseg_w || ' ' || vmin_w || ' ' || vhora_w || ' ' || vdia_w || ' ' || vmes_w || ' ' || vdia_semana_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION gerar_cron_expression_regra ( ie_regra_repet_p text, ie_dia_semana_p bigint, qt_intervalo_min_p bigint, hr_fixa_p text, nr_dia_fixo_p bigint) FROM PUBLIC;

