-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_equip_exame_duplicado ( nr_seq_exame_p bigint, ds_sigla_p text) RETURNS varchar AS $body$
DECLARE


nr_seq_exame_dup		exame_laboratorio.nr_seq_exame%type;
cd_exame_equip_integr_w		varchar(20);
Resultado_w	 		varchar(50);

c01 CURSOR FOR
	SELECT	distinct b.nr_seq_exame
	from	equipamento_lab a,
		lab_exame_equip b
	where	a.cd_equipamento = b.cd_equipamento
	  and	b.nr_seq_exame <> nr_seq_exame_p
	  and	a.ds_sigla = ds_sigla_p
	  and	b.cd_exame_equip = cd_exame_equip_integr_w;


BEGIN
	if (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '' AND ds_sigla_p IS NOT NULL AND ds_sigla_p::text <> '') then
		select coalesce(max(b.cd_exame_equip),null)
		into STRICT cd_exame_equip_integr_w
		from equipamento_lab a,
		     lab_exame_equip b
		where a.cd_equipamento	= b.cd_equipamento
		  and b.nr_seq_exame 	= nr_seq_exame_p
		  and a.ds_sigla 	= ds_sigla_p;

		open c01;
		loop
			fetch c01
			into nr_seq_exame_dup;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				resultado_w := resultado_w || nr_seq_exame_dup || ', ';
		end loop;
		close c01;
		resultado_w := substr(resultado_w, 1, length(resultado_W)-2);
	end if;

RETURN resultado_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_equip_exame_duplicado ( nr_seq_exame_p bigint, ds_sigla_p text) FROM PUBLIC;

