-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_dt_bomba_infusao_transicao (nr_sequencia_interface_p bigint) RETURNS timestamp AS $body$
DECLARE

nr_seq_bomba_transicao_v         bomba_infusao_transicao.nr_sequencia%TYPE;
dt_transicao_w	timestamp;

BEGIN

    BEGIN
        SELECT nr_sequencia
          INTO STRICT nr_seq_bomba_transicao_v 
          FROM (
            SELECT nr_sequencia 
              FROM bomba_infusao_transicao 
             WHERE nr_seq_bomba_interface = nr_sequencia_interface_p 
               AND (ie_status IN ('ST', 'DS') OR ds_campo = 'DS_MEDICAMENTO')
             ORDER BY dt_transicao DESC) alias2 LIMIT 1;

        SELECT coalesce(dt_transicao, clock_timestamp()) INTO STRICT dt_transicao_w  
          FROM bomba_infusao_transicao WHERE nr_seq_bomba_interface = nr_sequencia_interface_p  
           AND nr_sequencia > nr_seq_bomba_transicao_v
         ORDER BY nr_sequencia LIMIT 1;
    EXCEPTION
        WHEN no_data_found THEN dt_transicao_w := clock_timestamp();
    END;

RETURN	dt_transicao_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_dt_bomba_infusao_transicao (nr_sequencia_interface_p bigint) FROM PUBLIC;

