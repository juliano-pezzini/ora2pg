-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pfcs_get_tele_total_device ( ds_device_type text, ds_filter_type text, cd_estabelecimento_p text ) RETURNS bigint AS $body$
DECLARE


nr_retorno_w bigint;
ie_telemetria           varchar(5) :='S';
ie_rec_status           varchar(5) :='S';
ie_not_rec_status       varchar(5) :='F';
ie_matching_status      varchar(5) := 'S';
ie_finished_status 		varchar(5) := 'F';
ie_started_status 		varchar(5) := 'S';


BEGIN

nr_retorno_w := 0;

-- ds_filter_type A is for devices available
if (ds_filter_type = 'A') then
  select count(*)
	into STRICT nr_retorno_w 
	from equipamento eq
	where eq.cd_estabelecimento = (cd_estabelecimento_p)::numeric 
  and eq.ie_tipo_equipamento = ds_device_type
	and eq.cd_equipamento not in (SELECT distinct uae.cd_equipamento
                      from
                            unidade_atend_equip uae,
                            equipamento eq,
                            setor_atendimento sa,
                            atend_paciente_unidade apu,
                            cpoe_recomendacao cr,
                            tipo_recomendacao tr,
                            atendimento_paciente ap
                    where eq.cd_estabelecimento = (cd_estabelecimento_p)::numeric 
          			and eq.ie_tipo_equipamento = 'TL'
          			and uae.cd_equipamento = eq.cd_equipamento
          			and ap.nr_atendimento = apu.nr_atendimento
          			and apu.cd_unidade_basica = uae.cd_unidade_basica
          			and apu.cd_setor_atendimento = uae.cd_setor_atendimento
          			and apu.cd_unidade_compl = uae.cd_unidade_compl
          			and ap.nr_atendimento = cr.nr_atendimento
          			and cr.cd_recomendacao = tr.cd_tipo_recomendacao
          			and uae.cd_setor_atendimento = sa.cd_setor_atendimento
          			and coalesce(ap.dt_cancelamento::text, '') = ''
          			and coalesce(ap.dt_alta::text, '') = ''
          			and coalesce(cr.dt_suspensao::text, '') = ''
          			and apu.dt_saida_unidade is  null
          			and (
          				pfcs_get_recommendation_status(cr.nr_sequencia) = ie_started_status or
          				pfcs_get_recommendation_status(cr.nr_sequencia) = ie_finished_status)
          			and tr.ie_telemetria = ie_matching_status
          			and eq.cd_equipamento in (select distinct uaq.cd_equipamento
          					from unidade_atend_equip uaq,
          						equipamento eq
          					where uaq.cd_equipamento = eq.cd_equipamento
          						and eq.cd_estabelecimento = (cd_estabelecimento_p)::numeric 
          				));
-- ds_filter_type u/U is for devices in use
elsif (ds_filter_type = 'U') then
  select count(*)
  into STRICT nr_retorno_w
  from equipamento
  where equipamento.cd_estabelecimento = (cd_estabelecimento_p)::numeric  and equipamento.ie_tipo_equipamento = ds_device_type
  and equipamento.cd_equipamento in (SELECT distinct uae.cd_equipamento
                     from
                           unidade_atend_equip uae,
                           equipamento eq,
                           setor_atendimento sa,
                           atend_paciente_unidade apu,
                           cpoe_recomendacao cr,
                           tipo_recomendacao tr,
                           atendimento_paciente ap
                   where eq.cd_estabelecimento = (cd_estabelecimento_p)::numeric
         			and eq.ie_tipo_equipamento = 'TL'
         			and uae.cd_equipamento = eq.cd_equipamento
         			and ap.nr_atendimento = apu.nr_atendimento
         			and apu.cd_unidade_basica = uae.cd_unidade_basica
         			and apu.cd_setor_atendimento = uae.cd_setor_atendimento
         			and apu.cd_unidade_compl = uae.cd_unidade_compl
         			and ap.nr_atendimento = cr.nr_atendimento
         			and cr.cd_recomendacao = tr.cd_tipo_recomendacao
         			and uae.cd_setor_atendimento = sa.cd_setor_atendimento
         			and coalesce(ap.dt_cancelamento::text, '') = ''
         			and coalesce(ap.dt_alta::text, '') = ''
         			and coalesce(cr.dt_suspensao::text, '') = ''
         			and apu.dt_saida_unidade is  null
         			and (
         				pfcs_get_recommendation_status(cr.nr_sequencia) = ie_started_status or
         				pfcs_get_recommendation_status(cr.nr_sequencia) = ie_finished_status)
         			and tr.ie_telemetria = ie_matching_status
         			and eq.cd_equipamento in (select distinct uaq.cd_equipamento
         					from unidade_atend_equip uaq,
         						equipamento eq
         					where uaq.cd_equipamento = eq.cd_equipamento
         						and eq.cd_estabelecimento = (cd_estabelecimento_p)::numeric 
         				));
else
-- when ds_filter_type is not passed then all devices are considered
  select count(*)
	into STRICT nr_retorno_w
	from equipamento eq
	where eq.ie_tipo_equipamento = ds_device_type
  and eq.cd_estabelecimento = (cd_estabelecimento_p)::numeric;
end if;

return nr_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pfcs_get_tele_total_device ( ds_device_type text, ds_filter_type text, cd_estabelecimento_p text ) FROM PUBLIC;

