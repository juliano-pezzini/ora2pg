-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_copias_laudo_medico_proc (nr_seq_laudo_p bigint) RETURNS bigint AS $body$
DECLARE

 
			 
cd_procedimento_w	numeric(20);
ie_origem_proced_w	bigint;
cd_pessoa_fisica_w	varchar(10);
nr_prescricao_w		bigint;
qt_copias_w		bigint;
nr_copias_w		bigint;
			
			 
c01 CURSOR FOR 
	SELECT	coalesce(nr_copias,0) 
	from	medico_regra_copia_laudo 
	where	cd_pessoa_fisica	= cd_pessoa_fisica_w 
	and		coalesce(cd_procedimento,cd_procedimento_w)   	= cd_procedimento_w 
	and		coalesce(ie_origem_proced,ie_origem_proced_w)	= ie_origem_proced_w 
	order 	by cd_procedimento, ie_origem_proced, cd_pessoa_fisica;			
			 

BEGIN 
-- Procurar o médico da prescrição 
 
select 	coalesce(max(nr_prescricao),0) 
into STRICT 	nr_prescricao_w 
from 	laudo_paciente 
where 	nr_sequencia = nr_seq_laudo_p;
 
select	obter_medico_prescricao(nr_prescricao_w,'C') 
into STRICT	cd_pessoa_fisica_w
;
 
 
--Procurar o procedimento da prescrição 
 
select 	max(p.cd_procedimento), 
		max(p.ie_origem_proced) 
into STRICT	cd_procedimento_w, 
	ie_origem_proced_w 
from	laudo_paciente l, 
	procedimento_paciente p 
where	l.nr_seq_proc 	= p.nr_sequencia 
and	l.nr_sequencia	= nr_seq_laudo_p;
 
 
open C01;
loop 
fetch C01 into	 
	nr_copias_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	qt_copias_w := nr_copias_w;
	exit;
	 
	end;
end loop;
close C01;
 
 
return	qt_copias_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_copias_laudo_medico_proc (nr_seq_laudo_p bigint) FROM PUBLIC;

