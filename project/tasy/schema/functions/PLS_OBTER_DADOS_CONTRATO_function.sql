-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_contrato ( nr_seq_contrato_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/*
	E - Estipulante
	D - Data do contrato
	R - Data de renovacao
	TB - Tipo de beneficiario
	CO - Congenere
	DR - Data Rescisao
	DL - Data limite utilizacao
	TE - Tipo de estipulante
	C  - Codigo do estipulante (CPF ou CNPJ)
	EST - Estabelecimento
	PP - Pagador principal
	N - Numero do contrato (NR_CONTRATO)
	CD - Codigo da empresa na operada
	CE - Codigo da empresa na operada sem nvl
	CA - Codigo anterior
	CV - Canal de venda padrao do contrato
	V - Vendedor PF padrao do contrato
	AR - Aplicacao da regra de lancamento
	RP - Regulamentacao do produto do contrato
	RPC - Regulamentacao por codigo
	S - Estipulante + Descricao do cotnrato
	DS - Descricao do contrato,
	TC - Tipo de contratacao do produto do contrato
	CL - Codigo da classificacao
	DCL - Descricao da classificacao
	MR - Mes de reajuste
	RE - Data de reajuste
*/
nm_estipulante_w		varchar(255);
dt_contrato_w			timestamp;
dt_renovacao_w			timestamp;
qt_meses_w			bigint;
ds_retorno_w			varchar(255);
ie_tipo_beneficiario_w		varchar(3);
nr_seq_congenere_w		bigint;
ds_congenere_w			varchar(255);
dt_rescisao_contrato_w		timestamp;
dt_limite_utilizacao_w		timestamp;
ie_tipo_estipulante_w		varchar(2);
cd_estipulante_w		varchar(14);
cd_estabelecimento_w		varchar(4);
nr_seq_pagador_w		bigint;
nr_contrato_w			bigint;
cd_operadora_empresa_w		bigint;
cd_cod_anterior_w		varchar(20);
nr_seq_canal_venda_w		bigint;
nr_seq_regra_lanc_w		pls_contrato_regra_lanc.nr_sequencia%type;
ie_aplicacao_regra_w		pls_contrato_regra_lanc.ie_aplicacao_regra%type;
nr_seq_plano_w			pls_plano.nr_sequencia%type;
ds_contrato_w			pls_contrato.ds_contrato%type;
nr_seq_vendedor_pf_w		pls_contrato_regra_lanc.nr_seq_vendedor_pf%type;
nr_seq_contrato_princ_w		pls_contrato.nr_contrato_principal%type;
cd_classif_contrato_w		pls_contrato.cd_classif_contrato%type;
nr_mes_reajuste_w		pls_contrato.nr_mes_reajuste%type;
dt_reajuste_w			pls_contrato.dt_reajuste%type;


BEGIN

if (ie_opcao_p = 'PP')then
	select	max(nr_sequencia)
	into STRICT	nr_seq_pagador_w
	from	pls_contrato_pagador
	where	nr_seq_contrato = nr_seq_contrato_p
	and	ie_tipo_pagador = 'P'
	and (coalesce(dt_rescisao::text, '') = '' or trunc(dt_rescisao) > trunc(clock_timestamp()))
	and (coalesce(dt_suspensao::text, '') = '' or trunc(dt_suspensao) > trunc(clock_timestamp()));	
	
	if (coalesce(nr_seq_pagador_w::text, '') = '') then -- Se nao for encontrado um pagador principal no mesmo contrato deve ser considerado o pagador principal do contrato principal
		select	max(nr_contrato_principal)
		into STRICT	nr_seq_contrato_princ_w
		from	pls_contrato
		where	nr_sequencia = nr_seq_contrato_p;
		
		if (coalesce(nr_seq_contrato_princ_w,0) > 0) then
			select 	max(nr_sequencia)
			into STRICT	nr_seq_pagador_w
			from   	pls_contrato_pagador
			where  	nr_seq_contrato = nr_seq_contrato_princ_w
			and    	ie_tipo_pagador = 'P'
			and (coalesce(dt_rescisao::text, '') = '' or trunc(dt_rescisao) > trunc(clock_timestamp()))
			and (coalesce(dt_suspensao::text, '') = '' or trunc(dt_suspensao) > trunc(clock_timestamp()));
		end if;
	end if;	
	ds_retorno_w := nr_seq_pagador_w;
elsif (ie_opcao_p in ('CV','V','AR')) then
	select	max(nr_sequencia)
	into STRICT	nr_seq_regra_lanc_w
	from	pls_contrato_regra_lanc
	where	nr_seq_contrato = nr_seq_contrato_p
	and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and fim_dia(dt_fim_vigencia);
	
	if (ie_opcao_p = 'CV') then
		select	max(nr_seq_vendedor_canal)
		into STRICT	nr_seq_canal_venda_w
		from	pls_contrato_regra_lanc
		where	nr_sequencia = nr_seq_regra_lanc_w;
		
		ds_retorno_w := nr_seq_canal_venda_w;
	elsif (ie_opcao_p = 'V') then
		select	max(nr_seq_vendedor_pf)
		into STRICT	nr_seq_vendedor_pf_w
		from	pls_contrato_regra_lanc
		where	nr_sequencia = nr_seq_regra_lanc_w;
		
		ds_retorno_w := nr_seq_vendedor_pf_w;
	elsif (ie_opcao_p = 'AR') then
		if (nr_seq_regra_lanc_w IS NOT NULL AND nr_seq_regra_lanc_w::text <> '') then
			select	coalesce(ie_aplicacao_regra,'A')
			into STRICT	ie_aplicacao_regra_w
			from	pls_contrato_regra_lanc
			where	nr_sequencia = nr_seq_regra_lanc_w;
		
			ds_retorno_w	:= ie_aplicacao_regra_w;
		else
			ds_retorno_w	:= null;
		end if;
	end if;
elsif (ie_opcao_p = 'RP') then
	select	max(nr_seq_plano)
	into STRICT	nr_seq_plano_w
	from	pls_contrato_plano
	where	nr_seq_contrato	= nr_seq_contrato_p
	and	ie_situacao = 'A';
	
	select	obter_valor_dominio(2157,max(ie_regulamentacao))
	into STRICT	ds_retorno_w
	from	pls_plano
	where	nr_sequencia	= nr_seq_plano_w;
elsif (ie_opcao_p = 'RPC') then
	select	max(b.ie_regulamentacao)
	into STRICT	ds_retorno_w
	from	pls_contrato_plano	a,
		pls_plano		b
	where	a.nr_seq_plano		= b.nr_sequencia
	and	a.nr_seq_contrato	= nr_seq_contrato_p
	and	a.ie_situacao = 'A';
	
	if (coalesce(ds_retorno_w::text, '') = '') then
		select	max(b.ie_regulamentacao)
		into STRICT	ds_retorno_w
		from	pls_contrato_plano	a,
			pls_plano		b
		where	a.nr_seq_plano		= b.nr_sequencia
		and	a.nr_seq_contrato	= nr_seq_contrato_p;
	end if;
elsif (ie_opcao_p = 'TC') then
	select	max(b.ie_tipo_contratacao)
	into STRICT	ds_retorno_w
	from	pls_contrato_plano	a,
		pls_plano		b
	where	a.nr_seq_plano		= b.nr_sequencia
	and	a.nr_seq_contrato	= nr_seq_contrato_p
	and	a.ie_situacao = 'A';
	
	if (coalesce(ds_retorno_w::text, '') = '') then
		select	max(b.ie_tipo_contratacao)
		into STRICT	ds_retorno_w
		from	pls_contrato_plano	a,
			pls_plano		b
		where	a.nr_seq_plano		= b.nr_sequencia
		and	a.nr_seq_contrato	= nr_seq_contrato_p;
	end if;
else
	select	substr(obter_nome_pf_pj(cd_pf_estipulante, cd_cgc_estipulante),1,200),
		dt_contrato,
		coalesce(qt_intervalo,0),
		ie_tipo_beneficiario,
		nr_seq_congenere,
		dt_rescisao_contrato,
		CASE WHEN coalesce(cd_pf_estipulante::text, '') = '' THEN  'PJ'  ELSE 'PF' END ,
		CASE WHEN coalesce(cd_pf_estipulante::text, '') = '' THEN  cd_cgc_estipulante  ELSE cd_pf_estipulante END ,
		cd_estabelecimento,
		dt_limite_utilizacao,
		nr_contrato,
		cd_operadora_empresa,
		cd_cod_anterior,
		ds_contrato,
		cd_classif_contrato,
		nr_mes_reajuste,
		dt_reajuste
	into STRICT	nm_estipulante_w,
		dt_contrato_w,
		qt_meses_w,
		ie_tipo_beneficiario_w,
		nr_seq_congenere_w,
		dt_rescisao_contrato_w,
		ie_tipo_estipulante_w,
		cd_estipulante_w,
		cd_estabelecimento_w,
		dt_limite_utilizacao_w,
		nr_contrato_w,
		cd_operadora_empresa_w,
		cd_cod_anterior_w,
		ds_contrato_w,
		cd_classif_contrato_w,
		nr_mes_reajuste_w,
		dt_reajuste_w
	from	pls_contrato
	where	nr_sequencia	= nr_seq_contrato_p;
	
	if (ie_opcao_p = 'E') then
		ds_retorno_w	:= nm_estipulante_w;
	elsif (ie_opcao_p = 'D') then
		ds_retorno_w 	:= PKG_DATE_FORMATERS.TO_VARCHAR(dt_contrato_w, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario);
	elsif (ie_opcao_p = 'R') then
		if (qt_meses_w > 0) then
			select	add_months(dt_contrato_w,qt_meses_w)
			into STRICT	dt_renovacao_w
			;
			ds_retorno_w	:= PKG_DATE_FORMATERS.TO_VARCHAR(dt_renovacao_w, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario);
		else
			ds_retorno_w	:= '';
		end if;
	elsif (ie_opcao_p = 'TB') then
		ds_retorno_w := ie_tipo_beneficiario_w;
	elsif (ie_opcao_p = 'CO') then
		select	substr(obter_nome_pf_pj(null,cd_cgc),1,255)
		into STRICT	ds_congenere_w
		from	pls_congenere
		where	nr_sequencia = nr_seq_congenere_w;
		
		ds_retorno_w := ds_congenere_w;
	elsif (ie_opcao_p = 'DR') then
		ds_retorno_w := PKG_DATE_FORMATERS.TO_VARCHAR(dt_rescisao_contrato_w, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario);
	elsif (ie_opcao_p = 'DL') then
		ds_retorno_w := PKG_DATE_FORMATERS.TO_VARCHAR(dt_limite_utilizacao_w, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario);
	elsif (ie_opcao_p = 'TE') then
		ds_retorno_w := ie_tipo_estipulante_w;
	elsif (ie_opcao_p = 'C') then
		ds_retorno_w := cd_estipulante_w;
	elsif (ie_opcao_p = 'EST') then
		ds_retorno_w := cd_estabelecimento_w;
	elsif (ie_opcao_p = 'CD') then
		ds_retorno_w	:= to_char(coalesce(cd_operadora_empresa_w,nr_contrato_w));
	elsif (ie_opcao_p = 'CE') then
		ds_retorno_w	:= to_char(cd_operadora_empresa_w);
	elsif (ie_opcao_p = 'N') then
		ds_retorno_w := to_char(nr_contrato_w);
	elsif (ie_opcao_p = 'CA') then
		ds_retorno_w := cd_cod_anterior_w;
	elsif (ie_opcao_p = 'S') then
		ds_retorno_w	:= nm_estipulante_w;
		if (ds_contrato_w IS NOT NULL AND ds_contrato_w::text <> '') then
			ds_retorno_w := substr(ds_retorno_w || ' - '||ds_contrato_w,1,255);
		end if;
	elsif (ie_opcao_p = 'DS') then
		ds_retorno_w	:= ds_contrato_w;
	elsif (ie_opcao_p = 'CL') then
		ds_retorno_w	:= cd_classif_contrato_w;
	elsif (ie_opcao_p = 'DCL') then
		select	max(ds_classificacao)
		into STRICT	ds_retorno_w
		from	pls_classificacao_contrato
		where	cd_classificacao = cd_classif_contrato_w;
	elsif (ie_opcao_p = 'MR') then
		ds_retorno_w	:= obter_valor_dominio(8483,nr_mes_reajuste_w);
	elsif (ie_opcao_p = 'RE') then
		ds_retorno_w	:= PKG_DATE_FORMATERS.TO_VARCHAR(dt_reajuste_w, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario);
	end if;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_contrato ( nr_seq_contrato_p bigint, ie_opcao_p text) FROM PUBLIC;

