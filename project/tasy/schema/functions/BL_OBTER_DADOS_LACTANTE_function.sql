-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION bl_obter_dados_lactante ( cd_pessoa_fisica_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE



ds_retorno_w		varchar(255);
cd_estabelecimento_w	smallint;

/*
	D  - Próximo agendamento
	U - Ùltima coleta
	Q - Quantidade de coletas
	A - agendamento no dia

 */
BEGIN

cd_estabelecimento_w:= wheb_usuario_pck.get_cd_estabelecimento;

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

	if ( ie_opcao_p = 'D') then

		select	max(to_char(dt_agenda,'dd/mm/yyyy'))
		into STRICT	ds_retorno_w
		from	agenda_consulta
		where	cd_pessoa_fisica 	= cd_pessoa_fisica_p
		and	cd_agenda 		= bl_obter_dados_parametro(cd_estabelecimento_w,'A')
		and	ie_status_agenda 	= 'N';

	elsif ( ie_opcao_p = 'U') then

		select 	max(to_char(dt_coleta,'dd/mm/yyyy'))
		into STRICT	ds_retorno_w
		from	bl_coleta
		where	cd_pessoa_fisica = cd_pessoa_fisica_p;

	elsif ( ie_opcao_p = 'Q') then

		select 	count(*)
		into STRICT	ds_retorno_w
		from	bl_coleta
		where	cd_pessoa_fisica = cd_pessoa_fisica_p;

	elsif ( ie_opcao_p = 'A') then
		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ds_retorno_w
		from	agenda_consulta
		where	cd_pessoa_fisica 	= cd_pessoa_fisica_p
		and	cd_agenda 		= bl_obter_dados_parametro(cd_estabelecimento_w,'A')
		and	ie_status_agenda 	= 'N'
		and	dt_agenda 	between	inicio_dia(clock_timestamp()) and fim_dia(clock_timestamp());
	end if;

end if;


return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION bl_obter_dados_lactante ( cd_pessoa_fisica_p text, ie_opcao_p text) FROM PUBLIC;

