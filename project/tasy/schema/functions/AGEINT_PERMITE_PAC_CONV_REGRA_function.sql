-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ageint_permite_pac_conv_regra (nr_seq_ageint_p bigint, cd_estabelecimento_p bigint, nr_seq_agenda_item_p bigint default null) RETURNS varchar AS $body$
DECLARE


ie_permite_w varchar(1) := 'S';
cd_usuario_conv_w agenda_integrada.cd_usuario_convenio%type;
cd_usuario_conv_reg_w agenda_integrada.cd_usuario_convenio%type;
nr_seq_agenda_item_w agenda_integrada_item.nr_sequencia%type;
ie_regra_w agenda_integrada_item.ie_regra%type;
ie_tipo_convenio_w convenio.ie_tipo_convenio%type;
ie_tipo_conv_item_w convenio.ie_tipo_convenio%type;
ie_bloq_w	varchar(10);
ie_bloqueia_glosa_w varchar(2000);
qt_itens_tipo_conv_w bigint;
cont_w integer(10);

C01 CURSOR FOR
	SELECT nr_sequencia,
		   ie_regra
	  from agenda_integrada_item
	 where nr_seq_agenda_int = nr_seq_ageint_p
	   and (nr_sequencia = nr_seq_agenda_item_p or coalesce(nr_seq_agenda_item_p::text, '') = '');


BEGIN

	ie_bloqueia_glosa_w := Obter_Valor_Param_Usuario(869, 460, obter_perfil_ativo, obter_usuario_ativo, cd_estabelecimento_p);
	ie_bloqueia_glosa_w := ie_bloqueia_glosa_w||',';

	select max(cd_usuario_convenio), max(b.ie_tipo_convenio) into STRICT cd_usuario_conv_w, ie_tipo_convenio_w
	  from agenda_integrada a,
		   convenio b
	 where a.nr_sequencia = nr_seq_ageint_p
	   and a.cd_convenio = b.cd_convenio;

	if (ie_bloqueia_glosa_w <> ',' ) then

		ie_permite_w := 'N';

		OPEN C01;
		  LOOP
		  FETCH C01 INTO	
			nr_seq_agenda_item_w,
			ie_regra_w;
		  EXIT WHEN NOT FOUND; /* apply on C01 */
			begin			

				cd_usuario_conv_reg_w := null;
				cont_w := 1;

				if ((cd_usuario_conv_w IS NOT NULL AND cd_usuario_conv_w::text <> '') or (ie_tipo_convenio_w != 2 AND coalesce(nr_seq_agenda_item_p::text, '') = '')) then
				
				   select count(1)
					 into STRICT qt_itens_tipo_conv_w
					 from AGENDA_INTEGRADA_CONV_ITEM aici,
					      agenda_integrada_item aii,
						  agenda_integrada a,
						  convenio c
					where aici.nr_seq_agenda_item = aii.nr_sequencia
					  and aii.nr_seq_agenda_int = a.nr_sequencia
					  and aici.cd_convenio = c.cd_convenio
					  and c.ie_tipo_convenio = 2
					  and coalesce(aici.cd_usuario_convenio::text, '') = ''
					  and a.nr_sequencia = nr_seq_ageint_p;
					
					if (qt_itens_tipo_conv_w = 0) then
						ie_permite_w := 'S';
						exit;
					end if;
				end if;

				while cont_w <= length(ie_bloqueia_glosa_w) and ie_bloqueia_glosa_w <> ',' loop				
					begin

					ie_bloq_w := substr(ie_bloqueia_glosa_w,cont_w,1);

					if (ie_bloq_w <> ',') then
						if (ie_bloq_w = to_char(ie_regra_w)) then

							select max(a.cd_usuario_convenio), max(b.ie_tipo_convenio)
							  into STRICT cd_usuario_conv_reg_w, ie_tipo_conv_item_w
							  from AGENDA_INTEGRADA_CONV_ITEM a,
								   CONVENIO b
							 where nr_seq_agenda_item = nr_seq_agenda_item_w
							   and a.cd_convenio = b.cd_convenio;

							if ((cd_usuario_conv_reg_w IS NOT NULL AND cd_usuario_conv_reg_w::text <> '') or ie_tipo_conv_item_w != 2) then
								ie_permite_w :=  'S';
							else
								ie_permite_w := 'N';
								exit;
							end if;
						else
							if (ie_bloq_w <> ',') then
								ie_permite_w := 'S';
							end if;
						end if;

					end if;
					cont_w := cont_w+1;
					end;
				end loop;
				if (ie_permite_w = 'N') then
					exit;
				end if;
			end;
		end loop;
		CLOSE C01;

	end if;

	return ie_permite_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ageint_permite_pac_conv_regra (nr_seq_ageint_p bigint, cd_estabelecimento_p bigint, nr_seq_agenda_item_p bigint default null) FROM PUBLIC;

