-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_dil_dose_esp_medic ( nr_sequencia_p bigint, nr_prescricao_p bigint, nr_seq_horario_p bigint) RETURNS varchar AS $body$
DECLARE


--Esta  function faz todo o cálculo de dose, porém é específica para a dose especial.
cd_material_w					integer;
cd_medic_w						integer;
qt_dose_w						double precision;
qt_dose_ml_w					double precision;
cd_unid_med_dose_w				varchar(30) := '';
ds_material_w					varchar(100);
ie_possui_diluente_w			varchar(1);
ds_material_ww					varchar(100);
ds_reduzida_w					varchar(100);
ds_diluir_w						varchar(4000) := '';
ds_rediluir_w					varchar(4000) := '';
ds_retorno_w					varchar(2000) := '';
ds_reconstituir_w				varchar(2000) := '';
ds_adm_ui_w						varchar(2000) := '';
ds_hora_w						varchar(10) := '';
ie_administrar_ui_w				varchar(10) := '';
ie_aplicar_medic_w				varchar(10) := '';
ie_aplicar_ww					varchar(10) := '';
ie_um_prescrita_w				varchar(10);
ie_agrupador_w					smallint;
ie_agrupador_ww					smallint;
nr_casas_w						bigint;
qt_dose_mat_w					double precision;
cd_setor_prescr_w				double precision;
cont_ww							double precision;
qt_volume_ww					double precision;
cd_mat_ww						bigint;
qt_dose_mat_str_w				varchar(20) := '';
ie_separar_w					varchar(2);
cd_unid_med_dose_mat_w			varchar(30) := '';
qt_solucao_w					double precision := 0;
qt_solucao_str_w				varchar(10) :='';
ds_dose_diferenciada_w			varchar(50);
ds_erro_w						varchar(2000);
ie_ordem_w						smallint;
qt_solucao_ww					double precision := 0;
qt_min_aplicacao_w				smallint  := 0;
qt_min_aplicacao_ant_w			smallint  := 0;
qt_hora_aplicacao_ant_w			smallint  := 0;
qt_hora_aplicacao_w				smallint  := 0;
ds_min_aplicacao_w				varchar(255) := '';
cd_volume_final_w				double precision := 0;
mascara_w						smallint := 0;
qt_dose_str_w					varchar(20) := '';
cd_volume_final_str_w			varchar(20) := '';
qt_diluicao_w					double precision := 0;
qt_conversao_w					double precision;
cd_diluente_w					integer  := 0;
ds_diluente_w					varchar(100) := '';
qt_diluicao_str_w				varchar(20) := '';
ds_via_w						varchar(50) := '';
cd_unidade_medida_w				varchar(30);
ds_conv_ml_w					varchar(20) := '';
qt_conv_ml_w					double precision;
cd_estabelecimento_w			smallint;
qt_registro_w					smallint := 0;
ie_descr_redu_dil_w				varchar(1);

ds_aux_diluir_w					varchar(30);
ie_via_aplicacao_w				varchar(5);
cd_intervalo_w					varchar(7);
qt_ml_diluente_w				double precision;
ds_volume_w						varchar(100);
ds_tempo_w						varchar(100);
qt_dose_medic_ml_w				double precision;
ds_aplicar_w					varchar(200);
ds_diluicao_edit_w				varchar(2000);
ie_aplicar_w					varchar(1);
ds_dose_diluicao_w				varchar(100);
qt_dose_unid_med_cons_w			double precision;
qt_vol_adic_reconst_w			double precision;
ie_indice_w						smallint;

cd_material_red_w				integer;
qt_dose_red_w					double precision;
cd_unid_med_dose_red_w			varchar(30) := '';
qt_solucao_red_w				double precision := 0;
qt_dose_ml_red_w				double precision;
ds_material_red_ww				varchar(100);
ds_reduzida_red_w				varchar(100);
ds_material_red_w				varchar(100);
cd_volume_final_red_w			double precision := 0;
qt_diluicao_aux_w				double precision;
cd_unid_med_diluente_aux_w		varchar(50);


ie_mostrar_estabilidade_w		varchar(1);
qt_estagio_armazenamento_w		bigint;
ds_estagio_armazenamento_w		varchar(255);
qt_estabilidade_w				bigint;
ds_tempo_estabilidade_w			varchar(255);
ds_inf_adic_w					varchar(2000);
ie_higroscopico_w				varchar(1);
ie_fotosensivel_w				varchar(1);
ie_termolabil_w					varchar(1);
nr_casas_diluicao_w				bigint;
ie_ConsisteDoseConsumoMedic_w	varchar(1) := 'S';
qt_unit_medic_w					double precision;
ds_total_reconst_w				varchar(255);
qt_volume_adic_w				double precision;
ie_apres_vol_reconst_w			varchar(1);

c00 CURSOR FOR
SELECT	c.qt_dose,--nvl(b.qt_dose_especial,0),--b.qt_dose,
		b.qt_min_aplicacao,
		b.qt_hora_aplicacao,
		b.cd_unidade_medida_dose,
		b.qt_solucao,
		b.cd_unidade_medida,
		b.cd_material,
		a.cd_estabelecimento,
		b.cd_intervalo,
		b.ie_via_aplicacao,
		b.ds_dose_diferenciada,
		1 ie_indice,
		null ds_hora,
		1 ie_ordem,
		0 qt_diluicao,
		null cd_unid_med_diluente,
		a.cd_setor_atendimento,
		b.qt_unitaria,
		b.ie_agrupador
from 	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where 	a.nr_prescricao	= nr_prescricao_p
and		a.nr_prescricao	= b.nr_prescricao
and		b.nr_prescricao = c.nr_prescricao
and		b.nr_sequencia	= nr_sequencia_p
and		b.nr_sequencia	= c.nr_seq_material
and		c.nr_sequencia	= nr_seq_horario_p
and		b.ie_agrupador	in (1, 5, 8, 12, 14)
and	not exists (	select	1
					from	prescr_mat_diluicao x
					where	x.nr_prescricao	= b.nr_prescricao
					and		x.nr_seq_material = b.nr_sequencia)

union

select	coalesce(c.qt_dose_diferenciada, b.qt_dose),--nvl(c.qt_dose_especial,0),--
		coalesce(c.qt_min_aplicacao, b.qt_min_aplicacao),
		b.qt_hora_aplicacao,
		b.cd_unidade_medida_dose,
		b.qt_solucao,
		b.cd_unidade_medida,
		b.cd_material,
		a.cd_estabelecimento,
		b.cd_intervalo,
		b.ie_via_aplicacao,
		b.ds_dose_diferenciada,
		2 ie_indice,
		c.ds_hora,
		c.ie_ordem,
		c.qt_diluicao,
		c.cd_unid_med_diluente,
		a.cd_setor_atendimento,
		b.qt_unitaria,
		b.ie_agrupador
from 	prescr_mat_diluicao c,
		prescr_material b,
		prescr_medica a
where 	a.nr_prescricao	= nr_prescricao_p
and		a.nr_prescricao	= b.nr_prescricao
and		b.nr_prescricao	= c.nr_prescricao
and		b.nr_sequencia	= nr_sequencia_p
and		b.nr_sequencia	= c.nr_seq_material
and		b.ie_agrupador	in (1,5,8,12, 14)
order by ie_ordem;

c01 CURSOR FOR
SELECT	a.cd_material,
		a.qt_dose,
		coalesce(a.qt_vol_adic_reconst,0),
		a.qt_min_aplicacao,
		a.qt_hora_aplicacao,
		a.cd_unidade_medida_dose,
		a.ie_agrupador,
		a.qt_solucao,
		obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose),
		substr(b.ds_material,1,100),
		substr(b.ds_reduzida,1,100),
		ie_diluir_inteiro
FROM material b, prescr_material a
LEFT OUTER JOIN material_diluicao x ON (a.nr_seq_mat_diluicao = x.nr_seq_interno)
WHERE ((a.nr_sequencia_diluicao = nr_sequencia_p) or (a.nr_sequencia = nr_sequencia_p)) and a.nr_prescricao		= nr_prescricao_p  and a.cd_material = b.cd_material and a.ie_agrupador IN (3,4,7,9) order by a.ie_agrupador desc;


BEGIN

select	max(a.ds_diluicao_edit),
		max(a.cd_material),
		max(coalesce(b.ie_aplicar,'S')),
		max(coalesce(a.ie_aplicar,'S'))
into STRICT	ds_diluicao_edit_w,
		cd_mat_ww,
		ie_aplicar_medic_w,
		ie_aplicar_ww
from	prescr_material a,
		material b
where	a.cd_material	= b.cd_material
and		a.nr_prescricao	= nr_prescricao_p
and		a.nr_sequencia	= nr_sequencia_p;

if (ie_aplicar_ww = 'N') then
	ie_aplicar_medic_w	:= 'N';
end if;

--if	(ds_diluicao_edit_w is null) then
	ie_possui_diluente_w	:= 'N';

	open C00;
	loop
	fetch C00 into
		qt_dose_mat_w,
		qt_min_aplicacao_w,
		qt_hora_aplicacao_w,
		cd_unid_med_dose_mat_w,
		qt_solucao_ww,
		cd_unidade_medida_w,
		cd_medic_w,
		cd_estabelecimento_w,
		cd_intervalo_w,
		ie_via_aplicacao_w,
		ds_dose_diferenciada_w,
		ie_indice_w,
		ds_hora_w,
		ie_ordem_w,
		qt_diluicao_aux_w,
		cd_unid_med_diluente_aux_w,
		cd_setor_prescr_w,
		qt_unit_medic_w,
		ie_agrupador_ww;
	EXIT WHEN NOT FOUND; /* apply on C00 */

		select	coalesce(max(nr_casas_diluicao),0),
				coalesce(max(ie_separar),'S'),
				coalesce(max(ie_administrar_ui),'N'),
				coalesce(max(ie_aplicar),'N'),
				coalesce(max(ie_descr_redu_dil),'N'),
				coalesce(max(ie_mostrar_estabilidade),'N'),
				coalesce(max(ie_apres_vol_reconst),'N')
		into STRICT	nr_casas_diluicao_w,
				ie_separar_w,
				ie_administrar_ui_w,
				ie_aplicar_w,
				ie_descr_redu_dil_w,
				ie_mostrar_estabilidade_w,
				ie_apres_vol_reconst_w
		from	parametro_medico
		where	cd_estabelecimento	= cd_estabelecimento_w;

		select	max(obter_casas_diluicao(cd_mat_ww, cd_setor_prescr_w))
		into STRICT	nr_casas_w
		;

		if (nr_casas_w > 0) then
			nr_casas_diluicao_w	:= nr_casas_w;
		end if;

		/*	Para a dose especial, não se deve trazer o intervalo

		if	(cd_intervalo_w is not null) then
			select	max(ds_prescricao)
			into	ds_intervalo_w
			from	intervalo_prescricao
			where	cd_intervalo	= cd_intervalo_w;

			if	(ie_via_aplicacao_w is not null) then
				ds_intervalo_w	:= ds_intervalo_w ||' '||ie_via_aplicacao_w;
			end if;
		end if;*/
		if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
			ds_via_w := ' (' || ie_via_aplicacao_w || ') ';
		end if;

		select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
		into STRICT	qt_conv_ml_w
		;

		select	coalesce(max(ie_um_prescrita),'N')
		into STRICT	ie_um_prescrita_w
		from	regra_unid_med_diluente
		where	cd_setor_atendimento 	= cd_setor_prescr_w
		and	cd_unidade_medida	= cd_unid_med_dose_mat_w;

		if (ie_um_prescrita_w = 'S') then
			qt_conv_ml_w	:= 0;
		end if;

		if (qt_conv_ml_w > 0) and (upper(cd_unid_med_dose_mat_w) <> upper(obter_unid_med_usua('ML'))) then
			if (qt_conv_ml_w >= 1) then
				if (nr_casas_diluicao_w = 0) then
					ds_conv_ml_w	:= to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
				else
					ds_conv_ml_w	:= to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||obter_unid_med_usua('ml');
				end if;
			elsif (nr_casas_diluicao_w = 0) then
				ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
			else
				ds_conv_ml_w	:= '0'||to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||obter_unid_med_usua('ml');
			end if;
		end if;

		qt_dose_mat_str_w	:= qt_dose_mat_w;

		open c01;
		loop
		fetch c01 into
			cd_material_w,
			qt_dose_w,
			qt_vol_adic_reconst_w,
			qt_min_aplicacao_ant_w,
			qt_hora_aplicacao_ant_w,
			cd_unid_med_dose_w,
			ie_agrupador_w,
			qt_solucao_w,
			qt_dose_ml_w,
			ds_material_ww,
			ds_reduzida_w,
			ie_ConsisteDoseConsumoMedic_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			if (ie_ConsisteDoseConsumoMedic_w = 'S') then
				qt_dose_mat_w	:= obter_dose_convertida(cd_medic_w, ceil(qt_unit_medic_w),
									cd_unidade_medida_w,cd_unid_med_dose_mat_w);
				select	obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w)
				into STRICT	qt_conv_ml_w
				;

				select	coalesce(max(ie_um_prescrita),'N')
				into STRICT	ie_um_prescrita_w
				from	regra_unid_med_diluente
				where	cd_setor_atendimento 	= cd_setor_prescr_w
				and	cd_unidade_medida	= cd_unid_med_dose_mat_w;

				if (ie_um_prescrita_w = 'S') then
					qt_conv_ml_w	:= 0;
				end if;

				if (qt_conv_ml_w > 0) and (upper(cd_unid_med_dose_mat_w) <> upper(obter_unid_med_usua('ML'))) then
					if (qt_conv_ml_w >= 1) then
						if (nr_casas_diluicao_w = 0) then
							ds_conv_ml_w	:= to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
						else
							ds_conv_ml_w	:= to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||obter_unid_med_usua('ml');
						end if;
					elsif (nr_casas_diluicao_w = 0) then
						ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
					else
						ds_conv_ml_w	:= '0'||to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||obter_unid_med_usua('ml');
					end if;
				end if;

				qt_dose_mat_str_w	:= qt_dose_mat_w;
			end if;

			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 9) and (coalesce(qt_registro_w,0) = 0) then
				begin
				select	obter_conversao_ml(cd_material_w,qt_dose_w + qt_vol_adic_reconst_w,cd_unid_med_dose_w)
				into STRICT	qt_conv_ml_w
				;

				select	coalesce(max(ie_um_prescrita),'N')
				into STRICT	ie_um_prescrita_w
				from	regra_unid_med_diluente
				where	cd_setor_atendimento 	= cd_setor_prescr_w
				and	cd_unidade_medida	= cd_unid_med_dose_w;

				if (ie_um_prescrita_w = 'S') then
					qt_conv_ml_w	:= 0;
				end if;

				if (upper(cd_unid_med_dose_mat_w) = upper(obter_unid_med_usua('ML'))) then
					begin
					qt_conv_ml_w	:= qt_dose_mat_w;
					end;
				else
					begin
					qt_dose_unid_med_cons_w	:= obter_conversao_unid_med_cons(cd_medic_w,cd_unid_med_dose_mat_w,qt_dose_mat_w);
					qt_conv_ml_w		:= qt_dose_unid_med_cons_w * qt_conv_ml_w;
					end;
				end if;

				if (qt_conv_ml_w > 0) then
					if (qt_conv_ml_w >= 1) then
						if (nr_casas_diluicao_w = 0) then
							ds_conv_ml_w	:= to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
						else
							ds_conv_ml_w	:= to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||obter_unid_med_usua('ml');
						end if;
					elsif (nr_casas_diluicao_w = 0) then
						ds_conv_ml_w	:= '0'||to_char(qt_conv_ml_w)||' '||obter_unid_med_usua('ml');
					else
						ds_conv_ml_w	:= '0'||to_char(round(qt_conv_ml_w,nr_casas_diluicao_w))||' '||obter_unid_med_usua('ml');
					end if;
				end if;

				select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
			   	into STRICT	ds_material_w
			   	;

				if (qt_dose_w < 1) or (mod(qt_dose_w, trunc(qt_dose_w)) <> 0) then
					mascara_w	:= 0;
				else
					mascara_w	:= 1;
				end if;

				Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_dose_w, 2)  ELSE campo_mascara(qt_dose_w, 0) END
				into STRICT	qt_dose_str_w
				;

				select	max(qt_conversao)
				into STRICT	qt_conversao_w
				from	material_conversao_unidade
				where	cd_material		= cd_medic_w
				and	cd_unidade_medida	= cd_unidade_medida_w;

				if (ie_apres_vol_reconst_w = 'S') and (qt_vol_adic_reconst_w > 0) then

					select	obter_conversao_ml(cd_material_w,qt_dose_w + qt_vol_adic_reconst_w,cd_unid_med_dose_w)
					into STRICT	qt_volume_adic_w
					;

					ds_total_reconst_w := ' ' || Wheb_mensagem_pck.get_texto(309288, 'QT_VOLUME_ADIC_W='||qt_volume_adic_w); --' (Volume total após reconstituição '|| qt_volume_adic_w ||' ml).';
				end if;

				if (coalesce(qt_conversao_w::text, '') = '') then
					ds_reconstituir_w := 	ds_reconstituir_w ||Wheb_mensagem_pck.get_texto(306838) || ' ' /*'Reconstituir cada '*/ ||cd_unidade_medida_w||
							' ' || Wheb_mensagem_pck.get_texto(306840) || ' ' /*' em '*/||replace(qt_dose_str_w,'.',',')||' '||cd_unid_med_dose_w||
							' ' || Wheb_mensagem_pck.get_texto(306840) || ' ' /*' em '*/||ds_material_w || coalesce(ds_total_reconst_w,'.') || chr(13) || chr(10);
				else
					ds_reconstituir_w := 	ds_reconstituir_w ||Wheb_mensagem_pck.get_texto(306838) || ' ' /*'Reconstituir cada '*/ || qt_conversao_w || ' ' ||cd_unidade_medida_w||
							' ' || Wheb_mensagem_pck.get_texto(306840) || ' ' /*' em '*/||replace(qt_dose_str_w,'.',',')||' '||cd_unid_med_dose_w||
							' ' || Wheb_mensagem_pck.get_texto(306844) || ' ' /*' de '*/||ds_material_w || coalesce(ds_total_reconst_w,'.') || chr(13) || chr(10);
				end if;

				end;
			end if;

			if (ie_indice_w		= 2) and (coalesce(qt_registro_w,0)	= 0) and (coalesce(ds_rediluir_w::text, '') = '') then

				select	max(a.cd_material),
					max(a.qt_dose),
					max(a.cd_unidade_medida_dose),
					max(a.qt_solucao),
					max(obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose)),
					max(substr(b.ds_material,1,100)),
					max(substr(b.ds_reduzida,1,100))
				into STRICT	cd_material_red_w,
					qt_dose_red_w,
					cd_unid_med_dose_red_w,
					qt_solucao_red_w,
					qt_dose_ml_red_w,
					ds_material_red_ww,
					ds_reduzida_red_w
				from 	material b,
					prescr_material a
				where 	((a.nr_sequencia_diluicao = nr_sequencia_p) or (a.nr_sequencia = nr_sequencia_p))
				  and 	a.nr_prescricao = nr_prescricao_p
				  and	a.cd_material = b.cd_material
				  and	a.ie_agrupador = 7;

				if (cd_material_red_w IS NOT NULL AND cd_material_red_w::text <> '') and (qt_dose_red_w IS NOT NULL AND qt_dose_red_w::text <> '') and (cd_unid_med_dose_red_w IS NOT NULL AND cd_unid_med_dose_red_w::text <> '') then

					select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_red_w  ELSE ds_material_red_ww END
					into STRICT	ds_material_red_w
					;

					cd_volume_final_red_w := qt_dose_ml_red_w + qt_solucao_red_w;

					if (qt_solucao_red_w < 1) or (mod(qt_solucao_red_w, trunc(qt_solucao_red_w)) <> 0) then
						mascara_w	:= 0;
					else
						mascara_w	:= 1;
					end if;

					ds_dose_diluicao_w	:= replace(qt_dose_ml_red_w,'.',',') ||' '||obter_unid_med_usua('ml');
					if (qt_dose_ml_red_w = 0) then
						begin
						ds_dose_diluicao_w	:= replace(qt_dose_red_w,'.',',') ||' '||cd_unid_med_dose_red_w;
						end;
					end if;

					select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_solucao_red_w, 2)  ELSE campo_mascara(qt_solucao_red_w, 0) END
					into STRICT	qt_solucao_str_w
					;

					if (ie_separar_w = 'S') then
						ds_rediluir_w := ds_rediluir_w||Wheb_mensagem_pck.get_texto(306845) || ' ' /*'Separar '*/||replace(qt_solucao_str_w,'.',',')||' '||obter_unid_med_usua('ml')|| ' ' || Wheb_mensagem_pck.get_texto(306846) || ' ' /*' desta solução em '*/||
								ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(306844) || ' ' /*' de '*/||ds_material_red_w || chr(13) || chr(10);
					else
						ds_rediluir_w := ds_rediluir_w||Wheb_mensagem_pck.get_texto(306848) || ' ' /*'Rediluir '*/||replace(qt_solucao_str_w,'.',',')||' '||obter_unid_med_usua('ml')|| ' ' || Wheb_mensagem_pck.get_texto(306846) || ' ' /*' desta solução em '*/||
								ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(306844) || ' ' /*' de '*/||ds_material_red_w || chr(13) || chr(10);
					end if;
				end if;
			end if;

			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 3) then
			   	begin
				qt_ml_diluente_w	:= qt_dose_ml_w;
				select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
			   	into STRICT	ds_material_w
			   	;

				if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
					ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307082); --' do produto';
				else
					ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307083); --' do medicamento';
				end if;
				if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
					ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307085); --' da reconstituição';
				end if;
				if (nr_casas_diluicao_w = 0) then
					ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' '||obter_unid_med_usua('ml');
				else
					ds_dose_diluicao_w	:= replace(round(qt_dose_ml_w,nr_casas_diluicao_w),'.',',') ||' '||obter_unid_med_usua('ml');
				end if;

				if (qt_dose_ml_w = 0) then
					begin
					ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') ||' '||cd_unid_med_dose_w;
					end;
				end if;

				if (coalesce(qt_solucao_w,0)	> 0) then /*Caldas - OS153626 13/07/2009 */
					if (qt_solucao_w >= 1) then
						if (nr_casas_diluicao_w = 0) then
							ds_conv_ml_w	:= to_char(qt_solucao_w)||' '||obter_unid_med_usua('ml');
						else
							ds_conv_ml_w	:= to_char(round(qt_solucao_w,nr_casas_diluicao_w))||' '||obter_unid_med_usua('ml');
						end if;
					elsif (nr_casas_diluicao_w = 0) then
						ds_conv_ml_w	:= '0'||to_char(qt_solucao_w)||' '||obter_unid_med_usua('ml');
					else
						ds_conv_ml_w	:= '0'||to_char(round(qt_solucao_w,nr_casas_diluicao_w))||' '||obter_unid_med_usua('ml');
					end if;

					qt_conv_ml_w	:= qt_solucao_w;
				end if;

				select	coalesce(max(ie_um_prescrita),'N')
				into STRICT	ie_um_prescrita_w
				from	regra_unid_med_diluente
				where	cd_setor_atendimento 	= cd_setor_prescr_w
				and	cd_unidade_medida	= cd_unid_med_dose_mat_w;

				if (ie_um_prescrita_w = 'S') then
					qt_conv_ml_w	:= 0;
					ds_conv_ml_w	:= '';
				end if;

				if (ie_indice_w = 2) then
					if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
						ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307082); --' do produto';
					else
						ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307083); --' do medicamento';
					end if;
					if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
						ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307085); --' da reconstituição';
					end if;

					if (qt_min_aplicacao_w IS NOT NULL AND qt_min_aplicacao_w::text <> '') then
						ds_tempo_w	:= Wheb_mensagem_pck.get_texto(307087) || ' ' /*'em '*/ || to_char(qt_min_aplicacao_w) || ' ' || Wheb_mensagem_pck.get_texto(307086) || ' ' /*' min. no horário '*/ || ds_hora_w;
					end if;

					if (nr_casas_diluicao_w > 0) then
						ds_volume_w	:= ' '||to_char(round(qt_conv_ml_w + qt_ml_diluente_w,nr_casas_diluicao_w)) ||' '||obter_unid_med_usua('ml');
						if (ie_ConsisteDoseConsumoMedic_w = 'S') then
							ds_volume_w	:= ' '||to_char(round((((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_w)),nr_casas_diluicao_w)) ||' '||obter_unid_med_usua('ml');
						end if;
						if (ie_administrar_ui_w = 'S') then
							select	count(*)
							into STRICT	cont_ww
							from	material_conversao_unidade
							where	cd_material	= cd_mat_ww
							and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'));

							if (cont_ww > 0) then
								select	count(*)
								into STRICT	cont_ww
								from	regra_setor_conv_unid
								where	cd_material	= cd_mat_ww
								and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))
								and	cd_setor_atendimento = cd_setor_prescr_w;

								if (cont_ww > 0) then
									ds_adm_ui_w	:= ' '||to_char(Obter_dose_convertida(cd_mat_ww,round(qt_conv_ml_w + qt_ml_diluente_w,nr_casas_diluicao_w), obter_unid_med_usua('ml'),upper(obter_unid_med_usua('UI')))) ||' '||upper(obter_unid_med_usua('UI'));
								end if;
							end if;
						end if;
					else
						ds_volume_w	:= ' '||to_char(qt_conv_ml_w + qt_ml_diluente_w) ||' '||obter_unid_med_usua('ml');
						if (ie_ConsisteDoseConsumoMedic_w = 'S') then
							ds_volume_w	:= ' '||to_char((((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_w))) ||' '||obter_unid_med_usua('ml');
						end if;
						if (ie_administrar_ui_w = 'S') then
							select	count(*)
							into STRICT	cont_ww
							from	material_conversao_unidade
							where	cd_material = cd_mat_ww
							and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'));

							if (cont_ww > 0) then

								select	count(*)
								into STRICT	cont_ww
								from	regra_setor_conv_unid
								where	cd_material	= cd_mat_ww
								and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))
								and	cd_setor_atendimento = cd_setor_prescr_w;

								if (cont_ww > 0) then
									ds_adm_ui_w	:= ' '||to_char(Obter_dose_convertida(cd_mat_ww, (qt_conv_ml_w + qt_ml_diluente_w),obter_unid_med_usua('ml'),upper(obter_unid_med_usua('UI')))) ||' '||upper(obter_unid_med_usua('UI'));
								end if;
							end if;
						end if;
					end if;

					if (ds_volume_w IS NOT NULL AND ds_volume_w::text <> '') then
						ds_aplicar_w	:= Wheb_mensagem_pck.get_texto(307088) /*'Administrar'*/
|| replace(ds_volume_w,'.',',') || ' '|| ds_tempo_w;
						if (ds_adm_ui_w IS NOT NULL AND ds_adm_ui_w::text <> '') then
							ds_aplicar_w	:= ds_aplicar_w || chr(13) || ' ' || Wheb_mensagem_pck.get_texto(307088) /*' Administrar'*/|| replace(ds_adm_ui_w,'.',',') || ' '|| ds_tempo_w;
						end if;
					elsif (ds_tempo_w IS NOT NULL AND ds_tempo_w::text <> '') then
						ds_aplicar_w	:= Wheb_mensagem_pck.get_texto(307088) /*'Administrar'*/
||ds_tempo_w;
					end if;

					select	max(obter_conversao_ml(cd_material_w,qt_diluicao_aux_w,cd_unid_med_diluente_aux_w))
					into STRICT	qt_dose_ml_w
					;

					if (nr_casas_diluicao_w = 0) then
						ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' '||obter_unid_med_usua('ml');
					else
						ds_dose_diluicao_w	:= replace(round(qt_dose_ml_w,nr_casas_diluicao_w),'.',',') ||' '||obter_unid_med_usua('ml');
					end if;

					if (qt_dose_ml_w = 0) then
						ds_dose_diluicao_w	:= replace(qt_diluicao_aux_w,'.',',') ||' '||cd_unid_med_diluente_aux_w;
					end if;


					if (ie_separar_w = 'S') then
						ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/||replace(qt_dose_mat_str_w,'.',',')||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
								ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10) ||
								ds_rediluir_w || ds_aplicar_w || chr(13) || chr(10);
					else
						ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/||replace(qt_dose_mat_str_w,'.',',')||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
								ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10) ||
								ds_rediluir_w || ds_aplicar_w || chr(13) || chr(10);
					end if;

				elsif (coalesce(ds_conv_ml_w::text, '') = '') and (coalesce(ds_diluir_w::text, '') = '') then
					if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
						if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
							ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307093)); --'produto';
						else
							ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307095)); --'medicamento';
						end if;

						if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
							ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307096)); --'reconstituição';
						end if;
						if (ie_separar_w = 'S') then
							ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/|| ds_aux_diluir_w || ' ' || Wheb_mensagem_pck.get_texto(307099) || ' ('  /*' conforme dose do horário ('*/||ds_dose_diferenciada_w|| ') ' ||Wheb_mensagem_pck.get_texto(307087) || ' ' /*') em '*/||
								ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
						else
							ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/|| ds_aux_diluir_w || ' ' || Wheb_mensagem_pck.get_texto(307099) || ' (' /*' conforme dose do horário ('*/||ds_dose_diferenciada_w|| ') ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*') em '*/||
								ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
						end if;
					elsif (ie_separar_w = 'S') then
						ds_diluir_w := 	ds_diluir_w || Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/||replace(qt_dose_mat_str_w,'.',',')||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
							ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
					else
						ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/||replace(qt_dose_mat_str_w,'.',',')||' '||cd_unid_med_dose_mat_w|| ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
							ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
					end if;
				elsif (coalesce(ds_diluir_w::text, '') = '') then

					if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
						if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
							ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307093)); --'produto';
						else
							ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307095)); --'medicamento';
						end if;

						if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
							ds_aux_diluir_w	:= lower(Wheb_mensagem_pck.get_texto(307096)); --'reconstituição';
						end if;

						if (ie_separar_w = 'S') then
							ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/||ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307099) || ' (' /*' conforme dose do horário ('*/||ds_dose_diferenciada_w|| ') ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*') em '*/||
								ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
						else
							ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/||ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307099) || ' (' /*' conforme dose do horário ('*/||ds_dose_diferenciada_w|| ') ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*') em '*/||
								ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
						end if;
					elsif (ie_separar_w = 'S') then
						ds_diluir_w := 	ds_diluir_w || Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/ ||ds_conv_ml_w ||ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
							ds_dose_diluicao_w|| ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
					else
						ds_diluir_w := 	ds_diluir_w || Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/ ||ds_conv_ml_w ||ds_aux_diluir_w|| ' ' || Wheb_mensagem_pck.get_texto(307087) || ' ' /*' em '*/||
							ds_dose_diluicao_w|| Wheb_mensagem_pck.get_texto(307090) /*' de '*/
||ds_material_w || chr(13) || chr(10);
					end if;
				elsif (ie_separar_w = 'S') then
					ds_diluir_w := 	ds_diluir_w || Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/ || Wheb_mensagem_pck.get_texto(307104) || ' ' /*'a solução em '*/||
						ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
				else
					ds_diluir_w := 	ds_diluir_w ||Wheb_mensagem_pck.get_texto(307092) || ' ' /*'Diluir '*/ || Wheb_mensagem_pck.get_texto(307104) || ' ' /*'a solução em '*/||
						ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
				end if;
			   	end;
			end if;

			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 7) and (ie_indice_w <> 2) then
			   	begin
				select 	CASE WHEN ie_descr_redu_dil_w='S' THEN ds_reduzida_w  ELSE ds_material_ww END
			   	into STRICT	ds_material_w
			   	;

				cd_volume_final_w := qt_dose_ml_w + qt_solucao_w;

				if (qt_solucao_w < 1) or (mod(qt_solucao_w, trunc(qt_solucao_w)) <> 0) then
					mascara_w	:= 0;
				else
					mascara_w	:= 1;
				end if;

				ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' '||obter_unid_med_usua('ml');
				if (qt_dose_ml_w = 0) then
					begin
					ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') ||' '||cd_unid_med_dose_w;
					end;
				end if;

				Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(qt_solucao_w, 2)  ELSE campo_mascara(qt_solucao_w, 0) END
				into STRICT	qt_solucao_str_w
				;

				if (ie_separar_w = 'S') then
					ds_rediluir_w := ds_rediluir_w||Wheb_mensagem_pck.get_texto(307089) || ' ' /*'Separar '*/||replace(qt_solucao_str_w,'.',',')||' '||obter_unid_med_usua('ml')|| ' ' || Wheb_mensagem_pck.get_texto(307105) || ' ' /*' desta solução em '*/||
							ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
				else
					ds_rediluir_w := ds_rediluir_w||Wheb_mensagem_pck.get_texto(307184) || ' ' /*'Rediluir '*/||replace(qt_solucao_str_w,'.',',')||' '||obter_unid_med_usua('ml')||' ' || Wheb_mensagem_pck.get_texto(307105) || ' ' /*' desta solução em '*/||
							ds_dose_diluicao_w || ' ' || Wheb_mensagem_pck.get_texto(307090) || ' ' /*' de '*/||ds_material_w || chr(13) || chr(10);
				end if;
			   	end;
			end if;
			end;

			ie_possui_diluente_w	:= 'S';

		end loop;
		close c01;

		qt_registro_w	:= qt_registro_w + 1;

	end loop;
	close C00;

	ds_aplicar_w	:= '';

	if (cd_volume_final_w < 1) or (mod(cd_volume_final_w, trunc(cd_volume_final_w)) <> 0) then
		mascara_w	:= 0;
	else
		mascara_w	:= 1;
	end if;

	Select 	CASE WHEN mascara_w=0 THEN  campo_mascara(cd_volume_final_w, 2)  ELSE campo_mascara(cd_volume_final_w, 0) END
	into STRICT	cd_volume_final_str_w
	;

/*	Hudson comentou

	if	(qt_min_aplicacao_w is not null) and
		(qt_hora_aplicacao_w is not null) and
		((nvl(qt_min_aplicacao_w,0) > 0) and
		(nvl(qt_hora_aplicacao_w,0) > 0))then
		ds_tempo_w	:=  ' em ' || to_char(qt_hora_aplicacao_w) || ' h. e '|| to_char(qt_min_aplicacao_w) || ' min.';
	elsif	(qt_min_aplicacao_w is null) and
		(qt_hora_aplicacao_w is not null) then
		ds_tempo_w	:= ' em ' || to_char(qt_hora_aplicacao_w) || ' h.';
	elsif	(qt_min_aplicacao_w is not null) and
		(qt_hora_aplicacao_w is null) then
		ds_tempo_w	:= ' em ' || to_char(qt_min_aplicacao_w) || ' min.';
	end if;

*/
	ds_volume_w := null;
	if (qt_solucao_ww IS NOT NULL AND qt_solucao_ww::text <> '') and (qt_solucao_ww > 0) then
		if (nr_casas_diluicao_w > 0) then
			ds_volume_w	:= ' '||to_char(round(qt_solucao_ww,nr_casas_diluicao_w)) ||' '||obter_unid_med_usua('ml');
			qt_volume_ww	:= round(qt_solucao_ww,nr_casas_diluicao_w);
		else
			ds_volume_w	:= ' '||to_char(qt_solucao_ww) ||' '||obter_unid_med_usua('ml');
			qt_volume_ww	:= qt_solucao_ww;
		end if;
	elsif (ie_aplicar_w = 'S') then
		begin
		if (ds_rediluir_w IS NOT NULL AND ds_rediluir_w::text <> '') then
			ds_volume_w	:= ' '||cd_volume_final_str_w ||' '||obter_unid_med_usua('ml');
		elsif (ds_diluir_w IS NOT NULL AND ds_diluir_w::text <> '') then
			if (nr_casas_diluicao_w > 0) then
				ds_volume_w	:= ' '||to_char(round(qt_conv_ml_w + qt_ml_diluente_w,nr_casas_diluicao_w)) ||' '||obter_unid_med_usua('ml');
				qt_volume_ww	:= round(qt_conv_ml_w + qt_ml_diluente_w,nr_casas_diluicao_w);
				if (ie_ConsisteDoseConsumoMedic_w = 'S') then
					ds_volume_w	:= ' '||to_char(round(((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_w),nr_casas_diluicao_w)) ||' '||obter_unid_med_usua('ml');
					qt_volume_ww	:= round(((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_w),nr_casas_diluicao_w);
				end if;
			else
				ds_volume_w	:= ' '||to_char(qt_conv_ml_w + qt_ml_diluente_w) ||' '||obter_unid_med_usua('ml');
				qt_volume_ww	:= qt_conv_ml_w + qt_ml_diluente_w;
				if (ie_ConsisteDoseConsumoMedic_w = 'S') then
					ds_volume_w	:= ' '||to_char((((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_w))) ||' '||obter_unid_med_usua('ml');
					qt_volume_ww	:= (((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_w));
				end if;
			end if;
		elsif (ds_conv_ml_w IS NOT NULL AND ds_conv_ml_w::text <> '') then
			ds_volume_w	:= ' '||ds_conv_ml_w;
		end if;

		end;
	end if;

	if (ie_indice_w <> 2) or (ie_possui_diluente_w = 'N') then
		if (ds_volume_w IS NOT NULL AND ds_volume_w::text <> '') then
			ds_aplicar_w	:= Wheb_mensagem_pck.get_texto(307088) /*'Administrar'*/
|| replace(ds_volume_w,'.',',') || ds_via_w || ds_tempo_w;
			if (ie_administrar_ui_w = 'S') then

				select	count(*)
				into STRICT	cont_ww
				from	material_conversao_unidade
				where	cd_material	= cd_mat_ww
				and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'));

				if (cont_ww > 0) then

					select	count(*)
					into STRICT	cont_ww
					from	regra_setor_conv_unid
					where	cd_material	= cd_mat_ww
					and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('UI'))
					and	cd_setor_atendimento = cd_setor_prescr_w;

					if (cont_ww > 0) then
						ds_adm_ui_w	:= Wheb_mensagem_pck.get_texto(307088) || ' ' /*'Administrar '*/|| to_char(Obter_dose_convertida(cd_mat_ww,qt_volume_ww, obter_unid_med_usua('ml'),upper(obter_unid_med_usua('UI')))) ||' '||upper(obter_unid_med_usua('UI')) || ds_via_w || ds_tempo_w;
						ds_aplicar_w	:= ds_aplicar_w || chr(13) || chr(10) ||ds_adm_ui_w;
					end if;
				end if;
			end if;


		elsif (ds_tempo_w IS NOT NULL AND ds_tempo_w::text <> '') then
			ds_aplicar_w	:= Wheb_mensagem_pck.get_texto(307088) /*'Administrar'*/
||ds_tempo_w;
		end if;
	else
		ds_rediluir_w	:= '';
	end if;

	if (ie_aplicar_medic_w = 'N') then
		ds_aplicar_w	:= '';
	end if;

	ds_retorno_w 	:= ds_reconstituir_w || ds_diluir_w || ds_rediluir_w || ds_aplicar_w;
	ds_retorno_w	:= replace(ds_retorno_w,' ,',' 0,');
	ds_retorno_w	:= replace(ds_retorno_w,' .',' 0,');

	select	cd_material
	into STRICT	cd_material_w
	from	prescr_material
	where	nr_sequencia = nr_sequencia_p
	and	nr_prescricao = nr_prescricao_p;

	if (ie_mostrar_estabilidade_w = 'S') then

		select  coalesce(max(nr_seq_estagio),0),
				max(substr(obter_estagio_armazenamento(nr_seq_estagio),1,255)),
				max(qt_estabilidade),
				max(substr(obter_valor_dominio(1246,ie_tempo_estab),1,255))
		into STRICT	qt_estagio_armazenamento_w,
				ds_estagio_armazenamento_w,
				qt_estabilidade_w,
				ds_tempo_estabilidade_w
		from 	mat_estagio_armaz b,
				material_armazenamento a
		where 	b.nr_sequencia	= a.nr_seq_estagio
		and		a.cd_material	= cd_material_w
		and		b.ie_estagio	= '1'
		and		coalesce(a.cd_estabelecimento,coalesce(cd_estabelecimento_w,0)) = coalesce(cd_estabelecimento_w,0);

		if (ie_possui_diluente_w = 'S') and (qt_estagio_armazenamento_w > 0) then
			if (coalesce(ds_retorno_w::text, '') = '') then
				ds_retorno_w := Wheb_mensagem_pck.get_texto(307113) || ' ' /*'Estabilidade: '*/ || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w;
			else
				ds_retorno_w := ds_retorno_w || chr(13) || chr(10) ||Wheb_mensagem_pck.get_texto(307113) || ' ' /*'Estabilidade: '*/ || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w;
			end if;
		elsif (qt_estagio_armazenamento_w = 0) and (ie_possui_diluente_w = 'S') then
			select  coalesce(max(nr_seq_estagio),0),
					max(substr(obter_estagio_armazenamento(nr_seq_estagio),1,255)),
					max(qt_estabilidade),
					max(substr(obter_valor_dominio(1246,ie_tempo_estab),1,255))
			into STRICT	qt_estagio_armazenamento_w,
					ds_estagio_armazenamento_w,
					qt_estabilidade_w,
					ds_tempo_estabilidade_w
			from 	mat_estagio_armaz b,
					material_armazenamento a
			where 	b.nr_sequencia	= a.nr_seq_estagio
			and		a.cd_material	= cd_material_w
			and		b.ie_estagio	= '2'
			and		coalesce(a.cd_estabelecimento,coalesce(cd_estabelecimento_w,0)) = coalesce(cd_estabelecimento_w,0);

			if (qt_estagio_armazenamento_w > 0) then
				if (coalesce(ds_retorno_w::text, '') = '') then
					ds_retorno_w := Wheb_mensagem_pck.get_texto(307113) || ' ' /*'Estabilidade: '*/ || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w;
				else
					ds_retorno_w := ds_retorno_w || chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(307113) || ' ' /*'Estabilidade: '*/ || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' '|| ds_estagio_armazenamento_w;
				end if;
			end if;

		end if;
	end if;

	select  coalesce(max(ie_higroscopico),'N'),
			coalesce(max(ie_fotosensivel),'N'),
			coalesce(max(ie_termolabil),'N')
	into STRICT	ie_higroscopico_w,
			ie_fotosensivel_w,
			ie_termolabil_w
	from 	material
	where 	cd_material = cd_material_w;

	ds_inf_adic_w := Wheb_mensagem_pck.get_texto(307095) || ' '; --'Medicamento ';
	if (ie_fotosensivel_w = 'S') then
		ds_inf_adic_w := ds_inf_adic_w ||lower(Wheb_mensagem_pck.get_texto(307117)); --'fotossensível';
	end if;
	if (ie_higroscopico_w = 'S') then
		if	(ds_inf_adic_w <> (Wheb_mensagem_pck.get_texto(307095) || ' ') /*'Medicamento '*/) then
			ds_inf_adic_w := ds_inf_adic_w || ', ' || lower(Wheb_mensagem_pck.get_texto(307119)); --', higroscópico';
		else
			ds_inf_adic_w := ds_inf_adic_w ||lower(Wheb_mensagem_pck.get_texto(307119)); --'higroscópico';
		end if;
	end if;
	if (ie_termolabil_w = 'S') then
		if	(ds_inf_adic_w <> (Wheb_mensagem_pck.get_texto(307095) || ' ') /*'Medicamento '*/) then
			ds_inf_adic_w := ds_inf_adic_w || ' ' ||Wheb_mensagem_pck.get_texto(307120); --' e termolábil';
		else
			ds_inf_adic_w := ds_inf_adic_w ||lower(Wheb_mensagem_pck.get_texto(307121)); --'termolábil';
		end if;
	end if;
	ds_inf_adic_w := ds_inf_adic_w ||'.';
	if	(ds_inf_adic_w <> (Wheb_mensagem_pck.get_texto(307095) || ' .') /*'Medicamento .'*/) then
		if (coalesce(ds_retorno_w::text, '') = '') then
			ds_retorno_w := ds_inf_adic_w;
		else
			ds_retorno_w := ds_retorno_w || chr(13) || chr(10) ||ds_inf_adic_w;
		end if;
	end if;

/*else
	ds_retorno_w	:= ds_diluicao_edit_w;
end if;*/
RETURN substr(ds_retorno_w,1,2000);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_dil_dose_esp_medic ( nr_sequencia_p bigint, nr_prescricao_p bigint, nr_seq_horario_p bigint) FROM PUBLIC;

