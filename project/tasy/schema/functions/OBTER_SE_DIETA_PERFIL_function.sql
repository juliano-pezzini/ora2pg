-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_dieta_perfil (cd_perfil_p bigint, cd_setor_P bigint, cd_dieta_p bigint, nm_usuario_p text, cd_convenio_p bigint, ie_opcao_p text, ie_justificativa_p text) RETURNS varchar AS $body$
DECLARE


ie_mostra_dieta_w		varchar(10);
count_w					bigint;
nr_seq_agrupamento_w	bigint;
ie_obriga_justif_w		dieta_perfil.ie_obriga_justif%type;
ds_alerta_w				dieta_perfil.ds_msg_inconsistencia%type;
ds_retorno_w			varchar(1000) := 'S';

c01 CURSOR FOR
SELECT	coalesce(ie_mostra_dieta,'S'),
		coalesce(ie_obriga_justif,'N'),
		ds_msg_inconsistencia
from	dieta_perfil
where	cd_dieta	= cd_dieta_p
and	((cd_setor_atendimento = cd_setor_p) or (coalesce(cd_setor_atendimento::text, '') = '') or (coalesce(cd_setor_p::text, '') = ''))
and	((cd_setor_excluir <> cd_setor_p) or (coalesce(cd_setor_excluir::text, '') = '') or (coalesce(cd_setor_p::text, '') = ''))
and	((cd_perfil	= cd_perfil_p) or (coalesce(cd_perfil::text, '') = ''))
and	((coalesce(nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento = nr_seq_agrupamento_w))
and	((coalesce(cd_convenio::text, '') = '') or (cd_convenio = cd_convenio_p))
and	((coalesce(cd_pessoa_fisica::text, '') = '') or (cd_pessoa_fisica = obter_pf_usuario(nm_usuario_p,'C')))
order by coalesce(cd_pessoa_fisica,0),
	coalesce(cd_setor_atendimento,0),
	coalesce(cd_setor_excluir,0),
	coalesce(cd_perfil,0);


BEGIN

select	coalesce(count(*),0)
into STRICT	count_w
from	dieta_perfil
where	cd_dieta = cd_dieta_p;

select	max(nr_seq_agrupamento)
into STRICT	nr_seq_agrupamento_w
from	setor_atendimento
where	cd_setor_atendimento	= cd_setor_p;

if (coalesce(count_w,0) > 0) then
	
	if (ie_opcao_p = 'J') then
        ds_retorno_w := coalesce(ie_justificativa_p,'N');
    end if;
	
	open C01;
	loop
	fetch C01 into	
		ie_mostra_dieta_w,
		ie_obriga_justif_w,
		ds_alerta_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	
		if (ie_opcao_p = 'A') then
			ds_retorno_w := coalesce(ie_mostra_dieta_w,'N');
		elsif (ie_opcao_p = 'J') then
			
			if (coalesce(ie_obriga_justif_w,'N') = 'S') then
				
				ds_retorno_w := substr('S-'||ds_alerta_w,1,255);
			else
				ds_retorno_w := 'N';
			end if;
		end if;
	end loop;
	close C01;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_dieta_perfil (cd_perfil_p bigint, cd_setor_P bigint, cd_dieta_p bigint, nm_usuario_p text, cd_convenio_p bigint, ie_opcao_p text, ie_justificativa_p text) FROM PUBLIC;

