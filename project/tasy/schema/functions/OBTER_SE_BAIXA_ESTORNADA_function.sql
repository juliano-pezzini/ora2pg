-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_baixa_estornada ( nr_titulo_p bigint, nr_sequencia_p bigint, ie_tipo_titulo_p text) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w			varchar(1);
qt_reg_w				bigint;
nr_seq_liq_origem_w		titulo_receber_liq.nr_seq_liq_origem%type;

/* IE_TIPO_TITULO_P 
Inicialmente, para atender a demanda da OS 1321467, essa funcion trata apenas títulos a receber. 
Porém, caso haver necessidade, pode tratar para Tìtulo a Pagar, passando o parametro ie_tipo_titulo_p como P. 
 
R = Títulos a Receber 
P = Títulos a Pagar 
*/
									 
									 

BEGIN 
 
if ( coalesce(nr_titulo_p,0) <> 0) and ( coalesce(nr_sequencia_p,0) <> 0) then 
 
	if (ie_tipo_titulo_p = 'R') then 
		 
		/*Verificar se a seq da baixa tem seq_liq_origem, pois ai é uma baixa de estorno*/
 
		select	max(a.nr_seq_liq_origem)	 
		into STRICT	nr_seq_liq_origem_w	 
		from	titulo_receber_liq a 
		where	a.nr_titulo 	= nr_titulo_p 
		and		a.nr_sequencia 	= nr_sequencia_p;
		 
		/*Verificar se existe uma outra baixa com liq origem pra essa baixa, indicando que ela foi estornada*/
 
		select	count(*) 
		into STRICT	qt_reg_w 
		from	titulo_receber_liq a 
		where	a.nr_titulo 	= nr_titulo_p 
		and		a.nr_sequencia 	= nr_sequencia_p 
		and		exists ( SELECT 1 
						 from	titulo_receber_liq x 
						 where	x.nr_seq_liq_origem = a.nr_sequencia 
						 and	x.nr_titulo			= a.nr_titulo);
		 
		if ((coalesce(nr_seq_liq_origem_w,0) <> 0) or ( qt_reg_w <> 0)) then 
			ds_retorno_w := 'S';
		else 
			ds_retorno_w := 'N';
		end if;
	 
	end if;
 
end if;
 
return	coalesce(ds_retorno_w,'N');
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_baixa_estornada ( nr_titulo_p bigint, nr_sequencia_p bigint, ie_tipo_titulo_p text) FROM PUBLIC;

