-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_equipamento_exame_mat ( nr_seq_exame_p bigint, ie_busca_dados_p bigint, nr_seq_material_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


cd_equipamento_w		integer;
ds_sigla_w			varchar(10);
ds_equipamento_w		varchar(50);
cd_exame_equip_w		varchar(20);
cd_exame_equip_integr_w		varchar(20);
resultado_w	 		varchar(50);
ds_tempo_w			varchar(255);
ds_conservante_w		varchar(255);


/* opções
	e - busca o equipamento para a sigla

   busca dados
	1 - dados do tempo
	2 - Conservante
*/
c01 CURSOR FOR
	SELECT	coalesce((b.cd_exame_equip),null),
		coalesce((b.ds_tempo),null),
		coalesce((b.ds_conservante_integr),null)
	from 	equipamento_lab a,
	     	lab_exame_equip b
       where 	a.cd_equipamento	= b.cd_equipamento
	 and 	b.nr_seq_exame 		= nr_seq_exame_p
	 and 	((b.nr_seq_material 	=  coalesce(nr_seq_material_p,nr_seq_material)) or (coalesce(nr_seq_material::text, '') = ''))
	 and 	a.ds_sigla 	= ie_opcao_p
       order by coalesce(nr_seq_material,0);


BEGIN

resultado_w :=  null;

open c01;
loop
fetch c01 into
	cd_exame_equip_integr_w,
	ds_tempo_w,
	ds_conservante_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (ie_busca_dados_p = 1) then
		resultado_w := ds_tempo_w;
	elsif (ie_busca_dados_p = 2) then
		resultado_w := ds_conservante_w;
	else
		resultado_w := cd_exame_equip_integr_w;
	end if;
end loop;
close c01;


return resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_equipamento_exame_mat ( nr_seq_exame_p bigint, ie_busca_dados_p bigint, nr_seq_material_p bigint, ie_opcao_p text) FROM PUBLIC;

