-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_qt_ant_regra_contrato (nr_seq_regra_nf_p bigint) RETURNS bigint AS $body$
DECLARE


qt_maxima_w				contrato_regra_nf_qtde.qt_maxima%type;
qt_retorno_w				contrato_regra_nf_qtde.qt_maxima%type := 0;
dt_mesano_referencia_w			timestamp;
ie_parametro_w				varchar(15);


BEGIN

select	obter_valor_param_usuario(1200, 156, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento)
into STRICT	ie_parametro_w
;

select	max(dt_mesano_referencia),
	max(coalesce(qt_maxima,0))
into STRICT	dt_mesano_referencia_w,
	qt_maxima_w
from	contrato_regra_nf_qtde
where	nr_seq_regra_nf = nr_seq_regra_nf_p;

if (ie_parametro_w = '1') then
	qt_retorno_w	:= qt_maxima_w;
elsif (ie_parametro_w = '2') then

	select	max(coalesce(qt_maxima,0))
	into STRICT	qt_maxima_w
	from	contrato_regra_nf_qtde
	where	nr_seq_regra_nf = nr_seq_regra_nf_p
	and	dt_mesano_referencia = dt_mesano_referencia_w;

	qt_retorno_w := qt_maxima_w;
end if;

return qt_retorno_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_qt_ant_regra_contrato (nr_seq_regra_nf_p bigint) FROM PUBLIC;

