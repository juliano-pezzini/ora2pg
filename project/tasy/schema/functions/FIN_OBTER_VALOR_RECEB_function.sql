-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION fin_obter_valor_receb ( ie_opcao_p text, dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_fisica_p text, cd_cgc_p text, cd_estabelecimento_p bigint, nm_usuario_p text) RETURNS bigint AS $body$
DECLARE

						 
vl_especie_w		double precision := 0;
vl_cartao_deb_w		double precision := 0;
vl_cartao_cred_w		double precision := 0;
vl_cheque_avista_w	double precision := 0;
vl_cheque_pre_w		double precision := 0;
vl_cred_bancario_w	double precision := 0;
vl_retorno_w		double precision := 0;

dt_final_w		timestamp;
dt_inicial_w		timestamp;

nr_titulo_w		bigint;
nr_seq_baixa_w		integer;
nr_seq_caixa_rec_w	bigint;
nr_adiantamento_w		bigint;
nr_bordero_w		bigint;
nr_seq_cobranca_w	bigint;
vl_recebido_w		double precision;

ie_tipo_consistencia_w	integer;
vl_adiantamento_w		double precision;

c01 CURSOR FOR 
SELECT	a.nr_seq_caixa_rec, 
	a.nr_adiantamento, 
	sum(coalesce(a.vl_recebido,0) + coalesce(a.vl_juros,0) + coalesce(a.vl_multa,0) + 
	coalesce(a.vl_outros_acrescimos,0) + coalesce(a.vl_rec_maior,0)) 
from	titulo_receber_liq a, 
	titulo_receber b 
where 	a.nr_titulo = b.nr_titulo 
and	a.dt_recebimento between dt_inicial_w and dt_final_w 
and	b.cd_pessoa_fisica = cd_pessoa_fisica_p 
and	b.cd_estabelecimento = cd_estabelecimento_p 
and	(cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') 
and	b.ie_situacao <> 3 
group by a.nr_seq_caixa_rec, 
	 a.nr_adiantamento 

union all
 
SELECT	a.nr_seq_caixa_rec, 
	a.nr_adiantamento, 
	sum(coalesce(a.vl_recebido,0) + coalesce(a.vl_juros,0) + coalesce(a.vl_multa,0) + 
	coalesce(a.vl_outros_acrescimos,0) + coalesce(a.vl_rec_maior,0)) 
from	titulo_receber_liq a, 
	titulo_receber b 
where 	a.nr_titulo = b.nr_titulo 
and	a.dt_recebimento between dt_inicial_w and dt_final_w 
and	b.cd_cgc = cd_cgc_p 
and	b.cd_estabelecimento = cd_estabelecimento_p 
and	(cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') 
and	b.ie_situacao <> 3 
group by a.nr_seq_caixa_rec, 
	 a.nr_adiantamento 

union all
 
select	a.nr_seq_caixa_rec, 
	a.nr_adiantamento, 
	sum(coalesce(a.vl_adiantamento,0)) 
from	adiantamento a 
where 	coalesce(obter_data_receb_adiant(a.nr_adiantamento,'T'),obter_data_receb_adiant(a.nr_adiantamento,'B')) between inicio_dia(dt_inicial_w) and fim_dia(dt_final_w) 
and	a.cd_pessoa_fisica = cd_pessoa_fisica_p 
and	a.cd_estabelecimento = cd_estabelecimento_p 
and	(cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') 
AND 	NOT EXISTS (SELECT b.nr_adiantamento FROM titulo_receber_liq b WHERE b.nr_adiantamento = a.nr_adiantamento) 
group by a.nr_seq_caixa_rec, 
	 a.nr_adiantamento 

UNION ALL
 
select	a.nr_seq_caixa_rec, 
	a.nr_adiantamento, 
	sum(coalesce(a.vl_adiantamento,0)) 
from	adiantamento a 
where 	coalesce(obter_data_receb_adiant(a.nr_adiantamento,'T'),obter_data_receb_adiant(a.nr_adiantamento,'B')) between inicio_dia(dt_inicial_w) and fim_dia(dt_final_w) 
and	a.cd_cgc = cd_cgc_p 
and	a.cd_estabelecimento = cd_estabelecimento_p 
and	(cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') 
AND 	NOT EXISTS (SELECT b.nr_adiantamento FROM titulo_receber_liq b WHERE b.nr_adiantamento = a.nr_adiantamento) 
group by a.nr_seq_caixa_rec, 
	 a.nr_adiantamento;


BEGIN 
dt_final_w	:= fim_dia(dt_final_p);
dt_inicial_w	:= trunc(dt_inicial_p,'dd');
 
open c01;
loop 
fetch c01 into	 
	nr_seq_caixa_rec_w, 
	nr_adiantamento_w, 
	vl_recebido_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	vl_especie_w		:= 0;
	vl_cheque_pre_w		:= 0;
	vl_cheque_avista_w	:= 0;
	vl_cartao_cred_w		:= 0;
	vl_cartao_deb_w		:= 0;
	vl_cred_bancario_w	:= 0;
	 
	if (nr_seq_caixa_rec_w IS NOT NULL AND nr_seq_caixa_rec_w::text <> '') then 
		begin 
		if (ie_opcao_p = 'VL_ESPECIE') then 
			select	coalesce(vl_especie,0) 
			into STRICT	vl_especie_w 
			from	caixa_receb 
			where	nr_sequencia = nr_seq_caixa_rec_w;
		elsif (ie_opcao_p = 'VL_CHEQUE_PRE') then 
			select	coalesce(sum(vl_cheque),0) 
			into STRICT	vl_cheque_pre_w 
			from	cheque_cr 
			where	nr_seq_caixa_rec = nr_seq_caixa_rec_w 
			and	ie_forma_pagto = 'PD';
		elsif (ie_opcao_p = 'VL_CHEQUE_AVISTA') then 
			select	coalesce(sum(vl_cheque),0) 
			into STRICT	vl_cheque_avista_w 
			from	cheque_cr 
			where	nr_seq_caixa_rec = nr_seq_caixa_rec_w 
			and	coalesce(ie_forma_pagto,'AV') = 'AV';
		elsif (ie_opcao_p = 'VL_CARTAO_CRED') then 
			select	coalesce(sum(vl_transacao),0) 
			into STRICT	vl_cartao_cred_w 
			from	movto_cartao_cr a, 
				transacao_financeira b 
			where	a.nr_seq_trans_caixa = b.nr_sequencia 
			and	a.nr_seq_caixa_rec = nr_seq_caixa_rec_w 
			and	b.ie_cartao_cr = 'S';
		elsif (ie_opcao_p = 'VL_CARTAO_DEB') then 
			select	coalesce(sum(vl_transacao),0) 
			into STRICT	vl_cartao_deb_w 
			from	movto_cartao_cr a, 
				transacao_financeira b 
			where	a.nr_seq_trans_caixa = b.nr_sequencia 
			and	a.nr_seq_caixa_rec = nr_seq_caixa_rec_w 
			and	b.ie_cartao_debito = 'S';
		end if;
		end;
	elsif (nr_adiantamento_w IS NOT NULL AND nr_adiantamento_w::text <> '') then 
		begin 
		select	nr_seq_caixa_rec 
		into STRICT	nr_seq_caixa_rec_w 
		from	adiantamento 
		where	nr_adiantamento = nr_adiantamento_w;
		 
		if (ie_opcao_p = 'VL_ESPECIE') then 
			select	coalesce(vl_especie,0) 
			into STRICT	vl_especie_w 
			from	adiantamento 
			where	nr_adiantamento = nr_adiantamento_w;
		elsif (ie_opcao_p = 'VL_CHEQUE_PRE') then 
			select	coalesce(sum(vl_cheque),0) 
			into STRICT	vl_cheque_pre_w 
			from ( 
				SELECT	b.nr_seq_cheque, 
					b.vl_cheque 
				FROM	cheque_cr_v b, 
					adiantamento_cheque_cr a, 
					cheque_cr c 
				WHERE	b.nr_seq_cheque  = a.nr_seq_cheque 
				and	b.nr_seq_cheque = c.nr_seq_cheque 
				and	c.ie_forma_pagto = 'PD' 
				and	a.nr_adiantamento = nr_adiantamento_w 
				
UNION
 
				SELECT	b.nr_seq_cheque, 
					b.vl_cheque 
				FROM	cheque_cr_v b, 
					cheque_cr c 
				WHERE	b.nr_seq_cheque = c.nr_seq_cheque 
				and	c.ie_forma_pagto = 'PD' 
				and	b.nr_adiantamento = nr_adiantamento_w) alias3;
		elsif (ie_opcao_p = 'VL_CHEQUE_AVISTA') then 
			select	coalesce(sum(vl_cheque),0) 
			into STRICT	vl_cheque_avista_w 
			from ( 
				SELECT	b.nr_seq_cheque, 
					b.vl_cheque 
				FROM	cheque_cr_v b, 
					adiantamento_cheque_cr a, 
					cheque_cr c 
				WHERE	b.nr_seq_cheque  = a.nr_seq_cheque 
				and	b.nr_seq_cheque = c.nr_seq_cheque 
				and	coalesce(c.ie_forma_pagto,'AV') = 'AV' 
				and	a.nr_adiantamento = nr_adiantamento_w 
				
UNION
 
				SELECT	b.nr_seq_cheque, 
					b.vl_cheque 
				FROM	cheque_cr_v b, 
					cheque_cr c 
				WHERE	b.nr_seq_cheque = c.nr_seq_cheque 
				and	coalesce(c.ie_forma_pagto,'AV') = 'AV' 
				and	b.nr_adiantamento = nr_adiantamento_w) alias5;
		elsif (ie_opcao_p = 'VL_CARTAO_CRED') then 
			select	coalesce(sum(vl_transacao),0) 
			into STRICT	vl_cartao_cred_w 
			from	movto_cartao_cr a, 
				transacao_financeira b 
			where	a.nr_seq_trans_caixa = b.nr_sequencia 
			and (a.nr_adiantamento = nr_adiantamento_w or a.nr_seq_caixa_rec = nr_seq_caixa_rec_w) 
			and	b.ie_cartao_cr = 'S';
		elsif (ie_opcao_p = 'VL_CARTAO_DEB') then 
			select	coalesce(sum(vl_transacao),0) 
			into STRICT	vl_cartao_deb_w 
			from	movto_cartao_cr a, 
				transacao_financeira b 
			where	a.nr_seq_trans_caixa = b.nr_sequencia 
			and (a.nr_adiantamento = nr_adiantamento_w or a.nr_seq_caixa_rec = nr_seq_caixa_rec_w) 
			and	b.ie_cartao_debito = 'S';
		elsif (ie_opcao_p = 'VL_CRED_BANCARIO') then 
			select	coalesce(vl_adiantamento,0) 
			into STRICT	vl_cred_bancario_w 
			from	adiantamento a 
			where	nr_adiantamento = nr_adiantamento_w 
			and	vl_especie = 0 
			and	not exists (	SELECT	1 
						from	movto_cartao_cr x 
						where	x.nr_adiantamento = a.nr_adiantamento or x.nr_seq_caixa_rec = a.nr_seq_caixa_rec ) 
			and	not exists (	select	1 
						from	cheque_cr_v x 
						where	x.nr_adiantamento = a.nr_adiantamento) 
			and	not exists (	select	1 
						from	adiantamento_cheque_cr x 
						where	x.nr_adiantamento = a.nr_adiantamento);		
						 
		end if;
		 
		nr_seq_caixa_rec_w	:= null;
		end;
	elsif (ie_opcao_p = 'VL_CRED_BANCARIO') then 
		vl_cred_bancario_w	:= vl_recebido_w;
	end if;
	 
	vl_retorno_w	:= 	vl_retorno_w + 
				vl_especie_w + 
				vl_cheque_pre_w + 
				vl_cheque_avista_w + 
				vl_cartao_cred_w + 
				vl_cartao_deb_w + 
				vl_cred_bancario_w;
	end;
end loop;
close c01;
 
return	vl_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION fin_obter_valor_receb ( ie_opcao_p text, dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_fisica_p text, cd_cgc_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

