-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_item_disp_mercado (ie_tipo_item_p text, cd_protocolo_p protocolo_medic_material.cd_protocolo%type, nr_sequencia_p protocolo_medic_material.nr_sequencia%type, nr_seq_item_p protocolo_medic_material.nr_seq_material%type, nr_prescricao_p prescr_medica.nr_prescricao%type default null, cd_material_p cpoe_material.cd_material%type default null, cd_mat_comp1_p cpoe_material.cd_mat_comp1%type default null, cd_mat_comp2_p cpoe_material.cd_mat_comp2%type default null, cd_mat_comp3_p cpoe_material.cd_mat_comp3%type default null, cd_mat_comp4_p cpoe_material.cd_mat_comp4%type default null, cd_mat_comp5_p cpoe_material.cd_mat_comp5%type default null, cd_mat_comp6_p cpoe_material.cd_mat_comp6%type default null, cd_mat_comp7_p cpoe_material.cd_mat_comp7%type default null, cd_mat_dil_p cpoe_material.cd_mat_dil%type default null, cd_mat_recons_p cpoe_material.cd_mat_recons%type default null, cd_mat_red_p cpoe_material.cd_mat_red%type default null) RETURNS varchar AS $body$
DECLARE


ie_disp_mercado_w		material.ie_disponivel_mercado%type;
nr_agrupamento_w		protocolo_medic_material.nr_agrupamento%type;
cd_estabelecimento_w	usuario.cd_estabelecimento%type;

/*
ie_tipo_item_p = [M]edicamento e [S]olucao.

Passar os parametros de acordo com o tipo da prescricao.

Protocolo ou Rotina: ie_tipo_item_p, cd_protocolo_p, nr_sequencia_p e nr_seq_item_p.

Favoritos: cd_material_p, cd_mat_comp1_p, cd_mat_comp2_p, cd_mat_comp3_p, cd_mat_comp4_p, cd_mat_comp5_p, cd_mat_comp6_p, cd_mat_comp7_p, cd_mat_dil_p, cd_mat_recons_p e cd_mat_red_p.

Prescricoes anteriores: ie_tipo_item_p, nr_seq_item_p e nr_prescricao_p.
*/
BEGIN

	cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

	if (coalesce(cd_material_p::text, '') = '' and coalesce(nr_prescricao_p::text, '') = '') then

		if (ie_tipo_item_p = 'M') then

			select	coalesce(max(a.nr_agrupamento),0)
			into STRICT	nr_agrupamento_w
			from	protocolo_medic_material a
			where	a.cd_protocolo = cd_protocolo_p
			and		a.nr_sequencia = nr_sequencia_p
			and		a.nr_seq_material = nr_seq_item_p;

			select	coalesce(max('N'),'S')
			into STRICT	ie_disp_mercado_w
			from	protocolo_medic_material a
			where	a.cd_protocolo = cd_protocolo_p
			and		a.nr_sequencia = nr_sequencia_p
			and		a.nr_agrupamento = nr_agrupamento_w
			and		coalesce(a.nr_seq_solucao::text, '') = ''
			and		obter_se_item_disp(cd_estabelecimento_w, a.cd_material) = 'N';

		elsif (ie_tipo_item_p = 'S') then

			select	coalesce(max('N'),'S')
			into STRICT	ie_disp_mercado_w
			from	protocolo_medic_material a
			where	a.cd_protocolo = cd_protocolo_p
			and		a.nr_sequencia = nr_sequencia_p
			and		a.nr_seq_solucao = nr_seq_item_p
			and		obter_se_item_disp(cd_estabelecimento_w, a.cd_material) = 'N';

		end if;

	elsif (coalesce(cd_material_p::text, '') = '' and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '')) then

		if (ie_tipo_item_p = 'M') then

			select	coalesce(max(a.nr_agrupamento),0)
			into STRICT	nr_agrupamento_w
			from	prescr_material a
			where	a.nr_prescricao = nr_prescricao_p
			and		a.nr_sequencia = nr_seq_item_p;

			select	coalesce(max('N'),'S')
			into STRICT	ie_disp_mercado_w
			from	prescr_material a
			where	a.nr_prescricao = nr_prescricao_p
			and		a.nr_agrupamento = nr_agrupamento_w
			and 	coalesce(a.nr_sequencia_solucao::text, '') = ''
			and		obter_se_item_disp(cd_estabelecimento_w, a.cd_material) = 'N';

			if (ie_disp_mercado_w = 'S') then

				select	coalesce(max('N'),'S')
				into STRICT	ie_disp_mercado_w
				from	prescr_material a
				where	a.nr_prescricao = nr_prescricao_p
				and		a.nr_sequencia_diluicao = nr_seq_item_p
				and 	coalesce(a.nr_sequencia_solucao::text, '') = ''
				and		a.ie_agrupador in (4,3,7,9)
				and		obter_se_item_disp(cd_estabelecimento_w, a.cd_material) = 'N';

			end if;

		elsif (ie_tipo_item_p = 'S') then

			select	coalesce(max('N'),'S')
			into STRICT	ie_disp_mercado_w
			from	prescr_material a
			where	a.nr_prescricao = nr_prescricao_p
			and		a.nr_sequencia_solucao = nr_seq_item_p
			and		obter_se_item_disp(cd_estabelecimento_w, a.cd_material) = 'N';

		end if;

	else

		if (obter_se_item_disp(cd_estabelecimento_w, cd_material_p) = 'S'
		and obter_se_item_disp(cd_estabelecimento_w, cd_mat_dil_p) = 'S'
		and obter_se_item_disp(cd_estabelecimento_w, cd_mat_recons_p) = 'S'
		and obter_se_item_disp(cd_estabelecimento_w, cd_mat_red_p) = 'S'
		and obter_se_item_disp(cd_estabelecimento_w, cd_mat_comp1_p) = 'S'
		and obter_se_item_disp(cd_estabelecimento_w, cd_mat_comp2_p) = 'S'
		and obter_se_item_disp(cd_estabelecimento_w, cd_mat_comp3_p) = 'S'
		and obter_se_item_disp(cd_estabelecimento_w, cd_mat_comp4_p) = 'S'
		and obter_se_item_disp(cd_estabelecimento_w, cd_mat_comp5_p) = 'S'
		and obter_se_item_disp(cd_estabelecimento_w, cd_mat_comp6_p) = 'S'
		and obter_se_item_disp(cd_estabelecimento_w, cd_mat_comp7_p) = 'S') then
			ie_disp_mercado_w := 'S';
		else
			ie_disp_mercado_w := 'N';
		end if;

	end if;

	return coalesce(ie_disp_mercado_w, 'S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_item_disp_mercado (ie_tipo_item_p text, cd_protocolo_p protocolo_medic_material.cd_protocolo%type, nr_sequencia_p protocolo_medic_material.nr_sequencia%type, nr_seq_item_p protocolo_medic_material.nr_seq_material%type, nr_prescricao_p prescr_medica.nr_prescricao%type default null, cd_material_p cpoe_material.cd_material%type default null, cd_mat_comp1_p cpoe_material.cd_mat_comp1%type default null, cd_mat_comp2_p cpoe_material.cd_mat_comp2%type default null, cd_mat_comp3_p cpoe_material.cd_mat_comp3%type default null, cd_mat_comp4_p cpoe_material.cd_mat_comp4%type default null, cd_mat_comp5_p cpoe_material.cd_mat_comp5%type default null, cd_mat_comp6_p cpoe_material.cd_mat_comp6%type default null, cd_mat_comp7_p cpoe_material.cd_mat_comp7%type default null, cd_mat_dil_p cpoe_material.cd_mat_dil%type default null, cd_mat_recons_p cpoe_material.cd_mat_recons%type default null, cd_mat_red_p cpoe_material.cd_mat_red%type default null) FROM PUBLIC;

