-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION count_constr_same_day ( DT_EXAME_P timestamp, DS_HORARIOS_P text, IE_TIPO_COMPAR_P text default '<') RETURNS bigint AS $body$
WITH RECURSIVE cte AS (
DECLARE

    c01 CURSOR FOR SELECT 
        RPAD(regexp_substr(DS_HORARIOS_P,'[^ ]+', 1, level),5,':00') horarios
     (regexp_substr(DS_HORARIOS_P,'[^ ]+', 1, level) IS NOT NULL AND (regexp_substr(DS_HORARIOS_P,'[^ ]+', 1, level))::text <> '')  UNION ALL
DECLARE
 
    c01 CURSOR FOR SELECT 
        RPAD(regexp_substr(DS_HORARIOS_P,'[^ ]+', 1, level),5,':00') horarios
     (regexp_substr(DS_HORARIOS_P,'[^ ]+', 1, level) IS NOT NULL AND (regexp_substr(DS_HORARIOS_P,'[^ ]+', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
;
    c01_w c01%rowtype;
    return_count bigint := 0;

BEGIN
    if (IE_TIPO_COMPAR_P = '<') THEN
        FOR c01_w IN c01 LOOP
            if (cast(to_char(DT_EXAME_P, 'HH24MI') as numeric) >  cast(replace(c01_w.horarios,':','') as numeric)) THEN
                return_count := return_count +1;
            END IF;
        END LOOP;
    ELSIF (IE_TIPO_COMPAR_P = '>') THEN
        FOR c01_w IN c01 LOOP
            if (cast(to_char(DT_EXAME_P, 'HH24MI') as numeric) <  cast(replace(c01_w.horarios,':','') as numeric)) THEN
                return_count := return_count +1;
            END IF;
        END LOOP;
    END IF;
    return return_count;
    EXCEPTION WHEN  OTHERS THEN
        return return_count;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION count_constr_same_day ( DT_EXAME_P timestamp, DS_HORARIOS_P text, IE_TIPO_COMPAR_P text default '<') FROM PUBLIC;

