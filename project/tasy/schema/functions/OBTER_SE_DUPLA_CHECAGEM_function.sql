-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_dupla_checagem ( cd_barras_p text, nr_seq_processo_p adep_processo.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


cd_material_w bigint;
cd_material_lista_w varchar(500);
cd_barras_w varchar(500);
cd_unid_med_w varchar(500);
ie_numero_w varchar(1);
ie_dupla_checagem_w material.ie_dupla_checagem%type;
nr_prescricao_w adep_processo.nr_prescricao%type;
cd_material_conv_w bigint;
qt_material_w bigint;
nr_seq_lote_w material_lote_fornec.nr_sequencia%type;
nr_seq_loteagrup_w material_lote_fornec_agrup.nr_sequencia%type;
cd_kit_mat_w bigint;
ds_validade_w material_lote_fornec.dt_validade%type;
ds_material_w varchar(255);
cd_unid_med_conv_w prescr_mat_hor.cd_unid_med_hor%type;
nr_etiqueta_lp_w lp_individual.nr_sequencia%type;
ds_erro_w varchar(4000);

c01 CURSOR FOR
SELECT x.cd_registro cd_material
from table(lista_pck.obter_lista_char(cd_material_lista_w)) x;

BEGIN

ie_dupla_checagem_w := 'N';

select CASE WHEN is_number(cd_barras_p)=1 THEN  'S'  ELSE 'N' END
into STRICT ie_numero_w
;

if (cd_barras_p IS NOT NULL AND cd_barras_p::text <> '') then
    if (ie_numero_w = 'S') then
        if (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') then
            SELECT * FROM obter_itens_lote_disp((cd_barras_p)::numeric , nr_seq_processo_p, cd_material_lista_w, cd_barras_w, cd_unid_med_w) INTO STRICT cd_material_lista_w, cd_barras_w, cd_unid_med_w;

            select  max(a.nr_prescricao)
            into STRICT    nr_prescricao_w
            from    adep_processo a
            where   a.nr_sequencia = nr_seq_processo_p;
        end if;
    end if;
    begin
    SELECT * FROM converte_codigo_barras(cd_mat_barra_p => cd_barras_p, cd_estabelecimento_p    => wheb_usuario_pck.get_cd_estabelecimento, ie_tipo_barra_p         => null, cd_local_estoque_p      => null, cd_material_p           => cd_material_w, qt_material_p           => qt_material_w, nr_seq_lote_p           => nr_seq_lote_w, nr_seq_loteagrup_p      => nr_seq_loteagrup_w, cd_kit_mat_p            => cd_kit_mat_w, ds_validade_p           => ds_validade_w, ds_material_p           => ds_material_w, cd_unid_med_p           => cd_unid_med_w, nr_etiqueta_lp_p        => nr_etiqueta_lp_w, ds_erro_p               => ds_erro_w) INTO STRICT cd_material_p           => cd_material_w, qt_material_p           => qt_material_w, nr_seq_lote_p           => nr_seq_lote_w, nr_seq_loteagrup_p      => nr_seq_loteagrup_w, cd_kit_mat_p            => cd_kit_mat_w, ds_validade_p           => ds_validade_w, ds_material_p           => ds_material_w, cd_unid_med_p           => cd_unid_med_w, nr_etiqueta_lp_p        => nr_etiqueta_lp_w, ds_erro_p               => ds_erro_w;
    exception
    when others then
        cd_material_w := null;
    end;
    if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then
        if (cd_material_lista_w IS NOT NULL AND cd_material_lista_w::text <> '') then
            cd_material_lista_w := cd_material_lista_w || ',' || cd_material_w;
        else
            cd_material_lista_w := cd_material_w;
        end if;
    end if;

    if (cd_material_lista_w IS NOT NULL AND cd_material_lista_w::text <> '') then
        for c01_w in c01
        loop
            select  coalesce(max(a.ie_dupla_checagem), 'N')
            into STRICT    ie_dupla_checagem_w
            from    material a
            where   a.cd_material = c01_w.cd_material;

            if (ie_dupla_checagem_w = 'N') then
                ie_dupla_checagem_w := obter_se_medic_dupla_chec( cd_material_p => c01_w.cd_material,
                                                                    cd_estabelecimento_p => wheb_usuario_pck.get_cd_estabelecimento,
                                                                    nr_prescricao_p => nr_prescricao_w);
            end if;
            if (ie_dupla_checagem_w = 'S') then
                exit;
            end if;
        end loop;
    end if;
end if;

return ie_dupla_checagem_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_dupla_checagem ( cd_barras_p text, nr_seq_processo_p adep_processo.nr_sequencia%type) FROM PUBLIC;

