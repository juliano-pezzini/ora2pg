-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_area_atuac_guia_med ( nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_medico_p pls_prestador_medico.cd_medico%type, nr_seq_area_atuacao_p area_atuacao_medica.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_especialidade_p especialidade_medica.cd_especialidade%type, ie_agrupar_especialidade_p pls_web_param_guia_medico.ie_agrupar_especialidade%type) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(4000);
cd_especialidade_w	especialidade_medica.cd_especialidade%type := cd_especialidade_p;

C01 CURSOR(	nr_seq_prestador_pc	pls_prestador.nr_sequencia%type,
		cd_medico_pc		pls_prestador_medico.cd_medico%type,
		nr_seq_area_atuacao_pc	area_atuacao_medica.nr_sequencia%type,
		cd_especialidade_pc	especialidade_medica.cd_especialidade%type) FOR	
	SELECT	ds_area_atuacao
	from	(	SELECT	substr(obter_desc_area_atuacao_medica(p.nr_seq_area_atuacao),1,80) ds_area_atuacao
			from	pls_prestador_med_espec p
			where	p.nr_seq_prestador	= nr_seq_prestador_pc
			and	coalesce(p.ie_guia_medico,'S')	= 'S'
			and	(p.nr_seq_area_atuacao IS NOT NULL AND p.nr_seq_area_atuacao::text <> '')
			and 	coalesce(p.ie_endereco_principal,'N') = 'S'
			and	((coalesce(cd_medico_pc::text, '') = '')			or (p.cd_pessoa_fisica	= cd_medico_pc))
			and	((coalesce(nr_seq_area_atuacao_pc::text, '') = '')	or (p.nr_seq_area_atuacao = nr_seq_area_atuacao_pc))
			and	((coalesce(cd_especialidade_pc::text, '') = '')		or (p.cd_especialidade	= cd_especialidade_pc))
			
union
	
			select	substr(obter_desc_area_atuacao_medica(a.nr_seq_area_atuacao),1,80) ds_area_atuacao
			from	pls_prest_med_espec_adic a,
				pls_prestador_med_espec	p
			where	p.nr_sequencia		= a.nr_seq_prest_med_espec
			and	coalesce(p.ie_guia_medico,'S')	= 'S'
			and	p.nr_seq_prestador	= nr_seq_prestador_pc
			and 	coalesce(p.ie_endereco_principal,'N') = 'S'
			and	(a.nr_seq_area_atuacao IS NOT NULL AND a.nr_seq_area_atuacao::text <> '')
			and	((coalesce(cd_medico_pc::text, '') = '')			or (p.cd_pessoa_fisica	= cd_medico_pc))
			and	((coalesce(nr_seq_area_atuacao_pc::text, '') = '')	or (a.nr_seq_area_atuacao = nr_seq_area_atuacao_pc))
			and	((coalesce(cd_especialidade_pc::text, '') = '')		or (p.cd_especialidade	= cd_especialidade_pc))) alias35
	group by ds_area_atuacao;

BEGIN
-- Se agrupar as especialidades, nao deve restringir a especialidade porque mostra tudo no mesmo registro do guia medico
if (ie_agrupar_especialidade_p = 'S') then
	cd_especialidade_w := null;
end if;

for r_c01_w in C01( nr_seq_prestador_p, cd_medico_p, nr_seq_area_atuacao_p, cd_especialidade_w) loop
	ds_retorno_w	:= substr((ds_retorno_w || r_c01_w.ds_area_atuacao || ' \ '),1,4000);
end loop;

if (length(ds_retorno_w) > 0) then
	ds_retorno_w := substr(ds_retorno_w, 1, length(ds_retorno_w) - 3);
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_area_atuac_guia_med ( nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_medico_p pls_prestador_medico.cd_medico%type, nr_seq_area_atuacao_p area_atuacao_medica.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_especialidade_p especialidade_medica.cd_especialidade%type, ie_agrupar_especialidade_p pls_web_param_guia_medico.ie_agrupar_especialidade%type) FROM PUBLIC;

