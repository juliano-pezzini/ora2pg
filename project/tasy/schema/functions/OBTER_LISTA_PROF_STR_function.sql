-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_lista_prof_str ( nr_seq_gestao_vaga_p bigint default null, nr_atendimento_p bigint default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	    varchar(4000):= '';
funcao_w            atend_paciente_medico.nr_seq_func_medico%type;
nm_medico_w         varchar(255):= '';
controller_w        varchar(255) := ' ';

cAtendPacMed CURSOR FOR
    SELECT
        fm.ds_funcao funcao,
        a.nm_pessoa_fisica nm_medico,
        fm.ie_medico  ie_medico,
        c.DS_ESPECIALIDADE,
		fm.nr_seq_apresentacao nr_seq_apresentacao
    FROM funcao_medico fm, table(search_names_dev(NULL, apm.cd_profissional, NULL, NULL, 'main,social')) a, atend_paciente_medico apm
LEFT OUTER JOIN medico_especialidade b ON (apm.cd_profissional = b.cd_pessoa_fisica)
LEFT OUTER JOIN especialidade_medica c ON (b.CD_ESPECIALIDADE = c.CD_ESPECIALIDADE)
WHERE (apm.nr_seq_gestao_vaga = coalesce(nr_seq_gestao_vaga_p, 0)
            or apm.nr_atendimento = coalesce(nr_atendimento_p, 0))  and (b.CD_ESPECIALIDADE = (SELECT min(d.CD_ESPECIALIDADE) from MEDICO_ESPECIALIDADE d where d.cd_pessoa_fisica = b.cd_pessoa_fisica) or coalesce(b.CD_ESPECIALIDADE::text, '') = '')  and fm.cd_funcao = apm.nr_seq_func_medico order by
        nr_seq_apresentacao,funcao;

BEGIN

for pacMed in cAtendPacMed loop
		if ( controller_w <> pacMed.funcao ) then
            if ( coalesce(ds_retorno_w::text, '') = '' ) then
                ds_retorno_w := pacMed.funcao||':(';
            else
                IF substr(ds_retorno_w,-1) =',' Then
                 ds_retorno_w := substr(ds_retorno_w, 1, length(ds_retorno_w)-1);
                end If;
                ds_retorno_w := ds_retorno_w||') '||pacMed.funcao||':(';
            end if;
            controller_w := pacMed.funcao;
         end if;

        IF coalesce(pacMed.DS_ESPECIALIDADE::text, '') = '' Then
          ds_retorno_w := ds_retorno_w||pacMed.nm_medico||',';
        else
          ds_retorno_w := ds_retorno_w||pacMed.nm_medico||' - '||pacMed.DS_ESPECIALIDADE||',';
        end if;

end loop;
IF substr(ds_retorno_w,-1) =',' Then
ds_retorno_w := substr(ds_retorno_w, 1, length(ds_retorno_w)-1);
end If;
if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
ds_retorno_w := ds_retorno_w||')';
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_lista_prof_str ( nr_seq_gestao_vaga_p bigint default null, nr_atendimento_p bigint default null) FROM PUBLIC;

