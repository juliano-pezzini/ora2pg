-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_volume_corrigido (ie_bomba_infusao_p text, ie_fator_correcao_p text, qt_volume_p bigint, cd_material_p bigint, qt_dose_p bigint, cd_unidade_medida_p text) RETURNS bigint AS $body$
DECLARE


  qt_dose_correcao_w  double precision	:= 0;
  qt_equipo_w         double precision	:= Obter_vol_Dispositivo_solucao(ie_bomba_infusao_p);
  qt_total_w          double precision;
  qt_dose_ml_w        double precision;	
  qt_conversao_w      double precision;
  qt_conversao_ml_w   double precision;

  unid_med_usua_w     varchar(30);
  cd_unid_med_cons_w  varchar(30);		
  EXEC_W              varchar(200);

BEGIN
  if (coalesce(ie_fator_correcao_p, 'N') = 'S') and (coalesce(ie_bomba_infusao_p, 'N') <> 'N') and (coalesce(qt_equipo_w, 0) > 0) then
    unid_med_usua_w := obter_unid_med_usua('ML');

    cd_unid_med_cons_w := upper(substr(obter_dados_material_estab(cd_material_p, wheb_usuario_pck.get_cd_estabelecimento, 'UMS'),1,30));

    select coalesce(max(qt_conversao),0)
    into STRICT	 qt_conversao_w
    from   material_conversao_unidade
    where	cd_material = cd_material_p
    and	upper(cd_unidade_medida) = upper(cd_unidade_medida_p);


    select coalesce(max(qt_conversao),0)
    into STRICT   qt_conversao_ml_w
    from   material_conversao_unidade
    where cd_material = cd_material_p
    and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('ML'));

    begin
      EXEC_W := 'CALL OBTER_CONVERSAO_ML_MD(:1,:2,:3,:4,:5,:6) INTO :result';

      EXECUTE EXEC_W USING IN qt_dose_p,
                                     IN cd_unidade_medida_p,
                                     IN unid_med_usua_w,
                                     IN cd_unid_med_cons_w,
                                     IN qt_conversao_w,
                                     IN qt_conversao_ml_w,
                                     OUT qt_dose_ml_w;
    exception
      when others then
        qt_dose_ml_w := null;
    end;

    begin
      EXEC_W := 'CALL OBTER_TOT_E_VOL_VOL_COR_MD(:1,:2) INTO :result';

      EXECUTE EXEC_W USING IN qt_equipo_w,
                                     IN qt_volume_p,
                                     OUT qt_total_w;
    exception
      when others then
        qt_total_w := null;
    end;

    begin
      EXEC_W := 'CALL OBTER_DOSE_COR_V_CORRIG_MD(:1,:2,:3) INTO :result';

      EXECUTE EXEC_W USING IN qt_total_w,
                                     IN qt_volume_p,
                                     IN qt_dose_ml_w,
                                     OUT qt_dose_correcao_w;
    exception
      when others then
        qt_dose_correcao_w := null;
    end;
  end if;

  return	qt_dose_correcao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_volume_corrigido (ie_bomba_infusao_p text, ie_fator_correcao_p text, qt_volume_p bigint, cd_material_p bigint, qt_dose_p bigint, cd_unidade_medida_p text) FROM PUBLIC;

