-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_cod_tabela_tiss ( cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, nr_seq_material_p pls_material.nr_sequencia%type ) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Trazer o código de tabela do TISS
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [x ] Tasy (Delphi/Java) [ x ] Portal [ x ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:  Rotina utilizada nos relatórios, portal e Tasy
Se existir registro na tabela TUSS os códigos enviados para o material ou medicamento deverá ser
00 Tabela própria das operadoras
18 Diárias, taxas e gases medicinais
19 Materiais e Órteses, Próteses e Materiais Especiais (OPME)
20 Medicamentos
22 Procedimentos e eventos em saúde
98 Tabela Própria de Pacotes
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_tipo_tabela_w	varchar(2) := '00';
ie_tipo_despesa_w	pls_material.ie_tipo_despesa%type;
qt_registro_w		integer;



BEGIN

/* Validação aplicada somente para materiais e medicamentos */

if (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then
	select	CASE WHEN max(ie_tipo_despesa)='2' THEN '20' WHEN max(ie_tipo_despesa)='3' THEN '19' WHEN max(ie_tipo_despesa)='7' THEN '19' WHEN max(ie_tipo_despesa)='1' THEN '18'  ELSE '00' END
	into STRICT	cd_tipo_tabela_w
	from	pls_material a,
		tuss_material_item b
	where	a.nr_seq_tuss_mat_item 	= b.nr_sequencia
	and	a.nr_sequencia 		= nr_seq_material_p;

/* Validação feita para procedimentos  */

elsif (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') then

	select	count(1)
	into STRICT	qt_registro_w
	from	pls_pacote b
	where	b.cd_procedimento	= cd_procedimento_p
	and	b.ie_origem_proced	= ie_origem_proced_p;

	/* Se tiver pacote retorna o código do pacote */

	if (  qt_registro_w > 0 ) then
		cd_tipo_tabela_w := '98';
	/* Procedimentos codificação TUSS */

	elsif ( ie_origem_proced_p = '8' ) then
		select	CASE WHEN max(ie_classificacao)='1' THEN '22' WHEN max(ie_classificacao)='2' THEN '18' WHEN max(ie_classificacao)='3' THEN '18'  ELSE '00' END
		into STRICT	cd_tipo_tabela_w
		from	procedimento
		where	cd_procedimento	 = cd_procedimento_p
		and	ie_origem_proced = ie_origem_proced_p;

	end if;
end if;

return	cd_tipo_tabela_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_cod_tabela_tiss ( cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, nr_seq_material_p pls_material.nr_sequencia%type ) FROM PUBLIC;

