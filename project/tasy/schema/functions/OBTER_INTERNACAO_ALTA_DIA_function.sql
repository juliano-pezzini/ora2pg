-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_internacao_alta_dia ( dia_referencia_p text, dt_mes_ano_p text, ie_opcao_p text, ie_clinica_p bigint, ie_tipo_atendimento_p bigint, cd_centro_custo_p bigint) RETURNS varchar AS $body$
DECLARE

 
qt_retorno_w		varchar(2000);
dt_ref_ini_w		timestamp;
dt_ref_fim_w		timestamp;


BEGIN 
 
dt_ref_ini_w := to_date(dia_referencia_p || '/' || dt_mes_ano_p ,'dd/mm/yyyy');
dt_ref_fim_w := dt_ref_ini_w + 86399/86400;
 
if (ie_opcao_p = 'I') then 
	SELECT	COUNT(*) 
	into STRICT	qt_retorno_w 
	FROM	atend_paciente_unidade b, 
		setor_atendimento c, 
		atendimento_paciente a 
	WHERE	a.nr_atendimento = b.nr_atendimento 
	AND 	b.dt_entrada_unidade = (SELECT MAX(x.dt_entrada_unidade) 
				  	FROM atend_paciente_unidade x 
					WHERE x.nr_Atendimento = a.nr_atendimento) 
	AND 	b.cd_setor_atendimento = c.cd_Setor_atendimento 
	AND	coalesce(a.dt_alta::text, '') = '' 
	AND 	a.dt_entrada <= dt_ref_fim_w 
	AND	((a.ie_clinica = ie_clinica_p) or (coalesce(a.ie_clinica::text, '') = '')) 
	AND	((c.cd_centro_custo = cd_centro_custo_p) or (coalesce(c.cd_centro_custo::text, '') = '')) 
	AND	((a.ie_tipo_atendimento = ie_tipo_atendimento_p) or (coalesce(a.ie_tipo_atendimento::text, '') = ''));
elsif (ie_opcao_p = 'A') then 
	SELECT	COUNT(*) 
	into STRICT 	qt_retorno_w 
	FROM	setor_atendimento c, 
		atend_paciente_unidade b, 
		atendimento_paciente a 
	WHERE	a.nr_atendimento = b.nr_atendimento 
	AND 	b.cd_setor_atendimento = c.cd_Setor_atendimento 
	AND 	b.dt_entrada_unidade = (SELECT MAX(x.dt_entrada_unidade) 
					FROM atend_paciente_unidade x 
					WHERE x.nr_Atendimento = a.nr_atendimento) 
	AND	(a.dt_alta IS NOT NULL AND a.dt_alta::text <> '') 
	--AND	b.nr_seq_interno = Obter_Atepacu_paciente(a.nr_atendimento, 'A') 
	AND 	a.dt_alta BETWEEN dt_ref_ini_w AND dt_ref_fim_w  
	AND	((a.ie_clinica = ie_clinica_p) or (coalesce(a.ie_clinica::text, '') = '')) 
	AND	((c.cd_centro_custo = cd_centro_custo_p) or (coalesce(c.cd_centro_custo::text, '') = '')) 
	AND	((a.ie_tipo_atendimento = ie_tipo_atendimento_p) or (coalesce(a.ie_tipo_atendimento::text, '') = ''));
end if;
 
return	qt_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_internacao_alta_dia ( dia_referencia_p text, dt_mes_ano_p text, ie_opcao_p text, ie_clinica_p bigint, ie_tipo_atendimento_p bigint, cd_centro_custo_p bigint) FROM PUBLIC;

