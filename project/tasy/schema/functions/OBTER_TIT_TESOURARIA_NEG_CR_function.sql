-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tit_tesouraria_neg_cr ( nr_seq_negociacao_p bigint, nr_seq_parcela_p bigint) RETURNS bigint AS $body$
DECLARE


ie_forma_pagto_w	varchar(2);
nr_titulo_w		bigint	:= null;
nr_titulo_dia_w		bigint;

dt_vencimento_w		timestamp;
dt_venc_inicio_mes_w	timestamp;
dt_venc_fim_mes_w	timestamp;
dt_venc_inicial_w	timestamp;
dt_venc_final_w		timestamp;
qt_titulo_w		bigint;


BEGIN
if (nr_seq_negociacao_p IS NOT NULL AND nr_seq_negociacao_p::text <> '') and (nr_seq_parcela_p IS NOT NULL AND nr_seq_parcela_p::text <> '') then

	select	max(a.ie_forma_pagto),
		max(a.dt_vencimento)
	into STRICT	ie_forma_pagto_w,
		dt_vencimento_w
	from	negociacao_cr_parcela a
	where	a.nr_sequencia	= nr_seq_parcela_p;

	dt_venc_inicio_mes_w	:= trunc(dt_vencimento_w,'month');
	dt_venc_fim_mes_w	:= fim_mes(dt_vencimento_w);

	if (ie_forma_pagto_w	= 'DI') and (dt_vencimento_w IS NOT NULL AND dt_vencimento_w::text <> '') then

		select	max(d.nr_titulo),
			count(*)
		into STRICT	nr_titulo_w,
			qt_titulo_w
		from    titulo_receber d,
			deposito_ident_titulo c,
			deposito_identificado b,
			negociacao_cr_dep_ident a
		where   b.nr_sequencia  	= a.nr_seq_deposito_ident
		and	b.nr_sequencia		= c.nr_seq_deposito
		and	c.nr_titulo		= d.nr_titulo
		and	a.nr_seq_negociacao 	= nr_seq_negociacao_p
		and	d.dt_pagamento_previsto	between dt_venc_inicio_mes_w and dt_venc_fim_mes_w;

		if (coalesce(qt_titulo_w,0)	> 1) then

			dt_venc_inicial_w	:= trunc(dt_vencimento_w,'dd');
			dt_venc_final_w		:= fim_dia(dt_vencimento_w);

			select	max(d.nr_titulo)
			into STRICT	nr_titulo_dia_w
			from    titulo_receber		d,
				deposito_ident_titulo 	c,
				deposito_identificado   b,
				negociacao_cr_dep_ident a
			where   b.nr_sequencia  	= a.nr_seq_deposito_ident
			and	b.nr_sequencia		= c.nr_seq_deposito
			and	c.nr_titulo		= d.nr_titulo
			and	a.nr_seq_negociacao 	= nr_seq_negociacao_p
			and	d.dt_pagamento_previsto	between dt_venc_inicial_w and dt_venc_final_w;

			if (nr_titulo_dia_w IS NOT NULL AND nr_titulo_dia_w::text <> '') then

				nr_titulo_w	:= nr_titulo_dia_w;

			end if;

		end if;

	elsif (ie_forma_pagto_w = 'B') then

		select	max(a.nr_titulo),
			count(*)
		into STRICT	nr_titulo_w,
			qt_titulo_w
		from	negociacao_cr_boleto a
		where	a.nr_seq_negociacao 	= nr_seq_negociacao_p
		and	a.dt_vencimento		between dt_venc_inicio_mes_w and dt_venc_fim_mes_w;

		if (coalesce(qt_titulo_w,0)	> 1) then

			dt_venc_inicial_w	:= trunc(dt_vencimento_w,'dd');
			dt_venc_final_w		:= fim_dia(dt_vencimento_w);

			select	max(a.nr_titulo)
			into STRICT	nr_titulo_w
			from	negociacao_cr_boleto a
			where	a.nr_seq_negociacao 	= nr_seq_negociacao_p
			and	a.dt_vencimento		between dt_venc_inicial_w and dt_venc_final_w;

			if (nr_titulo_dia_w IS NOT NULL AND nr_titulo_dia_w::text <> '') then

				nr_titulo_w	:= nr_titulo_dia_w;

			end if;

		end if;

	elsif (ie_forma_pagto_w = 'D') then

		select	max(a.nr_titulo),
			count(*)
		into STRICT	nr_titulo_w,
			qt_titulo_w
		from	negociacao_cr_deb_cc a
		where	a.nr_seq_negociacao	= nr_seq_negociacao_p
		and	a.dt_debito		between dt_venc_inicio_mes_w and dt_venc_fim_mes_w;

		if (coalesce(qt_titulo_w,0)	> 1) then

			dt_venc_inicial_w	:= trunc(dt_vencimento_w,'dd');
			dt_venc_final_w		:= fim_dia(dt_vencimento_w);

			select	max(a.nr_titulo)
			into STRICT	nr_titulo_w
			from	negociacao_cr_deb_cc a
			where	a.nr_seq_negociacao	= nr_seq_negociacao_p
			and	a.dt_debito		between dt_venc_inicial_w and dt_venc_final_w;

			if (nr_titulo_dia_w IS NOT NULL AND nr_titulo_dia_w::text <> '') then

				nr_titulo_w	:= nr_titulo_dia_w;

			end if;

		end if;

	elsif (ie_forma_pagto_w	= 'CH') or (ie_forma_pagto_w	= 'CA') or (ie_forma_pagto_w	= 'E') then

		select 	max(a.nr_titulo)
		into STRICT	nr_titulo_w
		from 	titulo_receber a
		where 	a.nr_seq_negociacao_origem	= nr_seq_negociacao_p;

	end if;
end if;

return	nr_titulo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tit_tesouraria_neg_cr ( nr_seq_negociacao_p bigint, nr_seq_parcela_p bigint) FROM PUBLIC;

