-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_link_health_share (cd_pessoa_fisica_p text, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


ds_link_origem_w 	varchar(1000) := 'http://[host]:[porta]/csp/healthshare/HSACCESS/Custom.HS.UI.ViewPatient.cls?t=';
dt_link_w 			varchar(20);
ds_sistema_origem_w varchar(9) := 'TASY_CORP';
ds_token_w 			varchar(200);
ds_token_base64_w	varchar(500);
ds_hash_w			varchar(200);
ds_separator_w		varchar(1) := '^';
ds_salt_w 			varchar(20) := 'mBLWbXYV6ncvJs7a';


BEGIN

select 	to_char(clock_timestamp(),'YYYYMMDDHH24mi')
into STRICT 	dt_link_w
;

ds_token_w := cd_pessoa_fisica_p||ds_separator_w||ds_sistema_origem_w||ds_separator_w||nm_usuario_p||ds_separator_w||dt_link_w;

select 	utl_url.escape(utl_raw.cast_to_varchar2(utl_encode.base64_encode(encode(ds_token_w::bytea, 'hex')::bytea)))
into STRICT 	ds_token_base64_w
;

select obter_md5(ds_token_w||ds_salt_w)
into STRICT ds_hash_w
;

--Substr apenas para definir a empresa.
select	coalesce(max(DS_URL), ds_link_origem_w) || '?t='
into STRICT 	ds_link_origem_w
from	liberacao_acesso_ext_pep
where 	substr(cd_cgc_cliente, 1, 8) = substr(obter_cgc_estabelecimento(WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO), 1, 8)
and 	ie_sistema_externo 	= 'HSHARE';


return ds_link_origem_w||ds_token_base64_w||CHR(38)||'h='||ds_hash_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_link_health_share (cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

