-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_alta_ult_setor ( nr_atendimento_p bigint, dt_alta_p timestamp) RETURNS varchar AS $body$
DECLARE


dt_ent_setor_w	timestamp;
dt_saida_unidade_w timestamp;
ie_consiste_proc_w varchar(10);
dt_alta_w	timestamp;


BEGIN
ie_consiste_proc_w := obter_param_usuario(916, 76, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_consiste_proc_w);

if (coalesce(nr_atendimento_p,0) > 0) and (dt_alta_p IS NOT NULL AND dt_alta_p::text <> '') then

	begin
		if (ie_consiste_proc_w = 'I') then
			SELECT	MAX(dt_saida_unidade)
			INTO STRICT	dt_saida_unidade_w
			FROM 	setor_atendimento b,
				atend_paciente_unidade a
			WHERE	a.nr_atendimento		= nr_atendimento_p
			AND	a.nr_sequencia = 	(	SELECT	MAX(x.nr_sequencia)
								FROM 	atend_paciente_unidade x
								WHERE 	x.nr_atendimento = a.nr_atendimento
								AND 	x.nr_atendimento = nr_atendimento_p
								AND		obter_classif_setor(x.cd_setor_atendimento) = 5
							 )
			AND	a.cd_setor_atendimento 	= b.cd_setor_atendimento
			AND (b.cd_classif_setor = 5)
			ORDER BY	CASE WHEN b.cd_classif_setor=3 THEN  1 WHEN b.cd_classif_setor=4 THEN  1 WHEN b.cd_classif_setor=8 THEN  1  ELSE 0 END ,
					a.dt_saida_unidade,
					a.dt_entrada_unidade;
		end if;

		SELECT	dt_entrada_unidade
		into STRICT	dt_ent_setor_w
		FROM 	setor_atendimento b,
			atend_paciente_unidade a
		WHERE	a.nr_atendimento		= nr_atendimento_p
		AND	a.nr_sequencia = 	(	SELECT	MAX(x.nr_sequencia)
							FROM 	atend_paciente_unidade x
							WHERE 	x.nr_atendimento = a.nr_atendimento
							AND 	x.nr_atendimento = nr_atendimento_p
							and	obter_classif_setor(x.cd_setor_atendimento)  = 1
						 )
		AND	a.cd_setor_atendimento 	= b.cd_setor_atendimento
		and	b.cd_classif_setor = 1
		ORDER BY	CASE WHEN b.cd_classif_setor=3 THEN  1 WHEN b.cd_classif_setor=4 THEN  1 WHEN b.cd_classif_setor=8 THEN  1  ELSE 0 END ,
				a.dt_saida_unidade,
				a.dt_entrada_unidade;
	exception
	when others then
		return 'N';
	end;


	if ((dt_saida_unidade_w IS NOT NULL AND dt_saida_unidade_w::text <> '') and (dt_alta_p <= dt_saida_unidade_w) and (ie_consiste_proc_w = 'I'))then
		return 'S';
	elsif (dt_ent_setor_w IS NOT NULL AND dt_ent_setor_w::text <> '') then
		if (dt_alta_p < dt_ent_setor_w) then
			return 'S';
		else
			return 'N';
		end if;
	end if;

end if;

return	'N';

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_alta_ult_setor ( nr_atendimento_p bigint, dt_alta_p timestamp) FROM PUBLIC;

