-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION lab_obter_codigo_equip_interf (nr_seq_exame_p bigint, ds_sigla_p text, ie_opcao_p text, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint default 0) RETURNS varchar AS $body$
DECLARE


cd_exame_equip_integr_w		varchar(20);
Resultado_w	 		varchar(50);
DS_SIGLA_EQUIP_w		varchar(20);


BEGIN
select 	coalesce(max(b.cd_exame_equip),null),
	max(DS_SIGLA_EQUIP)
into STRICT 	cd_exame_equip_integr_w,
	DS_SIGLA_EQUIP_w
from equipamento_lab a,
	exame_lab_equip_regra c,
     lab_exame_equip b
where a.cd_equipamento	= b.cd_equipamento
 and b.nr_sequencia	= c.nr_seq_exame_equip
 and b.nr_seq_exame 	= nr_seq_exame_p
 and a.ds_sigla 	= ds_sigla_p
 and b.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,b.ie_tipo_atendimento)
 and c.cd_estabelecimento = cd_estabelecimento_p
 and c.ie_dia_semana	= pkg_date_utils.get_WeekDay(clock_timestamp())
 and clock_timestamp()	>= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || c.ds_hora_inicio || ':00','dd/mm/yyyy hh24:mi:ss')
 and clock_timestamp()	<= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || c.ds_hora_fim || ':00','dd/mm/yyyy hh24:mi:ss');

 if (coalesce(cd_exame_equip_integr_w::text, '') = '') then

	select 	coalesce(max(b.cd_exame_equip),null),
		max(DS_SIGLA_EQUIP)
	into STRICT 	cd_exame_equip_integr_w,
		DS_SIGLA_EQUIP_w
	from equipamento_lab a,
		exame_lab_equip_regra c,
	     lab_exame_equip b
	where a.cd_equipamento	= b.cd_equipamento
	 and b.nr_sequencia	= c.nr_seq_exame_equip
	 and b.nr_seq_exame 	= nr_seq_exame_p
	 and a.ds_sigla 	= ds_sigla_p
	 and coalesce(b.ie_tipo_atendimento::text, '') = ''
	 and c.cd_estabelecimento = cd_estabelecimento_p
	 and c.ie_dia_semana	= pkg_date_utils.get_WeekDay(clock_timestamp())
	 and clock_timestamp()	>= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || c.ds_hora_inicio || ':00','dd/mm/yyyy hh24:mi:ss')
	 and clock_timestamp()	<= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || c.ds_hora_fim || ':00','dd/mm/yyyy hh24:mi:ss');

	if (coalesce(cd_exame_equip_integr_w::text, '') = '') then
		select 	coalesce(max(b.cd_exame_equip),null),
			max(DS_SIGLA_EQUIP)
		into STRICT 	cd_exame_equip_integr_w,
			DS_SIGLA_EQUIP_w
		from 	equipamento_lab a,
			lab_exame_equip b
		where a.cd_equipamento	= b.cd_equipamento
		and b.nr_seq_exame 	= nr_seq_exame_p
		and b.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,b.ie_tipo_atendimento)
		and a.ds_sigla 	= ds_sigla_p;

		if (coalesce(cd_exame_equip_integr_w::text, '') = '') then

			select 	coalesce(max(b.cd_exame_equip),null),
				max(DS_SIGLA_EQUIP)
			into STRICT 	cd_exame_equip_integr_w,
				DS_SIGLA_EQUIP_w
			from 	equipamento_lab a,
				exame_lab_equip_regra c,
				lab_exame_equip b
			where 	a.cd_equipamento	= b.cd_equipamento
			 and 	b.nr_sequencia	= c.nr_seq_exame_equip
			 and 	b.nr_seq_exame 	= nr_seq_exame_p
			 and 	a.ds_sigla 	= ds_sigla_p
			 and 	coalesce(b.ie_tipo_atendimento, ie_tipo_atendimento_p) = ie_tipo_atendimento_p
			 and 	coalesce(c.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p
			 and 	coalesce(c.ie_dia_semana, pkg_date_utils.get_WeekDay(clock_timestamp())) = pkg_date_utils.get_WeekDay(clock_timestamp())
			 and 	coalesce(c.cd_setor_atendimento, cd_setor_atendimento_p) = cd_setor_atendimento_p
			 and 	((clock_timestamp()	>= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || c.ds_hora_inicio || ':00','dd/mm/yyyy hh24:mi:ss')) or (coalesce(c.ds_hora_inicio::text, '') = ''))
			 and 	((clock_timestamp()	<= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || c.ds_hora_fim || ':00','dd/mm/yyyy hh24:mi:ss')) or (coalesce(c.ds_hora_fim::text, '') = ''));

		end if;

		if (coalesce(cd_exame_equip_integr_w::text, '') = '') then
			select 	coalesce(max(b.cd_exame_equip),null),
				max(DS_SIGLA_EQUIP)
			into STRICT 	cd_exame_equip_integr_w,
				DS_SIGLA_EQUIP_w
			from 	equipamento_lab a,
				lab_exame_equip b
			where a.cd_equipamento	= b.cd_equipamento
			and b.nr_seq_exame 	= nr_seq_exame_p
			and coalesce(b.ie_tipo_atendimento::text, '') = ''
			and a.ds_sigla 	= ds_sigla_p;
		end if;
	end if;
end if;

if (ie_opcao_p	= 'SE') then
	Resultado_w	:= DS_SIGLA_EQUIP_w;
end if;

return	Resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION lab_obter_codigo_equip_interf (nr_seq_exame_p bigint, ds_sigla_p text, ie_opcao_p text, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint default 0) FROM PUBLIC;

