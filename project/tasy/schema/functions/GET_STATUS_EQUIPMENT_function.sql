-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_status_equipment ( nr_seq_equipamento_p bigint, ie_tipo_p bigint) RETURNS bigint AS $body$
DECLARE


dt_aquisicao_w					man_equipamento.dt_aquisicao%type;
dt_instalacao_w					man_equipamento.dt_instalacao%type;
dt_inicio_garantia_w				man_equipamento.dt_inicio_garantia%type;
qt_tempo_vida_util_w				man_equipamento.qt_tempo_vida_util%type;
dt_fim_garantia_w				man_equipamento.dt_fim_garantia%type;
qt_tempo_vida_util_equip_w			man_tipo_equipamento.qt_tempo_vida_util%type;
ie_vida_util_w					man_tipo_equipamento.ie_vida_util%type;
cn_validate_w					bigint;
dt_validate_value				timestamp;


BEGIN

		select	a.dt_aquisicao,
			a.dt_instalacao,
			a.dt_inicio_garantia,
			a.dt_fim_garantia,
			a.qt_tempo_vida_util,
			b.qt_tempo_vida_util qt_tempo_vida_util_equip,
			b.ie_vida_util
		into STRICT 	dt_aquisicao_w,
			dt_instalacao_w,
			dt_inicio_garantia_w,
			dt_fim_garantia_w,
			qt_tempo_vida_util_w,
			qt_tempo_vida_util_equip_w,
			ie_vida_util_w
		from	man_equipamento a,
			man_tipo_equipamento b
		where	b.nr_sequencia = a.nr_seq_tipo_equip
		and	a.nr_sequencia = nr_seq_equipamento_p;
    
    
	if (coalesce(ie_vida_util_w,0) = 0) then
		dt_validate_value:= dt_aquisicao_w;
	elsif (ie_vida_util_w = 1) then
		dt_validate_value:= dt_instalacao_w;
	elsif (ie_vida_util_w = 2) then
		dt_validate_value:= dt_inicio_garantia_w;
	end if;


	if (ie_tipo_p = 0) then
	
	if ((dt_validate_value IS NOT NULL AND dt_validate_value::text <> '') and (coalesce(coalesce(qt_tempo_vida_util_w,qt_tempo_vida_util_equip_w),0)) > 0) then
		if (add_months(dt_validate_value,coalesce(qt_tempo_vida_util_w,qt_tempo_vida_util_equip_w)) >= clock_timestamp()) then
			return 1;
	else
			return 2;
		end if;
	else
			return 0;  --Not informed
		end if;
	
	elsif (ie_tipo_p = 1) then
	
		if (coalesce(dt_inicio_garantia_w::text, '') = '' or coalesce(dt_fim_garantia_w::text, '') = '') then
			return 0;
	elsif (dt_inicio_garantia_w <= clock_timestamp() and dt_fim_garantia_w >= clock_timestamp() ) then
			return 1;  -- In warranty
	else
			return 2; --warranty expired 
	end if;
end if;
	return 0;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_status_equipment ( nr_seq_equipamento_p bigint, ie_tipo_p bigint) FROM PUBLIC;

