-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE array_dv AS (array_dv integer[2]);


CREATE OR REPLACE FUNCTION valida_cpf_cnpj (cpf_cnpj_p text) RETURNS varchar AS $body$
DECLARE

v_array_dv_w 		array_dv := array_dv(0, 0);
cpf_digit_w		constant integer := 11;
cnpj_digit_w		constant integer := 14;
is_cpf_w		boolean;
is_cnpj_w		boolean;
v_cpf_number_w		varchar(20);
total_w			bigint := 0;
coeficiente_w		bigint := 0;
dv1_w			bigint := 0;
dv2_w			bigint := 0;
digito_w		bigint := 0;
j			integer;
i			integer;


BEGIN

if (coalesce(cpf_cnpj_p::text, '') = '') then
	return 'N';
end if;
--retira os caracteres não numéricos do cpf/cnpj caso seja enviado para validação um valor com a máscara.
v_cpf_number_w	:= regexp_replace(cpf_cnpj_p, '[^0-9]', '');
--verifica se o valor passado é um cpf através do número de dígitos informados. cpf = 11
is_cpf_w	:= (length(v_cpf_number_w) = cpf_digit_w);
--verifica se o valor passado é um cnpj através do número de dígitos informados. cnpj = 14
is_cnpj_w := (length(v_cpf_number_w) = cnpj_digit_w);
if (is_cpf_w or is_cnpj_w) then
	total_w := 0;
else
	return 'N';
end if;
--armazena os valores de dígitos informados para posterior comparação com os dígitos verificadores calculados.
dv1_w	:= (substr(v_cpf_number_w, length(v_cpf_number_w) - 1, 1))::numeric;
dv2_w	:= (substr(v_cpf_number_w, length(v_cpf_number_w), 1))::numeric;
v_array_dv_w(1) := 0;
v_array_dv_w(2) := 0;
--laço para cálculo dos dígitos verificadores. É utilizado módulo 11 conforme norma da receita federal.
FOR j in 1 .. 2 loop
	total_w := 0;
	coeficiente_w := 2;
	for i IN REVERSE ((length(v_cpf_number_w)..1 - 3) + j) loop
		digito_w	:= (substr(v_cpf_number_w, i, 1))::numeric;
		total_w		:= total_w + (digito_w * coeficiente_w);
		coeficiente_w	:= coeficiente_w + 1;
		if (coeficiente_w > 9) and is_cnpj_w then
			coeficiente_w	:= 2;
		end if;
	end loop;
	v_array_dv_w(j) := 11 - mod(total_w, 11);
	if (v_array_dv_w(j) >= 10) then
		v_array_dv_w(j)	:= 0;
	end if;
end loop;
--compara os dígitos calculados com os informados para informar resultado.
if	((dv1_w = v_array_dv_w(1)) and (dv2_w = v_array_dv_w(2))) then
	return 'S';
else
	return 'N';
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION valida_cpf_cnpj (cpf_cnpj_p text) FROM PUBLIC;

