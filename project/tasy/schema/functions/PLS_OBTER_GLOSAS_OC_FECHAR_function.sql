-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_glosas_oc_fechar ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_tipo_p text ) RETURNS varchar AS $body$
DECLARE


ds_retorno_w		varchar(4000);
ds_retorno_temp_w	varchar(100);
cd_codigo_w		tiss_motivo_glosa.cd_motivo_tiss%type;

C01 CURSOR( nr_seq_conta_pc	pls_conta.nr_sequencia%type)FOR
	SELECT	to_char(b.cd_motivo_tiss) codigo
	from	pls_conta_glosa 	a,
		tiss_motivo_glosa 	b
	where	a.nr_seq_motivo_glosa	= b.nr_sequencia
--	and	a.ie_fechar_conta	= 'N'
	and	a.nr_seq_conta		= nr_seq_conta_pc
	and	ie_tipo_p		= 'G'
	and	a.ie_situacao		= 'A'
	
union

	SELECT	to_char(c.cd_motivo_tiss) codigo
	from	pls_conta_glosa 	a,
		pls_conta_mat 		b,
		tiss_motivo_glosa 	c
	where	a.nr_seq_motivo_glosa	= c.nr_sequencia
	and	a.nr_seq_conta_mat	= b.nr_sequencia
--	and	a.ie_fechar_conta	= 'N'
	and	b.nr_seq_conta		= nr_seq_conta_pc
	and	ie_tipo_p		= 'G'
	and	a.ie_situacao		= 'A'
	
union

	select	to_char(c.cd_motivo_tiss) codigo
	from	pls_conta_glosa 	a,
		pls_conta_proc 		b,
		tiss_motivo_glosa 	c
	where	a.nr_seq_motivo_glosa	= c.nr_sequencia
	and	a.nr_seq_conta_proc	= b.nr_sequencia
--	and	a.ie_fechar_conta	= 'N'
	and	b.nr_seq_conta		= nr_seq_conta_pc
	and	ie_tipo_p		= 'G'
	and	a.ie_situacao		= 'A'
	
union

	select	to_char(b.cd_ocorrencia) codigo
	from	pls_ocorrencia_benef a,
		pls_ocorrencia b
	where	b.nr_sequencia		= a.nr_seq_ocorrencia
--	and	a.ie_fechar_conta	= 'N'
	and	a.nr_seq_conta		= nr_seq_conta_pc
	and	ie_tipo_p		= 'O'
	and	a.ie_situacao		= 'A';

BEGIN

ds_retorno_w := null;

for	r_C01_w in C01(nr_seq_conta_p) loop

	cd_codigo_w := r_C01_w.codigo;

	if (ds_retorno_temp_w IS NOT NULL AND ds_retorno_temp_w::text <> '') then
		ds_retorno_w := ds_retorno_w || ds_retorno_temp_w || ', ';
	end if;

	ds_retorno_temp_w := cd_codigo_w;

end loop;
--Se terminar com  ', ' então remove pois acrescentará um 'e' ao término,
if (substr(ds_retorno_w, length(ds_retorno_w) -1, 2) = ', ') then
	ds_retorno_w := substr(ds_retorno_w, 1, length(ds_retorno_w) -2);
end if;

if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
	ds_retorno_w := ds_retorno_w || ' e ' || cd_codigo_w;
else
	if (cd_codigo_w IS NOT NULL AND cd_codigo_w::text <> '') then
		ds_retorno_w := cd_codigo_w;
	end if;
end if;

ds_retorno_w	:= substr(ds_retorno_w,1,255);

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_glosas_oc_fechar ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_tipo_p text ) FROM PUBLIC;

