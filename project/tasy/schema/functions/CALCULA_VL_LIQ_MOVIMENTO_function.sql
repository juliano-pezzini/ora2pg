-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION calcula_vl_liq_movimento ( nr_interno_conta_p CONTA_PACIENTE_RESUMO_IMP.NR_INTERNO_CONTA%type, cd_material_p CONTA_PACIENTE_RESUMO_IMP.CD_MATERIAL%type, cd_procedimento_p CONTA_PACIENTE_RESUMO_IMP.CD_PROCEDIMENTO%type, vl_movimento_p bigint, ie_proc_material_p text ) RETURNS bigint AS $body$
DECLARE


vl_total_w		CONTA_PACIENTE_RESUMO_IMP.VL_IMPOSTO%type := 0;


BEGIN

SELECT coalesce(
	(
		SELECT VL_MOVIMENTO_P - SUM(CPRI.VL_IMPOSTO)
		FROM CONTA_PACIENTE_RESUMO_IMP CPRI
		JOIN TRIBUTO_REGRA_DEFERIDO TRD ON CPRI.CD_TRIBUTO = TRD.CD_TRIBUTO
		JOIN TRIBUTO TRIB ON (TRD.CD_TRIBUTO = TRIB.CD_TRIBUTO)
		WHERE TRIB.IE_SOMA_DIMINUI = 'D'
		AND TRD.NR_SEQUENCIA IN (
			SELECT COALESCE(
				(SELECT A.NR_SEQUENCIA FROM TRIBUTO_REGRA_DEFERIDO A WHERE A.CD_CONVENIO_PARAMETRO = CPRI.CD_CONVENIO_PARAMETRO AND A.CD_TRIBUTO = CPRI.CD_TRIBUTO),
				(SELECT B.NR_SEQUENCIA FROM TRIBUTO_REGRA_DEFERIDO B WHERE coalesce(B.CD_CONVENIO_PARAMETRO::text, '') = '' AND B.CD_TRIBUTO = CPRI.CD_TRIBUTO)
				)
		)
		AND CPRI.NR_INTERNO_CONTA = NR_INTERNO_CONTA_P
		AND TRD.IE_CONTAB_PROV_RECEITAS = 'S'
		AND (
			(IE_PROC_MATERIAL_P = 'M' AND CPRI.CD_MATERIAL = CD_MATERIAL_P)
			OR (IE_PROC_MATERIAL_P = 'P' AND CPRI.CD_PROCEDIMENTO = CD_PROCEDIMENTO_P)
		)
	)
	, VL_MOVIMENTO_P
) AS VL_LIQUIDO
INTO STRICT vl_total_w
;

RETURN vl_total_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION calcula_vl_liq_movimento ( nr_interno_conta_p CONTA_PACIENTE_RESUMO_IMP.NR_INTERNO_CONTA%type, cd_material_p CONTA_PACIENTE_RESUMO_IMP.CD_MATERIAL%type, cd_procedimento_p CONTA_PACIENTE_RESUMO_IMP.CD_PROCEDIMENTO%type, vl_movimento_p bigint, ie_proc_material_p text ) FROM PUBLIC;

