-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_receb_lote_estrutura (nr_seq_lote_p bigint, ie_opcao_p text default 1) RETURNS varchar AS $body$
DECLARE


cd_material_w			material.cd_material%type;
cd_perfil_w		        integer;
cd_grupo_material_w	    subgrupo_material.cd_grupo_material%type;
cd_subgrupo_material_w	classe_material.cd_subgrupo_material%type;
nr_seq_familia_w		material.nr_seq_familia%type;
cd_classe_material_w	material.cd_classe_material%type;
ie_consiste_w		    varchar(1) := 'N';
qt_existe_w             bigint;

c01 CURSOR FOR
    SELECT	cd_material
    from	ap_lote_item
    where   nr_seq_lote = nr_seq_lote_p;

c02 CURSOR FOR
        SELECT	cd_perfil
        from	recebimento_lote_estrutura a
        where	((coalesce(a.cd_material::text, '') = '') or (a.cd_material = cd_material_w))
        and		((coalesce(a.cd_grupo_material::text, '') = '') or (a.cd_grupo_material = cd_grupo_material_w))
        and		((coalesce(a.cd_subgrupo_material::text, '') = '') or (a.cd_subgrupo_material = cd_subgrupo_material_w))
        and		((coalesce(a.cd_classe_material::text, '') = '') or (a.cd_classe_material = cd_classe_material_w))
        and		((coalesce(a.nr_seq_familia::text, '') = '') or (a.nr_seq_familia = nr_seq_familia_w));


BEGIN

select	count(1)
into STRICT    qt_existe_w
from	recebimento_lote_estrutura a;

if (qt_existe_w > 0) then

    open c01;
    loop
    fetch c01
        into cd_material_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
    begin

        select	obter_estrutura_material(cd_material, 'G'),
                obter_estrutura_material(cd_material, 'S'),
                nr_seq_familia,
                cd_classe_material
        into STRICT    cd_grupo_material_w,
                cd_subgrupo_material_w,
                nr_seq_familia_w,
                cd_classe_material_w        
        from	material
        where	cd_material = cd_material_w;

        if (ie_opcao_p = 1) then -- consiste legenda
        
            select	CASE WHEN coalesce(count(*), 0)=0 THEN  'N'  ELSE 'S' END 
            into STRICT    ie_consiste_w
            from	recebimento_lote_estrutura a
            where   ((coalesce(a.cd_material::text, '') = '') or (a.cd_material = cd_material_w))
            and		((coalesce(a.cd_grupo_material::text, '') = '') or (a.cd_grupo_material = cd_grupo_material_w))
            and		((coalesce(a.cd_subgrupo_material::text, '') = '') or (a.cd_subgrupo_material = cd_subgrupo_material_w))
            and		((coalesce(a.cd_classe_material::text, '') = '') or (a.cd_classe_material = cd_classe_material_w))
            and		((coalesce(a.nr_seq_familia::text, '') = '') or (a.nr_seq_familia = nr_seq_familia_w));

            if (ie_consiste_w = 'S') then
                return ie_consiste_w;
            end if;

        elsif (ie_opcao_p = 2) then --bipagem barras
            
            ie_consiste_w:= 'S';

            open c02;
            loop
            fetch c02
                into cd_perfil_w;
            EXIT WHEN NOT FOUND; /* apply on c02 */
            begin

                if (cd_perfil_w = obter_perfil_ativo) then
                    ie_consiste_w:= 'N';
                end if;

            end;
            end loop;
            close c02;

        end if;
    end;
    end loop;
    close c01;

end if;

return	ie_consiste_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_receb_lote_estrutura (nr_seq_lote_p bigint, ie_opcao_p text default 1) FROM PUBLIC;

