-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_ontology_validation ( nr_seq_pde_main_p bigint, nm_table_p text ) RETURNS varchar AS $body$
DECLARE


    ie_ontology              varchar(1);
    cd_ontology_required_w   pde_attribute.cd_ontologia%TYPE;
    cur_min_att CURSOR FOR
    SELECT
        nm_table,
        nm_attribute,
        cd_ontology
    FROM
        pde_minimum_attributes_v
    WHERE
        nm_table = nm_table_p;

    row_min_att              cur_min_att%rowtype;

BEGIN
    OPEN cur_min_att;
    ie_ontology := 'N';
    LOOP
        FETCH cur_min_att INTO row_min_att;
        EXIT WHEN NOT FOUND; /* apply on cur_min_att */
        BEGIN
            SELECT
                CASE
                    WHEN coalesce(phi.cd_valor_ontologia::text, '') = '' THEN
                        'NONE'
                    ELSE
                        phi.cd_valor_ontologia
                END cd_ontology
            INTO STRICT cd_ontology_required_w
            FROM
                tabela_atributo              ta
                LEFT JOIN ontologia_tabela             ot ON ta.nm_tabela = ot.nm_tabela
                LEFT JOIN ontologia_tabela_atributo    ota ON ot.nm_tabela = ota.nm_tabela
                                                           AND ta.nm_atributo = ota.nm_atributo
                LEFT JOIN res_cadastro_ontologia_phi   phi ON phi.nm_tabela = ta.nm_tabela
                                                            AND phi.nm_atributo = ta.nm_atributo
                LEFT JOIN pde_attribute                pde ON pde.nm_tabela = ota.nm_tabela
                                               AND pde.nm_atributo = ota.nm_atributo
                                               AND pde.nr_seq_pde_main = nr_seq_pde_main_p
            WHERE
                ta.nm_tabela = row_min_att.nm_table
                AND ta.nm_atributo = row_min_att.nm_attribute;

        END;

        IF cd_ontology_required_w = 'NONE' THEN
            ie_ontology := 'N';
        ELSE
            ie_ontology := 'Y';
        END IF;

    END LOOP;

    CLOSE cur_min_att;
    RETURN ie_ontology;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_ontology_validation ( nr_seq_pde_main_p bigint, nm_table_p text ) FROM PUBLIC;

