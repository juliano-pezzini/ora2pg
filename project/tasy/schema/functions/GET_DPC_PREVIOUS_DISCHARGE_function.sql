-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_dpc_previous_discharge ( nr_atendimento_p bigint, cd_mdc_p text ) RETURNS timestamp AS $body$
DECLARE

    dt_alta_w  timestamp;
    cnt_p_w bigint;

BEGIN
    SELECT distinct d.cd_mdc
into STRICT cnt_p_w
from    dpc_mdc d,
    dpc_classification c,
    patient_dpc_general_cond a,
    patient_dpc b,
    patient_dpc_questionnaire e
where    a.nr_seq_mdc    = d.nr_sequencia
and    a.nr_seq_classification = c.nr_sequencia
and    a.nr_sequencia = (SELECT max(x.nr_sequencia)
                from patient_dpc_general_cond x
                where x.nr_seq_patient_dpc = b.nr_sequencia)
and b.nr_sequencia = e.nr_seq_patient_dpc
and b.nr_atendimento in ( select nr_atendimento from ATENDIMENTO_PACIENTE where cd_pessoa_fisica = (select obter_cd_pes_fis_atend(b.nr_atendimento) ))
and b.nr_atendimento not in (select nr_atendimento from ATENDIMENTO_PACIENTE where nr_atendimento = nr_atendimento_p )
and d.cd_mdc=cd_mdc_p;


IF (cnt_p_w IS NOT NULL AND cnt_p_w::text <> '') THEN
	SELECT
		max(DT_ALTA) 
	INTO STRICT dt_alta_w
	FROM 
		atendimento_paciente 
	WHERE 
		cd_pessoa_fisica = obter_cd_pes_fis_atend(nr_atendimento_p);

ELSE
        dt_alta_w := NULL;

END IF;

RETURN dt_alta_w;


EXCEPTION
    WHEN no_data_found THEN
        RETURN NULL;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_dpc_previous_discharge ( nr_atendimento_p bigint, cd_mdc_p text ) FROM PUBLIC;

