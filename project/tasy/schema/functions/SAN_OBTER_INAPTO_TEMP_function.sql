-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION san_obter_inapto_temp ( cd_pessoa_fisica_p text) RETURNS varchar AS $body$
DECLARE

				
ie_retorno_w	varchar(2);

BEGIN

	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

		select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'T' END 
		into STRICT	ie_retorno_w
		from 	san_impedimento c, 
			san_doacao_impedimento b, 
			san_doacao a 
		where 	a.nr_sequencia 		= b.nr_seq_doacao  
		and 	b.nr_seq_impedimento 	= c.nr_sequencia 
		AND 	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
		and 	a.ie_avaliacao_final 	<> 'A'
		and     b.dt_ocorrencia + coalesce(c.nr_dias_inaptidao, 0) > clock_timestamp()
		and	c.ie_definitivo = 'N';
		
		if (ie_retorno_w = 'N') then
			SELECT 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'T' END
			INTO STRICT	ie_retorno_w
			FROM 	san_impedimento c, 
				san_questionario b, 
				san_doacao a 
			WHERE 	a.nr_sequencia 		= b.nr_seq_doacao  
			AND 	b.nr_seq_impedimento 	= c.nr_sequencia 
			AND 	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
			AND 	a.ie_avaliacao_final 	<> 'A'
			AND	c.ie_definitivo = 'N'
			AND (b.dt_ocorrencia + c.nr_dias_inaptidao) > clock_timestamp()
			AND     coalesce(b.ie_impede_doacao,'N') = 'S';
		end if;
		
		if (ie_retorno_w = 'N') then
			SELECT 	CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'T' END
			INTO STRICT	ie_retorno_w
			FROM 	san_doacao a,
					san_impedimento_sorologia c
			WHERE   a.nr_sequencia = c.NR_SEQ_DOACAO
			AND 	a.cd_pessoa_fisica = cd_pessoa_fisica_p
			AND	c.ie_nova_amostra = 'N'
			AND	c.dt_liberacao > clock_timestamp();
		end if;

		if (ie_retorno_w = 'N') then
			SELECT 	CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'T' END
			INTO STRICT	ie_retorno_w
			FROM 	san_doacao a,
					san_inapto_sinal_vital c
			WHERE   a.nr_sequencia = c.NR_SEQ_DOACAO
			AND 	a.cd_pessoa_fisica = cd_pessoa_fisica_p
			AND	a.ie_avaliacao_final <> 'A'
			AND	c.dt_liberacao > clock_timestamp();
		end if;
	end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION san_obter_inapto_temp ( cd_pessoa_fisica_p text) FROM PUBLIC;

