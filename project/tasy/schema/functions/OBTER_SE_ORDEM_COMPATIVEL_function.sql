-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_ordem_compativel (nr_seq_ordem_p bigint, cd_material_p bigint, cd_unidade_medida_p text, qt_dose_p bigint) RETURNS varchar AS $body$
DECLARE

								
ie_retorno_w	varchar(1) := 'N';
cd_unid_med_w	varchar(30);
qt_dose_w		double precision;
cd_material_w	bigint;
nr_sequencia_w	bigint;
ie_permite_dose_menor varchar(1);


BEGIN

ie_permite_dose_menor := obter_param_usuario(3130, 196, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_permite_dose_menor);

if (nr_seq_ordem_p IS NOT NULL AND nr_seq_ordem_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '')	and (cd_unidade_medida_p IS NOT NULL AND cd_unidade_medida_p::text <> '') and (qt_dose_p IS NOT NULL AND qt_dose_p::text <> '') then
	
	select	min(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	can_ordem_item_prescr
	where	nr_seq_ordem	= nr_seq_ordem_p
	and	coalesce(nr_sequencia_diluente::text, '') = '';

	Select	max(cd_unidade_medida),
			max(qt_dose),
			max(cd_material)
	into STRICT	cd_unid_med_w,
			qt_dose_w,
			cd_material_w
	from	can_ordem_item_prescr
	where	nr_sequencia	= nr_sequencia_w;
	
	if (cd_material_w = cd_material_p
		and (qt_dose_w = qt_dose_p or (qt_dose_w > qt_dose_p and ie_permite_dose_menor = 'S'))
		and cd_unid_med_w = cd_unidade_medida_p) then
		ie_retorno_w := 'S';
	end if;
	
end if;

return	ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_ordem_compativel (nr_seq_ordem_p bigint, cd_material_p bigint, cd_unidade_medida_p text, qt_dose_p bigint) FROM PUBLIC;

