-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION scc_get_phone_format_hl7 ( CD_PESSOA_FISICA_P text ) RETURNS varchar AS $body$
DECLARE
 ds_phone_number varchar(500) := '';
counter integer := 0;
ds_email varchar(255);

C01 CURSOR FOR SELECT substr(obter_email_pf(CD_PESSOA_FISICA_P),1,255);

-- contact info from pessoa_fisica table
C02 CURSOR FOR SELECT * from pessoa_fisica where CD_PESSOA_FISICA = CD_PESSOA_FISICA_P;
complement0 pessoa_fisica%ROWTYPE;

-- contact info from compl_pessoa_fisica table where complement type = 1 (Residencial)
C03 CURSOR FOR SELECT *
  FROM compl_pessoa_fisica
  where IE_TIPO_COMPLEMENTO = 1
  and CD_PESSOA_FISICA = CD_PESSOA_FISICA_P;
complement1 compl_pessoa_fisica%ROWTYPE;

-- contact info from compl_pessoa_fisica table where complement type = 2 (Commercial)
C04 CURSOR FOR SELECT *
  FROM compl_pessoa_fisica
  where IE_TIPO_COMPLEMENTO = 2
  and CD_PESSOA_FISICA = CD_PESSOA_FISICA_P;
complement2 compl_pessoa_fisica%ROWTYPE;


BEGIN

open C01;
loop
fetch C01 into ds_email;
EXIT WHEN NOT FOUND; /* apply on C01 */
if (ds_email IS NOT NULL AND ds_email::text <> '') then
ds_phone_number := '^NET^Internet^'||ds_email||'^^^';
counter := counter +1;
end if;
end loop;
close C01;

open C02;
loop
fetch C02 into complement0;
EXIT WHEN NOT FOUND; /* apply on C02 */
if (complement0.NR_TELEFONE_CELULAR IS NOT NULL AND complement0.NR_TELEFONE_CELULAR::text <> '') then
if (counter < 1) then
ds_phone_number := '^PRN^PH^^'||complement0.NR_DDI_CELULAR||'^'||complement0.NR_DDD_CELULAR||'^'||complement0.NR_TELEFONE_CELULAR;
else
ds_phone_number := ds_phone_number||'~'||'^PRN^PH^^'||complement0.NR_DDI_CELULAR||'^'||complement0.NR_DDD_CELULAR||'^'||complement0.NR_TELEFONE_CELULAR;
end if;
counter := counter +1;
end if;
if (complement0.NR_PAGER_BIP IS NOT NULL AND complement0.NR_PAGER_BIP::text <> '') then
if (counter < 1) then
ds_phone_number := '^PRN^BP^^^^'||complement0.NR_PAGER_BIP;
else
ds_phone_number := ds_phone_number||'~'||'^PRN^BP^^^^'||complement0.NR_PAGER_BIP;
end if;
counter := counter +1;
end if;
end loop;
close C02;

open C03;
loop
fetch C03 into complement1;
EXIT WHEN NOT FOUND; /* apply on C03 */
if (complement1.NR_TELEFONE IS NOT NULL AND complement1.NR_TELEFONE::text <> '') then
if (counter < 1) then
ds_phone_number := '^PRN^PH^^'||complement1.NR_DDI_TELEFONE||'^'||complement1.NR_DDD_TELEFONE||'^'||complement1.NR_TELEFONE;
else
ds_phone_number := ds_phone_number||'~'||'^PRN^PH^^'||complement1.NR_DDI_TELEFONE||'^'||complement1.NR_DDD_TELEFONE||'^'||complement1.NR_TELEFONE;
end if;
counter := counter +1;
end if;
if (complement1.NR_TELEFONE_CELULAR IS NOT NULL AND complement1.NR_TELEFONE_CELULAR::text <> '') then
if (counter < 1) then
ds_phone_number := '^PRN^PH^^'||complement1.NR_DDI_CELULAR||'^'||complement1.NR_DDD_CELULAR||'^'||complement1.NR_TELEFONE_CELULAR;
else
ds_phone_number := ds_phone_number||'~'||'^PRN^PH^^'||complement1.NR_DDI_CELULAR||'^'||complement1.NR_DDD_CELULAR||'^'||complement1.NR_TELEFONE_CELULAR;
end if;
counter := counter +1;
end if;
if (complement1.DS_FONE_ADIC IS NOT NULL AND complement1.DS_FONE_ADIC::text <> '') then
if (counter >= 5) then
exit;
elsif (counter < 1) then
counter := counter +1;
ds_phone_number := '^ORN^PH^^'||complement1.NR_DDI_FONE_ADIC||'^'||complement1.NR_DDD_CELULAR||'^'||complement1.DS_FONE_ADIC;
else
counter := counter +1;
ds_phone_number := ds_phone_number||'~'||'^ORN^PH^^'||complement1.NR_DDI_FONE_ADIC||'^'||complement1.NR_DDD_CELULAR||'^'||complement1.DS_FONE_ADIC;
end if;
end if;
if (complement1.DS_FAX IS NOT NULL AND complement1.DS_FAX::text <> '') then
if (counter >= 5) then
exit;
elsif (counter < 1) then
counter := counter +1;
ds_phone_number := '^PRN^FX^^'||complement1.NR_DDI_FAX||'^'||complement1.NR_DDD_FAX||'^'||complement1.DS_FAX;
else
counter := counter +1;
ds_phone_number := ds_phone_number||'~'||'^PRN^FX^^'||complement1.NR_DDI_FAX||'^'||complement1.NR_DDD_FAX||'^'||complement1.DS_FAX;
end if;
end if;
end loop;
close C03;

open C04;
loop
fetch C04 into complement2;
EXIT WHEN NOT FOUND; /* apply on C04 */
if (complement2.NR_TELEFONE IS NOT NULL AND complement2.NR_TELEFONE::text <> '') then
if (counter >= 5) then
exit;
elsif (counter < 1) then
counter := counter +1;
ds_phone_number := '^WPN^PH^^'||complement2.NR_DDI_TELEFONE||'^'||complement2.NR_DDD_TELEFONE||'^'||complement2.NR_TELEFONE;
else
counter := counter +1;
ds_phone_number := ds_phone_number||'~'||'^WPN^PH^^'||complement2.NR_DDI_TELEFONE||'^'||complement2.NR_DDD_TELEFONE||'^'||complement2.NR_TELEFONE;
end if;
end if;
if (complement2.NR_TELEFONE_CELULAR IS NOT NULL AND complement2.NR_TELEFONE_CELULAR::text <> '') then
if (counter >= 5) then
exit;
elsif (counter < 1) then
counter := counter +1;
ds_phone_number := '^WPN^PH^^'||complement2.NR_DDI_CELULAR||'^'||complement2.NR_DDD_CELULAR||'^'||complement2.NR_TELEFONE_CELULAR;
else
counter := counter +1;
ds_phone_number := ds_phone_number||'~'||'^WPN^PH^^'||complement2.NR_DDI_CELULAR||'^'||complement2.NR_DDD_CELULAR||'^'||complement2.NR_TELEFONE_CELULAR;
end if;
end if;
if (complement2.DS_FAX IS NOT NULL AND complement2.DS_FAX::text <> '') then
if (counter >= 5) then
exit;
elsif (counter < 1) then
counter := counter +1;
ds_phone_number := '^WPN^FX^^'||complement2.NR_DDI_FAX||'^'||complement2.NR_DDD_FAX||'^'||complement2.DS_FAX;
else
counter := counter +1;
ds_phone_number := ds_phone_number||'~'||'^WPN^FX^^'||complement2.NR_DDI_FAX||'^'||complement2.NR_DDD_FAX||'^'||complement2.DS_FAX;
end if;
end if;
end loop;
close C04;

  RETURN ds_phone_number;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION scc_get_phone_format_hl7 ( CD_PESSOA_FISICA_P text ) FROM PUBLIC;

