-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_ptu_especialidade_rce ( nr_seq_prestador_p bigint, nr_seq_pres_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: Obter informações quanto as especialidades e áreas de atuação dos prestadores 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
	CD_ESPEC	= cd_especialidade' 
	IE_RCE		= ie_rce 
	CD_ATUA		= cd_area_atuacao 
	IE_ATUA		= ie_rce_atuacao 
	IE_GUIA_ESPEC	= ie_guia_medico_espec 
	IE_GUIA_ATUA	= ie_guia_medico_atuacao 
------------------------------------------------------------------------------------------------------------------- 
Referências:	 
	PTU_MOVIMENTO_PRESTADOR_V, PTU_MOVIMENTO_PRESTADOR_38_V, 
	PTU_MOVIMENTO_PRESTADOR_40_V,PTU_MOVIMENTO_PRESTADOR_41_V 
	 
	PLS_OBTER_EXIBIR_GUIA_MED 
	 
 +=+=+=+=+=+=+=+=+=+=+=+=	NÃO UTILIZAR MAIS !	=+=+=+=+=+=+=+=+=+ 
 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
cd_area_atuacao1_w		varchar(255);
cd_area_atuacao2_w		varchar(255);
cd_especialidade1_w		varchar(255);
cd_especialidade2_w		varchar(255);
nr_retorno_w			varchar(10);
cd_espec_w			varchar(10);
cd_espec_ptu_w			varchar(10);
nr_rce_w			varchar(10)	:= '0';
cd_atua_w			varchar(2);
ie_tipo_prestador_w		varchar(2);
ie_rce_w			varchar(1);
ie_atuacao_w			varchar(1);
ie_guia_medico_espec_w		varchar(1);
ie_guia_medico_atuacao_w	varchar(1);
ie_valor_w			varchar(1);
cd_area_atuacao_w		numeric(20);
qt_espec_w			bigint;
nr_seq_prestador_w		bigint;
nr_seq_area_atuacao_w		bigint;


BEGIN 
if (ie_opcao_p = 'CD_ESPEC') then 
	select	max(b.cd_especialidade) 
	into STRICT	nr_retorno_w 
	from	ptu_prestador_espec	b, 
		ptu_prestador		a 
	where	b.nr_seq_prestador	= a.nr_sequencia 
	and	b.nr_seq_apres		= nr_seq_pres_p 
	and	a.nr_sequencia		= nr_seq_prestador_p;
	 
	if (nr_retorno_w = '0') then 
		nr_retorno_w := '00';
	end if;
	 
elsif (ie_opcao_p = 'CD_ATUA') then	 
	select	max(b.cd_area_atuacao) 
	into STRICT	nr_retorno_w 
	from	ptu_prestador_espec	b, 
		ptu_prestador		a 
	where	b.nr_seq_prestador	= a.nr_sequencia 
	and	b.nr_seq_apres		= nr_seq_pres_p 
	and	a.nr_sequencia		= nr_seq_prestador_p;
	 
	if (nr_retorno_w = '0') then 
		nr_retorno_w := '00';
	end if;
	 
elsif (ie_opcao_p = 'IE_RCE') then 
	select	max(b.ie_rce) 
	into STRICT	nr_retorno_w 
	from	ptu_prestador_espec	b, 
		ptu_prestador		a 
	where	b.nr_seq_prestador	= a.nr_sequencia 
	and	b.nr_seq_apres		= nr_seq_pres_p 
	and	a.nr_sequencia		= nr_seq_prestador_p;
	 
	if (coalesce(nr_retorno_w::text, '') = '') then 
		select	CASE WHEN a.ie_tipo_prestador='01' THEN  'N'  ELSE ' ' END  
		into STRICT	nr_retorno_w 
		from	ptu_prestador	a 
		where	a.nr_sequencia	= nr_seq_prestador_p;
	end if;
elsif (ie_opcao_p = 'IE_ATUA') then 
	select	max(b.ie_rce_atuacao) 
	into STRICT	nr_retorno_w 
	from	ptu_prestador_espec	b, 
		ptu_prestador		a 
	where	b.nr_seq_prestador	= a.nr_sequencia 
	and	b.nr_seq_apres		= nr_seq_pres_p 
	and	a.nr_sequencia		= nr_seq_prestador_p;
	 
	if (coalesce(nr_retorno_w::text, '') = '') then 
		select	CASE WHEN a.ie_tipo_prestador='01' THEN  'N'  ELSE ' ' END  
		into STRICT	nr_retorno_w 
		from	ptu_prestador	a 
		where	a.nr_sequencia	= nr_seq_prestador_p;
	end if;
elsif (ie_opcao_p = 'IE_GUIA_ESPEC') then	 
	select	max(b.ie_guia_medico_espec) 
	into STRICT	nr_retorno_w 
	from	ptu_prestador_espec	b, 
		ptu_prestador		a 
	where	b.nr_seq_prestador	= a.nr_sequencia 
	and	b.nr_seq_apres		= nr_seq_pres_p 
	and	a.nr_sequencia		= nr_seq_prestador_p;
	 
	if (coalesce(nr_retorno_w::text, '') = '') then 
		nr_retorno_w	:= ' ';
	end if;
elsif (ie_opcao_p = 'IE_GUIA_ATUA') then 
	select	max(b.ie_guia_medico_atuacao) 
	into STRICT	nr_retorno_w 
	from	ptu_prestador_espec	b, 
		ptu_prestador		a 
	where	b.nr_seq_prestador	= a.nr_sequencia 
	and	b.nr_seq_apres		= nr_seq_pres_p 
	and	a.nr_sequencia		= nr_seq_prestador_p;
	 
	if (coalesce(nr_retorno_w::text, '') = '') or (nr_retorno_w = 'N') then 
		nr_retorno_w	:= ' ';
	end if;
elsif (ie_opcao_p = 'NR_RCE') then	 
	select	max(b.cd_especialidade) 
	into STRICT	cd_espec_ptu_w 
	from	ptu_prestador_espec	b, 
		ptu_prestador		a 
	where	b.nr_seq_prestador	= a.nr_sequencia 
	and	b.nr_seq_apres		= nr_seq_pres_p 
	and	a.nr_sequencia		= nr_seq_prestador_p;
	 
	if (cd_espec_ptu_w IS NOT NULL AND cd_espec_ptu_w::text <> '') then 
		select	max(nr_seq_prestador) 
		into STRICT	nr_seq_prestador_w 
		from	ptu_prestador 
		where	nr_sequencia	= nr_seq_prestador_p;
		 
		select	max(a.cd_especialidade) 
		into STRICT	cd_espec_w 
		from	especialidade_medica	a 
		where	a.cd_ptu		= cd_espec_ptu_w;
		 
		begin 
		select	max(substr(pls_obter_rqe_especialidade(a.cd_pessoa_fisica, a.cd_especialidade),1,255)) 
		into STRICT	nr_retorno_w 
		from	pls_prestador_med_espec	a 
		where	a.nr_seq_prestador	= nr_seq_prestador_w 
		and	a.cd_especialidade	= cd_espec_w;
		exception 
		when others then 
			nr_retorno_w	:= null;
		end;
		 
		select	count(1) 
		into STRICT	qt_espec_w 
		from	especialidade_medica	a 
		where	a.cd_ptu		= cd_espec_ptu_w  LIMIT 2;
		 
		if (qt_espec_w > 1) and (coalesce(nr_retorno_w::text, '') = '') then 
			select	max(a.cd_especialidade) 
			into STRICT	cd_espec_w 
			from	especialidade_medica	a 
			where	a.cd_ptu		= cd_espec_ptu_w 
			and	a.cd_especialidade	<> cd_espec_w;
			 
			select	max(trim(both substr(pls_obter_rqe_especialidade(a.cd_pessoa_fisica, a.cd_especialidade),1,255))) 
			into STRICT	nr_retorno_w 
			from	pls_prestador_med_espec	a 
			where	a.nr_seq_prestador	= nr_seq_prestador_w 
			and	a.cd_especialidade	= cd_espec_w;
		end if;
	end if;
elsif (ie_opcao_p = 'NR_RCE_ATUA') then	 
	select	max(b.cd_area_atuacao) 
	into STRICT	cd_area_atuacao_w 
	from	ptu_prestador_espec	b, 
		ptu_prestador		a 
	where	b.nr_seq_prestador	= a.nr_sequencia 
	and	b.nr_seq_apres		= nr_seq_pres_p 
	and	a.nr_sequencia		= nr_seq_prestador_p;
	 
	if (cd_area_atuacao_w IS NOT NULL AND cd_area_atuacao_w::text <> '') then 
		select	max(a.nr_sequencia) 
		into STRICT	nr_seq_area_atuacao_w 
		from	area_atuacao_medica	a 
		where	a.cd_ptu	= cd_area_atuacao_w;
		 
		select	max(nr_seq_prestador) 
		into STRICT	nr_seq_prestador_w 
		from	ptu_prestador 
		where	nr_sequencia = nr_seq_prestador_p;
		 
		select	max(substr(pls_obter_rce_area_atuacao(a.cd_pessoa_fisica, a.nr_seq_area_atuacao),1,255)) 
		into STRICT	nr_retorno_w 
		from	pls_prestador_med_espec	a 
		where	a.nr_seq_prestador	= nr_seq_prestador_w 
		and	a.nr_seq_area_atuacao	= nr_seq_area_atuacao_w;
		 
		if (coalesce(nr_retorno_w::text, '') = '') then 
			select	max(substr(pls_obter_rce_area_atuacao(a.cd_pessoa_fisica, b.nr_seq_area_atuacao),1,255)) 
			into STRICT	nr_retorno_w 
			from	pls_prest_med_espec_adic	b, 
				pls_prestador_med_espec		a 
			where	a.nr_sequencia			= b.nr_seq_prest_med_espec 
			and	a.nr_seq_prestador		= nr_seq_prestador_w 
			and	b.nr_seq_area_atuacao		= nr_seq_area_atuacao_w;
		end if;
	end if;	
elsif (ie_opcao_p = 'IE_RCE_F') then 
	select	coalesce(max(b.ie_rce), 'N') 
	into STRICT	ie_rce_w 
	from	ptu_prestador_espec	b, 
		ptu_prestador		a 
	where	b.nr_seq_prestador	= a.nr_sequencia 
	and	b.nr_seq_apres		= nr_seq_pres_p 
	and	a.nr_sequencia		= nr_seq_prestador_p;
	 
	select	CASE WHEN a.ie_tipo_prestador='01' THEN  substr(obter_ptu_especialidade_rce(a.nr_sequencia, 1, 'CD_ESPEC'), 1, 2)  ELSE '0' END , 
		CASE WHEN a.ie_tipo_prestador='01' THEN  substr(obter_ptu_especialidade_rce(a.nr_sequencia, 2, 'CD_ESPEC'), 1, 2)  ELSE '0' END  
	into STRICT	cd_especialidade1_w, 
		cd_especialidade2_w 
	from	ptu_prestador	a 
	where	a.nr_sequencia	= nr_seq_prestador_p;
	 
	if (cd_especialidade1_w = cd_especialidade2_w) then 
		cd_especialidade2_w	:= '0';
	end if;
	 
	select	max(a.ie_tipo_prestador) 
	into STRICT	ie_tipo_prestador_w 
	from	ptu_prestador	a 
	where	a.nr_sequencia	= nr_seq_prestador_p;
	 
	if (ie_tipo_prestador_w = '01') and (ie_rce_w IS NOT NULL AND ie_rce_w::text <> '') and 
		((trim(both cd_especialidade1_w) <> '0') and (nr_seq_pres_p = 1)) or 
		((trim(both cd_especialidade2_w) <> '0') and (nr_seq_pres_p = 2)) then 
		nr_retorno_w	:= ie_rce_w;
	else 
		nr_retorno_w	:= 'N';
	end if;
	 
	if (coalesce(cd_especialidade2_w,'0') = '0') and (nr_seq_pres_p = 2) then 
		nr_retorno_w	:= ' ';
	end if;
	 
elsif (ie_opcao_p = 'IE_ATUA_F') then 
	select	coalesce(max(b.ie_rce_atuacao), 'N') ie_rce 
	into STRICT	ie_atuacao_w 
	from	ptu_prestador_espec	b, 
		ptu_prestador		a 
	where	b.nr_seq_prestador	= a.nr_sequencia 
	and	b.nr_seq_apres		= nr_seq_pres_p 
	and	a.nr_sequencia		= nr_seq_prestador_p;
	 
	select	max(nr_seq_prestador) 
	into STRICT	nr_seq_prestador_w 
	from	ptu_prestador 
	where	nr_sequencia	= nr_seq_prestador_p;
	 
	select	CASE WHEN a.ie_tipo_prestador='01' THEN  lpad(obter_ptu_especialidade_rce(a.nr_sequencia, 1, 'CD_ATUA'), 2, ' ')  ELSE '0' END , 
		CASE WHEN a.ie_tipo_prestador='01' THEN  lpad(obter_ptu_especialidade_rce(a.nr_sequencia, 2, 'CD_ATUA'), 2, ' ')  ELSE '0' END  
	into STRICT	cd_area_atuacao1_w, 
		cd_area_atuacao2_w 
	from	ptu_prestador	a 
	where	a.nr_sequencia	= nr_seq_prestador_p;
	 
	if (cd_area_atuacao1_w = cd_area_atuacao2_w) then 
		cd_area_atuacao2_w	:= '0';
	end if;
	 
	select	max(a.ie_tipo_prestador) 
	into STRICT	ie_tipo_prestador_w 
	from	ptu_prestador	a 
	where	a.nr_sequencia	= nr_seq_prestador_p;	
	 
	if (ie_tipo_prestador_w = '01') and (ie_atuacao_w IS NOT NULL AND ie_atuacao_w::text <> '') and 
		((trim(both cd_area_atuacao1_w) <> '0') and (nr_seq_pres_p = 1)) or 
		((trim(both cd_area_atuacao2_w) <> '0') and (nr_seq_pres_p = 2)) then 
		nr_retorno_w	:= ie_atuacao_w;
	else 
		nr_retorno_w	:= 'N';
	end if;
	 
	if (coalesce(cd_area_atuacao2_w,'0') = '0') and (nr_seq_pres_p = 2) then 
		nr_retorno_w	:= ' ';
	end if;
end if;
 
return nr_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_ptu_especialidade_rce ( nr_seq_prestador_p bigint, nr_seq_pres_p bigint, ie_opcao_p text) FROM PUBLIC;

