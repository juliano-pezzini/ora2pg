-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_orientacao_preparo_proc (nr_seq_proc_interno_p bigint, cd_estabelecimento_p bigint, nr_seq_topografia_p bigint DEFAULT NULL, ie_tipo_atendimento_p bigint DEFAULT NULL) RETURNS varchar AS $body$
DECLARE


TYPE lista_macros IS TABLE OF varchar(255) INDEX BY integer;
					
  return_w       varchar(6000) := '';
  ds_orientacao_ageint_w       varchar(4000) := '';
  nr_row         bigint := 0;
  ds_separador_w varchar(3) := chr(10);
  qt_valor_w	AGEINT_ORIENT_PREP_MACRO.vl_macro%type := 0;
  lista_macros_w	lista_macros;
  ind	bigint;
  ds_lista_macro_w varchar(4000) := ageint_obter_macro_prep('S');
  ds_macro_w varchar(255) := '';

  i RECORD;

BEGIN

	ind := 1;
	while(length(ds_lista_macro_w) > 0) loop
		ds_macro_w := substr(ds_lista_macro_w, 1, position(';' in ds_lista_macro_w)-1);
		ds_lista_macro_w := substr(ds_lista_macro_w, position(';' in ds_lista_macro_w)+1);
		lista_macros_w(ind) := ds_macro_w;
		ind := ind+1;
	end loop;

   FOR i IN (SELECT  ds_orientacao_preparo,
                    nr_sequencia AS nr_row
              FROM (SELECT aop.nr_sequencia,
                           aopr.nr_seq_orient_preparo,
                           aop.ds_orientacao_preparo
                      FROM ageint_orient_preparo    aop,
                           ageint_orient_prep_regra aopr
                     WHERE aop.nr_sequencia = aopr.nr_seq_orient_preparo
                       AND coalesce(aopr.nr_seq_proc_interno, nr_seq_proc_interno_p) = nr_seq_proc_interno_p
                       AND coalesce(aopr.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p
		       AND coalesce(aopr.nr_seq_topografia, coalesce(nr_seq_topografia_p,0)) = coalesce(nr_seq_topografia_p,0)
		       --AND nvl(aopr.ie_tipo_atendimento, nvl(ie_tipo_atendimento_p,0)) = nvl(ie_tipo_atendimento_p,0)
                       AND aop.ie_situacao = 'A'
					   AND coalesce(aop.ie_tipo_orient, 'P') = 'P'
                     ORDER BY coalesce(aopr.nr_seq_apres,999), aop.nr_sequencia) alias7) LOOP
    IF nr_row  <> i.nr_row THEN
		ds_orientacao_ageint_w := i.ds_orientacao_preparo;
		if (ds_orientacao_ageint_w IS NOT NULL AND ds_orientacao_ageint_w::text <> '') then
			ind := lista_macros_w.last;
			while(ind > 0) loop
				select coalesce(max(vl_macro),0)
				into STRICT qt_valor_w
				from AGEINT_ORIENT_PREP_MACRO a
				where ie_macro = ind
				and a.nr_seq_orient_prep_regra in (SELECT nr_sequencia
								from AGEINT_ORIENT_PREP_REGRA x
								where coalesce(x.cd_estabelecimento,cd_estabelecimento_p) = cd_estabelecimento_p
								and coalesce(x.nr_seq_proc_interno,nr_seq_proc_interno_p) = nr_seq_proc_interno_p
								AND coalesce(x.nr_seq_topografia, coalesce(nr_seq_topografia_p,0)) = coalesce(nr_seq_topografia_p,0)
								--AND nvl(x.ie_tipo_atendimento, nvl(ie_tipo_atendimento_p,0)) = nvl(ie_tipo_atendimento_p,0)
								);
				ds_orientacao_ageint_w := replace_macro_clob(ds_orientacao_ageint_w, lista_macros_w(ind), qt_valor_w);
				ind := ind-1;
			end loop;
		end if;
        return_w := return_w || ds_orientacao_ageint_w || ds_separador_w;
        nr_row := i.nr_row;
    END IF;

  END LOOP;

  RETURN return_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_orientacao_preparo_proc (nr_seq_proc_interno_p bigint, cd_estabelecimento_p bigint, nr_seq_topografia_p bigint DEFAULT NULL, ie_tipo_atendimento_p bigint DEFAULT NULL) FROM PUBLIC;

