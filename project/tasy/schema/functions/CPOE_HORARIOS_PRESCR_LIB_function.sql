-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_horarios_prescr_lib ( nr_seq_cpoe_p bigint, ie_tipo_item_p text) RETURNS varchar AS $body$
DECLARE


ie_itens_liberados_w	varchar(1);
nr_prescricao_w         bigint;
nr_seq_item_w		bigint;
ie_agrupador_w		bigint;	
				

BEGIN

if (ie_tipo_item_p in ('M', 'MAT', 'SOL')) then
	
	/*Verifica se o item possui algum horario liberado*/

	select	coalesce(max('S'), 'N')
	into STRICT	ie_itens_liberados_w
	from	prescr_material a,
			cpoe_material b
	where	b.nr_sequencia = nr_seq_cpoe_p
	and		a.nr_seq_mat_cpoe = b.nr_sequencia
	and		a.ie_agrupador in (1, 2, 4)
	and		horarios_prescr_lib(a.nr_prescricao, a.nr_sequencia , a.ie_agrupador) = 'S';
	
elsif (ie_tipo_item_p in ('SNE', 'S')) then

	/* Primeiro pega a maior prescricao para depois pegar o maior agrupador e maior sequencia dela */

	select  max(a.nr_prescricao)
	into STRICT 	nr_prescricao_w
	from	prescr_material a,
			cpoe_dieta b
	where	a.nr_seq_dieta_cpoe = b.nr_Sequencia
	and     b.nr_Sequencia = nr_seq_cpoe_p
	and 	ie_agrupador in (8,12);
	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
		select  max(a.nr_sequencia),
				max(a.ie_agrupador)		
		into STRICT 	nr_seq_item_w, 
				ie_agrupador_w 
		from	prescr_material a,
				cpoe_dieta b
		where	a.nr_seq_dieta_cpoe = b.nr_Sequencia
		and     b.nr_Sequencia = nr_seq_cpoe_p
		and     a.nr_prescricao = nr_prescricao_w
		and 	ie_agrupador in (8,12);
	end if;
	
	ie_itens_liberados_w := horarios_prescr_lib(nr_prescricao_w, nr_seq_item_w , ie_agrupador_w);
	
elsif (ie_tipo_item_p = 'P') then

	/* Primeiro pega a maior prescricao para depois pegar o maior agrupador e maior sequencia dela */

	select 	max(a.nr_prescricao)
	into STRICT 	nr_prescricao_w
	from 	prescr_procedimento a,
			cpoe_procedimento b 
	where 	a.nr_seq_proc_cpoe = b.nr_sequencia
	and   	(b.ds_horarios IS NOT NULL AND b.ds_horarios::text <> '')
	and		(a.ds_horarios IS NOT NULL AND a.ds_horarios::text <> '')
	and   	b.nr_sequencia = nr_seq_cpoe_p;
	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
		select 	max(a.nr_sequencia)
		into STRICT 	nr_seq_item_w
		from 	prescr_procedimento a,
				cpoe_procedimento b 
		where 	a.nr_seq_proc_cpoe = b.nr_sequencia
		and   	(b.ds_horarios IS NOT NULL AND b.ds_horarios::text <> '')
		and		coalesce(a.nr_seq_origem::text, '') = ''
		and 	a.nr_prescricao = nr_prescricao_w
		and   	b.nr_sequencia = nr_seq_cpoe_p;		
	end if;
	
	ie_itens_liberados_w := horarios_prescr_lib(nr_prescricao_w, nr_seq_item_w , 5);
	
elsif (ie_tipo_item_p = 'D') then
	/* Primeiro pega a maior prescricao para depois pegar o maior agrupador e maior sequencia dela */

	select 	max(a.nr_prescricao)
	into STRICT 	nr_prescricao_w
	from 	prescr_dieta a,
			cpoe_dieta b
	where 	a.nr_seq_dieta_cpoe = b.nr_sequencia
	and   	(b.ds_horarios IS NOT NULL AND b.ds_horarios::text <> '')
	and   	b.nr_sequencia = nr_seq_cpoe_p;
	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
		select 	max(a.nr_sequencia)
		into STRICT 	nr_seq_item_w
		from 	prescr_dieta a,
				cpoe_dieta b 
		where 	a.nr_seq_dieta_cpoe = b.nr_sequencia
		and   	(b.ds_horarios IS NOT NULL AND b.ds_horarios::text <> '')
		and 	a.nr_prescricao = nr_prescricao_w
		and   	b.nr_sequencia = nr_seq_cpoe_p;		
	end if;
	
	select	coalesce(max('S'),'N')
	into STRICT	ie_itens_liberados_w
	from	prescr_dieta_hor
	where	nr_prescricao = nr_prescricao_w
	and		nr_seq_dieta = nr_seq_item_w
	and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
elsif (ie_tipo_item_p = 'R') then
	/* Primeiro pega a maior prescricao para depois pegar o maior agrupador e maior sequencia dela */

	select 	max(a.nr_prescricao)
	into STRICT 	nr_prescricao_w
	from 	prescr_recomendacao a,
			cpoe_recomendacao b
	where 	a.nr_seq_rec_cpoe = b.nr_sequencia
	and   	(b.ds_horarios IS NOT NULL AND b.ds_horarios::text <> '')
	and   	b.nr_sequencia = nr_seq_cpoe_p;
	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
		select 	max(a.nr_sequencia)
		into STRICT 	nr_seq_item_w
		from 	prescr_recomendacao a,
				cpoe_recomendacao b 
		where 	a.nr_seq_rec_cpoe = b.nr_sequencia
		and   	(b.ds_horarios IS NOT NULL AND b.ds_horarios::text <> '')
		and 	a.nr_prescricao = nr_prescricao_w
		and   	b.nr_sequencia = nr_seq_cpoe_p;
	end if;
	
	select	coalesce(max('S'),'N')
	into STRICT	ie_itens_liberados_w
	from	prescr_rec_hor
	where	nr_prescricao = nr_prescricao_w
	and		nr_seq_recomendacao = nr_seq_item_w
	and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');

elsif (ie_tipo_item_p = 'O') then

	select	max(a.nr_prescricao)
	into STRICT	nr_prescricao_w
	from	prescr_gasoterapia a,
			cpoe_gasoterapia b
	where	a.nr_seq_gas_cpoe = b.nr_sequencia
	and		(b.ds_horarios IS NOT NULL AND b.ds_horarios::text <> '')
	and		(a.ds_horarios IS NOT NULL AND a.ds_horarios::text <> '')
	and		b.nr_sequencia = nr_seq_cpoe_p;

	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then

		select	max(a.nr_sequencia)
		into STRICT	nr_seq_item_w
		from	prescr_gasoterapia a,
				cpoe_gasoterapia b
		where	a.nr_seq_gas_cpoe = b.nr_sequencia
		and		(b.ds_horarios IS NOT NULL AND b.ds_horarios::text <> '')
		and		a.nr_prescricao = nr_prescricao_w
		and		b.nr_sequencia = nr_seq_cpoe_p;

	end if;

	select	coalesce(max('S'),'N')
	into STRICT	ie_itens_liberados_w
	from	prescr_gasoterapia_hor
	where	nr_prescricao = nr_prescricao_w
	and		nr_seq_gasoterapia = nr_seq_item_w
	and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');

else
	ie_itens_liberados_w := 'N';
end if;

return ie_itens_liberados_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_horarios_prescr_lib ( nr_seq_cpoe_p bigint, ie_tipo_item_p text) FROM PUBLIC;

