-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_setor_estab_atend (nr_atendimento_p bigint, cd_setor_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE

			 
cd_estab_atend_w	smallint;
cd_estab_atual_w	smallint;
ie_retorno_w		varchar(1):= 'S';
cd_estab_setor_w	smallint;
qt_passagem_estab_w	bigint;
ie_estabelecimento_conta_w	varchar(1);
			

BEGIN 
 
select 	max(cd_estabelecimento) 
into STRICT	cd_estab_atend_w 
from 	atendimento_paciente 
where 	nr_atendimento = nr_atendimento_p;
 
select 	wheb_usuario_pck.get_cd_estabelecimento 
into STRICT	cd_estab_atual_w
;
 
select	coalesce(max(ie_estabelecimento_conta), 'A') 
into STRICT	ie_estabelecimento_conta_w 
from	parametro_faturamento 
where	cd_estabelecimento = cd_estab_atual_w;
 
if (ie_estabelecimento_conta_w = 'S') and (cd_estab_atend_w <> cd_estab_atual_w) then 
 
	begin 
 
	select	max(cd_estabelecimento_base) 
	into STRICT	cd_estab_setor_w 
	from	setor_atendimento 
	where	cd_setor_atendimento	= cd_setor_atendimento_p;
 
	 
	if (cd_estab_setor_w = cd_estab_atend_w) and -- estabelecimento base do setor é IGUAL do estabelecimento do atendimento 
		(cd_estab_setor_w <> cd_estab_atual_w) then -- estabelecimento base do setor é DIFERENTE ao estabelecimento atual do usuário logado 
	 
		select 	count(*) 
		into STRICT	qt_passagem_estab_w 
		from 	atend_paciente_unidade a, 
			setor_atendimento	b 
		where 	a.nr_atendimento = nr_atendimento_p 
		and 	a.cd_setor_atendimento = b.cd_setor_atendimento 
		and 	b.cd_estabelecimento_base = cd_estab_atual_w;
	 
		if (qt_passagem_estab_w = 0) then 
			ie_retorno_w:= 'N';
		end if;
		 
	end if;
	 
	end;
end if;
 
return	ie_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_setor_estab_atend (nr_atendimento_p bigint, cd_setor_atendimento_p bigint) FROM PUBLIC;

