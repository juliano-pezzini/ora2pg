-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_atend_administrado_pa (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w				varchar(255);
qt_mat_tot_w				integer;

dt_referencia_w				timestamp;
dt_fim_horario_w			timestamp;
qt_prescricao_w				bigint;
qt_prescr_criadas_w			bigint;
qt_prescr_atend_w			bigint;
qt_total_pend_w				bigint;

ie_mat_adm_w 				char(1);
ie_prescr_pend_lib_w		char(1);
ie_prescr_pend_lib_ww		char(1);


BEGIN

dt_referencia_w				:= clock_timestamp() - interval '2 days';
ds_retorno_w				:= 'N';

select	count(nr_prescricao)
into STRICT	qt_prescricao_w
from	prescr_medica
where	nr_atendimento = nr_atendimento_p;

if (qt_prescricao_w > 0) then
	select	count(a.nr_prescricao)
	into STRICT	qt_mat_tot_w
	from	prescr_medica a
	where	nr_atendimento	= nr_atendimento_p
	and	(dt_liberacao_medico IS NOT NULL AND dt_liberacao_medico::text <> '')
	and	coalesce(DT_SUSPENSAO::text, '') = ''
	and	exists (SELECT 1
				from prescr_mat_hor x
				where 	x.nr_prescricao = a.nr_prescricao
				and 	OBTER_SE_HORARIO_LIBERADO(x.dt_lib_horario, x.dt_horario) = 'S'
				and	coalesce(x.dt_suspensao::text, '') = ''
				and (x.dt_fim_horario IS NOT NULL AND x.dt_fim_horario::text <> '')
				
union all

				SELECT 1
				from 	prescr_proc_hor x
				where 	x.nr_prescricao = a.nr_prescricao
				and 	OBTER_SE_HORARIO_LIBERADO(x.dt_lib_horario, x.dt_horario) = 'S'
				and	substr(obter_se_proc_enfermagem_pa(x.cd_procedimento,x.ie_origem_proced),1,1) = 'S'
				and	coalesce(x.dt_suspensao::text, '') = ''
				and (x.dt_fim_horario IS NOT NULL AND x.dt_fim_horario::text <> '')
				
union all

				Select 1 
				from 	prescr_rec_hor x
				where 	x.nr_prescricao = a.nr_prescricao
				and	coalesce(x.dt_suspensao::text, '') = ''
				and (x.dt_fim_horario IS NOT NULL AND x.dt_fim_horario::text <> '')
				and 	OBTER_SE_HORARIO_LIBERADO(x.dt_lib_horario, x.dt_horario) = 'S');
	
	if (qt_mat_tot_w	> 0) then
	
		select	coalesce(max('S'), 'N')
		into STRICT	ie_prescr_pend_lib_ww
		from	prescr_medica
		where	nr_atendimento	= nr_atendimento_p
		and	(dt_liberacao_medico IS NOT NULL AND dt_liberacao_medico::text <> '')
		and	coalesce(dt_liberacao::text, '') = '';
		
		ie_mat_adm_w            := 'N';
		ie_prescr_pend_lib_w    := 'N';
		
		if (ie_prescr_pend_lib_ww	= 'N') then
			Select  coalesce(max('S'), 'N')
			into STRICT	ie_prescr_pend_lib_w
			from 	prescr_medica a
			where a.nr_atendimento = nr_atendimento_p
			and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
			and	coalesce(a.dt_liberacao::text, '') = ''
			and not exists (SELECT 1
					from prescr_mat_hor x
					where x.nr_prescricao = a.nr_prescricao
					and OBTER_SE_HORARIO_LIBERADO(x.dt_lib_horario, x.dt_horario) = 'S'
					
union all

					SELECT 1 
					from prescr_proc_hor x
					where x.nr_prescricao = a.nr_prescricao
					and OBTER_SE_HORARIO_LIBERADO(x.dt_lib_horario, x.dt_horario) = 'S'
					
union all

					Select 1 
					from prescr_rec_hor x
					where x.nr_prescricao = a.nr_prescricao
					and OBTER_SE_HORARIO_LIBERADO(x.dt_lib_horario, x.dt_horario) = 'S');
			
			
			if (ie_prescr_pend_lib_w	= 'N') then
								
				select	coalesce(max('S'), 'N')
				into STRICT	ie_mat_adm_w
				from	prescr_mat_hor c,
						prescr_material b,
						prescr_medica a
				where 	a.nr_atendimento = nr_atendimento_p	
				and		c.nr_seq_material = b.nr_sequencia
				and		c.nr_prescricao = b.nr_prescricao
				and		b.nr_prescricao = a.nr_prescricao
				and		coalesce(c.dt_fim_horario::text, '') = ''
				and		coalesce(c.dt_suspensao::text, '') = ''
				and		coalesce(c.ie_situacao,'A') = 'A'
				and		coalesce(c.ie_adep,'S') = 'S'
				and		coalesce(c.ie_horario_especial,'N') <> 'S'
				and		b.ie_agrupador =1
				and		coalesce(a.ie_adep,'S') = 'S'
				and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S';
				
				if (ie_mat_adm_w	= 'N') then
					select	coalesce(max('S'), 'N')
					into STRICT	ie_mat_adm_w
					from	prescr_mat_hor c,
							prescr_material b,
							prescr_medica a
					where	a.nr_atendimento = nr_atendimento_p	
					and		c.nr_seq_material = b.nr_sequencia
					and		c.nr_prescricao = b.nr_prescricao
					and		b.nr_prescricao = a.nr_prescricao
					and		coalesce(c.dt_fim_horario::text, '') = ''
					and		coalesce(c.dt_suspensao::text, '') = ''
					and		coalesce(c.ie_situacao,'A') = 'A'
					and		coalesce(c.ie_adep,'S') = 'S'
					and		coalesce(c.ie_horario_especial,'N') <> 'S'
					and		b.ie_agrupador = 4
					and		obter_se_gerar_item_adep('M',b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'N') = 'S'
					and		coalesce(a.ie_adep,'S') = 'S'
					and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
					and		substr(obter_status_solucao_prescr(1, b.nr_prescricao, b.nr_sequencia_solucao),1,3) = 'N';
					
					
					if (ie_mat_adm_w	= 'N') then
						select	coalesce(max('S'), 'N')
						into STRICT	ie_mat_adm_w
						from	prescr_proc_hor c,
								prescr_procedimento b,
								prescr_medica a
						where	a.nr_atendimento = nr_atendimento_p	
						and		c.nr_prescricao = b.nr_prescricao
						and		c.nr_seq_procedimento = b.nr_sequencia
						and		b.nr_prescricao = a.nr_prescricao
						and		coalesce(c.dt_fim_horario::text, '') = ''
						and		coalesce(c.dt_suspensao::text, '') = ''
						and		coalesce(c.ie_situacao,'A') = 'A'
						and		coalesce(c.ie_horario_especial,'N') <> 'S'
						and		coalesce(b.nr_seq_solic_sangue::text, '') = ''
						and		coalesce(b.nr_seq_derivado::text, '') = ''
						and		coalesce(b.nr_seq_prot_glic::text, '') = ''
						and		((coalesce(b.nr_seq_proc_interno::text, '') = '') or (obter_ctrl_glic_proc(b.nr_seq_proc_interno) = 'NC'))
						and		coalesce(a.ie_adep,'S') = 'S'
						and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
						and		substr(obter_se_proc_enfermagem_pa(b.cd_procedimento,b.ie_origem_proced),1,1) = 'S'
						and		adep_obter_se_apres_hor_proc('PROC', wheb_usuario_pck.get_cd_estabelecimento, a.cd_setor_atendimento, obter_perfil_ativo, b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno, b.cd_setor_atendimento) = 'S'
						and		adep_obter_regra_inclusao(	'PROC',
															wheb_usuario_pck.get_cd_estabelecimento,  
															wheb_usuario_pck.get_cd_setor_atendimento, 
															obter_perfil_ativo, 
															null, 
															b.cd_procedimento, 
															b.ie_origem_proced, 
															b.nr_seq_proc_interno,
															a.cd_setor_Atendimento,
															b.cd_setor_atendimento,
															a.nr_prescricao,
															b.nr_seq_exame) = 'S'; -- nr_seq_exame_p
					end if;
					
				end if;
				
				
			
			end if;
		
		end if;
		
		
		if (ie_mat_adm_w	= 'N') and (ie_prescr_pend_lib_w = 'N') and (ie_prescr_pend_lib_ww	= 'N')then
			ds_retorno_w	:= 'S';
		end if;
	end if;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_atend_administrado_pa (nr_atendimento_p bigint) FROM PUBLIC;

