-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_oc_cta_obter_restr_mat (ie_opcao_p text, dados_regra_p pls_tipos_ocor_pck.dados_regra, cursor_p integer, dados_filtro_mat_p pls_tipos_ocor_pck.dados_filtro_mat) RETURNS varchar AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Montar as restrições e binds dos campos de filtro de material das ocorrências
combinadas
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
Quando houver campo IMP, não esquecer de tratar..

Alterações:
--------------------------------------------------------------------------------------------------------------------
francisco OS 657536 - 31/10/2013
Alteração: Incluído tratamento para nova restrição de filtro NR_SEQ_ESTRUT_MAT
--------------------------------------------------------------------------------------------------------------------
jjung OS 609316 - 24/01/2014

Alteração:	Eliminando table function pls_grupos_pck.obter_materiais_estrutura. Substituída pela
	pls_estrutura_material_v.

Motivo:	Não dá para usar, muito lenta. A view se comportou melhor.
--------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
/* IE_OPCAO_P
RESTRICAO -Obter restrições
BIND - Atualizar Binds
*/
ds_restricao_w		varchar(4000);

BEGIN

ds_restricao_w := null;

-- Sequência do material
if (dados_filtro_mat_p.nr_seq_material IS NOT NULL AND dados_filtro_mat_p.nr_seq_material::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		ds_restricao_w := ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.nr_seq_material = :nr_seq_material ';
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_material', dados_filtro_mat_p.nr_seq_material);
	end if;
end if;

-- Grupo do material
if (dados_filtro_mat_p.nr_seq_grupo_material IS NOT NULL AND dados_filtro_mat_p.nr_seq_grupo_material::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		ds_restricao_w := ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	exists	(select	1 '  || pls_tipos_ocor_pck.enter_w ||
										'		from	pls_grupo_material_tm x ' || pls_tipos_ocor_pck.enter_w ||
										'		where	x.nr_seq_material = mat.nr_seq_material ' || pls_tipos_ocor_pck.enter_w ||
										'		and	x.nr_seq_grupo = :nr_seq_grupo_material)';
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_grupo_material', dados_filtro_mat_p.nr_seq_grupo_material);
	end if;
end if;

/* Tipo despesa */

if (dados_filtro_mat_p.ie_tipo_despesa_mat IS NOT NULL AND dados_filtro_mat_p.ie_tipo_despesa_mat::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		if (dados_regra_p.ie_evento = 'IMP') then
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.ie_tipo_despesa_imp = :ie_tipo_despesa';
		else
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.ie_tipo_despesa = :ie_tipo_despesa';
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':ie_tipo_despesa', dados_filtro_mat_p.ie_tipo_despesa_mat);
	end if;
end if;

/* Dia semana */

if (dados_filtro_mat_p.dt_dia_semana IS NOT NULL AND dados_filtro_mat_p.dt_dia_semana::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		if (dados_regra_p.ie_evento = 'IMP') then
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.dt_dia_semana_imp = :dt_dia_semana';
		else
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.dt_dia_semana = :dt_dia_semana';
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':dt_dia_semana', dados_filtro_mat_p.dt_dia_semana);
	end if;
end if;
/* Feriado */

if (dados_filtro_mat_p.ie_feriado = 'S') then
	if (ie_opcao_p = 'RESTRICAO') then
		if (dados_regra_p.ie_evento = 'IMP') then
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	exists	(select	1' || pls_tipos_ocor_pck.enter_w ||
									'		from	feriado x' || pls_tipos_ocor_pck.enter_w ||
									'		where	x.cd_estabelecimento = :cd_estabelecimento' || pls_tipos_ocor_pck.enter_w ||
									'		and	x.dt_feriado = mat.dt_atendimento_imp_trunc)';
		else
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	exists	(select	1' || pls_tipos_ocor_pck.enter_w ||
									'		from	feriado x' || pls_tipos_ocor_pck.enter_w ||
									'		where	x.cd_estabelecimento = :cd_estabelecimento' || pls_tipos_ocor_pck.enter_w ||
									'		and	x.dt_feriado = mat.dt_atendimento_trunc)';
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_estabelecimento', dados_regra_p.cd_estabelecimento);
	end if;
end if;
/*Tipo feriado */

if (dados_filtro_mat_p.ie_tipo_feriado IS NOT NULL AND dados_filtro_mat_p.ie_tipo_feriado::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		if (dados_regra_p.ie_evento = 'IMP') then
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	exists	(select	1' || pls_tipos_ocor_pck.enter_w ||
									'		from	feriado x' || pls_tipos_ocor_pck.enter_w ||
									'		where	x.cd_estabelecimento = :cd_estabelecimento' || pls_tipos_ocor_pck.enter_w ||
									'		and	x.dt_feriado = mat.dt_atendimento_imp_trunc' || pls_tipos_ocor_pck.enter_w ||
									'		and	x.ie_tipo_feriado = :ie_tipo_feriado)';
		else
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	exists	(select	1' || pls_tipos_ocor_pck.enter_w ||
									'		from	feriado x' || pls_tipos_ocor_pck.enter_w ||
									'		where	x.cd_estabelecimento = :cd_estabelecimento' || pls_tipos_ocor_pck.enter_w ||
									'		and	x.dt_feriado = mat.dt_atendimento_trunc'|| pls_tipos_ocor_pck.enter_w ||
									'		and	x.ie_tipo_feriado = :ie_tipo_feriado)';
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_estabelecimento', dados_regra_p.cd_estabelecimento);
		dbms_sql.bind_variable(cursor_p, ':ie_tipo_feriado', dados_filtro_mat_p.ie_tipo_feriado);
	end if;
end if;
/* Hora inicial */

if (dados_filtro_mat_p.hr_inicial IS NOT NULL AND dados_filtro_mat_p.hr_inicial::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		if (dados_regra_p.ie_evento = 'IMP') then
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.hr_inicio_mat_imp >= :hr_inicial';
		else
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.hr_inicio_mat >= :hr_inicial';
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':hr_inicial', to_date(to_char(dados_filtro_mat_p.hr_inicial,'hh24:mi:ss'),'hh24:mi:ss'));
	end if;
end if;
/* Hora final */

if (dados_filtro_mat_p.hr_final IS NOT NULL AND dados_filtro_mat_p.hr_final::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		if (dados_regra_p.ie_evento = 'IMP') then
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.hr_fim_mat_imp <= :hr_final';
		else
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.hr_fim_mat <= :hr_final';
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':hr_final', to_date(to_char(dados_filtro_mat_p.hr_final,'hh24:mi:ss'),'hh24:mi:ss'));
	end if;
end if;
/* Valor mínimo */

if (dados_filtro_mat_p.vl_minimo_item IS NOT NULL AND dados_filtro_mat_p.vl_minimo_item::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		/* Se for valor calculado */

		if (dados_filtro_mat_p.ie_consistencia_valor = 'C') then
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.vl_material >= :vl_minimo';
		/* Se for valor apresentado */

		else
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.vl_material_imp >= :vl_minimo';
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':vl_minimo', dados_filtro_mat_p.vl_minimo_item);
	end if;
end if;
/* Valor máximo*/

if (dados_filtro_mat_p.vl_max_item IS NOT NULL AND dados_filtro_mat_p.vl_max_item::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		/* Se for valor calculado */

		if (dados_filtro_mat_p.ie_consistencia_valor = 'C') then
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.vl_material <= :vl_maximo';
		/* Se for valor apresentado */

		else
			ds_restricao_w	:= ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	mat.vl_material_imp <= :vl_maximo';
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':vl_maximo', dados_filtro_mat_p.vl_max_item);
	end if;
end if;
/* Estrutura de material */

if (dados_filtro_mat_p.nr_seq_estrut_mat IS NOT NULL AND dados_filtro_mat_p.nr_seq_estrut_mat::text <> '') then
	if (ie_opcao_p = 'RESTRICAO') then
		ds_restricao_w := ds_restricao_w || pls_tipos_ocor_pck.enter_w || 'and	exists	(select	1 '  || pls_tipos_ocor_pck.enter_w ||
										  '		from	pls_estrutura_material_tm  estrut_mat ' || pls_tipos_ocor_pck.enter_w ||
										  '		where	estrut_mat.nr_seq_estrutura = :nr_seq_estrut_mat ' || pls_tipos_ocor_pck.enter_w ||
										  '		and	estrut_mat.nr_seq_material = mat.nr_seq_material) ';
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_estrut_mat', dados_filtro_mat_p.nr_seq_estrut_mat);
	end if;
end if;

return	ds_restricao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_oc_cta_obter_restr_mat (ie_opcao_p text, dados_regra_p pls_tipos_ocor_pck.dados_regra, cursor_p integer, dados_filtro_mat_p pls_tipos_ocor_pck.dados_filtro_mat) FROM PUBLIC;

