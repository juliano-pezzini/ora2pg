-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION verifica_se_despesa_superior ( nr_seq_despesa_p bigint, vl_despesa_p bigint, nr_seq_classif_desp_p bigint, nr_seq_viagem_p bigint, dt_despesa_p timestamp) RETURNS varchar AS $body$
DECLARE


cd_cgc_w		varchar(14);
vl_despesa_w		double precision;
nr_seq_relat_w		bigint;
nr_seq_cliente_w	bigint;
vl_despesa_acordo_w	double precision;
ds_macro_w		varchar(255);
ds_retorno_w		varchar(255);
dt_saida_prev_w		timestamp;
ie_periodo_despesa_w	varchar(1);
dt_despesa_w		timestamp;
qt_despesa_w		bigint;
nr_seq_projeto_w	bigint;


BEGIN
select	count(*)
into STRICT	qt_despesa_w
from	via_relat_desp b,
	via_despesa a
where	a.nr_seq_relat = b.nr_sequencia
and	a.nr_seq_classif_desp = nr_seq_classif_desp_p
and	b.nr_seq_viagem = nr_seq_viagem_p;

select	max(c.cd_cnpj),
	max(nr_seq_proj)
into STRICT	cd_cgc_w,
	nr_seq_projeto_w
from	via_destino c
where	c.nr_seq_viagem = nr_seq_viagem_p;

select	coalesce(max(a.nr_seq_cliente),0)
into STRICT	nr_seq_cliente_w
from	proj_projeto a
where	a.nr_sequencia = nr_seq_projeto_w;

if (nr_seq_cliente_w = 0) then
	begin
	select	max(nr_sequencia)
	into STRICT	nr_seq_cliente_w
	from	com_cliente
	where	cd_cnpj = cd_cgc_w;
	end;
end if;

if (qt_despesa_w > 0) then

	select	max(coalesce(b.vl_despesa,0)),
		max(b.ie_periodo_despesa)
	into STRICT	vl_despesa_acordo_w,
		ie_periodo_despesa_w
	from	com_cliente_acordo a,
		com_cliente_acordo_desp b
	where	a.nr_sequencia = b.nr_seq_acordo
	and	b.nr_seq_classif_desp = nr_seq_classif_desp_p
	and	a.nr_seq_cliente = nr_seq_cliente_w;
	
	if (ie_periodo_despesa_w = 'D') then

		select	sum(coalesce(a.vl_despesa,0))
		into STRICT	vl_despesa_w
		from	via_despesa a,
			via_relat_desp b
		where	a.nr_seq_relat = b.nr_sequencia
		and	b.nr_seq_viagem = nr_seq_viagem_p
		and	nr_seq_classif_desp = nr_seq_classif_desp_p
		and	a.nr_sequencia <> nr_seq_despesa_p
		and	to_char(dt_despesa) = to_char(dt_despesa_p);
		
		vl_despesa_w := coalesce(vl_despesa_w,0) + coalesce(vl_despesa_p,0);
				
		if (vl_despesa_acordo_w < vl_despesa_w) then

			/*
			O valor da despesa é superior ao valor estipulado no acordo com o cliente!
			Valor do acordo: #@VL_DESPESA_ACORDO#@. Valor das despesas: #@VL_DESPESA#@
			*/
			ds_macro_w	:= 'VL_DESPESA_ACORDO=' || vl_despesa_acordo_w || ';VL_DESPESA=' || vl_despesa_w;
			ds_retorno_w	:= obter_desc_exp_idioma(944537, wheb_usuario_pck.get_nr_seq_idioma, ds_macro_w);

		end if;
	end if;
	
	if (ie_periodo_despesa_w = 'S') then

		select	sum(coalesce(a.vl_despesa,0))
		into STRICT	vl_despesa_w
		from	via_despesa a,
			via_relat_desp b
		where	a.nr_seq_relat = b.nr_sequencia
		and	b.nr_seq_viagem = nr_seq_viagem_p
		and	nr_seq_classif_desp = nr_seq_classif_desp_p
		and	a.nr_sequencia <> nr_seq_despesa_p
		and	dt_despesa between obter_inicio_fim_semana(dt_despesa_p,'I') and obter_inicio_fim_semana(dt_despesa_p,'F');

		vl_despesa_w := coalesce(vl_despesa_w,0) + coalesce(vl_despesa_p,0);
		
		if (vl_despesa_acordo_w < vl_despesa_w) then

			/*
			O valor da despesa é superior ao valor semanal estipulado no acordo com o cliente!
			Valor do acordo: #@VL_DESPESA_ACORDO#@. Valor das despesas: #@VL_DESPESA#@
			*/
			ds_macro_w	:= 'VL_DESPESA_ACORDO=' || vl_despesa_acordo_w || ';VL_DESPESA=' || vl_despesa_w;
			ds_retorno_w	:= obter_desc_exp_idioma(944539, wheb_usuario_pck.get_nr_seq_idioma, ds_macro_w);

		end if;
	end if;
	
	if (ie_periodo_despesa_w = 'Q') then

		select	trunc(dt_saida_prev,'dd')
		into STRICT	dt_saida_prev_w
		from	via_viagem
		where	nr_sequencia = nr_seq_viagem_p;
	
		select	sum(coalesce(a.vl_despesa,0))
		into STRICT	vl_despesa_w
		from	via_despesa a,
			via_relat_desp b
		where	a.nr_seq_relat = b.nr_sequencia
		and	b.nr_seq_viagem = nr_seq_viagem_p
		and	nr_seq_classif_desp = nr_seq_classif_desp_p
		and	a.nr_sequencia <> nr_seq_despesa_p
		and	dt_despesa between dt_saida_prev_w and (trunc(dt_saida_prev_w,'dd') + 11);
			
		vl_despesa_w := coalesce(vl_despesa_w,0) + coalesce(vl_despesa_p,0);
		
		if (vl_despesa_acordo_w < vl_despesa_w) then

			/*
			O valor da despesa é superior ao valor semanal estipulado no acordo com o cliente!
			Valor do acordo: #@VL_DESPESA_ACORDO#@. Valor das despesas: #@VL_DESPESA#@
			*/
			ds_macro_w	:= 'VL_DESPESA_ACORDO=' || vl_despesa_acordo_w || ';VL_DESPESA=' || vl_despesa_w;
			ds_retorno_w	:= obter_desc_exp_idioma(944539, wheb_usuario_pck.get_nr_seq_idioma, ds_macro_w);

		end if;
	end if;
	
else

	select	max(coalesce(b.vl_despesa,0)),
		max(b.ie_periodo_despesa)
	into STRICT	vl_despesa_acordo_w,
		ie_periodo_despesa_w
	from	com_cliente_acordo a,
		com_cliente_acordo_desp b
	where	a.nr_sequencia = b.nr_seq_acordo
	and	b.nr_seq_classif_desp = nr_seq_classif_desp_p
	and	a.nr_seq_cliente = nr_seq_cliente_w;

		if (vl_despesa_acordo_w < vl_despesa_p) then

			/*
			O valor da despesa é superior ao valor estipulado no acordo com o cliente!
			Valor do acordo: #@VL_DESPESA_ACORDO#@. Valor das despesas: #@VL_DESPESA#@
			*/
			ds_macro_w	:= 'VL_DESPESA_ACORDO=' || vl_despesa_acordo_w || ';VL_DESPESA=' || vl_despesa_w;
			ds_retorno_w	:= obter_desc_exp_idioma(944537, wheb_usuario_pck.get_nr_seq_idioma, ds_macro_w);

		end if;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION verifica_se_despesa_superior ( nr_seq_despesa_p bigint, vl_despesa_p bigint, nr_seq_classif_desp_p bigint, nr_seq_viagem_p bigint, dt_despesa_p timestamp) FROM PUBLIC;

