-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tot_os_test_equip_dano ( CD_TESTER_P bigint, NR_SEQ_EQUIPAMENTO_P bigint, DS_DANO_BREVE_P text, TIPO_P text) RETURNS bigint AS $body$
DECLARE

 PR_RETORNO_W	bigint := 0;

BEGIN

  IF TIPO_P = 'D' THEN --Development
    BEGIN
      SELECT COUNT(1)
        INTO STRICT PR_RETORNO_W
        FROM MAN_ORDEM_SERVICO OS
       WHERE OS.CD_PESSOA_SOLICITANTE         = CD_TESTER_P
         AND OS.NR_SEQ_EQUIPAMENTO            = NR_SEQ_EQUIPAMENTO_P
         AND trim(both UPPER(OS.DS_DANO_BREVE)) LIKE DS_DANO_BREVE_P
         AND OS.NR_SEQ_ESTAGIO NOT IN (SELECT NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE)
         AND OS.NR_SEQ_ESTAGIO NOT IN (9);
	  EXCEPTION
	  	WHEN no_data_found THEN
	  		PR_RETORNO_W := 0;
	  	WHEN OTHERS THEN
	  		PR_RETORNO_W := 0;
  	END;
  ELSIF TIPO_P = 'V' THEN --VeV
    BEGIN
      SELECT COUNT(1)
        INTO STRICT PR_RETORNO_W
        FROM MAN_ORDEM_SERVICO OS
       WHERE OS.CD_PESSOA_SOLICITANTE         = CD_TESTER_P
         AND OS.NR_SEQ_EQUIPAMENTO            = NR_SEQ_EQUIPAMENTO_P
         AND trim(both UPPER(OS.DS_DANO_BREVE)) LIKE DS_DANO_BREVE_P
         AND OS.NR_SEQ_ESTAGIO IN (SELECT NR_SEQ_ESTAGIO FROM VW_ESTAGIOS_TESTE);
	  EXCEPTION
	  	WHEN no_data_found THEN
	  		PR_RETORNO_W := 0;
	  	WHEN OTHERS THEN
	  		PR_RETORNO_W := 0;
  	END;
  ELSIF TIPO_P = 'E' THEN --Closed
    BEGIN
      SELECT COUNT(1)
        INTO STRICT PR_RETORNO_W
        FROM MAN_ORDEM_SERVICO OS
       WHERE OS.CD_PESSOA_SOLICITANTE         = CD_TESTER_P
         AND OS.NR_SEQ_EQUIPAMENTO            = NR_SEQ_EQUIPAMENTO_P
         AND trim(both UPPER(OS.DS_DANO_BREVE)) LIKE DS_DANO_BREVE_P
         AND OS.NR_SEQ_ESTAGIO IN (9);
	  EXCEPTION
	  	WHEN no_data_found THEN
	  		PR_RETORNO_W := 0;
	  	WHEN OTHERS THEN
	  		PR_RETORNO_W := 0;
  	END;
  ELSIF TIPO_P = 'T' THEN --Total
    BEGIN
      SELECT COUNT(1)
        INTO STRICT PR_RETORNO_W
        FROM MAN_ORDEM_SERVICO OS
       WHERE OS.CD_PESSOA_SOLICITANTE         = CD_TESTER_P
         AND OS.NR_SEQ_EQUIPAMENTO            = NR_SEQ_EQUIPAMENTO_P
         AND trim(both UPPER(OS.DS_DANO_BREVE)) LIKE DS_DANO_BREVE_P;
	  EXCEPTION
	  	WHEN no_data_found THEN
	  		PR_RETORNO_W := 0;
	  	WHEN OTHERS THEN
	  		PR_RETORNO_W := 0;
  	END;
  END IF;

RETURN	PR_RETORNO_W;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tot_os_test_equip_dano ( CD_TESTER_P bigint, NR_SEQ_EQUIPAMENTO_P bigint, DS_DANO_BREVE_P text, TIPO_P text) FROM PUBLIC;

