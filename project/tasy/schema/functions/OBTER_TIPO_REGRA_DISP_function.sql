-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_tipo_regra_disp ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, cd_material_p bigint, nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


ds_retorno_w				varchar(5) := 'XPTO';
cd_unid_med_w				varchar(30);
ie_regra_disp_w				varchar(1)	:= 'X';
cd_convenio_w				integer	:= 0;
cd_setor_w					integer	:= 0;
cd_unidade_medida_estoque_w	varchar(30);
cd_perfil_w					bigint;
ie_motivo_prescricao_w		varchar(3);
cd_material_estoque_w   	integer;
qt_mat_w					integer;
nr_atendimento_w			prescr_medica.nr_atendimento%type;
ie_acm_w					prescr_material.ie_acm%type;
ie_se_necessario_w			prescr_material.ie_se_necessario%type;
cd_intervalo_w				prescr_material.cd_intervalo%type;
ie_via_aplicacao_w			prescr_material.ie_via_aplicacao%type;
cd_unidade_medida_dose_w	prescr_material.cd_unidade_medida_dose%type;

C01 CURSOR FOR
	SELECT	ie_regra_disp
	from	material_regra_disp
	where	1 = 1
	and		(((coalesce(cd_unid_med_w,cd_unidade_medida) = cd_unidade_medida) and (ie_unidade_medida = 1)) or
			 ((coalesce(cd_unidade_medida_dose_w,cd_unidade_medida) = cd_unidade_medida) and (ie_unidade_medida = 2)) or
			 ((coalesce(cd_unidade_medida_estoque_w,cd_unidade_medida) = cd_unidade_medida) and (ie_unidade_medida = 3)) or (coalesce(cd_unidade_medida::text, '') = ''))
	and		(((coalesce(ie_acm_sn,'X') = 'N') and (coalesce(ie_acm_w,'N')  = 'N') and (coalesce(ie_se_necessario_w,'N') = 'N')) or
			 ((coalesce(ie_acm_sn,'X') = 'S') and
			  ((coalesce(ie_acm_w,'N') = 'S') or (coalesce(ie_se_necessario_w,'N') = 'S'))) or (coalesce(ie_acm_sn,'X') = 'X'))
	and		coalesce(cd_unid_med_estoque, cd_unidade_medida_estoque_w) = cd_unidade_medida_estoque_w
	and		((coalesce(ie_via_aplicacao::text, '') = '') or (coalesce(ie_via_aplicacao, ie_via_aplicacao_w) = ie_via_aplicacao_w))
	and		((coalesce(cd_intervalo::text, '') = '') or (coalesce(cd_intervalo, cd_intervalo_w) = cd_intervalo_w))
	and		coalesce(cd_convenio, cd_convenio_w)		= cd_convenio_w
	and		coalesce(cd_setor_atendimento,cd_setor_w)	= cd_setor_w
	and		(((coalesce(cd_material, cd_material_p)	= cd_material_p) and (coalesce(ie_material_estoque,'N') = 'N')) or
			((coalesce(cd_material, cd_material_estoque_w)	= cd_material_estoque_w) and (coalesce(ie_material_estoque,'N') = 'S')))
	and		((coalesce(nr_seq_estrut_int::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrut_int,cd_material_p) = 'S'))
	and		coalesce(cd_perfil, cd_perfil_w) = cd_perfil_w
	and		cd_estabelecimento	= cd_estabelecimento_p
	and 	((coalesce(ie_motivo_prescricao::text, '') = '') or (ie_motivo_prescricao = ie_motivo_prescricao_w))
	order by 	coalesce(cd_material,0),
				coalesce(cd_convenio,0),
				coalesce(cd_setor_atendimento,0),
				coalesce(cd_unidade_medida,'zzzz') desc,
				coalesce(ie_via_aplicacao,'zzzz') desc,
				coalesce(nr_seq_estrut_int,0),
				coalesce(cd_intervalo,'a');



BEGIN

cd_perfil_w		:= coalesce(obter_perfil_ativo,0);

select	count(cd_material)
into STRICT 	qt_mat_w
from	material
where	cd_material	= cd_material_p;

if (qt_mat_w > 0) and (nr_prescricao_p > 0) then

	select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo,
			substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UME'),1,30) cd_unidade_medida_estoque,
			substr(obter_dados_material(cd_material_p,'EST'),1,30)into
			cd_unid_med_w,
			cd_unidade_medida_estoque_w,
			cd_material_estoque_w
	from	Material
	where	cd_material	= cd_material_p;

	select	max(nr_atendimento),
			max(ie_motivo_prescricao)
	into STRICT	nr_atendimento_w,
			ie_motivo_prescricao_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;

	select	coalesce(max(cd_convenio),0),
			coalesce(max(cd_setor_atendimento),0)
	into STRICT	cd_convenio_w,
			cd_setor_w
	from	atendimento_paciente_v
	where	nr_atendimento = nr_atendimento_w;

	select	max(ie_via_aplicacao),
			max(cd_intervalo),
			coalesce(max(ie_acm),'N'),
			coalesce(max(ie_se_necessario),'N'),
			max(cd_unidade_medida_dose)
	into STRICT	ie_via_aplicacao_w,
			cd_intervalo_w,
			ie_acm_w,
			ie_se_necessario_w,
			cd_unidade_medida_dose_w
	from	prescr_material
	where	nr_prescricao = nr_prescricao_p
	and		nr_sequencia = nr_sequencia_p;

	open	c01;
	loop
	fetch	c01 into
			ie_regra_disp_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		ie_regra_disp_w			:= ie_regra_disp_w;
	end loop;
	close c01;

	ds_retorno_w	:= ie_regra_disp_w;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_tipo_regra_disp ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, cd_material_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

