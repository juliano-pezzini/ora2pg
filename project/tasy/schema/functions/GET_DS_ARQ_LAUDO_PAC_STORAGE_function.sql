-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_ds_arq_laudo_pac_storage (nr_sequencia_p laudo_paciente.nr_sequencia%TYPE) RETURNS varchar AS $body$
DECLARE

posicaoIniCaminho smallint;
posicaofimcaminho smallint;
posicaofimnome    smallint;
lengthw           smallint;
ds_storage        varchar(4200);
storagew          varchar(4200);
ds_path           varchar(4200);
cduuid            varchar(4200);
nomeArq           varchar(4200);

BEGIN
   select coalesce(ds_arquivo,'')
     into STRICT ds_storage
     from laudo_paciente 
    where nr_sequencia = nr_sequencia_p;

   if (ds_storage <> '') then
     select position('://' in ds_storage) 
        into STRICT posicaoinicaminho
;
      if (posicaoinicaminho > 0) then
        select length(ds_storage) into STRICT lengthw;

        select substr(ds_storage,posicaoinicaminho + 3, lengthw)
          into STRICT storagew 
;
        
        select position('/' in storagew) 
          into STRICT posicaofimcaminho
;

        select substr(storagew,0,posicaofimcaminho)
          into STRICT cduuid
;

        cduuid := replace(replace(cduuid,'MEDICAL_REPORT_PROCESSING_PDF.',''),'/','');

        select a.ds_path
          into STRICT ds_path
          from file_storage_path a
         where cd_uuid = cduuid;

         select length(storagew) into STRICT lengthw;
         select substr(storagew, posicaofimcaminho, lengthw)
           into STRICT storagew
;
         
        select position('?' in storagew) 
          into STRICT posicaofimnome
;

        select substr(storagew, 2, posicaofimnome -2) 
           into STRICT  nomeArq
;
      end if;
     return ds_path ||'\'||nomearq;
   end if;
   return null;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_ds_arq_laudo_pac_storage (nr_sequencia_p laudo_paciente.nr_sequencia%TYPE) FROM PUBLIC;

