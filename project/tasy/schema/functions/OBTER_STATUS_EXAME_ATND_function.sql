-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_status_exame_atnd (atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


retorno_w varchar(1);
qtd_exame_w bigint;
nr_prescricao_w bigint;
qtd_prescrito_w bigint;
qtd_nao_laudado_w bigint;
qtd_laudado_w bigint;


BEGIN
  retorno_w := 'X';

  select count(1)
  into STRICT qtd_exame_w
  from prescr_medica prescr_med
  inner join prescr_procedimento prescr_proc
    ON (prescr_med.nr_prescricao = prescr_proc.nr_prescricao)
  where prescr_med.nr_atendimento = atendimento_p
    and coalesce(prescr_proc.nr_seq_exame::text, '') = '';

  if (qtd_exame_w > 0 ) then
      --todos procedimentos do atendimento com laudo
      select case when count(1) = qtd_exame_w then 'F' else 'X' end
      into STRICT retorno_w
      from prescr_medica prescr_med
      inner join prescr_procedimento prescr_proc
	ON (prescr_med.nr_prescricao = prescr_proc.nr_prescricao)
      where prescr_med.nr_atendimento = atendimento_p
        and prescr_proc.ie_status_execucao = '40'
        and (prescr_proc.dt_integracao IS NOT NULL AND prescr_proc.dt_integracao::text <> '')
        and coalesce(prescr_proc.nr_seq_exame::text, '') = '';
  end if;

  if (retorno_w = 'X') then
    --pelo menos 1 procedimento com laudo no atendimento
    select case when count(1) > 0 then 'L' else 'X' end
    into STRICT retorno_w
    from prescr_medica prescr_med
    inner join prescr_procedimento prescr_proc
      ON (prescr_med.nr_prescricao = prescr_proc.nr_prescricao)
    where prescr_med.nr_atendimento = atendimento_p
      and prescr_proc.ie_status_execucao = '40'
      and (prescr_proc.dt_integracao IS NOT NULL AND prescr_proc.dt_integracao::text <> '')
      and coalesce(prescr_proc.nr_seq_exame::text, '') = '';
  end if;

  if (retorno_w = 'X') then
    --procedimento pendente
    select case when count(1) > 0 then 'P' else 'X' end
    into STRICT retorno_w
    from prescr_medica prescr_med
    inner join prescr_procedimento prescr_proc
      ON (prescr_med.nr_prescricao = prescr_proc.nr_prescricao)
    where prescr_med.nr_atendimento = atendimento_p
      and prescr_proc.ie_status_execucao < '20'
      and (prescr_proc.dt_integracao IS NOT NULL AND prescr_proc.dt_integracao::text <> '')
      and coalesce(prescr_proc.nr_seq_exame::text, '') = '';
  end if;

  if (retorno_w = 'X') then
    --pelo menos 1 procedimento executado no atendimento
    select case when count(1) > 0 then 'C' else 'X' end
    into STRICT retorno_w
    from prescr_medica prescr_med
    inner join prescr_procedimento prescr_proc
      ON (prescr_med.nr_prescricao = prescr_proc.nr_prescricao)
    where prescr_med.nr_atendimento = atendimento_p
      and prescr_proc.ie_status_execucao = '20'
      and (prescr_proc.dt_integracao IS NOT NULL AND prescr_proc.dt_integracao::text <> '')
      and coalesce(prescr_proc.nr_seq_exame::text, '') = '';
  end if;

  if (retorno_w = 'X') then
    --Sem procedimentos prescritos.
    select case when count(1) > 0 then 'N' else 'X' end
    into STRICT retorno_w
    from prescr_medica prescr_med
    inner join prescr_procedimento prescr_proc
      ON (prescr_med.nr_prescricao = prescr_proc.nr_prescricao)
    where prescr_med.nr_atendimento = atendimento_p
      and prescr_proc.ie_status_execucao = '10'
      and coalesce(prescr_proc.dt_integracao::text, '') = ''
      and coalesce(prescr_proc.nr_seq_exame::text, '') = '';
  end if;

  if (retorno_w = 'X') then
    retorno_w := 'N';
  end if;

  return retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_status_exame_atnd (atendimento_p bigint) FROM PUBLIC;

