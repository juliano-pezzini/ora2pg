-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_if_sensitive_field_pan (nm_table_p text, nm_field_p text) RETURNS varchar AS $body$
DECLARE

is_sensitive_field_w	varchar(1) := 'N';
cd_perfil_w		perfil.cd_perfil%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_funcao_w		funcao.cd_funcao%type;
cd_setor_w		setor_atendimento.cd_setor_atendimento%type;
nm_usuario_w		usuario.nm_usuario%type;


BEGIN

if (nm_table_p IS NOT NULL AND nm_table_p::text <> '') and (nm_field_p IS NOT NULL AND nm_field_p::text <> '') then

    cd_perfil_w		 := coalesce(obter_perfil_ativo,0);
    cd_estabelecimento_w := coalesce(obter_estabelecimento_ativo,1);
    cd_funcao_w		 := coalesce(obter_funcao_ativa,0);
    cd_setor_w		 := coalesce(obter_setor_ativo,0);
    nm_usuario_w	 := coalesce(obter_usuario_ativo, 'Tasy');

    if (upper(nm_table_p) = 'W_PAN_PACIENTE') then
	begin
        select coalesce(max(ie_informacao_sensivel),'N')
        into STRICT  is_sensitive_field_w
        from  tabela_atributo
        where nm_tabela = upper(nm_table_p)
        and   nm_atributo = upper(nm_field_p);
	
	select	coalesce(max(ie_sensitive), is_sensitive_field_w)
	into STRICT	is_sensitive_field_w
	from	tabela_atrib_regra
	where 	nm_tabela  = upper(nm_table_p)
	and	nm_atributo = upper(nm_field_p)
	and  	coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
	and	coalesce(cd_perfil, cd_perfil_w) = cd_perfil_w
	and	coalesce(cd_setor_atendimento, cd_setor_w) = cd_setor_w
	and	coalesce(cd_funcao, cd_funcao_w) = cd_funcao_w
	and	coalesce(nm_usuario_param, nm_usuario_w) = nm_usuario_w;
	
	exception
	when others then
	   is_sensitive_field_w := 'N';
	end;
	
	
	if (coalesce(is_sensitive_field_w, 'N') = 'Y') then
	    is_sensitive_field_w := 'S';
	end if;

    end if;
end if;

return	is_sensitive_field_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_if_sensitive_field_pan (nm_table_p text, nm_field_p text) FROM PUBLIC;

