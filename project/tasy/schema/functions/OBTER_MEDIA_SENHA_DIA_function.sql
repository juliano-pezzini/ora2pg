-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_media_senha_dia ( nm_monitor_p text default null, qt_horas_p bigint default 0) RETURNS bigint AS $body$
DECLARE


qt_minutos_w	bigint;


BEGIN

if (nm_monitor_p IS NOT NULL AND nm_monitor_p::text <> '') then
	if (coalesce(qt_horas_p, 0) > 0) then
		select	avg((select obter_dif_espera_senha_min(nr_sequencia, 'A', coalesce(dt_chamada, dt_primeira_chamada)) ))
		into STRICT	qt_minutos_w
		from	paciente_senha_fila
		where	(dt_chamada IS NOT NULL AND dt_chamada::text <> '')
		and (SELECT obter_se_fila_chama_monitor(nr_seq_fila_senha, nm_monitor_p, cd_estabelecimento) ) = 'S'
		and (select Obter_Minutos_Espera(dt_geracao_senha, clock_timestamp())/60 ) <= qt_horas_p
		and	dt_geracao_senha between trunc(clock_timestamp()) and trunc(clock_timestamp())+86399/86400;
	else
		select	avg((select obter_dif_espera_senha_min(nr_sequencia, 'A', coalesce(dt_chamada, dt_primeira_chamada)) ))
		into STRICT	qt_minutos_w
		from	paciente_senha_fila
		where	(dt_chamada IS NOT NULL AND dt_chamada::text <> '')
		and (SELECT obter_se_fila_chama_monitor(nr_seq_fila_senha, nm_monitor_p, cd_estabelecimento) ) = 'S'
		and	dt_geracao_senha between trunc(clock_timestamp()) and trunc(clock_timestamp())+86399/86400;
	end if;
else
	if (coalesce(qt_horas_p, 0) > 0) then
		select	avg((select obter_dif_espera_senha_min(nr_sequencia, 'A', coalesce(dt_chamada, dt_primeira_chamada)) ))
		into STRICT	qt_minutos_w
		from	paciente_senha_fila
		where	(dt_chamada IS NOT NULL AND dt_chamada::text <> '')
		and	dt_geracao_senha between trunc(clock_timestamp()) and trunc(clock_timestamp())+86399/86400
		and (SELECT Obter_Minutos_Espera(dt_geracao_senha, clock_timestamp())/60 ) <= qt_horas_p;
	else
		select	avg((select obter_dif_espera_senha_min(nr_sequencia, 'A', coalesce(dt_chamada, dt_primeira_chamada)) ))
		into STRICT	qt_minutos_w
		from	paciente_senha_fila
		where	(dt_chamada IS NOT NULL AND dt_chamada::text <> '')
		and	dt_geracao_senha between trunc(clock_timestamp()) and trunc(clock_timestamp())+86399/86400;
	end if;
end if;


return	qt_minutos_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_media_senha_dia ( nm_monitor_p text default null, qt_horas_p bigint default 0) FROM PUBLIC;

