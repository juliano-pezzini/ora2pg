-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pat_obter_fim_deprec (nr_seq_bem_p bigint) RETURNS timestamp AS $body$
DECLARE


dt_valor_w		    pat_valor_bem.dt_valor%TYPE;
dt_fim_deprec_w		pat_bem.dt_inicio_uso%TYPE;
qt_mes_restantes_w	bigint;
tx_deprec_w			pat_bem.tx_deprec%TYPE;
vl_deprec_mes_w     pat_valor_bem.vl_deprec_mes%TYPE;
vl_saldo_w          pat_valor_bem.vl_contabil%TYPE;
dt_fim_deprec_ww    bigint;


BEGIN
	begin
		select a.vl_deprec_mes,
	        a.vl_contabil,
	        a.dt_valor
	    into STRICT vl_deprec_mes_w,
	        vl_saldo_w,
	        dt_valor_w
	    from pat_valor_bem a
	 	where a.nr_seq_bem = nr_seq_bem_p
	    and a.dt_valor = (SELECT max(b.dt_valor) from pat_valor_bem b where b.nr_seq_bem = a.nr_seq_bem);
	exception
	    when no_data_found then
	    	vl_deprec_mes_w := 0;
	    	vl_saldo_w := 0;
	    	dt_valor_w := null;
	    when too_many_rows then
	    	vl_deprec_mes_w := null;
	    	vl_saldo_w := 0;
	    	dt_valor_w := null;
	    when others then
	    	vl_deprec_mes_w := null;
	    	vl_saldo_w := 0;
	    	dt_valor_w := null;
	end;

	if (coalesce(vl_deprec_mes_w,0) > 0) then
		qt_mes_restantes_w := ceil(vl_saldo_w/vl_deprec_mes_w);
	else
		begin
			select max(dt_inicio_uso)
			into STRICT dt_valor_w
			from pat_bem
			where nr_sequencia = nr_seq_bem_p;
		end;

		tx_deprec_w := pat_obter_taxa_depreciacao(nr_seq_bem_p);

        if (tx_deprec_w <> 0) then
        	qt_mes_restantes_w := ceil(100/(tx_deprec_w/12));

            if qt_mes_restantes_w > 0 then
                qt_mes_restantes_w := (qt_mes_restantes_w / 12);
                dt_fim_deprec_ww := (to_char(dt_valor_w,'YYYY'))::numeric  + qt_mes_restantes_w;

                if dt_fim_deprec_ww > 9999 then /* Tratamento para o erro Ora-01841 */
                    qt_mes_restantes_w := 0;
                end if;
            
            end if;
		else
			qt_mes_restantes_w := 0;	
		end if;

        -- Adicionar os meses previstos a data do ultimo valor gerado
        dt_fim_deprec_w := PKG_DATE_UTILS.ADD_MONTH(dt_valor_w,qt_mes_restantes_w, 0);

        -- Obter o ultimo dia do mes para considerar com fim da depreciacao
        dt_fim_deprec_w := PKG_DATE_UTILS.start_of(fim_mes(dt_fim_deprec_w),'dd', 0);

    end if;

	return	dt_fim_deprec_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pat_obter_fim_deprec (nr_seq_bem_p bigint) FROM PUBLIC;

