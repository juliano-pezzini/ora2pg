-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION consiste_ordem_retira_prot (nr_interno_conta_p conta_paciente.nr_interno_conta%type) RETURNS varchar AS $body$
DECLARE

 
 
nr_atendimento_w			conta_paciente.nr_atendimento%type;
nr_seq_ordem_w			conta_paciente.nr_seq_ordem%type;
cd_convenio_parametro_w		convenio.cd_convenio%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ie_consiste_seq_conta_w		convenio_estabelecimento.ie_consiste_seq_conta%type:='N';
qt_contas_w			bigint;
ds_retorno_w			varchar(1):='N';


BEGIN 
 
begin 
	select	nr_atendimento, 
		nr_seq_ordem, 
		cd_convenio_parametro, 
		cd_estabelecimento 
	into STRICT	nr_atendimento_w, 
		nr_seq_ordem_w, 
		cd_convenio_parametro_w, 
		cd_estabelecimento_w 
	from	conta_paciente 
	where	nr_interno_conta = nr_interno_conta_p;
exception 
when others then 
	nr_atendimento_w:=0;
	nr_seq_ordem_w:=0;
	cd_convenio_parametro_w:=0;
	cd_estabelecimento_w:=0;
end;
 
ie_consiste_seq_conta_w := Obter_Valor_Conv_Estab(cd_convenio_parametro_w,cd_estabelecimento_w,'IE_CONSISTE_SEQ_CONTA');
 
if coalesce(ie_consiste_seq_conta_w,'N') = 'A' or 
  coalesce(ie_consiste_seq_conta_w,'N') = 'B' then 
	 
	if	coalesce(nr_atendimento_w,0) > 0 and 
		coalesce(nr_seq_ordem_w,0) > 0 then 
 
		select	count(1) 
		into STRICT	qt_contas_w 
		from	conta_paciente 
		where	nr_atendimento = nr_atendimento_w 
		and	nr_seq_ordem > nr_seq_ordem_w 
		and	coalesce(ie_cancelamento::text, '') = '' 
		and	(nr_seq_protocolo IS NOT NULL AND nr_seq_protocolo::text <> '');
		 
		if qt_contas_w > 0 then 
			ds_retorno_w:=ie_consiste_seq_conta_w;
		else 
			ds_retorno_w:='N';
		end if;
 
	end if;
else 
	ds_retorno_w:='N';
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION consiste_ordem_retira_prot (nr_interno_conta_p conta_paciente.nr_interno_conta%type) FROM PUBLIC;

