-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_hbsportes_relat ( nr_cirurgia_p bigint) RETURNS varchar AS $body$
DECLARE

 
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
dt_cirurgia_w		timestamp;
cd_convenio_w		bigint;
cd_edicao_amb_w		integer;
nr_atendimento_w	bigint;
cd_retorno_w		integer;


BEGIN 
 
select	cd_procedimento_princ, 
	ie_origem_proced, 
	coalesce(dt_inicio_real, dt_inicio_prevista), 
	coalesce(nr_atendimento,0) 
into STRICT	cd_procedimento_w, 
	ie_origem_proced_w, 
	dt_cirurgia_w, 
	nr_atendimento_w 
from	cirurgia 
where	nr_cirurgia	= nr_cirurgia_p;
 
select	obter_convenio_atendimento(nr_atendimento_w) 
into STRICT	cd_convenio_w
;
 
if (ie_origem_proced_w	= 5) then 
	select	max(a.nr_porte_anest) 
	into STRICT	cd_retorno_w 
	from	cbhpm_preco a 
	where	a.cd_procedimento	= cd_procedimento_w 
	and	a.ie_origem_proced	= ie_origem_proced_w 
	and	a.dt_vigencia		= 
		(SELECT max(coalesce(x.dt_vigencia,clock_timestamp() - interval '3650 days')) 
		from 	cbhpm_preco x 
		where	x.cd_procedimento	= cd_procedimento_w 
		and	x.ie_origem_proced	= ie_origem_proced_w 
		and	x.dt_vigencia		<= dt_cirurgia_w);
else 
	select	max(cd_edicao_amb) 
	into STRICT	cd_edicao_amb_w 
	from 	convenio_amb 
	where (cd_convenio      = cd_convenio_w) 
 	and (coalesce(ie_situacao,'A')	= 'A') 
 	and 	(dt_inicio_vigencia   = 
	   	(SELECT max(dt_inicio_vigencia) 
	    	from 	convenio_amb a 
    		where (a.cd_convenio     = cd_convenio_w) 
	  	and (coalesce(a.ie_situacao,'A')= 'A') 
     	and (a.dt_inicio_vigencia <= dt_cirurgia_w)));
 
	select	coalesce(max(qt_porte_anestesico),0) 
	into STRICT	cd_retorno_w 
	from 	preco_amb a 
	where (a.cd_edicao_amb  	= cd_edicao_amb_w) 
	and (a.cd_procedimento 	= cd_procedimento_w) 
 	and 	coalesce(a.dt_inicio_vigencia,clock_timestamp() - interval '3650 days')	= 
			(SELECT max(coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days')) 
			from 	preco_amb b 
			where 	b.cd_edicao_amb		= cd_edicao_amb_w 
			and	b.cd_procedimento		= cd_procedimento_w 
			and	coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days') <= dt_cirurgia_w);
end if;
 
return	cd_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_hbsportes_relat ( nr_cirurgia_p bigint) FROM PUBLIC;

