-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_lote_contest ( nr_seq_lote_contest_p bigint, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


ds_retorno_w			varchar(255);
nr_seq_congenere_w		pls_congenere.nr_sequencia%type;
nr_seq_ptu_fatura_w		ptu_fatura.nr_sequencia%type;
nr_seq_pls_fatura_w		pls_fatura.nr_sequencia%type;
nr_titulo_w			titulo_receber.nr_titulo%type;
nr_titulo_pag_w			titulo_pagar.nr_titulo%type;
nr_seq_lote_discussao_w		pls_lote_discussao.nr_sequencia%type;
ie_envio_recebimento_w		pls_lote_contestacao.ie_envio_recebimento%type;
vl_titulo_w			titulo_receber.vl_titulo%type;
vl_pago_fatura_w		pls_lote_contestacao.vl_pago_fatura%type;
nr_fatura_w			ptu_fatura.nr_fatura%type;
vl_saldo_titulo_w		titulo_receber.vl_saldo_titulo%type;
cd_unimed_w			ptu_fatura.cd_unimed_destino%type;
nr_seq_camara_w			pls_camara_compensacao.nr_sequencia%type;
ie_tipo_arquivo_w		pls_lote_discussao.ie_tipo_arquivo%type;
vl_apresentado_w		pls_lote_discussao.vl_apresentado%type;

/*
'PC' - Verifica se o título da fatura está pago Integral (Retorna 'I') ou Parcial (Retorna 'P')
*/
BEGIN
if (ie_opcao_p = 'UO') then
	select	substr(pls_obter_seq_cod_cooperativa(null,a.nr_seq_congenere),1,70)
	into STRICT	ds_retorno_w
	from	pls_lote_contestacao	b,
		pls_fatura		a
	where	b.nr_seq_pls_fatura	= a.nr_sequencia
	and	b.nr_sequencia		= nr_seq_lote_contest_p
	and	b.ie_envio_recebimento	= 'R';

elsif (ie_opcao_p = 'UD') then
	select	max(cd_unimed_origem)
	into STRICT	ds_retorno_w
	from	pls_lote_contestacao	b,
		ptu_fatura		a
	where	b.nr_seq_ptu_fatura	= a.nr_sequencia
	and	b.nr_sequencia		= nr_seq_lote_contest_p
	and	b.ie_envio_recebimento	= 'E';

elsif (ie_opcao_p = 'UC') then
	select	max(cd_unimed_origem)
	into STRICT	ds_retorno_w
	from	pls_lote_contestacao	b,
		ptu_fatura		a
	where	b.nr_seq_ptu_fatura	= a.nr_sequencia
	and	b.nr_sequencia		= nr_seq_lote_contest_p
	and	b.ie_envio_recebimento	= 'E';

	if (coalesce(ds_retorno_w::text, '') = '') then
		begin
		select	lpad(x.cd_unimed_destino,4,'0')
		into STRICT	ds_retorno_w
		from	pls_lote_contestacao	b,
			ptu_fatura		x,
			pls_fatura		a
		where	b.nr_seq_pls_fatura	= a.nr_sequencia
		and	a.nr_sequencia		= x.nr_seq_pls_fatura
		and	b.nr_sequencia		= nr_seq_lote_contest_p
		and	b.ie_envio_recebimento	= 'R';
		exception
		when others then
			ds_retorno_w := null;
		end;

		if (coalesce(ds_retorno_w::text, '') = '') then
			select	substr(pls_obter_seq_cod_cooperativa(null,a.nr_seq_congenere),1,70)
			into STRICT	ds_retorno_w
			from	pls_lote_contestacao	b,
				pls_fatura		a
			where	b.nr_seq_pls_fatura	= a.nr_sequencia
			and	b.nr_sequencia		= nr_seq_lote_contest_p
			and	b.ie_envio_recebimento	= 'R';
		end if;
	end if;

elsif (ie_opcao_p = 'UA') then
	/* Pagamento */

	select	max(a.cd_unimed_origem)
	into STRICT	ds_retorno_w
	from	pls_lote_contestacao	b,
		ptu_fatura		a
	where	b.nr_seq_ptu_fatura	= a.nr_sequencia
	and	b.nr_sequencia		= nr_seq_lote_contest_p
	and	b.ie_envio_recebimento	= 'E';

	/* Faturamento */

	if (coalesce(ds_retorno_w::text, '') = '') then
		select	max(a.nr_seq_congenere)
		into STRICT	nr_seq_congenere_w
		from	pls_lote_contestacao	b,
			pls_fatura		a
		where	b.nr_seq_pls_fatura	= a.nr_sequencia
		and	b.nr_sequencia		= nr_seq_lote_contest_p
		and	b.ie_envio_recebimento	= 'R';

		if (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '') then
			ds_retorno_w := pls_obter_seq_cod_cooperativa(null,nr_seq_congenere_w);
		end if;
	end if;

	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		select	max(ie_permite_ajius)
		into STRICT	ds_retorno_w
		from	pls_congenere
		where	(cd_cooperativa)::numeric  = (ds_retorno_w)::numeric;
	else
		ds_retorno_w := 'N';
	end if;

elsif (ie_opcao_p = 'UDC') then
	select	max(cd_unimed_origem)
	into STRICT	ds_retorno_w
	from	pls_lote_contestacao	b,
		ptu_fatura		a
	where	b.nr_seq_ptu_fatura	= a.nr_sequencia
	and	b.nr_sequencia		= nr_seq_lote_contest_p
	and	b.ie_envio_recebimento	= 'E';

	if (coalesce(ds_retorno_w::text, '') = '') then
		select	substr(pls_obter_seq_cod_cooperativa(null,a.nr_seq_congenere),1,70)
		into STRICT	ds_retorno_w
		from	pls_lote_contestacao	b,
			pls_fatura		a
		where	b.nr_seq_pls_fatura	= a.nr_sequencia
		and	b.nr_sequencia		= nr_seq_lote_contest_p
		and	b.ie_envio_recebimento	= 'R';
	end if;

	select	pls_obter_dados_cooperativa(nr_sequencia,'RS')
	into STRICT	ds_retorno_w
	from	pls_congenere
	where	(cd_cooperativa)::numeric  = (ds_retorno_w)::numeric;

elsif (ie_opcao_p = 'UDF') then
	select	max(cd_unimed_origem)
	into STRICT	ds_retorno_w
	from	pls_lote_contestacao	b,
		ptu_fatura		a
	where	b.nr_seq_ptu_fatura	= a.nr_sequencia
	and	b.nr_sequencia		= nr_seq_lote_contest_p
	and	b.ie_envio_recebimento	= 'E';

	if (coalesce(ds_retorno_w::text, '') = '') then
		begin
		select	substr(pls_obter_dados_pagador(a.nr_seq_pagador,'NF'),1,70)
		into STRICT	ds_retorno_w
		from	pls_lote_contestacao	b,
			pls_fatura		a
		where	b.nr_seq_pls_fatura	= a.nr_sequencia
		and	b.nr_sequencia		= nr_seq_lote_contest_p
		and	b.ie_envio_recebimento	= 'R';
		exception
		when others then
			ds_retorno_w := null;
		end;

	elsif (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		begin
		select	substr(max(nm_fantasia),1,255)
		into STRICT	ds_retorno_w
		from	pessoa_juridica	x,
			pls_congenere	d
		where	d.cd_cgc	= x.cd_cgc
		and	(d.cd_cooperativa)::numeric  = (ds_retorno_w)::numeric;
		exception
		when others then
			ds_retorno_w := null;
		end;
	end if;

elsif (ie_opcao_p = 'NFO') then
	select 	max(nr_seq_ptu_fatura),
		max(nr_seq_pls_fatura)
	into STRICT	nr_seq_ptu_fatura_w,
		nr_seq_pls_fatura_w
	from	pls_lote_contestacao
	where	nr_sequencia = nr_seq_lote_contest_p;

	if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
		select	max(nr_fatura)
		into STRICT	ds_retorno_w
		from	ptu_fatura
		where	nr_sequencia = nr_seq_ptu_fatura_w;

	elsif (nr_seq_pls_fatura_w IS NOT NULL AND nr_seq_pls_fatura_w::text <> '') then
		select	coalesce(max(pt.nr_fatura),to_char(max(pf.nr_titulo)))
		into STRICT	ds_retorno_w
		FROM pls_fatura pf
LEFT OUTER JOIN ptu_fatura pt ON (pf.nr_sequencia = pt.nr_seq_pls_fatura)
WHERE pf.nr_sequencia = nr_seq_pls_fatura_w;
	end if;

elsif (ie_opcao_p = 'DEF') then
	select 	max(nr_seq_ptu_fatura),
		max(nr_seq_pls_fatura)
	into STRICT	nr_seq_ptu_fatura_w,
		nr_seq_pls_fatura_w
	from	pls_lote_contestacao
	where	nr_sequencia = nr_seq_lote_contest_p;

	if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
		select	max(dt_emissao_fatura)
		into STRICT	ds_retorno_w
		from	ptu_fatura
		where	nr_sequencia = nr_seq_ptu_fatura_w;

	elsif (nr_seq_pls_fatura_w IS NOT NULL AND nr_seq_pls_fatura_w::text <> '') then
		select	max(nr_titulo)
		into STRICT	nr_titulo_w
		from	pls_fatura
		where	nr_sequencia = nr_seq_pls_fatura_w;

		if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
			select	max(dt_emissao)
			into STRICT	ds_retorno_w
			from	titulo_receber
			where 	nr_titulo = nr_titulo_w;
		end if;
	end if;

elsif (ie_opcao_p = 'VFO') then
	select 	max(nr_seq_ptu_fatura),
		max(nr_seq_pls_fatura)
	into STRICT	nr_seq_ptu_fatura_w,
		nr_seq_pls_fatura_w
	from	pls_lote_contestacao
	where	nr_sequencia = nr_seq_lote_contest_p;

	if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
		select	max(vl_total_fatura)
		into STRICT	ds_retorno_w
		from	ptu_fatura
		where	nr_sequencia = nr_seq_ptu_fatura_w;

	elsif (nr_seq_pls_fatura_w IS NOT NULL AND nr_seq_pls_fatura_w::text <> '') then
		select	max(vl_fatura)
		into STRICT	ds_retorno_w
		from	pls_fatura
		where	nr_sequencia = nr_seq_pls_fatura_w;

	end if;

elsif (ie_opcao_p = 'VPN') then -- Vl total pago NDC (A560)
	select	max(nr_sequencia)
	into STRICT	nr_seq_lote_discussao_w
	from	pls_lote_discussao
	where	nr_seq_lote_contest	= nr_seq_lote_contest_p
	and	ie_status 		<> 'C';

	select	max(ie_tipo_arquivo),
		max(vl_apresentado)
	into STRICT	ie_tipo_arquivo_w,
		vl_apresentado_w
	from	pls_lote_discussao
	where	nr_sequencia	= nr_seq_lote_discussao_w;

	if (ie_tipo_arquivo_w = '7') or (ie_tipo_arquivo_w = '8') then
		select	sum(coalesce(vl_ndc,0))
		into STRICT	ds_retorno_w
		from (SELECT	sum(coalesce(y.vl_ndc,0)) vl_ndc
			from	pls_contestacao_discussao x,
				pls_discussao_proc y,
				pls_lote_discussao z
			where	y.nr_seq_discussao	= x.nr_sequencia
			and	x.nr_seq_lote		= z.nr_sequencia
			and	z.ie_status		<> 'C'
			and	z.nr_seq_lote_contest	= nr_seq_lote_contest_p
			and	z.vl_apresentado	> 0
			and	coalesce(y.ie_tipo_acordo,'X') != '12'
			
union all

			SELECT	sum(coalesce(y.vl_ndc,0)) vl_ndc
			from	pls_contestacao_discussao x,
				pls_discussao_mat y,
				pls_lote_discussao z
			where	y.nr_seq_discussao	= x.nr_sequencia
			and	x.nr_seq_lote		= z.nr_sequencia
			and	z.ie_status		<> 'C'
			and	z.nr_seq_lote_contest	= nr_seq_lote_contest_p
			and	z.vl_apresentado	> 0
			and	coalesce(y.ie_tipo_acordo,'X') != '12') alias10;
	else
		select	sum(coalesce(vl_ndc,0))
		into STRICT	ds_retorno_w
		from (SELECT	sum(coalesce(y.vl_ndc,0)) vl_ndc
			from	pls_contestacao_discussao x,
				pls_discussao_proc y,
				pls_lote_discussao z
			where	y.nr_seq_discussao	= x.nr_sequencia
			and	x.nr_seq_lote		= z.nr_sequencia
			and	z.ie_status		<> 'C'
			and	z.nr_sequencia		= nr_seq_lote_discussao_w
			
union all

			SELECT	sum(coalesce(y.vl_ndc,0)) vl_ndc
			from	pls_contestacao_discussao x,
				pls_discussao_mat y,
				pls_lote_discussao z
			where	y.nr_seq_discussao	= x.nr_sequencia
			and	x.nr_seq_lote		= z.nr_sequencia
			and	z.ie_status		<> 'C'
			and	z.nr_sequencia		= nr_seq_lote_discussao_w) alias6;
	end if;

elsif (ie_opcao_p = 'VPF') then
	select	coalesce(vl_pago_fatura,0)
	into STRICT	ds_retorno_w
	from	pls_lote_contestacao
	where	nr_sequencia			= nr_seq_lote_contest_p;

elsif (ie_opcao_p = 'PC') then
	select	coalesce(ie_envio_recebimento,''),
		vl_pago_fatura,
		nr_seq_ptu_fatura,
		nr_seq_pls_fatura
	into STRICT	ie_envio_recebimento_w,
		vl_pago_fatura_w,
		nr_seq_ptu_fatura_w,
		nr_seq_pls_fatura_w
	from	pls_lote_contestacao
	where	nr_sequencia			= nr_seq_lote_contest_p;

	if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then	-- Pagar
		select	max(nr_titulo),
			max(cd_unimed_origem)
		into STRICT	nr_titulo_pag_w,
			cd_unimed_w
		from	ptu_fatura
		where	nr_sequencia	= nr_seq_ptu_fatura_w;

		select	max(vl_titulo)
		into STRICT	vl_titulo_w
		from	titulo_pagar
		where	nr_titulo	= nr_titulo_pag_w;

		if (vl_pago_fatura_w = vl_titulo_w) then
			ds_retorno_w	:= 'I';
		else
			ds_retorno_w	:= 'P';
		end if;

		-- SEMPRE QUE FOR DE CÂMARA VAI SER INTEGRAL
		/*if	(cd_unimed_w is not null) then
			cd_unimed_w := lpad(cd_unimed_w,4,'0');

			select	max(c.nr_sequencia)
			into	nr_seq_camara_w
			from	pls_camara_compensacao	c,
				pls_congenere_camara 	b,
				pls_congenere		a
			where	a.nr_sequencia = b.nr_seq_congenere
			and	c.nr_sequencia = b.nr_seq_camara
			and	a.cd_cooperativa = cd_unimed_w
			and	(b.dt_fim_vigencia > sysdate or	b.dt_fim_vigencia is null);

			if	(nr_seq_camara_w is not null) then
				ds_retorno_w	:= 'I';
			end if;
		end if;*/
	elsif (nr_seq_pls_fatura_w IS NOT NULL AND nr_seq_pls_fatura_w::text <> '') then -- Receber
		select	max(nr_titulo)
		into STRICT	nr_titulo_w
		from	pls_fatura
		where	nr_sequencia 	= nr_seq_pls_fatura_w;

		select	max(cd_unimed_destino)
		into STRICT	cd_unimed_w
		from	ptu_fatura
		where	nr_seq_pls_fatura = nr_seq_pls_fatura_w;

		select	max(vl_titulo)
		into STRICT	vl_titulo_w
		from	titulo_receber
		where	nr_titulo	=  nr_titulo_w;

		select	coalesce(max(vl_alteracao),0) + vl_titulo_w
		into STRICT	vl_titulo_w
		from	alteracao_valor
		where	nr_titulo	= nr_titulo_w
		and	nr_sequencia	= (	SELECT	max(nr_sequencia)
						from	alteracao_valor
						where	nr_titulo	= nr_titulo_w);

		-- Quando tem desconto tem que pegar o saldo do titulo, caso nao tenha valor recebido e o saldo do titulo nao for zerado
		select	max(a.vl_saldo_titulo)
		into STRICT	vl_saldo_titulo_w
		from	titulo_receber_liq x,
			titulo_receber a
		where	a.nr_titulo = x.nr_titulo
		and	a.nr_titulo = nr_titulo_w
		and	a.vl_saldo_titulo > 0
		and	x.vl_recebido = 0
		and	x.vl_descontos > 0;

		if (vl_saldo_titulo_w IS NOT NULL AND vl_saldo_titulo_w::text <> '') then
			vl_titulo_w := vl_saldo_titulo_w;
		end if;

		if (vl_pago_fatura_w = vl_titulo_w) then
			ds_retorno_w	:= 'I';
		else
			ds_retorno_w	:= 'P';
		end if;

		-- SEMPRE QUE FOR DE CÂMARA VAI SER INTEGRAL
		/*if	(cd_unimed_w is not null) then
			cd_unimed_w := lpad(cd_unimed_w,4,'0');

			select	max(c.nr_sequencia)
			into	nr_seq_camara_w
			from	pls_camara_compensacao	c,
				pls_congenere_camara 	b,
				pls_congenere		a
			where	a.nr_sequencia = b.nr_seq_congenere
			and	c.nr_sequencia = b.nr_seq_camara
			and	a.cd_cooperativa = cd_unimed_w
			and	(b.dt_fim_vigencia > sysdate or	b.dt_fim_vigencia is null);

			if	(nr_seq_camara_w is not null) then
				ds_retorno_w	:= 'I';
			end if;
		end if;*/
	end if;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_lote_contest ( nr_seq_lote_contest_p bigint, ie_opcao_p text) FROM PUBLIC;

