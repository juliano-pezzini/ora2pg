-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION cpoe_obter_se_prescritor_reval (nr_seq_revalidation_rule_p cpoe_revalidation_rule.nr_sequencia%type, ie_motivo_prescricao_p cpoe_material.ie_motivo_prescricao%type, cd_perfil_p cpoe_material.cd_perfil_ativo%type, nm_usuario_p cpoe_material.nm_usuario%type) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	         varchar(1) := 'S';
ie_existe_regra_w        integer;
nr_regra_w               integer;
ie_obter_prof_usuario_w  varchar(3);
ie_obter_se_medico_w     varchar(3);

c01 CURSOR FOR

    SELECT coalesce(max(nr_sequencia), 0)
      from CPOE_REVAL_OTHER_USER a
     where a.nr_seq_cpoe_revalidation = nr_seq_revalidation_rule_p
       and ((a.ie_motivo_prescricao = ie_motivo_prescricao_p) or (coalesce(a.ie_motivo_prescricao::text, '') = ''))
       and ((a.cd_perfil = cd_perfil_p) or (coalesce(a.cd_perfil::text, '') = ''))
       and ((a.ie_funcao_prescritor = ie_obter_prof_usuario_w) or (coalesce(a.ie_funcao_prescritor::text, '') = '')
            or (a.ie_funcao_prescritor = 'M' and  ie_obter_se_medico_w = 'S'));

BEGIN

    ie_obter_prof_usuario_w := obter_Profissional_Usuario(nm_usuario_p, 'C');
    ie_obter_se_medico_w := obter_se_medico(obter_pf_usuario(nm_usuario_p, 'C'), 'M');

    select coalesce(max(nr_sequencia), 0)
      into STRICT ie_existe_regra_w
      from CPOE_REVAL_OTHER_USER
     where nr_seq_cpoe_revalidation = nr_seq_revalidation_rule_p;

    if (ie_existe_regra_w = 0) then
        if (obter_se_medico(obter_pf_usuario(nm_usuario_p, 'C'), 'M') = 'S') then
            return 'S';
		else
			return 'N';
        end if;
    end if;

    open c01;
        loop
        fetch c01 into
            nr_regra_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */

            if (nr_regra_w > 0) then
                return 'S';
            else
                return 'N';
            end if;

        end loop;
    close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION cpoe_obter_se_prescritor_reval (nr_seq_revalidation_rule_p cpoe_revalidation_rule.nr_sequencia%type, ie_motivo_prescricao_p cpoe_material.ie_motivo_prescricao%type, cd_perfil_p cpoe_material.cd_perfil_ativo%type, nm_usuario_p cpoe_material.nm_usuario%type) FROM PUBLIC;

