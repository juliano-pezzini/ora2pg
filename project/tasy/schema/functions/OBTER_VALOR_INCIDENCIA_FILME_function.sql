-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valor_incidencia_filme ( nr_seq_proc_princ_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text) RETURNS bigint AS $body$
DECLARE


vl_filme_w			double precision;
dt_conta_w			timestamp;
cd_proc_base_w			bigint;
ie_origem_proc_base_w		bigint;
nr_incidencia_w			smallint;
qt_filme_w			double precision;
cd_edicao_base_w		bigint;
vl_m2_filme_w			double precision;


BEGIN


select 	max(cd_procedimento),
	max(ie_origem_proced),
	max(dt_conta)
into STRICT	cd_proc_base_w,
	ie_origem_proc_base_w,
	dt_conta_w
from 	procedimento_paciente
where 	nr_sequencia = nr_seq_proc_princ_p;

if (ie_origem_proc_base_w	= 1) or (ie_origem_proc_base_w	= 4)  then

	SELECT * FROM Obter_Edicao_Proc(cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, dt_conta_w, cd_proc_base_w, cd_edicao_base_w, vl_m2_filme_w) INTO STRICT cd_edicao_base_w, vl_m2_filme_w;

	begin
	select 	nr_incidencia,
		qt_filme
	into STRICT	nr_incidencia_w,
		qt_filme_w
	from	preco_amb a
	where (a.cd_edicao_amb    	= cd_edicao_base_w)
	and (a.cd_procedimento  	= cd_proc_base_w)
	and 	coalesce(a.dt_inicio_vigencia,clock_timestamp() - interval '3650 days')	=
		(	SELECT 	max(coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days'))
			from  	preco_amb b
			where 	b.cd_edicao_amb		= cd_edicao_base_w
			and	b.cd_procedimento	= cd_proc_base_w
			and	coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days') <= dt_conta_w);
	exception
		when others then
			nr_incidencia_w	:= 1;
			qt_filme_w	:= 1;
	end;

	if (coalesce(nr_incidencia_w,0) = 0) then
		nr_incidencia_w:= 1;
	end if;

	vl_filme_w:= qt_filme_w / nr_incidencia_w * vl_m2_filme_w;

	end if;


return	vl_filme_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valor_incidencia_filme ( nr_seq_proc_princ_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text) FROM PUBLIC;

