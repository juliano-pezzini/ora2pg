-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_valores_item ( nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE



/*ie_opcao
P - Valor pago
R - Reapresentação
G - Valor glosa aceita
*/
vl_pago_w				convenio_retorno_glosa.vl_pago_digitado%type;
vl_glosa_ret_reap_w		convenio_retorno_glosa.vl_glosa%type;
vl_glosa_ret_aceita_w	convenio_retorno_glosa.vl_glosa%type;
vl_glosa_grg_w			lote_audit_hist_item.vl_glosa%type;
vl_retorno_w			convenio_retorno_glosa.vl_pago_digitado%type;


BEGIN

select	coalesce(sum(vl_pago_digitado),0)
into STRICT	vl_pago_w
from	convenio_retorno_glosa a,
		convenio_retorno b
where	a.nr_seq_retorno = b.nr_sequencia
and		b.ie_status_retorno = 'F'
and	((nr_seq_propaci_p IS NOT NULL AND nr_seq_propaci_p::text <> '') and (a.nr_seq_propaci = nr_seq_propaci_p)
or (nr_seq_matpaci_p IS NOT NULL AND nr_seq_matpaci_p::text <> '') and (a.nr_seq_matpaci = nr_seq_matpaci_p));

select	coalesce(sum(vl_glosa),0)
into STRICT	vl_glosa_ret_reap_w
from	convenio_retorno_glosa a,
		motivo_glosa b,
		convenio_retorno c
where	a.cd_motivo_glosa = b.cd_motivo_glosa
and		a.nr_Seq_retorno = c.nr_sequencia
and		c.ie_status_retorno = 'F'
and		b.ie_acao_glosa = 'R'
and		((nr_seq_propaci_p IS NOT NULL AND nr_seq_propaci_p::text <> '') and (a.nr_seq_propaci = nr_seq_propaci_p)
or (nr_seq_matpaci_p IS NOT NULL AND nr_seq_matpaci_p::text <> '') and (a.nr_seq_matpaci = nr_seq_matpaci_p));

select	coalesce(sum(vl_glosa),0)
into STRICT	vl_glosa_ret_aceita_w
from	convenio_retorno_glosa a,
		motivo_glosa b,
		convenio_retorno c
where	a.cd_motivo_glosa = b.cd_motivo_glosa
and		a.nr_seq_retorno = c.nr_sequencia
and		c.ie_status_retorno = 'F'
and		b.ie_acao_glosa = 'A'
and	((nr_seq_propaci_p IS NOT NULL AND nr_seq_propaci_p::text <> '') and (a.nr_seq_propaci = nr_seq_propaci_p)
or (nr_seq_matpaci_p IS NOT NULL AND nr_seq_matpaci_p::text <> '') and (a.nr_seq_matpaci = nr_seq_matpaci_p));

--valores GRG
select	coalesce(sum(vl_glosa),0)
into STRICT	vl_glosa_grg_w
from	lote_audit_hist_item x
where	((nr_seq_propaci_p IS NOT NULL AND nr_seq_propaci_p::text <> '') and (x.nr_seq_propaci = nr_seq_propaci_p)
or (nr_seq_matpaci_p IS NOT NULL AND nr_seq_matpaci_p::text <> '') and (x.nr_seq_matpaci = nr_seq_matpaci_p));

if (ie_opcao_p = 'P') then
	vl_retorno_w := vl_pago_w;
elsif (ie_opcao_p = 'R') then
	vl_retorno_w := (vl_glosa_ret_reap_w - vl_glosa_grg_w);
elsif (ie_opcao_p = 'A') then
	vl_retorno_w := (vl_glosa_ret_aceita_w + vl_glosa_grg_w);
end if;


return vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_valores_item ( nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, ie_opcao_p text) FROM PUBLIC;

