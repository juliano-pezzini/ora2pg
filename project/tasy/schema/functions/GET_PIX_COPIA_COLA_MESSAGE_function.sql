-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_pix_copia_cola_message (cd_mensagem_p bigint, nr_seq_cobranca_p bigint) RETURNS varchar AS $body$
DECLARE


	ds_mensagem_w 					fin_regra_comunic_evento.ds_comunicacao%type;
    ds_titulo_w 					fin_regra_comunic_evento.ds_titulo%type;
    nm_pessoa_fisica_w 				pessoa_fisica.nm_pessoa_fisica%type;
	razao_social_w 					pessoa_juridica.ds_razao_social%type;
	vl_cobranca_w 					pix_cobranca.vl_original%type;
	cd_cnpj_cliente_w 				pix_cobranca.cd_cnpj%type;
	cd_pessoa_fisica_cliente_w 		pix_cobranca.cd_pessoa_fisica%type;
    ds_chave_w 						pix_cobranca.ds_chave_pix%type;
	ds_url_payload_w 				pix_cobranca.ds_url_payload%type;
	ds_estab_w 						estabelecimento.nm_fantasia_estab%type;

	ds_emv_pix 						varchar(10000);


BEGIN

	--Mensagem padrao definida pelo cliente nas regras de comunicacao
	select max(a.ds_comunicacao),
		   max(a.ds_titulo)
	into STRICT   ds_mensagem_w,
		   ds_titulo_w
	from   fin_regra_comunic_evento a
	where  a.nr_sequencia = cd_mensagem_p;
	
	--Valores referente a cobranca selecionada
	select max(a.vl_original),
	       max(coalesce(a.cd_cnpj,'')),
		   max(coalesce(a.cd_pessoa_fisica,'')),
           max(a.ds_chave_pix),
           max(a.ds_url_payload)
	into STRICT   vl_cobranca_w,
		   cd_cnpj_cliente_w,
		   cd_pessoa_fisica_cliente_w,
           ds_chave_w,
           ds_url_payload_w
	from   pix_cobranca a
	where  a.nr_sequencia = nr_seq_cobranca_p;
	
	--Macro DS_CLIENTE
	select max(a.ds_razao_social)
	into STRICT   razao_social_w
	from   pessoa_juridica a
	where  a.cd_cgc = cd_cnpj_cliente_w;
	
	select max(a.nm_pessoa_fisica)
	into STRICT   nm_pessoa_fisica_w
	from   pessoa_fisica a
	where  a.cd_pessoa_fisica = cd_pessoa_fisica_cliente_w;
	
	--Macro DS_ESTABELECIMENTO
	select max(a.nm_fantasia_estab)
	into STRICT   ds_estab_w
	from   estabelecimento a
	where  a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

    --Replace das macros cadastradas
	if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then		
		if ((razao_social_w IS NOT NULL AND razao_social_w::text <> '') or razao_social_w <> '') then
			ds_mensagem_w := replace(ds_mensagem_w, '@DS_CLIENTE', razao_social_w);
		else
			ds_mensagem_w := replace(ds_mensagem_w, '@DS_CLIENTE', nm_pessoa_fisica_w);
		end if;
		ds_mensagem_w := replace(ds_mensagem_w, '@DS_EMPRESA', obter_nome_empresa(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento)));
		ds_mensagem_w := replace(ds_mensagem_w, '@DS_ESTABELECIMENTO', ds_estab_w);
		ds_mensagem_w := replace(ds_mensagem_w, '@DT_COBRANCA', clock_timestamp());
		ds_mensagem_w := replace(ds_mensagem_w, '@VALOR_COBRANCA', vl_cobranca_w);
		ds_mensagem_w := replace(ds_mensagem_w, '@PIX_COPIA_COLA', pix_pck.criar_qr_code_cobranca(vl_cobranca_w, ds_chave_w, cd_pessoa_fisica_cliente_w, cd_cnpj_cliente_w, 'BRASIL', ds_url_payload_w));
	end if;
	
    return ds_mensagem_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_pix_copia_cola_message (cd_mensagem_p bigint, nr_seq_cobranca_p bigint) FROM PUBLIC;

