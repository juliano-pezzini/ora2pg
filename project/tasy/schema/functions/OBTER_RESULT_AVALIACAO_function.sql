-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE ValorComplemento AS (	ds_valor	varchar(2000));


CREATE OR REPLACE FUNCTION obter_result_avaliacao ( nr_seq_avaliacao_p bigint, nr_seq_item_p bigint) RETURNS varchar AS $body$
DECLARE

/*
  B - Booleano
  D - Descrição
  M - Multiseleção
  S - Seleção Simples
  O - Valor Domínio
  C - Seleção Simples
  L - Cálculo
  T - Título
  V - Valor
  U - Seleção Simples (Radio Group);
*/
type Dados is table of ValorComplemento index by integer;

ds_resultado_w			varchar(4000);
qt_resultado_w			double precision;
ie_resultado_w			varchar(02);
cd_funcao_w			integer;
nr_seq_prontuario_w		integer;
cd_dominio_w			integer;
ds_complemento_w			varchar(4000);
ds_retorno_w			varchar(4000);


i				integer;
ds_texto_w			varchar(255);
pos_w				bigint;

complemento_w			Dados;
ds_comando_w			varchar(2000);


cursor_long_w     integer;
result_cursor_w   bigint;
ds_result_long_w  varchar(4000);
long_len_w  	  bigint;
buflen_w    	  bigint := 4000;
curpos_w    	  bigint := 0;



BEGIN


select		coalesce(a.cd_funcao, 0),
		coalesce(a.nr_seq_prontuario, 0)
into STRICT		cd_funcao_w,
		nr_seq_prontuario_w
from		med_item_avaliar b,
		med_tipo_avaliacao a
where		a.nr_sequencia	= b.nr_seq_tipo
and		b.nr_sequencia	= nr_seq_item_p;

ds_resultado_w			:= '';

select	ie_resultado,
	cd_dominio,
	ds_complemento || ';'
into STRICT 	ie_resultado_w,
	cd_dominio_w,
	ds_complemento_w
from 	med_item_avaliar
where nr_sequencia	= nr_seq_item_p;

if (nr_seq_prontuario_w = 194) then
	begin
	select		max(qt_resultado),
			max(ds_resultado)
	into STRICT 		qt_resultado_w,
			ds_resultado_w
	from		atend_check_list_result
	where		nr_seq_checklist	= nr_seq_avaliacao_p
	and		nr_seq_item		= nr_seq_item_p;
	end;
else
	begin
	if (cd_funcao_w	= 2000) then
		begin
		select		qt_resultado,
				ds_resultado
		into STRICT 		qt_resultado_w,
				ds_resultado_w
		from		sac_pesquisa_result
		where		nr_seq_pesquisa	= nr_seq_avaliacao_p
		and		nr_seq_item	= nr_seq_item_p;
		end;
	elsif (cd_funcao_w	= 4000) then /* Gestão da Qualidade */
		begin
		select		qt_resultado,
				ds_resultado
		into STRICT 		qt_resultado_w,
				ds_resultado_w
		from		qua_avaliacao_result
		where		nr_seq_avaliacao	= nr_seq_avaliacao_p
		and		nr_seq_item	= nr_seq_item_p;
		end;
	elsif (cd_funcao_w	= 299) then /* Ordem de serviço */
		begin
		select		qt_resultado,
				ds_resultado
		into STRICT 		qt_resultado_w,
				ds_resultado_w
		from		man_ordem_serv_aval_result
		where		nr_seq_ordem_serv_aval	= nr_seq_avaliacao_p
		and		nr_seq_item		= nr_seq_item_p;
		end;
	elsif (cd_funcao_w	= 230) then /* Cadastro de Funcionários */
		begin
		select		qt_resultado,
				ds_resultado
		into STRICT		qt_resultado_w,
				ds_resultado_w
		from		pessoa_avaliacao_result
		where		nr_seq_avaliacao	= nr_seq_avaliacao_p
		and		nr_seq_item	= nr_seq_item_p;
		end;
	elsif (cd_funcao_w	= 3004) then /* Cadastro de Funcionários */
		begin
		select		qt_resultado,
				ds_resultado
		into STRICT		qt_resultado_w,
				ds_resultado_w
		from		autorizacao_conv_av_result
		where		nr_seq_autor_conv_aval	= nr_seq_avaliacao_p
		and		nr_seq_item		= nr_seq_item_p;
		end;		
	else
		begin
		select		max(qt_resultado),
				max(ds_resultado)
		into STRICT 		qt_resultado_w,
				ds_resultado_w
		from		med_avaliacao_result
		where		nr_seq_avaliacao	= nr_seq_avaliacao_p
		and		nr_seq_item	= nr_seq_item_p;
				
		if (coalesce(ds_resultado_w::text, '') = '') and (ie_resultado_w = 'P') then
		
			begin
			
			cursor_long_w := dbms_sql.open_cursor;
			
			dbms_sql.parse( cursor_long_w,
							'select ds_result_long from med_avaliacao_result where nr_seq_avaliacao	= :nr_seq_avaliacao and nr_seq_item	= '||nr_seq_item_p,
							 dbms_sql.native );
			dbms_sql.bind_variable( cursor_long_w, ':nr_seq_avaliacao', nr_seq_avaliacao_p );

			dbms_sql.define_column_long(cursor_long_w, 1);
			result_cursor_w := dbms_sql.execute(cursor_long_w);

			if (dbms_sql.fetch_rows(cursor_long_w)>0) then
				dbms_sql.column_value_long(cursor_long_w, 1, buflen_w, curpos_w ,
										   ds_result_long_w, long_len_w );
			end if;
			
			dbms_sql.close_cursor(cursor_long_w);
			ds_resultado_w := ''|| ds_result_long_w;
			exception
				when others then
					ds_resultado_w := '';
			end;
			
		end if;		
		
		end;
	end if;
	end;
end if;

if (ie_resultado_w = 'B') then
	begin
	if (coalesce(qt_resultado_w,0) = 0) then
		ds_resultado_w	:= 'N';
	else
		ds_resultado_w	:= 'S';
	end if;
	if (pkg_i18n.get_user_locale()='en_AU') then
		ds_resultado_w := obter_valor_dominio(6,ds_resultado_w);
	end if;
	end;
elsif (ie_resultado_w = 'D') or (ie_resultado_w = 'C') then
	begin
	ds_resultado_w	:= ds_resultado_w;
	end;
elsif (ie_resultado_w = 'V') then
	ds_resultado_w	:= qt_resultado_w;
elsif (ie_resultado_w = 'U') then	/*Elemar e Philippe OS 186211*/
	
	if (coalesce(cd_dominio_w::text, '') = '') then
		for i in 0..100 loop
			ds_texto_w		:= substr(ds_complemento_w, 1, position(';' in ds_complemento_w) - 1);
			ds_complemento_w        := replace(ds_complemento_w, ds_texto_w || ';', '');
			if (i = qt_resultado_w) then
				ds_resultado_w	:= ds_texto_w;
				exit;
			end if;
		end loop;
	else
		
		if (coalesce(ds_resultado_w::text, '') = '') then
			begin
				select	coalesce(max(ds_valor_dominio),'')
				into STRICT	ds_resultado_w
				from	med_valor_dominio
				where	nr_seq_dominio = cd_dominio_w
				and	(vl_dominio)::numeric  = qt_resultado_w;
			exception
			when others then
				ds_resultado_w	 := null;
			end;
		end if;
	end if;
	if (coalesce(ds_resultado_w,'') = '') then
		ds_resultado_w	:= qt_resultado_w;
	end if;
elsif (ie_resultado_w = 'L') then
	ds_resultado_w	:= to_char(qt_resultado_w, 'fm999990.00');
elsif (ie_resultado_w = 'O') or (ie_resultado_w = 'S') then
	begin
	if (qt_resultado_w = 0) or (coalesce(qt_resultado_w::text, '') = '') then
		ds_resultado_w	:= ds_resultado_w;
	else
		ds_resultado_w	:= qt_resultado_w;
	end if;
	end;
elsif (ie_resultado_w	= 'Z') then
	begin
	
	
	pos_w	:= position(';' in ds_complemento_w);
	
	i	:= 0;
	while(pos_w	> 0) loop
		begin
		
		complemento_w[i].ds_valor	:= substr(ds_complemento_w,1,pos_w-1);
		
		ds_complemento_w		:= substr(ds_complemento_w,pos_w+1,2000);
		
		i	:= i+1;
				
		
		pos_w	:= position(';' in ds_complemento_w);
		end;
	end loop;
	
	
	
	if (complemento_w.count	>= 8)then
		
		ds_comando_w	:= 'select	'||complemento_w[8].ds_valor||
				    ' from	'||complemento_w[6].ds_valor||
				    ' where	'||complemento_w[7].ds_valor  ||' = :ds_result';
				
				    
				    
		ds_retorno_w	:=	Obter_select_concatenado_bv(	ds_comando_w,
									'ds_result='||ds_resultado_w||';','');
				
		
		
		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '')then
			ds_resultado_w	:= ds_resultado_w||' - '||ds_retorno_w;
			
		end if;
		
	
	end if;
	
	
	
	end;
end if;

return ds_resultado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_result_avaliacao ( nr_seq_avaliacao_p bigint, nr_seq_item_p bigint) FROM PUBLIC;

