-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_servico_nfse_joinville ( nr_sequencia_p bigint, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE

 
ds_retorno_w		varchar(1000);
ie_trat_desc_servico_w	varchar(2);
nm_usuario_w		varchar(20);
ds_horario_w		varchar(100);
ds_procedimentos_w	varchar(100);


BEGIN 
ie_trat_desc_servico_w := substr(coalesce(obter_valor_param_usuario(40, 251, Obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_p),'S'),1,1);
 
/* Honorarios Medicos */
 
ds_horario_w := wheb_mensagem_pck.get_texto(297570);
/* Procedimentos Ambulatoriais */
 
ds_procedimentos_w := wheb_mensagem_pck.get_texto(297571);
 
if (ie_trat_desc_servico_w = 'N') then 
	return obter_descricao_rps(cd_estabelecimento_p, nr_sequencia_p,'DS_SERVICOS');
else 
	begin 
	select	max(CASE WHEN Obter_se_pasta_honorario(p.ie_responsavel_credito)='S' THEN  ds_horario_w WHEN Obter_se_pasta_honorario(p.ie_responsavel_credito)=m.dt_atendimento THEN  coalesce(m.dt_atendimento,clock_timestamp()) WHEN Obter_se_pasta_honorario(p.ie_responsavel_credito)=ds_procedimentos_w THEN  		obter_classificacao_proced(p.cd_procedimento, p.ie_origem_proced, 'C') WHEN Obter_se_pasta_honorario(p.ie_responsavel_credito)='2' THEN  ds_procedimentos_w  ELSE PERFORM obter_descricao_rps(n.cd_estabelecimento, n.nr_sequencia,'DS_SERVICOS') END ) 
	into STRICT	ds_retorno_w 
	FROM operacao_nota o, nota_fiscal n
LEFT OUTER JOIN conta_paciente c ON (n.nr_interno_conta = c.nr_interno_conta)
LEFT OUTER JOIN material_atend_paciente m ON (c.nr_interno_conta = m.nr_interno_conta)
LEFT OUTER JOIN procedimento_paciente p ON (c.nr_interno_conta = p.nr_interno_conta)
WHERE o.cd_operacao_nf 	= n.cd_operacao_nf    and n.nr_sequencia		= nr_sequencia_p and n.cd_estabelecimento	= cd_estabelecimento_p;
	end;
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_servico_nfse_joinville ( nr_sequencia_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

