-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION adep_obter_se_apres_hor_proc ( ie_tipo_regra_p text, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, cd_perfil_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, cd_setor_execucao_p adep_regra_inclusao_proc.cd_setor_exec%type default null) RETURNS varchar AS $body$
DECLARE

				
cd_setor_atendimento_w	integer;
cd_perfil_w		integer;
				
ie_horarios_w	varchar(15)	:= 'S';

nr_seq_proc_interno_w	smallint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
cd_area_procedimento_w	integer;
cd_especialidade_w	bigint;
cd_grupo_proc_w		bigint;
	
c02 CURSOR FOR
SELECT	ie_horarios
from	adep_regra_inclusao_proc
where	cd_estabelecimento					= cd_estabelecimento_p
and	coalesce(cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
and	coalesce(cd_perfil, cd_perfil_w)				= cd_perfil_w
and	coalesce(nr_seq_proc_interno, nr_seq_proc_interno_p) 		= nr_seq_proc_interno_p
and	coalesce(cd_procedimento, cd_procedimento_w)		= cd_procedimento_w
and	((coalesce(ie_origem_proc::text, '') = '') or (ie_origem_proc	= ie_origem_proced_w))
and	coalesce(cd_area_procedimento, cd_area_procedimento_w)	= cd_area_procedimento_w
and	coalesce(cd_especialidade, cd_especialidade_w)		= cd_especialidade_w
and	coalesce(cd_grupo_proc, cd_grupo_proc_w)			= cd_grupo_proc_w
and (cd_setor_exec = cd_setor_execucao_p or coalesce(cd_setor_exec::text, '') = '')
and	coalesce(ie_situacao,'A')					= 'A'
order by
	coalesce(cd_setor_atendimento,99999) desc,
	coalesce(cd_setor_exec, 99999) desc,
	coalesce(cd_perfil,99999) desc,
	coalesce(nr_seq_proc_interno, 9999999999) desc,		
	coalesce(cd_procedimento,999999999999999) desc,
	coalesce(ie_origem_proced,9) desc,
	coalesce(cd_area_procedimento, 99999999) desc,
	coalesce(cd_especialidade, 99999999) desc,
	coalesce(cd_grupo_proc,999999999999999) desc,	
	nr_sequencia;
				

BEGIN
if (ie_tipo_regra_p IS NOT NULL AND ie_tipo_regra_p::text <> '') and (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then
	
	cd_setor_atendimento_w	:= coalesce(cd_setor_atendimento_p,0);
	cd_perfil_w		:= coalesce(cd_perfil_p,0);
	
	if (ie_tipo_regra_p = 'PROC') then
	
		if (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') then
			SELECT * FROM obter_proc_tab_interno_conv(nr_seq_proc_interno_p, cd_estabelecimento_p, null, null, null, null, cd_procedimento_w, ie_origem_proced_w, null, clock_timestamp(), null, null, null, null, null, null, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
		else
			cd_procedimento_w	:= cd_procedimento_p;
			ie_origem_proced_w	:= ie_origem_proced_p;
		end if;
			
		select 	max(cd_area_procedimento),
			max(cd_especialidade),
			max(cd_grupo_proc)
		into STRICT	cd_area_procedimento_w,
			cd_especialidade_w,
			cd_grupo_proc_w
		from	estrutura_procedimento_v
		where	cd_procedimento 	= cd_procedimento_w
		and	ie_origem_proced 	= ie_origem_proced_w;		
		
		open c02;
		loop
		fetch c02 into ie_horarios_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			ie_horarios_w := ie_horarios_w;
			end;
		end loop;
		close c02;		
	end if;
	
end if;

return ie_horarios_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION adep_obter_se_apres_hor_proc ( ie_tipo_regra_p text, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, cd_perfil_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, cd_setor_execucao_p adep_regra_inclusao_proc.cd_setor_exec%type default null) FROM PUBLIC;

