-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_cid_elegivel ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, cd_cid_p text, ie_morte_geral_p text, ie_tipo_diagnostico_p text, ie_morte_fetal_p text, ie_permite_anomalia_p text, ie_regra_notificacao_p text default 'N') RETURNS varchar AS $body$
DECLARE


ie_permite_principal_w		regra_utilizacao_cid.ie_permite_principal%type;
ie_permite_basica_w		regra_utilizacao_cid.ie_permite_basica%type;
ie_permite_fetal_w		regra_utilizacao_cid.ie_permite_fetal%type;
ie_obito_w			regra_utilizacao_cid.ie_permite_obito%type;
qt_achou_item_w			bigint;
ie_sexo_w			pessoa_fisica.ie_sexo%type;
ie_sexo_regra_w			regra_utilizacao_cid.ie_sexo%type;
idade_w				bigint;
qt_idade_minima_w		bigint;
qt_idade_maxima_w		bigint;
qt_idade_minima_dias_w		bigint;
qt_idade_maxima_dias_w		bigint;
qt_idade_minima_anos_w		bigint;
qt_idade_maxima_anos_w		bigint;
ie_permite_cid_w		varchar(1);
ie_rubrica_type_w           	varchar(1);
ie_permite_anomalia_w		regra_utilizacao_cid.ie_permite_anomalia%type;
ie_permite_selecionar_w		regra_utilizacao_cid.ie_permite_selecionar%type;
qt_reg_w			bigint;
ie_regra_just_w REGRA_UTILIZACAO_CID.IE_REGRA_JUST%type;


BEGIN
ie_permite_cid_w := 'S';

select coalesce(max(ie_permite_principal),'S'),
	coalesce(max(ie_permite_basica),'S'),
	coalesce(max(ie_permite_fetal),'S'),
	coalesce(max(ie_permite_obito),'S'),
	coalesce(max(qt_idade_min_dias),0),
	coalesce(max(qt_idade_max_dias),0),	
	coalesce(max(qt_idade_minima),0),
	coalesce(max(qt_idade_maxima),0),
	max(ie_sexo),
	coalesce(max(1),0) qt_achou_item,
	coalesce(max(ie_rubrica_type), 'N'),
	coalesce(max(ie_permite_anomalia),'N'),
	coalesce(max(ie_permite_selecionar), 'S'),
  coalesce(max(ie_regra_just), 'B')
into STRICT	ie_permite_principal_w,
	ie_permite_basica_w,
	ie_permite_fetal_w,
	ie_obito_w,
	qt_idade_minima_dias_w,
	qt_idade_maxima_dias_w,	
	qt_idade_minima_anos_w,
	qt_idade_maxima_anos_w,	
	ie_sexo_regra_w,
	qt_achou_item_w,
	ie_rubrica_type_w,
	ie_permite_anomalia_w,
	ie_permite_selecionar_w,
  ie_regra_just_w
from 	regra_utilizacao_cid
where 	cd_doenca = trim(both cd_cid_p)
and 	ie_situacao = 'A';

if (qt_achou_item_w	> 0) then

	Select 	max(pf.ie_sexo) ie_sexo,
		max(obter_idade(pf.dt_nascimento,clock_timestamp(),'DIA')) idade
	into STRICT	ie_sexo_w,
		idade_w
	from    pessoa_fisica pf
	where   pf.cd_pessoa_fisica = coalesce(cd_pessoa_fisica_p, obter_pessoa_atendimento(nr_atendimento_p,'C'));


	if (qt_idade_minima_dias_w <> 0 and qt_idade_minima_anos_w <> 0) then
		qt_idade_minima_w := qt_idade_minima_dias_w + (qt_idade_minima_anos_w * 365);	
	elsif (qt_idade_minima_dias_w <> 0) then
		qt_idade_minima_w := qt_idade_minima_dias_w;
	else
		qt_idade_minima_w := qt_idade_minima_anos_w * 365;	
	end if;

	if (qt_idade_maxima_dias_w <> 0 and qt_idade_maxima_anos_w <> 0) then
		qt_idade_maxima_w := qt_idade_maxima_dias_w + (qt_idade_maxima_anos_w * 365);
	elsif (qt_idade_maxima_dias_w <> 0) then
		qt_idade_maxima_w := qt_idade_maxima_dias_w;
	elsif (qt_idade_maxima_anos_w <> 0) then
		qt_idade_maxima_w := qt_idade_maxima_anos_w * 365;
	else
		qt_idade_maxima_w := 999999;
	end if;


	--Se ele achar uma regra por CID ele comeaa a validacao
	if (qt_achou_item_w = 1) then
		if (ie_permite_selecionar_w = 'N') then
			ie_permite_cid_w := 'N';
		elsif (ie_permite_anomalia_p = 'S') and (ie_permite_anomalia_w = 'N') then
			ie_permite_cid_w := 'N';
		elsif (ie_rubrica_type_w = 'S') then
		ie_permite_cid_w := 'N';
		elsif (ie_permite_fetal_w = 'N') and (ie_morte_fetal_p = 'S') then
			ie_permite_cid_w := 'N';
		elsif (ie_obito_w = 'N') and (ie_morte_geral_p = 'S') then
			ie_permite_cid_w := 'N';
		elsif (ie_permite_principal_w = 'N') and (coalesce(ie_tipo_diagnostico_p,'X') = 'P') then --Principal
			ie_permite_cid_w := 'N';
		elsif (ie_permite_basica_w = 'N') and (coalesce(ie_tipo_diagnostico_p,'X')  = 'S') then ---Secundario
			ie_permite_cid_w := 'N';
		elsif (idade_w < qt_idade_minima_w or idade_w > qt_idade_maxima_w) then
			ie_permite_cid_w := 'N';			
		elsif (coalesce(ie_sexo_w,ie_sexo_regra_w) <> coalesce(ie_sexo_regra_w,ie_sexo_w)) then
			ie_permite_cid_w := 'N';
		end if;

    if (ie_regra_notificacao_p = 'S' and ie_permite_cid_w = 'N') then
      ie_permite_cid_w := coalesce(ie_regra_just_w, 'B');
    end if;
	end if;

end if;

return ie_permite_cid_w;	
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_cid_elegivel ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, cd_cid_p text, ie_morte_geral_p text, ie_tipo_diagnostico_p text, ie_morte_fetal_p text, ie_permite_anomalia_p text, ie_regra_notificacao_p text default 'N') FROM PUBLIC;

