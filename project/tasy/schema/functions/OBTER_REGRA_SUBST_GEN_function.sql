-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_subst_gen ( nr_prescricao_p bigint, nr_atendimento_cpoe_p bigint default null, cd_material_p bigint DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL) RETURNS bigint AS $body$
DECLARE

cd_convenio_w	convenio.cd_convenio%type;
cd_material_comercial_w	material.cd_material%type;
cd_categoria_w	varchar(30) := '';
cd_plano_w	varchar(80) := '';
qt_regra_w	bigint;
nr_atendimento_w	atendimento_paciente.nr_atendimento%type;


BEGIN

cd_material_comercial_w	:= 0;

select	max(nr_atendimento)
into STRICT	nr_atendimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

if coalesce(nr_atendimento_w::text, '') = '' or nr_atendimento_w <= 0 then
	nr_atendimento_w := nr_atendimento_cpoe_p;
end if;


if (coalesce(coalesce(nr_atendimento_w, nr_atendimento_cpoe_p), 0) > 0) then

    cd_convenio_w := obter_convenio_atendimento(nr_atendimento_w);
    cd_plano_w := Obter_Plano_Convenio_Atend(nr_atendimento_w, 'C');

    select  max(b.cd_categoria)
    into STRICT 	cd_categoria_w
    from 	atend_categoria_convenio a,
            categoria_convenio b
    where	a.cd_convenio			= b.cd_convenio
    and     a.nr_atendimento		= nr_atendimento_w
    and 	a.cd_convenio			= cd_convenio_w;

	if (coalesce(cd_convenio_w, 0) > 0) then

		select  count(*)
        into STRICT	qt_regra_w
		from	rep_regra_subst_gen
		where	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
		and	((coalesce(cd_convenio::text, '') = '') or (cd_convenio = cd_convenio_w))
		and	((coalesce(cd_categoria::text, '') = '') or (cd_categoria = cd_categoria_w))
		and	((coalesce(cd_plano::text, '') = '') or (cd_plano = cd_plano_w))
		and	coalesce(ie_situacao, 'A') = 'A';

		if (qt_regra_w > 0) then

			select	max(cd_material)
			into STRICT	cd_material_comercial_w
			from	material
			where	cd_material_generico = cd_material_p
			and	ie_tipo_material = 2
			and	ie_situacao = 'A'
			and	ie_prescricao=  'S';

		end if;

	end if;

end if;

return	cd_material_comercial_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_subst_gen ( nr_prescricao_p bigint, nr_atendimento_cpoe_p bigint default null, cd_material_p bigint DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL) FROM PUBLIC;

