-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ehr_entidade_padrao ( nm_tabela_p text, nr_seq_elemento_p bigint, cd_pessoa_fisica_p bigint, nr_atendimento_p bigint, ie_inf_entidade_p text, ie_atendimento_p text, ie_profissional_p text default 'N') RETURNS varchar AS $body$
DECLARE


c02 CURSOR FOR
SELECT coalesce(ds_function,nm_atributo) nm_atributo,
	   ds_label,
	   CASE WHEN ie_quebra_linha='S' THEN ' chr(13) ||chr(10) ||'  ELSE null END  ds_quebra,
	   ds_separador
from   ehr_template_cont_ret
where  nr_seq_elemento = nr_seq_elemento_p
order by nr_seq_apres;

nm_usuario_w  usuario.nm_usuario%type;
ds_comando_w  varchar(2000);
ds_sql_w      varchar(8000);
ds_retorno_w  varchar(20000);
ds_retorno_ww varchar(20000) := '';
nm_tabela_w   varchar(50);

v_cursor REFCURSOR;
nr_sequencia_w bigint;
ds_comando_ww  varchar(2000);
c001		   integer;
qt_cursor_w    bigint;

BEGIN

if (nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '') then

	nm_usuario_w := WHEB_USUARIO_PCK.get_nm_usuario;

	for comandos in C02 loop
		begin
		if (ds_comando_w IS NOT NULL AND ds_comando_w::text <> '') then
			ds_comando_w	:= ds_comando_w ||'||'||chr(13);
		end if;
		ds_comando_w	:= ds_comando_w ||' decode('||comandos.nm_atributo||',null,null,'||comandos.ds_quebra ||chr(39) || comandos.ds_label
			||chr(39) ||'|| '|| comandos.nm_atributo ||'||'|| chr(39) || comandos.ds_separador ||chr(39) ||')';
		end;
	end loop;

	ds_comando_w	:= 'Select '||ds_comando_w ||' ds '||chr(13) ||'From ' || nm_tabela_p;


	ds_sql_w := ' select nr_sequencia ' ||
					' from   ' || nm_tabela_p || ' a ' ||
					' where  nr_atendimento	= '|| nr_atendimento_p ||
					' and	 ''' || ie_atendimento_p || ''' = ''S'' '||
					' and	''' || ie_profissional_p || ''' = ''N'' ' ||
					' and 	 dt_liberacao is not null '||
					' and	 nr_sequencia  in (	select	max(x.nr_sequencia) ' ||
					'    						from	' || nm_tabela_p || ' x ' ||
					' 							where	nr_atendimento = ' || nr_atendimento_p ||
					'							and	    ''' || ie_inf_entidade_p || ''' = ''U'' ' ||
					'							and	    x.dt_inativacao is null ' ||
					'							union ' ||
					'							select	x.nr_sequencia ' ||
					'							from	' || nm_tabela_p || ' x ' ||
					' 							where	nr_atendimento = ' || nr_atendimento_p ||
					' 							and	    x.dt_inativacao is null ' ||
					' 							and		''' || ie_inf_entidade_p	|| ''' = ''T'') ' ||
					' union ' ||
					' select nr_sequencia ' ||
					' from	 ' || nm_tabela_p || ' a ' ||
					' where	 nr_atendimento	in ( select	b.nr_atendimento ' ||
					' 							 from	atendimento_paciente b ' ||
					' 							 where	b.cd_pessoa_fisica 	= ''' || cd_pessoa_fisica_p || ''' ) ' ||
					' and	''' || ie_atendimento_p || ''' = ''N'' ' ||
					' and	''' || ie_profissional_p || ''' = ''N'' ' ||
					' and 	dt_liberacao is not null ' ||
					' and	nr_sequencia  in ( select max(x.nr_sequencia) ' ||
					' 						   from	  ' || nm_tabela_p || ' x ' ||
					' 						   where  x.nr_atendimento in (	select	b.nr_atendimento ' ||
					' 														from	atendimento_paciente b ' ||
					' 														where	b.cd_pessoa_fisica 	= ''' || cd_pessoa_fisica_p || ''' ) ' ||
					' 						   and	  ''' || ie_inf_entidade_p	|| '''	= ''U'' ' ||
					' 						   and	  x.dt_inativacao is null ' ||
					' 				           union	 ' ||
					' 				           select	x.nr_sequencia ' ||
					' 				           from	    ' || nm_tabela_p || ' x ' ||
					' 				           where	x.nr_atendimento in ( select b.nr_atendimento ' ||
					' 														  from	 atendimento_paciente b ' ||
					' 														  where	 b.cd_pessoa_fisica = ''' || cd_pessoa_fisica_p || ''' ) ' ||
					' 						   and	    x.dt_inativacao is null ' ||
					' 				           and	    ''' || ie_inf_entidade_p	|| '''	= ''T'') ' ||
					' union ' ||
					' select nr_sequencia ' ||
					' from	 ' || nm_tabela_p || ' a ' ||
					' where	 nr_atendimento	= ' || nr_atendimento_p ||
					' and	 ''' || ie_atendimento_p || ''' = ''S'' ' ||
					' and	 ''' || ie_profissional_p || ''' = ''S'' ' ||
					' and 	 dt_liberacao is not null ' ||
					' and	 nr_sequencia in ( select max(x.nr_sequencia) ' ||
					' 						   from	  ' || nm_tabela_p || ' x ' ||
					' 						   where  nr_atendimento = ' || nr_atendimento_p ||
					' 						   and	  ''' || ie_inf_entidade_p	|| '''	= ''U'' ' ||
					' 						   and	  x.dt_inativacao is null ' ||
					' 						   and	  x.nm_usuario_nrec = ''' || nm_usuario_w || ''' ' ||
					' 						   union	 ' ||
					' 						   select x.nr_sequencia ' ||
					' 						   from	  ' || nm_tabela_p || ' x ' ||
					' 						   where  nr_atendimento = ' || nr_atendimento_p ||
					' 						   and	  x.dt_inativacao is null ' ||
					' 						   and	  x.nm_usuario_nrec = ''' || nm_usuario_w || ''' ' ||
					' 						   and	  ''' || ie_inf_entidade_p	|| '''	= ''T'') ' ||
					' union ' ||
					' select nr_sequencia ' ||
					' from	 ' || nm_tabela_p || ' a ' ||
					' where	 nr_atendimento	in ( select	b.nr_atendimento ' ||
					' 							 from	atendimento_paciente b ' ||
					' 							 where	b.cd_pessoa_fisica 	= ''' || cd_pessoa_fisica_p || ''' ) ' ||
					' and	''' || ie_atendimento_p || ''' = ''N'' ' ||
					' and	''' || ie_profissional_p || ''' = ''S'' ' ||
					' and 	dt_liberacao is not null ' ||
					' and	nr_sequencia  in ( select max(x.nr_sequencia) ' ||
					' 				           from	  ' || nm_tabela_p || ' x ' ||
					' 				           where  x.nr_atendimento in ( select b.nr_atendimento ' ||
					' 				           				                from   atendimento_paciente b ' ||
					' 				           				                where  b.cd_pessoa_fisica 	= ''' || cd_pessoa_fisica_p || ''' ) ' ||
					' 				           and	  ''' || ie_inf_entidade_p	|| ''' = ''U'' ' ||
					' 				           and	  x.dt_inativacao is null ' ||
					' 				           and	  x.nm_usuario_nrec = ''' || nm_usuario_w || ''' ' ||
					' 				           union	 ' ||
					' 				           select x.nr_sequencia ' ||
					' 				           from	  ' || nm_tabela_p || ' x ' ||
					' 				           where  x.nr_atendimento in ( select b.nr_atendimento ' ||
					' 				           					            from   atendimento_paciente b ' ||
					' 				           					            where  b.cd_pessoa_fisica 	= ' || cd_pessoa_fisica_p || ') ' ||
					' 				           and	  x.dt_inativacao is null ' ||
					' 				           and	  x.nm_usuario_nrec = ''' || nm_usuario_w || ''' ' ||
					' 				           and	  ''' || ie_inf_entidade_p	|| '''  = ''T'') ' ||
					' order by nr_sequencia ';

	ds_retorno_ww := '';
	open v_cursor for EXECUTE ds_sql_w;
	loop
	fetch v_cursor into nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on v_cursor */
		ds_comando_ww	:= ds_comando_w || chr(13) || 'where nr_sequencia = '||to_char(nr_sequencia_w);

		c001 := dbms_sql.open_cursor;
		dbms_sql.parse(c001, ds_comando_ww, dbms_sql.native);
		dbms_sql.define_column(c001, 1, ds_retorno_ww, 2000);
		qt_cursor_w	:= dbms_sql.execute(c001);
		qt_cursor_w	:= dbms_sql.fetch_rows(c001);
		dbms_sql.column_value(c001, 1, ds_retorno_ww);
		dbms_sql.close_cursor(c001);
		ds_retorno_w	:= ds_retorno_w ||ds_retorno_ww ||chr(13);
	end loop;
	close v_cursor;

end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ehr_entidade_padrao ( nm_tabela_p text, nr_seq_elemento_p bigint, cd_pessoa_fisica_p bigint, nr_atendimento_p bigint, ie_inf_entidade_p text, ie_atendimento_p text, ie_profissional_p text default 'N') FROM PUBLIC;

