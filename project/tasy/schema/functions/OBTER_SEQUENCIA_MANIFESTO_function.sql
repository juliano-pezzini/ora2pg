-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_sequencia_manifesto (p_cd_classificacao bigint, p_dt_referencia timestamp) RETURNS bigint AS $body$
DECLARE

	V_NR_SEQUENCIA	bigint := 0;
	V_AUX       	bigint := 0;
    V_IE_SEQUENCIA  varchar(255);

BEGIN
    SELECT COUNT(*), IE_SEQUENCIA
    INTO STRICT V_AUX, V_IE_SEQUENCIA
    FROM REGRA_CALCULO_MANIFESTO
    WHERE CD_CLASSIFICACAO = p_cd_classificacao
    GROUP BY IE_SEQUENCIA;

    IF (V_AUX > 0) THEN
        CASE V_IE_SEQUENCIA
            WHEN 'A' THEN
	SELECT coalesce(max(NR_MANIFESTO), 0) + 1
                INTO STRICT V_NR_SEQUENCIA
                FROM RESIDUO_MANIFESTO
                WHERE TRUNCAR_DATA(DT_REFERENCIA, 'A') = TRUNCAR_DATA(p_dt_referencia, 'A')
                AND CD_CLASSIFICACAO = p_cd_classificacao;
            WHEN 'D' THEN
                SELECT coalesce(max(NR_MANIFESTO), 0) + 1
                INTO STRICT V_NR_SEQUENCIA
                FROM RESIDUO_MANIFESTO
                WHERE TRUNCAR_DATA(DT_REFERENCIA, 'D') = TRUNCAR_DATA(p_dt_referencia, 'D')
                AND CD_CLASSIFICACAO = p_cd_classificacao;
            WHEN 'M' THEN
                SELECT coalesce(max(NR_MANIFESTO), 0) + 1
                INTO STRICT V_NR_SEQUENCIA
                FROM RESIDUO_MANIFESTO
                WHERE TRUNCAR_DATA(DT_REFERENCIA, 'M') = TRUNCAR_DATA(p_dt_referencia, 'M')
                AND CD_CLASSIFICACAO = p_cd_classificacao;
            WHEN 'U' THEN
                SELECT coalesce(max(NR_MANIFESTO), 0) + 1
                INTO STRICT V_NR_SEQUENCIA
                FROM RESIDUO_MANIFESTO
                WHERE CD_CLASSIFICACAO = p_cd_classificacao;
        END CASE;
    END IF;

	RETURN V_NR_SEQUENCIA;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_sequencia_manifesto (p_cd_classificacao bigint, p_dt_referencia timestamp) FROM PUBLIC;

