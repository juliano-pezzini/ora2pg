-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_saldo_lote_fornec_local ( nr_seq_lote_fornec_p bigint, cd_local_estoque_p bigint, ie_conversao_consumo_p text default 'N') RETURNS bigint AS $body$
DECLARE


qt_lote_w			double precision;
qt_movimento_w		double precision;
qt_saldo_w		double precision := 0;
qt_saldo_ww		double precision := 0;
qt_movimento_nf_w		double precision;
nr_sequencia_nf_w		bigint;
cd_estabelecimento_w	smallint;
dt_mesano_referencia_w	timestamp;
cd_material_w		integer;
cd_material_estoque_w	integer;
ie_estoque_lote_w		varchar(1);
cd_local_estoque_w	smallint;
nr_seq_mat_lote_nf_w		material_lote_fornec_nf.nr_sequencia%type;


BEGIN
if (coalesce(nr_seq_lote_fornec_p,0) > 0) then
	begin
	if (coalesce(cd_local_estoque_p,0) > 0) then
		cd_local_estoque_w := cd_local_estoque_p;
	end if;
	
	select	qt_material,
		nr_sequencia_nf,
		cd_material,
		cd_estabelecimento
	into STRICT	qt_lote_w,
		nr_sequencia_nf_w,
		cd_material_w,
		cd_estabelecimento_w
	from	material_lote_fornec
	where	nr_sequencia = nr_seq_lote_fornec_p;
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_mat_lote_nf_w
	from	material_lote_fornec_nf
	where	nr_seq_lote_fornec = nr_seq_lote_fornec_p;
	
	select	coalesce(max(ie_estoque_lote),'N')
	into STRICT	ie_estoque_lote_w
	from	material_estab
	where	cd_material = cd_material_w
	and	cd_estabelecimento = cd_estabelecimento_w;
	
	select	cd_material_estoque
	into STRICT	cd_material_estoque_w
	from	material
	where	cd_material = cd_material_w;
	
	if (ie_estoque_lote_w = 'N') then
		begin
		select	coalesce(sum(CASE WHEN  a.cd_acao=1 THEN 	CASE WHEN 	b.ie_entrada_saida='E' THEN  a.qt_estoque  ELSE a.qt_estoque * -1 END   ELSE CASE WHEN 	b.ie_entrada_saida='E' THEN  a.qt_estoque * -1  ELSE a.qt_estoque END  END ),0)
		into STRICT	qt_movimento_w
		from	movimento_estoque a,
			operacao_estoque b
		where	a.cd_operacao_estoque = b.cd_operacao_estoque
		and	a.cd_estabelecimento = cd_estabelecimento_w
		and	a.cd_material_estoque = cd_material_estoque_w
		and	(a.dt_processo IS NOT NULL AND a.dt_processo::text <> '')
		and	a.nr_seq_lote_fornec = nr_seq_lote_fornec_p;

		if (coalesce(nr_sequencia_nf_w::text, '') = '') then
			qt_saldo_w := coalesce(qt_lote_w,0) + coalesce(qt_movimento_w,0);
		else
			begin
			select	coalesce(sum(CASE WHEN  a.cd_acao=1 THEN 	CASE WHEN 	b.ie_entrada_saida='E' THEN  a.qt_estoque  ELSE a.qt_estoque * -1 END   ELSE CASE WHEN 	b.ie_entrada_saida='E' THEN  a.qt_estoque * -1  ELSE a.qt_estoque END  END ),0)
			into STRICT	qt_movimento_nf_w
			from	movimento_estoque a,
				operacao_estoque b
			where	a.cd_operacao_estoque = b.cd_operacao_estoque
			and	a.cd_estabelecimento = cd_estabelecimento_w
			and	a.cd_material_estoque = cd_material_estoque_w
			and	(a.dt_processo IS NOT NULL AND a.dt_processo::text <> '')
			and	a.ie_origem_documento = 1
			and	a.nr_seq_tab_orig = nr_sequencia_nf_w
			and	a.nr_seq_lote_fornec = nr_seq_lote_fornec_p;
			
			if (nr_seq_mat_lote_nf_w IS NOT NULL AND nr_seq_mat_lote_nf_w::text <> '') then
				select	coalesce(sum(CASE WHEN  a.cd_acao=1 THEN 	CASE WHEN 	b.ie_entrada_saida='E' THEN  a.qt_estoque  ELSE a.qt_estoque * -1 END   ELSE CASE WHEN 	b.ie_entrada_saida='E' THEN  a.qt_estoque * -1  ELSE a.qt_estoque END  END ),0) + qt_movimento_nf_w
				into STRICT	qt_movimento_nf_w
				from	movimento_estoque a,
					operacao_estoque b,
					material_lote_fornec_nf x
				where	a.cd_operacao_estoque = b.cd_operacao_estoque
				and	a.cd_estabelecimento = cd_estabelecimento_w
				and	a.cd_material_estoque = cd_material_estoque_w
				and	(a.dt_processo IS NOT NULL AND a.dt_processo::text <> '')
				and	a.ie_origem_documento	= 1
				and	a.nr_seq_tab_orig 	= x.nr_sequencia_nf
				and	x.nr_sequencia_nf	<> nr_sequencia_nf_w
				and	a.nr_seq_lote_fornec	= nr_seq_lote_fornec_p
				and	x.nr_seq_lote_fornec	= a.nr_seq_lote_fornec;
			end if;
			
			qt_movimento_w	:= qt_movimento_w - qt_movimento_nf_w;
			qt_saldo_w := coalesce(qt_lote_w,0) + coalesce(qt_movimento_w,0);
			end;
		end if;
		end;
	else
		begin		
		dt_mesano_referencia_w	:= PKG_DATE_UTILS.start_of(clock_timestamp(), 'mm', 0);
		
		select	coalesce(sum(qt_estoque),0)
		into STRICT	qt_saldo_w
		from	saldo_estoque_lote
		where	nr_seq_lote = nr_seq_lote_fornec_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	dt_mesano_referencia = dt_mesano_referencia_w
		and	cd_local_estoque = coalesce(cd_local_estoque_w,cd_local_estoque);
		
		select	coalesce(sum(qt_estoque),0)
		into STRICT	qt_saldo_ww
		from	fornecedor_mat_consig_lote
		where	nr_seq_lote = nr_seq_lote_fornec_p
		and	cd_estabelecimento = cd_estabelecimento_w
		and	dt_mesano_referencia = dt_mesano_referencia_w
		and	cd_local_estoque = coalesce(cd_local_estoque_w,cd_local_estoque);
		
		qt_saldo_w := qt_saldo_w + qt_saldo_ww;
		end;
	end if;
	end;
end if;

if (ie_conversao_consumo_p = 'S') then
	select	max(cd_material)
	into STRICT	cd_material_w
	from	material_lote_fornec
	where	nr_sequencia = nr_seq_lote_fornec_p;
	
	select	round((qt_saldo_w * qt_conv_estoque_consumo)::numeric,4)
	into STRICT	qt_saldo_w
	from	material
	where	cd_material = cd_material_w;
end if;

return	qt_saldo_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_saldo_lote_fornec_local ( nr_seq_lote_fornec_p bigint, cd_local_estoque_p bigint, ie_conversao_consumo_p text default 'N') FROM PUBLIC;

