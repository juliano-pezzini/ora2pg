-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_valor_contab ( nr_seq_regra_p bigint, cd_conta_contabil_p text, ie_opcao_p text, nr_seq_mes_ref_p bigint, cd_centro_custo_p text, cd_estabelecimento_p bigint) RETURNS bigint AS $body$
DECLARE


cd_classif_w			varchar(40);
dt_referencia_w			timestamp;
vl_retorno_w			double precision;
vl_saldo_w			double precision;
vl_encerramento_w			double precision;
vl_movimento_w			double precision;
vl_credito_w			double precision;
vl_debito_w			double precision;
cd_centro_w			varchar(40);
ie_tipo_conta_w			varchar(01);
ie_tipo_w				varchar(01);
cd_empresa_w			bigint;


BEGIN

select	dt_referencia,
	cd_empresa
into STRICT	dt_referencia_w,
	cd_empresa_w
from	ctb_mes_ref
where	nr_sequencia		= nr_seq_mes_ref_p;



select	max(b.ie_tipo),
	max(a.ie_tipo)
into STRICT	ie_tipo_conta_w,
	ie_tipo_w
from	ctb_grupo_conta b,
	conta_contabil a
where	a.cd_grupo		= b.cd_grupo
and	a.cd_conta_contabil	= cd_conta_contabil_p;

if (coalesce(cd_centro_custo_p::text, '') = '') then
	begin
	select	coalesce(sum(vl_saldo),0),
		coalesce(sum(vl_encerramento),0),
		coalesce(sum(vl_movimento),0),
		coalesce(sum(vl_credito),0),
		coalesce(sum(vl_debito),0)
	into STRICT	vl_saldo_w,
		vl_encerramento_w,
		vl_movimento_w,
		vl_credito_w,
		vl_debito_w
	from	ctb_saldo a
	where	nr_seq_mes_ref in (
		SELECT nr_seq_mes_ref_p
		
		where ie_opcao_p not in ('MA','MAC','MAD')
		
union

		SELECT	nr_sequencia
		from	ctb_mes_ref
		where	dt_referencia	between trunc(dt_referencia_w,'year') and dt_referencia_w
		and	ie_opcao_p in ('MA','MAC','MAD'))
	and	cd_conta_contabil	= cd_conta_contabil_p
	and	((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p));


	end;
elsif (ie_tipo_w = 'A') then
	select	coalesce(sum(vl_saldo),0),
		coalesce(sum(vl_encerramento),0),
		coalesce(sum(vl_movimento),0),
		coalesce(sum(vl_credito),0),
		coalesce(sum(vl_debito),0)
	into STRICT	vl_saldo_w,
		vl_encerramento_w,
		vl_movimento_w,
		vl_credito_w,
		vl_debito_w
	from	centro_custo b,
		ctb_saldo a
	where	nr_seq_mes_ref	in (
		SELECT nr_seq_mes_ref_p
		
		where ie_opcao_p not in ('MA','MAC','MAD')
		
union

		SELECT	nr_sequencia
		from	ctb_mes_ref
		where	dt_referencia	between trunc(dt_referencia_w,'year') and dt_referencia_w
		and	ie_opcao_p in ('MA','MAC','MAD'))
	and	cd_conta_contabil	= cd_conta_contabil_p
	and	((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
	and	a.cd_centro_custo	= b.cd_centro_custo
	and	cd_centro_custo_p 		= substr(b.cd_classificacao,1, length(cd_centro_custo_p));
else
	select	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_referencia_w),1,40)
	into STRICT	cd_classif_w
	from	conta_contabil
	where	cd_conta_contabil	= cd_conta_contabil_p;

	select	coalesce(sum(vl_saldo),0),
		coalesce(sum(vl_encerramento),0),
		coalesce(sum(vl_movimento),0),
		coalesce(sum(vl_credito),0),
		coalesce(sum(vl_debito),0)
	into STRICT	vl_saldo_w,
		vl_encerramento_w,
		vl_movimento_w,
		vl_credito_w,
		vl_debito_w
	from	Conta_contabil c,
		centro_custo b,
		ctb_saldo a
	where	nr_seq_mes_ref	in (
		SELECT nr_seq_mes_ref_p
		
		where ie_opcao_p not in ('MA','MAC','MAD')
		
union

		SELECT	nr_sequencia
		from	ctb_mes_ref
		where	dt_referencia	between trunc(dt_referencia_w,'year') and dt_referencia_w
		and	ie_opcao_p in ('MA','MAC','MAD'))
	and	a.cd_conta_contabil	= c.cd_conta_contabil
	and	((coalesce(cd_estabelecimento_p::text, '') = '') or (a.cd_estabelecimento = cd_estabelecimento_p))
	and	a.cd_centro_custo	= b.cd_centro_custo
	and	cd_centro_custo_p 		= substr(b.cd_classificacao,1, length(cd_centro_custo_p))
	and	cd_classif_w		= substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, dt_referencia_w),1, length(cd_classif_w));

end if;

if ( ie_opcao_p in ('OA','OM')) then

	if (ie_tipo_w = 'A') then
		begin
		select	coalesce(sum(a.vl_orcado),0)
		into STRICT	vl_retorno_w
		from	centro_custo c,
			ctb_orcamento a,
			ctb_mes_ref b
		where	b.nr_sequencia		= a.nr_seq_mes_ref
		and	a.cd_centro_custo	= c.cd_centro_custo
		and	a.cd_estabelecimento	= coalesce(cd_estabelecimento_p, a.cd_estabelecimento)
		and	b.cd_empresa		= cd_empresa_w
		and	((coalesce(cd_centro_custo_p::text, '') = '') or (substr(c.cd_classificacao,1,length( cd_centro_custo_p )) = cd_centro_custo_p))
		and	a.cd_conta_contabil	= cd_conta_contabil_p
		and	b.dt_referencia between CASE WHEN ie_opcao_p='OA' THEN  trunc(dt_referencia_w, 'yyyy')  ELSE dt_referencia_w END  and dt_referencia_w;

		end;
	elsif (ie_tipo_w = 'T') then
		begin
		select	coalesce(max(a.vl_orcado),0)
		into STRICT	vl_retorno_w
		from	centro_custo c,
			ctb_orcamento a,
			ctb_mes_ref b
		where	b.nr_sequencia		= a.nr_seq_mes_ref
		and	a.cd_centro_custo	= c.cd_centro_custo
		and	a.cd_estabelecimento	= coalesce(cd_estabelecimento_p, a.cd_estabelecimento)
		and	b.cd_empresa		= cd_empresa_w
		and	((coalesce(cd_centro_custo_p::text, '') = '') or (substr(c.cd_classificacao,1,length( cd_centro_custo_p )) = cd_centro_custo_p))
		and	a.cd_conta_contabil	= cd_conta_contabil_p
		and	b.dt_referencia between CASE WHEN ie_opcao_p='OA' THEN  trunc(dt_referencia_w, 'yyyy')  ELSE dt_referencia_w END  and dt_referencia_w
		and	substr(ctb_obter_classif_conta(a.cd_conta_contabil, a.cd_classif_conta, dt_referencia_w),1,length(cd_classif_w)) = cd_classif_w;
		end;
	end if;

end if;

if (ie_opcao_p = 'S') then
	begin
	if (vl_encerramento_w <> 0) then
		vl_retorno_w		:= vl_saldo_w - vl_encerramento_w;
	else
		vl_retorno_w		:= vl_saldo_w;
	end if;
	end;
elsif (ie_opcao_p = 'SC') then
	vl_retorno_w			:= vl_saldo_w;
elsif (ie_opcao_p = 'M') then
	vl_retorno_w			:= vl_movimento_w;
elsif (ie_opcao_p = 'MA') then
	vl_retorno_w			:= vl_movimento_w;
elsif (ie_opcao_p in ('MD','MAD')) then
	vl_retorno_w			:= vl_debito_w;
elsif (ie_opcao_p in ('MC','MAC')) then
	vl_retorno_w			:= vl_credito_w;
elsif (ie_opcao_p in ('MASE','MCSE')) then
	if (vl_encerramento_w <> 0) then
		vl_retorno_w		:= vl_movimento_w - vl_encerramento_w;
	else
		vl_retorno_w		:= vl_movimento_w;
	end if;
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_valor_contab ( nr_seq_regra_p bigint, cd_conta_contabil_p text, ie_opcao_p text, nr_seq_mes_ref_p bigint, cd_centro_custo_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

