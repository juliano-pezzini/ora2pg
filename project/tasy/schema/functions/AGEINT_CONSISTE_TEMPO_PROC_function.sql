-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ageint_consiste_tempo_proc ( nr_seq_item_p bigint, cd_Agenda_p bigint, dt_agenda_p timestamp, cd_pessoa_fisica_p text, nr_seq_ageint_lib_p bigint, nr_minuto_duracao_p bigint, nm_usuario_p text, nr_seq_hor_p bigint) RETURNS varchar AS $body$
DECLARE

 
nr_seq_proc_interno_w	bigint;
qt_minuto_w		bigint;
ie_status_Agenda_w	varchar(3);
nr_minuto_duracao_w	bigint;
ds_retorno_w		varchar(1)	:= 'S';
nr_duracao_aux_w	bigint;
hr_Agenda_w		timestamp;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
cd_medico_w		varchar(10);
ie_lado_w		varchar(1);
ie_bloqueio_w		varchar(1);
ie_dia_semana_w		smallint;

C01 CURSOR FOR 
	SELECT	hr_Agenda, 
		ie_status_agenda, 
		nr_minuto_duracao 
	from	ageint_horarios_usuario 
	where	cd_Agenda		= cd_agenda_p 
	and	trunc(hr_Agenda)	= dt_Agenda_p 
	and	nm_usuario		= nm_usuario_p 
	and	nr_Seq_ageint_lib	= nr_seq_ageint_lib_p 
	and	nr_Sequencia > nr_seq_hor_p 
	order by hr_Agenda;
			
			 

BEGIN 
 
nr_duracao_aux_w	:= nr_minuto_duracao_p;
 
select	max(nr_seq_proc_interno), 
	max(ie_lado) 
into STRICT	nr_seq_proc_interno_w, 
	ie_lado_w 
from	agenda_integrada_item 
where	nr_sequencia	= nr_seq_item_p;
 
qt_minuto_w := Obter_Tempo_Padrao_Ageint(nr_seq_proc_interno_w, cd_procedimento_w, ie_origem_proced_w, cd_medico_w, cd_agenda_p, cd_pessoa_fisica_p, qt_minuto_w, ie_lado_w, null, null, null, null, ie_dia_semana_w);
 
if (qt_minuto_w	<> 0) then	 
	open C01;
	loop 
	fetch C01 into	 
		hr_Agenda_w, 
		ie_status_Agenda_w, 
		nr_minuto_duracao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		if (ie_status_agenda_w in ('L','B')) and (ds_retorno_w <> 'N') then 
			nr_duracao_aux_w	:= nr_duracao_aux_w + nr_minuto_duracao_w;
			if (nr_duracao_aux_w	>= qt_minuto_w) then 
				ds_retorno_w	:= 'S';
			end if;
		elsif (nr_duracao_aux_w	< qt_minuto_w) then 
			ds_retorno_w	:= 'N';
		end if;
		end;
	end loop;
	close C01;
end if;
 
select	obter_cod_dia_semana(dt_agenda_p) 
into STRICT	ie_dia_semana_w
;
 
select	sum(nr_minuto_duracao) 
into STRICT	nr_minuto_duracao_w 
from	ageint_horarios_usuario 
where	cd_agenda = cd_agenda_p 
and	hr_agenda between dt_agenda_p and dt_agenda_p + nr_minuto_duracao_p/1440 
and	ie_status_agenda not in ('C','B','F') 
and	nr_Seq_ageint_lib	= nr_seq_ageint_lib_p 
and	nm_usuario = nm_usuario_p;
 
 
if (nr_minuto_duracao_w <> 0) and (nr_minuto_duracao_w < nr_minuto_duracao_p) then 
	ds_retorno_w := 'N';
end if;
 
return	ds_retorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ageint_consiste_tempo_proc ( nr_seq_item_p bigint, cd_Agenda_p bigint, dt_agenda_p timestamp, cd_pessoa_fisica_p text, nr_seq_ageint_lib_p bigint, nr_minuto_duracao_p bigint, nm_usuario_p text, nr_seq_hor_p bigint) FROM PUBLIC;

