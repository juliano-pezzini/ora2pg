-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_pertences_exame (nr_atendimento_p bigint) RETURNS varchar AS $body$
DECLARE


qt_registros_w		bigint;
nm_usuario_w		varchar(15);
varformaestrut_w	varchar(1);
ie_pertences_w		varchar(1);



BEGIN
nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

varformaestrut_w := obter_param_usuario(991, 6, obter_perfil_ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento, varformaestrut_w);

if (varformaestrut_w = 'S') then

	select	count(*)
	into STRICT	qt_registros_w
	from	pertence_paciente_item a ,
		pertence_paciente b,
		pertence_item c
	where	b.nr_sequencia = a.nr_seq_pertence_paciente
	and		b.nr_atendimento = nr_atendimento_p
	and	    a.nr_seq_pertence = c.nr_sequencia
	and		c.ie_tipo = 'E'
	and		not exists (SELECT 1
					   from pertence_pac_item_evento x
						where x.nr_seq_pert_pac = a.nr_sequencia
						and	  x.cd_tipo_evento = 'E');

else

	select  count(*)
	into STRICT	qt_registros_w
	from    exame_paciente a
	where   a.nr_atendimento	= nr_atendimento_p
	and		coalesce(a.dt_entrega::text, '') = ''
	and		coalesce(a.ie_situacao,'A') = 'A';

end if;

if (qt_registros_w > 0) then
	ie_pertences_w := 'S';
else
	ie_pertences_w := 'N';
end if;

return  ie_pertences_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_pertences_exame (nr_atendimento_p bigint) FROM PUBLIC;

