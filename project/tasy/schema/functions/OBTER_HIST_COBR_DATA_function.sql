-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_hist_cobr_data ( nr_seq_cobranca_p bigint, dt_referencia_p timestamp, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE


/* ie_opcao_p
SE - Sequência do histórico
*/
nr_seq_historico_w	bigint;
dt_historico_w		timestamp;


BEGIN

/*lhalves OS369028 em 07/10/2011 - Performance*/

begin
select	dt_historico
into STRICT	dt_historico_w
from (SELECT	x.dt_historico
	from	cobranca_historico x
	where	x.nr_seq_cobranca	= nr_seq_cobranca_p
	and	x.dt_historico		<= fim_dia(dt_referencia_p)
	order	by x.dt_historico desc) alias1 LIMIT 1;
exception
when others then
	dt_historico_w	:= null;
end;

begin
select	nr_sequencia
into STRICT	nr_seq_historico_w
from (SELECT	b.nr_sequencia
	from	cobranca_historico b
	where	b.nr_seq_cobranca 	= nr_seq_cobranca_p
	and	b.dt_historico		= dt_historico_w
	order by b.nr_sequencia	desc) alias0 LIMIT 1;
exception
when others then
	nr_seq_historico_w	:= null;
end;

if (ie_opcao_p	= 'SE') then
	return to_char(nr_seq_historico_w);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_hist_cobr_data ( nr_seq_cobranca_p bigint, dt_referencia_p timestamp, ie_opcao_p text) FROM PUBLIC;

