-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_dados_arq_nf_ptu ( nr_seq_fatura_p ptu_fatura.nr_sequencia%type, nm_arquivo_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

/*  ie_opcao_p
NFC - Sequencia da nota de cobranca com base no nome do arquivo
*/
ds_retorno_w       varchar(500);
nr_lote_ini_w      smallint;
nr_lote_tam_w      smallint;
nr_nota_ini_w      smallint;
nr_nota_tam_w      smallint;
nr_guia_tiss_ini_w smallint;
nr_guia_tiss_tam_w smallint;

ie_tipo_exportacao_w ptu_fatura.ie_tipo_exportacao%type;


BEGIN

-- busca o tipo da fatura
select coalesce(max(fat.ie_tipo_exportacao), 'TXT')
into STRICT 	ie_tipo_exportacao_w
from 	ptu_fatura fat
where 	fat.nr_sequencia = nr_seq_fatura_p;

ds_retorno_w := '';

if (ie_opcao_p = 'NFC') then

	if ie_tipo_exportacao_w = 'TXT' then

		-- Existem dois tipos de nomeclaturas, a do webstart e do ptu , e para cada uma, existe a completa e simplificada, 

		-- PTU BATCH

		-- A completa vai possuir 83 caracteres

		-- A simplificada vai possuir 35 caracteres


		-- Sempre parte-se do principio que sera a  PTU simplificada, depois se avalia se e a completa, para garantir que se tenha um valor padrao
		nr_lote_ini_w := 1;
		nr_lote_tam_w := 8;
		nr_nota_ini_w := 9;
		nr_nota_tam_w := 20;

		--PTU - Completa
		if (length(nm_arquivo_p) = 83) then
			nr_lote_ini_w := 45;
			nr_lote_tam_w := 8;
			nr_nota_ini_w := 53;
			nr_nota_tam_w := 20;
		end if;

		-- WebStart - Simplificada
		if (length(nm_arquivo_p) = 35) then
			nr_lote_ini_w := 1;
			nr_lote_tam_w := 8;
			nr_nota_ini_w := 9;
			nr_nota_tam_w := 11;
		end if;

		--WebStart - Completa
		if (length(nm_arquivo_p) = 45) then
			nr_lote_ini_w := 16;
			nr_lote_tam_w := 8;
			nr_nota_ini_w := 24;
			nr_nota_tam_w := 11;
		end if;

		select 	max(to_char(cob.nr_sequencia))
		into STRICT 	ds_retorno_w
		from 	ptu_nota_cobranca cob
		where 	cob.nr_seq_fatura 	= nr_seq_fatura_p
		and 	cob.nr_lote 	= (obter_somente_numero(substr(nm_arquivo_p,nr_lote_ini_w,nr_lote_tam_w)))::numeric
		and 	cob.nr_nota 	= (obter_somente_numero(substr(nm_arquivo_p,nr_nota_ini_w,nr_nota_tam_w)))::numeric;
	else

	
		--  Sempre parte-se do principio que sera a  PTU simplificada,
		nr_lote_ini_w := 1;
		nr_lote_tam_w := 12;
		nr_guia_tiss_ini_w := 13;
		nr_guia_tiss_tam_w := 20;
	
		/*
		Anexos das guias de Consulta, SP/SADT, Internaco e Honorario:
		AAMMNNNNNNNNNNNNNNNNNNNNFFFFFFFFFFFFFFFFFFFFLLLLLLLLLLLLGGGGGGGGGGGGGGGGGGGGUUUUSSS.pdf
		LLLLLLLLLLLL = nr_LotePrestador
		GGGGGGGGGGGGGGGGGGGG = nr_GuiaTissPrestador
		**/
		if length(nm_arquivo_p) = 87 then
			nr_lote_ini_w := 45;
			nr_lote_tam_w := 12;
			nr_guia_tiss_ini_w := 57;
			nr_guia_tiss_tam_w := 20;
		end if;

		/*
		Simplificado:
		LLLLLLLLLLLLGGGGGGGGGGGGGGGGGGGGSSS.pdf
		LLLLLLLLLLLL = nr_LotePrestador
		GGGGGGGGGGGGGGGGGGGG = nr_GuiaTissPrestador
		SSS = sequencial do arquivo anexo
		**/
		
		if length(nm_arquivo_p) = 39 then
			nr_lote_ini_w := 1;
			nr_lote_tam_w := 12;
			nr_guia_tiss_ini_w := 13;
			nr_guia_tiss_tam_w := 20;
		end if;
		
		select 	max(to_char(cob.nr_sequencia))
		into STRICT 	ds_retorno_w
		from 	ptu_nota_cobranca cob
		where 	cob.nr_seq_fatura 	= nr_seq_fatura_p
		and 	(obter_somente_numero(cob.nr_lote_prest))::numeric  		= (obter_somente_numero(substr(nm_arquivo_p,nr_lote_ini_w,nr_lote_tam_w)))::numeric
		and 	(obter_somente_numero(cob.nr_guia_tiss_prestador))::numeric  	= (obter_somente_numero(substr(nm_arquivo_p,nr_guia_tiss_ini_w,nr_guia_tiss_tam_w)))::numeric;
		
	end if;
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_dados_arq_nf_ptu ( nr_seq_fatura_p ptu_fatura.nr_sequencia%type, nm_arquivo_p text, ie_opcao_p text) FROM PUBLIC;

