-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_verificar_idade_limite ( dt_referencia_p timestamp, nr_seq_segurado_p bigint ) RETURNS bigint AS $body$
DECLARE


-- Esta function foi criada para o relatorio WPLS 03297 - OPS - Conferencia do valor de mensalidade dos beneficiarios
				
dt_base_inclusao_w		timestamp;
dt_adaptacao_w			timestamp;
dt_mes_idade_limite_w		timestamp;
dt_mes_tempo_limite_w		timestamp;
qt_idade_w			bigint;
cd_estabelecimento_w		bigint;
qt_idade_limite_w		bigint;
qt_tempo_limite_w		bigint;
qt_anos_adesao_w		bigint;
nr_seq_mtvo_alteracao_w		bigint;
qt_idade_operadora_w		bigint;
qt_meses_add_w			bigint;
qt_meses_add_ww			bigint;
qt_anos_adesao_ww		bigint;
qt_idade_limite_ww		bigint;
qt_anos_tempo_limite_w		bigint;
qt_idade_ww			bigint;
ie_regulamentacao_w		varchar(2);
ie_data_ref_reaj_adaptado_w	varchar(1);
dt_contratacao_w		pls_segurado.dt_contratacao%type;
qt_idade_limite_reaj_benef_w	pls_segurado.qt_idade_limite_reaj%type;
qt_tempo_limite_reaj_benef_w	pls_segurado.qt_anos_limite_reaj%type;
dt_inclusao_operadora_w		pls_segurado.dt_inclusao_operadora%type;
qt_idade_limite_contrato_w	pls_contrato.qt_idade_limite_reaj%type;
qt_tempo_limite_contrato_w	pls_contrato.qt_anos_limite_reaj%type;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
qt_idade_limite_ops_w		pls_parametros.qt_idade_limite%type;
qt_tempo_limite_ops_w		pls_parametros.qt_tempo_limite%type;
ie_reaj_idade_limite_pre_w	pls_parametros.ie_reaj_idade_limite_pre%type;
dt_nascimento_w			pessoa_fisica.dt_nascimento%type;
ie_mes_cobranca_reaj_w		pls_parametros.ie_mes_cobranca_reaj%type;


BEGIN

cd_estabelecimento_w	:=  coalesce(wheb_usuario_pck.get_cd_estabelecimento,1);

select	coalesce(a.qt_idade_limite_reaj,0),
	coalesce(a.qt_anos_limite_reaj,0),
	a.nr_seq_contrato,
	a.dt_contratacao,
	a.dt_inclusao_operadora,
	b.dt_nascimento
into STRICT	qt_idade_limite_reaj_benef_w,
	qt_tempo_limite_reaj_benef_w,
	nr_seq_contrato_w,
	dt_contratacao_w,
	dt_inclusao_operadora_w,
	dt_nascimento_w
from	pls_segurado a,
	pessoa_fisica b
where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
and	a.nr_sequencia = nr_seq_segurado_p;

select	coalesce(max(qt_idade_limite_reaj),0),
	coalesce(max(qt_anos_limite_reaj),0)
into STRICT	qt_idade_limite_contrato_w,
	qt_tempo_limite_contrato_w
from	pls_contrato
where	nr_sequencia = nr_seq_contrato_w;

select	coalesce(qt_idade_limite,0),
	coalesce(qt_tempo_limite,0),
	ie_data_ref_reaj_adaptado,
	ie_reaj_idade_limite_pre,
	ie_mes_cobranca_reaj
into STRICT	qt_idade_limite_ops_w,
	qt_tempo_limite_ops_w,
	ie_data_ref_reaj_adaptado_w,
	ie_reaj_idade_limite_pre_w,
	ie_mes_cobranca_reaj_w
from	pls_parametros
where	cd_estabelecimento = cd_estabelecimento_w;

if (ie_mes_cobranca_reaj_w = 'P') then
	select	pls_obter_idade_segurado(nr_seq_segurado_p, last_day(add_months(dt_referencia_p,-1)), 'A')
	into STRICT	qt_idade_w
	;
else
	select	pls_obter_idade_segurado(nr_seq_segurado_p, last_day(dt_referencia_p), 'A')
	into STRICT	qt_idade_w
	;
end if;

if (qt_idade_limite_reaj_benef_w > 0) or (qt_tempo_limite_reaj_benef_w > 0) then
	qt_idade_limite_w	:= coalesce(qt_idade_limite_reaj_benef_w,0);
	qt_tempo_limite_w	:= coalesce(qt_tempo_limite_reaj_benef_w,0);
elsif (qt_idade_limite_contrato_w > 0) or (qt_tempo_limite_contrato_w > 0) then
	qt_idade_limite_w	:= coalesce(qt_idade_limite_contrato_w,0);
	qt_tempo_limite_w	:= coalesce(qt_tempo_limite_contrato_w,0);
elsif (qt_idade_limite_ops_w > 0) or (qt_tempo_limite_ops_w > 0) then
	qt_idade_limite_w	:= coalesce(qt_idade_limite_ops_w,0);
	qt_tempo_limite_w	:= coalesce(qt_tempo_limite_ops_w,0);
else
	qt_idade_limite_w	:= 999;
	qt_tempo_limite_w	:= 999;
end if;

select	max(c.ie_regulamentacao)
into STRICT	ie_regulamentacao_w
from	pls_contrato a,
	pls_contrato_plano b,
	pls_plano c
where	a.nr_sequencia	= b.nr_seq_contrato
and	b.nr_seq_plano	= c.nr_sequencia
and	a.nr_sequencia 	= nr_seq_contrato_w
and	coalesce(b.dt_inativacao::text, '') = '';

if (ie_regulamentacao_w in ('A','P')) then
	if (ie_data_ref_reaj_adaptado_w = 'A') then
		dt_base_inclusao_w	:= dt_contratacao_w;
	elsif (ie_data_ref_reaj_adaptado_w = 'D') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_mtvo_alteracao_w
		from	pls_motivo_alteracao_plano
		where	cd_ans	= '12';
		
		select	max(dt_alteracao)
		into STRICT	dt_adaptacao_w
		from	pls_segurado_alt_plano
		where	nr_seq_segurado		= nr_seq_segurado_p
		and	ie_situacao 		= 'A'
		and	nr_seq_motivo_alt	= nr_seq_mtvo_alteracao_w;

		dt_base_inclusao_w	:= coalesce(dt_adaptacao_w,dt_inclusao_operadora_w);
	else
		dt_base_inclusao_w	:= dt_inclusao_operadora_w;
	end if;
else
	dt_base_inclusao_w	:= dt_inclusao_operadora_w;
end if;

qt_idade_operadora_w := round((obter_idade(dt_base_inclusao_w, dt_referencia_p, 'A'))::numeric );

if	((qt_idade_operadora_w >= qt_tempo_limite_w) and (qt_idade_w >= qt_idade_limite_w) and
	((ie_regulamentacao_w <> 'R') or (ie_regulamentacao_w = 'R' and ie_reaj_idade_limite_pre_w = 'S'))) then
	qt_meses_add_w 		:= (12*qt_idade_limite_w);

	qt_meses_add_ww		:= (12*qt_tempo_limite_w);

	dt_mes_tempo_limite_w	:= add_months(dt_base_inclusao_w,qt_meses_add_ww);

	dt_mes_idade_limite_w 	:= add_months(dt_nascimento_w,qt_meses_add_w);

	qt_anos_adesao_w	:= (obter_idade(dt_nascimento_w,dt_inclusao_operadora_w,'A'))::numeric;

	qt_anos_adesao_ww	:= (obter_idade(dt_inclusao_operadora_w,dt_mes_idade_limite_w,'A'))::numeric;

	qt_anos_tempo_limite_w	:= (obter_idade(dt_nascimento_w,dt_mes_tempo_limite_w,'A'))::numeric;

	if (qt_anos_adesao_ww < qt_tempo_limite_w) and (coalesce(qt_anos_adesao_ww,0) > 0) then
		qt_idade_w 	:= qt_idade_limite_w;
	elsif (qt_anos_adesao_w >= qt_idade_limite_w) then
		qt_idade_ww	:= qt_anos_adesao_w+qt_tempo_limite_w;

		if (qt_idade_ww < qt_idade_w) then
			qt_idade_w 	:= qt_idade_ww;
		end if;
	elsif (qt_anos_tempo_limite_w >= qt_idade_limite_w) and (coalesce(qt_anos_tempo_limite_w,0) > 0) then
		qt_idade_w	:= qt_anos_tempo_limite_w;
	else
		qt_idade_w 	:= qt_idade_limite_w - 1;
	end if;
end if;

return	qt_idade_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_verificar_idade_limite ( dt_referencia_p timestamp, nr_seq_segurado_p bigint ) FROM PUBLIC;

