-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_vl_proc_mat_conta ( nr_seq_prestador_p bigint, ie_tipo_guia_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ie_tiss_p text) RETURNS bigint AS $body$
DECLARE


/*

  ==========================================================================================================
||				ATENÇÃO						||
||										||
||	Esta function foi criada apenas para uso no relatório RT11 - Qtd. e Valor dos eventos por prestador		||
||										||
   =========================================================================================================

 */
vl_retorno_w	double precision := 0;
vl_conta_proc_w	double precision := 0;
vl_conta_mat_w	double precision := 0;


BEGIN

	/*begin
	select	sum(nvl(b.vl_cobrado,0))
	into	vl_conta_proc_w
	from	--pls_conta_proc		a,
		pls_conta		b,
		pls_protocolo_conta	c
	where	/*--a.nr_seq_conta = b.nr_sequencia
	and*/
/*	b.ie_tipo_guia = (
					case
						when (ie_tipo_guia_p = 5) then 6
						when (ie_tipo_guia_p = 4) then 5
						when (
							(ie_tipo_guia_p = 2)
							and (b.ie_tipo_guia = 4)
							and (b.nr_seq_tipo_atendimento <> 8)
							) then 4
						when (
							(ie_tipo_guia_p = 1)
							and (b.ie_tipo_guia = 4)
							and (b.nr_seq_tipo_atendimento = 8)
							) then 4
						when (ie_tipo_guia_p = 1) then 3
						else 0
					end
				)
	and	b.nr_seq_prestador_exec = nr_seq_prestador_p
	and	b.nr_seq_protocolo = c.nr_sequencia
	and	c.ie_situacao in ('A','D','T')
	and	c.ie_tipo_protocolo <> 'R'
	and	((c.dt_mes_competencia >= dt_inicio_p) and (c.dt_mes_competencia <= dt_fim_p))
	--and	(((c.ie_origem_protocolo = 'E') and (nvl(ie_tiss_p,'N') = 'S')) or (nvl(ie_tiss_p,'N') = 'N'));
	and	(((b.ie_origem_conta = 'E') and (nvl(ie_tiss_p,'N') = 'S')) or (nvl(ie_tiss_p,'N') = 'N'));
	exception
	when others then
	vl_conta_proc_w := 0;
	end;*/
	begin

	select	sum(coalesce(a.vl_procedimento_imp,a.vl_procedimento))
	into STRICT	vl_conta_proc_w
	from	pls_conta_proc		a,
		pls_conta		b,
		pls_protocolo_conta	c
	where	a.nr_seq_conta = b.nr_sequencia
	and	(
		(ie_tipo_guia_p = 5 AND b.ie_tipo_guia = 6)
		or (ie_tipo_guia_p = 4 AND b.ie_tipo_guia = 5)
		or ((ie_tipo_guia_p = 2) and (b.ie_tipo_guia = 4) and (pls_obter_cd_tiss_atendimento(b.nr_seq_tipo_atendimento) <> '04'))
		or ((ie_tipo_guia_p = 1) and (b.ie_tipo_guia = 4) and (pls_obter_cd_tiss_atendimento(b.nr_seq_tipo_atendimento) = '04'))
		or (ie_tipo_guia_p = 1 AND b.ie_tipo_guia = 3)
		)
	/*and	b.ie_tipo_guia = (
					case
						when (ie_tipo_guia_p = 5) then 6
						when (ie_tipo_guia_p = 4) then 5
						when (
							(ie_tipo_guia_p = 2)
							and (b.ie_tipo_guia = 4)
							and (pls_obter_cd_tiss_atendimento(b.nr_seq_tipo_atendimento) <> '04')
							) then 4
						when (
							(ie_tipo_guia_p = 1)
							and (b.ie_tipo_guia = 4)
							and (pls_obter_cd_tiss_atendimento(b.nr_seq_tipo_atendimento) = '04')
							) then 4
						when (ie_tipo_guia_p = 1) then 3
						else 0
					end
				)*/
	and	b.nr_seq_prestador_exec = nr_seq_prestador_p
	and	b.nr_seq_protocolo = c.nr_sequencia
	and	c.ie_situacao in ('A','D','T')
	and	c.ie_tipo_protocolo <> 'R'
	and	(c.dt_mes_competencia >= dt_inicio_p AND c.dt_mes_competencia <= dt_fim_p)
	--and	(((c.ie_origem_protocolo = 'E') and (nvl(ie_tiss_p,'N') = 'S')) or (nvl(ie_tiss_p,'N') = 'N'));
	and	(((b.ie_origem_conta = 'E') and (coalesce(ie_tiss_p,'N') = 'S')) or (coalesce(ie_tiss_p,'N') = 'N'));

	exception
	when others then
	vl_conta_proc_w := 0;
	end;

	begin

	select	sum(coalesce(a.vl_material_imp,a.vl_material))
	into STRICT	vl_conta_mat_w
	from	pls_conta_mat		a,
		pls_conta		b,
		pls_protocolo_conta	c
	where	a.nr_seq_conta = b.nr_sequencia
	and	(
		(ie_tipo_guia_p = 5 AND b.ie_tipo_guia = 6)
		or (ie_tipo_guia_p = 4 AND b.ie_tipo_guia = 5)
		or ((ie_tipo_guia_p = 2) and (b.ie_tipo_guia = 4) and (pls_obter_cd_tiss_atendimento(b.nr_seq_tipo_atendimento) <> '04'))
		or ((ie_tipo_guia_p = 1) and (b.ie_tipo_guia = 4) and (pls_obter_cd_tiss_atendimento(b.nr_seq_tipo_atendimento) = '04'))
		or (ie_tipo_guia_p = 1 AND b.ie_tipo_guia = 3)
		)
	/*and	b.ie_tipo_guia = (
						case
							when (ie_tipo_guia_p = 5) then 6
							when (ie_tipo_guia_p = 4) then 5
							when (
								(ie_tipo_guia_p = 2)
								and (b.ie_tipo_guia = 4)
								and (b.nr_seq_tipo_atendimento <> 8)
								) then 4
							when (
								(ie_tipo_guia_p = 1)
								and (b.ie_tipo_guia = 4)
								and (b.nr_seq_tipo_atendimento = 8)
								) then 4
							when (ie_tipo_guia_p = 1) then 3
							else 0
						end
					)*/
	/*and	(
		(b.ie_tipo_guia = ie_tipo_guia_p) or
						(
							(ie_tipo_guia_p = 3) and
							(b.ie_tipo_guia = 4) and
							(pls_obter_cd_tiss_atendimento(b.nr_seq_tipo_atendimento) = '04')
						)
		)*/
	and	b.nr_seq_prestador_exec = nr_seq_prestador_p
	and	b.nr_seq_protocolo = c.nr_sequencia
	and	c.ie_situacao in ('A','D','T')
	and	c.ie_tipo_protocolo <> 'R'
	and	(c.dt_mes_competencia >= dt_inicio_p AND c.dt_mes_competencia <= dt_fim_p)
	--and	(((c.ie_origem_protocolo = 'E') and (nvl(ie_tiss_p,'N') = 'S')) or (nvl(ie_tiss_p,'N') = 'N'));
	and	(((b.ie_origem_conta = 'E') and (coalesce(ie_tiss_p,'N') = 'S')) or (coalesce(ie_tiss_p,'N') = 'N'));

	exception
	when others then
	vl_conta_mat_w := 0;
	end;

	vl_retorno_w := coalesce(vl_conta_proc_w,0) + coalesce(vl_conta_mat_w,0);

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_vl_proc_mat_conta ( nr_seq_prestador_p bigint, ie_tipo_guia_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ie_tiss_p text) FROM PUBLIC;

