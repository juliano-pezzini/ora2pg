-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION ctb_obter_valor_repasse ( nr_sequencia_p bigint, ie_opcao_p text, ie_apura_valor_p text, ie_cancelamento_conta_p text) RETURNS bigint AS $body$
DECLARE



vl_repasse_w		double precision		:= 0;


BEGIN

if (ie_apura_valor_p = 'S') then

	if (ie_opcao_p	= 'P') then
		if (coalesce(ie_cancelamento_conta_p::text, '') = '') then
			select	coalesce(sum(a.vl_repasse),0)
			into STRICT	vl_repasse_w
			from 	procedimento_repasse	a
			where	a.nr_seq_procedimento 	= nr_sequencia_p
			and	coalesce(nr_lote_contabil,0)	= 0
			and	coalesce(nr_interno_conta_est::text, '') = '';
		elsif (ie_cancelamento_conta_p = 'E') then
			select	coalesce(sum(a.vl_repasse),0)
			into STRICT	vl_repasse_w
			from 	procedimento_repasse	a
			where	a.nr_seq_procedimento 	= nr_sequencia_p
			and	coalesce(nr_lote_contabil,0)	= 0
			and	(nr_interno_conta_est IS NOT NULL AND nr_interno_conta_est::text <> '');
		elsif (ie_cancelamento_conta_p = 'C') then
		/* OS  108592 Matheus / Edgar 19/11/2008
		Deve existir este tratamento para contas canceladas mesmo que o procedimento ja esteja contabilizado
		porque o repasse da conta cancelada e pelo procedimento de estorno.
		Utilizado somente nos casos onde e contabilizado o repasse na receita
		*/
			select	coalesce(sum(a.vl_repasse),0)
			into STRICT	vl_repasse_w
			from 	procedimento_repasse	a
			where	a.nr_seq_procedimento 	= nr_sequencia_p
			and	coalesce(nr_lote_contabil,0)	= 0 /*Adicionei esta linha porque se ja foi contabilizado nao vai entrar no repasse entao nao deve estar na receita*/
			and	coalesce(a.nr_interno_conta_est::text, '') = '';
			/*and	nr_interno_conta_est	is not null;  Retirado na OS 821698 */

		end if;
	else
		if (coalesce(ie_cancelamento_conta_p::text, '') = '') then
			select	coalesce(sum(a.vl_repasse),0)
			into STRICT	vl_repasse_w
			from 	material_repasse	a
			where	a.nr_seq_material 	= nr_sequencia_p
			and	coalesce(nr_lote_contabil,0)	= 0
			and	coalesce(nr_interno_conta_est::text, '') = '';
		elsif (ie_cancelamento_conta_p = 'E') then
			select	coalesce(sum(a.vl_repasse),0)
			into STRICT	vl_repasse_w
			from 	material_repasse	a
			where	a.nr_seq_material 		= nr_sequencia_p
			and	coalesce(nr_lote_contabil,0)	= 0
			and	(nr_interno_conta_est IS NOT NULL AND nr_interno_conta_est::text <> '');
		elsif (ie_cancelamento_conta_p = 'C') then
		/* OS  108592 Matheus / Edgar 19/11/2008
		Deve existir este tratamento para contas canceladas mesmo que o material ja esteja contabilizado
		porque o repasse da conta cancelada e pelo material de estorno.
		Utilizado somente nos casos onde e contabilizado o repasse na receita
		*/
			select	coalesce(sum(a.vl_repasse),0)
			into STRICT	vl_repasse_w
			from 	material_repasse	a
			where	a.nr_seq_material 	= nr_sequencia_p
			and	coalesce(nr_interno_conta_est::text, '') = '';
		end if;
	end if;
end if;

vl_repasse_w		:= coalesce(vl_repasse_w,0);

return vl_repasse_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ctb_obter_valor_repasse ( nr_sequencia_p bigint, ie_opcao_p text, ie_apura_valor_p text, ie_cancelamento_conta_p text) FROM PUBLIC;

