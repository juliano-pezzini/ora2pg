-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_lib_prescr_leite_mat ( nr_prescricao_p text, cd_frasco_p text) RETURNS varchar AS $body$
DECLARE

				
ds_retorno_w		varchar(1) := 'S';
cd_doadora_w		varchar(60);
cd_atendido_w       	varchar(60);
ie_rn_w           	varchar(1);
ie_filiacao_w     	varchar(1);
ie_pasteurizado_w 	varchar(1);


BEGIN

	ie_filiacao_w := 'N';

	if (cd_frasco_p IS NOT NULL AND cd_frasco_p::text <> '' AND nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
	
		select coalesce(CASE WHEN max(coalesce(ie_recem_nato,'N'))='N' THEN  max(cd_pessoa_fisica)  ELSE max(cd_recem_nato) END ,0)
		into STRICT  	cd_atendido_w
		from	prescr_medica
		where 	nr_prescricao = nr_prescricao_p;
	
		select coalesce(max(cd_pessoa_fisica),0)
		into STRICT 	cd_doadora_w
		from	bl_frasco_v
		where	cd_frasco = cd_frasco_p;
			
		if (cd_atendido_w <> 0 and cd_doadora_w <> 0) then
			
			/*verifica se o leite e pasteurizado.*/

			select CASE WHEN substr(bl_obter_dados_status(max(nr_seq_status_leite),'S'),1,10)='P' THEN 'S'  ELSE 'N' END
			into STRICT 	ie_pasteurizado_w
			from	bl_frasco_v
			where 	cd_frasco = cd_frasco_p;
		
			/*verifica se a doadora possui filhos com prescricao de leite materno.*/

			select CASE WHEN coalesce(max(a.cd_pessoa_fisica)::text, '') = '' THEN  'N'  ELSE 'S' END
			into STRICT 	ie_rn_w
			from 	pessoa_fisica a,
				prescr_leite_deriv e,
				prescr_medica f,
				prescr_material pm,
				material c
			where 	a.cd_pessoa_mae = cd_doadora_w
				and a.cd_pessoa_fisica = f.cd_pessoa_fisica
				and f.nr_prescricao = e.nr_prescricao
				and e.nr_prescricao = pm.nr_prescricao
				and pm.cd_material = c.cd_material
				and	exists (SELECT	1
					from	nutricao_leite_deriv e,
						classif_leite_deriv f
					where	e.cd_material = c.cd_material
					and	e.nr_seq_classif = f.nr_sequencia
					and	coalesce(f.ie_leite_materno,'N') = 'S'
					and coalesce(e.ie_situacao,'A') = 'A');
			
			if 	ie_rn_w = 'S' then

				/*verifica se o atendido e filho e da doadora.*/

				select 	CASE WHEN coalesce(max(cd_pessoa_fisica)::text, '') = '' THEN  'N'  ELSE 'S' END
				into STRICT 	ie_filiacao_w
				from	pessoa_fisica
				where 	cd_pessoa_fisica = cd_atendido_w
				and 	cd_pessoa_mae = cd_doadora_w;
				
			end if;

			if (ie_rn_w = 'N' and ie_pasteurizado_w = 'S') or (ie_rn_w = 'S' and ie_filiacao_w = 'S') then
				ds_retorno_w := 'S';
			elsif (ie_rn_w = 'N' and ie_pasteurizado_w = 'N') then
				ds_retorno_w := 'P';
			elsif (ie_rn_w = 'S' and ie_filiacao_w = 'N' and ie_pasteurizado_w = 'N') then
				ds_retorno_w := 'F';
			else
				ds_retorno_w := 'N';
			end if;
		end if;
	end if;

	return ds_retorno_w;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_lib_prescr_leite_mat ( nr_prescricao_p text, cd_frasco_p text) FROM PUBLIC;

