-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_quant_itens_plano (cd_pessoa_fisica_p text, nr_atendimento_p bigint, ie_opcao_p text, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) RETURNS bigint AS $body$
DECLARE

/*
ie_opcao_p
-T = Total
-E = Estendidos
*/
qt_total_w			bigint;
cd_pessoa_fisica_w		varchar(10);
nr_prescr_inicial_w		bigint := 0;
nr_prescr_final_w		bigint := 0;
nr_prescr_inicial_sol_w		bigint := 0;
nr_prescr_final_sol_w		bigint := 0;
nr_prescr_inicial_sae_w		bigint := 0;
nr_prescr_final_sae_w		bigint := 0;
dt_inicio_plano_atual_w		timestamp;
dt_fim_plano_atual_w		timestamp;
cd_setor_atendimento_w		integer;
hr_quebra_w			varchar(10);
ie_horario_setor_w		varchar(1);
ie_inicia_dia_plano_w		varchar(1);
dt_plano_w			varchar(10);
dt_fim_w			timestamp;
ie_estendidos_w			smallint;
ie_agrupar_acm_sn_w		varchar(1);
ie_todos_proc_w			varchar(1);


BEGIN

if (ie_opcao_p	= 'T') then
	ie_estendidos_w	:= 2;
elsif (ie_opcao_p	= 'E') then
	ie_estendidos_w	:= 0;
end if;

ie_agrupar_acm_sn_w := Obter_Param_Usuario(950, 50, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupar_acm_sn_w);
ie_horario_setor_w := obter_param_usuario(950, 75, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_horario_setor_w);
ie_todos_proc_w := Obter_Param_Usuario(1113, 462, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_todos_proc_w);

select	coalesce(max(vl_parametro),max(vl_parametro_padrao))
into STRICT	ie_inicia_dia_plano_w
from	funcao_parametro
where	cd_funcao	= 950
and	nr_sequencia	= 66;

cd_setor_atendimento_w	:= obter_setor_atendimento(nr_atendimento_p);

if (cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '') then
	select	coalesce(max(to_char(hr_inicio_prescricao,'hh24:mi:ss')),'00:00:00')
	into STRICT	hr_quebra_w
	from	setor_atendimento
	where	cd_setor_atendimento	= cd_setor_atendimento_w;
else
	hr_quebra_w	:= '00:00:00';
end if;

dt_inicio_plano_atual_w	:= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || hr_quebra_w,'dd/mm/yyyy hh24:mi:ss');

if (dt_inicio_plano_atual_w > clock_timestamp()) then
	dt_inicio_plano_atual_w	:= dt_inicio_plano_atual_w - 1;
end if;

dt_fim_plano_atual_w	:= ((dt_inicio_plano_atual_w + 1) - 1/86400);
dt_fim_w		:= dt_inicio_plano_atual_w + 2;

if (coalesce(ie_inicia_dia_plano_w,'S')	= 'S') then
	dt_plano_w	:= to_char(dt_inicio_plano_atual_w,'dd/mm/yyyy');
else
	dt_plano_w	:= to_char(dt_fim_plano_atual_w,'dd/mm/yyyy');
end if;

if (coalesce(nr_atendimento_p::text, '') = '') then
	cd_pessoa_fisica_w	:= cd_pessoa_fisica_p;
else
	cd_pessoa_fisica_w	:= obter_pessoa_atendimento(nr_atendimento_p,'C');
end if;

select	coalesce(min(nr_prescricao),0),
	coalesce(max(nr_prescricao),0)
into STRICT	nr_prescr_inicial_w,
	nr_prescr_final_w
from	prescr_medica
where	cd_pessoa_fisica	= cd_pessoa_fisica_w
and	coalesce(nr_atendimento,0)	= coalesce(nr_atendimento_p,coalesce(nr_atendimento,0))
and	coalesce(ie_recem_nato,'N')	= 'N'
and	dt_validade_prescr	between dt_inicio_plano_atual_w and (dt_inicio_plano_atual_w + 2)
and	plt_obter_se_liberado(dt_liberacao_medico,dt_liberacao,dt_liberacao_farmacia) = 'S';

select	coalesce(min(a.nr_prescricao),0),
	coalesce(max(a.nr_prescricao),0)
into STRICT	nr_prescr_inicial_sol_w,
	nr_prescr_final_sol_w
from	prescr_solucao x,
	prescr_medica a
where	x.nr_prescricao = a.nr_prescricao
and	a.cd_pessoa_fisica = cd_pessoa_fisica_w
and	coalesce(a.nr_atendimento,0)	= coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
and	coalesce(a.ie_recem_nato,'N')	= 'N'
and	coalesce(x.nr_seq_dialise::text, '') = ''
and	coalesce(x.ie_hemodialise, 'N') = 'N'
and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
and	((obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicio_plano_atual_w,dt_fim_plano_atual_w) = 'S') or
	 ((x.ie_urgencia = 'S') and (exists (	SELECT	1
			from	prescr_mat_hor b
			where	b.nr_prescricao = x.nr_prescricao
			and	b.nr_seq_solucao = x.nr_seq_solucao
			and	b.dt_horario between dt_inicio_plano_atual_w and dt_fim_plano_atual_w))))
and	plt_obter_se_item_periodo(	null,				null,			ie_horario_setor_w,		dt_plano_w,		null,
					dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
					dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'SOL',
					x.nr_seq_solucao,		a.nr_prescricao,	'O') = 'S';

select	sum(qt_item)
into STRICT	qt_total_w
from	(
	--CCG
	SELECT	count(nr_seq_procedimento) qt_item
	from	(
		SELECT	a.nr_prescricao,
			c.nr_seq_procedimento,
			c.cd_procedimento,
			z.ds_protocolo ds_procedimento,
			x.ie_acm,
			x.ie_se_necessario,
			x.cd_intervalo,
			x.qt_procedimento,
			coalesce(x.ie_suspenso,'N') ie_suspenso,
			c.nr_seq_proc_interno,
			x.nr_seq_prot_glic,
			x.cd_intervalo,
			x.ie_origem_proced,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.ie_lib_farm,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			x.dt_extensao,
			x.ie_horario_susp,
			coalesce(a.ie_prescr_emergencia,'N') ie_retrogrado
		from	pep_protocolo_glicemia z,
			procedimento y,
			proc_interno w,
			prescr_procedimento x,
			prescr_proc_hor c,
			prescr_medica a
		where	z.nr_sequencia = x.nr_seq_prot_glic
		and	y.cd_procedimento = x.cd_procedimento
		and	y.ie_origem_proced = x.ie_origem_proced
		and	y.cd_procedimento = c.cd_procedimento
		and	y.ie_origem_proced = c.ie_origem_proced
		and	w.nr_sequencia = x.nr_seq_proc_interno
		and	w.nr_sequencia = c.nr_seq_proc_interno
		and	x.nr_prescricao = c.nr_prescricao
		and	x.nr_sequencia = c.nr_seq_procedimento
		and	x.nr_prescricao = a.nr_prescricao
		and	c.nr_prescricao = a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	a.nr_prescricao	between nr_prescr_inicial_w	and nr_prescr_final_w
		and	a.dt_validade_prescr	between dt_inicio_plano_atual_w	and dt_fim_w
		and	w.ie_tipo <> 'G'
		and	w.ie_tipo <> 'BS'
		and	coalesce(w.ie_ivc,'N') <> 'S'
		and	w.ie_ctrl_glic = 'CCG'
		and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
		and	(x.nr_seq_prot_glic IS NOT NULL AND x.nr_seq_prot_glic::text <> '')
		and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
		and	coalesce(x.nr_seq_derivado::text, '') = ''
		and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	Consiste_regra_grafico('CCG') = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'G',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S'
		group by
			a.nr_prescricao,
			c.nr_seq_procedimento,
			c.cd_procedimento,
			z.ds_protocolo,
			x.ie_acm,
			x.ie_se_necessario,
			x.cd_intervalo,
			x.qt_procedimento,
			x.ie_suspenso,
			c.nr_seq_proc_interno,
			x.nr_seq_prot_glic,
			x.ie_origem_proced,
			a.ie_lib_farm,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			x.dt_extensao,
			x.ie_horario_susp,
			a.ie_prescr_emergencia) alias25
	
union all
	--CIG
	select	count(nr_seq_procedimento) qt_item
	from	(select	a.nr_prescricao,
			c.nr_seq_procedimento,
			c.cd_procedimento,
			z.ds_valor_dominio,
			x.ie_acm,
			x.ie_se_necessario,
			x.cd_intervalo,
			x.qt_procedimento,
			coalesce(x.ie_suspenso,'N') ie_suspenso,
			c.nr_seq_proc_interno,
			x.cd_intervalo,
			x.ie_origem_proced,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.ie_lib_farm,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			x.dt_extensao,
			x.ie_horario_susp,
			x.nr_seq_prot_glic,
			a.ie_prescr_emergencia
		from	valor_dominio_v z,
			procedimento y,
			proc_interno w,
			prescr_procedimento x,
			prescr_proc_hor c,
			prescr_medica a
		where	z.cd_dominio = 1903
		and	z.vl_dominio = w.ie_ctrl_glic
		and	y.cd_procedimento = x.cd_procedimento
		and	y.ie_origem_proced = x.ie_origem_proced
		and	y.cd_procedimento = c.cd_procedimento
		and	y.ie_origem_proced = c.ie_origem_proced
		and	w.nr_sequencia = x.nr_seq_proc_interno
		and	w.nr_sequencia = c.nr_seq_proc_interno
		and	x.nr_prescricao = c.nr_prescricao
		and	x.nr_sequencia = c.nr_seq_procedimento
		and	x.nr_prescricao = a.nr_prescricao
		and	c.nr_prescricao = a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	a.nr_prescricao	between nr_prescr_inicial_w	and nr_prescr_final_w
		and	a.dt_validade_prescr	between dt_inicio_plano_atual_w	and dt_fim_w
		and	w.ie_tipo <> 'G'
		and	w.ie_tipo <> 'BS'
		and	coalesce(w.ie_ivc,'N') <> 'S'
		and	w.ie_ctrl_glic = 'CIG'
		and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
		and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
		and	coalesce(x.nr_seq_derivado::text, '') = ''
		and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	Consiste_regra_grafico('CIG') = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'C',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S'
		group by
			a.nr_prescricao,
			c.nr_seq_procedimento,
			c.cd_procedimento,
			z.ds_valor_dominio,
			x.ie_acm,
			x.ie_se_necessario,
			x.cd_intervalo,
			x.qt_procedimento,
			x.ie_suspenso,
			c.nr_seq_proc_interno,
			x.ie_origem_proced,
			a.dt_liberacao_medico,
			a.ie_lib_farm,
			a.dt_liberacao,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			x.dt_extensao,
			x.ie_horario_susp,
			x.nr_seq_prot_glic,
			a.ie_prescr_emergencia) alias48
	
union all
	--Coletas
	select	count(cd_procedimento) qt_item
	from	(
		select	c.cd_procedimento,
			x.ie_acm,
			x.ie_se_necessario,
			z.nm_exame,
			x.cd_material_exame,
			v.ds_material_exame,
			x.ds_material_especial,
			x.cd_intervalo,
			x.qt_procedimento,
			x.ie_suspenso,
			c.nr_seq_proc_interno,
			x.ie_origem_proced,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.ie_lib_farm,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			x.dt_extensao,
			x.ie_horario_susp,
			a.ie_prescr_emergencia
		FROM exame_laboratorio z, procedimento y, prescr_proc_hor c, prescr_medica a, prescr_procedimento x
LEFT OUTER JOIN material_exame_lab v ON (x.cd_material_exame = v.cd_material_exame)
WHERE z.nr_seq_exame = x.nr_seq_exame and y.cd_procedimento = x.cd_procedimento and y.ie_origem_proced = x.ie_origem_proced and y.cd_procedimento = c.cd_procedimento and y.ie_origem_proced = c.ie_origem_proced and x.nr_prescricao = c.nr_prescricao and x.nr_sequencia = c.nr_seq_procedimento and x.nr_prescricao = a.nr_prescricao and c.nr_prescricao = a.nr_prescricao and coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0)) and a.cd_pessoa_fisica	= cd_pessoa_fisica_w and plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S' and coalesce(a.ie_recem_nato,'N')	= 'N' and a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w and a.dt_validade_prescr	between dt_inicio_plano_atual_w and dt_fim_w and coalesce(x.nr_seq_proc_interno::text, '') = '' and (x.nr_seq_exame IS NOT NULL AND x.nr_seq_exame::text <> '') and coalesce(x.nr_seq_solic_sangue::text, '') = '' and coalesce(x.nr_seq_derivado::text, '') = '' and coalesce(x.nr_seq_exame_sangue::text, '') = '' and coalesce(c.ie_situacao,'A') = 'A' and ((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950)) and Consiste_regra_grafico('L') = 'S' and coalesce(x.dt_suspensao::text, '') = '' and coalesce(a.nr_seq_atend::text, '') = '' and plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'L',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S' group by
			c.cd_procedimento,
			x.ie_acm,
			x.ie_se_necessario,
			z.nm_exame,
			x.cd_intervalo,
			x.qt_procedimento,
			v.ds_material_exame,
			x.ie_suspenso,
			c.nr_seq_proc_interno,
			x.ie_origem_proced,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.dt_liberacao_farmacia,
			a.ie_lib_farm,
			x.ie_erro,
			x.dt_extensao,
			x.ie_horario_susp,
			a.ie_prescr_emergencia,
			x.cd_material_exame,
			v.ds_material_exame,
			x.ds_material_especial
		
union all

		select	c.cd_procedimento,
			x.ie_acm,
			x.ie_se_necessario,
			z.nm_exame,
			x.cd_material_exame,
			v.ds_material_exame,
			x.ds_material_especial,
			x.cd_intervalo,
			x.qt_procedimento,
			x.ie_suspenso,
			c.nr_seq_proc_interno,
			x.ie_origem_proced,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.ie_lib_farm,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			x.dt_extensao,
			x.ie_horario_susp,
			a.ie_prescr_emergencia
		FROM exame_laboratorio z, procedimento y, proc_interno w, prescr_proc_hor c, prescr_medica a, prescr_procedimento x
LEFT OUTER JOIN material_exame_lab v ON (x.cd_material_exame = v.cd_material_exame)
WHERE z.nr_seq_exame = x.nr_seq_exame and y.cd_procedimento = x.cd_procedimento and y.ie_origem_proced = x.ie_origem_proced and y.cd_procedimento = c.cd_procedimento and y.ie_origem_proced = c.ie_origem_proced and w.nr_sequencia = x.nr_seq_proc_interno and w.nr_sequencia = c.nr_seq_proc_interno and x.nr_prescricao = c.nr_prescricao and x.nr_sequencia = c.nr_seq_procedimento and x.nr_prescricao = a.nr_prescricao and c.nr_prescricao = a.nr_prescricao and coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0)) and a.cd_pessoa_fisica	= cd_pessoa_fisica_w and plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S' and coalesce(a.ie_recem_nato,'N')	= 'N' and a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w and a.dt_validade_prescr	between dt_inicio_plano_atual_w and dt_fim_w and w.ie_tipo <> 'G' and w.ie_tipo <> 'BS' and w.ie_ivc <> 'S' and (x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '') and coalesce(x.nr_seq_prot_glic::text, '') = '' and (x.nr_seq_exame IS NOT NULL AND x.nr_seq_exame::text <> '') and coalesce(x.nr_seq_solic_sangue::text, '') = '' and coalesce(x.nr_seq_derivado::text, '') = '' and coalesce(x.nr_seq_exame_sangue::text, '') = '' and coalesce(c.ie_situacao,'A') = 'A' and ((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950)) and Consiste_regra_grafico('L') = 'S' and coalesce(x.dt_suspensao::text, '') = '' and coalesce(a.nr_seq_atend::text, '') = '' and plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'L',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S' group by
			c.cd_procedimento,
			x.ie_acm,
			x.ie_se_necessario,
			z.nm_exame,
			x.cd_intervalo,
			x.qt_procedimento,
			v.ds_material_exame,
			x.ie_suspenso,
			c.nr_seq_proc_interno,
			x.ie_origem_proced,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.ie_lib_farm,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			x.dt_extensao,
			x.ie_horario_susp,
			a.ie_prescr_emergencia,
			v.ds_material_exame,
			x.cd_material_exame,
			x.ds_material_especial) alias91
	
union all
	--Dieta Oral
	select	count(nr_sequencia) qt_item
	from	(select	to_char(d.cd_dieta) cd_dieta,
			x.nm_dieta,
			c.dt_fim_horario,
			d.dt_suspensao,
			d.cd_intervalo,
			d.nr_sequencia,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.ie_lib_farm,
			a.dt_liberacao_farmacia,
			d.dt_extensao,
			a.nr_prescricao,
			d.ie_horario_susp,
			a.ie_prescr_emergencia,
			d.QT_PARAMETRO
		from	dieta x,
			prescr_dieta d,
			prescr_dieta_hor c,
			prescr_medica a
		where	x.cd_dieta = d.cd_dieta
		and	d.nr_prescricao = c.nr_prescricao
		and	d.nr_prescricao	= a.nr_prescricao
		and	c.nr_prescricao = a.nr_prescricao
		and	c.nr_seq_dieta	= d.nr_sequencia
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	a.nr_prescricao	between nr_prescr_inicial_w	and nr_prescr_final_w
		and	a.dt_validade_prescr	between dt_inicio_plano_atual_w	and dt_fim_w
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	Consiste_regra_grafico('D') = 'S'
		and	coalesce(d.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				d.dt_suspensao,		'D',
							d.nr_sequencia,			a.nr_prescricao,	'O') = 'S'
		group by
			d.cd_dieta,
			x.nm_dieta,
			c.dt_fim_horario,
			d.dt_suspensao,
			d.cd_intervalo,
			d.nr_sequencia,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.ie_lib_farm,
			a.dt_liberacao_farmacia,
			d.dt_extensao,
			d.QT_PARAMETRO,
			a.nr_prescricao,
			d.ie_horario_susp,
			a.ie_prescr_emergencia
		
union

		select	to_char(d.cd_dieta) cd_dieta,
			x.nm_dieta,
			null dt_fim_horario,
			d.dt_suspensao,
			d.cd_intervalo,
			d.nr_sequencia,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.ie_lib_farm,
			a.dt_liberacao_farmacia,
			d.dt_extensao,
			a.nr_prescricao,
			d.ie_horario_susp,
			a.ie_prescr_emergencia,
			d.QT_PARAMETRO
		from	dieta x,
			prescr_dieta d,
			prescr_medica a
		where	x.cd_dieta = d.cd_dieta
		and	d.nr_prescricao	= a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	a.nr_prescricao	between nr_prescr_inicial_w	and nr_prescr_final_w
		and	((ie_horario_setor_w = 'S' AND a.dt_validade_prescr between dt_inicio_plano_atual_w and dt_fim_w) or
			 ((ie_horario_setor_w	= 'R') and
			  ((to_char(a.dt_rep_pt,'dd/mm/yyyy') = dt_plano_w) or (to_char(a.dt_rep_pt2,'dd/mm/yyyy') = dt_plano_w))))
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	not exists (
				select	1
				from	prescr_dieta_hor c
				where	c.nr_prescricao = d.nr_prescricao
				and	c.nr_prescricao = a.nr_prescricao
				and	d.nr_sequencia	= c.nr_seq_dieta)
		and	(coalesce(a.dt_liberacao,a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao,a.dt_liberacao_medico))::text <> '')
		and	(((ie_estendidos_w = 0) and (PLT_obter_se_estendido(d.dt_extensao,dt_fim_plano_atual_w) = 'S')) or
			 ((ie_estendidos_w = 1) and (PLT_obter_se_estendido(d.dt_extensao,dt_fim_plano_atual_w) = 'N')) or (ie_estendidos_w = 2))
		and	Consiste_regra_grafico('D') = 'S'
		and	coalesce(d.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		group by
			d.cd_dieta,
			x.nm_dieta,
			d.dt_suspensao,
			d.cd_intervalo,
			d.nr_sequencia,
			a.dt_liberacao_medico,
			a.ie_lib_farm,
			a.dt_liberacao_farmacia,
			a.dt_liberacao,
			d.QT_PARAMETRO,
			d.dt_extensao,
			a.nr_prescricao,
			d.ie_horario_susp,
			a.ie_prescr_emergencia) alias147
	
union all
	--Gasoterapia
	select	count(nr_sequencia) qt_item
	from	(
		select	x.nr_sequencia
		FROM gas y, prescr_medica a, prescr_gasoterapia x
LEFT OUTER JOIN valor_dominio_v w ON (x.ie_unidade_medida = w.vl_dominio AND 1580 = w.cd_dominio)
LEFT OUTER JOIN intervalo_prescricao z ON (x.cd_intervalo = z.cd_intervalo)
WHERE y.nr_sequencia = x.nr_seq_gas and x.nr_prescricao = a.nr_prescricao and coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0)) and a.cd_pessoa_fisica	= cd_pessoa_fisica_w and plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S' and coalesce(a.ie_recem_nato,'N')	= 'N' and a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w and a.dt_validade_prescr	between dt_inicio_plano_atual_w and dt_fim_w and ((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950)) and Consiste_regra_grafico('O') = 'S' and coalesce(x.dt_suspensao::text, '') = '' and coalesce(a.nr_seq_atend::text, '') = '' and plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		x.dt_prev_execucao,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'O',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S' ) alias163
	
union all
	--Hemoterapia
	select	count(nr_sequencia) qt_item
	from	(
		select	x.nr_sequencia
		FROM procedimento y, prescr_medica a, prescr_procedimento x
LEFT OUTER JOIN san_derivado z ON (x.nr_seq_derivado = z.nr_sequencia)
WHERE y.cd_procedimento = x.cd_procedimento and y.ie_origem_proced = x.ie_origem_proced and x.nr_prescricao = a.nr_prescricao and coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0)) and a.cd_pessoa_fisica	= cd_pessoa_fisica_w and a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w and a.dt_validade_prescr	between dt_inicio_plano_atual_w and dt_fim_w and plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S' and coalesce(x.nr_seq_proc_interno::text, '') = '' and coalesce(x.nr_seq_exame::text, '') = '' and (x.nr_seq_solic_sangue IS NOT NULL AND x.nr_seq_solic_sangue::text <> '') and coalesce(a.ie_recem_nato,'N')	= 'N' and ((x.nr_seq_derivado IS NOT NULL AND x.nr_seq_derivado::text <> '') or (Obter_se_exibe_proced(x.nr_prescricao,x.nr_sequencia,x.ie_tipo_proced,'BSST') = 'S')) and ((coalesce(x.nr_seq_exame_sangue::text, '') = '') or (Obter_se_exibe_proced(x.nr_prescricao,x.nr_sequencia,x.ie_tipo_proced,'BSST') = 'S')) and ((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950)) and Consiste_regra_grafico('HM') = 'S' and coalesce(x.dt_suspensao::text, '') = '' and coalesce(a.nr_seq_atend::text, '') = '' and plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		x.dt_status,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'HM',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S'
		
union all

		select	x.nr_sequencia
		FROM procedimento y, proc_interno w, prescr_medica a, prescr_procedimento x
LEFT OUTER JOIN san_derivado z ON (x.nr_seq_derivado = z.nr_sequencia)
WHERE y.cd_procedimento = x.cd_procedimento and y.ie_origem_proced = x.ie_origem_proced and w.nr_sequencia = x.nr_seq_proc_interno and x.nr_prescricao = a.nr_prescricao and coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0)) and a.cd_pessoa_fisica	= cd_pessoa_fisica_w and a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w and a.dt_validade_prescr	between dt_inicio_plano_atual_w and dt_fim_w and w.ie_tipo <> 'G' and coalesce(w.ie_ivc,'N') <> 'S' and coalesce(w.ie_ctrl_glic,'NC') = 'NC' and (x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '') and coalesce(x.nr_seq_prot_glic::text, '') = '' and coalesce(x.nr_seq_exame::text, '') = '' and plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S' and (x.nr_seq_solic_sangue IS NOT NULL AND x.nr_seq_solic_sangue::text <> '') and coalesce(a.ie_recem_nato,'N')	= 'N' and ((x.nr_seq_derivado IS NOT NULL AND x.nr_seq_derivado::text <> '') or (Obter_se_exibe_proced(x.nr_prescricao,x.nr_sequencia,x.ie_tipo_proced,'AT') = 'S') or (Obter_se_exibe_proced(x.nr_prescricao,x.nr_sequencia,x.ie_tipo_proced,'BSST') = 'S') or (Obter_se_exibe_proced(x.nr_prescricao,x.nr_sequencia,x.ie_tipo_proced,'BS') = 'S')) and ((coalesce(x.nr_seq_exame_sangue::text, '') = '') or (Obter_se_exibe_proced(x.nr_prescricao,x.nr_sequencia,x.ie_tipo_proced,'AT') = 'S') or (Obter_se_exibe_proced(x.nr_prescricao,x.nr_sequencia,x.ie_tipo_proced,'BSST') = 'S') or (Obter_se_exibe_proced(x.nr_prescricao,x.nr_sequencia,x.ie_tipo_proced,'BS') = 'S')) and Consiste_regra_grafico('HM') = 'S' and ((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950)) and coalesce(x.dt_suspensao::text, '') = '' and coalesce(a.nr_seq_atend::text, '') = '' and plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		x.dt_status,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'HM',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S' ) alias228
	
union all
	--IVC
	select	count(nr_seq_procedimento) qt_item
	from	(
		select	a.nr_prescricao,
			c.nr_seq_procedimento,
			c.cd_procedimento,
			w.ds_proc_exame,
			y.ds_procedimento,
			x.ie_acm,
			x.ie_se_necessario,
			x.cd_intervalo,
			x.qt_procedimento,
			x.ie_suspenso,
			c.nr_seq_proc_interno,
			x.ie_origem_proced,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.ie_lib_farm,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			x.dt_extensao,
			x.ie_horario_susp,
			a.ie_prescr_emergencia
		from	procedimento y,
			proc_interno w,
			prescr_procedimento x,
			prescr_proc_hor c,
			prescr_medica a
		where	y.cd_procedimento = x.cd_procedimento
		and	y.ie_origem_proced = x.ie_origem_proced
		and	y.cd_procedimento = c.cd_procedimento
		and	y.ie_origem_proced = c.ie_origem_proced
		and	w.nr_sequencia = x.nr_seq_proc_interno
		and	w.nr_sequencia = c.nr_seq_proc_interno
		and	x.nr_prescricao = c.nr_prescricao
		and	x.nr_sequencia = c.nr_seq_procedimento
		and	x.nr_prescricao = a.nr_prescricao
		and	c.nr_prescricao = a.nr_prescricao
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	a.nr_prescricao	between nr_prescr_inicial_w	and nr_prescr_final_w
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	a.dt_validade_prescr	between dt_inicio_plano_atual_w	and dt_fim_w
		and	w.ie_tipo <> 'G'
		and	w.ie_tipo <> 'BS'
		and	w.ie_ivc = 'S'
		and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
		and	coalesce(x.nr_seq_prot_glic::text, '') = ''
		and	coalesce(x.nr_seq_exame::text, '') = ''
		and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
		and	coalesce(x.nr_seq_derivado::text, '') = ''
		and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	Consiste_regra_grafico('I') = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'I',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S'
		group by
			a.nr_prescricao,
			c.nr_seq_procedimento,
			c.cd_procedimento,
			w.ds_proc_exame,
			y.ds_procedimento,
			x.ie_acm,
			x.ie_se_necessario,
			x.cd_intervalo,
			x.qt_procedimento,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.ie_lib_farm,
			x.ie_suspenso,
			c.nr_seq_proc_interno,
			x.ie_origem_proced,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			x.dt_extensao,
			x.ie_horario_susp,
			a.ie_prescr_emergencia) alias251
	
union all
	--Jejum
	select	count(nr_sequencia) qt_item
	from	(
		select	c.nr_sequencia
		from	rep_tipo_jejum x,
			rep_jejum c,
			prescr_medica a
		where	x.nr_sequencia = c.nr_seq_tipo
		and	c.nr_prescricao = a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	a.nr_prescricao	between nr_prescr_inicial_w	and nr_prescr_final_w
		and	((c.dt_inicio between dt_inicio_plano_atual_w and dt_fim_plano_atual_w) or (c.dt_fim between dt_inicio_plano_atual_w and dt_fim_plano_atual_w))
		and	(coalesce(a.dt_liberacao_medico,a.dt_liberacao) IS NOT NULL AND (coalesce(a.dt_liberacao_medico,a.dt_liberacao))::text <> '')
		and	(((ie_estendidos_w = 0) and (PLT_obter_se_estendido(c.dt_extensao,dt_fim_plano_atual_w) = 'S')) or
			 ((ie_estendidos_w = 1) and (PLT_obter_se_estendido(c.dt_extensao,dt_fim_plano_atual_w) = 'N')) or (ie_estendidos_w = 2))
		and	Consiste_regra_grafico('J') = 'S'
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	coalesce(c.ie_suspenso,'N') <> 'S') alias283
	
union all
	--Material
	select	count(cd_material) qt_item
	from	(
		select	CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  a.nr_prescricao  ELSE null END   ELSE null END  nr_prescricao,
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  c.nr_seq_material  ELSE null END   ELSE null END  nr_seq_material,
			c.cd_material,
			y.ds_material,
			x.cd_intervalo,
			x.qt_dose,
			substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,c.nr_seq_material,x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
			coalesce(x.ie_suspenso,'N') ie_suspenso,
			x.cd_unidade_medida_dose,
			x.ie_via_aplicacao,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.ie_lib_farm,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			x.dt_extensao,
			x.hr_prim_horario,
			substr(PLT_obter_se_plano_atual(a.nr_prescricao),1,1) ie_plano_atual,
			x.ie_horario_susp,
			a.ie_prescr_emergencia
		from	material y,
			prescr_material x,
			prescr_mat_hor c,
			prescr_medica a
		where	y.cd_material = x.cd_material
		and	x.nr_prescricao = c.nr_prescricao
		and	x.nr_sequencia = c.nr_seq_material
		and	x.nr_prescricao = a.nr_prescricao
		and	c.nr_prescricao	= a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	a.nr_prescricao	between nr_prescr_inicial_w	and nr_prescr_final_w
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	a.dt_validade_prescr	between dt_inicio_plano_atual_w	and dt_fim_w
		and	x.ie_agrupador = 2
		and	coalesce(x.nr_seq_kit::text, '') = ''
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	x.ie_origem_inf	<> 'K'
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	c.ie_agrupador = 2
		and	Consiste_regra_grafico('MAT') = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'MAT',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S'
		group by
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  a.nr_prescricao  ELSE null END   ELSE null END ,
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  c.nr_seq_material  ELSE null END   ELSE null END ,
			c.cd_material,
			y.ds_material,
			adep_obter_um_dosagem_prescr(a.nr_prescricao,c.nr_seq_material,x.ie_acm,x.ie_se_necessario),
			x.cd_intervalo,
			x.qt_dose,
			PLT_obter_se_plano_atual(a.nr_prescricao),
			coalesce(x.ie_suspenso,'N'),
			x.cd_unidade_medida_dose,
			x.ie_via_aplicacao,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.dt_liberacao_farmacia,
			a.ie_lib_farm,
			x.ie_erro,
			x.dt_extensao,
			x.hr_prim_horario,
			x.ie_horario_susp,
			a.ie_prescr_emergencia) alias317
	
union all
	--Medicamento
	select	count(cd_material) qt_item
	from	(
		select	CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  a.nr_prescricao  ELSE null END   ELSE null END  nr_prescricao,
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  c.nr_seq_material  ELSE null END   ELSE null END  nr_seq_material,
			c.cd_material,
			y.ds_material,
			obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
			x.cd_intervalo,
			CASE WHEN coalesce(x.ds_dose_diferenciada::text, '') = '' THEN x.qt_dose  ELSE coalesce(c.qt_dose,x.qt_dose) END  qt_dose,
			CASE WHEN obter_se_agrupa_composto(a.nr_prescricao,c.nr_seq_material,x.nr_agrupamento,c.cd_material)='S' THEN x.nr_agrupamento  ELSE 0 END  nr_agrupamento,
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN substr(adep_obter_inf_dil_obs(a.nr_prescricao,c.nr_seq_material),1,2000)  ELSE null END  ds_dil_obs,
			coalesce(x.ie_suspenso,'N') ie_suspenso,
			x.cd_unidade_medida_dose,
			x.ie_via_aplicacao,
			CASE WHEN coalesce(x.dt_suspensao::text, '') = '' THEN  substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1) END  ie_lib_pend_rep,
			plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia) ie_liberado,
			x.ie_erro,
			a.ie_prescr_emergencia,
			x.dt_extensao,
			x.hr_prim_horario,
			x.ie_administrar,
			x.ds_dose_diferenciada,
			substr(coalesce(obter_se_medic_composto(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento),'N'),1,1) ie_composto,
			substr(plt_obter_compostos(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento,'M'),1,255) ds_composto,
			a.ie_prescr_emergencia
		from	material y,
			prescr_material x,
			prescr_mat_hor c,
			prescr_medica a
		where	y.cd_material = x.cd_material
		and	x.nr_prescricao = c.nr_prescricao
		and	x.nr_sequencia = c.nr_seq_material
		and	x.nr_prescricao = a.nr_prescricao
		and	c.nr_prescricao = a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w
		and	a.dt_validade_prescr	between dt_inicio_plano_atual_w and dt_fim_w
		and	x.ie_agrupador = 1
		and	coalesce(a.nr_seq_agenda::text, '') = ''
		and	x.ie_origem_inf <> 'K'
		and	coalesce(x.nr_seq_kit::text, '') = ''
		and	coalesce(x.nr_sequencia_diluicao::text, '') = ''
		and	coalesce(x.nr_sequencia_solucao::text, '') = ''
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	c.ie_agrupador = 1
		and	obter_se_gerar_item_plt('M',x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento, x.ie_item_superior, x.nr_seq_kit) = 'S'
		and	Consiste_regra_grafico('M') = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'M',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S'
		group by
			a.nr_prescricao,
			c.nr_seq_material,
			c.cd_material,
			y.ds_material,
			x.ie_acm,
			x.ie_se_necessario,
			x.cd_intervalo,
			CASE WHEN coalesce(x.ds_dose_diferenciada::text, '') = '' THEN x.qt_dose  ELSE coalesce(c.qt_dose,x.qt_dose) END ,
			x.nr_agrupamento,
			x.ie_suspenso,
			x.cd_unidade_medida_dose,
			CASE WHEN coalesce(x.dt_suspensao::text, '') = '' THEN  substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1) END ,
			x.ie_via_aplicacao,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			a.ie_prescr_emergencia,
			x.dt_extensao,
			x.hr_prim_horario,
			x.ie_administrar,
			x.ds_dose_diferenciada,
			obter_se_medic_composto(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento),
			plt_obter_compostos(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento,'M'),
			a.ie_prescr_emergencia
		
union all

		select	a.nr_prescricao,
			x.nr_sequencia nr_seq_material,
			x.cd_material,
			y.ds_material,
			obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
			x.cd_intervalo,
			x.qt_dose,
			CASE WHEN obter_se_agrupa_composto(a.nr_prescricao,x.nr_sequencia,x.nr_agrupamento,x.cd_material)='S' THEN x.nr_agrupamento  ELSE 0 END  nr_agrupamento,
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN substr(adep_obter_inf_dil_obs(a.nr_prescricao,x.nr_sequencia),1,2000)  ELSE null END  ds_dil_obs,
			coalesce(x.ie_suspenso,'N') ie_suspenso,
			x.cd_unidade_medida_dose,
			x.ie_via_aplicacao,
			CASE WHEN coalesce(x.dt_suspensao::text, '') = '' THEN  substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1) END  ie_lib_pend_rep,
			plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia) ie_liberado,
			x.ie_erro,
			coalesce(a.ie_prescr_emergencia,'N') ie_prescr_emergencia,
			x.dt_extensao,
			x.hr_prim_horario,
			x.ie_administrar,
			x.ds_dose_diferenciada,
			substr(coalesce(obter_se_medic_composto(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento),'N'),1,1) ie_composto,
			substr(plt_obter_compostos(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento,'M'),1,255) ds_composto,
			a.ie_prescr_emergencia
		from	material y,
			prescr_material x,
			prescr_medica a
		where	y.cd_material = x.cd_material
		and	x.nr_prescricao = a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w
		and	a.dt_validade_prescr between dt_inicio_plano_atual_w and dt_fim_w
		and	x.ie_agrupador = 1
		and	x.ie_origem_inf <> 'K'
		and	coalesce(x.nr_seq_kit::text, '') = ''
		and	coalesce(a.nr_seq_agenda::text, '') = ''
		and	coalesce(x.nr_sequencia_diluicao::text, '') = ''
		and	coalesce(x.nr_sequencia_solucao::text, '') = ''
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	x.ie_agrupador = 1
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicio_plano_atual_w,dt_fim_plano_atual_w) = 'S'
		and	(coalesce(a.dt_liberacao,a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao,a.dt_liberacao_medico))::text <> '')
		and	(((ie_estendidos_w = 0) and (PLT_obter_se_estendido(x.dt_extensao,dt_fim_plano_atual_w) = 'S')) or
			 ((ie_estendidos_w = 1) and (PLT_obter_se_estendido(x.dt_extensao,dt_fim_plano_atual_w) = 'N')) or (ie_estendidos_w = 2))
		and	not exists (	select	1
					from	prescr_mat_hor c
					where	c.nr_prescricao = x.nr_prescricao
					and	c.nr_seq_material = x.nr_sequencia
					and	c.cd_material = x.cd_material)
		and	coalesce(x.ie_administrar,'S')	= 'N'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	Consiste_regra_grafico('M') = 'S'
		and	obter_se_gerar_item_plt('M',x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento, x.ie_item_superior, x.nr_seq_kit) = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		group by
			a.nr_prescricao,
			x.nr_sequencia,
			x.cd_material,
			y.ds_material,
			x.ie_acm,
			x.ie_se_necessario,
			x.cd_intervalo,
			x.qt_dose,
			CASE WHEN coalesce(x.dt_suspensao::text, '') = '' THEN  substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1) END ,
			x.nr_agrupamento,
			x.ie_suspenso,
			x.cd_unidade_medida_dose,
			x.ie_via_aplicacao,
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			a.ie_prescr_emergencia,
			x.dt_extensao,
			x.hr_prim_horario,
			x.ie_administrar,
			x.ds_dose_diferenciada,
			obter_se_medic_composto(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento),
			plt_obter_compostos(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento,'M'),
			a.ie_prescr_emergencia) alias428
	
union all
	--NPT Adulta
	select	count(nr_sequencia) qt_item
	from	(
		select	x.nr_sequencia
		FROM prescr_medica a, nut_pac x
LEFT OUTER JOIN protocolo_npt y ON (x.nr_seq_protocolo = y.nr_sequencia)
WHERE x.nr_prescricao = a.nr_prescricao and coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0)) and a.cd_pessoa_fisica	= cd_pessoa_fisica_w and coalesce(a.ie_recem_nato,'N')	= 'N' and plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S' and a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w and a.dt_validade_prescr	between dt_inicio_plano_atual_w and dt_fim_w and x.ie_npt_adulta = 'S' and ((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950)) and Consiste_regra_grafico('NAN') = 'S' and coalesce(x.dt_suspensao::text, '') = '' and coalesce(a.nr_seq_atend::text, '') = '' and plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		x.dt_status,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'NAN',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S' ) alias444
	
union all
	--NPT Neonatal
	select	count(nr_sequencia) qt_item
	from	(
		select	x.nr_sequencia
		from	nut_pac x,
			prescr_medica a
		where	x.nr_prescricao = a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	a.nr_prescricao	between nr_prescr_inicial_w	and nr_prescr_final_w
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	a.dt_validade_prescr	between dt_inicio_plano_atual_w	and dt_fim_w
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	x.ie_npt_adulta <> 'S'
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	Consiste_regra_grafico('NPN') = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		x.dt_status,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'NPN',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S') alias460
	
union all
	--Procedimento
	select	count(cd_procedimento) qt_item
	from	(
		select	CASE WHEN obter_se_agrupar_proced_adep(a.nr_prescricao,c.nr_seq_procedimento,obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),ie_agrupar_acm_sn_w,obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),'S')='N' THEN a.nr_prescricao  ELSE null END  nr_prescricao,
			CASE WHEN obter_se_agrupar_proced_adep(a.nr_prescricao,c.nr_seq_procedimento,obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),ie_agrupar_acm_sn_w,obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),'S')='N' THEN CASE WHEN obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento)='N' THEN c.nr_seq_procedimento||a.nr_prescricao  ELSE c.nr_seq_procedimento END   ELSE null END  nr_seq_procedimento,
			c.cd_procedimento,
			y.ds_procedimento,
			obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
			x.cd_intervalo,
			x.qt_procedimento,
			substr(adep_obter_dados_prescr_proc(a.nr_prescricao,c.nr_seq_procedimento,'QIL','S',x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
			coalesce(x.ie_suspenso,'N') ie_suspenso,
			substr(obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),1,1) ie_associados,
			c.nr_seq_proc_interno,
			x.ie_origem_proced,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1) ie_lib_pend_rep,
			plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia) ie_liberado,
			x.ie_erro,
			x.dt_extensao,
			substr(PLT_obter_se_plano_atual(a.nr_prescricao),1,1) ie_plano_atual,
			a.ie_prescr_emergencia
		from	procedimento y,
			prescr_procedimento x,
			prescr_proc_hor c,
			prescr_medica a
		where	y.cd_procedimento = x.cd_procedimento
		and	y.ie_origem_proced = x.ie_origem_proced
		and	y.cd_procedimento = c.cd_procedimento
		and	y.ie_origem_proced = c.ie_origem_proced
		and	x.nr_prescricao = c.nr_prescricao
		and	x.nr_sequencia = c.nr_seq_procedimento
		and	x.nr_prescricao = a.nr_prescricao
		and	c.nr_prescricao = a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w
		and	a.dt_validade_prescr	between dt_inicio_plano_atual_w and dt_fim_w
		and	coalesce(a.nr_seq_agenda::text, '') = ''
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	((ie_todos_proc_w = 'S') or (coalesce(x.nr_seq_proc_princ::text, '') = ''))
		and	coalesce(x.nr_seq_proc_interno::text, '') = ''
		and	coalesce(x.nr_seq_exame::text, '') = ''
		and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
		and	coalesce(x.nr_seq_derivado::text, '') = ''
		and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
		and	coalesce(x.ie_plano,'S') = 'S'
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	Consiste_regra_grafico('P') = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'P',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S'
		group by
			CASE WHEN obter_se_agrupar_proced_adep(a.nr_prescricao,c.nr_seq_procedimento,obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),ie_agrupar_acm_sn_w,obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),'S')='N' THEN a.nr_prescricao  ELSE null END ,
			CASE WHEN obter_se_agrupar_proced_adep(a.nr_prescricao,c.nr_seq_procedimento,obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),ie_agrupar_acm_sn_w,obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),'S')='N' THEN CASE WHEN obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento)='N' THEN c.nr_seq_procedimento||a.nr_prescricao  ELSE c.nr_seq_procedimento END   ELSE null END ,
			c.cd_procedimento,
			y.ds_procedimento,
			obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),
			x.cd_intervalo,
			x.qt_procedimento,
			substr(adep_obter_dados_prescr_proc(a.nr_prescricao,c.nr_seq_procedimento,'QIL','S',x.ie_acm,x.ie_se_necessario),1,100),
			coalesce(x.ie_suspenso,'N'),
			substr(obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),1,1),
			c.nr_seq_proc_interno,
			x.ie_origem_proced,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1),
			plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia),
			x.ie_erro,
			x.dt_extensao,
			substr(PLT_obter_se_plano_atual(a.nr_prescricao),1,1),
			a.ie_prescr_emergencia
		
union all

		select	CASE WHEN obter_se_agrupar_proced_adep(a.nr_prescricao,c.nr_seq_procedimento,obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),ie_agrupar_acm_sn_w,obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),'S')='N' THEN a.nr_prescricao  ELSE null END  nr_prescricao,
			CASE WHEN obter_se_agrupar_proced_adep(a.nr_prescricao,c.nr_seq_procedimento,obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),ie_agrupar_acm_sn_w,obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),'S')='N' THEN CASE WHEN obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento)='N' THEN c.nr_seq_procedimento||a.nr_prescricao  ELSE c.nr_seq_procedimento END   ELSE null END  nr_seq_procedimento,
			c.cd_procedimento,
			coalesce(w.ds_proc_exame,y.ds_procedimento) ds_procedimento,
			obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
			x.cd_intervalo,
			x.qt_procedimento,
			substr(adep_obter_dados_prescr_proc(a.nr_prescricao,c.nr_seq_procedimento,'QIL','S',x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
			coalesce(x.ie_suspenso,'N') ie_suspenso,
			substr(obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),1,1) ie_associados,
			c.nr_seq_proc_interno,
			x.ie_origem_proced,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1) ie_lib_pend_rep,
			plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia) ie_liberado,
			x.ie_erro,
			x.dt_extensao,
			substr(PLT_obter_se_plano_atual(a.nr_prescricao),1,1) ie_plano_atual,
			a.ie_prescr_emergencia
		from	procedimento y,
			proc_interno w,
			prescr_procedimento x,
			prescr_proc_hor c,
			prescr_medica a
		where	y.cd_procedimento = x.cd_procedimento
		and	y.ie_origem_proced = x.ie_origem_proced
		and	y.cd_procedimento = c.cd_procedimento
		and	y.ie_origem_proced = c.ie_origem_proced
		and	w.nr_sequencia = x.nr_seq_proc_interno
		and	w.nr_sequencia = c.nr_seq_proc_interno
		and	x.nr_prescricao = c.nr_prescricao
		and	x.nr_sequencia = c.nr_seq_procedimento
		and	((ie_todos_proc_w = 'S') or (coalesce(x.nr_seq_proc_princ::text, '') = ''))
		and	x.nr_prescricao = a.nr_prescricao
		and	c.nr_prescricao = a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w
		and	a.dt_validade_prescr	between dt_inicio_plano_atual_w and dt_fim_w
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	coalesce(a.nr_seq_agenda::text, '') = ''
		and	coalesce(x.ie_plano,'S') = 'S'
		and	w.ie_tipo <> 'G'
		and	w.ie_tipo <> 'BS'
		and	coalesce(w.ie_ivc,'N') <> 'S'
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	coalesce(w.ie_ctrl_glic,'NC') = 'NC'
		and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
		and	coalesce(x.nr_seq_prot_glic::text, '') = ''
		and	coalesce(x.nr_seq_exame::text, '') = ''
		and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
		and	coalesce(x.nr_seq_derivado::text, '') = ''
		and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	Consiste_regra_grafico('P') = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'P',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S'
		group by
			CASE WHEN obter_se_agrupar_proced_adep(a.nr_prescricao,c.nr_seq_procedimento,obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),ie_agrupar_acm_sn_w,obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),'S')='N' THEN a.nr_prescricao  ELSE null END ,
			CASE WHEN obter_se_agrupar_proced_adep(a.nr_prescricao,c.nr_seq_procedimento,obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),ie_agrupar_acm_sn_w,obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),'S')='N' THEN CASE WHEN obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento)='N' THEN c.nr_seq_procedimento||a.nr_prescricao  ELSE c.nr_seq_procedimento END   ELSE null END ,
			c.cd_procedimento,
			coalesce(w.ds_proc_exame,y.ds_procedimento),
			obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),
			x.cd_intervalo,
			x.qt_procedimento,
			substr(adep_obter_dados_prescr_proc(a.nr_prescricao,c.nr_seq_procedimento,'QIL','S',x.ie_acm,x.ie_se_necessario),1,100),
			coalesce(x.ie_suspenso,'N'),
			substr(obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),1,1),
			c.nr_seq_proc_interno,
			x.ie_origem_proced,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1),
			plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia),
			x.ie_erro,
			x.dt_extensao,
			substr(PLT_obter_se_plano_atual(a.nr_prescricao),1,1),
			a.ie_prescr_emergencia) alias595
	
union all
	--Recomendao
	select	count(ie_retrogrado) qt_item
	from	(
		select	CASE WHEN obter_se_acm_sn(x.ie_acm, x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_recomendacao,ie_agrupar_acm_sn_w)='N' THEN  a.nr_prescricao  ELSE null END   ELSE null END  nr_prescricao,
			CASE WHEN obter_se_acm_sn(x.ie_acm, x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_recomendacao,ie_agrupar_acm_sn_w)='N' THEN  c.nr_seq_recomendacao  ELSE null END   ELSE null END  nr_seq_recomendacao,
			substr(coalesce(to_char(x.cd_recomendacao),x.ds_recomendacao),1,255) cd_recomendacao,
			substr(coalesce(y.ds_tipo_recomendacao,x.ds_recomendacao),1,4000) ds_recomendacao,
			obter_se_acm_sn(x.ie_acm, x.ie_se_necessario) ie_acm_sn,
			x.cd_intervalo,
			x.qt_recomendacao,
			w.ds_prescricao ds_prescricao,
			coalesce(x.ie_suspenso,'N') ie_suspenso,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1) ie_lib_pend_rep,
			x.dt_extensao,
			x.hr_prim_horario,
			substr(PLT_obter_se_plano_atual(a.nr_prescricao),1,1) ie_plano_atual,
			substr(x.ds_recomendacao,1,2000) ds_hint,
			coalesce(a.ie_prescr_emergencia,'N') ie_retrogrado
		FROM prescr_rec_hor c, prescr_medica a, prescr_recomendacao x
LEFT OUTER JOIN intervalo_prescricao w ON (x.cd_intervalo = w.cd_intervalo)
LEFT OUTER JOIN tipo_recomendacao y ON (x.cd_recomendacao = y.cd_tipo_recomendacao)
WHERE x.nr_prescricao = c.nr_prescricao and x.nr_sequencia = c.nr_seq_recomendacao and x.nr_prescricao = a.nr_prescricao and c.nr_prescricao = a.nr_prescricao and coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0)) and a.cd_pessoa_fisica	= cd_pessoa_fisica_w and plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S' and coalesce(a.ie_recem_nato,'N')	= 'N' and a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w and a.dt_validade_prescr	between dt_inicio_plano_atual_w and dt_fim_w and coalesce(c.ie_situacao,'A') = 'A' and ((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950)) and Consiste_regra_grafico('R') = 'S' and coalesce(x.dt_suspensao::text, '') = '' and coalesce(a.nr_seq_atend::text, '') = '' and plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'R',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S' group by
			a.nr_prescricao,
			c.nr_seq_recomendacao,
			x.cd_recomendacao,
			x.ds_recomendacao,
			y.ds_tipo_recomendacao,
			x.ds_horarios,
			x.cd_intervalo,
			x.qt_recomendacao,
			w.ds_prescricao,
			x.ie_suspenso,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1),
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.dt_liberacao_farmacia,
			x.dt_extensao,
			substr(x.ds_recomendacao,1,2000),
			x.hr_prim_horario,
			x.ie_se_necessario,
			x.ie_acm,
			a.ie_prescr_emergencia) alias634
	
union all
	--SNE
	select	count(nr_seq_material) qt_item
	from	(
		select	a.nr_prescricao nr_prescricao,
			x.nr_sequencia nr_seq_material,
			x.cd_material,
			y.ds_material,
			obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
			x.cd_intervalo,
			x.QT_VEL_INFUSAO,
			substr(plt_obter_status_solucao(2,a.nr_prescricao,x.nr_sequencia),1,3) ie_status_solucao,
			coalesce(x.ie_suspenso,'N') ie_suspenso,
			x.cd_unidade_medida_dose,
			x.ie_via_aplicacao,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1) ie_lib_pend_rep,
			plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia) ie_liberado,
			CASE WHEN plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia)='N' THEN x.ie_erro  ELSE null END  ie_erro,
			x.dt_extensao,
			x.hr_prim_horario,
			substr(PLT_obter_se_plano_atual(a.nr_prescricao),1,1) ie_plano_atual,
			coalesce(a.ie_prescr_emergencia,'N') ie_retrogrado
		FROM material y, prescr_medica a, prescr_material x
LEFT OUTER JOIN prescr_mat_hor h ON (x.nr_prescricao = h.nr_prescricao AND x.nr_sequencia = h.nr_seq_material)
WHERE y.cd_material = x.cd_material and x.nr_prescricao = a.nr_prescricao   and coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0)) and a.cd_pessoa_fisica	= cd_pessoa_fisica_w and coalesce(a.ie_recem_nato,'N')	= 'N' and a.nr_prescricao	between nr_prescr_inicial_w and nr_prescr_final_w and a.dt_validade_prescr	between dt_inicio_plano_atual_w and dt_fim_w and plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S' and x.ie_agrupador = 8 and ((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950)) and Consiste_regra_grafico('SNE') = 'S' and coalesce(x.dt_suspensao::text, '') = '' and coalesce(a.nr_seq_atend::text, '') = '' and plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		h.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'SNE',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S' group by
			a.nr_prescricao,
			x.nr_sequencia,
			x.cd_material,
			y.ds_material,
			x.ie_acm,
			x.ie_se_necessario,
			x.cd_intervalo,
			x.QT_VEL_INFUSAO,
			x.ie_suspenso,
			x.cd_unidade_medida_dose,
			x.ie_via_aplicacao,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1),
			a.dt_liberacao_medico,
			a.dt_liberacao,
			a.dt_liberacao_farmacia,
			x.ie_erro,
			x.dt_extensao,
			x.hr_prim_horario,
			a.ie_prescr_emergencia) alias665
	
union all
	--Soluo
	select	count(nr_seq_solucao) qt_item
	from	(
		select	x.nr_seq_solucao
		from	prescr_solucao x,
			prescr_medica a
		where	x.nr_prescricao = a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	a.nr_prescricao	between nr_prescr_inicial_sol_w and nr_prescr_final_sol_w
		and	coalesce(x.nr_seq_dialise::text, '') = ''
		and	coalesce(x.ie_hemodialise, 'N') = 'N'
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	((obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicio_plano_atual_w,dt_fim_plano_atual_w) = 'S') or
			 ((x.ie_urgencia = 'S') and (exists (	select	1
					from	prescr_mat_hor b
					where	b.nr_prescricao = x.nr_prescricao
					and	b.nr_seq_solucao = x.nr_seq_solucao
					and	b.dt_horario between dt_inicio_plano_atual_w and dt_fim_plano_atual_w))))
		and	Consiste_regra_grafico('SOL') = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	plt_obter_se_item_periodo(	null,				null,			ie_horario_setor_w,		dt_plano_w,		null,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'SOL',
							x.nr_seq_solucao,		a.nr_prescricao,	'O') = 'S') alias690
	
union all
	--Suplemento oral
	select	count(cd_material) qt_item
	from	(
		select	CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  a.nr_prescricao  ELSE null END   ELSE null END  nr_prescricao,
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  c.nr_seq_material  ELSE null END   ELSE null END  nr_seq_material,
			c.cd_material,
			y.ds_material,
			obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
			x.cd_intervalo,
			x.qt_dose,
			substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,c.nr_seq_material,x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
			coalesce(x.ie_suspenso,'N') ie_suspenso,
			x.cd_unidade_medida_dose,
			x.ie_via_aplicacao,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1) ie_lib_pend_rep,
			plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia) ie_liberado,
			CASE WHEN plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia)='N' THEN x.ie_erro  ELSE null END  ie_erro,
			x.dt_extensao,
			x.hr_prim_horario,
			substr(PLT_obter_se_plano_atual(a.nr_prescricao),1,1) ie_plano_atual,
			coalesce(a.ie_prescr_emergencia,'N') ie_retrogrado
		from	material y,
			prescr_material x,
			prescr_mat_hor c,
			prescr_medica a
		where	y.cd_material = x.cd_material
		and	y.cd_material = c.cd_material
		and	x.nr_prescricao = c.nr_prescricao
		and	x.nr_sequencia = c.nr_seq_material
		and	x.nr_prescricao = a.nr_prescricao
		and	c.nr_prescricao = a.nr_prescricao
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	a.nr_prescricao	between nr_prescr_inicial_w	and nr_prescr_final_w
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	a.dt_validade_prescr	between dt_inicio_plano_atual_w	and dt_fim_w
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	x.ie_agrupador = 12
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	c.ie_agrupador = 12
		and	Consiste_regra_grafico('S') = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and	plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'S',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S'
		group by
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  a.nr_prescricao  ELSE null END   ELSE null END ,
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,c.nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  c.nr_seq_material  ELSE null END   ELSE null END ,
			c.cd_material,
			y.ds_material,
			obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),
			x.cd_intervalo,
			x.qt_dose,
			substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,c.nr_seq_material,x.ie_acm,x.ie_se_necessario),1,100),
			coalesce(x.ie_suspenso,'N'),
			x.cd_unidade_medida_dose,
			x.ie_via_aplicacao,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1),
			plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia),
			CASE WHEN plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia)='N' THEN x.ie_erro  ELSE null END ,
			x.dt_extensao,
			x.hr_prim_horario,
			substr(PLT_obter_se_plano_atual(a.nr_prescricao),1,1),
			coalesce(a.ie_prescr_emergencia,'N')) alias739
	
union all
	--Leite
	select	count(cd_material) qt_item
	from	(
		select	CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,x.nr_sequencia,ie_agrupar_acm_sn_w)='N' THEN  a.nr_prescricao  ELSE null END   ELSE null END  nr_prescricao,
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,x.nr_sequencia,ie_agrupar_acm_sn_w)='N' THEN  c.nr_seq_material  ELSE null END   ELSE null END  nr_seq_material,
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,x.nr_sequencia,ie_agrupar_acm_sn_w)='N' THEN  b.nr_sequencia  ELSE null END   ELSE null END  nr_Seq_leite_deriv,
			c.cd_material,
			coalesce(d.nm_produto,y.ds_material) ds_material,
			obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
			x.cd_intervalo,
			x.qt_dose,
			substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,c.nr_seq_material,x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
			coalesce(x.ie_suspenso,'N') ie_suspenso,
			x.cd_unidade_medida_dose,
			b.ie_via_aplicacao,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1) ie_lib_pend_rep,
			plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia) ie_liberado,
			CASE WHEN plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia)='N' THEN x.ie_erro  ELSE null END  ie_erro,
			x.dt_extensao,
			coalesce(a.ie_prescr_emergencia,'N') ie_prescr_emergencia,
			x.hr_prim_horario,
			substr(PLT_obter_se_plano_atual(a.nr_prescricao),1,1) ie_plano_atual,
			'Disp.: ' || substr(Obter_desc_disp_succao(b.nr_seq_disp_succao),1,40) || obter_desc_expressao(741003)/*' Volume total: '*/||b.qt_volume_total||' ml'||CASE WHEN b.ie_via_aplicacao='O' THEN obter_desc_expressao(557420)/*' (Via oral)'*/ WHEN b.ie_via_aplicacao='S' THEN obter_desc_expressao(630262)/*' (Via sonda)'*/  ELSE /*', sendo '||b.qt_volume_oral||' ml via oral e '||b.qt_volume_sonda||' ml via sonda'*/ obter_desc_expressao(781897, 'QT_VOLUME_ORAL='|| b.qt_volume_oral ||';QT_VOLUME_SONDA=' || b.qt_volume_sonda) END  ds_hint,
			substr(coalesce(obter_se_leite_composto(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento),'N'),1,1) ie_composto,
			substr(plt_obter_compostos(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento,'LD'),1,255) ds_composto,
			coalesce(a.ie_prescr_emergencia,'N') ie_retrogrado
		from	nutricao_leite_deriv d,
			material y,
			prescr_leite_deriv b,
			prescr_material x,
			prescr_mat_hor c,
			prescr_medica a
		where	y.cd_material = d.cd_material
		and	y.cd_material = x.cd_material
		and	y.cd_material = c.cd_material
		and	x.nr_prescricao = c.nr_prescricao
		and	x.nr_sequencia = c.nr_seq_material
		and	x.nr_prescricao = a.nr_prescricao
		and	c.nr_prescricao = a.nr_prescricao
		and	b.nr_sequencia	= x.nr_seq_leite_deriv
		and	b.nr_prescricao	= x.nr_prescricao
		and	d.ie_se_necessario = x.ie_se_necessario
		and	coalesce(a.nr_atendimento,0) = coalesce(nr_atendimento_p,coalesce(a.nr_atendimento,0))
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	coalesce(a.ie_recem_nato,'N')	= 'N'
		and	plt_obter_se_mostra_REP(a.ie_motivo_prescricao) = 'S'
		and	a.nr_prescricao	between nr_prescr_inicial_w	and nr_prescr_final_w
		and	a.dt_validade_prescr	between dt_inicio_plano_atual_w	and dt_fim_w
		and	((coalesce(a.ie_adep,'S') = 'S') or (coalesce(a.cd_funcao_origem,0) = 950))
		and	x.ie_agrupador = 16
		and	coalesce(c.ie_situacao,'A') = 'A'
		and	c.ie_agrupador = 16
		and	Consiste_regra_grafico('LD') = 'S'
		and	coalesce(x.dt_suspensao::text, '') = ''
		and	coalesce(a.nr_seq_atend::text, '') = ''
		and coalesce(d.ie_situacao,'A') = 'A'
		and	plt_obter_se_item_periodo(	dt_inicio_plano_atual_w,	dt_fim_w,		ie_horario_setor_w,		dt_plano_w,		c.dt_horario,
							dt_inicio_plano_atual_w,	dt_fim_plano_atual_w,	'N',				nm_usuario_p,		ie_estendidos_w,
							dt_fim_plano_atual_w,		'N',			'N',				x.dt_suspensao,		'LD',
							x.nr_sequencia,			a.nr_prescricao,	'O') = 'S'
		group by
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,x.nr_sequencia,ie_agrupar_acm_sn_w)='N' THEN  a.nr_prescricao  ELSE null END   ELSE null END ,
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,x.nr_sequencia,ie_agrupar_acm_sn_w)='N' THEN  c.nr_seq_material  ELSE null END   ELSE null END ,
			CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao,x.nr_sequencia,ie_agrupar_acm_sn_w)='N' THEN  b.nr_sequencia  ELSE null END   ELSE null END ,
			c.cd_material,
			coalesce(d.nm_produto,y.ds_material),
			obter_se_acm_sn(x.ie_acm,x.ie_se_necessario),
			x.cd_intervalo,
			x.qt_dose,
			substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,c.nr_seq_material,x.ie_acm,x.ie_se_necessario),1,100),
			coalesce(x.ie_suspenso,'N'),
			x.cd_unidade_medida_dose,
			b.ie_via_aplicacao,
			substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,CASE WHEN a.ie_lib_farm='S' THEN a.dt_liberacao_farmacia  ELSE clock_timestamp() END ),1,1),
			plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia),
			CASE WHEN plt_obter_se_liberado(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia)='N' THEN x.ie_erro  ELSE null END ,
			x.dt_extensao,
			coalesce(a.ie_prescr_emergencia,'N'),
			x.hr_prim_horario,
			substr(PLT_obter_se_plano_atual(a.nr_prescricao),1,1),
			'Disp.: ' || substr(Obter_desc_disp_succao(b.nr_seq_disp_succao),1,40) || obter_desc_expressao(741003)/*' Volume total: '*/||b.qt_volume_total||' ml'||CASE WHEN b.ie_via_aplicacao='O' THEN obter_desc_expressao(557420)/*' (Via oral)'*/ WHEN b.ie_via_aplicacao='S' THEN obter_desc_expressao(630262)/*' (Via sonda)'*/  ELSE /*', sendo '||b.qt_volume_oral||' ml via oral e '||b.qt_volume_sonda||' ml via sonda'*/ obter_desc_expressao(781897, 'QT_VOLUME_ORAL='|| b.qt_volume_oral ||';QT_VOLUME_SONDA=' || b.qt_volume_sonda) END ,
			substr(coalesce(obter_se_leite_composto(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento),'N'),1,1),
			substr(plt_obter_compostos(x.nr_prescricao, x.nr_sequencia, x.nr_agrupamento,'LD'),1,255),
			coalesce(a.ie_prescr_emergencia,'N')) alias819
	) alias820;

return	qt_total_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_quant_itens_plano (cd_pessoa_fisica_p text, nr_atendimento_p bigint, ie_opcao_p text, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

