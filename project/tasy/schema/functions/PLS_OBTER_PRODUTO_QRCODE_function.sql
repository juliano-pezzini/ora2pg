-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION pls_obter_produto_qrcode ( nr_protocolo_ans_p pls_plano.nr_protocolo_ans%type, cd_usuario_plano_p pls_segurado_carteira.cd_usuario_plano%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) RETURNS bigint AS $body$
DECLARE


/*
Essa rotina é utilizada para obter o produto que está no QRCode da carteira de identificação do beneficiário
A logina dela é semelhante a rotina pls_obter_produto_tarja_magnet, que é utilizada para obter o produto da tarja do cartão de identificação do beneficiário
*/
			
nr_seq_plano_w		pls_plano.nr_sequencia%type;
vl_param_w		varchar(10);
			

BEGIN

--Utilizar regra de definição de produto para usuário eventual
vl_param_w := coalesce(obter_valor_param_usuario(1273, 19, Obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_p), 'N');

if (vl_param_w = 'S') then
	begin
	nr_seq_plano_w := (pls_obter_nome_empresa_cart(cd_usuario_plano_p, 'P', cd_estabelecimento_p))::numeric;	
	exception
	when others then
		nr_seq_plano_w := null;
	end;
else
	select	max(nr_sequencia)
	into STRICT	nr_seq_plano_w
	from	pls_plano
	where	ie_tipo_operacao = 'T'
	and	nr_protocolo_ans = nr_protocolo_ans_p;
end if;

return	nr_seq_plano_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_obter_produto_qrcode ( nr_protocolo_ans_p pls_plano.nr_protocolo_ans%type, cd_usuario_plano_p pls_segurado_carteira.cd_usuario_plano%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

