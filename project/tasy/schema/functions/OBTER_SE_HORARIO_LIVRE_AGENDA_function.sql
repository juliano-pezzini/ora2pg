-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_horario_livre_agenda ( cd_pessoa_fisica_p text, dt_agenda_p timestamp, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


qt_ocupado_w		integer	:=0;
ds_retorno_w		varchar(1)	:=null;
ie_mostra_horario_w	varchar(1)	:=null;


BEGIN

select	coalesce(max(IE_MOSTRA_HOR_DISP_MEDIC),'N')
into STRICT	ie_mostra_horario_w
from	parametro_agenda
where	cd_estabelecimento = cd_estabelecimento_p;

if (ie_mostra_horario_w = 'S') then
	SELECT 	SUM(qt_ocupado)
	INTO STRICT	qt_ocupado_w
	FROM (SELECT 	COUNT(*) qt_ocupado
		FROM   	agenda b,
			agenda_paciente a
		WHERE  	a.cd_agenda 			= b.cd_agenda
		AND	TO_CHAR(a.hr_inicio,'hh24:mi') 	= TO_CHAR(dt_agenda_p,'hh24:mi')
		AND	a.ie_status_agenda		NOT IN ('L','LF','C')
		AND a.dt_agenda BETWEEN PKG_DATE_UTILS.START_OF(dt_agenda_p,'DAY') AND PKG_DATE_UTILS.END_OF(dt_agenda_p,'DAY')
		AND	b.cd_pessoa_fisica 		= cd_pessoa_fisica_p
		
UNION
		
		SELECT 	COUNT(*) qt_ocupado
		FROM   	agenda b,
			agenda_consulta a
		WHERE  	a.cd_agenda 			= b.cd_agenda
		aND	TO_CHAR(a.dt_agenda,'hh24:mi') 	= TO_CHAR(dt_agenda_p,'hh24:mi')
		AND	a.ie_status_agenda		NOT IN ('L','LF','C')
		AND a.dt_agenda BETWEEN PKG_DATE_UTILS.START_OF(dt_agenda_p,'DAY') AND PKG_DATE_UTILS.END_OF(dt_agenda_p,'DAY')
		AND	b.cd_pessoa_fisica 		= cd_pessoa_fisica_p) alias14;	
	if 	qt_ocupado_w > 0 then 		
		ds_retorno_w := 'N';
	else
		ds_retorno_w := 'S';
	end if;	
else
	ds_retorno_w := null;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_horario_livre_agenda ( cd_pessoa_fisica_p text, dt_agenda_p timestamp, cd_estabelecimento_p bigint) FROM PUBLIC;

