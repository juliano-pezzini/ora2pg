-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_regra_cobranca_fin ( nr_titulo_p bigint) RETURNS bigint AS $body$
DECLARE


nr_sequencia_w 		  		cobranca_regra.nr_sequencia%type;
cd_estabelecimento_w 	 	titulo_receber.cd_estabelecimento%TYPE;
dt_emissao_w  			  	titulo_receber.dt_emissao%TYPE;
vl_titulo_w			  		titulo_receber.vl_titulo%TYPE;
cd_pessoa_fisica_w	 	 	titulo_receber.cd_pessoa_fisica%TYPE;
cd_cgc_w					titulo_receber.cd_cgc%TYPE;
nr_atendimento_w            titulo_receber.nr_atendimento%TYPE;
cd_convenio_w 			  	cobranca_regra.cd_convenio%TYPE;
cd_categoria_w			  	cobranca_regra.cd_categoria%TYPE;
cd_medico_resp_w		  	cobranca_regra.cd_medico_resp%TYPE;
cd_nacionalidade_w 		  	cobranca_regra.cd_nacionalidade%TYPE;
ie_tipo_alerta_w 		  	cobranca_regra.ie_tipo_alerta%TYPE;


c01 CURSOR FOR
	SELECT 	a.nr_sequencia nr_sequencia
	from 	cobranca_regra a
	where 	(cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')
	and     vl_titulo_w between coalesce(a.vl_minimo,vl_titulo_w) and coalesce(a.vl_maximo,vl_titulo_w)
	and     coalesce(a.cd_estabelecimento ,coalesce(cd_estabelecimento_w,'0')) = coalesce(cd_estabelecimento_w,'0')
	and 	coalesce(a.cd_nacionalidade ,coalesce(cd_nacionalidade_w,'0')) = coalesce(cd_nacionalidade_w,'0')
	and 	coalesce(a.cd_convenio ,coalesce(cd_convenio_w,'0')) = coalesce(cd_convenio_w,'0')
	and 	coalesce(a.cd_categoria ,coalesce(cd_categoria_w,'0')) = coalesce(cd_categoria_w,'0')
	and 	coalesce(a.cd_medico_resp ,coalesce(cd_medico_resp_w,'0')) = coalesce(cd_medico_resp_w,'0')
	and		dt_emissao_w between trunc(coalesce(a.dt_vigencia_inicial,dt_emissao_w)) and fim_dia(coalesce(a.dt_vigencia_final,dt_emissao_w))
	and (coalesce(a.ie_tipo_alerta::text, '') = '' or exists (SELECT 1 from alerta_paciente x
							where x.cd_pessoa_fisica = cd_pessoa_fisica_w
							and x.ie_situacao = 'A'
							and (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
							and x.NR_SEQ_TIPO_ALERTA =  a.ie_tipo_alerta))

union

	select 	a.nr_sequencia nr_sequencia
	from 	cobranca_regra a
	where 	(cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '')
	and     vl_titulo_w between coalesce(a.vl_minimo,vl_titulo_w) and coalesce(a.vl_maximo,vl_titulo_w)
	and     coalesce(a.cd_estabelecimento ,coalesce(cd_estabelecimento_w,'0')) = coalesce(cd_estabelecimento_w,'0')
	and 	coalesce(a.cd_convenio ,coalesce(cd_convenio_w,'0')) = coalesce(cd_convenio_w,'0')
	and 	coalesce(a.cd_categoria ,coalesce(cd_categoria_w,'0')) = coalesce(cd_categoria_w,'0')
	and		dt_emissao_w between trunc(coalesce(a.dt_vigencia_inicial,dt_emissao_w)) and fim_dia(coalesce(a.dt_vigencia_final,dt_emissao_w));

c01_w			c01%ROWTYPE;


BEGIN

select	max(a.dt_emissao),
		max(vl_titulo),
		max(cd_estabelecimento),
		max(obter_dados_pf(a.cd_pessoa_fisica,'NC')),
		max(obter_dados_conta_paciente(a.nr_interno_conta, 'N')),
		max(obter_dados_conta_paciente(a.nr_interno_conta, 'C')),
		max(nr_atendimento),
		max(cd_cgc),
		max(cd_pessoa_fisica)
into STRICT	dt_emissao_w,
		vl_titulo_w,
		cd_estabelecimento_w,
		cd_nacionalidade_w ,
		cd_convenio_w,
		cd_categoria_w,
		nr_atendimento_w,
		cd_cgc_w,
		cd_pessoa_fisica_w
from	titulo_receber a
where	a.nr_titulo = nr_titulo_p;


select  max(cd_medico_resp)
into STRICT 	cd_medico_resp_w
from 	atendimento_paciente
where 	nr_atendimento = nr_atendimento_w;

open c01;
loop
fetch c01 into
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	nr_sequencia_w	:= nr_sequencia_w;
	end;
end loop;
close c01;

return nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_regra_cobranca_fin ( nr_titulo_p bigint) FROM PUBLIC;

