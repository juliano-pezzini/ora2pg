-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_os_caso_teste (nr_seq_caso_teste_p bigint, ie_tipo_documento_p text) RETURNS varchar AS $body$
DECLARE

/*
ie_tipo_documento_p
  'T' = verificacao
	'V' = validacao
*/
ds_retorno_w    varchar(400);
  item RECORD;

BEGIN
	ds_retorno_w := '';

  IF (ie_tipo_documento_p IS NOT NULL AND ie_tipo_documento_p::text <> '') THEN
    IF ie_tipo_documento_p = 'T' THEN
			FOR item IN (
				SELECT DISTINCT v.nr_seq_service_order, v.nr_seq_tc
				FROM   reg_tc_evidence_v v
				WHERE  (v.nr_seq_service_order IS NOT NULL AND v.nr_seq_service_order::text <> '')
				AND    v.nr_seq_tc = nr_seq_caso_teste_p
				ORDER BY 1
			)
			LOOP
				ds_retorno_w := ds_retorno_w || ', ' || item.nr_seq_service_order;
			END LOOP;
		END IF;

    IF ie_tipo_documento_p = 'V' THEN
			FOR item IN (
				SELECT DISTINCT V.Ds_Os_Falha, V.Nr_Seq_Tc
				FROM   Reg_Validation_Report_V v
				WHERE  (V.Ds_Os_Falha IS NOT NULL AND V.Ds_Os_Falha::text <> '')
				AND    v.nr_seq_tc = nr_seq_caso_teste_p
				ORDER BY 1
			)
			LOOP
				ds_retorno_w := ds_retorno_w || ', ' || item.Ds_Os_Falha;
			END LOOP;
		END IF;

		ds_retorno_w := SUBSTR(ds_retorno_w,2,LENGTH(ds_retorno_w));
  END IF;

	RETURN  ds_retorno_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_os_caso_teste (nr_seq_caso_teste_p bigint, ie_tipo_documento_p text) FROM PUBLIC;

