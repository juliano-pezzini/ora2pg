-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION define_procedimento_tuss (cd_estabelecimento_p bigint, nr_seq_proc_interno_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_tipo_atendimento_p bigint, dt_procedimento_p timestamp, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_edicao_amb_p bigint, cd_setor_atendimento_p bigint default null, cd_tipo_acomodacao_p bigint default null) RETURNS bigint AS $body$
DECLARE


ds_retorno_w		bigint;
cd_procedimento_tuss_w	bigint;
qt_regra_w		bigint;
cd_edicao_amb_w		integer;
ie_origem_proc_tuss_w	bigint;
ie_origem_proc_filtro_w	bigint;
ie_tipo_convenio_w	smallint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
ie_prioridade_edicao_w	varchar(1);
tx_ajuste_geral_w	double precision;
vl_ch_honorarios_w	double precision := 1;
vl_ch_custo_oper_w	double precision := 1;
vl_m2_filme_w		double precision := 0;
dt_inicio_vigencia_w	timestamp;
nr_seq_cbhpm_edicao_w	bigint;


C01 CURSOR FOR
	SELECT	cd_procedimento
	from	proc_interno_conv_tuss
	where	ie_situacao = 'A'
	and 	nr_seq_proc_interno = nr_seq_proc_interno_p
	and	((cd_convenio	= cd_convenio_p) OR (coalesce(cd_convenio::text, '') = ''))
	and	((cd_edicao_amb	= cd_edicao_amb_w) OR (coalesce(cd_edicao_amb::text, '') = ''))
	and	((ie_tipo_atendimento = ie_tipo_atendimento_p) OR (coalesce(ie_tipo_atendimento::text, '') = ''))
	and	((cd_categoria	= cd_categoria_p) OR (coalesce(cd_categoria::text, '') = ''))
	and	coalesce(ie_origem_proc_filtro, coalesce(ie_origem_proc_filtro_w,0)) = coalesce(ie_origem_proc_filtro_w,0)
	and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
	and	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_p,0)) = coalesce(cd_setor_atendimento_p,0)
	and	coalesce(cd_tipo_acomodacao, coalesce(cd_tipo_acomodacao_p,0)) = coalesce(cd_tipo_acomodacao_p,0)
	and dt_procedimento_p between coalesce(DT_INICIO_VIGENCIA, dt_procedimento_p) and coalesce(DT_FINAL_VIGENCIA, dt_procedimento_p)
	order by
		coalesce(cd_edicao_amb,0),
		coalesce(cd_convenio,0),
		coalesce(cd_categoria,'0'),
		coalesce(ie_tipo_atendimento,0),
		coalesce(ie_origem_proc_filtro,0),
		coalesce(cd_estabelecimento,0),
		coalesce(cd_setor_atendimento,0),
		coalesce(cd_tipo_acomodacao,0);


BEGIN

ds_retorno_w:= null;

SELECT	coalesce(MAX(ie_prioridade_edicao_amb), 'N')
INTO STRICT	ie_prioridade_edicao_w
FROM	parametro_faturamento
WHERE	cd_estabelecimento	= cd_estabelecimento_p;

select 	coalesce(max(cd_procedimento_tuss),0),
	coalesce(max(ie_origem_proc_tuss),0),
	coalesce(max(cd_procedimento),0),
	coalesce(max(ie_origem_proced),0)
into STRICT	cd_procedimento_tuss_w,
	ie_origem_proc_tuss_w,
	cd_procedimento_w,
	ie_origem_proced_w
from 	proc_interno
where 	nr_sequencia = nr_seq_proc_interno_p;

if (coalesce(cd_procedimento_p,0) <> 0) and (coalesce(ie_origem_proced_p,0) <> 0) then
	cd_procedimento_w	:= cd_procedimento_p;
	ie_origem_proced_w	:= ie_origem_proced_p;
end if;

select	max(ie_tipo_convenio)
into STRICT	ie_tipo_convenio_w
from	convenio
where	cd_convenio = cd_convenio_p;

ie_origem_proc_filtro_w	:= Obter_Origem_Proced_Cat(cd_estabelecimento_p, ie_tipo_atendimento_p, ie_tipo_convenio_w, cd_convenio_p, cd_categoria_p);

if (ie_origem_proc_tuss_w = 8) then
	ds_retorno_w:= cd_procedimento_tuss_w;
end if;

if (coalesce(cd_edicao_amb_p,0) <> 0) then
	cd_edicao_amb_w	:= cd_edicao_amb_p;
end if;

if (coalesce(cd_edicao_amb_w,0) = 0) then
	if (ie_prioridade_edicao_w	= 'N') then
		begin
		select 	cd_edicao_amb,
			CASE WHEN coalesce(vl_ch_honorarios::text, '') = '' THEN 1 WHEN vl_ch_honorarios=0 THEN 1  ELSE vl_ch_honorarios END ,
			CASE WHEN coalesce(vl_ch_custo_oper::text, '') = '' THEN 1 WHEN vl_ch_custo_oper=0 THEN 1  ELSE vl_ch_custo_oper END ,
			coalesce(vl_filme,0),
			dt_inicio_vigencia,
			nr_seq_cbhpm_edicao
		into STRICT   	cd_edicao_amb_w,
			vl_ch_honorarios_w,
			vl_ch_custo_oper_w,
			vl_m2_filme_w,
			dt_inicio_vigencia_w,
			nr_seq_cbhpm_edicao_w
		from 	convenio_amb
		where (cd_estabelecimento     = cd_estabelecimento_p)
		and (cd_convenio            = cd_convenio_p)
		and (cd_categoria           = cd_categoria_p)
		and (coalesce(ie_situacao,'A')	= 'A')
		and 	(dt_inicio_vigencia     =
				(SELECT	max(dt_inicio_vigencia)
				from 	convenio_amb a
				where (a.cd_estabelecimento  = cd_estabelecimento_p)
		and (a.cd_convenio         = cd_convenio_p)
		and (a.cd_categoria        = cd_categoria_p)
		and (coalesce(a.ie_situacao,'A')= 'A')
		and (a.dt_inicio_vigencia <=  dt_procedimento_p)));
		exception
			when 	others then
				begin
				cd_edicao_amb_w		:= 0;
				vl_ch_honorarios_w	:= 0;
				vl_ch_custo_oper_w	:= 0;
				vl_m2_filme_w		:= 0;
				nr_seq_cbhpm_edicao_w	:= 0;
			end;
		end;
	else
		SELECT * FROM obter_edicao_proc_conv(cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, dt_procedimento_p, cd_procedimento_w, cd_edicao_amb_w, vl_ch_honorarios_w, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w, ie_origem_proced_w) INTO STRICT cd_edicao_amb_w, vl_ch_honorarios_w, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w;
	end if;
end if;

select 	count(*)
into STRICT	qt_regra_w
from 	proc_interno_conv_tuss
where	nr_seq_proc_interno = nr_seq_proc_interno_p;

if (qt_regra_w > 0) then

	OPEN C01;
	LOOP
	FETCH C01 into
		cd_procedimento_tuss_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		cd_procedimento_tuss_w:= cd_procedimento_tuss_w;
	END LOOP;
	CLOSE C01;

	ds_retorno_w:= cd_procedimento_tuss_w;

end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION define_procedimento_tuss (cd_estabelecimento_p bigint, nr_seq_proc_interno_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_tipo_atendimento_p bigint, dt_procedimento_p timestamp, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_edicao_amb_p bigint, cd_setor_atendimento_p bigint default null, cd_tipo_acomodacao_p bigint default null) FROM PUBLIC;

