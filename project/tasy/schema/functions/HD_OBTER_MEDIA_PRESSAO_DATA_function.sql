-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION hd_obter_media_pressao_data ( cd_pessoa_fisica_p text, dt_inicial_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, nr_seq_unid_dialise_p bigint, ie_tipo_pressao_p text) RETURNS varchar AS $body$
DECLARE


vl_retorno_w		varchar(255);
vl_pressao_pres_med_w	varchar(255);
vl_pressao_pred_med_w	varchar(255);
vl_pressao_poss_med_w	varchar(255);
vl_pressao_posd_med_w	varchar(255);

/* Tipo pressao
PRE
POS
*/
BEGIN

vl_retorno_w	:= null;

select	round(avg(d.qt_pa_sist_pre_deitado)),
	round(avg(d.qt_pa_diast_pre_deitado))
into STRICT	vl_pressao_pres_med_w,
	vl_pressao_pred_med_w
from	hd_pac_renal_cronico p,
	hd_unidade_dialise u,
	hd_dialise d
where	u.nr_sequencia = d.nr_seq_unid_dialise
and	p.cd_pessoa_fisica = d.cd_pessoa_fisica
and	coalesce(d.dt_cancelamento::text, '') = ''
AND	coalesce(qt_pa_sist_pre_deitado,0) > 0
AND	coalesce(d.qt_pa_diast_pre_deitado,0) > 0
and	substr(HD_OBTER_SE_PAC_ATIVO_DATA(p.cd_pessoa_fisica,dt_final_p),1,1) = 'S'
and	p.cd_pessoa_fisica	= cd_pessoa_fisica_p
and	d.dt_dialise between dt_inicial_p and fim_dia(dt_final_p)
and	((u.cd_estabelecimento	= cd_estabelecimento_p) or (cd_estabelecimento_p = '0'))
and	((u.nr_sequencia	= nr_seq_unid_dialise_p) or (nr_seq_unid_dialise_p = '0'))
and	coalesce(d.nr_seq_motivo_pa_deitado_pre::text, '') = '';

select	round(avg(d.qt_pa_sist_pos_deitado)),
	round(avg(d.qt_pa_diast_pos_deitado))
into STRICT	vl_pressao_poss_med_w,
	vl_pressao_posd_med_w
from	hd_pac_renal_cronico p,
	hd_unidade_dialise u,
	hd_dialise d
where	u.nr_sequencia = d.nr_seq_unid_dialise
and	p.cd_pessoa_fisica = d.cd_pessoa_fisica
AND	coalesce(d.qt_pa_sist_pos_deitado,0) > 0
AND	coalesce(d.qt_pa_diast_pos_deitado,0) > 0
and	coalesce(d.dt_cancelamento::text, '') = ''
and	substr(HD_OBTER_SE_PAC_ATIVO_DATA(p.cd_pessoa_fisica,dt_final_p),1,1) = 'S'
and	p.cd_pessoa_fisica	= cd_pessoa_fisica_p
and	d.dt_dialise between dt_inicial_p and fim_dia(dt_final_p)
and	((u.cd_estabelecimento	= cd_estabelecimento_p) or (cd_estabelecimento_p = '0'))
and	((u.nr_sequencia	= nr_seq_unid_dialise_p) or (nr_seq_unid_dialise_p = '0'))
and	coalesce(d.nr_seq_motivo_pa_deitado_pos::text, '') = '';

if (ie_tipo_pressao_p = 'PRES') then
	vl_retorno_w	:= vl_pressao_pres_med_w;
elsif (ie_tipo_pressao_p = 'PRED') then
	vl_retorno_w	:= vl_pressao_pred_med_w;
elsif (ie_tipo_pressao_p = 'POSS') then
	vl_retorno_w	:= vl_pressao_poss_med_w;
elsif (ie_tipo_pressao_p = 'POSD') then
	vl_retorno_w	:= vl_pressao_posd_med_w;
end if;

return	vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION hd_obter_media_pressao_data ( cd_pessoa_fisica_p text, dt_inicial_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, nr_seq_unid_dialise_p bigint, ie_tipo_pressao_p text) FROM PUBLIC;

