-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_conteudo_email_atend ( nr_seq_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) RETURNS varchar AS $body$
DECLARE


ds_conteudo_email_w	pls_parametros.ds_conteudo_email%type;
ds_usuario_w		usuario.ds_usuario%type;
cd_pessoa_fisica_w	usuario.cd_pessoa_fisica%type;
ds_assinatura_email_w	pls_regra_adicional_atend.ds_assinatura_email%type;
ds_estabelecimento_w	estabelecimento.nm_fantasia_estab%type;
ds_retorno_w        	pls_parametros.ds_conteudo_email%type := '';
nr_protocolo_atendimento_w	pls_atendimento.nr_protocolo_atendimento%type;


BEGIN

select	max(ds_conteudo_email)
into STRICT	ds_conteudo_email_w
from	pls_parametros
where	cd_estabelecimento	= cd_estabelecimento_p;

if ((trim(both ds_conteudo_email_w) IS NOT NULL AND (trim(both ds_conteudo_email_w))::text <> '')) then
	select	ds_usuario,
		cd_pessoa_fisica
	into STRICT	ds_usuario_w,
		cd_pessoa_fisica_w
	from	usuario
	where	nm_usuario 	= nm_usuario_p;
	
	if (pls_obter_se_controle_estab('GA') = 'S') then
		select  max(b.ds_assinatura_email)
		into STRICT	ds_assinatura_email_w
		from    pls_operador 			a,
			pls_regra_adicional_atend 	b
		where   b.nr_seq_operador 		= a.nr_sequencia
		and     b.ie_acao_evento 		= 16
		and     a.cd_pessoa_fisica 		= cd_pessoa_fisica_w
		and (b.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento );
	else
		select  max(b.ds_assinatura_email)
		into STRICT	ds_assinatura_email_w
		from    pls_operador 			a,
			pls_regra_adicional_atend 	b
		where   b.nr_seq_operador 		= a.nr_sequencia
		and     b.ie_acao_evento 		= 16
		and     a.cd_pessoa_fisica 		= cd_pessoa_fisica_w;	
	end if;
	
	select	max(nm_fantasia_estab)
	into STRICT	ds_estabelecimento_w
	from	estabelecimento
	where	cd_estabelecimento	= cd_estabelecimento_p;
	
	select	max(nr_protocolo_atendimento)
	into STRICT	nr_protocolo_atendimento_w
	from	pls_atendimento
	where	nr_sequencia	= nr_seq_atendimento_p;
	
	ds_conteudo_email_w	:= replace_macro(ds_conteudo_email_w, '@nm_usuario', 		nm_usuario_p);
	ds_conteudo_email_w	:= replace_macro(ds_conteudo_email_w, '@ds_usuario', 		ds_usuario_w);
	ds_conteudo_email_w	:= replace_macro(ds_conteudo_email_w, '@ds_estabelecimento', 	ds_estabelecimento_w);
	ds_conteudo_email_w	:= replace_macro(ds_conteudo_email_w, '@dt_atual', 		to_char(clock_timestamp(), 'dd/mm/yyyy'));
	ds_conteudo_email_w	:= replace_macro(ds_conteudo_email_w, '@hr_atual', 		to_char(clock_timestamp(), 'hh:mm:ss'));	
	ds_conteudo_email_w	:= replace_macro(ds_conteudo_email_w, '@ds_assinatura_email',	ds_assinatura_email_w);
	ds_conteudo_email_w	:= replace_macro(ds_conteudo_email_w, '@nr_protocolo',	nr_protocolo_atendimento_w);
	
	ds_retorno_w	:= ds_conteudo_email_w;
end if;

return	ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_conteudo_email_atend ( nr_seq_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

