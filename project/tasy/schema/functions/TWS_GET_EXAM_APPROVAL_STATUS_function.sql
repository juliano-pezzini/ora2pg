-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION tws_get_exam_approval_status ( nr_prescricao_p wsuite_exam_approval.nr_prescricao%type, nr_seq_prescricao_p wsuite_exam_approval.nr_seq_prescricao%type, nr_seq_prescr_proc_p wsuite_exam_approval.nr_seq_prescricao%type, nr_seq_ext_p wsuite_exam_approval.nr_seq_ext%type, nr_seq_result_ext_p wsuite_exam_approval.nr_seq_result_ext%type, ie_lab_p text) RETURNS varchar AS $body$
DECLARE

  ds_retorno_w           varchar(1) := 'N';
  count_w                bigint := 0;
  qt_hours_w            bigint := 0;
  dt_alta_w             atendimento_paciente.dt_alta%type;

BEGIN

  qt_hours_w := (tws_obter_param_tipo_login('1', 9114, 9))::numeric;

  if ((qt_hours_w IS NOT NULL AND qt_hours_w::text <> '')
  and qt_hours_w > 0) then
    qt_hours_w := qt_hours_w/24;

    select max(a.dt_alta)
    into STRICT dt_alta_w
    from atendimento_paciente a
    left join prescr_medica b
    on a.nr_atendimento = b.nr_atendimento
    where b.nr_prescricao = coalesce(nr_prescricao_p,0);

    if ((qt_hours_w IS NOT NULL AND qt_hours_w::text <> '')
    and qt_hours_w > 0
    and (dt_alta_w + qt_hours_w) < clock_timestamp()) then
      select  count(1)
      into STRICT    count_w
;
    end if;
  end if;

  if (count_w = 0) then
      if (ie_lab_p = 'S') then
        select  count(nr_sequencia)
        into STRICT    count_w
        from    wsuite_exam_approval
        where   nr_prescricao = coalesce(nr_prescricao_p,0)
        and (nr_seq_prescricao = coalesce(nr_seq_prescricao_p,0)
        or      nr_seq_prescricao = coalesce(nr_seq_prescr_proc_p,0))
        and     CASE WHEN coalesce(nr_seq_ext_p::text, '') = '' THEN  0  ELSE coalesce(nr_seq_ext,0) END  = coalesce(nr_seq_ext_p,0)
        and     CASE WHEN coalesce(nr_seq_result_ext_p::text, '') = '' THEN  0  ELSE coalesce(nr_seq_result_ext,0) END  = coalesce(nr_seq_result_ext_p,0)
        and     ie_approved = 'S';

      else
        select  count(nr_sequencia)
        into STRICT    count_w
        from    wsuite_exam_approval
        where   nr_prescricao = coalesce(nr_prescricao_p, 0)
        and     nr_seq_prescricao = coalesce(nr_seq_prescricao_p, 0)
        and     ie_approved = 'S';

      end if;
  end if;

  if (count_w > 0) then
    ds_retorno_w := 'S';
  end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION tws_get_exam_approval_status ( nr_prescricao_p wsuite_exam_approval.nr_prescricao%type, nr_seq_prescricao_p wsuite_exam_approval.nr_seq_prescricao%type, nr_seq_prescr_proc_p wsuite_exam_approval.nr_seq_prescricao%type, nr_seq_ext_p wsuite_exam_approval.nr_seq_ext%type, nr_seq_result_ext_p wsuite_exam_approval.nr_seq_result_ext%type, ie_lab_p text) FROM PUBLIC;

