-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION permite_agendar_exame_g ( nr_seq_agenda_p bigint, cd_agenda_p bigint) RETURNS varchar AS $body$
DECLARE


nr_seq_proc_interno_w			agenda_lista_espera.nr_seq_proc_interno%type;
cd_procedimento_w       		agenda_lista_espera.cd_procedimento%type;
ie_origem_proced_w      		agenda_lista_espera.ie_origem_proced%type;
cd_paciente_w	          		agenda_lista_espera.cd_pessoa_fisica%type;
cd_medico_exec_w  	    		agenda_lista_espera.cd_medico_exec%type;
cd_area_proced_w        		estrutura_procedimento_v.cd_area_procedimento%type;
cd_espec_proced_w       		estrutura_procedimento_v.cd_especialidade%type;
cd_grupo_proced_w       		estrutura_procedimento_v.cd_grupo_proc%type;
cd_estabelecimento_w    		estabelecimento.cd_estabelecimento%type;
ie_sexo_paciente_w      		pessoa_fisica.ie_sexo%type;
qtde_registros_w      			bigint := 0;
		

BEGIN

	cd_estabelecimento_w := coalesce(wheb_usuario_pck.get_cd_estabelecimento,1);

	select	a.nr_seq_proc_interno,
		a.cd_procedimento,
		a.ie_origem_proced,
		a.cd_pessoa_fisica,
		a.cd_medico
	into STRICT	nr_seq_proc_interno_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_paciente_w,
		cd_medico_exec_w
	from	agenda_paciente a
	where	a.nr_sequencia = nr_seq_agenda_p;

	select	coalesce(max(cd_area_procedimento),0),
		coalesce(max(cd_especialidade),0),
		coalesce(max(cd_grupo_proc),0)
	into STRICT	cd_area_proced_w,
		cd_espec_proced_w,
		cd_grupo_proced_w
	from	estrutura_procedimento_v
	where	cd_procedimento = cd_procedimento_w
	and	ie_origem_proced = ie_origem_proced_w;

	select	obter_sexo_pf(cd_paciente_w, 'C')
	into STRICT	ie_sexo_paciente_w
	;

  	select	count(nr_sequencia)
  	into STRICT	qtde_registros_w
  	from	agenda_regra
  	where	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
  	and	cd_agenda = cd_agenda_p;

  	if (qtde_registros_w > 0) then
		select	count(1)
		into STRICT	qtde_registros_w
		from	agenda_regra b,
      			agenda a
   		where	a.cd_agenda = b.cd_agenda
    		and	coalesce(a.ie_agenda_integrada,'N') = 'S'
		and	a.ie_situacao = 'a'
		and  	a.cd_tipo_agenda = 2	
    		and  	a.cd_agenda = cd_agenda_p
    		and	((b.cd_area_proc = cd_area_proced_w) or (coalesce(b.cd_area_proc::text, '') = ''))
    		and	((b.cd_especialidade = cd_espec_proced_w) or (coalesce(b.cd_especialidade::text, '') = ''))
    		and	((b.cd_grupo_proc = cd_grupo_proced_w) or (coalesce(b.cd_grupo_proc::text, '') = ''))
    		and	((b.nr_seq_proc_interno = nr_seq_proc_interno_w) or (coalesce(b.nr_seq_proc_interno::text, '') = ''))
    		and	((b.cd_procedimento = cd_procedimento_w) or (coalesce(b.cd_procedimento::text, '') = ''))
    		and	((coalesce(b.cd_procedimento::text, '') = '') or ((b.ie_origem_proced = ie_origem_proced_w) or (coalesce(b.ie_origem_proced::text, '') = '')))
    		and	((coalesce(a.cd_pessoa_fisica, cd_medico_exec_w) = cd_medico_exec_w) or (coalesce(cd_medico_exec_w::text, '') = ''))
    		and	coalesce(b.ie_situacao,'A') = 'A'
    		and	((coalesce(a.ie_sexo_agenda,'A') = 'A') or (ie_sexo_paciente_w = coalesce(a.ie_sexo_agenda,'A')));
	
    		if (qtde_registros_w > 0) then
      			return 'S';
    		else
      			return 'N';
    		end if;
  	else
    		return 'S';
  	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION permite_agendar_exame_g ( nr_seq_agenda_p bigint, cd_agenda_p bigint) FROM PUBLIC;

