-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_agenda_regra_dia ( cd_agenda_p bigint, dt_agenda_p timestamp, nm_usuario_p text) RETURNS varchar AS $body$
DECLARE


cd_pessoa_fisica_w	varchar(10);
ie_regra_w		varchar(1);
dt_dia_semana_w		smallint;
ie_feriado_w		varchar(1);
nm_usuario_w		varchar(15);
qt_regra_w        bigint;


BEGIN

ie_regra_w	:= 'N';
nm_usuario_w	:= nm_usuario_p;

if (coalesce(nm_usuario_w::text, '') = '') then
	nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
end if;



if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') and (dt_agenda_p IS NOT NULL AND dt_agenda_p::text <> '') then
	begin
   select 	max(CASE WHEN Obter_Se_Feriado(cd_estabelecimento, dt_agenda_p)=0 THEN 'N'  ELSE 'S' END ),
            coalesce(max(1),0)
   into STRICT	   ie_feriado_w,
            qt_regra_w
   from	   agenda a,
            agenda_pac_regra_dia b
   where    a.cd_agenda = b.cd_agenda
   and      a.cd_agenda = cd_agenda_p;

   if (coalesce(qt_regra_w,0) > 0) then
      cd_pessoa_fisica_w   := substr(Obter_Pessoa_Fisica_Usuario(nm_usuario_w, 'C'),1,10);
      if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
         dt_dia_semana_w      := obter_cod_dia_semana(dt_agenda_p);

         select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
         into STRICT	ie_regra_w
         from	agenda_pac_regra_dia
         where	cd_agenda = cd_agenda_p
         and	to_date(to_char(hr_inicial,'dd/mm/yyyy') ||' '||to_char(dt_agenda_p,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') between hr_inicial and hr_final
         and	((coalesce(dt_dia_semana, dt_dia_semana_w) = dt_dia_semana_w) or (dt_dia_semana = 9))
         and	((ie_feriado = 'S' AND ie_feriado_w = 'S') or					
             (ie_feriado = 'N' AND ie_feriado_w <> 'S'))
         and	((coalesce(ie_data_referencia,'S') = 'S') and (clock_timestamp() between coalesce(dt_inicio_vigencia, clock_timestamp() - interval '1 days') and coalesce(dt_fim_vigencia, clock_timestamp() + interval '1 days')) or (coalesce(ie_data_referencia,'S') = 'A') and (dt_agenda_p between coalesce(dt_inicio_vigencia, dt_agenda_p-1) and coalesce(dt_fim_vigencia, dt_agenda_p+1)))
         and	cd_pessoa_fisica = cd_pessoa_fisica_w;
      end if;
   end if;
	end;
end if;

return ie_regra_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_agenda_regra_dia ( cd_agenda_p bigint, dt_agenda_p timestamp, nm_usuario_p text) FROM PUBLIC;

