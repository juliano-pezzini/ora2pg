-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_saldo_transacao (nr_seq_movto_p bigint, ie_caixa_banco_p text) RETURNS bigint AS $body$
DECLARE


nr_seq_saldo_banco_w	bigint   := null;
nr_seq_saldo_caixa_w	bigint   := null;
vl_saldo_w		double precision := 0;
dt_transacao_w		timestamp;
vl_transacao_w		double precision := 0;
nr_seq_movto_w		bigint   := 0;
ie_banco_w		varchar(1)  := '';
ie_saldo_caixa_w	varchar(1)  := '';
dt_trans_movto_W	timestamp;

C01 CURSOR FOR
SELECT	 trunc(a.dt_transacao,'dd'),
	 a.vl_transacao,
	 a.nr_sequencia,
	 b.ie_banco
from	 transacao_financeira b,
	 movto_trans_financ a
where	 a.nr_seq_trans_financ  = b.nr_sequencia
and	 a.nr_seq_saldo_banco 	= nr_seq_saldo_banco_w
and	 b.ie_banco <> 'N'
order by trunc(a.dt_transacao,'dd'),
	 a.nr_sequencia;

C02 CURSOR FOR
SELECT	 trunc(a.dt_transacao,'dd'),
	 a.vl_transacao,
	 a.nr_sequencia,
	 b.ie_saldo_caixa
from	 transacao_financeira b,
	 movto_trans_financ a
where	 a.nr_seq_trans_financ  = b.nr_sequencia
and	 a.nr_seq_saldo_caixa 	= nr_seq_saldo_caixa_w
and	 b.ie_caixa in ('D','A','T')
order by trunc(a.dt_transacao,'dd'),
	 a.nr_sequencia;


BEGIN

select	nr_seq_saldo_banco,
	nr_seq_saldo_caixa,
	trunc(dt_transacao,'dd')
into STRICT	nr_seq_saldo_banco_w,
	nr_seq_saldo_caixa_w,
	dt_trans_movto_w
from	movto_trans_financ
where	nr_sequencia	= nr_seq_movto_p;

if (ie_caixa_banco_p = 'B') then
	select 	obter_saldo_banco_anterior(b.nr_sequencia)
	into STRICT	vl_saldo_w
	from 	banco_saldo b
	where 	nr_sequencia	= nr_seq_saldo_banco_w;

	open C01;
	loop
	fetch C01 into
		dt_transacao_w,
		vl_transacao_w,
		nr_seq_movto_w,
		ie_banco_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		if (ie_banco_w = 'C') then
			vl_saldo_w 	:= vl_saldo_w - vl_transacao_w;
		elsif (ie_banco_w = 'D') then
			vl_saldo_w 	:= vl_saldo_w + vl_transacao_w;
		elsif (ie_banco_w = 'T') then
			vl_saldo_w 	:= vl_saldo_w;
		end if;

		if (nr_seq_movto_w = nr_seq_movto_p) then
			exit;
		end if;
	end loop;
	close C01;
elsif (ie_caixa_banco_p = 'C') then
	select	vl_saldo_inicial
	into STRICT	vl_saldo_w
	from	caixa_saldo_diario
	where	nr_sequencia 	= nr_seq_saldo_caixa_w;

	open C02;
	loop
	fetch C02 into
		dt_transacao_w,
		vl_transacao_w,
		nr_seq_movto_w,
		ie_saldo_caixa_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		if (ie_saldo_caixa_w = 'S') then
			vl_saldo_w 	:= vl_saldo_w - vl_transacao_w;
		elsif (ie_saldo_caixa_w = 'E') then
			vl_saldo_w 	:= vl_saldo_w + vl_transacao_w;
		end if;

		if (nr_seq_movto_w = nr_seq_movto_p) then
			exit;
		end if;
	end loop;
	close C02;
end if;

return	coalesce(vl_saldo_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_saldo_transacao (nr_seq_movto_p bigint, ie_caixa_banco_p text) FROM PUBLIC;

