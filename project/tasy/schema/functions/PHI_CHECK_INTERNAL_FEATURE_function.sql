-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION phi_check_internal_feature ( nr_seq_ordem_serv_p bigint, nm_usuario_p text default null) RETURNS varchar AS $body$
DECLARE


retorno_w	bigint;
nm_usuario_w	varchar(255);


BEGIN

nm_usuario_w := coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario);

select	count(1)
into STRICT	retorno_w
from	man_ordem_servico mos
where	mos.nr_sequencia = nr_seq_ordem_serv_p
--and	obter_se_funcao_philips(mos.cd_funcao) = 'S'
and	exists (
		SELECT	1
		from	man_ordem_servico_exec mose
		where	mos.nr_sequencia = mose.nr_seq_ordem
		and	mose.nm_usuario_exec = nm_usuario_w
		and	coalesce(mose.dt_fim_execucao,clock_timestamp()) >= clock_timestamp()
	)
and (exists (
		SELECT	1
		from	usuario_grupo_des b
		where	trunc(clock_timestamp()) between trunc(b.dt_inicio_vigencia) and trunc(coalesce(b.dt_fim_vigencia, clock_timestamp()))
		and	b.nm_usuario_grupo = nm_usuario_w
		and	b.nr_seq_grupo in (
				select	nr_sequencia
				from	grupo_desenvolvimento
				where	ie_situacao = 'A'
				and	nr_seq_gerencia = 17
			)
	)
or	exists (
		select	1
		from	grupo_des_delegacao c
		where	trunc(clock_timestamp()) between trunc(coalesce(c.dt_inicio_vigencia, clock_timestamp())) and trunc(coalesce(c.dt_fim_vigencia, clock_timestamp()))
		and	c.nm_usuario_delegacao = nm_usuario_w
		and	c.nr_seq_grupo_des in (
				select	d.nr_sequencia
				from	grupo_desenvolvimento d
				where	d.ie_situacao = 'A'
				and	d.nr_seq_gerencia = 17
			)
	))
;

return retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION phi_check_internal_feature ( nr_seq_ordem_serv_p bigint, nm_usuario_p text default null) FROM PUBLIC;

