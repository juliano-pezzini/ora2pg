-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION sup_obter_seq_legenda_unit (nr_solic_unitarizacao_p bigint) RETURNS bigint AS $body$
DECLARE



dt_envio_w		timestamp;
dt_recebimento_w	timestamp;

dt_geracao_lote_w	timestamp;
dt_entrega_w		timestamp;
dt_liberacao_w		timestamp;
ie_urgente_w		varchar(1);

nr_sequencia_w		bigint;

qt_existe_w		bigint;
qt_nao_entregue_w	bigint;
qt_entregue_w		double precision;
qt_existe_devolucao_w	bigint;
qt_unitarizar_w		double precision;

nr_seq_retorno_w 	bigint;


BEGIN
if (coalesce(nr_solic_unitarizacao_p,0) > 0) then
	begin
	select	count(*)
	into STRICT	qt_existe_w
	from	unitarizacao
	where	nr_solic_unitarizacao = nr_solic_unitarizacao_p
	and	(dt_inicio_processo IS NOT NULL AND dt_inicio_processo::text <> '');

	select	count(*)
	into STRICT	qt_existe_devolucao_w
	from	solic_unitarizacao_dev
	where	nr_solic_unitarizacao = nr_solic_unitarizacao_p;

	if (qt_existe_w > 0) then
		begin
		select	max(nr_sequencia)
		into STRICT	nr_sequencia_w
		from	unitarizacao
		where	nr_solic_unitarizacao = nr_solic_unitarizacao_p;

		select	dt_geracao_lote,
			dt_entrega,
			coalesce(dt_liberacao, dt_fim_processo)
		into STRICT	dt_geracao_lote_w,
			dt_entrega_w,
			dt_liberacao_w
		from	unitarizacao
		where	nr_sequencia = nr_sequencia_w;

		select	count(*)
		into STRICT	qt_nao_entregue_w
		from	unitarizacao
		where	nr_solic_unitarizacao = nr_solic_unitarizacao_p
		and	coalesce(dt_entrega::text, '') = '';

		select	sum(qt_material)
		into STRICT	qt_entregue_w
		from	unitarizacao
		where	nr_solic_unitarizacao = nr_solic_unitarizacao_p
		and	(dt_entrega IS NOT NULL AND dt_entrega::text <> '');

		select	sum(qt_unitarizar)
		into STRICT	qt_unitarizar_w
		from	solic_unitarizacao
		where	nr_sequencia = nr_solic_unitarizacao_p;

		if (qt_entregue_w > 0) and (qt_entregue_w < qt_unitarizar_w) then
			nr_seq_retorno_w := 4136;
		elsif (qt_entregue_w >= qt_unitarizar_w) then
			nr_seq_retorno_w := 3524;
		elsif (dt_geracao_lote_w IS NOT NULL AND dt_geracao_lote_w::text <> '') then
			nr_seq_retorno_w := 3523;
		elsif (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') then
			nr_seq_retorno_w := 3518;
		else
			nr_seq_retorno_w := 3520;
		end if;
		end;
	else
		begin
		select	dt_envio,
			dt_recebimento,
			ie_urgente
		into STRICT	dt_envio_w,
			dt_recebimento_w,
			ie_urgente_w
		from	solic_unitarizacao
		where	nr_sequencia = nr_solic_unitarizacao_p;

		if (dt_recebimento_w IS NOT NULL AND dt_recebimento_w::text <> '') and (qt_existe_devolucao_w > 0) then
			nr_seq_retorno_w := 4346;
		elsif (dt_recebimento_w IS NOT NULL AND dt_recebimento_w::text <> '') then
			nr_seq_retorno_w := 3522;
		elsif ((dt_envio_w IS NOT NULL AND dt_envio_w::text <> '') and ie_urgente_w = 'S') then
			nr_seq_retorno_w := 3886;
		elsif (dt_envio_w IS NOT NULL AND dt_envio_w::text <> '') then
			nr_seq_retorno_w := 3521;
		else
			nr_seq_retorno_w := 0;
		end if;
		end;
	end if;
	end;
end if;

return nr_seq_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION sup_obter_seq_legenda_unit (nr_solic_unitarizacao_p bigint) FROM PUBLIC;

