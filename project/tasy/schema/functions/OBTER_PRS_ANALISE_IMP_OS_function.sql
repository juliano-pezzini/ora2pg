-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_prs_analise_imp_os ( nr_seq_ordem_serv_p bigint, dt_fim_versao_p timestamp, tipo_retorno_p text default 'PRS_ID', nr_seq_intencao_uso_p bigint default 2) RETURNS varchar AS $body$
DECLARE

/*
tipo_retorno_p = 'PRS_ID'    -- retorna o id do PRS

tipo_retorno_p = 'URS_ID'    -- retorna o id do URS


*/
ds_retorno_w			varchar(4000);
cd_prs_id_w			reg_product_requirement.cd_prs_id%type;
nr_seq_projeto_w		Man_Ordem_Servico.Nr_Seq_Projeto%type;
max_nr_seq_analise_imp_w	man_ordem_serv_impacto.nr_sequencia%type;

  item RECORD;

BEGIN

	ds_retorno_w := '';
	cd_prs_id_w := 0;

	select	max(a1.nr_sequencia)
	into STRICT	max_nr_seq_analise_imp_w
	from	man_ordem_serv_impacto a1
	where	(A1.Dt_Aprovacao IS NOT NULL AND A1.Dt_Aprovacao::text <> '')
	and	trunc(a1.dt_aprovacao) < (dt_fim_versao_p + 1)
	and	A1.Nr_Seq_Ordem_Serv = nr_seq_ordem_serv_p;

	for item in (
		SELECT  	c1.cd_prs_id,
				d1.cd_crs_id
		from    	man_ordem_serv_impacto a1,
				Man_Ordem_Serv_Imp_Pr b1,
				reg_product_requirement c1,
				reg_customer_requirement d1,
        reg_features_customer fea,
        reg_area_customer area
		where   	a1.nr_sequencia = B1.Nr_Seq_Impacto
		and     	b1.nr_product_requirement = C1.Nr_Sequencia
		and     	c1.nr_customer_requirement = d1.nr_sequencia
		and       	d1.nr_seq_features = fea.nr_sequencia
		and       	fea.nr_seq_area_customer = area.nr_sequencia
		and       	area.nr_seq_intencao_uso = nr_seq_intencao_uso_p
		and     	A1.nr_sequencia = max_nr_seq_analise_imp_w
		order by	c1.cd_prs_id
	) loop

		if (cd_prs_id_w <> item.cd_prs_id) then
			if tipo_retorno_p = 'PRS_ID' then
				if ds_retorno_w = '' then
					ds_retorno_w := item.cd_prs_id;
				else
					ds_retorno_w := substr(ds_retorno_w || chr(10) || item.cd_prs_id,1, 4000);
				end if;
				cd_prs_id_w := item.cd_prs_id;
			else
				if ds_retorno_w = '' then
					ds_retorno_w := item.cd_crs_id;
				else
					ds_retorno_w := ds_retorno_w || chr(10) || item.cd_crs_id;
				end if;
				-- controlado pelo prs id para ter o mesmo numero de linhas de retorno
				cd_prs_id_w := item.cd_crs_id;
			end if;
		end if;
	end loop;

	ds_retorno_w := substr(ds_retorno_w, 2, length(ds_retorno_w));

	-- busca PRS da analise de impacto de OS de projeto
	if coalesce(ds_retorno_w::text, '') = '' then

	select	coalesce(proj_obter_projeto_ordem_serv(nr_seq_ordem_serv_p),0) nr_seq_projeto
	into STRICT	nr_seq_projeto_w
	;

	if nr_seq_projeto_w > 0 then

	for item in (
		SELECT  	c1.cd_prs_id,
				d1.cd_crs_id
		from    	man_ordem_serv_impacto a1,
				Man_Ordem_Serv_Imp_Pr b1,
				reg_product_requirement c1,
				reg_customer_requirement d1,
        reg_features_customer fea,
        reg_area_customer area
		where   	a1.nr_sequencia = B1.Nr_Seq_Impacto
		and     	b1.nr_product_requirement = C1.Nr_Sequencia
		and     	c1.nr_customer_requirement = d1.nr_sequencia
		and       	d1.nr_seq_features = fea.nr_sequencia
		and       	fea.nr_seq_area_customer = area.nr_sequencia
		and       	area.nr_seq_intencao_uso = nr_seq_intencao_uso_p
		and     	(A1.Dt_Aprovacao IS NOT NULL AND A1.Dt_Aprovacao::text <> '')
		and     	trunc(a1.dt_aprovacao) < dt_fim_versao_p + 1
		and     	A1.Nr_Seq_Ordem_Serv =  ( SELECT  A.Nr_Seq_Ordem_Serv
							from    proj_projeto a
							where   a.nr_sequencia = nr_seq_projeto_w )
		order by	c1.cd_prs_id
	) loop

		if (cd_prs_id_w <> item.cd_prs_id) then
			if tipo_retorno_p = 'PRS_ID' then
				if ds_retorno_w = '' then
					ds_retorno_w := item.cd_prs_id;
				else
					ds_retorno_w := ds_retorno_w || chr(10) || item.cd_prs_id;
				end if;
				cd_prs_id_w := item.cd_prs_id;
			else
				if ds_retorno_w = '' then
					ds_retorno_w := item.cd_crs_id;
				else
					ds_retorno_w := ds_retorno_w || chr(10)|| item.cd_crs_id;
				end if;
				-- controlado pelo prs id para ter o mesmo numero de linhas de retorno
				cd_prs_id_w := item.cd_crs_id;
			end if;
		end if;
	end loop;

      ds_retorno_w := substr(ds_retorno_w, 2, length(ds_retorno_w));
    end if;

  end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_prs_analise_imp_os ( nr_seq_ordem_serv_p bigint, dt_fim_versao_p timestamp, tipo_retorno_p text default 'PRS_ID', nr_seq_intencao_uso_p bigint default 2) FROM PUBLIC;

