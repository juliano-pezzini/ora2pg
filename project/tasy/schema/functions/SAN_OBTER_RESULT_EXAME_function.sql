-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION san_obter_result_exame ( nr_seq_exame_lote_p bigint, nr_seq_exame_p bigint, nr_seq_exame_valor_p text default null) RETURNS varchar AS $body$
DECLARE


ds_retorno_w	varchar(255);


BEGIN

select	max(b.ds_valor)
	into STRICT ds_retorno_w
from	san_exame_realizado x,
	san_exame a,
	san_exame_valor b
where	a.nr_sequencia = x.nr_seq_exame
and 	x.nr_seq_exame = b.nr_seq_exame
and 	x.nr_seq_exame = nr_seq_exame_p
and 	x.nr_seq_exame_lote = nr_seq_exame_lote_p
and 	((coalesce(nr_seq_exame_valor_p::text, '') = '' and x.ds_resultado = to_char(b.nr_sequencia))
	or ((nr_seq_exame_valor_p IS NOT NULL AND nr_seq_exame_valor_p::text <> '') and IS_NUMBER(nr_seq_exame_valor_p) = 1 and nr_seq_exame_valor_p = to_char(b.nr_sequencia))
	or ((nr_seq_exame_valor_p IS NOT NULL AND nr_seq_exame_valor_p::text <> '') and IS_NUMBER(nr_seq_exame_valor_p) = 0 and nr_seq_exame_valor_p = to_char(b.ds_valor)))
and 	coalesce(a.cd_tipo_resultado::text, '') = '';

if ( coalesce(ds_retorno_w::text, '') = '' ) then


	select 	concat(coalesce(CASE WHEN b.ie_resultado='N' THEN  to_char(a.vl_resultado)  ELSE coalesce(CASE WHEN coalesce(c.cd_exp_valor_dominio::text, '') = '' THEN  a.ds_resultado  ELSE obter_desc_expressao(c.cd_exp_valor_dominio) END , a.ds_resultado) END , a.ie_resultado),
	
		(
			case
				when pkg_i18n.get_user_locale = 'ja_JP' then
					case
						when b.cd_tipo_resultado = 10053 and not coalesce(c.cd_exp_valor_dominio::text, '') = '' and upper(coalesce(a.nm_usuario_criacao, ' ')) <> 'TASY' then '(*)'
						when b.cd_tipo_resultado = 10053 and not coalesce(c.cd_exp_valor_dominio::text, '') = '' and upper(coalesce(a.nm_usuario_criacao, ' ')) = 'TASY' and upper(coalesce(a.nm_usuario, ' ')) <> 'TASY'
						then '(*)'
						else null
					end
				else null
			end
		))
	into STRICT	ds_retorno_w
	from	san_exame b
	left join san_exame_realizado a 
		on  a.nr_seq_exame	= b.nr_sequencia
	left join valor_dominio c 
		on  	b.cd_tipo_resultado 	= c.cd_dominio 
		and 	Upper(a.ds_resultado)	= Upper(c.ds_valor_dominio)
		and 	c.ie_situacao 		= 'A'
	where 	a.nr_seq_exame_lote	= nr_seq_exame_lote_p
	and 	a.nr_seq_exame		= nr_seq_exame_p;
	
end if;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION san_obter_result_exame ( nr_seq_exame_lote_p bigint, nr_seq_exame_p bigint, nr_seq_exame_valor_p text default null) FROM PUBLIC;

