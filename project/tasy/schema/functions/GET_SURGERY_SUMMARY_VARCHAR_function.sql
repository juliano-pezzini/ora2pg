-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION get_surgery_summary_varchar ( nr_surgery_p bigint, ie_option_p text) RETURNS varchar AS $body$
DECLARE

    ds_return_w varchar(32000);
    nm_medico_cirurgiao_w varchar(255);
    nm_medico_anestesista_w varchar(255);
    nm_attending_phycisian_w varchar(4000);
    nm_assitant_phycisian_w varchar(4000);
    nm_primary_nurse_w varchar(4000);
    nm_secondary_nurse_w varchar(4000);
    nm_other_anesthtist_w varchar(4000);
    nm_other_surgeon_w varchar(4000);
    nm_instrument_tech_w varchar(4000);
    nm_other_participant_w varchar(4000);
    nm_seroper_w varchar(4000);

    c_team_participant CURSOR FOR
    SELECT distinct fm.cd_funcao,fm.ie_medico,fm.ie_anestesista,fm.ie_auxiliar,fm.ie_instrumentador,fm.ie_enfermeira,fm.ds_funcao,cp.nm_participante,fm.ie_cirurgiao
    from cirurgia_participante cp,
    funcao_medico fm
    where Somente_Numero(cp.ie_funcao) = fm.cd_funcao
    and nr_cirurgia = nr_surgery_p
    and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') and coalesce(dt_inativacao::text, '') = '';

    c_infecteous_icd CURSOR FOR
    SELECT obter_desc_cid(cd_doenca) ds_icd,
    obter_status_diag_date(obter_pessoa_atendimento(NR_ATENDIMENTO,'C'),cd_doenca,nr_seq_interno) ds_status_date,
    substr(obter_status_diag_doenca(obter_pessoa_atendimento(NR_ATENDIMENTO,'C'), cd_doenca,dt_diagnostico,null,nr_seq_interno),1,60) ds_status
    from diagnostico_doenca
    where  nr_cirurgia = nr_surgery_p
    and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') and coalesce(dt_inativacao::text, '') = ''
    and (nr_seq_etiologia IS NOT NULL AND nr_seq_etiologia::text <> '');


BEGIN


	if (nr_surgery_p IS NOT NULL AND nr_surgery_p::text <> '' AND ie_option_p IS NOT NULL AND ie_option_p::text <> '') then
    if ( ie_option_p = 'POS') then
    select (obter_select_concatenado_bv('select SUBSTR(NVL(obter_valor_dominio(1552,IE_POSICAO), obter_valor_dominio(8664,IE_POSICAO)),1,40)
	from POSICAO_CIRURGIA  where nr_cirurgia = :nr_cirurgia_p
	and dt_liberacao is not null and dt_inativacao is null','nr_cirurgia_p=' || a.nr_cirurgia || ';' , ', '))
    into STRICT ds_return_w
    from cirurgia a where a.nr_cirurgia = nr_surgery_p;
    elsif ( ie_option_p = 'INF_ICD') then
    for r_c_infecteous_icd in c_infecteous_icd loop
    ds_return_w := r_c_infecteous_icd.ds_icd;
    if (r_c_infecteous_icd.ds_status_date IS NOT NULL AND r_c_infecteous_icd.ds_status_date::text <> '') then
        ds_return_w := ds_return_w  || ' - ' || r_c_infecteous_icd.ds_status_date;
    end if;
    if (r_c_infecteous_icd.ds_status IS NOT NULL AND r_c_infecteous_icd.ds_status::text <> '') then
        ds_return_w := ds_return_w  || ' - ' || r_c_infecteous_icd.ds_status;
    end if;
    ds_return_w := ds_return_w || chr(13) || chr(10);
    end loop;
    elsif ( ie_option_p = 'ICD') then
	select (obter_select_concatenado_bv('select obter_desc_cid(CD_DOENCA) from diagnostico_doenca
	where nr_cirurgia = :nr_cirurgia_p   and nr_seq_etiologia is null and dt_liberacao is not null and dt_inativacao is null','nr_cirurgia_p=' || a.nr_cirurgia || ';' , ', '))
    into STRICT ds_return_w
    from cirurgia a where a.nr_cirurgia =nr_surgery_p;
    elsif ( ie_option_p = 'SURG_TEAM') then
    select  obter_nome_medico(cd_medico_cirurgiao, 'N'),obter_nome_medico(cd_medico_anestesista, 'N'),obter_pf_usuario(nm_usuario,'N')
    into STRICT nm_medico_cirurgiao_w,nm_medico_anestesista_w,nm_seroper_w
    from cirurgia where nr_cirurgia = nr_surgery_p;
    ds_return_w := obter_desc_expressao(293107) || ' - ' ||  nm_medico_cirurgiao_w || chr(13);
    if (nm_medico_anestesista_w IS NOT NULL AND nm_medico_anestesista_w::text <> '') then
    ds_return_w := ds_return_w || obter_desc_expressao(293093) || ' - ' ||  nm_medico_anestesista_w || chr(13);
    end if;
    for r_c_team_participant in c_team_participant loop
    if (r_c_team_participant.ie_medico ='S' and r_c_team_participant.ie_auxiliar = 'N' and r_c_team_participant.ie_enfermeira ='N') then
    nm_attending_phycisian_w := nm_attending_phycisian_w ||r_c_team_participant.nm_participante || ',';
    elsif (r_c_team_participant.ie_medico ='S' and r_c_team_participant.ie_auxiliar = 'S' and r_c_team_participant.ie_enfermeira ='N') then
    nm_assitant_phycisian_w := nm_assitant_phycisian_w||r_c_team_participant.nm_participante || ',';
    elsif (r_c_team_participant.ie_medico ='N' and r_c_team_participant.ie_auxiliar = 'N' and r_c_team_participant.ie_enfermeira ='S') then
    nm_primary_nurse_w := nm_primary_nurse_w ||r_c_team_participant.nm_participante || ',';
    elsif (r_c_team_participant.ie_medico ='N' and r_c_team_participant.ie_auxiliar = 'S' and r_c_team_participant.ie_enfermeira ='S') then
    nm_secondary_nurse_w := nm_secondary_nurse_w || r_c_team_participant.nm_participante || ',';
    elsif (r_c_team_participant.ie_medico ='N' and r_c_team_participant.ie_auxiliar = 'N' and r_c_team_participant.ie_enfermeira ='N' and r_c_team_participant.ie_instrumentador ='S') then
    nm_instrument_tech_w := nm_instrument_tech_w || r_c_team_participant.nm_participante || ',';
    elsif (r_c_team_participant.ie_medico ='N' and r_c_team_participant.ie_auxiliar = 'N' and r_c_team_participant.ie_enfermeira ='N' and r_c_team_participant.ie_anestesista ='S') then
    nm_other_anesthtist_w := nm_other_anesthtist_w || r_c_team_participant.nm_participante || ',';
    elsif (r_c_team_participant.ie_medico ='S' and r_c_team_participant.ie_auxiliar = 'N' and r_c_team_participant.ie_enfermeira ='N' and r_c_team_participant.ie_cirurgiao ='S') then
    nm_other_surgeon_w := nm_other_surgeon_w || r_c_team_participant.nm_participante || ',';
    else
    nm_other_participant_w := nm_other_participant_w || r_c_team_participant.nm_participante || ',';
    end if;
    end loop;
    if (nm_attending_phycisian_w IS NOT NULL AND nm_attending_phycisian_w::text <> '') then
    nm_attending_phycisian_w := substr(nm_attending_phycisian_w,0,length(nm_attending_phycisian_w)-1);
    ds_return_w := ds_return_w || obter_desc_expressao(293095) || ' - ' || nm_attending_phycisian_w || chr(13) || chr(10);
    end if;
    if (nm_assitant_phycisian_w IS NOT NULL AND nm_assitant_phycisian_w::text <> '') then
    nm_assitant_phycisian_w := substr(nm_assitant_phycisian_w,0,length(nm_assitant_phycisian_w)-1);
    ds_return_w := ds_return_w || obter_desc_expressao(486333) || ' - ' || nm_assitant_phycisian_w || chr(13) || chr(10);
    end if;
    if (nm_primary_nurse_w IS NOT NULL AND nm_primary_nurse_w::text <> '') then
    nm_primary_nurse_w := substr(nm_primary_nurse_w,0,length(nm_primary_nurse_w)-1);
    ds_return_w := ds_return_w || obter_desc_expressao(1034043) || ' - ' || nm_primary_nurse_w || chr(13) || chr(10);
    end if;
    if (nm_secondary_nurse_w IS NOT NULL AND nm_secondary_nurse_w::text <> '') then
    nm_secondary_nurse_w := substr(nm_secondary_nurse_w,0,length(nm_secondary_nurse_w)-1);
    ds_return_w := ds_return_w || obter_desc_expressao(1056174) || ' - ' || nm_secondary_nurse_w || chr(13) || chr(10);
    end if;
    if (nm_other_anesthtist_w IS NOT NULL AND nm_other_anesthtist_w::text <> '') then
    nm_other_anesthtist_w := substr(nm_other_anesthtist_w,0,length(nm_other_anesthtist_w)-1);
    ds_return_w := ds_return_w || obter_desc_expressao(1014111) || ' - ' || nm_other_anesthtist_w || chr(13) || chr(10);
    end if;
    if (nm_other_surgeon_w IS NOT NULL AND nm_other_surgeon_w::text <> '') then
    nm_other_surgeon_w := substr(nm_other_surgeon_w,0,length(nm_other_surgeon_w)-1);
    ds_return_w := ds_return_w || obter_desc_expressao(1014159) || ' - ' || nm_other_surgeon_w || chr(13) || chr(10);
    end if;
    if (nm_instrument_tech_w IS NOT NULL AND nm_instrument_tech_w::text <> '') then
    nm_instrument_tech_w := substr(nm_instrument_tech_w,0,length(nm_instrument_tech_w)-1);
    ds_return_w := ds_return_w || obter_desc_expressao(309490) || ' - ' || nm_instrument_tech_w || chr(13) || chr(10);
    end if;
    if (nm_other_participant_w IS NOT NULL AND nm_other_participant_w::text <> '') then
    nm_other_participant_w := substr(nm_other_participant_w,0,length(nm_other_participant_w)-1);
    ds_return_w := ds_return_w || obter_desc_expressao(1033153) || ' - ' || nm_other_participant_w || chr(13) || chr(10);
    end if;
    ds_return_w := ds_return_w ||  obter_desc_expressao(1066020) || ' - ' ||  nm_seroper_w;
    elsif ( ie_option_p = 'SURG_DESC') then
	select x.ds_cirurgia
    into STRICT ds_return_w
    from cirurgia_descricao x
    where x.ie_tipo_descricao = 'P'
    and (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
    and x.ie_situacao = 'A'
    and  x.nr_cirurgia = nr_surgery_p
    order by x.dt_atualizacao desc LIMIT 1;
    end if;
  end if;
return ds_return_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION get_surgery_summary_varchar ( nr_surgery_p bigint, ie_option_p text) FROM PUBLIC;

