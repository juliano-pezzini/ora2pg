-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_saldo_disp_consig ( cd_estabelecimento_p bigint, cd_cgc_fornec_p text, cd_material_p bigint, cd_local_estoque_p bigint, nr_seq_lote_p bigint default null) RETURNS bigint AS $body$
DECLARE


qt_retorno_w			double precision	:= 0;
qt_estoque_w			double precision	:= 0;
qt_cirurgia_w			double precision	:= 0;
qt_esp_cirurgia_w		double precision	:= 0;
qt_agenda_cirurgia_w		double precision	:= 0;
qt_conv_estoque_w		double precision;
cd_material_w			integer;
cd_local_estoque_w		smallint;
ie_disp_esp_cirurgia_w		varchar(1);
IE_DISP_AG_CIRUR_w		varchar(1);
ie_tipo_local_w			integer;
ie_baixa_disp_w			varchar(1);
ie_estoque_lote_w		material_estab.ie_estoque_lote%type;
nr_seq_lote_w			material_lote_fornec.nr_sequencia%type;

c01 CURSOR FOR
SELECT	/*+ index (s salesto_i2) */	distinct cd_local_estoque
from	fornecedor_mat_consignado
where	cd_estabelecimento	= cd_estabelecimento_p
and	cd_material		= cd_material_w
and	dt_mesano_referencia	= PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0)
and	cd_local_estoque	= cd_local_estoque_p
and	coalesce(cd_local_estoque_p,0) > 0

union

select	/*+ index (s salesto_i2) */	distinct cd_local_estoque
from	fornecedor_mat_consignado
where	cd_estabelecimento	= cd_estabelecimento_p
and	cd_material		= cd_material_w
and	dt_mesano_referencia	= PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0)
and	coalesce(cd_local_estoque_p,0) = 0;

c02 CURSOR FOR
SELECT	/*+ index (s salesto_i2) */	distinct cd_local_estoque
from	fornecedor_mat_consig_lote
where	cd_estabelecimento	= cd_estabelecimento_p
and	cd_material		= cd_material_w
and	dt_mesano_referencia	= PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0)
and	cd_local_estoque	= cd_local_estoque_p
and	nr_seq_lote		= nr_seq_lote_w
and	coalesce(cd_local_estoque_p,0) > 0

union

select	/*+ index (s salesto_i2) */	distinct cd_local_estoque
from	fornecedor_mat_consig_lote
where	cd_estabelecimento	= cd_estabelecimento_p
and	cd_material		= cd_material_w
and	dt_mesano_referencia	= PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0)
and	nr_seq_lote		= nr_seq_lote_w
and	coalesce(cd_local_estoque_p,0) = 0;


BEGIN

select	max(cd_material_estoque)
into STRICT	cd_material_w
from	material
where	cd_material = cd_material_p;

nr_seq_lote_w := coalesce(nr_seq_lote_p,0);

if (nr_seq_lote_w > 0) then
	select	coalesce(max(ie_estoque_lote),'N')
	into STRICT	ie_estoque_lote_w
	from	material_estab
	where	cd_material = cd_material_w
	and	cd_estabelecimento = cd_estabelecimento_p;
end if;

if (ie_estoque_lote_w = 'N') or (nr_seq_lote_w <= 0) then
	select	obter_saldo_estoque_consig(cd_estabelecimento_p,cd_cgc_fornec_p,cd_material_p,cd_local_estoque_p)
	into STRICT	qt_estoque_w
	;
else
	qt_estoque_w := obter_saldo_consig_lote(cd_estabelecimento_p,cd_material_p,cd_local_estoque_p,cd_cgc_fornec_p,PKG_DATE_UTILS.start_of(clock_timestamp(), 'month', 0),nr_seq_lote_w);
end if;

if (qt_estoque_w > 0) then
	begin

	select	coalesce(max(ie_disp_esp_cirurgia),'N'),
		coalesce(max(IE_DISP_AG_CIRUR),'N')
	into STRICT	ie_disp_esp_cirurgia_w,
		IE_DISP_AG_CIRUR_w
	from	parametro_estoque
	where	cd_estabelecimento	= cd_estabelecimento_p;

	select	coalesce(max(qt_conv_estoque_consumo),1)
	into STRICT	qt_conv_estoque_w
	from	material
	where	cd_material = cd_material_w;

	if (ie_estoque_lote_w = 'N') or (nr_seq_lote_w <= 0) then
		begin
		open c01;
		loop
		fetch c01 into
			cd_local_estoque_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

			select	ie_tipo_local,
				coalesce(ie_baixa_disp, 'N')
			into STRICT	ie_tipo_local_w,
				ie_baixa_disp_w
			from 	local_estoque
			where	cd_local_estoque	= cd_local_estoque_w;

			if (ie_disp_esp_cirurgia_w = 'S') and
				((ie_tipo_local_w = 2) or (ie_baixa_disp_w = 'S')) then
				begin

				select	/*+ index (d presmat_i3)*/					coalesce(sum(qt_total_dispensar),0)
				into STRICT	qt_esp_cirurgia_w
				from	setor_atendimento a,
					cirurgia b,
					prescr_medica c,
					prescr_material d,
					material e
				where	b.nr_cirurgia		= c.nr_cirurgia
				and	c.nr_prescricao		= d.nr_prescricao
				and	a.cd_setor_atendimento	= b.cd_setor_atendimento
				and	d.cd_material		= e.cd_material
				and	a.cd_local_estoque	= cd_local_estoque_w
				and	e.cd_material_estoque	= cd_material_w
				and	d.cd_fornec_consignado	= coalesce(cd_cgc_fornec_p,d.cd_fornec_consignado)
				and	d.cd_motivo_baixa	= 0
				and	d.ie_status_cirurgia	in ('CB','AD')
				and	coalesce(d.ie_baixa_estoque_cir::text, '') = '';

				end;
			elsif (ie_disp_esp_cirurgia_w = 'C') then

				select	/*+ index (d presmat_i3)*/					coalesce(sum(qt_total_dispensar),0)
				into STRICT	qt_esp_cirurgia_w
				from	setor_atendimento a,
					cirurgia b,
					prescr_medica c,
					prescr_material d,
					material e
				where	b.nr_cirurgia		= c.nr_cirurgia
				and	c.nr_prescricao		= d.nr_prescricao
				and	a.cd_setor_atendimento	= b.cd_setor_atendimento
				and	d.cd_material		= e.cd_material
				and	coalesce(d.cd_local_estoque, a.cd_local_estoque) = cd_local_estoque_w
				and	e.cd_material_estoque	= cd_material_w
				and	d.cd_fornec_consignado	= coalesce(cd_cgc_fornec_p,d.cd_fornec_consignado)
				and	d.cd_motivo_baixa	= 0
				and	d.ie_status_cirurgia	in ('CB','AD')

				and	coalesce(d.ie_baixa_estoque_cir::text, '') = '';
			end if;

			if (ie_disp_ag_cirur_w = 'S') then
				select	coalesce(sum(qt_total_dispensar),0)
				into STRICT	qt_agenda_cirurgia_w
				from	setor_atendimento c,
					material x,
					prescr_medica b,
					prescr_material a
				where	a.nr_prescricao		= b.nr_prescricao
				and	b.cd_setor_atendimento	= c.cd_setor_atendimento
				and	a.cd_material		= x.cd_material
				and	c.cd_local_estoque	= cd_local_estoque_w
				and	x.cd_material_estoque	= cd_material_w
				and	a.cd_fornec_consignado	= coalesce(cd_cgc_fornec_p,a.cd_fornec_consignado)
				and	a.cd_motivo_baixa	= 0
				and	a.ie_status_cirurgia	= 'CB'
				and	(b.nr_seq_agenda IS NOT NULL AND b.nr_seq_agenda::text <> '')
				and	coalesce(b.nr_cirurgia::text, '') = ''
				and not exists (
					SELECT	1
					from	cirurgia c
					where	c.nr_prescricao = a.nr_prescricao);
			end if;

			qt_cirurgia_w	:= dividir(qt_esp_cirurgia_w + qt_agenda_cirurgia_w,qt_conv_estoque_w);

			end;
		end loop;
		close c01;
		end;
	else
		begin
		open c02;
		loop
		fetch c02 into
			cd_local_estoque_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin

			select	ie_tipo_local,
				coalesce(ie_baixa_disp, 'N')
			into STRICT	ie_tipo_local_w,
				ie_baixa_disp_w
			from 	local_estoque
			where	cd_local_estoque	= cd_local_estoque_w;

			if (ie_disp_esp_cirurgia_w = 'S') and
				((ie_tipo_local_w = 2) or (ie_baixa_disp_w = 'S')) then
				begin

				select	/*+ index (d presmat_i3)*/					coalesce(sum(qt_total_dispensar),0)
				into STRICT	qt_esp_cirurgia_w
				from	setor_atendimento a,
					cirurgia b,
					prescr_medica c,
					prescr_material d,
					material e
				where	b.nr_cirurgia		= c.nr_cirurgia
				and	c.nr_prescricao		= d.nr_prescricao
				and	a.cd_setor_atendimento	= b.cd_setor_atendimento
				and	d.cd_material		= e.cd_material
				and	a.cd_local_estoque	= cd_local_estoque_w
				and	e.cd_material_estoque	= cd_material_w
				and	d.cd_fornec_consignado	= coalesce(cd_cgc_fornec_p,d.cd_fornec_consignado)
				and	d.cd_motivo_baixa	= 0
				and	d.ie_status_cirurgia	in ('CB','AD')
				and	d.nr_seq_lote_fornec	= nr_seq_lote_w
				and	coalesce(d.ie_baixa_estoque_cir::text, '') = '';

				end;
			elsif (ie_disp_esp_cirurgia_w = 'C') then

				select	/*+ index (d presmat_i3)*/					coalesce(sum(qt_total_dispensar),0)
				into STRICT	qt_esp_cirurgia_w
				from	setor_atendimento a,
					cirurgia b,
					prescr_medica c,
					prescr_material d,
					material e
				where	b.nr_cirurgia		= c.nr_cirurgia
				and	c.nr_prescricao		= d.nr_prescricao
				and	a.cd_setor_atendimento	= b.cd_setor_atendimento
				and	d.cd_material		= e.cd_material
				and	coalesce(d.cd_local_estoque, a.cd_local_estoque) = cd_local_estoque_w
				and	e.cd_material_estoque	= cd_material_w
				and	d.cd_fornec_consignado	= coalesce(cd_cgc_fornec_p,d.cd_fornec_consignado)
				and	d.cd_motivo_baixa	= 0
				and	d.ie_status_cirurgia	in ('CB','AD')
				and	d.nr_seq_lote_fornec	= nr_seq_lote_w
				and	coalesce(d.ie_baixa_estoque_cir::text, '') = '';

			end if;

			if (ie_disp_ag_cirur_w = 'S') then
				select	coalesce(sum(qt_total_dispensar),0)
				into STRICT	qt_agenda_cirurgia_w
				from	setor_atendimento c,
					material x,
					prescr_medica b,
					prescr_material a
				where	a.nr_prescricao		= b.nr_prescricao
				and	b.cd_setor_atendimento	= c.cd_setor_atendimento
				and	a.cd_material		= x.cd_material
				and	c.cd_local_estoque	= cd_local_estoque_w
				and	x.cd_material_estoque	= cd_material_w
				and	a.cd_fornec_consignado	= coalesce(cd_cgc_fornec_p,a.cd_fornec_consignado)
				and	a.cd_motivo_baixa	= 0
				and	a.ie_status_cirurgia	= 'CB'
				and	(b.nr_seq_agenda IS NOT NULL AND b.nr_seq_agenda::text <> '')
				and	coalesce(b.nr_cirurgia::text, '') = ''
				and	a.nr_seq_lote_fornec 	= nr_seq_lote_w
				and not exists (
					SELECT	1
					from	cirurgia c
					where	c.nr_prescricao = a.nr_prescricao);
			end if;

			qt_cirurgia_w	:= dividir(qt_esp_cirurgia_w + qt_agenda_cirurgia_w,qt_conv_estoque_w);

			end;
		end loop;
		close c02;
		end;
	end if;
	end;
end if;

qt_retorno_w	:= (qt_estoque_w - qt_cirurgia_w);

return	qt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_saldo_disp_consig ( cd_estabelecimento_p bigint, cd_cgc_fornec_p text, cd_material_p bigint, cd_local_estoque_p bigint, nr_seq_lote_p bigint default null) FROM PUBLIC;

