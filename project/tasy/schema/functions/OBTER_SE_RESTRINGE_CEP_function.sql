-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION obter_se_restringe_cep ( NR_SEQ_FORMA_LAUDO_P grupo_forma_entrega_laudo.nr_sequencia%TYPE, CD_PESSOA_FISICA_P pessoa_fisica.cd_pessoa_fisica%TYPE, CD_ESTABELECIMENTO_P forma_entrega_laudo.cd_estabelecimento%TYPE, CD_CEP_ADICIONAL_P prescr_medica_entrega.cd_cep%TYPE) RETURNS varchar AS $body$
DECLARE

                    
ie_consiste_cep_w          grupo_forma_entrega_laudo.ie_consiste_cep%TYPE;
qt_cep_w                   numeric(30);
qt_cep_adicional_w         numeric(30);
returnCepRestrito          varchar(2) := 'N';


BEGIN

    SELECT b.ie_consiste_cep
    INTO STRICT    ie_consiste_cep_w
    FROM
        forma_entrega_laudo a,
        grupo_forma_entrega_laudo b
    WHERE (a.cd_estabelecimento = cd_estabelecimento_p or coalesce(cd_estabelecimento::text, '') = '')
          AND a.ie_situacao = 'A'
          AND a.nr_seq_grupo = b.nr_sequencia
          AND a.nr_sequencia = nr_seq_forma_laudo_p;

    IF (ie_consiste_cep_w = 'S') THEN
        SELECT COUNT(*)
        INTO STRICT qt_cep_w
        FROM 
            compl_pessoa_fisica a
        WHERE a.cd_pessoa_fisica = cd_pessoa_fisica_p
             AND EXISTS (SELECT * FROM restringe_cep c WHERE a.cd_cep = c.cd_cep and c.ie_ativo = 'A');

        SELECT COUNT(*) 
        INTO STRICT qt_cep_adicional_w
        FROM restringe_cep c 
        WHERE c.ie_ativo = 'A' AND c.cd_cep = cd_cep_adicional_p;

        IF (qt_cep_w > 0 OR qt_cep_adicional_w > 0)THEN
            returnCepRestrito := 'S';
        END IF;
    END IF;

    RETURN returnCepRestrito;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION obter_se_restringe_cep ( NR_SEQ_FORMA_LAUDO_P grupo_forma_entrega_laudo.nr_sequencia%TYPE, CD_PESSOA_FISICA_P pessoa_fisica.cd_pessoa_fisica%TYPE, CD_ESTABELECIMENTO_P forma_entrega_laudo.cd_estabelecimento%TYPE, CD_CEP_ADICIONAL_P prescr_medica_entrega.cd_cep%TYPE) FROM PUBLIC;

