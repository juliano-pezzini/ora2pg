-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE FUNCTION man_sla_previsao (nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, ie_prioridade_p man_ordem_servico.ie_prioridade%type, ie_retorno_p text) RETURNS varchar AS $body$
DECLARE


/* 
IE_PRIORIDADE_P =
E - Emergencia
A - Alta
M - Media
B - Baixa
S - Sem prioridade

IE_RETORNO_P =
T - Tempo
S - Status
*/
ie_classificacao_w	    man_ordem_servico.ie_classificacao%type;
nr_seq_localizacao_w	  man_ordem_servico.nr_seq_localizacao%type;
regra_sla_w             man_sla.nr_sequencia%type;
qt_min_termino_regra_w  man_sla_regra.qt_min_termino%type;
qt_min_rest_solucao_w	  man_sla_regra.qt_min_termino%type;
ds_retorno_w            man_ordem_servico.ds_dano_breve%type;


BEGIN
begin

select  max(sla_dashboard_pck.obter_regra_sla(1,
				nr_sequencia,
				nm_usuario,
				ie_prioridade_p,
				ie_classificacao,
				nr_seq_localizacao,
				nr_grupo_trabalho, 
				dt_ordem_servico,
				dt_inicio_real, 
				nr_seq_estagio,
				nr_seq_equipamento, 
				nr_seq_classif, 
				ie_parado,
				ie_ambiente)) regra_sla,
				max(ie_classificacao),
				max(nr_seq_localizacao)
into STRICT    regra_sla_w,
	ie_classificacao_w,
	nr_seq_localizacao_w
from    man_ordem_servico 
where   nr_sequencia = nr_seq_ordem_serv_p;
exception
when    no_data_found then return null;

end;

if (coalesce(regra_sla_w, 0) = 0 and ie_classificacao_w = 'E' and nr_seq_localizacao_w <> 41) then
	regra_sla_w := sla_dashboard_pck.obter_regra_alldef(sla_dashboard_pck.obter_nr_seq_regra_alldef(), ie_classificacao_w, ie_prioridade_p);
end if;

begin

select	max(b.qt_min_termino)
into STRICT	qt_min_termino_regra_w
from	man_sla_regra b
where	nr_sequencia = regra_sla_w;

end;

qt_min_rest_solucao_w := qt_min_termino_regra_w - sla_dashboard_pck.obter_qt_min_sol(nr_seq_ordem_serv_p);

begin
case ie_retorno_p
        when 'T' then
                select  man_obter_tempo_sla_formatado(qt_min_rest_solucao_w)
                into STRICT	ds_retorno_w
;

        when 'S' then
                if (qt_min_rest_solucao_w < 0 ) then
                        ds_retorno_w :=	'Breached';
                elsif (qt_min_rest_solucao_w < 390) then
                        ds_retorno_w :=	'Critical';
                elsif (qt_min_rest_solucao_w >= 390 ) and (qt_min_rest_solucao_w <= 1440 ) then
                        ds_retorno_w :=	'Warning';
                elsif (qt_min_rest_solucao_w > 1440) then
                        ds_retorno_w :=	'Good';
                end if;

        else null;
   end case;
end;

return ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION man_sla_previsao (nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, ie_prioridade_p man_ordem_servico.ie_prioridade%type, ie_retorno_p text) FROM PUBLIC;

