-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS reg_intencao_uso_after ON reg_intencao_uso CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_reg_intencao_uso_after() RETURNS trigger AS $BODY$
declare

ie_tipo_alteracao_w		reg_intencao_uso_hist.ie_tipo_alteracao%type;
nr_seq_gerencia_w     reg_intencao_uso_lib.nr_seq_gerencia%type;
nr_seq_diretoria_w    reg_intencao_uso_lib.nr_seq_diretoria%type;
qt_reg_w				smallint;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'N')  then
	goto fim;
end if;

if (TG_OP = 'INSERT') then
	ie_tipo_alteracao_w := 'I';

	BEGIN
		select	ger.nr_sequencia,
			ger.nr_seq_diretoria
		into STRICT	nr_seq_gerencia_w,
			nr_seq_diretoria_w
		from	gerencia_wheb ger
		where	ger.nr_sequencia in (	SELECT	max(gru.nr_seq_gerencia)
						from	gerencia_wheb_grupo_usu usu,
							gerencia_wheb_grupo gru
						where	usu.nr_seq_grupo = gru.nr_sequencia
						and	coalesce(gru.ie_situacao, 'A') = 'A'
						and	usu.nm_usuario_grupo = NEW.nm_usuario);
	exception
	when others then
		nr_seq_gerencia_w := null;
		nr_seq_diretoria_w := null;
	end;

  insert into reg_intencao_uso_lib(
    nr_sequencia,
    nr_seq_intencao_uso,
    nr_seq_gerencia,
    nr_seq_diretoria,
    nm_usuario,
    nm_usuario_nrec,
    dt_atualizacao,
    dt_atualizacao_nrec,
    cd_perfil)
  values (
    nextval('reg_intencao_uso_lib_seq'),
    NEW.nr_sequencia,
    nr_seq_gerencia_w,
    nr_seq_diretoria_w,
    NEW.nm_usuario,
    NEW.nm_usuario,
    LOCALTIMESTAMP,
    LOCALTIMESTAMP,
    null);

elsif (TG_OP = 'UPDATE') and (NEW.ie_situacao = 'I') then
	ie_tipo_alteracao_w := 'E';
else
	ie_tipo_alteracao_w := 'A';
end if;

insert into reg_intencao_uso_hist(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ds_briefing,
	ds_obs_briefing,
	cd_versao,
	nr_seq_reg_version_rev,
	ds_descricao,
	dt_aprovacao,
	ie_situacao,
	ds_intencao_uso,
	nr_seq_intencao_uso,
	nr_seq_estagio,
	ie_tipo_alteracao)
values (
	nextval('reg_intencao_uso_hist_seq'),
	NEW.dt_atualizacao,
	NEW.nm_usuario,
	NEW.dt_atualizacao_nrec,
	NEW.nm_usuario_nrec,
	NEW.ds_briefing,
	NEW.ds_obs_briefing,
	NEW.cd_versao,
	null,
	NEW.ds_descricao,
	NEW.dt_aprovacao,
	NEW.ie_situacao,
	NEW.ds_intencao_uso,
	NEW.nr_sequencia,
	NEW.nr_seq_estagio,
	ie_tipo_alteracao_w);

<<fim>>
qt_reg_w := 0;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_reg_intencao_uso_after() FROM PUBLIC;

CREATE TRIGGER reg_intencao_uso_after
	AFTER INSERT OR UPDATE ON reg_intencao_uso FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_reg_intencao_uso_after();

