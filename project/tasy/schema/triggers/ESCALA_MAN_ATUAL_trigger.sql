-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_man_atual ON escala_man CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_man_atual() RETURNS trigger AS $BODY$
declare
qt_imc_w		double precision;
qt_selecionado_w	bigint;
BEGIN


--Consiste_Liberacao_Escala(60);
if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
	BEGIN
	NEW.nr_hora	:= (to_char(round(NEW.DT_AVALIACAO,'hh24'),'hh24'))::numeric;
	end;
end if;

NEW.qt_pontuacao		:= 0;
NEW.qt_pontuacao_triagem	:= 0;
NEW.qt_pontuacao_aval_glob	:= 0;


qt_imc_w	:= dividir(NEW.qt_peso,(NEW.qt_altura /100) * (NEW.qt_altura /100));


if (qt_imc_w	>=19) and (qt_imc_w	<21) then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 1;
	NEW.qt_pontuacao_triagem	:= NEW.qt_pontuacao_triagem + 1;
elsif (qt_imc_w	>=21) and (qt_imc_w	< 23) then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 2;
	NEW.qt_pontuacao_triagem	:= NEW.qt_pontuacao_triagem + 2;
elsif (qt_imc_w	>=23) then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 3;
	NEW.qt_pontuacao_triagem	:= NEW.qt_pontuacao_triagem + 3;
end if;

NEW.qt_imc := qt_imc_w;

if (NEW.qt_circun_braco	>=21) and (NEW.qt_circun_braco	<= 22) then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 0.5;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 0.5;

elsif (NEW.qt_circun_braco	> 22) then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 1;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 1;
end if;

if (NEW.qt_circun_panturrilha	>=31) then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 1;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 1;
end if;

if (NEW.IE_SOZINHO	= 'S') then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 1;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 1;
end if;

if (NEW.IE_STRESS	= 'N') then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 2;
	NEW.qt_pontuacao_triagem	:= NEW.qt_pontuacao_triagem + 2;
end if;

if (NEW.IE_TRES_MEDICAMENTOS	= 'N') then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 1;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 1;
end if;

if (NEW.IE_ESCARAS	= 'N') then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 1;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 1;
end if;


if (NEW.IE_FRUTA	= 'S') then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 1;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 1;
end if;


qt_selecionado_w	:= 0;

if (NEW.IE_LACTEO	= 'S') then
	qt_selecionado_w	:= qt_selecionado_w + 1;
end if;

if (NEW.IE_LEGUME	= 'S') then
	qt_selecionado_w	:= qt_selecionado_w + 1;
end if;

if (NEW.IE_CARNE	= 'S') then
	qt_selecionado_w	:= qt_selecionado_w + 1;
end if;

if (qt_selecionado_w	= 2) then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 0.5;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 0.5;
elsif (qt_selecionado_w	= 3) then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 1;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 1;
end if;

NEW.qt_pontuacao		:= NEW.qt_pontuacao + NEW.IE_PERDA_PESO;
NEW.qt_pontuacao_triagem	:= NEW.qt_pontuacao_triagem + NEW.IE_PERDA_PESO;
NEW.qt_pontuacao		:= NEW.qt_pontuacao + NEW.IE_MOBILIDADE;
NEW.qt_pontuacao_triagem	:= NEW.qt_pontuacao_triagem + NEW.IE_MOBILIDADE;
NEW.qt_pontuacao		:= NEW.qt_pontuacao + NEW.IE_NEUROLOGICO;
NEW.qt_pontuacao_triagem	:= NEW.qt_pontuacao_triagem + NEW.IE_NEUROLOGICO;
NEW.qt_pontuacao		:= NEW.qt_pontuacao + NEW.QT_REFEICAO;
NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + NEW.QT_REFEICAO;
NEW.qt_pontuacao		:= NEW.qt_pontuacao + NEW.IE_DECLINEO_INGESTAO;
NEW.qt_pontuacao_triagem	:= NEW.qt_pontuacao_triagem + NEW.IE_DECLINEO_INGESTAO;
NEW.qt_pontuacao		:= NEW.qt_pontuacao + NEW.IE_FORMA_ALIMENTACAO;
NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + NEW.IE_FORMA_ALIMENTACAO;
NEW.qt_pontuacao		:= NEW.qt_pontuacao + NEW.IE_PAC_PROBL_NUTRICIONAL;
NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + NEW.IE_PAC_PROBL_NUTRICIONAL;

if (NEW.IE_COMP_IDADE	= '1') then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 0.5;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 0.5;
elsif (NEW.IE_COMP_IDADE	= '2') then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 1;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 1;
elsif (NEW.IE_COMP_IDADE	= '3') then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 2;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 2;
end if;

if (NEW.QT_LIQUIDO	= 1) then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 0.5;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 0.5;
elsif (NEW.qt_liquido	= 2) then
	NEW.qt_pontuacao		:= NEW.qt_pontuacao + 1;
	NEW.qt_pontuacao_aval_glob	:= NEW.qt_pontuacao_aval_glob + 1;
end if;

if (NEW.qt_pontuacao_triagem >= 12)
 and (NEW.IE_SOZINHO is null)
 and (NEW.IE_TRES_MEDICAMENTOS is null)
 and (NEW.IE_ESCARAS is null)
 and (NEW.QT_REFEICAO is null)
 and (NEW.IE_FRUTA is null)
 and (NEW.QT_LIQUIDO is null)
 and (NEW.IE_FORMA_ALIMENTACAO is null)
 and (NEW.IE_PAC_PROBL_NUTRICIONAL is null)
 and (NEW.IE_COMP_IDADE is null) then

 	NEW.QT_PONTUACAO	:= NEW.qt_pontuacao_triagem;

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_man_atual() FROM PUBLIC;

CREATE TRIGGER escala_man_atual
	BEFORE INSERT OR UPDATE ON escala_man FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_man_atual();

