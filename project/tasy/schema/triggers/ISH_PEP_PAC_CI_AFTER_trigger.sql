-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS ish_pep_pac_ci_after ON pep_pac_ci CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_ish_pep_pac_ci_after() RETURNS trigger AS $BODY$
declare

reg_integracao_w      gerar_int_padrao.reg_integracao;
nr_seq_episodio_w     atendimento_paciente.nr_seq_episodio%type;
cd_pessoa_fisica_w    atendimento_paciente.cd_pessoa_fisica%type;

BEGIN

select	max(nr_seq_episodio),
	max(cd_pessoa_fisica)
into STRICT	nr_seq_episodio_w,
	cd_pessoa_fisica_w
from	atendimento_paciente
where	nr_atendimento  =  coalesce(NEW.nr_atendimento, OLD.nr_atendimento);

reg_integracao_w.cd_pessoa_fisica	:=	cd_pessoa_fisica_w;
reg_integracao_w.nr_atendimento		:=	coalesce(NEW.nr_atendimento, OLD.nr_atendimento);
reg_integracao_w.ie_operacao		:=	'A';

if	((get_case_encounter_type(null, null, reg_integracao_w.nr_atendimento, null) = '1') and (OLD.dt_liberacao is null and NEW.dt_liberacao is not null)) then
	reg_integracao_w := gerar_int_padrao.gravar_integracao('106', nr_seq_episodio_w, coalesce(NEW.nm_usuario, OLD.nm_usuario), reg_integracao_w);
end if;

IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_ish_pep_pac_ci_after() FROM PUBLIC;

CREATE TRIGGER ish_pep_pac_ci_after
	AFTER INSERT OR UPDATE OR DELETE ON pep_pac_ci FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_ish_pep_pac_ci_after();

