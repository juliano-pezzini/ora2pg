-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS med_treatment_plan_afinsert ON med_treatment_plan CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_med_treatment_plan_afinsert() RETURNS trigger AS $BODY$
declare

nr_sequencia_w	med_treat_plan_rules.nr_sequencia%type;

C01 CURSOR FOR
SELECT	ds_who_confirm_plan,
	sy_requires_confirmation
from	med_treat_plan_rules_conf
where	nr_seq_rule = nr_sequencia_w;
c01_w	c01%rowtype;


BEGIN

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_sequencia_w
from	med_treat_plan_rules
where	sy_type_form = NEW.si_type_form
and	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

if (nr_sequencia_w > 0) then

	open C01;
	loop
	fetch C01 into	
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		BEGIN
		
		insert into med_treatment_plan_conf(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_med_treat_plan,
			ds_who_confirm_plan,
			sy_requires_confirmation)
		values (	nextval('med_treatment_plan_conf_seq'),
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			NEW.nr_sequencia,
			c01_w.ds_who_confirm_plan,
			c01_w.sy_requires_confirmation);
		
		end;
	end loop;
	close C01;

end if;
	
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_med_treatment_plan_afinsert() FROM PUBLIC;

CREATE TRIGGER med_treatment_plan_afinsert
	AFTER INSERT ON med_treatment_plan FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_med_treatment_plan_afinsert();

