-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_atend_paciente_delete ON material_atend_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_atend_paciente_delete() RETURNS trigger AS $BODY$
declare
ie_status_acerto_w		smallint;
ds_module_w 		varchar(255);
osuser_w			varchar(100);
osuser_log_w		varchar(100);
ds_module_log_w		varchar(255);
ie_integracao_opme_w	varchar(1);
ie_baixa_estoq_pac_w	varchar(1);
dt_geracao_resumo_w	timestamp;
ds_call_stack_w		varchar(2000);
ie_consignado_w		material.ie_consignado%type;

/* Adicionei esta variavel para pegar o usuario que esta excluindo, estornando o movimento.*/




nm_usuario_exclusao_w	varchar(15) := wheb_usuario_pck.get_nm_usuario();

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

if (OLD.nr_interno_conta is not null) then
	BEGIN
	select max(ie_status_acerto)
	into STRICT	ie_status_acerto_w
	from	conta_paciente
	where	nr_interno_conta	= OLD.nr_interno_conta;
	if (ie_status_acerto_w = 2) then		
		--Conta do Paciente ja fechada !


		CALL Wheb_mensagem_pck.exibir_mensagem_abort(195615);
	end if;
	end;
end if;

select obter_se_baixa_estoque_pac(OLD.cd_setor_atendimento, coalesce(OLD.cd_material_exec, OLD.cd_material), OLD.nr_seq_ordem_prod, 0)
into STRICT	ie_baixa_estoq_pac_w
;

if (coalesce(ie_baixa_estoq_pac_w,'N') = 'S') and (OLD.cd_local_estoque is not null) and (OLD.dt_atualizacao_estoque is not null)	then
    	BEGIN

	CALL gerar_prescricao_estoque(
				null,
				OLD.nr_atendimento,
				OLD.dt_entrada_unidade,
				coalesce(OLD.cd_material_exec, OLD.cd_material), /*fabio 16/01/2006 coloquei o nvl os28239*/

				OLD.dt_atendimento,
				OLD.cd_acao,
				OLD.cd_local_estoque,
				coalesce(OLD.qt_estoque, OLD.qt_material),
				OLD.cd_setor_atendimento,
				OLD.cd_unidade_medida,
				coalesce(nm_usuario_exclusao_w, OLD.nm_usuario), -- Usuario que realizou a exclusao do item, estornou o movimento

				'E',
				OLD.nr_prescricao,
                  			OLD.nr_sequencia_prescricao,
				OLD.nr_seq_proc_princ,
				OLD.nr_sequencia,
				OLD.cd_cgc_fornecedor,
				OLD.ds_observacao,
				OLD.nr_seq_lote_fornec,
				OLD.nr_receita,
				OLD.nr_serie_material,
				null, '','','');
	end;
end if;
if (OLD.nr_prescricao is not null) and (OLD.nr_seq_origem is null) and (OLD.nr_seq_mat_glosa is null)	then
	select	coalesce(max(ie_consignado),'0')
	into STRICT	ie_consignado_w
	from	material
	where	cd_material = OLD.cd_material;
	
	if (obter_funcao_ativa <> 36) then
		ie_consignado_w := '0';
	end if;
	
	update	prescr_material a
	set	a.dt_baixa  = NULL,
		a.cd_motivo_baixa = 0,
		a.cd_fornec_consignado = CASE WHEN ie_consignado_w='2' THEN null  ELSE a.cd_fornec_consignado END
	where	a.nr_prescricao  = OLD.nr_prescricao
	and	a.nr_sequencia   = OLD.nr_sequencia_prescricao;
end if;

/*select	max(module||' - ' || machine||' - ' || program|| ' - ' || osuser|| ' - ' || terminal),
	max(osuser)
into	ds_module_w,
	osuser_w
from	v$session
where	audsid = (select userenv('sessionid') from dual)
and 	upper(program) not like '%TASY%';

if	(ds_module_w is not null) then
	insert into log_exclusao(nm_tabela, dt_atualizacao, nm_usuario, ds_chave) 
			values ('MATERIAL_ATEND_PACIENTE', sysdate, osuser_w, 'Conta: ' || :old.nr_interno_conta || '  ' ||
				'Material: ' || :old.cd_material || '  ' || ds_module_w);
end if;*/



select	substr(max(module||' - ' || machine||' - ' || program|| ' - ' || osuser|| ' - ' || terminal),1,255),
	substr(max(osuser),1,100)
into STRICT	ds_module_log_w,
	osuser_log_w
from	v$session
where	audsid = (SELECT userenv('sessionid') );

ie_integracao_opme_w := obter_param_usuario(24, 234, obter_perfil_ativo, NEW.nm_usuario, 0, ie_integracao_opme_w);

if (coalesce(ie_integracao_opme_w,'N') = 'S') and (OLD.nr_sequencia is not null) then
	CALL exclui_item_integracao_opme(OLD.nr_sequencia);
end if;

ds_call_stack_w	:= substr(dbms_utility.format_call_stack,1,1800);

insert	into mat_atend_pac_log(
	nr_sequencia,
	nr_seq_mat,
	dt_atualizacao,	
	nm_usuario,
	ds_module,
	nr_atendimento,
	nr_interno_conta,
	cd_material,
	dt_atendimento,
	ie_acao,
	qt_material,
	vl_material,
	cd_perfil,
	cd_funcao,
	ie_valor_informado,
	nr_seq_proc_pacote,
	nr_seq_proc_princ,
	cd_setor_atendimento,
	dt_entrada_unidade,
	nr_seq_atepacu,
	nr_prescricao,
	cd_local_estoque,
	ds_call_stack)
values (nextval('mat_atend_pac_log_seq'),
	OLD.nr_sequencia,
	LOCALTIMESTAMP,
	coalesce(wheb_usuario_pck.get_nm_usuario,substr(osuser_log_w,1,15)),
	ds_module_log_w,
	OLD.nr_atendimento,
	OLD.nr_interno_conta,
	OLD.cd_material,
	OLD.dt_atendimento,
	'E',
	OLD.qt_material,
	OLD.vl_material,
	obter_perfil_ativo,
	obter_funcao_ativa,
	OLD.ie_valor_informado,
	OLD.nr_seq_proc_pacote,
	OLD.nr_seq_proc_princ,
	OLD.cd_setor_atendimento,
	OLD.dt_entrada_unidade,
	OLD.nr_seq_atepacu,
	OLD.nr_prescricao,
	OLD.cd_local_estoque,
	ds_call_stack_w);
	
-- OS 465559

if (OLD.nr_interno_conta is not null) then
	
	select	max(dt_geracao_resumo)
	into STRICT	dt_geracao_resumo_w
	from 	conta_paciente
	where 	nr_interno_conta = OLD.nr_interno_conta;
	
	if (dt_geracao_resumo_w is not null) then
		
		update	conta_paciente
		set 	dt_geracao_resumo  = NULL
		where 	nr_interno_conta = OLD.nr_interno_conta;
		
	end if;
	
end if;

CALL avisar_material_excluido(OLD.cd_material, OLD.nm_usuario, OLD.nr_atendimento);

end if;

RETURN OLD;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_atend_paciente_delete() FROM PUBLIC;

CREATE TRIGGER material_atend_paciente_delete
	BEFORE DELETE ON material_atend_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_atend_paciente_delete();

