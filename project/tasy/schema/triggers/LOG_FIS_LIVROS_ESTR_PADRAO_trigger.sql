-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS log_fis_livros_estr_padrao ON fis_livros_estr_padrao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_log_fis_livros_estr_padrao() RETURNS trigger AS $BODY$
declare

ds_historico_w		varchar(2000);
ds_erro_w		varchar(4000);
ds_operacao		varchar(10);
BEGIN
  BEGIN
	BEGIN
		if (TG_OP = 'INSERT') then
			ds_operacao := 'Insert';
		else 	if (TG_OP = 'UPDATE') then
				ds_operacao := 'Update';
			else
				ds_operacao := 'Delete';
			end if;
		end if;

		select 	substr(ds_operacao || ' na estrutura dos livros (LALUR/LACS): '|| chr(13) || chr(10)||
			'Sequência anterior: ' || OLD.nr_sequencia || ' | Sequência atual: ' || NEW.nr_sequencia || chr(13) || chr(10)||
			'Descrição anterior: ' || OLD.ds_estrutura || ' | Descrição atual: ' || NEW.ds_estrutura || chr(13) || chr(10)||
			'Livro anterior: ' || OLD.ie_lalur_lacs || ' | Livro atual: ' || NEW.ie_lalur_lacs || chr(13) || chr(10)||
			'Tipo anterior: ' || OLD.ie_tipo_estrutura || ' | tipo atual: ' || NEW.ie_tipo_estrutura || chr(13) || chr(10)||
			CASE WHEN OLD.nr_seq_superior=NEW.nr_seq_superior THEN  null  ELSE 'Seq superior anterior: ' || OLD.nr_seq_superior || ' | Seq superior atual: ' || NEW.nr_seq_superior || chr(13) || chr(10) END  ||
			CASE WHEN OLD.nr_seq_ordem=NEW.nr_seq_ordem THEN  null  ELSE 'Seq ordem anterior: ' || OLD.nr_seq_ordem || ' | Seq ordem atual: ' || NEW.nr_seq_ordem || chr(13) || chr(10) END  ||
			CASE WHEN OLD.ie_situacao=NEW.ie_situacao THEN  null  ELSE 'Situação anterior: ' || OLD.ie_situacao || ' | Situação atual: ' || NEW.ie_situacao|| chr(13) || chr(10) END  ||
			CASE WHEN OLD.ie_forma_apuracao=NEW.ie_forma_apuracao THEN  null  ELSE 'Forma apuração anterior: ' || OLD.ie_forma_apuracao || ' | Forma apuração atual: ' || NEW.ie_forma_apuracao || chr(13) || chr(10) END  ||
			CASE WHEN OLD.ie_permite_editar=NEW.ie_permite_editar THEN  null  ELSE 'Permite edição anterior: ' || OLD.ie_permite_editar || ' | Permite edição atual: ' || NEW.ie_permite_editar || chr(13) || chr(10) END  ||
			CASE WHEN OLD.ie_gerar_ecf=NEW.ie_gerar_ecf THEN  null  ELSE 'Registros ECF anterior: ' || OLD.ie_gerar_ecf || ' | Registros ECF atual: ' || NEW.ie_gerar_ecf || chr(13) || chr(10) END  ||
			CASE WHEN OLD.cd_codigo_ecf=NEW.cd_codigo_ecf THEN  null  ELSE 'Código ECF anterior: ' || OLD.cd_codigo_ecf || ' | Código ECF atual: ' || NEW.cd_codigo_ecf || chr(13) || chr(10) END  ||
			CASE WHEN OLD.ie_gerar_ecf_n=NEW.ie_gerar_ecf_n THEN  null  ELSE 'Registros ECF(Bloco N anual) anterior: ' || OLD.ie_gerar_ecf_n || ' | Registros ECF(Bloco N anual) atual: ' || NEW.ie_gerar_ecf_n || chr(13) || chr(10) END  ||
			CASE WHEN OLD.cd_codigo_bloco_n=NEW.cd_codigo_bloco_n THEN  null  ELSE 'Código ECF (Bloco N anual) anterior: ' || OLD.cd_codigo_bloco_n || ' | Código ECF (Bloco N anual) atual: ' || NEW.cd_codigo_bloco_n END ,1,2000)
		into STRICT	ds_historico_w
		;

		CALL gravar_log_tasy(1908, ds_historico_w, wheb_usuario_pck.get_nm_usuario);

	exception
		when others then
			ds_erro_w := sqlerrm(SQLSTATE);
			CALL gravar_log_tasy(1908, 'Erro ao gravar log de Alteração da estrutura dos livros (LALUR/LACS): '|| chr(13) || chr(10)|| ds_erro_w, wheb_usuario_pck.get_nm_usuario);
	end;
  END;
IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_log_fis_livros_estr_padrao() FROM PUBLIC;

CREATE TRIGGER log_fis_livros_estr_padrao
	BEFORE INSERT OR UPDATE OR DELETE ON fis_livros_estr_padrao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_log_fis_livros_estr_padrao();

