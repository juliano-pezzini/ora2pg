-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS log_dc_interface_aftinsert ON log_dc_interface CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_log_dc_interface_aftinsert() RETURNS trigger AS $BODY$
declare
qt_reg_w	bigint;
BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;


if (NEW.ds_event  in ('directcontrol.oec','directcontrol.oec.resend','directcontrol.private.fund.eligibilitycheck')) and (NEW.ie_request_response = 'D') and (NEW.ds_message like '%success=false%') and (NEW.invoice_id is not null)	then

	insert into autorizacao_convenio_hist(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		nr_atendimento,
		nr_seq_autorizacao,
		ds_historico,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_sequencia_autor) values (
		nextval('autorizacao_convenio_hist_seq'),
		LOCALTIMESTAMP,
		'DCInterface',
		null,
		null,
		substr(NEW.ds_message,1,4000),
		LOCALTIMESTAMP,
		'DCInterface',
		NEW.invoice_id);
		
end if;

if  ((NEW.ds_event ='directcontrol.transmitclaim') or (NEW.ds_event = 'directcontrol.encounter.billing')) and (NEW.ie_request_response = 'D') and (NEW.ds_message like '%success=false%') and (NEW.invoice_id is not null)	then
	
	insert into eclipse_claim_history(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_interno_conta,
		ds_historico) values (
		nextval('eclipse_claim_history_seq'),
		LOCALTIMESTAMP,
		'DCInterface',
		LOCALTIMESTAMP,
		'DCInterface',		
		NEW.invoice_id,
		substr(NEW.ds_message,1,4000));
		
end if;

<<Final>>
qt_reg_w	:= 0;


RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_log_dc_interface_aftinsert() FROM PUBLIC;

CREATE TRIGGER log_dc_interface_aftinsert
	AFTER INSERT ON log_dc_interface FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_log_dc_interface_aftinsert();

