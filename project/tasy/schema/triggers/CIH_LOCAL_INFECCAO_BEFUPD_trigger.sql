-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cih_local_infeccao_befupd ON cih_local_infeccao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cih_local_infeccao_befupd() RETURNS trigger AS $BODY$
declare
 
cd_caso_infeccao_w		bigint;
nr_seq_evento_infeccao_w bigint;
nr_atendimento_w		bigint;
cd_estabelecimento_w	bigint;
ie_evento_topografia_w		varchar(1);
 
c01 CURSOR FOR 
SELECT	cd_caso_infeccao, 
		nr_seq_evento_infeccao 
from	cih_parametros;	
 
BEGIN 
 
ie_evento_topografia_w := Obter_Param_Usuario(1302, 47, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_evento_topografia_w);
 
OPEN C01;
LOOP 
FETCH C01 into 
	cd_caso_infeccao_w, 
	nr_seq_evento_infeccao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
if (cd_caso_infeccao_w is not null) then 
 
	if (NEW.cd_caso_infeccao = cd_caso_infeccao_w) and 
		((OLD.cd_caso_infeccao <> cd_caso_infeccao_w) or 
		(OLD.cd_topografia <> NEW.cd_topografia AND ie_evento_topografia_w = 'S')) then 
	 
		select	a.nr_atendimento, 
			a.cd_estabelecimento 
		into STRICT	nr_atendimento_w, 
			cd_estabelecimento_w 
		from	atendimento_paciente a, 
			cih_ficha_ocorrencia c 
		where	c.nr_atendimento	= a.nr_atendimento 
		and	c.nr_ficha_ocorrencia	= NEW.nr_ficha_ocorrencia;
			 
		CALL gerar_evento_infeccao_trig(NEW.nm_usuario, nr_atendimento_w, cd_estabelecimento_w, NEW.cd_topografia, NEW.cd_caso_infeccao, NEW.cd_clinica, nr_seq_evento_infeccao_w);
		 
	end if;
 
end if;
END LOOP;
CLOSE C01;
 
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cih_local_infeccao_befupd() FROM PUBLIC;

CREATE TRIGGER cih_local_infeccao_befupd
	BEFORE UPDATE ON cih_local_infeccao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cih_local_infeccao_befupd();

