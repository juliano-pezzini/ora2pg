-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS orcamento_pac_proc_insert ON orcamento_paciente_proc CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_orcamento_pac_proc_insert() RETURNS trigger AS $BODY$
declare

cd_estabelecimento_w		smallint;
ie_atualiza_dias_exame_w	varchar(2):= 'N';

BEGIN

select 	coalesce(max(cd_estabelecimento), wheb_usuario_pck.get_cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from 	orcamento_paciente
where 	nr_sequencia_orcamento = NEW.nr_sequencia_orcamento;

ie_atualiza_dias_exame_w := coalesce(Obter_valor_param_usuario(106, 121, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w),'N');

if (ie_atualiza_dias_exame_w = 'S') and (coalesce(NEW.nr_seq_exame,0) > 0) then
	NEW.qt_dias_entrega_exame:= obter_exame_lab_regra_setor(cd_estabelecimento_w, NEW.nr_seq_exame, 'QTDE');
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_orcamento_pac_proc_insert() FROM PUBLIC;

CREATE TRIGGER orcamento_pac_proc_insert
	BEFORE INSERT ON orcamento_paciente_proc FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_orcamento_pac_proc_insert();

