-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_pagar_adiant_insert ON titulo_pagar_adiant CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_pagar_adiant_insert() RETURNS trigger AS $BODY$
DECLARE

cd_estabelecimento_w		integer;
ie_altera_valor_tit_escrit_w	varchar(1);
qt_registro_w			integer;
vl_saldo_juros_w	double precision;
vl_saldo_multa_w	double precision;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
select	max(cd_estabelecimento),
	coalesce(max(vl_saldo_juros),0),
	coalesce(max(vl_saldo_multa),0)
into STRICT	cd_estabelecimento_w,
	vl_saldo_juros_w,
	vl_saldo_multa_w
from	titulo_pagar
where	nr_titulo	= NEW.nr_titulo;

vl_saldo_juros_w := vl_saldo_juros_w - NEW.vl_juros;
vl_saldo_multa_w := vl_saldo_multa_w - NEW.vl_multa;

if (vl_saldo_juros_w < 0) then
	vl_saldo_juros_w := 0;
end if;

if (vl_saldo_multa_w < 0) then
	vl_saldo_multa_w := 0;
end if;

update	titulo_pagar
set	vl_saldo_juros = coalesce(vl_saldo_juros_w,0),
	vl_saldo_multa = coalesce(vl_saldo_multa_w,0)
where	nr_titulo = NEW.nr_titulo;

/* nao deixar salvar se tem registro na titulo_pagar_adiant vinculado ao titulo */



select	coalesce(max(ie_altera_valor_tit_escrit),'S')
into STRICT	ie_altera_valor_tit_escrit_w
from	parametros_contas_pagar
where	cd_estabelecimento	= cd_estabelecimento_w;

if (ie_altera_valor_tit_escrit_w = 'N') then

	select	count(*)
	into STRICT	qt_registro_w
	from	titulo_pagar_escrit
	where	nr_titulo	= NEW.nr_titulo;

	if (qt_registro_w > 0) then
		/* Titulo ja vinculado a uma remessa de pagamento escritural.
		O mesmo so pode ser baixado pela funcao "Pagamento escritural".
		Titulo: :new.nr_titulo */

		CALL wheb_mensagem_pck.exibir_mensagem_abort(262125,'NR_TITULO_W='||NEW.nr_titulo);
	end if;
end if;
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_pagar_adiant_insert() FROM PUBLIC;

CREATE TRIGGER titulo_pagar_adiant_insert
	BEFORE INSERT ON titulo_pagar_adiant FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_pagar_adiant_insert();

