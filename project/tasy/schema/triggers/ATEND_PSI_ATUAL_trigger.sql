-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_psi_atual ON atend_psi CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_psi_atual() RETURNS trigger AS $BODY$
declare
  EXEC_w                   varchar(500);
  ie_sexo_w	               varchar(1);

	qt_esc_ano_w             bigint := 0;
	qt_esc_enf_w             bigint := 0;
	qt_esc_neo_w             bigint := 0;
	qt_esc_hep_w             bigint := 0;
	qt_esc_icc_w             bigint := 0;
	qt_esc_avc_w             bigint := 0;
	qt_esc_ren_w             bigint := 0;
	qt_esc_mental_w          bigint := 0;
	qt_esc_fr_w              bigint := 0;
	qt_esc_pas_w             bigint := 0;
	qt_esc_temp_w            bigint := 0;
	qt_esc_fc_w              bigint := 0;
	qt_esc_ph_arterial_w     bigint := 0;
	qt_esc_ureia_w           bigint := 0;
	qt_esc_sodio_w           bigint := 0;
	qt_esc_glicose_w         bigint := 0;
	qt_esc_hematocrito_w     bigint := 0;
	qt_esc_po2_w             bigint := 0;
	qt_esc_derrame_pleural_w bigint := 0;
	qt_escore_w              bigint := 0;
	pr_risco_w               bigint := 0;
	qt_reg_w	             smallint;
BEGIN
  BEGIN
	if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
		NEW.nr_hora	:= (to_char(round(NEW.DT_AVALIACAO,'hh24'),'hh24'))::numeric;
	end if;

	if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
		goto Final;
	end if;

	select	max(ie_sexo)
	into STRICT	ie_sexo_w
	from	atendimento_paciente_v
	where	nr_atendimento		= NEW.nr_atendimento;

	NEW.qt_ano				:= coalesce(NEW.qt_ano,0);

	--INICIO MD
    BEGIN
		EXEC_w := 'BEGIN CALCULA_PSI_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, 
											:11, :12, :13, :14, :15, :16, :17, :18, :19, :20,
											:21, :22, :23, :24, :25, :26, :27, :28, :29, :30,
											:31, :32, :33, :34, :35, :36, :37, :38, :39, :40, :41); END;';
		
		EXECUTE EXEC_w USING IN NEW.qt_ano,
											IN ie_sexo_w,
											IN NEW.ie_enfermagem,
											IN NEW.ie_neoplasia,
											IN NEW.ie_hepatica,
											IN NEW.ie_icc,
											IN NEW.ie_avc,
											IN NEW.ie_renal,
											IN NEW.ie_estado_mental,
											IN NEW.ie_fr,
											IN NEW.ie_pas,
											IN NEW.ie_temp,
											IN NEW.ie_fc,
											IN NEW.ie_ph_arterial,
											IN NEW.ie_ureia,
											IN NEW.ie_sodio,
											IN NEW.ie_glicose,
											IN NEW.ie_hematocrito,
											IN NEW.ie_po2,
											IN NEW.ie_derrame_pleural,
											OUT qt_esc_ano_w,
											OUT qt_esc_enf_w,
											OUT qt_esc_neo_w,
											OUT qt_esc_hep_w,
											OUT qt_esc_icc_w,
											OUT qt_esc_avc_w,
											OUT qt_esc_ren_w,
											OUT qt_esc_mental_w,
											OUT qt_esc_fr_w,
											OUT qt_esc_pas_w,
											OUT qt_esc_temp_w,
											OUT qt_esc_fc_w,
											OUT qt_esc_ph_arterial_w,
											OUT qt_esc_ureia_w,
											OUT qt_esc_sodio_w,
											OUT qt_esc_glicose_w,
											OUT qt_esc_hematocrito_w,
											OUT qt_esc_po2_w,
											OUT qt_esc_derrame_pleural_w,
											OUT qt_escore_w,
											OUT pr_risco_w;
	exception
		when others then
			qt_esc_ano_w             := null;
			qt_esc_enf_w             := null;
			qt_esc_neo_w             := null;
			qt_esc_hep_w             := null;
			qt_esc_icc_w             := null;
			qt_esc_avc_w             := null;
			qt_esc_ren_w             := null;
			qt_esc_mental_w          := null;
			qt_esc_fr_w              := null;
			qt_esc_pas_w             := null;
			qt_esc_temp_w            := null;
			qt_esc_fc_w              := null;
			qt_esc_ph_arterial_w     := null;
			qt_esc_ureia_w           := null;
			qt_esc_sodio_w           := null;
			qt_esc_glicose_w         := null;
			qt_esc_hematocrito_w     := null;
			qt_esc_po2_w             := null;
			qt_esc_derrame_pleural_w := null;
			qt_escore_w              := null;
			pr_risco_w               := null;
	end;

  NEW.qt_esc_ano		        := qt_esc_ano_w;
  NEW.qt_esc_enf		        := qt_esc_enf_w;
  NEW.qt_esc_neo		        := qt_esc_neo_w;
  NEW.qt_esc_hep		        := qt_esc_hep_w;
  NEW.qt_esc_icc		        := qt_esc_icc_w;
  NEW.qt_esc_avc		        := qt_esc_avc_w;
  NEW.qt_esc_ren		        := qt_esc_ren_w;
  NEW.qt_esc_mental        := qt_esc_mental_w;
  NEW.qt_esc_fr		        := qt_esc_fr_w;
  NEW.qt_esc_pas		        := qt_esc_pas_w;
  NEW.qt_esc_temp	        := qt_esc_temp_w;
  NEW.qt_esc_fc		        := qt_esc_fc_w;
  NEW.qt_esc_ph_arterial	  := qt_esc_ph_arterial_w;
  NEW.qt_esc_ureia		      := qt_esc_ureia_w;
  NEW.qt_esc_sodio		      := qt_esc_sodio_w;
  NEW.qt_esc_glicose		    := qt_esc_glicose_w;
  NEW.qt_esc_hematocrito	  := qt_esc_hematocrito_w;
  NEW.qt_esc_po2		          := qt_esc_po2_w;
  NEW.qt_esc_derrame_pleural	:= qt_esc_derrame_pleural_w;

  NEW.qt_escore	            := qt_escore_w;
  NEW.pr_risco               := pr_risco_w;
	--FIM MD
	
	<<Final>>
	qt_reg_w	:= 0;
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_psi_atual() FROM PUBLIC;

CREATE TRIGGER atend_psi_atual
	BEFORE INSERT OR UPDATE ON atend_psi FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_psi_atual();

