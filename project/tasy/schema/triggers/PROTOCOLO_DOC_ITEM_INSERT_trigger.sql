-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS protocolo_doc_item_insert ON protocolo_doc_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_protocolo_doc_item_insert() RETURNS trigger AS $BODY$
declare

qt_atend_w  			bigint;
ds_tipo_w  			varchar(100);
ds_program_w		varchar(100);
ie_formadocconta_w		varchar(1);
ie_gerardescperiodoconta_w 	varchar(1);
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ds_periodo_w			varchar(255);
dt_periodo_inicial_w		conta_paciente.dt_periodo_inicial%type;
dt_periodo_final_w		conta_paciente.dt_periodo_final%type;
BEGIN
  BEGIN

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

ie_formadocconta_w := obter_param_usuario(290, 26, obter_perfil_ativo, obter_usuario_ativo, cd_estabelecimento_w, ie_formadocconta_w);
ie_gerardescperiodoconta_w := obter_param_usuario(290, 92, obter_perfil_ativo, obter_usuario_ativo, cd_estabelecimento_w, ie_gerardescperiodoconta_w);

select  ie_tipo_protocolo
into STRICT 	ds_tipo_w
from  	protocolo_documento
where  	nr_sequencia = NEW.nr_sequencia;

select program
into STRICT   ds_program_w
from   v$session
where  audsid = (SELECT MAX(USERENV('sessionid')) );


if  ds_tipo_w in ('2','5')
	and (upper(ds_program_w) = 'TASY.EXE') then

	if (NEW.nr_documento is not null) then
		select  	count(*)
		into STRICT  	qt_atend_w
		from  	atendimento_paciente
		Where  	nr_atendimento = NEW.nr_documento;

		if (qt_atend_w = 0) then
		--r.aise_application_error(-20011,'Este atendimento não existe');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(263426);
		end if;

		if ((ie_formadocconta_w = 'C') and (ie_gerardescperiodoconta_w = 'S') and (NEW.nr_seq_interno is not null)) then

		   BEGIN
		   select  	dt_periodo_inicial,
				dt_periodo_final
		   into STRICT 	dt_periodo_inicial_w,
				dt_periodo_final_w
		   from		conta_paciente
		   where 	nr_interno_conta = NEW.nr_seq_interno;
		   exception
		   when others then
		   	dt_periodo_inicial_w	:= null;
			dt_periodo_final_w	:= null;
		   end;
				--Período da conta é de #@DT_PERIODO_INICIAL#@ até #@DT_PERIODO_FINAL#@
		  NEW.ds_documento := wheb_mensagem_pck.get_texto(882113,'DT_PERIODO_INICIAL=' || dt_periodo_inicial_w ||';DT_PERIODO_FINAL='|| dt_periodo_final_w);

		end if;
	end if;
end if;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_protocolo_doc_item_insert() FROM PUBLIC;

CREATE TRIGGER protocolo_doc_item_insert
	BEFORE INSERT ON protocolo_doc_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_protocolo_doc_item_insert();

