-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS dpc_edition_ins_upd_after ON dpc_edition CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_dpc_edition_ins_upd_after() RETURNS trigger AS $BODY$
declare

nr_sequencia_w  patient_dpc.nr_sequencia%type;
nr_atendimento_w patient_dpc.nr_atendimento%type;
qt_w bigint;
nm_usuario_w varchar(30);

c01 CURSOR FOR
SELECT  nr_sequencia,
	    nr_atendimento_w
from    patient_dpc
where   nr_seq_edition = NEW.nr_sequencia
and     coalesce(dt_end_dpc,LOCALTIMESTAMP) > NEW.dt_end;

c02 CURSOR FOR
SELECT  distinct obter_usuario_pf(a.cd_prescritor)
from 	pessoa_fisica c, 
		medico b, 
		prescr_medica a
where 	b.cd_pessoa_fisica = c.cd_pessoa_fisica 
and 	a.cd_prescritor  = b.cd_pessoa_fisica 
and 	a.nr_atendimento = nr_atendimento_w
and 	b.ie_situacao = 'A' 

union
 
SELECT 	distinct obter_usuario_pf(a.cd_medico) 
from 	pessoa_fisica c, 
		medico b, 
		evolucao_paciente a 
where 	b.cd_pessoa_fisica = c.cd_pessoa_fisica 
and 	a.cd_medico = b.cd_pessoa_fisica 
and 	a.nr_atendimento  = nr_atendimento_w
and 	b.ie_situacao = 'A' 

union
 
select 	distinct obter_usuario_pf(a.cd_medico_referido)
from 	pessoa_fisica c, 
		medico b, 
		atendimento_paciente a 
where 	b.cd_pessoa_fisica = c.cd_pessoa_fisica 
and 	a.cd_medico_referido = b.cd_pessoa_fisica 
and 	a.nr_atendimento  = nr_atendimento_w
and 	b.ie_situacao = 'A' 

union
 
select 	distinct obter_usuario_pf(b.cd_medico) 
from 	pessoa_fisica c, 
		pf_medico_externo b, 
		pessoa_fisica m
where 	b.cd_pessoa_fisica = c.cd_pessoa_fisica 
and 	c.cd_pessoa_fisica = b.cd_pessoa_fisica 
and 	m.cd_pessoa_fisica = b.cd_medico 
and 	b.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C');

BEGIN

if ((get_uses_dpc() = 'S') and (OLD.dt_end <> NEW.dt_end)) then

	open c01;
	loop
	fetch c01 into
	nr_sequencia_w,
	nr_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		select  count(*)
		into STRICT    qt_w
		from    pep_item_pendente
		where   ie_tipo_registro = 'DPC2'
		and     nr_seq_registro = nr_sequencia_w
		and     nr_atendimento = nr_atendimento_w;
		
		
		if (qt_w = 0) then
		
		select  obter_usuario_pf(cd_medico_resp)
		into STRICT 	nm_usuario_w
		from 	atendimento_paciente
		where 	nr_atendimento = nr_atendimento_w;
		
		
		insert into pep_item_pendente(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		dt_registro,
		cd_pessoa_fisica,
		nr_atendimento,
		nr_seq_registro,
		ie_tipo_pendencia,
		ie_tipo_registro,
		ds_item)
		SELECT
		nextval('pep_item_pendente_seq'),
		LOCALTIMESTAMP,
		nm_usuario_w,
		LOCALTIMESTAMP,
		nm_usuario_w,
		NEW.dt_end,
		obter_pessoa_atendimento(nr_atendimento_w,'C'),
		nr_atendimento_w,
		nr_sequencia_w,
		'L',
		'DPC2',
		obter_desc_expressao(974849)||' '|| to_char(NEW.dt_end,'YYYY-MM-DD') as ds_item;
		
			open c02;
			loop
			fetch c02 into
			nm_usuario_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
			
			insert into pep_item_pendente(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_registro,
				cd_pessoa_fisica,
				nr_atendimento,
				nr_seq_registro,
				ie_tipo_pendencia,
				ie_tipo_registro,
				ds_item)
			SELECT
				nextval('pep_item_pendente_seq'),
				LOCALTIMESTAMP,
				nm_usuario_w,
				LOCALTIMESTAMP,
				nm_usuario_w,
				NEW.dt_end,
				obter_pessoa_atendimento(nr_atendimento_w,'C'),
				nr_atendimento_w,
				nr_sequencia_w,
				'L',
				'DPC2',
				obter_desc_expressao(974849)||' '|| to_char(NEW.dt_end,'YYYY-MM-DD') as ds_item;
						
			end loop;
			close c02;	

				
		end if;
	
	end loop;
	close c01;
	
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_dpc_edition_ins_upd_after() FROM PUBLIC;

CREATE TRIGGER dpc_edition_ins_upd_after
	AFTER INSERT OR UPDATE ON dpc_edition FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_dpc_edition_ins_upd_after();

