-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS sus_aih_unif_delete ON sus_aih_unif CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_sus_aih_unif_delete() RETURNS trigger AS $BODY$
declare

nr_sequencia_w		bigint;
nr_interno_conta_def_w  bigint;
ds_log_w    varchar(2000);
qt_reg_w    smallint;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then
    goto Final;
end if;

CALL Sus_Cancelar_Numeracao(OLD.nr_aih,OLD.nm_usuario);

BEGIN
select	nr_interno_conta
into STRICT	nr_interno_conta_def_w
from	conta_paciente
where (nr_interno_conta = OLD.nr_interno_conta)
and (nr_atendimento = OLD.nr_atendimento)
and (ie_status_acerto = 2)
and (nr_seq_protocolo > 0);

exception
    when others then
    nr_interno_conta_def_w	:= 0;
end;

if (nr_interno_conta_def_w > 0) then
BEGIN
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1163844,'NR_AIH_P='||OLD.NR_AIH||';NR_INTERNO_CONTA_P='||nr_interno_conta_def_w);
end;
end  if;

select	nextval('aih_hist_conta_seq')
into STRICT	nr_sequencia_w
;

ds_log_w := substr(wheb_mensagem_pck.get_texto(310585)||dbms_utility.format_call_stack, 1, 2000);

insert into aih_hist_conta(
	nr_sequencia,
	nr_aih, 
	nr_seq_aih, 
	nr_atendimento,
	nr_interno_conta, 
	dt_atualizacao, 
	nm_usuario,
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	ds_observacao)
values (	nr_sequencia_w, 
	OLD.nr_aih, 
	OLD.nr_sequencia, 
	OLD.nr_atendimento,
	OLD.nr_interno_conta, 
	LOCALTIMESTAMP, 
	OLD.nm_usuario,
	LOCALTIMESTAMP, 
	OLD.nm_usuario,
    ds_log_w); 	--wheb_mensagem_pck.get_texto(310585));--substr('Exclusao',1,2000));
	
<<Final>>
qt_reg_w := 0;

  END;
RETURN OLD;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_sus_aih_unif_delete() FROM PUBLIC;

CREATE TRIGGER sus_aih_unif_delete
	BEFORE DELETE ON sus_aih_unif FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_sus_aih_unif_delete();

