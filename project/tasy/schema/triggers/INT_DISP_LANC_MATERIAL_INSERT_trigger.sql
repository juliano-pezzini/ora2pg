-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS int_disp_lanc_material_insert ON int_disp_lanc_material CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_int_disp_lanc_material_insert() RETURNS trigger AS $BODY$
declare

ds_erro_w	varchar(2000);

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
	if (NEW.cd_acao is null) or (NEW.cd_acao not in ('EVM','ERM'))then
		ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(310130); --'Campo CD_ACAO esta nulo ou valor invalido.';
	end if;
	if (NEW.nr_atendimento is null) then
		ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(310131); --Campo NR_ATENDIMENTO esta nulo.
	end if;
	if (NEW.cd_local_estoque is null) then
		ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(310132); --Campo CD_LOCAL_ESTOQUE esta nulo.
	end if;
	if (NEW.cd_material is null) then
		ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(310133); --Campo CD_MATERIAL esta nulo.
	end if;
	if (NEW.qt_atual is null) then
		ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(310134); --Campo QT_ATUAL esta nulo.
	end if;

	NEW.nm_usuario := NEW.nm_usuario_nrec;
	
	 SELECT * FROM intdisp_lancamento_material(
			NEW.cd_acao, NEW.nr_atendimento, NEW.cd_local_estoque, NEW.cd_operacao_estoque, NEW.cd_material, NEW.qt_atual, NEW.dt_movimento, NEW.cd_cgc, NEW.ie_atualizou, NEW.ds_erro, NEW.nr_seq_mat_hor, NEW.cd_barras, NEW.nm_usuario_nrec, 'N', NEW.cd_setor_atendimento, NEW.nr_cirurgia) INTO STRICT NEW.ie_atualizou, NEW.ds_erro;

	if (NEW.ds_erro is not null) or (ds_erro_w is not null) then
		NEW.ds_erro := substr(NEW.ds_erro||' | '||ds_erro_w || ' | ' || SQLERRM(SQLSTATE) || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE,1,2000);
	end if;
end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_int_disp_lanc_material_insert() FROM PUBLIC;

CREATE TRIGGER int_disp_lanc_material_insert
	BEFORE INSERT ON int_disp_lanc_material FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_int_disp_lanc_material_insert();

