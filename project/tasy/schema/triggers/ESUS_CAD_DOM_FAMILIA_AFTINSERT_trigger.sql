-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS esus_cad_dom_familia_aftinsert ON esus_cad_dom_familia CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_esus_cad_dom_familia_aftinsert() RETURNS trigger AS $BODY$
declare
nr_seq_micro_area_w		esus_cad_domiciliar.nr_seq_micro_area%type;
nr_prontuario_famili_w	psf_familia.nr_prontuario_famili%type;

BEGIN
	
	select	coalesce(max(nr_seq_micro_area),0)
	into STRICT	nr_seq_micro_area_w
	from	esus_cad_domiciliar
	where	nr_sequencia = NEW.nr_seq_cad_dom;

	select	coalesce(max(nr_prontuario_famili),0)
	into STRICT	nr_prontuario_famili_w
	from	psf_familia
	where	nr_prontuario_famili = NEW.nr_prontuario_famili;

	if (nr_seq_micro_area_w > 0) and (nr_prontuario_famili_w = 0) then
	
		insert into psf_familia(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_micro_area,
			cd_familia,
			ds_familia,
			ie_situacao,
			nr_seq_micro_area,
			nr_prontuario_famili)
		values (
			nextval('psf_familia_seq'),
			NEW.dt_atualizacao,
			NEW.nm_usuario,
			NEW.dt_atualizacao_nrec,
			NEW.nm_usuario_nrec,
			(SELECT max(cd_micro_area) from psf_micro_area where nr_sequencia = nr_seq_micro_area_w),
			NEW.cd_pessoa_fis_respon,
			obter_nome_pf(NEW.cd_pessoa_fis_respon),
			'A',
			nr_seq_micro_area_w,
			NEW.nr_prontuario_famili);
		
		end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_esus_cad_dom_familia_aftinsert() FROM PUBLIC;

CREATE TRIGGER esus_cad_dom_familia_aftinsert
	AFTER INSERT ON esus_cad_dom_familia FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_esus_cad_dom_familia_aftinsert();

