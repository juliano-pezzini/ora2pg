-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS laudo_paciente_delete ON laudo_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_laudo_paciente_delete() RETURNS trigger AS $BODY$
DECLARE
qt_ditado_w	bigint;
ie_status_w	varchar(10)	:= '20';

BEGIN

select	count(*)
into STRICT	qt_ditado_w
from	prescr_proc_ditado b,
	prescr_procedimento a
where	a.nr_seq_interno	= b.nr_seq_prescr_proc
and	a.nr_sequencia  in (	SELECT	b.nr_sequencia_prescricao
				from	procedimento_paciente b
				where	b.nr_prescricao = a.nr_prescricao
				and	b.nr_sequencia_prescricao = a.nr_sequencia
				and	b.nr_laudo = OLD.nr_sequencia);

if (qt_ditado_w > 0) then
	ie_status_w	:= '25';
end if;

Update	prescr_procedimento a
set	a.ie_status_execucao = ie_status_w,
	a.nm_usuario	= coalesce(wheb_usuario_pck.get_nm_usuario, a.nm_usuario)
where	a.nr_prescricao = OLD.nr_prescricao
and	a.nr_sequencia  in (	SELECT	b.nr_sequencia_prescricao
				from	procedimento_paciente b
				where	b.nr_prescricao = a.nr_prescricao
				and	b.nr_sequencia_prescricao = a.nr_sequencia
				and	b.nr_laudo = OLD.nr_sequencia);

update	procedimento_paciente
set	nr_laudo  = NULL,
	dt_vinc_proced_adic  = NULL
where 	nr_laudo = OLD.nr_sequencia;

RETURN OLD;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_laudo_paciente_delete() FROM PUBLIC;

CREATE TRIGGER laudo_paciente_delete
	BEFORE DELETE ON laudo_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_laudo_paciente_delete();

