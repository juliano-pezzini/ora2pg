-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS mprev_programa_partic_update ON mprev_programa_partic CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_mprev_programa_partic_update() RETURNS trigger AS $BODY$
declare

nm_programa_w        mprev_programa.nm_programa%type;
cd_pessoa_fisica_w   pessoa_fisica.cd_pessoa_fisica%type;
default_date         mprev_programa_partic.dt_exclusao%type;
new_dt_exclusao_w    mprev_programa_partic.dt_exclusao%type;
old_dt_exclusao_w    mprev_programa_partic.dt_exclusao%type;
nr_seq_envio_mens_w  mprev_regra_cubo.nr_seq_envio_mens%type;

cRegrasEP CURSOR FOR
SELECT nr_sequencia
from   mprev_regra_envio_mensagem
where  ie_momento_envio = 'EP';

cRegrasIP CURSOR FOR
SELECT nr_sequencia
from   mprev_regra_envio_mensagem
where  ie_momento_envio = 'IP';

BEGIN
    if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
      default_date := to_date('01/01/1900', 'DD/MM/YYYY');
      old_dt_exclusao_w := coalesce(OLD.dt_exclusao, default_date);
      new_dt_exclusao_w := coalesce(NEW.dt_exclusao, default_date);

      if (wheb_usuario_pck.get_cd_funcao = '10157' and old_dt_exclusao_w != new_dt_exclusao_w) then
          select cd_pessoa_fisica
          into STRICT   cd_pessoa_fisica_w
          from   mprev_participante
          where  nr_sequencia = NEW.nr_seq_participante;

          select nm_programa
          into STRICT   nm_programa_w
          from   mprev_programa
          where  nr_sequencia = NEW.nr_seq_programa;

          if (new_dt_exclusao_w != default_date) then
              open cRegrasEP;
              loop
              fetch cRegrasEP into nr_seq_envio_mens_w;
              EXIT WHEN NOT FOUND; /* apply on cRegrasEP */
                  BEGIN
                      CALL mprev_enviar_email_sms(cd_pessoa_fisica_w , nr_seq_envio_mens_w, nm_programa_w, '10157', NEW.nm_usuario);
                  end;
              end loop;
              close cRegrasEP;
          elsif (new_dt_exclusao_w = default_date) then
              open cRegrasIP;
              loop
              fetch cRegrasIP into nr_seq_envio_mens_w;
              EXIT WHEN NOT FOUND; /* apply on cRegrasIP */
                  BEGIN
                      CALL mprev_enviar_email_sms(cd_pessoa_fisica_w , nr_seq_envio_mens_w, nm_programa_w, '10157', NEW.nm_usuario);
                  end;
              end loop;
              close cRegrasIP;
          end if;
      end if;
    end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_mprev_programa_partic_update() FROM PUBLIC;

CREATE TRIGGER mprev_programa_partic_update
	AFTER UPDATE ON mprev_programa_partic FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_mprev_programa_partic_update();

