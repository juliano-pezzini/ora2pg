-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS paciente_atend_medic_delete ON paciente_atend_medic CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_paciente_atend_medic_delete() RETURNS trigger AS $BODY$
declare

ie_atualizar_autor_conv_w		varchar(15) := 'N';
nr_seq_autor_w			bigint;
nr_ciclo_w			smallint;
ds_dia_ciclo_w			varchar(5);
nr_seq_pend_Agenda_w		bigint;

qt_dose_total_w			paciente_atend_medic.qt_dose_prescricao%type;
qt_solicitada_w			material_autorizado.qt_solicitada%type;
qt_itens_autor_w		integer;
qt_itens_tratamento_w		integer;
BEGIN
  BEGIN
ie_atualizar_autor_conv_w := obter_param_usuario(281, 1001, obter_perfil_ativo, OLD.nm_usuario, 0, ie_atualizar_autor_conv_w);

if (ie_atualizar_autor_conv_w = 'S') then
	BEGIN

	select	max(nr_ciclo),
		max(ds_dia_ciclo)
	into STRICT	nr_ciclo_w,
		ds_dia_ciclo_w
	from	paciente_atendimento
	where	nr_seq_atendimento = OLD.nr_seq_atendimento;


	select	max(a.nr_sequencia)
	into STRICT	nr_seq_autor_w
	from	autorizacao_convenio a,
		estagio_autorizacao b
	where	a.nr_ciclo			= nr_ciclo_w
	and	((a.ds_dia_ciclo		= ds_dia_ciclo_w) or (coalesce(ds_dia_ciclo, 'X')	= 'X'))
	and	a.nr_seq_paciente_setor	= OLD.nr_seq_paciente
	and	a.nr_seq_estagio		= b.nr_sequencia
	and	b.ie_interno 		= '1';


	if (coalesce(nr_seq_autor_w,0) <> 0) then
		BEGIN

			select	sum(qt_dose_prescricao),
			count(1)
		into STRICT	qt_dose_total_w,
			qt_itens_tratamento_w
		from	paciente_atend_medic
		where	nr_seq_atendimento = OLD.nr_seq_atendimento
		and	cd_material = OLD.cd_material;
		
		select 	sum(qt_solicitada),
			count(1)
		into STRICT	qt_solicitada_w,
			qt_itens_autor_w
		from	material_autorizado
		where	nr_sequencia_autor 	= nr_seq_autor_w
		and	cd_material		= OLD.cd_material;

		if	(qt_dose_total_w = qt_solicitada_w AND qt_itens_autor_w = 1) then
			
		delete	from material_autorizado
		where	nr_sequencia_autor 	= nr_seq_autor_w
		and	cd_material		= OLD.cd_material;

		elsif 	((qt_solicitada_w > coalesce(OLD.qt_dose_prescricao,0)) and (qt_itens_tratamento_w > 1) and (qt_itens_autor_w = 1)) then
			
			update 	material_autorizado set
				qt_solicitada 		= qt_solicitada - coalesce(OLD.qt_dose_prescricao,0),
				dt_atualizacao 		= LOCALTIMESTAMP,
				nm_usuario		= NEW.nm_usuario
			where	nr_sequencia_autor 	= nr_seq_autor_w
			and	cd_material		= OLD.cd_material;
			
		end if;	
		end;
	end if;
	
	exception
	when others then
		null;
	end;
end if;

  END;
RETURN OLD;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_paciente_atend_medic_delete() FROM PUBLIC;

CREATE TRIGGER paciente_atend_medic_delete
	BEFORE DELETE ON paciente_atend_medic FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_paciente_atend_medic_delete();

