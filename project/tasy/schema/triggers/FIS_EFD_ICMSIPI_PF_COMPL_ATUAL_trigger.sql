-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS fis_efd_icmsipi_pf_compl_atual ON compl_pessoa_fisica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_fis_efd_icmsipi_pf_compl_atual() RETURNS trigger AS $BODY$
declare
ie_efd_icmsipi_w	varchar(1);

BEGIN
ie_efd_icmsipi_w := obter_param_usuario(5500, 61, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_efd_icmsipi_w);

if (wheb_usuario_pck.get_ie_executar_trigger = 'S' ) then
	if (coalesce(ie_efd_icmsipi_w,'N') = 'S') then
		-- REGISTRO 0150.CD_MUN
		if (coalesce(NEW.cd_municipio_ibge,'XPTO') <> coalesce(OLD.cd_municipio_ibge,'XPTO')) then
			insert into fis_efd_icmsipi_alteracao(
				nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_campo_alterado,
				ds_valor_anterior,
				cd_pessoa_fisica)
			values (nextval('fis_efd_icmsipi_alteracao_seq'),
				LOCALTIMESTAMP,
				obter_usuario_ativo,
				'08', -- Domínio 8965 - EFD ICMS/IPI - Campo alterado
				elimina_caracteres_especiais(substr(OLD.cd_municipio_ibge || substr(calcula_digito('MODULO10', OLD.cd_municipio_ibge),1,1),1,7)),
				NEW.cd_pessoa_fisica);
		end if;

		-- REGISTRO 0150.END
		if (coalesce(NEW.ds_endereco,'XPTO') <> coalesce(OLD.ds_endereco,'XPTO')) then
			insert into fis_efd_icmsipi_alteracao(
				nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_campo_alterado,
				ds_valor_anterior,
				cd_pessoa_fisica)
			values (nextval('fis_efd_icmsipi_alteracao_seq'),
				LOCALTIMESTAMP,
				obter_usuario_ativo,
				'10', -- Domínio 8965 - EFD ICMS/IPI - Campo alterado
				substr(OLD.ds_endereco,1,100),
				NEW.cd_pessoa_fisica);
		end if;

		-- REGISTRO 0150.NUM
		if (coalesce(NEW.nr_endereco,0) <> coalesce(OLD.nr_endereco,0)) then
			insert into fis_efd_icmsipi_alteracao(
				nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_campo_alterado,
				ds_valor_anterior,
				cd_pessoa_fisica)
			values (nextval('fis_efd_icmsipi_alteracao_seq'),
				LOCALTIMESTAMP,
				obter_usuario_ativo,
				'11', -- Domínio 8965 - EFD ICMS/IPI - Campo alterado
				to_char(OLD.nr_endereco),
				NEW.cd_pessoa_fisica);
		end if;

		-- REGISTRO 0150.COMPL
		if (coalesce(NEW.ds_complemento,'XPTO') <> coalesce(OLD.ds_complemento,'XPTO')) then
			insert into fis_efd_icmsipi_alteracao(
				nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_campo_alterado,
				ds_valor_anterior,
				cd_pessoa_fisica)
			values (nextval('fis_efd_icmsipi_alteracao_seq'),
				LOCALTIMESTAMP,
				obter_usuario_ativo,
				'12', -- Domínio 8965 - EFD ICMS/IPI - Campo alterado
				substr(OLD.ds_complemento,1,100),
				NEW.cd_pessoa_fisica);
		end if;

		-- REGISTRO 0150.BAIRRO
		if (coalesce(NEW.ds_bairro,'XPTO') <> coalesce(OLD.ds_bairro,'XPTO')) then
			insert into fis_efd_icmsipi_alteracao(
				nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_campo_alterado,
				ds_valor_anterior,
				cd_pessoa_fisica)
			values (nextval('fis_efd_icmsipi_alteracao_seq'),
				LOCALTIMESTAMP,
				obter_usuario_ativo,
				'13', -- Domínio 8965 - EFD ICMS/IPI - Campo alterado
				substr(OLD.ds_bairro,1,100),
				NEW.cd_pessoa_fisica);
		end if;
	end if;
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_fis_efd_icmsipi_pf_compl_atual() FROM PUBLIC;

CREATE TRIGGER fis_efd_icmsipi_pf_compl_atual
after update of cd_municipio_ibge, ds_endereco, nr_endereco, ds_complemento, ds_bairro ON compl_pessoa_fisica for each row  
	WHEN (new.ie_tipo_complemento = 1)
	EXECUTE PROCEDURE trigger_fct_fis_efd_icmsipi_pf_compl_atual();

