-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS exame_lab_result_item_up_assi ON exame_lab_result_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_exame_lab_result_item_up_assi() RETURNS trigger AS $BODY$
DECLARE
qt_reg_w		smallint;

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;

--Na atualização da assinatura de aprovacao, deverá referenciar a assinatura anterior de reprovação:
if (NEW.nr_seq_assinatura > 0) and
   ((OLD.nr_seq_assinatura is null) or (OLD.nr_seq_assinatura <> NEW.nr_seq_assinatura)) then

	update tasy_assinatura_digital
	set nr_seq_assinatura_anterior = CASE WHEN coalesce(NEW.nr_seq_assinat_inativ,0)=0 THEN  OLD.nr_seq_assinatura  ELSE NEW.nr_seq_assinat_inativ END
	where nr_sequencia = NEW.nr_seq_assinatura;

	NEW.nr_seq_assinat_inativ := null;

end if;

--Na atualização da assinatura de reprovacao, deverá referenciar a assinatura anterior de aprovação:
if (NEW.nr_seq_assinat_inativ > 0) and
   ((OLD.nr_seq_assinat_inativ is null) or (OLD.nr_seq_assinat_inativ <> NEW.nr_seq_assinat_inativ)) then

	update tasy_assinatura_digital
	set nr_seq_assinatura_anterior = CASE WHEN coalesce(NEW.nr_seq_assinatura,0)=0 THEN  OLD.nr_seq_assinat_inativ  ELSE NEW.nr_seq_assinatura END
	where nr_sequencia = NEW.nr_seq_assinat_inativ;

	NEW.nr_seq_assinatura := null;

end if;

<<Final>>
qt_reg_w	:= 0;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_exame_lab_result_item_up_assi() FROM PUBLIC;

CREATE TRIGGER exame_lab_result_item_up_assi
	BEFORE UPDATE ON exame_lab_result_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_exame_lab_result_item_up_assi();

