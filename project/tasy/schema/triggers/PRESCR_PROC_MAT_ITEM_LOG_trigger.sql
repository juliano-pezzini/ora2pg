-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_proc_mat_item_log ON prescr_proc_mat_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_proc_mat_item_log() RETURNS trigger AS $BODY$
BEGIN
    IF ( wheb_usuario_pck.get_ie_executar_trigger = 'S' ) THEN
        IF (OLD.ie_status <> NEW.ie_status) THEN
            CALL gravar_log_lab_pragma(
                CD_LOG_P => 17,
                DS_LOG_P => substr(
                     ':NEW.NR_SEQUENCIA: '           || to_char(NEW.NR_SEQUENCIA)
                || ' - :NEW.DT_ATUALIZACAO: '         || to_char(NEW.DT_ATUALIZACAO, 'dd/mm/yyyy hh24:mi:ss')
                || ' - :NEW.NM_USUARIO: '             || to_char(NEW.NM_USUARIO)
                || ' - :NEW.DT_ATUALIZACAO_NREC: '    || to_char(NEW.DT_ATUALIZACAO_NREC, 'dd/mm/yyyy hh24:mi:ss')
                || ' - :NEW.NM_USUARIO_NREC: '        || to_char(NEW.NM_USUARIO_NREC)
                || ' - :NEW.NR_PRESCRICAO: '          || to_char(NEW.NR_PRESCRICAO)
                || ' - :NEW.NR_SEQ_PRESCR: '          || to_char(NEW.NR_SEQ_PRESCR)
                || ' - :NEW.NR_SEQ_PRESCR_PROC_MAT: ' || to_char(NEW.NR_SEQ_PRESCR_PROC_MAT)
                || ' - :NEW.IE_STATUS: '              || to_char(NEW.IE_STATUS)
                || ' - :NEW.CD_BARRAS: '              || to_char(NEW.CD_BARRAS)
                || ' - :NEW.DT_INTEGRACAO: '          || to_char(NEW.DT_INTEGRACAO, 'dd/mm/yyyy hh24:mi:ss')
                || ' - :NEW.NR_SEQ_FRASCO: '          || to_char(NEW.NR_SEQ_FRASCO)
                || ' - :NEW.IE_SUSPENSO: '            || to_char(NEW.IE_SUSPENSO)
                || ' - :OLD.NR_SEQUENCIA: '           || to_char(OLD.NR_SEQUENCIA)
                || ' - :OLD.DT_ATUALIZACAO: '         || to_char(OLD.DT_ATUALIZACAO, 'dd/mm/yyyy hh24:mi:ss')
                || ' - :OLD.NM_USUARIO: '             || to_char(OLD.NM_USUARIO)
                || ' - :OLD.DT_ATUALIZACAO_NREC: '    || to_char(OLD.DT_ATUALIZACAO_NREC, 'dd/mm/yyyy hh24:mi:ss')
                || ' - :OLD.NM_USUARIO_NREC: '        || to_char(OLD.NM_USUARIO_NREC)
                || ' - :OLD.NR_PRESCRICAO: '          || to_char(OLD.NR_PRESCRICAO)
                || ' - :OLD.NR_SEQ_PRESCR: '          || to_char(OLD.NR_SEQ_PRESCR)
                || ' - :OLD.NR_SEQ_PRESCR_PROC_MAT: ' || to_char(OLD.NR_SEQ_PRESCR_PROC_MAT)
                || ' - :OLD.IE_STATUS: '              || to_char(OLD.IE_STATUS)
                || ' - :OLD.CD_BARRAS: '              || to_char(OLD.CD_BARRAS)
                || ' - :OLD.DT_INTEGRACAO: '          || to_char(OLD.DT_INTEGRACAO, 'dd/mm/yyyy hh24:mi:ss')
                || ' - :OLD.NR_SEQ_FRASCO: '          || to_char(OLD.NR_SEQ_FRASCO)
                || ' - :OLD.IE_SUSPENSO: '            || to_char(OLD.IE_SUSPENSO)
                || ' - STACK_TRACE: '                 || dbms_utility.format_call_stack, 1, 3999),
                NM_USUARIO_P => NEW.nm_usuario,
                NR_PRESCRICAO_P => NEW.nr_prescricao
            );
        END IF;
    END IF;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_proc_mat_item_log() FROM PUBLIC;

CREATE TRIGGER prescr_proc_mat_item_log
	BEFORE UPDATE ON prescr_proc_mat_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_proc_mat_item_log();

