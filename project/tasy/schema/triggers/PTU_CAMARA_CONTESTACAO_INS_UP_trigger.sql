-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS ptu_camara_contestacao_ins_up ON ptu_camara_contestacao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_ptu_camara_contestacao_ins_up() RETURNS trigger AS $BODY$
declare

C01 CURSOR(	nr_seq_lote_contest_pc	pls_lote_contestacao.nr_sequencia%type) FOR
	SELECT	a.nr_seq_conta
	from	pls_contestacao a
	where	a.nr_seq_lote	= nr_seq_lote_contest_pc
	group by
		a.nr_seq_conta;

BEGIN
if (NEW.ie_tipo_arquivo in (5,6,7,8)) and (NEW.nr_seq_lote_discussao is not null) then -- A opção "9" será tratado dentro da trigger PLS_LOTE_DISCUSSAO_INSERT
	--Altera o status com a rotina nova
	CALL pls_altera_status_contestacao(NEW.nr_seq_lote_contest, 'C', NEW.nm_usuario);

	--atualiza a data de vencimento separadamente
	update	pls_lote_contestacao
	set	dt_fechamento	= coalesce(dt_fechamento,LOCALTIMESTAMP)
	where	nr_sequencia	= NEW.nr_seq_lote_contest;

	for r_c01_w in c01( NEW.nr_seq_lote_contest ) loop
		CALL pls_atualiza_status_copartic( r_c01_w.nr_seq_conta, 'LC', NEW.nr_sequencia, NEW.nm_usuario, NEW.cd_estabelecimento);
	end loop;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_ptu_camara_contestacao_ins_up() FROM PUBLIC;

CREATE TRIGGER ptu_camara_contestacao_ins_up
	BEFORE INSERT OR UPDATE ON ptu_camara_contestacao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_ptu_camara_contestacao_ins_up();

