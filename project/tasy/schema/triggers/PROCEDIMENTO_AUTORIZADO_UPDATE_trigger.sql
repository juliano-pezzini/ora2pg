-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS procedimento_autorizado_update ON procedimento_autorizado CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_procedimento_autorizado_update() RETURNS trigger AS $BODY$
DECLARE
--ds_titulo_w			varchar2(255) 	:= 'Log de alteração no procedimento autorizado';
ds_titulo_w			varchar(255) 	:= wheb_mensagem_pck.get_texto(311533);
ds_historico_w			varchar(4000)	:= '';
dt_parametro_w			timestamp		:= trunc(LOCALTIMESTAMP) + 89399/89400;

ds_atributo_w			varchar(255);
ds_valor_ant_w			varchar(2000);
ds_valor_atual_w		varchar(2000);
ds_valor_desc_ant_w		varchar(2000);
ds_valor_desc_atual_w		varchar(2000);
nr_seq_tipo_hist_proc_w		bigint := 0;
BEGIN
  BEGIN

ds_atributo_w	 	:= '';
ds_valor_ant_w		:= '';
ds_valor_atual_w	:= '';

BEGIN
ds_titulo_w	:= 	substr(ds_titulo_w ||' '||OLD.cd_procedimento||' - '||
			substr(Obter_Desc_Prescr_Proc(OLD.cd_procedimento,OLD.ie_origem_proced,OLD.nr_seq_proc_interno),1,255),1,255);

if (coalesce(NEW.nr_seq_regra_plano,0) <> coalesce(OLD.nr_seq_regra_plano,0)) then
	ds_atributo_w	:= 'NR_SEQ_REGRA_PLANO';
	ds_valor_ant_w	:= OLD.nr_seq_regra_plano;
	ds_valor_atual_w:= NEW.nr_seq_regra_plano;
	--ds_historico_w	:= substr(ds_historico_w||'Campo: NR_SEQ_REGRA_PLANO - Antes: '|| :old.nr_seq_regra_plano ||' Depois: '|| :new.nr_seq_regra_plano ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.cd_procedimento_tuss,0) <> coalesce(OLD.cd_procedimento_tuss,0)) then
	ds_atributo_w:= 'CD_PROCEDIMENTO_TUSS';
	ds_valor_ant_w	:= OLD.cd_procedimento_tuss;
	ds_valor_atual_w:= NEW.cd_procedimento_tuss;
	--ds_historico_w	:= substr(ds_historico_w||'Campo: CD_PROCEDIMENTO_TUSS - Antes: '|| :old.cd_procedimento_tuss ||' Depois: '|| :new.cd_procedimento_tuss ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.nr_seq_agenda,0) <> coalesce(OLD.nr_seq_agenda,0)) then
	ds_atributo_w:= 'NR_SEQ_AGENDA';
	ds_valor_ant_w	:= OLD.nr_seq_agenda;
	ds_valor_atual_w:= NEW.nr_seq_agenda;
	--ds_historico_w	:= substr(ds_historico_w||'Campo: NR_SEQ_AGENDA - Antes: '|| :old.nr_seq_agenda ||' Depois: '|| :new.nr_seq_agenda ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.cd_procedimento_convenio,0) <> coalesce(OLD.cd_procedimento_convenio,0)) then
	ds_atributo_w:= 'CD_PROCEDIMENTO_CONVENIO';
	ds_valor_ant_w	:= OLD.cd_procedimento_convenio;
	ds_valor_atual_w:= NEW.cd_procedimento_convenio;
	--ds_historico_w	:= substr(ds_historico_w||'Campo: CD_PROCEDIMENTO_CONVENIO - Antes: '|| :old.cd_procedimento_convenio ||' Depois: '|| :new.cd_procedimento_convenio ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.nr_seq_proc_interno,0) <> coalesce(OLD.nr_seq_proc_interno,0)) then
	ds_atributo_w:= 'NR_SEQ_PROC_INTERNO';
	ds_valor_ant_w	:= OLD.nr_seq_proc_interno;
	ds_valor_atual_w:= NEW.nr_seq_proc_interno;
	--ds_historico_w 	:= substr(ds_historico_w||'Campo: NR_SEQ_PROC_INTERNO - Antes: '|| :old.nr_seq_proc_interno ||' Depois: '|| :new.nr_seq_proc_interno ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.qt_solicitada,0) <> coalesce(OLD.qt_solicitada,0)) then
	ds_atributo_w:= 'QT_SOLICITADA';
	ds_valor_ant_w	:= OLD.qt_solicitada;
	ds_valor_atual_w:= NEW.qt_solicitada;
	--ds_historico_w := substr(ds_historico_w||'Campo: QT_SOLICITADA - Antes: '|| :old.qt_solicitada ||' Depois: '|| :new.qt_solicitada ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.dt_aprovacao,dt_parametro_w) <> coalesce(OLD.dt_aprovacao,dt_parametro_w)) then
	ds_atributo_w:= 'DT_APROVACAO';
	ds_valor_ant_w	:= to_char(OLD.dt_aprovacao,'dd/mm/yyyy hh24:mi:ss');
	ds_valor_atual_w:= to_char(NEW.dt_aprovacao,'dd/mm/yyyy hh24:mi:ss');
	--ds_historico_w    := substr(ds_historico_w||'Campo: DT_APROVACAO - Antes: '|| to_char(:old.dt_aprovacao,'dd/mm/yyyy hh24:mi:ss') ||' Depois: '|| to_char(:new.dt_aprovacao,'dd/mm/yyyy hh24:mi:ss') ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.nm_usuario_aprov,0) <> coalesce(OLD.nm_usuario_aprov,0)) then
	ds_atributo_w:= 'NM_USUARIO_APROV';
	ds_valor_ant_w	:= OLD.nm_usuario_aprov;
	ds_valor_atual_w:= NEW.nm_usuario_aprov;
	--ds_historico_w := substr(ds_historico_w||'Campo: NM_USUARIO_APROV - Antes: '|| :old.nm_usuario_aprov ||' Depois: '|| :new.nm_usuario_aprov ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.nr_seq_prescricao,0) <> coalesce(OLD.nr_seq_prescricao,0)) then
	ds_atributo_w:= 'NR_SEQ_PRESCRICAO';
	ds_valor_ant_w	:= OLD.nr_seq_prescricao;
	ds_valor_atual_w:= NEW.nr_seq_prescricao;
	--ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_PRESCRICAO - Antes: '|| :old.nr_seq_prescricao ||' Depois: '|| :new.nr_seq_prescricao ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.nr_prescricao,0) <> coalesce(OLD.nr_prescricao,0)) then
	ds_atributo_w:= 'NR_PRESCRICAO';
	ds_valor_ant_w	:= OLD.nr_prescricao;
	ds_valor_atual_w:= NEW.nr_prescricao;
	--ds_historico_w := substr(ds_historico_w||'Campo: NR_PRESCRICAO - Antes: '|| :old.nr_prescricao ||' Depois: '|| :new.nr_prescricao ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.vl_autorizado,0) <> coalesce(OLD.vl_autorizado,0)) then
	ds_atributo_w:= 'VL_AUTORIZADO';
	ds_valor_ant_w	:= OLD.vl_autorizado;
	ds_valor_atual_w:= NEW.vl_autorizado;
	--ds_historico_w := substr(ds_historico_w||'Campo: VL_AUTORIZADO - Antes: '|| :old.vl_autorizado ||' Depois: '|| :new.vl_autorizado ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.ds_observacao,0) <> coalesce(OLD.ds_observacao,0)) then
	ds_atributo_w:= 'DS_OBSERVACAO';
	ds_valor_ant_w	:= OLD.ds_observacao;
	ds_valor_atual_w:= NEW.ds_observacao;
	--ds_historico_w := substr(ds_historico_w||'Campo: DS_OBSERVACAO - Antes: '|| :old.ds_observacao ||' Depois: '|| :new.ds_observacao ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.qt_autorizada,0) <> coalesce(OLD.qt_autorizada,0)) then
	ds_atributo_w:= 'QT_AUTORIZADA';
	ds_valor_ant_w	:= OLD.qt_autorizada;
	ds_valor_atual_w:= NEW.qt_autorizada;
	--ds_historico_w := substr(ds_historico_w||'Campo: QT_AUTORIZADA - Antes: '|| :old.qt_autorizada ||' Depois: '|| :new.qt_autorizada ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.ie_origem_proced,0) <> coalesce(OLD.ie_origem_proced,0)) then
	ds_atributo_w:= 'IE_ORIGEM_PROCED';
	ds_valor_ant_w	:= OLD.ie_origem_proced;
	ds_valor_atual_w:= NEW.ie_origem_proced;
	--ds_historico_w := substr(ds_historico_w||'Campo: IE_ORIGEM_PROCED - Antes: '|| :old.ie_origem_proced ||' Depois: '|| :new.ie_origem_proced ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.cd_procedimento,0) <> coalesce(OLD.cd_procedimento,0)) then
	ds_atributo_w:= 'CD_PROCEDIMENTO';
	ds_valor_ant_w	:= OLD.cd_procedimento;
	ds_valor_atual_w:= NEW.cd_procedimento;
	--ds_historico_w   := substr(ds_historico_w||'Campo: CD_PROCEDIMENTO - Antes: '|| :old.cd_procedimento ||' Depois: '|| :new.cd_procedimento ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);

	SELECT	MAX(NR_SEQUENCIA)
	INTO STRICT	nr_seq_tipo_hist_proc_w
	FROM	AUTORIZACAO_TIPO_HIST
	WHERE	coalesce(IE_TIPO,'X') = 'P'
	and	coalesce(ie_situacao,'A') = 'A';

	if (nr_seq_tipo_hist_proc_w > 0) then
		ds_valor_desc_ant_w	:= ds_valor_ant_w || ' - ' || substr(Obter_Desc_Prescr_Proc(OLD.cd_procedimento,OLD.ie_origem_proced,OLD.nr_seq_proc_interno),1,255);
		ds_valor_desc_atual_w	:= ds_valor_atual_w || ' - '|| substr(Obter_Desc_Prescr_Proc(NEW.cd_procedimento,NEW.ie_origem_proced,NEW.nr_seq_proc_interno),1,255);
	end if;
end if;
if (coalesce(NEW.nr_seq_autorizacao,0) <> coalesce(OLD.nr_seq_autorizacao,0)) then
	ds_atributo_w:= 'NR_SEQ_AUTORIZACAO';
	ds_valor_ant_w	:= OLD.nr_seq_autorizacao;
	ds_valor_atual_w:= NEW.nr_seq_autorizacao;
	--ds_historico_w  := substr(ds_historico_w||'Campo: NR_SEQ_AUTORIZACAO - Antes: '|| :old.nr_seq_autorizacao ||' Depois: '|| :new.nr_seq_autorizacao ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
if (coalesce(NEW.nr_atendimento,0) <> coalesce(OLD.nr_atendimento,0)) then
	ds_atributo_w:= 'NR_ATENDIMENTO';
	ds_valor_ant_w	:= OLD.nr_atendimento;
	ds_valor_atual_w:= NEW.nr_atendimento;
	--ds_historico_w  := substr(ds_historico_w||'Campo: NR_ATENDIMENTO - Antes: '|| :old.nr_atendimento ||' Depois: '|| :new.nr_atendimento ||chr(13)||chr(10),1,4000);
	ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
											'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
											'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
end if;
exception
when others then
	ds_historico_w := 'X';
end;

if (coalesce(ds_historico_w,'X') <> 'X') then
	CALL gravar_autor_conv_log_alter(NEW.nr_sequencia_autor,ds_titulo_w,substr(ds_historico_w,1,2000),NEW.nm_usuario);

	if (coalesce(nr_seq_tipo_hist_proc_w,0) > 0) then

		insert into autorizacao_convenio_hist(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_atendimento,
			nr_seq_autorizacao,
			ds_historico,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_sequencia_autor,
			nr_seq_tipo_hist,
			dt_liberacao,
			nm_usuario_lib)
		SELECT	nextval('autorizacao_convenio_hist_seq'),
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			NEW.nr_atendimento,
			NEW.nr_seq_autorizacao,
			WHEB_MENSAGEM_PCK.get_texto(312535) || ' ' || ds_valor_desc_ant_w || chr(13)|| WHEB_MENSAGEM_PCK.get_texto(182372) || ' ' ||ds_valor_desc_atual_w,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			NEW.nr_sequencia_autor,
			nr_seq_tipo_hist_proc_w,
			LOCALTIMESTAMP,
			NEW.nm_usuario
		;


	end if;


end if;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_procedimento_autorizado_update() FROM PUBLIC;

CREATE TRIGGER procedimento_autorizado_update
	AFTER UPDATE ON procedimento_autorizado FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_procedimento_autorizado_update();

