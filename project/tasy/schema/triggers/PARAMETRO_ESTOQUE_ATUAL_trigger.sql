-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS parametro_estoque_atual ON parametro_estoque CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_parametro_estoque_atual() RETURNS trigger AS $BODY$
declare
qt_existe_w		bigint;
qt_estoque_lote_w	bigint;
BEGIN
select	count(*)
into STRICT	qt_existe_w
from	regra_valorizacao_estoque
where	cd_estabelecimento = NEW.cd_estabelecimento;

if (coalesce(OLD.ie_estoque_lote,'N') = 'S') and (NEW.ie_estoque_lote = 'N') then
	select	count(*)
	into STRICT	qt_estoque_lote_w
	from	material_estab
	where	cd_estabelecimento = NEW.cd_estabelecimento
	and	ie_estoque_lote = 'S';

	if (qt_estoque_lote_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(263046);
	end if;
end if;

if	(qt_existe_w = 0 AND NEW.ie_metodo_valorizacao = 'MPM') or (OLD.ie_metodo_valorizacao <> NEW.ie_metodo_valorizacao) then
	BEGIN
	update	regra_valorizacao_estoque
	set	ie_metodo_valorizacao = NEW.ie_metodo_valorizacao,
		nm_usuario = NEW.nm_usuario,
		dt_atualizacao = NEW.dt_atualizacao
	where	dt_mes_inicio_vigencia = trunc(LOCALTIMESTAMP,'mm')
	and	cd_estabelecimento = NEW.cd_estabelecimento;
	if (NOT FOUND) then
		insert into regra_valorizacao_estoque(
			cd_estabelecimento,
			dt_mes_inicio_vigencia,
			ie_metodo_valorizacao,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec)
		values (	NEW.cd_estabelecimento,
			trunc(LOCALTIMESTAMP,'mm'),
			NEW.ie_metodo_valorizacao,
			LOCALTIMESTAMP,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			NEW.nm_usuario);
	end if;
	end;
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_parametro_estoque_atual() FROM PUBLIC;

CREATE TRIGGER parametro_estoque_atual
	AFTER INSERT OR UPDATE ON parametro_estoque FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_parametro_estoque_atual();

