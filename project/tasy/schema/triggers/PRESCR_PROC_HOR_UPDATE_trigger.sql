-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_proc_hor_update ON prescr_proc_hor CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_proc_hor_update() RETURNS trigger AS $BODY$
declare

c_zero_date constant timestamp := to_date('01-01-01 00:00:00', 'dd-mm-yy hh24:mi:ss');

cd_perfil_w						perfil.cd_perfil%type;
ie_log_rastr_w		varchar(1);
ds_log_rastr_w	varchar(1800);

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

	ie_log_rastr_w := obter_se_info_rastre_prescr('D', wheb_usuario_pck.get_nm_usuario, cd_perfil_w, wheb_usuario_pck.get_cd_estabelecimento);

	if (ie_log_rastr_w = 'S') then
		cd_perfil_w := obter_perfil_ativo;

		ds_log_rastr_w := 'Rastreabilidade PRESCR_PROC_HOR_UPDATE Alteracoes(old/new)= ';

		if (coalesce(OLD.dt_horario,c_zero_date) <> coalesce(NEW.dt_horario,c_zero_date)) then
			ds_log_rastr_w := substr(ds_log_rastr_w || ' DT_HORARIO(' || to_char(OLD.dt_horario, 'dd/mm/yyyy hh24:mi:ss') || '/' || to_char(NEW.dt_horario, 'dd/mm/yyyy hh24:mi:ss')||'); ',1,1800);
		end if;

		if (coalesce(OLD.dt_lib_horario,c_zero_date) <> coalesce(NEW.dt_lib_horario,c_zero_date)) then
			ds_log_rastr_w := substr(ds_log_rastr_w || ' DT_LIB_HORARIO(' || to_char(OLD.dt_lib_horario, 'dd/mm/yyyy hh24:mi:ss') || '/' || to_char(NEW.dt_lib_horario, 'dd/mm/yyyy hh24:mi:ss')||'); ',1,1800);
		end if;

		if (coalesce(OLD.dt_fim_horario,c_zero_date) <> coalesce(NEW.dt_fim_horario,c_zero_date)) then
			ds_log_rastr_w := substr(ds_log_rastr_w || ' DT_FIM_HORARIO(' || to_char(OLD.dt_fim_horario, 'dd/mm/yyyy hh24:mi:ss') || '/' || to_char(NEW.dt_fim_horario, 'dd/mm/yyyy hh24:mi:ss')||'); ',1,1800);
		end if;

		if (coalesce(OLD.dt_suspensao,c_zero_date) <> coalesce(NEW.dt_suspensao,c_zero_date)) then
			ds_log_rastr_w := substr(ds_log_rastr_w || ' DT_SUSPENSAO(' || to_char(OLD.dt_suspensao, 'dd/mm/yyyy hh24:mi:ss') || '/' || to_char(NEW.dt_suspensao, 'dd/mm/yyyy hh24:mi:ss')||'); ',1,1800);
		end if;

		ds_log_rastr_w := substr(ds_log_rastr_w || 'NR_PRESCRICAO('||NEW.nr_prescricao||'); NR_SEQ_PROCEDIMENTO('||NEW.nr_seq_procedimento||'); FUNCAO('||to_char(wheb_usuario_pck.get_cd_funcao)||'); PERFIL('||to_char(cd_perfil_w)||');',1,1800);

		CALL gerar_log_prescricao(
			nr_prescricao_p		=> NEW.nr_prescricao,
			nr_seq_item_p		=> NEW.nr_seq_procedimento,
			ie_agrupador_p		=> null,
			nr_seq_horario_p	=> NEW.nr_sequencia,
			ie_tipo_item_p		=> 'P',
			ds_log_p			=> ds_log_rastr_w,
			nm_usuario_p		=> NEW.nm_usuario,
			nr_seq_objeto_p		=> 42283,
			ie_commit_p			=> 'N');
	end if;

	if (NEW.dt_horario <> OLD.dt_horario) and (OLD.dt_horario is not null) then
		NEW.ds_stack	:= substr(dbms_utility.format_call_stack,1,2000);
	end if;

end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_proc_hor_update() FROM PUBLIC;

CREATE TRIGGER prescr_proc_hor_update
	BEFORE UPDATE ON prescr_proc_hor FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_proc_hor_update();

