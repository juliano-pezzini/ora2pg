-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS lib_material_paciente_delete ON lib_material_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_lib_material_paciente_delete() RETURNS trigger AS $BODY$
declare	
nr_sequencia_w	bigint;
 
BEGIN 
 
update	prescr_material 
set	nr_seq_lib_mat_pac	 = NULL 
where	nr_prescricao		= OLD.nr_prescricao 
and	nr_sequencia		= OLD.nr_seq_material 
and	nr_seq_lib_mat_pac	= OLD.nr_sequencia;
 
select	nextval('lib_material_paciente_hist_seq') 
into STRICT	nr_sequencia_w
;	
 
insert into lib_material_paciente_hist( 
	nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	cd_pessoa_fisica, 
	cd_material, 
	dt_acao, 
	cd_pessoa_acao, 
	ie_tipo_acao, 
	qt_dias_tratamento, 
	dt_inicio_validade) 
values ( 
	nr_sequencia_w, 
	LOCALTIMESTAMP, 
	OLD.nm_usuario, 
	OLD.cd_pessoa_fisica, 
	OLD.cd_material, 
	LOCALTIMESTAMP, 
	substr(obter_dados_usuario_opcao(OLD.nm_usuario,'C'),1,100), 
	'E', 
	OLD.qt_dias_tratamento, 
	OLD.dt_inicio_validade);
RETURN OLD;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_lib_material_paciente_delete() FROM PUBLIC;

CREATE TRIGGER lib_material_paciente_delete
	BEFORE DELETE ON lib_material_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_lib_material_paciente_delete();

