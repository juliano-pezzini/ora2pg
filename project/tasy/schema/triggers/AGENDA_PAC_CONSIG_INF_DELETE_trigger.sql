-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS agenda_pac_consig_inf_delete ON agenda_pac_consig_inf CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_agenda_pac_consig_inf_delete() RETURNS trigger AS $BODY$
declare
ds_alteracao_w		varchar(4000) := null;
nr_seq_agenda_w		agenda_pac_consignado.nr_seq_agenda%type;
solicitacao_medica_w	varchar(255);
BEGIN
  BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

BEGIN
select max(nr_seq_agenda),
       max(ds_material)
into STRICT   nr_seq_agenda_w,
       solicitacao_medica_w
from   agenda_pac_consignado
where  nr_sequencia = OLD.nr_seq_age_consig;
exception
when others then
	nr_seq_agenda_w := 0;
end;

if (nr_seq_agenda_w > 0) then

	if (coalesce(OLD.DS_OBSERVACAO,'XPTO') <> 'XPTO') and (coalesce(OLD.ie_tipo_informacao,'X') = 'C') then
		ds_alteracao_w	:=	substr(wheb_mensagem_pck.get_texto(796514,
								'DS_OBSERVACAO='||OLD.DS_OBSERVACAO||
								';DS_MATERIAL='||solicitacao_medica_w),1,4000);
		if (ds_alteracao_w is not null) then
			CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'EC',ds_alteracao_w,OLD.nm_usuario);
		end if;	
	end if;	
	
	if (OLD.qt_material is not null) and (coalesce(OLD.ie_tipo_informacao,'X') = 'DE') then
		ds_alteracao_w	:=	substr(wheb_mensagem_pck.get_texto(796525,
								'QT_MATERIAL='||OLD.qt_material||
								';DS_MATERIAL='||solicitacao_medica_w),1,4000);
		if (ds_alteracao_w is not null) then
			CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'EDE',ds_alteracao_w,OLD.nm_usuario);
		end if;	
	end if;	
	
	if (OLD.qt_material is not null) and (coalesce(OLD.ie_tipo_informacao,'X') = 'DI') then
		ds_alteracao_w	:=	substr(wheb_mensagem_pck.get_texto(796525,
								'QT_MATERIAL='||OLD.qt_material||
								';DS_MATERIAL='||solicitacao_medica_w),1,4000);
		if (ds_alteracao_w is not null) then
			CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'EDI',ds_alteracao_w,OLD.nm_usuario);
		end if;	
	end if;	
	
	if (OLD.qt_material is not null) and (coalesce(OLD.ie_tipo_informacao,'X') = 'CO') then
		ds_alteracao_w	:=	substr(wheb_mensagem_pck.get_texto(796525,
								'QT_MATERIAL='||OLD.qt_material||
								';DS_MATERIAL='||solicitacao_medica_w),1,4000);
		if (ds_alteracao_w is not null) then
			CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ECO',ds_alteracao_w,OLD.nm_usuario);
		end if;	
	end if;	
	
	if (OLD.ie_retirada is not null) and (coalesce(OLD.ie_tipo_informacao,'X') = 'RE') then
		ds_alteracao_w	:=	substr(wheb_mensagem_pck.get_texto(796527,
								'IE_RETIRADA='||OLD.ie_retirada||
								';DS_MATERIAL='||solicitacao_medica_w),1,4000);
		if (ds_alteracao_w is not null) then
			CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ERE',ds_alteracao_w,OLD.nm_usuario);
		end if;	
	end if;	
	

	if	((coalesce(OLD.DS_OBSERVACAO,'XPTO') <> 'XPTO') or (coalesce(OLD.DS_CME_PREPARADO,'XPTO') <> 'XPTO')) and (coalesce(OLD.ie_tipo_informacao,'X') = 'M') then
		ds_alteracao_w	:=	substr(wheb_mensagem_pck.get_texto(796528,
								'DS_OBSERVACAO='||OLD.DS_OBSERVACAO||
								';DS_CME_PREPARADO='||OLD.DS_CME_PREPARADO||
								';DS_MATERIAL='||solicitacao_medica_w),1,4000);
		if (ds_alteracao_w is not null) then
		CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ECM',ds_alteracao_w,OLD.nm_usuario);
		end if;	
	end if;	

	if (coalesce(OLD.DS_OBSERVACAO,'XPTO') <> 'XPTO') and (coalesce(OLD.ie_tipo_informacao,'X') = 'A') then
		ds_alteracao_w	:=	substr(wheb_mensagem_pck.get_texto(796514,
								'DS_OBSERVACAO='||OLD.DS_OBSERVACAO||
								';DS_MATERIAL='||solicitacao_medica_w),1,4000);
		if (ds_alteracao_w is not null) then
		CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'EAG',ds_alteracao_w,OLD.nm_usuario);
		end if;	
	end if;	

	if (coalesce(OLD.DS_OBSERVACAO,'XPTO') <> 'XPTO') and (coalesce(OLD.ie_tipo_informacao,'X') = 'E') then
		ds_alteracao_w	:=	substr(wheb_mensagem_pck.get_texto(796514,
								'DS_OBSERVACAO='||OLD.DS_OBSERVACAO||
								';DS_MATERIAL='||solicitacao_medica_w),1,4000);
		if (ds_alteracao_w is not null) then
		CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'EE',ds_alteracao_w,OLD.nm_usuario);
		end if;	
	end if;	

	if (coalesce(OLD.DS_OBSERVACAO,'XPTO') <> 'XPTO') and (coalesce(OLD.ie_tipo_informacao,'X') = 'F') then
		ds_alteracao_w	:=	substr(wheb_mensagem_pck.get_texto(796514,
								'DS_OBSERVACAO='||OLD.DS_OBSERVACAO||
								';DS_MATERIAL='||solicitacao_medica_w),1,4000);
		if (ds_alteracao_w is not null) then
		CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'EF',ds_alteracao_w,OLD.nm_usuario);
		end if;	
	end if;	

	if (coalesce(OLD.DS_OBSERVACAO,'XPTO') <> 'XPTO') and (coalesce(OLD.ie_tipo_informacao,'X') = 'R') then
		ds_alteracao_w	:=	substr(wheb_mensagem_pck.get_texto(796514,
								'DS_OBSERVACAO='||OLD.DS_OBSERVACAO||
								';DS_MATERIAL='||solicitacao_medica_w),1,4000);
		if (ds_alteracao_w is not null) then
		CALL gravar_hist_planeja_consig(nr_seq_agenda_w,'ER',ds_alteracao_w,OLD.nm_usuario);
		end if;	
	end if;	
end if;	
end if;

  END;
RETURN OLD;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_agenda_pac_consig_inf_delete() FROM PUBLIC;

CREATE TRIGGER agenda_pac_consig_inf_delete
	BEFORE DELETE ON agenda_pac_consig_inf FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_agenda_pac_consig_inf_delete();

