-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS proj_rat_ativ_valor_delete ON proj_rat_ativ CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_proj_rat_ativ_valor_delete() RETURNS trigger AS $BODY$
declare
qt_hora_old_w		double precision;
qt_hora_adic_old_w	double precision;
qt_hora_w		double precision;
qt_hora_adic_w		double precision;

BEGIN
if (OLD.nr_seq_etapa_cron is not null) then
	BEGIN
	select	coalesce(qt_hora_real,0),
		coalesce(qt_horas_etapa_adic,0)
	into STRICT	qt_hora_old_w,
		qt_hora_adic_old_w
	from	proj_cron_etapa
	where	nr_sequencia = OLD.nr_seq_etapa_cron;

	select	coalesce((coalesce(qt_hora_real,0) - dividir(coalesce(OLD.qt_min_ativ,0),60)),0)
	into STRICT	qt_hora_w
	from	proj_cron_etapa
	where	nr_sequencia = OLD.nr_seq_etapa_cron;

	if (OLD.ie_atividade_extra = 'S') then
		qt_hora_adic_w := coalesce(round((dividir(OLD.qt_min_ativ,60))::numeric,2),0);
	end if;

	if (coalesce(wheb_usuario_pck.get_ie_executar_trigger, 'S') = 'S') then
		update	proj_cron_etapa
		set		qt_hora_real = coalesce(qt_hora_w,0),
				qt_horas_etapa_adic = qt_hora_adic_w - coalesce(qt_hora_adic_w,0)
		where	nr_sequencia = OLD.nr_seq_etapa_cron;
	end if;
	end;
end if;
RETURN OLD;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_proj_rat_ativ_valor_delete() FROM PUBLIC;

CREATE TRIGGER proj_rat_ativ_valor_delete
	BEFORE DELETE ON proj_rat_ativ FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_proj_rat_ativ_valor_delete();

