-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS hd_dial_dialisador_befup_sign ON hd_dialise_dialisador CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_hd_dial_dialisador_befup_sign() RETURNS trigger AS $BODY$
declare
nr_seq_assinatura_w	hd_assinatura_digital.nr_sequencia%type;

BEGIN

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_dialise_dialisador = NEW.nr_sequencia
and 	ie_opcao = 'MD'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_montagem 		<> NEW.dt_montagem
		or OLD.cd_pf_montagem 		<> NEW.cd_pf_montagem
		or OLD.nr_seq_dialisador 	<> NEW.nr_seq_dialisador
		or OLD.nr_seq_maquina 		<> NEW.nr_seq_maquina
		or OLD.nr_seq_dialise 		<> NEW.nr_seq_dialise
		or OLD.nr_seq_ponto_acesso 	<> NEW.nr_seq_ponto_acesso
		or OLD.ie_troca_emergencia 	<> NEW.ie_troca_emergencia
		or OLD.nr_seq_unid_dialise 	<> NEW.nr_seq_unid_dialise
		or OLD.qt_reuso_atual 		<> NEW.qt_reuso_atual
		or OLD.nr_seq_osmose 		<> NEW.nr_seq_osmose
		or (OLD.dt_montagem		is null		and	NEW.dt_montagem		is not null)
		or (OLD.cd_pf_montagem		is null		and	NEW.cd_pf_montagem		is not null)
		or (OLD.nr_seq_dialisador	is null		and	NEW.nr_seq_dialisador		is not null)
		or (OLD.nr_seq_maquina		is null		and	NEW.nr_seq_maquina		is not null)
		or (OLD.nr_seq_dialise		is null		and	NEW.nr_seq_dialise		is not null)
		or (OLD.nr_seq_ponto_acesso	is null		and	NEW.nr_seq_ponto_acesso	is not null)
		or (OLD.ie_troca_emergencia	is null		and	NEW.ie_troca_emergencia	is not null)
		or (OLD.nr_seq_unid_dialise	is null		and	NEW.nr_seq_unid_dialise	is not null)
		or (OLD.qt_reuso_atual		is null		and	NEW.qt_reuso_atual		is not null)
		or (OLD.nr_seq_osmose		is null		and	NEW.nr_seq_osmose		is not null)
		or (OLD.dt_montagem		is not null	and	NEW.dt_montagem		is null)
		or (OLD.cd_pf_montagem		is not null	and	NEW.cd_pf_montagem		is null)
		or (OLD.nr_seq_dialisador	is not null	and	NEW.nr_seq_dialisador		is null)
		or (OLD.nr_seq_maquina		is not null	and	NEW.nr_seq_maquina		is null)
		or (OLD.nr_seq_dialise		is not null	and	NEW.nr_seq_dialise		is null)
		or (OLD.nr_seq_ponto_acesso	is not null	and	NEW.nr_seq_ponto_acesso	is null)
		or (OLD.ie_troca_emergencia	is not null	and	NEW.ie_troca_emergencia	is null)
		or (OLD.nr_seq_unid_dialise	is not null	and	NEW.nr_seq_unid_dialise	is null)
		or (OLD.qt_reuso_atual		is not null	and	NEW.qt_reuso_atual		is null)
		or (OLD.nr_seq_osmose		is not null	and	NEW.nr_seq_osmose		is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_seq_dial_retirada = NEW.nr_sequencia
and 	ie_opcao = 'C'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_retirada		<> NEW.dt_retirada
		or OLD.cd_pf_retirada		<> NEW.cd_pf_retirada
		or OLD.ds_motivo_subst		<> NEW.ds_motivo_subst
		or (OLD.dt_retirada		is null		and	NEW.dt_retirada	is not null)
		or (OLD.cd_pf_retirada		is null		and	NEW.cd_pf_retirada	is not null)
		or (OLD.ds_motivo_subst	is null		and	NEW.ds_motivo_subst	is not null)
		or (OLD.dt_retirada		is not null	and	NEW.dt_retirada	is null)
		or (OLD.cd_pf_retirada		is not null	and	NEW.cd_pf_retirada	is null)
		or (OLD.ds_motivo_subst	is not null	and	NEW.ds_motivo_subst	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_dialise_dialisador = NEW.nr_sequencia
and 	ie_opcao = 'TI'
and	dt_liberacao is not null
and	OLD.dt_retirada is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_retirada		<> NEW.dt_retirada
		or OLD.cd_pf_retirada		<> NEW.cd_pf_retirada
		or OLD.ds_motivo_subst		<> NEW.ds_motivo_subst
		or (OLD.dt_retirada		is null		and	NEW.dt_retirada	is not null)
		or (OLD.cd_pf_retirada		is null		and	NEW.cd_pf_retirada	is not null)
		or (OLD.ds_motivo_subst	is null		and	NEW.ds_motivo_subst	is not null)
		or (OLD.dt_retirada		is not null	and	NEW.dt_retirada	is null)
		or (OLD.cd_pf_retirada		is not null	and	NEW.cd_pf_retirada	is null)
		or (OLD.ds_motivo_subst	is not null	and	NEW.ds_motivo_subst	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_seq_dial_retirada = NEW.nr_sequencia
and 	ie_opcao = 'SD'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_retirada		<> NEW.dt_retirada
		or OLD.cd_pf_retirada          <> NEW.cd_pf_retirada
		or OLD.ds_motivo_subst         <> NEW.ds_motivo_subst
		or (OLD.dt_retirada		is null		and	NEW.dt_retirada	is not null)
		or (OLD.cd_pf_retirada		is null		and	NEW.cd_pf_retirada	is not null)
		or (OLD.ds_motivo_subst	is null		and	NEW.ds_motivo_subst	is not null)
		or (OLD.dt_retirada		is not null	and	NEW.dt_retirada	is null)
		or (OLD.cd_pf_retirada		is not null	and	NEW.cd_pf_retirada	is null)
		or (OLD.ds_motivo_subst	is not null	and	NEW.ds_motivo_subst	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_dialise_dialisador = NEW.nr_sequencia
and 	ie_opcao = 'SD'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_montagem		<> NEW.dt_montagem
		or OLD.cd_pf_montagem          <> NEW.cd_pf_montagem
		or OLD.nr_seq_dialisador       <> NEW.nr_seq_dialisador
		or OLD.nr_seq_maquina		<> NEW.nr_seq_maquina
		or OLD.nr_seq_dialise          <> NEW.nr_seq_dialise
		or OLD.nr_seq_ponto_acesso     <> NEW.nr_seq_ponto_acesso
		or OLD.ie_troca_emergencia     <> NEW.ie_troca_emergencia
		or OLD.nr_seq_unid_dialise     <> NEW.nr_seq_unid_dialise
		or OLD.qt_reuso_atual          <> NEW.qt_reuso_atual
		or OLD.nr_seq_osmose           <> NEW.nr_seq_osmose
		or (OLD.dt_montagem		is null		and	NEW.dt_montagem		is not null)
		or (OLD.cd_pf_montagem		is null		and	NEW.cd_pf_montagem		is not null)
		or (OLD.nr_seq_dialisador	is null		and	NEW.nr_seq_dialisador		is not null)
		or (OLD.nr_seq_maquina		is null		and	NEW.nr_seq_maquina		is not null)
		or (OLD.nr_seq_dialise		is null		and	NEW.nr_seq_dialise		is not null)
		or (OLD.nr_seq_ponto_acesso	is null		and	NEW.nr_seq_ponto_acesso	is not null)
		or (OLD.ie_troca_emergencia	is null		and	NEW.ie_troca_emergencia	is not null)
		or (OLD.nr_seq_unid_dialise	is null		and	NEW.nr_seq_unid_dialise	is not null)
		or (OLD.qt_reuso_atual		is null		and	NEW.qt_reuso_atual		is not null)
		or (OLD.nr_seq_osmose		is null		and	NEW.nr_seq_osmose		is not null)
		or (OLD.dt_montagem		is not null	and	NEW.dt_montagem		is null)
		or (OLD.cd_pf_montagem		is not null	and	NEW.cd_pf_montagem		is null)
		or (OLD.nr_seq_dialisador	is not null	and	NEW.nr_seq_dialisador		is null)
		or (OLD.nr_seq_maquina		is not null	and	NEW.nr_seq_maquina		is null)
		or (OLD.nr_seq_dialise		is not null	and	NEW.nr_seq_dialise		is null)
		or (OLD.nr_seq_ponto_acesso	is not null	and	NEW.nr_seq_ponto_acesso	is null)
		or (OLD.ie_troca_emergencia	is not null	and	NEW.ie_troca_emergencia	is null)
		or (OLD.nr_seq_unid_dialise	is not null	and	NEW.nr_seq_unid_dialise	is null)
		or (OLD.qt_reuso_atual		is not null	and	NEW.qt_reuso_atual		is null)
		or (OLD.nr_seq_osmose		is not null	and	NEW.nr_seq_osmose		is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_seq_dial_retirada = NEW.nr_sequencia
and 	ie_opcao = 'RD'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_retirada		<> NEW.dt_retirada
		or OLD.cd_pf_retirada		<> NEW.cd_pf_retirada
		or OLD.ds_motivo_subst		<> NEW.ds_motivo_subst
		or (OLD.dt_retirada		is null		and	NEW.dt_retirada	is not null)
		or (OLD.cd_pf_retirada		is null		and	NEW.cd_pf_retirada	is not null)
		or (OLD.ds_motivo_subst	is null		and	NEW.ds_motivo_subst	is not null)
		or (OLD.dt_retirada		is not null	and	NEW.dt_retirada	is null)
		or (OLD.cd_pf_retirada		is not null	and	NEW.cd_pf_retirada	is null)
		or (OLD.ds_motivo_subst	is not null	and	NEW.ds_motivo_subst	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_seq_dial_retirada = NEW.nr_sequencia
and 	ie_opcao = 'SM'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_retirada		<> NEW.dt_retirada
		or OLD.cd_pf_retirada		<> NEW.cd_pf_retirada
		or OLD.nr_seq_motivo_sub	<> NEW.nr_seq_motivo_sub
		or (OLD.dt_retirada		is null		and	NEW.dt_retirada	is not null)
		or (OLD.cd_pf_retirada		is null		and	NEW.cd_pf_retirada	is not null)
		or (OLD.nr_seq_motivo_sub	is null		and	NEW.nr_seq_motivo_sub	is not null)
		or (OLD.dt_retirada		is not null	and	NEW.dt_retirada	is null)
		or (OLD.cd_pf_retirada		is not null	and	NEW.cd_pf_retirada	is null)
		or (OLD.nr_seq_motivo_sub	is not null	and	NEW.nr_seq_motivo_sub	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_dialise_dialisador = NEW.nr_sequencia
and 	ie_opcao = 'SM'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_montagem		<> NEW.dt_montagem
		or OLD.cd_pf_montagem          <> NEW.cd_pf_montagem
		or OLD.nr_seq_dialisador       <> NEW.nr_seq_dialisador
		or OLD.nr_seq_maquina		<> NEW.nr_seq_maquina
		or OLD.nr_seq_dialise          <> NEW.nr_seq_dialise
		or OLD.nr_seq_ponto_acesso     <> NEW.nr_seq_ponto_acesso
		or OLD.ie_troca_emergencia     <> NEW.ie_troca_emergencia
		or OLD.nr_seq_unid_dialise     <> NEW.nr_seq_unid_dialise
		or OLD.qt_reuso_atual          <> NEW.qt_reuso_atual
		or OLD.nr_seq_osmose           <> NEW.nr_seq_osmose
		or (OLD.dt_montagem		is null		and	NEW.dt_montagem		is not null)
		or (OLD.cd_pf_montagem		is null		and	NEW.cd_pf_montagem		is not null)
		or (OLD.nr_seq_dialisador	is null		and	NEW.nr_seq_dialisador		is not null)
		or (OLD.nr_seq_maquina		is null		and	NEW.nr_seq_maquina		is not null)
		or (OLD.nr_seq_dialise		is null		and	NEW.nr_seq_dialise		is not null)
		or (OLD.nr_seq_ponto_acesso	is null		and	NEW.nr_seq_ponto_acesso	is not null)
		or (OLD.ie_troca_emergencia	is null		and	NEW.ie_troca_emergencia	is not null)
		or (OLD.nr_seq_unid_dialise	is null		and	NEW.nr_seq_unid_dialise	is not null)
		or (OLD.qt_reuso_atual		is null		and	NEW.qt_reuso_atual		is not null)
		or (OLD.nr_seq_osmose		is null		and	NEW.nr_seq_osmose		is not null)
		or (OLD.dt_montagem		is not null	and	NEW.dt_montagem		is null)
		or (OLD.cd_pf_montagem		is not null	and	NEW.cd_pf_montagem		is null)
		or (OLD.nr_seq_dialisador	is not null	and	NEW.nr_seq_dialisador		is null)
		or (OLD.nr_seq_maquina		is not null	and	NEW.nr_seq_maquina		is null)
		or (OLD.nr_seq_dialise		is not null	and	NEW.nr_seq_dialise		is null)
		or (OLD.nr_seq_ponto_acesso	is not null	and	NEW.nr_seq_ponto_acesso	is null)
		or (OLD.ie_troca_emergencia	is not null	and	NEW.ie_troca_emergencia	is null)
		or (OLD.nr_seq_unid_dialise	is not null	and	NEW.nr_seq_unid_dialise	is null)
		or (OLD.qt_reuso_atual		is not null	and	NEW.qt_reuso_atual		is null)
		or (OLD.nr_seq_osmose		is not null	and	NEW.nr_seq_osmose		is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_seq_dial_retirada = NEW.nr_sequencia
and 	ie_opcao = 'FD'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_retirada		<> NEW.dt_retirada
		or OLD.cd_pf_retirada		<> NEW.cd_pf_retirada
		or OLD.ds_motivo_subst		<> NEW.ds_motivo_subst
		or (OLD.dt_retirada		is null		and	NEW.dt_retirada	is not null)
		or (OLD.cd_pf_retirada		is null		and	NEW.cd_pf_retirada	is not null)
		or (OLD.ds_motivo_subst	is null		and	NEW.ds_motivo_subst	is not null)
		or (OLD.dt_retirada		is not null	and	NEW.dt_retirada	is null)
		or (OLD.cd_pf_retirada		is not null	and	NEW.cd_pf_retirada	is null)
		or (OLD.ds_motivo_subst	is not null	and	NEW.ds_motivo_subst	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_hd_dial_dialisador_befup_sign() FROM PUBLIC;

CREATE TRIGGER hd_dial_dialisador_befup_sign
	BEFORE UPDATE ON hd_dialise_dialisador FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_hd_dial_dialisador_befup_sign();

