-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS fluxo_caixa_atual ON fluxo_caixa CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_fluxo_caixa_atual() RETURNS trigger AS $BODY$
DECLARE

cont_w	bigint := 0;
ie_fechamento_diario_w	varchar(10);

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
if (obter_bloq_canc_proj_rec(NEW.nr_seq_proj_rec) > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1144309);  -- Registro associado a um projeto bloqueado ou cancelado. 
end if;

ie_fechamento_diario_w := Obter_Param_Usuario(830, 22, obter_perfil_ativo, NEW.nm_usuario, NEW.cd_estabelecimento, ie_fechamento_diario_w);

if (ie_fechamento_diario_w = 'S') then

	if (coalesce(NEW.ie_classif_fluxo,OLD.ie_classif_fluxo) = 'O') then
		select	count(*)
		into STRICT	cont_w
		from	fluxo_caixa_fechamento
		where	dt_referencia		 				= coalesce(NEW.dt_referencia,OLD.dt_referencia)
		and	cd_empresa						= coalesce(NEW.cd_empresa,OLD.cd_empresa)
		and	coalesce(ie_tipo_fluxo, 'G')					= 'O'
		and	coalesce(cd_estabelecimento, NEW.cd_estabelecimento)		= NEW.cd_estabelecimento;
	elsif (coalesce(NEW.ie_classif_fluxo,OLD.ie_classif_fluxo) = 'P') then
		select	count(*)
		into STRICT	cont_w
		from	fluxo_caixa_fechamento
		where	dt_referencia						= coalesce(NEW.dt_referencia,OLD.dt_referencia)
		and	cd_empresa						= coalesce(NEW.cd_empresa,OLD.cd_empresa)
		and	coalesce(ie_tipo_fluxo, 'G')					= 'G'
		and	coalesce(coalesce(cd_estabelecimento, NEW.cd_estabelecimento), -1)	= coalesce(NEW.cd_estabelecimento,coalesce(OLD.cd_estabelecimento,coalesce(cd_estabelecimento,-1)));
	end if;

else

	if (coalesce(NEW.ie_classif_fluxo,OLD.ie_classif_fluxo) = 'O') then
		select	count(*)
		into STRICT	cont_w
		from	fluxo_caixa_fechamento
		where	trunc(dt_referencia,'month') 					= trunc(coalesce(NEW.dt_referencia,OLD.dt_referencia),'month')
		and	cd_empresa						= coalesce(NEW.cd_empresa,OLD.cd_empresa)
		and	coalesce(ie_tipo_fluxo, 'G')					= 'O'
		and	coalesce(cd_estabelecimento, NEW.cd_estabelecimento) 		= NEW.cd_estabelecimento;
	elsif (coalesce(NEW.ie_classif_fluxo,OLD.ie_classif_fluxo) = 'P') then
		select	count(*)
		into STRICT	cont_w
		from	fluxo_caixa_fechamento
		where	trunc(dt_referencia,'month') 					= trunc(coalesce(NEW.dt_referencia,OLD.dt_referencia),'month')
		and	cd_empresa						= coalesce(NEW.cd_empresa,OLD.cd_empresa)
		and	coalesce(ie_tipo_fluxo, 'G')					= 'G'
		and	coalesce(coalesce(cd_estabelecimento, NEW.cd_estabelecimento), -1)	= coalesce(NEW.cd_estabelecimento,coalesce(OLD.cd_estabelecimento,coalesce(cd_estabelecimento,-1)));
	end if;

end if;

if (cont_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(176744,	'DT_REFERENCIA_W=' || coalesce(NEW.dt_referencia,OLD.dt_referencia) || ';' ||
							'CD_ESTABELECIMENTO_W=' || coalesce(NEW.cd_estabelecimento,OLD.cd_estabelecimento));
end if;	
end if;

IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_fluxo_caixa_atual() FROM PUBLIC;

CREATE TRIGGER fluxo_caixa_atual
	BEFORE INSERT OR UPDATE OR DELETE ON fluxo_caixa FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_fluxo_caixa_atual();

