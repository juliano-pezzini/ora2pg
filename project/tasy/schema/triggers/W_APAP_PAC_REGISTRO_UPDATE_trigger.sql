-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS w_apap_pac_registro_update ON w_apap_pac_registro CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_w_apap_pac_registro_update() RETURNS trigger AS $BODY$
declare
nm_tabela_w				w_apap_pac_informacao.nm_tabela%type;
nm_atributo_tabela_w	w_apap_pac_informacao.nm_atributo_tabela%type;
nm_atrib_vl_graf_w		linked_data_atributo.nm_atrib_vl_graf%type;
ie_plot_style_w			w_apap_pac_informacao.ie_plot_style%type;
nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
cd_pessoa_fisica_w		atendimento_paciente.cd_pessoa_fisica%type;
nr_sequencia_w			w_apap_pac_informacao.nr_sequencia%type;
vl_param_regra_destaque_w	valor_dominio.vl_dominio%type;
ie_alerta_w				w_apap_pac_registro.ie_alerta%type;
ds_cor_w				sinal_vital_regra.ds_cor_min%type;
cd_perfil_w				perfil.cd_perfil%type 					:= wheb_usuario_pck.get_cd_perfil;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type	:= wheb_usuario_pck.get_cd_estabelecimento;
nm_usuario_w			usuario.nm_usuario%type					:= wheb_usuario_pck.get_nm_usuario;
BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	<> 'N')  then
	vl_param_regra_destaque_w := obter_param_usuario(1355, 4, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, vl_param_regra_destaque_w);
	if (vl_param_regra_destaque_w <> 'N') then
		select	max(a.nm_tabela),
				max(a.nm_atributo_tabela),
				max(select	y.nm_atrib_vl_graf from linked_data_atributo y where y.nm_atributo_linked = a.nm_atributo_linked and a.nr_seq_linked_data = y.nr_seq_linked_data) nm_atrib_vl_graf,
				max(c.nr_atendimento),
				upper(max(a.ie_plot_style)),
				max(a.nr_sequencia),
				max(c.cd_pessoa_fisica)
		into STRICT	nm_tabela_w,
				nm_atributo_tabela_w,
				nm_atrib_vl_graf_w,
				nr_atendimento_w,
				ie_plot_style_w,
				nr_sequencia_w,
				cd_pessoa_fisica_w
		from	w_apap_pac_informacao a,
				w_apap_pac_grupo b,
				w_apap_pac c
		where	a.nr_seq_apap_grupo = b.nr_sequencia
		and		b.nr_seq_mod_apap	= c.nr_sequencia
		and		a.nr_sequencia 		= NEW.nr_seq_apap_inf;
		
		if	(nm_tabela_w = 'ATENDIMENTO_SINAL_VITAL' AND NEW.vl_resultado is not null) then
			select	coalesce(max(ie_alerta),'N'),
					max(ds_cor)
			into STRICT	NEW.ie_alerta,
					NEW.ds_cor
			from	table(apap_limite_pck.get_limite(nr_atendimento_w,cd_pessoa_fisica_w,NEW.vl_resultado,coalesce(nm_atributo_tabela_w,nm_atrib_vl_graf_w),vl_param_regra_destaque_w));
		elsif (ie_plot_style_w = 'CANDLESTICK') and (nm_tabela_w = 'ATENDIMENTO_SINAL_VITAL') and (NEW.vl_resultado is null) and (NEW.vl_pas is not null) and (NEW.vl_pad is not null) then
			select	coalesce(max(ie_alerta),'N')
			into STRICT    NEW.ie_alerta_max
			from	table(apap_limite_pck.get_limite(nr_atendimento_w,cd_pessoa_fisica_w,NEW.vl_pas,'QT_PA_SISTOLICA',vl_param_regra_destaque_w));
			
			select	coalesce(max(ie_alerta),'N')
			into STRICT	NEW.ie_alerta_min
			from	table(apap_limite_pck.get_limite(nr_atendimento_w,cd_pessoa_fisica_w,NEW.vl_pad,'QT_PA_DIASTOLICA',vl_param_regra_destaque_w));
			
			select	coalesce(max(ie_alerta),'N')
			into STRICT    NEW.ie_alerta_med
			from	table(apap_limite_pck.get_limite(nr_atendimento_w,cd_pessoa_fisica_w,NEW.vl_pam,'QT_PAM',vl_param_regra_destaque_w));
		end if;	
	end if;	
end if;	

if (TG_OP = 'UPDATE') and (NEW.nr_seq_origem is not null) and
	((OLD.vl_resultado <> coalesce(NEW.vl_resultado,0)) or (OLD.ds_resultado <> coalesce(NEW.ds_resultado,'XPTO')) or
	((OLD.dt_resultado <> NEW.dt_resultado) and ((OLD.dt_resultado is not null) or (NEW.dt_resultado is not null)))) then
	NEW.ie_editado := 'S';
end if;	

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_w_apap_pac_registro_update() FROM PUBLIC;

CREATE TRIGGER w_apap_pac_registro_update
	BEFORE INSERT OR UPDATE ON w_apap_pac_registro FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_w_apap_pac_registro_update();

