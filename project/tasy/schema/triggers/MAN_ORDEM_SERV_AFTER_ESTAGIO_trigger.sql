-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS man_ordem_serv_after_estagio ON man_ordem_servico CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_man_ordem_serv_after_estagio() RETURNS trigger AS $BODY$
declare
dt_estagio_anterior_w		timestamp;
nr_seq_gerencia_w		bigint;
cd_pessoa_gerente_w		varchar(10);
qt_minuto_pre_analise_w		bigint;
ie_origem_alteracao_w		varchar(1);

BEGIN

if (user = 'CORP') or (obter_se_base_wheb = 'S') then

	if (OLD.nr_seq_estagio is null) and (NEW.nr_seq_estagio in (1051,231,1731)) then --Desenv aguardando triagem, Aguardando triagem, Tec aguardando triagem
		if (NEW.nr_seq_grupo_des is not null) then

			select	max(nr_seq_gerencia)
			into STRICT	nr_seq_gerencia_w
			from	grupo_desenvolvimento
			where	nr_sequencia = NEW.nr_seq_grupo_des;

		elsif (NEW.nr_seq_grupo_sup is not null) then

			select	max(nr_seq_gerencia_sup)
			into STRICT	nr_seq_gerencia_w
			from	grupo_suporte
			where	nr_sequencia = NEW.nr_seq_grupo_sup;

		end if;

		select	substr(obter_responsavel_gerencia(nr_seq_gerencia_w), 1, 10),
			CASE WHEN upper(NEW.nm_usuario)='WEBSERVICE' THEN  'E' WHEN upper(NEW.nm_usuario)='WEBSERVICE 2' THEN  'E' WHEN upper(NEW.nm_usuario)='WEB' THEN  'E' WHEN upper(NEW.nm_usuario)='WEBSERVER' THEN  'E'  ELSE 'I' END
		into STRICT	cd_pessoa_gerente_w,
			ie_origem_alteracao_w
		;

		insert into man_ordem_serv_log_triagem(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_ordem_serv,
			nr_seq_localizacao,
			nr_seq_grupo_des,
			nr_seq_grupo_sup,
			nr_seq_gerencia,
			cd_pessoa_gerente,
			nr_seq_estagio_anterior,
			dt_estagio_anterior,
			nr_seq_estagio_atual,
			dt_estagio_atual,
			ie_classificacao_cliente,
			ie_classificacao_philips,
			ie_prioridade_cliente,
			ie_prioridade_philips,
			qt_minuto_pre_analise,
			dt_ordem_servico,
			dt_inicio_real,
			ie_origem_alteracao)
		values (	nextval('man_ordem_serv_log_triagem_seq'),
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			NEW.nr_sequencia,
			NEW.nr_seq_localizacao,
			NEW.nr_seq_grupo_des,
			NEW.nr_seq_grupo_sup,
			nr_seq_gerencia_w,
			cd_pessoa_gerente_w,
			null,
			null,
			NEW.nr_seq_estagio,
			LOCALTIMESTAMP,
			NEW.ie_classificacao_cliente,
			NEW.ie_classificacao,
			NEW.ie_prioridade_cliente,
			NEW.ie_prioridade,
			0,
			NEW.dt_ordem_servico,
			LOCALTIMESTAMP,
			ie_origem_alteracao_w);

	elsif (OLD.nr_seq_estagio in (1051,231,1731)) and --Desenv aguardando triagem, Aguardando triagem, Tec aguardando triagem
		(NEW.nr_seq_estagio is not null) and (NEW.nr_seq_estagio <> OLD.nr_seq_estagio) then

		select	max(dt_atualizacao)
		into STRICT	dt_estagio_anterior_w
		from	man_ordem_serv_estagio
		where	nr_seq_ordem = NEW.nr_sequencia
		and	nr_seq_estagio = OLD.nr_seq_estagio;

		if (OLD.nr_seq_grupo_des is not null) then

			select	max(nr_seq_gerencia)
			into STRICT	nr_seq_gerencia_w
			from	grupo_desenvolvimento
			where	nr_sequencia = OLD.nr_seq_grupo_des;

		elsif (OLD.nr_seq_grupo_sup is not null) then

			select	max(nr_seq_gerencia_sup)
			into STRICT	nr_seq_gerencia_w
			from	grupo_suporte
			where	nr_sequencia = OLD.nr_seq_grupo_sup;

		end if;

		select	substr(obter_responsavel_gerencia(nr_seq_gerencia_w), 1, 10),
			CASE WHEN upper(NEW.nm_usuario)='WEBSERVICE' THEN  'E' WHEN upper(NEW.nm_usuario)='WEBSERVICE 2' THEN  'E' WHEN upper(NEW.nm_usuario)='WEB' THEN  'E' WHEN upper(NEW.nm_usuario)='WEBSERVER' THEN  'E'  ELSE 'I' END
		into STRICT	cd_pessoa_gerente_w,
			ie_origem_alteracao_w
		;

		if (trunc(dt_estagio_anterior_w, 'dd') = trunc(LOCALTIMESTAMP, 'dd')) or (obter_cod_dia_semana(LOCALTIMESTAMP) in (7, 1) or
			 obter_se_feriado(1, LOCALTIMESTAMP) > 0) then
			select (LOCALTIMESTAMP - dt_estagio_anterior_w) * 1440
			into STRICT	qt_minuto_pre_analise_w
			;
		else
			select	man_obter_min_com(1, dt_estagio_anterior_w, LOCALTIMESTAMP)
			into STRICT	qt_minuto_pre_analise_w
			;
		end if;

		insert into man_ordem_serv_log_triagem(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_ordem_serv,
			nr_seq_localizacao,
			nr_seq_grupo_des,
			nr_seq_grupo_sup,
			nr_seq_gerencia,
			cd_pessoa_gerente,
			nr_seq_estagio_anterior,
			dt_estagio_anterior,
			nr_seq_estagio_atual,
			dt_estagio_atual,
			ie_classificacao_cliente,
			ie_classificacao_philips,
			ie_prioridade_cliente,
			ie_prioridade_philips,
			qt_minuto_pre_analise,
			dt_ordem_servico,
			dt_inicio_real,
			ie_origem_alteracao)
		values (	nextval('man_ordem_serv_log_triagem_seq'),
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			NEW.nr_sequencia,
			NEW.nr_seq_localizacao,
			OLD.nr_seq_grupo_des,
			OLD.nr_seq_grupo_sup,
			nr_seq_gerencia_w,
			cd_pessoa_gerente_w,
			OLD.nr_seq_estagio,
			dt_estagio_anterior_w,
			NEW.nr_seq_estagio,
			LOCALTIMESTAMP,
			OLD.ie_classificacao_cliente,
			OLD.ie_classificacao,
			OLD.ie_prioridade_cliente,
			OLD.ie_prioridade,
			coalesce(qt_minuto_pre_analise_w,0),
			NEW.dt_ordem_servico,
			LOCALTIMESTAMP,
			ie_origem_alteracao_w);
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_man_ordem_serv_after_estagio() FROM PUBLIC;

CREATE TRIGGER man_ordem_serv_after_estagio
	AFTER INSERT OR UPDATE OF nr_seq_estagio ON man_ordem_servico FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_man_ordem_serv_after_estagio();

