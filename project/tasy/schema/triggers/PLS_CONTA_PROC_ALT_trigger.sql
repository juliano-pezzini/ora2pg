-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_conta_proc_alt ON pls_conta_proc CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_conta_proc_alt() RETURNS trigger AS $BODY$
declare

ds_log_call_w			varchar(1500);
ds_observacao_w			varchar(4000);

BEGIN
if (coalesce(wheb_usuario_pck.get_ie_lote_contabil,'N') = 'N') and (coalesce(wheb_usuario_pck.get_ie_atualizacao_contabil,'N') = 'N')  then
	if ( pls_se_aplicacao_tasy = 'N') or ( NEW.ie_status	!= 'D' and OLD.ie_status	= 'D') or (OLD.ie_status = 'M' and NEW.ie_status <> 'M') or
		(NEW.vl_procedimento_imp = 0 AND NEW.ie_valor_informado ='S')then

		ds_log_call_w := substr(pls_obter_detalhe_exec(false),1,1500);/*substr(	' Função ativa : '|| obter_funcao_ativa || chr(13) ||chr(10)||
				' CallStack: '|| chr(13) || chr(10)|| dbms_utility.format_call_stack,1,1500);*/
				--' Função ativa : '|| obter_funcao_ativa || chr(13) ||chr(10)||
		ds_observacao_w := 'Conta: '||OLD.nr_seq_conta||' ; Conta proc: '||OLD.nr_sequencia;

		if (coalesce(OLD.cd_procedimento,0) <> coalesce(NEW.cd_procedimento,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Código procedimento:'||chr(13)||chr(10)||
						chr(9)||'Anterior: '||OLD.cd_procedimento||' - Modificado: '||NEW.cd_procedimento||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.ie_origem_proced,0) <> coalesce(NEW.ie_origem_proced,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Origem do procedimento:'||chr(13)||chr(10)||
						chr(9)||'Anterior: '||OLD.ie_origem_proced||' - Modificado: '||NEW.ie_origem_proced||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.ie_valor_informado,'X') <> coalesce(NEW.ie_valor_informado,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Valor informado: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.ie_valor_informado||' - Modificada: '||NEW.ie_valor_informado;
		end if;

		if (coalesce(OLD.ie_status,'X') <> coalesce(NEW.ie_status,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Status: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.ie_status||' - Modificada: '||NEW.ie_status;
		end if;

		if (coalesce(OLD.vl_procedimento_imp,0) <> coalesce(NEW.vl_procedimento_imp,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Valor apresentado:'||chr(13)||chr(10)||
						chr(9)||'Anterior: '||OLD.vl_procedimento_imp||' - Modificado: '||NEW.vl_procedimento_imp||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.qt_procedimento_imp,0) <> coalesce(NEW.qt_procedimento_imp,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Quantidade apresentada:'||chr(13)||chr(10)||
						chr(9)||'Anterior: '||OLD.qt_procedimento_imp||' - Modificado: '||NEW.qt_procedimento_imp||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.vl_liberado,0) <> coalesce(NEW.vl_liberado,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Valor liberado:'||chr(13)||chr(10)||
						chr(9)||'Anterior: '||OLD.vl_liberado||' - Modificado: '||NEW.vl_liberado||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.vl_prestador,0) <> coalesce(NEW.vl_prestador,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Valor prestador:'||chr(13)||chr(10)||
						chr(9)||'Anterior: '||OLD.vl_prestador||' - Modificado: '||NEW.vl_prestador||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.ie_tecnica_utilizada,'X') <> coalesce(NEW.ie_tecnica_utilizada,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Técnica utilizada:'||chr(13)||chr(10)||
						chr(9)||'Anterior: '||obter_valor_dominio(1834, OLD.ie_tecnica_utilizada)||' - Modificada: '||
						obter_valor_dominio(1834, NEW.ie_tecnica_utilizada)||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.ie_criterio_horario,'X') <> coalesce(NEW.ie_criterio_horario,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Critério de horário:'||chr(13)||chr(10)||
						chr(9)||'Anterior: '||OLD.ie_criterio_horario||' - Modificado: '||NEW.ie_criterio_horario||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.ie_via_acesso,'X') <> coalesce(NEW.ie_via_acesso,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Via acesso: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '||obter_valor_dominio(1268, OLD.ie_via_acesso)||' - Modificada: '||
						obter_valor_dominio(1268, NEW.ie_via_acesso)||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.tx_item,0) <> coalesce(NEW.tx_item,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'% Taxa: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '||OLD.tx_item||' - Modificada: '||coalesce(NEW.tx_item,0)||chr(13)||chr(10);
		end if;


		if (coalesce(to_char(OLD.dt_procedimento),'X') <> coalesce(to_char(NEW.dt_procedimento),'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Dt. procedimento: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '||to_char(OLD.dt_procedimento, 'dd/mm/yyyy')||' - Modificada: '||
						to_char(NEW.dt_procedimento, 'dd/mm/yyyy')||chr(13)||chr(10);
		end if;

		if (coalesce(to_char(NEW.dt_fim_proc, 'hh24:mi:ss'),'X') <> coalesce(to_char(OLD.dt_fim_proc, 'hh24:mi:ss'),'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Hora fim: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '||to_char(OLD.dt_fim_proc, 'hh24:mi:ss')||' - Modificada: '||to_char(NEW.dt_fim_proc, 'hh24:mi:ss')||
						chr(13)||chr(10);
		end if;

		if (coalesce(to_char(NEW.dt_inicio_proc, 'hh24:mi:ss'),'X') <> coalesce(to_char(OLD.dt_inicio_proc, 'hh24:mi:ss'),'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Hora início: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '||to_char(OLD.dt_inicio_proc, 'hh24:mi:ss')||' - Modificada: '||
						to_char(NEW.dt_inicio_proc, 'hh24:mi:ss')||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.ie_cobranca_prevista,'X') <> coalesce(NEW.ie_cobranca_prevista,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Cobrança prevista: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '||coalesce(OLD.ie_cobranca_prevista,'N')||' - Modificada: '||NEW.ie_cobranca_prevista||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.ie_autogerado,'X') <> coalesce(NEW.ie_autogerado,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Autogerado: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '||coalesce(OLD.ie_autogerado,'N')||' - Modificado: '||coalesce(NEW.ie_autogerado,'N')||chr(13)||chr(10);
		end if;

		if (coalesce(OLD.nr_seq_setor_atend,0) <> coalesce(NEW.nr_seq_setor_atend,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Setor atendimento: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '||pls_obter_dados_setor_atend(OLD.nr_seq_setor_atend,'DS')||' - Modificada: '||
						pls_obter_dados_setor_atend(NEW.nr_seq_setor_atend,'DS')||
						chr(13)||chr(10);
		end if;

		insert into plsprco_cta( 	nr_sequencia, dt_atualizacao, nm_usuario,
							dt_atualizacao_nrec, nm_usuario_nrec, nm_tabela,
							ds_log, ds_log_call, ds_funcao_ativa,
							ie_aplicacao_tasy, nm_maquina, pls_conta_proc, ie_opcao )
				values ( 	nextval('plsprco_cta_seq'), LOCALTIMESTAMP, substr(coalesce(wheb_usuario_pck.get_nm_usuario,'Usuário não identificado '),1,14),
							LOCALTIMESTAMP, substr(coalesce(wheb_usuario_pck.get_nm_usuario,'Usuário não identificado '),1,14), 'PLS_CONTA_PROC',
							ds_observacao_w, ds_log_call_w, obter_funcao_ativa,
							'N', wheb_usuario_pck.get_machine, OLD.nr_sequencia, '0');
		--end if;
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_conta_proc_alt() FROM PUBLIC;

CREATE TRIGGER pls_conta_proc_alt
	BEFORE UPDATE ON pls_conta_proc FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_conta_proc_alt();

