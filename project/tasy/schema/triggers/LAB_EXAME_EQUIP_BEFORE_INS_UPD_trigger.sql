-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS lab_exame_equip_before_ins_upd ON lab_exame_equip CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_lab_exame_equip_before_ins_upd() RETURNS trigger AS $BODY$
declare
ie_cons_cod_equip_w	varchar(1);
qt_equip_duplicado_w	bigint;
ds_exame_duplicado_w	varchar(255);

pragma autonomous_transaction;

c01 CURSOR FOR
	SELECT	distinct
		nr_seq_exame,
		substr(obter_desc_exame(nr_seq_exame),1,250) ds_exame
	from	lab_exame_equip
	where	cd_equipamento = NEW.cd_equipamento
	and	cd_exame_equip = NEW.cd_exame_equip
	order by 2;

BEGIN

ie_cons_cod_equip_w := obter_param_usuario(746, 38, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_cons_cod_equip_w);

if (wheb_usuario_pck.get_ie_executar_trigger = 'S')  then

	if (ie_cons_cod_equip_w = 'S') then

		select	count(1)
		into STRICT	qt_equip_duplicado_w
		from	lab_exame_equip
		where	cd_equipamento = NEW.cd_equipamento
		and	cd_exame_equip = NEW.cd_exame_equip  LIMIT 1;

		if (qt_equip_duplicado_w > 0) then

			for r_c01_w in c01 loop
				BEGIN
					if (ds_exame_duplicado_w is not null) then
						ds_exame_duplicado_w := substr(ds_exame_duplicado_w||chr(10)||r_c01_w.nr_seq_exame||' - '||r_c01_w.ds_exame,1,255);
						exit when length(ds_exame_duplicado_w) >= 254;
					else
						ds_exame_duplicado_w := chr(10)||chr(13)||r_c01_w.nr_seq_exame||' - '||r_c01_w.ds_exame;
					end if;
				end;
			end loop;
		CALL wheb_mensagem_pck.exibir_mensagem_abort(289474,'DS_ERRO='||ds_exame_duplicado_w);

		end if;

	end if;

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_lab_exame_equip_before_ins_upd() FROM PUBLIC;

CREATE TRIGGER lab_exame_equip_before_ins_upd
	BEFORE INSERT OR UPDATE ON lab_exame_equip FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_lab_exame_equip_before_ins_upd();

