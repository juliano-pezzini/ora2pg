-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS autorizacao_convenio_trg_log ON autorizacao_convenio CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_autorizacao_convenio_trg_log() RETURNS trigger AS $BODY$
declare

ds_module_log_w     autorizacao_convenio_log.ds_modulo%type;
osuser_log_w        usuario.nm_usuario%type;
sessionid_w         numeric(20);
BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger <> 'N')  then

	select userenv('sessionid') userenv
	into STRICT sessionid_w
	;

	select	substr(max(vsession.module||' - ' || vsession.machine||' - ' || vsession.program|| ' - ' || vsession.osuser|| ' - ' || vsession.terminal),1,255) ds_module,
		substr(max(vsession.osuser),1,15) osuser
	into STRICT	ds_module_log_w,
		osuser_log_w
	from	v$session vsession
	where	vsession.audsid = sessionid_w;

	 if (TG_OP = 'DELETE') then

		insert into autorizacao_convenio_log(
			nr_sequencia,
			nr_sequencia_autor,
			cd_pessoa_fisica,
			nr_seq_agenda_consulta,
			nr_seq_agenda,
			ds_callstack,
			nr_seq_autor_cirurgia,
			nr_seq_paciente_atend,
			nr_seq_autor_origem,
			ds_modulo,
			nm_usuario,
			dt_atualizacao)
		values (
			nextval('autorizacao_convenio_log_seq'),
			OLD.nr_sequencia,
			OLD.cd_pessoa_fisica,
			OLD.nr_seq_agenda_consulta,
			OLD.nr_seq_agenda,
			substr(dbms_utility.format_call_stack,1,2500),
			OLD.nr_seq_autor_cirurgia,
			OLD.nr_seq_paciente,
			OLD.nr_seq_autor_origem,
			ds_module_log_w,
			coalesce(wheb_usuario_pck.get_nm_usuario,osuser_log_w),
			LOCALTIMESTAMP);
	end if;
end if;

RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_autorizacao_convenio_trg_log() FROM PUBLIC;

CREATE TRIGGER autorizacao_convenio_trg_log
	AFTER DELETE ON autorizacao_convenio FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_autorizacao_convenio_trg_log();

