-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS nota_credito_insert ON nota_credito CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_nota_credito_insert() RETURNS trigger AS $BODY$
declare

qt_regra_w			smallint;
ie_consiste_data_retroativa	varchar(1);
qt_mes_fechado_w		bigint;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
ie_consiste_data_retroativa := obter_param_usuario(9051, 12, obter_perfil_ativo, NEW.nm_usuario, obter_estabelecimento_ativo, ie_consiste_data_retroativa);

select 	count(*)
into STRICT 	qt_mes_fechado_w
from	estabelecimento b,
	ctb_mes_ref a
where 	trunc(a.dt_referencia,'month')	= trunc(NEW.dt_nota_credito,'month')
and	a.cd_empresa 		= b.cd_empresa
and	b.cd_estabelecimento	= NEW.cd_estabelecimento
and	substr(ctb_obter_se_mes_fechado(a.nr_sequencia,b.cd_estabelecimento),1,1) = 'F';

if (ie_consiste_data_retroativa = 'N') and (qt_mes_fechado_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(236060);
end if;

BEGIN
select	1
into STRICT	qt_regra_w
from	regra_nota_credito LIMIT 1;
exception
when others then
	qt_regra_w := 0;
end;

if (qt_regra_w > 0) then
	SELECT * FROM obter_regra_nota_credito(
		NEW.ie_origem, NEW.dt_nota_credito, NEW.nr_seq_trans_baixa_tit_pagar, NEW.nr_seq_trans_fin_contab, NEW.dt_vencimento) INTO STRICT NEW.nr_seq_trans_baixa_tit_pagar, NEW.nr_seq_trans_fin_contab, NEW.dt_vencimento;
end if;
end if;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_nota_credito_insert() FROM PUBLIC;

CREATE TRIGGER nota_credito_insert
	BEFORE INSERT ON nota_credito FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_nota_credito_insert();

