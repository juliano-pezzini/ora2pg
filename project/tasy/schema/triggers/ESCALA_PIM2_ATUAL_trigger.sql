-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_pim2_atual ON escala_pim2 CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_pim2_atual() RETURNS trigger AS $BODY$
declare
  EXEC_W    varchar(500);
  qt_reg_w  smallint;
  ds_erro_w   varchar(4000);
  ds_parametro_w  varchar(4000);
BEGIN
  BEGIN
  BEGIN
    if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
      BEGIN  
      NEW.nr_hora	:= (to_char(round(NEW.DT_AVALIACAO,'hh24'),'hh24'))::numeric;
      end;
    end if;

    if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
      goto Final;
    end if;

    BEGIN
      EXEC_W := 'CALL OBTER_SCOR_ADM_ELE_E_PIM2_MD(:1) INTO :result';

      EXECUTE EXEC_W USING IN NEW.ie_adm_eletiva,
                                     OUT NEW.qt_pto_adm_eletiva;
    exception
      when others then
        NEW.qt_pto_adm_eletiva := 0;
        ds_erro_w := substr(sqlerrm, 1, 4000);
        ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
        || ' - :new.ie_adm_eletiva: ' || NEW.ie_adm_eletiva || ' - :new.qt_pto_adm_eletiva: ' || NEW.qt_pto_adm_eletiva, 1, 4000);
        CALL gravar_log_medical_device('ESCALA_PIM2_ATUAL', 'OBTER_SCOR_ADM_ELE_E_PIM2_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;

    BEGIN
      EXEC_W := 'CALL OBTER_PROC_RECUP_E_PIM2_MD(:1) INTO :result';

      EXECUTE EXEC_W USING IN NEW.ie_proc_recuperacao,
                                     OUT NEW.qt_pto_proc_recup;
    exception
      when others then
        NEW.qt_pto_proc_recup := 0;
        ds_erro_w := substr(sqlerrm, 1, 4000);
        ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
        || ' - :new.ie_proc_recuperacao: ' || NEW.ie_proc_recuperacao || ' - :new.qt_pto_proc_recup: ' || NEW.qt_pto_proc_recup, 1, 4000);
        CALL gravar_log_medical_device('ESCALA_PIM2_ATUAL', 'OBTER_PROC_RECUP_E_PIM2_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;

    BEGIN
      EXEC_W := 'CALL OBTER_SCOR_CIR_CARD_E_PIM2_MD(:1) INTO :result';

      EXECUTE EXEC_W USING IN NEW.ie_cirurgia_cardiaca,
                                     OUT NEW.QT_PTO_CIRUR_CARD;
    exception
      when others then
        NEW.QT_PTO_CIRUR_CARD := 0;
        ds_erro_w := substr(sqlerrm, 1, 4000);
        ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
        || ' - :new.ie_cirurgia_cardiaca: ' || NEW.ie_cirurgia_cardiaca || ' - :new.QT_PTO_CIRUR_CARD: ' || NEW.QT_PTO_CIRUR_CARD, 1, 4000);
        CALL gravar_log_medical_device('ESCALA_PIM2_ATUAL', 'OBTER_SCOR_CIR_CARD_E_PIM2_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;

    BEGIN
      EXEC_W := 'CALL OBTER_DIAS_ALTO_RIS_E_PIM2_MD(:1, :2) INTO :result';

      EXECUTE EXEC_W USING IN NEW.ie_diag_alto_risco,
                                     IN NEW.ie_diag_baixo_risco,
                                     OUT NEW.qt_pto_diag_alto_risco;
    exception
      when others then
        NEW.qt_pto_diag_alto_risco := 0;
        ds_erro_w := substr(sqlerrm, 1, 4000);
        ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
        || ' - :new.ie_diag_alto_risco: ' || NEW.ie_diag_alto_risco || ' - :new.ie_diag_baixo_risco: ' || NEW.ie_diag_baixo_risco || ' - :new.qt_pto_diag_alto_risco: ' || NEW.qt_pto_diag_alto_risco, 1, 4000);
        CALL gravar_log_medical_device('ESCALA_PIM2_ATUAL', 'OBTER_DIAS_ALTO_RIS_E_PIM2_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;

    BEGIN
      EXEC_W := 'CALL OBTER_SCORE_PUP_E_PIM2_MD(:1) INTO :result';

      EXECUTE EXEC_W USING IN NEW.ie_resposta_pupilas,
                                     OUT NEW.qt_pto_resp_pupilas;
    exception
      when others then
        NEW.qt_pto_resp_pupilas := 0;
        ds_erro_w := substr(sqlerrm, 1, 4000);
        ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
        || ' - :new.ie_resposta_pupilas: ' || NEW.ie_resposta_pupilas || ' - :new.qt_pto_resp_pupilas: ' || NEW.qt_pto_resp_pupilas, 1, 4000);
        CALL gravar_log_medical_device('ESCALA_PIM2_ATUAL', 'OBTER_SCORE_PUP_E_PIM2_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;

    BEGIN
      EXEC_W := 'CALL OBTER_VENT_MEC_E_PIM2_MD(:1) INTO :result';

      EXECUTE EXEC_W USING IN NEW.ie_ventilacao_mecanica,
                                     OUT NEW.qt_pto_vent_mec;
    exception
      when others then
        NEW.qt_pto_vent_mec := 0;
        ds_erro_w := substr(sqlerrm, 1, 4000);
        ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
        || ' - :new.ie_ventilacao_mecanica: ' || NEW.ie_ventilacao_mecanica || ' - :new.qt_pto_vent_mec: ' || NEW.qt_pto_vent_mec, 1, 4000);
        CALL gravar_log_medical_device('ESCALA_PIM2_ATUAL', 'OBTER_VENT_MEC_E_PIM2_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;

    BEGIN
      EXEC_W := 'BEGIN OBTER_SCORES_ESCALA_PIM2_MD(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10,
                                                  :11,:12,:13,:14,:15,:16,:17,:18,:19,:20); END;';

      EXECUTE EXEC_W USING IN NEW.qt_rel_fio2,
                                     IN NEW.qt_rel_pao2,
                                     IN NEW.ie_adm_eletiva,
                                     IN NEW.ie_proc_recuperacao,
                                     IN NEW.ie_cirurgia_cardiaca,
                                     IN NEW.ie_diag_alto_risco, 
                                     IN NEW.ie_resposta_pupilas,
                                     IN NEW.ie_ventilacao_mecanica,
                                     IN NEW.qt_pto_adm_eletiva, 
                                     IN NEW.qt_pto_proc_recup,
                                     IN NEW.qt_pto_cirur_card,
                                     IN NEW.qt_pto_diag_alto_risco,
                                     IN NEW.qt_pto_resp_pupilas,
                                     IN NEW.qt_pto_vent_mec,
                                     IN NEW.qt_pa_sitolica,
                                     IN NEW.qt_ph_sangue,
                                     OUT NEW.qt_pto_pa_sistolica,
                                     OUT NEW.qt_pto_ph_sangue,
                                     OUT NEW.qt_pto_pao2_fio2,
                                     OUT NEW.qt_tx_mortalidade;
    exception
      when others then
          NEW.qt_pto_pa_sistolica  := 0;
          NEW.qt_pto_ph_sangue     := 0;
          NEW.qt_pto_pao2_fio2     := 0;
          NEW.qt_tx_mortalidade    := 0;
        ds_erro_w := substr(sqlerrm, 1, 4000);
        ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
        || ' - :new.qt_rel_fio2: ' || NEW.qt_rel_fio2 || ' - :new.qt_rel_pao2: ' || NEW.qt_rel_pao2 || ' - :new.ie_adm_eletiva: ' || NEW.ie_adm_eletiva || ' - :new.ie_proc_recuperacao: ' || NEW.ie_proc_recuperacao
        || ' - :new.ie_cirurgia_cardiaca: ' || NEW.ie_cirurgia_cardiaca || ' - :new.ie_diag_alto_risco: ' || NEW.ie_diag_alto_risco || ' - :new.ie_resposta_pupilas: ' || NEW.ie_resposta_pupilas || ' - :new.ie_ventilacao_mecanica: ' || NEW.ie_ventilacao_mecanica
        || ' - :new.qt_pto_adm_eletiva: ' || NEW.qt_pto_adm_eletiva || ' - :new.qt_pto_proc_recup: ' || NEW.qt_pto_proc_recup || ' - :new.qt_pto_cirur_card: ' || NEW.qt_pto_cirur_card || ' - :new.qt_pto_diag_alto_risco: ' || NEW.qt_pto_diag_alto_risco || ' - :new.qt_pto_resp_pupilas: ' || NEW.qt_pto_resp_pupilas
        || ' - :new.qt_pto_vent_mec: ' || NEW.qt_pto_vent_mec || ' - :new.qt_pa_sitolica: ' || NEW.qt_pa_sitolica || ' - :new.qt_ph_sangue: ' || NEW.qt_ph_sangue || ' - :new.qt_pto_pa_sistolica: ' || NEW.qt_pto_pa_sistolica || ' - :new.qt_pto_ph_sangue: ' || NEW.qt_pto_ph_sangue
        || ' - :new.qt_pto_pao2_fio2: ' || NEW.qt_pto_pao2_fio2 || ' - :new.qt_tx_mortalidade: ' || NEW.qt_tx_mortalidade, 1, 4000);
        CALL gravar_log_medical_device('ESCALA_PIM2_ATUAL', 'OBTER_SCORES_ESCALA_PIM2_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;

    <<Final>>
    qt_reg_w	:= 0;
  exception
    when others then
      CALL wheb_mensagem_pck.exibir_mensagem_abort(206726);
  end;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_pim2_atual() FROM PUBLIC;

CREATE TRIGGER escala_pim2_atual
	BEFORE INSERT OR UPDATE ON escala_pim2 FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_pim2_atual();

