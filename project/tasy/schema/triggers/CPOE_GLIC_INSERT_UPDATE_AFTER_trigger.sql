-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cpoe_glic_insert_update_after ON cpoe_proc_glic CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cpoe_glic_insert_update_after() RETURNS trigger AS $BODY$
declare

ds_log_cpoe_w			varchar(2000);
dt_min_date_w			timestamp := to_date('30/12/1899 00:00:00', 'dd/mm/yyyy hh24:mi:ss');
BEGIN
  BEGIN
if (coalesce(NEW.nr_sequencia,0) <> coalesce(OLD.nr_sequencia,0)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_sequencia(' || coalesce(OLD.nr_sequencia,0) || '/' || coalesce(NEW.nr_sequencia,0)||'); ',1,2000);
end if;

if (coalesce(NEW.nr_seq_procedimento,0) <> coalesce(OLD.nr_seq_procedimento,0)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_procedimento(' || coalesce(OLD.nr_seq_procedimento,0) || '/' || coalesce(NEW.nr_seq_procedimento,0)||'); ',1,2000);
end if;

if (coalesce(NEW.nr_seq_proc_edit,0) <> coalesce(OLD.nr_seq_proc_edit,0)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_proc_edit(' || coalesce(OLD.nr_seq_proc_edit,0) || '/' || coalesce(NEW.nr_seq_proc_edit,0)||'); ',1,2000);
end if;

if (coalesce(NEW.nr_atendimento,0) <> coalesce(OLD.nr_atendimento,0)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_atendimento(' || coalesce(OLD.nr_atendimento,0) || '/' || coalesce(NEW.nr_atendimento,0)||'); ',1,2000);
end if;

if (coalesce(NEW.nr_seq_protocolo,0) <> coalesce(OLD.nr_seq_protocolo,0)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_protocolo(' || coalesce(OLD.nr_seq_protocolo,0) || '/' || coalesce(NEW.nr_seq_protocolo,0)||'); ',1,2000);
end if;

if (coalesce(NEW.qt_glic_inic,0) <> coalesce(OLD.qt_glic_inic,0)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' qt_glic_inic(' || coalesce(OLD.qt_glic_inic,0) || '/' || coalesce(NEW.qt_glic_inic,0)||'); ',1,2000);
end if;

if (coalesce(NEW.qt_glic_fim,0) <> coalesce(OLD.qt_glic_fim,0)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' qt_glic_fim(' || coalesce(OLD.qt_glic_fim,0) || '/' || coalesce(NEW.qt_glic_fim,0)||'); ',1,2000);
end if;

if (coalesce(NEW.qt_ui_insulina,0) <> coalesce(OLD.qt_ui_insulina,0)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' qt_ui_insulina(' || coalesce(OLD.qt_ui_insulina,0) || '/' || coalesce(NEW.qt_ui_insulina,0)||'); ',1,2000);
end if;

if (coalesce(NEW.qt_glicose,0) <> coalesce(OLD.qt_glicose,0)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' qt_glicose(' || coalesce(OLD.qt_glicose,0) || '/' || coalesce(NEW.qt_glicose,0)||'); ',1,2000);
end if;

if (coalesce(NEW.qt_minutos_medicao,0) <> coalesce(OLD.qt_minutos_medicao,0)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' qt_minutos_medicao(' || coalesce(OLD.qt_minutos_medicao,0) || '/' || coalesce(NEW.qt_minutos_medicao,0)||'); ',1,2000);
end if;

if (coalesce(NEW.qt_ui_insulina_int,0) <> coalesce(OLD.qt_ui_insulina_int,0)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' qt_ui_insulina_int(' || coalesce(OLD.qt_ui_insulina_int,0) || '/' || coalesce(NEW.qt_ui_insulina_int,0)||'); ',1,2000);
end if;

if (coalesce(NEW.cd_pessoa_fisica,'XPTO') <> coalesce(OLD.cd_pessoa_fisica,'XPTO')) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' cd_pessoa_fisica(' || coalesce(OLD.cd_pessoa_fisica,'<NULL>') || '/' || coalesce(NEW.cd_pessoa_fisica,'<NULL>')||'); ',1,2000);
end if;

if (coalesce(NEW.ie_modificado,'XPTO') <> coalesce(OLD.ie_modificado,'XPTO')) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' ie_modificado(' || coalesce(OLD.ie_modificado,'<NULL>') || '/' || coalesce(NEW.ie_modificado,'<NULL>')||'); ',1,2000);
end if;

if (coalesce(NEW.dt_atualizacao, dt_min_date_w) <> coalesce(OLD.dt_atualizacao, dt_min_date_w)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_atualizacao(' || coalesce(to_char(OLD.dt_atualizacao,'dd/mm/yyyy hh24:mi:ss'),'<NULL>') || '/' || coalesce(to_char(NEW.dt_atualizacao,'dd/mm/yyyy hh24:mi:ss'),'<NULL>')||'); ',1,2000);
end if;

if (coalesce(NEW.dt_atualizacao_nrec, dt_min_date_w) <> coalesce(OLD.dt_atualizacao_nrec, dt_min_date_w)) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_atualizacao_nrec(' || coalesce(to_char(OLD.dt_atualizacao_nrec,'dd/mm/yyyy hh24:mi:ss'),'<NULL>') || '/' || coalesce(to_char(NEW.dt_atualizacao_nrec,'dd/mm/yyyy hh24:mi:ss'),'<NULL>')||'); ',1,2000);
end if;

if (coalesce(NEW.nm_usuario, 'XPTO') <> coalesce(OLD.nm_usuario, 'XPTO')) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nm_usuario(' || coalesce(OLD.nm_usuario,'<NULL>') || '/' || coalesce(NEW.nm_usuario,'<NULL>')||'); ',1,2000);
end if;

if (coalesce(NEW.nm_usuario_nrec, 'XPTO') <> coalesce(OLD.nm_usuario_nrec, 'XPTO')) then
	ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nm_usuario_nrec(' || coalesce(OLD.nm_usuario_nrec,'<NULL>') || '/' || coalesce(NEW.nm_usuario_nrec,'<NULL>')||'); ',1,2000);
end if;

if (ds_log_cpoe_w is not null) then

	if (coalesce(OLD.nr_sequencia, 0) > 0) then
		ds_log_cpoe_w := substr('Alterações(old/new)= ' || ds_log_cpoe_w,1,2000);
	else
		ds_log_cpoe_w := substr('Criação(old/new)= ' || ds_log_cpoe_w,1,2000);
	end if;
	ds_log_cpoe_w := substr(ds_log_cpoe_w ||' FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);

	CALL gravar_log_cpoe(ds_log_cpoe_w, NEW.nr_atendimento, 'P', coalesce(NEW.nr_seq_procedimento, NEW.nr_seq_proc_edit));

end if;
exception
when others then
	null;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cpoe_glic_insert_update_after() FROM PUBLIC;

CREATE TRIGGER cpoe_glic_insert_update_after
	AFTER INSERT OR UPDATE ON cpoe_proc_glic FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cpoe_glic_insert_update_after();

