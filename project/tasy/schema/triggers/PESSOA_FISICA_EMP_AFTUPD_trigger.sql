-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pessoa_fisica_emp_aftupd ON pessoa_fisica_empregador CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pessoa_fisica_emp_aftupd() RETURNS trigger AS $BODY$
declare
reg_integracao_w		gerar_int_padrao.reg_integracao;
nr_prontuario_w		pessoa_fisica.nr_prontuario%type;
ie_funcionario_w		pessoa_fisica.ie_funcionario%type;
nr_seq_conselho_w	pessoa_fisica.nr_seq_conselho%type;
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
nr_cpf_w pessoa_fisica.nr_cpf %type;

BEGIN

if (NEW.dt_inicio_trabalho is not null and NEW.dt_inicio_trabalho > LOCALTIMESTAMP) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1117614);
end if;

cd_pessoa_fisica_w	:=	coalesce(NEW.cd_pessoa_fisica, OLD.cd_pessoa_fisica);

if	((TG_OP = 'INSERT' or TG_OP = 'UPDATE') and (coalesce(wheb_usuario_pck.get_ie_executar_trigger, 'S') = 'S'))	then
	CALL insere_pessoa_fisica_emp(	NEW.cd_cgc,
							NEW.dt_inicio_trabalho,
							NEW.nm_usuario,
							cd_pessoa_fisica_w,
							NEW.dt_fim_trabalho,
							NEW.cd_profissao,
							NEW.ds_profissao,
							coalesce(OLD.cd_cgc, NEW.cd_cgc),
							'S',
							NEW.ds_empresa_texto,
							coalesce(OLD.ds_empresa_texto, NEW.ds_empresa_texto),
                            NEW.ds_endereco_empreg,
							NEW.nr_endereco_empreg,
							NEW.ds_pais_empreg,
							NEW.cd_cep_empreg,
							NEW.ds_municipio_empreg,
							NEW.nr_telefone
                            );
end if;

select	nr_prontuario,
	ie_funcionario,
	nr_seq_conselho,
  nr_cpf
into STRICT	nr_prontuario_w,
	ie_funcionario_w,
	nr_seq_conselho_w,
  nr_cpf_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_w;

if nr_cpf_w is not null then
   reg_integracao_w.ie_possui_cpf := 'S';
end if;

reg_integracao_w.ie_operacao		:=  'A';
reg_integracao_w.nr_prontuario		:=  nr_prontuario_w;
reg_integracao_w.cd_pessoa_fisica	:=  cd_pessoa_fisica_w;
reg_integracao_w.ie_funcionario		:=  coalesce(ie_funcionario_w,'N');
reg_integracao_w.nr_seq_conselho	:=  nr_seq_conselho_w;

if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then
	CALL wheb_usuario_pck.set_ie_executar_trigger('S');
end if;

if (wheb_usuario_pck.get_ie_lote_contabil = 'N') then
  reg_integracao_w := gerar_int_padrao.gravar_integracao('12', cd_pessoa_fisica_w, coalesce(NEW.nm_usuario,OLD.nm_usuario), reg_integracao_w);
end if;

IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pessoa_fisica_emp_aftupd() FROM PUBLIC;

CREATE TRIGGER pessoa_fisica_emp_aftupd
	AFTER INSERT OR UPDATE OR DELETE ON pessoa_fisica_empregador FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pessoa_fisica_emp_aftupd();

