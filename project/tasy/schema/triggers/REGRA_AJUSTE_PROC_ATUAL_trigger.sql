-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS regra_ajuste_proc_atual ON regra_ajuste_proc CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_regra_ajuste_proc_atual() RETURNS trigger AS $BODY$
declare
qt_preenchido_w		smallint	:= 0;
qt_reg_w	smallint;
BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;
if (NEW.CD_PROCEDIMENTO IS NOT NULL)	then
	BEGIN
	qt_preenchido_w := 1;
	end;
else	
	if (NEW.CD_GRUPO_PROC IS NOT NULL) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	if (NEW.CD_ESPECIALIDADE IS NOT NULL) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	if (NEW.CD_AREA_PROCEDIMENTO IS NOT NULL) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	if (NEW.NR_SEQ_GRUPO_LAB IS NOT NULL) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	if (NEW.NR_SEQ_PROC_INTERNO IS NOT NULL) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	/* Felipe Martini OS85074 - Inclui a validacao para a Estrutura SUS Unificado*/


	if (NEW.nr_seq_grupo is not null) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	if (NEW.nr_seq_subgrupo is not null) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	if (NEW.nr_seq_forma_org is not null) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	if (NEW.nr_seq_exame is not null) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	if (NEW.nr_seq_grupo_int is not null) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	if (NEW.nr_seq_espec_int is not null) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	if (NEW.nr_seq_area_int is not null) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	if (NEW.nr_seq_estrutura is not null) then
		qt_preenchido_w := qt_preenchido_w + 1;
	end if;
	/*if	(:new.nr_seq_classif is not null) then
		qt_preenchido_w	:= qt_preenchido_w + 1;
	end if;*/

end if;

/* Ricardo 28/10/2004 - Inclui a linha abaixo, se nao houver procedimento, limpa a origem */



if (NEW.CD_PROCEDIMENTO IS NULL) and (NEW.ie_origem_proced is not null) then
	NEW.ie_origem_proced := null;
end if;

if (qt_preenchido_w > 1) then
	--Apenas uma estrutura pode ser selecionada!

	CALL Wheb_mensagem_pck.exibir_mensagem_abort(185149);
elsif (qt_preenchido_w = 0) then
	--Uma estrutura deve ser selecionada!

	CALL Wheb_mensagem_pck.exibir_mensagem_abort(185150);
end if;
<<Final>>
qt_reg_w	:= 0;

RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_regra_ajuste_proc_atual() FROM PUBLIC;

CREATE TRIGGER regra_ajuste_proc_atual
	BEFORE INSERT OR UPDATE ON regra_ajuste_proc FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_regra_ajuste_proc_atual();

