-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS hd_dial_concentrado_befup_sign ON hd_dialise_concentrado CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_hd_dial_concentrado_befup_sign() RETURNS trigger AS $BODY$
declare
nr_seq_assinatura_w	hd_assinatura_digital.nr_sequencia%type;

BEGIN

select 	max(a.nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital a,
	hd_assinatura_item b
where 	a.nr_sequencia = b.nr_seq_assinatura
and 	b.nr_seq_concentrado = NEW.nr_sequencia
and 	a.ie_opcao = 'MD'
and	a.dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.nr_seq_maquina		<> NEW.nr_seq_maquina
		or OLD.nr_seq_ponto_acesso	<> NEW.nr_seq_ponto_acesso
		or OLD.ie_atualiza_estoque	<> NEW.ie_atualiza_estoque
		or OLD.cd_lote_fornecedor	<> NEW.cd_lote_fornecedor
		or OLD.cd_material		<> NEW.cd_material
		or OLD.dt_conta		<> NEW.dt_conta
		or OLD.dt_inclusao		<> NEW.dt_inclusao
		or OLD.cd_pf_inclusao		<> NEW.cd_pf_inclusao
		or (OLD.nr_seq_maquina 	is null		and NEW.nr_seq_maquina 	is not null)
		or (OLD.nr_seq_ponto_acesso 	is null		and NEW.nr_seq_ponto_acesso 	is not null)
		or (OLD.ie_atualiza_estoque 	is null		and NEW.ie_atualiza_estoque 	is not null)
		or (OLD.cd_lote_fornecedor 	is null		and NEW.cd_lote_fornecedor 	is not null)
		or (OLD.cd_material 		is null		and NEW.cd_material 		is not null)
		or (OLD.dt_conta 		is null		and NEW.dt_conta 		is not null)
		or (OLD.dt_inclusao 		is null		and NEW.dt_inclusao 		is not null)
		or (OLD.cd_pf_inclusao 	is null		and NEW.cd_pf_inclusao 	is not null)
		or (OLD.nr_seq_maquina 	is not null	and NEW.nr_seq_maquina 	is null)
		or (OLD.nr_seq_ponto_acesso 	is not null	and NEW.nr_seq_ponto_acesso 	is null)
		or (OLD.ie_atualiza_estoque 	is not null	and NEW.ie_atualiza_estoque 	is null)
		or (OLD.cd_lote_fornecedor 	is not null	and NEW.cd_lote_fornecedor 	is null)
		or (OLD.cd_material 		is not null	and NEW.cd_material 		is null)
		or (OLD.dt_conta 		is not null	and NEW.dt_conta 		is null)
		or (OLD.dt_inclusao 		is not null	and NEW.dt_inclusao 		is null)
		or (OLD.cd_pf_inclusao 	is not null	and NEW.cd_pf_inclusao 	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(a.nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital a,
	hd_assinatura_item b
where 	a.nr_sequencia = b.nr_seq_assinatura
and 	b.nr_seq_concentrado_ret = NEW.nr_sequencia
and 	a.ie_opcao = 'C'
and	a.dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_retirada	<> NEW.dt_retirada
		or OLD.cd_pf_retirada	<> NEW.cd_pf_retirada
		or (OLD.dt_retirada 	is null		and NEW.dt_retirada 	is not null)
		or (OLD.cd_pf_retirada is null		and NEW.cd_pf_retirada is not null)
		or (OLD.dt_retirada 	is not null	and NEW.dt_retirada 	is null)
		or (OLD.cd_pf_retirada	is not null	and NEW.cd_pf_retirada is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(a.nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital a,
	hd_assinatura_item b
where 	a.nr_sequencia = b.nr_seq_assinatura
and 	b.nr_seq_concentrado = NEW.nr_sequencia
and 	a.ie_opcao = 'IC'
and	a.dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.nr_seq_maquina		<> NEW.nr_seq_maquina
		or OLD.nr_seq_ponto_acesso	<> NEW.nr_seq_ponto_acesso
		or OLD.ie_atualiza_estoque	<> NEW.ie_atualiza_estoque
		or OLD.cd_lote_fornecedor	<> NEW.cd_lote_fornecedor
		or OLD.cd_material		<> NEW.cd_material
		or OLD.nr_seq_dialise		<> NEW.nr_seq_dialise
		or OLD.dt_inclusao		<> NEW.dt_inclusao
		or OLD.cd_pf_inclusao		<> NEW.cd_pf_inclusao
		or (OLD.nr_seq_maquina 	is null		and NEW.nr_seq_maquina 	is not null)
		or (OLD.nr_seq_ponto_acesso 	is null		and NEW.nr_seq_ponto_acesso 	is not null)
		or (OLD.ie_atualiza_estoque 	is null		and NEW.ie_atualiza_estoque 	is not null)
		or (OLD.cd_lote_fornecedor 	is null		and NEW.cd_lote_fornecedor 	is not null)
		or (OLD.cd_material 		is null		and NEW.cd_material 		is not null)
		or (OLD.nr_seq_dialise		is null		and NEW.nr_seq_dialise		is not null)
		or (OLD.dt_inclusao 		is null		and NEW.dt_inclusao 		is not null)
		or (OLD.cd_pf_inclusao 	is null		and NEW.cd_pf_inclusao 	is not null)
		or (OLD.nr_seq_maquina 	is not null	and NEW.nr_seq_maquina 	is null)
		or (OLD.nr_seq_ponto_acesso 	is not null	and NEW.nr_seq_ponto_acesso 	is null)
		or (OLD.ie_atualiza_estoque 	is not null	and NEW.ie_atualiza_estoque 	is null)
		or (OLD.cd_lote_fornecedor 	is not null	and NEW.cd_lote_fornecedor 	is null)
		or (OLD.cd_material 		is not null	and NEW.cd_material 		is null)
		or (OLD.nr_seq_dialise		is not null	and NEW.nr_seq_dialise		is null)
		or (OLD.dt_inclusao 		is not null	and NEW.dt_inclusao 		is null)
		or (OLD.cd_pf_inclusao 	is not null	and NEW.cd_pf_inclusao 	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(a.nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital a,
	hd_assinatura_item b
where 	a.nr_sequencia = b.nr_seq_assinatura
and 	b.nr_seq_concentrado = NEW.nr_sequencia
and 	a.ie_opcao = 'SD'
and	a.dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.nr_seq_maquina		<> NEW.nr_seq_maquina
		or OLD.nr_seq_ponto_acesso	<> NEW.nr_seq_ponto_acesso
		or OLD.ie_atualiza_estoque	<> NEW.ie_atualiza_estoque
		or OLD.cd_lote_fornecedor	<> NEW.cd_lote_fornecedor
		or OLD.cd_material		<> NEW.cd_material
		or OLD.dt_conta		<> NEW.dt_conta
		or OLD.dt_inclusao		<> NEW.dt_inclusao
		or OLD.cd_pf_inclusao		<> NEW.cd_pf_inclusao
		or (OLD.nr_seq_maquina 	is null		and NEW.nr_seq_maquina 	is not null)
		or (OLD.nr_seq_ponto_acesso 	is null		and NEW.nr_seq_ponto_acesso 	is not null)
		or (OLD.ie_atualiza_estoque 	is null		and NEW.ie_atualiza_estoque 	is not null)
		or (OLD.cd_lote_fornecedor 	is null		and NEW.cd_lote_fornecedor 	is not null)
		or (OLD.cd_material 		is null		and NEW.cd_material 		is not null)
		or (OLD.dt_conta		is null		and NEW.dt_conta		is not null)
		or (OLD.dt_inclusao 		is null		and NEW.dt_inclusao 		is not null)
		or (OLD.cd_pf_inclusao 	is null		and NEW.cd_pf_inclusao 	is not null)
		or (OLD.nr_seq_maquina 	is not null	and NEW.nr_seq_maquina 	is null)
		or (OLD.nr_seq_ponto_acesso 	is not null	and NEW.nr_seq_ponto_acesso 	is null)
		or (OLD.ie_atualiza_estoque 	is not null	and NEW.ie_atualiza_estoque 	is null)
		or (OLD.cd_lote_fornecedor 	is not null	and NEW.cd_lote_fornecedor 	is null)
		or (OLD.cd_material 		is not null	and NEW.cd_material 		is null)
		or (OLD.dt_conta		is not null	and NEW.dt_conta		is null)
		or (OLD.dt_inclusao 		is not null	and NEW.dt_inclusao 		is null)
		or (OLD.cd_pf_inclusao 	is not null	and NEW.cd_pf_inclusao 	is null)) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(a.nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital a,
	hd_assinatura_item b
where 	a.nr_sequencia = b.nr_seq_assinatura
and 	b.nr_seq_concentrado_ret = NEW.nr_sequencia
and 	a.ie_opcao = 'SC'
and	a.dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_retirada	<> NEW.dt_retirada
		or OLD.cd_pf_retirada	<> NEW.cd_pf_retirada
		or (OLD.dt_retirada 	is null		and NEW.dt_retirada 	is not null)
		or (OLD.cd_pf_retirada is null		and NEW.cd_pf_retirada is not null)
		or (OLD.dt_retirada 	is not null	and NEW.dt_retirada 	is null)
		or (OLD.cd_pf_retirada	is not null	and NEW.cd_pf_retirada is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(a.nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital a,
	hd_assinatura_item b
where 	a.nr_sequencia = b.nr_seq_assinatura
and 	b.nr_seq_concentrado = NEW.nr_sequencia
and 	a.ie_opcao = 'SC'
and	a.dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.nr_seq_maquina		<> NEW.nr_seq_maquina
		or OLD.nr_seq_ponto_acesso	<> NEW.nr_seq_ponto_acesso
		or OLD.ie_atualiza_estoque	<> NEW.ie_atualiza_estoque
		or OLD.cd_lote_fornecedor	<> NEW.cd_lote_fornecedor
		or OLD.cd_material		<> NEW.cd_material
		or OLD.nr_seq_dialise		<> NEW.nr_seq_dialise
		or OLD.dt_inclusao		<> NEW.dt_inclusao
		or OLD.cd_pf_inclusao		<> NEW.cd_pf_inclusao
		or (OLD.nr_seq_maquina 	is null		and NEW.nr_seq_maquina 	is not null)
		or (OLD.nr_seq_ponto_acesso 	is null		and NEW.nr_seq_ponto_acesso 	is not null)
		or (OLD.ie_atualiza_estoque 	is null		and NEW.ie_atualiza_estoque 	is not null)
		or (OLD.cd_lote_fornecedor 	is null		and NEW.cd_lote_fornecedor 	is not null)
		or (OLD.cd_material 		is null		and NEW.cd_material 		is not null)
		or (OLD.nr_seq_dialise		is null		and NEW.nr_seq_dialise		is not null)
		or (OLD.dt_inclusao 		is null		and NEW.dt_inclusao 		is not null)
		or (OLD.cd_pf_inclusao 	is null		and NEW.cd_pf_inclusao 	is not null)
		or (OLD.nr_seq_maquina 	is not null	and NEW.nr_seq_maquina 	is null)
		or (OLD.nr_seq_ponto_acesso 	is not null	and NEW.nr_seq_ponto_acesso 	is null)
		or (OLD.ie_atualiza_estoque 	is not null	and NEW.ie_atualiza_estoque 	is null)
		or (OLD.cd_lote_fornecedor 	is not null	and NEW.cd_lote_fornecedor 	is null)
		or (OLD.cd_material 		is not null	and NEW.cd_material 		is null)
		or (OLD.nr_seq_dialise		is not null	and NEW.nr_seq_dialise		is null)
		or (OLD.dt_inclusao 		is not null	and NEW.dt_inclusao 		is null)
		or (OLD.cd_pf_inclusao 	is not null	and NEW.cd_pf_inclusao 	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(a.nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital a,
	hd_assinatura_item b
where 	a.nr_sequencia = b.nr_seq_assinatura
and 	b.nr_seq_concentrado_ret = NEW.nr_sequencia
and 	a.ie_opcao = 'RC'
and	a.dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_retirada	<> NEW.dt_retirada
		or OLD.cd_pf_retirada	<> NEW.cd_pf_retirada
		or (OLD.dt_retirada 	is null		and NEW.dt_retirada 	is not null)
		or (OLD.cd_pf_retirada is null		and NEW.cd_pf_retirada is not null)
		or (OLD.dt_retirada 	is not null	and NEW.dt_retirada 	is null)
		or (OLD.cd_pf_retirada	is not null	and NEW.cd_pf_retirada is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(a.nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital a,
	hd_assinatura_item b
where 	a.nr_sequencia = b.nr_seq_assinatura
and 	b.nr_seq_concentrado_ret = NEW.nr_sequencia
and 	a.ie_opcao = 'FD'
and	a.dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_retirada	<> NEW.dt_retirada
		or OLD.cd_pf_retirada	<> NEW.cd_pf_retirada
		or (OLD.dt_retirada 	is null		and NEW.dt_retirada 	is not null)
		or (OLD.cd_pf_retirada is null		and NEW.cd_pf_retirada is not null)
		or (OLD.dt_retirada 	is not null	and NEW.dt_retirada 	is null)
		or (OLD.cd_pf_retirada	is not null	and NEW.cd_pf_retirada is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_hd_dial_concentrado_befup_sign() FROM PUBLIC;

CREATE TRIGGER hd_dial_concentrado_befup_sign
	BEFORE UPDATE ON hd_dialise_concentrado FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_hd_dial_concentrado_befup_sign();

