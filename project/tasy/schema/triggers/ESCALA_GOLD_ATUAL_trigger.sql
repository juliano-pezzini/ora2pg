-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_gold_atual ON escala_gold CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_gold_atual() RETURNS trigger AS $BODY$
declare
  qt_reg_w    smallint;
  sql_w       varchar(200);
  ie_grupo_w  varchar(1);
  ds_erro_w      varchar(4000);
  ds_parametro_w varchar(4000);
BEGIN
  BEGIN

  if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
  end if;

  /** Medical Device **/

  sql_w := 'begin OBTER_SCORE_ESCALA_GOLD_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13); end;';
  BEGIN
	  EXECUTE sql_w using in NEW.qt_irritado,
									in NEW.ie_irritado_adm,
									in NEW.QT_CAT_01,
									in NEW.QT_CAT_02,
									in NEW.QT_CAT_03,
									in NEW.QT_CAT_04,
                  in NEW.QT_CAT_05,
                  in NEW.QT_CAT_06,
                  in NEW.QT_CAT_07,
                  in NEW.QT_CAT_08,
                  in NEW.ie_mmrc,
                  out NEW.QT_TOTAL_CAT,
                  out ie_grupo_w;
  exception
    when others then
    ie_grupo_w := null;
    ds_erro_w := sqlerrm;
    ds_parametro_w := ':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
    ds_parametro_w := ds_parametro_w || ' - :new.qt_irritado: ' || NEW.qt_irritado || ' - :new.ie_irritado_adm: ' || NEW.ie_irritado_adm || ' - :new.QT_CAT_01: ' || NEW.QT_CAT_01;
    ds_parametro_w := ds_parametro_w || ' - :new.QT_CAT_02: ' || NEW.QT_CAT_02 || ' - :new.QT_CAT_03: ' || NEW.QT_CAT_03 || ' - :new.QT_CAT_04: ' || NEW.QT_CAT_04 || ' - :new.QT_CAT_05: ' || NEW.QT_CAT_05;
    ds_parametro_w := ds_parametro_w || ' - :new.QT_CAT_06: ' || NEW.QT_CAT_06 || ' - :new.QT_CAT_07: ' || NEW.QT_CAT_07 || ' - :new.QT_CAT_08: ' || NEW.QT_CAT_08 || ' - :new.ie_mmrc: ' || NEW.ie_mmrc || ' - :new.QT_TOTAL_CAT: ' || NEW.QT_TOTAL_CAT || ' - ie_grupo_w: ' || ie_grupo_w;
    CALL gravar_log_medical_device('ESCALA_GOLD_ATUAL', 'OBTER_SCORE_ESCALA_GOLD_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
  end;

  <<Final>>
  qt_reg_w := 0;

  NEW.ie_grupo := ie_grupo_w;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_gold_atual() FROM PUBLIC;

CREATE TRIGGER escala_gold_atual
	BEFORE INSERT OR UPDATE ON escala_gold FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_gold_atual();

