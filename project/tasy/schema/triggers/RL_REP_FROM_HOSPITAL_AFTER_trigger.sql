-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS rl_rep_from_hospital_after ON rl_rep_from_hospital CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_rl_rep_from_hospital_after() RETURNS trigger AS $BODY$
declare

count_history_w	bigint;

BEGIN
	if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
	
		select	count(*)
		into STRICT	count_history_w
		from	rl_history
		where	nr_seq_rl_rep_from_hosp = NEW.nr_sequencia;
		
		if (count_history_w > 0) then
			update rl_history
			set ds_referring_hosp = (SELECT ds_razao_social from  pessoa_juridica where cd_cgc = NEW.cd_medical_institution),
			    ds_referred_hosp = (select ds_departamento ds from departamento_medico where cd_departamento = NEW.cd_referred_department)
			where nr_seq_rl_rep_from_hosp = NEW.nr_sequencia;
		else
			insert into rl_history(
				nr_sequencia,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_rl_rep_from_hosp,
				dt_history,
				ds_referring_hosp,
				ds_referred_hosp,
				ie_type,
				nm_recorded_by,
				ie_status
				)
			values (
				nextval('rl_history_seq'),
				NEW.dt_atualizacao,
				NEW.dt_atualizacao_nrec,
				NEW.nm_usuario,
				NEW.nm_usuario_nrec,
				NEW.nr_sequencia,
				LOCALTIMESTAMP,
				(SELECT ds_razao_social from  pessoa_juridica where cd_cgc = NEW.cd_medical_institution),
				(select ds_departamento ds from departamento_medico where cd_departamento = NEW.cd_referred_department),
				'2',
				NEW.nm_usuario,
				'1');
		end if;
	end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_rl_rep_from_hospital_after() FROM PUBLIC;

CREATE TRIGGER rl_rep_from_hospital_after
	AFTER INSERT OR UPDATE ON rl_rep_from_hospital FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_rl_rep_from_hospital_after();

