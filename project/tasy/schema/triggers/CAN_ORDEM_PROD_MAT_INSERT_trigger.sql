-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS can_ordem_prod_mat_insert ON can_ordem_prod_mat CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_can_ordem_prod_mat_insert() RETURNS trigger AS $BODY$
declare
qt_estoque_w		double precision;
nr_seq_cabine_w		bigint;
ie_lote_w		varchar(1);
ie_reaproveitamento	varchar(1);
ie_tipo_manipulacao_w	varchar(1);
ie_arredonda_dose_w	varchar(1);
ie_via_aplicacao_w	varchar(1);
qt_dose_real_w		double precision;
ie_atualiza_validade_w	varchar(1);
dt_val_ordem_w		timestamp;
dt_val_ordem_ww		timestamp;
nr_seq_marca_w		bigint;
ie_sobras_overfill_w	varchar(1);
ie_arredonda_dose_cabine_w	varchar(15);
ie_baixa_kit_w varchar(1);

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then
	RETURN NEW;
end if;

if (coalesce(NEW.ie_sobra_overfill,'N') not in ('S','O')) then

	qt_estoque_w := 0;

	ie_tipo_manipulacao_w := Obter_Param_Usuario(3130, 218, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_tipo_manipulacao_w);
	ie_arredonda_dose_w := Obter_Param_Usuario(3130, 286, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_arredonda_dose_w);
	ie_arredonda_dose_cabine_w := Obter_Param_Usuario(3130, 418, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_arredonda_dose_cabine_w);
	ie_atualiza_validade_w := Obter_Param_Usuario(3130, 369, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_atualiza_validade_w);
    ie_sobras_overfill_w := obter_param_usuario(3130, 366, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_sobras_overfill_w);	
    ie_baixa_kit_w := obter_param_usuario(3130, 511, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_baixa_kit_w);

	select	b.nr_seq_cabine
	into STRICT	nr_seq_cabine_w   
	from	far_etapa_producao b, 
			can_ordem_prod a 
	where	a.nr_sequencia 	= 	NEW.nr_seq_ordem 
	and		b.nr_sequencia 		= 	a.nr_seq_etapa_prod;

	ie_lote_w	:= 'N';
 

	if (coalesce(NEW.ie_reaproveitado,'N') = 'N') and (NEW.nr_seq_ordem_origem is null) and
		((ie_tipo_manipulacao_w <> 'T') or (NEW.ie_estoque_cabine = 'S')) and (NEW.nr_seq_kit is null or ie_baixa_kit_w = 'S') then

		/*select	nvl(sum(qt_estoque),0) 
		into	qt_estoque_w 
		from	far_estoque_cabine   
		where	nr_seq_cabine	= nr_seq_cabine_w 
		and	cd_material	= :new.cd_material
		and	nr_seq_lote_fornec = :new.nr_seq_lote_fornec;*/
 
		
		select 	sum(x) 
		into STRICT   	qt_estoque_w
		from (	SELECT	coalesce(sum(qt_estoque),0)   x  
				from	far_estoque_cabine 
				where	nr_seq_cabine	= nr_seq_cabine_w  
				and		cd_material	= NEW.cd_material 
				and		nr_seq_lote_fornec  = NEW.nr_seq_lote_fornec
				
union

				SELECT	coalesce(sum(qt_saldo),0)  x 
				from	quimio_sobra_overfill 
				where	nr_seq_cabine	= nr_seq_cabine_w   
				and		cd_material	=  NEW.cd_material 
				and		nr_seq_lote_fornec  = NEW.nr_seq_lote_fornec
				and		qt_saldo > 0
				and		NEW.ie_sobra_overfill = 'S') alias12;

		ie_lote_w	:= 'S';

			if (qt_estoque_w = 0) then   
				/*select	NVL(sum(qt_estoque),0)   
				into	qt_estoque_w   
				from	far_estoque_cabine 
				where	nr_seq_cabine	= nr_seq_cabine_w   
				and		cd_material	= :new.cd_material 
				and		nr_seq_lote_fornec is null;*/

				
				select 	sum(x) 
				into STRICT   	qt_estoque_w
				from (	SELECT	coalesce(sum(qt_estoque),0)   x  
						from	far_estoque_cabine 
						where	nr_seq_cabine	= nr_seq_cabine_w  
						and		cd_material	= NEW.cd_material 
						and		nr_seq_lote_fornec is null
						
union

						SELECT	coalesce(sum(qt_saldo),0)  x 
						from	quimio_sobra_overfill 
						where	nr_seq_cabine	= nr_seq_cabine_w   
						and		cd_material	=  NEW.cd_material 
						and		nr_seq_lote_fornec is null
						and		qt_saldo > 0
						and		NEW.ie_sobra_overfill = 'S') alias6;
						

				if (qt_estoque_w = 0) and (ie_sobras_overfill_w <> 'S')then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(186924);
				end if;

				ie_lote_w	:= 'N';

			end if;

		qt_dose_real_w := NEW.qt_dose_real;

		if (ie_arredonda_dose_w = 'S') and (ie_arredonda_dose_cabine_w = 'S') then  
			qt_dose_real_w := Obter_qt_dose_onco(NEW.cd_material,NEW.qt_dose_real,ie_via_aplicacao_w);
		end if;

		qt_estoque_w	:= qt_estoque_w - qt_dose_real_w;

			if (ie_lote_w = 'S') then
			if (qt_estoque_w > 0) then   
				update	far_estoque_cabine   
				set	qt_estoque	= qt_estoque_w   
				where	nr_seq_cabine	= nr_seq_cabine_w   
				and	cd_material	= NEW.cd_material  
				and	nr_seq_lote_fornec = NEW.nr_seq_lote_fornec
				and	coalesce(NEW.ie_sobra_overfill,'N') = 'N';
			else 
				delete	FROM far_estoque_cabine   
				where	nr_seq_cabine	= nr_seq_cabine_w   
				and	cd_material	= NEW.cd_material  
				and	nr_seq_lote_fornec = NEW.nr_seq_lote_fornec
				and	coalesce(NEW.ie_sobra_overfill,'N') = 'N';
			end if;
		else  
			if (qt_estoque_w > 0) then   
				update	far_estoque_cabine   
				set	qt_estoque	= qt_estoque_w   
				where	nr_seq_cabine	= nr_seq_cabine_w   
				and	cd_material	= NEW.cd_material
				and	coalesce(NEW.ie_sobra_overfill,'N') = 'N';   				
			else
				delete	FROM far_estoque_cabine   
				where	nr_seq_cabine	= nr_seq_cabine_w   
				and	cd_material	= NEW.cd_material
				and	coalesce(NEW.ie_sobra_overfill,'N') = 'N';   				
			end if;
		end if;
	end if;
	
	

	if (ie_atualiza_validade_w = 'S') then

		select 	LOCALTIMESTAMP + qt_obter_estabilidade_mat(NEW.cd_material, NEW.nr_seq_lote_fornec) / 24
		into STRICT	dt_val_ordem_w   
		;

		select 	max(dt_validade_ordem)
		into STRICT	dt_val_ordem_ww
		from	can_ordem_prod   
		where   nr_sequencia = NEW.nr_seq_ordem;

		if (dt_val_ordem_w < dt_val_ordem_ww) or (dt_val_ordem_ww is null) then   

			update 	can_ordem_prod   
			set 	dt_validade_ordem 	= 	dt_val_ordem_w,   
					dt_validade_rotulo 	= 	dt_val_ordem_w  
			where	nr_sequencia		= 	NEW.nr_seq_ordem;

		end if;
	end if;
end if;

delete	from far_estoque_cabine
where	cd_material	=	NEW.cd_material
and		qt_estoque <= 0;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_can_ordem_prod_mat_insert() FROM PUBLIC;

CREATE TRIGGER can_ordem_prod_mat_insert
	AFTER INSERT ON can_ordem_prod_mat FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_can_ordem_prod_mat_insert();

