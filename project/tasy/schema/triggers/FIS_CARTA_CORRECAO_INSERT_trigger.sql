-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS fis_carta_correcao_insert ON fis_carta_correcao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_fis_carta_correcao_insert() RETURNS trigger AS $BODY$
declare
vl_anterior_w		varchar(255);
vl_atual_w		varchar(255);
qt_registros_w		bigint;
BEGIN
  BEGIN

if (coalesce(wheb_usuario_pck.get_ie_executar_trigger,'S') = 'S') then

	BEGIN

	if (NEW.ie_tipo_correcao = 1) then -- Raz?o Social
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(obter_dados_nota_fiscal(a.nr_sequencia, 3),1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(obter_dados_nota_fiscal(a.nr_sequencia, 3),1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 2) then -- Endere?o
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(obter_dados_pf_pj(null,a.cd_cgc_emitente, 'R'), 1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(obter_dados_pf_pj(null,a.cd_cgc_emitente, 'R'), 1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 3) then -- Munic?pio
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(obter_dados_pf_pj(null,a.cd_cgc_emitente, 'CI'), 1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(obter_dados_pf_pj(null,a.cd_cgc_emitente, 'CI'), 1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 4) then -- Estado
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(obter_dados_pf_pj(null,a.cd_cgc_emitente, 'UF'), 1, 10)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(obter_dados_pf_pj(null,a.cd_cgc_emitente, 'UF'), 1, 10)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 5) then -- Cnpj
		BEGIN
		if (NEW.cd_material is null) then
			select	a.cd_cgc_emitente
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	a.cd_cgc_emitente
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 6) then -- Inscri??o estadual
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(obter_dados_pf_pj(null,a.cd_cgc_emitente, 'IE'), 1, 40)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(obter_dados_pf_pj(null,a.cd_cgc_emitente, 'IE'), 1, 40)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 7) then -- Natureza Opera??o
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(obter_dados_natureza_operacao(b.cd_natureza_operacao, 'CF'), 1, 20)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(obter_dados_natureza_operacao(b.cd_natureza_operacao, 'CF'), 1, 20)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		
		NEW.vl_atual	:= obter_dados_natureza_operacao(NEW.cd_natureza_operacao, 'CF');

		end;
	elsif (NEW.ie_tipo_correcao = 8) then -- C?digo fiscal da opera??o
		BEGIN
		if (NEW.cd_material is null) then
			select	max(f.cd_codigo_valores_fiscais),
				count(*)
			into STRICT	vl_anterior_w,
				qt_registros_w
			from	nota_fiscal_item b,
				fis_variacao_fiscal f
			where	f.nr_sequencia		= b.nr_seq_variacao_fiscal
			and	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	max(f.cd_codigo_valores_fiscais),
				count(*)
			into STRICT	vl_anterior_w,
				qt_registros_w
			from	nota_fiscal_item b,
				fis_variacao_fiscal f
			where	f.nr_sequencia		= b.nr_seq_variacao_fiscal
			and	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		
		if (qt_registros_w = 0) then
			BEGIN
			if (NEW.cd_material is null) then
				select	o.cd_cfop
				into STRICT	vl_anterior_w
				from	nota_fiscal_item b,
					natureza_operacao o
				where	o.cd_natureza_operacao = b.cd_natureza_operacao
				and	b.cd_procedimento	= NEW.cd_procedimento
				and	b.ie_origem_proced	= NEW.ie_origem_proced
				and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
				and	b.nr_item_nf 		= NEW.nr_item_nf;
			else
				select	o.cd_cfop
				into STRICT	vl_anterior_w
				from	nota_fiscal_item b,
					natureza_operacao o
				where	o.cd_natureza_operacao = b.cd_natureza_operacao
				and	b.cd_material		= NEW.cd_material
				and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
				and	b.nr_item_nf 		= NEW.nr_item_nf;
			end if;
			end;
		end if;
		
		end;
	elsif (NEW.ie_tipo_correcao = 9) then -- Via de transporte
		BEGIN
		select	substr(obter_dados_pf_pj(null,t.cd_cnpj, 'N'), 1, 255)
		into STRICT	vl_anterior_w
		from	nota_fiscal_transportadora t,
			nota_fiscal a
		where	a.nr_sequencia		= t.nr_seq_nota
		and	a.nr_sequencia		= NEW.nr_seq_nota_fiscal;
		
		exception
		when no_data_found or too_many_rows then
			vl_anterior_w := null;
		end;
	elsif (NEW.ie_tipo_correcao = 10) then -- Data de emiss?o
		BEGIN
		if (NEW.cd_material is null) then
			select	a.dt_emissao
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	a.dt_emissao
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				nota_fiscal a
			where	a.nr_sequencia		= b.nr_sequencia
			and	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 11) then -- Data de sa?da
		BEGIN
		--  N?o tem o 11 -- Data de sa?da -- Inativo

		null;
		end;

	elsif (NEW.ie_tipo_correcao = 12) then -- Unidade
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(Obter_Unidade_Medida(b.cd_unidade_medida_compra), 1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(Obter_Unidade_Medida(b.cd_unidade_medida_compra), 1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 13) then -- Quantidade
		BEGIN
		if (NEW.cd_material is null) then
			select	b.qt_item_nf
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	b.qt_item_nf
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 14) then -- Descri??o do servi?o
		BEGIN
		--  N?o tem o 14 -- Descri??o do servi?o -- Ativo

		null;
		end;
	elsif (NEW.ie_tipo_correcao = 15) then -- Pre?o unit?rio
		BEGIN
		if (NEW.cd_material is null) then
			select	b.vl_unitario_item_nf
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	b.vl_unitario_item_nf
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 16) then -- Valor do produto
		BEGIN
		-- N?o tem o 16 -- Valor do produto -- Inativo

		null;
		end;
	elsif (NEW.ie_tipo_correcao in (17,48)) then -- Classifica??o fiscal e NCM
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(coalesce(a.nr_seq_ncm,'0'), 1, 10)
			into STRICT	vl_anterior_w
			from	material_fiscal a,
				nota_fiscal_item b
			where	a.cd_material		= b.cd_material
			and	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(coalesce(a.nr_seq_ncm,'0'), 1, 10)
			into STRICT	vl_anterior_w
			from	material_fiscal a,
				nota_fiscal_item b
			where	a.cd_material		= b.cd_material
			and	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 18) then -- Aliquota IPI
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(coalesce(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'IPI', 'TX'),'0'), 1, 20) vl_aliquota_ipi
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(coalesce(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'IPI', 'TX'),'0'), 1, 20) vl_aliquota_ipi
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 19) then -- Valor do IPI
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'IPI', 'TRIB'), 1, 20) vl_ipi
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'IPI', 'TRIB'), 1, 20) vl_ipi
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 20) then -- Base de c?lculo IPI
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'IPI', 'BC'), 1, 20) vl_base_ipi
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'IPI', 'BC'), 1, 20) vl_base_ipi
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 21) then -- Valor total nota
		BEGIN
		select	substr(a.vl_total_nota, 1, 20)
		into STRICT	vl_anterior_w
		from	nota_fiscal a
		where	a.nr_sequencia		= NEW.nr_seq_nota_fiscal;
		
		exception
		when no_data_found or too_many_rows then
			vl_anterior_w := null;
		end;
	elsif (NEW.ie_tipo_correcao = 22) then -- Valor total nota
		BEGIN
		-- N?o tem o 22 -- Valor por extenso -- Inativo

		null;
		end;
	elsif (NEW.ie_tipo_correcao = 23) then -- Valor do ICMS
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'ICMS', 'TRIB'), 1, 20) vl_icms_deb_cred
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'ICMS', 'TRIB'), 1, 20) vl_icms_deb_cred
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 24) then -- Base de c?lculo do ICMS
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'ICMS', 'BC'), 1, 20) vl_base_icms
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'ICMS', 'BC'), 1, 20) vl_base_icms
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 25) then -- Nome transportadora
		BEGIN
		--  N?o tem o 25 -- Nome transportadora -- Inativo

		null;
		end;
	elsif (NEW.ie_tipo_correcao = 26) then -- Endere?o da transportadora
		BEGIN	
			select	substr(obter_dados_pf_pj(null, t.cd_cnpj, 'R'), 1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_transportadora t,
				nota_fiscal a
			where	a.nr_sequencia		= t.nr_seq_nota
			and	a.nr_sequencia		= NEW.nr_seq_nota_fiscal;
		null;
		end;
	elsif (NEW.ie_tipo_correcao = 27) then -- Termo isen??o do IPI
		BEGIN
		-- N?o tem o 27 -- Termo isen??o do IPI -- Inativo

		null;
		end;
	elsif (NEW.ie_tipo_correcao = 28) then -- Termo de isen??o do ICMS 
		BEGIN
		-- N?o tem o 28 -- Termo de isen??o do ICMS -- Inativo

		null;
		end;
	elsif (NEW.ie_tipo_correcao = 29) then -- Peso bruto/liquido
		BEGIN
		select	t.qt_peso_bruto || '/' || t.qt_peso_liquido
		into STRICT	vl_anterior_w
		from	nota_fiscal_transportadora t,
			nota_fiscal a
		where	a.nr_sequencia		= t.nr_seq_nota
		and	a.nr_sequencia		= NEW.nr_seq_nota_fiscal;
		end;
	elsif (NEW.ie_tipo_correcao = 30) then -- Volume
		BEGIN
		select	t.qt_volume
		into STRICT	vl_anterior_w
		from	nota_fiscal_transportadora t,
			nota_fiscal a
		where	a.nr_sequencia		= t.nr_seq_nota
		and	a.nr_sequencia		= NEW.nr_seq_nota_fiscal;
		end;
	elsif (NEW.ie_tipo_correcao = 31) then -- Rasuras 
		BEGIN
		-- N?o tem o 31 -- Rasuras -- Inativo

		null;
		end;
	elsif (NEW.ie_tipo_correcao = 32) then -- Vencimento
		BEGIN
		select	max(dt_vencimento)
		into STRICT	vl_anterior_w
		from	nota_fiscal_venc v,
			nota_fiscal_item b,
			nota_fiscal a
		where	a.nr_sequencia		= v.nr_sequencia
		and	a.nr_sequencia		= b.nr_sequencia
		and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal;
		end;
	elsif (NEW.ie_tipo_correcao = 33) then -- Hist?rico 
		BEGIN
		-- N?o tem o 33 -- Hist?rico -- Inativo

		null;
		end;
	elsif (NEW.ie_tipo_correcao = 34) then -- Per?odo
		BEGIN
		--  N?o tem o 34 -- Per?odo -- Inativo

		null;
		end;
	elsif (NEW.ie_tipo_correcao = 35) then -- Base de c?lculo ISS
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'ISS', 'BC'), 1, 20) vl_base_iss
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'ISS', 'BC'), 1, 20) vl_base_iss
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 36) then -- Valor total ISS
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'ISS', 'TRIB'), 1, 20) vl_iss
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(nfe_obter_valor_trib_item(b.nr_sequencia, b.nr_item_nf, 'ISS', 'TRIB'), 1, 20) vl_iss
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 37) then -- Observa??o
		BEGIN
		if (NEW.cd_material is null) then
			select	substr(b.ds_observacao, 1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	substr(b.ds_observacao, 1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b
			where	b.cd_material		= NEW.cd_material
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 38) then -- Lote do medicamento
		BEGIN
		select	substr(m.ds_lote_fornec, 1, 255)
		into STRICT	vl_anterior_w
		FROM nota_fiscal_item b
LEFT OUTER JOIN material_lote_fornec m ON (b.nr_seq_lote_fornec = m.nr_sequencia)
WHERE b.nr_sequencia	     = NEW.nr_seq_nota_fiscal;	
		end;
	elsif (NEW.ie_tipo_correcao = 39) then -- Lote fornecedor
		BEGIN
		--verificar se tem lote fornecedor vinculado a nota_fiscal_item (aba lote fornecedor na nota fiscal)

		select 	count(*)
		into STRICT	qt_registros_w
		from	nota_fiscal_item_lote b,
			material_lote_fornec m
		where	b.nr_seq_lote_fornec	= m.nr_sequencia
		and	b.nr_seq_nota	     	= NEW.nr_seq_nota_fiscal
		and	b.nr_item_nf 	     	= NEW.nr_item_nf
		and 	b.nr_sequencia		= NEW.nr_seq_item_lote;

		if (qt_registros_w > 0) then
			select	substr(m.ds_lote_fornec, 1, 255)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item_lote b,
				material_lote_fornec m
			where	b.nr_seq_lote_fornec = m.nr_sequencia
			and	b.nr_seq_nota	     = NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 	     = NEW.nr_item_nf
			and 	b.nr_sequencia	     = NEW.nr_seq_item_lote;

		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 40) then -- Observa??o da Nota
		BEGIN
		select	substr(b.ds_observacao, 1, 255)
		into STRICT	vl_anterior_w
		from	nota_fiscal b
		where	b.nr_sequencia	     = NEW.nr_seq_nota_fiscal;
		end;
	elsif (NEW.ie_tipo_correcao = 41) then
		BEGIN
		--  N?o tem o 41 -- N?o existe

		null;
		end;
	elsif (NEW.ie_tipo_correcao = 42) then -- Descri??o do item da nota
		BEGIN
		if (NEW.cd_material is null) then
			select	a.ds_material
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				material a
			where	b.cd_procedimento	= NEW.cd_procedimento
			and	b.ie_origem_proced	= NEW.ie_origem_proced
			and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 		= NEW.nr_item_nf;
		else
			select	a.ds_material
			into STRICT	vl_anterior_w
			from	nota_fiscal_item b,
				material a
			where	b.cd_material	= a.cd_material
			and	b.nr_sequencia	= NEW.nr_seq_nota_fiscal
			and	b.nr_item_nf 	= NEW.nr_item_nf;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 43) then
		BEGIN
		--  N?o tem o 43 -- N?o existe

		null;
		end;
	elsif (NEW.ie_tipo_correcao = 44) then -- Tipo frete
		BEGIN	
		/*
		T - 'Por conta de terceiros'
		C - 'Por conta do emitente'
		F - 'Por conta do destinat?rio/remetente'
		'Sem frete'
		*/

		select	substr(CASE WHEN t.ie_tipo_frete='T' THEN wheb_mensagem_pck.get_texto(310761) WHEN t.ie_tipo_frete='C' THEN wheb_mensagem_pck.get_texto(310762) WHEN t.ie_tipo_frete='F' THEN wheb_mensagem_pck.get_texto(310763)  ELSE wheb_mensagem_pck.get_texto(310764) END ,1,255)
		into STRICT	vl_anterior_w
		from	nota_fiscal_transportadora t,
			nota_fiscal a
		where	a.nr_sequencia		= t.nr_seq_nota
		and	a.nr_sequencia		= NEW.nr_seq_nota_fiscal;
		
		select	substr(CASE WHEN NEW.ie_tipo_frete='T' THEN wheb_mensagem_pck.get_texto(310761) WHEN NEW.ie_tipo_frete='C' THEN wheb_mensagem_pck.get_texto(310762) WHEN NEW.ie_tipo_frete='F' THEN wheb_mensagem_pck.get_texto(310763)  ELSE wheb_mensagem_pck.get_texto(310764) END ,1,255)
		into STRICT	vl_atual_w
		;
		
		NEW.vl_atual := vl_atual_w;
		end;
	elsif (NEW.ie_tipo_correcao = 45) then -- CST
		BEGIN
		if (NEW.cd_material is null) then
			select CASE WHEN obter_tipo_tributo(a.cd_tributo)='PIS' THEN  b.ie_tributacao_pis WHEN obter_tipo_tributo(a.cd_tributo)='COFINS' THEN  b.ie_tributacao_cofins END
			into STRICT	vl_anterior_w
			from	nota_fiscal_item_trib a,
				procedimento_fiscal b,
				nota_fiscal_item c,
				tributo d
			where	c.nr_item_nf 		= a.nr_item_nf
			and	c.nr_sequencia 		= a.nr_sequencia 
			and	a.cd_tributo 		= d.cd_tributo
			and	b.cd_procedimento	= c.cd_procedimento
			and	b.ie_origem_proced	= c.ie_origem_proced
			and	a.nr_sequencia 		= NEW.nr_seq_nota_fiscal
			and	a.nr_item_nf  		= NEW.nr_item_nf
			and	a.cd_tributo 		= NEW.cd_tributo;
		else
			select CASE WHEN obter_tipo_tributo(a.cd_tributo)='ICMS' THEN  b.ie_tributacao_icms WHEN obter_tipo_tributo(a.cd_tributo)='IPI' THEN  b.ie_tributacao_ipi WHEN obter_tipo_tributo(a.cd_tributo)='PIS' THEN  b.ie_tributacao_pis_saida WHEN obter_tipo_tributo(a.cd_tributo)='COFINS' THEN  b.ie_tribut_cofins_saida END
			into STRICT	vl_anterior_w
			from	nota_fiscal_item_trib a,
				material_fiscal b,
				nota_fiscal_item c,
				tributo d
			where	c.nr_item_nf 	= a.nr_item_nf
			and	c.nr_sequencia 	= a.nr_sequencia 
			and	a.cd_tributo 	= d.cd_tributo
			and	c.cd_material 	= b.cd_material
			and	a.nr_sequencia 	= NEW.nr_seq_nota_fiscal
			and	a.nr_item_nf  	= NEW.nr_item_nf
			and	a.cd_tributo 	= NEW.cd_tributo;
		end if;
		end;
	elsif (NEW.ie_tipo_correcao = 46) then
		BEGIN
		
		if (NEW.cd_material is null) then
			select	max(b.cd_situacao)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item c,
				situacao_trib_prest_serv b
			where	c.nr_seq_classif_trib	= b.nr_sequencia
			and	c.nr_sequencia 		= NEW.nr_seq_nota_fiscal
			and	c.nr_item_nf  		= NEW.nr_item_nf
			and	c.cd_procedimento	= NEW.cd_procedimento;
		else
			select	max(b.cd_situacao)
			into STRICT	vl_anterior_w
			from	nota_fiscal_item c,
				situacao_trib_prest_serv b
			where	c.nr_seq_classif_trib	= b.nr_sequencia
			and	c.nr_sequencia 		= NEW.nr_seq_nota_fiscal
			and	c.nr_item_nf  		= NEW.nr_item_nf
			and	c.cd_material		= NEW.cd_material;
		end if;
		select	max(cd_situacao)
		into STRICT	vl_atual_w
		from	situacao_trib_prest_serv
		where	nr_sequencia = NEW.nr_seq_classif_trib;
		
		NEW.vl_atual := vl_atual_w;
		end;
	elsif (NEW.ie_tipo_correcao = 47) then
		BEGIN
		vl_anterior_w := NEW.vl_anterior;
		
		end;

	elsif (NEW.ie_tipo_correcao = 51) then
		BEGIN
			if (NEW.cd_material is null) then
				select	substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc), 1, 255)
				into STRICT	vl_anterior_w
				from	nota_fiscal_item b,
					nota_fiscal a
				where	a.nr_sequencia		= b.nr_sequencia
				and	b.cd_procedimento	= NEW.cd_procedimento
				and	b.ie_origem_proced	= NEW.ie_origem_proced
				and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal;
			else
				select	substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc), 1, 255)
				into STRICT	vl_anterior_w
				from	nota_fiscal_item b,
					nota_fiscal a
				where	a.nr_sequencia		= b.nr_sequencia
				and	b.cd_material		= NEW.cd_material
				and	b.nr_sequencia		= NEW.nr_seq_nota_fiscal;
			end if;
		
		end;
	end if;

	exception
	when others then
		vl_anterior_w := null;
	end;

	NEW.vl_anterior		:= vl_anterior_w;
end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_fis_carta_correcao_insert() FROM PUBLIC;

CREATE TRIGGER fis_carta_correcao_insert
	BEFORE INSERT OR UPDATE ON fis_carta_correcao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_fis_carta_correcao_insert();

