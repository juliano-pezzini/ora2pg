-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS gerint_unidade_atendimento ON unidade_atendimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_gerint_unidade_atendimento() RETURNS trigger AS $BODY$
declare

cd_estabelecimento_w	integer;
ds_sep_bv_w				varchar(50);

BEGIN

/*			I N T E G R A Ç Ã O  -  G E R I N T
	Evento 1: Serviço de Bloqueio de Leito
	Evento 2: Serviço de Desbloqueio de Leito*/
select	max(cd_estabelecimento_base)
into STRICT	cd_estabelecimento_w
from	setor_atendimento
where	cd_setor_atendimento = NEW.cd_setor_atendimento;

ds_sep_bv_w	:=	obter_separador_bv;

if (obter_dados_param_atend(cd_estabelecimento_w,'GI') = 'S') and (NEW.nm_leito_integracao is not null) then

	if (OLD.ie_status_unidade not in ('M', 'O', 'E', 'I', 'H', 'R', 'G')) and (NEW.ie_status_unidade in ('M', 'O', 'E', 'I', 'H', 'R', 'G')) then

		CALL exec_sql_dinamico_bv('TASY', Gerint_desc_de_para('QUERY'), 	'nm_usuario_p='					|| NEW.nm_usuario  		|| ds_sep_bv_w ||
																	'cd_estabelecimento_p=' 		|| cd_estabelecimento_w 	|| ds_sep_bv_w ||
																	'id_evento_p=' 					|| 1 						|| ds_sep_bv_w ||
																	'nr_atendimento_p=' 			|| NEW.nr_atendimento 		|| ds_sep_bv_w ||
																	'ie_leito_extra_p=' 			|| null 					|| ds_sep_bv_w ||
																	'dt_alta_p=' 					|| null 					|| ds_sep_bv_w ||
																	'ds_motivo_alta_p=' 			|| null 					|| ds_sep_bv_w ||
																	'ds_justif_transferencia_p='	|| null 					|| ds_sep_bv_w ||
																	'nr_seq_solic_internacao_p=' 	|| null 					|| ds_sep_bv_w ||
																	'nr_seq_leito_p=' 				|| NEW.nr_seq_interno		|| ds_sep_bv_w ||
																	'ds_ident_leito_p='				|| NEW.nm_leito_integracao	|| ds_sep_bv_w ||
																	'nr_seq_classif_p=' 			|| NEW.nr_seq_classif		|| ds_sep_bv_w ||
																	'ie_status_unidade_p=' 			|| NEW.ie_status_unidade	|| ds_sep_bv_w ||
																	'nr_cpf_paciente_p=' 			|| null						|| ds_sep_bv_w ||
																	'nr_cartao_sus_p=' 				|| null						|| ds_sep_bv_w ||
																	'cd_cid_p='						|| null						|| ds_sep_bv_w ||
																	'cd_evolucao_p='				|| null);

	end if;

	if (OLD.ie_status_unidade in ('M', 'O', 'E', 'I', 'H', 'R', 'G')) and (NEW.ie_status_unidade not in ('M', 'O', 'E', 'I', 'H', 'R', 'G')) then

		CALL exec_sql_dinamico_bv('TASY', Gerint_desc_de_para('QUERY'), 	'nm_usuario_p='					|| NEW.nm_usuario  		|| ds_sep_bv_w ||
																	'cd_estabelecimento_p=' 		|| cd_estabelecimento_w 	|| ds_sep_bv_w ||
																	'id_evento_p=' 					|| 2 						|| ds_sep_bv_w ||
																	'nr_atendimento_p=' 			|| NEW.nr_atendimento 		|| ds_sep_bv_w ||
																	'ie_leito_extra_p=' 			|| null 					|| ds_sep_bv_w ||
																	'dt_alta_p=' 					|| null 					|| ds_sep_bv_w ||
																	'ds_motivo_alta_p=' 			|| null 					|| ds_sep_bv_w ||
																	'ds_justif_transferencia_p='	|| null 					|| ds_sep_bv_w ||
																	'nr_seq_solic_internacao_p=' 	|| null 					|| ds_sep_bv_w ||
																	'nr_seq_leito_p=' 				|| NEW.nr_seq_interno		|| ds_sep_bv_w ||
																	'ds_ident_leito_p='				|| NEW.nm_leito_integracao	|| ds_sep_bv_w ||
																	'nr_seq_classif_p=' 			|| NEW.nr_seq_classif		|| ds_sep_bv_w ||
																	'ie_status_unidade_p=' 			|| NEW.ie_status_unidade	|| ds_sep_bv_w ||
																	'nr_cpf_paciente_p=' 			|| null						|| ds_sep_bv_w ||
																	'nr_cartao_sus_p=' 				|| null						|| ds_sep_bv_w ||
																	'cd_cid_p='						|| null						|| ds_sep_bv_w ||
																	'cd_evolucao_p='				|| null);
	end if;

end if;
/*		I N T E G R A Ç Ã O  -  G E R I N T  -  F I M		*/

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_gerint_unidade_atendimento() FROM PUBLIC;

CREATE TRIGGER gerint_unidade_atendimento
	AFTER UPDATE ON unidade_atendimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_gerint_unidade_atendimento();

