-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS latam_requisito_after ON latam_requisito CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_latam_requisito_after() RETURNS trigger AS $BODY$
DECLARE

ie_tipo_gap_w               varchar(10);
qt_funcao_w                 bigint;
cd_funcao_w                 funcao.cd_funcao%type;
nr_seq_reg_prs_w            reg_product_requirement.nr_sequencia%type;
nr_seq_old_reg_prs_w        reg_product_requirement.nr_sequencia%type;
nr_customer_requirement_w   reg_product_requirement.nr_customer_requirement%type;
nr_seq_latam_crs_w          latam_requisito_crs.nr_sequencia%type;
ds_observacao_w             latam_log.ds_observacao%type;
ds_quebra_w			            varchar(20);

C01 CURSOR FOR
    SELECT  a.cd_funcao
    from    reg_funcao_pr   a,
            reg_product_requirement b
    where   a.nr_seq_product_req = b.nr_sequencia
    and b.nr_sequencia = nr_seq_reg_prs_w;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then
    BEGIN
    select  a.ie_tipo_gap,
            e.nr_seq_prs
    into STRICT    ie_tipo_gap_w,
            nr_seq_reg_prs_w
    from    latam_gap a,
            latam_modulo b,
            latam_subprocesso c,
            latam_requisito_crs d,
            latam_requisito_prs e
    where   a.nr_sequencia  = b.nr_seq_gap
    and b.nr_sequencia  = c.nr_seq_modulo
    and c.nr_sequencia  = d.nr_seq_latam_subprocesso
    and d.nr_sequencia  = e.nr_seq_requisito_crs
    and e.nr_sequencia  = NEW.nr_seq_prs;
    exception
    when others then
        BEGIN
        ie_tipo_gap_w       := 'X';
        nr_seq_reg_prs_w    := null;
        end;
    end;

    if (NEW.nr_seq_prs is not null) and (coalesce(OLD.nr_seq_prs,0) <> coalesce(NEW.nr_seq_prs,0)) then
    
        select  max(b.nr_seq_crs)
        into STRICT    nr_customer_requirement_w
        from    latam_requisito_prs a,
                latam_requisito_crs b
        where   a.nr_seq_requisito_crs = b.nr_sequencia
                and a.nr_sequencia = NEW.nr_seq_prs;

        select  nextval('latam_requisito_crs_seq')
        into STRICT    nr_seq_latam_crs_w
;

        insert into latam_requisito_crs(
                        nr_sequencia,
                        dt_atualizacao,
                        nm_usuario,
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        nr_seq_requisito,
                        nr_seq_crs)
        values (   nr_seq_latam_crs_w,
                        LOCALTIMESTAMP,
                        NEW.nm_usuario,
                        LOCALTIMESTAMP,
                        NEW.nm_usuario,
                        NEW.nr_sequencia,
                        nr_customer_requirement_w);

        select  max(a.nr_seq_prs)
        into STRICT    nr_seq_reg_prs_w
        from    latam_requisito_prs a
        where   a.nr_sequencia = NEW.nr_seq_prs;

    
    
        insert  into latam_requisito_prs(nr_sequencia,
                        dt_atualizacao,
                        nm_usuario,
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        nr_seq_requisito_crs,
                        nr_seq_prs)
        values (   nextval('latam_requisito_prs_seq'),
                        LOCALTIMESTAMP,
                        NEW.nm_usuario,
                        LOCALTIMESTAMP,
                        NEW.nm_usuario,
                        nr_seq_latam_crs_w,
                        nr_seq_reg_prs_w);
    end if;

    if (NEW.nr_seq_req_prs is not null) and (coalesce(OLD.nr_seq_req_prs,0) <> coalesce(NEW.nr_seq_req_prs,0)) then
    
        delete  FROM latam_requisito_crs
        where   nr_seq_requisito = NEW.nr_sequencia;

        select  max(nr_customer_requirement)
        into STRICT    nr_customer_requirement_w
        from    reg_product_requirement
        where   nr_sequencia = NEW.nr_seq_req_prs;

        select  nextval('latam_requisito_crs_seq')
        into STRICT    nr_seq_latam_crs_w
;

        insert into latam_requisito_crs(
                        nr_sequencia,
                        dt_atualizacao,
                        nm_usuario,
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        nr_seq_requisito,
                        nr_seq_crs)
        values (   nr_seq_latam_crs_w,
                        LOCALTIMESTAMP,
                        NEW.nm_usuario,
                        LOCALTIMESTAMP,
                        NEW.nm_usuario,
                        NEW.nr_sequencia,
                        nr_customer_requirement_w);

        insert  into latam_requisito_prs(nr_sequencia,
                        dt_atualizacao,
                        nm_usuario,
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        nr_seq_requisito_crs,
                        nr_seq_prs)
        values (   nextval('latam_requisito_prs_seq'),
                        LOCALTIMESTAMP,
                        NEW.nm_usuario,
                        LOCALTIMESTAMP,
                        NEW.nm_usuario,
                        nr_seq_latam_crs_w,
                        NEW.nr_seq_req_prs);
    end if;

    nr_seq_old_reg_prs_w    := OLD.nr_seq_req_prs;
    nr_seq_reg_prs_w    := NEW.nr_seq_req_prs;
    if  ((NEW.nr_seq_req_prs is not null) and (coalesce(OLD.nr_seq_req_prs,0) <> coalesce(NEW.nr_seq_req_prs,0))) or
        ((NEW.nr_seq_prs is not null) and (coalesce(OLD.nr_seq_prs,0) <> coalesce(NEW.nr_seq_prs,0))) then

        if (NEW.nr_seq_prs is not null) then
            select  max(a.nr_seq_prs)
            into STRICT    nr_seq_reg_prs_w
            from    latam_requisito_prs a
            where   a.nr_sequencia = NEW.nr_seq_prs;

            select  max(a.nr_seq_prs)
            into STRICT    nr_seq_old_reg_prs_w
            from    latam_requisito_prs a
            where   a.nr_sequencia = OLD.nr_seq_prs;
        end if;

        delete  FROM latam_requisito_funcao a
        where   a.nr_seq_requisito = NEW.nr_sequencia
        and exists (SELECT  1
                from    reg_funcao_pr x
                where   x.cd_funcao = a.cd_funcao
                and     x.nr_seq_product_req = nr_seq_old_reg_prs_w);

        open C01;
        loop
        fetch C01 into
            cd_funcao_w;
        EXIT WHEN NOT FOUND; /* apply on C01 */
        BEGIN

        select  count(*)
        into STRICT    qt_funcao_w
        from    latam_requisito_funcao
        where   nr_seq_requisito = NEW.nr_sequencia
        and     cd_funcao = cd_funcao_w;

        if (qt_funcao_w    = 0) then
                insert into latam_requisito_funcao(nr_sequencia,
                        dt_atualizacao,
                        nm_usuario,
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        nr_seq_requisito,
                        cd_funcao)
                values (nextval('latam_requisito_funcao_seq'),
                        LOCALTIMESTAMP,
                        NEW.nm_usuario,
                        LOCALTIMESTAMP,
                        NEW.nm_usuario,
                        NEW.nr_sequencia,
                        cd_funcao_w);
        end if;

        end;
        end loop;
        close C01;

    end if;

    if TG_OP = 'INSERT' then
        insert into latam_log(nr_sequencia,
                              dt_atualizacao,
                              nm_usuario,
                              nr_seq_requisito,
                              ie_liberar_desenv_old,
                              ie_liberar_desenv,
                              ds_observacao)
                   values (nextval('latam_log_seq'),
                              LOCALTIMESTAMP,
                              NEW.nm_usuario,
                              NEW.nr_sequencia,
                              null,
                              NEW.ie_liberar_desenv,
                              SUBSTR(obter_desc_expressao(648823), 1, 2000));
    end if;

    if TG_OP = 'UPDATE' then
        BEGIN
            ds_observacao_w := ' ';
            ds_quebra_w	    := chr(10);
            if NEW.ie_importancia_desenv <> OLD.ie_importancia_desenv then
              ds_observacao_w := ds_observacao_w || (wheb_mensagem_pck.get_texto(1195724, 'NEW="' ||
                                  obter_valor_dominio(8355, NEW.ie_importancia_desenv) ||
                                  '";OLD="' ||obter_valor_dominio(8355, OLD.ie_importancia_desenv)||'"')|| ds_quebra_w);
            end if;

            if NEW.nr_seq_modulo <> OLD.nr_seq_modulo then
              ds_observacao_w := ds_observacao_w || (wheb_mensagem_pck.get_texto(1195724, 'NEW="' || NEW.nr_seq_modulo ||
                                  ' - ' || substr(obter_ds_modulo_pais(NEW.nr_seq_modulo),1,80) ||
                                  '";OLD=" ' || OLD.nr_seq_modulo || ' - ' || substr(obter_ds_modulo_pais(OLD.nr_seq_modulo),1,80)||'"') || ds_quebra_w);
            end if;

            if NEW.ie_liberar_desenv <> OLD.ie_liberar_desenv then
              ds_observacao_w := ds_observacao_w || (wheb_mensagem_pck.get_texto(1195724, 'NEW="' ||
                                  obter_valor_dominio(8158, NEW.ie_liberar_desenv) ||
                                  '";OLD="' || obter_valor_dominio(8158, OLD.ie_liberar_desenv)||'"') || ds_quebra_w);
            end if;

            if NEW.ie_golive <> OLD.ie_golive then
              ds_observacao_w := ds_observacao_w || (wheb_mensagem_pck.get_texto(1195724, 'NEW="' ||
                                  obter_valor_dominio(8070, NEW.ie_golive) ||
                                  '";OLD="' || obter_valor_dominio(8070, OLD.ie_golive)||'"') || ds_quebra_w);
            end if;

            if NEW.nr_seq_milestone <> OLD.nr_seq_milestone then
              ds_observacao_w := ds_observacao_w || (wheb_mensagem_pck.get_texto(1195724, 'NEW="' || NEW.nr_seq_milestone ||
                                  '";OLD="' || OLD.nr_seq_milestone ||'"') || ds_quebra_w);
            end if;

            if (ds_observacao_w is not null) then
              insert into latam_log(nr_sequencia,
              dt_atualizacao,
              nm_usuario,
              nr_seq_requisito,
              ie_liberar_desenv_old,
              ie_liberar_desenv,
              ds_observacao)
              values (nextval('latam_log_seq'),
              LOCALTIMESTAMP,
              NEW.nm_usuario,
              NEW.nr_sequencia,
              OLD.ie_liberar_desenv,
              NEW.ie_liberar_desenv,
              ds_observacao_w);
            end if;
        end;
    end if;
end if;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_latam_requisito_after() FROM PUBLIC;

CREATE TRIGGER latam_requisito_after
	AFTER INSERT OR UPDATE ON latam_requisito FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_latam_requisito_after();

