-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS eme_regulacao_update ON eme_regulacao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_eme_regulacao_update() RETURNS trigger AS $BODY$
declare

ds_call_w	varchar(2000);

pragma autonomous_transaction;

BEGIN

if (NEW.nr_atendimento is null) and (OLD.nr_atendimento is not null) then
	
	ds_call_w:= dbms_utility.format_call_stack;
	insert into log_atendimento(dt_atualizacao,nm_usuario,cd_log,ds_log,nr_atendimento)
	values (LOCALTIMESTAMP,'Tasy',19,substr('new.nr_atendimento: ' || NEW.nr_atendimento || ' old.nr_atendimento: ' || OLD.nr_atendimento || ' callstack: ' || ds_call_w,1,2000),0);
	
	
	/* 
	Realizado tratamento abaixo para que o atendimento não seja retirado da regulação, OS 879354
	*/
	
	NEW.nr_atendimento := OLD.nr_atendimento;
	
	commit;
	
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_eme_regulacao_update() FROM PUBLIC;

CREATE TRIGGER eme_regulacao_update
	BEFORE UPDATE ON eme_regulacao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_eme_regulacao_update();

