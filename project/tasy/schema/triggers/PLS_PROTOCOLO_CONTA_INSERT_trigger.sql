-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_protocolo_conta_insert ON pls_protocolo_conta CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_protocolo_conta_insert() RETURNS trigger AS $BODY$
declare

ds_log_call_w	varchar(1500);
ds_observacao_w	varchar(4000);

BEGIN
/* A versão TISS vem no XML, PTU ou pode ser informada em tela,
porém temos que garantir que caso não informada, busque a versão vigente
pois há várias visões de telas tratadas pela versão TISS */
if (NEW.cd_versao_tiss is null) then
	NEW.cd_versao_tiss	:= pls_obter_versao_tiss;
end if;


if (NEW.ie_apresentacao is null) then

	ds_log_call_w := substr(pls_obter_detalhe_exec(false),1,1500);
	ds_observacao_w := 'Protocolo: '||OLD.nr_sequencia||' sendo inserido sem informação de tipo de apresentação';

	insert into plsprco_cta(
		nr_sequencia, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, nm_tabela,
		ds_log, ds_log_call, ds_funcao_ativa,
		ie_aplicacao_tasy, nm_maquina, ie_opcao
	) values (
		nextval('plsprco_cta_seq'), LOCALTIMESTAMP, substr(coalesce(wheb_usuario_pck.get_nm_usuario,'Usuário não identificado '),1,14),
		LOCALTIMESTAMP, substr(coalesce(wheb_usuario_pck.get_nm_usuario,'Usuário não identificado '),1,14), 'PLS_PROTOCOLO_CONTA',
		ds_observacao_w, ds_log_call_w, obter_funcao_ativa,
		'N', wheb_usuario_pck.get_machine, '0'
	);

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_protocolo_conta_insert() FROM PUBLIC;

CREATE TRIGGER pls_protocolo_conta_insert
	BEFORE INSERT ON pls_protocolo_conta FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_protocolo_conta_insert();

