-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS aval_nutricao_atual ON aval_nutricao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_aval_nutricao_atual() RETURNS trigger AS $BODY$
declare
    cd_pessoa_fisica_w PESSOA_FISICA.CD_PESSOA_FISICA%type;
    ie_sexo_w varchar(1);
    qt_fator_ativ_w double precision;
    qt_fator_stress_w double precision;
    qt_obesidade smallint;
    qt_pont_sexo smallint;
    qt_pont_queimadura smallint;
    qt_pont_trauma smallint;
    ie_raca_negra_w varchar(1);
    qt_nec_proteica_w double precision;
    sql_w varchar(4000);
    qt_razao_cintura_quadril_w double precision;
    qt_imc_w 				real;
    qt_altura_estimada_w 	smallint;
    qt_altura_w 			real;
    qt_peso_atual_w 		double precision;
    qt_peso_atual_ww 		double precision;
    qt_peso_ajustado_w 		double precision;
    pr_gordura_w 			double precision;
    qt_reg_w 				smallint;
    qt_perc_circ_braco_w 		real;
    qt_perc_prega_cut_tricip_w real;
    qt_perc_circ_musc_braco_w real;
    ds_erro_w             varchar(4000);
    ds_parametros_w       varchar(4000);
    qt_peso_habit_i_w     integer;
    ie_form_hamwi_w       varchar(1);
	qt_caloria_w		real;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;

select cd_pessoa_fisica
into STRICT   cd_pessoa_fisica_w
from   atendimento_paciente
where  nr_atendimento = NEW.nr_atendimento;

if (NEW.cd_pessoa_fisica is null) then
    NEW.cd_pessoa_fisica := cd_pessoa_fisica_w;
end if;

select obter_sexo_pf(cd_pessoa_fisica_w,'C')
into STRICT   ie_sexo_w
;

BEGIN
sql_w := 'begin obter_perda_aval_nutri_md  (:1, :2, :3, :4, :5); end;';
EXECUTE sql_w
	using in NEW.qt_peso_atual, in NEW.qt_peso_habit,
		 out NEW.pr_perda, out NEW.qt_perda, out NEW.pr_perda_peso;

exception
	when others then
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametros_w := substr( ':new.nr_atendimento: '
                                 || NEW.nr_atendimento
                                 || '-'
                                 || ':new.qt_peso_atual: '
                                 || NEW.qt_peso_atual
                                 || '-'
                                 || 'new.qt_peso_habit: '
                                 || NEW.qt_peso_habit
                                 || '-'
                                 || ':new.pr_perda: '
                                 || NEW.pr_perda
                                 || '-'
                                 || ':new.qt_perda: '
                                 || NEW.qt_perda
                                 || '-'
                                 || ':new.pr_perda_peso: '
                                 || NEW.pr_perda_peso, 1, 4000);
            CALL gravar_log_medical_device('aval_nutricao_atual',
                                     'obter_perda_aval_nutri_md',
                                     ds_parametros_w,
                                     ds_erro_w,
                                     NEW.nm_usuario,
                                     'N');
		NEW.pr_perda := null;
		NEW.qt_perda := null;
		NEW.pr_perda_peso := null;
end;

if (coalesce(OLD.dt_avaliacao,LOCALTIMESTAMP + interval '10 days') <> NEW.dt_avaliacao) and (NEW.dt_avaliacao is not null) then
	NEW.ds_utc		:= obter_data_utc(NEW.dt_avaliacao, 'hv');
end if;
if (coalesce(OLD.dt_liberacao,LOCALTIMESTAMP + interval '10 days') <> NEW.dt_liberacao) and (NEW.dt_liberacao is not null) then
	NEW.ds_utc_atualizacao	:= obter_data_utc(NEW.dt_liberacao,'hv');
end if;

if (NEW.qt_altura is not null) then
    BEGIN
        sql_w := 'call obter_valor_imc_md(:1, :2, :3) into :qt_imc_w';
        EXECUTE sql_w
            using	in NEW.qt_peso_atual ,
					in 0 ,
					in NEW.qt_altura,
					out qt_imc_w;
    exception
        when others then
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametros_w := substr( ':new.nr_atendimento: '
                                 || NEW.nr_atendimento
                                 || '-'
                                 || ':new.qt_peso_atual: '
                                 || NEW.qt_peso_atual
                                 || '-'
                                 || 'new.qt_altura: '
                                 || NEW.qt_altura
                                 || '-'
                                 || 'qt_imc_w: '
                                 || qt_imc_w, 1, 4000);
            CALL gravar_log_medical_device('aval_nutricao_atual',
                                     'obter_valor_imc_md',
                                     ds_parametros_w,
                                     ds_erro_w,
                                     NEW.nm_usuario,
                                     'N');

            qt_imc_w := null;
    end;

    NEW.qt_imc	:= qt_imc_w;
end if;

ie_form_hamwi_w := obter_param_usuario(281, 1666, obter_perfil_ativo, NEW.nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_form_hamwi_w);

if (ie_form_hamwi_w = 'S'           and
  NEW.qt_altura is not null       and
  NEW.qt_peso_habit_i is null     and
  ie_sexo_w in ('M', 'F')) then
    BEGIN
        sql_w := 'call calculate_weight_form_hamwi(:1, :2) into :qt_peso_habit_i_w';
        EXECUTE sql_w
          using	in NEW.qt_altura,
                in ie_sexo_w,
                out qt_peso_habit_i_w;
  exception
      when others then
          ds_erro_w := substr(sqlerrm, 1, 4000);
          ds_parametros_w := substr( ':new.nr_atendimento: '
                                || NEW.nr_atendimento
                                || '-'
                                || ':new.qt_altura: '
                                || NEW.qt_altura
                                || '-'
                                || 'ie_sexo_w: '
                                || ie_sexo_w
                                || '-'
                                || 'qt_peso_habit_i_w: '
                                || qt_peso_habit_i_w, 1, 4000);
          CALL gravar_log_medical_device('aval_nutricao_atual',
                                    'calculate_weight_form_hamwi',
                                    ds_parametros_w,
                                    ds_erro_w,
                                    NEW.nm_usuario,
                                    'N');

          qt_peso_habit_i_w := NEW.qt_peso_habit_i;
  end;

  NEW.qt_peso_habit_i := qt_peso_habit_i_w;
end if;

if (NEW.qt_circ_quadril	is not null) and (NEW.qt_circ_cintura is not null)then

    BEGIN
        sql_w := 'call dividir_md(:1, :2) into :qt_razao_cintura_quadril_w';
        EXECUTE sql_w
            using	in NEW.qt_circ_cintura,
					in NEW.qt_circ_quadril,
					out qt_razao_cintura_quadril_w;
    exception
        when others then
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametros_w := substr( ':new.nr_atendimento: '
                                 || NEW.nr_atendimento
                                 || '-'
                                 || ':new.qt_circ_cintura: '
                                 || NEW.qt_circ_cintura
                                 || '-'
                                 || 'new.qt_circ_quadril: '
                                 || NEW.qt_circ_quadril
                                 || '-'
                                 || 'qt_razao_cintura_quadril_w: '
                                 || qt_razao_cintura_quadril_w, 1, 4000);
            CALL gravar_log_medical_device('aval_nutricao_atual',
                                     'dividir_md',
                                     ds_parametros_w,
                                     ds_erro_w,
                                     NEW.nm_usuario,
                                     'N');

            NEW.qt_razao_cintura_quadril := null;
    end;

    NEW.qt_razao_cintura_quadril	:= qt_razao_cintura_quadril_w;
end if;

/* Obter se raca negra */

select	coalesce(max(ie_negro),'N')
into STRICT	ie_raca_negra_w
from	cor_pele a,
		pessoa_fisica b
where	b.nr_seq_cor_pele 	= a.nr_sequencia
and		b.cd_pessoa_fisica 	= cd_pessoa_fisica_w;

BEGIN
	sql_w := 'call obter_altura_estimada_md(:1, :2, :3) into :qt_altura_estimada_w';
	EXECUTE sql_w
		using	in ie_sexo_w ,
				in NEW.qt_idade,
				in NEW.qt_altura_joelho,
				out qt_altura_estimada_w;
exception
	when others then
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametros_w := substr( ':new.nr_atendimento: '
                                 || NEW.nr_atendimento
                                 || '-'
                                 || 'ie_sexo_w: '
                                 || ie_sexo_w
                                 || '-'
                                 || 'new.qt_idade: '
                                 || NEW.qt_idade
                                 || '-'
                                 || 'new.qt_altura_joelho: '
                                 || NEW.qt_altura_joelho
                                 || '-'
                                 || 'qt_altura_estimada_w: '
                                 || qt_altura_estimada_w, 1, 4000);
            CALL gravar_log_medical_device('aval_nutricao_atual',
                                     'obter_altura_estimada_md',
                                     ds_parametros_w,
                                     ds_erro_w,
                                     NEW.nm_usuario,
                                     'N');

		qt_altura_estimada_w := null;
end;

NEW.qt_altura_estimada	:= qt_altura_estimada_w;

BEGIN
	sql_w := 'begin obter_alt_peso_aval_nutri_md  (:1, :2, :3, :4, :5, :6, :7, :8, :9 ,:10, :11, :12); end;';
	EXECUTE sql_w
		using	in NEW.ie_origem_altura,
				in NEW.qt_altura_joelho,
				in ie_sexo_w,
				in NEW.qt_idade,
				in NEW.ie_origem_peso,
				in NEW.qt_prega_cut_subesc,
				in NEW.qt_circ_panturrilha,
				in NEW.qt_circ_braco,
				in NEW.qt_circ_abdomen,
				in ie_raca_negra_w,
				out qt_altura_w,
				out qt_peso_atual_w;
exception
	when others then
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametros_w := substr( ':new.nr_atendimento: '
                                 || NEW.nr_atendimento
                                 || '-'
                                 || ':new.ie_origem_altura: '
                                 || NEW.ie_origem_altura
                                 || '-'
                                 || 'ie_sexo_w: '
                                 || ie_sexo_w
                                 || '-'
                                 || 'new.qt_idade: '
                                 || NEW.qt_idade
                                 || '-'
                                 || ':new.ie_origem_peso: '
                                 || NEW.ie_origem_peso
                                 || '-'
                                 || ':new.qt_prega_cut_subesc: '
                                 || NEW.qt_prega_cut_subesc
                                 || '-'
                                 || ':new.qt_circ_panturrilha: '
                                 || NEW.qt_circ_panturrilha
                                 || '-'
                                 || 'new.qt_circ_braco: '
                                 || NEW.qt_circ_braco
                                 || '-'
                                 || ':new.qt_circ_abdomen: '
                                 || NEW.qt_circ_abdomen
                                 || '-'
                                 || 'ie_raca_negra_w: '
                                 || ie_raca_negra_w
                                 || '-'
                                 || 'qt_altura_w: '
                                 || qt_altura_w
                                 || '-'
                                 || 'qt_peso_atual_w: '
                                 || qt_peso_atual_w, 1, 4000);


            CALL gravar_log_medical_device('aval_nutricao_atual',
                                     'obter_alt_peso_aval_nutri_md',
                                     ds_parametros_w,
                                     ds_erro_w,
                                     NEW.nm_usuario,
                                     'N');

		qt_altura_w := null;
		qt_peso_atual_w := null;
end;

if (qt_altura_w is not null) then
	NEW.qt_altura := qt_altura_w;
end if;

if (qt_peso_atual_w is not null) then
	NEW.qt_peso_atual	:= qt_peso_atual_w;
end if;

BEGIN

qt_perc_circ_braco_w := obter_classif_percentil(ie_raca_negra_w, ie_sexo_w, NEW.qt_idade, 'CB');
qt_perc_prega_cut_tricip_w := obter_classif_percentil(ie_raca_negra_w, ie_sexo_w, NEW.qt_idade, 'PCT');
qt_perc_circ_musc_braco_w := obter_classif_percentil(ie_raca_negra_w, ie_sexo_w, NEW.qt_idade, 'CMB');

NEW.QT_PERC_CIRC_BRACO := qt_perc_circ_braco_w;
NEW.qt_perc_prega_cut_tricip := qt_perc_prega_cut_tricip_w;
NEW.qt_perc_circ_musc_braco := qt_perc_circ_musc_braco_w;

qt_caloria_w := NEW.qt_caloria;

sql_w := 'begin calc_percent_aval_nutri_md  (:1, :2, :3, :4, :5, :6, :7, :8, :9 ,:10, :11, :12, :13, :14, :15, :16, :17, :18, :19, :20, :21, :22, :23); end;';
EXECUTE sql_w
	using in ie_sexo_w,
		  in NEW.qt_idade, in NEW.qt_circ_braco, in NEW.qt_prega_cut_tricip,
		  in NEW.qt_peso_atual, in NEW.qt_altura, in NEW.qt_altura_estimada,
		  in NEW.qt_proteina, in OLD.qt_caloria, in NEW.qt_perc_circ_braco,
		  in NEW.qt_perc_prega_cut_tricip, in NEW.qt_perc_circ_musc_braco,
		  out NEW.pr_circ_braco, out NEW.pr_prega_cut_tricip,
		  out NEW.pr_circ_musc_braco, out NEW.qt_gasto_ener_repouso,
		  out NEW.qt_nec_proteica, out NEW.qt_gasto_ener_repouso_kj,
		  out NEW.qt_nec_calorica, out NEW.qt_nec_calorica_kj, out NEW.qt_circ_musc_braco,
		  in out qt_caloria_w, in out NEW.qt_caloria_kj;

NEW.qt_caloria :=  qt_caloria_w;
		
exception
	when others then
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametros_w := substr( ':new.nr_atendimento: '
                                 || NEW.nr_atendimento
                                 || '-'
                                 || ':new.qt_idade: '
                                 || NEW.qt_idade
                                 || '-'
                                 || 'qt_circ_braco: '
                                 || NEW.qt_circ_braco
                                 || '-'
                                 || 'new.qt_idade: '
                                 || NEW.qt_idade
                                 || '-'
                                 || ':new.qt_prega_cut_tricip: '
                                 || NEW.qt_prega_cut_tricip
                                 || '-'
                                 || ':new.qt_peso_atual: '
                                 || NEW.qt_peso_atual
                                 || '-'
                                 || ':new.qt_altura: '
                                 || NEW.qt_altura
                                 || '-'
                                 || 'new.qt_altura_estimada: '
                                 || NEW.qt_altura_estimada
                                 || '-'
                                 || ':new.qt_proteina: '
                                 || NEW.qt_proteina
                                 || '-'
                                 || ':old.qt_caloria: '
                                 || OLD.qt_caloria
                                 || '-'
                                 || ':new.qt_perc_circ_braco: '
                                 || NEW.qt_perc_circ_braco
                                 || '-'
                                 || ':new.qt_perc_prega_cut_tricip: '
                                 || NEW.qt_perc_prega_cut_tricip
                                 || '-'
                                 || ':new.qt_perc_circ_musc_braco: '
                                 || NEW.qt_perc_circ_musc_braco
                                 || '-'
                                 || 'pr_circ_braco: '
                                 || NEW.pr_circ_braco
                                 || '-'
                                 || 'new.pr_prega_cut_tricip: '
                                 || NEW.pr_prega_cut_tricip
                                 || '-'
                                 || ':new.pr_circ_musc_braco: '
                                 || NEW.pr_circ_musc_braco
                                 || '-'
                                 || ':new.qt_gasto_ener_repouso: '
                                 || NEW.qt_gasto_ener_repouso
                                 || '-'
                                 || ':new.qt_nec_proteica: '
                                 || NEW.qt_nec_proteica
                                 || '-'
                                 || 'new.qt_gasto_ener_repouso_kj: '
                                 || NEW.qt_gasto_ener_repouso_kj
                                 || '-'
                                 || ':new.qt_nec_calorica: '
                                 || NEW.qt_nec_calorica
                                 || '-'
                                 || ':new.qt_nec_calorica_kj: '
                                 || NEW.qt_nec_calorica_kj
                                 || '-'
                                 || ':new.qt_circ_musc_braco: '
                                 || NEW.qt_circ_musc_braco
                                 || '-'
                                 || ':new.qt_caloria: '
                                 || NEW.qt_caloria
                                 || '-'
                                 || ':new.qt_caloria_kj: '
                                 || NEW.qt_caloria_kj, 1, 4000);

           CALL gravar_log_medical_device('aval_nutricao_atual',
                                     'calc_percent_aval_nutri_md',
                                     ds_parametros_w,
                                     ds_erro_w,
                                     NEW.nm_usuario,
                                     'N');

		NEW.pr_circ_braco := null;
		NEW.pr_prega_cut_tricip := null;
		NEW.pr_circ_musc_braco := null;
		NEW.qt_gasto_ener_repouso := null;
		NEW.qt_gasto_ener_repouso_kj := null;
		NEW.qt_nec_proteica := null;
		NEW.qt_caloria_kj := null;
		NEW.qt_caloria := null;
		NEW.qt_nec_calorica := null;
		NEW.qt_nec_calorica_kj := null;
		NEW.qt_circ_musc_braco := null;
end;

BEGIN
if (NEW.QT_GASTO_ENER_REPOUSO is not null or NEW.QT_GASTO_ENER_REPOUSO_KJ is not null ) and (NEW.NR_SEQ_FATOR_ATIV is not null) and (NEW.NR_SEQ_FATOR_STRESS is not null) then

	select	coalesce(max(qt_fator),1)
	into STRICT	qt_fator_stress_w
	from	nut_fator_stress
	where	nr_sequencia	= NEW.NR_SEQ_FATOR_STRESS;
	select	coalesce(max(qt_fator),1)
	into STRICT	qt_fator_ativ_w
	from	nut_fator_ativ
	where	nr_sequencia	= NEW.NR_SEQ_FATOR_ATIV;

    BEGIN
        sql_w := 'begin obter_gasto_aval_nutri_md  (:1, :2, :3, :4, :5, :6); end;';
        EXECUTE sql_w using in NEW.qt_gasto_ener_repouso, in NEW.qt_gasto_ener_repouso_kj, in qt_fator_ativ_w,
									  in qt_fator_stress_w,out NEW.qt_gasto_ener_total, out NEW.qt_gasto_ener_total_kj;

    exception
        when others then
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametros_w := substr( ':new.nr_atendimento: '||NEW.nr_atendimento||'-'||'qt_gasto_ener_repouso: '||NEW.qt_gasto_ener_repouso||'-'||'qt_gasto_ener_repouso_kj: '||NEW.qt_gasto_ener_repouso_kj
										||'-'||'qt_fator_ativ_w: '||qt_fator_ativ_w||'-'||'qt_fator_stress_w: '||qt_fator_stress_w||'-'||'new.qt_gasto_ener_total: '||NEW.qt_gasto_ener_total||'-'||':new.qt_gasto_ener_total_kj: '||NEW.qt_gasto_ener_total_kj, 1, 4000);
            CALL gravar_log_medical_device('aval_nutricao_atual', 'OBTER_GASTO_AVAL_NUTRI_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
            NEW.qt_gasto_ener_total := null;
            NEW.qt_gasto_ener_total_kj := null;
         end;

end if;
exception
when others then
	null;
end;
BEGIN
    BEGIN
        sql_w := 'begin obter_gasto_mif_aval_nutri_md  (:1, :2, :3, :4, :5, :6); end;';
        EXECUTE sql_w using in NEW.qt_altura ,in ie_sexo_w, in NEW.qt_peso_atual, in NEW.qt_idade,
									  out NEW.qt_gasto_geb_mifflin, out NEW.qt_gasto_geb_mifflin_kj;
    exception
        when others then
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametros_w := substr(':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.qt_altura: '||NEW.qt_altura||'-'||'ie_sexo_w: '||ie_sexo_w||'-'||
									  'new.qt_peso_atual: '||NEW.qt_peso_atual||'-'||':new.qt_idade: '||NEW.qt_idade||'-'||':new.qt_gasto_geb_mifflin: '||NEW.qt_gasto_geb_mifflin||'-'||
									  ':new.qt_gasto_geb_mifflin_kj: '||NEW.qt_gasto_geb_mifflin_kj, 1, 4000);
            CALL gravar_log_medical_device('aval_nutricao_atual', 'OBTER_GASTO_MIF_AVAL_NUTRI_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
            NEW.qt_gasto_geb_mifflin := null;
            NEW.qt_gasto_geb_mifflin_kj := null;
    end;

    BEGIN
        sql_w := 'call obter_peso_ajustado_md(:1, :2, :3, :4) into :qt_peso_ajustado_w';
        EXECUTE sql_w using in NEW.qt_peso_atual ,in NEW.qt_peso_habit, in NEW.qt_imc,
									  in NEW.qt_peso_habit_i , out qt_peso_ajustado_w;
    exception
        when others then
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametros_w := substr(  ':new.nr_atendimento: '||NEW.nr_atendimento||'-'|| ':new.QT_PESO_ATUAL: '||NEW.QT_PESO_ATUAL||'-'||':new.QT_PESO_HABIT: '||NEW.QT_PESO_HABIT||'-'||
										'new.QT_IMC: '||NEW.QT_IMC||'-'||':new.QT_PESO_HABIT_I: '||NEW.QT_PESO_HABIT_I||'-'||'QT_PESO_AJUSTADO_W: '||QT_PESO_AJUSTADO_W, 1, 4000);
            CALL gravar_log_medical_device('AVAL_NUTRICAO_ATUAL', 'OBTER_PESO_AJUSTADO_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
            qt_peso_ajustado_w := null;
    end;

    NEW.qt_peso_ajustado	:= qt_peso_ajustado_w;

    BEGIN
        sql_w := 'call obter_perc_gordura_md(:1, :2, :3, :4) into :pr_gordura_w';
        EXECUTE sql_w using in NEW.qt_prega_cut_tricip , in NEW.qt_prega_cut_suprailiaca,
									  in NEW.qt_prega_cut_subesc, in NEW.qt_prega_cut_abd , out pr_gordura_w;
    exception
        when others then
            ds_erro_w := substr(sqlerrm,1 , 4000);
            ds_parametros_w := substr(':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.qt_prega_cut_tricip: '||NEW.qt_prega_cut_tricip||'-'||':new.qt_prega_cut_suprailiaca: '||NEW.qt_prega_cut_suprailiaca||'-'||
									  'new.qt_prega_cut_subesc: '||NEW.qt_prega_cut_subesc||'-'||':new.qt_prega_cut_abd: '||NEW.qt_prega_cut_abd||'-'||'pr_gordura_w: '||pr_gordura_w, 1, 4000);
            CALL gravar_log_medical_device('AVAL_NUTRICAO_ATUAL', 'OBTER_PERC_GORDURA_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
            pr_gordura_w := null;
    END;

    NEW.pr_gordura	:= pr_gordura_w;

    BEGIN
        sql_w := 'begin obter_pont_aval_nutri_md(:1, :2, :3, :4, :5, :6, :7, :8, :9); end;';
        EXECUTE sql_w
            using in NEW.ie_respiracao ,in NEW.qt_imc, in NEW.qt_idade, in NEW.qt_peso_atual,
                  in NEW.ie_queimadura, in NEW.ie_trauma, in ie_sexo_w,
                  out NEW.qt_gast_ener_total_ireton, out NEW.qt_gast_ener_total_ireton_kj;
    exception
        when others then
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametros_w := substr(':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.IE_RESPIRACAO: '||NEW.IE_RESPIRACAO||'-'||':new.QT_IMC: '||NEW.QT_IMC||'-'||
								      'new.qt_idade: '||NEW.qt_idade||'-'||':new.qt_peso_atual: '||NEW.qt_peso_atual||'-'||':new.IE_QUEIMADURA: '||NEW.IE_QUEIMADURA||'-'||
									  ':new.IE_TRAUMA: '||NEW.IE_TRAUMA||'-'||'ie_sexo_w: '||ie_sexo_w||'-'||':new.QT_GAST_ENER_TOTAL_IRETON: '||NEW.QT_GAST_ENER_TOTAL_IRETON||'-'||
									  ':new.QT_GAST_ENER_TOTAL_IRETON_KJ: '||NEW.QT_GAST_ENER_TOTAL_IRETON_KJ, 1, 4000);
            CALL gravar_log_medical_device('AVAL_NUTRICAO_ATUAL', 'OBTER_PONT_AVAL_NUTRI_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
            NEW.QT_GAST_ENER_TOTAL_IRETON := NULL;
            NEW.QT_GAST_ENER_TOTAL_IRETON_KJ := NULL;
    END;
exception
when others then
	null;
end;
<<Final>>
qt_reg_w	:= 0;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_aval_nutricao_atual() FROM PUBLIC;

CREATE TRIGGER aval_nutricao_atual
	BEFORE INSERT OR UPDATE ON aval_nutricao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_aval_nutricao_atual();

