-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS man_ordem_servico_upsup ON man_ordem_servico CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_man_ordem_servico_upsup() RETURNS trigger AS $BODY$
declare
ds_log_w	varchar(4000);
nm_user_w	varchar(50);
/*Trigger criada exclusivamente para o setor de Suporte*/

BEGIN

select	username
into STRICT	nm_user_w
from	user_users;

if (lower(nm_user_w)  = 'corp') and (coalesce(OLD.IE_GRAU_SATISFACAO,'xpto') <> 'xpto') and (coalesce(NEW.IE_GRAU_SATISFACAO,'xpto') <> coalesce(OLD.IE_GRAU_SATISFACAO,'xpto')) and (coalesce(OLD.IE_GRAU_SATISFACAO,'xpto') <> 'xpto')	then

		ds_log_w := 'OS: '||NEW.nr_sequencia||obter_desc_expressao(313421)/*' Valor antigo: '*/||': '||OLD.IE_GRAU_SATISFACAO||'-'||substr(obter_valor_dominio(1197, OLD.IE_GRAU_SATISFACAO),1,20)||
					obter_desc_expressao(301455)/*' Valor novo: '*/
||': '||NEW.IE_GRAU_SATISFACAO||'-'||substr(obter_valor_dominio(1197, NEW.IE_GRAU_SATISFACAO),1,20);

		insert into log_mov(dt_atualizacao, nm_usuario, ds_log, cd_log) values (LOCALTIMESTAMP, wheb_usuario_pck.get_nm_usuario, ds_log_w, 280691);

end if;


RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_man_ordem_servico_upsup() FROM PUBLIC;

CREATE TRIGGER man_ordem_servico_upsup
	BEFORE UPDATE ON man_ordem_servico FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_man_ordem_servico_upsup();

