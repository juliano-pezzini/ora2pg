-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pessoa_fisica_privac_insert ON pessoa_fisica_privacidade CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pessoa_fisica_privac_insert() RETURNS trigger AS $BODY$
declare
valor_dominio_9577_w 	valor_dominio.vl_dominio%type;

C01 CURSOR FOR
	SELECT 	coalesce(ie_mala_direta, 'N') ie_mala_direta,
		coalesce(ie_nf_correio, 'N') ie_nf_correio,
		ie_tipo_complemento,
		nr_sequencia
	from   	compl_pessoa_fisica
	where  	cd_pessoa_fisica 	= NEW.cd_pessoa_fisica;

C01row C01%rowtype;

C02 CURSOR FOR
	SELECT	coalesce(ie_perm_sms_email, 'N') ie_perm_sms_email
	from	pessoa_fisica
	where  	cd_pessoa_fisica	= NEW.cd_pessoa_fisica;

C02row C02%rowtype;

C03 is CURSOR
	with tbl_pfcorresp as (
		SELECT	ie_tipo_corresp,
			ie_tipo_doc,
			nr_sequencia
		from 	pessoa_fisica_corresp
		where 	cd_pessoa_fisica 	= NEW.cd_pessoa_fisica
		and 	ie_tipo_corresp 	 ('Email', 'MCel', 'Mala' )
	)
	SELECT 	a.vl_dominio as ie_tipo_corresp,
		b.vl_dominio as ie_tipo_doc,
		(	select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
			from 	tbl_pfcorresp c
			where 	c.ie_tipo_corresp 	= a.vl_dominio
			and 	c.ie_tipo_doc 		in (b.vl_dominio, 'Q')) as ie_aceite		
	from   	valor_dominio a,
		valor_dominio b
	where  	a.cd_dominio 	= 1418
	and    	a.vl_dominio 	in ('Email', 'MCel', 'Mala' )
	and    	b.cd_dominio 	= 1491
	and    	b.vl_dominio 	in ('PM', 'AE');

C03row C03%rowtype;

C04 CURSOR FOR
	SELECT 	CASE WHEN coalesce(ie_tipo_compl_corresp, 0)=0 THEN 'N'  ELSE 'S' END  ie_tipo_compl_corresp,
		coalesce(ie_email_laudo, 'N') ie_email_laudo,
		ie_tipo_compl_corresp ie_tipo_complemento
	from 	medico
	where 	cd_pessoa_fisica = NEW.cd_pessoa_fisica;

C04row C04%rowtype;

C05 CURSOR FOR
	SELECT 	coalesce(ie_correspondencia,'N') ie_correspondencia,
	  	ie_tipo_complemento,
		nr_sequencia
	from	compl_pessoa_fisica
	where 	cd_pessoa_fisica = NEW.cd_pessoa_fisica 
	and exists ( 	SELECT 	cd_pessoa_fisica 
			from	medico 
			where 	cd_pessoa_fisica = NEW.cd_pessoa_fisica );

C05row C05%rowtype;


procedure inserirRegistro( 	ie_tipo_consentimento_p		in	pessoa_fisica_privac_item.ie_tipo_consentimento%type,
				ie_tipo_documento_p		in	pessoa_fisica_privac_item.ie_tipo_documento%type,
				ie_tipo_complemento_pf_p	in	pessoa_fisica_privac_item.ie_tipo_complemento_pf%type,
				ie_aceite_p			in	pessoa_fisica_privac_item.ie_aceite%type,
				nr_sequencia_comp_pf_p		in	pessoa_fisica_privac_item.nr_seq_compl_pf%type ) is
BEGIN
insert into pessoa_fisica_privac_item(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_pf_privacidade,
	ie_tipo_consentimento,
	ie_tipo_documento,
	ie_tipo_complemento_pf,
	ie_aceite,
	nr_seq_compl_pf)
values (nextval('pessoa_fisica_privac_item_seq'),
	LOCALTIMESTAMP,
	NEW.nm_usuario,
	LOCALTIMESTAMP,
	NEW.nm_usuario,
	NEW.nr_sequencia,
	ie_tipo_consentimento_p,
	ie_tipo_documento_p,
	ie_tipo_complemento_pf_p,
	ie_aceite_p,
	nr_sequencia_comp_pf_p);
end;

BEGIN

	<<ler_pessoa_fisica>>
	for C02row in C02
	loop
		CALL inserirRegistro(	'SEA',
					null,
					null,
					C02row.ie_perm_sms_email,
					null );
					
		CALL inserirRegistro(	'SAI',
					null,
					null,
					C02row.ie_perm_sms_email,
					null );
	end loop ler_pessoa_fisica;

	<<ler_complementos>>
	for C01row in C01
	loop
		CALL inserirRegistro(	'CMD',
					null,
					C01row.ie_tipo_complemento,
					C01row.ie_mala_direta,
					C01row.nr_sequencia );

		CALL inserirRegistro(	'CNC',
					null,
					C01row.ie_tipo_complemento,
					C01row.ie_nf_correio,
					C01row.nr_sequencia );
	end loop ler_complementos;


	<<ler_correspondecia>>
	for C03row in C03
	loop       
		valor_dominio_9577_w	:= NULL;

		if (C03row.ie_tipo_corresp = 'Email') and (C03row.ie_tipo_doc = 'AE') then
			valor_dominio_9577_w	:= 'EAE';
		end if;

		if (C03row.ie_tipo_corresp = 'Email') and (C03row.ie_tipo_doc = 'PM') then
			valor_dominio_9577_w	:= 'EPM';
		end if;

		if (C03row.ie_tipo_corresp = 'MCel') and (C03row.ie_tipo_doc = 'AE') then
			valor_dominio_9577_w	:= 'SAE';
		end if;

		if (C03row.ie_tipo_corresp = 'MCel') and (C03row.ie_tipo_doc = 'PM') then
			valor_dominio_9577_w	:= 'SPM';
		end if;

		if (C03row.ie_tipo_corresp = 'Mala') and (C03row.ie_tipo_doc = 'AE') then
			valor_dominio_9577_w	:= 'MAE';
		end if;

		if (C03row.ie_tipo_corresp = 'Mala') and (C03row.ie_tipo_doc = 'PM') then
			valor_dominio_9577_w	:= 'MPM';
		end if;

		CALL inserirRegistro(	valor_dominio_9577_w,
			C03row.ie_tipo_doc,
			null,
			C03row.ie_aceite,
			null );

	end loop ler_correspondecia;

	<<ler_medico>>
	for C04row in C04
	loop
		CALL inserirRegistro(	'MCM',
					null,
					C04row.ie_tipo_complemento,
					C04row.ie_tipo_compl_corresp,
					null );

		CALL inserirRegistro(	'ERM',
					null,
					null,
					C04row.ie_email_laudo,
					null );
	end loop ler_medico;

	<<ler_complemento_medico>>
	for C05row in C05
	loop
		-- Adicionar consentimento para receber correspondencia
		CALL inserirRegistro(	'CCC',
					null,
					C05row.ie_tipo_complemento,
					C05row.ie_correspondencia,
					C05row.nr_sequencia );
	end loop ler_complemento_medico;	
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pessoa_fisica_privac_insert() FROM PUBLIC;

CREATE TRIGGER pessoa_fisica_privac_insert
	AFTER INSERT ON pessoa_fisica_privacidade FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pessoa_fisica_privac_insert();

