-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pessoa_fisica_befupdate_log ON pessoa_fisica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pessoa_fisica_befupdate_log() RETURNS trigger AS $BODY$
DECLARE

ie_alteracao_nome_w	varchar(01);
cd_perfil_ativo_w		integer := obter_perfil_ativo;
cd_funcao_ativa_w		integer := obter_funcao_ativa;
BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
	BEGIN
	if (OLD.nm_pessoa_fisica <> NEW.nm_pessoa_fisica) or (OLD.dt_nascimento <> NEW.dt_nascimento) or (OLD.ie_sexo <> NEW.ie_sexo) or (OLD.ie_estado_civil <> NEW.ie_estado_civil) or (OLD.nr_cpf <> NEW.nr_cpf) or (OLD.nr_identidade <> NEW.nr_identidade) or (OLD.nr_telefone_celular <> NEW.nr_telefone_celular) or (OLD.ie_grau_instrucao <> NEW.ie_grau_instrucao) or (OLD.nr_cep_cidade_nasc <> NEW.nr_cep_cidade_nasc) or (OLD.nr_prontuario <> NEW.nr_prontuario) or (OLD.cd_religiao <> NEW.cd_religiao) or (OLD.nr_pis_pasep <> NEW.nr_pis_pasep) or (OLD.cd_nacionalidade <> NEW.cd_nacionalidade) or (OLD.ie_funcionario <> NEW.ie_funcionario) or (OLD.qt_altura_cm <> NEW.qt_altura_cm) or (OLD.nr_seq_cor_pele <> NEW.nr_seq_cor_pele) then
		BEGIN

		if (coalesce(OLD.nm_pessoa_fisica, NEW.nm_pessoa_fisica) <> NEW.nm_pessoa_fisica) then
			ie_alteracao_nome_w	:= 'S';
		else
			ie_alteracao_nome_w	:= 'N';
		end if;

		insert into pessoa_fisica_alteracao(
			nr_sequencia,
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_tipo_pessoa,
			nm_pessoa_fisica,
			dt_nascimento,
			ie_sexo,
			ie_estado_civil,
			nr_cpf,
			nr_identidade,
			nr_telefone_celular,
			ie_grau_instrucao,
			nr_cep_cidade_nasc,
			nr_prontuario,
			cd_religiao,
			nr_pis_pasep,
			cd_nacionalidade,
			ie_dependencia_sus,
			qt_altura_cm,
			ie_tipo_sangue,
			ie_fator_rh,
			dt_obito,
			nr_iss,
			nr_inss,
			nr_cert_nasc,
			nr_cert_casamento,
			cd_cargo,
			ds_codigo_prof,
			cd_empresa,
			ie_funcionario,
			nr_seq_cor_pele,
			ds_orgao_emissor_ci,
			nr_cartao_nac_sus,
			cd_cbo_sus,
			cd_atividade_sus,
			ie_vinculo_sus,
			cd_estabelecimento,
			cd_sistema_ant,
			ie_frequenta_escola,
			cd_funcionario,
			nr_pager_bip,
			nr_transacao_sus,
			cd_medico,
			cd_perfil_ativo,
			ie_tipo_prontuario,
			nm_pessoa_pesquisa,
			dt_emissao_ci,
			nr_seq_conselho,
			dt_admissao_hosp,
			ie_fluencia_portugues,
			nr_titulo_eleitor,
			nr_zona,
			nr_secao,
			dt_emissao_ctps,
			nr_cartao_estrangeiro,
			nr_reg_geral_estrang,
			dt_chegada_brasil,
			nm_usuario_original,
			ds_historico,
			sg_emissora_ci,
			dt_naturalizacao_pf,
			nr_ctps,
			ie_status_exportar,
			nr_serie_ctps,
			uf_emissora_ctps,
			nr_portaria_nat,
			nr_seq_perfil,
			nr_seq_cartorio_nasc,
			nr_seq_cartorio_casamento,
			dt_emissao_cert_nasc,
			dt_emissao_cert_casamento,
			nr_livro_cert_nasc,
			nr_livro_cert_casamento,
			dt_cadastro_original,
			nr_folha_cert_nasc,
			nr_folha_cert_casamento,
			nr_same,
			ds_observacao,
			qt_dependente,
			nm_pessoa_fisica_sem_acento,
			dt_geracao_pront,
			nr_transplante,
			nr_registro_pls,
			dt_validade_rg,
			dt_revisao,
			nm_usuario_revisao,
			dt_demissao_hosp,
			nr_contra_ref_sus,
			cd_puericultura,
			ds_senha,
			ds_fonetica,
			ds_fonetica_cns,
			ie_revisar,
			cd_cnes,
			ds_apelido,
			nr_seq_cbo_saude,
			ie_endereco_correspondencia,
			ie_nf_correio,
			dt_integracao_externa,
			cd_municipio_ibge,
			nr_seq_pais,
			nr_seq_nut_perfil,
			qt_peso_nasc,
			uf_conselho,
			nr_pront_dv,
			nm_abreviado,
			nr_ddd_celular,
			nr_ddi_celular,
			nr_ccm,
			dt_fim_experiencia,
			dt_validade_conselho,
			ds_profissao,
			ds_empresa_pf,
			nr_passaporte,
			cd_tipo_pj,
			nr_cnh,
			nr_cert_militar,
			nr_pront_ext,
			dt_inicio_ocup_atual,
			ie_escolaridade_cns,
			ie_situacao_conj_cns,
			nr_folha_cert_div,
			nr_cert_divorcio,
			nr_seq_cartorio_divorcio,
			dt_emissao_cert_divorcio,
			nr_livro_cert_divorcio,
			dt_alta_institucional,
			dt_transplante,
			cd_familia,
			nr_matricula_nasc,
			nm_pessoa_atual,
			ie_alteracao_nome,
			dt_nascimento_atual,
			cd_perfil_alteracao,
			cd_funcao_ativa)
		values (	nextval('pessoa_fisica_alteracao_seq'),
			NEW.cd_pessoa_fisica,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			OLD.ie_tipo_pessoa,
			OLD.nm_pessoa_fisica,
			OLD.dt_nascimento,
			OLD.ie_sexo,
			OLD.ie_estado_civil,
			OLD.nr_cpf,
			OLD.nr_identidade,
			OLD.nr_telefone_celular,
			OLD.ie_grau_instrucao,
			OLD.nr_cep_cidade_nasc,
			OLD.nr_prontuario,
			OLD.cd_religiao,
			OLD.nr_pis_pasep,
			OLD.cd_nacionalidade,
			OLD.ie_dependencia_sus,
			OLD.qt_altura_cm,
			OLD.ie_tipo_sangue,
			OLD.ie_fator_rh,
			OLD.dt_obito,
			OLD.nr_iss,
			OLD.nr_inss,
			OLD.nr_cert_nasc,
			OLD.nr_cert_casamento,
			OLD.cd_cargo,
			OLD.ds_codigo_prof,
			OLD.cd_empresa,
			OLD.ie_funcionario,
			OLD.nr_seq_cor_pele,
			OLD.ds_orgao_emissor_ci,
			OLD.nr_cartao_nac_sus,
			OLD.cd_cbo_sus,
			OLD.cd_atividade_sus,
			OLD.ie_vinculo_sus,
			OLD.cd_estabelecimento,
			OLD.cd_sistema_ant,
			OLD.ie_frequenta_escola,
			OLD.cd_funcionario,
			OLD.nr_pager_bip,
			OLD.nr_transacao_sus,
			OLD.cd_medico,
			OLD.cd_perfil_ativo,
			OLD.ie_tipo_prontuario,
			OLD.nm_pessoa_pesquisa,
			OLD.dt_emissao_ci,
			OLD.nr_seq_conselho,
			OLD.dt_admissao_hosp,
			OLD.ie_fluencia_portugues,
			OLD.nr_titulo_eleitor,
			OLD.nr_zona,
			OLD.nr_secao,
			OLD.dt_emissao_ctps,
			OLD.nr_cartao_estrangeiro,
			OLD.nr_reg_geral_estrang,
			OLD.dt_chegada_brasil,
			OLD.nm_usuario_original,
			OLD.ds_historico,
			OLD.sg_emissora_ci,
			OLD.dt_naturalizacao_pf,
			OLD.nr_ctps,
			OLD.ie_status_exportar,
			OLD.nr_serie_ctps,
			OLD.uf_emissora_ctps,
			OLD.nr_portaria_nat,
			OLD.nr_seq_perfil,
			OLD.nr_seq_cartorio_nasc,
			OLD.nr_seq_cartorio_casamento,
			OLD.dt_emissao_cert_nasc,
			OLD.dt_emissao_cert_casamento,
			OLD.nr_livro_cert_nasc,
			OLD.nr_livro_cert_casamento,
			OLD.dt_cadastro_original,
			OLD.nr_folha_cert_nasc,
			OLD.nr_folha_cert_casamento,
			OLD.nr_same,
			OLD.ds_observacao,
			OLD.qt_dependente,
			OLD.nm_pessoa_fisica_sem_acento,
			OLD.dt_geracao_pront,
			OLD.nr_transplante,
			OLD.nr_registro_pls,
			OLD.dt_validade_rg,
			OLD.dt_revisao,
			OLD.nm_usuario_revisao,
			OLD.dt_demissao_hosp,
			OLD.nr_contra_ref_sus,
			OLD.cd_puericultura,
			OLD.ds_senha,
			OLD.ds_fonetica,
			OLD.ds_fonetica_cns,
			OLD.ie_revisar,
			OLD.cd_cnes,
			OLD.ds_apelido,
			OLD.nr_seq_cbo_saude,
			OLD.ie_endereco_correspondencia,
			OLD.ie_nf_correio,
			OLD.dt_integracao_externa,
			OLD.cd_municipio_ibge,
			OLD.nr_seq_pais,
			OLD.nr_seq_nut_perfil,
			OLD.qt_peso_nasc,
			OLD.uf_conselho,
			OLD.nr_pront_dv,
			OLD.nm_abreviado,
			OLD.nr_ddd_celular,
			OLD.nr_ddi_celular,
			OLD.nr_ccm,
			OLD.dt_fim_experiencia,
			OLD.dt_validade_conselho,
			OLD.ds_profissao,
			OLD.ds_empresa_pf,
			OLD.nr_passaporte,
			OLD.cd_tipo_pj,
			OLD.nr_cnh,
			OLD.nr_cert_militar,
			OLD.nr_pront_ext,
			OLD.dt_inicio_ocup_atual,
			OLD.ie_escolaridade_cns,
			OLD.ie_situacao_conj_cns,
			OLD.nr_folha_cert_div,
			OLD.nr_cert_divorcio,
			OLD.nr_seq_cartorio_divorcio,
			OLD.dt_emissao_cert_divorcio,
			OLD.nr_livro_cert_divorcio,
			OLD.dt_alta_institucional,
			OLD.dt_transplante,
			OLD.cd_familia,
			OLD.nr_matricula_nasc,
			NEW.nm_pessoa_fisica,
			ie_alteracao_nome_w,
			NEW.dt_nascimento,
			cd_perfil_ativo_w,
			cd_funcao_ativa_w);
		end;
	end if;
	end;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pessoa_fisica_befupdate_log() FROM PUBLIC;

CREATE TRIGGER pessoa_fisica_befupdate_log
	BEFORE UPDATE ON pessoa_fisica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pessoa_fisica_befupdate_log();

