-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pac_atend_medic_adm_atual ON paciente_atend_medic_adm CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pac_atend_medic_adm_atual() RETURNS trigger AS $BODY$
declare

ie_inserir_item_adm_w	varchar(1);
qt_reg_w	smallint;
cd_estabelecimento_w estabelecimento.cd_estabelecimento%type;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;

cd_estabelecimento_w := coalesce(wheb_usuario_pck.get_cd_estabelecimento,1);

ie_inserir_item_adm_w := Obter_Param_Usuario(3130, 47, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_inserir_item_adm_w);

if (ie_inserir_item_adm_w = 'N') then

	if (NEW.ie_status_adm = 1) then
		update	paciente_atend_medic
		set	ie_administracao	=	'A'
		where	nr_seq_atendimento	=	NEW.nr_seq_atendimento
		and	nr_seq_material		=	NEW.nr_seq_material
		and	ie_administracao 	=	'P';
	end if;

	update	paciente_atend_medic
	set	ie_checado		=	'S'
	where	nr_seq_atendimento	=	NEW.nr_seq_atendimento
	and	nr_seq_material		=	NEW.nr_seq_material
	and	ie_checado		=	'N';
end if;
<<Final>>
qt_reg_w	:= 0;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pac_atend_medic_adm_atual() FROM PUBLIC;

CREATE TRIGGER pac_atend_medic_adm_atual
	BEFORE INSERT OR UPDATE ON paciente_atend_medic_adm FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pac_atend_medic_adm_atual();

