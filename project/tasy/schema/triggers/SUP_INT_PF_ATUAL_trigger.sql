-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS sup_int_pf_atual ON sup_int_pf CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_sup_int_pf_atual() RETURNS trigger AS $BODY$
declare
qt_existe_w			bigint;
cd_pessoa_fisica_w		varchar(10);
cd_pessoa_fisica_ww		varchar(10);
nr_sequencia_w			bigint;
nr_sequencia_ww			bigint;
ie_tipo_complemento_w		smallint;
BEGIN


select	count(*)
into STRICT	qt_existe_w
from	sup_parametro_integracao a,
	sup_int_regra_pf b
where	a.nr_sequencia = b.nr_seq_integracao
and	a.ie_evento = 'PF'
and	a.ie_forma = 'R'
and	a.ie_situacao = 'A'
and	b.ie_situacao = 'A';

if (qt_existe_w > 0) and (NEW.dt_liberacao is not null) and (NEW.dt_confirma_integracao is null) and (NEW.ie_forma_integracao = 'R') then

	ie_tipo_complemento_w := NEW.ie_tipo_complemento;

	if (coalesce(NEW.ie_tipo_complemento,0) = 0) then
		ie_tipo_complemento_w := 1;
	end if;

	select	coalesce(max(cd_pessoa_fisica),0)
	into STRICT	cd_pessoa_fisica_ww
	from	pessoa_fisica
	where	cd_sistema_ant = NEW.cd_pessoa_fisica;

	NEW.dt_leitura	:= LOCALTIMESTAMP;

	if (cd_pessoa_fisica_ww = 0) then

		select	nextval('pessoa_fisica_seq')
		into STRICT	cd_pessoa_fisica_w
		;

		insert into pessoa_fisica(
			cd_pessoa_fisica,
			ie_tipo_pessoa,
			nr_identidade,
			nm_pessoa_fisica,
			nr_telefone_celular,
			ie_grau_instrucao,
			nr_cep_cidade_nasc,
			nr_prontuario,
			dt_atualizacao,
			nm_usuario,
			cd_religiao,
			nr_pis_pasep,
			cd_nacionalidade,
			ie_dependencia_sus,
			qt_altura_cm,
			ie_tipo_sangue,
			ie_fator_rh,
			dt_nascimento,
			dt_obito,
			ie_sexo,
			nr_iss,
			ie_estado_civil,
			nr_inss,
			nr_cpf,
			nr_cert_nasc,
			cd_cargo,
			nr_cert_casamento,
			ds_codigo_prof,
			cd_empresa,
			ie_funcionario,
			nr_seq_cor_pele,
			ds_orgao_emissor_ci,
			nr_cartao_nac_sus,
			cd_cbo_sus,
			cd_atividade_sus,
			ie_vinculo_sus,
			ie_frequenta_escola,
			cd_funcionario,
			nr_pager_bip,
			nr_transacao_sus,
			cd_medico,
			ie_tipo_prontuario,
			dt_emissao_ci,
			nr_seq_conselho,
			dt_admissao_hosp,
			ie_fluencia_portugues,
			nr_titulo_eleitor,
			nr_zona,
			nr_secao,
			nr_cartao_estrangeiro,
			nr_reg_geral_estrang,
			dt_chegada_brasil,
			sg_emissora_ci,
			dt_naturalizacao_pf,
			nr_ctps,
			nr_serie_ctps,
			uf_emissora_ctps,
			dt_emissao_ctps,
			nr_portaria_nat,
			nr_seq_cartorio_nasc,
			nr_seq_cartorio_casamento,
			dt_emissao_cert_nasc,
			dt_emissao_cert_casamento,
			nr_livro_cert_nasc,
			nr_livro_cert_casamento,
			dt_cadastro_original,
			nr_folha_cert_nasc,
			nr_folha_cert_casamento,
			nr_same,
			ds_observacao,
			qt_dependente,
			nr_transplante,
			dt_validade_rg,
			dt_revisao,
			dt_demissao_hosp,
			cd_puericultura,
			cd_cnes,
			ds_apelido,
			ie_endereco_correspondencia,
			qt_peso_nasc,
			uf_conselho,
			nm_abreviado,
			nr_ccm,
			dt_fim_experiencia,
			dt_validade_conselho,
			ds_profissao,
			ds_empresa_pf,
			nr_passaporte,
			nr_cnh,
			nr_cert_militar,
			nr_pront_ext,
			ie_escolaridade_cns,
			ie_situacao_conj_cns,
			nr_folha_cert_div,
			nr_cert_divorcio,
			nr_seq_cartorio_divorcio,
			dt_emissao_cert_divorcio,
			nr_livro_cert_divorcio,
			dt_alta_institucional,
			dt_transplante,
			nr_matricula_nasc,
			ie_doador,
			dt_vencimento_cnh,
			ds_categoria_cnh,
			cd_sistema_ant)
		values (	cd_pessoa_fisica_w,
			'2',
			NEW.nr_identidade,
			NEW.nm_pessoa_fisica,
			NEW.nr_telefone_celular,
			NEW.ie_grau_instrucao,
			NEW.nr_cep_cidade_nasc,
			NEW.nr_prontuario,
			LOCALTIMESTAMP,
			'INTEGR_TASY',
			NEW.cd_religiao,
			NEW.nr_pis_pasep,
			NEW.cd_nacionalidade,
			NEW.ie_dependencia_sus,
			NEW.qt_altura_cm,
			NEW.ie_tipo_sangue,
			NEW.ie_fator_rh,
			NEW.dt_nascimento,
			NEW.dt_obito,
			NEW.ie_sexo,
			NEW.nr_iss,
			NEW.ie_estado_civil,
			NEW.nr_inss,
			NEW.nr_cpf,
			NEW.nr_cert_nasc,
			NEW.cd_cargo,
			NEW.nr_cert_casamento,
			NEW.ds_codigo_prof,
			NEW.cd_empresa,
			NEW.ie_funcionario,
			NEW.nr_seq_cor_pele,
			NEW.ds_orgao_emissor_ci,
			NEW.nr_cartao_nac_sus,
			NEW.cd_cbo_sus,
			NEW.cd_atividade_sus,
			NEW.ie_vinculo_sus,
			NEW.ie_frequenta_escola,
			NEW.cd_funcionario,
			NEW.nr_pager_bip,
			NEW.nr_transacao_sus,
			NEW.cd_medico,
			NEW.ie_tipo_prontuario,
			NEW.dt_emissao_ci,
			NEW.nr_seq_conselho,
			NEW.dt_admissao_hosp,
			NEW.ie_fluencia_portugues,
			NEW.nr_titulo_eleitor,
			NEW.nr_zona,
			NEW.nr_secao,
			NEW.nr_cartao_estrangeiro,
			NEW.nr_reg_geral_estrang,
			NEW.dt_chegada_brasil,
			NEW.sg_emissora_ci,
			NEW.dt_naturalizacao_pf,
			NEW.nr_ctps,
			NEW.nr_serie_ctps,
			NEW.uf_emissora_ctps,
			NEW.dt_emissao_ctps,
			NEW.nr_portaria_nat,
			NEW.nr_seq_cartorio_nasc,
			NEW.nr_seq_cartorio_casamento,
			NEW.dt_emissao_cert_nasc,
			NEW.dt_emissao_cert_casamento,
			NEW.nr_livro_cert_nasc,
			NEW.nr_livro_cert_casamento,
			NEW.dt_cadastro_original,
			NEW.nr_folha_cert_nasc,
			NEW.nr_folha_cert_casamento,
			NEW.nr_same,
			NEW.ds_observacao,
			NEW.qt_dependente,
			NEW.nr_transplante,
			NEW.dt_validade_rg,
			NEW.dt_revisao,
			NEW.dt_demissao_hosp,
			NEW.cd_puericultura,
			NEW.cd_cnes,
			NEW.ds_apelido,
			NEW.ie_endereco_correspondencia,
			NEW.qt_peso_nasc,
			NEW.uf_conselho,
			NEW.nm_abreviado,
			NEW.nr_ccm,
			NEW.dt_fim_experiencia,
			NEW.dt_validade_conselho,
			NEW.ds_profissao,
			NEW.ds_empresa_pf,
			NEW.nr_passaporte,
			NEW.nr_cnh,
			NEW.nr_cert_militar,
			NEW.nr_pront_ext,
			NEW.ie_escolaridade_cns,
			NEW.ie_situacao_conj_cns,
			NEW.nr_folha_cert_div,
			NEW.nr_cert_divorcio,
			NEW.nr_seq_cartorio_divorcio,
			NEW.dt_emissao_cert_divorcio,
			NEW.nr_livro_cert_divorcio,
			NEW.dt_alta_institucional,
			NEW.dt_transplante,
			NEW.nr_matricula_nasc,
			NEW.ie_doador,
			NEW.dt_vencimento_cnh,
			NEW.ds_categoria_cnh,
			NEW.cd_pessoa_fisica);

		select	coalesce(max(nr_sequencia),0) +1
		into STRICT	nr_sequencia_w
		from	compl_pessoa_fisica;

		insert into compl_pessoa_fisica(
			nr_sequencia,
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			nm_contato,
			ds_endereco,
			cd_cep,
			nr_endereco,
			ds_complemento,
			ds_municipio,
			ds_bairro,
			sg_estado,
			nr_telefone,
			nr_ramal,
			ds_fone_adic,
			ds_email,
			cd_profissao,
			cd_empresa_refer,
			ds_setor_trabalho,
			ds_horario_trabalho,
			nr_matricula_trabalho,
			cd_municipio_ibge,
			ds_fax,
			cd_tipo_logradouro,
			nr_ddd_telefone,
			nr_ddi_telefone,
			nr_ddi_fax,
			nr_ddd_fax,
			ds_website,
			nm_contato_pesquisa,
			ie_tipo_complemento)
		values (	nr_sequencia_w,
			cd_pessoa_fisica_w,
			LOCALTIMESTAMP,
			'INTEGR_TASY',
			NEW.nm_contato,
			NEW.ds_endereco,
			NEW.cd_cep,
			NEW.nr_endereco,
			NEW.ds_complemento,
			NEW.ds_municipio,
			NEW.ds_bairro,
			NEW.sg_estado,
			NEW.nr_telefone,
			NEW.nr_ramal,
			NEW.ds_fone_adic,
			NEW.ds_email,
			NEW.cd_profissao,
			NEW.cd_empresa_refer,
			NEW.ds_setor_trabalho,
			NEW.ds_horario_trabalho,
			NEW.nr_matricula_trabalho,
			NEW.cd_municipio_ibge,
			NEW.ds_fax,
			NEW.cd_tipo_logradouro,
			NEW.nr_ddd_telefone,
			NEW.nr_ddi_telefone,
			NEW.nr_ddi_fax,
			NEW.nr_ddd_fax,
			NEW.ds_website,
			NEW.nm_contato_pesquisa,
			ie_tipo_complemento_w);
	else

		update	pessoa_fisica
		set	nr_identidade			= NEW.nr_identidade,
			nm_pessoa_fisica			= NEW.nm_pessoa_fisica,
			nr_telefone_celular			= NEW.nr_telefone_celular,
			ie_grau_instrucao			= NEW.ie_grau_instrucao,
			nr_cep_cidade_nasc		= NEW.nr_cep_cidade_nasc,
			nr_prontuario			= NEW.nr_prontuario,
			dt_atualizacao			= LOCALTIMESTAMP,
			nm_usuario			= 'INTEGR_TASY',
			cd_religiao			= NEW.cd_religiao,
			nr_pis_pasep			= NEW.nr_pis_pasep,
			cd_nacionalidade			= NEW.cd_nacionalidade,
			ie_dependencia_sus		= NEW.ie_dependencia_sus,
			qt_altura_cm			= NEW.qt_altura_cm,
			ie_tipo_sangue			= NEW.ie_tipo_sangue,
			ie_fator_rh			= NEW.ie_fator_rh,
			dt_nascimento			= NEW.dt_nascimento,
			dt_obito				= NEW.dt_obito,
			ie_sexo				= NEW.ie_sexo,
			nr_iss				= NEW.nr_iss,
			ie_estado_civil			= NEW.ie_estado_civil,
			nr_inss				= NEW.nr_inss,
			nr_cpf				= NEW.nr_cpf,
			nr_cert_nasc			= NEW.nr_cert_nasc,
			cd_cargo				= NEW.cd_cargo,
			nr_cert_casamento			= NEW.nr_cert_casamento,
			ds_codigo_prof			= NEW.ds_codigo_prof,
			cd_empresa			= NEW.cd_empresa,
			ie_funcionario			= NEW.ie_funcionario,
			nr_seq_cor_pele			= NEW.nr_seq_cor_pele,
			ds_orgao_emissor_ci		= NEW.ds_orgao_emissor_ci,
			nr_cartao_nac_sus			= NEW.nr_cartao_nac_sus,
			cd_cbo_sus			= NEW.cd_cbo_sus,
			cd_atividade_sus			= NEW.cd_atividade_sus,
			ie_vinculo_sus			= NEW.ie_vinculo_sus,
			ie_frequenta_escola		= NEW.ie_frequenta_escola,
			cd_funcionario			= NEW.cd_funcionario,
			nr_pager_bip			= NEW.nr_pager_bip,
			nr_transacao_sus			= NEW.nr_transacao_sus,
			cd_medico			= NEW.cd_medico,
			ie_tipo_prontuario			= NEW.ie_tipo_prontuario,
			dt_emissao_ci			= NEW.dt_emissao_ci,
			nr_seq_conselho			= NEW.nr_seq_conselho,
			dt_admissao_hosp			= NEW.dt_admissao_hosp,
			ie_fluencia_portugues		= NEW.ie_fluencia_portugues,
			nr_titulo_eleitor			= NEW.nr_titulo_eleitor,
			nr_zona				= NEW.nr_zona,
			nr_secao				= NEW.nr_secao,
			nr_cartao_estrangeiro		= NEW.nr_cartao_estrangeiro,
			nr_reg_geral_estrang		= NEW.nr_reg_geral_estrang,
			dt_chegada_brasil			= NEW.dt_chegada_brasil,
			sg_emissora_ci			= NEW.sg_emissora_ci,
			dt_naturalizacao_pf			= NEW.dt_naturalizacao_pf,
			nr_ctps				= NEW.nr_ctps,
			nr_serie_ctps			= NEW.nr_serie_ctps,
			uf_emissora_ctps			= NEW.uf_emissora_ctps,
			dt_emissao_ctps			= NEW.dt_emissao_ctps,
			nr_portaria_nat			= NEW.nr_portaria_nat,
			nr_seq_cartorio_nasc		= NEW.nr_seq_cartorio_nasc,
			nr_seq_cartorio_casamento		= NEW.nr_seq_cartorio_casamento,
			dt_emissao_cert_nasc		= NEW.dt_emissao_cert_nasc,
			dt_emissao_cert_casamento		= NEW.dt_emissao_cert_casamento,
			nr_livro_cert_nasc			= NEW.nr_livro_cert_nasc,
			nr_livro_cert_casamento		= NEW.nr_livro_cert_casamento,
			dt_cadastro_original			= NEW.dt_cadastro_original,
			nr_folha_cert_nasc			= NEW.nr_folha_cert_nasc,
			nr_folha_cert_casamento		= NEW.nr_folha_cert_casamento,
			nr_same				= NEW.nr_same,
			ds_observacao			= NEW.ds_observacao,
			qt_dependente			= NEW.qt_dependente,
			nr_transplante			= NEW.nr_transplante,
			dt_validade_rg			= NEW.dt_validade_rg,
			dt_revisao			= NEW.dt_revisao,
			dt_demissao_hosp			= NEW.dt_demissao_hosp,
			cd_puericultura			= NEW.cd_puericultura,
			cd_cnes				= NEW.cd_cnes,
			ds_apelido			= NEW.ds_apelido,
			ie_endereco_correspondencia	= NEW.ie_endereco_correspondencia,
			qt_peso_nasc			= NEW.qt_peso_nasc,
			uf_conselho			= NEW.uf_conselho,
			nm_abreviado			= NEW.nm_abreviado,
			nr_ccm				= NEW.nr_ccm,
			dt_fim_experiencia			= NEW.dt_fim_experiencia,
			dt_validade_conselho		= NEW.dt_validade_conselho,
			ds_profissao			= NEW.ds_profissao,
			ds_empresa_pf			= NEW.ds_empresa_pf,
			nr_passaporte			= NEW.nr_passaporte,
			nr_cnh				= NEW.nr_cnh,
			nr_cert_militar			= NEW.nr_cert_militar,
			nr_pront_ext			= NEW.nr_pront_ext,
			ie_escolaridade_cns		= NEW.ie_escolaridade_cns,
			ie_situacao_conj_cns		= NEW.ie_situacao_conj_cns,
			nr_folha_cert_div			= NEW.nr_folha_cert_div,
			nr_cert_divorcio			= NEW.nr_cert_divorcio,
			nr_seq_cartorio_divorcio		= NEW.nr_seq_cartorio_divorcio,
			dt_emissao_cert_divorcio		= NEW.dt_emissao_cert_divorcio,
			nr_livro_cert_divorcio		= NEW.nr_livro_cert_divorcio,
			dt_alta_institucional			= NEW.dt_alta_institucional,
			dt_transplante			= NEW.dt_transplante,
			nr_matricula_nasc			= NEW.nr_matricula_nasc,
			ie_doador				= NEW.ie_doador,
			dt_vencimento_cnh			= NEW.dt_vencimento_cnh,
			ds_categoria_cnh			= NEW.ds_categoria_cnh
		where	cd_pessoa_fisica = cd_pessoa_fisica_ww;

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_ww
		from	compl_pessoa_fisica
		where	ie_tipo_complemento = ie_tipo_complemento_w
		and	cd_pessoa_fisica = cd_pessoa_fisica_ww;

		if (nr_sequencia_ww = 0) then

			select	coalesce(max(nr_sequencia),0) +1
			into STRICT	nr_sequencia_w
			from	compl_pessoa_fisica
			where	cd_pessoa_fisica = cd_pessoa_fisica_ww;

			insert into compl_pessoa_fisica(
				nr_sequencia,
				cd_pessoa_fisica,
				dt_atualizacao,
				nm_usuario,
				nm_contato,
				ds_endereco,
				cd_cep,
				nr_endereco,
				ds_complemento,
				ds_municipio,
				ds_bairro,
				sg_estado,
				nr_telefone,
				nr_ramal,
				ds_fone_adic,
				ds_email,
				cd_profissao,
				cd_empresa_refer,
				ds_setor_trabalho,
				ds_horario_trabalho,
				nr_matricula_trabalho,
				cd_municipio_ibge,
				ds_fax,
				cd_tipo_logradouro,
				nr_ddd_telefone,
				nr_ddi_telefone,
				nr_ddi_fax,
				nr_ddd_fax,
				ds_website,
				nm_contato_pesquisa,
				ie_tipo_complemento)
			values (	nr_sequencia_w,
				cd_pessoa_fisica_ww,
				LOCALTIMESTAMP,
				'INTEGR_TASY',
				NEW.nm_contato,
				NEW.ds_endereco,
				NEW.cd_cep,
				NEW.nr_endereco,
				NEW.ds_complemento,
				NEW.ds_municipio,
				NEW.ds_bairro,
				NEW.sg_estado,
				NEW.nr_telefone,
				NEW.nr_ramal,
				NEW.ds_fone_adic,
				NEW.ds_email,
				NEW.cd_profissao,
				NEW.cd_empresa_refer,
				NEW.ds_setor_trabalho,
				NEW.ds_horario_trabalho,
				NEW.nr_matricula_trabalho,
				NEW.cd_municipio_ibge,
				NEW.ds_fax,
				NEW.cd_tipo_logradouro,
				NEW.nr_ddd_telefone,
				NEW.nr_ddi_telefone,
				NEW.nr_ddi_fax,
				NEW.nr_ddd_fax,
				NEW.ds_website,
				NEW.nm_contato_pesquisa,
				ie_tipo_complemento_w);
		else

			update	compl_pessoa_fisica
			set	dt_atualizacao		= LOCALTIMESTAMP,
				nm_usuario		= 'INTEGR_TASY',
				nm_contato		= NEW.nm_contato,
				ds_endereco		= NEW.ds_endereco,
				cd_cep			= NEW.cd_cep,
				nr_endereco		= NEW.nr_endereco,
				ds_complemento		= NEW.ds_complemento,
				ds_municipio		= NEW.ds_municipio,
				ds_bairro			= NEW.ds_bairro,
				sg_estado		= NEW.sg_estado,
				nr_telefone		= NEW.nr_telefone,
				nr_ramal			= NEW.nr_ramal,
				ds_fone_adic		= NEW.ds_fone_adic,
				ds_email			= NEW.ds_email,
				cd_profissao		= NEW.cd_profissao,
				cd_empresa_refer		= NEW.cd_empresa_refer,
				ds_setor_trabalho		= NEW.ds_setor_trabalho,
				ds_horario_trabalho		= NEW.ds_horario_trabalho,
				nr_matricula_trabalho	= NEW.nr_matricula_trabalho,
				cd_municipio_ibge		= NEW.cd_municipio_ibge,
				ds_fax			= NEW.ds_fax,
				cd_tipo_logradouro		= NEW.cd_tipo_logradouro,
				nr_ddd_telefone		= NEW.nr_ddd_telefone,
				nr_ddi_telefone		= NEW.nr_ddi_telefone,
				nr_ddi_fax		= NEW.nr_ddi_fax,
				nr_ddd_fax		= NEW.nr_ddd_fax,
				ds_website		= NEW.ds_website,
				nm_contato_pesquisa	= NEW.nm_contato_pesquisa
			where	nr_sequencia		= nr_sequencia_ww
			and	cd_pessoa_fisica		= cd_pessoa_fisica_ww;
		end if;
		cd_pessoa_fisica_w := cd_pessoa_fisica_ww;
	end if;
	NEW.dt_confirma_integracao	:= LOCALTIMESTAMP;
	NEW.cd_sistema_ant		:= cd_pessoa_fisica_w;
end if;



RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_sup_int_pf_atual() FROM PUBLIC;

CREATE TRIGGER sup_int_pf_atual
	BEFORE INSERT OR UPDATE ON sup_int_pf FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_sup_int_pf_atual();

