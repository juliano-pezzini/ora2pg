-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS lote_contabil_delete ON lote_contabil CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_lote_contabil_delete() RETURNS trigger AS $BODY$
declare
ds_lote_w               varchar(255);
ds_mensagem_w           varchar(4000);
nr_lote_contabil_w              bigint;
ds_enter_w              varchar(3) := chr(13) || chr(10);

C01 CURSOR FOR
SELECT   substr(WHEB_MENSAGEM_PCK.get_texto(818839, 'NR_LOTE_CONTABIL=' || nr_lote_contabil ||
                                                ';CD_ESTABELECIMENTO=' || cd_estabelecimento || 
                                                ';NM_ESTABELECIMENTO=' || obter_nome_estabelecimento(cd_estabelecimento) || 
                                                ';DT_REFERENCIA=' || to_char(dt_referencia,'dd/mm/yyyy')),1,255) ds_lote
from     lote_contabil
where    nr_lote_origem = nr_lote_contabil_w
order by ds_lote;

pragma autonomous_transaction;

BEGIN

if (coalesce(wheb_usuario_pck.get_ie_executar_trigger, 'S') = 'S') then
        nr_lote_contabil_w      := OLD.nr_lote_contabil;

        open C01;
        loop
        fetch C01 into
                ds_lote_w;
        EXIT WHEN NOT FOUND; /* apply on C01 */
                BEGIN
                ds_mensagem_w := substr(ds_mensagem_w || ds_lote_w || ds_enter_w,1,4000);
                end;
        end loop;
        close C01;

        if (coalesce(ds_mensagem_w,'X') <> 'X') then
                /* 'Este lote nao pode ser excluido pois existem lotes dependentes!' */


                ds_mensagem_w := substr(WHEB_MENSAGEM_PCK.get_texto(818840) || ds_enter_w || ds_enter_w ||
                                        WHEB_MENSAGEM_PCK.get_texto(818842) /*'Lotes dependentes: '*/
 || ds_enter_w ||
                                        ds_mensagem_w,1,4000);
                CALL wheb_mensagem_pck.exibir_mensagem_abort(184609,'DS_ERRO_W='||ds_mensagem_w);
        end if;
end if;
RETURN OLD;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_lote_contabil_delete() FROM PUBLIC;

CREATE TRIGGER lote_contabil_delete
	BEFORE DELETE ON lote_contabil FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_lote_contabil_delete();

