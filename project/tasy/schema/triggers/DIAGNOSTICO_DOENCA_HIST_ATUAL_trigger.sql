-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS diagnostico_doenca_hist_atual ON diagnostico_doenca_hist CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_diagnostico_doenca_hist_atual() RETURNS trigger AS $BODY$
DECLARE
dt_diagnostico_w	timestamp;
nr_atendimento_w	bigint;
qt_reg_w		smallint;
BEGIN
  BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;
if (NEW.ie_status in ('P','S')) then
	BEGIN
	select	max(a.dt_diagnostico),
		max(a.nr_atendimento)
	into STRICT	dt_diagnostico_w,
		nr_atendimento_w
	from	diagnostico_doenca a,
		diagnostico_medico b,
		atendimento_paciente x
	where	a.nr_atendimento	= x.nr_atendimento
	and	x.nr_atendimento	= b.nr_atendimento
	and	x.cd_pessoa_fisica	= NEW.cd_pessoa_fisica
	and	a.cd_doenca		= NEW.cd_doenca
	and	a.nr_atendimento	= b.nr_atendimento
	and	a.dt_diagnostico	= b.dt_diagnostico;
	exception
		when others then
		dt_diagnostico_w	:= to_date('02/01/1800','DD/MM/YYYY');
		nr_atendimento_w	:= 0;
	end;

	if (NEW.ie_status = 'P') then
		update	diagnostico_doenca
		set	ie_classificacao_doenca	= 'P'
		where	nr_atendimento	= nr_atendimento_w
		and	cd_doenca	= NEW.cd_doenca
		and	dt_diagnostico	= dt_diagnostico_w;
	elsif (NEW.ie_status = 'S') then
		update	diagnostico_doenca
		set	ie_classificacao_doenca	= 'S'
		where	nr_atendimento	= nr_atendimento_w
		and	cd_doenca	= NEW.cd_doenca
		and	dt_diagnostico	= dt_diagnostico_w;
	end if;
end if;
<<Final>>
qt_reg_w	:= 0;



  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_diagnostico_doenca_hist_atual() FROM PUBLIC;

CREATE TRIGGER diagnostico_doenca_hist_atual
	BEFORE INSERT OR UPDATE ON diagnostico_doenca_hist FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_diagnostico_doenca_hist_atual();

