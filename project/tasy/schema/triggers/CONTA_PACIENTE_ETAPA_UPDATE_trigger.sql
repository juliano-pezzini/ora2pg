-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS conta_paciente_etapa_update ON conta_paciente_etapa CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_conta_paciente_etapa_update() RETURNS trigger AS $BODY$
DECLARE
 
nr_seq_evento_w		bigint;
nr_atendimento_w	bigint;
cd_pessoa_fisica_w	varchar(10);
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
 
C01 CURSOR FOR 
	SELECT	nr_seq_evento 
	from	regra_envio_sms 
	where	cd_estabelecimento	= cd_estabelecimento_w 
	and	ie_evento_disp = 'FEC' 
	and (coalesce(nr_seq_etapa,NEW.NR_SEQ_ETAPA) = NEW.NR_SEQ_ETAPA) 
	and (coalesce(nr_seq_motivo_dev, coalesce(NEW.nr_seq_motivo_dev,0)) = coalesce(NEW.nr_seq_motivo_dev,0)) 
	and	coalesce(ie_situacao,'A') = 'A' 
	order by 
		coalesce(nr_seq_etapa,0), 
		coalesce(nr_seq_motivo_dev,0);
 
PRAGMA autonomous_transaction;
 
BEGIN 
 
if (OLD.DT_FIM_ETAPA is null) and (NEW.DT_FIM_ETAPA is not null) then 
 
	SELECT	MAX(cd_estabelecimento), 
		max(nr_atendimento) 
	INTO STRICT	cd_estabelecimento_w, 
		nr_atendimento_w 
	FROM	conta_paciente 
	WHERE 	nr_interno_conta	= NEW.nr_interno_conta;
 
	select 	max(cd_pessoa_fisica) 
	into STRICT	cd_pessoa_fisica_w 
	from 	atendimento_paciente 
	where 	nr_atendimento = nr_atendimento_w;
 
	open C01;
		loop 
		fetch C01 into	 
			nr_seq_evento_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			BEGIN		 
			CALL gerar_evento_paciente(nr_seq_evento_w,nr_atendimento_w,cd_pessoa_fisica_w,null,wheb_usuario_pck.get_nm_usuario,null);		
			end;
		end loop;
	close C01;
	 
end if;
	 
COMMIT;
 
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_conta_paciente_etapa_update() FROM PUBLIC;

CREATE TRIGGER conta_paciente_etapa_update
	BEFORE UPDATE ON conta_paciente_etapa FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_conta_paciente_etapa_update();

