-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS nascimento_delete ON nascimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_nascimento_delete() RETURNS trigger AS $BODY$
declare
cd_estabelecimento_w	bigint;
IE_CANC_ATEND_RN_w	varchar(10);
 
BEGIN 
 
cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
 
select	max(IE_CANC_ATEND_RN) 
into STRICT	IE_CANC_ATEND_RN_w 
from	parametro_medico 
where	cd_estabelecimento	= cd_estabelecimento_w;
 
if (IE_CANC_ATEND_RN_w	= 'S') and (OLD.nr_atend_rn	is not null) then 
	CALL cancelar_atend_rn(OLD.nr_atend_rn,OLD.nm_usuario);
end if;
 
 
if (OLD.NR_DNV is not null) and (length(somente_numero(OLD.NR_DNV))	= length(OLD.NR_DNV)) then 
	update	REGRA_NUMERACAO_DEC_ITEM a 
	set	IE_DISPONIVEL = 'S' 
	where	nr_declaracao	= OLD.NR_DNV 
	and	exists (	SELECT	1 
				from	regra_numeracao_declaracao b 
				where	a.NR_SEQ_REGRA_NUM	= b.nr_sequencia 
				and	b.ie_situacao	= 'A' 
				and	b.ie_tipo_numeracao	= 'DNV');
end if;
 
RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_nascimento_delete() FROM PUBLIC;

CREATE TRIGGER nascimento_delete
	BEFORE DELETE ON nascimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_nascimento_delete();

