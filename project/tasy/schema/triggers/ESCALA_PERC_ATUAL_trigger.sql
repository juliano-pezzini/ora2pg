-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_perc_atual ON escala_perc CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_perc_atual() RETURNS trigger AS $BODY$
declare
	EXEC_W      varchar(200);
	qt_valor_w	smallint := 0;
  ds_erro_w   varchar(4000);
  ds_parametro_w  varchar(4000);
BEGIN
  BEGIN
	if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then
    BEGIN
      EXEC_W := 'CALL OBTER_SCORE_ESCALA_PERC_MD(:1,:2,:3,:4,:5,:6,:7,:8) INTO :result';

      EXECUTE EXEC_W USING IN NEW.IE_HEART_RATE,
                                     IN NEW.IE_HEMOPTYSIS,
                                     IN NEW.IE_HORMONE_USE,
                                     IN NEW.IE_AGE,
                                     IN NEW.IE_LEG_SWELLING,
                                     IN NEW.IE_PRIOR_PE,
                                     IN NEW.IE_RECENT_SURGERY,
                                     IN NEW.IE_SATURATION,
                                     OUT qt_valor_w;
    exception
      when others then
        qt_valor_w := null;
        ds_erro_w := substr(sqlerrm, 1, 4000);
        ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
        || ' - :new.IE_HEART_RATE: ' || NEW.IE_HEART_RATE || ' - :new.IE_HEMOPTYSIS: ' || NEW.IE_HEMOPTYSIS || ' - :new.IE_HORMONE_USE: ' || NEW.IE_HORMONE_USE || ' - :new.IE_AGE: ' || NEW.IE_AGE || ' - :new.IE_LEG_SWELLING: ' || NEW.IE_LEG_SWELLING
        || ' - :new.IE_PRIOR_PE: ' || NEW.IE_PRIOR_PE || ' - :new.IE_RECENT_SURGERY: ' || NEW.IE_RECENT_SURGERY || ' - :new.IE_SATURATION: ' || NEW.IE_SATURATION || ' - qt_valor_w: ' || qt_valor_w, 1, 4000);
        CALL gravar_log_medical_device('ESCALA_PERC_ATUAL', 'OBTER_SCORE_ESCALA_PERC_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;

		NEW.QT_PONTUACAO := qt_valor_w;
	end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_perc_atual() FROM PUBLIC;

CREATE TRIGGER escala_perc_atual
	BEFORE INSERT OR UPDATE ON escala_perc FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_perc_atual();

