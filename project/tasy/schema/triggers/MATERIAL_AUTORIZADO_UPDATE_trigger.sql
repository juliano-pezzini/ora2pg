-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_autorizado_update ON material_autorizado CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_autorizado_update() RETURNS trigger AS $BODY$
declare
ds_titulo_w			varchar(255) := WHEB_MENSAGEM_PCK.get_texto(311735); --Log de alteracao no material autorizado
ds_historico_w			varchar(4000):= '';
dt_parametro_w			timestamp	:= ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(LOCALTIMESTAMP);

ds_atributo_w			varchar(255);
ds_valor_ant_w			varchar(2000);
ds_valor_atual_w		varchar(2000);
ds_valor_desc_ant_w		varchar(2000);
ds_valor_desc_atual_w		varchar(2000);

nr_seq_tipo_hist_mat_w		bigint := 0;
BEGIN
  BEGIN

ds_atributo_w	 	:= '';
ds_valor_ant_w		:= '';
ds_valor_atual_w	:= '';

if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then
	BEGIN
	
		BEGIN
		ds_titulo_w	:= 	substr(ds_titulo_w ||' '||OLD.cd_material||' - '||substr(obter_desc_material(OLD.cd_material),1,255),1,255);
					
		if (coalesce(NEW.nr_seq_agrup_rel,0) <> coalesce(OLD.nr_seq_agrup_rel,0)) then
			ds_atributo_w	:= 'NR_SEQ_AGRUP_REL';
			ds_valor_ant_w	:= OLD.nr_seq_agrup_rel;
			ds_valor_atual_w:= NEW.nr_seq_agrup_rel;
			--	ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_AGRUP_REL - Antes: '|| :old.nr_seq_agrup_rel ||' Depois: '|| :new.nr_seq_agrup_rel ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
		end if;
		if (coalesce(NEW.nr_seq_opme,0) <> coalesce(OLD.nr_seq_opme,0)) then
			ds_atributo_w	:= 'NR_SEQ_OPME';
			ds_valor_ant_w	:= OLD.nr_seq_opme;
			ds_valor_atual_w:= NEW.nr_seq_opme;		
			--	ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_OPME - Antes: '|| :old.nr_seq_opme ||' Depois: '|| :new.nr_seq_opme ||chr(13)||chr(10),1,4000);	

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);
		end if;
		if (coalesce(NEW.nr_seq_mat_autor_cirurgia,0) <> coalesce(OLD.nr_seq_mat_autor_cirurgia,0)) then
			ds_atributo_w	:= 'NR_SEQ_MAT_AUTOR_CIRURGIA';
			ds_valor_ant_w	:= OLD.nr_seq_mat_autor_cirurgia;
			ds_valor_atual_w:= NEW.nr_seq_mat_autor_cirurgia;
			--	ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_MAT_AUTOR_CIRURGIA - Antes: '|| :old.nr_seq_mat_autor_cirurgia ||' Depois: '|| :new.nr_seq_mat_autor_cirurgia ||chr(13)||chr(10),1,4000);	

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);	
		end if;
		if (coalesce(NEW.nr_seq_regra_plano,0) <> coalesce(OLD.nr_seq_regra_plano,0)) then
			ds_atributo_w	:= 'NR_SEQ_REGRA_PLANO';
			ds_valor_ant_w	:= OLD.nr_seq_regra_plano;
			ds_valor_atual_w:= NEW.nr_seq_regra_plano;		
			--	ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_REGRA_PLANO - Antes: '|| :old.nr_seq_regra_plano ||' Depois: '|| :new.nr_seq_regra_plano ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);	
		end if;
		if (coalesce(NEW.vl_cotado,0) <> coalesce(OLD.vl_cotado,0)) then
			ds_atributo_w	:= 'VL_COTADO';
			ds_valor_ant_w	:= OLD.vl_cotado;
			ds_valor_atual_w:= NEW.vl_cotado;		
			--	ds_historico_w := substr(ds_historico_w||'Campo: VL_COTADO - Antes: '|| :old.vl_cotado ||' Depois: '|| :new.vl_cotado ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);	
		end if;
		if (coalesce(NEW.nr_orcamento,0) <> coalesce(OLD.nr_orcamento,0)) then
			ds_atributo_w	:= 'NR_ORCAMENTO';
			ds_valor_ant_w	:= OLD.nr_orcamento;
			ds_valor_atual_w:= NEW.nr_orcamento;	
		--		ds_historico_w := substr(ds_historico_w||'Campo: NR_ORCAMENTO - Antes: '|| :old.nr_orcamento ||' Depois: '|| :new.nr_orcamento ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);				
		end if;
		if (coalesce(NEW.nr_seq_marca,0) <> coalesce(OLD.nr_seq_marca,0)) then
			ds_atributo_w	:= 'NR_SEQ_MARCA';
			ds_valor_ant_w	:= OLD.nr_seq_marca;
			ds_valor_atual_w:= NEW.nr_seq_marca;	
			--ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_MARCA - Antes: '|| :old.nr_seq_marca ||' Depois: '|| :new.nr_seq_marca ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);				
		end if;
		if (coalesce(NEW.ie_enviar,0) <> coalesce(OLD.ie_enviar,0)) then
			ds_atributo_w	:= 'IE_ENVIAR';
			ds_valor_ant_w	:= OLD.ie_enviar;
			ds_valor_atual_w:= NEW.ie_enviar;	
			--ds_historico_w := substr(ds_historico_w||'Campo: IE_ENVIAR - Antes: '|| :old.ie_enviar ||' Depois: '|| :new.ie_enviar ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);		
		end if;
		if (coalesce(NEW.pr_adicional,0) <> coalesce(OLD.pr_adicional,0)) then
			ds_atributo_w	:= 'PR_ADICIONAL';
			ds_valor_ant_w	:= OLD.pr_adicional;
			ds_valor_atual_w:= NEW.pr_adicional;	
			--ds_historico_w := substr(ds_historico_w||'Campo: PR_ADICIONAL - Antes: '|| :old.pr_adicional ||' Depois: '|| :new.pr_adicional ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);					
		end if;
		if (coalesce(NEW.ie_valor_conta,0) <> coalesce(OLD.ie_valor_conta,0)) then
			ds_atributo_w	:= 'IE_VALOR_CONTA';
			ds_valor_ant_w	:= OLD.ie_valor_conta;
			ds_valor_atual_w:= NEW.ie_valor_conta;	
			--ds_historico_w := substr(ds_historico_w||'Campo: IE_VALOR_CONTA - Antes: '|| :old.ie_valor_conta ||' Depois: '|| :new.ie_valor_conta ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);	
		end if;
		if (coalesce(NEW.nr_seq_fabricante,0) <> coalesce(OLD.nr_seq_fabricante,0)) then
			ds_atributo_w	:= 'NR_SEQ_FABRICANTE';
			ds_valor_ant_w	:= OLD.nr_seq_fabricante;
			ds_valor_atual_w:= NEW.nr_seq_fabricante;	
			--ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_FABRICANTE - Antes: '|| :old.nr_seq_fabricante ||' Depois: '|| :new.nr_seq_fabricante ||chr(13)||chr(10),1,4000)

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);	
		end if;
		if (coalesce(NEW.ds_mat_convenio,0) <> coalesce(OLD.ds_mat_convenio,0)) then
			ds_atributo_w	:= 'DS_MAT_CONVENIO';
			ds_valor_ant_w	:= OLD.ds_mat_convenio;
			ds_valor_atual_w:= NEW.ds_mat_convenio;	
			--ds_historico_w := substr(ds_historico_w||'Campo: DS_MAT_CONVENIO - Antes: '|| :old.ds_mat_convenio ||' Depois: '|| :new.ds_mat_convenio ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);	
		end if;
		if (coalesce(NEW.vl_unitario,0) <> coalesce(OLD.vl_unitario,0)) then
			ds_atributo_w	:= 'VL_UNITARIO';
			ds_valor_ant_w	:= OLD.vl_unitario;
			ds_valor_atual_w:= NEW.vl_unitario;				
			--ds_historico_w := substr(ds_historico_w||'Campo: VL_UNITARIO - Antes: '|| :old.vl_unitario ||' Depois: '|| :new.vl_unitario ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);				
		end if;
		if (coalesce(NEW.ie_origem_preco,0) <> coalesce(OLD.ie_origem_preco,0)) then
			ds_atributo_w	:= wheb_mensagem_pck.get_texto(802667);
			ds_valor_ant_w	:= coalesce(substr(obter_valor_dominio(7061,OLD.ie_origem_preco),1,120),wheb_mensagem_pck.get_texto(802666));
			ds_valor_atual_w:= coalesce(substr(obter_valor_dominio(7061,NEW.ie_origem_preco),1,120),wheb_mensagem_pck.get_texto(802666));
			--ds_historico_w := substr(ds_historico_w||'Campo: Origem Preco - Antes: '|| nvl(substr(obter_valor_dominio(7061,:old.ie_origem_preco),1,120),wheb_mensagem_pck.get_texto(802666)) ||' Depois: '|| Nvl(substr(obter_valor_dominio(7061,:new.ie_origem_preco),1,120),wheb_mensagem_pck.get_texto(802666)) ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);		
		end if;
		if (coalesce(NEW.cd_cgc_fabricante,0) <> coalesce(OLD.cd_cgc_fabricante,0)) then
			ds_atributo_w	:= 'CD_CGC_FABRICANTE';
			ds_valor_ant_w	:= OLD.cd_cgc_fabricante;
			ds_valor_atual_w:= NEW.cd_cgc_fabricante;	
			--ds_historico_w := substr(ds_historico_w||'Campo: CD_CGC_FABRICANTE - Antes: '|| :old.cd_cgc_fabricante ||' Depois: '|| :new.cd_cgc_fabricante ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);	
		end if;
		if (coalesce(NEW.cd_material_convenio,0) <> coalesce(OLD.cd_material_convenio,0)) then
			ds_atributo_w	:= 'CD_MATERIAL_CONVENIO';
			ds_valor_ant_w	:= OLD.cd_material_convenio;
			ds_valor_atual_w:= NEW.cd_material_convenio;			
			--ds_historico_w := substr(ds_historico_w||'Campo: CD_MATERIAL_CONVENIO - Antes: '|| :old.cd_material_convenio ||' Depois: '|| :new.cd_material_convenio ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);				
		end if;
		if (coalesce(NEW.nr_seq_prescricao,0) <> coalesce(OLD.nr_seq_prescricao,0)) then
			ds_atributo_w	:= 'NR_SEQ_PRESCRICAO';
			ds_valor_ant_w	:= OLD.nr_seq_prescricao;
			ds_valor_atual_w:= NEW.nr_seq_prescricao;		
			--ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_PRESCRICAO - Antes: '|| :old.nr_seq_prescricao ||' Depois: '|| :new.nr_seq_prescricao ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);				
		end if;
		if (coalesce(NEW.nr_prescricao,0) <> coalesce(OLD.nr_prescricao,0)) then
			ds_atributo_w	:= 'NR_PRESCRICAO';
			ds_valor_ant_w	:= OLD.nr_prescricao;
			ds_valor_atual_w:= NEW.nr_prescricao;				
			--ds_historico_w := substr(ds_historico_w||'Campo: NR_PRESCRICAO - Antes: '|| :old.nr_prescricao ||' Depois: '|| :new.nr_prescricao ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);					
		end if;
		if (coalesce(NEW.qt_solicitada,0) <> coalesce(OLD.qt_solicitada,0)) then
			ds_atributo_w	:= 'QT_SOLICITADA';
			ds_valor_ant_w	:= OLD.qt_solicitada;
			ds_valor_atual_w:= NEW.qt_solicitada;			
			--ds_historico_w := substr(ds_historico_w||'Campo: QT_SOLICITADA - Antes: '|| :old.qt_solicitada ||' Depois: '|| :new.qt_solicitada ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);								
		end if;
		if (coalesce(NEW.dt_aprovacao,dt_parametro_w) <> coalesce(OLD.dt_aprovacao,dt_parametro_w)) then
			ds_atributo_w	:= 'DT_APROVACAO';
			ds_valor_ant_w	:= PKG_DATE_FORMATERS_TZ.TO_VARCHAR(OLD.dt_aprovacao,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone);
			ds_valor_atual_w:= PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_aprovacao,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone);
			--ds_historico_w := substr(ds_historico_w||'Campo: DT_APROVACAO - Antes: '|| to_char(:old.dt_aprovacao,'dd/mm/yyyy hh24:mi:ss') ||' Depois: '|| to_char(:new.dt_aprovacao,'dd/mm/yyyy hh24:mi:ss') ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);					
		end if;
		if (coalesce(NEW.nm_usuario_aprov,0) <> coalesce(OLD.nm_usuario_aprov,0)) then
			ds_atributo_w	:= 'NM_USUARIO_APROV';
			ds_valor_ant_w	:= OLD.nm_usuario_aprov;
			ds_valor_atual_w:= NEW.nm_usuario_aprov;			
			--ds_historico_w := substr(ds_historico_w||'Campo: NM_USUARIO_APROV - Antes: '|| :old.nm_usuario_aprov ||' Depois: '|| :new.nm_usuario_aprov ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);				
		end if;
		if (coalesce(NEW.ds_observacao,0) <> coalesce(OLD.ds_observacao,0)) then
			ds_atributo_w	:= 'DS_OBSERVACAO';
			ds_valor_ant_w	:= OLD.ds_observacao;
			ds_valor_atual_w:= NEW.ds_observacao;			
			--ds_historico_w := substr(ds_historico_w||'Campo: DS_OBSERVACAO - Antes: '|| :old.ds_observacao ||' Depois: '|| :new.ds_observacao ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);				
		end if;
		if (coalesce(NEW.qt_autorizada,0) <> coalesce(OLD.qt_autorizada,0)) then
			ds_atributo_w	:= 'QT_AUTORIZADA';
			ds_valor_ant_w	:= OLD.qt_autorizada;
			ds_valor_atual_w:= NEW.qt_autorizada;			
			--ds_historico_w := substr(ds_historico_w||'Campo: QT_AUTORIZADA - Antes: '|| :old.qt_autorizada ||' Depois: '|| :new.qt_autorizada ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);				
		end if;
		if (coalesce(NEW.cd_material,0) <> coalesce(OLD.cd_material,0)) then
			ds_atributo_w	:= 'CD_MATERIAL';
			ds_valor_ant_w	:= OLD.cd_material;
			ds_valor_atual_w:= NEW.cd_material;				
			--ds_historico_w := substr(ds_historico_w||'Campo: CD_MATERIAL - Antes: '|| :old.cd_material ||' Depois: '|| :new.cd_material ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);		
																							
																											
																							
			SELECT	MAX(NR_SEQUENCIA)
			INTO STRICT	nr_seq_tipo_hist_mat_w
			FROM	AUTORIZACAO_TIPO_HIST
			WHERE	coalesce(IE_TIPO,'X') = 'M'
			and	coalesce(ie_situacao,'A') = 'A';
			
			if (nr_seq_tipo_hist_mat_w > 0) then
				ds_valor_desc_ant_w	:= ds_valor_ant_w || ' - ' || substr(obter_desc_material(OLD.cd_material),1,255);
				ds_valor_desc_atual_w	:= ds_valor_atual_w || ' - '|| substr(obter_desc_material(NEW.cd_material),1,255);
			end if;
			
		end if;
		if (coalesce(NEW.nr_seq_autorizacao,0) <> coalesce(OLD.nr_seq_autorizacao,0)) then
			ds_atributo_w	:= 'NR_SEQ_AUTORIZACAO';
			ds_valor_ant_w	:= OLD.nr_seq_autorizacao;
			ds_valor_atual_w:= NEW.nr_seq_autorizacao;			
			--ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_AUTORIZACAO - Antes: '|| :old.nr_seq_autorizacao ||' Depois: '|| :new.nr_seq_autorizacao ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);				
		end if;
		if (coalesce(NEW.nr_atendimento,0) <> coalesce(OLD.nr_atendimento,0)) then
			ds_atributo_w	:= 'NR_ATENDIMENTO';
			ds_valor_ant_w	:= OLD.nr_atendimento;
			ds_valor_atual_w:= NEW.nr_atendimento;			
			--_historico_w := substr(ds_historico_w||'Campo: NR_ATENDIMENTO - Antes: '|| :old.nr_atendimento ||' Depois: '|| :new.nr_atendimento ||chr(13)||chr(10),1,4000);--

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);							
		end if;
		if (coalesce(NEW.ie_reducao_acrescimo,0) <> coalesce(OLD.ie_reducao_acrescimo,0)) then
			ds_atributo_w	:= 'IE_REDUCAO_ACRESCIMO';
			ds_valor_ant_w	:= OLD.ie_reducao_acrescimo;
			ds_valor_atual_w:= NEW.ie_reducao_acrescimo;				
			--ds_historico_w := substr(ds_historico_w||'Campo: IE_REDUCAO_ACRESCIMO - Antes: '|| :old.ie_reducao_acrescimo ||' Depois: '|| :new.ie_reducao_acrescimo ||chr(13)||chr(10),1,4000);

			ds_historico_w	:= substr(ds_historico_w|| wheb_mensagem_pck.get_texto(311530,  'DS_ATRIBUTO=' || ds_atributo_w || ';' ||
																							'DS_VALOR_ANT=' || ds_valor_ant_w || ';' ||
																							'DS_VALOR_ATUAL=' || ds_valor_atual_w) ||chr(13)||chr(10),1,4000);				
		end if;
		exception
		when others then
			ds_historico_w := 'X';
		end;
		
		BEGIN
		
		if (coalesce(NEW.cd_cgc_fabricante,0) <> coalesce(OLD.cd_cgc_fabricante,0)) then
			update	agenda_pac_consignado
			set	cd_cgc 		= NEW.cd_cgc_fabricante,
				ds_fornecedor	= substr(obter_nome_pf_pj(null,NEW.cd_cgc_fabricante),1,255)
			where	nr_seq_mat_autor= NEW.nr_sequencia;	
		end if;
		
		exception
		when others then
			ds_historico_w := 'X';
		end;

		if (coalesce(ds_historico_w,'X') <> 'X') then
			CALL gravar_autor_conv_log_alter(NEW.nr_sequencia_autor,ds_titulo_w,substr(ds_historico_w,1,2000),NEW.nm_usuario);
			
			
			if (coalesce(nr_seq_tipo_hist_mat_w,0) > 0) then
				
				insert into autorizacao_convenio_hist(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_atendimento,
					nr_seq_autorizacao,
					ds_historico,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_sequencia_autor,
					nr_seq_tipo_hist,
					dt_liberacao,
					nm_usuario_lib)
				SELECT	nextval('autorizacao_convenio_hist_seq'),
					LOCALTIMESTAMP,
					NEW.nm_usuario,
					NEW.nr_atendimento,
					NEW.nr_seq_autorizacao,
					WHEB_MENSAGEM_PCK.get_texto(312535) || ' ' || ds_valor_desc_ant_w || chr(13)|| WHEB_MENSAGEM_PCK.get_texto(182372) || ' ' ||ds_valor_desc_atual_w,
					LOCALTIMESTAMP,
					NEW.nm_usuario,
					NEW.nr_sequencia_autor,
					nr_seq_tipo_hist_mat_w,
					LOCALTIMESTAMP,
					NEW.nm_usuario
				;
				
				
			end if;
				
			
			
			
		end if;
	end;
end if;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_autorizado_update() FROM PUBLIC;

CREATE TRIGGER material_autorizado_update
	AFTER UPDATE ON material_autorizado FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_autorizado_update();

