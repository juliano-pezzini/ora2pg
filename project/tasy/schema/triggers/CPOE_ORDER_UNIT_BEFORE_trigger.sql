-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cpoe_order_unit_before ON cpoe_order_unit CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cpoe_order_unit_before() RETURNS trigger AS $BODY$
DECLARE
   nr_order_unit_w CPOE_ORDER_UNIT.NR_ORDER_UNIT%TYPE;
   nr_order_serial_w    CPOE_ORDER_UNIT.NR_ORDER_PATIENT_SEQ%TYPE;
   cd_establishment_w   usuario.cd_estabelecimento%type;
BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then	

  if (coalesce(OLD.si_type_of_prescription,'X') <> coalesce(NEW.si_type_of_prescription,'X')) or (coalesce(OLD.nr_seq_cpoe_tipo_pedido,0) <> coalesce(NEW.nr_seq_cpoe_tipo_pedido,0) or (coalesce(OLD.dt_start, LOCALTIMESTAMP) <> coalesce(NEW.dt_start, LOCALTIMESTAMP))) then

      nr_order_unit_w := CPOE_SET_ORDER_UNIT_NUMBER( NEW.nr_seq_cpoe_tipo_pedido, NEW.si_type_of_prescription, NEW.nr_atendimento, NEW.dt_start, nr_order_unit_w);

      NEW.nr_order_unit    := nr_order_unit_w;
	
	  
	  cd_establishment_w := wheb_usuario_pck.get_cd_estabelecimento;

      nr_order_serial_w := generate_int_serial_number(NEW.cd_pessoa_fisica, 'ACC_ORDER_SEQ', cd_establishment_w, NEW.nm_usuario, nr_order_serial_w, 949);

      NEW.nr_order_patient_seq := nr_order_serial_w;
	
  end if;

end if;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cpoe_order_unit_before() FROM PUBLIC;

CREATE TRIGGER cpoe_order_unit_before
	BEFORE INSERT OR UPDATE ON cpoe_order_unit FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cpoe_order_unit_before();

