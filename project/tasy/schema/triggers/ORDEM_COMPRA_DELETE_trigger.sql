-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS ordem_compra_delete ON ordem_compra CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_ordem_compra_delete() RETURNS trigger AS $BODY$
DECLARE

nr_seq_interno_w	bigint;
ie_seq_interna_w	varchar(1);
qt_existe_w		bigint;

BEGIN

select	coalesce(max(ie_seq_interna),'N')
into STRICT	ie_seq_interna_w
from	parametro_compras
where	cd_estabelecimento	= OLD.cd_estabelecimento;

if (OLD.nr_seq_interno is not null) and (ie_seq_interna_w = 'S') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266265);
	--'A ordem de compra item sequencia interna. NÃ£o pode ser excluida');
end if;

if (OLD.nr_seq_reg_lic_compra is not null) then

	update	reg_lic_compra_item
	set	nr_ordem_compra = ''
	where	nr_ordem_compra = OLD.nr_ordem_compra;

	select	count(*)
	into STRICT	qt_existe_w
	from	reg_lic_compra_item
	where	nr_seq_reg_lic_compra = OLD.nr_seq_reg_lic_compra
	and	nr_ordem_compra is not null;

	if (qt_existe_w = 0) then
		update	reg_lic_compra
		set	dt_geracao_ordem_compra	= '',
			nm_usuario_geracao_oc	= ''
		where	nr_sequencia = OLD.nr_seq_reg_lic_compra;
	end if;
end if;

update	material_autor_cirurgia
set	nr_ordem_compra	 = NULL
where	nr_ordem_compra = OLD.nr_ordem_compra;

RETURN OLD;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_ordem_compra_delete() FROM PUBLIC;

CREATE TRIGGER ordem_compra_delete
	BEFORE DELETE ON ordem_compra FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_ordem_compra_delete();

