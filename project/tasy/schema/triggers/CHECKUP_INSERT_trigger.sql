-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS checkup_insert ON checkup CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_checkup_insert() RETURNS trigger AS $BODY$
DECLARE

qt_idade_w		smallint;
ie_sexo_w		varchar(1);
nr_seq_avaliacao_w	bigint;
nr_sequencia_w		bigint;


c01 CURSOR FOR
	SELECT	nr_seq_avaliacao
	from	checkup_avaliacao
	where	cd_estabelecimento = NEW.cd_estabelecimento
	and	qt_idade_w between coalesce(qt_idade_min,qt_idade_w) and coalesce(qt_idade_max,qt_idade_w)
	and	ie_sexo_w = coalesce(ie_sexo, ie_sexo_w);

BEGIN

select	coalesce(obter_idade_pf(NEW.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'),0),
	obter_sexo_pf(NEW.cd_pessoa_fisica, 'C')
into STRICT	qt_idade_w,
	ie_sexo_w
;


open c01;
loop
fetch c01 into
	nr_seq_avaliacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	select	nextval('med_avaliacao_paciente_seq')
	into STRICT	nr_sequencia_w
	;

	insert into med_avaliacao_paciente(
			nr_sequencia,
			cd_pessoa_fisica,
			cd_medico,
			dt_avaliacao,
			dt_atualizacao,
			nm_usuario,
			ds_observacao,
			nr_seq_tipo_avaliacao,
			ie_avaliacao_parcial,
			nr_atendimento,
			nr_prescricao,
			nr_seq_aval_compl,
			dt_liberacao,
			nr_seq_checkup)
	values (nr_sequencia_w,
			NEW.cd_pessoa_fisica,
			NEW.cd_pessoa_fisica,
			LOCALTIMESTAMP,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			null,
			nr_seq_avaliacao_w,
			'N',
			NEW.nr_atendimento,
			NEW.nr_prescricao,
			null,
			null,
			NEW.nr_sequencia);
end loop;
close c01;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_checkup_insert() FROM PUBLIC;

CREATE TRIGGER checkup_insert
	AFTER INSERT ON checkup FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_checkup_insert();

