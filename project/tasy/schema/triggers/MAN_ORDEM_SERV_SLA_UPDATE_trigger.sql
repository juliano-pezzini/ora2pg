-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS man_ordem_serv_sla_update ON man_ordem_serv_sla CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_man_ordem_serv_sla_update() RETURNS trigger AS $BODY$
declare

qt_min_w			bigint;
dt_inicio_w			timestamp;
dt_estagio_w			timestamp;
nr_seq_estagio_os_w		bigint;
nr_grupo_planej_w		bigint;
nr_seq_grupo_sup_w		bigint;
qt_existe_w			bigint;
nm_usuario_exec_w		varchar(15);
ie_classificacao_w		varchar(15);
--

owner_name_w			varchar(100);
caller_name_w			varchar(100);
line_number_w			bigint;
caller_type_w			varchar(100);

/*
415 - Nao iniciada
413 - Acao imediata
412 - Concluida
411 - Iniciada
*/


BEGIN

if (substr(dbms_utility.format_call_stack,1,2000) like '%MAN_ANALISAR_SLA%') then
	goto Final;
end if;

if (coalesce(wheb_usuario_pck.get_ie_executar_trigger,'S') = 'N')  then
	goto Final;
end if;

if (coalesce(phi_is_base_philips(),'N') = 'S')  then
	goto Final;
end if;

NEW.nr_seq_status	:= coalesce(NEW.nr_seq_status, 415);

if (substr(dbms_utility.format_call_stack,1,2000) like '%MAN_ORDEM_SERVICO_AFTER%') then
	/*Verifica se foi encerrada e ainda nao esta com status concluida*/


	if (NEW.dt_termino is not null) and (OLD.dt_termino is not null) and (NEW.nr_seq_status <> 412) then
		NEW.nr_seq_status	:= 412;
		
		/*select	Man_Obter_Min_SLA_OS(:new.nr_seq_ordem, :new.ie_tempo)
		into	:new.qt_min_real_os
		from	dual;
		
		if	(:new.dt_inicio > :new.dt_inicio_prev) or
			(:new.qt_min_real_OS > :new.qt_min_termino) then
			:new.qt_desvio	:= 1;
		else
			:new.qt_desvio	:= 0;
		end if;*/

	/*Se esta "nao iniciada" e iniciou*/


	elsif (NEW.nr_seq_status = 415) and (OLD.dt_inicio is null) and (NEW.dt_inicio is not null) then
		NEW.nr_seq_status		:= 411;
	end if;
else
	/*Verifica se foi encerrada e ainda nao esta com status concluida*/


	if (NEW.dt_termino is not null) and (OLD.dt_termino is not null) and (NEW.nr_seq_status <> 412) then
		NEW.nr_seq_status	:= 412;
		
		select	Man_Obter_Min_SLA_OS(NEW.nr_seq_ordem, NEW.ie_tempo)
		into STRICT	NEW.qt_min_real_os
		;
		
		if (NEW.dt_inicio > NEW.dt_inicio_prev) or (NEW.qt_min_real_OS > NEW.qt_min_termino) then
			NEW.qt_desvio	:= 1;
		else
			NEW.qt_desvio	:= 0;
		end if;	
	/*Se esta "nao iniciada" e iniciou*/


	elsif (NEW.nr_seq_status = 415) and (OLD.dt_inicio is null) and (NEW.dt_inicio is not null) then
		NEW.nr_seq_status		:= 411;
	end if;
end if;

/*Se esta iniciada, contar minutos reais da SLA*/


if (NEW.dt_inicio is not null) then
	if (NEW.ie_tempo = 'COR') then
		NEW.qt_min_real_inic	:= (NEW.dt_inicio - NEW.dt_ordem) * 1440;
		
		if (NEW.nr_seq_estagio is not null) then
			NEW.qt_min_real_inic	:= (NEW.dt_inicio - dt_estagio_w) * 1440;
		end if;
	else
		select	Man_Obter_Min_com(NEW.cd_estabelecimento, NEW.dt_ordem, NEW.dt_inicio)
		into STRICT	NEW.qt_min_real_inic
		;
		
		if (NEW.nr_seq_estagio is not null) then
			select	Man_Obter_Min_com(NEW.cd_estabelecimento, NEW.dt_inicio, dt_estagio_w)
			into STRICT	NEW.qt_min_real_inic
			;
		end if;
	end if;
end if;

/*Se esta como "nao iniciada", ve se esta perto do limite para inicio, se estiver, muda para "acao imediata"*/


if (NEW.nr_seq_status = 415) then
	qt_min_w	:= NEW.qt_min_inicio / 3;
	dt_inicio_w	:= NEW.dt_inicio_prev - (qt_min_w / 1440);
	if (LOCALTIMESTAMP > dt_inicio_w) then
		NEW.nr_seq_status	:= 413;
	end if;
end if;

/*Se esta como acao imediata, e foi iniciada, verifica se mantem "acao imediata" ou altera para "iniciada" - OS*/


if (NEW.nr_seq_status = 413) and (NEW.dt_inicio is not null) and (OLD.dt_inicio is null) then
	qt_min_w	:= NEW.qt_min_termino / 3;
	if (NEW.qt_min_real_os > qt_min_w) then
		NEW.nr_seq_status	:= 413;
	else
		NEW.nr_seq_status	:= 411;
	end if;
end if;


if (substr(dbms_utility.format_call_stack,1,2000) like '%MAN_ORDEM_SERVICO_AFTER%') then
	null;
else
	select	Man_Obter_Min_SLA_OS(NEW.nr_seq_ordem, NEW.ie_tempo)
	into STRICT	NEW.qt_min_real_os
	;

	/*if	(:new.nr_seq_estagio is not null) then
		select	Man_Obter_Min_SLA_OS_estagio(:new.nr_seq_ordem, :new.ie_tempo, :new.nr_seq_estagio)
		into	:new.qt_min_real_os
		from	dual;
	end if;*/

end if;

/*Se esta como iniciada, e ja tem data de inicio, calcula os minutos, se estiver perto do limite de termino, altera para "acao imediata"*/


if (NEW.nr_seq_status = 411) and (OLD.dt_inicio is not null) then
	qt_min_w	:= NEW.qt_min_termino / 3;
	if (NEW.qt_min_real_os > qt_min_w) then
		NEW.nr_seq_status	:= 413;
	end if;
end if;

if (coalesce(NEW.qt_min_real_inic,0) > NEW.qt_min_inicio) then
	NEW.qt_desvio_inic		:= 1;
else
	NEW.qt_desvio_inic		:= 0;
end if;

if (coalesce(NEW.qt_min_real_inic,0) > NEW.qt_min_inicio) or (coalesce(NEW.qt_min_real_os,0) > NEW.qt_min_termino) then
	NEW.qt_desvio		:= 1;
else
	NEW.qt_desvio		:= 0;
end if;

<<Final>>
null;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_man_ordem_serv_sla_update() FROM PUBLIC;

CREATE TRIGGER man_ordem_serv_sla_update
	BEFORE UPDATE ON man_ordem_serv_sla FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_man_ordem_serv_sla_update();

