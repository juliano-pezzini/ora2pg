-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS tabela_atributo_linked_atual ON tabela_atributo_linked CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_tabela_atributo_linked_atual() RETURNS trigger AS $BODY$
DECLARE
  nr_seq_template_w EHR_TEMPLATE_CONTEUDO.NR_SEQ_TEMPLATE%TYPE;

  c_template_conteudo CURSOR(nr_sequencia_p  EHR_TEMPLATE_CONTEUDO.NR_SEQUENCIA%TYPE) FOR
    SELECT etc.nr_seq_template
      FROM ehr_template_conteudo etc
     WHERE etc.nr_sequencia = nr_sequencia_p;

BEGIN
  
  if (wheb_usuario_pck.get_ie_executar_trigger = 'S' ) then 

    -- Do not create table columns for FUNCTION attributes

    IF NEW.ie_tipo_atributo = 'FUNCTION' THEN
      RETURN NEW;
    END IF;

    OPEN c_template_conteudo(NEW.nr_seq_elemento);
      FETCH c_template_conteudo INTO nr_seq_template_w;
    CLOSE c_template_conteudo;

    CALL ehr_alterar_tabela_linked(
      nr_seq_template_w
    , NEW.nr_seq_linked
    , 'ALTER'
    , NEW.nm_atributo
    , NEW.ie_componente
    , NEW.ie_tipo_atributo
    );

  end if;

RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_tabela_atributo_linked_atual() FROM PUBLIC;

CREATE TRIGGER tabela_atributo_linked_atual
	AFTER INSERT ON tabela_atributo_linked FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_tabela_atributo_linked_atual();

