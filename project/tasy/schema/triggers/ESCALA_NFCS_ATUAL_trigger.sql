-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_nfcs_atual ON escala_nfcs CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_nfcs_atual() RETURNS trigger AS $BODY$
declare
  qt_ponto_w bigint	:= 0;
  sql_w      varchar(300);
  ds_erro_w   varchar(4000);
  ds_parametro_w  varchar(4000);
BEGIN
  BEGIN
  if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
    BEGIN
      NEW.nr_hora := (to_char(round(NEW.DT_AVALIACAO, 'hh24'), 'hh24'))::numeric;
	end;
  end if;

  /** Inicio Medical Device **/

  if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
	  BEGIN
		sql_w := 'call obter_score_escala_nfcs_md(:1, :2, :3, :4, :5, :6, :7, :8) into :qt_ponto_w';
		EXECUTE sql_w using in NEW.ie_fronte_saliente, in NEW.ie_fenda_palpebral, in NEW.ie_sulco_aprofundado,
									  in NEW.ie_boca_aberta, in NEW.ie_boca_estirada, in NEW.ie_lingua_tensa,
									  in NEW.ie_protusao_lingua, in NEW.ie_tremor_queixo, out qt_ponto_w;
	  exception
		when others then
		qt_ponto_w := null;
        ds_erro_w := sqlerrm;
        ds_parametro_w := ':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
        || ' - :new.ie_fronte_saliente: ' || NEW.ie_fronte_saliente || ' - :new.ie_fenda_palpebral: ' || NEW.ie_fenda_palpebral
        || ' - :new.ie_boca_aberta: ' || NEW.ie_boca_aberta || ' - :new.ie_boca_estirada: ' || NEW.ie_boca_estirada
        || ' - :new.ie_lingua_tensa: ' || NEW.ie_lingua_tensa || ' - :new.ie_protusao_lingua: ' || NEW.ie_protusao_lingua
        || ' - :new.ie_tremor_queixo: ' || NEW.ie_tremor_queixo || ' - qt_ponto_w: ' || qt_ponto_w;
        CALL gravar_log_medical_device('ESCALA_NFCS_ATUAL', 'OBTER_SCORE_ESCALA_NFCS_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	  end;
	  NEW.qt_pontuacao := qt_ponto_w;
  end if;
  /** fim Medical Device **/
  
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_nfcs_atual() FROM PUBLIC;

CREATE TRIGGER escala_nfcs_atual
	BEFORE INSERT OR UPDATE ON escala_nfcs FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_nfcs_atual();

