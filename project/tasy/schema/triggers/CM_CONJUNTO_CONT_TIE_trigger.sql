-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cm_conjunto_cont_tie ON cm_conjunto_cont CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cm_conjunto_cont_tie() RETURNS trigger AS $BODY$
declare

json_w		philips_json;
json_data_w	text;

BEGIN

if (wheb_usuario_pck.get_nm_usuario is not null) then

	if (TG_OP = 'INSERT' or TG_OP = 'UPDATE') then

		json_w := philips_json();
		json_w.put('id', NEW.nr_sequencia);
		json_w.put('kit', NEW.nr_seq_conjunto);
		json_w.put('item', NEW.nr_seq_item);
		json_w.put('kitStatus', NEW.ie_status_conjunto);
		json_w.put('sterilizationDepartment', NEW.cd_setor_atendimento);
		json_w.put('pack', NEW.nr_seq_embalagem);
		json_w.put('sterilisationValue', NEW.vl_esterilizacao);
		json_w.put('points', NEW.qt_ponto);
		json_w.put('establishment', NEW.cd_estabelecimento);
		json_w.put('receiptUser', NEW.nm_usuario_ester);
		json_w.put('originalUser', NEW.nm_usuario_origem);
		json_w.put('exitUser', NEW.nm_usuario_saida);
		json_w.put('scheduleUser', NEW.nm_usuario_agenda);
		json_w.put('linkUser', NEW.nm_usuario_vinc);
		json_w.put('deactivationUser', NEW.nm_usuario_inativacao);
		json_w.put('startCycleUser', NEW.nm_usuario_inicio);
		json_w.put('endCycleUser', NEW.nm_usuario_fim);
		json_w.put('stockLocationTransferUser', NEW.nm_usuario_repasse);
		json_w.put('surgerySettlementUser', NEW.nm_usuario_baixa_cirurgia);
		json_w.put('receiptDate', NEW.dt_receb_ester);
		json_w.put('originDate', NEW.dt_origem);
		json_w.put('expirationDate', NEW.dt_validade);
		json_w.put('exitDate', NEW.dt_saida);
		json_w.put('scheduleDate', NEW.dt_aloc_agenda);
		json_w.put('surgerySettlementDate', NEW.dt_baixa_cirurgia);
		json_w.put('automaticEntryDate', NEW.dt_lancamento_automatico);
		json_w.put('linkDate', NEW.dt_vinculo_conj);
		json_w.put('deactivationDate', NEW.dt_inativacao);
		json_w.put('releaseDate', NEW.dt_liberacao);
		json_w.put('printingDate', NEW.dt_impressao);
		json_w.put('itemCheckDate', NEW.dt_conferencia_itens);
		json_w.put('eventDate', NEW.ds_utc);
		json_w.put('registrationDate', NEW.ds_utc_atualizacao);
		json_w.put('undeterminedExpiration', NEW.ie_indeterminado);
		json_w.put('cycle', NEW.nr_seq_ciclo);
		json_w.put('physicalKit', NEW.nr_seq_conj_fisico);
		json_w.put('schedule', NEW.nr_seq_agenda);
		json_w.put('person', NEW.cd_pessoa_fisica);
		json_w.put('legalEntity', NEW.cd_cgc);
		json_w.put('stockLocation', NEW.cd_local_estoque);
		json_w.put('surgery', NEW.nr_cirurgia);
		json_w.put('originalDepartment', NEW.cd_setor_atend_orig);
		json_w.put('destinationDepartment', NEW.cd_setor_atend_dest);
		json_w.put('clientDepartment', NEW.nr_seq_cliente);
		json_w.put('control', NEW.nr_seq_controle);
		json_w.put('batch', NEW.nr_seq_lote);
		json_w.put('notes', NEW.ds_observacao);
		json_w.put('personResponsible', NEW.cd_pessoa_resp);
		json_w.put('sterilisation', NEW.ie_tipo_esterilizacao);
		json_w.put('encounter', NEW.nr_atendimento);
		json_w.put('perioperativeElectronicPatientChartId', NEW.nr_seq_pepo);
		json_w.put('activeProfile', NEW.cd_perfil_ativo);
		json_w.put('status', NEW.ie_situacao);
		json_w.put('justification', NEW.ds_justificativa);
		json_w.put('originKit', NEW.nr_seq_conj_origem);
		json_w.put('physician', NEW.cd_medico);
		json_w.put('signature', NEW.nr_seq_assinatura);
		json_w.put('deactivationSignature', NEW.nr_seq_assinat_inativacao);
		json_w.put('receiptPersonId', NEW.cd_pessoa_receb);
		json_w.put('receiptPerson', NEW.nm_pessoa_receb);
		json_w.put('institutionControl', NEW.cd_controle_conj);
		json_w.put('kitPosition', NEW.nr_seq_posicao_conj);
		json_w.put('purge', NEW.ie_expurgo);
		json_w.put('sterilizationCycle', NEW.nr_seq_ciclo_lav);
		json_w.put('externalDeliveryItem', NEW.nr_seq_envio_ext_item);
		json_w.put('externalReceipt', NEW.nr_seq_receb_ext);
		json_w.put('perioperativeElectronicPatientChartRule', NEW.nr_seq_regra_pepo);
		json_w.put('equipment', NEW.ds_equipamento);
		json_w.put('daylightSavingTime', NEW.ie_horario_verao);
		json_w.put('cleaningProcess', NEW.ie_processo_limpeza);
		json_w.put('auxiliaryKit ', NEW.nm_conjunto_aux);
		json_w.put('auxiliaryCycle', NEW.nr_ciclo_aux);
		json_w.put('auxiliaryClassification', NEW.ds_classificacao_aux);
		json_w.put('auxiliaryKitStatus', NEW.ds_status_conjunto_aux);
		json_w.put('auxiliaryPackage', NEW.ds_embalagem_aux);
		json_w.put('auxiliaryStockLocation', NEW.ds_local_estoque_aux);
		json_w.put('auxiliaryCorporateName', NEW.ds_razao_social_aux);
		json_w.put('auxiliaryPerson', NEW.nm_pessoa_fisica_aux);
		json_w.put('auxiliaryOriginalDepartment', NEW.ds_setor_atend_orig_aux);
		json_w.put('auxiliaryRequisitionDepartment', NEW.ds_setor_requisicao_aux);
		json_w.put('auxiliaryColor', NEW.ds_cor_conjunto_aux);
		json_w.put('auxiliaryPhysician', NEW.nm_medico_aux);
		json_w.put('auxiliaryPersonResponsible', NEW.nm_pessoa_resp_aux);
		json_w.put('lastUpdate', NEW.dt_atualizacao);
		json_w.put('lastUpdatedBy', NEW.nm_usuario);

		dbms_lob.createtemporary(json_data_w, true);
		json_w.(json_data_w);

		if (TG_OP = 'INSERT') then
			json_data_w := bifrost.send_integration_content('cssd.management.add.send.request', json_data_w, wheb_usuario_pck.get_nm_usuario);
		elsif (TG_OP = 'UPDATE') then
			json_data_w := bifrost.send_integration_content('cssd.management.update.send.request', json_data_w, wheb_usuario_pck.get_nm_usuario);
		end if;

	elsif (TG_OP = 'DELETE') then

		json_w := philips_json();
		json_w.put('id', OLD.nr_sequencia);

		dbms_lob.createtemporary(json_data_w, true);
		json_w.(json_data_w);

		json_data_w := bifrost.send_integration_content('cssd.management.delete.send.request', json_data_w, wheb_usuario_pck.get_nm_usuario);

	end if;

end if;

IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cm_conjunto_cont_tie() FROM PUBLIC;

CREATE TRIGGER cm_conjunto_cont_tie
	AFTER INSERT OR UPDATE OR DELETE ON cm_conjunto_cont FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cm_conjunto_cont_tie();

