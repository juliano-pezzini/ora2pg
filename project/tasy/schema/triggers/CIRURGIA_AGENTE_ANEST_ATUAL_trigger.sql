-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cirurgia_agente_anest_atual ON cirurgia_agente_anest_ocor CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cirurgia_agente_anest_atual() RETURNS trigger AS $BODY$
DECLARE
ie_consiste_w		varchar(2) := 'N';
dt_inicio_real_w	timestamp;
cd_estabelecimento_w	smallint;
nr_seq_pepo_w		bigint;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
ie_tipo_w			varchar(10);
nr_cirurgia_w 		cirurgia_agente_anestesico.nr_cirurgia%type;
ie_tipo_cir_ag_w	cirurgia_agente_anestesico.ie_tipo%type;
ie_libera_medic_pepo_w		varchar(1);
ie_libera_material_pepo_w	varchar(1);
ie_libera_agente_pepo_w		varchar(1);
ie_libera_hemoder_pepo_w	varchar(1);
ie_libera_terapia_pepo_w	varchar(1);
cd_setor_atendimento_w		cirurgia.cd_setor_atendimento%type;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then
    goto final;
end if;

select	coalesce(max(b.nr_seq_pepo),0)
into STRICT	nr_seq_pepo_w
from 	cirurgia_agente_anestesico b	
where	b.nr_sequencia = NEW.nr_seq_cirur_agente
and	coalesce(b.ie_situacao,'A') = 'A';

if (nr_seq_pepo_w > 0) then
	select	min(a.dt_inicio_real),
		min(a.cd_estabelecimento)
	into STRICT	dt_inicio_real_w,
		cd_estabelecimento_w
	from 	cirurgia a,
		cirurgia_agente_anestesico b			
	where	a.nr_seq_pepo = b.nr_seq_pepo
	and	coalesce(b.ie_situacao,'A') = 'A'
	and	b.nr_sequencia = NEW.nr_seq_cirur_agente;
else
	select	max(a.dt_inicio_real),
		max(a.cd_estabelecimento)
	into STRICT	dt_inicio_real_w,
		cd_estabelecimento_w
	from 	cirurgia a,
		cirurgia_agente_anestesico b			
	where	a.nr_cirurgia = b.nr_cirurgia
	and	coalesce(b.ie_situacao,'A') = 'A'
	and	b.nr_sequencia = NEW.nr_seq_cirur_agente;
end if;

if (cd_estabelecimento_w is null) then
	select cd_estabelecimento
	into STRICT cd_estabelecimento_w
	from pepo_cirurgia
	where nr_sequencia = nr_seq_pepo_w;
end if;

if 	(NEW.dt_inicio_adm is not null AND NEW.dt_final_adm is not null) and (NEW.dt_final_adm < NEW.dt_inicio_adm) and (NEW.dt_inativacao is null)	then
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(202905, 'DT_INICIO_ADM_P='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_inicio_adm, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||';DT_FINAL_ADM_P='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_final_adm, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone));
end if;

ie_consiste_w := Obter_Param_Usuario(872, 93, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_consiste_w);

if (ie_consiste_w = 'S') and
	((dt_inicio_real_w is null) or (NEW.dt_inicio_adm < dt_inicio_real_w)) and (NEW.dt_inativacao is null)	then
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(202909);
end if;

select	max(ie_libera_medic_pepo),
	max(ie_libera_material_pepo),
	max(ie_libera_agente_pepo),
	max(ie_libera_hemoder_pepo),
	max(ie_libera_terapia_pepo)
into STRICT	ie_libera_medic_pepo_w,
	ie_libera_material_pepo_w,
	ie_libera_agente_pepo_w,
	ie_libera_hemoder_pepo_w,
	ie_libera_terapia_pepo_w
from	parametro_medico
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

select	ie_tipo
into STRICT	ie_tipo_cir_ag_w
from cirurgia_agente_anestesico
where nr_sequencia = NEW.NR_SEQ_CIRUR_AGENTE;

if (ie_tipo_cir_ag_w = 1) and (coalesce(ie_libera_agente_pepo_w,'N') = 'S') then --Agentes anestesicos	
	if (NEW.dt_liberacao is null) then
		ie_tipo_w := 'ADAA';
	elsif (OLD.dt_liberacao is null) and (NEW.dt_liberacao is not null) then
		ie_tipo_w := 'XADAA';
	end if;
elsif (ie_tipo_cir_ag_w = 2) and (coalesce(ie_libera_terapia_pepo_w,'N') = 'S') then --Terapia hidroeletrolitica		
	if (NEW.dt_liberacao is null) then
		ie_tipo_w := 'ADTH';
	elsif (OLD.dt_liberacao is null) and (NEW.dt_liberacao is not null) then
		ie_tipo_w := 'XADTH';
	end if;
elsif (ie_tipo_cir_ag_w = 3) and (coalesce(ie_libera_medic_pepo_w,'N') = 'S') then --Medicamentos
	if (NEW.dt_liberacao is null) then
		ie_tipo_w := 'ADMD';
	elsif (OLD.dt_liberacao is null) and (NEW.dt_liberacao is not null) then
		ie_tipo_w := 'XADMD';
	end if;
elsif (ie_tipo_cir_ag_w = 5) and (coalesce(ie_libera_hemoder_pepo_w,'N') = 'S') then --Hemocomponente
	if (NEW.dt_liberacao is null) then
		ie_tipo_w := 'ADHE';
	elsif (OLD.dt_liberacao is null) and (NEW.dt_liberacao is not null) then
		ie_tipo_w := 'XADHE';
	end if;

end if;	

if (ie_tipo_w	is not null) then
select	max(nr_cirurgia),
		max(nr_seq_pepo)
into STRICT	nr_cirurgia_w,
		nr_seq_pepo_w
from cirurgia_agente_anestesico
where nr_sequencia = NEW.NR_SEQ_CIRUR_AGENTE;		

select	max(c.nr_atendimento),
		max(c.cd_pessoa_fisica),
		max(c.cd_setor_atendimento)
	into STRICT	nr_atendimento_w,
		cd_pessoa_fisica_w,
		cd_setor_atendimento_w
	from	cirurgia c
	where	c.nr_cirurgia = nr_cirurgia_w;

	if (cd_pessoa_fisica_w is null) then
		select	max(c.nr_atendimento),
			max(c.cd_pessoa_fisica)
		into STRICT	nr_atendimento_w,
			cd_pessoa_fisica_w
		from	pepo_cirurgia c
		where	c.nr_sequencia = nr_seq_pepo_w;
	end if;
	
	CALL Gerar_registro_pendente_PEP(ie_tipo_w, NEW.nr_sequencia, cd_pessoa_fisica_w, nr_atendimento_w, NEW.nm_usuario);	
end if;

IF ( NEW.dt_inicio_adm IS NOT NULL ) THEN
	NEW.ds_utc := substr(obter_data_utc(NEW.dt_inicio_adm, 'HV'), 1, 50);
END IF;

IF ( ( OLD.dt_liberacao IS NULL ) OR ( OLD.dt_liberacao <> NEW.dt_liberacao ) ) AND ( NEW.dt_liberacao IS NOT NULL ) THEN
	NEW.ds_utc_atualizacao := substr(obter_data_utc(NEW.dt_liberacao, 'HV'), 1, 50);
END IF;

<<final>>
null;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cirurgia_agente_anest_atual() FROM PUBLIC;

CREATE TRIGGER cirurgia_agente_anest_atual
	BEFORE INSERT OR UPDATE ON cirurgia_agente_anest_ocor FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cirurgia_agente_anest_atual();

