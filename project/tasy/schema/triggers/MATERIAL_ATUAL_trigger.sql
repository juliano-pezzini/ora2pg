-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_atual ON material CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_atual() RETURNS trigger AS $BODY$
declare
qt_itens_w	bigint;
ie_atualiza_via_w	varchar(1);

pragma autonomous_transaction;
BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

	NEW.dt_atualizacao 	:= coalesce(NEW.dt_atualizacao, LOCALTIMESTAMP);
    NEW.dt_atualizacao_nrec 	:= coalesce(NEW.dt_atualizacao_nrec , LOCALTIMESTAMP);


	if (NEW.cd_unidade_medida_compra = NEW.cd_unidade_medida_estoque) then
		NEW.qt_conv_compra_estoque		:= 1;
	end if;

	if (NEW.cd_unidade_medida_consumo = NEW.cd_unidade_medida_estoque) then
		NEW.qt_conv_estoque_consumo	:= 1;
	end if;

	/*retirado por fabio 18/06/2007
	if	(:new.cd_unidade_medida_solic = :new.cd_unidade_medida_consumo) then
		:new.qt_minimo_multiplo_solic	:= 1;
	end if;
	*/


	if (NEW.ie_cobra_paciente = 'N') then
		NEW.cd_material_conta		:= null;
	end if;

	if (NEW.cd_unidade_medida_estoque <> OLD.cd_unidade_medida_estoque) or (NEW.cd_unidade_medida_consumo <> OLD.cd_unidade_medida_consumo) or (NEW.qt_conv_estoque_consumo <> OLD.qt_conv_estoque_consumo) then
		BEGIN
		if (NEW.cd_unidade_medida_estoque <> OLD.cd_unidade_medida_estoque) or (NEW.cd_unidade_medida_consumo <> OLD.cd_unidade_medida_consumo) then
			BEGIN
			select 	coalesce(max(1),0)
			into STRICT	qt_itens_w
			from	movimento_estoque
			where	cd_material	= NEW.cd_material;

			if (qt_itens_w > 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(266245);
				--'Existe movimento de estoque. ' || chr(10) ||

				--' As unidades de consumo e estoque nao podem ser alteradas');

			end if;
			end;
		end if;

		select 	coalesce(max(1),0)
		into STRICT	qt_itens_w
		from	requisicao_material_pendente_v
		where	cd_material	= NEW.cd_material;

		if (qt_itens_w > 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(266246);
			--'Existe requisicoes pendentes para este material. ' || chr(10) ||

			--' A conversao de estoque x consumo e as unidades de consumo e estoque nao podem ser alteradas');

		end if;
		end;
	end if;

	if (NEW.ds_material_sem_acento is null) or (NEW.ds_material <> OLD.ds_material)  then
		NEW.ds_material_sem_acento		:= upper( elimina_acentuacao(NEW.ds_material));
	end if;

	if (length(NEW.ds_material) < 3) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266249);
		--'A descricao do material deve ter no minimo 3 caracteres');

	end if;

	if (NEW.ie_controle_medico = 4) then
		if (NEW.qt_dia_profilatico is null) or (NEW.qt_dia_terapeutico is null) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(266250);
			--'Os dias de uso profilatico e terapeutico devem estar informdos');

		end if;
	end if;

	if	((NEW.ie_dias_util_medic is null) or (NEW.ie_dias_util_medic = 'N')) and (NEW.ie_dias_util_medic <> OLD.ie_dias_util_medic) and (NEW.ie_controle_medico <> 0) and (NEW.ie_controle_medico <> OLD.ie_controle_medico) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266251,'CD_MATERIAL=' || NEW.cd_material);
		--'Material ' || :new.cd_material || chr(13) ||

		--'Nao pode haver controle de antimicrobiano sem controle de dias de utilizacao');

	end if;


	ie_atualiza_via_w := obter_param_usuario(1580, 2, obter_perfil_ativo, NEW.nm_usuario, 0, ie_atualiza_via_w);

	if (ie_atualiza_via_w = 'S') and (NEW.nr_seq_forma_farm is not null) and
		((OLD.nr_seq_forma_farm is null) or (NEW.nr_seq_forma_farm <> OLD.nr_seq_forma_farm)) then

		CALL atualiza_via_forma_farm(NEW.cd_material, NEW.nr_seq_forma_farm, NEW.nm_usuario);

	end if;

	if (TG_OP = 'INSERT') and (NEW.ie_gerar_lote is null)then

		NEW.ie_gerar_lote := 'S';
	end if;

end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_atual() FROM PUBLIC;

CREATE TRIGGER material_atual
	BEFORE INSERT OR UPDATE ON material FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_atual();

