-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS banco_regra_numero_bef_update ON banco_regra_numero CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_banco_regra_numero_bef_update() RETURNS trigger AS $BODY$
declare

subtype varchar_1 is varchar(1);

nr_atual_w		varchar(100);
ie_gerar_log_w		varchar_1 := 'S';
ds_log_w		log_tasy.ds_log%type;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

	BEGIN

	if (NEW.ie_regra = OLD.ie_regra) and (NEW.ds_rotina_digito = OLD.ds_rotina_digito) and (NEW.nr_fixo = OLD.nr_fixo) and (NEW.qt_dig_numero = OLD.qt_dig_numero) and (NEW.qt_dig_verif = OLD.qt_dig_verif) and (NEW.nr_atual <> OLD.nr_atual) then
	   ie_gerar_log_w := 'N';
	end if;

	if (ie_gerar_log_w = 'S') then

		if (OLD.nr_atual <> NEW.nr_atual) then
			nr_atual_w := 	substr(' nr_atual: '||OLD.nr_atual||' - '||NEW.nr_atual,1,100);
		end if;

		ds_log_w := substr(' cd_banco: '||OLD.cd_banco|| ' - '||NEW.cd_banco||
			' cd_estabelecimento: '||OLD.cd_estabelecimento||' - '||NEW.cd_estabelecimento||
			' nm_usuario: '||OLD.nm_usuario||' - '||NEW.nm_usuario||
			' ie_regra: '||OLD.ie_regra||' - '||NEW.ie_regra||
			' nr_fixo: '||OLD.nr_fixo||' - '||NEW.nr_fixo||
			' ds_rotina_digito: '||OLD.ds_rotina_digito||' - '||NEW.ds_rotina_digito||
			nr_atual_w||
			' qt_dig_numero: '||OLD.qt_dig_numero||' - '||NEW.qt_dig_numero||
			' qt_dig_verif: '||OLD.qt_dig_verif||' - '||NEW.qt_dig_verif,1,2000);

		if (TG_OP = 'UPDATE') then
			CALL gravar_log_tasy(54335,
					'U'||ds_log_w,
					NEW.nm_usuario);
		else
			CALL gravar_log_tasy(54335,
					'D'||ds_log_w,
					coalesce(NEW.nm_usuario, OLD.nm_usuario));
		end if;

	end if;

	exception
        when data_exception then
            CALL gravar_log_tasy(54335,
            substr('Excecao ao incluir log (Value_Error): '||sqlerrm,1,2000),
            NEW.nm_usuario);
        when others then
            CALL gravar_log_tasy(54335,
            substr('Excecao ao incluir log: '||sqlerrm,1,2000),
            NEW.nm_usuario);
    end;

end if;

  END;
IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_banco_regra_numero_bef_update() FROM PUBLIC;

CREATE TRIGGER banco_regra_numero_bef_update
	BEFORE UPDATE OR DELETE ON banco_regra_numero FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_banco_regra_numero_bef_update();

