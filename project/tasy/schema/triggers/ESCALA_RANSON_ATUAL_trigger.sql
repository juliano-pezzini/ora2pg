-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_ranson_atual ON escala_ranson CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_ranson_atual() RETURNS trigger AS $BODY$
declare
  sql_w            varchar(800);
  qt_pontuacao_w   bigint;
  ds_erro_w        varchar(4000);
  ds_parametros_w  varchar(4000);
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger  = 'S')  then   
   
  if (NEW.nr_hora is null) or (NEW.dt_avaliacao <> OLD.dt_avaliacao) then
    BEGIN
    NEW.nr_hora	:= (to_char(round(NEW.dt_avaliacao,'hh24'),'hh24'))::numeric;
    end;
  end if;


  BEGIN
  
      sql_w := 'CALL OBTER_SCORE_RANSON_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12) INTO :qt_pontuacao_w';
      EXECUTE sql_w USING IN NEW.ie_pancreatite_aguda,
                                    IN NEW.qt_idade,
                                    IN NEW.qt_leucocitos,
                                    IN NEW.qt_glicemia,
                                    IN NEW.qt_dhl,
                                    IN NEW.qt_tgo,
                                    IN NEW.pr_queda_hematocrito,
                                    IN NEW.qt_aumento_bun,
                                    IN NEW.qt_calcemia,
                                    IN NEW.qt_pao2,
                                    IN NEW.qt_base_excess,
                                    IN NEW.qt_sequestro_liquido,
                                    OUT qt_pontuacao_w;

  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_pancreatite_aguda: '||NEW.ie_pancreatite_aguda||'-'||':new.qt_idade: '||NEW.qt_idade||'-'||':new.qt_leucocitos: '||NEW.qt_leucocitos||'-'||
                          ':new.qt_glicemia: '||NEW.qt_glicemia||'-'||':new.qt_dhl: '||NEW.qt_dhl||'-'||':new.qt_tgo: '||NEW.qt_tgo||'-'||
                          ':new.pr_queda_hematocrito: '||NEW.pr_queda_hematocrito||'-'||':new.qt_aumento_bun: '||NEW.qt_aumento_bun||'-'||':new.qt_calcemia: '||NEW.qt_calcemia||'-'||
                          ':new.qt_pao2: '||NEW.qt_pao2||'-'||':new.qt_base_excess: '||NEW.qt_base_excess||'-'||':new.qt_sequestro_liquido: '||NEW.qt_sequestro_liquido||'-'||
                          'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_ranson_atual','OBTER_SCORE_RANSON_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pontuacao_w := null;
  end;
      NEW.qt_pontuacao	:= qt_pontuacao_w;

end if;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_ranson_atual() FROM PUBLIC;

CREATE TRIGGER escala_ranson_atual
	BEFORE INSERT OR UPDATE ON escala_ranson FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_ranson_atual();

