-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS paciente_atendimento_atual ON paciente_atendimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_paciente_atendimento_atual() RETURNS trigger AS $BODY$
declare
qt_altura_w				integer;
qt_redutor_sc_w			double precision;
ie_formula_sc_w			varchar(10);
qt_superf_corporal_w	double precision;
cd_pessoa_fisica_w   	varchar(20);
ie_registro_liberado_w 	varchar(1);
BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
	if (NEW.dt_cancelamento is null) then
		CALL Abortar_Se_Protoc_Inativo(NEW.nr_seq_paciente);
	end if;

	if (coalesce(OLD.DT_PREVISTA,LOCALTIMESTAMP + interval '10 days') <> NEW.DT_PREVISTA) and (NEW.DT_PREVISTA is not null) then
		NEW.ds_utc		:= obter_data_utc(NEW.DT_PREVISTA, 'HV');	
	end if;

	if (coalesce(OLD.DT_LIBERACAO,LOCALTIMESTAMP + interval '10 days') <> NEW.DT_LIBERACAO) and (NEW.DT_LIBERACAO is not null) then
		NEW.ds_utc_atualizacao	:= obter_data_utc(NEW.DT_LIBERACAO,'HV');
	end if;

	if (coalesce(NEW.qt_peso,0) <> coalesce(OLD.qt_peso,0)) OR (coalesce(NEW.qt_altura,0) <> coalesce(OLD.qt_altura,0))then
			
		select	coalesce(qt_altura,0),
			coalesce(qt_redutor_sc,0),
			ie_formula_sup_corporea,
				cd_pessoa_fisica
		into STRICT qt_altura_w,
			qt_redutor_sc_w,
			ie_formula_sc_w,
				cd_pessoa_fisica_w
		from	paciente_setor
		where	nr_seq_paciente = NEW.nr_seq_paciente;
		
		if (coalesce(NEW.qt_altura,0) > 0) then	
			qt_altura_w := NEW.qt_altura;	
		end if;
		
		qt_superf_corporal_w := round(obter_superficie_corp_red_ped(NEW.qt_peso, qt_altura_w,qt_redutor_sc_w, cd_pessoa_fisica_w, obter_usuario_ativo,ie_formula_sc_w),obter_numero_casas_sc);
		if (coalesce(qt_superf_corporal_w,0) > 0) then
			NEW.qt_superf_corporal	:= qt_superf_corporal_w;
		end if;
			
					
	end if;

	if (NEW.dt_suspensao is not null) and (OLD.dt_suspensao is null) and (NEW.NM_USUARIO_SUSPENSAO is null) then
		NEW.NM_USUARIO_SUSPENSAO	:= obter_usuario_ativo;
	end if;

	if (OLD.ie_exige_liberacao = 'N') and (NEW.ie_exige_liberacao = 'S') and (NEW.nr_prescricao is not null) then
		select 	coalesce(max('S'),'N')
		into STRICT	ie_registro_liberado_w
		from 	prescr_material 
		where 	nr_prescricao = NEW.nr_prescricao 
		and 	dt_baixa  is not null;
		
		if (ie_registro_liberado_w = 'S') then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(326065);
		end if;	
	end if;
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_paciente_atendimento_atual() FROM PUBLIC;

CREATE TRIGGER paciente_atendimento_atual
	BEFORE INSERT OR UPDATE ON paciente_atendimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_paciente_atendimento_atual();

