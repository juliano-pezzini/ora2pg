-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cobranca_atual ON cobranca CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cobranca_atual() RETURNS trigger AS $BODY$
DECLARE

cd_pessoa_fisica_w	varchar(255) := null;
cd_cgc_w		varchar(255) := null;
ie_inclui_tit_canc_w	parametro_contas_receber.ie_inclui_tit_canc%type;
ie_situacao_w			titulo_receber.ie_situacao%type;	

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
if (NEW.nr_seq_cheque is not null) then
	select	max(cd_pessoa_fisica),
		max(cd_cgc)
	into STRICT	cd_pessoa_fisica_w,
		cd_cgc_w
	from	cheque_cr
	where	nr_seq_cheque	= NEW.nr_seq_cheque;
end if;

if (NEW.nr_titulo is not null) then
	select	max(cd_pessoa_fisica),
		max(cd_cgc),
			max(ie_situacao)
	into STRICT	cd_pessoa_fisica_w,
		cd_cgc_w,
			ie_situacao_w
	from	titulo_receber
	where	nr_titulo	= NEW.nr_titulo;
	
	if (TG_OP = 'INSERT') then
	
		select	coalesce(max(a.ie_inclui_tit_canc),'S')	
		into STRICT	ie_inclui_tit_canc_w
		from	parametro_contas_receber a
		where	a.cd_estabelecimento = NEW.cd_estabelecimento;

		if (ie_situacao_w = '3') and (coalesce(ie_inclui_tit_canc_w,'S') = 'N') then
			--A cobranca nao pode ser gerada pois o titulo #@nr_titulo_w#@ esta cancelado. Verifique na funcao Parametros do Contas a Receber, aba cobranca.

			CALL wheb_mensagem_pck.exibir_mensagem_abort(717906, 'NR_TITULO_W=' || NEW.nr_titulo);
		end if;
		
	end if;
	
end if;

NEW.cd_pessoa_fisica	:= cd_pessoa_fisica_w;
NEW.cd_cgc		:= cd_cgc_w;

end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cobranca_atual() FROM PUBLIC;

CREATE TRIGGER cobranca_atual
	BEFORE INSERT OR UPDATE ON cobranca FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cobranca_atual();

