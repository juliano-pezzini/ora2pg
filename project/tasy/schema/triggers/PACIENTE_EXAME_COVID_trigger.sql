-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS paciente_exame_covid ON paciente_exame CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_paciente_exame_covid() RETURNS trigger AS $BODY$
declare

  nr_atendimento_w  atendimento_paciente.nr_atendimento%type;
  nr_seq_atend_adic_w  atend_paciente_adic.nr_sequencia%type;

BEGIN

if (NEW.ie_exame_pac is not null AND NEW.ie_exame_pac = 'COVID-19') then

  select max(nr_atendimento)
  into STRICT   nr_atendimento_w
  from   atendimento_paciente
  where  cd_pessoa_fisica = NEW.cd_pessoa_fisica;

  select max(nr_sequencia)
  into STRICT   nr_seq_atend_adic_w
  from   atend_paciente_adic
  where  nr_atendimento = nr_atendimento_w;

  if ((trim(both substr(upper(NEW.ds_resultado),1,7))) like(substr(upper(OBTER_DESC_EXPRESSAO(296109)),1,7)) and (NEW.ie_situacao = 'A')) then


    if (nr_seq_atend_adic_w is null) then

      insert into ATEND_PACIENTE_ADIC(  nr_sequencia,
                          dt_atualizacao,
                          nm_usuario,
                          nr_atendimento,
                          ie_atend_covid_posit)
      values (nextval('atend_paciente_adic_seq'),LOCALTIMESTAMP,NEW.nm_usuario,nr_atendimento_w,'S');
    else
      update ATEND_PACIENTE_ADIC  set ie_atend_covid_posit = 'S' where nr_sequencia = nr_seq_atend_adic_w;
    end if;
  else
  --  Raise_application_error(-20011,'#@#@'||upper(:new.ds_resultado)||' - '||upper(OBTER_DESC_EXPRESSAO(296109))||' - '||nr_seq_atend_adic_w);
    if (nr_seq_atend_adic_w is null) then

      insert into ATEND_PACIENTE_ADIC(nr_sequencia,
                      dt_atualizacao,
                      nm_usuario,
                      nr_atendimento,
                      ie_atend_covid_posit)
      values (nextval('atend_paciente_adic_seq'),LOCALTIMESTAMP,NEW.nm_usuario,nr_atendimento_w,'N');
    else
      update ATEND_PACIENTE_ADIC  set ie_atend_covid_posit = 'N' where nr_sequencia = nr_seq_atend_adic_w;
    end if;

  end if;

end if;


RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_paciente_exame_covid() FROM PUBLIC;

CREATE TRIGGER paciente_exame_covid
	BEFORE INSERT OR UPDATE ON paciente_exame FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_paciente_exame_covid();

