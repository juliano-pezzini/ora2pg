-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS regra_entrega_laudo_atual ON regra_entrega_laudo CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_regra_entrega_laudo_atual() RETURNS trigger AS $BODY$
DECLARE
ie_sem_setor_entrega_w      parametro_cdi.ie_sem_setor_entrega%TYPE;
ie_setor_ativo_w            setor_atendimento.ie_situacao%TYPE;
BEGIN
  BEGIN
	IF (wheb_usuario_pck.get_ie_executar_trigger  = 'N') THEN
		GOTO Final;
	END IF;

	BEGIN
		SELECT coalesce(ie_sem_setor_entrega,'N')
		INTO STRICT ie_sem_setor_entrega_w
		FROM parametro_cdi
		WHERE nr_sequencia = (
			SELECT max(nr_sequencia)
			FROM parametro_cdi);
	EXCEPTION
	WHEN no_data_found THEN
		ie_sem_setor_entrega_w := 'N';
	END;

	BEGIN
		SELECT coalesce(ie_situacao,'I')
		INTO STRICT ie_setor_ativo_w
		FROM setor_atendimento
		WHERE cd_setor_atendimento = NEW.cd_setor_atendimento;
	EXCEPTION
	WHEN no_data_found THEN
		ie_setor_ativo_w := null;
	END;

	if (ie_sem_setor_entrega_w = 'N') and (NEW.cd_setor_atendimento is null) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(288202);
	end if;

	if ((NEW.cd_setor_atendimento is not null and OLD.cd_estabelecimento <> NEW.cd_estabelecimento)
        or ie_setor_ativo_w = 'I') then
		NEW.cd_setor_atendimento := null;
	end if;
	
	<<Final>>
	null;

  END;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_regra_entrega_laudo_atual() FROM PUBLIC;

CREATE TRIGGER regra_entrega_laudo_atual
	BEFORE INSERT OR UPDATE ON regra_entrega_laudo FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_regra_entrega_laudo_atual();

