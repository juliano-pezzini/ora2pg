-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_autor_cirurgia_update ON material_autor_cirurgia CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_autor_cirurgia_update() RETURNS trigger AS $BODY$
declare

nr_sequencia_autor_w		bigint;
nr_sequencia_autor_old_w  material_autorizado.nr_sequencia_autor%TYPE;
nr_seq_material_autor_w		bigint;
nr_seq_estagio_w		bigint;
ie_interno_w			varchar(2);
ie_lib_materiais_esp_w		varchar(1)	:= 'N';
ie_atualizando_autor_w		bigint;
ie_valor_conta_w		varchar(15) := 'N';
ie_atualiza_valor_conta_w	varchar(15) := 'S';
cd_estabelecimento_w		integer;
ie_atualiza_dados_mat_autor_w	varchar(1) := 'N';
ds_teste_w			varchar(2000);
nr_seq_autor_conv_w	material_autorizado.nr_sequencia_autor%TYPE;
cont_w			integer;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

    select	coalesce(max(b.ie_lib_materiais_esp),'N'),
        coalesce(max(b.cd_estabelecimento),0),
        max((select max(x.nr_sequencia) from autorizacao_convenio x where x.nr_sequencia = a.nr_seq_autor_conv)) nr_seq_autor_conv
    into STRICT	ie_lib_materiais_esp_w,
        cd_estabelecimento_w,
        nr_seq_autor_conv_w
    from	parametro_faturamento b,
        autorizacao_cirurgia a
    where	a.cd_estabelecimento	= b.cd_estabelecimento
    and	a.nr_sequencia		= NEW.nr_seq_autorizacao;

    ie_atualiza_valor_conta_w 	:= coalesce(obter_valor_param_usuario(3004, 148, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w),'S');
    ie_atualiza_dados_mat_autor_w 	:= coalesce(obter_valor_param_usuario(3006, 71, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w),'N');

    if (coalesce(ie_lib_materiais_esp_w,'N') = 'N')  then
        select	max(nr_sequencia),
            max(nr_seq_estagio)
        into STRICT	nr_sequencia_autor_w,
            nr_seq_estagio_w
        from	autorizacao_convenio
        where	nr_seq_autor_cirurgia	= NEW.nr_seq_autorizacao;

        if (nr_sequencia_autor_w is null) then
            select	max(a.nr_seq_autor_conv),
                max(b.nr_seq_estagio)
            into STRICT	nr_sequencia_autor_w,
                nr_seq_estagio_w
            from	autorizacao_cirurgia a,
                autorizacao_convenio b
            where	a.nr_seq_autor_conv = b.nr_sequencia
            and	a.nr_sequencia	    = NEW.nr_seq_autorizacao;
        end if;

        if (nr_sequencia_autor_w is not null) then
            select	max(ie_interno)
            into STRICT	ie_interno_w
            from	estagio_autorizacao
            where	nr_sequencia	= coalesce(nr_seq_estagio_w,0)
            and		OBTER_EMPRESA_ESTAB(wheb_usuario_pck.get_cd_estabelecimento) = cd_empresa;

            select	max(nr_sequencia),
                coalesce(max(ie_valor_conta),'N')
            into STRICT	nr_seq_material_autor_w,
                ie_valor_conta_w
            from	material_autorizado
            where	cd_material		= OLD.cd_material
            and	nr_sequencia_autor	= nr_sequencia_autor_w;

            if (OLD.nr_seq_autorizacao  is not null
                 and NEW.nr_seq_autorizacao  is not null 
                 and (nr_sequencia_autor_w is not null) or (nr_seq_autor_conv_w is not null))then

                select	coalesce(max(nr_sequencia),0)
                into STRICT	cont_w
                from	material_autorizado
                where	nr_sequencia_autor	= coalesce(nr_sequencia_autor_w,nr_seq_autor_conv_w)
                and	cd_material		= NEW.cd_material
                and	((nr_seq_opme is null) or (nr_seq_opme		= NEW.nr_seq_opme));

                if (cont_w = 0
                    and OLD.nr_seq_autorizacao  <> NEW.nr_seq_autorizacao ) then

                select	max(nr_sequencia)
                into STRICT	nr_sequencia_autor_old_w
                from	autorizacao_convenio
                where	nr_seq_autor_cirurgia	= OLD.nr_seq_autorizacao;

                    update material_autorizado
                        set
                        nm_usuario           = NEW.nm_usuario,
                        nm_usuario_nrec      = NEW.nm_usuario,
                        dt_atualizacao       = NEW.dt_atualizacao,
                        dt_atualizacao_nrec  = NEW.dt_atualizacao,
                        nr_sequencia_autor   = coalesce(nr_sequencia_autor_w,nr_seq_autor_conv_w),
                        cd_material          = NEW.cd_material,
                        qt_solicitada        = NEW.qt_solicitada,
                        qt_autorizada        = 0,
                        vl_unitario          = NEW.vl_unitario_material,
                        ds_observacao        = substr(NEW.ds_observacao,1,2000),
                        cd_cgc_fabricante    = CASE WHEN NEW.cd_cgc_fornec = NULL THEN cd_cgc_fabricante  ELSE NEW.cd_cgc_fornec END ,
                        nr_seq_fabricante    = NEW.nr_seq_fabricante,
                        pr_adicional         = NEW.pr_adicional,
                        ie_valor_conta       = NEW.ie_valor_conta,
                        nr_seq_opme          = NEW.nr_seq_opme,
                        nr_seq_regra_plano   = NEW.nr_seq_regra_plano,
                        ie_reducao_acrescimo = NEW.ie_reducao_acrescimo,
                        nr_seq_marca		 = NEW.nr_seq_marca
                    where cd_material        = OLD.cd_material
                    and nr_sequencia_autor   = coalesce(nr_sequencia_autor_old_w, nr_sequencia_autor)
                    and (nr_seq_opme is null or nr_seq_opme = coalesce(OLD.nr_seq_opme, nr_seq_opme))
                    and coalesce(nr_prescricao,0) = coalesce(OLD.nr_prescricao, 0);

                elsif (nr_seq_material_autor_w is not null) and
                    ((ie_atualiza_dados_mat_autor_w = 'N') and (ie_interno_w in ('1','2') or nr_seq_estagio_w is null)) or (ie_atualiza_dados_mat_autor_w = 'S') then

                    select	max(a.SID) sid
                    into STRICT	ie_atualizando_autor_w
                    from	v$session a
                    where	a.audsid		= (SELECT userenv('sessionid') b  b)
                    and	upper(a.action) 	like 'ATUALIZAR_AUTORIZACAO_CONVENIO%';

                    /* Francisco - 11/09/2009 - OS 165733 - So fazer esse update quando nao estiver mudando estagio da autorizacao */


                    if (ie_atualizando_autor_w = 0 or ie_atualizando_autor_w is null) and
                        ((ie_atualiza_valor_conta_w = 'S') or
                        ((ie_atualiza_valor_conta_w = 'N') and (coalesce(ie_valor_conta_w,'N') = 'N'))) then
    
                        update	material_autorizado
                        set	cd_material	= NEW.cd_material,
                            vl_unitario	= NEW.vl_unitario_material,
                            qt_solicitada	= coalesce(NEW.qt_solicitada,qt_solicitada),
                            qt_autorizada	= coalesce(NEW.qt_material,0),
                            ds_observacao	= substr(NEW.ds_observacao,1,2000),
                            cd_cgc_fabricante	= CASE WHEN NEW.cd_cgc_fornec = NULL THEN cd_cgc_fabricante  ELSE NEW.cd_cgc_fornec END ,
                            nr_seq_fabricante	= NEW.nr_seq_fabricante,
                            pr_adicional		= NEW.pr_adicional,
                            ie_reducao_acrescimo	= NEW.ie_reducao_acrescimo,
                            ie_valor_conta		= NEW.ie_valor_conta,
                            nr_seq_opme		= NEW.nr_seq_opme,
                            ie_origem_preco		= NEW.ie_origem_preco,
                            nr_seq_marca		= NEW.nr_seq_marca,
                            ie_faturamento_direto 	= NEW.ie_faturamento_direto,
                            dt_fatur_direto		= NEW.dt_fatur_direto,
                            nm_usuario_fatur_direto	= NEW.nm_usuario_fatur_direto,
                            dt_atualizacao 		= LOCALTIMESTAMP,
                            nm_usuario		= NEW.nm_usuario
                        where	nr_sequencia	= nr_seq_material_autor_w;
                    end if;
                end if;
            end if;
        end if;
    end if;
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_autor_cirurgia_update() FROM PUBLIC;

CREATE TRIGGER material_autor_cirurgia_update
	AFTER UPDATE ON material_autor_cirurgia FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_autor_cirurgia_update();

