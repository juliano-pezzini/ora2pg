-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_escala_four_atual ON atend_escala_four CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_escala_four_atual() RETURNS trigger AS $BODY$
declare

qt_reg_w				smallint;
cd_setor_atendimento_w	bigint;
ds_sql_w                varchar(4000);
qt_ponto_w              smallint;
ds_erro_w        		varchar(4000);
ds_parametros_w  		varchar(4000);
BEGIN
  BEGIN

    if (NEW.nr_hora is null) or (NEW.dt_avaliacao <> OLD.dt_avaliacao) then
        BEGIN  
            NEW.nr_hora := (to_char(round(NEW.dt_avaliacao,'hh24'),'hh24'))::numeric;
        end;
    end if;

    if (wheb_usuario_pck.get_ie_executar_trigger = 'N')  then
        goto final;
    end if;

    if (NEW.nr_atendimento is not null) and (NEW.dt_liberacao is null) then	

        BEGIN
            cd_setor_atendimento_w := obter_setor_atendimento(NEW.nr_atendimento);
        exception
        when others then
            cd_setor_atendimento_w	:= 0;
        end;

        if (cd_setor_atendimento_w	> 0) then
            NEW.cd_setor_atendimento	:= cd_setor_atendimento_w;
        end if;

    end if;

    BEGIN
        ds_sql_w := 'call calcular_ponto_escala_four_md(:1, :2, :3, :4) into :qt_ponto_w';
        EXECUTE ds_sql_w using in NEW.ie_resp_motora,
										 in NEW.ie_resp_ocular,
										 in NEW.ie_refl_cerebral,
										 in NEW.ie_respiracao,
										 out qt_ponto_w;

    exception
        when others then
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametros_w := substr(':new.nr_atendimento: '||NEW.nr_atendimento||'-:new.ie_resp_motora: '||NEW.ie_resp_motora||'-new.ie_resp_ocular: '||NEW.ie_resp_ocular||
									  '-:new.ie_refl_cerebral: '||NEW.ie_refl_cerebral||'-:new.ie_respiracao: '||NEW.ie_respiracao||'-qt_ponto_w: '|| qt_ponto_w, 1, 4000);
            CALL gravar_log_medical_device('atend_escala_four_atual', 'calcular_ponto_escala_four_md', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_ponto_w := null;
    end;
	
    NEW.qt_ponto := qt_ponto_w;

    <<final>>
    qt_reg_w := 0;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_escala_four_atual() FROM PUBLIC;

CREATE TRIGGER atend_escala_four_atual
	BEFORE INSERT OR UPDATE ON atend_escala_four FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_escala_four_atual();

