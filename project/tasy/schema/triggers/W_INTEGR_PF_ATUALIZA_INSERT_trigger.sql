-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS w_integr_pf_atualiza_insert ON w_integracao_pf_atualiza CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_w_integr_pf_atualiza_insert() RETURNS trigger AS $BODY$
DECLARE

cd_pessoa_fisica_w	varchar(10);
qt_existe_w_usuario_w	bigint;
qt_existe_compl_pf_w	bigint;
nr_sequencia_compl_w	bigint;
ds_erro_w 		varchar(1800);
BEGIN
  BEGIN

if (NEW.CD_PESSOA_FISICA_EXTERNO is not null) and (NEW.IE_TIPO_CODIGO_EXTERNO is not null) then

	select 	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from 	pf_codigo_externo
	where 	CD_PESSOA_FISICA_EXTERNO = NEW.CD_PESSOA_FISICA_EXTERNO
	and 	IE_TIPO_CODIGO_EXTERNO   = 'TS';

	if (cd_pessoa_fisica_w is not null) then -- Existe a pessoa
		BEGIN
		update	pessoa_fisica
		set	CD_NACIONALIDADE	=	NEW.CD_NACIONALIDADE,
			CD_PESSOA_FISICA	= 	NEW.CD_PESSOA_FISICA,
			CD_RELIGIAO		= 	NEW.CD_RELIGIAO,
			DS_ORGAO_EMISSOR_CI	= 	NEW.DS_ORGAO_EMISSOR_CI,
			DT_ATUALIZACAO		=	NEW.DT_ATUALIZACAO,
			DT_EMISSAO_CI		=	NEW.DT_EMISSAO_CI,
			DT_NASCIMENTO		=	NEW.DT_NASCIMENTO,
			IE_ESTADO_CIVIL		=	NEW.IE_ESTADO_CIVIL,
			IE_GRAU_INSTRUCAO	=	NEW.IE_GRAU_INSTRUCAO,
			IE_SEXO			=	NEW.IE_SEXO,
			IE_TIPO_PESSOA		=	NEW.IE_TIPO_PESSOA,
			NM_PESSOA_FISICA	=	NEW.NM_PESSOA_FISICA,
			NM_USUARIO		=	NEW.NM_USUARIO,
			NR_CPF			=	NEW.NR_CPF,
			NR_DDD_CELULAR		=	NEW.NR_DDD_CELULAR,
			NR_IDENTIDADE		=	NEW.NR_IDENTIDADE,
			NR_TELEFONE_CELULAR	=	NEW.NR_TELEFONE_CELULAR,
			SG_EMISSORA_CI		=	NEW.SG_EMISSORA_CI
		where 	cd_pessoa_fisica	= cd_pessoa_fisica_w;
		exception
			when others then
			null;
			/*ds_erro_w:= SQLERRM;
			insert into logxxxx_tasy( cd_log, ds_log, nm_usuario, dt_atualizacao)
				values (7211, '1- Update PF ' || cd_pessoa_fisica_w || ' - ' || ds_erro_w,'Integracao',sysdate);*/
		end;

		select 	count(*)
		into STRICT	qt_existe_w_usuario_w
		from 	W_USUARIO_CONVENIO
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;

		if (qt_existe_w_usuario_w	= 0) then

			BEGIN
			insert into W_USUARIO_CONVENIO(CD_PLANO_CONVENIO,
				CD_USUARIO_CONVENIO,
				DT_ADMISSAO,
				DT_DESLIGAMENTO,
				IE_SOS,
				IE_REGULAMENTADO,
				CD_FORMACAO,
				CD_PESSOA_FISICA,
				CD_CATEGORIA,
				IE_STATUS,
				nm_pessoa_fisica)
			values (NEW.CD_PLANO_CONVENIO,
				NEW.CD_USUARIO_CONVENIO,
				NEW.DT_ADMISSAO,
				NEW.DT_DESLIGAMENTO,
				NEW.IE_SOS,
				NEW.IE_REGULAMENTADO,
				NEW.CD_FORMACAO,
				cd_pessoa_fisica_w,
				NEW.CD_CATEGORIA,
				NEW.IE_STATUS,
				NEW.NM_PESSOA_FISICA);
			exception
				when others then
				null;
				/*ds_erro_w:= SQLERRM;
				insert into logxxxxxx_tasy ( cd_log, ds_log, nm_usuario, dt_atualizacao)
					values (7211, '2- Insert W_USUARIO... ' || cd_pessoa_fisica_w || ' - ' || ds_erro_w,'Integracao',sysdate);*/
			end;
		else

			BEGIN
			update 	W_USUARIO_CONVENIO
			set 	CD_PLANO_CONVENIO	=	NEW.CD_PLANO_CONVENIO,
				CD_USUARIO_CONVENIO	=	NEW.CD_USUARIO_CONVENIO,
				DT_ADMISSAO		=	NEW.DT_ADMISSAO,
				DT_DESLIGAMENTO		=	NEW.DT_DESLIGAMENTO,
				IE_SOS			=	NEW.IE_SOS,
				IE_REGULAMENTADO	=	NEW.IE_REGULAMENTADO,
				CD_FORMACAO		=	NEW.CD_FORMACAO,
				CD_CATEGORIA		= 	NEW.CD_CATEGORIA,
				IE_STATUS		=	NEW.IE_STATUS
			where 	cd_pessoa_fisica 	= cd_pessoa_fisica_w;
			exception
				when others then
				null;
				/*ds_erro_w:= SQLERRM;
				insert into logxxxxxx_tasy ( cd_log, ds_log, nm_usuario, dt_atualizacao)
					values (7211, '3- Update W_USUARIO... ' || cd_pessoa_fisica_w || ' - ' || ds_erro_w,'Integracao',sysdate);*/
			end;

		end if;

		select 	count(*)
		into STRICT	qt_existe_compl_pf_w
		from 	compl_pessoa_fisica
		where 	cd_pessoa_fisica = cd_pessoa_fisica_w
		and 	ie_tipo_complemento = NEW.ie_tipo_complemento;

		if (qt_existe_compl_pf_w = 0) then

			select (coalesce(max(nr_sequencia),0)+1)
			into STRICT 	nr_sequencia_compl_w
			from 	compl_pessoa_fisica
			where 	cd_pessoa_fisica = cd_pessoa_fisica_w;

			--Complemento da Pessoa Física
			BEGIN
			insert into compl_pessoa_fisica(
					cd_pessoa_fisica,
					nr_sequencia,
					ie_tipo_complemento,
					dt_atualizacao,
					nm_usuario,
					cd_cep,
					cd_municipio_ibge,
					ds_bairro,
					ds_complemento,
					ds_email,
					ds_endereco,
					ds_municipio,
					nm_contato,
					nr_ddd_telefone,
					nr_endereco,
					nr_ramal,
					nr_seq_pais,
					nr_telefone,
					sg_estado)
				values (cd_pessoa_fisica_w,
					nr_sequencia_compl_w,
					NEW.ie_tipo_complemento,
					NEW.dt_atualizacao,
					NEW.nm_usuario,
					NEW.cd_cep,
					NEW.cd_municipio_ibge,
					NEW.ds_bairro,
					NEW.ds_complemento,
					NEW.ds_email,
					NEW.ds_endereco,
					NEW.ds_municipio,
					NEW.nm_contato,
					NEW.nr_ddd_telefone,
					NEW.nr_endereco,
					NEW.nr_ramal,
					NEW.nr_seq_pais,
					NEW.nr_telefone,
					NEW.sg_estado);
			exception
				when others then
				null;
				/*ds_erro_w:= SQLERRM;
				insert into logxxxxx_tasy ( cd_log, ds_log, nm_usuario, dt_atualizacao)
					values (7211, '4- Insert  Compl_PF ' || cd_pessoa_fisica_w || ' - ' || ds_erro_w,'Integracao',sysdate);*/
			end;


			--Complemento da Pessoa Física (Mãe)
			BEGIN
			insert into compl_pessoa_fisica(
					cd_pessoa_fisica,
					nr_sequencia,
					ie_tipo_complemento,
					dt_atualizacao,
					nm_usuario,
					nm_contato)
				values (cd_pessoa_fisica_w,
					nr_sequencia_compl_w + 1,
					5,
					NEW.dt_atualizacao,
					NEW.nm_usuario,
					NEW.nm_mae);
			exception
				when others then
				null;
				/*ds_erro_w:= SQLERRM;
				insert into logxxxxxx_tasy ( cd_log, ds_log, nm_usuario, dt_atualizacao)
					values (7211, '4.1- Insert  Compl_PF(Mae) ' || cd_pessoa_fisica_w || ' - ' || ds_erro_w,'Integracao',sysdate);*/
			end;

		else

			--Complemento da Pessoa Física
			BEGIN
			update compl_pessoa_fisica
			set	dt_atualizacao		=	NEW.dt_atualizacao,
				nm_usuario		=	NEW.nm_usuario,
				cd_cep			=	NEW.cd_cep,
				cd_municipio_ibge	=	NEW.cd_municipio_ibge,
				ds_bairro		=	NEW.ds_bairro,
				ds_complemento		=	NEW.ds_complemento,
				ds_email		=	NEW.ds_email,
				ds_endereco		=	NEW.ds_endereco,
				ds_municipio		=	NEW.ds_municipio,
				nm_contato		=	NEW.nm_contato,
				nr_ddd_telefone		=	NEW.nr_ddd_telefone,
				nr_endereco		=	NEW.nr_endereco,
				nr_ramal		=	NEW.nr_ramal,
				nr_seq_pais		=	NEW.nr_seq_pais,
				nr_telefone		=	NEW.nr_telefone,
				sg_estado		=	NEW.sg_estado
			where	cd_pessoa_fisica 	= 	cd_pessoa_fisica_w
			and 	ie_tipo_complemento 	= 	NEW.ie_tipo_complemento;
			exception
				when others then
				null;
				/*ds_erro_w:= SQLERRM;
				insert into logxxxxxx_tasy ( cd_log, ds_log, nm_usuario, dt_atualizacao)
					values (7211, '5- Update Compl_PF ' || cd_pessoa_fisica_w || ' - ' || ds_erro_w,'Integracao',sysdate);*/
			end;


			--Complemento da Pessoa Física (Mãe)
			BEGIN
			update compl_pessoa_fisica
			set	dt_atualizacao		=	NEW.dt_atualizacao,
				nm_usuario		=	NEW.nm_usuario,
				nm_contato		=	NEW.nm_mae
			where	cd_pessoa_fisica 	= 	cd_pessoa_fisica_w
			and 	ie_tipo_complemento 	= 	5;
			exception
				when others then
				null;
				/*ds_erro_w:= SQLERRM;
				insert into logxxxxxx_tasy ( cd_log, ds_log, nm_usuario, dt_atualizacao)
					values (7211, '5.1- Update Compl_PF(Mae) ' || cd_pessoa_fisica_w || ' - ' || ds_erro_w,'Integracao',sysdate);*/
			end;

		end if;

	else -- Não tem a PF
		select 	nextval('pessoa_fisica_seq')
		into STRICT	cd_pessoa_fisica_w
		;

		BEGIN
		insert into pessoa_fisica(CD_NACIONALIDADE,
			CD_PESSOA_FISICA,
			CD_RELIGIAO,
			DS_ORGAO_EMISSOR_CI,
			DT_ATUALIZACAO,
			DT_EMISSAO_CI,
			DT_NASCIMENTO,
			IE_ESTADO_CIVIL,
			IE_GRAU_INSTRUCAO,
			IE_SEXO,
			IE_TIPO_PESSOA,
			NM_PESSOA_FISICA,
			NM_USUARIO,
			NR_CPF,
			NR_DDD_CELULAR,
			NR_IDENTIDADE,
			NR_TELEFONE_CELULAR,
			SG_EMISSORA_CI)
		values (
			NEW.CD_NACIONALIDADE,
			cd_pessoa_fisica_w,
			NEW.CD_RELIGIAO,
			NEW.DS_ORGAO_EMISSOR_CI,
			NEW.DT_ATUALIZACAO,
			NEW.DT_EMISSAO_CI,
			NEW.DT_NASCIMENTO,
			NEW.IE_ESTADO_CIVIL,
			NEW.IE_GRAU_INSTRUCAO,
			NEW.IE_SEXO,
			NEW.IE_TIPO_PESSOA,
			NEW.NM_PESSOA_FISICA,
			NEW.NM_USUARIO,
			NEW.NR_CPF,
			NEW.NR_DDD_CELULAR,
			NEW.NR_IDENTIDADE,
			NEW.NR_TELEFONE_CELULAR,
			NEW.SG_EMISSORA_CI);
		exception
			when others then
			null;
			/*ds_erro_w:= SQLERRM;
			insert into logxxxxxx_tasy ( cd_log, ds_log, nm_usuario, dt_atualizacao)
				values (7211, '6- Insert PF ' || cd_pessoa_fisica_w || ' - ' || ds_erro_w,'Integracao',sysdate);*/
		end;

		BEGIN
		insert into W_USUARIO_CONVENIO(CD_PLANO_CONVENIO,
				CD_USUARIO_CONVENIO,
				DT_ADMISSAO,
				DT_DESLIGAMENTO,
				IE_SOS,
				IE_REGULAMENTADO,
				CD_FORMACAO,
				CD_PESSOA_FISICA,
				CD_CATEGORIA,
				IE_STATUS,
				NM_PESSOA_FISICA)
			values (NEW.CD_PLANO_CONVENIO,
				NEW.CD_USUARIO_CONVENIO,
				NEW.DT_ADMISSAO,
				NEW.DT_DESLIGAMENTO,
				NEW.IE_SOS,
				NEW.IE_REGULAMENTADO,
				NEW.CD_FORMACAO,
				cd_pessoa_fisica_w,
				NEW.CD_CATEGORIA,
				NEW.IE_STATUS,
				NEW.NM_PESSOA_FISICA);
		exception
			when others then
			null;
			/*ds_erro_w:= SQLERRM;
			insert into logxxxxx_tasy ( cd_log, ds_log, nm_usuario, dt_atualizacao)
				values (7211, '7- Insert W_USUARIO... ' || cd_pessoa_fisica_w || ' - ' || ds_erro_w,'Integracao',sysdate);*/
		end;


		select (coalesce(max(nr_sequencia),0)+1)
		into STRICT 	nr_sequencia_compl_w
		from 	compl_pessoa_fisica
		where 	cd_pessoa_fisica = cd_pessoa_fisica_w;

			--Complemento da Pessoa Física
		BEGIN
		insert into compl_pessoa_fisica(
					cd_pessoa_fisica,
					nr_sequencia,
					ie_tipo_complemento,
					dt_atualizacao,
					nm_usuario,
					cd_cep,
					cd_municipio_ibge,
					ds_bairro,
					ds_complemento,
					ds_email,
					ds_endereco,
					ds_municipio,
					nm_contato,
					nr_ddd_telefone,
					nr_endereco,
					nr_ramal,
					nr_seq_pais,
					nr_telefone,
					sg_estado)
				values (cd_pessoa_fisica_w,
					nr_sequencia_compl_w,
					NEW.ie_tipo_complemento,
					NEW.dt_atualizacao,
					NEW.nm_usuario,
					NEW.cd_cep,
					NEW.cd_municipio_ibge,
					NEW.ds_bairro,
					NEW.ds_complemento,
					NEW.ds_email,
					NEW.ds_endereco,
					NEW.ds_municipio,
					NEW.nm_contato,
					NEW.nr_ddd_telefone,
					NEW.nr_endereco,
					NEW.nr_ramal,
					NEW.nr_seq_pais,
					NEW.nr_telefone,
					NEW.sg_estado);
		exception
			when others then
			null;
			/*ds_erro_w:= SQLERRM;
			insert into logxxxxxx_tasy ( cd_log, ds_log, nm_usuario, dt_atualizacao)
				values (7211, '8- Insert Compl_PF ' || cd_pessoa_fisica_w || ' - ' || ds_erro_w,'Integracao',sysdate);*/
		end;


		--Complemento da Pessoa Física (Mãe)
		BEGIN
		insert into compl_pessoa_fisica(
				cd_pessoa_fisica,
				nr_sequencia,
				ie_tipo_complemento,
				dt_atualizacao,
				nm_usuario,
				nm_contato)
			values (cd_pessoa_fisica_w,
				nr_sequencia_compl_w + 1,
				5,
				NEW.dt_atualizacao,
				NEW.nm_usuario,
				NEW.nm_mae);
		exception
			when others then
			null;
			/*ds_erro_w:= SQLERRM;
			insert into logxxxxx_tasy ( cd_log, ds_log, nm_usuario, dt_atualizacao)
				values (7211, '8.1- Insert  Compl_PF(Mae) ' || cd_pessoa_fisica_w || ' - ' || ds_erro_w,'Integracao',sysdate);*/
		end;

	end if;

end if;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_w_integr_pf_atualiza_insert() FROM PUBLIC;

CREATE TRIGGER w_integr_pf_atualiza_insert
	BEFORE INSERT ON w_integracao_pf_atualiza FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_w_integr_pf_atualiza_insert();

