-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS caixa_receb_update ON caixa_receb CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_caixa_receb_update() RETURNS trigger AS $BODY$
declare

qt_reg_w		smallint;
cd_estabelecimento_w	smallint;
ie_alterar_pessoa_w	varchar(1);
ie_alterar_obs_w	varchar(1);
ie_adto_mesma_pessoa_w	varchar(1);
cd_pessoa_fisica_w 		adiantamento.cd_pessoa_fisica%type;
cd_cgc_w				adiantamento.cd_cgc%type;

C01 CURSOR FOR
	SELECT coalesce(max(cd_pessoa_fisica),0),
		coalesce(max(cd_cgc),0)
	from adiantamento
	where nr_seq_caixa_rec = NEW.nr_sequencia;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;

select	max(b.cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	caixa b,
	caixa_saldo_diario a
where	a.nr_seq_caixa	= b.nr_sequencia
and	a.nr_sequencia	= NEW.nr_seq_saldo_caixa;

ie_alterar_pessoa_w := obter_param_usuario(813, 102, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_alterar_pessoa_w);
ie_alterar_obs_w := obter_param_usuario(813, 133, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_alterar_obs_w);
ie_adto_mesma_pessoa_w := Obter_Param_Usuario(813, 207, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, obter_estabelecimento_ativo, ie_adto_mesma_pessoa_w);

if (OLD.dt_fechamento is not null) and (NEW.dt_cancelamento is null) and (coalesce(ie_alterar_pessoa_w,'N') = 'N' or (coalesce(OLD.cd_pessoa_fisica,'X') = coalesce(NEW.cd_pessoa_fisica,'X') and coalesce(OLD.cd_cgc,'X') = coalesce(NEW.cd_cgc,'X'))) and (coalesce(ie_alterar_obs_w,'N') = 'N' or coalesce(OLD.ds_observacao,'X') = coalesce(NEW.ds_observacao,'X')) and (coalesce(OLD.NR_RPS,0) = coalesce(NEW.NR_RPS,0)) then

	/* Não é possível alterar esse recibo!
	O recibo :old.nr_recibo já foi fechado! */
	CALL wheb_mensagem_pck.exibir_mensagem_abort(262425,'NR_RECIBO_W='||OLD.nr_recibo);
end if;

if (coalesce(ie_adto_mesma_pessoa_w,'N') = 'S') then
	open C01;
	loop
	fetch C01 into
		cd_pessoa_fisica_w,
		cd_cgc_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		BEGIN

		if ((cd_pessoa_fisica_w > 0) and (coalesce(NEW.cd_pessoa_fisica,0) <> cd_pessoa_fisica_w)) or
			((cd_cgc_w > 0) and (coalesce(NEW.cd_cgc,0) <> cd_cgc_w)) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(460322);
		end if;
		end;
	end loop;
	close C01;
end if;

<<Final>>
qt_reg_w	:= 0;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_caixa_receb_update() FROM PUBLIC;

CREATE TRIGGER caixa_receb_update
	BEFORE UPDATE ON caixa_receb FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_caixa_receb_update();

