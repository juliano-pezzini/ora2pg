-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS lote_ent_sec_ficha_update ON lote_ent_sec_ficha CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_lote_ent_sec_ficha_update() RETURNS trigger AS $BODY$
declare

--pragma autonomous_transaction;


nr_sequencia_w      lote_ent_sec_ficha_log.nr_sequencia%type;
nr_seq_lote_ent_w    lote_ent_secretaria.nr_sequencia%type;
nr_seq_evento_w      ev_evento.nr_sequencia%type;
nr_lote_w      lote_ent_secretaria.nr_lote%type;
ds_retorno_w      varchar(4000);
nr_seq_tipo_ocorr_w    varchar(255);
nr_seq_ocorrencia_w    bigint;
nr_seq_exame_prescr_w    prescr_procedimento.nr_seq_exame%type;
nr_seq_material_prescr_w  material_exame_lab.nr_Sequencia%type;
nr_seq_prescr_w               exame_lab_result_item.nr_seq_prescr%type;
nr_Seq_resultado_w            exame_lab_result_item.nr_Seq_resultado%type;
nr_prescricao_w               prescr_procedimento.nr_prescricao%type;
qt_resultado_w                exame_lab_result_item.qt_resultado%type;
pr_resultado_w                exame_lab_result_item.pr_resultado%type;
ds_resultado_w            exame_lab_result_item.ds_resultado%type;
dt_aprovacao_exame_pai_w      exame_lab_result_item.dt_aprovacao%type;
nr_exames_aprovados_w         bigint;
nr_seq_metodo_w               exame_lab_result_item.nr_Seq_metodo%type;

ficha_row                       lote_ent_sec_ficha%rowtype;

ie_trigger_prescr_proc    char(1);

c01 CURSOR FOR
  SELECT  a.nr_seq_evento
  from  regra_envio_sms a
  where  a.ie_evento_disp = 'ALTLIBFIC'
  and  coalesce(a.ie_situacao,'A') = 'A';

-- exames principais

c02 CURSOR FOR
  SELECT   f.dt_aprovacao,
            b.nr_prescricao,
            c.nr_sequencia nr_seq_prescr,
            d.nr_sequencia nr_seq_material
  from     prescr_medica b,
            prescr_procedimento c,
            material_exame_lab d,
            exame_lab_resultado e,
            exame_lab_result_item f
  where    b.nr_seq_ficha_lote = OLD.nr_sequencia
  and      b.nr_prescricao = OLD.nr_prescricao
  and      b.nr_prescricao = c.nr_prescricao
  and      c.nr_seq_exame is not null
  and      c.cd_material_exame = d.cd_material_exame
  and      b.nr_prescricao = e.nr_prescricao
  and      f.nr_seq_resultado = e.nr_seq_resultado
  and      f.nr_seq_prescr = c.nr_sequencia
  and      f.nr_seq_material is not null;

-- exames filhos

c03 CURSOR FOR
  SELECT c.nr_seq_exame,
    f.nr_seq_resultado,
    f.qt_resultado,
    f.pr_resultado,
    f.ds_resultado
  from     prescr_medica b,
    prescr_procedimento c,
    exame_lab_resultado e,
    exame_lab_result_item f
  where    b.nr_seq_ficha_lote = OLD.nr_sequencia
  and      b.nr_prescricao = nr_prescricao_w
  and      b.nr_prescricao = c.nr_prescricao
  and      c.nr_seq_exame is not null
  and      b.nr_prescricao = e.nr_prescricao
  and      f.nr_seq_resultado = e.nr_seq_resultado
    and     f.nr_seq_prescr = nr_seq_prescr_w
  and      f.nr_seq_prescr = c.nr_sequencia;
BEGIN
  BEGIN

BEGIN

  select  'S'
  into STRICT    ie_trigger_prescr_proc

  where   lower( substr( dbms_utility.format_call_stack, 1, 4000 ) ) like '%prescr_procedimento_update%';

exception
when others then

    select  'N'
    into STRICT    ie_trigger_prescr_proc
;
end;

ficha_row.NR_SEQUENCIA                 :=     NEW.NR_SEQUENCIA;
ficha_row.NR_SEQ_LOTE_SEC              :=     NEW.NR_SEQ_LOTE_SEC;
ficha_row.DT_ATUALIZACAO               :=     NEW.DT_ATUALIZACAO;
ficha_row.NM_USUARIO                   :=     NEW.NM_USUARIO;
ficha_row.DT_ATUALIZACAO_NREC          :=     NEW.DT_ATUALIZACAO_NREC;
ficha_row.NM_USUARIO_NREC              :=     NEW.NM_USUARIO_NREC;
ficha_row.NR_PRONTUARIO_EX             :=     NEW.NR_PRONTUARIO_EX;
ficha_row.CD_USUARIO_CONV_EXT          :=     NEW.CD_USUARIO_CONV_EXT;
ficha_row.NR_FICHA_EXT                 :=     NEW.NR_FICHA_EXT;
ficha_row.DS_OBSERVACAO                :=     NEW.DS_OBSERVACAO;
ficha_row.IE_SUSP_AM_INAD              :=     NEW.IE_SUSP_AM_INAD;
ficha_row.CD_BARRAS                    :=     NEW.CD_BARRAS;
ficha_row.NR_CARTAO_NAC_SUS            :=     NEW.NR_CARTAO_NAC_SUS;
ficha_row.IE_FICHA_ADICIONAL           :=     NEW.IE_FICHA_ADICIONAL;
ficha_row.CD_ENTIDADE_F                :=     NEW.CD_ENTIDADE_F;
ficha_row.CD_LOTE_F                    :=     NEW.CD_LOTE_F;
ficha_row.CD_EXAME_F                   :=     NEW.CD_EXAME_F;
ficha_row.IE_PREMATURO_F               :=     NEW.IE_PREMATURO_F;
ficha_row.IE_TRANSFUSAO_F              :=     NEW.IE_TRANSFUSAO_F;
ficha_row.DT_COLETA_F                  :=     NEW.DT_COLETA_F;
ficha_row.IE_TIPO_TESTE_F              :=     NEW.IE_TIPO_TESTE_F;
ficha_row.DS_REPETICAO_EXAME_F         :=     NEW.DS_REPETICAO_EXAME_F;
ficha_row.CD_ENTRADA_F                 :=     NEW.CD_ENTRADA_F;
ficha_row.CD_EXAME_FICHA_F             :=     NEW.CD_EXAME_FICHA_F;
ficha_row.CD_PRONTUARIO_F              :=     NEW.CD_PRONTUARIO_F;
ficha_row.NM_RN_F                      :=     NEW.NM_RN_F;
ficha_row.CD_DNV_F                     :=     NEW.CD_DNV_F;
ficha_row.DT_COLETA_FICHA_F            :=     NEW.DT_COLETA_FICHA_F;
ficha_row.IE_PERIODO_COL_F             :=     NEW.IE_PERIODO_COL_F;
ficha_row.DT_NASCIMENTO_F              :=     NEW.DT_NASCIMENTO_F;
ficha_row.IE_PERIODO_NASC_F            :=     NEW.IE_PERIODO_NASC_F;
ficha_row.QT_PESO_F                    :=     NEW.QT_PESO_F;
ficha_row.IE_SEXO_F                    :=     NEW.IE_SEXO_F;
ficha_row.IE_COR_PF_F                  :=     NEW.IE_COR_PF_F;
ficha_row.IE_NPP_F                     :=     NEW.IE_NPP_F;
ficha_row.IE_PREMAT_S_F                :=     NEW.IE_PREMAT_S_F;
ficha_row.NR_IDADE_GEST_F              :=     NEW.NR_IDADE_GEST_F;
ficha_row.IE_PREMAT_N_F                :=     NEW.IE_PREMAT_N_F;
ficha_row.IE_TRANSF_S_F                :=     NEW.IE_TRANSF_S_F;
ficha_row.DT_TRANSF_F                  :=     NEW.DT_TRANSF_F;
ficha_row.IE_TRANSF_N_F                :=     NEW.IE_TRANSF_N_F;
ficha_row.IE_GEMELAR_F                 :=     NEW.IE_GEMELAR_F;
ficha_row.IE_TIPO_FICHA                :=     NEW.IE_TIPO_FICHA;
ficha_row.CD_MATERIAL_EXAME            :=     NEW.CD_MATERIAL_EXAME;
ficha_row.IE_STATUS_FICHA              :=     NEW.IE_STATUS_FICHA;
ficha_row.NR_SEQ_MOT_INADEQ            :=     NEW.NR_SEQ_MOT_INADEQ;
ficha_row.DS_MOTIVO_INADEQ             :=     NEW.DS_MOTIVO_INADEQ;
ficha_row.CD_PESSOA_FISICA             :=     NEW.CD_PESSOA_FISICA;
ficha_row.IE_BARRA_GERADO              :=     NEW.IE_BARRA_GERADO;
ficha_row.NM_MAE_F                     :=     NEW.NM_MAE_F;
ficha_row.CD_MEDICO_RESP               :=     NEW.CD_MEDICO_RESP;
ficha_row.NR_SEQ_TIPO_MAT_LOTE         :=     NEW.NR_SEQ_TIPO_MAT_LOTE;
ficha_row.NR_PRESCRICAO                :=     NEW.NR_PRESCRICAO;
ficha_row.IE_AMOSTRA                   :=     NEW.IE_AMOSTRA;
ficha_row.NR_SEQ_GRAU_PARENTESCO       :=     NEW.NR_SEQ_GRAU_PARENTESCO;
ficha_row.DT_VALIDADE                  :=     NEW.DT_VALIDADE;
ficha_row.DT_FABRICACAO                :=     NEW.DT_FABRICACAO;
ficha_row.NR_LOTE_FICHA                :=     NEW.NR_LOTE_FICHA;
ficha_row.NR_ATENDIMENTO               :=     NEW.NR_ATENDIMENTO;
ficha_row.CD_PESSOA_EXTERNA            :=     NEW.CD_PESSOA_EXTERNA;
ficha_row.HR_COLETA_F                  :=     NEW.HR_COLETA_F;
ficha_row.HR_NASCIMENTO_F              :=     NEW.HR_NASCIMENTO_F;
ficha_row.CD_MOTIVO_BAIXA              :=     NEW.CD_MOTIVO_BAIXA;
ficha_row.IE_CORTICOIDE_F              :=     NEW.IE_CORTICOIDE_F;
ficha_row.DS_CORTICOIDE_F              :=     NEW.DS_CORTICOIDE_F;
ficha_row.IE_SUSPENSO                  :=     NEW.IE_SUSPENSO;
ficha_row.IE_FICHA_URG                 :=     NEW.IE_FICHA_URG;
ficha_row.NR_SEQ_LOCAL                 :=     NEW.NR_SEQ_LOCAL;
ficha_row.NR_SEQ_LOCAL_CAIXA           :=     NEW.NR_SEQ_LOCAL_CAIXA;
ficha_row.NR_SEQ_FICHA_ANT             :=     NEW.NR_SEQ_FICHA_ANT;
ficha_row.IE_AMAMENTADO_F              :=     NEW.IE_AMAMENTADO_F;
ficha_row.IE_ALIM_LEITE_F              :=     NEW.IE_ALIM_LEITE_F;
ficha_row.IE_ICTERICIA_F               :=     NEW.IE_ICTERICIA_F;
ficha_row.IE_MAE_VEG_F                 :=     NEW.IE_MAE_VEG_F;
ficha_row.QT_GEST_F                    :=     NEW.QT_GEST_F;
ficha_row.DT_ULT_MENST                 :=     NEW.DT_ULT_MENST;
ficha_row.IE_TIPO_PARTO                :=     NEW.IE_TIPO_PARTO;
ficha_row.IE_ABORTO                    :=     NEW.IE_ABORTO;
ficha_row.QT_ABORTO                    :=     NEW.QT_ABORTO;
ficha_row.NR_SISPRENATAL               :=     NEW.NR_SISPRENATAL;
ficha_row.DS_UNIDADE_BASICA_ORIGEM     :=     NEW.DS_UNIDADE_BASICA_ORIGEM;
ficha_row.NR_DDI                       :=     NEW.NR_DDI;
ficha_row.NR_DDI_CELULAR               :=     NEW.NR_DDI_CELULAR;
ficha_row.NR_SEQ_MOTIVO_NAO_ELUIDO     :=     NEW.NR_SEQ_MOTIVO_NAO_ELUIDO;

CALL lote_ent_sec_ficha_pck.set_row(ficha_row);

ds_retorno_w := '';

nr_seq_tipo_ocorr_w := obter_param_usuario(10060, 64, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, nr_seq_tipo_ocorr_w);

if (NEW.cd_pessoa_fisica is not null) then
    CALL Lote_ent_sec_atualiz_dnv(NEW.cd_pessoa_fisica, NEW.cd_dnv_f, NEW.nm_usuario);
end if;


if (nr_seq_tipo_ocorr_w is null) then

  select  MAX(nr_sequencia)
  into STRICT  nr_seq_tipo_ocorr_w
  from   lote_ent_tipo_ocorrencia;

  if (nr_seq_tipo_ocorr_w is null) then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(294313);
  end if;


end if;

select   MAX(nr_sequencia),
    MAX(nr_lote)
into STRICT   nr_seq_lote_ent_w,
    nr_lote_w
from     lote_ent_secretaria
where  nr_sequencia = NEW.nr_seq_lote_sec
and   dt_liberacao is not null;

if (nr_seq_lote_ent_w is not null) and (OLD.nr_prescricao is not null) then
  select   nextval('lote_ent_sec_ficha_log_seq')
  into STRICT   nr_sequencia_w
;

  ds_retorno_w := wheb_mensagem_pck.get_texto(308667) || ' ' /*'Ficha alterada: '*/ || nr_sequencia_w || chr(13) || chr(10) || ' ' || wheb_mensagem_pck.get_texto(308670) || ' ' /*' Coluna    -    Vl. antigo   -   Vl. novo '*/ || chr(13) || chr(10);

  if (OLD.cd_motivo_baixa <> NEW.cd_motivo_baixa) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308673) || ': ' /*'Motivo baixa: '*/|| OLD.cd_motivo_baixa || ' - ' || NEW.cd_motivo_baixa || chr(13) || chr(10);
  end if;

  if (OLD.nr_seq_lote_sec <> NEW.nr_seq_lote_sec) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308675) || ': ' /*'Seq lote: '*/|| OLD.nr_seq_lote_sec || ' - ' || NEW.nr_seq_lote_sec || chr(13) || chr(10);
  end if;

  if (OLD.nm_usuario <> NEW.nm_usuario) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308677) || ' ' /*'Usuário: '*/|| OLD.nm_usuario || ' - ' || NEW.nm_usuario || chr(13) || chr(10);
  end if;

  if (OLD.nr_prontuario_ex <> NEW.nr_prontuario_ex) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308681) || ' ' /*'Prontuário: '*/|| OLD.nr_prontuario_ex || ' - ' || NEW.nr_prontuario_ex || chr(13) || chr(10);
  end if;

  if (OLD.cd_usuario_conv_ext <> NEW.cd_usuario_conv_ext) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308682) || ' ' /*'Cd. Usuário Ext: '*/|| OLD.cd_usuario_conv_ext || ' - ' || NEW.cd_usuario_conv_ext || chr(13) || chr(10);
  end if;

  if (OLD.cd_pessoa_fisica <> NEW.cd_pessoa_fisica) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308684) || ': ' /*'Pessoa física: '*/|| OLD.cd_pessoa_fisica || ' - ' || NEW.cd_pessoa_fisica || chr(13) || chr(10);
  end if;

  if (OLD.nr_ficha_ext <> NEW.nr_ficha_ext) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308687) || ' '/*'Ficha ext: '*/|| OLD.nr_ficha_ext || ' - ' || NEW.nr_ficha_ext || chr(13) || chr(10);
  end if;

  if (OLD.ds_observacao <> NEW.ds_observacao) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308689) || ' ' /*'Observação: '*/|| OLD.ds_observacao || ' - ' || NEW.ds_observacao || chr(13) || chr(10);
  end if;

  if (OLD.ie_susp_am_inad <> NEW.ie_susp_am_inad) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308691) || ' ' /*'Supende amostra inad: '*/|| OLD.ie_susp_am_inad || ' - ' || NEW.ie_susp_am_inad || chr(13) || chr(10);
  end if;

  if (OLD.cd_barras <> NEW.cd_barras) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308692) || ' ' /*'Barras: '*/|| OLD.cd_barras || ' - ' || NEW.cd_barras || chr(13) || chr(10);
  end if;

  if (OLD.nr_cartao_nac_sus <> NEW.nr_cartao_nac_sus) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308693) || ': ' /*'Cartão SUS: '*/|| OLD.nr_cartao_nac_sus || ' - ' || NEW.nr_cartao_nac_sus || chr(13) || chr(10);
  end if;

  if (OLD.ie_suspenso <> NEW.ie_suspenso) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308694) || ': ' /*'Suspenso: '*/|| OLD.ie_suspenso || ' - ' || NEW.ie_suspenso || chr(13) || chr(10);
  end if;

  if (OLD.ie_ficha_adicional <> NEW.ie_ficha_adicional) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308695) || ' ' /*'Ficha adicional: '*/|| OLD.ie_ficha_adicional || ' - ' || NEW.ie_ficha_adicional || chr(13) || chr(10);
  end if;

  if (OLD.cd_entidade_f <> NEW.cd_entidade_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308696) || ': ' /*'Cod. entidade: '*/|| OLD.cd_entidade_f || ' - ' || NEW.cd_entidade_f || chr(13) || chr(10);
  end if;

  if (OLD.cd_lote_f <> NEW.cd_lote_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308697) || ' ' /*'Cod. lote: '*/|| OLD.cd_lote_f || ' - ' || NEW.cd_lote_f || chr(13) || chr(10);
  end if;

  if (OLD.cd_exame_f <> NEW.cd_exame_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308698) || ' ' /*'Cod. exame: '*/|| OLD.cd_exame_f || ' - ' || NEW.cd_exame_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_prematuro_f <> NEW.ie_prematuro_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308699) || ': ' /*'Prematuro: '*/|| OLD.ie_prematuro_f || ' - ' || NEW.ie_prematuro_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_transfusao_f <> NEW.ie_transfusao_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308700) || ': ' /*'Transfundido: '*/|| OLD.ie_transfusao_f || ' - ' || NEW.ie_transfusao_f || chr(13) || chr(10);
  end if;

  if (OLD.dt_coleta_f <> NEW.dt_coleta_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308701) || ' ' /*'Dt. coleta: '*/|| OLD.dt_coleta_f || ' - ' || NEW.dt_coleta_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_tipo_teste_f <> NEW.ie_tipo_teste_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308702) || ': ' /*'Tipo teste: '*/|| OLD.ie_tipo_teste_f || ' - ' || NEW.ie_tipo_teste_f || chr(13) || chr(10);
  end if;

  if (OLD.cd_entrada_f <> NEW.cd_entrada_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308703) || ' ' /*'Cod. entrada: '*/|| OLD.cd_entrada_f || ' - ' || NEW.cd_entrada_f || chr(13) || chr(10);
  end if;

  if (OLD.cd_exame_ficha_f <> NEW.cd_exame_ficha_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308704) || ' ' /*'Cod. exame ficha: '*/|| OLD.cd_exame_ficha_f || ' - ' || NEW.cd_exame_ficha_f || chr(13) || chr(10);
  end if;

  if (OLD.cd_prontuario_f <> NEW.cd_prontuario_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308705) || ' ' /*'Cod. prontuário: '*/|| OLD.cd_prontuario_f || ' - ' || NEW.cd_prontuario_f || chr(13) || chr(10);
  end if;

  if (OLD.nm_rn_f <> NEW.nm_rn_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308707) || ': ' /*'RN: '*/|| OLD.nm_rn_f || ' - ' || NEW.nm_rn_f || chr(13) || chr(10);
  end if;

  if (OLD.cd_dnv_f <> NEW.cd_dnv_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308708) || ' ' /*'Cod. DNV: '*/|| OLD.cd_dnv_f || ' - ' || NEW.cd_dnv_f || chr(13) || chr(10);
  end if;

  if (OLD.dt_coleta_ficha_f <> NEW.dt_coleta_ficha_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308709) || ' ' /*'Dt. coleta ficha: '*/|| OLD.dt_coleta_ficha_f || ' - ' || NEW.dt_coleta_ficha_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_periodo_col_f <> NEW.ie_periodo_col_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308710) || ' ' /*'Período coleta: '*/|| OLD.ie_periodo_col_f || ' - ' || NEW.ie_periodo_col_f || chr(13) || chr(10);
  end if;

  if (OLD.dt_nascimento_f <> NEW.dt_nascimento_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308711) || ' ' /*'Dt. nascimento: '*/|| OLD.dt_nascimento_f || ' - ' || NEW.dt_nascimento_f || chr(13) || chr(10);
  end if;

  if (OLD.nr_prescricao <> NEW.nr_prescricao) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308714) || ' ' /*'Prescrição: '*/|| OLD.nr_prescricao || ' - ' || NEW.nr_prescricao || chr(13) || chr(10);
  end if;

  if (OLD.nr_seq_tipo_mat_lote <> NEW.nr_seq_tipo_mat_lote) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308715) || ' ' /*'Tipo mat. lote: '*/|| OLD.nr_seq_tipo_mat_lote || ' - ' || NEW.nr_seq_tipo_mat_lote || chr(13) || chr(10);
  end if;

  if (OLD.hr_coleta_f <> NEW.hr_coleta_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308716) || ' ' /*'Hr. coleta: '*/|| OLD.hr_coleta_f || ' - ' || NEW.hr_coleta_f || chr(13) || chr(10);
  end if;

  if (OLD.hr_nascimento_f <> NEW.hr_nascimento_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308717) || ' ' /*'Hr. nascimento: '*/|| OLD.hr_nascimento_f || ' - ' || NEW.hr_nascimento_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_periodo_nasc_f <> NEW.ie_periodo_nasc_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308718) || ' ' /*'Período nasc.: '*/|| OLD.ie_periodo_nasc_f || ' - ' || NEW.ie_periodo_nasc_f || chr(13) || chr(10);
  end if;

  if (OLD.qt_peso_f <> NEW.qt_peso_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308719) || ': '/*'Peso: '*/|| OLD.qt_peso_f || ' - ' || NEW.qt_peso_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_sexo_f <> NEW.ie_sexo_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308720) || ': ' /*'Sexo: '*/|| OLD.ie_sexo_f || ' - ' || NEW.ie_sexo_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_cor_pf_f <> NEW.ie_cor_pf_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308721) || ' ' /*'Cod. Cor: '*/|| OLD.ie_cor_pf_f || ' - ' || NEW.ie_cor_pf_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_npp_f <> NEW.ie_npp_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308722) || ': ' /*'NPP: '*/|| OLD.ie_npp_f || ' - ' || NEW.ie_npp_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_premat_s_f <> NEW.ie_premat_s_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308699) || ': ' /*'Prematuro: '*/|| OLD.ie_premat_s_f || ' - ' || NEW.ie_premat_s_f || chr(13) || chr(10);
  end if;

  if (OLD.nr_idade_gest_f <> NEW.nr_idade_gest_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308723) || ': ' /*'Idade gest: '*/|| OLD.nr_idade_gest_f || ' - ' || NEW.nr_idade_gest_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_premat_n_f <> NEW.ie_premat_n_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308699) || ': ' /*'Prematuro: '*/|| OLD.ie_premat_n_f || ' - ' || NEW.ie_premat_n_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_transf_s_f <> NEW.ie_transf_s_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308700) || ': ' /*'Transfundido: '*/|| OLD.ie_transf_s_f || ' - ' || NEW.ie_transf_s_f || chr(13) || chr(10);
  end if;

  if (OLD.dt_transf_f <> NEW.dt_transf_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308725) || ': ' /*'Dt. transfusão: '*/|| OLD.dt_transf_f || ' - ' || NEW.dt_transf_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_transf_n_f <> NEW.ie_transf_n_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308700) || ': ' /*'Transfundido: '*/|| OLD.ie_transf_n_f || ' - ' || NEW.ie_transf_n_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_gemelar_f <> NEW.ie_gemelar_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308726) || ': ' /*'Gemelar: '*/|| OLD.ie_gemelar_f || ' - ' || NEW.ie_gemelar_f || chr(13) || chr(10);
  end if;

  if (OLD.ie_corticoide_f <> NEW.ie_corticoide_f) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308727) || ': ' /*'Corticóide: '*/|| OLD.ie_corticoide_f || ' - ' || NEW.ie_corticoide_f || chr(13) || chr(10);
  end if;

  if (OLD.dt_validade <> NEW.dt_validade) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308728) || ' ' /*'Dt. validade: '*/|| OLD.dt_validade || ' - ' || NEW.dt_validade || chr(13) || chr(10);
  end if;

  if (OLD.ie_amostra <> NEW.ie_amostra) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308730) || ': ' /*'Amostra: '*/|| OLD.ie_amostra || ' - ' || NEW.ie_amostra || chr(13) || chr(10);
  end if;

  if (OLD.nr_seq_grau_parentesco <> NEW.nr_seq_grau_parentesco) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308731) || ': ' /*'Grau parentesco: '*/|| OLD.nr_seq_grau_parentesco || ' - ' || NEW.nr_seq_grau_parentesco || chr(13) || chr(10);
  end if;

  if (OLD.dt_fabricacao <> NEW.dt_fabricacao) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308732) || ': ' /*'Dt. fabricação: '*/|| OLD.dt_fabricacao || ' - ' || NEW.dt_fabricacao || chr(13) || chr(10);
  end if;

  if (OLD.nr_lote_ficha <> NEW.nr_lote_ficha) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308733) || ' ' /*'Nr lote: '*/|| OLD.nr_lote_ficha || ' - ' || NEW.nr_lote_ficha || chr(13) || chr(10);
  end if;

  if (OLD.cd_pessoa_externa <> NEW.cd_pessoa_externa) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308734) || ' ' /*'Cod. pessoa ext.: '*/|| OLD.cd_pessoa_externa || ' - ' || NEW.cd_pessoa_externa || chr(13) || chr(10);
  end if;

  if (OLD.cd_medico_resp <> NEW.cd_medico_resp) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308736) || ': ' /*'Cód. médico resp: '*/|| OLD.cd_medico_resp || ' - ' || NEW.cd_medico_resp || chr(13) || chr(10);
  end if;

  if (OLD.nr_seq_ficha_ant <> NEW.nr_seq_ficha_ant) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308738) || ': ' /*'Ficha anterior: '*/|| OLD.nr_seq_ficha_ant || ' - ' || NEW.nr_seq_ficha_ant || chr(13) || chr(10);
  end if;

  if (OLD.ie_tipo_ficha <> NEW.ie_tipo_ficha) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308739) || ': ' /*'Tipo ficha: '*/|| OLD.ie_tipo_ficha || ' - ' || NEW.ie_tipo_ficha || chr(13) || chr(10);
  end if;

  if (OLD.cd_material_exame <> NEW.cd_material_exame) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308740) || ': ' /*'Cód. material: '*/|| OLD.cd_material_exame || ' - ' || NEW.cd_material_exame || chr(13) || chr(10);
  end if;

  if (OLD.ie_status_ficha <> NEW.ie_status_ficha) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308741) || ': ' /*'Status ficha: '*/|| OLD.ie_status_ficha || ' - ' || NEW.ie_status_ficha || chr(13) || chr(10);
  end if;

  if (OLD.ds_motivo_inadeq <> NEW.ds_motivo_inadeq) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308742) || '.: ' /*'Motivo inad.: '*/|| OLD.ds_motivo_inadeq || ' - ' || NEW.ds_motivo_inadeq || chr(13) || chr(10);
  end if;

  if (OLD.ie_barra_gerado <> NEW.ie_barra_gerado) then
    ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(308743) || ': ' /*'Barras gerado: '*/|| OLD.ie_barra_gerado || ' - ' || NEW.ie_barra_gerado || chr(13) || chr(10);
  end if;

  select   nextval('lote_ent_ocorrencia_seq')
  into STRICT  nr_seq_ocorrencia_w
;

  insert into lote_ent_ocorrencia(
    nr_sequencia,
    dt_atualizacao,
    nm_usuario,
    dt_atualizacao_nrec,
    nm_usuario_nrec,
    ie_situacao,
    nr_seq_tipo_ocorrencia,
    ds_observacao,
    NR_SEQ_FICHA,
    NR_SEQ_LOTE_SEC
  ) values (
    nr_seq_ocorrencia_w,
    LOCALTIMESTAMP,
    NEW.nm_usuario,
    LOCALTIMESTAMP,
    NEW.nm_usuario,
    'A',
    nr_seq_tipo_ocorr_w,
    ds_retorno_w,
    NEW.nr_sequencia,
    nr_seq_lote_ent_w
  );

  insert into lote_ent_sec_ficha_log(nr_sequencia,
                    cd_motivo_baixa,
                    nr_seq_lote_sec,
                    dt_atualizacao,
                    nm_usuario,
                    dt_atualizacao_nrec,
                    nm_usuario_nrec,
                    nr_prontuario_ex,
                    cd_usuario_conv_ext,
                    cd_pessoa_fisica,
                    nr_ficha_ext,
                    ds_observacao,
                    ie_susp_am_inad,
                    cd_barras,
                    nr_seq_ficha_orig,
                    nr_cartao_nac_sus,
                    ie_suspenso,
                    ie_ficha_adicional,
                    cd_entidade_f,
                    cd_lote_f,
                    cd_exame_f,
                    ie_prematuro_f,
                    ie_transfusao_f,
                    dt_coleta_f,
                    ie_tipo_teste_f,
                    cd_entrada_f,
                    cd_exame_ficha_f,
                    cd_prontuario_f,
                    nm_rn_f,
                    cd_dnv_f,
                    dt_coleta_ficha_f,
                    ie_periodo_col_f,
                    dt_nascimento_f,
                    nr_prescricao,
                    nr_seq_tipo_mat_lote,
                    hr_coleta_f,
                    hr_nascimento_f,
                    ie_periodo_nasc_f,
                    qt_peso_f,
                    ie_sexo_f,
                    ie_cor_pf_f,
                    ie_npp_f,
                    ie_premat_s_f,
                    nr_idade_gest_f,
                    ie_premat_n_f,
                    ie_transf_s_f,
                    dt_transf_f,
                    ie_transf_n_f,
                    ie_gemelar_f,
                    ie_corticoide_f,
                    dt_validade,
                    ie_amostra,
                    nr_seq_grau_parentesco,
                    dt_fabricacao,
                    nr_lote_ficha,
                    cd_pessoa_externa,
                    cd_medico_resp,
                    nr_seq_ficha_ant,
                    ie_tipo_ficha,
                    cd_material_exame,
                    ie_status_ficha,
                    ds_motivo_inadeq,
                    ie_barra_gerado)
                    values (
                    nr_sequencia_w,
                    OLD.cd_motivo_baixa,
                    OLD.nr_seq_lote_sec,
                    OLD.dt_atualizacao,
                    OLD.nm_usuario,
                    OLD.dt_atualizacao_nrec,
                    OLD.nm_usuario_nrec,
                    OLD.nr_prontuario_ex,
                    OLD.cd_usuario_conv_ext,
                    OLD.cd_pessoa_fisica,
                    OLD.nr_ficha_ext,
                    OLD.ds_observacao,
                    OLD.ie_susp_am_inad,
                    OLD.cd_barras,
                    OLD.nr_sequencia,
                    OLD.nr_cartao_nac_sus,
                    OLD.ie_suspenso,
                    coalesce(OLD.ie_ficha_adicional,'N'),
                    OLD.cd_entidade_f,
                    OLD.cd_lote_f,
                    OLD.cd_exame_f,
                    OLD.ie_prematuro_f,
                    OLD.ie_transfusao_f,
                    OLD.dt_coleta_f,
                    OLD.ie_tipo_teste_f,
                    OLD.cd_entrada_f,
                    OLD.cd_exame_ficha_f,
                    OLD.cd_prontuario_f,
                    OLD.nm_rn_f,
                    OLD.cd_dnv_f,
                    OLD.dt_coleta_ficha_f,
                    OLD.ie_periodo_col_f,
                    OLD.dt_nascimento_f,
                    OLD.nr_prescricao,
                    OLD.nr_seq_tipo_mat_lote,
                    OLD.hr_coleta_f,
                    OLD.hr_nascimento_f,
                    OLD.ie_periodo_nasc_f,
                    OLD.qt_peso_f,
                    OLD.ie_sexo_f,
                    OLD.ie_cor_pf_f,
                    OLD.ie_npp_f,
                    OLD.ie_premat_s_f,
                    OLD.nr_idade_gest_f,
                    OLD.ie_premat_n_f,
                    OLD.ie_transf_s_f,
                    OLD.dt_transf_f,
                    OLD.ie_transf_n_f,
                    OLD.ie_gemelar_f,
                    OLD.ie_corticoide_f,
                    OLD.dt_validade,
                    OLD.ie_amostra,
                    OLD.nr_seq_grau_parentesco,
                    OLD.dt_fabricacao,
                    OLD.nr_lote_ficha,
                    OLD.cd_pessoa_externa,
                    OLD.cd_medico_resp,
                    OLD.nr_seq_ficha_ant,
                    OLD.ie_tipo_ficha,
                    OLD.cd_material_exame,
                    OLD.ie_status_ficha,
                    OLD.ds_motivo_inadeq,
                    OLD.ie_barra_gerado
                    );

    if (OLD.dt_coleta_f <> NEW.dt_coleta_f) or (OLD.hr_coleta_f <> NEW.hr_coleta_f) or (OLD.dt_nascimento_f <> NEW.dt_nascimento_f) or (OLD.hr_nascimento_f <> NEW.hr_nascimento_f)  then
    CALL lab_atualiza_regra_pacote_proc( nr_seq_lote_ent_w,OLD.nr_sequencia,NEW.nm_usuario, NEW.dt_coleta_f, NEW.hr_coleta_f,NEW.dt_nascimento_f, NEW.hr_nascimento_f);
  end if;

    open C01;
    loop
    fetch C01 into
      nr_seq_evento_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
      BEGIN
      CALL gerar_evento_alter_ficha_lib(nr_seq_evento_w, nr_lote_w,OLD.nr_sequencia, OLD.nm_usuario,OLD.nr_prescricao,OLD.cd_pessoa_fisica);
      end;
    end loop;
    close C01;

  if (NEW.ie_tipo_ficha = OLD.ie_tipo_ficha AND ie_trigger_prescr_proc = 'N') then
    nr_exames_aprovados_w := 0;

    open C02;
    loop
    fetch C02 into
      dt_aprovacao_exame_pai_w,
      nr_prescricao_w,
            nr_seq_prescr_w,
      nr_seq_material_prescr_w;
    EXIT WHEN NOT FOUND; /* apply on C02 */
      BEGIN
      -- Se exame principal não estiver aprovado, atualiza, senão exibe mensagem

      if (dt_aprovacao_exame_pai_w is null) then
        open C03;
        loop
        fetch C03 into
          nr_seq_exame_prescr_w,
          nr_seq_resultado_w,
          qt_resultado_w,
          pr_resultado_w,
          ds_resultado_w;
        EXIT WHEN NOT FOUND; /* apply on C03 */
          BEGIN

                        select  b.nr_seq_metodo
                        into STRICT    nr_seq_metodo_w
                        from    exame_lab_result_item b
                        where   b.nr_seq_resultado = nr_seq_resultado_w and
                                b.nr_seq_exame  = nr_seq_exame_prescr_w and
                                b.nr_seq_prescr = nr_seq_prescr_w;

            update exame_lab_result_item
            set    ie_tipo_val_crit = SUBSTR(lab_cons_valor_result_lote(nr_seq_exame_prescr_w, nr_seq_material_prescr_w, coalesce(qt_resultado_w,pr_resultado_w), ds_resultado_w, nr_prescricao_w, nr_seq_prescr_w,1, nr_seq_metodo_w,nr_seq_resultado_w),1,255),
                 ie_valor_crit = SUBSTR(lab_cons_valor_result_lote(nr_seq_exame_prescr_w, nr_seq_material_prescr_w, coalesce(qt_resultado_w,pr_resultado_w), ds_resultado_w, nr_prescricao_w, nr_seq_prescr_w,2, nr_seq_metodo_w,nr_seq_resultado_w),1,2),
                 ds_mensagem_criterio =  SUBSTR(lab_cons_valor_result_lote(nr_seq_exame_prescr_w, nr_seq_material_prescr_w, coalesce(qt_resultado_w,pr_resultado_w), ds_resultado_w, nr_prescricao_w, nr_seq_prescr_w,3,nr_seq_metodo_w,nr_seq_resultado_w),1,4000),
                 ds_acao_criterio = SUBSTR(lab_cons_valor_result_lote(nr_seq_exame_prescr_w, nr_seq_material_prescr_w, coalesce(qt_resultado_w,pr_resultado_w), ds_resultado_w, nr_prescricao_w, nr_seq_prescr_w,4,nr_seq_metodo_w,nr_seq_resultado_w),1,255),
                 ie_acao_criterio_lote = SUBSTR(lab_cons_valor_result_lote(nr_seq_exame_prescr_w, nr_seq_material_prescr_w, coalesce(qt_resultado_w,pr_resultado_w), ds_resultado_w, nr_prescricao_w, nr_seq_prescr_w,7,nr_seq_metodo_w,nr_seq_resultado_w),1,1),
                 ds_result_sug_crit = SUBSTR(lab_cons_valor_result_lote(nr_seq_exame_prescr_w, nr_seq_material_prescr_w, coalesce(qt_resultado_w,pr_resultado_w), ds_resultado_w, nr_prescricao_w, nr_seq_prescr_w,8,nr_seq_metodo_w,nr_seq_resultado_w),1,255),
                 ds_material_criterio = SUBSTR(lab_cons_valor_result_lote(nr_seq_exame_prescr_w, nr_seq_material_prescr_w, coalesce(qt_resultado_w,pr_resultado_w), ds_resultado_w, nr_prescricao_w, nr_seq_prescr_w,9,nr_seq_metodo_w,nr_seq_resultado_w),1,255),
                 ds_metodo_criterio = SUBSTR(lab_cons_valor_result_lote(nr_seq_exame_prescr_w, nr_seq_material_prescr_w, coalesce(qt_resultado_w,pr_resultado_w), ds_resultado_w, nr_prescricao_w, nr_seq_prescr_w,10,nr_seq_metodo_w,nr_seq_resultado_w),1,255),
                 dt_atualizacao = LOCALTIMESTAMP
            where  nr_seq_resultado = nr_seq_resultado_w
            and     nr_seq_prescr = nr_seq_prescr_w;

          end;
        end loop;
        close C03;
      else
        -- se o exame principal já estiver aprovado, não deve alterar dados do exame principal ou filhos

        nr_exames_aprovados_w := nr_exames_aprovados_w + 1;
      end if;
      end;
    end loop;
    close C02;

    if (nr_exames_aprovados_w > 0) then
      CALL gravar_log_lab_pragma(37, wheb_mensagem_pck.get_texto(334623), wheb_usuario_pck.get_nm_usuario);
    end if;

  end if;

end if;

--commit;


  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_lote_ent_sec_ficha_update() FROM PUBLIC;

CREATE TRIGGER lote_ent_sec_ficha_update
	BEFORE UPDATE ON lote_ent_sec_ficha FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_lote_ent_sec_ficha_update();

