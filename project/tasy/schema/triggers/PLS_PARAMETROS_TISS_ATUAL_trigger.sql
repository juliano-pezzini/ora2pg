-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_parametros_tiss_atual ON pls_parametros_tiss CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_parametros_tiss_atual() RETURNS trigger AS $BODY$
declare

qtde_regime_duplicado_w pls_parametros_tiss.nr_sequencia%type := 0;
qtde_so_duplicado_w 	pls_parametros_tiss.nr_sequencia%type := 0;

PRAGMA AUTONOMOUS_TRANSACTION;

BEGIN

	if ( wheb_usuario_pck.get_ie_executar_trigger = 'S') then
		select	max(nr_sequencia)
		into STRICT	qtde_regime_duplicado_w
		from	pls_parametros_tiss
		where	ie_regime_atendimento = NEW.ie_regime_atendimento
		and  ( (pls_obter_entre_datas_str(dt_inicio_vigencia, dt_fim_vigencia, NEW.dt_inicio_vigencia) = 'S')
		    or (pls_obter_entre_datas_str(dt_inicio_vigencia, dt_fim_vigencia, NEW.dt_fim_vigencia) = 'S'))
		and 	nr_sequencia <> NEW.nr_sequencia
		and 	ie_situacao = 'A';
		
		--dois registros com mesmo regime atendimento, sendo que pelo menos um dia em comum entre os dois intervalos
		if (qtde_regime_duplicado_w is not null) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1208239);
		else
			select	max(nr_sequencia)
			into STRICT	qtde_so_duplicado_w
			from	pls_parametros_tiss
			where	ie_saude_ocupacional = NEW.ie_saude_ocupacional
			and  ( (pls_obter_entre_datas_str(dt_inicio_vigencia, dt_fim_vigencia, NEW.dt_inicio_vigencia) = 'S')
				or (pls_obter_entre_datas_str(dt_inicio_vigencia, dt_fim_vigencia, NEW.dt_fim_vigencia) = 'S'))
			and 	nr_sequencia <> NEW.nr_sequencia
			and 	ie_situacao = 'A';
			
			--dois registros com tipo de saude ocupacional, sendo que pelo menos um dia em comum entre os dois intervalos
			if (qtde_so_duplicado_w is not null) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1208240);
			end if;
		end if;
	end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_parametros_tiss_atual() FROM PUBLIC;

CREATE TRIGGER pls_parametros_tiss_atual
	BEFORE INSERT OR UPDATE ON pls_parametros_tiss FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_parametros_tiss_atual();

