-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_ntiss_atual ON escala_ntiss CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_ntiss_atual() RETURNS trigger AS $BODY$
DECLARE
    qt_reg_w         smallint;
    sql_w            varchar(900);
    qt_pto_total_w   bigint;
    ds_erro_w        varchar(4000);
    ds_parametros_w  varchar(4000);
BEGIN
  BEGIN
    IF ( NEW.nr_hora IS NULL ) OR ( NEW.dt_avaliacao <> OLD.dt_avaliacao ) THEN
        BEGIN
            NEW.nr_hora := (to_char(round(NEW.dt_avaliacao, 'hh24'), 'hh24'))::numeric;

        END;
    END IF;

    IF ( wheb_usuario_pck.get_ie_executar_trigger = 'N' ) THEN
        GOTO final;
    END IF;

-- Medical Device
    BEGIN
        sql_w := 'begin OBTER_PONT_ESCALA_NTISS_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16, :17, :18,
                                                 :19, :20, :21, :22, :23, :24, :25, :26, :27, :28, :29, :30, :31, :32, :33, :34,
                                                 :35, :36, :37, :38, :39, :40, :41, :42, :43, :44, :45, :46, :47, :48, :49, :50,
                                                 :51, :52, :53, :54, :55, :56, :57, :58, :59, :60, :61, :62, :63, :64, :65, :66, :67,
                                                 :68, :69, :70, :71, :72, :73, :74, :75, :76, :77, :78, :79, :80, :81, :82, :83, :84,
                                                 :85, :86, :87, :88, :89, :90, :91, :92, :93, :94, :95, :96, :97); end;';
        EXECUTE sql_w
            USING IN NEW.ie_ventilacao, OUT NEW.qt_pto_vent, IN NEW.ie_surfactante, OUT NEW.qt_pto_surfactante, IN NEW.ie_intubacao_traq,
            OUT NEW.qt_pto_intubacao, IN NEW.ie_traqueostomia, OUT NEW.qt_pto_traqueostomia, IN NEW.ie_ecmo, OUT NEW.qt_pto_ecmo,
            IN NEW.ie_uso_atb, OUT NEW.qt_pto_atb, IN NEW.ie_uso_diuretico, OUT NEW.qt_pto_diuretico, IN NEW.ie_anticonvulsivante,
            OUT NEW.qt_pto_anticonvulsivante, IN NEW.ie_aminofilina, OUT NEW.qt_pto_aminofilina, IN NEW.ie_medic_nao_prog, OUT NEW.qt_pto_medic_nao_prog,
            IN NEW.ie_corticoide, OUT NEW.qt_pto_corticoide, IN NEW.ie_resina, OUT NEW.qt_pto_resina,
            IN NEW.ie_trat_metabolico, OUT NEW.qt_pto_trat_meta, IN NEW.ie_aliment_gavagem, OUT NEW.qt_pto_aliment_gavagem, IN NEW.ie_fototerapia, 
            OUT NEW.qt_pto_fototerapia, IN NEW.ie_emulsao_lipidica, OUT NEW.qt_pto_emulsao, IN NEW.ie_infusao_aminoacido,
            OUT NEW.qt_pto_infusao_amino, IN NEW.ie_adm_insulina, OUT NEW.qt_pto_adm_insulina, IN NEW.ie_infusao_potassio, OUT NEW.qt_pto_infusao_pot, 
            IN NEW.ie_transporte, OUT NEW.qt_pto_transporte, IN NEW.ie_dialise, OUT NEW.qt_pto_dialise,
            IN NEW.ie_drenagem, OUT NEW.qt_pto_drenagem, IN NEW.ie_toracocentese, OUT NEW.qt_pto_toracocentese, IN NEW.ie_pericardio,
            OUT NEW.qt_pto_pericardio, IN NEW.ie_operacao, OUT NEW.qt_pto_operacao, IN NEW.ie_indometacina, OUT NEW.qt_pto_indometacina,
            IN NEW.ie_expansao, OUT NEW.qt_pto_expansao, IN NEW.ie_vasopressor, OUT NEW.qt_pto_vasopressor, IN NEW.ie_ressucitacao,
            OUT NEW.qt_pto_ressucitacao, IN NEW.ie_marcapasso, OUT NEW.qt_pto_marcapasso, IN NEW.ie_sinal_vital, OUT NEW.qt_pto_sinal_vital,
            IN NEW.ie_coleta_sangue, OUT NEW.qt_pto_coleta, IN NEW.ie_monitor_cardio, OUT NEW.qt_pto_monit_cardio, IN NEW.ie_amb_termoregulado,
            OUT NEW.qt_pto_termoregulado, IN NEW.ie_oximetria, OUT NEW.qt_pto_oximetria, IN NEW.ie_monit_pa, OUT NEW.qt_pto_monit_pa,
            IN NEW.ie_monit_pvc, OUT NEW.qt_pto_monit_pvc, IN NEW.ie_cateter, OUT NEW.qt_pto_cateter, IN NEW.ie_balanco_hidrico,
            OUT NEW.qt_pto_balanco_hidrico, IN NEW.ie_gamaglobulina, OUT NEW.qt_pto_gamaglobulina, IN NEW.ie_exsanguineotra_parcial,
            OUT NEW.qt_pto_exsanguineo_par, IN NEW.ie_exsanguineotra, OUT NEW.qt_pto_exsanguineotra, IN NEW.ie_hemotransf_menor,
            OUT NEW.qt_pto_hemotransf_menor, IN NEW.ie_transfusao_plaq, OUT NEW.qt_pto_transf_plaq, IN NEW.ie_transfusao_plasma,
            OUT NEW.qt_pto_transf_plasma, IN NEW.ie_acesso_arterial, OUT NEW.qt_pto_acesso_arterial, IN NEW.ie_acesso_venoso_per,
            OUT NEW.qt_pto_acesso_venoso_per, IN NEW.ie_acesso_venoso_central, OUT NEW.qt_pto_acesso_venoso_cen, OUT qt_pto_total_w;

    EXCEPTION
        WHEN OTHERS THEN
            ds_erro_w := sqlerrm;
            ds_parametros_w := ( ':new.nr_atendimento: '
                                 || NEW.nr_atendimento
                                 || '-'
                                 || ':new.cd_profissional: '
                                 || NEW.cd_profissional
                                 || '-'
                                 || ':new.ie_situacao: '
                                 || NEW.ie_situacao
                                 || '-'
                                 || ':new.ie_ventilacao: '
                                 || NEW.ie_ventilacao
                                 || '-'
                                 || ':new.qt_pto_vent: '
                                 || NEW.qt_pto_vent
                                 || '-'
                                 || ':new.ie_surfactante: '
                                 || NEW.ie_surfactante
                                 || '-'
                                 || ':new.qt_pto_surfactante: '
                                 || NEW.qt_pto_surfactante
                                 || '-'
                                 || ':new.ie_intubacao_traq: '
                                 || NEW.ie_intubacao_traq
                                 || '-'
                                 || ':new.qt_pto_intubacao: '
                                 || NEW.qt_pto_intubacao
                                 || '-'
                                 || ':new.ie_traqueostomia: '
                                 || NEW.ie_traqueostomia
                                 || '-'
                                 || ':new.qt_pto_traqueostomia: '
                                 || NEW.qt_pto_traqueostomia
                                 || '-'
                                 || ':new.ie_ecmo: '
                                 || NEW.ie_ecmo
                                 || '-'
                                 || ':new.qt_pto_ecmo: '
                                 || NEW.qt_pto_ecmo
                                 || '-'
                                 || ':new.ie_uso_atb: '
                                 || NEW.ie_uso_atb
                                 || '-'
                                 || ':new.qt_pto_atb: '
                                 || NEW.qt_pto_atb
                                 || '-'
                                 || ':new.ie_uso_diuretico: '
                                 || NEW.ie_uso_diuretico
                                 || '-'
                                 || ':new.qt_pto_diuretico: '
                                 || NEW.qt_pto_diuretico
                                 || '-'
                                 || ':new.ie_anticonvulsivante: '
                                 || NEW.ie_anticonvulsivante
                                 || '-'
                                 || ':new.qt_pto_anticonvulsivante: '
                                 || NEW.qt_pto_anticonvulsivante
                                 || '-'
                                 || ':new.ie_aminofilina: '
                                 || NEW.ie_aminofilina
                                 || '-'
                                 || ':new.qt_pto_aminofilina: '
                                 || NEW.qt_pto_aminofilina
                                 || '-'
                                 || ':new.ie_medic_nao_prog: '
                                 || NEW.ie_medic_nao_prog
                                 || '-'
                                 || ':new.qt_pto_medic_nao_prog: '
                                 || NEW.qt_pto_medic_nao_prog
                                 || '-'
                                 || ':new.ie_corticoide: '
                                 || NEW.ie_corticoide
                                 || '-'
                                 || ':new.qt_pto_corticoide: '
                                 || NEW.qt_pto_corticoide
                                 || '-'
                                 || ':new.ie_resina: '
                                 || NEW.ie_resina
                                 || '-'
                                 || ':new.qt_pto_resina: '
                                 || NEW.qt_pto_resina
                                 || '-'
                                 || ':new.ie_trat_metabolico: '
                                 || NEW.ie_trat_metabolico
                                 || '-'
                                 || ':new.qt_pto_trat_meta: '
                                 || NEW.qt_pto_trat_meta
                                 || '-'
                                 || ':new.ie_aliment_gavagem: '
                                 || NEW.ie_aliment_gavagem
                                 || '-'
                                 || ':new.qt_pto_aliment_gavagem: '
                                 || NEW.qt_pto_aliment_gavagem
                                 || '-'
                                 || ':new.ie_fototerapia: '
                                 || NEW.ie_fototerapia
                                 || '-'
                                 || ':new.qt_pto_fototerapia: '
                                 || NEW.qt_pto_fototerapia
                                 || '-'
                                 || ':new.ie_emulsao_lipidica: '
                                 || NEW.ie_emulsao_lipidica
                                 || '-'
                                 || ':new.qt_pto_emulsao: '
                                 || NEW.qt_pto_emulsao
                                 || '-'
                                 || ':new.ie_infusao_aminoacido: '
                                 || NEW.ie_infusao_aminoacido
                                 || '-'
                                 || ':new.qt_pto_infusao_amino: '
                                 || NEW.qt_pto_infusao_amino
                                 || '-'
                                 || ':new.ie_adm_insulina: '
                                 || NEW.ie_adm_insulina
                                 || '-'
                                 || ':new.qt_pto_adm_insulina: '
                                 || NEW.qt_pto_adm_insulina
                                 || '-'
                                 || ':new.ie_infusao_potassio: '
                                 || NEW.ie_infusao_potassio
                                 || '-'
                                 || ':new.qt_pto_infusao_pot: '
                                 || NEW.qt_pto_infusao_pot
                                 || '-'
                                 || ':new.ie_transporte: '
                                 || NEW.ie_transporte
                                 || '-'
                                 || ':new.qt_pto_transporte: '
                                 || NEW.qt_pto_transporte
                                 || '-'
                                 || ':new.ie_dialise: '
                                 || NEW.ie_dialise
                                 || '-'
                                 || ':new.qt_pto_dialise: '
                                 || NEW.qt_pto_dialise
                                 || '-'
                                 || ':new.ie_drenagem: '
                                 || NEW.ie_drenagem
                                 || '-'
                                 || ':new.qt_pto_drenagem: '
                                 || NEW.qt_pto_drenagem
                                 || '-'
                                 || ':new.ie_toracocentese: '
                                 || NEW.ie_toracocentese
                                 || '-'
                                 || ':new.qt_pto_toracocentese: '
                                 || NEW.qt_pto_toracocentese
                                 || '-'
                                 || ':new.ie_pericardio: '
                                 || NEW.ie_pericardio
                                 || '-'
                                 || ':new.qt_pto_pericardio: '
                                 || NEW.qt_pto_pericardio
                                 || '-'
                                 || ':new.ie_operacao: '
                                 || NEW.ie_operacao
                                 || '-'
                                 || ':new.qt_pto_operacao: '
                                 || NEW.qt_pto_operacao
                                 || '-'
                                 || ':new.ie_indometacina: '
                                 || NEW.ie_indometacina
                                 || '-'
                                 || ':new.qt_pto_indometacina: '
                                 || NEW.qt_pto_indometacina
                                 || '-'
                                 || ':new.ie_expansao: '
                                 || NEW.ie_expansao
                                 || '-'
                                 || ':new.qt_pto_expansao: '
                                 || NEW.qt_pto_expansao
                                 || '-'
                                 || ':new.ie_vasopressor: '
                                 || NEW.ie_vasopressor
                                 || '-'
                                 || ':new.qt_pto_vasopressor: '
                                 || NEW.qt_pto_vasopressor
                                 || '-'
                                 || ':new.ie_ressucitacao: '
                                 || NEW.ie_ressucitacao
                                 || '-'
                                 || ':new.qt_pto_ressucitacao: '
                                 || NEW.qt_pto_ressucitacao
                                 || '-'
                                 || ':new.ie_marcapasso: '
                                 || NEW.ie_marcapasso
                                 || '-'
                                 || ':new.qt_pto_marcapasso: '
                                 || NEW.qt_pto_marcapasso
                                 || '-'
                                 || ':new.ie_sinal_vital: '
                                 || NEW.ie_sinal_vital
                                 || '-'
                                 || ':new.qt_pto_sinal_vital: '
                                 || NEW.qt_pto_sinal_vital
                                 || '-'
                                 || ':new.ie_coleta_sangue: '
                                 || NEW.ie_coleta_sangue
                                 || '-'
                                 || ':new.qt_pto_coleta: '
                                 || NEW.qt_pto_coleta
                                 || '-'
                                 || ':new.ie_monitor_cardio: '
                                 || NEW.ie_monitor_cardio
                                 || '-'
                                 || ':new.qt_pto_monit_cardio: '
                                 || NEW.qt_pto_monit_cardio
                                 || '-'
                                 || ':new.ie_amb_termoregulado: '
                                 || NEW.ie_amb_termoregulado
                                 || '-'
                                 || ':new.qt_pto_termoregulado: '
                                 || NEW.qt_pto_termoregulado
                                 || '-'
                                 || ':new.ie_oximetria: '
                                 || NEW.ie_oximetria
                                 || '-'
                                 || ':new.qt_pto_oximetria: '
                                 || NEW.qt_pto_oximetria
                                 || '-'
                                 || ':new.ie_monit_pa: '
                                 || NEW.ie_monit_pa
                                 || '-'
                                 || ':new.qt_pto_monit_pa: '
                                 || NEW.qt_pto_monit_pa
                                 || '-'
                                 || ':new.ie_monit_pvc: '
                                 || NEW.ie_monit_pvc
                                 || '-'
                                 || ':new.qt_pto_monit_pvc: '
                                 || NEW.qt_pto_monit_pvc
                                 || '-'
                                 || ':new.ie_cateter: '
                                 || NEW.ie_cateter
                                 || '-'
                                 || ':new.qt_pto_cateter: '
                                 || NEW.qt_pto_cateter
                                 || '-'
                                 || ':new.ie_balanco_hidrico: '
                                 || NEW.ie_balanco_hidrico
                                 || '-'
                                 || ':new.qt_pto_balanco_hidrico: '
                                 || NEW.qt_pto_balanco_hidrico
                                 || '-'
                                 || ':new.ie_gamaglobulina: '
                                 || NEW.ie_gamaglobulina
                                 || '-'
                                 || ':new.qt_pto_gamaglobulina: '
                                 || NEW.qt_pto_gamaglobulina
                                 || '-'
                                 || ':new.ie_exsanguineotra_parcial: '
                                 || NEW.ie_exsanguineotra_parcial
                                 || '-'
                                 || ':new.qt_pto_exsanguineo_par: '
                                 || NEW.qt_pto_exsanguineo_par
                                 || '-'
                                 || ':new.ie_exsanguineotra: '
                                 || NEW.ie_exsanguineotra
                                 || '-'
                                 || ':new.qt_pto_exsanguineotra: '
                                 || NEW.qt_pto_exsanguineotra
                                 || '-'
                                 || ':new.ie_hemotransf_menor: '
                                 || NEW.ie_hemotransf_menor
                                 || '-'
                                 || ':new.qt_pto_hemotransf_menor: '
                                 || NEW.qt_pto_hemotransf_menor
                                 || '-'
                                 || ':new.ie_transfusao_plaq: '
                                 || NEW.ie_transfusao_plaq
                                 || '-'
                                 || ':new.qt_pto_transf_plaq: '
                                 || NEW.qt_pto_transf_plaq
                                 || '-'
                                 || ':new.ie_transfusao_plasma: '
                                 || NEW.ie_transfusao_plasma
                                 || '-'
                                 || ':new.qt_pto_transf_plasma: '
                                 || NEW.qt_pto_transf_plasma
                                 || '-'
                                 || ':new.ie_acesso_arterial: '
                                 || NEW.ie_acesso_arterial
                                 || '-'
                                 || ':new.qt_pto_acesso_arterial: '
                                 || NEW.qt_pto_acesso_arterial
                                 || '-'
                                 || ':new.ie_acesso_venoso_per: '
                                 || NEW.ie_acesso_venoso_per
                                 || '-'
                                 || ':new.qt_pto_acesso_venoso_per: '
                                 || NEW.qt_pto_acesso_venoso_per
                                 || '-'
                                 || ':new.ie_acesso_venoso_central: '
                                 || NEW.ie_acesso_venoso_central
                                 || '-'
                                 || ':new.qt_pto_acesso_venoso_cen: '
                                 || NEW.qt_pto_acesso_venoso_cen
                                 || '-'
                                 || 'qt_pto_total_w:'
                                 || qt_pto_total_w );

            CALL gravar_log_medical_device('escala_ntiss_atual', 'OBTER_PONT_ESCALA_NTISS_MD',
                                     ds_parametros_w,
                                     substr(ds_erro_w, 4000),
                                     NEW.nm_usuario,
                                     'N');

            qt_pto_total_w := NULL;
    END;

    NEW.qt_pto_total := qt_pto_total_w;
    << final >> qt_reg_w := 0;
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_ntiss_atual() FROM PUBLIC;

CREATE TRIGGER escala_ntiss_atual
	BEFORE INSERT OR UPDATE ON escala_ntiss FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_ntiss_atual();

