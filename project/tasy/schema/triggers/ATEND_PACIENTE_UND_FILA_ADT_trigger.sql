-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_paciente_und_fila_adt ON atend_paciente_unidade CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_paciente_und_fila_adt() RETURNS trigger AS $BODY$
declare
registro_tipo_transferencia_w 	atendimento_paciente_v.cd_unidade%type;
nr_atendimento_w 				fila_impressao_adt.nr_atendimento%type;

PRAGMA AUTONOMOUS_TRANSACTION;

c01 CURSOR FOR
    SELECT  imp.nr_sequencia
      from  relatorio_auto_imp imp,
            usuario_scheduler u
     where  imp.ie_regra_repet = 'ADT'
       and  imp.ie_tipo_acao_adt = 'T'
       and 	imp.nr_seq_scheduler = u.nr_sequencia
       and 	imp.ie_exportar_documento = 'S'
       and 	u.ie_situacao = 'A';

c01_w c01%rowtype;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
	nr_atendimento_w := NEW.nr_atendimento;

	select trim(both obter_unidade_paciente(null, null, nr_atendimento_w))
	into STRICT registro_tipo_transferencia_w
	;

		if  registro_tipo_transferencia_w = 'EDBirth' then
			open c01;
			fetch c01 into c01_w;
			if c01%found then
				insert into fila_impressao_adt(
					nr_sequencia,
					nr_atendimento,
					nr_seq_relatorio_auto_imp,
					dt_atualizacao
					) values (
					nextval('fila_impressao_adt_seq'),
					nr_atendimento_w,
					c01_w.nr_sequencia,
					LOCALTIMESTAMP
					);
			end if;
			close c01;
		end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_paciente_und_fila_adt() FROM PUBLIC;

CREATE TRIGGER atend_paciente_und_fila_adt
	AFTER INSERT ON atend_paciente_unidade FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_paciente_und_fila_adt();

