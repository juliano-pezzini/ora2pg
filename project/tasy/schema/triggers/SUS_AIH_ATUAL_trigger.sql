-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS sus_aih_atual ON sus_aih CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_sus_aih_atual() RETURNS trigger AS $BODY$
DECLARE
 
cd_convenio_w	bigint;
qt_reg_w	smallint;
BEGIN 
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N') then 
	goto Final;
end if;
if (NEW.nr_interno_conta is null) and (OLD.nr_interno_conta is null) then 
	 
	select	max(a.cd_convenio) /* Felipe Martini OS75220*/
 
	into STRICT	cd_convenio_w 
	from	atend_categoria_convenio a, 
		convenio c 
	where	c.cd_convenio		= a.cd_convenio 
	and	c.ie_tipo_convenio	= 3 
	and	a.nr_atendimento	= NEW.nr_atendimento;
		 
	select	coalesce(max(nr_interno_conta),null) 
	into STRICT	NEW.nr_interno_conta 
	from 	conta_paciente 
	where 	nr_atendimento 		= NEW.nr_atendimento 
	and	cd_convenio_parametro	= cd_convenio_w 
	and	ie_status_acerto	= 1;
 
end if;
 
if (coalesce(NEW.nr_interno_conta,0) <> coalesce(OLD.nr_interno_conta,1)) then 
	update sus_laudo_paciente 
	set nr_interno_conta = NEW.nr_interno_conta 
	where nr_aih = NEW.nr_aih;
end if;
 
if	((NEW.qt_dia_acompanhante	= 0 ) or (NEW.qt_dia_acompanhante	is null)) and (OLD.qt_dia_acompanhante	> 0 ) then 
	delete	from procedimento_paciente 
	where	nr_interno_conta	= NEW.nr_interno_conta 
	and	cd_procedimento		= 99080011;
end if;
<<Final>> 
qt_reg_w	:= 0;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_sus_aih_atual() FROM PUBLIC;

CREATE TRIGGER sus_aih_atual
	BEFORE INSERT OR UPDATE ON sus_aih FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_sus_aih_atual();

