-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS lote_audit_hist_item_insert ON lote_audit_hist_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_lote_audit_hist_item_insert() RETURNS trigger AS $BODY$
declare

ie_tipo_glosa_w		varchar(10);
cd_convenio_w		bigint;
cd_estabelecimento_w	bigint;
cd_motivo_glosa_w	bigint;
ie_acao_glosa_w		varchar(1);
cd_setor_resp_w		integer;
cd_resposta_w		bigint;


BEGIN

/*lhalves OS 585937 em 11/05/2013 - Buscar motivo de glosa conforme regra, baseado no valor de glosa informado*/

if (NEW.cd_motivo_glosa is null) and (coalesce(NEW.vl_glosa_informada,0) <> 0) then

	select	max(a.cd_convenio),
		max(a.cd_estabelecimento)
	into STRICT	cd_convenio_w,
		cd_estabelecimento_w
	from	lote_auditoria a,
		lote_audit_hist b,
		lote_audit_hist_guia c
	where	a.nr_sequencia	= b.nr_seq_lote_audit
	and	b.nr_sequencia	= c.nr_seq_lote_hist
	and	c.nr_sequencia	= NEW.nr_seq_guia;

	cd_motivo_glosa_w := OBTER_MOTIVO_GLOSA_RECURSO(cd_estabelecimento_w, cd_convenio_w, NEW.vl_glosa_informada, cd_motivo_glosa_w);

	if (cd_motivo_glosa_w is not null) then

		select	max(a.ie_acao_glosa) ie_acao_glosa,
			max(a.cd_setor_resp) cd_setor_resp,
			max(a.cd_resposta) cd_resposta,
			max(a.ie_tipo_glosa) ie_tipo_glosa
		into STRICT	ie_acao_glosa_w,
			cd_setor_resp_w,
			cd_resposta_w,
			ie_tipo_glosa_w
		from	motivo_glosa a
		where	a.cd_motivo_glosa = cd_motivo_glosa_w;

		NEW.ie_acao_glosa		:= ie_acao_glosa_w;
		NEW.cd_setor_responsavel	:= cd_setor_resp_w;
		NEW.cd_resposta		:= cd_resposta_w;
		NEW.ie_tipo_glosa		:= ie_tipo_glosa_w;
		NEW.cd_motivo_glosa		:= cd_motivo_glosa_w;

	end if;

end if;
/*FIM lhalves OS 585937*/

if (NEW.cd_motivo_glosa is not null) then

	select	max(ie_tipo_glosa)
	into STRICT	ie_tipo_glosa_w
	from	motivo_glosa
	where	cd_motivo_glosa	= NEW.cd_motivo_glosa;

	NEW.ie_tipo_glosa	:= ie_tipo_glosa_w;

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_lote_audit_hist_item_insert() FROM PUBLIC;

CREATE TRIGGER lote_audit_hist_item_insert
	BEFORE INSERT ON lote_audit_hist_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_lote_audit_hist_item_insert();

