-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_autor_cirurgia_delete ON material_autor_cirurgia CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_autor_cirurgia_delete() RETURNS trigger AS $BODY$
declare

nr_sequencia_autor_w	bigint;
nr_seq_material_autor_w	bigint;
nr_seq_estagio_w	bigint;
ie_interno_w		varchar(2);
ie_lib_materiais_esp_w	varchar(1)	:= 'N';
BEGIN
  BEGIN

BEGIN

select	coalesce(max(ie_lib_materiais_esp),'N')
into STRICT	ie_lib_materiais_esp_w
from	parametro_faturamento b,
	autorizacao_cirurgia a
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_sequencia		= OLD.nr_seq_autorizacao;

if (coalesce(ie_lib_materiais_esp_w,'N') = 'N')  then

	select	max(nr_sequencia),
		max(nr_seq_estagio)
	into STRICT	nr_sequencia_autor_w,
		nr_seq_estagio_w
	from	autorizacao_convenio
	where	nr_seq_autor_cirurgia	= OLD.nr_seq_autorizacao;

	if (nr_sequencia_autor_w is not null) then

		select	max(ie_interno)
		into STRICT	ie_interno_w
		from	estagio_autorizacao
		where	nr_sequencia	= coalesce(nr_seq_estagio_w,0)
		and		OBTER_EMPRESA_ESTAB(wheb_usuario_pck.get_cd_estabelecimento) = cd_empresa;

		select	max(nr_sequencia)
		into STRICT	nr_seq_material_autor_w
		from	material_autorizado
		where	cd_material		= OLD.cd_material
		and	nr_sequencia_autor	= nr_sequencia_autor_w;

		if (nr_seq_material_autor_w is not null) and (ie_interno_w = '1' or nr_seq_estagio_w is null) then

			delete	from	material_autorizado
			where	nr_sequencia	= nr_seq_material_autor_w;
		end if;
	end if;
end if;

exception
	when others then
	null;
end;

  END;
RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_autor_cirurgia_delete() FROM PUBLIC;

CREATE TRIGGER material_autor_cirurgia_delete
	AFTER DELETE ON material_autor_cirurgia FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_autor_cirurgia_delete();

