-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_recomendacao_updt_after ON prescr_recomendacao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_recomendacao_updt_after() RETURNS trigger AS $BODY$
declare

ds_erro_w     	varchar(2000);
ds_stack_w		varchar(2000);
ds_log_w	varchar(2000);
dt_min_date_w	timestamp := to_date('30/12/1899 00:00:00', 'dd/mm/yyyy hh24:mi:ss');
BEGIN
  BEGIN
	BEGIN
		if (coalesce(NEW.nr_sequencia,0) <> coalesce(OLD.nr_sequencia,0)) then
			ds_log_w	:= substr(ds_log_w || ' nr_sequencia(' || coalesce(OLD.nr_sequencia,0) || '/' || coalesce(NEW.nr_sequencia,0)||'); ',1,2000);
		end if;

		if (coalesce(NEW.dt_suspensao, dt_min_date_w) <> coalesce(OLD.dt_suspensao, dt_min_date_w)) then
			ds_log_w	:= substr(ds_log_w || ' dt_suspensao(' || coalesce(to_char(OLD.dt_suspensao,'dd/mm/yyyy hh24:mi:ss'),'<NULL>') || '/' || coalesce(to_char(NEW.dt_suspensao,'dd/mm/yyyy hh24:mi:ss'),'<NULL>')||'); ',1,2000);
		end if;

		if (coalesce(NEW.dt_inicio, LOCALTIMESTAMP) <> coalesce(OLD.dt_inicio, LOCALTIMESTAMP)) then
			ds_log_w	:= substr(ds_log_w || ' dt_inicio(' || coalesce(to_char(OLD.dt_inicio,'dd/mm/yyyy hh24:mi:ss'),'<NULL>') || '/' || coalesce(to_char(NEW.dt_inicio,'dd/mm/yyyy hh24:mi:ss'),'<NULL>')||'); ',1,2000);
		end if;

		if (coalesce(NEW.ds_horarios,'XPTO') <> coalesce(OLD.ds_horarios,'XPTO')) then
			ds_log_w	:= substr(ds_log_w || ' ds_horarios(' || coalesce(OLD.ds_horarios,'<NULL>') || '/' || coalesce(NEW.ds_horarios,'<NULL>')||'); ',1,2000);
		end if;

		if (coalesce(NEW.hr_prim_horario,'XPTO') <> coalesce(OLD.hr_prim_horario,'XPTO')) then
			ds_log_w	:= substr(ds_log_w || ' hr_prim_horario(' || coalesce(OLD.hr_prim_horario,'<NULL>') || '/' || coalesce(NEW.hr_prim_horario,'<NULL>')||'); ',1,2000);
		end if;

		if (coalesce(NEW.cd_intervalo,'XPTO') <> coalesce(OLD.cd_intervalo,'XPTO')) then
			ds_log_w	:= substr(ds_log_w || ' cd_intervalo(' || coalesce(OLD.cd_intervalo,'<NULL>') || '/' || coalesce(NEW.cd_intervalo,'<NULL>')||'); ',1,2000);
		end if;

		if (coalesce(NEW.ie_alterar_horario,'XPTO') <> coalesce(OLD.ie_alterar_horario,'XPTO')) then
			ds_log_w	:= substr(ds_log_w || ' ie_alterar_horario(' || coalesce(OLD.ie_alterar_horario,'<NULL>') || '/' || coalesce(NEW.ie_alterar_horario,'<NULL>')||'); ',1,2000);
		end if;

		if (coalesce(NEW.nr_ocorrencia,0) <> coalesce(OLD.nr_ocorrencia,0)) then
			ds_log_w	:= substr(ds_log_w || ' nr_ocorrencia(' || coalesce(OLD.nr_ocorrencia,0) || '/' || coalesce(NEW.nr_ocorrencia,0)||'); ',1,2000);
		end if;

		if (coalesce(NEW.cd_perfil_ativo, 0) <> coalesce(OLD.cd_perfil_ativo, 0)) then
			ds_log_w	:= substr(ds_log_w || ' cd_perfil_ativo(' || coalesce(OLD.cd_perfil_ativo, 0) || '/' || coalesce(NEW.cd_perfil_ativo, 0)||'); ',1,2000);
		end if;

		if (ds_log_w is not null) then
			
			if (coalesce(OLD.nr_sequencia, 0) > 0) then
				ds_log_w := substr('Alteracoes(old/new)= ' || ds_log_w,1,2000);
			else
				ds_log_w := substr('Criacao(old/new)= ' || ds_log_w,1,2000);
			end if;
			
			ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
			ds_log_w := substr(ds_log_w ||' FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')'||ds_stack_w,1,2000);
			
			CALL gravar_log_tasy(10007, ds_log_w, NEW.nm_usuario);
		end if;

	exception
	when others then
		ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
		ds_erro_w := substr('EXCEPTION prescr_recomendacao_update_after' || ': ' || sqlerrm(SQLSTATE)||ds_stack_w, 1, 2000);
		
		CALL gravar_log_tasy(10007, ds_erro_w, NEW.nm_usuario);
	end;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_recomendacao_updt_after() FROM PUBLIC;

CREATE TRIGGER prescr_recomendacao_updt_after
	AFTER UPDATE ON prescr_recomendacao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_recomendacao_updt_after();

