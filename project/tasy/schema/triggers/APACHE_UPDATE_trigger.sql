-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS apache_update ON apache CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_apache_update() RETURNS trigger AS $BODY$
DECLARE
  qt_pto_po_urgencia_w double precision	:= 0;
  qt_ano_w             double precision	:= 0;
  qt_pto_art_bic_w     double precision	:= 0;
  qt_reg_w             smallint;
  EXEC_W               varchar(300);
  qt_temp_axilar_w     bigint;
  qt_temp_retal_w      bigint;
ds_erro_w                   varchar(4000);
ds_parametros_w             varchar(4000);
BEGIN
  BEGIN

if (NEW.nr_hora is null) or (NEW.DT_APACHE <> OLD.DT_APACHE) then
	BEGIN  
	NEW.nr_hora	:= (to_char(round(NEW.DT_APACHE,'hh24'),'hh24'))::numeric;
	end;
end if;

if (coalesce(OLD.dt_apache, LOCALTIMESTAMP + interval '10 days') <> NEW.dt_apache) 
	and (NEW.dt_apache is not null)
	then NEW.ds_utc := obter_data_utc(NEW.dt_apache, 'HV');
end if;

if (coalesce(OLD.dt_liberacao,LOCALTIMESTAMP + interval '10 days') <> NEW.dt_liberacao)
	and (NEW.dt_liberacao is not null)
	then NEW.ds_utc_atualizacao := obter_data_utc(NEW.dt_liberacao, 'HV');
end if;

if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
  goto Final;
end if;

if	TG_OP = 'INSERT' then
	NEW.cd_setor_paciente := obter_setor_atendimento(NEW.nr_atendimento);
end if;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_PAL_MEDIA_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_pad,
                                 IN NEW.qt_pas,
                                 OUT NEW.qt_pal_media;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.qt_pad: '||NEW.qt_pad||'-'||':new.qt_pal_media: '||NEW.qt_pal_media);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_PAL_MEDIA_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');

      NEW.qt_pal_media := null;
end;

BEGIN
  EXEC_W := 'BEGIN APACHE_UPDATE_MD_PCK.OBTER_QT_TEMPO_MD(:1,:2,:3,:4,:5,:6); END;';

  EXECUTE EXEC_W USING IN NEW.qt_temp_axilar,
                                 IN NEW.qt_temp_retal,
                                 IN OLD.qt_temp_axilar,
                                 IN OLD.qt_temp_retal,
                                 OUT qt_temp_axilar_w,
                                 OUT qt_temp_retal_w;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.qt_temp_axilar: '||NEW.qt_temp_axilar||'-'||':new.qt_temp_retal: '||NEW.qt_temp_retal||'-'||
                          ':old.qt_temp_axilar: '||OLD.qt_temp_axilar||'-'||':old.qt_temp_retal: '||OLD.qt_temp_retal||'-'||
                          'qt_temp_axilar_w: '||qt_temp_axilar_w||'-'||'qt_temp_retal_w: '||qt_temp_retal_w);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_QT_TEMPO_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      qt_temp_axilar_w := null;
      qt_temp_retal_w  := null;
end;
NEW.qt_temp_axilar := qt_temp_axilar_w;
NEW.qt_temp_retal  := qt_temp_retal_w;

if (coalesce(NEW.qt_escala_glasgow,99) <= 15) then
  BEGIN
    EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_S_ESC_GLASGOW_MEDIA_MD(:1) INTO :RESULT';

    EXECUTE EXEC_W USING IN NEW.qt_escala_glasgow,
                                  OUT NEW.qt_pto_glasgow;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_escala_glasgow: '||NEW.qt_escala_glasgow||'-'||':new.qt_pto_glasgow: '||NEW.qt_pto_glasgow);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_S_ESC_GLASGOW_MEDIA_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
    
        NEW.qt_pto_glasgow := null;
  end;
end if;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_temp_retal,
                                 IN 1,
                                 OUT NEW.qt_pto_temp;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('LINHA 90 :new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_temp_retal: '||NEW.qt_temp_retal||'-'||':new.qt_pto_temp: '||NEW.qt_pto_temp);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_pto_temp := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_pal_media,
                                 IN 2,
                                 OUT NEW.qt_pto_PA_med;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('LINHA 107 :new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_pal_media: '||NEW.qt_pal_media||'-'||':new.qt_pto_PA_med: '||NEW.qt_pto_PA_med);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_pto_PA_med := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_freq_card,
                                 IN 3,
                                 OUT NEW.qt_pto_FC;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('LINHA 124 :new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_freq_card: '||NEW.qt_freq_card||'-'||':new.qt_pto_FC: '||NEW.qt_pto_FC);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_pto_FC := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_freq_resp,
                                 IN 4,
                                 OUT NEW.qt_pto_FR;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('LINHA 141 :new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_freq_resp: '||NEW.qt_freq_resp||'-'||':new.qt_pto_FR: '||NEW.qt_pto_FR);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_pto_FR := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_ph_arterial,
                                 IN 5,
                                 OUT NEW.qt_pto_ph_art;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('LINHA 158 :new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_ph_arterial: '||NEW.qt_ph_arterial||'-'||':new.qt_pto_ph_art: '||NEW.qt_pto_ph_art);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_pto_ph_art := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_sodio_serico,
                                 IN 6,
                                 OUT NEW.qt_pto_sodio_serico;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('LINHA 175 :new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_sodio_serico: '||NEW.qt_sodio_serico||'-'||':new.qt_pto_sodio_serico: '||NEW.qt_pto_sodio_serico);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_pto_sodio_serico := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_potassio_serico,
                                 IN 7,
                                 OUT NEW.qt_pto_pot_serico;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('LINHA 192 :new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_potassio_serico: '||NEW.qt_potassio_serico||'-'||':new.qt_pto_pot_serico: '||NEW.qt_pto_pot_serico);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_pto_pot_serico := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_hematocrito,
                                 IN 8,
                                 OUT NEW.qt_pto_hematocrito;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('LINHA 209 :new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_hematocrito: '||NEW.qt_hematocrito||'-'||':new.qt_pto_hematocrito: '||NEW.qt_pto_hematocrito);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_pto_hematocrito := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_globulos_brancos / 1000,
                                 IN 9,
                                 OUT NEW.qt_pto_glob_branco;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('LINHA 226 :new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_globulos_brancos: '||NEW.qt_globulos_brancos / 1000||'-'||':new.qt_pto_glob_branco: '||NEW.qt_pto_glob_branco);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_pto_glob_branco := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_bicarbonato_serico,
                                 IN 10,
                                 OUT NEW.qt_ponto_bicarb_serico;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('LINHA 243 :new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_bicarbonato_serico: '||NEW.qt_bicarbonato_serico||'-'||':new.qt_ponto_bicarb_serico: '||NEW.qt_ponto_bicarb_serico);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_PONTO_APACHE_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_ponto_bicarb_serico := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_SCORE_CREATININA_MD(:1,:2) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_creatinina,
                                 IN NEW.ie_ira,
                                 OUT NEW.qt_pto_creatinina;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_creatinina: '||NEW.qt_creatinina||'-'||':new.ie_ira: '||NEW.ie_ira||'-'||':new.qt_pto_creatinina: '||NEW.qt_pto_creatinina);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_SCORE_CREATININA_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_pto_creatinina := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_SCORE_OXIG_PAAO2_MD(:1,:2,:3,:4) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_pb,
                                 IN NEW.qt_oxigenacao_fio2,
                                 IN NEW.qt_oxigenacao_pco2, 
                                 IN NEW.qt_oxigenacao_pao2, 
                                 OUT NEW.qt_oxigenacao_paao2;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_pb: '||NEW.qt_pb||'-'||':new.qt_oxigenacao_fio2: '||NEW.qt_oxigenacao_fio2||'-'||':new.qt_oxigenacao_pco2: '||NEW.qt_oxigenacao_pco2||'-'||
                          ':new.qt_oxigenacao_pao2: '||NEW.qt_oxigenacao_pao2||'-'||':new.qt_oxigenacao_paao2: '||NEW.qt_oxigenacao_paao2);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_SCORE_OXIG_PAAO2_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_oxigenacao_paao2 := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_SCORE_PTO_OXIG_MD(:1,:2,:3,:4) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_oxigenacao_fio2,
                                 IN NEW.qt_oxigenacao_paao2,
                                 IN NEW.qt_oxigenacao_pao2, 
                                 IN NEW.qt_oxigenacao_pco2, 
                                 OUT NEW.qt_pto_oxig;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_oxigenacao_fio2: '||NEW.qt_oxigenacao_fio2||'-'||':new.qt_oxigenacao_paao2: '||NEW.qt_oxigenacao_paao2||'-'||':new.qt_oxigenacao_pao2: '||NEW.qt_oxigenacao_pao2||'-'||
                          ':new.qt_oxigenacao_pco2: '||NEW.qt_oxigenacao_pco2||'-'||':new.qt_pto_oxig: '||NEW.qt_pto_oxig);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_SCORE_PTO_OXIG_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_pto_oxig := null;
end;

if (NEW.qt_pto_ph_art is not null) then
	qt_pto_art_bic_w := NEW.qt_pto_ph_art;
else	
	qt_pto_art_bic_w := NEW.qt_ponto_bicarb_serico;
end if;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_S_QT_PONT_VAR_FIS_MD(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10,:11,:12) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_pto_temp,
                                 IN NEW.qt_pto_PA_med,
                                 IN NEW.qt_pto_FC, 
                                 IN NEW.qt_pto_FR, 
                                 IN NEW.qt_pto_oxig,
                                 IN qt_pto_art_bic_w,
                                 IN NEW.qt_pto_sodio_serico,
                                 IN NEW.qt_pto_pot_serico,
                                 IN NEW.qt_pto_creatinina,
                                 IN NEW.qt_pto_hematocrito,
                                 IN NEW.qt_pto_glob_branco,
                                 IN NEW.qt_pto_glasgow,
                                 OUT NEW.QT_PONT_VAR_FISIOLOGICAS;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_pto_temp: '||NEW.qt_pto_temp||'-'||':new.qt_pto_PA_med: '||NEW.qt_pto_PA_med||'-'||':new.qt_pto_FC: '||NEW.qt_pto_FC||'-'||
                          ':new.qt_pto_FR: '||NEW.qt_pto_FR||'-'||':new.qt_pto_oxig: '||NEW.qt_pto_oxig||'-'||'qt_pto_art_bic_w: '||qt_pto_art_bic_w||'-'||
                          ':new.qt_pto_sodio_serico: '||NEW.qt_pto_sodio_serico||'-'||':new.qt_pto_pot_serico: '||NEW.qt_pto_pot_serico||'-'||':new.qt_pto_creatinina: '||NEW.qt_pto_creatinina||'-'||
                          ':new.qt_pto_hematocrito: '||NEW.qt_pto_hematocrito||'-'||':new.qt_pto_glob_branco: '||NEW.qt_pto_glob_branco||'-'||':new.qt_pto_glasgow: '||NEW.qt_pto_glasgow||'-'||
                          ':new.QT_PONT_VAR_FISIOLOGICAS: '||NEW.QT_PONT_VAR_FISIOLOGICAS);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_S_QT_PONT_VAR_FIS_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.QT_PONT_VAR_FISIOLOGICAS := null;
end;

qt_pto_po_urgencia_w		:= 0;
if (NEW.ie_po_urgencia = 'S') then
	qt_pto_po_urgencia_w	:= 0.603;
end if;


if (coalesce(NEW.qt_pont_idade,0) = 0) then
	select	coalesce(max(campo_numerico(obter_idade(dt_nascimento,NEW.dt_apache,'A'))),0)
	into STRICT	qt_ano_w	
	from	pessoa_fisica b,
		atendimento_paciente a
	where	a.nr_atendimento	= NEW.nr_atendimento
	and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica;

  BEGIN
    EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_SCORE_PTO_IDADE_MD(:1) INTO :RESULT';

    EXECUTE EXEC_W USING IN qt_ano_w,
                                  OUT NEW.qt_pont_idade;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          'qt_ano_w: '||qt_ano_w||'-'||':new.qt_pont_idade: '||NEW.qt_pont_idade);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_SCORE_PTO_IDADE_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
    
        NEW.qt_pont_idade := null;
  end;
end if;

select	coalesce(max(qt_pontuacao),0)
into STRICT	NEW.qt_peso_cat_diag
from	apache_categ_diag
where	nr_sequencia	= NEW.nr_seq_cat_diag;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_SCORE_APACHE_II_MD(:1,:2,:3) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_pont_var_fisiologicas,
                                 IN NEW.qt_pont_idade,
                                 IN NEW.qt_pont_doenca_cronica,
                                 OUT NEW.qt_apache_ii;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_pont_var_fisiologicas: '||NEW.qt_pont_var_fisiologicas||'-'||':new.qt_pont_idade: '||NEW.qt_pont_idade||'-'||
                          ':new.qt_pont_doenca_cronica: '||NEW.qt_pont_doenca_cronica||'-'||':new.qt_apache_ii: '||NEW.qt_apache_ii);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_SCORE_APACHE_II_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_apache_ii := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_SCORE_RISCO_CALC_MD(:1) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_apache_ii,
                                 OUT NEW.qt_risco_calculado;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_apache_ii: '||NEW.qt_apache_ii||'-'||':new.qt_risco_calculado: '||NEW.qt_risco_calculado);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_SCORE_RISCO_CALC_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.qt_risco_calculado := null;
end;

BEGIN
  EXEC_W := 'CALL APACHE_UPDATE_MD_PCK.OBTER_SCORE_PR_RISCO_MD(:1,:2,:3) INTO :RESULT';

  EXECUTE EXEC_W USING IN NEW.qt_apache_ii,
                                 IN qt_pto_po_urgencia_w,
                                 IN NEW.qt_peso_cat_diag,
                                 OUT NEW.pr_risco;
exception
  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.dt_apache: '||NEW.dt_apache||'-'||':new.nr_atendimento: '||NEW.nr_atendimento||'-'||
                          ':new.qt_apache_ii: '||NEW.qt_apache_ii||'-'||'qt_pto_po_urgencia_w: '||qt_pto_po_urgencia_w||'-'||
                          ':new.qt_peso_cat_diag: '||NEW.qt_peso_cat_diag||'-'||':new.pr_risco: '||NEW.pr_risco);
      CALL gravar_log_medical_device('APACHE_UPDATE','APACHE_UPDATE_MD_PCK.OBTER_SCORE_PR_RISCO_MD'
                                 ,ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'N');
  
      NEW.pr_risco := null;
end;
<<Final>>
qt_reg_w	:= 0;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_apache_update() FROM PUBLIC;

CREATE TRIGGER apache_update
	BEFORE INSERT OR UPDATE ON apache FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_apache_update();

