-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS proj_rat_atual ON proj_rat CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_proj_rat_atual() RETURNS trigger AS $BODY$
DECLARE

					qt_reg_w		smallint;
					ie_regime_contr_w	varchar(15);
					cd_cargo_w		bigint;
					ie_cobrado_w		varchar(2);

					BEGIN

						if (wheb_usuario_pck.get_ie_executar_trigger = 'N')  then
							goto Final;
						end if;

						if (NEW.ie_paga_rat = 'N') then
							NEW.vl_hora_pagar := 0;
							NEW.vl_pagar := 0;
						end if;

						if (NEW.vl_hora_cobrar is not null) and (NEW.qt_hora_cobrar is not null) then
							NEW.vl_cobrar_cliente	:= NEW.vl_hora_cobrar * NEW.qt_hora_cobrar;
						end if;

						if (NEW.vl_hora_pagar is not null) and (NEW.qt_hora_pagar is not null) then
							NEW.vl_pagar			:= NEW.vl_hora_pagar * NEW.qt_hora_pagar;
						end if;

						if (NEW.dt_aprov_fin is not null) then
							NEW.ie_status_rat			:= 'AF';
						elsif (NEW.dt_rec_fin is not null) then
							NEW.ie_status_rat			:= 'RF';
						elsif (NEW.dt_aprovacao is not null) then
							NEW.ie_status_rat			:= 'AP';
						elsif (NEW.dt_receb_rat is not null) then
							NEW.ie_status_rat			:= 'RP';
						elsif (NEW.dt_liberacao is not null) then
							NEW.ie_status_rat			:= 'LC';
						else
							NEW.ie_status_rat			:= 'PL';
						end if;

						if (NEW.ie_status_rat = 'AF') and (NEW.vl_cobrar_cliente = 0) and (NEW.ie_status_cobrar <> 'NC') then
							CALL Wheb_mensagem_pck.exibir_mensagem_abort(279324);
						end if;

						if (NEW.ie_status_rat = 'AF') and (NEW.vl_cobrar_cliente > 0) and (NEW.ie_status_cobrar = 'SN') then
							CALL Wheb_mensagem_pck.exibir_mensagem_abort(279325);
						end if;

						if (NEW.ie_regime_contr is null) then
							select	max(cc.ie_regime_contr)
							into STRICT	ie_regime_contr_w
							from	com_canal_consultor cc,
							        com_canal ca
							where   ca.nr_sequencia = cc.nr_seq_canal
							and     ca.ie_situacao = 'A'
							and     cc.ie_situacao = 'A'
							and     cc.cd_pessoa_fisica = NEW.cd_executor;

							if (ie_regime_contr_w is not null) then
								NEW.ie_regime_contr := ie_regime_contr_w;
							end if;
						end if;


						if (TG_OP = 'INSERT') then

							select	max(ie_cobrado)
							into STRICT	ie_cobrado_w
							from	proj_cronograma
							where	nr_sequencia = NEW.nr_seq_cronograma;

							if (ie_cobrado_w = 'N') then
								NEW.ie_status_cobrar := 'NC';
							else
								NEW.ie_status_cobrar := 'CV';
							end if;


							select	max(cd_cargo)
							into STRICT	cd_cargo_w
							from	pessoa_fisica
							where	cd_pessoa_fisica = NEW.cd_executor;

							if (cd_cargo_w in (842, 261, 171, 101, 991, 163, 941, 974, 972, 973, 164, 165, 162)) then -- Consultor
								NEW.ie_paga_rat := 'S';
							else
								NEW.ie_paga_rat := 'X';
							end if;
						end if;

						<<Final>>
						qt_reg_w	:= 0;
					RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_proj_rat_atual() FROM PUBLIC;

CREATE TRIGGER proj_rat_atual
	BEFORE INSERT OR UPDATE ON proj_rat FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_proj_rat_atual();

