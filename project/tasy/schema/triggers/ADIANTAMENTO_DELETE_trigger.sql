-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS adiantamento_delete ON adiantamento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_adiantamento_delete() RETURNS trigger AS $BODY$
DECLARE

dt_fechamento_w			timestamp	:= null;
nr_recibo_w			bigint;
nr_seq_cheque_cr_w		bigint;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
if (OLD.nr_seq_caixa_rec is not null) then
	select	max(dt_fechamento),
		max(nr_recibo)
	into STRICT	dt_fechamento_w,
		nr_recibo_w
	from	caixa_receb
	where	nr_sequencia	= OLD.nr_seq_caixa_rec;

	if (dt_fechamento_w is not null) then
		/*r.aise_application_error(-20011,'Nao e possivel excluir o adiantamento! ' || chr(13) ||
					'O recibo ' || nr_recibo_w || ' ja foi fechado!');*/

		CALL wheb_mensagem_pck.exibir_mensagem_abort(267355,'nr_recibo_w='||nr_recibo_w);			
	end if;
end if;	

select	max(nr_seq_cheque)
into STRICT	nr_seq_cheque_cr_w
from	cheque_cr
where	nr_adiantamento	= OLD.nr_adiantamento;

if (nr_seq_cheque_cr_w is not null) then
	/*r.aise_application_error(-20011,'Nao e possivel excluir o adiantamento! ' || chr(10) ||
					'E necessario desvincular o cheque.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(267356);				

end if;	
end if;

RETURN OLD;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_adiantamento_delete() FROM PUBLIC;

CREATE TRIGGER adiantamento_delete
	BEFORE DELETE ON adiantamento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_adiantamento_delete();

