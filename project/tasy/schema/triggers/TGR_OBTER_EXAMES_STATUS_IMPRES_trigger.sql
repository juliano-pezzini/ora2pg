-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS tgr_obter_exames_status_impres ON prescr_procedimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_tgr_obter_exames_status_impres() RETURNS trigger AS $BODY$
declare
    json_presc_w philips_json := philips_json();
    json_data_w text;
    ds_param_integ_res_w text;
    cd_estabelecimento_w bigint;
BEGIN
    if (wheb_usuario_pck.get_ie_executar_trigger <> 'N') and (wheb_usuario_pck.is_evento_ativo(1013) = 'S') then
        if (((coalesce(NEW.ie_status_atend,99) = 13) and (coalesce(OLD.ie_status_atend,99) < 13)) and (NEW.dt_integracao_etiq is null)) then
                cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
                json_presc_w.put('codigoEstabelecimento', cd_estabelecimento_w);
                dbms_lob.createtemporary(lob_loc => json_data_w, cache => true, dur => dbms_lob.call);
                json_presc_w.(json_data_w);
                ds_param_integ_res_w := bifrost.send_integration_content('examWithTagEvent', json_data_w, wheb_usuario_pck.get_nm_usuario);
        end if;
    end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_tgr_obter_exames_status_impres() FROM PUBLIC;

CREATE TRIGGER tgr_obter_exames_status_impres
	AFTER INSERT OR UPDATE OF ie_status_atend ON prescr_procedimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_tgr_obter_exames_status_impres();

