-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS conta_paciente_ret_hist_insert ON conta_paciente_ret_hist CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_conta_paciente_ret_hist_insert() RETURNS trigger AS $BODY$
declare

ie_acao_w		smallint;
vl_hist_old_w		double precision;
vl_hist_atual_w		double precision;

vl_saldo_w		double precision;

ie_situacao_w		varchar(1);
vl_pendente_w		double precision;
vl_reapresentacao_w	double precision;
vl_glosa_devida_w	double precision;
vl_glosa_indevida_w	double precision;
vl_nao_auditado_w	double precision;
vl_inicial_w		double precision;
vl_recebido_w		double precision;
vl_perdas_w		double precision;
vl_nota_credito_w	double precision;

nr_interno_conta_w	bigint;
cd_autorizacao_w	varchar(20);
nr_seq_ret_item_w	bigint;
ie_valor_amaior_w	varchar(1);
cd_estabelecimento_w	smallint;
ds_consistencia_w	varchar(255);
vl_soma_itens_w		double precision;

BEGIN

select	coalesce(max(ie_acao),-1)
into STRICT	ie_acao_w
from	hist_audit_conta_paciente
where	nr_sequencia	= NEW.nr_seq_hist_audit;

select	max(a.nr_interno_conta)
into STRICT	nr_interno_conta_w
from	conta_paciente_retorno a
where	a.nr_sequencia	= NEW.nr_seq_conpaci_ret;

if (ie_acao_w = -1) then
	/* Não existe histórico da auditoria.
	Verifique cadastro de histórico ou desabilite a geração de auditoria!
	Conta: NR_INTERNO_CONTA_W */
	CALL wheb_mensagem_pck.exibir_mensagem_abort(180961,'NR_INTERNO_CONTA_W='||nr_interno_conta_w);
end if;

select	a.ie_situacao,
	a.vl_pendente,
	a.vl_reapresentacao,
	a.vl_glosa_devida,
	a.vl_glosa_indevida,
	a.vl_nao_auditado,
	a.vl_inicial,
	a.nr_interno_conta,
	a.cd_autorizacao,
	a.vl_recebido,
	coalesce(a.vl_perdas, 0),
	b.cd_estabelecimento,
	coalesce(a.vl_nota_credito, 0)
into STRICT	ie_situacao_w,
	vl_pendente_w,
	vl_reapresentacao_w,
	vl_glosa_devida_w,
	vl_glosa_indevida_w,
	vl_nao_auditado_w,
	vl_inicial_w,
	nr_interno_conta_w,
	cd_autorizacao_w,
	vl_recebido_w,
	vl_perdas_w,
	cd_estabelecimento_w,
	vl_nota_credito_w
from 	conta_paciente b,
	conta_paciente_retorno a
where 	a.nr_sequencia		= NEW.nr_seq_conpaci_ret
and	a.nr_interno_conta	= b.nr_interno_conta;

ie_valor_amaior_w := Obter_Param_Usuario(66, 18, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_valor_amaior_w);

vl_hist_old_w		:= coalesce(OLD.vl_historico,0);
vl_hist_atual_w		:= NEW.vl_historico - vl_hist_old_w;

if (vl_hist_atual_w = 0) then
	goto final;
end if;

if (ie_acao_w <> 8) then -- afstringari 179913 22/01/2010
	if (ie_acao_w = 5) then
		vl_pendente_w	:= vl_pendente_w + vl_hist_atual_w;
		if (vl_recebido_w  >= vl_hist_atual_w) then
			vl_recebido_w		:= vl_recebido_w - vl_hist_atual_w;
			vl_hist_atual_w	:= 0;
		else
			vl_hist_atual_w	:= vl_hist_atual_w - vl_recebido_w;
			vl_recebido_w		:= 0;
			vl_inicial_w		:= vl_inicial_w + vl_hist_atual_w;
			vl_hist_atual_w 	:= 0;
		end if;
	end if;

	vl_saldo_w	:= vl_pendente_w + vl_glosa_indevida_w + vl_reapresentacao_w + vl_nao_auditado_w;

	if (coalesce(vl_pendente_w,0) = 0) then
		--A conta #@NR_INTERNO_CONTA_P#@ já está em auditoria. O processo deve ser efetuado pela Conta Paciente Auditoria!
		ds_consistencia_w	:= wheb_mensagem_pck.get_texto(304653,'NR_INTERNO_CONTA_P='|| nr_interno_conta_w);
	end if;

	if (vl_saldo_w < vl_hist_atual_w) then
		/* Valor do histórico supera o valor pendente!
		Guia: cd_autorizacao_w
		Vl saldo: vl_saldo_w
		Vl hist atual: vl_hist_atual_w */
		CALL wheb_mensagem_pck.exibir_mensagem_abort(180962,	'DS_CONSISTENCIA_W='||ds_consistencia_w||';'||
								'CD_AUTORIZACAO_W='||cd_autorizacao_w||';'||
								'VL_SALDO_W='||vl_saldo_w||';'||
								'VL_HIST_ATUAL_W='||vl_hist_atual_w);
	else
		if (ie_acao_w = 0) then
			if (vl_pendente_w < vl_hist_atual_w) then
				/* O histórico de não auditado só pode ser lançado caso não tenha sido lançado outros históricos.
				Guia: cd_autorizacao_w */
				CALL wheb_mensagem_pck.exibir_mensagem_abort(180967,	'CD_AUTORIZACAO_W='||cd_autorizacao_w);
			else
				vl_pendente_w	:= vl_pendente_w - vl_hist_atual_w;
			end if;
		elsif (ie_acao_w = 7) then
			vl_pendente_w		:= vl_pendente_w - vl_hist_atual_w;
		elsif (ie_acao_w = 9) then
			vl_pendente_w		:= vl_pendente_w - vl_hist_atual_w;
		elsif (ie_acao_w <> 5) then
			if (vl_pendente_w >= vl_hist_atual_w) then
				vl_pendente_w	:= vl_pendente_w - vl_hist_atual_w;
				vl_hist_atual_w	:= 0;
			else
				vl_hist_atual_w	:= vl_hist_atual_w - vl_pendente_w;
				vl_pendente_w	:= 0;

				if (ie_acao_w <> 2) and (vl_reapresentacao_w >= vl_hist_atual_w) then
					vl_reapresentacao_w	:= vl_reapresentacao_w - vl_hist_atual_w;
					vl_hist_atual_w		:= 0;
				else
					if (ie_acao_w <> 2) then
						vl_hist_atual_w		:= vl_hist_atual_w - vl_reapresentacao_w;
						vl_reapresentacao_w	:= 0;
					end if;

					if (ie_acao_w <> 4) and (vl_glosa_indevida_w >= vl_hist_atual_w) then
						vl_glosa_indevida_w	:= vl_glosa_indevida_w - vl_hist_atual_w;
						vl_hist_atual_w		:= 0;
					else
						if (ie_acao_w <> 4) then
							vl_hist_atual_w	:= vl_hist_atual_w - vl_reapresentacao_w;
							vl_glosa_indevida_w	:= 0;
						end if;

						if (vl_nao_auditado_w >= vl_hist_atual_w) then
							vl_nao_auditado_w	:= vl_nao_auditado_w - vl_hist_atual_w;
							vl_hist_atual_w	:= 0;
						else
							/* Valor do histórico supera o valor pendente!
							Guia: cd_autorizacao_w */
							CALL wheb_mensagem_pck.exibir_mensagem_abort(180970,	'CD_AUTORIZACAO_W='||cd_autorizacao_w);
						end if;
					end if;
				end if;
			end if;
		end if;
	end if;

	if (ie_acao_w = 0) then
		vl_nao_auditado_w	:= vl_nao_auditado_w + NEW.vl_historico - vl_hist_old_w;
	elsif (ie_acao_w = 1) then
		vl_recebido_w		:= vl_recebido_w + NEW.vl_historico - vl_hist_old_w;
	elsif (ie_acao_w = 2) then
		vl_reapresentacao_w	:= vl_reapresentacao_w + NEW.vl_historico - vl_hist_old_w;
	elsif (ie_acao_w = 3) then
		vl_glosa_devida_w	:= vl_glosa_devida_w + NEW.vl_historico - vl_hist_old_w;
	elsif (ie_acao_w = 4) then
		vl_glosa_indevida_w	:= vl_glosa_indevida_w + NEW.vl_historico - vl_hist_old_w;
	elsif (ie_acao_w = 7) then
		vl_perdas_w		:= vl_perdas_w + NEW.vl_historico - vl_hist_old_w;
	elsif (ie_acao_w = 9) then
		vl_nota_credito_w	:= NEW.vl_historico - vl_hist_old_w;
	end if;

	vl_soma_itens_w	:= vl_pendente_w + vl_glosa_devida_w + vl_glosa_indevida_w + vl_recebido_w + vl_reapresentacao_w + vl_nao_auditado_w + vl_perdas_w + vl_nota_credito_w;

	if (vl_soma_itens_w <> vl_inicial_w) and (coalesce(ie_valor_amaior_w,'N') = 'N') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(180971,	'CD_AUTORIZACAO_W='||cd_autorizacao_w||';'||
								'NR_INTERNO_CONTA_W='||nr_interno_conta_w||';'||
								'VL_SOMA_ITENS_W='||vl_soma_itens_w||';'||
								'VL_INICIAL_W='||vl_inicial_w||';'||
								'VL_PENDENTE_W='||vl_pendente_w||';'||
								'VL_GLOSA_DEVIDA_W='||vl_glosa_devida_w||';'||
								'VL_GLOSA_INDEVIDA_W='||vl_glosa_indevida_w||';'||
								'VL_RECEBIDO_W='||vl_recebido_w||';'||
								'VL_REAPRESENTACAO_W='||vl_reapresentacao_w||';'||
								'VL_NAO_AUDITADO_W='||vl_nao_auditado_w||';'||
								'VL_PERDAS_W='||vl_perdas_w||';'||
								'VL_NOTA_CREDITO_W='||vl_nota_credito_w);
	end if;
end if;

if (vl_pendente_w = 0) and (vl_glosa_indevida_w = 0) and (vl_reapresentacao_w = 0)  and (vl_nao_auditado_w = 0) then
	ie_situacao_w := 'F';
end if;

if (NEW.nr_seq_ret_item is null) then
	select 	max(a.nr_sequencia)
	into STRICT 	nr_seq_ret_item_w
	from	convenio_retorno b,
		convenio_retorno_item a
	where 	a.nr_seq_retorno	= b.nr_sequencia
	and 	b.ie_status_retorno	= 'F'
	and 	nr_interno_conta	= nr_interno_conta_w
	and 	cd_autorizacao		= cd_autorizacao_w;

	NEW.nr_seq_ret_item 		:= nr_seq_ret_item_w;
end if;

update conta_paciente_retorno
set	ie_situacao 		= ie_situacao_w,
	vl_pendente 		= vl_pendente_w,
	vl_reapresentacao	= vl_reapresentacao_w,
	vl_glosa_devida		= vl_glosa_devida_w,
	vl_glosa_indevida	= vl_glosa_indevida_w,
	vl_nao_auditado 	= vl_nao_auditado_w,
	vl_recebido		= vl_recebido_w,
	vl_inicial		= vl_inicial_w,
	vl_perdas		= vl_perdas_w,
	vl_nota_credito		= vl_nota_credito_w
where nr_sequencia 		= NEW.nr_seq_conpaci_ret;

 <<final>>

vl_inicial_w := vl_inicial_w;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_conta_paciente_ret_hist_insert() FROM PUBLIC;

CREATE TRIGGER conta_paciente_ret_hist_insert
	BEFORE INSERT OR UPDATE ON conta_paciente_ret_hist FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_conta_paciente_ret_hist_insert();

