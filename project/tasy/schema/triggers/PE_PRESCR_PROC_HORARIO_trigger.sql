-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pe_prescr_proc_horario ON pe_prescr_proc CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pe_prescr_proc_horario() RETURNS trigger AS $BODY$
declare
qt_reg_w	bigint;
BEGIN
  BEGIN

BEGIN	
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;

if (NEW.DT_PRIMEIRO_HORARIO IS NOT NULL AND (NEW.DT_PRIMEIRO_HORARIO <> OLD.DT_PRIMEIRO_HORARIO OR OLD.DT_PRIMEIRO_HORARIO IS NULL)) then

	NEW.HR_PRIM_HORARIO := LPAD(PKG_DATE_UTILS.extract_field('HOUR', NEW.dt_primeiro_horario), 2, 0) || ':' || LPAD(PKG_DATE_UTILS.extract_field('MINUTE', NEW.dt_primeiro_horario), 2, 0);

elsif (NEW.HR_PRIM_HORARIO is not null and (NEW.HR_PRIM_HORARIO <> OLD.HR_PRIM_HORARIO OR OLD.HR_PRIM_HORARIO IS NULL))then

    NEW.dt_primeiro_horario := PKG_DATE_UTILS.get_time(NEW.dt_atualizacao, NEW.HR_PRIM_HORARIO || ':00');

end if;

if (NEW.HR_HORARIO_ESPEC is null) then

		NEW.dt_horario_espec := null;
		
-- Feito para HTML pois o componente seta o dia/mes/ano errado

elsif ((NEW.IE_INTERV_ESPEC_AGORA = 'S') and (NEW.DT_HORARIO_ESPEC is not null) and ((NEW.DT_HORARIO_ESPEC <> OLD.DT_HORARIO_ESPEC)  or (NEW.DT_HORARIO_ESPEC is not null) and (OLD.DT_HORARIO_ESPEC is null)))then

   NEW.DT_HORARIO_ESPEC := pkg_date_utils.get_time(NEW.DT_ATUALIZACAO,pkg_date_utils.extract_field('HOUR',NEW.DT_HORARIO_ESPEC) || ':'|| pkg_date_utils.extract_field('MINUTE',NEW.DT_HORARIO_ESPEC));
   NEW.HR_HORARIO_ESPEC := pkg_date_utils.extract_field('HOUR',NEW.DT_HORARIO_ESPEC) || ':'|| lpad(pkg_date_utils.extract_field('MINUTE',NEW.DT_HORARIO_ESPEC),2,'0');

-- So ira entrar nesse elsif registros de JAVA e DELPHI

elsif	((NEW.IE_INTERV_ESPEC_AGORA = 'S') and ((NEW.HR_HORARIO_ESPEC <> OLD.HR_HORARIO_ESPEC) or
	(NEW.HR_HORARIO_ESPEC is not null AND OLD.HR_HORARIO_ESPEC is null))) then

		NEW.dt_horario_espec :=  to_date(to_char(LOCALTIMESTAMP,'dd/mm/yyyy') ||':'|| NEW.HR_HORARIO_ESPEC,'dd/mm/yyyy hh24:mi');

end if;

exception
	when others then
	null;
end;

<<Final>>
qt_reg_w	:= 0;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pe_prescr_proc_horario() FROM PUBLIC;

CREATE TRIGGER pe_prescr_proc_horario
	BEFORE INSERT OR UPDATE ON pe_prescr_proc FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pe_prescr_proc_horario();

