-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_child_pugh_atual ON escala_child_pugh CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_child_pugh_atual() RETURNS trigger AS $BODY$
declare

  qt_reg_w        smallint;
  sql_w           varchar(200);
  qt_pontuacao_w  smallint;
  pr_sobrevida1_w smallint;
  pr_sobrevida2_w smallint;
BEGIN
  BEGIN
  if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
    BEGIN
	  NEW.nr_hora := (to_char(round(NEW.DT_AVALIACAO,'hh24'), 'hh24'))::numeric;
    end;
  end if;
  if (wheb_usuario_pck.get_ie_executar_trigger	= 'N') then
    goto Final;
  end if;
  /** Medical Device **/

  BEGIN
    sql_w := 'begin OBTER_SCORE_ESC_CHILD_PUGH_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9); end;';
    EXECUTE sql_w using in NEW.ie_bilirrubina,
                                  in NEW.ie_albumina,
                                  in NEW.ie_inr,
                                  in NEW.ie_ascite,
                                  in NEW.ie_quick,
                                  in NEW.ie_encefalopatia_hepatica,
                                  out qt_pontuacao_w,
                                  out pr_sobrevida1_w,
                                  out pr_sobrevida2_w;
  exception
    when others then
      qt_pontuacao_w := null;
      pr_sobrevida1_w := null;
      pr_sobrevida2_w := null;
  end;

  NEW.qt_pontuacao	:= qt_pontuacao_w;
  NEW.pr_sobrevida1 := pr_sobrevida1_w;
  NEW.pr_sobrevida2 := pr_sobrevida2_w;

  <<Final>>
  qt_reg_w := 0;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_child_pugh_atual() FROM PUBLIC;

CREATE TRIGGER escala_child_pugh_atual
	BEFORE INSERT OR UPDATE ON escala_child_pugh FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_child_pugh_atual();

