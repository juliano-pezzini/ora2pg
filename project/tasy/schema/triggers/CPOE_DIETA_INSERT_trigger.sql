-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cpoe_dieta_insert ON cpoe_dieta CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cpoe_dieta_insert() RETURNS trigger AS $BODY$
DECLARE



ds_etapa_w 	   varchar(200) := wheb_mensagem_pck.get_texto(307054);
BEGIN
ds_etapa_w := substr(ds_etapa_w, 1, position(' ' in ds_etapa_w));

NEW.ds_stack	:= substr(dbms_utility.format_call_stack,1,2000);

if (NEW.ds_horarios is null)  then

	CALL gravar_log_tasy(10007,
					' DIETA_REMOVEU_HORARIOS Seq: ' || NEW.nr_sequencia ||
					' :new.ie_tipo_dieta:' 		|| NEW.ie_tipo_dieta ||
					' :old.ie_tipo_dieta:' 		|| OLD.ie_tipo_dieta ||
					' :new.ie_administracao:' 		|| NEW.ie_administracao ||
					' :old.ie_administracao:' 		|| OLD.ie_administracao ||
					' :new.ds_horarios:' 		|| NEW.ds_horarios ||
					' :old.ds_horarios:' 		|| OLD.ds_horarios,
				NEW.nm_usuario);		
end if;

if (NEW.cd_perfil_ativo is null)  then
	NEW.cd_perfil_ativo := obter_perfil_ativo;
end if;

if (coalesce(NEW.ie_retrogrado, 'N') = 'S') then
	NEW.dt_prox_geracao := coalesce(NEW.dt_inicio, LOCALTIMESTAMP);
end if;

if (NEW.cd_funcao_origem = 924 and position(ds_etapa_w in (NEW.ds_horarios)) > 0) then
	NEW.ds_horarios := trim(both replace(padroniza_horario_prescr(NEW.ds_horarios,NULL),'A',''));
end if;

if (NEW.nr_seq_cpoe_anterior is not null and NEW.dt_liberacao is null and NEW.cd_funcao_origem = 2314) then
	NEW.dt_liberacao_enf := null;
	NEW.dt_liberacao_farm := null;
	NEW.nm_usuario_lib_enf := null;
	NEW.nm_usuario_lib_farm := null;
	NEW.cd_farmac_lib := null;
end if;

if (NEW.nr_cirurgia is not null) and (NEW.ie_tipo_prescr_cirur is null) then
	NEW.ie_tipo_prescr_cirur := 2;
end if;

if (NEW.ie_duracao <> 'P') and (NEW.ie_duracao <> 'R') then
	NEW.dt_fim := null;
end if;

-- When two or more people save a nutrition toghether, the second record get the username of first record 

if ((NEW.dt_liberacao is null) and (NEW.nm_usuario <> NEW.nm_usuario_nrec) and (NEW.dt_atualizacao = NEW.dt_atualizacao_nrec)) then
	NEW.nm_usuario := NEW.nm_usuario_nrec;
end if;

RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cpoe_dieta_insert() FROM PUBLIC;

CREATE TRIGGER cpoe_dieta_insert
	BEFORE INSERT ON cpoe_dieta FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cpoe_dieta_insert();

