-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS mat_estrutura_cadastro_insert ON mat_estrutura_cadastro CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_mat_estrutura_cadastro_insert() RETURNS trigger AS $BODY$
declare

cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
nr_seq_estrut_int_w		parametros_farmacia.nr_seq_estrut_int%type;
ds_param_integ_hl7_w	varchar(4000) := '';
ie_supply_point_w		varchar(1);
ie_athena_w				varchar(1);
qt_estrut_regra_w		bigint;
ie_enviar_mat_estoque_w	varchar(1) := 'N';
BEGIN
  BEGIN

BEGIN
select	b.cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	mat_estrutura a,
	mat_tipo_estrutura b
where	a.nr_sequencia = NEW.nr_seq_estrutura
and	b.nr_sequencia = a.nr_seq_tipo;
exception
when others then
	cd_estabelecimento_w := 1;
end;

select	coalesce(max(nr_seq_estrut_int),0),
		coalesce(max(ie_enviar_mat_estoque), 'N')
into STRICT	nr_seq_estrut_int_w,
		ie_enviar_mat_estoque_w
from	parametros_farmacia
where	cd_estabelecimento = cd_estabelecimento_w;

BEGIN
select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_supply_point_w
from	far_setores_integracao
where	nr_seq_empresa_int = 82  LIMIT 1;
exception
when others then
	ie_supply_point_w := 'N';
end;

BEGIN
select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_athena_w
from	far_setores_integracao
where	nr_seq_empresa_int = 221  LIMIT 1;
exception
when others then
	ie_athena_w := 'N';
end;

select	count(*)
into STRICT	qt_estrut_regra_w
from	estrutura_interna_disp a
where (cd_estabelecimento_w is null or a.cd_estabelecimento = cd_estabelecimento_w)
and 	a.nr_seq_estrutura = NEW.nr_seq_estrutura;

if	((ie_supply_point_w = 'S') or (ie_athena_w = 'S')) and
	((NEW.nr_seq_estrutura = nr_seq_estrut_int_w) or (qt_estrut_regra_w > 0)) then
	
	if (ie_supply_point_w = 'S') then
		ds_param_integ_hl7_w := 'cd_material=' || NEW.cd_material || obter_separador_bv
							 || 'ie_enviar_mat_estoque=' || ie_enviar_mat_estoque_w || obter_separador_bv;
	else
		ds_param_integ_hl7_w := 'cd_material=' || NEW.cd_material || obter_separador_bv;
	end if;
	--swisslog_gerar_integracao(438,ds_param_integ_hl7_w);

	CALL gravar_agend_integracao(438,ds_param_integ_hl7_w);
end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_mat_estrutura_cadastro_insert() FROM PUBLIC;

CREATE TRIGGER mat_estrutura_cadastro_insert
	AFTER INSERT ON mat_estrutura_cadastro FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_mat_estrutura_cadastro_insert();

