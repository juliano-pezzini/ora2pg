-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS comunic_interna_update ON comunic_interna CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_comunic_interna_update() RETURNS trigger AS $BODY$
DECLARE

nr_sequencia_w		bigint;
nm_usuario_oculto_w		varchar(255);
ie_tipo_w			varchar(255);
ie_usuario_oculto_destino_w	varchar(255);

BEGIN

if (OLD.nm_usuario <> NEW.nm_usuario) then
	-- Não é possível alterar uma comunicação interna de outro usuário!
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266912);
end if;

select	max(coalesce(vl_parametro, vl_parametro_padrao))
into STRICT	nm_usuario_oculto_w
from	funcao_parametro
where	cd_funcao		= 87
and	nr_sequencia		= 12;

select	coalesce(max(ie_tipo),'C')
into STRICT	ie_tipo_w
from	comunic_interna_classif
where	nr_sequencia		= NEW.nr_seq_classif;

if (nm_usuario_oculto_w is not null) and (ie_tipo_w 		<> 'G') and (NEW.ie_gerencial	<> 'S') then
	/* Francisco - OS 60685 - Quando o usuário oculto estiver na lista destino deve aparecer entre os que leram */

	ie_usuario_oculto_destino_w := position(nm_usuario_oculto_w in NEW.nm_usuario_destino);
	if ( ie_usuario_oculto_destino_w = 0 ) then
		NEW.nm_usuario_oculto	:= nm_usuario_oculto_w;
	end if;
else
	NEW.nm_usuario_oculto	:= null;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_comunic_interna_update() FROM PUBLIC;

CREATE TRIGGER comunic_interna_update
	BEFORE UPDATE ON comunic_interna FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_comunic_interna_update();

