-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_pac_dispositivo_aft_ins ON atend_pac_dispositivo CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_pac_dispositivo_aft_ins() RETURNS trigger AS $BODY$
declare

cd_pessoa_fisica_w			varchar(10);

nr_seq_regra_w				wl_regra_item.nr_sequencia%type;
qt_tempo_normal_w			wl_regra_item.qt_tempo_normal%type;

nr_seq_tipo_adm_fat_atd_w	atendimento_paciente.nr_seq_tipo_admissao_fat%type;
ie_tipo_atendimento_w		atendimento_paciente.ie_tipo_atendimento%type;
nr_seq_episodio_w			atendimento_paciente.nr_seq_episodio%type;
nr_seq_tipo_adm_fat_tsk_w	wl_regra_item.nr_seq_tipo_admissao_fat%type;
ie_gerar_pendencia_tl_w		subtipo_episodio.ie_gerar_pendencia%type;
	
C01 CURSOR FOR
	SELECT	coalesce(b.qt_tempo_normal, 0),
			coalesce(b.nr_sequencia, 0)
	from 	wl_regra_worklist a,
			wl_regra_item b
	where	a.nr_sequencia = b.nr_seq_regra
	and		b.ie_situacao = 'A'
	and		a.nr_seq_item = (	SELECT	max(x.nr_sequencia)
								from	wl_item x
								where	x.nr_sequencia = a.nr_seq_item
								and		x.cd_categoria = 'TL'
								and		x.ie_situacao = 'A');

BEGIN

select	max(cd_pessoa_fisica),
		max(nr_seq_tipo_admissao_fat),
		max(ie_tipo_atendimento),
		max(nr_seq_episodio)
into STRICT	cd_pessoa_fisica_w,
		nr_seq_tipo_adm_fat_atd_w,
		ie_tipo_atendimento_w,
		nr_seq_episodio_w
from	atendimento_paciente
where	nr_atendimento = NEW.nr_atendimento;

if (NEW.dt_retirada is null) then
	open C01;
	loop
	fetch C01 into
		qt_tempo_normal_w,
		nr_seq_regra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		BEGIN
			
			if (qt_tempo_normal_w > 0 and obter_se_regra_geracao(nr_seq_regra_w,nr_seq_episodio_w,nr_seq_tipo_adm_fat_atd_w) = 'S') then
				-- Gera Tarefa no Worklist para dispositivos

				CALL wl_gerar_finalizar_tarefa('TL','I',NEW.nr_atendimento,cd_pessoa_fisica_w,NEW.nm_usuario,coalesce(NEW.dt_retirada_prev,LOCALTIMESTAMP+(qt_tempo_normal_w/24)),'N',
											null,NEW.nr_sequencia,null,null,null,null,null,null,null,nr_seq_regra_w,null,null,null,null,null,null,null,NEW.dt_retirada_prev,nr_seq_episodio_w);
			end if;
		end;
	end loop;
	close C01;
end if;

RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_pac_dispositivo_aft_ins() FROM PUBLIC;

CREATE TRIGGER atend_pac_dispositivo_aft_ins
	AFTER INSERT ON atend_pac_dispositivo FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_pac_dispositivo_aft_ins();

