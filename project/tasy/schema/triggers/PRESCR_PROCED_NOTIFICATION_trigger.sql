-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_proced_notification ON prescr_procedimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_proced_notification() RETURNS trigger AS $BODY$
declare

vl_parametro_w  varchar(255);
ie_laboratorio_w  varchar(1);
cd_pessoa_fisica_w  pessoa_fisica.cd_pessoa_fisica%type;
ie_notification_type_w varchar(1);
nr_sequencia_laudo_paciente_w bigint;

BEGIN

cd_pessoa_fisica_w := obter_valores_prescr_trigger(NEW.nr_prescricao,'PF');

--select nvl(max('S'),'N')

--into ie_laboratorio_w

--from exame_laboratorio a

--where rownum = 1

--and  a.ie_formato_resultado in ('SM','SDM')

--and  a.nr_seq_exame = :new.nr_seq_exame;

select coalesce(max('S'),'N')
into STRICT ie_laboratorio_w
from exame_laboratorio a where  ie_anatomia_patologica = 'N'
and  a.nr_seq_exame = NEW.nr_seq_exame LIMIT 1;

if (ie_laboratorio_w = 'S') then
 ie_notification_type_w := 'L';
 vl_parametro_w := tws_obter_param_tipo_login('1',9114,1);
elsif (obter_se_exame_anatomo_patol(NEW.nr_seq_exame) = 'S') then
 ie_notification_type_w := 'P';
 vl_parametro_w := tws_obter_param_tipo_login('1',9114,3);
else
 ie_notification_type_w := 'R';
 vl_parametro_w := tws_obter_param_tipo_login('1',9114,2);
end if;

if (vl_parametro_w = 41) then
 vl_parametro_w := 45;
end if;


if (ie_notification_type_w = 'L') then
 if (NEW.ie_status_atend >= vl_parametro_w) and (OLD.ie_status_atend < vl_parametro_w) then

  CALL wsuite_add_notification(ie_notification_type_w,NEW.nr_prescricao, NEW.nr_sequencia, NEW.nm_usuario, cd_pessoa_fisica_w,NEW.nr_sequencia);

 elsif (OLD.ie_status_atend >= vl_parametro_w) and (NEW.ie_status_atend < vl_parametro_w) then

  CALL wsuite_remove_notification(ie_notification_type_w,NEW.nr_prescricao,NEW.nr_sequencia);

 end if;
else

 if (NEW.ie_status_execucao >= vl_parametro_w) and (OLD.ie_status_execucao < vl_parametro_w) then
  CALL wsuite_add_notification(ie_notification_type_w,NEW.nr_prescricao, NEW.nr_sequencia, NEW.nm_usuario, cd_pessoa_fisica_w,NEW.nr_sequencia);

 elsif (OLD.ie_status_execucao >= vl_parametro_w) and (NEW.ie_status_execucao < vl_parametro_w) then
  CALL wsuite_remove_notification(ie_notification_type_w,NEW.nr_prescricao,NEW.nr_sequencia);

 end if;
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_proced_notification() FROM PUBLIC;

CREATE TRIGGER prescr_proced_notification
	BEFORE UPDATE ON prescr_procedimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_proced_notification();

