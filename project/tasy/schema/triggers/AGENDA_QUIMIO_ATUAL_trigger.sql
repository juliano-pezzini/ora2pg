-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS agenda_quimio_atual ON agenda_quimio CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_agenda_quimio_atual() RETURNS trigger AS $BODY$
declare

atrib_oldvalue_w		varchar(255);
atrib_newvalue_w		varchar(255);
cd_estabelecimento_w	numeric(20);
nr_seq_pac_senha_fila_w bigint;
BEGIN

if	((OLD.ie_status_agenda is not null) and (NEW.ie_status_agenda is not null) and (OLD.ie_status_agenda <> NEW.ie_status_agenda)) and (NEW.nr_seq_pend_agenda is not null) then
			
	atrib_oldvalue_w := substr(obter_valor_dominio(3192,OLD.ie_status_agenda),1,255);
	atrib_newvalue_w := substr(obter_valor_dominio(3192,NEW.ie_status_agenda),1,255);
	
	CALL gerar_agenda_quimio_hist(NEW.nr_sequencia,OLD.cd_pessoa_fisica, wheb_mensagem_pck.get_texto(791793,
												'DS_ATRIB_OLDVALUE='||atrib_oldvalue_w ||
												';DS_ATRIB_NEWVALUE='||atrib_newvalue_w), OLD.dt_agenda,NEW.nm_usuario);
	
	/*gravar logs de alteracoes(USJCCT)*/

	insert into agenda_quimio_log(NR_SEQUENCIA,
					 DT_ATUALIZACAO,
                     --NR_SEQ_MEDICACAO,
                     --CD_PROTOCOLO,
					 NM_USUARIO,
					 DT_ATUALIZACAO_NREC,
					 NM_USUARIO_NREC,   
					 DS_LOG,       
					 NR_SEQ_PEND_AGENDA,
					 DT_LOG,
					 DS_STACK)
				values (nextval('agenda_quimio_log_seq'),
					LOCALTIMESTAMP,
					NEW.nm_usuario,
					LOCALTIMESTAMP,
					OLD.nm_usuario,
					substr(	wheb_mensagem_pck.get_texto(791795,
							'DS_ATRIB_OLDVALUE='||atrib_oldvalue_w ||
							';DS_ATRIB_NEWVALUE='||atrib_newvalue_w ||
							';DS_MOTIVO_STATUS='||NEW.ds_motivo_status||
                            --';NR_SEQ_MEDICACAO='||:new.nr_seq_medicacao||
                            --';CD_PROTOCOLO=' ||:new.cd_protocolo||
							';CD_PESSOA_FISICA_OLD='||OLD.cd_pessoa_fisica)||chr(10)||
						wheb_mensagem_pck.get_texto(791797,
							'NR_SEQ_PEND_AGENDA='||NEW.nr_seq_pend_agenda ||
							';NR_SEQ_LOCAL='||NEW.nr_seq_local ||
							';DT_CANCELADA='||NEW.dt_cancelada||
							';NR_SEQ_MOT_CANCELAMENTO='||NEW.nr_seq_mot_cancelamento)||chr(10)||
							wheb_mensagem_pck.get_texto(799798) || ': '||NEW.nr_sequencia||'/'||NEW.nr_seq_atendimento,1,4000),
					NEW.nr_seq_pend_agenda,
					LOCALTIMESTAMP,
					substr(	wheb_mensagem_pck.get_texto(791798,
							'DS_FUNCAO_ATIVA='||obter_funcao_Ativa ||
							';DS_PERFIL='||obter_perfil_ativo) || ' -  Stack' || dbms_utility.format_call_stack, 1,4000));
				
end if;

if 	((NEW.ie_status_agenda is not null AND NEW.ie_status_agenda = 'C' AND OLD.ie_status_agenda <> NEW.ie_status_agenda) and
	((OLD.nr_seq_atendimento is not null) or (NEW.nr_seq_atendimento is not null))) then
	delete FROM agenda_quimio_marcacao where nr_seq_atendimento = coalesce(NEW.nr_seq_atendimento,OLD.nr_seq_atendimento);
	
	delete FROM w_agenda_quimio where nr_seq_atendimento = coalesce(NEW.nr_seq_atendimento,OLD.nr_seq_atendimento);
end if;

if (OLD.ie_status_agenda is null) and (NEW.ie_status_agenda is not null) and (NEW.ie_status_agenda = 'N') then
		
	atrib_oldvalue_w := substr(obter_valor_dominio(3192,OLD.ie_status_agenda),1,255);
	atrib_newvalue_w := substr(obter_valor_dominio(3192,NEW.ie_status_agenda),1,255);
	
	CALL gerar_agenda_quimio_hist(NEW.nr_sequencia,OLD.cd_pessoa_fisica, wheb_mensagem_pck.get_texto(791799), NEW.dt_agenda,NEW.nm_usuario);
	
end if;

if  ((OLD.dt_agenda is not null) and (trunc(OLD.dt_agenda) <> OLD.dt_agenda) and (OLD.dt_agenda <> NEW.dt_agenda)) or
	(OLD.nr_seq_local is not null AND OLD.nr_seq_local <> NEW.nr_seq_local) or
	(OLD.nr_minuto_duracao is not null AND OLD.nr_minuto_duracao <> NEW.nr_minuto_duracao)	then	
	
	delete	FROM agenda_quimio_marcacao
	where 	dt_Agenda between trunc(coalesce(OLD.dt_agenda,NEW.dt_agenda)) and trunc(coalesce(OLD.dt_agenda,NEW.dt_agenda))+86399/86400 
	and 	nr_seq_agenda = coalesce(NEW.nr_sequencia, OLD.nr_sequencia);
			
	delete	FROM w_agenda_quimio
	where	dt_horario between trunc(coalesce(OLD.dt_agenda,NEW.dt_agenda)) and trunc(coalesce(OLD.dt_agenda,NEW.dt_agenda))+86399/86400
	and		nr_seq_agequi = coalesce(NEW.nr_sequencia, OLD.nr_sequencia);

end if;

if (OLD.dt_agenda is not null) and (NEW.dt_agenda is not null) and (OLD.dt_agenda <> NEW.dt_agenda)  then
	
	atrib_oldvalue_w := to_char(OLD.dt_agenda,'dd/mm/yyyy hh24:mi');
	atrib_newvalue_w := to_char(NEW.dt_agenda,'dd/mm/yyyy hh24:mi');
	
	CALL gerar_agenda_quimio_hist(NEW.nr_sequencia,OLD.cd_pessoa_fisica, wheb_mensagem_pck.get_texto(791800,
												'DS_ATRIB_OLDVALUE='||atrib_oldvalue_w ||
												';DS_ATRIB_NEWVALUE='||atrib_newvalue_w), OLD.dt_agenda,NEW.nm_usuario);
	
	if (NEW.nr_seq_pend_agenda is not null) then
		/*gravar logs de alteracoes(USJCCT)*/

		insert into agenda_quimio_log(NR_SEQUENCIA,
						 DT_ATUALIZACAO,
                         --NR_SEQ_MEDICACAO,
                         --CD_PROTOCOLO,
						 NM_USUARIO,
						 DT_ATUALIZACAO_NREC,
						 NM_USUARIO_NREC,   
						 DS_LOG,       
						 NR_SEQ_PEND_AGENDA,
						 DT_LOG,
						 DS_STACK)
					values (nextval('agenda_quimio_log_seq'),
						LOCALTIMESTAMP,
						NEW.nm_usuario,
						LOCALTIMESTAMP,
						OLD.nm_usuario,
						substr(	wheb_mensagem_pck.get_texto(791801,
									'DS_ATRIB_OLDVALUE='||atrib_oldvalue_w ||
									';DS_ATRIB_NEWVALUE='||atrib_newvalue_w ||
									';DS_MOTIVO_STATUS='||NEW.ds_motivo_status||
                                    --';NR_SEQ_MEDICACAO='||:new.nr_seq_medicacao||
                                    --';CD_PROTOCOLO=' ||:new.cd_protocolo||
									';CD_PESSOA_FISICA_OLD='||OLD.cd_pessoa_fisica)||chr(10)||
							wheb_mensagem_pck.get_texto(791797,
									'NR_SEQ_PEND_AGENDA='||NEW.nr_seq_pend_agenda ||
									';NR_SEQ_LOCAL='||NEW.nr_seq_local ||
									';DT_CANCELADA='||NEW.dt_cancelada||
									';NR_SEQ_MOT_CANCELAMENTO='||NEW.nr_seq_mot_cancelamento)||chr(10)||
									wheb_mensagem_pck.get_texto(799798) || ': '||NEW.nr_sequencia||'/'||NEW.nr_seq_atendimento,1,4000),
						NEW.nr_seq_pend_agenda,
						LOCALTIMESTAMP,
						substr(wheb_mensagem_pck.get_texto(791798,
							'DS_FUNCAO_ATIVA='||obter_funcao_Ativa ||
							';DS_PERFIL='||obter_perfil_ativo) || ' -  Stack' || dbms_utility.format_call_stack, 1,4000)
						);
											
	end if;
end if;


if (OLD.ie_status_Agenda is null) and (NEW.ie_status_agenda is not null) and (NEW.nr_seq_pend_agenda is not null) then
	
	insert into agenda_quimio_log(NR_SEQUENCIA,
					 DT_ATUALIZACAO,
                     --NR_SEQ_MEDICACAO,
                     --CD_PROTOCOLO,
					 NM_USUARIO,
					 DT_ATUALIZACAO_NREC,
					 NM_USUARIO_NREC,   
					 DS_LOG,       
					 NR_SEQ_PEND_AGENDA,
					 DT_LOG,
					 DS_STACK)
				values (nextval('agenda_quimio_log_seq'),
					LOCALTIMESTAMP,
					NEW.nm_usuario,
					LOCALTIMESTAMP,
					OLD.nm_usuario,
					substr(	wheb_mensagem_pck.get_texto(791804,
								'DS_ATRIB_OLDVALUE='||atrib_oldvalue_w ||
								';DS_ATRIB_NEWVALUE='||atrib_newvalue_w ||
								';DS_MOTIVO_STATUS='||NEW.ds_motivo_status||
                                --';NR_SEQ_MEDICACAO='||:new.nr_seq_medicacao||
                                --';CD_PROTOCOLO=' ||:new.cd_protocolo||
								';CD_PESSOA_FISICA_OLD='||OLD.cd_pessoa_fisica)||chr(10)||
						wheb_mensagem_pck.get_texto(791797,
								'NR_SEQ_PEND_AGENDA='||NEW.nr_seq_pend_agenda ||
								';NR_SEQ_LOCAL='||NEW.nr_seq_local ||
								';DT_CANCELADA='||NEW.dt_cancelada||
								';NR_SEQ_MOT_CANCELAMENTO='||NEW.nr_seq_mot_cancelamento)||chr(10)||
								wheb_mensagem_pck.get_texto(799798) || ': '||NEW.nr_sequencia||'/'||NEW.nr_seq_atendimento,1,4000),
					NEW.nr_seq_pend_agenda,
					LOCALTIMESTAMP,
					substr(wheb_mensagem_pck.get_texto(791798,
							'DS_FUNCAO_ATIVA='||obter_funcao_Ativa ||
							';DS_PERFIL='||obter_perfil_ativo) || ' -  Stack' || dbms_utility.format_call_stack, 1,4000));
										
end if;	

--Gerar historico de cancelamento da pendencia
if (NEW.ie_status_agenda is not null) and (OLD.ie_status_agenda is not null) and (OLD.ie_status_agenda <> 'C') and (NEW.ie_status_agenda = 'C') then
	CALL gerar_agenda_quimio_hist(NEW.nr_sequencia,OLD.cd_pessoa_fisica, wheb_mensagem_pck.get_texto(791806), OLD.dt_agenda,NEW.nm_usuario);
	
end if;	

if (coalesce(NEW.nr_seq_local,0) > 0) and (coalesce(OLD.nr_seq_local,0) <> coalesce(NEW.nr_seq_local,0)) then

	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	qt_local
	where	nr_sequencia = NEW.nr_seq_local;
	
	NEW.cd_estabelecimento := cd_estabelecimento_w;
end if;

if (OLD.nr_atendimento is null) and (NEW.nr_atendimento is not null) and (NEW.nr_seq_pac_senha_fila is null) then
		
	select	max(nr_seq_pac_senha_fila)
	into STRICT	nr_seq_pac_senha_fila_w
	from	atendimento_paciente
	where	nr_atendimento = NEW.nr_atendimento;
		
	if (coalesce(nr_seq_pac_senha_fila_w,0) > 0) then
		NEW.nr_seq_pac_senha_fila := nr_seq_pac_senha_fila_w;
	end if;
end if;

if (OLD.cd_pessoa_fisica is not null) and (OLD.cd_pessoa_fisica <> NEW.cd_pessoa_fisica) and (NEW.nr_seq_atendimento is not null) then
	
	if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then
		insert into agenda_quimio_log(NR_SEQUENCIA,
					 DT_ATUALIZACAO,
					 NM_USUARIO,
					 DT_ATUALIZACAO_NREC,
					 NM_USUARIO_NREC,   
					 DS_LOG,       
					 NR_SEQ_PEND_AGENDA,
					 DT_LOG,
					 DS_STACK)
				values (nextval('agenda_quimio_log_seq'),
					LOCALTIMESTAMP,
					NEW.nm_usuario,
					LOCALTIMESTAMP,
					OLD.nm_usuario,
					substr(wheb_mensagem_pck.get_texto(791811,
							'CD_PESSOA_FISICA_OLD='||OLD.cd_pessoa_fisica ||
							';CD_PESSOA_FISICA_NEW='||NEW.cd_pessoa_fisica)||chr(10)||
							wheb_mensagem_pck.get_texto(799798) || ': '||NEW.nr_sequencia||'/'||NEW.nr_seq_atendimento,1,4000),
					NEW.nr_seq_pend_agenda,
					LOCALTIMESTAMP,
					substr(	wheb_mensagem_pck.get_texto(791798,
							'DS_FUNCAO_ATIVA='||obter_funcao_Ativa ||
							';DS_PERFIL='||obter_perfil_ativo) || ' -  Stack: ' || dbms_utility.format_call_stack, 1,4000));

	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort(658383);			
	end if;
end if;	

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_agenda_quimio_atual() FROM PUBLIC;

CREATE TRIGGER agenda_quimio_atual
	BEFORE INSERT OR UPDATE ON agenda_quimio FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_agenda_quimio_atual();

