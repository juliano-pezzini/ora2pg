-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS man_ordem_servico_update ON man_ordem_servico CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_man_ordem_servico_update() RETURNS trigger AS $BODY$
DECLARE
nm_user_w			varchar(50);
qt_doc_erro_w			bigint;
qt_existe_orc_w			bigint;
qt_reg_w				bigint;
ie_gerar_grupo_des_w		varchar(01) := 'S';
NR_SEQ_GERENCIA_W		bigint;
nm_usuario_lider_sup_w		varchar(15);
ie_desenv_w             		varchar(01) := 'S';
nr_seq_plano_w      	    	bigint;
nr_seq_meta_os_w 	       		bigint;
ie_tipo_os_meta_w			varchar(03);
dt_geracao_meta_w		timestamp;

nr_seq_proj_vinc_w			bigint;
nr_seq_proj_orig_w			bigint;
nr_seq_proj_acomp_w		bigint;
ie_produto_w			varchar(15);
cd_setor_usuario_w			integer := wheb_usuario_pck.get_cd_setor_atendimento;
qt_ativ_programacao_w		bigint;
qt_hist_code_review_w		bigint;


BEGIN
ie_gerar_grupo_des_w	:= coalesce(Obter_Valor_Param_Usuario(299,228,Obter_Perfil_Ativo,NEW.nm_usuario,0),'S');

if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;
select	username
into STRICT	nm_user_w
from	user_users;

if (NEW.ie_classificacao <> OLD.ie_classificacao) then
	NEW.nm_usuario_classif	:= NEW.nm_usuario;
end if;

if (NEW.ie_prioridade <> OLD.ie_prioridade) then
	NEW.nm_usuario_prioridade	:= NEW.nm_usuario;
	if (nm_user_w = 'CORP') then
		CALL sla_dashboard_pck.validar_alt_prioridade_sla(
					NEW.nr_sequencia,NEW.nm_usuario,
					NEW.ie_prioridade, NEW.ie_classificacao,
					NEW.nr_seq_localizacao, NEW.nr_grupo_trabalho, NEW.dt_ordem_servico, 
					NEW.dt_inicio_real, NEW.nr_seq_estagio, NEW.nr_seq_equipamento, NEW.nr_seq_classif,
					NEW.ie_parado, NEW.cd_funcao, NEW.ie_ambiente);
	end if;
end if;

if (NEW.ie_ambiente <> OLD.ie_ambiente) then
	if (nm_user_w = 'CORP') then
		CALL sla_dashboard_pck.validar_alt_ambiente_sla(
					NEW.nr_sequencia,NEW.nm_usuario,
					NEW.ie_prioridade, NEW.ie_classificacao,
					NEW.nr_seq_localizacao, NEW.nr_grupo_trabalho, NEW.dt_ordem_servico, 
					NEW.dt_inicio_real, NEW.nr_seq_estagio, NEW.nr_seq_equipamento, NEW.nr_seq_classif, NEW.ie_parado, NEW.ie_ambiente);
	end if;
end if;

if (nm_user_w = 'CORP') and (NEW.ie_classificacao = 'E') and (NEW.nr_seq_meta_pe is null) and (upper(NEW.nm_usuario) <> 'WEBSERVICE') and (NEW.nr_seq_estagio in (2,9,791,1511)) then
	select	count(*)
	into STRICT	qt_doc_erro_w
	from	man_doc_erro
	where	nr_seq_ordem	= NEW.nr_sequencia
	and	dt_liberacao is not null;

	if (qt_doc_erro_w = 0) then
			CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(173237);
	end if;
end if;

if (NEW.nr_seq_grupo_sup is null) and (NEW.cd_funcao is not null) then
	select	min(b.nr_sequencia)
	into STRICT	NEW.nr_seq_grupo_sup
	from	grupo_suporte b,
		funcao_grupo_sup a
	where	a.nr_seq_grupo	= b.nr_sequencia
	and	a.cd_funcao	= NEW.cd_funcao;
	
	if (NEW.nr_seq_grupo_sup is not null) then
		select	max(a.nm_usuario_lider)
		into STRICT	nm_usuario_lider_sup_w
		from	grupo_suporte a
		where	a.nr_sequencia = NEW.nr_seq_grupo_sup;
	end if;
end if;

if (nm_user_w = 'CORP') then
	BEGIN
	
	if (coalesce(OLD.ie_grau_satisfacao,'XX') <> coalesce(NEW.ie_grau_satisfacao,'XX')) and (NEW.ie_grau_satisfacao is not null) and (NEW.ie_status_ordem = '3') and (NEW.NR_SEQ_ESTAGIO	not in (9)) and --Se ja estiver encerrada, nao alterar o estagio para Encerramento solicitado pelo cliente
		(NEW.dt_fim_real is not null) then
		NEW.dt_fim_real	:= null;
		NEW.ie_status_ordem	:= '2';
			NEW.nr_seq_estagio	:= 511;
		end if;	

	if (NEW.nr_seq_estagio <> OLD.nr_seq_estagio) then
		BEGIN

		select	max(ie_desenv)
		into STRICT	ie_desenv_w
		from	man_estagio_processo
		where	nr_sequencia    = NEW.nr_seq_estagio;

		select	substr(proj_obter_dados_ordem_serv(NEW.nr_sequencia, 'PROJ'),1,10) nr_seq_proj_vinc,
			substr(proj_obter_dados_ordem_serv(NEW.nr_sequencia, 'PROJD'),1,10) nr_seq_proj_orig,
			substr(proj_obter_dados_ordem_serv(NEW.nr_sequencia, 'PROJA'),1,10) nr_seq_proj_acomp
		into STRICT	nr_seq_proj_vinc_w,
			nr_seq_proj_orig_w,
			nr_seq_proj_acomp_w
		;
		
		if (ie_desenv_w = 'S') and (coalesce(nr_seq_proj_vinc_w,'0') = '0') and (coalesce(nr_seq_proj_orig_w,'0') = '0') and (coalesce(nr_seq_proj_acomp_w,'0') = '0') then
			
			select  max(nr_seq_gerencia)
			into STRICT    nr_seq_gerencia_w
			from    grupo_desenvolvimento
			where   nr_sequencia            = NEW.nr_seq_grupo_des;

			select  coalesce(max(nr_sequencia),0)
			into STRICT    nr_seq_plano_w
			from    desenvolvimento_plano_meta
			where   nr_seq_gerencia         = nr_seq_gerencia_w
			and     dt_meta_real is null;
						
			select	max(dt_geracao)
			into STRICT	dt_geracao_meta_w
			from	desenvolvimento_plano_meta
			where	nr_sequencia	= nr_seq_plano_w;

			if (nr_seq_plano_w > 0) and (dt_geracao_meta_w >= NEW.dt_ordem_servico) then
				select  count(*)
				into STRICT    qt_reg_w
				from    desenv_plano_meta_os
				where   nr_seq_plano            = nr_seq_plano_w
				and	NR_SEQ_ORDEM_SERV       = NEW.nr_sequencia;

				if (qt_reg_w = 0) then
					select  nextval('desenv_plano_meta_os_seq')
					into STRICT    nr_seq_meta_os_w
					;

					if (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), LOCALTIMESTAMP - interval '60 days') = 'S') then
						ie_tipo_os_meta_w	:= '0';
					elsif (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), LOCALTIMESTAMP - interval '59 days', LOCALTIMESTAMP - interval '45 days') = 'S') then
						ie_tipo_os_meta_w	:= '1';
					elsif (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), LOCALTIMESTAMP - interval '44 days', LOCALTIMESTAMP - interval '30 days') = 'S') then
						ie_tipo_os_meta_w	:= '2';
					elsif (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), LOCALTIMESTAMP - interval '29 days', LOCALTIMESTAMP - interval '15 days') = 'S') then
						ie_tipo_os_meta_w	:= '3';
					elsif (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), LOCALTIMESTAMP - interval '14 days', LOCALTIMESTAMP - interval '7 days') = 'S') then
						ie_tipo_os_meta_w	:= '4';
					elsif (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), LOCALTIMESTAMP - interval '6 days', LOCALTIMESTAMP) = 'S') then
						ie_tipo_os_meta_w	:= '5';
					end if;
					
					if (ie_tipo_os_meta_w is not null) then
						insert  into desenv_plano_meta_os(nr_sequencia,
								nr_seq_plano,
								nr_seq_ordem_serv,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								ie_tipo_os_meta,
								nr_seq_estagio_orig,
								nr_seq_estagio_meta,
								ie_recorrente)
						values (nr_seq_meta_os_w,
								nr_seq_plano_w,
								NEW.nr_sequencia,
								LOCALTIMESTAMP,
								NEW.nm_usuario,
								LOCALTIMESTAMP,
								NEW.nm_usuario,
								ie_tipo_os_meta_w,
								NEW.nr_seq_estagio,
								null, 'S');
					end if;
				end if;
			end if;
		
		
		end if;
		CALL sla_dashboard_pck.registrar_alt_estag_sla(
					NEW.nr_sequencia,NEW.nm_usuario,
					NEW.ie_prioridade, NEW.ie_classificacao,
					NEW.nr_seq_localizacao, NEW.nr_grupo_trabalho, NEW.dt_ordem_servico, 
					NEW.dt_inicio_real, NEW.nr_seq_estagio, NEW.nr_seq_equipamento, NEW.nr_seq_classif, NEW.ie_parado, NEW.ie_ambiente);
		end;
	end if;

	if (NEW.nr_seq_estagio = 231) and /* Aguardando Triagem*/

		(coalesce(nm_usuario_lider_sup_w,'X') <> 'X') then
		BEGIN
		select	count(*)
		into STRICT	qt_reg_w
		from	man_ordem_servico_exec
		where	nm_usuario_exec	= nm_usuario_lider_sup_w
		and	nr_seq_ordem	= NEW.nr_sequencia;

		if (qt_reg_w = 0) then
			insert into man_ordem_servico_exec(
				nr_sequencia,
				nr_seq_ordem,
				dt_atualizacao,
				nm_usuario,
				nm_usuario_exec,
				qt_min_prev,
				dt_recebimento,
				nr_seq_funcao)
			SELECT	nextval('man_ordem_servico_exec_seq'),
				NEW.nr_sequencia,
				LOCALTIMESTAMP,
				'Tasy',
				nm_usuario_lider_sup_w,
				45,
				LOCALTIMESTAMP,
				31
			;
		end if;
		
		if (NEW.nm_usuario_exec is null) then
			NEW.nm_usuario_exec := nm_usuario_lider_sup_w;
		end if;
		end;
	end if;

	if (NEW.ie_classificacao = 'E') and (NEW.ie_prioridade_sup is null) then /*Anderson  OS223881 - Conforme IT suporte*/

		NEW.ie_prioridade_sup := 10;
	end if;

	end;
end if;

if (OLD.nr_seq_meta_pe is not null) and (OLD.ie_status_ordem = 3) and (OLD.ie_status_ordem <> NEW.ie_status_ordem) then
	NEW.dt_validacao_pe := '';
end if;

if (nm_user_w = 'CORP') and (NEW.ie_status_ordem = 3) and (OLD.ie_status_ordem <> NEW.ie_status_ordem) and (upper(NEW.nm_usuario) <> 'WEBSERVICE') then

	/*Verifica se existe atividade de programacao para esta OS*/


	select	count(1)
	into STRICT	qt_ativ_programacao_w
	from	man_ordem_serv_ativ
	where	nr_seq_funcao in (1288,11,551)
	and		nr_seq_ordem_serv = NEW.nr_sequencia;

	if (qt_ativ_programacao_w > 0)then

	/*Verifica se existe historico do tipo Code Review*/


		select	count(1)
		into STRICT 	qt_hist_code_review_w
		from	man_ordem_serv_tecnico
		where	nr_seq_tipo = 163
		and		nr_seq_ordem_serv = NEW.nr_sequencia;
	end if;

	if (NEW.dt_ordem_servico > to_date('11/05/2016', 'dd/mm/yyyy')) then --Somente ira pedir aprovacao de code review se a OS foi criada DEPOIS que foi implementado essa rotina de Code Review (11/05/2016) . Mais detalhes verificar OS: 1402146
		if (qt_hist_code_review_w = 0) then
			CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(458500); /*Atencao! Para cada atividade de programacao deve existir um historico de "Aprovacao de Code Review"*/

		end if;
	end if;		
end if;

<<Final>>
qt_reg_w	:= 0;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_man_ordem_servico_update() FROM PUBLIC;

CREATE TRIGGER man_ordem_servico_update
	BEFORE UPDATE ON man_ordem_servico FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_man_ordem_servico_update();

