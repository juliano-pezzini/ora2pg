-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_mat_hor_insert ON prescr_mat_hor CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_mat_hor_insert() RETURNS trigger AS $BODY$
declare

ie_tipo_item_w		varchar(20);
nr_atendimento_w	bigint;
cd_pessoa_fisica_w	varchar(10);

BEGIN

if (NEW.ie_agrupador = 1) then
	ie_tipo_item_w	:= 'M';
elsif (NEW.ie_agrupador = 2) then
	ie_tipo_item_w	:= 'MAT';
elsif (NEW.ie_agrupador = 8) then
	ie_tipo_item_w	:= 'SNE';
elsif (NEW.ie_agrupador = 4) then
	ie_tipo_item_w	:= 'SOL';
elsif (NEW.ie_agrupador = 12) then
	ie_tipo_item_w	:= 'S';
elsif (NEW.ie_agrupador = 16) then
	ie_tipo_item_w	:= 'LD';
end if;

nr_atendimento_w	:= NEW.nr_atendimento;

if (coalesce(NEW.nr_atendimento,0) = 0) then
	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	prescr_medica
	where	nr_prescricao = NEW.nr_prescricao;
end if;

select	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_fisica_w
from	prescr_medica
where	nr_prescricao = NEW.nr_prescricao;

if (NEW.dt_lib_horario is not null) then
	CALL Atualizar_adep_controle_SC(NEW.nm_usuario, nr_atendimento_w, ie_tipo_item_w, 'S', NEW.nr_prescricao);
	CALL Atualizar_plt_controle(null, nr_atendimento_w, cd_pessoa_fisica_w, ie_tipo_item_w, 'S', NEW.nr_prescricao);
else
	CALL Atualizar_plt_controle(NEW.nm_usuario, nr_atendimento_w, cd_pessoa_fisica_w, ie_tipo_item_w, 'S', NEW.nr_prescricao);
end if;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_mat_hor_insert() FROM PUBLIC;

CREATE TRIGGER prescr_mat_hor_insert
	AFTER INSERT ON prescr_mat_hor FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_mat_hor_insert();

