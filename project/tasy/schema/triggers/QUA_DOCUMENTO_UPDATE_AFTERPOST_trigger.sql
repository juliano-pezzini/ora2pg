-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS qua_documento_update_afterpost ON qua_documento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_qua_documento_update_afterpost() RETURNS trigger AS $BODY$
declare
nr_seq_ordem_w			man_ordem_servico.nr_sequencia%type;
nr_seq_estagio_w		man_ordem_servico.nr_seq_estagio%type;

c01 CURSOR FOR
SELECT	nr_sequencia
from	man_ordem_servico
where	nr_seq_documento = NEW.nr_sequencia
and	ie_tipo_ordem = 11 /*Solicitação de Normatização*/

and	ie_status_ordem <> '3';

BEGIN

if(NEW.ie_status = 'D' AND NEW.dt_aprovacao is not null) then
	BEGIN
		open C01;
		loop
		fetch C01 into
			nr_seq_ordem_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			BEGIN
			
			if	(	(NEW.nr_seq_classif = 1)
				and	NEW.nr_seq_tipo in (2, 3, 5, 15)
				and (obter_se_base_corp = 'S'
					or	obter_se_base_wheb = 'S')) then
				BEGIN
					select	max(mes.nr_sequencia)
					into STRICT	nr_seq_estagio_w
					from	man_estagio_processo mes
					where	mes.nr_sequencia = 1871;
					
					if (nr_seq_estagio_w is not null) then
						BEGIN
							update	man_ordem_servico
							set	nr_seq_estagio = nr_seq_estagio_w
							where	nr_sequencia = nr_seq_ordem_w;
						end;
					end if;
				end;
			else
				BEGIN
					/* 'OS encerrada automaticamente após aprovação do documento '||:new.cd_documento||' - '||substr(obter_desc_expressao(:new.cd_exp_documento, :new.nm_documento), 1, 255) */


					CALL man_encerrar_OS(nr_seq_ordem_w,9,NEW.nm_usuario_aprov,substr(WHEB_MENSAGEM_PCK.get_texto(823511, 'NEW_CD_DOCUMENTO='||NEW.cd_documento||';DESC_EXPRESSAO_DOC='||substr(obter_desc_expressao(NEW.cd_exp_documento, NEW.nm_documento), 1, 255)),1,255),'N');
				end;
			end if;
			end;
		end loop;
		close C01;
	end;
end if;

RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_qua_documento_update_afterpost() FROM PUBLIC;

CREATE TRIGGER qua_documento_update_afterpost
	AFTER UPDATE ON qua_documento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_qua_documento_update_afterpost();

