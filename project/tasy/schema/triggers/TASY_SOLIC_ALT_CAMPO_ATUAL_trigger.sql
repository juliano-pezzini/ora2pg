-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS tasy_solic_alt_campo_atual ON tasy_solic_alt_campo CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_tasy_solic_alt_campo_atual() RETURNS trigger AS $BODY$
declare
-- Trigger criada por questão de performance
ie_tipo_solicitacao_w		tasy_solic_alteracao.ie_tipo_solicitacao%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
cd_cgc_w			pessoa_juridica.cd_cgc%type;
BEGIN
  BEGIN
select	max(ie_tipo_solicitacao)
into STRICT	ie_tipo_solicitacao_w
from	tasy_solic_alteracao
where	nr_sequencia	= NEW.nr_seq_solicitacao
and	cd_pessoa_fisica is null
and	cd_cgc is null;

-- Tipo Solicitação Prestador
if (ie_tipo_solicitacao_w = 'P') and (TG_OP = 'INSERT') then
	-- Pega Pessoa Física
	BEGIN
	select	cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from	pls_prestador	c
	where	(NEW.ds_chave_simples	= c.cd_pessoa_fisica
	or	substr(NEW.ds_chave_composta,1,length(NEW.ds_chave_composta)-1) = ('CD_PESSOA_FISICA=' || c.cd_pessoa_fisica || '#@#@IE_TIPO_COMPLEMENTO=')
	or	NEW.ds_chave_composta	= 'CD_PESSOA_FISICA=' || c.cd_pessoa_fisica
	or	NEW.ds_chave_composta	= 'CD_PESSOA_FISICA=' || q'{'}' || c.cd_pessoa_fisica ||  q'{'}' ) --Formato portal
  LIMIT 1;
	exception
	when no_data_found then
		cd_pessoa_fisica_w	:= null;
	end;

	--Pega Pessoa Jurídica
	if (cd_pessoa_fisica_w is null) then
		BEGIN
		select	cd_cgc
		into STRICT	cd_cgc_w
		from	pls_prestador	c
		where	(NEW.ds_chave_simples        = c.cd_cgc
		or	substr(NEW.ds_chave_composta,1,position('#@#@IE_TIPO_COMPLEMENTO=' in NEW.ds_chave_composta) + length('#@#@IE_TIPO_COMPLEMENTO=') -1) = ('CD_CGC=' || c.cd_cgc || '#@#@IE_TIPO_COMPLEMENTO=')
		or	NEW.ds_chave_composta     = 'CD_CGC=' || c.cd_cgc
		or	NEW.ds_chave_composta     = 'CD_CGC=' || q'{'}' || c.cd_cgc || q'{'}') --Formato portal
  LIMIT 1;
		exception
		when no_data_found then
			cd_cgc_w	:= null;
		end;
	end if;

	-- Atualizar os dados do prestador solicitante
	update	tasy_solic_alteracao
	set	cd_pessoa_fisica	= cd_pessoa_fisica_w,
		cd_cgc			= cd_cgc_w
	where	nr_sequencia		= NEW.nr_seq_solicitacao;
end if;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_tasy_solic_alt_campo_atual() FROM PUBLIC;

CREATE TRIGGER tasy_solic_alt_campo_atual
	BEFORE INSERT OR UPDATE ON tasy_solic_alt_campo FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_tasy_solic_alt_campo_atual();

