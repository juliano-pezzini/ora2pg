-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS sup_int_pj_atual ON sup_int_pj CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_sup_int_pj_atual() RETURNS trigger AS $BODY$
declare
qt_existe_erros_w				bigint;
qt_existe_w				bigint;
BEGIN 
 
select	count(*) 
into STRICT	qt_existe_w 
from	sup_parametro_integracao a, 
	sup_int_regra_pj b 
where	a.nr_sequencia = b.nr_seq_integracao 
and	a.ie_evento = 'PJ' 
and	a.ie_forma = 'R' 
and	a.ie_situacao = 'A' 
and	b.ie_situacao = 'A';
 
if (qt_existe_w > 0) and (NEW.dt_liberacao is not null) and (NEW.dt_confirma_integracao is null) and (NEW.ie_forma_integracao = 'R') then 
	 
	NEW.dt_leitura := LOCALTIMESTAMP;
	 
	CALL consiste_sup_int_pj( 
		NEW.nr_sequencia, 
		NEW.cd_cgc, 
		NEW.cd_estabelecimento, 
		NEW.cd_municipio_ibge, 
		NEW.cd_pf_resp_tecnico, 
		NEW.cd_cnes);
		 
	select	count(*) 
	into STRICT	qt_existe_erros_w 
	from	sup_int_pj_consist 
	where	nr_sequencia = NEW.nr_sequencia;
	 
	if (qt_existe_erros_w = 0) then 
		 
		CALL gerar_pessoa_jur_integracao(	 
			NEW.cd_cgc, 
			NEW.cd_estabelecimento, 
			'INTEGR_TASY', 
			NEW.ds_razao_social, 
			NEW.nm_fantasia, 
			NEW.ds_nome_abrev, 
			NEW.cd_municipio_ibge, 
			NEW.cd_cep, 
			NEW.ds_endereco, 
			NEW.nr_endereco, 
			NEW.ds_complemento, 
			NEW.ds_bairro, 
			NEW.ds_municipio, 
			NEW.sg_estado, 
			NEW.nr_telefone, 
			NEW.nr_fax, 
			NEW.nr_inscricao_estadual, 
			NEW.nr_inscricao_municipal, 
			NEW.cd_internacional, 
			NEW.ds_site_internet, 
			NEW.cd_pf_resp_tecnico, 
			NEW.ds_orgao_reg_resp_tecnico, 
			NEW.nr_autor_func, 
			NEW.nr_alvara_sanitario, 
			NEW.nr_alvara_sanitario_munic, 
			NEW.nr_certificado_boas_prat, 
			NEW.cd_ans, 
			NEW.dt_validade_autor_func, 
			NEW.dt_validade_alvara_sanit, 
			NEW.dt_validade_cert_boas_prat, 
			NEW.cd_cnes, 
			NEW.cd_referencia_fornec, 
			NEW.cd_sistema_ant, 
			NEW.ds_email, 
			NEW.dt_validade_resp_tecnico, 
			NEW.nm_pessoa_contato, 
			NEW.nr_ramal_contato, 
			NEW.nr_registro_resp_tecnico, 
			NEW.qt_dia_prazo_entrega, 
			NEW.vl_minimo_nf, 
			NEW.dt_validade_alvara_munic, 
			NEW.ds_resp_tecnico, 
			NEW.ie_situacao, 
			NEW.ie_status_apenado);
 
		NEW.dt_confirma_integracao 	:= LOCALTIMESTAMP;
	end if;
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_sup_int_pj_atual() FROM PUBLIC;

CREATE TRIGGER sup_int_pj_atual
	BEFORE INSERT OR UPDATE ON sup_int_pj FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_sup_int_pj_atual();

