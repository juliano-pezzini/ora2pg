-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_medica_update_hl7 ON prescr_medica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_medica_update_hl7() RETURNS trigger AS $BODY$
declare
ds_sep_bv_w				varchar(100);
ds_param_integ_hl7_w	varchar(4000);

nr_seq_interno_w		bigint;
qt_prescr_w				bigint;
nr_seq_prescr_w			bigint;
nr_acesso_dicom_w 		varchar(20);
qt_proc_laudo_w			bigint;
ie_envia_w				varchar(1);
nr_seq_anamese_w	  	varchar(10);

C01 CURSOR FOR
	SELECT	a.nr_sequencia	
	from	prescr_procedimento a,
		proc_interno_integracao b
	where	a.nr_prescricao	= NEW.nr_prescricao
	and	b.nr_seq_proc_interno = a.nr_seq_proc_interno
	and	coalesce(b.cd_estabelecimento,coalesce(NEW.cd_estabelecimento,0)) = coalesce(NEW.cd_estabelecimento,0)
	and	a.nr_seq_exame is null
	and	b.nr_seq_sistema_integ in (11,66,91,103,108) 		--Philips-DCX, GE-Centricity-PACSIW, Synapse-Fuji, Philips-IBE, GE-Centricity-RISi
	
union
 
	SELECT	nr_sequencia
	from	prescr_procedimento a
	where	a.nr_prescricao	= NEW.nr_prescricao 		--Philips-Isite
	and	Obter_Se_Integr_Proc_Interno(a.nr_seq_proc_interno, 2, null, a.ie_lado, NEW.cd_estabelecimento) = 'S'		 
	and	a.nr_seq_exame is null;
	
C03 CURSOR FOR
	SELECT	nr_sequencia
	from	prescr_procedimento a
	where	a.nr_prescricao	= NEW.nr_prescricao 		--Poligrafo
	and	Obter_Se_Integr_Proc_Interno(a.nr_seq_proc_interno, 16, null, a.ie_lado, NEW.cd_estabelecimento) = 'S'
	and	a.nr_seq_exame is null;	
	
c_clinic_windata CURSOR FOR
	SELECT	a.nr_sequencia	
	from	prescr_procedimento a,
		proc_interno_integracao b
	where	a.nr_prescricao	= NEW.nr_prescricao
	and	b.nr_seq_proc_interno = a.nr_seq_proc_interno
	and	coalesce(b.cd_estabelecimento,coalesce(NEW.cd_estabelecimento,0)) = coalesce(NEW.cd_estabelecimento,0)
	and	a.nr_seq_exame is null
	and	b.nr_seq_sistema_integ in (139); 		--Clinic WinData
	
c_radcentre CURSOR FOR
	SELECT	a.nr_sequencia	
	from	prescr_procedimento a,
		proc_interno_integracao b
	where	a.nr_prescricao	= NEW.nr_prescricao
	and	b.nr_seq_proc_interno = a.nr_seq_proc_interno
	and	coalesce(b.cd_estabelecimento,coalesce(NEW.cd_estabelecimento,0)) = coalesce(NEW.cd_estabelecimento,0)
	and	a.nr_seq_exame is null
	and	b.nr_seq_sistema_integ in (140); 		--RadCentre
	
	
c_odseasy CURSOR FOR
	SELECT	a.nr_sequencia	
	from	prescr_procedimento a,
		proc_interno_integracao b
	where	a.nr_prescricao	= NEW.nr_prescricao
	and	b.nr_seq_proc_interno = a.nr_seq_proc_interno
	and	coalesce(b.cd_estabelecimento,coalesce(NEW.cd_estabelecimento,0)) = coalesce(NEW.cd_estabelecimento,0)
	and	a.nr_seq_exame is null
	and	b.nr_seq_sistema_integ in (152); 		--ODSeasy
	
	
	
c_cardiobase CURSOR FOR
	SELECT	a.nr_sequencia	
	from	prescr_procedimento a,
		proc_interno_integracao b
	where	a.nr_prescricao	= NEW.nr_prescricao
	and	b.nr_seq_proc_interno = a.nr_seq_proc_interno
	and	coalesce(b.cd_estabelecimento,coalesce(NEW.cd_estabelecimento,0)) = coalesce(NEW.cd_estabelecimento,0)
	and	a.nr_seq_exame is null
	and	b.nr_seq_sistema_integ in (153); 		--Cardiobase
	
c_PacsLaboredo CURSOR FOR
	SELECT	a.nr_sequencia, a.nr_acesso_dicom	
	from	prescr_procedimento a,
		proc_interno_integracao b
	where	a.nr_prescricao	= NEW.nr_prescricao
	and	b.nr_seq_proc_interno = a.nr_seq_proc_interno
	and	coalesce(b.cd_estabelecimento,coalesce(NEW.cd_estabelecimento,0)) = coalesce(NEW.cd_estabelecimento,0)
	and	a.nr_seq_exame is null
	and	b.nr_seq_sistema_integ in (184); 		--Laboredo
	
c_xcelera CURSOR FOR
	SELECT	a.nr_sequencia	
	from	prescr_procedimento a,
		proc_interno_integracao b
	where	a.nr_prescricao	= NEW.nr_prescricao
	and	b.nr_seq_proc_interno = a.nr_seq_proc_interno
	and	coalesce(b.cd_estabelecimento,coalesce(NEW.cd_estabelecimento,0)) = coalesce(NEW.cd_estabelecimento,0)
	and	a.nr_seq_exame is null
	and	b.nr_seq_sistema_integ in (200); 		--Xcelera
BEGIN

if (NEW.dt_liberacao	is not null) and (OLD.dt_liberacao	is null) then
	
	select	max(obter_atepacu_paciente( NEW.nr_atendimento ,'A'))
	into STRICT	nr_seq_interno_w
	;
	
	ds_sep_bv_w := obter_separador_bv;	
	
	open C01;
	loop
	fetch C01 into	
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		BEGIN
		
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w; -- Bruno orientou
		CALL gravar_agend_integracao(25, ds_param_integ_hl7_w);
		nr_seq_anamese_w := converte_rf_string_anam(NEW.nr_atendimento, NEW.nm_usuario, nr_seq_anamese_w);
		
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
					'nr_atendimento='   || NEW.nr_atendimento   || ds_sep_bv_w ||
					'nr_seq_interno='   || nr_seq_interno_w      || ds_sep_bv_w ||
					'nr_prescricao='    || NEW.nr_prescricao    || ds_sep_bv_w ||
					'nr_seq_presc='	    || nr_seq_prescr_w	     || ds_sep_bv_w ||	
					'order_control='    || 'NW'    		     || ds_sep_bv_w ||	
					'order_status='     || 'SC'    		           || ds_sep_bv_w ||
				              'nr_seq_anamese='   || nr_seq_anamese_w   	 || ds_sep_bv_w;

					
		CALL gravar_agend_integracao(23, ds_param_integ_hl7_w);
		
		CALL gravar_agend_integracao(530, ds_param_integ_hl7_w);
		
		end;
	end loop;
	close C01;
	
	open c_clinic_windata;
	loop
	fetch c_clinic_windata into	
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on c_clinic_windata */
		BEGIN
		
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
					'nr_atendimento='   || NEW.nr_atendimento   || ds_sep_bv_w ||
					'nr_seq_interno='   || nr_seq_interno_w      || ds_sep_bv_w ||
					'nr_prescricao='    || NEW.nr_prescricao    || ds_sep_bv_w ||
					'nr_seq_presc='	    || nr_seq_prescr_w	     || ds_sep_bv_w ||	
					'order_control='    || 'NW'    		     || ds_sep_bv_w ||	
					'order_status='     || 'SC'    		           || ds_sep_bv_w ||
					'receiving_app='    || 'CWD' || ds_sep_bv_w;

					
		CALL gravar_agend_integracao(664, ds_param_integ_hl7_w);
		end;
	end loop;
	close c_clinic_windata;

	open c_radcentre;
	loop
	fetch c_radcentre into	
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on c_radcentre */
		BEGIN
		
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
					'nr_atendimento='   || NEW.nr_atendimento   || ds_sep_bv_w ||
					'nr_seq_interno='   || nr_seq_interno_w      || ds_sep_bv_w ||
					'nr_prescricao='    || NEW.nr_prescricao    || ds_sep_bv_w ||
					'nr_seq_presc='	    || nr_seq_prescr_w	     || ds_sep_bv_w ||	
					'order_control='    || 'NW'    		     || ds_sep_bv_w ||	
					'order_status='     || 'SC'    		           || ds_sep_bv_w ||
					      'receiving_app='    || 'RADCENTRE' || ds_sep_bv_w;

					
		CALL gravar_agend_integracao(666, ds_param_integ_hl7_w);
		end;
	end loop;
	close c_radcentre;
	
	open c_odseasy;
	loop
	fetch c_odseasy into	
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on c_odseasy */
		BEGIN
		
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
					'nr_atendimento='   || NEW.nr_atendimento   || ds_sep_bv_w ||
					'nr_seq_interno='   || nr_seq_interno_w      || ds_sep_bv_w ||
					'nr_prescricao='    || NEW.nr_prescricao    || ds_sep_bv_w ||
					'nr_seq_presc='	    || nr_seq_prescr_w	     || ds_sep_bv_w ||	
					'order_control='    || 'NW'    		     || ds_sep_bv_w ||	
					'order_status='     || 'SC'    		           || ds_sep_bv_w ||
					'receiving_app='    || 'CUSTODIAG' || ds_sep_bv_w;

					
		CALL gravar_agend_integracao(689, ds_param_integ_hl7_w);
		end;
	end loop;
	close c_odseasy;
	
	open c_cardiobase;
	loop
	fetch c_cardiobase into	
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on c_cardiobase */
		BEGIN
		
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
					'nr_atendimento='   || NEW.nr_atendimento   || ds_sep_bv_w ||
					'nr_seq_interno='   || nr_seq_interno_w      || ds_sep_bv_w ||
					'nr_prescricao='    || NEW.nr_prescricao    || ds_sep_bv_w ||
					'nr_seq_presc='	    || nr_seq_prescr_w	     || ds_sep_bv_w ||	
					'order_control='    || 'NW'    		     || ds_sep_bv_w ||	
					'order_status='     || 'SC'    		           || ds_sep_bv_w ||
					'receiving_app='    || 'CARDIOBASE' || ds_sep_bv_w;

					
		CALL gravar_agend_integracao(695, ds_param_integ_hl7_w);
		end;
	end loop;
	close c_cardiobase;
	
	open c_xcelera;
	loop
	fetch c_xcelera into	
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on c_xcelera */
		BEGIN
		
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica	|| ds_sep_bv_w ||
								'nr_atendimento='   || NEW.nr_atendimento		|| ds_sep_bv_w ||               
								'nr_seq_interno='   || nr_seq_interno_w			|| ds_sep_bv_w ||               
								'nr_prescricao='    || NEW.nr_prescricao		|| ds_sep_bv_w ||               
								'nr_seq_presc='	    || nr_seq_prescr_w			|| ds_sep_bv_w ||               
								'order_control='    || 'NW'				|| ds_sep_bv_w ||               
								'order_status='     || 'SC'				|| ds_sep_bv_w ||
								'receiving_app='    || 'XCELERA' || ds_sep_bv_w									;

		CALL gravar_agend_integracao(862, ds_param_integ_hl7_w);
		end;
	end loop;
	close c_xcelera;

	open c_PacsLaboredo;
	loop
	fetch c_PacsLaboredo into	
		nr_seq_prescr_w, nr_acesso_dicom_w;
	EXIT WHEN NOT FOUND; /* apply on c_PacsLaboredo */
		BEGIN

		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
                      			'nr_atendimento='   || NEW.nr_atendimento   || ds_sep_bv_w ||
                            'nr_seq_interno='   || nr_seq_interno_w      || ds_sep_bv_w ||
                            'nr_prescricao='    || NEW.nr_prescricao    || ds_sep_bv_w ||
                            'nr_seq_presc='	    || nr_seq_prescr_w	     || ds_sep_bv_w ||	
                            'nr_acesso_dicom='  || nr_acesso_dicom_w     || ds_sep_bv_w ||	
                            'order_control='    || 'NW'    		           || ds_sep_bv_w ||	
                            'order_status='     || 'SC'    		           || ds_sep_bv_w ||
                            'receiving_app='    || 'CARDIOBASE'          || ds_sep_bv_w;

					
    CALL gravar_agend_integracao(804, ds_param_integ_hl7_w);
		end;
	end loop;
	close c_PacsLaboredo;

	open C03;
	loop
	fetch C03 into
	nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		BEGIN

		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w;
		CALL gravar_agend_integracao(616, ds_param_integ_hl7_w);
		end;
	end loop;
	close C03;	
	
elsif 	(NEW.dt_liberacao is null AND OLD.dt_liberacao is not null) or
		(NEW.dt_liberacao_medico is null AND OLD.dt_liberacao_medico is not null) then
		--integração isite, cancelamento de procedimentos quando for cancelado o atendimento
		ds_sep_bv_w := obter_separador_bv;
	
		open C01;
			loop
			fetch C01 into	
				nr_seq_prescr_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				BEGIN
				select	max(obter_atepacu_paciente( NEW.nr_atendimento ,'A'))
				into STRICT	nr_seq_interno_w
				;
				
				ie_envia_w := 'S';

				select	count(*)
				into STRICT	qt_proc_laudo_w                                                         
				from	prescr_proc_status                                                      
				where	nr_prescricao	= NEW.nr_prescricao                                     
				and		nr_seq_prescr	= nr_seq_prescr_w                                        
				and		ie_status_exec 	= '40';

				if (qt_proc_laudo_w > 0) then                                                
					ie_envia_w := 'N';
				end if;
				
				if (ie_envia_w = 'S') then    
				
					ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica	|| ds_sep_bv_w ||                                                                          
											'nr_atendimento='   || NEW.nr_atendimento		|| ds_sep_bv_w ||               
											'nr_seq_interno='   || nr_seq_interno_w			|| ds_sep_bv_w ||               
											'nr_prescricao='    || NEW.nr_prescricao		|| ds_sep_bv_w ||               
											'nr_seq_presc='	    || nr_seq_prescr_w			|| ds_sep_bv_w ||               
											'order_control='    || 'OC'				|| ds_sep_bv_w ||               
											'order_status='     || 'CA'				|| ds_sep_bv_w;

					CALL gravar_agend_integracao(23, ds_param_integ_hl7_w);

				
				end if;
				
				end;
		end loop;
		close C01;
		
	open c_clinic_windata;
	loop
	fetch c_clinic_windata into	
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on c_clinic_windata */
		BEGIN
		select	max(obter_atepacu_paciente( NEW.nr_atendimento ,'A'))
		into STRICT	nr_seq_interno_w
		;
		
		ie_envia_w := 'S';

		select	count(*)
		into STRICT	qt_proc_laudo_w                                                         
		from	prescr_proc_status                                                      
		where	nr_prescricao	= NEW.nr_prescricao                                     
		and		nr_seq_prescr	= nr_seq_prescr_w                                        
		and		ie_status_exec 	= '40';

		if (qt_proc_laudo_w > 0) then                                                
			ie_envia_w := 'N';
		end if;
		
		if (ie_envia_w = 'S') then    
		
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica	|| ds_sep_bv_w ||                                                                          
									'nr_atendimento='   || NEW.nr_atendimento		|| ds_sep_bv_w ||               
									'nr_seq_interno='   || nr_seq_interno_w			|| ds_sep_bv_w ||               
									'nr_prescricao='    || NEW.nr_prescricao		|| ds_sep_bv_w ||               
									'nr_seq_presc='	    || nr_seq_prescr_w			|| ds_sep_bv_w ||               
									'order_control='    || 'OC'				|| ds_sep_bv_w ||               
									'order_status='     || 'CA'				|| ds_sep_bv_w ||
									'receiving_app='    || 'CWD' || ds_sep_bv_w;

			CALL gravar_agend_integracao(664, ds_param_integ_hl7_w);
		end if;	
		end;
	end loop;
	close c_clinic_windata;
		
	open c_radcentre;
	loop
	fetch c_radcentre into	
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on c_radcentre */
		BEGIN
		select	max(obter_atepacu_paciente( NEW.nr_atendimento ,'A'))
		into STRICT	nr_seq_interno_w
		;
		
		ie_envia_w := 'S';

		select	count(*)
		into STRICT	qt_proc_laudo_w                                                         
		from	prescr_proc_status                                                      
		where	nr_prescricao	= NEW.nr_prescricao                                     
		and		nr_seq_prescr	= nr_seq_prescr_w                                        
		and		ie_status_exec 	= '40';

		if (qt_proc_laudo_w > 0) then                                                
			ie_envia_w := 'N';
		end if;
		
		if (ie_envia_w = 'S') then    
		
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica	|| ds_sep_bv_w ||                                                                          
									'nr_atendimento='   || NEW.nr_atendimento		|| ds_sep_bv_w ||               
									'nr_seq_interno='   || nr_seq_interno_w			|| ds_sep_bv_w ||               
									'nr_prescricao='    || NEW.nr_prescricao		|| ds_sep_bv_w ||               
									'nr_seq_presc='	    || nr_seq_prescr_w			|| ds_sep_bv_w ||               
									'order_control='    || 'OC'				|| ds_sep_bv_w ||               
									'order_status='     || 'CA'				|| ds_sep_bv_w ||
									'receiving_app='    || 'RADCENTRE' || ds_sep_bv_w									;

			CALL gravar_agend_integracao(666, ds_param_integ_hl7_w);
		end if;	
		end;
	end loop;
	close c_radcentre;
	
	
	open c_odseasy;
	loop
	fetch c_odseasy into	
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on c_odseasy */
		BEGIN
		select	max(obter_atepacu_paciente( NEW.nr_atendimento ,'A'))
		into STRICT	nr_seq_interno_w
		;
		
		ie_envia_w := 'S';

		select	count(*)
		into STRICT	qt_proc_laudo_w                                                         
		from	prescr_proc_status                                                      
		where	nr_prescricao	= NEW.nr_prescricao                                     
		and		nr_seq_prescr	= nr_seq_prescr_w                                        
		and		ie_status_exec 	= '40';

		if (qt_proc_laudo_w > 0) then                                                
			ie_envia_w := 'N';
		end if;
		
		if (ie_envia_w = 'S') then    
		
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica	|| ds_sep_bv_w ||                                                                          
									'nr_atendimento='   || NEW.nr_atendimento		|| ds_sep_bv_w ||               
									'nr_seq_interno='   || nr_seq_interno_w			|| ds_sep_bv_w ||               
									'nr_prescricao='    || NEW.nr_prescricao		|| ds_sep_bv_w ||               
									'nr_seq_presc='	    || nr_seq_prescr_w			|| ds_sep_bv_w ||               
									'order_control='    || 'OC'				|| ds_sep_bv_w ||               
									'order_status='     || 'CA'				|| ds_sep_bv_w ||
									'receiving_app='    || 'CUSTODIAG' || ds_sep_bv_w									;

			CALL gravar_agend_integracao(689, ds_param_integ_hl7_w);
		end if;	
		end;
	end loop;
	close c_odseasy;
	
	open c_cardiobase;
	loop
	fetch c_cardiobase into	
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on c_cardiobase */
		BEGIN
		select	max(obter_atepacu_paciente( NEW.nr_atendimento ,'A'))
		into STRICT	nr_seq_interno_w
		;
		
		ie_envia_w := 'S';

		select	count(*)
		into STRICT	qt_proc_laudo_w                                                         
		from	prescr_proc_status                                                      
		where	nr_prescricao	= NEW.nr_prescricao                                     
		and		nr_seq_prescr	= nr_seq_prescr_w                                        
		and		ie_status_exec 	= '40';

		if (qt_proc_laudo_w > 0) then                                                
			ie_envia_w := 'N';
		end if;
		
		if (ie_envia_w = 'S') then 
		
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
						'nr_atendimento='   || NEW.nr_atendimento   || ds_sep_bv_w ||
						'nr_seq_interno='   || nr_seq_interno_w      || ds_sep_bv_w ||
						'nr_prescricao='    || NEW.nr_prescricao    || ds_sep_bv_w ||
						'nr_seq_presc='	    || nr_seq_prescr_w	     || ds_sep_bv_w ||	
						'order_control='    || 'NW'    		     || ds_sep_bv_w ||	
						'order_status='     || 'SC'    		           || ds_sep_bv_w ||
						'receiving_app='    || 'CARDIOBASE' || ds_sep_bv_w;

						
			CALL gravar_agend_integracao(695, ds_param_integ_hl7_w);
		end if;	
		end;
	end loop;
	close c_cardiobase;
	
	open c_xcelera;
	loop
	fetch c_xcelera into	
		nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on c_xcelera */
		BEGIN
		select	max(obter_atepacu_paciente( NEW.nr_atendimento ,'A'))
		into STRICT	nr_seq_interno_w
		;
		
		ie_envia_w := 'S';

		select	count(*)
		into STRICT	qt_proc_laudo_w                                                         
		from	prescr_proc_status                                                      
		where	nr_prescricao	= NEW.nr_prescricao                                     
		and		nr_seq_prescr	= nr_seq_prescr_w                                        
		and		ie_status_exec 	= '40';

		if (qt_proc_laudo_w > 0) then                                                
			ie_envia_w := 'N';
		end if;
		
		if (ie_envia_w = 'S') then    
		
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica	|| ds_sep_bv_w ||                                                                          
									'nr_atendimento='   || NEW.nr_atendimento		|| ds_sep_bv_w ||               
									'nr_seq_interno='   || nr_seq_interno_w			|| ds_sep_bv_w ||               
									'nr_prescricao='    || NEW.nr_prescricao		|| ds_sep_bv_w ||               
									'nr_seq_presc='	    || nr_seq_prescr_w			|| ds_sep_bv_w ||               
									'order_control='    || 'NW'				|| ds_sep_bv_w ||               
									'order_status='     || 'SC'				|| ds_sep_bv_w ||
									'receiving_app='    || 'XCELERA' || ds_sep_bv_w									;

			CALL gravar_agend_integracao(862, ds_param_integ_hl7_w);
		end if;	
		end;
	end loop;
	close c_xcelera;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_medica_update_hl7() FROM PUBLIC;

CREATE TRIGGER prescr_medica_update_hl7
	BEFORE UPDATE ON prescr_medica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_medica_update_hl7();

