-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS protocolo_convenio_atual ON protocolo_convenio CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_protocolo_convenio_atual() RETURNS trigger AS $BODY$
DECLARE
   PRAGMA AUTONOMOUS_TRANSACTION;

   ie_operacao_w smallint := 0;
   ie_tipo_convenio_w     convenio.ie_tipo_convenio%type;
   ie_geracao_w           ctb_regra_geracao_lote_rec.ie_geracao%type;
   ie_ctb_online_w        varchar(1);

BEGIN
    if (coalesce(wheb_usuario_pck.get_ie_executar_trigger, 'S') = 'S') then
        if (OLD.ie_status_protocolo = 1 and NEW.ie_status_protocolo = 2) then
            ie_operacao_w := 1;
        elsif (OLD.ie_status_protocolo = 2 and NEW.ie_status_protocolo = 1) then
            ie_operacao_w := 2;
        end if;

        if (ie_operacao_w <> 0) then
            ie_ctb_online_w := ctb_online_pck.get_modo_lote(6, NEW.cd_estabelecimento);

            select ie_tipo_convenio
            into STRICT   ie_tipo_convenio_w
            from   convenio
            where  cd_convenio = NEW.cd_convenio;

            ie_geracao_w    := ctb_online_pck.get_geracao_lote_receita(NEW.cd_convenio,
                                                                        NEW.cd_estabelecimento,
                                                                        NEW.nm_usuario,
                                                                        ie_tipo_convenio_w);

            if (ie_ctb_online_w = 'S' and ie_geracao_w = 'FPR') then

                CALL ctb_contab_onl_lote_receita(nr_seq_protocolo_p  =>  NEW.nr_seq_protocolo,
                                            nr_interno_conta_p  =>  null,
                                            nm_usuario_p        =>  NEW.nm_usuario,
                                            ie_operacao_p       =>  ie_operacao_w,
                                            dt_referencia_p     =>  null);
            end if;
        end if;
    end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_protocolo_convenio_atual() FROM PUBLIC;

CREATE TRIGGER protocolo_convenio_atual
	AFTER UPDATE ON protocolo_convenio FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_protocolo_convenio_atual();

