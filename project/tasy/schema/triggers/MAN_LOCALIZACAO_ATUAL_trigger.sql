-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS man_localizacao_atual ON man_localizacao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_man_localizacao_atual() RETURNS trigger AS $BODY$
declare

qt_existe_w	bigint;

BEGIN
if (NEW.ie_situacao <> OLD.ie_situacao) and (NEW.ie_situacao = 'I') then
	BEGIN
	/*Verifica se existe algum equipamento ativo com a localização que está sendo inativada*/

	select	count(*)
	into STRICT	qt_existe_w
	from	man_equipamento
	where	nr_seq_local 	= NEW.nr_sequencia
	and	ie_situacao 	= 'A';

	if (qt_existe_w > 0) then
		select	count(*)
		into STRICT	qt_existe_w
		from	man_planej_prev a
		where	exists (	SELECT	1
				from	man_equipamento b
				where	b.nr_seq_local 	= NEW.nr_sequencia
				and	b.ie_situacao 	= 'A'
				and	a.nr_seq_equip	= b.nr_sequencia)
		and	ie_situacao = 'A';

		if (qt_existe_w > 0) then
			/*(-20011,'Existem regras de planejamento preventivo ativas para equipamentos desta localização.' ||
						'#@#@');*/
			CALL wheb_mensagem_pck.exibir_mensagem_abort(263155);
		end if;
	end if;
	end;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_man_localizacao_atual() FROM PUBLIC;

CREATE TRIGGER man_localizacao_atual
	BEFORE UPDATE ON man_localizacao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_man_localizacao_atual();

