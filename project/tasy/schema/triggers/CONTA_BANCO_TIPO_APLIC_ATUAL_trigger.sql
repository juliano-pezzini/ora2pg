-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS conta_banco_tipo_aplic_atual ON conta_banco_tipo_aplic CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_conta_banco_tipo_aplic_atual() RETURNS trigger AS $BODY$
declare

ds_historico_w		varchar(255);

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
if (NEW.ds_tipo_aplicacao <> OLD.ds_tipo_aplicacao) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354769,'VALOR_ANTIGO='||OLD.ds_tipo_aplicacao||';VALOR_NOVO='||NEW.ds_tipo_aplicacao),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.ie_forma_lancamento <> OLD.ie_forma_lancamento) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354771,'VALOR_ANTIGO='||obter_descricao_dominio(7602,OLD.ie_forma_lancamento)
								||';VALOR_NOVO='||obter_descricao_dominio(7602,NEW.ie_forma_lancamento)),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.ie_forma_rend <> OLD.ie_forma_rend) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354771,'VALOR_ANTIGO='||obter_descricao_dominio(7601,OLD.ie_forma_rend)
								||';VALOR_NOVO='||obter_descricao_dominio(7601,NEW.ie_forma_rend)),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.nr_seq_trans_fin_rend <> OLD.nr_seq_trans_fin_rend) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354771,'VALOR_ANTIGO='||obter_ds_transacao(OLD.nr_seq_trans_fin_rend)
								||';VALOR_NOVO='||obter_ds_transacao(NEW.nr_seq_trans_fin_rend)),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.nr_seq_trans_fin_resg <> OLD.nr_seq_trans_fin_resg) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354771,'VALOR_ANTIGO='||obter_ds_transacao(OLD.nr_seq_trans_fin_resg)
								||';VALOR_NOVO='||obter_ds_transacao(NEW.nr_seq_trans_fin_resg)),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.ie_tipo_aplic_fixa <> OLD.ie_tipo_aplic_fixa) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354771,'VALOR_ANTIGO='||obter_descricao_dominio(7604,OLD.ie_tipo_aplic_fixa)
								||';VALOR_NOVO='||obter_descricao_dominio(7604,NEW.ie_tipo_aplic_fixa)),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.ie_tipo_fundo <> OLD.ie_tipo_fundo) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354771,'VALOR_ANTIGO='||obter_descricao_dominio(7603,OLD.ie_tipo_fundo)
								||';VALOR_NOVO='||obter_descricao_dominio(7603,NEW.ie_tipo_fundo)),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.ie_carencia_obrig <> OLD.ie_carencia_obrig) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354771,'VALOR_ANTIGO='||obter_descricao_dominio(6,OLD.ie_carencia_obrig)
								||';VALOR_NOVO='||obter_descricao_dominio(6,NEW.ie_carencia_obrig)),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.nr_dias_carencia <> OLD.nr_dias_carencia) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354769,'VALOR_ANTIGO='||to_char(OLD.nr_dias_carencia)
								||';VALOR_NOVO='||to_char(NEW.nr_dias_carencia)),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.ie_tipo_prazo <> OLD.ie_tipo_prazo) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354771,'VALOR_ANTIGO='||obter_descricao_dominio(7605,OLD.ie_tipo_prazo)
								||';VALOR_NOVO='||obter_descricao_dominio(7605,NEW.ie_tipo_prazo)),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.vl_taxa_rend <> OLD.vl_taxa_rend) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354769,'VALOR_ANTIGO='||to_char(OLD.vl_taxa_rend,'999,999,999.99')
								||';VALOR_NOVO='||to_char(NEW.vl_taxa_rend,'999,999,999.99')),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.nr_dias_rend <> OLD.nr_dias_rend) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354769,'VALOR_ANTIGO='||to_char(OLD.nr_dias_rend)
								||';VALOR_NOVO='||to_char(NEW.nr_dias_rend)),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.vl_min_aplic <> OLD.vl_min_aplic) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354769,'VALOR_ANTIGO='||to_char(OLD.vl_min_aplic,'999,999,999.99')
								||';VALOR_NOVO='||to_char(NEW.vl_min_aplic,'999,999,999.99')),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.vl_min_resg <> OLD.vl_min_resg) then
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(354769,'VALOR_ANTIGO='||to_char(OLD.vl_min_resg,'999,999,999.99')
								||';VALOR_NOVO='||to_char(NEW.vl_min_resg,'999,999,999.99')),0,254);
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

if (NEW.ie_situacao <> OLD.ie_situacao) then
	select substr(wheb_mensagem_pck.get_texto(354769,'VALOR_ANTIGO='||CASE WHEN OLD.ie_situacao='A' THEN wheb_mensagem_pck.get_texto(354788)  ELSE wheb_mensagem_pck.get_texto(354792) END
							||';VALOR_NOVO='||CASE WHEN NEW.ie_situacao='A' THEN wheb_mensagem_pck.get_texto(354788)  ELSE wheb_mensagem_pck.get_texto(354792) END ),0,254)
	into STRICT	ds_historico_w
	;
	
	insert into tipo_aplicacao_hist(
		nr_sequencia,
		cd_estabelecimento,
		ds_historico,
		nr_seq_tipo_aplic,
		nm_usuario,
		dt_atualizacao)
	values (nextval('tipo_aplicacao_hist_seq'),
		NEW.cd_estabelecimento,
		ds_historico_w,
		NEW.nr_sequencia,
		NEW.nm_usuario,
		LOCALTIMESTAMP);
	
end if;

end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_conta_banco_tipo_aplic_atual() FROM PUBLIC;

CREATE TRIGGER conta_banco_tipo_aplic_atual
	AFTER UPDATE ON conta_banco_tipo_aplic FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_conta_banco_tipo_aplic_atual();

