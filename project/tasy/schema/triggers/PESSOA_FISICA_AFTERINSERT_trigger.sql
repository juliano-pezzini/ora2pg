-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pessoa_fisica_afterinsert ON pessoa_fisica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pessoa_fisica_afterinsert() RETURNS trigger AS $BODY$
DECLARE

cd_setor_atendimento_w	integer;
ie_setor_origem_w	varchar(1); --Ivan em 10/08/2007 OS60862
nr_seq_set_origem_w	bigint;  --Ivan em 10/08/2007 OS60862
ie_regra_pront_w	varchar(15);
sg_estado_w		compl_pessoa_fisica.sg_estado%type;

BEGIN

if (NEW.nr_prontuario is not null) then

	select	coalesce(max(vl_parametro),'BASE')
	into STRICT	ie_regra_pront_w
	from	funcao_parametro
	where	cd_funcao	= 0
	and	nr_sequencia	= 120;

	if (ie_regra_pront_w <> 'ESTAB') then
		CALL gerar_same_cpi_prontuario(	NEW.nr_prontuario, NEW.cd_pessoa_fisica, NEW.cd_estabelecimento,NEW.nm_usuario);
	end if;
end if;

CALL gerar_regra_prontuario_gestao(null, NEW.cd_estabelecimento, null, NEW.cd_pessoa_fisica, NEW.nm_usuario, null, null, null, null, null, null, null);

/* Início - Ivan em 10/08/2007 OS60862 */

ie_setor_origem_w := Obter_Param_Usuario(32, 19, obter_perfil_ativo, NEW.nm_usuario, coalesce(NEW.cd_estabelecimento,0), ie_setor_origem_w);

if (ie_setor_origem_w = 'S') then
	BEGIN

	select	coalesce(max(cd_setor_atendimento),0)
	into STRICT	cd_setor_atendimento_w
	from	usuario
	where	nm_usuario	= NEW.nm_usuario;

	if (cd_setor_atendimento_w > 0) then
		BEGIN

		select	nextval('pf_setor_prontuario_seq')
		into STRICT	nr_seq_set_origem_w
		;

		insert into pf_setor_prontuario(
			nr_sequencia,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			cd_pessoa_fisica,
			cd_setor_atendimento,
			dt_inicio_cinculo)
		values (
			nr_seq_set_origem_w,
			LOCALTIMESTAMP,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			NEW.nm_usuario,
			NEW.cd_pessoa_fisica,
			cd_setor_atendimento_w,
			LOCALTIMESTAMP
		);

		end;
	end if;

	end;
end if;

/* Projeto MXM (7077)  - Exportar cadastro pessoa fisica */

select 	max(sg_estado)
into STRICT	sg_estado_w
from 	compl_pessoa_fisica
where 	cd_pessoa_fisica = NEW.cd_pessoa_fisica
and 	coalesce(ie_tipo_complemento,1) = 1;
if (NEW.nr_cpf is not null and sg_estado_w is not null) then
	CALL gravar_agend_integracao(556,'CD_PESSOA_FISICA='||NEW.cd_pessoa_fisica||';CD_PESSOA_JURIDICA='||null||';'); --Fornecedor
	CALL gravar_agend_integracao(562,'CD_PESSOA_FISICA='||NEW.cd_pessoa_fisica||';'); --Cliente
end if;
/* Término - Ivan em 10/08/2007 OS60862 */

CALL recent_patients_found_handler(null, NEW.cd_pessoa_fisica, NEW.nm_usuario, 'S');

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pessoa_fisica_afterinsert() FROM PUBLIC;

CREATE TRIGGER pessoa_fisica_afterinsert
	AFTER INSERT ON pessoa_fisica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pessoa_fisica_afterinsert();

