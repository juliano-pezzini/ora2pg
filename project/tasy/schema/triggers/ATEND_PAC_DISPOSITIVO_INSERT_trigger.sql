-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_pac_dispositivo_insert ON atend_pac_dispositivo CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_pac_dispositivo_insert() RETURNS trigger AS $BODY$
declare

cd_pessoa_fisica_w		varchar(10);
qt_itens_w			bigint;
nr_seq_tecnica_w		bigint;
nr_seq_local_w			bigint;

C01 CURSOR FOR
	SELECT	nr_seq_tecnica,
		nr_seq_local
	from	hd_regra_acesso_disp
	where	ie_situacao = 'A'
	and	NR_SEQ_DISPOSITIVO = NEW.NR_SEQ_DISPOSITIVO;

BEGIN

select	cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from	atendimento_paciente
where	nr_atendimento = NEW.nr_atendimento;

select 	count(*)
into STRICT	qt_itens_w
from	hd_pac_renal_cronico
where	cd_pessoa_fisica = cd_pessoa_fisica_w;

if (qt_itens_w > 0) then

	open C01;
	loop
	fetch C01 into
		nr_seq_tecnica_w,
		nr_seq_local_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		BEGIN

		insert into	hd_acesso(NR_SEQUENCIA,
						DT_ATUALIZACAO,
						NM_USUARIO,
						DT_ATUALIZACAO_NREC,
						NM_USUARIO_NREC,
						CD_PESSOA_FISICA,
						NR_SEQ_LOCAL,
						NR_SEQ_TECNICA,
						DT_INSTALACAO)
		values (		nextval('hd_acesso_seq'),
						LOCALTIMESTAMP,
						NEW.nm_usuario,
						LOCALTIMESTAMP,
						NEW.nm_usuario,
						cd_pessoa_fisica_w,
						nr_seq_local_w,
						nr_seq_tecnica_w,
						LOCALTIMESTAMP);

		end;
	end loop;
	close C01;

end if;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_pac_dispositivo_insert() FROM PUBLIC;

CREATE TRIGGER atend_pac_dispositivo_insert
	BEFORE INSERT ON atend_pac_dispositivo FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_pac_dispositivo_insert();

