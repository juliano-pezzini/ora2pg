-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS medico_equipe_area ON domicilio_familia CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_medico_equipe_area() RETURNS trigger AS $BODY$
DECLARE

CD_MEDICO_W varchar(100);

NR_SEQ_EQUIPE_W  bigint;

BEGIN

	SELECT MAX(NR_SEQ_EQUIPE) INTO STRICT NR_SEQ_EQUIPE_W
		FROM PSF_AREA
		WHERE NR_SEQUENCIA =COALESCE(NEW.NR_SEQ_AREA,-1);

	IF (NR_SEQ_EQUIPE_W IS NOT NULL) THEN

	SELECT MAX(CD_PESSOA_FISICA)
		INTO STRICT CD_MEDICO_W
		FROM PF_EQUIPE
		WHERE NR_SEQUENCIA = NR_SEQ_EQUIPE_W;

	END IF;

	IF (CD_MEDICO_W IS NOT NULL) THEN

	UPDATE PESSOA_FISICA
		SET DT_ATUALIZACAO     = LOCALTIMESTAMP,
		NM_USUARIO           = WHEB_USUARIO_PCK.GET_NM_USUARIO,
		CD_MEDICO            = CD_MEDICO_W
		WHERE CD_PESSOA_FISICA = NEW.CD_PESSOA_FISICA;

	END IF;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_medico_equipe_area() FROM PUBLIC;

CREATE TRIGGER medico_equipe_area
	AFTER INSERT OR UPDATE ON domicilio_familia FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_medico_equipe_area();

