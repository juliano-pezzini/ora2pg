-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_regra_preco_anexo_atual ON pls_regra_preco_anexo CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_regra_preco_anexo_atual() RETURNS trigger AS $BODY$
declare
ds_alteracao_w 	varchar(4000);
ds_log_w	pls_regra_preco_anexo_log.ds_log%type;

BEGIN

ds_alteracao_w  := null;
ds_log_w	:= '';

if (coalesce(OLD.ds_anexo, 'X') <> coalesce(NEW.ds_anexo, 'X')) then
	ds_alteracao_w	:= ' alterado o campo Anexo valor anterior: '||OLD.ds_anexo||' valor atual: '||NEW.ds_anexo;
end if;

if (coalesce(OLD.ds_documento, 'X') <> coalesce(NEW.ds_documento, 'X')) then

	if (ds_alteracao_w is not null) then
		ds_alteracao_w	:= ds_alteracao_w ||';';
	end if;

	ds_alteracao_w	:=  ds_alteracao_w ||' alterado o campo Documento valor anterior: '||OLD.ds_documento||' valor atual: '||NEW.ds_documento;

end if;

if (OLD.dt_fim_vigencia 			<> NEW.dt_fim_vigencia) or
	 (OLD.dt_fim_vigencia is null AND NEW.dt_fim_vigencia is not null) or
	 (OLD.dt_fim_vigencia is not null AND NEW.dt_fim_vigencia is null) then

	if (ds_alteracao_w is not null) then
		ds_alteracao_w	:= ds_alteracao_w ||';';
	end if;

	ds_alteracao_w	:= ds_alteracao_w ||' alterado o campo Dt fim vigência valor anterior: '||OLD.dt_fim_vigencia||' valor atual: '||NEW.dt_fim_vigencia;

end if;

if (OLD.dt_inicio_vigencia 		<> NEW.dt_inicio_vigencia) or
	 (OLD.dt_inicio_vigencia is null AND NEW.dt_inicio_vigencia is not null)or
	 (OLD.dt_inicio_vigencia is not null AND NEW.dt_inicio_vigencia is null)then

	if (ds_alteracao_w is not null) then
		ds_alteracao_w	:= ds_alteracao_w ||';';
	end if;

	ds_alteracao_w	:= ds_alteracao_w ||' alterado o campo Dt início vigência valor anterior: '||OLD.dt_inicio_vigencia||' valor atual: '||NEW.dt_inicio_vigencia;

end if;

if (ds_alteracao_w is not null) then

	ds_log_w := 'Alteraçõe(s) efetuada(s): '||ds_alteracao_w;

	insert into pls_regra_preco_anexo_log( 	nr_sequencia,				dt_atualizacao,		nm_usuario,
			dt_atualizacao_nrec,			nm_usuario_nrec,  	nr_seq_regra_preco_anexo,  	ds_log)
		SELECT	nextval('pls_regra_preco_anexo_log_seq'), LOCALTIMESTAMP,		NEW.nm_usuario,
			LOCALTIMESTAMP, 				NEW.nm_usuario,	NEW.nr_sequencia, 		ds_log_w
		;
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_regra_preco_anexo_atual() FROM PUBLIC;

CREATE TRIGGER pls_regra_preco_anexo_atual
	AFTER UPDATE ON pls_regra_preco_anexo FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_regra_preco_anexo_atual();

