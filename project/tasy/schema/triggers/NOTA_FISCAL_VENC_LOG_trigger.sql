-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS nota_fiscal_venc_log ON nota_fiscal_venc CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_nota_fiscal_venc_log() RETURNS trigger AS $BODY$
declare
ds_log_w	log_tasy.ds_log%type;
ds_perfil_w	perfil.ds_perfil%type;

BEGIN

select	max(substr(OBTER_DESC_PERFIL(obter_perfil_ativo),1,30))
into STRICT	ds_perfil_w
;
	
if (TG_OP = 'UPDATE') then
	
	ds_log_w	:=  'Alteração de vencimento' || chr(13) || chr(10) ||
						'Sequencia da NF: ' || NEW.nr_sequencia || chr(13) || chr(10) ||
						'Data venc antiga: ' || to_char(OLD.dt_vencimento,'dd/mm/yyyy') || chr(13) || chr(10) ||
						'Data venc nova: ' || to_char(NEW.dt_vencimento,'dd/mm/yyyy') || chr(13) || chr(10) ||
						'Data alteração: ' || to_char(LOCALTIMESTAMP,'dd/mm/yyyy hh24:mi:ss') || chr(13) || chr(10) ||
						'Valor antigo: ' || OLD.vl_vencimento  || chr(13) || chr(10) ||
						'Valor novo: ' || NEW.vl_vencimento  || chr(13) || chr(10) ||
						'Título:' || NEW.nr_titulo_pagar  || chr(13) || chr(10) ||
						'Usuário: ' || wheb_usuario_pck.get_nm_usuario || chr(13) || chr(10) ||
						'Perfil: ' || ds_perfil_w || chr(13) || chr(10) ||
						'Função: ' || substr(OBTER_DESC_FUNCAO(Obter_Funcao_Ativa),1,20) ||
						'Call stack: ' || substr(dbms_utility.format_call_stack,1,1000);
	
	CALL gravar_log_tasy(55911,ds_log_w,coalesce(wheb_usuario_pck.get_nm_usuario,NEW.nm_usuario));

elsif (TG_OP = 'INSERT') then
	
	ds_log_w	:=  'Inserção de vencimento' || chr(13) || chr(10) ||
						'Sequencia da NF: ' || NEW.nr_sequencia || chr(13) || chr(10) ||
						'Data venc: ' || to_char(NEW.dt_vencimento,'dd/mm/yyyy') || chr(13) || chr(10) ||
						'Data inserção: ' || to_char(LOCALTIMESTAMP,'dd/mm/yyyy hh24:mi:ss') || chr(13) || chr(10) ||
						'Valor: ' || NEW.vl_vencimento  || chr(13) || chr(10) ||
						'Título:' || NEW.nr_titulo_pagar  || chr(13) || chr(10) ||
						'Usuário: ' || wheb_usuario_pck.get_nm_usuario || chr(13) || chr(10) ||
						'Perfil: ' || ds_perfil_w || chr(13) || chr(10) ||
						'Função: ' || substr(OBTER_DESC_FUNCAO(Obter_Funcao_Ativa),1,20) ||
						'Call stack: ' || substr(dbms_utility.format_call_stack,1,1000);
	
	CALL gravar_log_tasy(55912,ds_log_w,coalesce(wheb_usuario_pck.get_nm_usuario,NEW.nm_usuario));


elsif (TG_OP = 'DELETE') then

	ds_log_w	:=  'Exclusão de vencimento' || chr(13) || chr(10) ||
						'Sequencia da NF: ' || OLD.nr_sequencia || chr(13) || chr(10) ||
						'Data venc: ' || to_char(OLD.dt_vencimento,'dd/mm/yyyy') || chr(13) || chr(10) ||
						'Data exclusão: ' || to_char(LOCALTIMESTAMP,'dd/mm/yyyy hh24:mi:ss') || chr(13) || chr(10) ||
						'Valor: ' || OLD.vl_vencimento  || chr(13) || chr(10) ||
						'Título:' || OLD.nr_titulo_pagar  || chr(13) || chr(10) ||
						'Usuário: ' || wheb_usuario_pck.get_nm_usuario || chr(13) || chr(10) ||
						'Perfil: ' || ds_perfil_w || chr(13) || chr(10) ||
						'Função: ' || substr(OBTER_DESC_FUNCAO(Obter_Funcao_Ativa),1,20) ||
						'Call stack: ' || substr(dbms_utility.format_call_stack,1,1000);
	
	CALL gravar_log_tasy(55913,ds_log_w,coalesce(wheb_usuario_pck.get_nm_usuario,NEW.nm_usuario));
	
end if;

IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_nota_fiscal_venc_log() FROM PUBLIC;

CREATE TRIGGER nota_fiscal_venc_log
	BEFORE INSERT OR UPDATE OR DELETE ON nota_fiscal_venc FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_nota_fiscal_venc_log();

