-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pessoa_juridica_estab_atual ON pessoa_juridica_estab CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pessoa_juridica_estab_atual() RETURNS trigger AS $BODY$
declare
ds_razao_social_w				pessoa_juridica.ds_razao_social%type;
nm_fantasia_w				varchar(80);
ds_nome_abrev_w				varchar(50);
cd_municipio_ibge_w			varchar(6);
cd_cep_w				varchar(15);
ds_endereco_w				varchar(40);
nr_endereco_w				varchar(10);
ds_complemento_w				varchar(255);
ds_bairro_w				varchar(40);
ds_municipio_w				varchar(40);
sg_estado_w				pessoa_juridica.sg_estado%type;
nr_telefone_w				varchar(15);
nr_fax_w					varchar(15);
nr_inscricao_estadual_w			varchar(20);
nr_inscricao_municipal_w			varchar(20);
cd_internacional_w				varchar(20);
ds_site_internet_w				varchar(255);
cd_pf_resp_tecnico_w			varchar(10);
ds_orgao_reg_resp_tecnico_w		varchar(10);
nr_autor_func_w				pessoa_juridica.nr_autor_func%type;
nr_alvara_sanitario_w			varchar(20);
nr_alvara_sanitario_munic_w			varchar(20);
nr_certificado_boas_prat_w			varchar(20);
cd_ans_w				varchar(20);
dt_validade_autor_func_w			timestamp;
dt_validade_alvara_sanit_w			timestamp;
dt_validade_cert_boas_prat_w		timestamp;
cd_cnes_w				varchar(20);
dt_validade_resp_tecnico_w			timestamp;
nr_registro_resp_tecnico_w			varchar(20);
dt_validade_alvara_munic_w			timestamp;
ds_resp_tecnico_w				varchar(255);
qt_existe_w				bigint;
BEGIN

select	count(*)
into STRICT	qt_existe_w
from	sup_parametro_integracao a,
	sup_int_regra_pj b
where	a.nr_sequencia = b.nr_seq_integracao
and	a.ie_evento = 'PJ'
and	a.ie_forma = 'E'
and	a.ie_situacao = 'A'
and	b.ie_situacao = 'A';

if (qt_existe_w > 0) and (NEW.nm_usuario <> 'INTEGR_TASY') then

	select	ds_razao_social,
		nm_fantasia,
		ds_nome_abrev,
		cd_municipio_ibge,
		cd_cep,
		ds_endereco,
		nr_endereco,
		ds_complemento,
		ds_bairro,
		ds_municipio,
		sg_estado,
		nr_telefone,
		nr_fax,
		nr_inscricao_estadual,
		nr_inscricao_municipal,
		cd_internacional,
		ds_site_internet,
		cd_pf_resp_tecnico,
		ds_orgao_reg_resp_tecnico,
		nr_autor_func,
		nr_alvara_sanitario,
		nr_alvara_sanitario_munic,
		nr_certificado_boas_prat,
		cd_ans,
		dt_validade_autor_func,
		dt_validade_alvara_sanit,
		dt_validade_cert_boas_prat,
		cd_cnes,
		dt_validade_resp_tecnico,
		nr_registro_resp_tecnico,
		dt_validade_alvara_munic,
		ds_resp_tecnico
	into STRICT	ds_razao_social_w,
		nm_fantasia_w,
		ds_nome_abrev_w,
		cd_municipio_ibge_w,
		cd_cep_w,
		ds_endereco_w,
		nr_endereco_w,
		ds_complemento_w,
		ds_bairro_w,
		ds_municipio_w,
		sg_estado_w,
		nr_telefone_w,
		nr_fax_w,
		nr_inscricao_estadual_w,
		nr_inscricao_municipal_w,
		cd_internacional_w,
		ds_site_internet_w,
		cd_pf_resp_tecnico_w,
		ds_orgao_reg_resp_tecnico_w,
		nr_autor_func_w,
		nr_alvara_sanitario_w,
		nr_alvara_sanitario_munic_w,
		nr_certificado_boas_prat_w,
		cd_ans_w,
		dt_validade_autor_func_w,
		dt_validade_alvara_sanit_w,
		dt_validade_cert_boas_prat_w,
		cd_cnes_w,
		dt_validade_resp_tecnico_w,
		nr_registro_resp_tecnico_w,
		dt_validade_alvara_munic_w,
		ds_resp_tecnico_w
	from	pessoa_juridica
	where	cd_cgc = NEW.cd_cgc;

	insert into sup_int_pj(
		nr_sequencia,
		ie_forma_integracao,
		dt_liberacao,
		cd_cgc,
		ds_razao_social,
		nm_fantasia,
		ds_nome_abrev,
		cd_municipio_ibge,
		cd_cep,
		ds_endereco,
		nr_endereco,
		ds_complemento,
		ds_bairro,
		ds_municipio,
		sg_estado,
		nr_telefone,
		nr_fax,
		nr_inscricao_estadual,
		nr_inscricao_municipal,
		cd_internacional,
		ds_site_internet,
		cd_pf_resp_tecnico,
		ds_orgao_reg_resp_tecnico,
		nr_autor_func,
		nr_alvara_sanitario,
		nr_alvara_sanitario_munic,
		nr_certificado_boas_prat,
		cd_ans,
		dt_validade_autor_func,
		dt_validade_alvara_sanit,
		dt_validade_cert_boas_prat,
		cd_cnes,
		dt_validade_resp_tecnico,
		nr_registro_resp_tecnico,
		dt_validade_alvara_munic,
		ds_resp_tecnico,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_referencia_fornec,
		ds_email,
		nm_pessoa_contato,
		nr_ramal_contato,
		qt_dia_prazo_entrega,
		vl_minimo_nf)
	values (	nextval('sup_int_pj_seq'),
		'E',
		LOCALTIMESTAMP,
		NEW.cd_cgc,
		substr(ds_razao_social_w,1,80),
		nm_fantasia_w,
		ds_nome_abrev_w,
		cd_municipio_ibge_w,
		cd_cep_w,
		ds_endereco_w,
		nr_endereco_w,
		ds_complemento_w,
		ds_bairro_w,
		ds_municipio_w,
		sg_estado_w,
		nr_telefone_w,
		nr_fax_w,
		nr_inscricao_estadual_w,
		nr_inscricao_municipal_w,
		cd_internacional_w,
		ds_site_internet_w,
		cd_pf_resp_tecnico_w,
		ds_orgao_reg_resp_tecnico_w,
		nr_autor_func_w,
		nr_alvara_sanitario_w,
		nr_alvara_sanitario_munic_w,
		nr_certificado_boas_prat_w,
		cd_ans_w,
		dt_validade_autor_func_w,
		dt_validade_alvara_sanit_w,
		dt_validade_cert_boas_prat_w,
		cd_cnes_w,
		dt_validade_resp_tecnico_w,
		nr_registro_resp_tecnico_w,
		dt_validade_alvara_munic_w,
		ds_resp_tecnico_w,
		LOCALTIMESTAMP,
		'INTEGR_TASY',
		LOCALTIMESTAMP,
		'INTEGR_TASY',
		NEW.cd_referencia_fornec,
		NEW.ds_email,
		NEW.nm_pessoa_contato,
		NEW.nr_ramal_contato,
		NEW.qt_dia_prazo_entrega,
		NEW.vl_minimo_nf);
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pessoa_juridica_estab_atual() FROM PUBLIC;

CREATE TRIGGER pessoa_juridica_estab_atual
	BEFORE INSERT OR UPDATE ON pessoa_juridica_estab FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pessoa_juridica_estab_atual();

