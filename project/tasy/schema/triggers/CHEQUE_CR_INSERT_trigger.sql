-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cheque_cr_insert ON cheque_cr CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cheque_cr_insert() RETURNS trigger AS $BODY$
declare
ie_pessoa_w	varchar(1);
dt_fechamento_w	timestamp	:= null;
nr_recibo_w	bigint;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
select	coalesce(max(ie_pessoa_cheque_cr),'N')
into STRICT	ie_pessoa_w
from	parametro_contas_receber
where	cd_estabelecimento	= NEW.cd_estabelecimento;

if (ie_pessoa_w = 'S') and (NEW.cd_pessoa_fisica is null and NEW.cd_cgc is null) then
	/* O cheque deve ser de uma pessoa fisica ou juridica! */


	CALL wheb_mensagem_pck.exibir_mensagem_abort(223996);
end if;

if (NEW.nr_seq_caixa_rec is not null) then
	select	max(dt_fechamento),
		max(nr_recibo)
	into STRICT	dt_fechamento_w,
		nr_recibo_w
	from	caixa_receb
	where	nr_sequencia	= NEW.nr_seq_caixa_rec;

	if (dt_fechamento_w is not null) then
		/* Nao e possivel inserir um novo cheque!
		O recibo nr_recibo_w ja foi fechado! */

		CALL wheb_mensagem_pck.exibir_mensagem_abort(223997,'NR_RECIBO_W='||nr_recibo_w);
	end if;
end if;

if (NEW.ie_forma_pagto is null) then

	if (trunc(coalesce(NEW.dt_registro,LOCALTIMESTAMP),'dd') = trunc(coalesce(NEW.dt_vencimento,LOCALTIMESTAMP),'dd')) then
		NEW.ie_forma_pagto	:= 'AV';
	else
		NEW.ie_forma_pagto	:= 'PD';
	end if;

end if;

/* Projeto Davita  - Nao deixa gerar movimento contabil apos fechamento  da data */


if ( NEW.dt_contabil is not null ) then
	CALL philips_contabil_pck.valida_se_dia_fechado(OBTER_EMPRESA_ESTAB(NEW.cd_estabelecimento),NEW.dt_contabil);
end if;

NEW.vl_saldo_negociado	:= NEW.vl_cheque;

end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cheque_cr_insert() FROM PUBLIC;

CREATE TRIGGER cheque_cr_insert
	BEFORE INSERT ON cheque_cr FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cheque_cr_insert();

