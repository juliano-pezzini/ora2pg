-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_prestador_plano_delete ON pls_prestador_plano CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_prestador_plano_delete() RETURNS trigger AS $BODY$
declare

qt_rotina_w	bigint := 0;
ds_chave_w	varchar(255);
nm_usuario_w	varchar(15);
BEGIN
  BEGIN
BEGIN
nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

ds_chave_w :=	substr('NR_SEQUENCIA='||OLD.nr_sequencia||',NR_SEQ_PRESTADOR='||OLD.nr_seq_prestador,1,255);

select	count(1)
into STRICT	qt_rotina_w
from 	v$session
where	audsid	= (SELECT userenv('sessionid') )
and	username = (select username from v$session where audsid = (select userenv('sessionid') ))
and	action like 'PLS_COPIA_PARAMETRO_PRESTADOR%';

if (qt_rotina_w > 0) then
	ds_chave_w := substr('Ação=Cópia de parâmetros do prestador,Opção=Excluir registros existentes,'||ds_chave_w,1,255);
else
	ds_chave_w := substr('Ação=Exclusão,'||ds_chave_w,1,255);
end if;

insert into log_exclusao(ds_chave,
	dt_atualizacao,
	nm_tabela,
	nm_usuario)
values (ds_chave_w,
	LOCALTIMESTAMP,
	'PLS_PRESTADOR_PLANO',
	nm_usuario_w);

exception
when others then
	null;
end;
  END;
RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_prestador_plano_delete() FROM PUBLIC;

CREATE TRIGGER pls_prestador_plano_delete
	AFTER DELETE ON pls_prestador_plano FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_prestador_plano_delete();

