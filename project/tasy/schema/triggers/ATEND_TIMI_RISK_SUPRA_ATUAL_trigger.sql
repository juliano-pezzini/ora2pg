-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_timi_risk_supra_atual ON atend_timi_risk_supra CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_timi_risk_supra_atual() RETURNS trigger AS $BODY$
DECLARE
qt_reg_w	smallint;
BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;
NEW.qt_escore_ano				:= 0;
NEW.qt_escore_dm_htn_angina		:= 0;
NEW.qt_escore_pas				:= 0;
NEW.qt_escore_fc				:= 0;
NEW.qt_escore_killip			:= 0;
NEW.qt_escore_peso				:= 0;
NEW.qt_escore_supra_st_ant_bre		:= 0;
NEW.qt_escore_tempo_rx			:= 0;

NEW.qt_escore				:= 0;
NEW.pr_risco_morte_30d			:= 0;

if (NEW.qt_ano > 74) then
	NEW.qt_escore_ano			:= 3;
elsif (NEW.qt_ano > 64) then
	NEW.qt_escore_ano			:= 2;
end if;
if (NEW.ie_dm_htn_angina = 'S') then
	NEW.qt_escore_dm_htn_angina	:= 1;
end if;
if (NEW.ie_pas = 'S') then
	NEW.qt_escore_pas			:= 3;
end if;
if (NEW.ie_fc = 'S') then
	NEW.qt_escore_fc			:= 2;
end if;
if (NEW.ie_peso = 'S') then
	NEW.qt_escore_peso			:= 1;
end if;
if (NEW.ie_killip = 'S') then
	NEW.qt_escore_killip		:= 2;
end if;
if (NEW.ie_supra_st_ant_bre = 'S') then
	NEW.qt_escore_supra_st_ant_bre	:= 1;
end if;
if (NEW.ie_tempo_rx = 'S') then
	NEW.qt_escore_tempo_rx		:= 1;
end if;

NEW.qt_escore				:=
		NEW.qt_escore_ano	+
		NEW.qt_escore_dm_htn_angina +
		NEW.qt_escore_pas +
		NEW.qt_escore_fc +
		NEW.qt_escore_killip +
		NEW.qt_escore_peso +
		NEW.qt_escore_tempo_rx +
		NEW.qt_escore_supra_st_ant_bre;

if (NEW.qt_escore = 0) then
	NEW.pr_risco_morte_30d		:= 0.8;
elsif (NEW.qt_escore = 1) then
	NEW.pr_risco_morte_30d		:= 1.6;
elsif (NEW.qt_escore = 2) then
	NEW.pr_risco_morte_30d		:= 2.2;
elsif (NEW.qt_escore = 3) then
	NEW.pr_risco_morte_30d		:= 4.4;
elsif (NEW.qt_escore = 4) then
	NEW.pr_risco_morte_30d		:= 7.3;
elsif (NEW.qt_escore = 5) then
	NEW.pr_risco_morte_30d		:= 12;
elsif (NEW.qt_escore = 6) then
	NEW.pr_risco_morte_30d		:= 16;
elsif (NEW.qt_escore = 7) then
	NEW.pr_risco_morte_30d		:= 23;
elsif (NEW.qt_escore = 8) then
	NEW.pr_risco_morte_30d		:= 27;
elsif (NEW.qt_escore > 8) then
	NEW.pr_risco_morte_30d		:= 36;
end if;
<<Final>>
qt_reg_w	:= 0;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_timi_risk_supra_atual() FROM PUBLIC;

CREATE TRIGGER atend_timi_risk_supra_atual
	BEFORE INSERT OR UPDATE ON atend_timi_risk_supra FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_timi_risk_supra_atual();

