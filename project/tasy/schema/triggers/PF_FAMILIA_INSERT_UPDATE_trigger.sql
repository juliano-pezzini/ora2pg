-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pf_familia_insert_update ON pf_familia CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pf_familia_insert_update() RETURNS trigger AS $BODY$
DECLARE
qtd_member_w smallint;
dependence_w smallint;
ie_grau_parentesco_w GRAU_PARENTESCO.IE_GRAU_PARENTESCO%type;
pragma autonomous_transaction;

function get_qtd_member_family(member_type_p bigint,
							   ie_gender_p text )
return bigint
as 
qtd_w smallint := 0;
BEGIN
	
	if (ie_gender_p is not null) then
		select count(*)
		into STRICT  qtd_w
		from pf_familia f,
		grau_parentesco g 
		where f.cd_pessoa_fisica = NEW.cd_pessoa_fisica	
		and f.NR_SEQ_GRAU_PARENTESCO = g.nr_sequencia
		and f.ie_gender = ie_gender_p
		and f.nr_sequencia <> NEW.nr_sequencia
		and g.IE_GRAU_PARENTESCO = member_type_p;
	else
		select count(*)
		into STRICT  qtd_w
		from pf_familia f,
		grau_parentesco g 
		where f.cd_pessoa_fisica = NEW.cd_pessoa_fisica	
		and f.NR_SEQ_GRAU_PARENTESCO = g.nr_sequencia
		and f.nr_sequencia <> NEW.nr_sequencia
		and g.IE_GRAU_PARENTESCO = member_type_p;
	end if;
	
	
	return qtd_w;

end;

BEGIN
	if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then
		if (TG_OP = 'INSERT' or ((TG_OP = 'UPDATE') and ((NEW.ie_gender <> OLD.ie_gender) or (NEW.NR_SEQ_GRAU_PARENTESCO <> OLD.NR_SEQ_GRAU_PARENTESCO)))) then
			select    max(IE_GRAU_PARENTESCO) ie_grau_parentesco
			into STRICT    ie_grau_parentesco_w
			from    grau_parentesco g
			where   nr_sequencia = NEW.NR_SEQ_GRAU_PARENTESCO;
			
			if (ie_grau_parentesco_w = 5) then -- 5 = Mae
			
				qtd_member_w := get_qtd_member_family(ie_grau_parentesco_w);
			
				if (qtd_member_w > 0) then
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153133);
			end if;
			elsif (ie_grau_parentesco_w = 6) then -- 6 - Pai
			
				qtd_member_w := get_qtd_member_family(ie_grau_parentesco_w);			
				
				if (qtd_member_w > 0) then
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153135);
				end if;	
			elsif (ie_grau_parentesco_w = 9) then -- 9 = Avo paterna(o)
			
				dependence_w := get_qtd_member_family(6); -- 6 = pai
				
				if (dependence_w = 0) then
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153113);
				end if;
				
				qtd_member_w := get_qtd_member_family(ie_grau_parentesco_w, NEW.ie_gender);
				
				if (qtd_member_w > 0) then
					if (NEW.ie_gender = 'M') then
						CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153118);
					elsif (NEW.ie_gender = 'F') then
						CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153127);
					end if;
				end if;
				
			elsif (ie_grau_parentesco_w = 12) then -- 12 = Avo(o) materna(o)
				
				dependence_w := get_qtd_member_family(5); -- 5 = mae
				
				if (dependence_w = 0) then
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153116);
				end if;
				
				qtd_member_w := get_qtd_member_family(ie_grau_parentesco_w, NEW.ie_gender);
				
				if (qtd_member_w > 0) then
					if (NEW.ie_gender = 'M') then
						CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153128);
					elsif (NEW.ie_gender = 'F') then
						CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153131);
					end if;
				end if;

			elsif (ie_grau_parentesco_w = 13) then -- 13 - Esposa(o)
				
				qtd_member_w := get_qtd_member_family(ie_grau_parentesco_w);
				
				if (qtd_member_w > 0) then
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153136);
				end if;
			
			elsif (ie_grau_parentesco_w = 15) then -- 15 = Sogra(o)
				
				dependence_w := get_qtd_member_family(13); --13 - Esposa(o)
				
				if (dependence_w = 0) then
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153117);
				end if;
				
				qtd_member_w := get_qtd_member_family(ie_grau_parentesco_w, NEW.ie_gender);
				
				if (qtd_member_w > 0) then
					if (NEW.ie_gender = 'M') then
						CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153582);
					elsif (NEW.ie_gender = 'F') then
						CALL Wheb_mensagem_pck.exibir_mensagem_abort(1153583);
					end if;
				end if;
			end if;
		end if;
	end if;	

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pf_familia_insert_update() FROM PUBLIC;

CREATE TRIGGER pf_familia_insert_update
	BEFORE INSERT OR UPDATE ON pf_familia FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pf_familia_insert_update();

