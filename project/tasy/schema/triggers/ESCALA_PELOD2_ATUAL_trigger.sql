-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_pelod2_atual ON escala_pelod_ii CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_pelod2_atual() RETURNS trigger AS $BODY$
declare

	cd_pessoa_fisica_w	       varchar(10);
	/*nr_idade_dias_w	 	       number(10, 0);*/


	nr_idade_meses_w	       bigint;
	/*logit_w			           number(15,4):= 0;*/


	qt_reg_w	               smallint;
	/*Medical Device*/


	sql_w                      varchar(200);
	qt_rel_pao2_fio2_w         smallint;
	qt_pto_paco2_w             smallint;
	qt_pto_vent_mecanica_w     smallint;
	qt_pto_pulmonar_w          smallint;
	qt_pto_glob_branco_w       smallint;
	qt_pto_plaquetas_w         smallint;
	qt_pto_hematologica_w      smallint;
    qt_pto_glasgow_w           smallint;
	qt_pto_pupila_fixa_w       smallint;
	qt_pto_snc_w               smallint;
	qt_pto_lactato_serico_w    real;
	qt_pto_pam_w               smallint;
	qt_pto_cardio_w            smallint;
	qt_pto_creatinina_serica_w smallint;
	qt_pto_renal_w             smallint;
	qt_pontuacao_w             smallint;
	pr_mortalidade_w           double precision;
    ds_erro_w   varchar(4000);
    ds_parametro_w  varchar(4000);
BEGIN
  BEGIN

	if (NEW.nr_hora is null) or (NEW.dt_avaliacao <> OLD.dt_avaliacao) then
		BEGIN  
			NEW.nr_hora := (to_char(round(NEW.dt_avaliacao,'hh24'), 'hh24'))::numeric;
		end;
	end if;
	
	if (wheb_usuario_pck.get_ie_executar_trigger = 'N')  then
		goto Final;
	end if;

	/* Obter pessoa fisica */


	select cd_pessoa_fisica
	  into STRICT cd_pessoa_fisica_w
	  from atendimento_paciente
	 where nr_atendimento = NEW.nr_atendimento;

	/* Obter a idade em meses */


	select coalesce(obter_idade_pf(cd_pessoa_fisica_w, NEW.dt_avaliacao, 'M'), 0)
	  into STRICT nr_idade_meses_w
	;

	
	/** Medical Device **/


	
	/* Pontuacao da relacao Pao2/Fio2*/


	BEGIN
        sql_w := 'call calcular_score_rel_pao2fio2_md(:1) into :qt_rel_pao2_fio2_w';
        EXECUTE sql_w using in NEW.qt_rel_pao2_fio2, out qt_rel_pao2_fio2_w;
    exception
        when others then
            qt_rel_pao2_fio2_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_rel_pao2_fio2: ' || NEW.qt_rel_pao2_fio2 || ' - qt_rel_pao2_fio2_w: ' || qt_rel_pao2_fio2_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'CALCULAR_SCORE_REL_PAO2FIO2_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
    NEW.qt_pto_rel_pao2_fio2 := qt_rel_pao2_fio2_w;

	/* Pontuacao do PaCO2*/


	BEGIN
        sql_w := 'call calcular_score_paco2_md(:1) into :qt_pto_paco2_w';	
        EXECUTE sql_w using in NEW.qt_paco2, out qt_pto_paco2_w;
    exception
        when others then
            qt_pto_paco2_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_paco2: ' || NEW.qt_paco2 || ' - qt_pto_paco2_w: ' || qt_pto_paco2_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'CALCULAR_SCORE_PACO2_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.qt_pto_paco2 := qt_pto_paco2_w;

	/* Pontuacao da ventilacao mecanica */


	BEGIN
        sql_w := 'call obter_score_venti_mecanica_md(:1) into :qt_pto_vent_mecanica_w';	
        EXECUTE sql_w using in NEW.ie_ventilacao_mecanica, out qt_pto_vent_mecanica_w;
    exception
        when others then
            qt_pto_vent_mecanica_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.ie_ventilacao_mecanica: ' || NEW.ie_ventilacao_mecanica || ' - qt_pto_vent_mecanica_w: ' || qt_pto_vent_mecanica_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'OBTER_SCORE_VENTI_MECANICA_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.qt_pto_vent_mecanica := qt_pto_vent_mecanica_w;

	/* Calcular Pontuacao Pulmonar */


    BEGIN
        sql_w := 'call calcular_score_pto_pulmonar_md(:1, :2, :3) into :qt_pto_pulmonar_w';	
        EXECUTE sql_w using in NEW.qt_pto_paco2, in NEW.qt_pto_vent_mecanica, in NEW.qt_pto_rel_pao2_fio2, out qt_pto_pulmonar_w;
	exception
        when others then
            qt_pto_pulmonar_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_pto_paco2: ' || NEW.qt_pto_paco2 || ' - :new.qt_pto_vent_mecanica: ' || NEW.qt_pto_vent_mecanica || ' - :new.qt_pto_rel_pao2_fio2: ' || NEW.qt_pto_rel_pao2_fio2 || ' - qt_pto_pulmonar_w: ' || qt_pto_pulmonar_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'CALCULAR_SCORE_PTO_PULMONAR_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.qt_pto_pulmonar := qt_pto_pulmonar_w;

	/* Pontuacao da Hematologica */


    BEGIN
        sql_w := 'call obter_score_hematologica_md(:1) into :qt_pto_glob_branco_w';	
        EXECUTE sql_w using in NEW.qt_globulos_brancos, out qt_pto_glob_branco_w;
    exception
        when others then
            qt_pto_glob_branco_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_globulos_brancos: ' || NEW.qt_globulos_brancos || ' - qt_pto_glob_branco_w: ' || qt_pto_glob_branco_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'OBTER_SCORE_HEMATOLOGICA_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;	
	NEW.qt_pto_glob_branco := qt_pto_glob_branco_w;

	BEGIN
        sql_w := 'call obter_score_plaquetas_md(:1) into :qt_pto_plaquetas_w';	
        EXECUTE sql_w using in NEW.qt_plaquetas, out qt_pto_plaquetas_w;
	exception
        when others then
            qt_pto_plaquetas_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_plaquetas: ' || NEW.qt_plaquetas || ' - qt_pto_plaquetas_w: ' || qt_pto_plaquetas_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'OBTER_SCORE_PLAQUETAS_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.qt_pto_plaquetas := qt_pto_plaquetas_w;	

    BEGIN
        sql_w := 'call calcular_score_hematologia_md(:1, :2) into :qt_pto_hematologica_w';	
        EXECUTE sql_w using in NEW.qt_pto_plaquetas, in NEW.qt_pto_glob_branco, out qt_pto_hematologica_w;
	exception
        when others then
            qt_pto_hematologica_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_plaquetas: ' || NEW.qt_plaquetas || ' - qt_pto_plaquetas_w: ' || qt_pto_plaquetas_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'CALCULAR_SCORE_HEMATOLOGIA_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.qt_pto_hematologica := qt_pto_hematologica_w;	

	/* Pontuacao da Neurologica */


    BEGIN
        sql_w := 'call obter_score_neurologia_md(:1) into :qt_pto_glasgow_w';	
        EXECUTE sql_w using in NEW.qt_glasgow, out qt_pto_glasgow_w;
	exception
        when others then
            qt_pto_glasgow_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_glasgow: ' || NEW.qt_glasgow || ' - qt_pto_glasgow_w: ' || qt_pto_glasgow_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'OBTER_SCORE_NEUROLOGIA_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
    NEW.qt_pto_glasgow := qt_pto_glasgow_w;

	BEGIN
        sql_w := 'call obter_score_pupila_fixa_md(:1) into :qt_pto_pupila_fixa_w';	
        EXECUTE sql_w using in NEW.ie_pupila_fixa, out qt_pto_pupila_fixa_w;
    exception
        when others then
            qt_pto_pupila_fixa_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.ie_pupila_fixa: ' || NEW.ie_pupila_fixa || ' - qt_pto_pupila_fixa_w: ' || qt_pto_pupila_fixa_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'OBTER_SCORE_PUPILA_FIXA_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;	
	NEW.qt_pto_pupila_fixa := qt_pto_pupila_fixa_w;	

	BEGIN
        sql_w := 'call calcular_score_snc_md(:1, :2) into :qt_pto_snc_w';	
        EXECUTE sql_w using in NEW.qt_pto_glasgow, in NEW.qt_pto_pupila_fixa, out qt_pto_snc_w;
	exception
        when others then
            qt_pto_snc_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_pto_glasgow: ' || NEW.qt_pto_glasgow || ' - :new.qt_pto_pupila_fixa: ' || NEW.qt_pto_pupila_fixa || ' - qt_pto_snc_w: ' || qt_pto_snc_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'OBTER_SCORE_PUPILA_FIXA_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.qt_pto_snc := qt_pto_snc_w;	

	/* Pontuacao da Cardiovascular */
	
	BEGIN
        sql_w := 'call obter_score_cardiovascular_md(:1) into :qt_pto_lactato_serico_w';	
        EXECUTE sql_w using in NEW.qt_lactato_serico, out qt_pto_lactato_serico_w;
	exception
        when others then
            qt_pto_lactato_serico_w := null;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_lactato_serico: ' || NEW.qt_lactato_serico || ' - qt_pto_lactato_serico_w: ' || qt_pto_lactato_serico_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'OBTER_SCORE_CARDIOVASCULAR_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.qt_pto_lactato_serico := qt_pto_lactato_serico_w;	

	BEGIN
        sql_w := 'call obter_score_qt_pam_md(:1, :2) into :qt_pto_pam_w';	
        EXECUTE sql_w using in nr_idade_meses_w, in NEW.qt_pam, out qt_pto_pam_w;
	exception
        when others then
            qt_pto_pam_w := null;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - nr_idade_meses_w: ' || nr_idade_meses_w || ' - :new.qt_pam: ' || NEW.qt_pam || ' - qt_pto_pam_w: ' || qt_pto_pam_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'OBTER_SCORE_QT_PAM_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.qt_pto_pam := qt_pto_pam_w;

	BEGIN
        sql_w := 'call calcular_score_cardio_md(:1, :2) into :qt_pto_cardio_w';	
        EXECUTE sql_w using in NEW.qt_pto_pam, in NEW.qt_pto_lactato_serico, out qt_pto_cardio_w;
	exception
        when others then
            qt_pto_cardio_w := null;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_pto_pam: ' || NEW.qt_pto_pam || ' - :new.qt_pto_lactato_serico: ' || NEW.qt_pto_lactato_serico || ' - qt_pto_cardio_w: ' || qt_pto_cardio_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'CALCULAR_SCORE_CARDIO_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.qt_pto_cardio := qt_pto_cardio_w;

	/* Pontuacao da Renal */


    BEGIN
        sql_w := 'begin obter_score_renal_md(:1, :2, :3, :4); end;';	
        EXECUTE sql_w using in NEW.qt_creatinina_serica,
                                      in nr_idade_meses_w,
                                      out qt_pto_creatinina_serica_w,
                                      out qt_pto_renal_w;
	exception
        when others then
            qt_pto_creatinina_serica_w := 0;
            qt_pto_renal_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_creatinina_serica: ' || NEW.qt_creatinina_serica || ' - nr_idade_meses_w: ' || nr_idade_meses_w || ' - qt_pto_creatinina_serica_w: ' || qt_pto_creatinina_serica_w || ' - qt_pto_renal_w: ' || qt_pto_renal_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'OBTER_SCORE_RENAL_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.qt_pto_creatinina_serica := qt_pto_creatinina_serica_w;	
	NEW.qt_pto_renal := qt_pto_renal_w;

	/* Pontuacao total */


    BEGIN
        sql_w := 'call calcular_score_total_md(:1, :2, :3, :4, :5) into :qt_pontuacao_w';	
        EXECUTE sql_w using in NEW.qt_pto_renal,
                                      in NEW.qt_pto_hematologica,
	                                  in NEW.qt_pto_cardio,
								      in NEW.qt_pto_pulmonar,
								      in NEW.qt_pto_snc,
								      out qt_pontuacao_w;
	exception
        when others then
            qt_pontuacao_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_pto_renal: ' || NEW.qt_pto_renal || ' - :new.qt_pto_hematologica: ' || NEW.qt_pto_hematologica || ' - :new.qt_pto_cardio: ' || NEW.qt_pto_cardio || ' - :new.qt_pto_pulmonar: ' || NEW.qt_pto_pulmonar
            || ' - :new.qt_pto_snc: ' || NEW.qt_pto_snc || ' - qt_pontuacao_w: ' || qt_pontuacao_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'CALCULAR_SCORE_TOTAL_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.qt_pontuacao := qt_pontuacao_w;

	/* Percentual de mortalidade*/


    BEGIN
        sql_w := 'call calcular_perc_mortalidade_md(:1) into :pr_mortalidade_w';	
        EXECUTE sql_w using in NEW.qt_pontuacao, out pr_mortalidade_w;
	exception
        when others then
            pr_mortalidade_w := 0;
            ds_erro_w := substr(sqlerrm, 1, 4000);
            ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
            || ' - :new.qt_pontuacao: ' || NEW.qt_pontuacao || ' - pr_mortalidade_w: ' || pr_mortalidade_w, 1, 4000);
            CALL gravar_log_medical_device('ESCALA_PELOD2_ATUAL', 'CALCULAR_PERC_MORTALIDADE_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;
	NEW.pr_mortalidade := pr_mortalidade_w;

	<<Final>>
	qt_reg_w := 0;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_pelod2_atual() FROM PUBLIC;

CREATE TRIGGER escala_pelod2_atual
	BEFORE INSERT OR UPDATE ON escala_pelod_ii FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_pelod2_atual();

