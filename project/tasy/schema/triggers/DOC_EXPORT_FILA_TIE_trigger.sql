-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS doc_export_fila_tie ON doc_export_fila CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_doc_export_fila_tie() RETURNS trigger AS $BODY$
DECLARE
  DS_JSON_W                text;
  JSON_W                   PHILIPS_JSON;
  JSON_PATIENT_W           PHILIPS_JSON;
  JSON_ENCOUNTER_W         PHILIPS_JSON;
  JSON_PERSON_IDENTIFIER_W PHILIPS_JSON;
  JSON_DOCUMENT_W          PHILIPS_JSON;
  CD_PESSOA_FISICA_W       PESSOA_FISICA.CD_PESSOA_FISICA%TYPE;

  FUNCTION GET_DOCUMENT RETURN PHILIPS_JSON_VALUE IS
    JSON_DOCUMENT_W PHILIPS_JSON := PHILIPS_JSON();
    DIRECTORY_W     DOC_EXPORT_FILA.DS_CAMINHO_RELATORIO%TYPE;
    FILE_NAME_W     DOC_EXPORT_FILA.DS_CAMINHO_RELATORIO%TYPE;
    EXTENSION_W     DOC_EXPORT_FILA.DS_CAMINHO_RELATORIO%TYPE;
  BEGIN
    SELECT SUBSTR(NEW.DS_CAMINHO_RELATORIO,
                  1,
                  INSTR(NEW.DS_CAMINHO_RELATORIO, '\', -1)) DIRECTORY,
           SUBSTR(NEW.DS_CAMINHO_RELATORIO,
                  INSTR(NEW.DS_CAMINHO_RELATORIO, '\', -1) + 1,
                  INSTR(NEW.DS_CAMINHO_RELATORIO, '.', -1) -
                  INSTR(NEW.DS_CAMINHO_RELATORIO, '\', -1) - 1) FILE_NAME,
           SUBSTR(NEW.DS_CAMINHO_RELATORIO,
                  INSTR(NEW.DS_CAMINHO_RELATORIO, '.', -1) + 1) EXTENSION
      INTO STRICT DIRECTORY_W, FILE_NAME_W, EXTENSION_W
;

    JSON_DOCUMENT_W.PUT('id', NEW.DS_RELATORIO_ID);
    JSON_DOCUMENT_W.PUT('sequence', NEW.NR_SEQUENCIA);
    JSON_DOCUMENT_W.PUT('type', NEW.DS_RELATORIO);
    JSON_DOCUMENT_W.PUT('path', NEW.DS_CAMINHO_RELATORIO);
    JSON_DOCUMENT_W.PUT('directory', DIRECTORY_W);
    JSON_DOCUMENT_W.PUT('fileName', FILE_NAME_W);
    JSON_DOCUMENT_W.PUT('extension', EXTENSION_W);
    JSON_DOCUMENT_W.PUT('dateCreate',
                        TO_CHAR(NEW.DT_RELATORIO, 'MM/DD/YYYY HH24:MI:SS'));
    JSON_DOCUMENT_W.PUT('changeDate',
                        TO_CHAR(NEW.DT_RELATORIO_ALTERACAO,
                                'MM/DD/YYYY HH24:MI:SS'));

    RETURN JSON_DOCUMENT_W.TO_JSON_VALUE();
  END;

BEGIN
  IF (coalesce(NEW.NR_ATENDIMENTO, 0) > 0 AND
     wheb_usuario_pck.get_ie_executar_trigger = 'S') THEN
    CD_PESSOA_FISICA_W := OBTER_PESSOA_ATENDIMENTO(NEW.NR_ATENDIMENTO, 'C');

    JSON_W                   := PHILIPS_JSON();
    JSON_PATIENT_W           := PERSON_JSON_PCK.GET_PERSON(CD_PESSOA_FISICA_W);
    JSON_PERSON_IDENTIFIER_W := PERSON_JSON_PCK.GET_PERSON_IDENTIFIER(CD_PESSOA_FISICA_W);
    JSON_ENCOUNTER_W         := ENCOUNTER_JSON_PCK.GET_ENCOUNTER(NEW.NR_ATENDIMENTO);

    JSON_W.PUT('patient', JSON_PATIENT_W.TO_JSON_VALUE());
    JSON_W.PUT('patientIdentifier',
               JSON_PERSON_IDENTIFIER_W.TO_JSON_VALUE());
    JSON_W.PUT('visit', JSON_ENCOUNTER_W.TO_JSON_VALUE());
    JSON_W.PUT('document', GET_DOCUMENT());

    DBMS_LOB.CREATETEMPORARY(DS_JSON_W, TRUE);
    JSON_W.(DS_JSON_W);

    DS_JSON_W := BIFROST.SEND_INTEGRATION_CONTENT('document.data.export',
                                                  DS_JSON_W,
                                                  coalesce(WHEB_USUARIO_PCK.GET_NM_USUARIO,
                                                      NEW.NM_USUARIO));
  END IF;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_doc_export_fila_tie() FROM PUBLIC;

CREATE TRIGGER doc_export_fila_tie
	AFTER INSERT ON doc_export_fila FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_doc_export_fila_tie();

