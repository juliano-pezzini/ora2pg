-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pfcs_after_upd_org_address ON pfcs_address CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pfcs_after_upd_org_address() RETURNS trigger AS $BODY$
DECLARE
cd_cgc_w    pessoa_juridica.cd_cgc%type;

BEGIN

    if (NEW.nr_seq_organization is not null) then
        select max(cd_cgc)
        into STRICT cd_cgc_w
        from estabelecimento
        where cd_estabelecimento = (
            SELECT aux.cd_estabelecimento
            from pfcs_organization aux
            where aux.nr_sequencia = NEW.nr_seq_organization
            and aux.nr_seq_organization_sup is not null
        );

        if (cd_cgc_w is not null) then
            update pessoa_juridica
            set ds_endereco = coalesce(NEW.addr_line, ' '),
                cd_cep = coalesce(NEW.postal_code, ' '),
                ds_municipio = coalesce(NEW.city, ' '),
                dt_atualizacao = LOCALTIMESTAMP
            where cd_cgc = cd_cgc_w;
        end if;
    end if;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pfcs_after_upd_org_address() FROM PUBLIC;

CREATE TRIGGER pfcs_after_upd_org_address
	AFTER UPDATE ON pfcs_address FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pfcs_after_upd_org_address();

