-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_snapii_snappeii_befins ON escala_snapii_snappeii CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_snapii_snappeii_befins() RETURNS trigger AS $BODY$
DECLARE
    qt_peso_percentil_w  bigint;
    qt_peso_atual_kg_w   double precision;
    qt_diurese_w         double precision;
    qt_pto_peso_w        smallint := NULL;
    qt_reg_w             smallint;
    exec_w               varchar(300);
    ds_erro_w            varchar(4000);
    ds_parametros_w      varchar(4000);
BEGIN
  BEGIN
    IF ( NEW.nr_hora IS NULL ) OR ( NEW.dt_avaliacao <> OLD.dt_avaliacao ) THEN
        BEGIN
            NEW.nr_hora := (to_char(round(NEW.dt_avaliacao, 'hh24'), 'hh24'))::numeric;

        END;
    END IF;

    IF ( wheb_usuario_pck.get_ie_executar_trigger = 'N' ) THEN
        GOTO final;
    END IF;
    BEGIN
        exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PAO2_FIO2_MD(:1) INTO :result';
        EXECUTE exec_w
            USING IN NEW.qt_rel_po2_fio2, OUT NEW.qt_pto_rel_po2_fio2;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_rel_po2_fio2: '||NEW.qt_rel_po2_fio2||'-'||':new.qt_pto_rel_po2_fio2: '||NEW.qt_pto_rel_po2_fio2);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PAO2_FIO2_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            NEW.qt_pto_rel_po2_fio2 := NULL;
    END;

	if (NEW.qt_pa_diastolica is not null) and (NEW.qt_pa_sistolica is not null) then

		BEGIN
			exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PAM_MD(:1, :2) INTO :result';
			EXECUTE exec_w
				USING IN NEW.qt_pa_diastolica, IN NEW.qt_pa_sistolica, OUT NEW.qt_pam;

		EXCEPTION
			WHEN OTHERS THEN
		  ds_erro_w := sqlerrm;
		  ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
							  ':new.qt_pa_diastolica: '||NEW.qt_pa_diastolica||'-'||':new.qt_pa_sistolica: '||NEW.qt_pa_sistolica||'-'||':new.qt_pam: '||NEW.qt_pam);
		  CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PAM_MD'
									 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
			
				NEW.qt_pam := NULL;
		END;
	
	end if;

    BEGIN
        exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PTO_PAM_MD(:1) INTO :result';
        EXECUTE exec_w
            USING IN NEW.qt_pam, OUT NEW.qt_pto_pam;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_pam: '||NEW.qt_pam||'-'||':new.qt_pto_pam: '||NEW.qt_pto_pam);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PTO_PAM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            NEW.qt_pto_pam := NULL;
    END;

    BEGIN
        exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PTO_TEMP_MD(:1) INTO :result';
        EXECUTE exec_w
            USING IN NEW.qt_temp, OUT NEW.qt_pto_temp;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_temp: '||NEW.qt_temp||'-'||':new.qt_pto_temp: '||NEW.qt_pto_temp);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PTO_TEMP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            NEW.qt_pto_temp := NULL;
    END;

    BEGIN
        exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PTO_PH_SERICO_MD(:1) INTO :result';
        EXECUTE exec_w
            USING IN NEW.qt_ph_serico, OUT NEW.qt_pto_ph_serico;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_ph_serico: '||NEW.qt_ph_serico||'-'||':new.qt_pto_ph_serico: '||NEW.qt_pto_ph_serico);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PTO_PH_SERICO_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            NEW.qt_pto_ph_serico := NULL;
    END;

    BEGIN
        exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PTO_DIURESE_MD(:1, :2, :3) INTO :result';
        EXECUTE exec_w
            USING IN NEW.qt_peso, IN NEW.qt_peso_atual, IN NEW.qt_diurese, OUT NEW.qt_pto_diurese;

    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_peso: '||NEW.qt_peso||'-'||':new.qt_peso_atual: '||NEW.qt_peso_atual||'-'||':new.qt_diurese: '||NEW.qt_diurese||'-'||':new.qt_pto_diurese: '||NEW.qt_pto_diurese);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PTO_DIURESE_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');

            NEW.qt_pto_diurese := NULL;
    END;

    BEGIN
        exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PTO_CONVUL_MD(:1) INTO :result';
        EXECUTE exec_w
            USING IN NEW.ie_convulsao_multipla, OUT NEW.qt_pto_convul;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_convulsao_multipla: '||NEW.ie_convulsao_multipla||'-'||':new.qt_pto_convul: '||NEW.qt_pto_convul);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PTO_CONVUL_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');

            NEW.qt_pto_convul := NULL;
    END;

    BEGIN
        exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PTO_PESO_NASC_MD(:1) INTO :result';
        EXECUTE exec_w
            USING IN NEW.qt_peso, OUT NEW.qt_pto_peso;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_peso: '||NEW.qt_peso||'-'||':new.qt_pto_peso: '||NEW.qt_pto_peso);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PTO_PESO_NASC_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');

            NEW.qt_pto_peso := NULL;
    END;

    BEGIN
        exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PTO_IDADE_GEST_MD(:1,:2,:3,:4) INTO :result';
        EXECUTE exec_w
            USING IN OLD.qt_idade_gestacional, IN NEW.qt_idade_gestacional, IN NEW.qt_peso, IN NEW.qt_peso_atual, OUT NEW.qt_pto_idade_gest;

    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':old.qt_idade_gestacional: '||OLD.qt_idade_gestacional||'-'||':new.qt_idade_gestacional: '||NEW.qt_idade_gestacional||'-'||
                          ':new.qt_peso: '||NEW.qt_peso||'-'||':new.qt_peso_atual: '||NEW.qt_peso_atual||'-'||':new.qt_pto_idade_gest: '||NEW.qt_pto_idade_gest);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PTO_IDADE_GEST_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            NEW.qt_pto_idade_gest := NULL;
    END;

    BEGIN
        exec_w := 'BEGIN ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PTO_APGAR_MD(:1,:2,:3,:4); END;';
        EXECUTE exec_w
            USING IN NEW.qt_peso, IN NEW.qt_apgar_quinto_min, OUT qt_pto_peso_w, OUT NEW.qt_pto_apgar;

    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':old.qt_peso: '||OLD.qt_peso||'-'||':new.qt_apgar_quinto_min: '||NEW.qt_apgar_quinto_min||'-'||
                          'qt_pto_peso_w: '||qt_pto_peso_w||'-'||':new.qt_pto_apgar: '||NEW.qt_pto_apgar);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PTO_APGAR_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');

            qt_pto_peso_w := NULL;
            NEW.qt_pto_apgar := NULL;
    END;

    IF ( qt_pto_peso_w IS NOT NULL ) THEN
        NEW.qt_pto_peso := qt_pto_peso_w;
    END IF;

    BEGIN
        exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PTO_SNAP_II_MD(:1,:2,:3,:4,:5,:6) INTO :result';
        EXECUTE exec_w
            USING IN NEW.qt_pto_rel_po2_fio2, IN NEW.qt_pto_pam, IN NEW.qt_pto_temp, IN NEW.qt_pto_ph_serico, IN NEW.qt_pto_diurese,
            IN NEW.qt_pto_convul, OUT NEW.qt_snap_ii;

    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':old.qt_pto_rel_po2_fio2: '||OLD.qt_pto_rel_po2_fio2||'-'||':new.qt_pto_pam: '||NEW.qt_pto_pam||'-'||
                          ':new.qt_pto_temp: '||NEW.qt_pto_temp||'-'||':new.qt_pto_ph_serico: '||NEW.qt_pto_ph_serico||'-'||
                          ':new.qt_pto_diurese: '||NEW.qt_pto_diurese||'-'||':new.qt_pto_convul: '||NEW.qt_pto_convul||'-'||
                          ':new.qt_snap_ii: '||NEW.qt_snap_ii);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PTO_SNAP_II_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');

            NEW.qt_snap_ii := NULL;
    END;

    BEGIN
        exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PTO_SNAPPE_II_MD(:1,:2,:3,:4) INTO :result';
        EXECUTE exec_w
            USING IN NEW.qt_snap_ii, IN NEW.qt_pto_peso, IN NEW.qt_pto_idade_gest, IN NEW.qt_pto_apgar, OUT NEW.qt_snappe_ii;

    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':old.qt_snap_ii: '||OLD.qt_snap_ii||'-'||':new.qt_pto_peso: '||NEW.qt_pto_peso||'-'||
                          ':new.qt_pto_idade_gest: '||NEW.qt_pto_idade_gest||'-'||':new.qt_pto_apgar: '||NEW.qt_pto_apgar||'-'||
                          ':new.qt_snappe_ii: '||NEW.qt_snappe_ii);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PTO_SNAPPE_II_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            NEW.qt_snappe_ii := NULL;
    END;

    BEGIN
        exec_w := 'CALL ESC_SNAPPEII_BEFINS_MD_PCK.OBTER_SCORE_PTO_MORTAL_MD(:1,:2) INTO :result';
        EXECUTE exec_w
            USING IN NEW.qt_peso, IN NEW.qt_snappe_ii, OUT NEW.pr_mortalidade;

    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := ('ESC_SNAPPEII_BEFINS_MD_PCK - :new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':old.qt_peso: '||OLD.qt_peso||'-'||':new.qt_snappe_ii: '||NEW.qt_snappe_ii||'-'||
                          ':new.pr_mortalidade: '||NEW.pr_mortalidade);
      CALL gravar_log_medical_device('escala_snapii_snappeii_befins','OBTER_SCORE_PTO_MORTAL_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');

            NEW.pr_mortalidade := NULL;
    END;

    << final >> qt_reg_w := 0;
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_snapii_snappeii_befins() FROM PUBLIC;

CREATE TRIGGER escala_snapii_snappeii_befins
	BEFORE INSERT OR UPDATE ON escala_snapii_snappeii FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_snapii_snappeii_befins();

