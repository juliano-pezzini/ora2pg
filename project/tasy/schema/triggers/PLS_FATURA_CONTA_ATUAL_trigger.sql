-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_fatura_conta_atual ON pls_fatura_conta CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_fatura_conta_atual() RETURNS trigger AS $BODY$
declare

nr_seq_congenere_w		pls_congenere.nr_sequencia%type;
nr_seq_fatura_w			pls_fatura.nr_sequencia%type;
nr_seq_lote_w			pls_lote_faturamento.nr_sequencia%type;
ds_programa_w			varchar(255);
ds_observacao_w			pls_fatura_log.ds_observacao%type;

BEGIN
if (NEW.nr_seq_congenere is not null) and (NEW.nr_seq_fatura_evento is not null) then
	select	max(x.nr_seq_congenere),
		max(x.nr_sequencia),
		max(x.nr_seq_lote)
	into STRICT	nr_seq_congenere_w,
		nr_seq_fatura_w,
		nr_seq_lote_w
	from	pls_fatura	x,
		pls_fatura_evento w
	where	x.nr_sequencia	= w.nr_seq_fatura
	and	w.nr_sequencia	= NEW.nr_seq_fatura_evento;

	if (coalesce(nr_seq_congenere_w,0) <> NEW.nr_seq_congenere) then
		select	substr(max(program),1,254)
		into STRICT	ds_programa_w
		from	v$session
		where	audsid = (SELECT userenv('sessionid') )
		and	username = (select username from v$session where audsid = (select userenv('sessionid') ));

		ds_observacao_w := 	'PLS_FATURA_CONTA_ATUAL - '||ds_programa_w||
					' - PLS_FATURA_CONTA.NR_SEQ_CONGENERE: '||NEW.nr_seq_congenere||
					' - PLS_FATURA.NR_SEQ_CONGENERE: '||nr_seq_congenere_w;

		CALL pls_gerar_fatura_log( nr_seq_lote_w, nr_seq_fatura_w, NEW.nr_seq_conta, ds_observacao_w, 'FL', 'N', NEW.nm_usuario);
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_fatura_conta_atual() FROM PUBLIC;

CREATE TRIGGER pls_fatura_conta_atual
	BEFORE INSERT OR UPDATE ON pls_fatura_conta FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_fatura_conta_atual();

