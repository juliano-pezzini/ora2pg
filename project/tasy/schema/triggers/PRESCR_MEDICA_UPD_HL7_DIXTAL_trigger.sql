-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_medica_upd_hl7_dixtal ON prescr_medica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_medica_upd_hl7_dixtal() RETURNS trigger AS $BODY$
declare
ds_sep_bv_w		varchar(100);
ds_param_integ_hl7_w	varchar(4000);
 
nr_seq_interno_w	bigint;
qt_doenca_w		bigint;
nr_seq_proc_w		bigint;
nr_seq_bco_w		bigint;
nr_seq_nut_p_w		bigint;
nr_seq_nut_pac_w	bigint;
nr_seq_enteral_w	bigint;
nr_seq_gaso_w		bigint;
nr_seq_recomendacao_w	bigint;
nr_seq_oxig_w		bigint;
nr_seq_dieta_w		bigint;
nr_seq_jejum_w		bigint;
nr_seq_doenca_w		bigint;
ie_leito_monit		varchar(1);
 
c01 CURSOR FOR 
	SELECT	nr_sequencia 
	from	prescr_procedimento 
	where	nr_prescricao = NEW.nr_prescricao 
	and 	ie_tipo_proced <> 'G' 
	order by 1;
 
c02 CURSOR FOR 
	SELECT	nr_sequencia 
	from	prescr_solic_bco_sangue 
	where	nr_prescricao = NEW.nr_prescricao 
	order by 1;
	 
c03 CURSOR FOR 
	SELECT	nr_sequencia 
	from	nut_pac 
	where	nr_prescricao = NEW.nr_prescricao 
	order by 1;
 
c04 CURSOR FOR 
	SELECT	nr_sequencia 
	from	nut_paciente 
	where	nr_prescricao = NEW.nr_prescricao 
	order by 1;
 
c05 CURSOR FOR 
	SELECT	nr_sequencia 
	from	prescr_material 
	where	nr_prescricao = NEW.nr_prescricao 
	and	ie_agrupador = 8 
	order by 1;	
	 
c06 CURSOR FOR 
	SELECT	nr_sequencia 
	from	prescr_gasoterapia 
	where	nr_prescricao = NEW.nr_prescricao 
	order by 1;
	 
c07 CURSOR FOR 
	SELECT	nr_sequencia 
	from	prescr_recomendacao 
	where	nr_prescricao = NEW.nr_prescricao 
	order by 1;
 
c08 CURSOR FOR 
	SELECT	nr_sequencia 
	from	prescr_procedimento 
	where	nr_prescricao = NEW.nr_prescricao 
	and	ie_tipo_proced = 'G' 
	order by 1;	
	 
c09 CURSOR FOR 
	SELECT	nr_sequencia 
	from	prescr_dieta 
	where	nr_prescricao = NEW.nr_prescricao 
	order by 1;	
 
c10 CURSOR FOR 
	SELECT	nr_sequencia 
	from	rep_jejum 
	where	nr_prescricao = NEW.nr_prescricao 
	order by 1;
 
/*cursor c11 is 
	select	nr_sequencia 
	from	paciente_antec_clinico 
	where 	cd_pessoa_fisica = :new.cd_pessoa_fisica 
	order by 1;	*/
 
	 
BEGIN 
 
if	--((:new.dt_liberacao	is not null) and (:old.dt_liberacao	is null)) or 
	(NEW.dt_liberacao_medico is not null) and (OLD.dt_liberacao_medico is null) then 
	 
	ds_sep_bv_w := obter_separador_bv;
	 
	select	max(obter_atepacu_paciente( NEW.nr_atendimento ,'A')) 
	into STRICT	nr_seq_interno_w 
	;
	 
	select	coalesce(obter_se_leito_atual_monit(NEW.nr_atendimento),'N') 
	into STRICT	ie_leito_monit 
	;
 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_proc_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_proc='	  || nr_seq_proc_w	   || ds_sep_bv_w;	
			CALL gravar_agend_integracao(50, ds_param_integ_hl7_w);	
			end;
		end if;
		end;
	end loop;
	close C01;
	 
	open C02;
	loop 
	fetch C02 into	 
		nr_seq_bco_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_bco='	  || nr_seq_bco_w	   || ds_sep_bv_w;	
			CALL gravar_agend_integracao(50, ds_param_integ_hl7_w);	
			end;
		end if;		
		end;
	end loop;
	close C02;
	 
	open C03;
	loop 
	fetch C03 into	 
		nr_seq_nut_p_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_nut_p='	  || nr_seq_nut_p_w	   || ds_sep_bv_w;	
			CALL gravar_agend_integracao(50, ds_param_integ_hl7_w);
			end;
		end if;		
		end;
	end loop;
	close C03;
	 
	open C04;
	loop 
	fetch C04 into	 
		nr_seq_nut_pac_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_nut_pac='  || nr_seq_nut_pac_w	   || ds_sep_bv_w;	
			CALL gravar_agend_integracao(50, ds_param_integ_hl7_w);	
			end;
		end if;				
		end;
	end loop;
	close C04;
	 
	open C05;
	loop 
	fetch C05 into	 
		nr_seq_enteral_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_enteral='  || nr_seq_enteral_w	   || ds_sep_bv_w;	
			CALL gravar_agend_integracao(50, ds_param_integ_hl7_w);	
			end;
		end if;						
		end;
	end loop;
	close C05;
	 
	open C06;
	loop 
	fetch C06 into	 
		nr_seq_gaso_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_gaso='	  || nr_seq_gaso_w	   || ds_sep_bv_w;	
			CALL gravar_agend_integracao(50, ds_param_integ_hl7_w);	
			end;
		end if;								
		end;
	end loop;
	close C06;
	 
	open C07;
	loop 
	fetch C07 into	 
		nr_seq_recomendacao_w;
	EXIT WHEN NOT FOUND; /* apply on C07 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_recomend=' || nr_seq_recomendacao_w || ds_sep_bv_w;	
			CALL gravar_agend_integracao(50, ds_param_integ_hl7_w);	
			end;
		end if;										
		end;
	end loop;
	close C07;
	 
	open C08;
	loop 
	fetch C08 into	 
		nr_seq_oxig_w;
	EXIT WHEN NOT FOUND; /* apply on C08 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_oxig='   || nr_seq_oxig_w 	   || ds_sep_bv_w;	
			CALL gravar_agend_integracao(50, ds_param_integ_hl7_w);	
			end;
		end if;												
		end;
	end loop;
	close C08;
	 
		 
	select 	count(*) 
	into STRICT	qt_doenca_w 
	from 	paciente_antec_clinico 
	where 	cd_pessoa_fisica = NEW.cd_pessoa_fisica;
	 
	open C09;
	loop 
	fetch C09 into	 
		nr_seq_dieta_w;
	EXIT WHEN NOT FOUND; /* apply on C09 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_dieta='   || nr_seq_dieta_w 	   || ds_sep_bv_w;	
			CALL gravar_agend_integracao(51, ds_param_integ_hl7_w);	
			end;
		end if;			
		end;
	end loop;
	close C09;
	 
	open C10;
	loop 
	fetch C10 into	 
		nr_seq_jejum_w;
	EXIT WHEN NOT FOUND; /* apply on C10 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_jejum='   || nr_seq_jejum_w 	   || ds_sep_bv_w;	
			CALL gravar_agend_integracao(51, ds_param_integ_hl7_w);	
			end;
		end if;					
		end;
	end loop;
	close C10;
	 
	/*open C11; 
	loop 
	fetch C11 into	 
		nr_seq_doenca_w; 
	exit when C11%notfound; 
	 
		begin 
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || :new.cd_pessoa_fisica || ds_sep_bv_w || 
					'nr_atendimento='  || :new.nr_atendimento  || ds_sep_bv_w || 
					'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
					'nr_prescricao='  || :new.nr_prescricao  || ds_sep_bv_w || 
					'nr_seq_doenca='  || nr_seq_doenca_w 	   || ds_sep_bv_w;	 
		gravar_agend_integracao(52, ds_param_integ_hl7_w);	 
		 
		end; 
	end loop; 
	close C11;*/
 
	 
	 
	if (qt_doenca_w > 0) and (ie_leito_monit = 'S') then	 
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
					'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
					'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
					'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w;
			 
		CALL gravar_agend_integracao(52, ds_param_integ_hl7_w);
			 
	end if;
end if;
 
if (NEW.dt_suspensao is not null) and (OLD.dt_suspensao is null) then 
	 
	ds_sep_bv_w := obter_separador_bv;
	 
	select	max(obter_atepacu_paciente( NEW.nr_atendimento ,'A')) 
	into STRICT	nr_seq_interno_w 
	;
	 
	select	coalesce(obter_se_leito_atual_monit(NEW.nr_atendimento),'N') 
	into STRICT	ie_leito_monit 
	;
	 
	open C02;
	loop 
	fetch C02 into	 
		nr_seq_bco_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_bco='	  || nr_seq_bco_w	   || ds_sep_bv_w;	
			CALL gravar_agend_integracao(50, ds_param_integ_hl7_w);	
			end;
		end if;
		end;
	end loop;
	close C02;
	 
	open C03;
	loop 
	fetch C03 into	 
		nr_seq_nut_p_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
	 
		BEGIN 
		if (ie_leito_monit = 'S') then 
			BEGIN 
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w || 
						'nr_atendimento='  || NEW.nr_atendimento  || ds_sep_bv_w || 
						'nr_seq_interno='  || nr_seq_interno_w   || ds_sep_bv_w || 
						'nr_prescricao='  || NEW.nr_prescricao  || ds_sep_bv_w || 
						'nr_seq_nut_p='	  || nr_seq_nut_p_w	   || ds_sep_bv_w;	
			CALL gravar_agend_integracao(50, ds_param_integ_hl7_w);	
			end;
		end if;
		end;
	end loop;
	close C03;
	 
end if;
 
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_medica_upd_hl7_dixtal() FROM PUBLIC;

CREATE TRIGGER prescr_medica_upd_hl7_dixtal
	BEFORE INSERT OR UPDATE ON prescr_medica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_medica_upd_hl7_dixtal();

