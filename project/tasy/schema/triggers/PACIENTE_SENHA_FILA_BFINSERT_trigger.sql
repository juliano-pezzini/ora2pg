-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS paciente_senha_fila_bfinsert ON paciente_senha_fila CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_paciente_senha_fila_bfinsert() RETURNS trigger AS $BODY$
declare

	nr_prioridade_w	integer;
BEGIN

-- caso a senha seja gerada com um atendimento vinculado, adiciona 1 segundo à data de entrada na fila, simulando a ação de transferência de fila.
if (NEW.dt_vinculacao_senha is not null) then
	NEW.dt_entrada_fila := NEW.dt_geracao_senha + (1/24/60/60);
else
	NEW.dt_entrada_fila := NEW.dt_geracao_senha;
end if;

-- Caso a senha seja gerada com uma pessoa fisica vinculada, altera-a para prioritária de acordo com a Regra de prioridade de senhas (Shift+F11)
if (NEW.cd_pessoa_fisica is not null) then
	if (OBTER_SE_PAC_SENHA_PRIOR_REGRA(NEW.cd_pessoa_fisica) = 'S') then
		select	max(coalesce(nr_prioridade_padrao, nr_prioridade))
		into STRICT	nr_prioridade_w
		from	fila_espera_senha
		where	nr_sequencia = NEW.nr_seq_fila_senha;

		if (nr_prioridade_w is not null) then
			NEW.nr_prioridade := nr_prioridade_w - 1;
		end if;
	end if;
end if;

if (NEW.nr_prioridade is null) then

	select	max(nr_prioridade)
	into STRICT	nr_prioridade_w
	from	fila_espera_senha
	where	nr_sequencia = NEW.nr_seq_fila_senha;

	if (nr_prioridade_w is not null) then
		NEW.nr_prioridade := nr_prioridade_w;
	end if;

end if;

if (NEW.DS_MAQUINA_CHAMADA is not null) then
	NEW.DS_MAQUINA_CHAMADA_PESQUISA := padronizar_nome(NEW.DS_MAQUINA_CHAMADA);
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_paciente_senha_fila_bfinsert() FROM PUBLIC;

CREATE TRIGGER paciente_senha_fila_bfinsert
	BEFORE INSERT ON paciente_senha_fila FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_paciente_senha_fila_bfinsert();

