-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_glosa_evento_atual ON pls_glosa_evento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_glosa_evento_atual() RETURNS trigger AS $BODY$
declare

ie_tipo_w	pls_glosa_evento_log.ie_tipo%type;
nm_usuario_w	usuario.nm_usuario%type;
cd_motivo_tiss_w	varchar(10);

BEGIN
if (coalesce(wheb_usuario_pck.get_ie_executar_trigger,'S') = 'S')  then
	if (TG_OP = 'INSERT') then
		ie_tipo_w	:= 'I';
		/* Quando inserir, sempre vir com o padrão da versão */

		if (NEW.ie_plano_versao is not null) then
			NEW.ie_plano 		:= NEW.ie_plano_versao;

			if (NEW.cd_motivo_tiss is null) then
				select	max(cd_motivo_tiss)
				into STRICT	cd_motivo_tiss_w
				from	tiss_motivo_glosa a
				where	a.nr_sequencia	= NEW.nr_seq_motivo_glosa;

				NEW.cd_motivo_tiss	:= cd_motivo_tiss_w;
			end if;
		end if;
	elsif (TG_OP = 'UPDATE') then
		ie_tipo_w	:= 'A';
	end if;

	if (wheb_usuario_pck.get_nm_usuario is null) then
		nm_usuario_w	:= 'banco de dados';
	else
		nm_usuario_w	:= wheb_usuario_pck.get_nm_usuario;
	end if;

	if (TG_OP = 'UPDATE') and (coalesce(OLD.ie_plano,'X') <> coalesce(NEW.ie_plano,'X')) then
		insert into pls_glosa_evento_log(nr_sequencia,
			ie_plano,
			dt_atualizacao,
			nm_usuario,
			dt_alteracao,
			nr_seq_motivo_glosa,
			ie_evento,
			cd_estabelecimento,
			ie_tipo)
		values (nextval('pls_glosa_evento_log_seq'),
			NEW.ie_plano,
			LOCALTIMESTAMP,
			nm_usuario_w,
			LOCALTIMESTAMP,
			NEW.nr_seq_motivo_glosa,
			NEW.ie_evento,
			NEW.cd_estabelecimento,
			ie_tipo_w);
	end if;
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_glosa_evento_atual() FROM PUBLIC;

CREATE TRIGGER pls_glosa_evento_atual
	BEFORE INSERT OR UPDATE ON pls_glosa_evento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_glosa_evento_atual();

