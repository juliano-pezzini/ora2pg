-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS movto_cartao_cr_parcela_after ON movto_cartao_cr_parcela CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_movto_cartao_cr_parcela_after() RETURNS trigger AS $BODY$
declare

ie_contab_desp_cartao_w		parametro_contas_receber.ie_contab_desp_cartao%type;
cd_estabelecimento_w		movto_cartao_cr.cd_estabelecimento%type;
dt_transacao_w			movto_cartao_cr.dt_transacao%type;
dt_transacao_tr_w		movto_cartao_cr.dt_transacao%type;
nr_seq_trans_caixa_w		movto_cartao_cr.nr_seq_trans_caixa%type;
nr_sequencia_w			movto_cartao_cr.nr_sequencia%type;
vl_movimento_w			ctb_documento.vl_movimento%type;
nr_seq_info_w			ctb_documento.nr_seq_info%type;
nm_tabela_w			ctb_documento.nm_tabela%type;
nr_seq_caixa_rec_w 		movto_cartao_cr.nr_seq_caixa_rec%type;
nr_seq_banco_w			movto_trans_financ.nr_seq_banco%type;
nr_seq_caixa_w			movto_trans_financ.nr_seq_caixa%type;
nr_documento_w			ctb_documento.nr_documento%type;
nr_seq_doc_compl_w		ctb_documento.nr_seq_doc_compl%type;
nr_doc_analitico_w		ctb_documento.nr_doc_analitico%type;
nr_seq_proj_rec_w       ctb_documento.nr_seq_proj_rec%type;

c01 CURSOR FOR
	SELECT	a.nm_atributo,
		a.cd_tipo_lote_contab
	from	atributo_contab a
	where 	a.cd_tipo_lote_contab = 10
	and 	a.nm_atributo in ( 'VL_PARCELA_CARTAO', 'VL_DESPESA_CARTAO', 'VL_LIQUIDO_CARTAO')
	and	nr_seq_caixa_rec_w is not null
	
union all

	SELECT	a.nm_atributo,
		a.cd_tipo_lote_contab
	from	atributo_contab a
	where 	a.cd_tipo_lote_contab = 18
	and 	a.nm_atributo in ( 'VL_PARCELA_CARTAO', 'VL_DESPESA_CARTAO', 'VL_LIQUIDO_CARTAO', 'VL_LIQUIDO_CARTAO_TR')
	and	nr_seq_caixa_rec_w is null;

c01_w		c01%rowtype;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
select	cd_estabelecimento,
	dt_transacao,
	nr_seq_trans_caixa,
	nr_sequencia,
	nr_seq_caixa_rec
into STRICT	cd_estabelecimento_w,
	dt_transacao_tr_w,
	nr_seq_trans_caixa_w,
	nr_sequencia_w,
	nr_seq_caixa_rec_w
from	movto_cartao_cr
where	nr_sequencia = NEW.nr_seq_movto;

open c01;
loop
fetch c01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
	dt_transacao_w	:= dt_transacao_tr_w;
	if (c01_w.cd_tipo_lote_contab = 10) then
		BEGIN
		
		BEGIN
		
		select	coalesce(ie_contab_desp_cartao,'N')
		into STRICT	ie_contab_desp_cartao_w
		from	parametro_contas_receber
		where	cd_estabelecimento	= cd_estabelecimento_w;
		
		exception
		when others then
			ie_contab_desp_cartao_w:= 'N';
		end;
		
		if (ctb_online_pck.get_modo_lote(10,cd_estabelecimento_w) = 'S') then
			BEGIN
			select	coalesce(x.ie_contab_desp_cartao,'N')
			into STRICT	ie_contab_desp_cartao_w
			from (SELECT	a.ie_contab_desp_cartao
				 from	ctb_param_lote_contas_rec a
				 where	a.cd_empresa	= obter_empresa_estab(cd_estabelecimento_w)
				 and	coalesce(a.cd_estab_exclusivo, cd_estabelecimento_w) = cd_estabelecimento_w
				 order by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;
			exception when others then
			ie_contab_desp_cartao_w:= 'N';
			end;
		end if;
		
		if (ie_contab_desp_cartao_w = 'S') then
			BEGIN

			vl_movimento_w := case	c01_w.nm_atributo
					 when	'VL_PARCELA_CARTAO' then NEW.vl_parcela
					 when	'VL_DESPESA_CARTAO' then NEW.vl_despesa
					 when	'VL_LIQUIDO_CARTAO' then NEW.vl_liquido
					 else
						null
					 end;
			nr_seq_info_w		:= 64;
			nm_tabela_w		:= 'MOVTO_CARTAO_CR_PARCELA';
			nr_documento_w		:= nr_sequencia_w;
			nr_seq_doc_compl_w	:= NEW.nr_sequencia;
			nr_doc_analitico_w	:= 0;
			
			end;
		end if;
	
		end;
	elsif (c01_w.cd_tipo_lote_contab = 18) then
		BEGIN
		
		BEGIN
		
		select	coalesce(ie_contab_desp_cartao,'N')
		into STRICT	ie_contab_desp_cartao_w
		from	parametro_contas_receber
		where	cd_estabelecimento	= cd_estabelecimento_w;
		
		exception
		when others then
			ie_contab_desp_cartao_w:= 'N';
		end;
		
		if (ctb_online_pck.get_modo_lote(18,cd_estabelecimento_w) = 'S') then
			BEGIN
			select	coalesce(x.ie_contab_desp_cartao,'N')
			into STRICT	ie_contab_desp_cartao_w
			from (SELECT	a.ie_contab_desp_cartao
				 from	ctb_param_lote_contas_rec a
				 where	a.cd_empresa	= obter_empresa_estab(cd_estabelecimento_w)
				 and	coalesce(a.cd_estab_exclusivo, cd_estabelecimento_w) = cd_estabelecimento_w
				 order by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;
			exception when others then
			ie_contab_desp_cartao_w:= 'N';
			end;
		end if;
		
		if (ie_contab_desp_cartao_w = 'S') then
			BEGIN
			
			BEGIN
			
			select	nr_seq_banco,
				nr_seq_caixa,
				nr_sequencia,
				nr_seq_trans_financ,
                nr_seq_proj_rec
			into STRICT	nr_seq_banco_w,
				nr_seq_caixa_w,
				nr_documento_w,
				nr_seq_trans_caixa_w,
                nr_seq_proj_rec_w
			from	movto_trans_financ
			where	nr_seq_movto_cartao = NEW.nr_seq_movto;
			
			exception
			when others then
				nr_seq_banco_w:= null;
				nr_seq_caixa_w:= null;
			end;
			
			if (nr_seq_caixa_rec_w is null) and (nr_seq_banco_w is not null) and (nr_seq_caixa_w is null) then
				BEGIN
				
				vl_movimento_w:=case	c01_w.nm_atributo
						when	'VL_PARCELA_CARTAO' then NEW.vl_parcela
						when	'VL_DESPESA_CARTAO' then NEW.vl_despesa
						when	'VL_LIQUIDO_CARTAO' then NEW.vl_liquido
						when	'VL_LIQUIDO_CARTAO_TR' then NEW.vl_liquido
						else
							null
						end;
				nr_seq_info_w:=	5;
				nm_tabela_w:=	'MOVTO_CARTAO_CR_PARCELA';
				nr_seq_doc_compl_w:=	nr_sequencia_w;
				nr_doc_analitico_w:=	NEW.nr_sequencia;
				
				if (c01_w.nm_atributo in ('VL_PARCELA_CARTAO', 'VL_LIQUIDO_CARTAO')) then
					dt_transacao_w	:= NEW.dt_parcela;
				end if;
				
				
				end;
			end if;
		
			end;
		end if;
		end;
	end if;
		
	if (coalesce(vl_movimento_w, 0) <> 0) then
	BEGIN
				
	CALL ctb_concil_financeira_pck.ctb_gravar_documento(	cd_estabelecimento_w,
								dt_transacao_w,
								c01_w.cd_tipo_lote_contab,
								nr_seq_trans_caixa_w,
								nr_seq_info_w,
								nr_documento_w,
								nr_seq_doc_compl_w,
								nr_doc_analitico_w,
								vl_movimento_w,
								nm_tabela_w,
								c01_w.nm_atributo,
								NEW.nm_usuario,
                                'P',
                                null,
                                nr_seq_proj_rec_w);
		end;
	end if;
		
	end;
end loop;
close c01;


if (TG_OP = 'INSERT') then
	/* Grava o agendamento da informacao para atualizacao do fluxo de caixa. */


	CALL gravar_agend_fluxo_caixa(NEW.nr_seq_movto,NEW.nr_sequencia,'CC',NEW.dt_parcela,'I',NEW.nm_usuario);
elsif (TG_OP = 'UPDATE') then
	/* Grava o agendamento da informacao para atualizacao do fluxo de caixa. */


	CALL gravar_agend_fluxo_caixa(NEW.nr_seq_movto,NEW.nr_sequencia,'CC',NEW.dt_parcela,'A',NEW.nm_usuario);
end if;
end if;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_movto_cartao_cr_parcela_after() FROM PUBLIC;

CREATE TRIGGER movto_cartao_cr_parcela_after
	AFTER INSERT ON movto_cartao_cr_parcela FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_movto_cartao_cr_parcela_after();

