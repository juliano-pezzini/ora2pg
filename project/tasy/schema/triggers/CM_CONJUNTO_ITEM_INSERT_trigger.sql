-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cm_conjunto_item_insert ON cm_conjunto_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cm_conjunto_item_insert() RETURNS trigger AS $BODY$
declare

nr_seq_item_w	cm_conjunto_item.nr_seq_item%type;
ie_unico_w		cm_item.ie_unico%type;
qt_reg_con_w	numeric(20);

pragma autonomous_transaction;

BEGIN

	select 	max(coalesce(ie_unico,'N'))
	into STRICT	ie_unico_w
	from 	cm_item
	where	nr_sequencia = NEW.nr_seq_item;

	select 	count(nr_seq_item)
	into STRICT	nr_seq_item_w
	from 	cm_conjunto_item
	where	nr_seq_item = NEW.nr_seq_item;

	if (ie_unico_w = 'S' AND nr_seq_item_w > 0) then
		--Este item é único e já está associado em outro conjunto
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1035195);
	end if;

	select	count(*)
	into STRICT	qt_reg_con_w
	from	cm_conjunto_cont
	where	ie_status_conjunto not in (10,6)
	and		nr_seq_item = NEW.nr_seq_item;

	if (coalesce(qt_reg_con_w ,0) > 0) then
		--Não é possível inserir o item no conjunto. O item já está em processo de esterilização individual.
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1035492);
	end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cm_conjunto_item_insert() FROM PUBLIC;

CREATE TRIGGER cm_conjunto_item_insert
	BEFORE INSERT ON cm_conjunto_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cm_conjunto_item_insert();

