-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS gerint_atendimento_paciente ON atendimento_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_gerint_atendimento_paciente() RETURNS trigger AS $BODY$
declare

ie_integracao_gerint_w	varchar(1) := 'N';
ie_integra_gerint_w		varchar(1);
ds_sep_bv_w				varchar(50);
ds_motivo_alta_w		varchar(255);
cd_unidade_basica_w		gerint_solic_internacao.cd_unidade_basica%type;
cd_unidade_compl_w		gerint_solic_internacao.cd_unidade_compl%type;
CD_SETOR_ATENDIMENTO_W	bigint;
ie_gerint_w				unidade_atendimento.ie_gerint%type;

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
	if (obter_dados_param_atend(NEW.cd_estabelecimento,'GI') = 'S') and (NEW.ie_tipo_atendimento = 1) then

			select 	coalesce(max(cd_unidade_basica),'0'),
					coalesce(max(cd_unidade_compl),'0'),
					coalesce(max(cd_setor_atendimento),'0')
			into STRICT	cd_unidade_basica_w,
					cd_unidade_compl_w,
					cd_setor_atendimento_w
			from	gerint_solic_internacao
			where	nr_atendimento = NEW.nr_atendimento
			and		ie_situacao = 'I';

			select	coalesce(max(A.ie_gerint),'N')
			into STRICT	ie_gerint_w
			from 	unidade_atendimento A
			where 	A.cd_unidade_basica		= cd_unidade_basica_w
			and 	A.cd_unidade_compl  	    = cd_unidade_compl_w
			and 	A.cd_setor_atendimento 	= cd_setor_atendimento_w;


		if (NEW.ie_tipo_convenio = 3 or ie_gerint_w = 'S') then	
			
			ds_sep_bv_w	:=	obter_separador_bv;

			if (NEW.dt_alta is not null) and 	--Evento 5: Servico de Liberacao de Internacao
				(OLD.dt_alta is null) then
			
				select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_integra_gerint_w
				from	gerint_solic_internacao
				where	nr_atendimento = NEW.nr_atendimento
				and		ie_situacao = 'I';
						
				if (ie_integra_gerint_w = 'S') then
					--Define o motivo de alta.			

					if (OBTER_SE_MOTIVO_ALTA_OBITO(NEW.cd_motivo_alta) = 'S') then
						ds_motivo_alta_w := 'OBITO';
					elsif (OBTER_SE_MOTIVO_ALTA_TRANS(NEW.cd_motivo_alta) = 'S') then
						ds_motivo_alta_w := 'TRANSFERENCIA';
					else
						ds_motivo_alta_w := 'ALTA';
					end if;
								
					CALL exec_sql_dinamico_bv('TASY', Gerint_desc_de_para('QUERY'), 	'nm_usuario_p='					|| NEW.nm_usuario  							|| ds_sep_bv_w ||
																				'cd_estabelecimento_p=' 		|| NEW.cd_estabelecimento				 		|| ds_sep_bv_w ||
																				'id_evento_p=' 					|| '5'				 							|| ds_sep_bv_w ||
																				'nr_atendimento_p=' 			|| NEW.nr_atendimento 							|| ds_sep_bv_w ||
																				'ie_leito_extra_p=' 			|| null				 							|| ds_sep_bv_w ||
																				'dt_alta_p=' 				|| to_char(NEW.dt_alta,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w ||
																				'ds_motivo_alta_p=' 			|| ds_motivo_alta_w								|| ds_sep_bv_w ||
																				'ds_justif_transferencia_p='	|| null 										|| ds_sep_bv_w ||
																				'nr_seq_solic_internacao_p=' 	|| null 										|| ds_sep_bv_w ||
																				'nr_seq_leito_p=' 				|| null											|| ds_sep_bv_w ||
																				'ds_ident_leito_p='				|| null											|| ds_sep_bv_w ||
																				'nr_seq_classif_p=' 			|| null											|| ds_sep_bv_w ||
																				'ie_status_unidade_p=' 			|| null											|| ds_sep_bv_w ||
																				'nr_cpf_paciente_p=' 			|| null											|| ds_sep_bv_w ||
																				'nr_cartao_sus_p=' 				|| null											|| ds_sep_bv_w ||
																				'cd_cid_p='						|| null											|| ds_sep_bv_w ||
																				'cd_evolucao_p='				|| null);																		
				end if;
			elsif (NEW.dt_alta is null) and		--Evento 8: Servico de Reversao da Alta/Obito
					(OLD.dt_alta is not null) then
				
				select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END 
				into STRICT	ie_integra_gerint_w
				from	gerint_solic_internacao
				where	nr_atendimento = NEW.nr_atendimento
				and		ie_situacao = 'L';
				
				if (ie_integra_gerint_w = 'S') then
				
					CALL exec_sql_dinamico_bv('TASY', Gerint_desc_de_para('QUERY'), 	'nm_usuario_p='					|| NEW.nm_usuario  							|| ds_sep_bv_w ||
																				'cd_estabelecimento_p=' 		|| NEW.cd_estabelecimento				 		|| ds_sep_bv_w ||
																				'id_evento_p=' 					|| '8'				 							|| ds_sep_bv_w ||
																				'nr_atendimento_p=' 			|| NEW.nr_atendimento 							|| ds_sep_bv_w ||
																				'ie_leito_extra_p=' 			|| null				 							|| ds_sep_bv_w ||
																				'dt_alta_p=' 					|| null											|| ds_sep_bv_w ||
																				'ds_motivo_alta_p=' 			|| null											|| ds_sep_bv_w ||
																				'ds_justif_transferencia_p='	|| null 										|| ds_sep_bv_w ||
																				'nr_seq_solic_internacao_p=' 	|| null 										|| ds_sep_bv_w ||
																				'nr_seq_leito_p=' 				|| null											|| ds_sep_bv_w ||
																				'ds_ident_leito_p='				|| null											|| ds_sep_bv_w ||
																				'nr_seq_classif_p=' 			|| null											|| ds_sep_bv_w ||
																				'ie_status_unidade_p=' 			|| null											|| ds_sep_bv_w ||
																				'nr_cpf_paciente_p=' 			|| null											|| ds_sep_bv_w ||
																				'nr_cartao_sus_p=' 				|| null											|| ds_sep_bv_w ||
																				'cd_cid_p='						|| null											|| ds_sep_bv_w ||
																				'cd_evolucao_p='				|| null);
				end if;
			end if;
		end if;
	end if;
end if;
/*		I N T E G R A C A O  -  G E R I N T  -  F I M		*/


RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_gerint_atendimento_paciente() FROM PUBLIC;

CREATE TRIGGER gerint_atendimento_paciente
	AFTER UPDATE ON atendimento_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_gerint_atendimento_paciente();

