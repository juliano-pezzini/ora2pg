-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_material_update ON prescr_material CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_material_update() RETURNS trigger AS $BODY$
DECLARE
cd_motivo_exclusao_w		varchar(20);
qt_adm_w					bigint;
nr_seq_log_w				bigint;
ie_lib_auto_w				varchar(1);
ie_dia_semana_w				varchar(1);
ie_segunda_w				varchar(2);
ie_terca_w					varchar(2);
ie_quarta_w					varchar(2);
ie_quinta_w					varchar(2);
ie_sexta_w					varchar(2);
ie_sabado_w					varchar(2);
ie_domingo_w				varchar(2);
ie_operacao_w				varchar(2);
ie_verifica_hor_apra_w		varchar(2);
dt_prescricao_w				timestamp;
ds_origem_w					varchar(1800);
ds_alteracao_w				varchar(1800);
ds_alteracao_rastre_w		varchar(1800);
hr_prim_hor_prescr_w		varchar(5);
ie_controla_adm_w			varchar(5);
hr_prim_hor_medic_w			varchar(5);
ie_somente_proced_w			varchar(5);
ie_registra_alter_medico_w 	varchar(1);
ie_reg_alter_medico_farm_w 	varchar(1);
cd_pessoa_alteracao_w		varchar(10);
ie_justifica_dias_util_w 	varchar(1);
ie_altera_status_atend_w 	varchar(1);
ie_tipo_item_w				varchar(15);
cd_unidade_medida_consumo_w	varchar(30);
nr_seq_protocolo_w			bigint;
cd_motivo_baixa_w			bigint;
nr_atendimento_w			bigint;
nr_seq_w					bigint;
qt_horas_ant_copia_cpoe_w	bigint;
dt_copia_cpoe_w				timestamp;
dt_inicio_prescr_w			timestamp;
dt_inicio_item_w			timestamp;
dt_validade_prescr_w		timestamp;
dt_proxima_dose_w			timestamp;
dt_proxima_dose_ww			timestamp;
dt_proxima_dose_ww2			timestamp;
dt_proxima_dose_ww3			timestamp;
qt_operacao_w				bigint;
qt_dias_lib_padrao_w		integer;
ie_altera_dt_proxima_dose_w varchar(2);
qt_existe_w					integer;
ie_interv_sup_24h_w			varchar(1);
ie_vancomicina_w			varchar(3);
cd_perfil_w					bigint;
cd_estabelecimento_w		bigint;
ie_gera_lote_pac_w			varchar(1);
ie_padronizado_w			varchar(1);
ie_log_baixa_item_w			varchar(1);
qt_dia_terapeutico_w		material.qt_dia_terapeutico%type;
qt_dia_profilatico_w			material.qt_dia_profilatico%type;
ie_dias_util_medic_w		material.ie_dias_util_medic%type;
dt_suspensao_w				timestamp;
qt_hora_aplicacao_w			prescr_material.qt_hora_aplicacao%type;
qt_min_aplicacao_w			prescr_material.qt_min_aplicacao%type;
cd_setor_atendimento_w		prescr_medica.cd_setor_atendimento%type;
cd_pessoa_fisica_w			prescr_medica.cd_pessoa_fisica%type;
qt_peso_w					prescr_medica.qt_peso%type;
qt_idade_w					integer;
ie_liberado_medico_w		char(1);
qt_dose_extra_w 			double precision := 0;
cd_funcao_origem_w			prescr_medica.cd_funcao_origem%type;
cd_funcao_origem_ww			prescr_medica.cd_funcao_origem%type;
cd_setor_prescr_w			prescr_medica.cd_setor_atendimento%type;
i							integer;
qt_horarios_medic_w			integer;
ie_horario_valido_w			varchar(1);
qt_tot_disp_w				double precision;
ds_horarios_w				varchar(10);
ds_horarios_ww				varchar(10);
ds_horarios_www				varchar(10);
ie_add_dia_w				varchar(1) := 'S';
ds_horarios_interv_w		intervalo_prescricao.ds_horarios%type;
nr_horas_validade_w			prescr_medica.nr_horas_validade%type;
qt_horas_adicional_w		double precision;
ie_intervalo_24_w			varchar(5);
hr_prim_horario_w			prescr_material.hr_prim_horario%type;
ie_copia_dil_w				varchar(10);
ie_unit_corrigida_w			varchar(1) := 'N';
qt_hora_intervalo_ww		double precision;
ie_inter_dif_w				varchar(1) := 'N';
cd_material_cpoe_w			cpoe_material.cd_material%type;
nr_ult_prescricao_w			prescr_medica.nr_prescricao%type;
ie_rastre_prescr_dp_w		varchar(1);
ds_rastre_prescr_dp_w		varchar(1800);
ds_param_integration_w varchar(20000);

procedure gerar_log_alteracoes is
BEGIN
  BEGIN
	if (coalesce(NEW.cd_intervalo,'XPTO') <> coalesce(OLD.cd_intervalo,'XPTO')) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' cd_intervalo(' || coalesce(OLD.cd_intervalo,0) || '/' || coalesce(NEW.cd_intervalo,0)||'); ',1,1800);
	end if;

	if (coalesce(NEW.IE_SE_NECESSARIO,'N') <> coalesce(OLD.IE_SE_NECESSARIO,'N')) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' IE_SE_NECESSARIO(' || coalesce(OLD.IE_SE_NECESSARIO,0) || '/' || coalesce(NEW.IE_SE_NECESSARIO,0)||'); ',1,1800);
	end if;

	if (coalesce(NEW.hr_prim_horario,'XPTO') <> coalesce(OLD.hr_prim_horario,'XPTO')) then
		ds_alteracao_w	:= substr(' HR_PRIM_HORARIO('||coalesce(OLD.hr_prim_horario,'<NULO>')||'/'||coalesce(NEW.hr_prim_horario,'<NULO>')||'); ',1,1800);
	end if;

	if (coalesce(NEW.ds_horarios,'XPTO') <> coalesce(OLD.ds_horarios,'XPTO')) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' DS_HORARIOS('||coalesce(OLD.ds_horarios,'<NULO>')||'/'||coalesce(NEW.ds_horarios,'<NULO>')||'); ',1,1800);
	end if;	

	if (coalesce(NEW.nr_ocorrencia,999) <> coalesce(OLD.nr_ocorrencia,999)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' NR_OCORRENCIA(' || coalesce(OLD.nr_ocorrencia,999) || '/' || coalesce(NEW.nr_ocorrencia,999)||'); ',1,1800);
	end if;

	if (coalesce(OLD.qt_total_dispensar,0)	<> coalesce(NEW.qt_total_dispensar,0)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' QT_TOTAL_DISPENSAR(' || coalesce(OLD.qt_total_dispensar,0) || '/' || coalesce(NEW.qt_total_dispensar,0)||'); ',1,1800);	
	end if;

	if (coalesce(NEW.nr_agrupamento,999) <> coalesce(OLD.nr_agrupamento,999)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' NR_AGRUPAMENTO(' || coalesce(OLD.nr_agrupamento,999) || '/' || coalesce(NEW.nr_agrupamento,999)||'); ',1,1800);
	end if;

	if (coalesce(NEW.cd_local_estoque,0) <> coalesce(OLD.cd_local_estoque,0)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' CD_LOCAL_ESTOQUE(' || coalesce(OLD.cd_local_estoque,0) || '/' || coalesce(NEW.cd_local_estoque,0)||'); ',1,1800);
	end if;

	if (coalesce(NEW.cd_motivo_baixa,0) <> coalesce(OLD.cd_motivo_baixa,0)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' CD_MOTIVO_BAIXA(' || coalesce(OLD.cd_motivo_baixa,0) || '/' || coalesce(NEW.cd_motivo_baixa,0)||'); ',1,1800);
	end if;

	if (coalesce(NEW.dt_baixa,LOCALTIMESTAMP + interval '1 days'/3600) <> coalesce(OLD.dt_baixa,LOCALTIMESTAMP + interval '1 days'/3600)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' DT_BAIXA(' || coalesce(OLD.dt_baixa,LOCALTIMESTAMP) || '/' || coalesce(NEW.dt_baixa,LOCALTIMESTAMP)||'); ',1,1800);
	end if;
	
	
	if (NEW.dt_baixa is not null and OLD.dt_baixa is null) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' DT_BAIXA(' || coalesce(OLD.dt_baixa,LOCALTIMESTAMP) || '/' || coalesce(NEW.dt_baixa,LOCALTIMESTAMP)||'); ',1,1800);
	end if;
	
	if (coalesce(NEW.dt_inicio_medic,LOCALTIMESTAMP) <> coalesce(OLD.dt_inicio_medic,LOCALTIMESTAMP)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' DT_INICIO_MEDIC(' || coalesce(OLD.dt_inicio_medic,LOCALTIMESTAMP) || '/' || coalesce(NEW.dt_inicio_medic,LOCALTIMESTAMP)||'); ',1,1800);
	end if;

	if (coalesce(NEW.qt_dia_prim_hor,0) <> coalesce(OLD.qt_dia_prim_hor,0)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' QT_DIA_PRIM_HOR(' || coalesce(OLD.qt_dia_prim_hor,0) || '/' || coalesce(NEW.qt_dia_prim_hor,0)||'); ',1,1800);
	end if;

	if (NEW.ie_via_aplicacao <> OLD.ie_via_aplicacao) then
		ds_alteracao_w := substr(ds_alteracao_w || ' IE_VIA_APLICACAO(' || coalesce(OLD.ie_via_aplicacao,'0') || '/' || coalesce(NEW.ie_via_aplicacao,'0')||'); ',1,1800);
	end if;
	
	if (coalesce(NEW.HR_DOSE_ESPECIAL,'X') <> coalesce(OLD.HR_DOSE_ESPECIAL,'X')) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' HR_DOSE_ESPECIAL(' || coalesce(OLD.HR_DOSE_ESPECIAL,'X') || '/' || coalesce(NEW.HR_DOSE_ESPECIAL,'X')||'); ',1,1800);
	end if;
	
	if (NEW.cd_material <> OLD.cd_material) then
		ds_alteracao_w := substr(ds_alteracao_w || ' Material(' || coalesce(OLD.cd_material,'0') || '/' || coalesce(NEW.cd_material,'0')||'); ',1,1800);
	end if;
	
	if (NEW.nr_seq_regra_local <> OLD.nr_seq_regra_local) then
		ds_alteracao_w := substr(ds_alteracao_w || ' NR_SEQ_REGRA_LOCAL(' || coalesce(OLD.nr_seq_regra_local,'0') || '/' || coalesce(NEW.nr_seq_regra_local,'0')||'); ',1,1800);
	end if;
	
	if (NEW.qt_dose <> OLD.qt_dose) then
		ds_alteracao_w := substr(ds_alteracao_w || ' QT_DOSE(' || coalesce(OLD.QT_DOSE,'0') || '/' || coalesce(NEW.QT_DOSE,'0')||'); ',1,1800);
	end if;
	
	if (coalesce(NEW.ie_administrar, 0) <> coalesce(OLD.ie_administrar, 0)) then
		ds_alteracao_w := substr(ds_alteracao_w || ' IE_ADMINISTRAR(' || coalesce(OLD.ie_administrar,'0') || '/' || coalesce(NEW.ie_administrar,'0')||'); ',1,1800);
	end if;	
	
	if (coalesce(NEW.dt_proxima_dose, LOCALTIMESTAMP) <> coalesce(OLD.dt_proxima_dose, LOCALTIMESTAMP)) then
		ds_alteracao_w := substr(ds_alteracao_w || ' DT_PROXIMA_DOSE(' || to_char(OLD.dt_proxima_dose, 'dd/mm/yyyy hh24:mi:ss') || '/' || to_char(NEW.dt_proxima_dose, 'dd/mm/yyyy hh24:mi:ss')||'); ',1,1800);
	end if;
	
	if (coalesce(NEW.dt_suspensao, LOCALTIMESTAMP) <> coalesce(OLD.dt_suspensao,LOCALTIMESTAMP)) then
		ds_alteracao_w := substr(ds_alteracao_w || ' DT_SUSPENSAO(' || to_char(OLD.DT_SUSPENSAO, 'dd/mm/yyyy hh24:mi:ss') || '/' || to_char(NEW.DT_SUSPENSAO, 'dd/mm/yyyy hh24:mi:ss')||'); ',1,1800);
	end if;
	
	if (coalesce(NEW.ie_horario_susp, 'N') <> coalesce(OLD.ie_horario_susp, 'N')) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' IE_HORARIO_SUSP(' || coalesce(OLD.IE_HORARIO_SUSP,0) || '/' || coalesce(NEW.IE_HORARIO_SUSP,0)||'); ',1,1800);
	end if;	
	
	if (coalesce(NEW.qt_total_dias_lib,0) <> coalesce(OLD.qt_total_dias_lib,0)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' QT_TOTAL_DIAS_LIB(' || coalesce(OLD.qt_total_dias_lib,0) || '/' || coalesce(NEW.qt_total_dias_lib,0)||'); ',1,1800);
	end if;
	
	if (coalesce(NEW.nr_dia_util,0) <> coalesce(OLD.nr_dia_util,0)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' NR_DIA_UTIL(' || coalesce(OLD.nr_dia_util,0) || '/' || coalesce(NEW.nr_dia_util,0)||'); ',1,1800);
	end if;
	
	if (coalesce(NEW.qt_dias_solicitado,0) <> coalesce(OLD.qt_dias_solicitado,0)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' QT_DIAS_SOLICITADO(' || coalesce(OLD.qt_dias_solicitado,0) || '/' || coalesce(NEW.qt_dias_solicitado,0)||'); ',1,1800);
	end if;
	
	if (coalesce(NEW.qt_dias_liberado,0) <> coalesce(OLD.qt_dias_liberado,0)) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' QT_DIAS_LIBERADO(' || coalesce(OLD.qt_dias_liberado,0) || '/' || coalesce(NEW.qt_dias_liberado,0)||'); ',1,1800);
	end if;

    if (coalesce(NEW.ie_medicacao_paciente,'N') <> coalesce(OLD.ie_medicacao_paciente,'N')) then
		ds_alteracao_w	:= substr(ds_alteracao_w || ' IE_MEDICACAO_PACIENTE(' || coalesce(OLD.ie_medicacao_paciente,'N') || '/' || coalesce(NEW.ie_medicacao_paciente,'N')||'); ',1,1800);
	end if;
	
	if (coalesce(NEW.ie_gerar_horario, 'S') <> coalesce(OLD.ie_gerar_horario, 'S')) then
		ds_alteracao_w := substr(ds_alteracao_w || ' IE_GERAR_HORARIO(' || coalesce(OLD.ie_gerar_horario, 'S') || '/' || coalesce(NEW.ie_gerar_horario, 'S') || '); ', 1, 1800);
	end if;
	
	if (ds_alteracao_w is not null) then
		ds_alteracao_w := substr('Alteracoes(old/new)= ' || ds_alteracao_w || ' DT_LIB_MATERIAL-' || NEW.dt_lib_material || ' FUNCAO('||to_char(wheb_usuario_pck.get_cd_funcao)||'); PERFIL('||to_char(cd_perfil_w)||')',1,1800);
		CALL Gerar_log_prescr_mat(NEW.nr_prescricao, NEW.nr_sequencia, NEW.ie_agrupador, null, null, ds_alteracao_w, coalesce(NEW.nm_usuario,wheb_usuario_pck.get_nm_usuario), 'N');
	end if;
	end;
	
procedure gerar_log_rastre_prescr is
	BEGIN

	if (obter_se_info_rastre_prescr( 'L', coalesce(NEW.nm_usuario,wheb_usuario_pck.get_nm_usuario), cd_perfil_w, cd_estabelecimento_w) = 'S') then

        if (NEW.qt_dose <> OLD.qt_dose) then
			ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w || ' QT_DOSE(' || coalesce(OLD.QT_DOSE,'0') || '/' || coalesce(NEW.QT_DOSE,'0')||'); ',1,1800);
		end if;

        if (coalesce(OLD.qt_total_dispensar,0)	<> coalesce(NEW.qt_total_dispensar,0)) then
			ds_alteracao_rastre_w	:= substr(ds_alteracao_rastre_w || ' QT_TOTAL_DISPENSAR(' || coalesce(OLD.qt_total_dispensar,0) || '/' || coalesce(NEW.qt_total_dispensar,0)||'); ',1,1800);	
		end if;

        if (coalesce(NEW.cd_local_estoque,0) <> coalesce(OLD.cd_local_estoque,0)) then
	        ds_alteracao_rastre_w	:= substr(ds_alteracao_rastre_w || ' CD_LOCAL_ESTOQUE(' || coalesce(OLD.cd_local_estoque,0) || '/' || coalesce(NEW.cd_local_estoque,0)||'); ',1,1800);
    	end if;

        if (coalesce(NEW.nr_seq_classif,0) <> coalesce(OLD.nr_seq_classif,0)) then
			ds_alteracao_rastre_w	:= substr(ds_alteracao_rastre_w || ' NR_SEQ_CLASSIF(' || coalesce(OLD.nr_seq_classif,0) || '/' || coalesce(NEW.nr_seq_classif,0)||'); ',1,1800);
		end if;

        if (coalesce(NEW.cd_motivo_baixa,0) <> coalesce(OLD.cd_motivo_baixa,0)) then
	        ds_alteracao_rastre_w	:= substr(ds_alteracao_rastre_w || ' CD_MOTIVO_BAIXA(' || coalesce(OLD.cd_motivo_baixa,0) || '/' || coalesce(NEW.cd_motivo_baixa,0)||'); ',1,1800);
		end if;

        if (coalesce(NEW.dt_baixa,LOCALTIMESTAMP + interval '1 days'/3600) <> coalesce(OLD.dt_baixa,LOCALTIMESTAMP + interval '1 days'/3600)) then
			ds_alteracao_rastre_w	:= substr(ds_alteracao_rastre_w || ' DT_BAIXA(' || coalesce(OLD.dt_baixa,LOCALTIMESTAMP) || '/' || coalesce(NEW.dt_baixa,LOCALTIMESTAMP)||'); ',1,1800);
   		end if;
		
		if (coalesce(NEW.ie_regra_disp,'N') <> coalesce(OLD.ie_regra_disp,'N')) then
	        ds_alteracao_rastre_w	:= substr(ds_alteracao_rastre_w || ' IE_REGRA_DISP(' || coalesce(OLD.ie_regra_disp,'N') || '/' || coalesce(NEW.ie_regra_disp,'N')||'); ',1,1800);
		end if;

        if (ds_alteracao_rastre_w is not null) then
	        ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes(old/new)= ' || ds_alteracao_rastre_w || ' DT_LIB_MATERIAL-' || NEW.dt_lib_material || ' FUNCAO('||to_char(wheb_usuario_pck.get_cd_funcao)||'); PERFIL('||to_char(cd_perfil_w)||')',1,1800);
		    CALL Gerar_log_prescr_mat(NEW.nr_prescricao, NEW.nr_sequencia, NEW.ie_agrupador, null, null, ds_alteracao_rastre_w, coalesce(NEW.nm_usuario,wheb_usuario_pck.get_nm_usuario), 'N');
		end if;
	
	end if;

	end;


	
procedure ajustar_dt_proxima_dose is
BEGIN	
	cd_motivo_baixa_w := wheb_assist_pck.obterValorParametroREP(194, cd_motivo_baixa_w);
	
	NEW.ie_administrar	:= coalesce(NEW.ie_administrar,'S');
	
	dt_proxima_dose_ww	:= to_date(to_char(coalesce(NEW.dt_inicio_medic, dt_inicio_prescr_w), 'dd/mm/yyyy ') || to_char(dt_inicio_prescr_w, 'hh24:mi'), 'dd/mm/yyyy hh24:mi');			
	
	if (NEW.hr_prim_horario is not null) and (NEW.hr_prim_horario <> '  :  ') then
		
		if (NEW.dt_inicio_medic is null) and (to_char(dt_inicio_prescr_w, 'hh24:mi') >  obter_prim_dshorarios(NEW.ds_horarios)) then
			dt_proxima_dose_ww	:= dt_inicio_prescr_w + 1;
			ie_add_dia_w := 'N';					
		end if;
		
		dt_proxima_dose_ww	:= to_date(to_char(dt_proxima_dose_ww,'dd/mm/yyyy ') || obter_prim_dshorarios(NEW.ds_horarios) || ':00','dd/mm/yyyy hh24:mi:ss');
		
	end if;
	
	qt_horarios_medic_w := obter_ocorrencias_horarios_rep(NEW.ds_horarios);
	ds_horarios_w		:= null;
	ds_horarios_ww		:= null;

	if (qt_horarios_medic_w = 2) then    
    
		if ((OLD.qt_total_dispensar is null AND NEW.qt_total_dispensar is not null) or
			((OLD.hr_prim_horario is null) or ((coalesce(OLD.hr_prim_horario,'XPTO')) <> (coalesce(NEW.hr_prim_horario,'XPTO')))) or
			((OLD.cd_intervalo is null) or ((coalesce(OLD.cd_intervalo,'XPTO')) <> (coalesce(NEW.cd_intervalo,'XPTO')))) or
			((OLD.nr_ocorrencia is null) or ((coalesce(OLD.nr_ocorrencia,999999)) <> (coalesce(NEW.nr_ocorrencia,999999)))) or
			((OLD.qt_dose is null) or ((coalesce(OLD.qt_dose,999999)) <> (coalesce(NEW.qt_dose,999999))))) then
		  
			i:= 1;
			ie_horario_valido_w := 'N';
			NEW.qt_dia_prim_hor	:= abs(trunc(dt_proxima_dose_ww - dt_inicio_prescr_w));
			qt_tot_disp_w 			:= NEW.qt_total_dispensar / 2;
			
			while i < (qt_horarios_medic_w + 1) loop
				BEGIN
				
				if (ds_horarios_w is null) then
					if (position(':' in NEW.ds_horarios) > 1) then
						ds_horarios_w := substr(NEW.ds_horarios,1,5);
					else
						ds_horarios_w := substr(NEW.ds_horarios,1,2);
					end if;
				else
					ds_horarios_w := replace(NEW.ds_horarios, ''||ds_horarios_w, '');				
				end if;
				
				dt_proxima_dose_ww2 := obter_proxima_dose_medic(dt_proxima_dose_ww,NEW.cd_intervalo, NEW.ds_horarios, ie_add_dia_w);
				ie_add_dia_w := 'S';
			
				ie_dia_semana_w		:= pkg_date_utils.get_WeekDay(dt_proxima_dose_ww);
				
				if (dt_proxima_dose_ww not between dt_inicio_prescr_w and dt_validade_prescr_w) and (Obter_se_horario_valido_inter(dt_proxima_dose_ww,NEW.cd_intervalo) <> 'I') then
	
					if (ie_rastre_prescr_dp_w = 'S') then
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || chr(13) || 'linha:' || $$plsql_line || chr(13), 1, 1800);
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'DT_PROXIMA_DOSE(' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) || '/', 1, 1800);
					end if;
				
					NEW.dt_proxima_dose	:= dt_proxima_dose_ww;
						
					if (ie_rastre_prescr_dp_w = 'S') then
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) ||'); ' || chr(13), 1, 1800);
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'cd_motivo_baixa_w:' || cd_motivo_baixa_w
							|| 'ds_horarios_interv_w:'|| ds_horarios_interv_w || 'ds_horarios_w:' || ds_horarios_w || 'ds_horarios_ww:' || ds_horarios_ww 
							|| 'ds_horarios_www:' || ds_horarios_www || 'ds_rastre_prescr_dp_w:' || ds_rastre_prescr_dp_w 
							|| 'dt_inicio_prescr_w:' || to_char( dt_inicio_prescr_w , 'dd/mm/yyyy hh24:mi:ss') 
							|| 'dt_proxima_dose_ww:' || to_char( dt_proxima_dose_ww , 'dd/mm/yyyy hh24:mi:ss') 
							|| 'dt_validade_prescr_w:' || to_char( dt_validade_prescr_w , 'dd/mm/yyyy hh24:mi:ss') || 'ie_add_dia_w:' || ie_add_dia_w 
							|| 'ie_dia_semana_w:' || ie_dia_semana_w || 'ie_domingo_w:' || ie_domingo_w || 'ie_horario_valido_w:' || ie_horario_valido_w 
							|| 'ie_operacao_w:' || ie_operacao_w || 'ie_quarta_w:' || ie_quarta_w || 'ie_quinta_w:' || ie_quinta_w 
							|| 'ie_rastre_prescr_dp_w:' || ie_rastre_prescr_dp_w || 'ie_sabado_w:' || ie_sabado_w || 'ie_segunda_w:' || ie_segunda_w 
							|| 'ie_sexta_w:' || ie_sexta_w || 'ie_terca_w:' || ie_terca_w || 'nr_horas_validade_w:' || nr_horas_validade_w 
							|| 'qt_horarios_medic_w:' || qt_horarios_medic_w || 'qt_tot_disp_w:' || qt_tot_disp_w, 1, 1800);
					end if;
					
					if (coalesce(NEW.ie_sem_aprazamento,'N') = 'N') or (NEW.hr_prim_horario is not null) then
						NEW.qt_total_dispensar	:= NEW.qt_total_dispensar - qt_tot_disp_w;
					end if;
					
				elsif ((ie_dia_semana_w	= 1 AND ie_domingo_w	= 'N') or
					   (ie_dia_semana_w	= 2 AND ie_segunda_w	= 'N') or
					   (ie_dia_semana_w	= 3 AND ie_terca_w	= 'N') or
					   (ie_dia_semana_w	= 4 AND ie_quarta_w	= 'N') or
					   (ie_dia_semana_w	= 5 AND ie_quinta_w	= 'N') or
					   (ie_dia_semana_w	= 6 AND ie_sexta_w	= 'N') or
					   (ie_dia_semana_w	= 7 AND ie_sabado_w	= 'N')) then
	
					if (ie_rastre_prescr_dp_w = 'S') then		
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || chr(13) || 'linha:' || $$plsql_line || chr(13), 1, 1800);
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'DT_PROXIMA_DOSE(' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) || '/', 1, 1800);
					end if;
					
					NEW.dt_proxima_dose	:= dt_proxima_dose_ww2;
						
					if (ie_rastre_prescr_dp_w = 'S') then		
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) ||'); ' || chr(13), 1, 1800);						
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'cd_motivo_baixa_w:' || cd_motivo_baixa_w
							|| 'ds_horarios_interv_w:'|| ds_horarios_interv_w || 'ds_horarios_w:' || ds_horarios_w || 'ds_horarios_ww:' || ds_horarios_ww 
							|| 'ds_horarios_www:' || ds_horarios_www || 'ds_rastre_prescr_dp_w:' || ds_rastre_prescr_dp_w 
							|| 'dt_inicio_prescr_w:' || to_char( dt_inicio_prescr_w , 'dd/mm/yyyy hh24:mi:ss') 
							|| 'dt_proxima_dose_ww:' || to_char( dt_proxima_dose_ww , 'dd/mm/yyyy hh24:mi:ss') 
							|| 'dt_validade_prescr_w:' || to_char( dt_validade_prescr_w , 'dd/mm/yyyy hh24:mi:ss') || 'ie_add_dia_w:' || ie_add_dia_w 
							|| 'ie_dia_semana_w:' || ie_dia_semana_w || 'ie_domingo_w:' || ie_domingo_w || 'ie_horario_valido_w:' || ie_horario_valido_w 
							|| 'ie_operacao_w:' || ie_operacao_w || 'ie_quarta_w:' || ie_quarta_w || 'ie_quinta_w:' || ie_quinta_w 
							|| 'ie_rastre_prescr_dp_w:' || ie_rastre_prescr_dp_w || 'ie_sabado_w:' || ie_sabado_w || 'ie_segunda_w:' || ie_segunda_w 
							|| 'ie_sexta_w:' || ie_sexta_w || 'ie_terca_w:' || ie_terca_w || 'nr_horas_validade_w:' || nr_horas_validade_w 
							|| 'qt_horarios_medic_w:' || qt_horarios_medic_w || 'qt_tot_disp_w:' || qt_tot_disp_w, 1, 1800);
					end if;
					
					if (coalesce(NEW.ie_sem_aprazamento,'N') = 'N') or (NEW.hr_prim_horario is not null) then
						NEW.qt_total_dispensar	:= NEW.qt_total_dispensar - qt_tot_disp_w;
					end if;
				elsif (dt_proxima_dose_ww between dt_inicio_prescr_w and dt_validade_prescr_w AND ( or
					    or
					    or
					    or
					    or
					    or
					   )) then
					
						NEW.ie_administrar		:= 'S';
						NEW.cd_motivo_baixa	:= 0;
						ie_horario_valido_w 	:= 'S';
						
						ds_horarios_w := replace(NEW.ds_horarios, ds_horarios_w, '');
						
						if (position(':' in ds_horarios_w) = 0) and (length(ds_horarios_w) = 2) then
							ds_horarios_www := ds_horarios_w || ':00';
						end if;
						
						if (to_date(to_char(dt_proxima_dose_ww,'dd/mm/yyyy ') || ds_horarios_www ||':00','dd/mm/yyyy hh24:mi:ss') < dt_inicio_prescr_w) then
							dt_proxima_dose_ww := dt_proxima_dose_ww + 1;
							ie_add_dia_w := 'N';
						elsif (dt_proxima_dose_ww between dt_inicio_prescr_w and dt_validade_prescr_w) then
							ie_add_dia_w := 'N';
						end if;

						dt_proxima_dose_ww3	:= obter_proxima_dose_medic(dt_proxima_dose_ww,NEW.cd_intervalo,ds_horarios_w, ie_add_dia_w);
	
						if (ie_rastre_prescr_dp_w = 'S') then		
							ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || chr(13) || 'linha:' || $$plsql_line || chr(13), 1, 1800);
							ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'DT_PROXIMA_DOSE(' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) || '/', 1, 1800);
						end if;
						
						NEW.dt_proxima_dose := dt_proxima_dose_ww3;
							
						if (ie_rastre_prescr_dp_w = 'S') then		
							ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || to_char(NEW.dt_proxima_dose, 'dd/mm/yyyy hh24:mi:ss') ||'); ' || chr(13), 1, 1800);						
							ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'cd_motivo_baixa_w:' || cd_motivo_baixa_w
								|| 'ds_horarios_interv_w:'|| ds_horarios_interv_w || 'ds_horarios_w:' || ds_horarios_w || 'ds_horarios_ww:' || ds_horarios_ww 
								|| 'ds_horarios_www:' || ds_horarios_www || 'ds_rastre_prescr_dp_w:' || ds_rastre_prescr_dp_w 
								|| 'dt_inicio_prescr_w:' || to_char( dt_inicio_prescr_w , 'dd/mm/yyyy hh24:mi:ss') 
								|| 'dt_proxima_dose_ww:' || to_char( dt_proxima_dose_ww , 'dd/mm/yyyy hh24:mi:ss') 
								|| 'dt_validade_prescr_w:' || to_char( dt_validade_prescr_w , 'dd/mm/yyyy hh24:mi:ss') || 'ie_add_dia_w:' || ie_add_dia_w 
								|| 'ie_dia_semana_w:' || ie_dia_semana_w || 'ie_domingo_w:' || ie_domingo_w || 'ie_horario_valido_w:' || ie_horario_valido_w 
								|| 'ie_operacao_w:' || ie_operacao_w || 'ie_quarta_w:' || ie_quarta_w || 'ie_quinta_w:' || ie_quinta_w 
								|| 'ie_rastre_prescr_dp_w:' || ie_rastre_prescr_dp_w || 'ie_sabado_w:' || ie_sabado_w || 'ie_segunda_w:' || ie_segunda_w 
								|| 'ie_sexta_w:' || ie_sexta_w || 'ie_terca_w:' || ie_terca_w || 'nr_horas_validade_w:' || nr_horas_validade_w 
								|| 'qt_horarios_medic_w:' || qt_horarios_medic_w || 'qt_tot_disp_w:' || qt_tot_disp_w, 1, 1800);
						end if;						
						
						ie_add_dia_w := 'S';	
				else	
					if (ie_rastre_prescr_dp_w = 'S') then		
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || chr(13) || 'linha:' || $$plsql_line || chr(13), 1, 1800);
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'DT_PROXIMA_DOSE(' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) || '/', 1, 1800);
					end if;
					
					NEW.dt_proxima_dose	:= dt_proxima_dose_ww2;
						
					if (ie_rastre_prescr_dp_w = 'S') then		
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) ||'); ' || chr(13), 1, 1800);						
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'cd_motivo_baixa_w:' ||  cd_motivo_baixa_w
							|| 'ds_horarios_interv_w:'|| ds_horarios_interv_w || 'ds_horarios_w:' || ds_horarios_w || 'ds_horarios_ww:' || ds_horarios_ww
							|| 'ds_horarios_www:' || ds_horarios_www || 'ds_rastre_prescr_dp_w:' || ds_rastre_prescr_dp_w 
							|| 'dt_inicio_prescr_w:' || to_char( dt_inicio_prescr_w , 'dd/mm/yyyy hh24:mi:ss') 
							|| 'dt_proxima_dose_ww:' || to_char( dt_proxima_dose_ww , 'dd/mm/yyyy hh24:mi:ss') 
							|| 'dt_validade_prescr_w:' || to_char( dt_validade_prescr_w , 'dd/mm/yyyy hh24:mi:ss') || 'ie_add_dia_w:' || ie_add_dia_w 
							|| 'ie_dia_semana_w:' || ie_dia_semana_w || 'ie_domingo_w:' || ie_domingo_w || 'ie_horario_valido_w:' || ie_horario_valido_w 
							|| 'ie_operacao_w:' || ie_operacao_w || 'ie_quarta_w:' || ie_quarta_w || 'ie_quinta_w:' || ie_quinta_w 
							|| 'ie_rastre_prescr_dp_w:' || ie_rastre_prescr_dp_w || 'ie_sabado_w:' || ie_sabado_w || 'ie_segunda_w:' || ie_segunda_w 
							|| 'ie_sexta_w:' || ie_sexta_w || 'ie_terca_w:' || ie_terca_w || 'nr_horas_validade_w:' || nr_horas_validade_w 
							|| 'qt_horarios_medic_w:' || qt_horarios_medic_w || 'qt_tot_disp_w:' || qt_tot_disp_w, 1, 1800);
					end if;	
					
					if (coalesce(NEW.ie_sem_aprazamento,'N') = 'N') or (NEW.hr_prim_horario is not null) then
						NEW.qt_total_dispensar	:= NEW.qt_total_dispensar - qt_tot_disp_w;
					end if;
				end if;
				dt_proxima_dose_ww := 	NEW.dt_proxima_dose;
				
				i:= i + 1;
				end;
			end loop;	
			
			if (ie_horario_valido_w = 'N') then	
				NEW.qt_total_dispensar	:=0;
				NEW.cd_motivo_baixa	:= coalesce(cd_motivo_baixa_w,0);
				NEW.ie_regra_disp	:= 'N';
				NEW.ie_administrar := 'N';
			end if;
		end if;
	else		
  
		if (coalesce(qt_horarios_medic_w,0) = 1) and (ds_horarios_interv_w is null) and (nr_horas_validade_w > 24) and (coalesce(Obter_se_horario_valido_inter(dt_proxima_dose_ww, NEW.cd_intervalo), 'A') = 'I') and (Obter_se_horario_valido_inter(dt_proxima_dose_ww + 1, NEW.cd_intervalo) = 'A') and (dt_proxima_dose_ww + 1 between dt_inicio_prescr_w and dt_validade_prescr_w) then
		
			dt_proxima_dose_ww := dt_proxima_dose_ww + 1;
		end if;
	
		ie_dia_semana_w		:= pkg_date_utils.get_WeekDay(dt_proxima_dose_ww);
		
		NEW.qt_dia_prim_hor	:= abs(trunc(dt_proxima_dose_ww - dt_inicio_prescr_w));
		
		if	((dt_proxima_dose_ww not between dt_inicio_prescr_w and dt_validade_prescr_w) or
			 (ie_dia_semana_w	= 1 AND ie_domingo_w	= 'N') or
			 (ie_dia_semana_w	= 2 AND ie_segunda_w	= 'N') or
			 (ie_dia_semana_w	= 3 AND ie_terca_w	= 'N') or
			 (ie_dia_semana_w	= 4 AND ie_quarta_w	= 'N') or
			 (ie_dia_semana_w	= 5 AND ie_quinta_w	= 'N') or
			 (ie_dia_semana_w	= 6 AND ie_sexta_w	= 'N') or
			 (ie_dia_semana_w	= 7 AND ie_sabado_w	= 'N')) then
			NEW.ie_administrar	:= 'N';
			
			if (coalesce(NEW.ie_sem_aprazamento,'N') = 'N') or (NEW.hr_prim_horario is not null) then
				NEW.qt_total_dispensar	:= 0;
				NEW.cd_motivo_baixa	:= coalesce(cd_motivo_baixa_w,0);
				NEW.ie_regra_disp	:= 'N';
			end if;
		elsif (dt_proxima_dose_ww between dt_inicio_prescr_w and dt_validade_prescr_w) then
			NEW.ie_administrar		:= null;
			NEW.cd_motivo_baixa	:= 0;
		end if;

		if (NEW.ie_administrar = 'S') or 
			((NEW.dt_proxima_dose is not null)  and
			 ((ie_operacao_w	= 'D') and
			 ((Obter_se_horario_valido_inter(dt_proxima_dose_ww, NEW.cd_intervalo) = 'I') or (Obter_se_horario_valido_inter(NEW.dt_proxima_dose, NEW.cd_intervalo) = 'I')))) or
			((NEW.dt_proxima_dose is null) and (NEW.ie_administrar = 'N') and (ie_operacao_w	= 'D') and (Obter_se_horario_valido_inter(dt_proxima_dose_ww, NEW.cd_intervalo) = 'I')) then
	
			if (ie_rastre_prescr_dp_w = 'S') then		
				ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || chr(13) || 'linha:' || $$plsql_line || chr(13), 1, 1800);
				ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'DT_PROXIMA_DOSE(' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) || '/', 1, 1800);
			end if;

			NEW.dt_proxima_dose	:= obter_proxima_dose_medic(dt_proxima_dose_ww,NEW.cd_intervalo, NEW.ds_horarios, ie_add_dia_w);
			ie_add_dia_w := 'S';
				
			if (ie_rastre_prescr_dp_w = 'S') then		
				ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) ||'); ' || chr(13), 1, 1800);						
				ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'cd_motivo_baixa_w:' || cd_motivo_baixa_w
					|| 'ds_horarios_interv_w:'|| ds_horarios_interv_w || 'ds_horarios_w:' || ds_horarios_w || 'ds_horarios_ww:' || ds_horarios_ww 
					|| 'ds_horarios_www:' || ds_horarios_www || 'ds_rastre_prescr_dp_w:' || ds_rastre_prescr_dp_w 
					|| 'dt_inicio_prescr_w:' || to_char( dt_inicio_prescr_w , 'dd/mm/yyyy hh24:mi:ss') 
					|| 'dt_proxima_dose_ww:' || to_char( dt_proxima_dose_ww , 'dd/mm/yyyy hh24:mi:ss') 
					|| 'dt_validade_prescr_w:' || to_char( dt_validade_prescr_w , 'dd/mm/yyyy hh24:mi:ss') || 'ie_add_dia_w:' || ie_add_dia_w 
					|| 'ie_dia_semana_w:' || ie_dia_semana_w || 'ie_domingo_w:' || ie_domingo_w || 'ie_horario_valido_w:' || ie_horario_valido_w 
					|| 'ie_operacao_w:' || ie_operacao_w || 'ie_quarta_w:' || ie_quarta_w || 'ie_quinta_w:' || ie_quinta_w 
					|| 'ie_rastre_prescr_dp_w:' || ie_rastre_prescr_dp_w || 'ie_sabado_w:' || ie_sabado_w || 'ie_segunda_w:' || ie_segunda_w 
					|| 'ie_sexta_w:' || ie_sexta_w || 'ie_terca_w:' || ie_terca_w || 'nr_horas_validade_w:' || nr_horas_validade_w 
					|| 'qt_horarios_medic_w:' || qt_horarios_medic_w || 'qt_tot_disp_w:' || qt_tot_disp_w, 1, 1800);
			end if;
		end if;
	end if;	
end;

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then
      goto to_final;
end if;

cd_perfil_w				:= coalesce(obter_perfil_ativo,0);
cd_estabelecimento_w	:= coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);
cd_funcao_origem_w		:= coalesce(wheb_usuario_pck.get_cd_funcao,0);

CALL wheb_assist_pck.set_informacoes_usuario(cd_estabelecimento_w,cd_perfil_w,coalesce(NEW.nm_usuario,wheb_usuario_pck.get_nm_usuario));

if (coalesce(NEW.ie_medicacao_paciente,'N') = 'S') then
	ie_gera_lote_pac_w := wheb_assist_pck.obterValorParametroREP(389, ie_gera_lote_pac_w);
	if (coalesce(ie_gera_lote_pac_w,'N')		<> 'S') then
		NEW.ie_regra_disp := 'N';
	end if;	
end if;

ie_rastre_prescr_dp_w := obter_se_info_rastre_prescr('DP', coalesce(NEW.nm_usuario, wheb_usuario_pck.get_nm_usuario), cd_perfil_w, cd_estabelecimento_w);

select	coalesce(max(qt_dias_lib_padrao),0),
		coalesce(max(ie_log_baixa_item),'N')
into STRICT	qt_dias_lib_padrao_w,
		ie_log_baixa_item_w
from	parametro_medico
where   cd_estabelecimento = cd_estabelecimento_w;

cd_funcao_origem_ww		:= obter_funcao_origem_prescr(NEW.nr_prescricao);
dt_inicio_prescr_w		:= obter_datas_prescricao(NEW.nr_prescricao,'I');
dt_validade_prescr_w	:= coalesce(obter_datas_prescricao(NEW.nr_prescricao,'V'), dt_inicio_prescr_w + 24);
nr_horas_validade_w		:= Obter_dados_prescricao(NEW.nr_prescricao,'HR');

if (NEW.ie_agrupador = 1) then
	ie_tipo_item_w	:= 'M';
elsif (NEW.ie_agrupador = 2) then
	ie_tipo_item_w	:= 'MAT';
elsif (NEW.ie_agrupador = 8) then
	ie_tipo_item_w	:= 'SNE';
elsif (NEW.ie_agrupador = 4) then
	ie_tipo_item_w	:= 'SOL';
elsif (NEW.ie_agrupador = 12) then
	ie_tipo_item_w	:= 'S';	
elsif (NEW.ie_agrupador = 16) then
	ie_tipo_item_w	:= 'LD';
end if;

select	coalesce(obter_dados_medic_atb_var(max(cd_material),cd_estabelecimento_w,max(ie_justifica_dias_util),'JD',null,null,null),'N'),
		coalesce(max(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS')),NEW.cd_unidade_medida),
		coalesce(max(ie_vancomicina), 'N'),
		coalesce(max(qt_dia_terapeutico),0),
		coalesce(max(qt_dia_profilatico),0),
		coalesce(max(ie_dias_util_medic),'N'),
		coalesce(max(obter_se_material_padronizado(cd_estabelecimento_w,cd_material)),'N')
into STRICT	ie_justifica_dias_util_w,
		cd_unidade_medida_consumo_w,
		ie_vancomicina_w,
		qt_dia_terapeutico_w,
		qt_dia_profilatico_w,
		ie_dias_util_medic_w,
		ie_padronizado_w
from	material
where	cd_material = NEW.cd_material;

/* --> Rafael em 03/09/2007 x ADEP x cfe definido com Marcus <-- */


if (coalesce(OLD.ie_suspenso,'N') = 'N') and (NEW.ie_suspenso = 'S') then
	BEGIN
	ie_altera_status_atend_w := wheb_assist_pck.obterValorParametroREP(1068, ie_altera_status_atend_w);	
	
	if (ie_vancomicina_w = 'S') then
		update	rep_dialogo_vancomicina
		set		ie_situacao = 'I'
		where	nr_seq_material = NEW.nr_sequencia
		and		nr_prescricao = NEW.nr_prescricao;
	end if;
	
	update	prescr_mat_hor b
	set		nm_usuario_adm = nm_usuario_inter,
			dt_fim_horario = dt_interrupcao
	where	((b.nr_seq_lote is null) or (ie_altera_status_atend_w = 'S') or (not exists (SELECT 1 from ap_lote c where c.nr_sequencia = b.nr_seq_lote and c.dt_atend_farmacia is not null)))
	and		dt_inicio_horario is not null
	and		dt_fim_horario is null
	and		dt_suspensao is null
	and		ie_agrupador in (4,8,13)
	and		nr_seq_material = NEW.nr_sequencia
	and		nr_prescricao = NEW.nr_prescricao;

	update	prescr_mat_hor b
	set		dt_suspensao = LOCALTIMESTAMP,
			nm_usuario_susp = NEW.nm_usuario_susp,
			nr_seq_motivo_susp = NEW.nr_seq_motivo_susp,
			ds_motivo_susp = NEW.ds_motivo_susp,
			dt_fim_horario = CASE WHEN ie_agrupador=4 THEN  dt_interrupcao  ELSE dt_fim_horario END
	where	((ie_agrupador not in (4,8,13)) or (dt_inicio_horario is null))
	and		((b.nr_seq_lote is null) or (ie_altera_status_atend_w = 'S') or (not exists (SELECT 1 from ap_lote c where c.nr_sequencia = b.nr_seq_lote and c.dt_atend_farmacia is not null)))
	and		dt_inicio_horario is null
	and		dt_fim_horario is null
	and		dt_suspensao is null
	and		nr_seq_material = NEW.nr_sequencia
	and		nr_prescricao = NEW.nr_prescricao;
	
	update	prescr_mat_hor b
	set		dt_suspensao = LOCALTIMESTAMP,
			nm_usuario_susp = NEW.nm_usuario_susp,
			nr_seq_motivo_susp = NEW.nr_seq_motivo_susp,
			ds_motivo_susp = NEW.ds_motivo_susp
	where	((ie_agrupador not in (4,8,13)) or (dt_inicio_horario is null))
	and		((b.nr_seq_lote is null) or (ie_altera_status_atend_w = 'S') or (not exists (SELECT 1 from ap_lote c where c.nr_sequencia = b.nr_seq_lote and c.dt_atend_farmacia is not null)))
	and		dt_inicio_horario is null
	and		dt_fim_horario is null
	and		dt_suspensao is null
	and		nr_seq_superior = NEW.nr_sequencia
	and		nr_prescricao = NEW.nr_prescricao;
	
	CALL Atualizar_adep_controle_SC(NEW.nm_usuario, nr_atendimento_w, ie_tipo_item_w, 'S', NEW.nr_prescricao);	
	CALL Atualizar_plt_controle(null, nr_atendimento_w, null, ie_tipo_item_w, 'S', NEW.nr_prescricao);	
	end;
else
	Atualizar_plt_controle(NEW.nm_usuario, nr_atendimento_w, null, ie_tipo_item_w, 'S', NEW.nr_prescricao);		
end if;

if (ie_vancomicina_w = 'S') and (NEW.dt_lib_material is null) and
	((coalesce(OLD.qt_dose,-1) <> coalesce(NEW.qt_dose,-1)) or (coalesce(OLD.cd_unidade_medida_dose,'XPTO') <> coalesce(NEW.cd_unidade_medida_dose,'XPTO')) or (coalesce(OLD.cd_intervalo,'XPTO') <> coalesce(NEW.cd_intervalo,'XPTO'))) then
	update	rep_dialogo_vancomicina
	set		qt_dose_manut_adm = NEW.qt_dose,
			cd_unidade_medida_adm = NEW.cd_unidade_medida_dose,
			cd_intervalo_adm = NEW.cd_intervalo,
			nm_usuario = NEW.nm_usuario
	where	ie_tipo_evento = 'SM'
	and		nr_seq_material = NEW.nr_sequencia
	and		nr_prescricao = NEW.nr_prescricao;
end if;

if (NEW.qt_dose is not null) and (NEW.qt_conversao_dose > 0) and (NEW.ds_dose_diferenciada is null) and (coalesce(NEW.nr_seq_mat_cpoe, 0) = 0) then
	
		ie_unit_corrigida_w := 'N';
	
		if (NEW.ie_agrupador in (3,7,9)) then
			qt_dose_extra_w := Obter_dose_extra_disp(NEW.nr_sequencia_diluicao, NEW.nr_prescricao, NEW.cd_unidade_medida_dose, NEW.cd_material, NEW.qt_dose);
		elsif (NEW.ie_agrupador = 1 ) then
			qt_dose_extra_w := Obter_dose_extra_disp(NEW.nr_sequencia, NEW.nr_prescricao, NEW.cd_unidade_medida_dose, NEW.cd_material, NEW.qt_dose);
		elsif	(NEW.ie_agrupador = 4 AND NEW.qt_volume_corrigido > 0) then
			NEW.qt_unitaria := NEW.qt_volume_corrigido/NEW.qt_conversao_dose;	
			ie_unit_corrigida_w := 'S';
		end if;	
			
		if (coalesce(ie_unit_corrigida_w,'N') = 'N') then
			NEW.qt_unitaria := (NEW.qt_dose + qt_dose_extra_w)/NEW.qt_conversao_dose;
		end if;
end if;

if (coalesce(NEW.qt_material,0) > coalesce(NEW.qt_original,0)) then
	NEW.qt_original := NEW.qt_material;
end if;

if (cd_funcao_origem_ww in (950, 924) and
	NEW.qt_dias_liberado = 0 and
	NEW.nr_seq_motivo_reprov is not null) then

	CALL atualizar_dias_ccih(nr_prescricao_p => NEW.nr_prescricao,
						nr_sequencia_p => NEW.nr_sequencia,
						cd_material_p => NEW.cd_material,
						nm_usuario_p => NEW.nm_usuario);
end if;

gerar_log_alteracoes;

gerar_log_rastre_prescr;

if ((obter_funcao_ativa = 900) and (NEW.cd_local_estoque is null) and (OLD.cd_local_estoque is not null) and (coalesce(NEW.cd_motivo_baixa,0) = 0)) then
	BEGIN
			NEW.cd_local_estoque := null;
	end;
elsif (NEW.cd_local_estoque is null) and (OLD.cd_local_estoque is not null) then
		BEGIN
			NEW.cd_local_estoque	:= OLD.cd_local_estoque;
		end;
end if;

if (coalesce(NEW.ie_suspenso,'N') = 'S') and (coalesce(OLD.ie_suspenso,'N') = 'N') then
	BEGIN
	cd_motivo_exclusao_w := wheb_assist_pck.obterValorParametroREP(130, cd_motivo_exclusao_w);
	
	cd_motivo_exclusao_w	:= coalesce((somente_numero(cd_motivo_exclusao_w))::numeric ,0);
	
	if (cd_motivo_exclusao_w > 0) then
		
		ie_somente_proced_w := wheb_assist_pck.obterValorParametroREP(639, ie_somente_proced_w);
		
		if (coalesce(ie_somente_proced_w,'N') = 'N') then
			update	material_atend_paciente a
			set		a.cd_motivo_exc_conta		= (cd_motivo_exclusao_w)::numeric ,
					a.nr_interno_conta		 = NULL
			where	exists (	SELECT	1
								from	conta_paciente b
								where	b.ie_status_acerto	= 1
								and		a.nr_interno_conta	= b.nr_interno_conta)
			and		a.nr_sequencia_prescricao	= NEW.nr_sequencia
			and		a.nr_prescricao				= NEW.nr_prescricao;
		end if;
	end if;
	end;
end if;
/*
select	max(cd_setor_atendimento)
into cd_setor_prescr_w
from prescr_medica
where	nr_prescricao = :new.nr_prescricao;
*/

cd_setor_prescr_w := null; -- Da erro de mutante se deixar o sql acima.
ie_lib_auto_w	:=	Obter_se_lib_aut_antimic(NEW.cd_material, cd_perfil_w, cd_estabelecimento_w, NEW.nm_usuario, NEW.cd_intervalo, cd_setor_prescr_w, NEW.ie_objetivo);

NEW.cd_unidade_medida	:= cd_unidade_medida_consumo_w;

if	((obter_funcao_ativa <> 896) and ((ie_lib_auto_w = 'S') or (ie_justifica_dias_util_w = 'S'))) then
	if (qt_dias_lib_padrao_w > 0) then
		if (NEW.ie_objetivo	in ('F','P','C')) and (qt_dia_profilatico_w	> 0) and (qt_dias_lib_padrao_w	> qt_dia_profilatico_w) then
			NEW.qt_dias_liberado	:= qt_dia_profilatico_w;			
		elsif (NEW.ie_objetivo	in ('T','D','E')) and (qt_dia_terapeutico_w	> 0) and (qt_dias_lib_padrao_w	> qt_dia_terapeutico_w) then
			NEW.qt_dias_liberado	:= qt_dia_terapeutico_w;			 			
		else	
			if (coalesce(coalesce(NEW.qt_dias_liberado,NEW.qt_total_dias_lib),0) < qt_dias_lib_padrao_w) then
				NEW.qt_dias_liberado	:= qt_dias_lib_padrao_w;
			end if;
		end if;
	else
		NEW.qt_dias_liberado	:= NEW.qt_dias_solicitado;	
	end if;
	
	if (NEW.qt_dias_liberado = 0) then
		NEW.qt_dias_liberado	:= null;
	end if;
end if;

select	max(cd_material)
into STRICT	cd_material_cpoe_w
from	cpoe_material
where	nr_sequencia = NEW.nr_seq_mat_cpoe;

if (cd_funcao_origem_ww = 2314) and (cd_material_cpoe_w = NEW.cd_material)  and (NEW.nr_prescricao_anterior is null) and
	((NEW.qt_dias_liberado = 0) or (coalesce(NEW.qt_dias_liberado,0) <> coalesce(OLD.qt_dias_liberado,0))) then	
	CALL cpoe_atualizar_dias_liberados(NEW.nm_usuario, NEW.nr_seq_mat_cpoe, NEW.nr_prescricao, coalesce(NEW.qt_dias_liberado,0));
end if;


if (NEW.cd_intervalo is not null) then

	select	max(ie_segunda),
			max(ie_terca),
			max(ie_quarta),
			max(ie_quinta),
			max(ie_sexta),
			max(ie_sabado),
			max(ie_domingo),
			coalesce(max(qt_operacao),0),
			max(ie_operacao),
			Obter_se_interv_superior_24h(max(cd_intervalo), null),
			max(ds_horarios)
	into STRICT	ie_segunda_w,
			ie_terca_w,
			ie_quarta_w,
			ie_quinta_w,
			ie_sexta_w,
			ie_sabado_w,
			ie_domingo_w,
			qt_operacao_w,
			ie_operacao_w,
			ie_interv_sup_24h_w,
			ds_horarios_interv_w
	from	intervalo_prescricao
	where	cd_intervalo	= NEW.cd_intervalo;

end if;

if (NEW.dt_baixa is null) then
	if (NEW.cd_intervalo is not null) and (NEW.dt_inicio_medic is null) and (NEW.hr_prim_horario is not null) and (NEW.hr_prim_horario <> '  :  ') then
		BEGIN

		if (NEW.qt_dia_prim_hor = 1) and (NEW.hr_prim_horario >= to_char(dt_inicio_prescr_w, 'hh24:mi')) and (obter_funcao_ativa <> 252) then
			BEGIN
				NEW.qt_dia_prim_hor := 0;
			end;
		end if;
		
		end;
	end if;

	if (ie_interv_sup_24h_w = 'S') and (qt_operacao_w > 24) then
		if (NEW.dt_proxima_dose is not null) and (obter_datas_prescricao(NEW.nr_prescricao,'L') is not null) and (coalesce(NEW.ie_administrar,'S') <> 'N') then
			if (NEW.dt_proxima_dose > dt_validade_prescr_w) then
				dt_proxima_dose_w	:= NEW.dt_proxima_dose - (qt_operacao_w/24);
			else
				dt_proxima_dose_w := NEW.dt_proxima_dose;
			end if;
			
			ie_altera_dt_proxima_dose_w := wheb_assist_pck.obterValorParametroREP(694, ie_altera_dt_proxima_dose_w);
			
			if (NEW.dt_proxima_dose is not null) and (cd_funcao_origem_ww <> 2314) and
				((dt_proxima_dose_w >= dt_inicio_prescr_w AND dt_proxima_dose_w < dt_validade_prescr_w) or
				 (ie_altera_dt_proxima_dose_w = 'S' AND dt_proxima_dose_w < dt_inicio_prescr_w)) then
				NEW.qt_dia_prim_hor := abs(trunc(dt_proxima_dose_w - dt_inicio_prescr_w));
			end if;
		end if;
	elsif	(NEW.dt_lib_material is null AND OLD.dt_proxima_dose is not null) and (coalesce(NEW.cd_motivo_baixa,0) = 0) then
			
		if (ie_rastre_prescr_dp_w = 'S') then		
			ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || chr(13) || 'linha:' || $$plsql_line || chr(13), 1, 1800);
			ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'DT_PROXIMA_DOSE(' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) || '/', 1, 1800);
		end if;
			
		NEW.dt_proxima_dose	:= null;
			
		if (ie_rastre_prescr_dp_w = 'S') then		
			ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || to_char(NEW.dt_proxima_dose, 'dd/mm/yyyy hh24:mi:ss') ||'); ' || chr(13), 1, 1800);						
			ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'old.dt_proxima_dose:' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(OLD.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone), 1, 1800);
		end if;
		
		NEW.ie_administrar		:= null;
	end if;

	if (NEW.cd_intervalo is not null) then	
	
		ie_controla_adm_w := wheb_assist_pck.obterValorParametroREP(992, ie_controla_adm_w);
		
		if (ie_operacao_w	= 'D') and (ie_controla_adm_w = 'S') then
			
			ajustar_dt_proxima_dose;
			
		end if;
	end if;
end if;

if (cd_funcao_origem_ww <> 2314) then
	if (coalesce(NEW.qt_total_dias_lib,0) = 0) and (NEW.qt_dias_liberado is not null) and (OLD.qt_dias_liberado is null) and (obter_atendimento_prescr(NEW.nr_prescricao) is not null) then
		NEW.qt_total_dias_lib := Obter_total_dias_liberado(	NEW.nr_prescricao,
						obter_atendimento_prescr(NEW.nr_prescricao), 
						coalesce(obter_data_prescricao(NEW.nr_prescricao),LOCALTIMESTAMP),
						NEW.cd_material);
		if (NEW.qt_total_dias_lib = 0) then
			NEW.qt_total_dias_lib := null;
		end if;
	end if;

	if (NEW.qt_dias_liberado is not null) and (OLD.qt_dias_liberado is null) then
		NEW.qt_total_dias_lib	:= coalesce(NEW.qt_total_dias_lib,0) + NEW.qt_dias_liberado;
		if (NEW.qt_total_dias_lib = 0) then
			NEW.qt_total_dias_lib := null;
		end if;
	elsif (OLD.qt_dias_liberado is not null) and (NEW.qt_dias_liberado is not null) and (NEW.qt_dias_liberado <> OLD.qt_dias_liberado) then
		NEW.qt_total_dias_lib	:= (coalesce(NEW.qt_total_dias_lib,0) + (coalesce(NEW.qt_dias_liberado,0)) - coalesce(OLD.qt_dias_liberado,0));
		if (NEW.qt_total_dias_lib = 0) then
			NEW.qt_total_dias_lib := null;
		end if;
	elsif (NEW.qt_dias_liberado is null) and (OLD.qt_dias_liberado is not null) and (obter_funcao_ativa = 896) then
		  NEW.qt_total_dias_lib := null;
	end if;

	NEW.ie_novo_ciclo_ccih := 'N';

	if 	((NEW.qt_total_dias_lib <> OLD.qt_total_dias_lib) or (NEW.nr_dia_util >= NEW.qt_total_dias_lib) or (NEW.qt_total_dias_lib is null)) and
		(((NEW.nr_dia_util = 0 and ie_dias_util_medic_w = 'O') or (NEW.nr_dia_util = 1 and ie_dias_util_medic_w = 'S')) or
		 ((NEW.qt_total_dias_lib > 0) and (NEW.nr_dia_util > NEW.qt_total_dias_lib) and ((NEW.nr_dia_util - NEW.qt_total_dias_lib) = 1) and (ie_dias_util_medic_w <> 'O')) or
		 ((ie_dias_util_medic_w = 'O') and (NEW.qt_total_dias_lib > 0) and ((NEW.nr_dia_util - NEW.qt_total_dias_lib) = 0))) then
		NEW.ie_novo_ciclo_ccih := 'S';
	end if;
elsif (obter_funcao_ativa = 896) then
	NEW.qt_total_dias_lib := NEW.qt_dias_liberado;
end if;

if	((obter_funcao_ativa = 47)  and (coalesce(ie_padronizado_w,'N') = 'N') and
	 ((coalesce(NEW.qt_total_dias_lib,0) = 0) or (coalesce(NEW.qt_total_dias_lib,0) <> coalesce(OLD.qt_total_dias_lib,0)))) then
	CALL cpoe_update_nao_padronizados(NEW.nm_usuario, NEW.nr_seq_mat_cpoe, NEW.nr_prescricao, NEW.qt_total_dias_lib);
end if;

if (NEW.ie_status_cirurgia	= 'CB') and (NEW.nm_usuario_consist is null) then
	NEW.nm_usuario_consist		:= NEW.nm_usuario;
	NEW.dt_atualizacao_consist	:= NEW.dt_atualizacao;
end if;

if (ie_log_baixa_item_w	= 'S') and (coalesce(NEW.cd_motivo_baixa,0) > 0) and (coalesce(OLD.cd_motivo_baixa,0) = 0) then
	BEGIN
	
	/*select	count(*)
	into	qt_existe_w
	from	prescr_mat_hor
	where	nr_prescricao = :new.nr_prescricao
	and	nr_seq_material = :new.nr_sequencia
	and	ie_dispensar_farm is null;
	
	if	(qt_existe_w > 0) then
		update	prescr_mat_hor
		set	ie_dispensar_farm = 'S',
			dt_atualizacao = sysdate,
			nm_usuario = :new.nm_usuario
		where	nr_prescricao = :new.nr_prescricao
		and	nr_seq_material = :new.nr_sequencia
		and	ie_dispensar_farm is null;
	end if;*/

	
	ds_origem_w := substr(dbms_utility.format_call_stack,1,1800);
	select	nextval('rep_log_baixa_item_seq')
	into STRICT	nr_seq_log_w
	;
	
	insert into rep_log_baixa_item(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_objeto,
		nr_prescricao,
		nr_seq_material,
		cd_motivo_baixa)
	values (nr_seq_log_w,
		LOCALTIMESTAMP,
		coalesce(NEW.nm_usuario,'Tasy'),
		LOCALTIMESTAMP,
		NEW.nm_usuario,
		substr(ds_origem_w,1,255),
		NEW.nr_prescricao,
		NEW.nr_sequencia,
		NEW.cd_motivo_baixa);
	end;
end if;

if (NEW.qt_dias_liberado = 0) and (coalesce(NEW.qt_dias_solicitado,0) = 0) then
	NEW.qt_dias_liberado	:= null;
end if;

if (NEW.nr_agrupamento is null) then
	NEW.nr_agrupamento := 99;
end if;

if (coalesce(NEW.ie_administrar,'S') = 'N') then
	update	prescr_mat_hor
	set		ie_situacao	= 'I'
	where	dt_fim_horario is null
	and		dt_suspensao is null
	and		nr_seq_material = NEW.nr_sequencia
	and		nr_prescricao 	= NEW.nr_prescricao;
	
	update	prescr_mat_hor
	set		ie_situacao	= 'I'
	where	dt_suspensao is null
	and		dt_fim_horario is null
	and		nr_seq_superior	= NEW.nr_sequencia
	and		nr_prescricao	= NEW.nr_prescricao;
end if;

BEGIN
if (OLD.hr_prim_horario <> NEW.hr_prim_horario) and (NEW.hr_prim_horario <> '  :  ') and (NEW.hr_prim_horario is not null) and (coalesce(NEW.ie_administrar,'S') <> 'N') and (NEW.dt_proxima_dose is not null) and (qt_operacao_w > 24) and (ie_interv_sup_24h_w = 'S') then
	if (ie_rastre_prescr_dp_w = 'S') then		
		ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || chr(13) || 'linha:' || $$plsql_line || chr(13), 1, 1800);
		ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'DT_PROXIMA_DOSE(' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) || '/', 1, 1800);
	end if;
		
	NEW.dt_proxima_dose := to_date(to_char(dt_inicio_prescr_w + coalesce(NEW.qt_dia_prim_hor,0),'dd/mm/yyyy ')||NEW.hr_prim_horario||':00','dd/mm/yyyy hh24:mi:ss') + (qt_operacao_w/24);
		
	if (ie_rastre_prescr_dp_w = 'S') then		
		ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || to_char(NEW.dt_proxima_dose, 'dd/mm/yyyy hh24:mi:ss') ||'); ' || chr(13), 1, 1800);						
		ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'new.dt_proxima_dose:' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) || 'new.hr_prim_horario:' || NEW.hr_prim_horario || 'new.ie_administrar:' || NEW.ie_administrar || 'old.hr_prim_horario:' || OLD.hr_prim_horario || 'ie_interv_sup_24h_w:' || ie_interv_sup_24h_w || 'qt_operacao_w:' || qt_operacao_w, 1, 1800);
	end if;
end if;

if	((((OLD.hr_prim_horario <> NEW.hr_prim_horario) and (NEW.hr_prim_horario <> '  :  ') and (NEW.hr_prim_horario is not null)) or (coalesce(NEW.qt_dia_prim_hor,0) <> coalesce(OLD.qt_dia_prim_hor,0))) or
	(((NEW.hr_prim_horario is null) or 	  ---Tratamento para se o hr_prim_horario estiver  null ou vazio	
	  (NEW.hr_prim_horario = '  :  ')) and (obter_se_acm_sn(NEW.ie_acm, NEW.ie_se_necessario) <> 'S') and (NEW.ds_horarios is not null))) and (cd_funcao_origem_ww = 2314) and
	((obter_funcao_ativa = 7015) or (obter_funcao_ativa = 7010 and coalesce(obter_se_mat_lib_farm_cpoe(NEW.nr_seq_mat_cpoe),'N') = 'N') or (obter_funcao_ativa = 252)) and (obter_datas_prescricao(NEW.nr_prescricao,'L') is not null) then

	select 	coalesce(max('S'),'N')
	into STRICT	ie_inter_dif_w
	from	cpoe_material
	where	nr_sequencia = NEW.nr_seq_mat_cpoe
	and		((coalesce(ie_domingo,'S') = 'N')
	or (coalesce(ie_segunda,'S') = 'N')
	or (coalesce(ie_terca,'S') = 'N')
	or (coalesce(ie_quarta,'S') = 'N')
	or (coalesce(ie_quinta,'S') = 'N')
	or (coalesce(ie_sexta,'S') = 'N')
	or (coalesce(ie_sabado,'S') = 'N'));

	if (ie_inter_dif_w = 'N') then
	
		qt_horas_adicional_w := 24;
		
		if (NEW.cd_intervalo is not null) then
		select	coalesce(max(ie_24_h),'N')
		into STRICT  ie_intervalo_24_w
		from  intervalo_prescricao
		where  cd_intervalo = NEW.cd_intervalo
		and    coalesce(ie_operacao,'X') = 'H'
		and    coalesce(qt_operacao,1) > 24;	
		end if;
		
		qt_horas_ant_copia_cpoe_w := get_qt_hours_after_copy_cpoe( obter_perfil_ativo, NEW.nm_usuario, obter_estabelecimento_ativo);
					
		if (NEW.dt_proxima_dose is not null) and (ie_intervalo_24_w = 'S') then
	
			ie_controla_adm_w := wheb_assist_pck.obterValorParametroREP(992, ie_controla_adm_w);
			
			if ((ie_controla_adm_w = 'S') and (coalesce(NEW.ie_sem_aprazamento,'N') = 'N')) then
				
				ie_altera_dt_proxima_dose_w := wheb_assist_pck.obterValorParametroREP(694, ie_altera_dt_proxima_dose_w);		
				qt_hora_intervalo_ww 	:= Obter_ocorrencia_intervalo(NEW.cd_intervalo, nr_horas_validade_w,'H');
				dt_proxima_dose_ww	:= to_date(to_char(coalesce(NEW.dt_inicio_medic, dt_inicio_prescr_w), 'dd/mm/yyyy ') || to_char(dt_inicio_prescr_w, 'hh24:mi'), 'dd/mm/yyyy hh24:mi');
		
				if (NEW.hr_prim_horario is not null AND NEW.hr_prim_horario <> '  :  ') then
				
					if (NEW.dt_inicio_medic is null) and (to_char(dt_inicio_prescr_w, 'hh24:mi') >  obter_prim_dshorarios(NEW.ds_horarios)) then
						dt_proxima_dose_ww	:= dt_inicio_prescr_w + 1;
						ie_add_dia_w := 'N';					
					end if;
					
					dt_proxima_dose_ww	:= to_date(to_char(dt_proxima_dose_ww,'dd/mm/yyyy ') || obter_prim_dshorarios(NEW.ds_horarios) || ':00','dd/mm/yyyy hh24:mi:ss');
					
				end if;			
					
				if	(ie_altera_dt_proxima_dose_w = 'S' AND dt_proxima_dose_ww is not null) then
					
					dt_proxima_dose_ww	:= dt_proxima_dose_ww + qt_hora_intervalo_ww/24;
	
					if (ie_rastre_prescr_dp_w = 'S') then		
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || chr(13) || 'linha:' || $$plsql_line || chr(13), 1, 1800);
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'DT_PROXIMA_DOSE(' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_proxima_dose, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone) || '/', 1, 1800);
					end if;
						
					NEW.dt_proxima_dose := dt_proxima_dose_ww;
						
					if (ie_rastre_prescr_dp_w = 'S') then		
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || to_char(NEW.dt_proxima_dose, 'dd/mm/yyyy hh24:mi:ss') ||'); ' || chr(13), 1, 1800);						
						ds_rastre_prescr_dp_w := substr(ds_rastre_prescr_dp_w || 'dt_proxima_dose_ww:' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_proxima_dose_ww, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone), 1, 1800);
					end if;
				end if;
			end if;		
	
			dt_copia_cpoe_w	:= (NEW.dt_proxima_dose - (qt_horas_ant_copia_cpoe_w/24));
		else
			
			if (ie_intervalo_24_w = 'S') then
				qt_horas_adicional_w := Obter_ocorrencia_intervalo(NEW.cd_intervalo,24,'H');
			else
				qt_horas_adicional_w := Obter_ocorrencia_intervalo(NEW.cd_intervalo,24,'H');		
				if (ie_operacao_w = 'H' and qt_horas_adicional_w > 12 and qt_horas_adicional_w < 24) then
					qt_horas_adicional_w := qt_horas_adicional_w + qt_horas_adicional_w;
				else
					qt_horas_adicional_w := 24;
				end if;
			end if;
			
			if	(NEW.hr_prim_horario is not null AND NEW.hr_prim_horario <> '  :  ') then
				hr_prim_horario_w	:=	NEW.hr_prim_horario;
			else
				hr_prim_horario_w 	:=	obter_prim_dshorarios(NEW.ds_horarios);
			end if;
	
			dt_inicio_item_w := to_date(to_char(dt_inicio_prescr_w + coalesce(NEW.qt_dia_prim_hor,0),'dd/mm/yyyy')||' '||hr_prim_horario_w||':00','dd/mm/yyyy hh24:mi:ss');
			
			if (obter_funcao_ativa = 7010 or obter_funcao_ativa = 7015) then
			
				BEGIN
			
			    select	max(nr_atendimento),
						max(cd_pessoa_fisica)
				into STRICT	nr_atendimento_w,
						cd_pessoa_fisica_w
				from	prescr_medica
				where	nr_prescricao = NEW.nr_prescricao;
			
				nr_ult_prescricao_w := 	obter_prescr_item_cpoe(NEW.nr_seq_mat_cpoe, 'M', nr_atendimento_w, cd_pessoa_fisica_w );
				
			    if (nr_ult_prescricao_w is not null) and (nr_ult_prescricao_w <> NEW.nr_prescricao) then
					dt_inicio_item_w := to_date( to_char(obter_datas_prescricao(nr_ult_prescricao_w,'I'),'dd/mm/yyyy')||' '||hr_prim_horario_w||':00','dd/mm/yyyy hh24:mi:ss');
				end if;
						
				end;
			end if;
			
			if (dt_inicio_item_w < dt_inicio_prescr_w) then
				dt_inicio_item_w := dt_inicio_item_w + 1;
			end if;

			dt_copia_cpoe_w	:= (dt_inicio_item_w + ((qt_horas_adicional_w - qt_horas_ant_copia_cpoe_w)/24));
			
		end if;
		
		update	cpoe_material
		set		dt_prox_geracao = trunc(dt_copia_cpoe_w,'hh')
		where	nr_sequencia = NEW.nr_seq_mat_cpoe;
		
	end if;
	
end if;

if	(((OLD.ie_via_aplicacao <> NEW.ie_via_aplicacao) or (OLD.cd_intervalo <> NEW.cd_intervalo)) and (NEW.ie_agrupador = 1)) then
	
	BEGIN --Exception
	
	select	max(nr_atendimento),
		max(cd_setor_atendimento),
		max(cd_pessoa_fisica),
		obter_peso_prescr_sinal(max(nr_prescricao)),
		Obter_Idade_PF(max(cd_pessoa_fisica), LOCALTIMESTAMP, 'A')
	into STRICT	nr_atendimento_w,
		cd_setor_atendimento_w,
		cd_pessoa_fisica_w,
		qt_peso_w,
		qt_idade_w
	from	prescr_medica
	where	nr_prescricao = NEW.nr_prescricao;
		
	qt_hora_aplicacao_w	:= (Obter_Padrao_Param_Prescr(nr_atendimento_w, NEW.cd_material, NEW.ie_via_aplicacao, cd_setor_atendimento_w, cd_pessoa_fisica_w,
							qt_idade_w, qt_peso_w, NEW.ie_se_necessario, 'HR', NEW.cd_intervalo))::numeric;
	
	qt_min_aplicacao_w	:= (Obter_Padrao_Param_Prescr(nr_atendimento_w, NEW.cd_material, NEW.ie_via_aplicacao, cd_setor_atendimento_w, cd_pessoa_fisica_w,
							qt_idade_w, qt_peso_w, NEW.ie_se_necessario, 'MI', NEW.cd_intervalo))::numeric;
										
	if (qt_min_aplicacao_w > 0) then	
		if (qt_min_aplicacao_w < 60) then
			NEW.qt_min_aplicacao	:= qt_min_aplicacao_w;
			NEW.qt_hora_aplicacao	:= null;		
		elsif (qt_min_aplicacao_w = 60) then
			NEW.qt_hora_aplicacao	:= 1;
			NEW.qt_min_aplicacao 	:= null;
		else
			NEW.qt_hora_aplicacao	:= trunc(dividir(qt_min_aplicacao_w,60));		
			NEW.qt_min_aplicacao	:= (qt_min_aplicacao_w - (NEW.qt_hora_aplicacao * 60));
			if (NEW.qt_min_aplicacao = 0) then
				NEW.qt_min_aplicacao	:= null;
			end if;
		end if;		
	end if;
	
	if (qt_hora_aplicacao_w > 0) then
		NEW.qt_hora_aplicacao	:= qt_hora_aplicacao_w;
		if (qt_min_aplicacao_w <= 0) then
			NEW.qt_min_aplicacao := null;
		end if;
	end if;
		
	exception
	when others then	
		NEW.qt_min_aplicacao	:= null;
		NEW.qt_hora_aplicacao	:= null;		
	end;
				
end if;

exception when others then
	null;	
end;

if (NEW.nr_ocorrencia = 0) and (cd_funcao_origem_w = 7015) then
	NEW.nr_ocorrencia := 1;
end if;	

if	((coalesce(OLD.cd_material,0) > 0) and (NEW.cd_material <> OLD.cd_material) and obter_se_medic_subst(NEW.nr_sequencia,NEW.nr_prescricao) = 'N') and (NEW.ie_agrupador not in (3,7,9)) then

	select	coalesce(max('S'), 'N')
	into STRICT	ie_liberado_medico_w
	from	prescr_medica
	where	nr_prescricao = NEW.nr_prescricao
	and	dt_liberacao_medico is not null;
	
	if (ie_liberado_medico_w = 'S') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(355770,'NR_PRESCRICAO=' ||NEW.nr_prescricao);
	end if;
end if;

if (coalesce(OLD.ie_bomba_infusao,'XPTO') <> coalesce(NEW.ie_bomba_infusao,'XPTO')) then
	
	update	prescr_material_compl
	set		ie_item_disp_gerado = 'N'
	where	nr_prescricao = NEW.nr_prescricao
	and		nr_sequencia = NEW.nr_sequencia;
end if;

BEGIN
	if ((obter_funcao_ativa = 7015) and (NEW.qt_dia_prim_hor = 1) and (to_date(to_char(NEW.dt_inicio_medic,'dd/mm/yyyy ') || NEW.hr_prim_horario, 'dd/mm/yyyy hh24:mi') > LOCALTIMESTAMP) and (to_date(to_char(NEW.dt_inicio_medic,'dd/mm/yyyy ') || NEW.hr_prim_horario, 'dd/mm/yyyy hh24:mi') > dt_inicio_prescr_w) and (to_char(dt_inicio_prescr_w, 'dd/mm/yyyy') = to_char(NEW.dt_inicio_medic,'dd/mm/yyyy'))) then	
		NEW.qt_dia_prim_hor := 0;
	end if;
exception
when others then	
	null;
end;
if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then
	if (NEW.dt_suspensao is not null AND OLD.dt_suspensao is null) then	
		ds_param_integration_w := '{"recordId" : "' || NEW.nr_seq_interno || '"' || '}';
		CALL execute_bifrost_integration(263, ds_param_integration_w);
	end if;
end if;

if ((OLD.cd_material <> NEW.cd_material) and (NEW.ie_agrupador in (3,7,9))) then
	
	ie_copia_dil_w := wheb_assist_pck.obterValorParametroREP(813, ie_copia_dil_w);
	
	if (coalesce(ie_copia_dil_w,'XPTO') = 'P') then
	
		/*
		Inserido essa opcao no atributo devido a OS 1473600 para que o sistema sinalize o diluente / reconstituiente / rediluente que teve seu material alterado na prescricao anterior
		*/

	
		NEW.ie_alterou_dose_dil := 'D';
	end if;	
end if;

IF (coalesce(OLD.DS_OBSERVACAO,'XPTO') <> coalesce(NEW.DS_OBSERVACAO,'XPTO')) THEN
    CALL Gerar_log_prescr_mat(NEW.nr_prescricao
    ,NEW.nr_sequencia
    ,NEW.ie_agrupador
    ,null
    ,null
    ,'DS_OBSERVACAO('||coalesce(OLD.DS_OBSERVACAO,'<NULO>')||'/'||coalesce(NEW.DS_OBSERVACAO,'<NULO>')||')'
    ,coalesce(NEW.nm_usuario,wheb_usuario_pck.get_nm_usuario)
    ,'N');
END IF;

if (ie_rastre_prescr_dp_w = 'S' and ds_rastre_prescr_dp_w is not null) then
	ds_rastre_prescr_dp_w := substr('Rastreabilidade dos processos de prescricao (Proxima administracao) > prescr_material_update' || ds_rastre_prescr_dp_w, 1, 1800);

	CALL gerar_log_prescr_mat(NEW.nr_prescricao, NEW.nr_sequencia, NEW.ie_agrupador, null, null, ds_rastre_prescr_dp_w, coalesce(NEW.nm_usuario, wheb_usuario_pck.get_nm_usuario), 'N');
end if;
<<to_final>>
null;

  END;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_material_update() FROM PUBLIC;

CREATE TRIGGER prescr_material_update
	BEFORE UPDATE ON prescr_material FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_material_update();

