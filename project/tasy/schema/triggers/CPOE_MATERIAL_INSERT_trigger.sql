-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cpoe_material_insert ON cpoe_material CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cpoe_material_insert() RETURNS trigger AS $BODY$
DECLARE

ie_item_alta_w				cpoe_material.ie_item_alta%type;
nr_seq_transcricao_w		cpoe_material.nr_seq_transcricao%type;
ie_retrogrado_w				cpoe_material.ie_retrogrado%type;
nr_seq_pepo_w				cpoe_material.nr_seq_pepo%type;
nr_cirurgia_w				cpoe_material.nr_cirurgia%type;
nr_cirurgia_patologia_w		cpoe_material.nr_cirurgia_patologia%type;	
nr_seq_agenda_w				cpoe_material.nr_seq_agenda%type;
nr_seq_conclusao_apae_w		cpoe_material.nr_seq_conclusao_apae%type;
ie_item_dupla_valid_w		varchar(1);


BEGIN

if (coalesce(wheb_usuario_pck.get_ie_executar_trigger, 'S') = 'S') then

NEW.ds_stack	:= substr(dbms_utility.format_call_stack,1,2000);

if (coalesce(NEW.ie_retrogrado, 'N') = 'S' or coalesce(NEW.ie_oncologia, 'N') = 'S') then
	NEW.dt_prox_geracao := coalesce(NEW.dt_inicio, LOCALTIMESTAMP);
end if;

if (NEW.cd_perfil_ativo is null)  then
	NEW.cd_perfil_ativo := obter_perfil_ativo;
end if;

if (NEW.nr_seq_cpoe_anterior is not null and NEW.dt_liberacao is null and NEW.cd_funcao_origem = 2314) then
	NEW.dt_liberacao_enf := null;
	NEW.dt_liberacao_farm := null;
	NEW.nm_usuario_lib_enf := null;
	NEW.nm_usuario_lib_farm := null;
	
	NEW.cd_farmac_lib := null;
end if;

if (NEW.dt_suspensao is not null) and (NEW.dt_liberacao is null) and (NEW.cd_funcao_origem = 2314) then
  NEW.dt_suspensao := null;
  NEW.dt_lib_suspensao := null;
end if;

if (NEW.nr_cirurgia is not null) and (NEW.ie_tipo_prescr_cirur is null) then
	NEW.ie_tipo_prescr_cirur := 2;
end if;

if (NEW.nr_seq_adicional is not null) then
	update	cpoe_material
	set		dt_adm_adicional  = NULL
	where	nr_sequencia = NEW.nr_seq_adicional;
end if;

if (NEW.ie_material is null) and (NEW.ie_controle_tempo = 'S') then
	NEW.ie_material := 'N';
end if;

if (coalesce(NEW.ie_material, 'N') = 'S') then
	NEW.ds_medic_nao_padrao := null;
end if;
	
if (NEW.ie_material = 'S') and (NEW.nr_seq_procedimento is not null) then
	
	select	coalesce(max(ie_item_alta),'N'),
			coalesce(max(nr_seq_transcricao),0),
			coalesce(max(ie_retrogrado), 'N'),
			max(nr_seq_pepo),
			max(nr_cirurgia),
			max(nr_cirurgia_patologia),
			max(nr_seq_agenda),
			max(nr_seq_conclusao_apae)
		into STRICT ie_item_alta_w,
			nr_seq_transcricao_w,
			ie_retrogrado_w,
			nr_seq_pepo_w,
			nr_cirurgia_w,
			nr_cirurgia_patologia_w,
			nr_seq_agenda_w,
			nr_seq_conclusao_apae_w
	from    cpoe_procedimento
	where   nr_sequencia = NEW.nr_seq_procedimento;
	
	NEW.ie_item_alta := ie_item_alta_w;
	NEW.nr_seq_transcricao := nr_seq_transcricao_w;
	NEW.ie_retrogrado := ie_retrogrado_w;
	NEW.nr_seq_pepo := nr_seq_pepo_w;	
	NEW.nr_cirurgia := nr_cirurgia_w;
	NEW.nr_cirurgia_patologia := nr_cirurgia_patologia_w;
	NEW.nr_seq_agenda := nr_seq_agenda_w;
	NEW.nr_seq_conclusao_apae := nr_seq_conclusao_apae_w;

end if;

if (NEW.ie_duracao <> 'P') then
	NEW.dt_fim := null;
end if;

if (obter_se_antimicrobiano(NEW.cd_material) = 0) then
	NEW.dt_fim_cih := null;
	NEW.qt_dias_liberado := null;
end if;

if (NEW.ds_dose_diferenciada is not null) then
	CALL gravar_log_tasy(10008,
				' usuario:' || NEW.nm_usuario ||
				' CPOE_MATERIAL_INSERT_DS_DOSE_DIFERENCIADA ' ||
				' sequencia: ' || NEW.nr_sequencia ||
				' codigo material: ' || NEW.cd_material ||
				' medicamento: ' || obter_desc_material(NEW.cd_material) ||
				' old_ds_dose_diferenciada: ' || OLD.ds_dose_diferenciada ||				
				' new_ds_dose_diferenciada: ' || NEW.ds_dose_diferenciada ||
				' old_horarios: ' || OLD.ds_horarios ||				
				' new_horarios: ' || NEW.ds_horarios ||
				' ie_alterou_horario: ' || NEW.ie_alterou_horario ||
				' old_nr_etapas: '  || OLD.nr_etapas ||
				' nr_etapas:'  || NEW.nr_etapas ||				
				' old_nr_ocorrencia:' || OLD.nr_ocorrencia ||
				' nr_ocorrencia:' || NEW.nr_ocorrencia ||
				' nr_seq_cpoe_anterior:' || NEW.nr_seq_cpoe_anterior ||
				' stack:' || substr(dbms_utility.format_call_stack,1,2000),
				NEW.nm_usuario);
end if;

if (NEW.hr_prim_horario is not null and (coalesce(NEW.ie_acm, 'N') = 'S' or coalesce(NEW.ie_se_necessario, 'N') = 'S')) then
    if (trunc(NEW.dt_inicio) > trunc(LOCALTIMESTAMP)) then
        NEW.hr_prim_horario := '01:00';
    else
        NEW.hr_prim_horario := to_char(trunc(LOCALTIMESTAMP, 'hh24') + 1/24, 'hh24:mi');
    end if;
end if;

ie_item_dupla_valid_w := obtem_se_item_dupla_valid(NEW.cd_material);

if (ie_item_dupla_valid_w = 'I') then
	NEW.ie_exige_ciencia := 'L';
elsif (ie_item_dupla_valid_w = 'V') then
	NEW.ie_exige_ciencia := 'V';
end if;

end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cpoe_material_insert() FROM PUBLIC;

CREATE TRIGGER cpoe_material_insert
	BEFORE INSERT ON cpoe_material FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cpoe_material_insert();

