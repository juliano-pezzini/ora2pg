-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pf_familia_before_del ON pf_familia CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pf_familia_before_del() RETURNS trigger AS $BODY$
declare
qtd_member_w		bigint := 0;
ie_grau_parentesco_w	grau_parentesco.ie_grau_parentesco%type;

pragma autonomous_transaction;


function get_qtd_member_family(member_type_p bigint, nr_seq_member_sup_p bigint)
return bigint
as 
qtd_w smallint := 0;

BEGIN
	
if (nr_seq_member_sup_p is null) then	
	select count(*)
	into STRICT	qtd_w
	from	pf_familia f,
		grau_parentesco g 
	where	f.cd_pessoa_fisica = OLD.cd_pessoa_fisica	
	and	f.nr_seq_grau_parentesco = g.nr_sequencia
	and	f.nr_sequencia <> OLD.nr_sequencia
	and	g.ie_grau_parentesco = member_type_p;
		
else
	select count(*)
	into STRICT	qtd_w
	from	pf_familia f,
		grau_parentesco g 
	where	f.cd_pessoa_fisica = OLD.cd_pessoa_fisica	
	and	f.nr_seq_grau_parentesco = g.nr_sequencia
	and	f.nr_sequencia <> OLD.nr_sequencia
	and	g.ie_grau_parentesco = member_type_p
	and	f.nr_seq_member_sup = nr_seq_member_sup_p;

end if;

return qtd_w;

end;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then

	select	max(ie_grau_parentesco) ie_grau_parentesco
	into STRICT	ie_grau_parentesco_w
	from	grau_parentesco g
	where	nr_sequencia = OLD.nr_seq_grau_parentesco;
	
	
		
	if (ie_grau_parentesco_w = '6') then /*If delete a Father*/
		
		qtd_member_w := get_qtd_member_family('9',null); /*And exists Paternal grandfather/grandmother, show a message*/
		if (qtd_member_w > 0) then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(1159074);
		end if;
	
	elsif (ie_grau_parentesco_w = '5') then /*If delete a Mother*/
		
		qtd_member_w := get_qtd_member_family('12',null); /*And exists Maternal grandfather/grandmother, show a message*/
		
		
		if (qtd_member_w > 0) then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(1159075);
		end if;	
	
	elsif (ie_grau_parentesco_w = '13') then /*If delete a Spouse*/
		
		qtd_member_w := get_qtd_member_family('15',null); /*and exist a Father-in-law/Mother-in-low, show a message*/
		if (qtd_member_w > 0) then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(1159076);
		end if;
	
	
	elsif (ie_grau_parentesco_w = '3') then /*Id delete a Son/Daugther*/
	
		qtd_member_w := get_qtd_member_family('14',OLD.nr_sequencia); /*and exist a Grandchild, show a message*/
		if (qtd_member_w > 0) then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(1159077);
		end if;
	end if;
end if;
RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pf_familia_before_del() FROM PUBLIC;

CREATE TRIGGER pf_familia_before_del
	BEFORE DELETE ON pf_familia FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pf_familia_before_del();

