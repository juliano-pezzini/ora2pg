-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_paciente_unid_ger_update ON atend_paciente_unidade CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_paciente_unid_ger_update() RETURNS trigger AS $BODY$
BEGIN
        IF  ((coalesce(NEW.cd_setor_atendimento,0) <> coalesce(OLD.cd_setor_atendimento,0)) OR (coalesce(NEW.cd_unidade_basica,'NULL') <> coalesce(OLD.cd_unidade_basica,'NULL')) OR (coalesce(NEW.cd_unidade_compl,'NULL') <> coalesce(OLD.cd_unidade_compl,'NULL'))) and (NEW.dt_saida_unidade is null) then

            -- Reserva o novo leito

            UPDATE  unidade_atendimento unat
            SET unat.nr_atendimento         = NEW.nr_atendimento,
                unat.dt_entrada_unidade     = NEW.dt_entrada_unidade,
                unat.ie_status_unidade      = 'P',
                unat.nm_usuario         = NEW.nm_usuario,
                unat.dt_atualizacao     = LOCALTIMESTAMP
            WHERE   unat.cd_unidade_basica      = NEW.cd_unidade_basica
            AND unat.cd_unidade_compl       = NEW.cd_unidade_compl
            AND unat.cd_setor_atendimento   = NEW.cd_setor_atendimento
            and unat.ie_status_unidade      = 'L'
            and obter_se_sem_acomodacao(unat.cd_tipo_acomodacao) <> 'S';
            -- Liberar o leito antigo

            UPDATE  unidade_atendimento unat
            SET unat.nr_atendimento          = NULL,
                unat.dt_entrada_unidade      = NULL,
                unat.ie_status_unidade      = 'L',
                unat.nm_usuario         = NEW.nm_usuario,
                unat.dt_atualizacao     = LOCALTIMESTAMP
            WHERE   unat.cd_unidade_basica      = OLD.cd_unidade_basica
            AND unat.cd_unidade_compl       = OLD.cd_unidade_compl
            and unat.nr_atendimento         = OLD.nr_atendimento
            AND unat.cd_setor_atendimento   = OLD.cd_setor_atendimento;
        END IF;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_paciente_unid_ger_update() FROM PUBLIC;

CREATE TRIGGER atend_paciente_unid_ger_update
	AFTER UPDATE ON atend_paciente_unidade FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_paciente_unid_ger_update();

