-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_pagar_trib_baixa_insert ON titulo_pagar_trib_baixa CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_pagar_trib_baixa_insert() RETURNS trigger AS $BODY$
declare

cd_estabelecimento_w    titulo_pagar.cd_estabelecimento%type;
dt_baixa_w              titulo_pagar_baixa.dt_baixa%type;
nr_seq_trans_fin_w      titulo_pagar_baixa.nr_seq_trans_fin%type;
quant_w                 bigint := 0;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
    if (philips_contabil_pck.get_estabelecimento() is null) then
        select  a.cd_estabelecimento,
                b.dt_baixa,
                b.nr_seq_trans_fin
        into STRICT    cd_estabelecimento_w,
                dt_baixa_w,
                nr_seq_trans_fin_w
        from    titulo_pagar a,
                titulo_pagar_baixa b
        where   a.nr_titulo = b.nr_titulo
        and     a.nr_titulo = NEW.nr_titulo
        and     b.nr_sequencia = NEW.nr_seq_tit_baixa;
    else
        cd_estabelecimento_w    := philips_contabil_pck.get_estabelecimento();
        nr_seq_trans_fin_w      := philips_contabil_pck.get_nr_seq_trans_fin();
        dt_baixa_w              := philips_contabil_pck.get_dt_baixa();
    end if;

    if (TG_OP = 'INSERT') then
        BEGIN
        if (coalesce(NEW.vl_baixa, 0) <> 0) then
            BEGIN
            select  1
            into STRICT    quant_w

            where exists (
                SELECT  a.nr_sequencia
                from    ctb_documento a
                where   a.nr_documento = NEW.nr_titulo
                and     a.nr_seq_doc_compl = NEW.nr_seq_tit_baixa
                and     a.nr_doc_analitico = NEW.nr_sequencia
                and     a.nm_tabela = 'TITULO_PAGAR_BAIXA_CONTAB_V'
                and     a.nm_atributo = 'VL_IMPOSTO_BAIXA'
                and     a.nr_seq_trans_financ = coalesce(NEW.nr_seq_trans_financ, nr_seq_trans_fin_w)
                );
            exception
                when no_data_found then
                    quant_w := 0;
                when too_many_rows then
                    quant_w := 0;
            end;

            if (quant_w = 0) then
                CALL ctb_concil_financeira_pck.ctb_gravar_documento(cd_estabelecimento_w,
                                                                dt_baixa_w,
                                                                7,
                                                                coalesce(NEW.nr_seq_trans_financ, nr_seq_trans_fin_w),
                                                                13,
                                                                NEW.nr_titulo,
                                                                NEW.nr_seq_tit_baixa,
                                                                NEW.nr_sequencia,
                                                                NEW.vl_baixa,
                                                                'TITULO_PAGAR_BAIXA_CONTAB_V',
                                                                'VL_IMPOSTO_BAIXA',
                                                                NEW.nm_usuario,
                                                                'P');
            end if;
        end if;

        delete
        from    ctb_documento a
        where   a.cd_tipo_lote_contabil = 7
        and     a.nm_atributo = 'VL_IMPOSTO_BAIXA'
        and     a.nr_documento = NEW.nr_titulo
        and     a.nr_seq_doc_compl = NEW.nr_seq_tit_baixa
        and     a.cd_estabelecimento = cd_estabelecimento_w
        and     a.ie_situacao_ctb = 'N';

        end;
    elsif (TG_OP = 'UPDATE') then
        update  ctb_documento a
        set     a.nr_seq_trans_financ = coalesce(NEW.nr_seq_trans_financ,nr_seq_trans_fin_w),
                a.vl_movimento = NEW.vl_baixa,
                a.dt_atualizacao = LOCALTIMESTAMP,
                a.nm_usuario = NEW.nm_usuario
        where   a.cd_tipo_lote_contabil = 7
        and     a.nr_documento = NEW.nr_titulo
        and     a.nr_seq_doc_compl = NEW.nr_seq_tit_baixa
        and     a.nr_doc_analitico = NEW.nr_sequencia
        and     a.nm_atributo = 'VL_IMPOSTO_BAIXA'
        and     a.ie_situacao_ctb = 'P'
        and     coalesce(a.nr_lote_contabil,0) = 0;
    end if;

end if;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_pagar_trib_baixa_insert() FROM PUBLIC;

CREATE TRIGGER titulo_pagar_trib_baixa_insert
	AFTER INSERT OR UPDATE ON titulo_pagar_trib_baixa FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_pagar_trib_baixa_insert();

