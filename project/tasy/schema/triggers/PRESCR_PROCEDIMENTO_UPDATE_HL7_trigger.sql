-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_procedimento_update_hl7 ON prescr_procedimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_procedimento_update_hl7() RETURNS trigger AS $BODY$
declare
ds_sep_bv_w			varchar(100);
ds_param_integ_hl7_w		varchar(4000);
nr_seq_interno_w		bigint;
nr_atendimento_w		bigint;
cd_pessoa_fisica_w		varchar(60);
ie_order_control_w	  	varchar(2);
ie_order_status_w	  	varchar(2);
ie_permite_proc_interno_w 	varchar(2);
cd_estabelecimento_w		bigint;
ie_status_envio_w		integer;
ie_formato_resultado_w		varchar(10);
qt_equip_lab_w			bigint;
ie_envia_w			varchar(1);
qt_proc_laudo_w			bigint;
nr_seq_proc_status_w		bigint;
qt_prescr_proc_material_w	bigint;
qt_status_amostra_w		bigint;
nr_seq_grupo_w			bigint;
nr_seq_grupo_imp_w		bigint;
ie_grupo_imp_amostra_seq_w	varchar(1);
nr_seq_prescr_w			bigint;
nr_seq_mat_item_w		bigint;
ie_integra_tasylab_w	varchar(1);

BEGIN

if (NEW.nr_seq_exame is null) and
	(((NEW.ie_status_execucao	=  '20') and (somente_numero(OLD.ie_status_execucao) < 20) and (somente_numero(OLD.ie_status_execucao) > 0)) or
	(--(:new.ie_status_execucao	=  '10') and      -removido pois no processo de cliente que utiliza o Isite o status se mantém em 20
	(NEW.ie_suspenso		=  'S') and (OLD.ie_suspenso		=  'N'))) then

	select 	permite_proc_interno_integ(NEW.nr_seq_proc_interno,11)
	into STRICT	ie_permite_proc_interno_w
	;

	select	max(cd_estabelecimento),
			max(nr_atendimento)
	into STRICT	cd_estabelecimento_w,
			nr_atendimento_w
	from	prescr_medica
	where	nr_prescricao = NEW.nr_prescricao;

	if (ie_permite_proc_interno_w  <> 'S') then

		/* iSite */

		select	Obter_Se_Integr_Proc_Interno(NEW.nr_seq_proc_interno,2,null,NEW.ie_lado, cd_estabelecimento_w)
		into STRICT	ie_permite_proc_interno_w
		;

	end if;

	if (ie_permite_proc_interno_w = 'S') then

		select	max(nr_atendimento),
			max(cd_pessoa_fisica)
		into STRICT	nr_atendimento_w,
			cd_pessoa_fisica_w
		from	prescr_medica
		where	nr_prescricao	= NEW.nr_prescricao;

		select	max(obter_atepacu_paciente( nr_atendimento_w ,'A'))
		into STRICT	nr_seq_interno_w
		;

		ds_sep_bv_w := obter_separador_bv;

		ie_envia_w := 'S';

		if  (NEW.ie_suspenso = 'S' AND OLD.ie_suspenso <> 'S') or (NEW.ie_status_execucao = '10') then --suspenso
			ie_order_control_w := 'OC';
			ie_order_status_w  := 'CA';

			select	count(*)
			into STRICT	qt_proc_laudo_w
			from	prescr_proc_status
			where	nr_prescricao	= NEW.nr_prescricao
			and	nr_seq_prescr	= NEW.nr_sequencia
			and	ie_status_exec 	= '40';

			if (qt_proc_laudo_w > 0) then
				ie_envia_w := 'N';
			end if;

		elsif (NEW.ie_status_execucao = '20') then --Executado
			ie_order_control_w := 'SC';
			ie_order_status_w  := 'CM';

			select	max(nr_sequencia)
			into STRICT	nr_seq_proc_status_w
			from	prescr_proc_status
			where	nr_prescricao	= NEW.nr_prescricao
			and	nr_seq_prescr	= NEW.nr_sequencia
			and	ie_status_exec 	= '20';

			select	count(*)
			into STRICT	qt_proc_laudo_w
			from	prescr_proc_status
			where	nr_prescricao	=  NEW.nr_prescricao
			and	nr_seq_prescr	=  NEW.nr_sequencia
			and	nr_sequencia 	<> nr_seq_proc_status_w
			and	ie_status_exec 	=  '20';

			if (qt_proc_laudo_w > 0) then
				ie_envia_w := 'N';
			end if;

		end if;

		if (ie_envia_w = 'S') then

			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || cd_pessoa_fisica_w || ds_sep_bv_w ||
						'nr_atendimento='   || nr_atendimento_w   || ds_sep_bv_w ||
						'nr_seq_interno='   || nr_seq_interno_w   || ds_sep_bv_w ||
						'nr_prescricao='    || NEW.nr_prescricao || ds_sep_bv_w ||
						'nr_seq_presc='	    || NEW.nr_sequencia  || ds_sep_bv_w ||
						'order_control='    || ie_order_control_w || ds_sep_bv_w ||
						'order_status='     || ie_order_status_w  || ds_sep_bv_w;

			CALL gravar_agend_integracao(23, ds_param_integ_hl7_w);

		end if;

	end if;

end if;

if (NEW.nr_seq_exame is not null) then

	select	count(*)
	into STRICT	qt_equip_lab_w
	from	lab_exame_equip l,
		equipamento_lab	e
	where	l.cd_equipamento = e.cd_equipamento
	and	e.ds_sigla  	 = 'DTINNOV'
	and	l.nr_seq_exame 	 = NEW.nr_seq_exame;

	if (qt_equip_lab_w > 0) then


		select	max(cd_estabelecimento),
			max(nr_atendimento)
		into STRICT	cd_estabelecimento_w,
			nr_atendimento_w
		from	prescr_medica
		where	nr_prescricao = NEW.nr_prescricao;


		select	max(ie_status_envio),
				max(ie_gerar_padrao_grupo_imp)
		into STRICT	ie_status_envio_w,
				ie_grupo_imp_amostra_seq_w
		from	lab_parametro
		where	cd_estabelecimento = cd_estabelecimento_w;

		if	(NEW.ie_status_atend	=  ie_status_envio_w AND OLD.ie_status_atend <> ie_status_envio_w) then

			select	max(ie_formato_resultado)
			into STRICT	ie_formato_resultado_w
			from	exame_laboratorio
			where	nr_seq_exame = NEW.nr_seq_exame;

			ds_sep_bv_w := obter_separador_bv;


			if (ie_formato_resultado_w in ('SM','SDM')) then    -- (SM)Seleção Microbiologia  /  (SDM) Seleção de microorganismo
				--gerar agendamento HL7 microbiology
				ds_param_integ_hl7_w :=	'nr_atendimento='   || nr_atendimento_w   || ds_sep_bv_w ||
							'nr_prescricao='    || NEW.nr_prescricao || ds_sep_bv_w ||
							'nr_seq_presc='	    || NEW.nr_sequencia  || ds_sep_bv_w;


				CALL gravar_agend_integracao(74, ds_param_integ_hl7_w);

			else

				/*select	max(nr_sequencia)
				into	nr_seq_mat_item_w
				from	prescr_proc_mat_item
				where	nr_prescricao = :new.nr_prescricao
				and	nr_seq_prescr = :new.nr_sequencia;*/
				select	max(a.nr_sequencia)
				into STRICT	nr_seq_mat_item_w
				from 	prescr_proc_material a,
					prescr_proc_mat_item b
				where 	b.nr_seq_prescr_proc_mat = a.nr_sequencia
				and	a.nr_prescricao = NEW.nr_prescricao
				and 	b.nr_seq_prescr = NEW.nr_sequencia;

				select 	count(*)
				into STRICT 	qt_prescr_proc_material_w
				from 	prescr_proc_material a,
					prescr_proc_mat_item b
				where 	b.nr_seq_prescr_proc_mat = a.nr_sequencia
				and	a.nr_prescricao = NEW.nr_prescricao
				and 	b.nr_seq_prescr = NEW.nr_sequencia;



				/*if	(qt_prescr_proc_material_w > 1) then

					--gerar agendamento HL7 Lab - curva
					ds_param_integ_hl7_w :=	'nr_atendimento='   || nr_atendimento_w   || ds_sep_bv_w ||
								'nr_prescricao='    || :new.nr_prescricao || ds_sep_bv_w ||
								'nr_seq_presc='	    || :new.nr_sequencia  || ds_sep_bv_w ;


					gravar_agend_integracao(84, ds_param_integ_hl7_w);


				else*/
				if (qt_prescr_proc_material_w <= 1) then

					select 	max(nr_seq_grupo),
						max(nr_seq_grupo_imp)
					into STRICT	nr_seq_grupo_w,
						nr_seq_grupo_imp_w
					from	exame_laboratorio
					where	nr_seq_exame = NEW.nr_seq_exame;

					select	count(*)
					into STRICT	qt_status_amostra_w
					from	prescr_proc_mat_item a, prescr_proc_material b, material_exame_lab c
					where	a.nr_seq_prescr_proc_mat = b.nr_sequencia
					and	c.nr_sequencia = b.nr_seq_material
					and	b.nr_sequencia = nr_seq_mat_item_w
					and	a.nr_prescricao = NEW.nr_prescricao
					and	a.nr_seq_prescr <> NEW.nr_sequencia
					and	c.cd_material_exame = NEW.cd_material_exame
					and	coalesce(a.ie_suspenso,'N') = 'N'
					and	(((b.nr_seq_grupo = nr_seq_grupo_w) and (coalesce(ie_grupo_imp_amostra_seq_w,'N') = 'N')) or
					((b.nr_seq_grupo_imp = nr_seq_grupo_imp_w) and (coalesce(ie_grupo_imp_amostra_seq_w,'N') = 'S')))
					and exists (	SELECT	1
									from	lab_exame_equip l,
											equipamento_lab	e
									where	l.cd_equipamento = e.cd_equipamento
									and		e.ds_sigla  	 = 'DTINNOV'
									and		l.nr_seq_exame 	 = obter_dados_prescr_proc_hl7(NEW.nr_prescricao,a.nr_seq_prescr,'E'))
					and	ie_status_envio_w > (select ie_etapa
								     from prescr_proc_etapa
								     where nr_prescricao = NEW.nr_prescricao
								     and nr_sequencia = (select max(nr_sequencia)
											 from prescr_proc_etapa
											 where nr_prescricao = NEW.nr_prescricao
											 and nr_seq_prescricao = a.nr_seq_prescr));


					if (qt_status_amostra_w = 0) then
					--gerar agendamento HL7 Lab
						ds_param_integ_hl7_w :=	'nr_atendimento='   || nr_atendimento_w   || ds_sep_bv_w ||
									'nr_prescricao='    || NEW.nr_prescricao || ds_sep_bv_w ||
									'nr_seq_presc='	    || NEW.nr_sequencia  || ds_sep_bv_w ||
									'nr_seq_prescr_proc_mat=' || nr_seq_mat_item_w || ds_sep_bv_w;

						CALL gravar_agend_integracao(73, ds_param_integ_hl7_w);
					end if;

				end if;
			end if;

		end if;
	end if;

	if (wheb_usuario_pck.is_evento_ativo(221) = 'S') and (coalesce(NEW.ie_status_atend, 0) <> coalesce(OLD.ie_status_atend, 0)) then

		select 	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_integra_tasylab_w
		from	LAB_TASYLAB_CLIENTE a,
				LAB_TASYLAB_CLI_PRESCR b
		where	a.nr_sequencia = b.NR_SEQ_TASYLAB_CLI
		and		b.nr_prescricao = NEW.nr_prescricao
		and		coalesce(a.IE_STATUS_ATEND,35) = NEW.ie_status_atend;

		if (ie_integra_tasylab_w = 'S') then


			CALL integrar_tasylab(	NEW.nr_prescricao,
								NEW.nr_sequencia,
								221,
								null,
								null,
								obter_funcao_ativa,
								obter_perfil_ativo,
								'TASYLAB',
								obter_estabelecimento_ativo,
								null,
								null,
								null,
								'N');

		end if;

	end if;

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_procedimento_update_hl7() FROM PUBLIC;

CREATE TRIGGER prescr_procedimento_update_hl7
	AFTER UPDATE ON prescr_procedimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_procedimento_update_hl7();

