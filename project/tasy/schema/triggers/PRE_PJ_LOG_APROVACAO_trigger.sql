-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pre_pj_log_aprovacao ON pre_pessoa_juridica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pre_pj_log_aprovacao() RETURNS trigger AS $BODY$
BEGIN

  if wheb_usuario_pck.get_ie_executar_trigger = 'S' then
    if TG_OP = 'INSERT' then
    -- Criando novo registro

      insert into pre_pessoa_juridica_log(
                  nr_sequencia
                , nr_seq_pre_pj
                , dt_atualizacao
                , nm_usuario
                , dt_atualizacao_nrec
                , nm_usuario_nrec
                , cd_cgc
                , ds_atributo
                , ds_valor_old
                , ds_valor_new
                )
           values (
                  nextval('pre_pessoa_juridica_log_seq')
                , NEW.nr_sequencia
                , LOCALTIMESTAMP
                , obter_usuario_ativo
                , LOCALTIMESTAMP
                , obter_usuario_ativo
                , NEW.cd_cgc
                , 'IE_APROVACAO'
                , NULL
                , NEW.ie_aprovacao );

    end if;

    if TG_OP = 'UPDATE' AND NEW.IE_APROVACAO IS DISTINCT FROM OLD.IE_APROVACAO then
    -- Alteração do IE_APROVACAO

      insert into pre_pessoa_juridica_log(
                  nr_sequencia
                , nr_seq_pre_pj
                , dt_atualizacao
                , nm_usuario
                , dt_atualizacao_nrec
                , nm_usuario_nrec
                , cd_cgc
                , ds_atributo
                , ds_valor_old
                , ds_valor_new
                )
           values(
                  nextval('pre_pessoa_juridica_log_seq')
                , NEW.nr_sequencia
                , LOCALTIMESTAMP
                , obter_usuario_ativo
                , LOCALTIMESTAMP
                , obter_usuario_ativo
                , NEW.cd_cgc
                , 'IE_APROVACAO'
                , OLD.ie_aprovacao
                , NEW.ie_aprovacao );

    end if;
  end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pre_pj_log_aprovacao() FROM PUBLIC;

CREATE TRIGGER pre_pj_log_aprovacao
	AFTER INSERT OR UPDATE ON pre_pessoa_juridica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pre_pj_log_aprovacao();

