-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_padua_atual ON escala_padua CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_padua_atual() RETURNS trigger AS $BODY$
declare
  qt_score_w smallint;
  sql_w      varchar(300);
  ds_erro_w      varchar(4000);
  ds_parametro_w varchar(4000);
BEGIN
  BEGIN

  if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then
  
  BEGIN
    
      sql_w := 'CALL OBTER_SCORE_PADUA_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11) INTO :qt_score_w';
      EXECUTE sql_w USING IN NEW.ie_cancer_ativo,
                                    IN NEW.ie_tev_previo,
                                    IN NEW.ie_mobilidade_reduzida,
                                    IN NEW.ie_condicao_trombofilia,
                                    IN NEW.ie_trauma_cirurgia_recente,
                                    IN NEW.ie_idade_avancada,
                                    IN NEW.ie_parada_card_resp,
                                    IN NEW.ie_infarto_avc,
                                    IN NEW.ie_infeccao_reumato,
                                    IN NEW.ie_obesidade,
                                    IN NEW.ie_tratamento_hormonal,
                                    OUT qt_score_w;

  exception
    when others then
      qt_score_w := null;
      ds_erro_w := sqlerrm;
      ds_parametro_w := ':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
      ds_parametro_w := ds_parametro_w || ' - :new.ie_cancer_ativo: ' || NEW.ie_cancer_ativo || ' - :new.ie_tev_previo: ' || NEW.ie_tev_previo || ' - :new.ie_mobilidade_reduzida: ' || NEW.ie_mobilidade_reduzida;
      ds_parametro_w := ds_parametro_w || ' - :new.ie_condicao_trombofilia: ' || NEW.ie_condicao_trombofilia || ' - :new.ie_trauma_cirurgia_recente: ' || NEW.ie_trauma_cirurgia_recente || ' - :new.ie_idade_avancada: ' || NEW.ie_idade_avancada;
      ds_parametro_w := ds_parametro_w || ' - :new.ie_parada_card_resp: ' || NEW.ie_parada_card_resp || ' - :new.ie_infarto_avc: ' || NEW.ie_infarto_avc || ' - :new.ie_infeccao_reumato: ' || NEW.ie_infeccao_reumato || ' - :new.ie_obesidade: ' || NEW.ie_obesidade || ' - :new.ie_tratamento_hormonal: ' || NEW.ie_tratamento_hormonal;
      ds_parametro_w := ds_parametro_w || ' - qt_score_w: ' || qt_score_w;
      CALL gravar_log_medical_device('ESCALA_PADUA_ATUAL', 'OBTER_SCORE_PADUA_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
  end;
  NEW.qt_score := qt_score_w;

  end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_padua_atual() FROM PUBLIC;

CREATE TRIGGER escala_padua_atual
	BEFORE INSERT OR UPDATE ON escala_padua FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_padua_atual();

