-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_escala_braden_atual ON atend_escala_braden CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_escala_braden_atual() RETURNS trigger AS $BODY$
declare
qt_reg_w                smallint;
cd_setor_atendimento_w  bigint;
qt_ponto_w              smallint;
sql_w                   varchar(4000);
ds_erro_w               varchar(4000);
ds_parametros_w         varchar(4000);
BEGIN
  BEGIN
    if (NEW.nr_hora is null) or (NEW.dt_avaliacao <> OLD.dt_avaliacao) then
        BEGIN
            NEW.nr_hora := (to_char(round(NEW.dt_avaliacao, 'hh24'), 'hh24'))::numeric;
        end;
    end if;

    if (coalesce(OLD.dt_avaliacao, LOCALTIMESTAMP + interval '10 days') <> NEW.dt_avaliacao)
	and (NEW.dt_avaliacao is not null)
	then NEW.ds_utc := obter_data_utc(NEW.dt_avaliacao, 'HV');
    end if;
		
    if (coalesce(OLD.dt_liberacao,LOCALTIMESTAMP + interval '10 days') <> NEW.dt_liberacao)
	and (NEW.dt_liberacao is not null)
	then NEW.ds_utc_atualizacao := obter_data_utc(NEW.dt_liberacao, 'HV');
    end if;

    if ( wheb_usuario_pck.get_ie_executar_trigger = 'N' ) then
        goto final;
    end if;
    if (NEW.nr_atendimento is not null) and (NEW.dt_liberacao is null) then
        BEGIN
            cd_setor_atendimento_w := obter_setor_atendimento(NEW.nr_atendimento);
        exception
            when others then
                cd_setor_atendimento_w := 0;
        end;

        if ( cd_setor_atendimento_w > 0 ) then
            NEW.cd_setor_atendimento := cd_setor_atendimento_w;
        end if;
    end if;

    BEGIN
        sql_w := 'call obter_score_escala_braden_md(:1, :2, :3, :4, :5, :6) into :qt_ponto_w';
        EXECUTE sql_w using in NEW.ie_percepcao_sensorial,
									  in NEW.ie_umidade, 
									  in NEW.ie_atividade_fisica, 
									  in NEW.ie_mobilidade, 
									  in NEW.ie_nutricao, 
									  in NEW.ie_friccao_cisalhamento, 
									  out qt_ponto_w;
    exception
        when others then
            ds_erro_w := substr(sqlerrm,1,4000);
            ds_parametros_w := substr(':new.dt_atualizacao: '||NEW.dt_atualizacao||'-'||'new.nm_usuario: '||NEW.nm_usuario||'-'||'new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_pessoa_fisica: '||NEW.cd_pessoa_fisica||'-'||
									  ':new.cd_setor_atendimento: '||NEW.cd_setor_atendimento||'-'||':new.ie_percepcao_sensorial: '||NEW.ie_percepcao_sensorial||'-'||':new.ie_umidade: '||NEW.ie_umidade||'-'||':new.ie_atividade_fisica: '||NEW.ie_atividade_fisica||'-'||
									  ':new.ie_mobilidade: '||NEW.ie_mobilidade||'-'||':new.ie_nutricao: '||NEW.ie_nutricao||'-'||':new.ie_friccao_cisalhamento: '||NEW.ie_friccao_cisalhamento||'-'||'qt_ponto_w: '||qt_ponto_w ,1,4000);
            CALL gravar_log_medical_device('ATEND_ESCALA_BRADEN_ATUAL', 'OBTER_SCORE_ESCALA_BRADEN_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
            qt_ponto_w := null;
    end;

    NEW.qt_ponto := qt_ponto_w;

    if ( NEW.dt_liberacao is not null ) and ( OLD.dt_liberacao is null ) and ( NEW.nr_atendimento is not null ) then
        BEGIN
            CALL gravar_agend_rothman(NEW.nr_atendimento, NEW.nr_sequencia, 'BRA', NEW.nm_usuario);
        exception
            when others then
                null;
        end;
    end if;

    << final >> qt_reg_w := 0;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_escala_braden_atual() FROM PUBLIC;

CREATE TRIGGER atend_escala_braden_atual
	BEFORE INSERT OR UPDATE ON atend_escala_braden FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_escala_braden_atual();

