-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pessoa_titular_convenio_update ON pessoa_titular_convenio CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pessoa_titular_convenio_update() RETURNS trigger AS $BODY$
declare

	
BEGIN
		
	if ((coalesce(OLD.cd_convenio,0) <> coalesce(NEW.cd_convenio,0)) or (coalesce(OLD.cd_categoria,'X') <> coalesce(NEW.cd_categoria,'X')) or (coalesce(OLD.cd_plano_convenio,'X') <> coalesce(NEW.cd_plano_convenio,'X')) or (coalesce(OLD.ie_tipo_conveniado,0) <> coalesce(NEW.ie_tipo_conveniado,0)) or (coalesce(OLD.cd_pessoa_titular,0) <> coalesce(NEW.cd_pessoa_titular,0)) or (coalesce(OLD.ie_grau_dependencia,'X') <> coalesce(NEW.ie_grau_dependencia,'X')) or (coalesce(OLD.cd_usuario_convenio,'X') <> coalesce(NEW.cd_usuario_convenio,'X')) or (coalesce(OLD.dt_inicio_vigencia,LOCALTIMESTAMP) <> coalesce(NEW.dt_inicio_vigencia,LOCALTIMESTAMP)) or (coalesce(OLD.dt_fim_vigencia,LOCALTIMESTAMP) <> coalesce(NEW.dt_fim_vigencia,LOCALTIMESTAMP)) or (coalesce(OLD.dt_validade_carteira,LOCALTIMESTAMP) <> coalesce(NEW.dt_validade_carteira,LOCALTIMESTAMP)) or (coalesce(OLD.cd_usuario_convenio_tit,'X') <> coalesce(NEW.cd_usuario_convenio_tit,'X')) or (coalesce(OLD.cd_empresa_refer,0) <> coalesce(NEW.cd_empresa_refer,0))) then
		
		CALL call_bifrost_content('patient.insurance.update','person_json_pck.get_patient_message_clob('||NEW.cd_pessoa_fisica||')', NEW.nm_usuario);
		
	end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pessoa_titular_convenio_update() FROM PUBLIC;

CREATE TRIGGER pessoa_titular_convenio_update
	AFTER UPDATE ON pessoa_titular_convenio FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pessoa_titular_convenio_update();

