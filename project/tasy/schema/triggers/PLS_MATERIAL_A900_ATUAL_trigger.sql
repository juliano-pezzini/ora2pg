-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_material_a900_atual ON pls_material_a900 CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_material_a900_atual() RETURNS trigger AS $BODY$
declare
qt_registro_w		integer := 0;
 
pragma autonomous_transaction;
 
BEGIN 
select	count(1) 
into STRICT	qt_registro_w 
 
where	exists (SELECT	1 
		from	pls_material_a900 x 
		where	coalesce(x.dt_inicio_vigencia, NEW.dt_inicio_vigencia) <= NEW.dt_inicio_vigencia 
		and	coalesce(x.dt_fim_vigencia, NEW.dt_inicio_vigencia) >= NEW.dt_inicio_vigencia 
		and	x.nr_seq_material = NEW.nr_seq_material 
		and	x.nr_sequencia	 <> NEW.nr_sequencia);
 
if (coalesce(qt_registro_w,0) > 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(285105);
end if;
 
if (NEW.nr_seq_material_unimed is null) or (OLD.cd_material_a900 <> NEW.cd_material_a900) then 
	NEW.nr_seq_material_unimed := pls_obter_dados_material_a900(NEW.cd_material_a900,null,'NR');
end if;
 
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_material_a900_atual() FROM PUBLIC;

CREATE TRIGGER pls_material_a900_atual
	BEFORE INSERT OR UPDATE ON pls_material_a900 FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_material_a900_atual();

