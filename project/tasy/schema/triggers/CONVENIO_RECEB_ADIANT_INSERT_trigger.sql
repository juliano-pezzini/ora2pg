-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS convenio_receb_adiant_insert ON convenio_receb_adiant CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_convenio_receb_adiant_insert() RETURNS trigger AS $BODY$
declare

dt_documento_w		convenio_receb.dt_recebimento%type;
vl_adiantamento_w	adiantamento.vl_adiantamento%type;
nr_seq_trans_fin_w	adiantamento.nr_seq_trans_fin%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;

c01 CURSOR FOR
	SELECT		a.nm_atributo,
			a.cd_tipo_lote_contab
	from		atributo_contab a
	where 		a.cd_tipo_lote_contab = 11
	and 		a.nm_atributo in ('VL_ADIANTAMENTO');

c01_w		c01%rowtype;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
if (TG_OP = 'INSERT') then

	select  a.vl_adiantamento,
		coalesce(a.nr_seq_trans_fin, b.nr_seq_trans_fin),
		b.dt_recebimento,
		b.cd_estabelecimento
	into STRICT    vl_adiantamento_w,
		nr_seq_trans_fin_w,
		dt_documento_w,
		cd_estabelecimento_w
	from    adiantamento a,
		Convenio_Receb b
	where   b.nr_sequencia		= NEW.nr_seq_receb
	and 	a.nr_adiantamento	= NEW.nr_adiantamento;
	
	open c01;
	loop
	fetch c01 into	
	c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		BEGIN
		
		if (coalesce(vl_adiantamento_w, 0) <> 0) and (coalesce(nr_seq_trans_fin_w, 0) <> 0) then
			BEGIN
			CALL ctb_concil_financeira_pck.ctb_gravar_documento(	
										cd_estabelecimento_w,
										trunc(dt_documento_w),
										c01_w.cd_tipo_lote_contab,
										nr_seq_trans_fin_w,
										8,
										NEW.nr_seq_receb,
										NEW.nr_sequencia,
										null,
										vl_adiantamento_w,
										'CONVENIO_RECEB_ADIANT',
										c01_w.nm_atributo,
										NEW.nm_usuario);

			end;
		end if;
		end;
	end loop;
	close c01;

elsif (TG_OP = 'UPDATE') then

	select  a.vl_adiantamento,
		coalesce(a.nr_seq_trans_fin, b.nr_seq_trans_fin)
	into STRICT    vl_adiantamento_w,
		nr_seq_trans_fin_w
	from    adiantamento a,
		Convenio_Receb b
	where   b.nr_sequencia		= NEW.nr_seq_receb
	and 	a.nr_adiantamento	= NEW.nr_adiantamento;

	BEGIN
	update  ctb_documento
	set     vl_movimento 		= coalesce(vl_adiantamento_w,0),
		nr_seq_trans_financ	= nr_seq_trans_fin_w
	where     nm_tabela   		= 'CONVENIO_RECEB_ADIANT'
	and     nr_documento		= NEW.nr_seq_receb
	and	nr_seq_doc_compl 	= NEW.nr_sequencia
	and	nm_atributo		= 'VL_ADIANTAMENTO'
	and	coalesce(nr_lote_contabil,0)	= 0;
	end;

end if;

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_convenio_receb_adiant_insert() FROM PUBLIC;

CREATE TRIGGER convenio_receb_adiant_insert
	AFTER INSERT OR UPDATE ON convenio_receb_adiant FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_convenio_receb_adiant_insert();

