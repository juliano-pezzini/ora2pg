-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS item_req_material_beforeinsert ON item_requisicao_material CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_item_req_material_beforeinsert() RETURNS trigger AS $BODY$
declare
dt_liberacao_w			timestamp;
ie_consignado_w			varchar(1);
cd_local_estoque_w		integer;
cd_local_estoque_destino_w		integer;

BEGIN

select	max(dt_liberacao),
	max(cd_local_estoque),
	coalesce(max(cd_local_estoque_destino),0)
into STRICT	dt_liberacao_w,
	cd_local_estoque_w,
	cd_local_estoque_destino_w
from	requisicao_material
where	nr_requisicao = NEW.nr_requisicao;

select 	coalesce(max(a.ie_consignado),'0')
into STRICT	ie_consignado_w
from 	operacao_estoque a,
	requisicao_material b
where 	b.nr_requisicao = NEW.nr_requisicao
and	a.cd_operacao_estoque = b.cd_operacao_estoque;


/* Retirado por Fabio - OS 386419 - Foi colocado na procedure CONSISTIR_REQUISICAO
if	(:new.qt_saldo_estoque is null) then
	begin

	if	(ie_consignado_w <> '0') then
		:new.qt_saldo_estoque	:= obter_saldo_estoque_consig(:new.cd_estabelecimento, :new.cd_cgc_fornecedor, :new.cd_material, cd_local_estoque_w);
	else
		:new.qt_saldo_estoque	:= obter_saldo_disp_estoque(:new.cd_estabelecimento, :new.cd_material, cd_local_estoque_w, trunc(sysdate,'mm'));
	end if;

	end;
end if;

if	(:new.qt_saldo_estoque_dest is null) and
	(cd_local_estoque_destino_w > 0) then
	begin

	if	(ie_consignado_w <> '0') then
		:new.qt_saldo_estoque_dest	:= obter_saldo_estoque_consig(:new.cd_estabelecimento, :new.cd_cgc_fornecedor, :new.cd_material, cd_local_estoque_destino_w);
	else
		:new.qt_saldo_estoque_dest	:= obter_saldo_disp_estoque(:new.cd_estabelecimento, :new.cd_material, cd_local_estoque_destino_w, trunc(sysdate,'mm'));
	end if;

	end;
end if;*/
NEW.QT_MATERIAL_ATENDIDA := coalesce(NEW.QT_MATERIAL_ATENDIDA, 0);
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_item_req_material_beforeinsert() FROM PUBLIC;

CREATE TRIGGER item_req_material_beforeinsert
	BEFORE INSERT ON item_requisicao_material FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_item_req_material_beforeinsert();

