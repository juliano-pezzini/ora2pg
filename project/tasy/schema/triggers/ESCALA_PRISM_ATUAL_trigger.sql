-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_prism_atual ON escala_prism CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_prism_atual() RETURNS trigger AS $BODY$
DECLARE
    logit_w             double precision;
    logit_po_w          double precision;
    cd_pessoa_fisica_w  varchar(10);
    qt_reg_w            smallint;
    sql_w               varchar(600);
    qt_pontuacao_w      smallint;
    pr_mortalidade_w    double precision;
    ds_erro_w           varchar(4000);
    ds_parametros_w     varchar(4000);
BEGIN
  BEGIN
    IF ( NEW.nr_hora IS NULL ) OR ( NEW.dt_avaliacao <> OLD.dt_avaliacao ) THEN
        BEGIN
            NEW.nr_hora := (to_char(round(NEW.dt_avaliacao, 'hh24'), 'hh24'))::numeric;

        END;
    END IF;

    IF ( wheb_usuario_pck.get_ie_executar_trigger = 'N' ) THEN
        GOTO final;
    END IF;
--- Inicio MD1 e MD2
/* Pontuacao PA Sistolica */
 /* Pontuacao PA Diastolica */

    sql_w := 'begin OBTER_PONTUACAO_PA_PRISM_MD  (:1, :2, :3, :4, :5); end;';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_pa_sistolica, IN NEW.ie_lactante, IN NEW.qt_pa_diastolica, OUT NEW.qt_pto_pas, OUT NEW.qt_pto_pad;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_pa_sistolica: '||NEW.qt_pa_sistolica||'-'||':new.ie_lactante: '||NEW.ie_lactante||'-'||':new.qt_pa_diastolica: '||NEW.qt_pa_diastolica||'-'||
                          ':new.qt_pto_pas: '||NEW.qt_pto_pas||'-'||':new.qt_pto_pad: '||NEW.qt_pto_pad);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONTUACAO_PA_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            NEW.qt_pto_pas := NULL;
            NEW.qt_pto_pad := NULL;
    END;

--- Fim MD1 E  MD2
--- Inicio MD3
/* Pontuacao Freq Cardiaca */

    sql_w := 'CALL OBTER_PONT_FEQ_CARD_PRISM_MD (:1, :2) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_freq_cardiaca, IN NEW.ie_lactante, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_freq_cardiaca: '||NEW.qt_freq_cardiaca||'-'||':new.ie_lactante: '||NEW.ie_lactante||'-'||
                          'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONT_FEQ_CARD_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_fc := qt_pontuacao_w;

--- Fim MD3
--- Inicio MD4
/* Pontuacao Freq Respiratoria */

    sql_w := 'CALL OBTER_PONT_FEQ_RESP_PRISM_MD(:1, :2, :3) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_freq_resp, IN NEW.ie_apneia, IN NEW.ie_lactante, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_freq_resp: '||NEW.qt_freq_resp||'-'||':new.ie_apneia: '||NEW.ie_apneia||'-'||':new.ie_lactante: '||NEW.ie_lactante||'-'||
                          'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONT_FEQ_RESP_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_fr := qt_pontuacao_w;
--- Fim MD4
--- Inicio MD5
/* Pontuacao PaO FiO */

    sql_w := 'CALL OBTER_PONT_PAO_FIO_PRISM_MD (:1) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_rel_pao2_fio2, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_rel_pao2_fio2: '||NEW.qt_rel_pao2_fio2||'-'||'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONT_PAO_FIO_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_rel_pao2_fio2 := qt_pontuacao_w;

--- Fim MD5
--- Inicio MD6
/* Pontuacao PaC0 */

    sql_w := 'CALL OBTER_PONTUACAO_PACO_PRISM_MD(:1) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_paco2, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_paco2: '||NEW.qt_paco2||'-'||'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONTUACAO_PACO_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_paco2 := qt_pontuacao_w;
--- Fim MD6
--- Inicio MD7
/* Pontuacao Tempo de Protrombina */

    sql_w := 'CALL OBTER_PONT_PROT_PRISM_MD(:1) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.ie_tempo_tp_ttp, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_tempo_tp_ttp: '||NEW.ie_tempo_tp_ttp||'-'||'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONT_PROT_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_tp_ttp := qt_pontuacao_w;
--- Fim MD7
--- Inicio MD8
/* Pontuacao Bilirrubina */

    sql_w := 'CALL OBTER_PONT_BILI_PRISM_MD(:1) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_bilirrubina_total, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_bilirrubina_total: '||NEW.qt_bilirrubina_total||'-'||'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONT_BILI_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_bilirrubina := qt_pontuacao_w;

--- Fim MD8
--- Inicio MD9
/* Pontuacao Calcio */

    sql_w := 'CALL OBTER_PONT_CALCIO_PRISM_MD(:1) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_calcio, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_calcio: '||NEW.qt_calcio||'-'||'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONT_CALCIO_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_calcio := qt_pontuacao_w;
--- Fim MD9
--- Inicio MD10
/* Pontuacao Potassio */

    sql_w := 'CALL OBTER_PONT_POTACIO_PRISM_MD (:1) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_potassio, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_potassio: '||NEW.qt_potassio||'-'||'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONT_POTACIO_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_potassio := qt_pontuacao_w;

--- Fim MD10
--- Incio MD11
/* Pontuacao Glicemia */

    sql_w := 'CALL OBTER_PONT_GLICEMIA_PRISM_MD(:1) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
/* Pontuacao Bicarbonato */

            USING IN NEW.qt_glicemia, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_glicemia: '||NEW.qt_glicemia||'-'||'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONT_GLICEMIA_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_glicemia := qt_pontuacao_w;
--- Fim MD11
--- Inicio MD12
    sql_w := 'CALL OBTER_PONT_BICABOR_PRISM_MD(:1) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_bicarbonato, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_bicarbonato: '||NEW.qt_bicarbonato||'-'||'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONT_BICABOR_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_bicarbonato := qt_pontuacao_w;

--- Fim MD12
--- Inicio MD13
/* Pontuacao reacoes pupilares */

    sql_w := 'CALL OBTER_PONT_REAC_PUPI_PRISM_MD(:1) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.ie_reacoes_pupilares, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_reacoes_pupilares: '||NEW.ie_reacoes_pupilares||'-'||'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONT_REAC_PUPI_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_reac_pup := qt_pontuacao_w;
--- Fim MD13
--- Inicio MD14
/* Pontuacao glasgow */

    sql_w := 'CALL OBTER_PONTU_GLASGOW_PRISM_MD(:1) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_escala_glasgow, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_escala_glasgow: '||NEW.qt_escala_glasgow||'-'||'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONTU_GLASGOW_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_glasgow := qt_pontuacao_w;
--- Fim MD14
--- Inicio MD15
/* Pontuacao Total */

    sql_w := 'CALL OBTER_PONT_TOTAL_PRISM_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14) INTO :qt_pontuacao_W';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_pto_pas, IN NEW.qt_pto_pad, IN NEW.qt_pto_fc, NEW.qt_pto_fr, IN NEW.qt_pto_rel_pao2_fio2, IN NEW.qt_pto_paco2,
            IN NEW.qt_pto_tp_ttp, NEW.qt_pto_bilirrubina, IN NEW.qt_pto_calcio, IN NEW.qt_pto_potassio, IN NEW.qt_pto_glicemia, 
            NEW.qt_pto_bicarbonato, IN NEW.qt_pto_reac_pup, IN NEW.qt_pto_glasgow, OUT qt_pontuacao_w;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_pto_pas: '||NEW.qt_pto_pas||'-'||':new.qt_pto_pad: '||NEW.qt_pto_pad||'-'||':new.qt_pto_fc: '||NEW.qt_pto_fc||'-'||
                          ':new.qt_pto_fr: '||NEW.qt_pto_fr||'-'||':new.qt_pto_rel_pao2_fio2: '||NEW.qt_pto_rel_pao2_fio2||'-'||':new.qt_pto_paco2: '||NEW.qt_pto_paco2||'-'||
                          ':new.qt_pto_tp_ttp: '||NEW.qt_pto_tp_ttp||'-'||':new.qt_pto_bilirrubina: '||NEW.qt_pto_bilirrubina||'-'||':new.qt_pto_calcio: '||NEW.qt_pto_calcio||'-'||
                          ':new.qt_pto_potassio: '||NEW.qt_pto_potassio||'-'||':new.qt_pto_glicemia: '||NEW.qt_pto_glicemia||'-'||':new.qt_pto_bicarbonato: '||NEW.qt_pto_bicarbonato||'-'||
                          ':new.qt_pto_reac_pup: '||NEW.qt_pto_reac_pup||'-'||':new.qt_pto_glasgow: '||NEW.qt_pto_glasgow||'-'||
                          'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PONT_TOTAL_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pto_total := qt_pontuacao_w;

    
--- Fim MD15
/* Obter pessoa fisica */

    SELECT
        cd_pessoa_fisica
    INTO STRICT cd_pessoa_fisica_w
    FROM
        atendimento_paciente
    WHERE
        nr_atendimento = NEW.nr_atendimento;

/* Idade em meses */

    IF ( OLD.qt_idade IS NULL ) THEN
        SELECT
            coalesce(obter_idade_pf(cd_pessoa_fisica_w, LOCALTIMESTAMP, 'M'), 0)        INTO STRICT NEW.qt_idade
;

    END IF;
--- Inciio MD16 e 17
/* Predicado de mortalidade */

    sql_w := 'begin OBTER_PRED_MORT_PRISM_MD (:1, :2, :3, :4); end;';
    BEGIN
        EXECUTE sql_w
            USING IN NEW.qt_pto_total, IN NEW.qt_idade, OUT NEW.pr_mortalidade, OUT NEW.pr_mortalidade_pos_op;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_pto_total: '||NEW.qt_pto_total||'-'||':new.qt_idade: '||NEW.qt_idade||'-'||':new.pr_mortalidade: '||NEW.pr_mortalidade||'-'||
                          ':new.pr_mortalidade_pos_op: '||NEW.pr_mortalidade_pos_op);

      CALL gravar_log_medical_device('escala_prism_atual','OBTER_PRED_MORT_PRISM_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            NEW.pr_mortalidade := NULL;
            NEW.pr_mortalidade_pos_op := NULL;
    END;

--- Fim MD 16 e 17
    << final >> qt_reg_w := 0;
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_prism_atual() FROM PUBLIC;

CREATE TRIGGER escala_prism_atual
	BEFORE INSERT OR UPDATE ON escala_prism FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_prism_atual();

