-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS ctb_regra_metrica_insert ON ctb_regra_metrica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_ctb_regra_metrica_insert() RETURNS trigger AS $BODY$
declare

ds_centro_custo_w		varchar(255);
ds_metrica_w		varchar(255);
qt_limite_w		double precision;

BEGIN

if (NEW.ie_regra = 'QF') then
	NEW.pr_aplicar	:= null;
	NEW.nr_seq_mes_ref	:= null;
elsif (NEW.ie_regra = 'PO') then
	NEW.qt_fixa		:= null;
elsif (NEW.ie_regra = 'PQ') then
	NEW.qt_fixa		:= null;
	NEW.nr_seq_mes_ref	:= null;
end if;

if (NEW.cd_centro_custo is not null) and (NEW.nr_seq_metrica is not null) and (coalesce(NEW.qt_fixa,0) <> 0) then
	BEGIN
	select	coalesce(max(qt_limite),0)
	into STRICT	qt_limite_w
	from	ctb_orc_metrica
	where	nr_seq_metrica	= NEW.nr_seq_metrica
	and	cd_centro_custo	= NEW.cd_centro_custo;

	if (qt_limite_w <> 0) and (NEW.qt_fixa > qt_limite_w) then

		ds_centro_custo_w	:= substr(obter_desc_centro_custo(NEW.cd_centro_custo),1,255);
		ds_metrica_w		:= substr(ctb_obter_desc_metrica(NEW.nr_seq_metrica),1,255);
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266590,'QT_FIXA=' || NEW.qt_fixa 	|| ';' ||
							'DS_METRICA='	  || ds_metrica_w 	|| ';' ||
							'DS_CENTRO='	  || ds_centro_custo_w  || ';' ||
							'QT_LIMITE='	  || qt_limite_w);
	end if;
	end;
end if;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_ctb_regra_metrica_insert() FROM PUBLIC;

CREATE TRIGGER ctb_regra_metrica_insert
	BEFORE INSERT OR UPDATE ON ctb_regra_metrica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_ctb_regra_metrica_insert();

