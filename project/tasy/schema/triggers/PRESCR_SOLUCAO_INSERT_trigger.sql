-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_solucao_insert ON prescr_solucao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_solucao_insert() RETURNS trigger AS $BODY$
DECLARE

dt_lib_w	timestamp;
cd_funcao_origem_w		prescr_medica.cd_funcao_origem%type;

BEGIN

if (NEW.nr_seq_interno is null) then
	select	nextval('prescr_solucao_seq')
	into STRICT	NEW.nr_seq_interno
	;
end if;

select	max(coalesce(dt_liberacao, dt_liberacao_medico)),
		max(cd_funcao_origem)
into STRICT	dt_lib_w,
		cd_funcao_origem_w
from	prescr_medica
where	nr_prescricao	= NEW.nr_prescricao;

if (dt_lib_w is not null) and (cd_funcao_origem_w	<> 2314) then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(182660);
end if;

NEW.ie_bomba_elastomerica	:= obter_bomba_elast_sol(NEW.nr_prescricao, NEW.nr_Seq_solucao);

if (NEW.ie_bomba_elastomerica is not null) and (coalesce(obter_vol_bomba_elast_sol(NEW.nr_prescricao, NEW.nr_Seq_solucao),0) > 0) then
	NEW.qt_dosagem			:= obter_vol_bomba_elast_sol(NEW.nr_prescricao, NEW.nr_Seq_solucao);
	NEW.qt_solucao_total		:= Obter_vel_sol_mlh(NEW.ie_tipo_dosagem, NEW.qt_dosagem) * NEW.qt_tempo_aplicacao * NEW.nr_etapas;
end if;

if (NEW.nr_etapas = 0) and
	((NEW.ie_acm = 'S') or (NEW.IE_SOLUCAO_PCA = 'S') or (NEW.ie_se_necessario = 'S')) and (coalesce(NEW.ie_hemodialise,'N') = 'N') then
	NEW.nr_etapas	:= null;
end if;

NEW.nr_etapas_medico	:= NEW.nr_etapas;

NEW.ds_stack	:= substr(dbms_utility.format_call_stack,1,2000);

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_solucao_insert() FROM PUBLIC;

CREATE TRIGGER prescr_solucao_insert
	BEFORE INSERT ON prescr_solucao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_solucao_insert();

