-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS transacao_financeira_update ON transacao_financeira CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_transacao_financeira_update() RETURNS trigger AS $BODY$
declare

cont_banco_w		bigint;
cont_caixa_w		bigint;
ie_alterar_desc_w	varchar(255);

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
select	count(*)
into STRICT	cont_caixa_w
from	movto_trans_financ
where	nr_seq_trans_financ 	= OLD.nr_sequencia
and (nr_seq_caixa is not null or nr_seq_saldo_caixa is not null);

select	count(*)
into STRICT	cont_banco_w
from	movto_trans_financ
where	nr_seq_trans_financ	= OLD.nr_sequencia
and (nr_seq_banco is not null or nr_seq_saldo_banco is not null);

ie_alterar_desc_w := Obter_Param_Usuario(1120, 12, wheb_usuario_pck.get_cd_perfil, NEW.nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_alterar_desc_w);

if	((ie_alterar_desc_w = 'N') and (NEW.ds_transacao <> OLD.ds_transacao) and ((cont_caixa_w > 0) or (cont_banco_w > 0))) or
	((NEW.ie_situacao in ('A','I')) and /*consistir inativas tambem conforme OS 792317*/

	 (((OLD.ie_acao	<> NEW.ie_acao) and ((cont_caixa_w > 0) or (cont_banco_w > 0))) or
	  (cont_caixa_w	> 0 AND NEW.ie_saldo_caixa	<> OLD.ie_saldo_caixa) or
	  (cont_banco_w	> 0 AND NEW.ie_banco		<> OLD.ie_banco)))	then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(	176493,
						'CONTA_CAIXA_W='||cont_caixa_w||';'||
						'CONT_BANCO_W='||cont_banco_w);

end if;

end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_transacao_financeira_update() FROM PUBLIC;

CREATE TRIGGER transacao_financeira_update
	BEFORE UPDATE ON transacao_financeira FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_transacao_financeira_update();

