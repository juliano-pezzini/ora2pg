-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_paciente_unidade_atual ON atend_paciente_unidade CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_paciente_unidade_atual() RETURNS trigger AS $BODY$
declare
ds_origem_w			varchar(1800);
ds_unidade_log_w			varchar(4000);
ds_insert_w 	varchar(60);
reg_integracao_p		gerar_int_padrao.reg_integracao;
qt_reg_w				smallint;
BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'N')  then
	goto Final;
end if;


if (TG_OP = 'INSERT') then
	select substr(dbms_utility.format_call_stack,1,1800)
	into STRICT ds_origem_w
	;
	
	ds_unidade_log_w := NEW.nr_atendimento ||' - '||to_char(NEW.dt_entrada_unidade,'dd/mm/yyyy hh24:mi:ss') || ' - ' || NEW.nr_seq_interno ||'---'||ds_origem_w;
	
	insert 	into log_mov(DT_ATUALIZACAO,
			 NM_USUARIO, 
			 CD_LOG, 
			 DS_LOG)
		values (LOCALTIMESTAMP, 
			 NEW.nm_usuario, 
			 2286249,
			 ds_unidade_log_w);
end if;
	
	
if (TG_OP = 'UPDATE') and (OLD.dt_atualizacao is not null) and (OLD.dt_atualizacao = NEW.dt_atualizacao) then

   	select substr(dbms_utility.format_call_stack,1,1800)
	into STRICT ds_origem_w 
	;
	
	ds_unidade_log_w := NEW.nr_atendimento ||' - '||to_char(NEW.dt_entrada_unidade,'dd/mm/yyyy hh24:mi:ss') || ' - ' || NEW.nr_seq_interno ||'---'||ds_origem_w;
	
	insert 	into log_mov(DT_ATUALIZACAO,
			 NM_USUARIO, 
			 CD_LOG, 
			 DS_LOG)
		values (LOCALTIMESTAMP, 
			 NEW.nm_usuario, 
			 5584024,
			 ds_unidade_log_w);
			 
	NEW.dt_atualizacao := LOCALTIMESTAMP;
   
end if;

if (NEW.ie_passagem_Setor = 'S') then
	if (TG_OP = 'INSERT') then
		ds_insert_w := substr(OBTER_DESC_EXPRESSAO(306417),1,60);
	elsif (TG_OP = 'UPDATE') then
		ds_insert_w := substr(OBTER_DESC_EXPRESSAO(621767),1,60);
	end if;

	select substr(dbms_utility.format_call_stack,1,1800)
	into STRICT ds_origem_w
	;
	
	ds_unidade_log_w :=
			SUBSTR( SUBSTR(OBTER_DESC_EXPRESSAO(325836), 1, 4000) ||':'||NEW.nr_atendimento
			||' '|| ds_insert_w 
			||' - '||SUBSTR(OBTER_DESC_EXPRESSAO(724202), 1, 4000) ||' '||ds_origem_w
			||' - '||SUBSTR(OBTER_DESC_EXPRESSAO(298359), 1, 4000)||':'||NEW.cd_setor_atendimento
			||' '||SUBSTR(OBTER_DESC_EXPRESSAO(341592), 1, 4000)||NEW.cd_unidade_basica
			||' '||SUBSTR(OBTER_DESC_EXPRESSAO(341593), 1, 4000)||NEW.cd_unidade_compl
			||' '||SUBSTR(OBTER_DESC_EXPRESSAO(646538), 1, 4000)||':'||to_char(NEW.dt_entrada_unidade,'dd/mm/yyyy hh24:mi:ss')
			||' '||SUBSTR(OBTER_DESC_EXPRESSAO(288878), 1, 4000)||':'||to_char(NEW.dt_saida_unidade,'dd/mm/yyyy hh24:mi:ss')
			||' '||SUBSTR(OBTER_DESC_EXPRESSAO(335149), 1, 4000)||':'||NEW.ie_passagem_Setor
			||' '||SUBSTR(OBTER_DESC_EXPRESSAO(328225), 1, 4000)||':'||NEW.nm_usuario
			||' '||SUBSTR(OBTER_DESC_EXPRESSAO(345366), 1, 4000)||':'||substr(obter_desc_funcao(obter_funcao_ativa),1,30)
			||' '||SUBSTR(OBTER_DESC_EXPRESSAO(330290), 1, 4000)||':'||substr(OBTER_DESC_PERFIL(obter_perfil_ativo),1,30)
			||' '||SUBSTR(OBTER_DESC_EXPRESSAO(328225), 1, 4000)||':'||substr(obter_usuario_ativo,1,30)
			,1,4000);
			
			
	insert 	into log_mov(DT_ATUALIZACAO,
			 NM_USUARIO, 
			 CD_LOG, 
			 DS_LOG)
		values (LOCALTIMESTAMP, 
			 NEW.nm_usuario, 
			 55840,
			 ds_unidade_log_w);

end if;

<<Final>>
qt_reg_w	:= 0;
	
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_paciente_unidade_atual() FROM PUBLIC;

CREATE TRIGGER atend_paciente_unidade_atual
	BEFORE INSERT OR UPDATE ON atend_paciente_unidade FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_paciente_unidade_atual();

