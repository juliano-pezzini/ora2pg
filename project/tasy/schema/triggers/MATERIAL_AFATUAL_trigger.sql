-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_afatual ON material CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_afatual() RETURNS trigger AS $BODY$
declare

BEGIN
if (1 = 2) then --De acordo com OS 1704282, o usuário irá cadastrar os princípios ativos adicionais, não é necessário a trigger gerar eles automaticamente. Também será importado via ABDATA (GERMANY)
if	(TG_OP = 'INSERT' AND NEW.nr_seq_ficha_tecnica is not null) or
	((TG_OP = 'UPDATE') and (coalesce(OLD.nr_seq_ficha_tecnica, 0) <> coalesce(NEW.nr_seq_ficha_tecnica, 0))) then
	BEGIN
	delete	FROM material_princ_ativo
	where	cd_material = NEW.cd_material;

	insert into material_princ_ativo(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_material,
		nr_seq_medic_ficha_tecnica,
		qt_conversao_mg,
		cd_unid_med_concetracao,
		cd_unid_med_base_conc,
		qt_concentracao_total,
		cd_unid_med_conc_total)
	SELECT	nextval('material_princ_ativo_seq'),
		LOCALTIMESTAMP,
		NEW.nm_usuario,
		LOCALTIMESTAMP,
		NEW.nm_usuario,
		NEW.cd_material,
		nr_sequencia,
		null qt_conversao_mg,
		null cd_unid_med_concetracao,
		null cd_unid_med_base_conc,
		null qt_concentracao_total,
		null cd_unid_med_conc_total
	from	medic_ficha_tecnica
	where	nr_seq_superior = NEW.nr_seq_ficha_tecnica;
	end;
end if;

end if;

if (TG_OP = 'UPDATE') and
	((coalesce(NEW.cd_material_generico,0) <> coalesce(OLD.cd_material_generico,0)) or (coalesce(NEW.cd_unidade_medida_consumo,'X') <> coalesce(OLD.cd_unidade_medida_consumo,'X')) or (coalesce(NEW.ie_tipo_material,'X') <> coalesce(OLD.ie_tipo_material,'X')) or (coalesce(NEW.ds_material,'X') <> coalesce(OLD.ds_material,'X')) or (coalesce(NEW.ie_situacao,'X') <> coalesce(OLD.ie_situacao,'X'))) then
	CALL gerar_int_dankia_pck.dankia_atualiza_material(OLD.cd_material,NEW.cd_material_generico,NEW.cd_unidade_medida_consumo,NEW.ie_tipo_material,NEW.ie_situacao,NEW.ds_material,NEW.nm_usuario);
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_afatual() FROM PUBLIC;

CREATE TRIGGER material_afatual
	AFTER INSERT OR UPDATE ON material FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_afatual();

