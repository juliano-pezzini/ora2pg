-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS obj_schem_order_insert ON obj_schem_order CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_obj_schem_order_insert() RETURNS trigger AS $BODY$
DECLARE
  r RECORD;
    nr_sequencia_rem_w bigint;
BEGIN
    --wheb_usuario_pck.get_ie_executar_trigger

    if (NEW.nr_seq_obj_schematic is not null) then
        BEGIN
            for r in (SELECT a.nr_sequencia,
                             a.nr_seq_apres
                        from objeto_schematic a
                       where a.nr_seq_obj_sup = NEW.nr_seq_obj_schematic
                       and NEW.NR_SEQ_OBJ_FILE is null) loop

                $if $$tasy_local_dict=true $then
                nr_sequencia_rem_w := get_remote_sequence('seq:obj_schem_order_item_seq');
                $else
                select nextval('obj_schem_order_item_seq') into STRICT nr_sequencia_rem_w;
                $end

                insert into obj_schem_order_item(nr_sequencia,
                     dt_atualizacao,
                     nm_usuario,
                     dt_atualizacao_nrec,
                     nm_usuario_nrec,
                     nr_seq_regra,
                     nr_seq_obj_schematic,
                     nr_ordem)
                values (nr_sequencia_rem_w, --obj_schem_order_item_seq.nextval,
                     LOCALTIMESTAMP,
                     NEW.nm_usuario,
                     LOCALTIMESTAMP,
                     NEW.nm_usuario,
                     NEW.nr_sequencia,
                     r.nr_sequencia,
                     r.nr_seq_apres);
            end loop;
        end;
    elsif (NEW.nr_seq_funcao_schematic is not null) then
        BEGIN
            for r in (SELECT x.nr_sequencia,
                             row_number() OVER () AS * 3 nr_seq_apres
                        from (select a.nr_sequencia
                                from funcao           b,
                                     objeto_schematic a
                               where b.cd_funcao = a.cd_funcao_externa
                                 and a.nr_seq_funcao_schematic = NEW.nr_seq_funcao_schematic
                                 and a.ie_tipo_componente = 'WAE'
                               order by substr(obter_desc_expressao(a.cd_exp_conf_usage,
                                                                    obter_desc_expressao(a.cd_exp_desc_obj,
                                                                                         obter_desc_expressao(b.cd_exp_funcao,
                                                                                                              a.ds_objeto))),
                                               1,
                                               255)) x) loop

                $if $$tasy_local_dict=true $then
                nr_sequencia_rem_w := get_remote_sequence('seq:obj_schem_order_item_seq');
                $else
                select nextval('obj_schem_order_item_seq') into STRICT nr_sequencia_rem_w;
                $end

                insert into obj_schem_order_item(nr_sequencia,
                     dt_atualizacao,
                     nm_usuario,
                     dt_atualizacao_nrec,
                     nm_usuario_nrec,
                     nr_seq_regra,
                     nr_seq_obj_schematic,
                     nr_ordem)
                values (nr_sequencia_rem_w, --obj_schem_order_item_seq.nextval,
                     LOCALTIMESTAMP,
                     NEW.nm_usuario,
                     LOCALTIMESTAMP,
                     NEW.nm_usuario,
                     NEW.nr_sequencia,
                     r.nr_sequencia,
                     r.nr_seq_apres);
            end loop;
        end;
    end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_obj_schem_order_insert() FROM PUBLIC;

CREATE TRIGGER obj_schem_order_insert
	AFTER INSERT ON obj_schem_order FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_obj_schem_order_insert();

