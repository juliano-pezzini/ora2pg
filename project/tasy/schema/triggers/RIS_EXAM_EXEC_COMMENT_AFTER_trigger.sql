-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS ris_exam_exec_comment_after ON ris_exam_exec_comment CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_ris_exam_exec_comment_after() RETURNS trigger AS $BODY$
declare
	cd_evolucao_w       evolucao_paciente.cd_evolucao%type;
	nr_atendimento_w    prescr_medica.nr_atendimento%type;
	cd_exam_type_w      ris_exam_exec_info.cd_exam_type%type;
	ds_comments_w       ris_exam_exec_info.ds_comments%type;
	dt_exam_exec_w      ris_exam_exec_info.dt_exam_exec%type;
	ds_proc_exame_w     proc_interno.ds_proc_exame%type;
	ie_cancel_w         ris_exam_exec_info.ie_cancel%type;
	cd_body_part_w      ris_exam_exec_proc.cd_body_part%type;
	ris_exec_info_seq_w ris_exam_exec_proc.nr_seq_ris_exam_exec_info%type;


BEGIN

	if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then	
		select 	cd_body_part,
				nr_seq_ris_exam_exec_info
		into STRICT	cd_body_part_w,
				ris_exec_info_seq_w
		from 	ris_exam_exec_proc
		where nr_sequencia = NEW.nr_seq_ris_exam_exec_proc;

		select	p.nr_atendimento,
			i.cd_exam_type,
			i.ds_comments,
			i.dt_exam_exec,
			i.ie_cancel
		into STRICT	nr_atendimento_w,
			cd_exam_type_w,
			ds_comments_w,
			dt_exam_exec_w,
			ie_cancel_w
		from	ris_exam_exec_info i,
			prescr_medica p
		where	i.nr_sequencia = ris_exec_info_seq_w
		and 	p.nr_prescricao = i.nr_prescricao;

		if (NEW.cd_comment_classif = 33) then
			select  a.ds_proc_exame
			into STRICT	   ds_proc_exame_w
			from    proc_interno a
			where   a.nr_sequencia = NEW.cd_comment_code;

			if (ie_cancel_w = '0') then
				ds_proc_exame_w := ds_proc_exame_w || ' (Departament)';
			else
				ds_proc_exame_w := ds_proc_exame_w || ' (Departament Canceled)';
			end if;

			cd_evolucao_w := clinical_notes_pck.gerar_soap(nr_atendimento_w, 0, 'RADIOLOGY', null, 'P', 1, cd_evolucao_w, null, null, null, dt_exam_exec_w, ds_proc_exame_w, null, cd_exam_type_w, ds_comments_w, cd_body_part_w);
		end if;
	end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_ris_exam_exec_comment_after() FROM PUBLIC;

CREATE TRIGGER ris_exam_exec_comment_after
	AFTER INSERT ON ris_exam_exec_comment FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_ris_exam_exec_comment_after();

