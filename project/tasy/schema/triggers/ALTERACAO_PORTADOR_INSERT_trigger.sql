-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS alteracao_portador_insert ON alteracao_portador CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_alteracao_portador_insert() RETURNS trigger AS $BODY$
declare
  -- local variables here

cd_estabelecimento_w    ctb_documento.cd_estabelecimento%type;
dt_hora_w		timestamp;
BEGIN
  BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

	/*OS 2869560, o delphi nao lanca horas no dt_alteracao. Essa hora  precisa ser lancada devido na rotina gerar_bloqueto_tit_rec verificar se a data da alteracao e apos a ultima via/emissao do boleto para nova geracoa*/


	BEGIN
	if (to_char(NEW.dt_alteracao,'hh24:mi:ss') = '00:00:00') then
		dt_hora_w := NEW.dt_atualizacao;
		NEW.dt_alteracao := to_date(to_char(NEW.dt_alteracao,'dd/MM/yyyy')||' '||to_char(dt_hora_w,'hh24:mi:ss'), 'dd/MM/yyyy hh24:mi:ss');
	end if;
	exception
		when data_exception then
			NEW.dt_alteracao := NEW.dt_alteracao;
		when others then
			NEW.dt_alteracao := NEW.dt_alteracao;
	end;


	select  cd_estabelecimento
	into STRICT    cd_estabelecimento_w
	from    titulo_Receber
	where   nr_titulo = NEW.nr_titulo;
	
	/* Projeto Davita  - Nao deixa gerar movimento contabil apos fechamento  da data */


	CALL philips_contabil_pck.valida_se_dia_fechado(OBTER_EMPRESA_ESTAB(cd_estabelecimento_w),NEW.dt_alteracao);
end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_alteracao_portador_insert() FROM PUBLIC;

CREATE TRIGGER alteracao_portador_insert
	BEFORE INSERT ON alteracao_portador FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_alteracao_portador_insert();

