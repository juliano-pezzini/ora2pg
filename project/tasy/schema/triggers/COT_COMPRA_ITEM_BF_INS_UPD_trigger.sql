-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cot_compra_item_bf_ins_upd ON cot_compra_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cot_compra_item_bf_ins_upd() RETURNS trigger AS $BODY$
declare

ie_situacao_w       cot_compra_item.ie_situacao%type;
ds_historico_w      varchar(255);

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

    if (obter_bloq_canc_proj_rec(NEW.nr_seq_proj_rec) > 0) then
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1144309);  -- Registro associado a um projeto bloqueado ou cancelado. 
    end if;
	
	if (NEW.vl_unit_previsto <> OLD.vl_unit_previsto) then
	
		ds_historico_w := substr(wheb_mensagem_pck.get_texto(1180001,'NR_ITEM_COT_COMPRA_W='||NEW.nr_item_cot_compra||
								';VL_OLD_UNIT_MAT_W='||campo_mascara(OLD.VL_UNIT_PREVISTO ,4)||
								';VL_NEW_UNIT_MAT_W='||campo_mascara(NEW.VL_UNIT_PREVISTO ,4)),1,255);
		
		CALL gerar_hist_cotacao_sem_commit(NEW.nr_cot_compra, WHEB_MENSAGEM_PCK.get_texto(298885), ds_historico_w, 'S', NEW.nm_usuario);
		
		if (NEW.ie_situacao = 'I') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(265963);
		end if;

	end if;
	
	if (NEW.qt_material <> OLD.qt_material) then
		
		ds_historico_w := substr(wheb_mensagem_pck.get_texto(1180002,'NR_ITEM_COT_COMPRA_W='||NEW.nr_item_cot_compra||
								';QT_MAT_OLD_W='||campo_mascara(OLD.qt_material,4)||
								';QT_MAT_NEW_W='||campo_mascara(NEW.qt_material,4)),1,255);
		
		CALL gerar_hist_cotacao_sem_commit(NEW.nr_cot_compra, WHEB_MENSAGEM_PCK.get_texto(298888), ds_historico_w, 'S', NEW.nm_usuario);

	end if;
	
	if (NEW.cd_material <> OLD.cd_material) then
		
		ds_historico_w := substr(wheb_mensagem_pck.get_texto(1180003,'NR_ITEM_COT_COMPRA_W='||NEW.nr_item_cot_compra||
							';NM_USUARIO_W='||NEW.nm_usuario||
							';CD_MATERIAL_OLD='||OLD.cd_material||
							';CD_MATERIAL_NEW='||NEW.cd_material), 1, 255);
		
		CALL gerar_hist_cotacao_sem_commit(NEW.nr_cot_compra, WHEB_MENSAGEM_PCK.get_texto(298902), ds_historico_w, 'S', NEW.nm_usuario);

	end if;
	
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cot_compra_item_bf_ins_upd() FROM PUBLIC;

CREATE TRIGGER cot_compra_item_bf_ins_upd
	BEFORE INSERT OR UPDATE ON cot_compra_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cot_compra_item_bf_ins_upd();

