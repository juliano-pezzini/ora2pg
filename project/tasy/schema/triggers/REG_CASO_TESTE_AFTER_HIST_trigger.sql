-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS reg_caso_teste_after_hist ON reg_caso_teste CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_reg_caso_teste_after_hist() RETURNS trigger AS $BODY$
declare

ie_ct_lancado_w			varchar(1);
ie_tipo_alteracao_w		reg_caso_teste_hist.ie_tipo_alteracao%type;
ds_descricao_w			reg_caso_teste_hist.ds_descricao%type;
ds_pre_condicao_w		reg_caso_teste_hist.ds_pre_condicao%type;
dt_ultima_aprovacao_w		reg_caso_teste_hist.dt_aprovacao%type;
ie_acao_teste_alterada_w	varchar(1);

BEGIN

select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
into STRICT	ie_ct_lancado_w -- Determinar se o CT j?oi liberado em alguma revis?do documento de CT
from	reg_caso_teste_hist
where	nr_seq_caso_teste = NEW.nr_sequencia
and	ie_tipo_alteracao = 'I'
and	nr_seq_reg_version_rev is not null;

if (NEW.dt_aprovacao is not null) and (NEW.nm_usuario_aprovacao is not null) then

	delete	FROM reg_caso_teste_hist
	where	nr_seq_caso_teste = NEW.nr_sequencia
	and	nr_seq_reg_version_rev is null;

	ie_acao_teste_alterada_w := reg_gravar_hist_acao_teste(NEW.nr_sequencia, NEW.nm_usuario, ie_acao_teste_alterada_w);

	if (ie_ct_lancado_w = 'S') then

		select	ds_descricao,
			ds_pre_condicao,
			dt_aprovacao
		into STRICT	ds_descricao_w,
			ds_pre_condicao_w,
			dt_ultima_aprovacao_w
		from	reg_caso_teste_hist
		where	nr_sequencia = (	SELECT	max(nr_sequencia)
						from	reg_caso_teste_hist
						where	nr_seq_caso_teste = NEW.nr_sequencia
						and	ie_tipo_alteracao in ('I', 'A')
						and	nr_seq_reg_version_rev is not null
					);

		if (coalesce(OLD.ie_situacao, 'A') = 'A') and (NEW.ie_situacao = 'I') then
			ie_tipo_alteracao_w := 'E';
		elsif (NEW.ds_descricao <> ds_descricao_w) or (ie_acao_teste_alterada_w = 'S') then
			ie_tipo_alteracao_w := 'A';
		end if;
	else
		if (coalesce(NEW.ie_situacao, 'A') = 'A') then
			ie_tipo_alteracao_w := 'I';
		end if;
	end if;
end if;

if (ie_tipo_alteracao_w is not null) then

	insert into reg_caso_teste_hist(
		nr_sequencia,
		nr_seq_customer,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_product,
		ds_descricao,
		ie_tipo_documento,
		dt_liberacao_vv,
		ds_pre_condicao,
		nr_tempo_estimado,
		nr_seq_feature,
		ie_tipo_execucao,
		ie_obrigatorio,
		ie_tipo_teste,
		cd_versao,
		nr_seq_usability_principle,
		nr_seq_reg_version_rev,
		nr_seq_estagio,
		nr_seq_caso_teste,
		ie_tipo_alteracao,
		dt_revisao,
		ie_tipo_revisao,
		nr_seq_revisao,
		ie_situacao,
		dt_aprovacao,
		nm_usuario_aprovacao,
		nm_usuario_liberacao,
		dt_inclusao_hist,
		dt_inativacao,
		nm_usuario_inativacao,
		ds_motivo_inativacao,
		nr_seq_agrupador,
		nr_seq_test_script,
		nr_seq_intencao_uso,
		cd_ct_id)
	values (
		nextval('reg_caso_teste_hist_seq'),
		NEW.nr_seq_customer,
		NEW.dt_atualizacao,
		NEW.nm_usuario,
		NEW.dt_atualizacao_nrec,
		NEW.nm_usuario_nrec,
		NEW.nr_seq_product,
		NEW.ds_descricao,
		NEW.ie_tipo_documento,
		NEW.dt_liberacao_vv,
		NEW.ds_pre_condicao,
		NEW.nr_tempo_estimado,
		NEW.nr_seq_feature,
		NEW.ie_tipo_execucao,
		NEW.ie_obrigatorio,
		NEW.ie_tipo_teste,
		NEW.cd_versao,
		NEW.nr_seq_usability_principle,
		null,
		NEW.nr_seq_estagio,
		NEW.nr_sequencia,
		ie_tipo_alteracao_w,
		NEW.dt_revisao,
		NEW.ie_tipo_revisao,
		NEW.nr_seq_revisao,
		NEW.ie_situacao,
		NEW.dt_aprovacao,
		NEW.nm_usuario_aprovacao,
		NEW.nm_usuario_liberacao,
		LOCALTIMESTAMP,
		NEW.dt_inativacao,
		NEW.nm_usuario_inativacao,
		NEW.ds_motivo_inativacao,
		NEW.nr_seq_agrupador,
		NEW.nr_seq_test_script,
		NEW.nr_seq_intencao_uso,
		NEW.cd_ct_id);

end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_reg_caso_teste_after_hist() FROM PUBLIC;

CREATE TRIGGER reg_caso_teste_after_hist
	AFTER UPDATE ON reg_caso_teste FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_reg_caso_teste_after_hist();

