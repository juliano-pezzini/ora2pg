-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS euroscore_atual ON euroscore CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_euroscore_atual() RETURNS trigger AS $BODY$
DECLARE
qt_reg_w	smallint;
qt_score_w			double precision;
qt_score2_w     double precision;
qt_score_ano_w double precision;

sql_w varchar(32000);
BEGIN
  BEGIN


if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
	BEGIN
	NEW.nr_hora	:= (to_char(round(NEW.DT_AVALIACAO,'hh24'),'hh24'))::numeric;
	end;
end if;


if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
	BEGIN
	NEW.nr_hora	:= (to_char(round(NEW.DT_AVALIACAO,'hh24'),'hh24'))::numeric;
	end;
end if;


if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
	BEGIN
	NEW.nr_hora	:= (to_char(round(NEW.DT_AVALIACAO,'hh24'),'hh24'))::numeric;
	end;
end if;
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;
NEW.qt_score_ano				:= 0;
NEW.qt_sexo					:= 0;
NEW.qt_doenca_pulm_cronica			:= 0;
NEW.qt_arteriopatia_extracardiaca		:= 0;
NEW.qt_disfuncao_neurologica		:= 0;
NEW.qt_cirurgia_cardiaca_previa		:= 0;
NEW.qt_creatinina_200			:= 0;
NEW.qt_endocartite_ativa			:= 0;
NEW.qt_preoperativo_critico		:= 0;
NEW.qt_angina_instavel			:= 0;
NEW.qt_funcao_ve				:= 0;
NEW.qt_infarto_miocardio			:= 0;
NEW.qt_hipertensao_pulmonar		:= 0;
NEW.qt_emergencia				:= 0;
NEW.qt_outro_proc_revasc			:= 0;
NEW.qt_cirurgia_aorta			:= 0;
NEW.qt_ruptura_septal			:= 0;
NEW.qt_score					:= 0;

NEW.qt_ano					:= coalesce(NEW.qt_ano,0);

  BEGIN
      sql_w := 'CALL OBTER_SCORE_ANO_EUROSCORE_MD(:1) INTO :qt_score_ano_w';
      EXECUTE sql_w USING IN NEW.qt_ano,
                                    OUT qt_score_ano_w;
  exception
    when others then
      qt_score_ano_w := null;
  end;
      NEW.qt_score_ano	:= qt_score_ano_w;
      sql_w := null;


  BEGIN
    sql_w := 'BEGIN OBTER_TOTAL_EUROSCORE_ADIT_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16, :17, :18, :19, :20, :21, :22, :23, :24, :25, :26, :27, :28, :29, :30, :31, :32, :33, :34, :35); END;';

    EXECUTE sql_w USING IN NEW.qt_score_ano,
                                  IN NEW.ie_calculo,
                                  IN NEW.ie_sexo,
                                  IN NEW.ie_doenca_pulm_cronica,
                                  IN NEW.ie_arteriopatia_extracardiaca,
                                  IN NEW.ie_disfuncao_neurologica,
                                  IN NEW.ie_cirurgia_cardiaca_previa,
                                  IN NEW.ie_creatinina_200,
                                  IN NEW.ie_endocartite_ativa,
                                  IN NEW.ie_preoperativo_critico,
                                  IN NEW.ie_angina_instavel,
                                  IN NEW.ie_funcao_ve,
                                  IN NEW.ie_infarto_miocardio,
                                  IN NEW.ie_hipertensao_pulmonar,
                                  IN NEW.ie_emergencia,
                                  IN NEW.ie_outro_proc_revasc,
                                  IN NEW.ie_cirurgia_aorta,
                                  IN NEW.ie_ruptura_septal,
                                  IN OUT NEW.qt_sexo,
                                  IN OUT NEW.qt_doenca_pulm_cronica,
                                  IN OUT NEW.qt_arteriopatia_extracardiaca,
                                  IN OUT NEW.qt_disfuncao_neurologica,
                                  IN OUT NEW.qt_cirurgia_cardiaca_previa,
                                  IN OUT NEW.qt_creatinina_200,
                                  IN OUT NEW.qt_endocartite_ativa,
                                  IN OUT NEW.qt_preoperativo_critico,
                                  IN OUT NEW.qt_angina_instavel,
                                  IN OUT NEW.qt_funcao_ve,
                                  IN OUT NEW.qt_infarto_miocardio,
                                  IN OUT NEW.qt_hipertensao_pulmonar,
                                  IN OUT NEW.qt_emergencia,
                                  IN OUT NEW.qt_outro_proc_revasc,
                                  IN OUT NEW.qt_cirurgia_aorta,
                                  IN OUT NEW.qt_ruptura_septal,
                                  OUT qt_score_w;
  exception
    when others then
      qt_score_w     := null;
  end;
      NEW.qt_score	:= qt_score_w;
      sql_w := null;

  BEGIN
    sql_w := 'BEGIN OBTER_TOTAL_EUROSCORE_LOGIS_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16, :17, :18, :19, :20, :21, :22, :23, :24, :25, :26, :27, :28, :29, :30, :31, :32, :33, :34, :35, :36, :37); END;';

    EXECUTE sql_w USING IN NEW.qt_ano,
                                  IN NEW.ie_calculo,
                                  IN NEW.ie_sexo,
                                  IN NEW.ie_doenca_pulm_cronica,
                                  IN NEW.ie_arteriopatia_extracardiaca,
                                  IN NEW.ie_disfuncao_neurologica,
                                  IN NEW.ie_cirurgia_cardiaca_previa,
                                  IN NEW.ie_creatinina_200,
                                  IN NEW.ie_endocartite_ativa,
                                  IN NEW.ie_preoperativo_critico,
                                  IN NEW.ie_angina_instavel,
                                  IN NEW.ie_funcao_ve,
                                  IN NEW.ie_infarto_miocardio,
                                  IN NEW.ie_hipertensao_pulmonar,
                                  IN NEW.ie_emergencia,
                                  IN NEW.ie_outro_proc_revasc,
                                  IN NEW.ie_cirurgia_aorta,
                                  IN NEW.ie_ruptura_septal,
                                  IN OUT NEW.qt_score_ano,
                                  IN OUT NEW.qt_sexo,
                                  IN OUT NEW.qt_doenca_pulm_cronica,
                                  IN OUT NEW.qt_arteriopatia_extracardiaca,
                                  IN OUT NEW.qt_disfuncao_neurologica,
                                  IN OUT NEW.qt_cirurgia_cardiaca_previa,
                                  IN OUT NEW.qt_creatinina_200,
                                  IN OUT NEW.qt_endocartite_ativa,
                                  IN OUT NEW.qt_preoperativo_critico,
                                  IN OUT NEW.qt_angina_instavel,
                                  IN OUT NEW.qt_funcao_ve,
                                  IN OUT NEW.qt_infarto_miocardio,
                                  IN OUT NEW.qt_hipertensao_pulmonar,
                                  IN OUT NEW.qt_emergencia,
                                  IN OUT NEW.qt_outro_proc_revasc,
                                  IN OUT NEW.qt_cirurgia_aorta,
                                  IN OUT NEW.qt_ruptura_septal,
                                  IN OUT qt_score_w,
                                  OUT qt_score2_w;
  exception
    when others then
      qt_score_w     := null;
      qt_score2_w    := null;
  end;
      NEW.qt_score	:= qt_score_w;
      NEW.qt_score2	:= qt_score2_w;
      sql_w := null;

<<Final>>
qt_reg_w	:= 0;

  END;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_euroscore_atual() FROM PUBLIC;

CREATE TRIGGER euroscore_atual
	BEFORE INSERT OR UPDATE ON euroscore FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_euroscore_atual();

