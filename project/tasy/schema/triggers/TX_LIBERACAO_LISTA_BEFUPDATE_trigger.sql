-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS tx_liberacao_lista_befupdate ON tx_liberacao_lista CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_tx_liberacao_lista_befupdate() RETURNS trigger AS $BODY$
declare

ie_profissional_w	varchar(15);
ie_profissional_regra_w	varchar(15);

BEGIN

select 	max(ie_profissional)
into STRICT	ie_profissional_w
from 	usuario
where 	nm_usuario = NEW.nm_usuario;

if (ie_profissional_w is not null) then

	select  max(ie_profissional)
	into STRICT	ie_profissional_regra_w
	from	tx_regra_lib_lista
	where	ie_tipo_prof_lib = NEW.ie_tipo_prof_lib;

	if (ie_profissional_regra_w <> ie_profissional_w) then
		/*Usuário ' || :new.nm_usuario || ' possui classe profissional ' || substr(obter_valor_dominio(1631,ie_profissional_w),1,255) || '.' || chr(13) ||
		'Porém o cadastro somente permite o lançamento dos profissionais de classe ' || substr(obter_valor_dominio(1631,ie_profissional_regra_w),1,255));*/
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(261537,	'USUARIO='||NEW.nm_usuario || ';' ||
														'PROFISSIONAL=' || substr(obter_valor_dominio(1631,ie_profissional_w),1,255) || ';' ||
														'PROFISSIONAL2=' || substr(obter_valor_dominio(1631,ie_profissional_regra_w),1,255));

	end if;
else
	--Usuário ' || :new.nm_usuario || ' não possui classe profissional definida.' || chr(13) ||  'Verificar cadastro do usuário ');
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(261540, 'USUARIO='||NEW.nm_usuario);
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_tx_liberacao_lista_befupdate() FROM PUBLIC;

CREATE TRIGGER tx_liberacao_lista_befupdate
	BEFORE INSERT OR UPDATE ON tx_liberacao_lista FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_tx_liberacao_lista_befupdate();

