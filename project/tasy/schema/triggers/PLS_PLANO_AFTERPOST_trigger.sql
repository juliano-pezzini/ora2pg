-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_plano_afterpost ON pls_plano CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_plano_afterpost() RETURNS trigger AS $BODY$
declare
ds_estagio_anterior_w		varchar(255);
ds_estagio_novo_w		varchar(255);

BEGIN

if (OLD.ie_situacao <> NEW.ie_situacao) then
	select	CASE WHEN OLD.ie_situacao='A' THEN  'Ativo' WHEN OLD.ie_situacao='S' THEN  'Suspenso' WHEN OLD.ie_situacao='I' THEN  'Cancelado' END ,
		CASE WHEN NEW.ie_situacao='A' THEN  'Ativo' WHEN NEW.ie_situacao='S' THEN  'Suspenso' WHEN NEW.ie_situacao='I' THEN  'Cancelado' END
	into STRICT	ds_estagio_anterior_w,
		ds_estagio_novo_w
	;

	insert into pls_plano_historico(nr_sequencia, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_plano,
		dt_historico, ds_titulo, ds_historico)
	values (nextval('pls_plano_historico_seq'), LOCALTIMESTAMP, NEW.nm_usuario,
		LOCALTIMESTAMP, NEW.nm_usuario, NEW.nr_sequencia,
		LOCALTIMESTAMP, 'Alteração de estágio do produto', 'Estágio anterior: ' || ds_estagio_anterior_w || chr(13) || chr(10) ||
		'Estágio novo: ' || ds_estagio_novo_w || chr(13) || chr(10) ||
		'Data ativação: ' || NEW.dt_ativacao || chr(13) || chr(10) ||
		'Data suspensão: ' || NEW.dt_suspensao || chr(13) || chr(10) ||
		'Data cancelamento: ' || NEW.dt_cancelamento);
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_plano_afterpost() FROM PUBLIC;

CREATE TRIGGER pls_plano_afterpost
	AFTER INSERT OR UPDATE ON pls_plano FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_plano_afterpost();

