-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_cam_icu_original_atual ON escala_cam_icu_original CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_cam_icu_original_atual() RETURNS trigger AS $BODY$
declare

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then

if (NEW.IE_INICIO_AGUDO_PRESENTE = 'P') then

    if (NEW.IE_ATENCAO_PRESENTE = 'P') then
 
        if (NEW.IE_NIVEL_CONC_PRESENTE = 'P' or NEW.IE_PENS_DESORG_PRESENTE = 'P') then
  
             NEW.qt_score := 3;
        else
              NEW.qt_score  := 4;
        end if;

 else
 
  NEW.qt_score  := 2;

 end if;

 else
 
  NEW.qt_score  := 1;

end if;

if (OLD.dt_liberacao is null and NEW.dt_liberacao is not null and NEW.ie_richmond_rass is not null) then

insert into escala_richmond(
    nr_sequencia,
    dt_atualizacao,
    nm_usuario,
    dt_atualizacao_nrec,
    nm_usuario_nrec,
    ie_rass,
    dt_avaliacao,
    cd_profissional,
    nr_atendimento,
    ie_situacao,
    dt_liberacao,
    ie_nivel_atencao
  )
  values (
    nextval('escala_richmond_seq'),
    LOCALTIMESTAMP,
    NEW.nm_usuario,
    LOCALTIMESTAMP,
    NEW.nm_usuario,
    NEW.ie_richmond_rass,
    LOCALTIMESTAMP,
    NEW.cd_profissional,
    NEW.nr_atendimento,
    'A',
    LOCALTIMESTAMP,
    NEW.ie_nivel_atencao
  );

end if;

end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_cam_icu_original_atual() FROM PUBLIC;

CREATE TRIGGER escala_cam_icu_original_atual
	BEFORE INSERT OR UPDATE ON escala_cam_icu_original FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_cam_icu_original_atual();

