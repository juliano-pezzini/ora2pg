-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS hd_dialise_befup_sign ON hd_dialise CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_hd_dialise_befup_sign() RETURNS trigger AS $BODY$
declare
nr_seq_assinatura_w	hd_assinatura_digital.nr_sequencia%type;

BEGIN

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_seq_dialise = NEW.nr_sequencia
and 	ie_opcao = 'C'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_cancelamento		<> NEW.dt_cancelamento
		or OLD.ds_observacao		<> NEW.ds_observacao
		or OLD.nr_seq_motivo_fim	<> NEW.nr_seq_motivo_fim
		or OLD.cd_pf_cancelamento	<> NEW.cd_pf_cancelamento
		or (OLD.dt_cancelamento 	is null		and NEW.dt_cancelamento 	is not null)
		or (OLD.ds_observacao 		is null		and NEW.ds_observacao 		is not null)
		or (OLD.nr_seq_motivo_fim 	is null		and NEW.nr_seq_motivo_fim 	is not null)
		or (OLD.cd_pf_cancelamento 	is null		and NEW.cd_pf_cancelamento 	is not null)
		or (OLD.dt_cancelamento 	is not null	and NEW.dt_cancelamento 	is null)
		or (OLD.ds_observacao 		is not null	and NEW.ds_observacao 		is null)
		or (OLD.nr_seq_motivo_fim 	is not null	and NEW.nr_seq_motivo_fim 	is null)
		or (OLD.cd_pf_cancelamento 	is not null	and NEW.cd_pf_cancelamento 	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_seq_dialise = NEW.nr_sequencia
and 	ie_opcao = 'CP'
and	dt_liberacao is not null
and	dt_inativacao is null;

if (nr_seq_assinatura_w is not null)
	and (OLD.qt_pa_sist_pre_deitado		<> NEW.qt_pa_sist_pre_deitado
		or OLD.qt_pa_diast_pre_deitado         <> NEW.qt_pa_diast_pre_deitado
		or OLD.qt_pa_sist_pre_pe               <> NEW.qt_pa_sist_pre_pe
		or OLD.qt_pa_diast_pre_pe              <> NEW.qt_pa_diast_pre_pe
		or OLD.qt_peso_pre                     <> NEW.qt_peso_pre
		or OLD.qt_peso_ideal                   <> NEW.qt_peso_ideal
		or OLD.dt_instalacao                   <> NEW.dt_instalacao
		or OLD.cd_pf_instalacao                <> NEW.cd_pf_instalacao
		or OLD.nr_seq_motivo_peso_pre          <> NEW.nr_seq_motivo_peso_pre
		or OLD.nr_seq_motivo_pa_deitado_pre    <> NEW.nr_seq_motivo_pa_deitado_pre
		or OLD.nr_seq_motivo_pa_pe_pre         <> NEW.nr_seq_motivo_pa_pe_pre
		or OLD.qt_soro_reposicao               <> NEW.qt_soro_reposicao
		or OLD.qt_soro_devolucao               <> NEW.qt_soro_devolucao
		or OLD.nr_seq_tipo_soro                <> NEW.nr_seq_tipo_soro
		or OLD.qt_gpid                         <> NEW.qt_gpid
		or OLD.qt_valor_gpid                   <> NEW.qt_valor_gpid
		or (OLD.qt_pa_sist_pre_deitado 	is null		and NEW.qt_pa_sist_pre_deitado 	is not null)
		or (OLD.qt_pa_diast_pre_deitado 	is null		and NEW.qt_pa_diast_pre_deitado 	is not null)
		or (OLD.qt_pa_sist_pre_pe 		is null		and NEW.qt_pa_sist_pre_pe 		is not null)
		or (OLD.qt_pa_diast_pre_pe 		is null		and NEW.qt_pa_diast_pre_pe 		is not null)
		or (OLD.qt_peso_pre 			is null		and NEW.qt_peso_pre 			is not null)
		or (OLD.qt_peso_ideal 			is null		and NEW.qt_peso_ideal 			is not null)
		or (OLD.dt_instalacao 			is null		and NEW.dt_instalacao 			is not null)
		or (OLD.cd_pf_instalacao 		is null		and NEW.cd_pf_instalacao 		is not null)
		or (OLD.nr_seq_motivo_peso_pre 	is null		and NEW.nr_seq_motivo_peso_pre 	is not null)
		or (OLD.nr_seq_motivo_pa_deitado_pre 	is null		and NEW.nr_seq_motivo_pa_deitado_pre 	is not null)
		or (OLD.nr_seq_motivo_pa_pe_pre 	is null		and NEW.nr_seq_motivo_pa_pe_pre 	is not null)
		or (OLD.qt_soro_reposicao 		is null		and NEW.qt_soro_reposicao 		is not null)
		or (OLD.qt_soro_devolucao 		is null		and NEW.qt_soro_devolucao 		is not null)
		or (OLD.nr_seq_tipo_soro 		is null		and NEW.nr_seq_tipo_soro 		is not null)
		or (OLD.qt_gpid 			is null		and NEW.qt_gpid 			is not null)
		or (OLD.qt_valor_gpid 			is null		and NEW.qt_valor_gpid 			is not null)
		or (OLD.qt_pa_sist_pre_deitado 	is not null	and NEW.qt_pa_sist_pre_deitado 	is null)
		or (OLD.qt_pa_diast_pre_deitado 	is not null	and NEW.qt_pa_diast_pre_deitado 	is null)
		or (OLD.qt_pa_sist_pre_pe 		is not null	and NEW.qt_pa_sist_pre_pe 		is null)
		or (OLD.qt_pa_diast_pre_pe 		is not null	and NEW.qt_pa_diast_pre_pe 		is null)
		or (OLD.qt_peso_pre 			is not null	and NEW.qt_peso_pre 			is null)
		or (OLD.qt_peso_ideal 			is not null	and NEW.qt_peso_ideal 			is null)
		or (OLD.dt_instalacao 			is not null	and NEW.dt_instalacao 			is null)
		or (OLD.cd_pf_instalacao 		is not null	and NEW.cd_pf_instalacao 		is null)
		or (OLD.nr_seq_motivo_peso_pre 	is not null	and NEW.nr_seq_motivo_peso_pre 	is null)
		or (OLD.nr_seq_motivo_pa_deitado_pre 	is not null	and NEW.nr_seq_motivo_pa_deitado_pre 	is null)
		or (OLD.nr_seq_motivo_pa_pe_pre 	is not null	and NEW.nr_seq_motivo_pa_pe_pre 	is null)
		or (OLD.qt_soro_reposicao 		is not null	and NEW.qt_soro_reposicao 		is null)
		or (OLD.qt_soro_devolucao 		is not null	and NEW.qt_soro_devolucao 		is null)
		or (OLD.nr_seq_tipo_soro 		is not null	and NEW.nr_seq_tipo_soro 		is null)
		or (OLD.qt_gpid 			is not null	and NEW.qt_gpid 			is null)
		or (OLD.qt_valor_gpid 			is not null	and NEW.qt_valor_gpid 			is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_seq_dialise = NEW.nr_sequencia
and 	ie_opcao = 'ID'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.dt_inicio_dialise		<> NEW.dt_inicio_dialise
		or OLD.cd_pf_inicio_dialise    <> NEW.cd_pf_inicio_dialise
		or (OLD.dt_inicio_dialise 	is null		and NEW.dt_inicio_dialise 	is not null)
		or (OLD.cd_pf_inicio_dialise 	is null		and NEW.cd_pf_inicio_dialise 	is not null)
		or (OLD.dt_inicio_dialise 	is not null	and NEW.dt_inicio_dialise 	is null)
		or (OLD.cd_pf_inicio_dialise 	is not null	and NEW.cd_pf_inicio_dialise 	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_seq_dialise = NEW.nr_sequencia
and 	ie_opcao = 'FD'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.qt_pa_sist_pos_pe			<> NEW.qt_pa_sist_pos_pe
		or OLD.qt_pa_diast_pos_pe              <> NEW.qt_pa_diast_pos_pe
		or OLD.qt_pa_sist_pos_deitado          <> NEW.qt_pa_sist_pos_deitado
		or OLD.qt_pa_diast_pos_deitado         <> NEW.qt_pa_diast_pos_deitado
		or OLD.qt_peso_pos                     <> NEW.qt_peso_pos
		or OLD.dt_fim_dialise                  <> NEW.dt_fim_dialise
		or OLD.cd_pf_fim_dialise               <> NEW.cd_pf_fim_dialise
		or OLD.nr_seq_motivo_peso_pos          <> NEW.nr_seq_motivo_peso_pos
		or OLD.nr_seq_motivo_pa_deitado_pos    <> NEW.nr_seq_motivo_pa_deitado_pos
		or OLD.nr_seq_motivo_pa_pe_pos         <> NEW.nr_seq_motivo_pa_pe_pos
		or OLD.qt_freq_cardiaca                <> NEW.qt_freq_cardiaca
		or OLD.qt_temp_axiliar_pos             <> NEW.qt_temp_axiliar_pos
		or OLD.qt_ultrafiltracao               <> NEW.qt_ultrafiltracao
		or OLD.qt_tempo_dialise                <> NEW.qt_tempo_dialise
		or (OLD.qt_pa_sist_pos_pe		is null		and NEW.qt_pa_sist_pos_pe		is not null)
		or (OLD.qt_pa_diast_pos_pe		is null		and NEW.qt_pa_diast_pos_pe		is not null)
		or (OLD.qt_pa_sist_pos_deitado		is null		and NEW.qt_pa_sist_pos_deitado		is not null)
		or (OLD.qt_pa_diast_pos_deitado	is null		and NEW.qt_pa_diast_pos_deitado	is not null)
		or (OLD.qt_peso_pos			is null		and NEW.qt_peso_pos			is not null)
		or (OLD.dt_fim_dialise			is null		and NEW.dt_fim_dialise			is not null)
		or (OLD.cd_pf_fim_dialise		is null		and NEW.cd_pf_fim_dialise		is not null)
		or (OLD.nr_seq_motivo_peso_pos		is null		and NEW.nr_seq_motivo_peso_pos		is not null)
		or (OLD.nr_seq_motivo_pa_deitado_pos	is null		and NEW.nr_seq_motivo_pa_deitado_pos	is not null)
		or (OLD.nr_seq_motivo_pa_pe_pos	is null		and NEW.nr_seq_motivo_pa_pe_pos	is not null)
		or (OLD.qt_freq_cardiaca		is null		and NEW.qt_freq_cardiaca		is not null)
		or (OLD.qt_temp_axiliar_pos		is null		and NEW.qt_temp_axiliar_pos		is not null)
		or (OLD.qt_ultrafiltracao		is null		and NEW.qt_ultrafiltracao		is not null)
		or (OLD.qt_tempo_dialise		is null		and NEW.qt_tempo_dialise		is not null)
		or (OLD.qt_pa_sist_pos_pe		is not null	and NEW.qt_pa_sist_pos_pe		is null)
		or (OLD.qt_pa_diast_pos_pe		is not null	and NEW.qt_pa_diast_pos_pe		is null)
		or (OLD.qt_pa_sist_pos_deitado		is not null	and NEW.qt_pa_sist_pos_deitado		is null)
		or (OLD.qt_pa_diast_pos_deitado	is not null	and NEW.qt_pa_diast_pos_deitado	is null)
		or (OLD.qt_peso_pos			is not null	and NEW.qt_peso_pos			is null)
		or (OLD.dt_fim_dialise			is not null	and NEW.dt_fim_dialise			is null)
		or (OLD.cd_pf_fim_dialise		is not null	and NEW.cd_pf_fim_dialise		is null)
		or (OLD.nr_seq_motivo_peso_pos		is not null	and NEW.nr_seq_motivo_peso_pos		is null)
		or (OLD.nr_seq_motivo_pa_deitado_pos	is not null	and NEW.nr_seq_motivo_pa_deitado_pos	is null)
		or (OLD.nr_seq_motivo_pa_pe_pos	is not null	and NEW.nr_seq_motivo_pa_pe_pos	is null)
		or (OLD.qt_freq_cardiaca		is not null	and NEW.qt_freq_cardiaca		is null)
		or (OLD.qt_temp_axiliar_pos		is not null	and NEW.qt_temp_axiliar_pos		is null)
		or (OLD.qt_ultrafiltracao		is not null	and NEW.qt_ultrafiltracao		is null)
		or (OLD.qt_tempo_dialise		is not null	and NEW.qt_tempo_dialise		is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_seq_dialise = NEW.nr_sequencia
and 	ie_opcao = 'GH'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.nr_sequencia		<> NEW.nr_sequencia
		or OLD.dt_atualizacao_nrec	<> NEW.dt_atualizacao_nrec
		or OLD.nm_usuario_nrec		<> NEW.nm_usuario_nrec
		or OLD.cd_pessoa_fisica	<> NEW.cd_pessoa_fisica
		or OLD.dt_dialise		<> NEW.dt_dialise
		or OLD.nr_seq_unid_dialise	<> NEW.nr_seq_unid_dialise
		or OLD.nr_atendimento		<> NEW.nr_atendimento
		or OLD.nr_dialise_atend_pac	<> NEW.nr_dialise_atend_pac
		or OLD.ie_tipo_dialise		<> NEW.ie_tipo_dialise
		or OLD.ie_paciente_agudo	<> NEW.ie_paciente_agudo
		or (OLD.nr_sequencia		is null		and NEW.nr_sequencia		is not null)
		or (OLD.dt_atualizacao_nrec	is null		and NEW.dt_atualizacao_nrec	is not null)
		or (OLD.nm_usuario_nrec	is null		and NEW.nm_usuario_nrec	is not null)
		or (OLD.cd_pessoa_fisica	is null		and NEW.cd_pessoa_fisica	is not null)
		or (OLD.dt_dialise		is null		and NEW.dt_dialise		is not null)
		or (OLD.nr_seq_unid_dialise	is null		and NEW.nr_seq_unid_dialise	is not null)
		or (OLD.nr_atendimento		is null		and NEW.nr_atendimento		is not null)
		or (OLD.nr_dialise_atend_pac	is null		and NEW.nr_dialise_atend_pac	is not null)
		or (OLD.ie_tipo_dialise	is null		and NEW.ie_tipo_dialise	is not null)
		or (OLD.ie_paciente_agudo	is null		and NEW.ie_paciente_agudo	is not null)
		or (OLD.nr_sequencia		is not null	and NEW.nr_sequencia		is null)
		or (OLD.dt_atualizacao_nrec	is not null	and NEW.dt_atualizacao_nrec	is null)
		or (OLD.nm_usuario_nrec	is not null	and NEW.nm_usuario_nrec	is null)
		or (OLD.cd_pessoa_fisica	is not null	and NEW.cd_pessoa_fisica	is null)
		or (OLD.dt_dialise		is not null	and NEW.dt_dialise		is null)
		or (OLD.nr_seq_unid_dialise	is not null	and NEW.nr_seq_unid_dialise	is null)
		or (OLD.nr_atendimento		is not null	and NEW.nr_atendimento		is null)
		or (OLD.nr_dialise_atend_pac	is not null	and NEW.nr_dialise_atend_pac	is null)
		or (OLD.ie_tipo_dialise	is not null	and NEW.ie_tipo_dialise	is null)
		or (OLD.ie_paciente_agudo	is not null	and NEW.ie_paciente_agudo	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

select 	max(nr_sequencia)
into STRICT	nr_seq_assinatura_w
from 	hd_assinatura_digital
where 	nr_seq_dialise = NEW.nr_sequencia
and 	ie_opcao = 'GM'
and	dt_liberacao is not null;

if (nr_seq_assinatura_w is not null)
	and (OLD.nr_sequencia		<> NEW.nr_sequencia
		or OLD.dt_atualizacao_nrec	<> NEW.dt_atualizacao_nrec
		or OLD.nm_usuario_nrec		<> NEW.nm_usuario_nrec
		or OLD.cd_pessoa_fisica	<> NEW.cd_pessoa_fisica
		or OLD.dt_dialise		<> NEW.dt_dialise
		or OLD.nr_seq_unid_dialise	<> NEW.nr_seq_unid_dialise
		or OLD.nr_atendimento		<> NEW.nr_atendimento
		or OLD.nr_dialise_atend_pac	<> NEW.nr_dialise_atend_pac
		or OLD.ie_tipo_dialise		<> NEW.ie_tipo_dialise
		or OLD.ie_paciente_agudo	<> NEW.ie_paciente_agudo
		or (OLD.nr_sequencia		is null		and NEW.nr_sequencia		is not null)
		or (OLD.dt_atualizacao_nrec	is null		and NEW.dt_atualizacao_nrec	is not null)
		or (OLD.nm_usuario_nrec	is null		and NEW.nm_usuario_nrec	is not null)
		or (OLD.cd_pessoa_fisica	is null		and NEW.cd_pessoa_fisica	is not null)
		or (OLD.dt_dialise		is null		and NEW.dt_dialise		is not null)
		or (OLD.nr_seq_unid_dialise	is null		and NEW.nr_seq_unid_dialise	is not null)
		or (OLD.nr_atendimento		is null		and NEW.nr_atendimento		is not null)
		or (OLD.nr_dialise_atend_pac	is null		and NEW.nr_dialise_atend_pac	is not null)
		or (OLD.ie_tipo_dialise	is null		and NEW.ie_tipo_dialise	is not null)
		or (OLD.ie_paciente_agudo	is null		and NEW.ie_paciente_agudo	is not null)
		or (OLD.nr_sequencia		is not null	and NEW.nr_sequencia		is null)
		or (OLD.dt_atualizacao_nrec	is not null	and NEW.dt_atualizacao_nrec	is null)
		or (OLD.nm_usuario_nrec	is not null	and NEW.nm_usuario_nrec	is null)
		or (OLD.cd_pessoa_fisica	is not null	and NEW.cd_pessoa_fisica	is null)
		or (OLD.dt_dialise		is not null	and NEW.dt_dialise		is null)
		or (OLD.nr_seq_unid_dialise	is not null	and NEW.nr_seq_unid_dialise	is null)
		or (OLD.nr_atendimento		is not null	and NEW.nr_atendimento		is null)
		or (OLD.nr_dialise_atend_pac	is not null	and NEW.nr_dialise_atend_pac	is null)
		or (OLD.ie_tipo_dialise	is not null	and NEW.ie_tipo_dialise	is null)
		or (OLD.ie_paciente_agudo	is not null	and NEW.ie_paciente_agudo	is null)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(364485);
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_hd_dialise_befup_sign() FROM PUBLIC;

CREATE TRIGGER hd_dialise_befup_sign
	BEFORE UPDATE ON hd_dialise FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_hd_dialise_befup_sign();

