-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS plano_versao_update ON plano_versao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_plano_versao_update() RETURNS trigger AS $BODY$
declare
nr_seq_regra_w	wl_regra_item.nr_sequencia%type;
qt_tempo_document_w 		wl_regra_item.qt_tempo_normal%type;
is_rule_exists_w varchar(1) := 'N';

BEGIN
	if (NEW.dt_liberacao is not null and OLD.dt_liberacao is null) then

    select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END 
    into STRICT is_rule_exists_w
    from 	wl_regra_worklist a,
		wl_regra_item b
    where	a.nr_sequencia = b.nr_seq_regra
    and		b.ie_situacao = 'A'
    and   obter_se_wl_liberado(wheb_usuario_pck.get_cd_perfil,wheb_usuario_pck.get_nm_usuario,a.nr_sequencia) = 'S'
    and		a.nr_seq_item = (	SELECT	max(x.nr_sequencia)
							from	wl_item x
							where	x.nr_sequencia = a.nr_seq_item
							and		x.cd_categoria = 'MP'
							and		x.ie_situacao = 'A');

        
    if (is_rule_exists_w = 'S') then                               
    select	coalesce(b.qt_tempo_normal,0),
		coalesce(b.nr_sequencia, 0)
    into STRICT qt_tempo_document_w,
			nr_seq_regra_w
    from 	wl_regra_worklist a,
		wl_regra_item b
    where	a.nr_sequencia = b.nr_seq_regra
    and		b.ie_situacao = 'A'
    and		a.nr_seq_item = (	SELECT	max(x.nr_sequencia)
							from	wl_item x
							where	x.nr_sequencia = a.nr_seq_item
							and		x.cd_categoria = 'MP'
							and		x.ie_situacao = 'A');


		CALL wl_gerar_finalizar_tarefa('MP','I',NEW.nr_atendimento,NEW.cd_pessoa_fisica,wheb_usuario_pck.get_nm_usuario,LOCALTIMESTAMP+(qt_tempo_document_w/24),
                              'N',null,null,null,null,null,null,null,null,null,nr_seq_regra_w,
                              null,null,null,null,null,null,null,LOCALTIMESTAMP,null,null,NEW.cd_medico);
	end if;
  end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_plano_versao_update() FROM PUBLIC;

CREATE TRIGGER plano_versao_update
	BEFORE UPDATE ON plano_versao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_plano_versao_update();

