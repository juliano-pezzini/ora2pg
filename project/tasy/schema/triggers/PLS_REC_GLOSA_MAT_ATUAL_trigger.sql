-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_rec_glosa_mat_atual ON pls_rec_glosa_mat CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_rec_glosa_mat_atual() RETURNS trigger AS $BODY$
declare

ds_log_call_w	varchar(1500);
ds_log_w 	varchar(4000);
nr_seq_conta_w		pls_conta.nr_sequencia%type;

BEGIN

if ( coalesce(NEW.vl_acatado,0) != coalesce(OLD.vl_acatado,0)) then

	select nr_seq_conta
	into STRICT	nr_seq_conta_w
	from	pls_conta_mat
	where 	nr_sequencia = NEW.nr_seq_conta_mat;

	ds_log_w := ' seq mat rec = '||NEW.nr_sequencia||' new vl_acatado = '||coalesce(NEW.vl_acatado,0)||' old vl_acatado = '||coalesce(OLD.vl_acatado,0);
	ds_log_call_w := substr(	' Funcao ativa : '|| obter_funcao_ativa || chr(13) ||chr(10)||
							' CallStack: '|| chr(13) || chr(10)|| dbms_utility.format_call_stack,1,1500);
							
	ds_log_w := ds_log_w ||' -> '||ds_log_call_w;
	--nr_seq_conta, nr_seq_conta_proc, nr_seq_conta_mat referem-se aos registros da pls_conta, pls_conta_proc e pls_conta_mat
	insert into pls_rec_glosa_item_log(nr_sequencia, nr_seq_conta, nr_seq_conta_proc, nr_seq_conta_mat, ds_log, dt_atualizacao_nrec, dt_atualizacao, nm_usuario, nm_usuario_nrec)
	values ( nextval('pls_rec_glosa_item_log_seq'), nr_seq_conta_w, null, NEW.nr_seq_conta_mat, ds_log_w, LOCALTIMESTAMP, LOCALTIMESTAMP, NEW.nm_usuario, NEW.nm_usuario);
end if;

							
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_rec_glosa_mat_atual() FROM PUBLIC;

CREATE TRIGGER pls_rec_glosa_mat_atual
	BEFORE UPDATE ON pls_rec_glosa_mat FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_rec_glosa_mat_atual();

