-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS evento_nobreak_insert ON evento_nobreak CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_evento_nobreak_insert() RETURNS trigger AS $BODY$
DECLARE
 
nm_usuario_sms_w	varchar(20);
ds_senha_sms_w		varchar(20);
ds_status_envio_w	varchar(60);
ds_remetente_w		varchar(255);
nm_usuario_envio_w	varchar(15);
nr_celular_envio_w	varchar(15);
ds_email_envio_w	varchar(255);
ie_forma_aviso_w	varchar(15);
ds_evento_nobreak_w	varchar(60);
ie_retorno_sms_w	smallint;
ds_contato_envio_w	varchar(255);
 
id_sms_w			bigint;
ds_esconder_ddi_w	varchar(1);
 
c01 CURSOR FOR 
	SELECT 	CASE WHEN ds_esconder_ddi_w='S' THEN  a.nr_ddd_celular||a.NR_TELEFONE_CELULAR  ELSE a.nr_ddi_celular||a.NR_TELEFONE_CELULAR END  NR_TELEFONE_CELULAR, 
			obter_compl_pf(a.cd_pessoa_fisica,1,'M'), 
			b.ie_forma_aviso, 
			b.nm_usuario_aviso 
	from	pessoa_fisica a, 
			evento_nobreak_usuario b 
	where	a.cd_pessoa_fisica 	= obter_pessoa_fisica_usuario(b.nm_usuario_aviso,'C') 
	and		b.nr_seq_evento	 	= NEW.nr_seq_evento;
 
BEGIN 
 
ds_esconder_ddi_w := OBTER_VALOR_PARAM_USUARIO(0,214,0,obter_usuario_ativo,obter_estabelecimento_ativo);
 
select	ds_evento 
into STRICT	ds_evento_nobreak_w 
from	tipo_evento_nobreak 
where	nr_sequencia 		= NEW.nr_seq_evento;
 
OPEN c01;
LOOP 
FETCH c01 INTO 	nr_celular_envio_w, 
		ds_email_envio_w, 
		ie_forma_aviso_w, 
		nm_usuario_envio_w;
BEGIN 
 	EXIT WHEN NOT FOUND; /* apply on c01 */
	 
	if ( upper(ie_forma_aviso_w) = 'MCEL' ) then 
		nr_celular_envio_w := replace(nr_celular_envio_w,'(','');
		nr_celular_envio_w := replace(nr_celular_envio_w,')','');
		nr_celular_envio_w := replace(nr_celular_envio_w,' ','');
		nr_celular_envio_w := replace(nr_celular_envio_w,'-','');
		if (nr_celular_envio_w is not null) then 
			id_sms_w := wheb_sms.enviar_sms('Nobreak', nr_celular_envio_w, ds_evento_nobreak_w, obter_usuario_ativo, id_sms_w);
		end if;
	end if;
	if ( upper(ie_forma_aviso_w) = 'EMAIL') then 
		CALL Enviar_Email(	'Evento Nobreak', 
				ds_evento_nobreak_w, 
				ds_remetente_w, 
				ds_email_envio_w, 
				nm_usuario_envio_w, 
				'A');
		ds_contato_envio_w	:= ds_email_envio_w;
		ds_status_envio_w	:= 'Email enviado com sucesso';
	end if;
 
	if ( upper(ie_forma_aviso_w) = 'CI') then 
		insert into comunic_interna( 
			nr_sequencia, 
			dt_comunicado, 
			ds_titulo, 
			ds_comunicado, 
			ie_gerencial, 
			nm_usuario_destino, 
			ie_geral, 
			cd_estab_destino, 
			nr_seq_classif, 
			dt_liberacao, 
			nm_usuario, 
			dt_atualizacao) 
		values ( 
			nextval('comunic_interna_seq'), 
			LOCALTIMESTAMP, 
			'Evento Nobreak', 
			ds_evento_nobreak_w, 
			'N', 
			nm_usuario_envio_w, 
			'N', 
			1, 
			5, 
			LOCALTIMESTAMP, 
			'NoBreak', 
			LOCALTIMESTAMP);
		ds_contato_envio_w	:= '';
		ds_status_envio_w	:= 'Comunicação criada com sucesso';
	end if;
 
 
	insert into evento_nobreak_aviso( 
		nr_sequencia, 
		ds_status, 
		dt_envio, 
		nm_usuario_envio, 
		nr_seq_evento, 
		ds_contato_envio, 
		ie_forma_envio, 
		dt_atualizacao, 
		nm_usuario) 
	values (nextval('evento_nobreak_aviso_seq'), 
		ds_status_envio_w, 
		LOCALTIMESTAMP, 
		nm_usuario_envio_w, 
		NEW.nr_sequencia, 
		ds_contato_envio_w, 
		ie_forma_aviso_w, 
		LOCALTIMESTAMP, 
		'Nobreak');
END;
END LOOP;
CLOSE c01;
 
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_evento_nobreak_insert() FROM PUBLIC;

CREATE TRIGGER evento_nobreak_insert
	AFTER INSERT ON evento_nobreak FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_evento_nobreak_insert();

