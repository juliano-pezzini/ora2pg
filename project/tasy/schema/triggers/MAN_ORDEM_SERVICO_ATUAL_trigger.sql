-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS man_ordem_servico_atual ON man_ordem_servico CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_man_ordem_servico_atual() RETURNS trigger AS $BODY$
DECLARE

qt_reg_w						bigint;
qt_existe_w						bigint;
qt_existe_orc_w					bigint;
cd_setor_atendimento_w			bigint;

qt_registro_w				bigint;
nr_seq_estagio_w			bigint;
ie_estagio_new_tec_w			bigint	:= 0;
ie_estagio_old_tec_w			bigint	:= 0;
ie_gerar_grupo_des_w			varchar(01)	:= 'S';
nr_seq_gerencia_w			bigint;
ds_tipo_w				varchar(255);
nr_seq_sla_w				bigint;
qt_reg_analista_w			bigint;
nr_seq_sla_ww				bigint;
nr_seq_sla_regra_w			bigint;
nr_seq_sla_regra_ww			bigint;
qt_estagio_desenv_w			bigint;
ie_estagio_atual_desen_w		varchar(1);
ie_limpar_data_real_reab_w		varchar(1);
ds_mensagem_sms_w			varchar(255);
nm_usuario_lider_w			varchar(255);
ie_recebe_desenv_w			varchar(15);
nm_usuario_negonio_w			varchar(255);
ie_sms_w				varchar(15);
nr_telefone_celular_w			pessoa_fisica.nr_telefone_celular%type;
nr_telefone_celular_adic_w		varchar(15);
nm_usuario_lider_sup_w			varchar(15);
ds_enter_w				varchar(2)	:= chr(13) || chr(10);

ds_responsavel_teste_comp_w		varchar(60);
ds_responsaveis_teste_comp_w		varchar(2000);
nr_seq_estagio_padrao_w			bigint;
ie_desenv_w				varchar(01)	:= 'S';
ie_suporte_w				varchar(01)	:= 'S';
ie_tecnologia_w				varchar(01)	:= 'S';
ie_testes_w				varchar(01)	:= 'S';
ie_encerrado_inatividade_w		varchar(1);
ie_encerr_classif_ind_w			varchar(1);
nr_seq_ativ_exec_w			bigint;
nm_usuario_manutencao_w			varchar(15);

ie_tec_w				varchar(1);
ie_des_w				varchar(1);
ie_tecnologia_old_w			varchar(1);
ie_desenv_new_w				varchar(1);

/*SLA*/

cd_estabelecimento_w			smallint	:= wheb_usuario_pck.get_Cd_estabelecimento;
qt_min_termino_w			bigint	:= 0;
qt_min_inicio_w				bigint	:= 0;
nr_seq_skill_w				bigint;
ie_tempo_w				varchar(15);
ie_utiliza_sla_w			varchar(15);
ie_gerar_dt_fim_prev_sla_w		varchar(15);
ie_gerar_dt_inicio_prev_sla_w		varchar(15);
ds_retorno_w				varchar(2000)	:= null;

nr_seq_pendencia_w			bigint;
cd_pessoa_adic_w			varchar(10);
nr_seq_solic_sd_w			bigint;
ie_acao_solic_w				varchar(2);
nr_seq_mot_canc_solic_w			bigint;

nr_seq_grupo_des_w			grupo_desenvolvimento.nr_sequencia%type;
ie_situacao_grupo_des_w			grupo_desenvolvimento.ie_situacao%type;
nr_seq_grupo_loc_w			funcao_grupo_loc.nr_seq_grupo_des%type;
nr_seq_estagio_loc_w			funcao_grupo_loc.nr_seq_estagio%type;
nr_seq_gerencia_sup_w			grupo_suporte.nr_seq_gerencia_sup%type;
nr_seq_grupo_sup_esp_w 			grupo_suporte.nr_sequencia%type;
ie_status_w				varchar(1);

ie_abrangencia_w			varchar(1);
ie_delphi_w				varchar(1);
ie_java_w				varchar(1);
ie_html5_w				varchar(1);
ie_terceiro_w				varchar(1);
ie_tipo_ordem_w 			man_ordem_servico.ie_tipo_ordem%type;
qt_ativ_programacao_w			bigint;
qt_hist_code_review_w			bigint;

/*Acordo Cliente*/

nr_seq_des_acordo_os_w			bigint;

ie_acao_w				bigint;
nm_usuario_email_w			varchar(255);
ds_usu_mail_w				varchar(255);
ie_base_corp_w 				varchar(1);
ie_base_wheb_w 				varchar(1);
ie_base_philips_w			varchar(1);
nr_seq_idioma_loc_w			bigint;
ie_origem_w				man_ordem_servico.ie_origem%type;
qt_char_w				bigint;
ie_waiting_ch_w				varchar(1);
ie_complaint_rule_w			varchar(1);
ie_complaint_w				varchar(1);
qt_hist_risco_w				bigint;
qt_hist_decisao_w			bigint;
qt_hist_info_pergunta_w			bigint;
qt_hist_info_resposta_w			bigint;
qt_hist_complaint_w			bigint;
ie_complaint_eval_w			man_ordem_servico.ie_complaint%type;
ds_return_w				varchar(50) := 'Not defined';
ie_permite_abertura_os_w		varchar(1);
ds_classificacao_w			varchar(100);
nr_seq_grupo_sup_w			grupo_suporte.nr_sequencia%type;

ie_info_relavantes_w	varchar(1);
ie_ult_estag_cliente_w	varchar(1);
ie_stage_to_desenv_w    varchar(1) := 'N';
ie_classif_equivalente_w man_classif_cadastro.ie_classif_equivalente%type;
ie_classif_equiv_cliente_w man_classif_cadastro.ie_classif_equivalente%type;

C01 CURSOR FOR
	/*Verificar os respons?is por realiazr testes em componentes*/

	SELECT 	obter_nome_usuario(c.nm_usuario_lider)
	From	Componente_Tasy a,
		Comp_Grupo_Desenv b,
		grupo_desenvolvimento c
	Where	a.Nr_Sequencia = B.Nr_Seq_Comp_Tasy
	and	C.Nr_Sequencia = B.Nr_Seq_Grupo
	and	a.cd_componente = NEW.ie_componente
	and	Not Exists ( SELECT 1
				From	Man_Ordem_Serv_Tecnico d
				Where	d.nr_Seq_Ordem_Serv = NEW.nr_sequencia
				And	d.nr_seq_tipo	= 30
				and	d.nm_usuario 	= c.nm_usuario_lider);

				
c02 CURSOR FOR
	SELECT	nr_seq_ativ_exec
	from	man_ordem_ativ_prev
	where	nr_seq_ordem_serv = NEW.nr_sequencia
	and		nr_seq_ativ_exec in (58,115,120,130,131,124);
				
c03 CURSOR FOR
SELECT	a.ie_recebe_desenv,
	a.ie_sms,
	a.cd_pessoa_adic
FROM	desenv_regra_os_cliente a
WHERE	coalesce(a.nr_seq_localizacao,NEW.nr_seq_localizacao) = NEW.nr_seq_localizacao
AND	coalesce(a.ie_classificacao,NEW.ie_classificacao) = NEW.ie_classificacao
AND	coalesce(a.nr_seq_classif_cad,coalesce(NEW.nr_seq_classif_cad,0)) = coalesce(NEW.nr_seq_classif_cad,0)
AND	coalesce(a.nr_seq_gerencia, nr_seq_gerencia_w) = nr_seq_gerencia_w
and	coalesce(a.cd_funcao, coalesce(NEW.cd_funcao,9999999999)) = coalesce(NEW.cd_funcao,9999999999)
AND	coalesce(a.nr_seq_grupo_des, NEW.nr_seq_grupo_des) = NEW.nr_seq_grupo_des
AND	coalesce(a.nr_seq_grupo_sup, NEW.nr_seq_grupo_sup) = NEW.nr_seq_grupo_sup
AND	((coalesce(ie_terceiro, ie_terceiro_w) = ie_terceiro_w) or (a.ie_terceiro = 'A'))
and (position(coalesce(NEW.ie_plataforma, 'passed') in coalesce(a.ie_plataforma, coalesce(NEW.ie_plataforma, 'passed'))) > 0)
AND	a.ie_situacao = 'A'
AND	man_verificar_vigencia_regra(NEW.dt_ordem_servico, a.dt_inicio, a.dt_fim) = 'S'
ORDER BY coalesce(a.dt_inicio, LOCALTIMESTAMP) DESC,
	coalesce(a.dt_fim, LOCALTIMESTAMP) DESC,
	coalesce(a.cd_funcao, 9999999999) DESC,
	coalesce(a.ie_plataforma, 'ZZZZZZZZZZZ') DESC,
	coalesce(a.nr_seq_grupo_des, 9999999999) DESC,
	coalesce(a.nr_seq_grupo_sup, 9999999999) DESC,
	coalesce(a.nr_seq_gerencia, 9999999999) DESC,
	coalesce(a.ie_classificacao, 'ZZZZZZZZZZZ') DESC,
	coalesce(a.nr_seq_localizacao, 9999999999) DESC;

c04 CURSOR FOR
	SELECT  a.nm_usuario_grupo,
		b.ds_email
	from    gerencia_wheb_grupo_usu a,
		usuario b
	where   nr_seq_grupo = 249
	and     b.nm_usuario = a.nm_usuario_grupo;
	
c05 CURSOR FOR
SELECT	a.ie_sms,
	a.cd_pessoa_adic
from	desenv_regra_os_cliente a
where	coalesce(a.nr_seq_localizacao,NEW.nr_seq_localizacao) = NEW.nr_seq_localizacao
and	coalesce(a.ie_classificacao,NEW.ie_classificacao) = NEW.ie_classificacao
AND	coalesce(a.nr_seq_classif_cad,coalesce(NEW.nr_seq_classif_cad,0)) = coalesce(NEW.nr_seq_classif_cad,0)
and	a.ie_sms = 'S'
and	a.ie_situacao = 'A'
order by coalesce(a.dt_inicio, LOCALTIMESTAMP) desc,
	coalesce(a.dt_fim, LOCALTIMESTAMP) desc,
	coalesce(a.ie_classificacao, 'ZZZZZZZZZZZ') desc,
	coalesce(a.nr_seq_localizacao, 9999999999) desc;
BEGIN
  BEGIN

ie_base_corp_w := obter_se_base_corp;
ie_base_wheb_w := obter_se_base_wheb;

if	((ie_base_corp_w = 'S') and (TG_OP = 'UPDATE') and (upper(NEW.nm_usuario) = 'WEBSERVICE') and (OLD.nr_seq_classif_cad is null) and (NEW.nr_seq_classif_cad is not null)) then
	BEGIN
		select  max(ie_classif_equivalente)
		into STRICT    ie_classif_equiv_cliente_w
		from    man_classif_cadastro
		where   nr_sequencia = NEW.nr_seq_classif_cad;
		
		NEW.nr_seq_grupo_des := null;
		NEW.nr_seq_grupo_sup := null;
		
		if (NEW.ie_classificacao <> ie_classif_equiv_cliente_w) then
			BEGIN
				NEW.nr_seq_estagio := 231;

				NEW.ie_classificacao := ie_classif_equiv_cliente_w;
				NEW.ie_classificacao_cliente := ie_classif_equiv_cliente_w;

                                if (NEW.ie_classificacao = 'E') then
                                        BEGIN
                                                NEW.nr_seq_severidade := man_get_severity(NEW.ie_prioridade);
                                                NEW.nr_seq_severidade_wheb := man_get_severity(NEW.ie_prioridade);
					end;
                                elsif (NEW.ie_classificacao = 'S') then
                                        BEGIN
                                                NEW.nr_seq_severidade := 7;
                                                NEW.nr_seq_severidade_wheb := 7;
					end;
                                else
                                        BEGIN
                                                NEW.nr_seq_severidade := null;
                                                NEW.nr_seq_severidade_wheb := null;
					end;
                                end if;

				CALL sla_dashboard_pck.man_delete_os_monitor(NEW.nr_sequencia);
				
                                delete
                                from man_sla_evento
                                where nr_seq_ordem = NEW.nr_sequencia;

                                delete
                                from man_ordem_serv_sla 
                                where nr_seq_ordem = NEW.nr_sequencia;

			end;
		end if;
		
exception
when others then
        null;
end;
end if;


select	coalesce(max('S'), 'N')
into STRICT	ie_base_philips_w

where	obter_se_base_corp = 'S'
or	obter_se_base_wheb = 'S';

if (phi_is_base_philips = 'S') then
	BEGIN
		if (TG_OP = 'INSERT') then
			BEGIN
				if (	NEW.nr_seq_planej is not null
					and	NEW.ie_tipo_ordem = 2) then
					BEGIN
						NEW.nr_seq_severidade := 7;
						NEW.nr_seq_severidade_wheb := 7;
					end;
				end if;
			end;
		end if;
	end;
end if;

if (TG_OP = 'INSERT') and (ie_base_philips_w = 'S') and (NEW.ie_origem_os = 1) then
	select	coalesce(max(ra.ie_permite_abertura_os),'S')
	into STRICT	ie_permite_abertura_os_w
	from	phi_regra_abertura_os ra
	where	ra.ie_situacao = 'A'
	and	ra.ie_classificacao = NEW.ie_classificacao
	and	coalesce(ra.cd_setor_atendimento, wheb_usuario_pck.get_cd_setor_atendimento,0) = coalesce(wheb_usuario_pck.get_cd_setor_atendimento,0)
	and	coalesce(ra.nr_seq_equipamento, NEW.nr_seq_equipamento,0) = coalesce(NEW.nr_seq_equipamento,0)
	and	coalesce(ra.ie_plataforma, NEW.ie_plataforma,null) = coalesce(NEW.ie_plataforma,null)
	order by coalesce(ra.cd_setor_atendimento,0),
		coalesce(ra.nr_seq_equipamento,0),
		coalesce(NEW.ie_plataforma,0);
	
	if (ie_permite_abertura_os_w = 'N') then
		ds_classificacao_w := substr(obter_valor_dominio_idioma(1149, NEW.ie_classificacao, wheb_usuario_pck.get_nr_seq_idioma),1,80);
		BEGIN
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1206332,'DS_CLASSIFICACAO='||coalesce(ds_classificacao_w,' '));
		end;
	end if;
end if;

/*altera? para n?permitir os cliente abrirem OS de anomalia, situa? encontrada no portal web*/

if (ie_base_corp_w = 'S') and (NEW.ie_classificacao_cliente = 'A') and (NEW.ie_classificacao = 'A') then
	
	select  max(a.nr_seq_idioma)
	into STRICT    nr_seq_idioma_loc_w
	from    pessoa_juridica a,
		man_localizacao b
	where   a.cd_cgc	= b.cd_cnpj
	and	b.nr_sequencia	= NEW.nr_seq_localizacao;
	
	if (ie_terceiro_w = 'S') then
		NEW.ie_classificacao := 'E';
		NEW.ie_classificacao_cliente := 'E';
		
		insert into man_ordem_serv_tecnico(nr_sequencia,
			nr_seq_ordem_serv,
			dt_atualizacao,
			nm_usuario,
			ds_relat_tecnico,
			dt_historico,
			ie_origem,
			nr_seq_tipo,
			dt_liberacao,
			nm_usuario_lib)
		values (nextval('man_ordem_serv_tecnico_seq'),
			NEW.nr_sequencia,
			LOCALTIMESTAMP,
			'Tasy',
			obter_desc_exp_idioma(919172,nr_seq_idioma_loc_w) || '. ' || obter_desc_exp_idioma(327458,nr_seq_idioma_loc_w) || ' ' || obter_desc_exp_idioma(549954,nr_seq_idioma_loc_w),
			LOCALTIMESTAMP,
			'I',
			148,
			LOCALTIMESTAMP,
			'Tasy');
	end if;
end if;

if	((ie_base_corp_w = 'S') and (OLD.nr_versao_cliente_abertura is not null) and (coalesce(NEW.nr_versao_cliente_abertura,'0') <> OLD.nr_versao_cliente_abertura)) then
			insert into man_ordem_serv_tecnico(nr_sequencia,
					nr_seq_ordem_serv,
					dt_historico,
					dt_liberacao,
					nm_usuario,
					dt_atualizacao,
					nr_seq_tipo, 
					ds_relat_tecnico,
					nm_usuario_lib)
			values (nextval('man_ordem_serv_tecnico_seq'),
					NEW.nr_sequencia,
					LOCALTIMESTAMP,
					LOCALTIMESTAMP, 
					NEW.nm_usuario,
					LOCALTIMESTAMP, 
					7, --Dialogo interno.
					substr(obter_texto_dic_objeto(1125812, obter_nr_seq_idioma(NEW.nm_usuario), 
						substr(	'NR_VERSAO_ANTERIOR=' || coalesce(OLD.NR_VERSAO_CLIENTE_ABERTURA,' ') 
						||	';NR_VERSAO_ATUAL=' || coalesce(NEW.NR_VERSAO_CLIENTE_ABERTURA,' '),1,4000)),1,4000),
					NEW.nm_usuario);					
end if;


if (	ie_base_philips_w = 'S'
	and	NEW.nr_versao_cliente_abertura is not null) then
	BEGIN
	
		select	coalesce(length(NEW.nr_versao_cliente_abertura) - length(replace(NEW.nr_versao_cliente_abertura,'.',null)), length(NEW.nr_versao_cliente_abertura), 0)
		into STRICT	qt_char_w
		;
		
		if (qt_char_w > 2) then
			BEGIN
				NEW.cd_tasy_version := substr(NEW.nr_versao_cliente_abertura, 1, instr(NEW.nr_versao_cliente_abertura, '.', -1) -1);
				NEW.nr_service_pack := substr(NEW.nr_versao_cliente_abertura, instr(NEW.nr_versao_cliente_abertura, '.', -1) +1);
			end;
		elsif (qt_char_w <= 2) then
			BEGIN
				NEW.cd_tasy_version := NEW.nr_versao_cliente_abertura;
				NEW.nr_service_pack := '00';
			end;
		end if;
	exception
		when others then
			NEW.cd_tasy_version := null;
			NEW.nr_service_pack := null;
	end;
end if;

if	(	phi_is_base_philips = 'S'
	and	upper(NEW.nm_usuario) <> 'WEBSERVICE'
	and	(	(OLD.ie_status_ordem = 3 and NEW.ie_status_ordem <> 3)
		or (OLD.nr_seq_estagio = 9 and NEW.nr_seq_estagio <> 9))) then
	BEGIN
		select	coalesce(max('S'), 'N') ie_encerrada
		into STRICT	ie_encerrado_inatividade_w
		from	man_ordem_serv_tecnico most
		where	most.nr_seq_ordem_serv = NEW.nr_sequencia
		and	most.nr_seq_tipo = 273; -- Encerramento por ausencia de retorno
		
		select	coalesce(max('S'), 'N') ie_classif_indevida
		into STRICT	ie_encerr_classif_ind_w
		from	man_ordem_serv_tecnico most
		where	most.nr_seq_ordem_serv = NEW.nr_sequencia
		and	most.nr_seq_tipo = 281; -- Encerramento por ausencia de retorno
		
		if (ie_encerrado_inatividade_w = 'S') then
			BEGIN
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1143145);
			end;
		elsif (ie_encerr_classif_ind_w = 'S') then
			BEGIN
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1182415);
			end;
		end if;
	end;
end if;

select	coalesce(max(ie_delphi),'N'),
	coalesce(max(ie_java),'N'),
	coalesce(max(ie_html5),'N'),
	coalesce(max(ie_terceiro),'S')
into STRICT	ie_delphi_w,
        ie_java_w,
        ie_html5_w,
        ie_terceiro_w
from	man_localizacao
where	nr_sequencia	= NEW.nr_seq_localizacao;

if (ie_base_philips_w = 'S') then
	if (ie_terceiro_w = 'N') then
		NEW.ie_origem := 'I';
	else
		select 	coalesce(max('I'), 'E')
		into STRICT 	ie_origem_w
		from 	man_localizacao_status a
		where 	a.nr_seq_localizacao = NEW.nr_seq_localizacao
		and 	NEW.dt_ordem_servico <= coalesce(a.dt_fim, LOCALTIMESTAMP);

		NEW.ie_origem := ie_origem_w;
	end if;
end if;

if (NEW.nr_seq_grupo_des is not null) then
	BEGIN
	select	max(ie_situacao)
	into STRICT	ie_situacao_grupo_des_w
	from	grupo_desenvolvimento
	where	nr_sequencia = NEW.nr_seq_grupo_des;

	if (ie_situacao_grupo_des_w = 'I') then
		NEW.nr_seq_grupo_des := null;
	end if;
	end;
end if;

if (phi_is_base_philips = 'S' and
	NEW.nr_seq_grupo_des is null and
	NEW.cd_funcao is not null) then
	BEGIN
	/*
	* The system will clear the field if the function had changed
	* and the new function does not have a item registered
	*/
	if (NEW.nr_seq_func_item is not null) then
		BEGIN
		select	count(1)
		into STRICT	qt_reg_w
		from	funcao_item fi
		where	fi.cd_funcao = NEW.cd_funcao
		and	fi.nr_sequencia = NEW.nr_seq_func_item;
		
		if (qt_reg_w = 0) then
			NEW.nr_seq_func_item := null;
		end if;
		end;
	end if;


	/**
	* The objective of this select is to return only the most restrictive
	* row, accordingly with the parameters in the service order.
	*/
	BEGIN
	select	x.nr_seq_grupo,
		x.nr_seq_skill
	into STRICT	nr_seq_grupo_des_w,
		nr_seq_skill_w
	from (SELECT	fgd.nr_seq_grupo,
			fgd.nr_seq_skill
		FROM grupo_desenvolvimento gd, funcao_grupo_des fgd
LEFT OUTER JOIN funcao_grupo_des_cli fgdc ON (fgd.nr_sequencia = fgdc.nr_seq_funcao_grupo)
WHERE gd.nr_sequencia = fgd.nr_seq_grupo  and gd.ie_situacao = 'A' and fgd.cd_funcao = NEW.cd_funcao and (fgd.nr_seq_func_item = NEW.nr_seq_func_item or fgd.nr_seq_func_item is null) and (fgdc.nr_seq_localizacao = NEW.nr_seq_localizacao or fgdc.nr_seq_localizacao is null) order by
			fgdc.nr_seq_localizacao,
			fgd.nr_seq_func_item,
			fgd.nr_seq_grupo) x LIMIT 1;
	exception
	when others then
		nr_seq_grupo_des_w := null;
		nr_seq_skill_w := null;
	end;

	/**
	* Treatment for specific cases, when the select above didnt bring any
	* value, for the service order to not get lost in the backlog without
	* any development group.
	*/
	if (nr_seq_grupo_des_w is null) then
		BEGIN
		select	x.nr_seq_grupo,
			x.nr_seq_skill
		into STRICT	nr_seq_grupo_des_w,
			nr_seq_skill_w
		from (SELECT	fgd.nr_seq_grupo,
				fgd.nr_seq_skill
			FROM grupo_desenvolvimento gd, funcao_grupo_des fgd
LEFT OUTER JOIN funcao_grupo_des_cli fgdc ON (fgd.nr_sequencia = fgdc.nr_seq_funcao_grupo)
WHERE gd.nr_sequencia = fgd.nr_seq_grupo  and gd.ie_situacao = 'A' and fgd.cd_funcao = NEW.cd_funcao and (fgdc.nr_seq_localizacao = NEW.nr_seq_localizacao or fgdc.nr_seq_localizacao is null) order by
				fgdc.nr_seq_localizacao,
				fgd.nr_seq_func_item,
				fgd.nr_seq_grupo) x LIMIT 1;
		exception
		when others then
			nr_seq_grupo_des_w := null;
			nr_seq_skill_w := null;
		end;
	end if;
	
	/**
	* Select the most appropriate group according to the FUNCAO_GRUPO_LOC rule. If a group is found, assign
	* the new development group of the SO to the group found. Otherwise, assign the group found in the previous
	* SELECT statements (FUNCAO_GRUPO_DES rule).
	**/
	select	max(x.nr_seq_grupo_des),
		max(x.nr_seq_estagio)
	into STRICT	nr_seq_grupo_loc_w,
    		nr_seq_estagio_loc_w
	from (SELECT fgl.nr_seq_grupo_des,
    		        fgl.nr_seq_estagio
        	from	funcao_grupo_loc fgl,
			grupo_desenvolvimento gd
    		where	fgl.nr_seq_grupo_des = gd.nr_sequencia
		and	gd.ie_situacao = 'A'
		and	coalesce(fgl.nr_seq_cliente, NEW.nr_seq_cliente, 0) = coalesce(NEW.nr_seq_cliente, 0)
    		and	coalesce(fgl.nr_seq_func_item, NEW.nr_seq_func_item, 0) = coalesce(NEW.nr_seq_func_item, 0)
    		and	coalesce(fgl.cd_funcao, NEW.cd_funcao, 0) = coalesce(NEW.cd_funcao, 0)
    		and	coalesce(fgl.nr_seq_grupo_des_func, nr_seq_grupo_des_w, 0) = coalesce(nr_seq_grupo_des_w, 0)
    		and	coalesce(fgl.ie_classificacao, NEW.ie_classificacao, '0') = coalesce(NEW.ie_classificacao, '0')
		and	coalesce(fgl.nr_seq_classif_cad, NEW.nr_seq_classif_cad, 0) = coalesce(NEW.nr_seq_classif_cad, 0)
    		and 	coalesce(fgl.ie_origem, NEW.ie_origem, '0') = coalesce(NEW.ie_origem, '0')
    		and	obter_se_entre_horario(LOCALTIMESTAMP, coalesce(fgl.hr_inicio, LOCALTIMESTAMP), coalesce(fgl.hr_fim, LOCALTIMESTAMP)) = 'S'
		and	LOCALTIMESTAMP between coalesce(fgl.dt_inicio_vigencia, LOCALTIMESTAMP) and coalesce(fgl.dt_fim_vigencia, LOCALTIMESTAMP)
    		order by
    		        fgl.nr_seq_cliente,
    			fgl.nr_seq_func_item,
    			fgl.cd_funcao,
    			fgl.nr_seq_grupo_des_func,
			fgl.nr_seq_classif_cad,
			fgl.ie_classificacao,
			fgl.ie_origem,
			fgl.hr_inicio,
			fgl.hr_fim) x LIMIT 1;

	if (nr_seq_grupo_loc_w is not null) then
		NEW.nr_seq_grupo_des := nr_seq_grupo_loc_w;
	else
		NEW.nr_seq_grupo_des := nr_seq_grupo_des_w;
	end if;

	end;
end if;

if (	TG_OP = 'UPDATE'
	and	ie_base_philips_w = 'S'
	and	NEW.nr_seq_ordem_serv_pai is not null) then
	BEGIN
		if (		(NEW.ie_status_ordem = 3 and OLD.ie_status_ordem <> NEW.ie_status_ordem)
			or (NEW.nr_seq_estagio = 9 and OLD.nr_seq_estagio <> NEW.nr_seq_estagio)) then
			BEGIN
			
				/*Verifica se existe hist?o do tipo Code Review*/

				select	count(1)
				into STRICT 	qt_hist_code_review_w
				from	man_ordem_serv_tecnico
				where	nr_seq_tipo = 163
				and	nr_seq_ordem_serv = NEW.nr_sequencia;
				
				select	count(1)
				into STRICT	qt_ativ_programacao_w
				from	man_ordem_serv_ativ
				where	nr_seq_funcao in (1288,11,551)
				and	nr_seq_ordem_serv = NEW.nr_sequencia;

				if (qt_ativ_programacao_w > 0) and (qt_hist_code_review_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(458500); /*Aten?! Para cada atividade de programa? deve existir um hist?o de "Aprova? de Code Review"*/
				end if;

				if (phi_ordem_servico_pck.get_exige_hist_teste(NEW.nr_sequencia, 'P', 'S', NEW.ie_plataforma) = 'S') then	/* Programmer test validation */
					CALL wheb_mensagem_pck.exibir_mensagem_abort(1196495);
				elsif (phi_ordem_servico_pck.get_exige_hist_teste(NEW.nr_sequencia, 'A', 'S', NEW.ie_plataforma) = 'S') then	/* Analyst test validation */
					CALL wheb_mensagem_pck.exibir_mensagem_abort(1196498);
				end if;

				if (	phi_is_base_philips	= 'S'
					and	NEW.nr_seq_estagio	= 9
					and	NEW.ie_origem_os	= 1) then
					NEW.dt_fim_real := LOCALTIMESTAMP;
					NEW.ie_status_ordem := '3';
				end if;

			end;
		end if;

	end;
else
	BEGIN
	
		if (	ie_base_philips_w = 'S'
			and	TG_OP = 'UPDATE'
			and (	OLD.nr_seq_origem is null and NEW.nr_seq_origem is not null
				or	OLD.nr_seq_origem is not null and NEW.nr_seq_origem is null
				or	OLD.nr_seq_origem <> NEW.nr_seq_origem)
			) then
			BEGIN
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1099802);
			end;
		end if;

		select	max(cd_setor_atendimento)
		into STRICT	cd_setor_atendimento_w
		from 	usuario
		where	nm_usuario	= NEW.nm_usuario;

		ie_gerar_grupo_des_w	:= coalesce(Obter_Valor_Param_Usuario(299,228,Obter_Perfil_Ativo,NEW.nm_usuario,0),'S');
		ie_limpar_data_real_reab_w	:= coalesce(Obter_Valor_Param_Usuario(299,343,Obter_Perfil_Ativo,NEW.nm_usuario,0),'S');

		if (nr_seq_pendencia_w > 0) and (NEW.dt_fim_previsto is not null) then
			BEGIN
			if (TG_OP = 'INSERT') then
				BEGIN
				update	proj_ata_pendencia a
				set	a.dt_repactuada 	= NEW.dt_fim_previsto,
					a.nm_usuario	= NEW.nm_usuario,
					a.dt_atualizacao 	= LOCALTIMESTAMP
				where	a.nr_sequencia	= nr_seq_pendencia_w;
				end;
			elsif (TG_OP = 'UPDATE') and (OLD.dt_fim_previsto <> NEW.dt_fim_previsto) then
					BEGIN
					update	proj_ata_pendencia a
					set	a.dt_repactuada	= NEW.dt_fim_previsto,
						a.nm_usuario	= NEW.nm_usuario,
						a.dt_atualizacao	= LOCALTIMESTAMP
					where	a.nr_sequencia	= nr_seq_pendencia_w;	
					end;
			end if;
			end;
		end if;


		if (TG_OP = 'UPDATE') and (NEW.cd_funcao = 982) and (OLD.ie_status_ordem <> NEW.ie_status_ordem) then
			
			if (NEW.ie_status_ordem = 1) then
				ie_status_w := 'B';
			elsif (NEW.ie_status_ordem = 2) then
				ie_status_w := 'E';	
			elsif (NEW.ie_status_ordem = 3) then
				ie_status_w := 'F';		
			end if;	
			
			update 	pcs_agenda_atividades
			set	ie_status = ie_status_w
			where	nr_ordem_servico = NEW.nr_sequencia;
				
		end if;

		if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
			goto Final;
		end if;

		/*Cliente teste
		Ok cliente encerrado
		Aguardando informa?s do cliente
		testes
		testes aguardando vers?o


		Eliminar as atividades previstas futuras. 
		*/
		--Bloqueio para n?o permitir abrir ORdem de Servi?com a localiza? do cliente, quando o usu?o for do desenvolvimento
		if	((ie_base_corp_w = 'S') and (NEW.nr_seq_localizacao <> coalesce(OLD.nr_seq_localizacao,-1))) then
			SELECT count(*)
			into STRICT 	qt_registro_w
			FROM USUARIO_GRUPO_DES Y
			WHERE Y.NM_USUARIO_GRUPO = NEW.nm_usuario_nrec;
			
			if (qt_registro_w > 0) then
				SELECT 	count(*)
				into STRICT	qt_registro_w
				FROM 	man_localizacao z
				WHERE 	ie_terceiro = 'S'
				and		z.nr_sequencia = NEW.nr_seq_localizacao;
				
				if (qt_registro_w > 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(1024347);
				end if;
			end if;
		end if;


		if (ie_base_corp_w = 'S') and (NEW.nr_seq_estagio <> OLD.nr_seq_estagio) and (NEW.nr_seq_estagio in (2,9,41,791,1071,1511)) and (NEW.ie_origem_os <> '2') then /*n?o fazer para iniciativas do BSC na corp - OS429191*/
			BEGIN

			select	count(*)
			into STRICT	qt_existe_w
			from	man_ordem_ativ_prev
			where 	nr_seq_ordem_serv		= NEW.nr_sequencia
			and	dt_prevista		>= trunc(LOCALTIMESTAMP + interval '1 days');

			if (qt_existe_w > 0) then
				delete	FROM man_ordem_ativ_prev a
				where	nr_seq_ordem_serv		= NEW.nr_sequencia
				and	dt_prevista		>= trunc(LOCALTIMESTAMP + interval '1 days')
				and	not exists (SELECT 1
					from MAN_ORDEM_SERV_ATIV x
					where x.NR_SEQ_ATIV_PREV = a.nr_sequencia);
			end if;
			end;
		end if;

		if (ie_base_corp_w = 'S') and (NEW.nr_seq_estagio <> OLD.nr_seq_estagio) and (NEW.nr_seq_severidade = 1) then
		BEGIN
			select 	ie_acao
			into STRICT	ie_acao_w
			from   	man_estagio_processo
			where  	nr_sequencia = NEW.nr_seq_estagio;

			if (ie_acao_w = 2) then

				if (NEW.nr_seq_severidade_wheb is null) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(1023603);
				end if;

			end if;
		end;
		end if;

		if	(OLD.nr_seq_severidade_wheb = 1 AND NEW.nr_seq_severidade_wheb <> OLD.nr_seq_severidade_wheb) then

			open c04;
			loop
			fetch c04 into	
				nm_usuario_email_w,
				ds_usu_mail_w;
			EXIT WHEN NOT FOUND; /* apply on c04 */
				BEGIN
					if (ds_usu_mail_w is not null) then
						CALL enviar_email('Service order severity changed', 'Service order ' || NEW.nr_sequencia || 'severity changed', 'support.informatics@philips.com',
						ds_usu_mail_w, 'TASY', 'A');
					end if;
				end;
			end loop;
			close c04;
		end if;

		if (ie_base_corp_w = 'S') and (NEW.ie_plataforma is null) and (NEW.nr_seq_localizacao is not null) then
			

			if (NEW.cd_funcao in (2314,2815)) then /*CPOE ou Manchester na opera?*/
				NEW.ie_plataforma	:= 'H';
			elsif	((UPPER(NEW.ds_dano) like '%HTML%') or (UPPER(NEW.ds_dano_breve) like '%HTML%')) then
				NEW.ie_plataforma	:= 'H';
			elsif	((UPPER(NEW.ds_dano) like '%JAVA%') or (UPPER(NEW.ds_dano_breve) like '%JAVA%')) then
				NEW.ie_plataforma	:= 'S';
			elsif (ie_delphi_w = 'S') and (ie_java_w = 'N') and (ie_html5_w = 'N') then
				NEW.ie_plataforma	:= 'D';
			elsif (ie_delphi_w = 'N') and (ie_java_w = 'S') and (ie_html5_w = 'N') then
				NEW.ie_plataforma	:= 'S';
			elsif (ie_delphi_w = 'N') and (ie_java_w = 'N') and (ie_html5_w = 'S') then
				NEW.ie_plataforma	:= 'H';
			elsif (NEW.nr_seq_grupo_des is not null) then
				select	max(nr_seq_gerencia)
				into STRICT	nr_seq_gerencia_w
				from	grupo_desenvolvimento
				where	nr_sequencia	= NEW.nr_seq_grupo_des;

				if (nr_seq_gerencia_w in (82,86)) then /*ger?ncias do HTML5*/
					NEW.ie_plataforma	:= 'H';
				end if;
			end if;
		end if;

		if (ie_base_corp_w = 'S') and (NEW.NR_SEQ_ESTAGIO in (4,731,732,761,131,31)) and (NEW.NR_GRUPO_TRABALHO not in (132,72)) then
			NEW.NR_GRUPO_TRABALHO	:= 2;
			NEW.NR_GRUPO_PLANEJ		:= 2;
		end if;

		select	max(nr_seq_gerencia_sup)
		into STRICT	nr_seq_gerencia_sup_w
		from	grupo_suporte
		where	nr_sequencia = NEW.nr_Seq_grupo_sup;

		if (ie_base_corp_w = 'S') and (verifica_se_estagio_nv2(NEW.NR_SEQ_ESTAGIO) = 'S') and (nr_seq_gerencia_sup_w in (5,58)) and (NEW.nr_seq_estagio <> OLD.nr_seq_estagio) then
			NEW.NR_GRUPO_TRABALHO	:= 262;
			NEW.NR_GRUPO_PLANEJ		:= 2;
		end if;

		if (ie_base_corp_w = 'S') and (NEW.nr_seq_estagio <> coalesce(OLD.nr_seq_estagio,0)) then
			
			if (NEW.nr_seq_estagio = 9) then
				NEW.dt_fim_real := LOCALTIMESTAMP;
				NEW.ie_status_ordem := '3';
			end if;

			-- Edgar 13/10/2009, verificar se a OS foi para desenvolvimento
			if (OLD.nr_seq_estagio not in (4,731,732,741,261)) and (NEW.nr_seq_estagio in (4,731,732,741,261)) then
				NEW.DT_ULT_ACESSO_LIDER	:= null;
			end if;

			if (NEW.nr_seq_estagio = 151 ) then /*Retorno cliente*/
				BEGIN
				if (NEW.ie_classificacao in ('T','S')) then /*Solicita? / Sugest?o*/
					select 	max(nr_seq_estagio)
					into STRICT	nr_seq_estagio_w
					from   	man_ordem_serv_estagio c
					where  	c.nr_seq_ordem	= NEW.nr_sequencia
					and    	c.nr_sequencia	=	(SELECT max(a.nr_sequencia)
									from   	man_ordem_serv_estagio	a,
										man_estagio_processo	b
									where	a.nr_seq_ordem	= c.nr_seq_ordem
									and	a.nr_seq_estagio	= b.nr_sequencia
									and	b.ie_desenv	= 'S');
				
					-- Incluido begin-exception devido a OS 834422, pois a OS 821521 n?o havia grupo de desenvolvimento.
					BEGIN
					select	b.nm_usuario_manutencao,
						b.nm_usuario_lider,
						b.nm_usuario_negonio,
						b.nr_seq_gerencia
					into STRICT	nm_usuario_manutencao_w,
						nm_usuario_lider_w,
						nm_usuario_negonio_w,
						nr_seq_gerencia_w
					from	grupo_desenvolvimento b
					where	b.nr_sequencia	= NEW.nr_seq_grupo_des;
					exception
					when others then
						nr_seq_gerencia_w		:= null;
						nm_usuario_negonio_w	:= null;
						nm_usuario_lider_w		:= null;
						nm_usuario_manutencao_w	:= null;
					end;
				
					select	count(*)
					into STRICT	qt_reg_w
					from	man_ordem_servico_exec
					where	nr_seq_ordem	= NEW.nr_sequencia
					and	nm_usuario_exec 	= nm_usuario_manutencao_w;
					
					select	count(*)
					into STRICT	qt_reg_analista_w
					from	man_ordem_servico_exec
					where	nr_seq_ordem	= NEW.nr_sequencia
					and	nm_usuario_exec 	= nm_usuario_lider_w
					and	dt_fim_execucao is null;
					
					if (qt_reg_analista_w = 0) then
						select	count(*)
						into STRICT	qt_reg_analista_w
						from	man_ordem_servico_exec
						where	nr_seq_ordem	= NEW.nr_sequencia
						and	nm_usuario_exec	= nm_usuario_negonio_w
						and	dt_fim_execucao is null;
					end if;
					
					if (qt_reg_analista_w = 0) and (nr_seq_gerencia_w <> 3) then /*S?ve voltar para o analista de manuten? se n?o estiver sendo tratada pelo analista de neg?s e nem o de sistemas*/
						if (qt_reg_w > 0) then
							update	man_ordem_servico_exec a
							set	a.dt_fim_execucao 	 = NULL
							where	a.nr_seq_ordem	= NEW.nr_sequencia
							and	a.nm_usuario_exec 	= nm_usuario_manutencao_w;
						else
							if (coalesce(nm_usuario_manutencao_w,'X') <> 'X') then
								insert into man_ordem_servico_exec(nr_sequencia,
									nr_seq_ordem,
									dt_atualizacao,
									nm_usuario,
									nm_usuario_exec,
									qt_min_prev,
									nr_seq_tipo_exec,
									dt_atualizacao_nrec,
									nm_usuario_nrec)
								values (nextval('man_ordem_servico_exec_seq'),
									NEW.nr_sequencia,
									LOCALTIMESTAMP,
									NEW.nm_usuario,
									nm_usuario_manutencao_w,
									15,
									1,
									LOCALTIMESTAMP,
									NEW.nm_usuario);
							end if;
						end if;
					end if;
					
					if (nr_seq_estagio_w is not null )  then
						select 	count(*)
						into STRICT	qt_reg_w
						from   	man_estagio_processo
						where	ie_tecnologia	= 'S'
						and    	nr_sequencia	= nr_seq_estagio_w;
						
						if (qt_reg_w > 0) then
							/*Tecnologia*/

							NEW.nr_seq_estagio := 131;
						else
							/*Desenvolvimento Retorno Cliente*/

							NEW.nr_seq_estagio := 1051;--4;
						end if;
					end if;
				elsif (NEW.ie_classificacao = 'E') then /*Erro sempre voltar para o ?ltimo grupo - suporte, tecnologia ou desenv - OS405979*/
					BEGIN
					select 	max(nr_seq_estagio)
					into STRICT	nr_seq_estagio_w
					from   	man_ordem_serv_estagio c
					where  	c.nr_seq_ordem	= NEW.nr_sequencia
					and    	c.nr_sequencia	=	(SELECT	max(a.nr_sequencia)
									from   	man_ordem_serv_estagio a,
										man_estagio_processo b
									where	a.nr_seq_ordem		= c.nr_seq_ordem
									and	a.nr_seq_estagio		= b.nr_sequencia
									and	b.ie_aguarda_cliente	= 'N'
									and	b.nr_sequencia not in (151,511,9,261,371));
					if (nr_seq_estagio_w is not null) then
						NEW.nr_seq_estagio	:= nr_seq_estagio_w;
					end if;
					end;
				end if;
						
				--Verifica se existe algum acordo para est?S, caso exista , define data de retono do cliente no acordo
				select	max(nr_sequencia)
				into STRICT	nr_seq_des_acordo_os_w
				from	desenv_acordo_os
				where	nr_seq_ordem_servico = NEW.nr_sequencia;
				
					if (nr_seq_des_acordo_os_w is not null) then
						update	desenv_acordo_os
						set	dt_retorno_cli = LOCALTIMESTAMP
						where	nr_sequencia = nr_seq_des_acordo_os_w;
					end if;
				
				end;					
			else
				SELECT 	COUNT(*)
				into STRICT	qt_reg_w
				FROM   	man_estagio_processo
				WHERE  	ie_desenv = 'S'
				AND    	nr_sequencia = NEW.nr_seq_estagio
				AND	not exists ( 	SELECT	1
							from	man_estagio_processo
							where	ie_desenv = 'S'
							and	nr_sequencia = OLD.nr_seq_estagio);
				
				if ( qt_reg_w > 0 ) then

					select	count(*)
					into STRICT	qt_reg_w
					from 	man_estagio_processo
					where	ie_tecnologia = 'S'
					and 	nr_sequencia = NEW.nr_seq_estagio;

					if ( qt_reg_w > 0 ) then
						ie_estagio_new_tec_w	:= 1;
					end if;

					SELECT 	max(nr_seq_estagio)
					into STRICT	nr_seq_estagio_w
					FROM   	man_ordem_serv_estagio c
					WHERE  	c.nr_seq_ordem = NEW.nr_sequencia
					AND    	c.nr_sequencia = (
						SELECT MAX(a.nr_sequencia)
						FROM   	man_ordem_serv_estagio a,
							man_estagio_processo b
						WHERE   a.nr_seq_ordem = c.nr_seq_ordem
						AND	a.nr_seq_estagio = b.nr_sequencia
						AND	b.ie_desenv = 'S');
				
					if ( nr_seq_estagio_w is not null )  then
						
						SELECT 	COUNT(*)
						into STRICT	qt_reg_w
						FROM   	man_estagio_processo
						where	ie_tecnologia = 'S'
						AND    	nr_sequencia = nr_seq_estagio_w;		
					
						if (qt_reg_w > 0 ) then
							ie_estagio_old_tec_w := 1;
						end if;

						/*Verificar se setor do usu?o ?esenvolvimento*/

						select	count(*)
						into STRICT	qt_reg_w
						from	usuario
						where	cd_setor_atendimento in (2,16)
						and	nm_usuario = NEW.nm_usuario;
						
						if (qt_reg_w > 0 ) then
							if ( ie_estagio_old_tec_w > 0 ) and ( ie_estagio_new_tec_w = 0 ) and (NEW.nm_usuario <> 'Tasy') then	/*Anderson 25/10/2010 - OS254470 - Para n?o bloquear a job de encerramento autom?co*/
								CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(173235);
							elsif ( ie_estagio_old_tec_w = 0 ) and ( ie_estagio_new_tec_w > 0 ) and (NEW.nm_usuario <> 'Tasy') then	/*Anderson 25/10/2010 - OS254470 - Para n?o bloquear a job de encerramento autom?co*/
								CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(173236);
							end if;
						end if;
					end if;
				end if;	
			end if;
		end if;
			

		if (ie_base_corp_w = 'S') and (OLD.nr_seq_severidade_wheb != NEW.nr_seq_severidade_wheb)	and (NEW.nr_seq_severidade_wheb in (1, 6))	and (OLD.dt_teste_negocio is null)	and (NEW.ie_classificacao in ('S','E')) then /*Solicita? / Defeito*/
			NEW.dt_teste_negocio := LOCALTIMESTAMP;
		end if;

		if (ie_base_corp_w = 'S') and
			((OLD.nr_seq_severidade_wheb != NEW.nr_seq_severidade_wheb)	and (NEW.nr_seq_severidade_wheb not in (1, 6)))	or (NEW.ie_classificacao not in ('S','E')) then /*Solicita? / Defeito*/
			NEW.dt_teste_negocio := null;
		end if;
			
		if (ie_base_corp_w = 'S') and (NEW.nr_seq_estagio in (2,9,1511)) then
			select	count(*)
			into STRICT	qt_existe_orc_w
			from	man_ordem_servico_orc
			where	nr_seq_ordem = NEW.nr_sequencia
			and	dt_aprovacao is null
			and	dt_reprovacao is null;

			if (qt_existe_orc_w > 0) then
				CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(303144);
			end if;
		end if;

		if	((TG_OP = 'UPDATE') and (ie_base_corp_w = 'S') and (OLD.nr_seq_estagio is not null) and (NEW.nr_seq_estagio <> OLD.nr_seq_estagio) and (upper(NEW.nm_usuario) <> 'WEBSERVICE')) then

				select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
				into STRICT	ie_ult_estag_cliente_w
				from	man_estagio_processo
				where	ie_aguarda_cliente	= 'S'
				and		nr_sequencia 		= NEW.nr_seq_estagio;

				select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
				into STRICT	ie_info_relavantes_w
				from	man_ordem_serv_tecnico	a
				where	a.nr_seq_ordem_serv		=	NEW.nr_sequencia
				and 	a.dt_liberacao is not null
				and		a.NM_USUARIO	<> 	'WebService'
				and 	a.nr_seq_tipo in (1, 139);	-- 1 = informacoes relevantes. 139 = Infra - Informacoes Relevantes da OS
				if (ie_info_relavantes_w = 'N' and ie_ult_estag_cliente_w = 'S') then
					CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(1141861);
				end if;			
		end if;

		if (TG_OP = 'UPDATE') and (ie_base_corp_w = 'S') and (NEW.dt_ordem_servico > to_date('11/05/2016','dd/mm/yyyy')) and --Somente ir?edir aprova? de code review se a OS foi criada DEPOIS que foi implementado essa rotina de Code Review (11/05/2016) . Mais detalhes verificar OS: 1402146
			(((NEW.nr_seq_estagio in (2,791)) and (NEW.nr_seq_estagio <> OLD.nr_seq_estagio)) or
			(NEW.ie_status_ordem = 3 AND OLD.ie_status_ordem <> NEW.ie_status_ordem)) and (upper(NEW.nm_usuario) <> 'WEBSERVICE') then --Est?o "Cliente (Teste)", "Testes" ou encerramento da OS.
			BEGIN
			/* Verifica se existe atividade de programa? para esta OS */

			select	count(1)
			into STRICT	qt_ativ_programacao_w
			from	man_ordem_serv_ativ
			where	nr_seq_funcao in (1288,11,551)
			and	nr_seq_ordem_serv = NEW.nr_sequencia;

			if (qt_ativ_programacao_w > 0)then
				BEGIN
				/*Verifica se existe hist?o do tipo Code Review*/

				select	count(1)
				into STRICT 	qt_hist_code_review_w
				from	man_ordem_serv_tecnico
				where	nr_seq_tipo = 163
				and	nr_seq_ordem_serv = NEW.nr_sequencia;
				
				if (qt_hist_code_review_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(458500); /*Aten?! Para cada atividade de programa? deve existir um hist?o de "Aprova? de Code Review"*/
				end if;
				end;
			end if;
			end;
		end if;

		if (phi_is_base_philips = 'S') and (NEW.ie_status_ordem = 3) and (OLD.ie_status_ordem <> NEW.ie_status_ordem) and (upper(NEW.nm_usuario) <> 'WEBSERVICE') then
			BEGIN

			if (phi_ordem_servico_pck.get_exige_hist_teste(NEW.nr_sequencia, 'P', 'S', NEW.ie_plataforma) = 'S') then	/* Programmer test validation */
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1196495);
			elsif (phi_ordem_servico_pck.get_exige_hist_teste(NEW.nr_sequencia, 'A', 'S', NEW.ie_plataforma) = 'S') then	/* Analyst test validation */
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1196498);
			end if;

			end;
		end if;

		if (ie_base_corp_w = 'S') and (NEW.ie_grau_satisfacao in ('P','R')) and (NEW.nr_seq_justif_grau_satisf is null) and (NEW.ie_status_ordem = 3) and (upper(NEW.nm_usuario) <> 'WEBSERVICE') then
			CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(184368);
		end if;

		BEGIN
		if (phi_is_base_philips = 'S' and
			coalesce(nr_seq_skill_w,0) > 0) then
			
				select	max(ie_desenv)
				into STRICT	ie_desenv_w
				from	man_estagio_processo
				where	nr_sequencia = NEW.nr_seq_estagio;
				
				if (ie_desenv_w = 'S') then
					delete
					from	man_ordem_serv_skill
					where	nr_seq_ordem_serv = NEW.nr_sequencia;
					
					insert into man_ordem_serv_skill(
						nr_sequencia,
						nr_seq_skill,
						nr_seq_ordem_serv,
						nm_usuario,
						dt_atualizacao)
					values (	nextval('man_ordem_serv_skill_seq'),
						nr_seq_skill_w,
						NEW.nr_sequencia,
						'Tasy',
						LOCALTIMESTAMP);	
			end if;
		end if;
		exception when others then
			null;
		end;

		if (NEW.nr_seq_grupo_sup is null) and (NEW.cd_funcao is not null) then
			BEGIN
			select	x.nr_seq_grupo,
				x.nm_usuario_lider
			into STRICT	nr_seq_grupo_sup_w,
				nm_usuario_lider_sup_w
			from (SELECT	fgs.nr_seq_grupo,
					gs.nm_usuario_lider
				from	grupo_suporte gs,
					funcao_grupo_sup fgs
				where	fgs.nr_seq_grupo = gs.nr_sequencia
				and	fgs.cd_funcao = NEW.cd_funcao
				and	gs.ie_situacao = 'A'
				order by
					fgs.nr_seq_grupo) x LIMIT 1;
			exception
			when others then
				nr_seq_grupo_sup_w := null;
				nm_usuario_lider_sup_w := null;
			end;

			NEW.nr_seq_grupo_sup := nr_seq_grupo_sup_w;

			/**
			* Routine to change the support group if there is a
			* mirror group registered for the SO localization
			* country.
			*/
			select 	min(a.nr_seq_grupo_sup_esp)
			into STRICT 	nr_seq_grupo_sup_esp_w
			from 	grupo_espelho a,
				pessoa_juridica b,
				man_localizacao c
			where 	a.nr_seq_grupo_sup 	= NEW.nr_seq_grupo_sup
			and 	a.ie_situacao 		= 'A'
			and 	a.nr_seq_pais 		= b.nr_seq_pais
			and 	b.cd_cgc 		= c.cd_cnpj
			and 	c.nr_sequencia 		= NEW.nr_seq_localizacao;
			
			if (nr_seq_grupo_sup_esp_w is not null) then
				select 	max(nr_sequencia),
					max(nm_usuario_lider)
				into STRICT	NEW.nr_seq_grupo_sup,
					nm_usuario_lider_sup_w
				from 	grupo_suporte
				where 	nr_sequencia = nr_seq_grupo_sup_esp_w;
			end if;
		end if;

                if (ie_base_corp_w = 'S') and (NEW.NR_SEQ_ESTAGIO in (4,731,732,131,1051, 2112, 1532,1533,1534,1191,1274,2143)) and (OLD.nr_seq_estagio in (2,3,31,41,71,121,141,151,152,201,231,232,311,791,811,861,1371,1431,1061,1071,1234,2113)) then
                        ie_stage_to_desenv_w := 'S';
                end if;

		if (ie_base_corp_w = 'S') and (coalesce(Obter_Valor_Param_Usuario(299,137,Obter_Perfil_Ativo,NEW.nm_usuario,0),'S') = 'N') and (NEW.ie_classificacao = 'D') and (ie_stage_to_desenv_w = 'S') then
			CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(173238);
		end if;
                
                if (ie_base_corp_w = 'S') and (coalesce(obter_valor_param_usuario(297,109,obter_perfil_ativo,NEW.nm_usuario,0),'S') = 'N') and (NEW.ie_classificacao = 'E') and (ie_stage_to_desenv_w = 'S') then
                        CALL wheb_mensagem_pck.exibir_mensagem_abort(1154441);
                end if;

		if (TG_OP = 'UPDATE') and (ie_base_corp_w = 'S') and (NEW.ie_status_ordem = 3) and (NEW.ie_status_ordem <> OLD.ie_status_ordem) then
			BEGIN
			NEW.dt_fim_real := LOCALTIMESTAMP;
			
			if (OLD.ie_status_ordem <> NEW.ie_status_ordem) and (NEW.ie_tipo_ordem in (8,9)) then
				BEGIN
				select	count(*)
				into STRICT	qt_existe_w
				from	man_ordem_serv_tecnico
				where	nr_seq_tipo = 88
				and	nr_seq_ordem_serv = NEW.nr_sequencia;
				
				if (qt_existe_w = 0) then
					CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(186637);
				end if;
				end;
			end if;
			end;
		end if;

		if (OLD.IE_STATUS_ORDEM = 3) and (NEW.ie_status_ordem <> 3 ) and (ie_limpar_data_real_reab_w = 'S') then
			NEW.dt_fim_real := null;
		end if;

		if (TG_OP = 'INSERT') and (ie_base_corp_w = 'S') and (NEW.cd_funcao = -3000) then
			NEW.nr_seq_estagio := 886;
		end if;

		if (NEW.nr_seq_estagio = 231) and /* Aguardando Triagem*/
			(coalesce(nm_usuario_lider_sup_w,'X') <> 'X') and (NEW.ie_classificacao = 'D') and (NEW.nm_usuario_exec is null) then
			NEW.nm_usuario_exec := nm_usuario_lider_sup_w;
		end if;

		if	((TG_OP = 'INSERT') and ((ie_base_corp_w = 'S') or (ie_base_wheb_w = 'S'))) or
                        ((ie_base_corp_w = 'S') and (TG_OP = 'UPDATE') and (upper(NEW.nm_usuario) = 'WEBSERVICE') and (OLD.nr_seq_classif_cad is null) and (NEW.nr_seq_classif_cad is not null)) then
			BEGIN
			if (coalesce(NEW.nr_seq_severidade,0) = 0) then
				NEW.nr_seq_severidade := null;
			end if;
			
			select	max(nr_seq_gerencia)
			into STRICT	nr_seq_gerencia_w
			from	grupo_desenvolvimento
			where	nr_sequencia	= NEW.nr_seq_grupo_des;
			
			OPEN c03;
			LOOP
			FETCH C03 INTO
				ie_recebe_desenv_w,
				ie_sms_w,
				cd_pessoa_adic_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
			END LOOP;
			CLOSE C03;
			
			if (coalesce(ie_sms_w,'N') = 'N') then
				OPEN c05;
				LOOP
				FETCH C05 INTO
					ie_sms_w,
					cd_pessoa_adic_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
				END LOOP;
				CLOSE C05;
			end if;
			
			select	max(replace(replace(substr(elimina_caracteres_especiais(b.NR_DDI_CELULAR || b.NR_DDD_CELULAR || b.nr_telefone_celular),1,25),')',''),'(',''))
			into STRICT	nr_telefone_celular_w
			from	pessoa_fisica b,
				gerencia_wheb a
			where	b.cd_pessoa_fisica = a.cd_responsavel
			and	a.nr_sequencia = nr_seq_gerencia_w;
			
			/*Defeitos de HTML5 continuar?o indo para o Desenvolvimento at?stabiliza? do produto*/

			if (coalesce(ie_recebe_desenv_w,'N') = 'S') and (NEW.cd_funcao <> -3003) and					--Atualizacao da versao
				(NEW.cd_funcao <> -2999) and 					-- ICloud
				(NEW.nr_seq_equipamento <> 2897) and				--release testing
				(NEW.ds_dano_breve <> obter_desc_expressao(348229)) then	--OS de migracao
				NEW.nr_seq_estagio	:= 1051;				/*Aguardando triagem desenvolvimento*/
			end if;
			
			if (coalesce(ie_sms_w,'N') = 'S') and (coalesce(nr_telefone_celular_w, 'X') <> 'X') then
				BEGIN
				select	max(replace(replace(substr(elimina_caracteres_especiais(b.NR_DDI_CELULAR || b.NR_DDD_CELULAR || b.nr_telefone_celular),1,25),')',''),'(',''))
				into STRICT	nr_telefone_celular_adic_w
				from	pessoa_fisica b
				where	cd_pessoa_fisica = cd_pessoa_adic_w;

				if (coalesce(nr_telefone_celular_adic_w,'X') <> 'X') then
					
					nr_telefone_celular_adic_w := ';' || nr_telefone_celular_adic_w;
				
				end if;

				ds_mensagem_sms_w := 'Foi aberta uma nova ordem de servi?N? ' || NEW.nr_sequencia || '.';
				
				CALL enviar_sms_ordem_servico('SMS-OS', nr_telefone_celular_w || nr_telefone_celular_adic_w, ds_mensagem_sms_w, NEW.nr_sequencia, 'Tasy');
				
				exception
				when others then
					null;
				end;
			end if;

			if (NEW.cd_funcao in (20000, 20001)) then
				NEW.nr_seq_estagio := 231;
			end if;
		end;
		end if;

		if (	TG_OP = 'INSERT'
			and	ie_base_philips_w = 'S') then
                        
                        if (NEW.ie_classificacao = 'E' and (upper(NEW.nm_usuario) = 'WEBSERVICE')) then
                                BEGIN
                                        NEW.nr_seq_severidade := man_get_severity(NEW.ie_prioridade);
                                        NEW.nr_seq_severidade_wheb := NEW.nr_seq_severidade;
                                end;
                        end if;

			if (	NEW.nr_seq_severidade_wheb is null
				and	NEW.nr_seq_severidade is not null
				and	NEW.ie_origem_os = 1) then
				BEGIN
					NEW.nr_seq_severidade_wheb := NEW.nr_seq_severidade;
				exception
				when others then
					NEW.nr_seq_severidade_wheb := null;
				end;
			elsif (	NEW.nr_seq_severidade_wheb is null
				and	NEW.ie_origem_os = 1) then
				BEGIN
					if (NEW.ie_classificacao = 'S') then
						BEGIN
							NEW.nr_seq_severidade_wheb := 7;
						end;
					elsif (NEW.ie_classificacao = 'E') then
						BEGIN
							NEW.nr_seq_severidade_wheb := 5;
						end;
					end if;					
				end;
			end if;
		end if;
		
		if	(TG_OP = 'UPDATE' AND (ie_base_corp_w = 'S' or ie_base_wheb_w = 'S')) then
			BEGIN
				if (NEW.ie_classificacao = 'E'
					and	NEW.nr_seq_severidade_wheb = 7) then
					BEGIN
						CALL wheb_mensagem_pck.exibir_mensagem_abort(1076429);
					end;
				end if;
			end;
		end if;

		if (TG_OP = 'INSERT') and		/*Solicita? OS330098 - OS's do HSC ser?o sempre direcionadas ao desenvolvimento e sempre ter?o o usu?o da Bruna*/
			(ie_base_corp_w = 'S') and (NEW.ie_classificacao = 'E') and (NEW.nr_seq_localizacao = 15) and (NEW.ds_dano_breve <> 'Migra?: necessidade de revis?o dos projetos/componentes.') then
			BEGIN
			NEW.nr_seq_estagio	:= 1051;	/*Aguardando triagem desenvolvimento*/
			
			if (NEW.dt_ordem_servico < to_date(to_char(NEW.dt_ordem_servico,'dd/mm/yyyy') || ' 08', 'dd/mm/yy hh24')) or (NEW.dt_ordem_servico > to_date(to_char(NEW.dt_ordem_servico,'dd/mm/yyyy') || ' 18', 'dd/mm/yy hh24')) then
				BEGIN
				ds_mensagem_sms_w := 'Foi aberta uma nova ordem de servi?de Erro N? ' || NEW.nr_sequencia || '.';
				CALL enviar_sms_ordem_servico('SMS-OS', '4791916265', ds_mensagem_sms_w, NEW.nr_sequencia, 'Tasy');
				exception
				when others then
					null;
				end;
			end if;
			end;
		end if;

		if (ie_base_corp_w = 'S') and (NEW.ie_classificacao = 'E') and (NEW.ie_prioridade_sup is null) then /*Anderson  OS223881 - Conforme IT suporte*/
			NEW.ie_prioridade_sup := 10;
		end if;

		if ( ie_base_philips_w = 'S' ) and ( NEW.ie_classificacao_cliente is null) and ( NEW.ie_classificacao is not null) then
			NEW.ie_classificacao_cliente := NEW.ie_classificacao;
		end if;
		
		if (ie_base_philips_w = 'S') and (NEW.ie_origem_os = 1) and (NEW.ie_tipo_ordem <> 2) then		/*S?ualizar quando n?for preventiva*/
			ie_tipo_ordem_w := obter_ie_tipo_os(NEW.ie_origem, NEW.ie_classificacao, NEW.ie_classificacao_cliente, NEW.nr_seq_localizacao, NEW.nr_seq_equipamento, NEW.dt_ordem_servico);
			NEW.ie_tipo_ordem := coalesce(ie_tipo_ordem_w, NEW.ie_tipo_ordem);
		end if;
		
		/*Consistencia ao tirar a Ordem de Servico do estagio Tecnologia*/

		if ( ie_base_corp_w = 'S' ) then
			if ( OLD.nr_seq_estagio in (131,1532,1533,1534) ) and ( NEW.nr_seq_estagio not in (131,1532,1533,1534) ) then
				if (OLD.nr_seq_classif in (23,43)) then
					/*Tec -  Manutencao Componente - Estudo Viabilidade*/

					ds_retorno_w := verifica_historico_obrig(NEW.nr_sequencia,25) || ds_enter_w;
					/*Tec -  Manutencao Componente - Desenvolvimento*/

					ds_retorno_w := ds_retorno_w || verifica_historico_obrig(NEW.nr_sequencia,26) || ds_enter_w;
					/*Tec -  Manutencao Componente - Teste da aplicacao*/

					ds_retorno_w := ds_retorno_w || verifica_historico_obrig(NEW.nr_sequencia,27) || ds_enter_w;
				end if;
				/*Infraestrutura*/

				if (OLD.nr_seq_classif = 28) then
					open C02;
					loop
					fetch C02 into	
						nr_seq_ativ_exec_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						BEGIN
						case 	nr_seq_ativ_exec_w
							when	58 	then
								ds_retorno_w := ds_retorno_w || verifica_historico_obrig(NEW.nr_sequencia,78) || ds_enter_w;
							when	115 	then
								ds_retorno_w := ds_retorno_w || verifica_historico_obrig(NEW.nr_sequencia,81) || ds_enter_w;
							when	120 	then
								ds_retorno_w := ds_retorno_w || verifica_historico_obrig(NEW.nr_sequencia,80) || ds_enter_w;
							when	130 	then
								ds_retorno_w := ds_retorno_w || verifica_historico_obrig(NEW.nr_sequencia,84) || ds_enter_w;
							when	124 	then
								ds_retorno_w := ds_retorno_w || verifica_historico_obrig(NEW.nr_sequencia,79) || ds_enter_w;
							when	131 	then
								ds_retorno_w := ds_retorno_w || verifica_historico_obrig(NEW.nr_sequencia,82) || ds_enter_w;
							when	53 	then
								ds_retorno_w := ds_retorno_w || verifica_historico_obrig(NEW.nr_sequencia,85) || ds_enter_w;
							when	53 	then
								ds_retorno_w := ds_retorno_w || verifica_historico_obrig(NEW.nr_sequencia,86) || ds_enter_w;
						end case;
						end;
					end loop;
					close C02;
				end if;
				
				if (ds_retorno_w is not null) and (replace(ds_retorno_w,ds_enter_w,'') = '') then
					CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(229633,'DS_MENSAGEM='||ds_retorno_w);
					-- necessario ter um historico do tipo:'
				end	if;
						
			end if;
			
			if (NEW.nr_seq_estagio <> OLD.nr_seq_estagio) and
				((NEW.cd_funcao <> -3003 ) or (NEW.cd_funcao is null)) then /*Atualizacao de versao*/
			
				select	max(ie_tecnologia)
				into STRICT	ie_tecnologia_w
				from	man_estagio_processo
				where	ie_tecnologia = 'S'
				and	nr_sequencia = NEW.nr_Seq_estagio;
				
				select 	max(ie_desenv)
				into STRICT	ie_desenv_w
				from	man_estagio_processo
				where 	nr_sequencia = OLD.nr_seq_estagio
				and	ie_desenv = 'S'
				and	coalesce(ie_tecnologia,'N') = 'N';

				/*Verificar se setor do usuario desenvolvimento*/

				select	count(*)
				into STRICT	qt_reg_w
				from	usuario
				where	cd_setor_atendimento in (2,16)
				and	nm_usuario = NEW.nm_usuario;
				
				select 	max(ie_tecnologia)
				into STRICT	ie_tecnologia_old_w
				from	man_estagio_processo
				where 	nr_sequencia = OLD.nr_seq_estagio;
				
				if ( ie_tecnologia_w = 'S' ) and ( ie_desenv_w = 'S') and ( qt_reg_w > 0 ) and ( ie_tecnologia_old_w <> 'S') then
				
					select 	count(*)
					into STRICT	qt_reg_w
					from	man_ordem_serv_tecnico a
					where	a.nr_seq_ordem_serv = NEW.nr_sequencia
					and	a.nr_seq_tipo	= 76
					and (exists (SELECT 1
							from 	GRUPO_DESENVOLVIMENTO b
							where	b.nr_seq_gerencia not in (2,284,285)
							and	a.nm_usuario_lib = b.nm_usuario_lider)
						or exists (
							SELECT 1
							from	grupo_desenvolvimento b,
								grupo_Des_delegacao c
							where	b.nr_sequencia  = c.nr_seq_grupo_des
							and 	b.nr_seq_gerencia not in (2,284,285)
							and	c.nm_usuario_delegacao = a.nm_usuario_lib
							and	a.dt_historico between c.dt_inicio_vigencia and coalesce(c.dt_fim_vigencia,LOCALTIMESTAMP + interval '1 days'))
						);
					
					if (qt_reg_w = 0 ) then
						select	substr(obter_desc_expressao(cd_exp_tipo, ds_tipo),1,80)
						into STRICT	ds_tipo_w
						from	man_tipo_hist
						where	nr_sequencia = 76;
						CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(173240,'DS_TIPO='||ds_tipo_w||';');
					end if;
					
				end if;
				
				select	max(ie_desenv)
				into STRICT	ie_desenv_new_w
				from	man_estagio_processo
				where	ie_desenv = 'S'
				and	nr_sequencia = NEW.nr_Seq_estagio
				and	coalesce(ie_tecnologia, 'N') = 'N';
				
				select 	max(ie_tecnologia)
				into STRICT	ie_tecnologia_old_w
				from	man_estagio_processo
				where 	nr_sequencia = OLD.nr_seq_estagio
				and	ie_tecnologia = 'S';
				
				/*Verificar se setor do usuario tecnologia*/

				select	count(*)
				into STRICT	qt_reg_w
				from	usuario
				where	cd_setor_atendimento in (7)
				and	nm_usuario = NEW.nm_usuario;
				
				if ( ie_desenv_new_w = 'S' ) and ( ie_tecnologia_old_w = 'S') and ( qt_reg_w > 0 ) and ( NEW.ie_origem_os = 1 )	and ( NEW.cd_funcao <> -3001 )	then
				
					select 	count(*)
					into STRICT	qt_reg_w
					from	man_ordem_serv_tecnico a
					where	a.nr_seq_ordem_serv = NEW.nr_sequencia
					and	a.nr_seq_tipo	= 76
					and (exists (	SELECT	1
									from 	grupo_desenvolvimento b
									where	b.nr_seq_gerencia in (2,284,285)
									and	a.nm_usuario_lib = b.nm_usuario_lider)
						or exists (		SELECT 1
									from	grupo_desenvolvimento b,
										grupo_Des_delegacao c
									where	b.nr_sequencia  = c.nr_seq_grupo_des
									and	b.nr_seq_gerencia in (2,284,285)
									and	c.nm_usuario_delegacao = a.nm_usuario_lib
									and	a.dt_historico between c.dt_inicio_vigencia and coalesce(c.dt_fim_vigencia,LOCALTIMESTAMP + interval '1 days'))
						);
					
					if (qt_reg_w = 0 ) then
						select	substr(obter_desc_expressao(cd_exp_tipo, ds_tipo),1,80)
						into STRICT	ds_tipo_w
						from	man_tipo_hist
						where	nr_sequencia = 76;
						CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(738422,'DS_TIPO='||ds_tipo_w||';');
					end if;
					
				end if;
					
			end if;
			
			if ( NEW.nr_seq_estagio in (2,41,791)) and (OLD.nr_seq_classif = 43) then
				
				if (NEW.ie_componente is null ) then
					CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(173241);
				end if;
				
				/*Tec -  Manutencao Componente - Teste e Validacao pelos Grupos do Desenvolvimento*/

				open C01;
				loop
				fetch C01 into	
					ds_responsavel_teste_comp_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					BEGIN
					ds_responsaveis_teste_comp_w := ds_responsaveis_teste_comp_w || chr(13) || chr(10) ||  ds_responsavel_teste_comp_w;
					end;
				end loop;
				close C01;
				if (ds_responsaveis_teste_comp_w is not null ) then
					select	substr(obter_desc_expressao(cd_exp_tipo, ds_tipo),1,80)
					into STRICT	ds_tipo_w
					from	man_tipo_hist
					where	nr_sequencia = 30;
					CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(173242,'DS_TIPO='||ds_tipo_w||';DS_RESPONSAVEIS='||ds_responsaveis_teste_comp_w||';');
				end if;
			end if;
		end if;

		/* Francisco - 01/09/2010 - OS 244015 
		Tratei para sempre gravar o IE_ORIGEM_OS como "1 - Sistema Tasy" na base CORP
		Senao nao abre a funcao nova para o desenvolvimento */
		if (ie_base_corp_w = 'S') then
			/* Lydia Garcia - 14/10/2020 - OS 2191787 */

			if (NEW.cd_funcao is not null) then
				NEW.ie_origem_os	:= 1;
			end if;
			
			if (NEW.nr_seq_causa_rnc is not null) then
				BEGIN
					select	coalesce(max(ie_abrangencia), 'N')
					into STRICT	ie_abrangencia_w
					from	qua_nao_conform_causa
					where	nr_sequencia = NEW.nr_seq_causa_rnc;

					if (ie_abrangencia_w = 'S') then
						if (NEW.dt_conclusao_desejada is not null) and (NEW.dt_conclusao_desejada <> OLD.dt_conclusao_desejada) then
							update	qua_nao_conform_causa
							set	dt_prevista 	= NEW.dt_conclusao_desejada,
								dt_atualizacao	= LOCALTIMESTAMP,
								nm_usuario	= NEW.nm_usuario
							where	nr_sequencia	= NEW.nr_seq_causa_rnc;
						end if;
						
						if (NEW.dt_fim_real is not null) then
							update	qua_nao_conform_causa
							set	dt_realizacao 	= NEW.dt_fim_real,
								dt_atualizacao	= LOCALTIMESTAMP,
								nm_usuario	= NEW.nm_usuario
							where	nr_sequencia	= NEW.nr_seq_causa_rnc;
						end if;
					end if;
				end;
			end if;
		end if;

		ie_gerar_dt_fim_prev_sla_w := obter_param_usuario(299, 419, obter_perfil_Ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_gerar_dt_fim_prev_sla_w);
		ie_gerar_dt_inicio_prev_sla_w := obter_param_usuario(299, 529, obter_perfil_Ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_gerar_dt_inicio_prev_sla_w);
		ie_utiliza_sla_w := obter_param_usuario(299, 57, obter_perfil_Ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_utiliza_sla_w);

		select	max(nr_sequencia),
			max(nr_seq_sla_regra)
		into STRICT	nr_seq_sla_w,
			nr_seq_sla_regra_w
		from	man_ordem_serv_sla
		where	nr_seq_ordem	= NEW.nr_sequencia;	

		if (TG_OP = 'UPDATE') and (NEW.nr_seq_estagio <> OLD.nr_seq_estagio) then	/*Anderson 09/02/2011 - OS250441 - Se existir uma regra por est?o, atualiza para a nova regra*/
			BEGIN
			
			select	man_obter_regra_sla(	cd_estabelecimento_w,
							NEW.nm_usuario,NEW.ie_prioridade, NEW.ie_classificacao,
							NEW.nr_seq_localizacao, NEW.nr_grupo_trabalho, NEW.dt_ordem_servico, 
							NEW.dt_inicio_real, NEW.nr_seq_estagio, NEW.nr_seq_equipamento, NEW.nr_seq_classif, NEW.ie_parado)
			into STRICT	nr_seq_sla_regra_ww
			;
				
			if	(	/*Padr?o para os clientes*/
				(coalesce(nr_seq_sla_w,0) > 0) and (coalesce(nr_seq_sla_regra_w,0) > 0) and (coalesce(nr_seq_sla_regra_ww,0) > 0) and (coalesce(nr_seq_sla_regra_w,0) <> coalesce(nr_seq_sla_regra_ww,0))
				) OR
				(	/*Para o comercial, sempre que voltar de um est?o para um est?o com regra SLA, limpar a data real e come? a contar novamente*/
				(coalesce(nr_seq_sla_w,0) > 0) and (ie_base_corp_w = 'S') and (coalesce(nr_seq_sla_regra_ww,0) > 0) and (NEW.nr_grupo_trabalho in (42,102))
				) then
				NEW.dt_inicio_real := null;
			
				CALL Man_atualizar_SLA_OS(nr_seq_sla_w, cd_estabelecimento_w,
						NEW.nm_usuario,NEW.ie_prioridade, NEW.ie_classificacao,
						NEW.nr_seq_localizacao, NEW.nr_grupo_trabalho, NEW.dt_ordem_servico, 
						NEW.dt_inicio_real, NEW.nr_seq_estagio, NEW.nr_seq_equipamento, NEW.nr_seq_classif, NEW.ie_parado);

						
				if	((coalesce(ie_gerar_dt_fim_prev_sla_w,'N') = 'T') or (coalesce(ie_gerar_dt_inicio_prev_sla_w,'N') = 'T')) then
					BEGIN

					select	qt_min_termino,
							qt_min_inicio,
						ie_tempo
					into STRICT	qt_min_termino_w,
						qt_min_inicio_w,
						ie_tempo_w
					from	man_sla_regra
					where	nr_sequencia = nr_seq_sla_regra_ww;
					
					if (coalesce(ie_gerar_dt_fim_prev_sla_w,'N') = 'T') then
						if (ie_tempo_w = 'COR') then
							NEW.dt_fim_previsto	:= NEW.dt_ordem_servico + (qt_min_termino_w / 1440);
						else
							NEW.dt_fim_previsto	:= man_obter_hor_com(cd_estabelecimento_w, NEW.dt_ordem_servico, qt_min_termino_w);
						end if;	
					end if;
					
					if (coalesce(ie_gerar_dt_inicio_prev_sla_w,'N') = 'T') then
						if (ie_tempo_w = 'COR') then
							NEW.dt_inicio_previsto	:= NEW.dt_ordem_servico + (qt_min_inicio_w / 1440);
						else
							NEW.dt_inicio_previsto	:= man_obter_hor_com(cd_estabelecimento_w, NEW.dt_ordem_servico, qt_min_inicio_w);
						end if;	
					end if;

					end;
				end if;
			end if;
			end;
		end if;

		/*Buscar a regra que ser?isparada na after, para j?tualizar o fim previsto - Solicita? OS390954
		Tratamento feito aqui pois n?o teria como atualizar a ordem de servi?na after, mutanting*/
		if (TG_OP = 'INSERT') or
			((coalesce(nr_seq_sla_w,0) = 0) and
			((coalesce(ie_gerar_dt_fim_prev_sla_w,'N') = 'T') or (coalesce(ie_gerar_dt_inicio_prev_sla_w,'N') = 'T'))) then
			BEGIN
			
			if (coalesce(ie_utiliza_sla_w,'N') in ('S','L')) and
				((coalesce(ie_gerar_dt_fim_prev_sla_w,'N') <> 'N') or (coalesce(ie_gerar_dt_inicio_prev_sla_w,'N') <> 'N')) then
				BEGIN
				select	man_obter_regra_sla(	cd_estabelecimento_w,
								NEW.nm_usuario,NEW.ie_prioridade, NEW.ie_classificacao,
								NEW.nr_seq_localizacao, NEW.nr_grupo_trabalho, NEW.dt_ordem_servico, 
								NEW.dt_inicio_real, NEW.nr_seq_estagio, NEW.nr_seq_equipamento, NEW.nr_seq_classif, NEW.ie_parado)
				into STRICT	nr_seq_sla_regra_ww
				;

				if (nr_seq_sla_regra_ww > 0) then
					BEGIN
					select	qt_min_termino,
						qt_min_inicio,
						ie_tempo
					into STRICT	qt_min_termino_w,
						qt_min_inicio_w,
						ie_tempo_w
					from	man_sla_regra
					where	nr_sequencia = nr_seq_sla_regra_ww;
					
					if (coalesce(ie_gerar_dt_fim_prev_sla_w,'N') <> 'N') then
						if (ie_tempo_w = 'COR') then
							NEW.dt_fim_previsto	:= NEW.dt_ordem_servico + (qt_min_termino_w / 1440);
						else
							NEW.dt_fim_previsto	:= man_obter_hor_com(cd_estabelecimento_w, NEW.dt_ordem_servico, qt_min_termino_w);
						end if;	
					end if;
					
					if (coalesce(ie_gerar_dt_inicio_prev_sla_w,'N') <> 'N') then
						if (ie_tempo_w = 'COR') then
							NEW.dt_inicio_previsto	:= NEW.dt_ordem_servico + (qt_min_inicio_w / 1440);
						else
							NEW.dt_inicio_previsto	:= man_obter_hor_com(cd_estabelecimento_w, NEW.dt_ordem_servico, qt_min_inicio_w);
						end if;	
					end if;
					
					end;
				end if;
				end;
			end if;
			end;
		end if;

		if (NEW.cd_centro_custo_os is null) and (NEW.nr_seq_localizacao is not null) then
			select	max(a.cd_centro_custo)
			into STRICT	NEW.cd_centro_custo_os
			from	setor_atendimento a,
				man_localizacao b
			where	a.cd_setor_atendimento 	= b.cd_setor
			and	b.nr_sequencia 		= NEW.nr_seq_localizacao;
		end if;

		if (TG_OP = 'UPDATE') and (OLD.nr_seq_proj_cron_etapa is not null) and (NEW.nr_seq_estagio in (2,9,1511)) then
			
			update	proj_cron_etapa
			set	ie_status_etapa = '4'
			where	nr_sequencia = OLD.nr_seq_proj_cron_etapa;

			select	count(*)
			into STRICT	qt_reg_w
			from	proj_cron_etapa c
			where	c.ie_status_etapa not in ('4','1')
			and	c.nr_seq_cronograma = (	SELECT	x.nr_seq_cronograma
							from	proj_cron_etapa x
							where	x.nr_sequencia = OLD.nr_seq_proj_cron_etapa);

			if (qt_reg_w = 0) then
				CALL atualizar_cronograma_npi(OLD.nr_seq_proj_cron_etapa,NEW.nm_usuario);
			end if;
		end if;

		if (TG_OP = 'UPDATE') and (OLD.dt_teste_negocio is not null) and (OLD.nr_seq_estagio in (2,1511)) and /*Cliente Teste*/
			(NEW.nr_seq_estagio = 4) and /*Desenv pendente analise */
			(NEW.ie_classificacao in ('T','S')) then /*Solicita? / Sugest?o*/
			NEW.dt_teste_negocio := LOCALTIMESTAMP;
		end if;	

		if (TG_OP = 'UPDATE') and (ie_base_corp_w = 'S') and (NEW.nr_seq_estagio <> OLD.nr_seq_estagio) then

			if (NEW.nr_seq_estagio = 9) and
				((NEW.dt_fim_real is null) or (NEW.ie_status_ordem <> '3')) then
				CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(366288);
			end if;
			
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_solic_sd_w
			from	com_solic_sd
			where	nr_ordem_servico = NEW.nr_sequencia;
			
			if (nr_seq_solic_sd_w > 0) then
				
				select	max(ie_acao),
					max(nr_seq_mot_canc_sd)
				into STRICT	ie_acao_solic_w,
					nr_seq_mot_canc_solic_w
				from	com_acao_encerrar_os
				where	nr_seq_estagio = NEW.nr_seq_estagio;	
				
				if (ie_acao_solic_w = 'C') then
					CALL com_atualizar_status_sd_js(ie_acao_solic_w,NEW.nr_sequencia, nr_seq_mot_canc_solic_w, obter_texto_dic_objeto(326288, wheb_usuario_pck.get_nr_seq_idioma, null), NEW.nm_usuario, 'N');
			
				elsif (ie_acao_solic_w = 'R') then
					CALL com_atualizar_status_sd_js(ie_acao_solic_w,NEW.nr_sequencia, null, null, NEW.nm_usuario, 'N');
				end if;
			end if;
		end if;

		CALL man_ordem_servico_validation(case TG_OP = 'INSERT' when true then 'I' else 'U' end, NEW.nm_usuario, OLD.nm_usuario, NEW.nr_sequencia, OLD.nr_sequencia, NEW.nr_seq_estagio, OLD.nr_seq_estagio,
		NEW.nr_seq_grupo_des, OLD.nr_seq_grupo_des, NEW.nr_seq_localizacao, OLD.nr_seq_localizacao, NEW.ie_classificacao, OLD.ie_classificacao,
		NEW.cd_funcao, OLD.cd_funcao, NEW.ie_origem_os, OLD.ie_origem_os, NEW.ie_plataforma, OLD.ie_plataforma, NEW.ie_complaint, NEW.ie_classificacao_cliente, NEW.ie_tipo_ordem);

		if ((ie_base_corp_w = 'S') and (NEW.nm_usuario = 'WebService') and (NEW.nr_seq_estagio not in (1051, 1731)) and (OLD.nr_seq_estagio IN (2, 41, 261))) then
			select	max(ie_tecnologia),
				max(ie_desenv)
			into STRICT	ie_tecnologia_w,
				ie_desenv_w
			from	man_estagio_processo
			where	nr_sequencia = NEW.nr_seq_estagio;
			
			if (ie_tecnologia_w = 'S') then
				NEW.nr_seq_estagio := 1731;
			elsif (ie_desenv_w = 'S') then
				NEW.nr_seq_estagio := 1051;
			end if;
			
		end if;
		if ((ie_base_corp_w = 'S') and (NEW.nm_usuario = 'WebService') and (NEW.nr_seq_estagio in (9)) and (NEW.ie_classificacao = 'E') and (NEW.ie_complaint = 'S')) then
		--Caso realizar algum ajuste aqui deve ser feito o mesmo ajuste na package man_ordem_servico_atual pois a function obter_status_complaint estava gerando mutante na trigger e por isso foi desmembrada
			select 	coalesce(max('S'), 'N')
			into STRICT 	ie_complaint_rule_w
			
			where 	(((NEW.ie_classificacao = 'E') and (man_obter_se_loc_terceiro(NEW.nr_seq_localizacao) = 'S')) or
				 ((NEW.ie_classificacao = 'E') and (NEW.ie_classificacao_cliente = 'A') and (NEW.ie_tipo_ordem <> 28) and (man_obter_se_loc_terceiro(NEW.nr_seq_localizacao) = 'N')));

			select  count(x.nr_sequencia)
			into STRICT    qt_hist_risco_w
			from    man_ordem_serv_tecnico x
			where   nr_seq_tipo in ( 233, 236 ) -- Potential Security or Privacy Event or Potential
			and     x.nr_seq_ordem_serv = NEW.nr_sequencia
			and     x.dt_liberacao is not null;

			select  count(x.nr_sequencia)
			into STRICT    qt_hist_decisao_w
			from    man_ordem_serv_tecnico x
			where   nr_seq_tipo in ( 216, 217 ) -- invest need no invest need
			and     x.nr_seq_ordem_serv = NEW.nr_sequencia
			and     x.dt_liberacao is not null;

			select  count(x.nr_sequencia)
			into STRICT    qt_hist_info_pergunta_w
			from    man_ordem_serv_tecnico x
			where   nr_seq_tipo in ( 218 ) -- request info
			and     x.nr_seq_ordem_serv = NEW.nr_sequencia
			and     x.dt_liberacao is not null;

			select  count(x.nr_sequencia)
			into STRICT    qt_hist_info_resposta_w
			from    man_ordem_serv_tecnico x
			where   nr_seq_tipo in ( 214 ) -- request info
			and     x.nr_seq_ordem_serv = NEW.nr_sequencia
			and     x.dt_liberacao is not null;

			select  count(x.nr_sequencia)
			into STRICT    qt_hist_complaint_w
			from    man_ordem_serv_tecnico x
			where   nr_seq_tipo = 215 -- complaiint
			and     x.nr_seq_ordem_serv = NEW.nr_sequencia
			and     x.dt_liberacao is not null;

			SELECT	coalesce(NEW.ie_complaint, 'N')
			into STRICT	ie_complaint_w
			;

			select 	coalesce(max('S'), 'N')
			into STRICT 	ie_complaint_eval_w
			
			where 	NEW.ie_complaint is not null;

			if (ie_complaint_eval_w = 'N') then
				ds_return_w := 'WFE';--'Waiting evaluation'
			elsif (qt_hist_info_pergunta_w > qt_hist_info_resposta_w) then
				ds_return_w := 'WFI';--'Waiting information'
			elsif (ie_complaint_w = 'S') and (NEW.cd_trackwise_id is null) and (qt_hist_risco_w > 0) then
				ds_return_w := 'WT';--'Waiting Triage/Pending Analysis on the Server Order Management'
			elsif (ie_complaint_w = 'S') and (NEW.cd_trackwise_id is not null) and
				((qt_hist_decisao_w = 0) or (qt_hist_decisao_w > 0 AND qt_hist_decisao_w < qt_hist_complaint_w)) then
				ds_return_w := 'WD';--'Waiting Decision/Pending resolution on the Server Order Management'
			elsif (NEW.cd_trackwise_id is not null) and (qt_hist_decisao_w > 0) then
				ds_return_w := 'CD';--'Complaintt documented'
			elsif (ie_complaint_w = 'N') then
				ds_return_w := 'NC';--'Not Complaint'
			end if;

			select	coalesce(max('S'), 'N')
			into STRICT	ie_waiting_ch_w
			
			where	ie_complaint_rule_w = 'S'
			and	ds_return_w in ('WFI', 'WT', 'WD');

			if (ie_waiting_ch_w = 'S') then
				NEW.nr_seq_estagio := 511;
			end if;
		end if;

		-- Treatment for assigning the stage to the one found in the FUNCAO_GRUPO_LOC table, when applicable, if a specific rule was found for the SO.
		NEW.nr_seq_estagio := coalesce(nr_seq_estagio_loc_w, NEW.nr_seq_estagio);

		if ((ie_base_corp_w = 'S') and (NEW.ie_origem_os = 1) and (NEW.dt_inicio_real is null) and (NEW.ie_status_ordem = 2)) then
			NEW.dt_inicio_real := LOCALTIMESTAMP;
		end if;
		<<Final>>

		qt_reg_w	:= 0;
	end;
end if;

  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_man_ordem_servico_atual() FROM PUBLIC;

CREATE TRIGGER man_ordem_servico_atual
	BEFORE INSERT OR UPDATE ON man_ordem_servico FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_man_ordem_servico_atual();

