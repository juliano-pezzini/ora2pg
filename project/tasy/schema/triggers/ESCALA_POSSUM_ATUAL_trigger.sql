-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_possum_atual ON escala_possum CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_possum_atual() RETURNS trigger AS $BODY$
declare
  qt_pt_idade_w          smallint := 0;
  qt_pt_glasgow_w        smallint := 0;
  qt_pt_ureia_w          smallint := 0;
  qt_ureia_mmol_w        double precision := 0;
  qt_pt_fc_w             smallint := 0;
  qt_pt_hemoglobina_w    smallint := 0;
  qt_pt_glob_brancos_w   smallint := 0;
  qt_pt_potassio_w       smallint := 0;
  qt_pt_sodio_w          smallint := 0;
  qt_pt_pa_sist_w        smallint := 0;
  qt_pt_procedimento_w   smallint := 0;
  qt_pt_perda_sangue_w   smallint := 0;
  qt_pt_respiratorio_w   smallint	:= 0;
  qt_pt_cardiovascular_w smallint	:= 0;
  qt_pt_ecg_w            smallint	:= 0;
  qt_pt_tipo_cirurgia_w  smallint	:= 0;
  qt_reg_w               smallint;
  nr_atendimento_w       bigint;
  cd_pessoa_fisica_w     varchar(10);
  ie_tipo_w		           varchar(10);
  EXEC_W                 varchar(300);
    ds_erro_w        varchar(4000);
    ds_parametros_w  varchar(4000);
BEGIN
  BEGIN
  if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then 
    BEGIN  
    NEW.nr_hora	:= (to_char(round(NEW.DT_AVALIACAO,'hh24'),'hh24'))::numeric;
    end;
  end if;
  if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
    goto Final;
  end if;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_IDADE_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_idade,
                                   OUT qt_pt_idade_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_idade: '||NEW.qt_idade||'-'||'qt_pt_idade_w: '||qt_pt_idade_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_IDADE_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_idade_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_GLASGOW_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_glasgow,
                                   OUT qt_pt_glasgow_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_glasgow: '||NEW.qt_glasgow||'-'||'qt_pt_glasgow_w: '||qt_pt_glasgow_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_GLASGOW_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_glasgow_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_UREIA_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_ureia,
                                   OUT qt_pt_ureia_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_ureia: '||NEW.qt_ureia||'-'||'qt_pt_ureia_w: '||qt_pt_ureia_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_UREIA_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_ureia_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_FREQ_CARD_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_fc,
                                   OUT qt_pt_fc_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_fc: '||NEW.qt_fc||'-'||'qt_pt_fc_w: '||qt_pt_fc_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_FREQ_CARD_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_fc_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_HEMOGLOB_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_hemoglobina,
                                   OUT qt_pt_hemoglobina_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_hemoglobina: '||NEW.qt_hemoglobina||'-'||'qt_pt_hemoglobina_w: '||qt_pt_hemoglobina_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_HEMOGLOB_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_hemoglobina_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_GLOB_BRAN_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_glob_brancos,
                                   OUT qt_pt_glob_brancos_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_glob_brancos: '||NEW.qt_glob_brancos||'-'||'qt_pt_glob_brancos_w: '||qt_pt_glob_brancos_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_GLOB_BRAN_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_glob_brancos_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_POTASSIO_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_potassio,
                                   OUT qt_pt_potassio_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_potassio: '||NEW.qt_potassio||'-'||'qt_pt_potassio_w: '||qt_pt_potassio_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_POTASSIO_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_potassio_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_SODIO_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_sodio,
                                   OUT qt_pt_sodio_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_sodio: '||NEW.qt_sodio||'-'||'qt_pt_sodio_w: '||qt_pt_sodio_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_SODIO_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_sodio_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_PRES_SISTOL_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_pa_sist,
                                   OUT qt_pt_pa_sist_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_pa_sist: '||NEW.qt_pa_sist||'-'||'qt_pt_pa_sist_w: '||qt_pt_pa_sist_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_PRES_SISTOL_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_pa_sist_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_PROCED_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_procedimento,
                                   OUT qt_pt_procedimento_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_procedimento: '||NEW.qt_procedimento||'-'||'qt_pt_procedimento_w: '||qt_pt_procedimento_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_PRES_SISTOL_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_procedimento_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_PERD_SANG_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_perda_sangue,
                                   OUT qt_pt_perda_sangue_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_perda_sangue: '||NEW.qt_perda_sangue||'-'||'qt_pt_perda_sangue_w: '||qt_pt_perda_sangue_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_PERD_SANG_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_perda_sangue_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_RESPIRAT_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.ie_respiratorio,
                                   OUT qt_pt_respiratorio_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_respiratorio: '||NEW.ie_respiratorio||'-'||'qt_pt_respiratorio_w: '||qt_pt_respiratorio_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_RESPIRAT_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_respiratorio_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_CARDIOVAS_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.ie_cardiovascular,
                                   OUT qt_pt_cardiovascular_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_cardiovascular: '||NEW.ie_cardiovascular||'-'||'qt_pt_cardiovascular_w: '||qt_pt_cardiovascular_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_CARDIOVAS_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_cardiovascular_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_ELETROCARD_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.ie_ecg,
                                   OUT qt_pt_ecg_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_ecg: '||NEW.ie_ecg||'-'||'qt_pt_ecg_w: '||qt_pt_ecg_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_ELETROCARD_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_ecg_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_TP_CIRUR_EP_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN NEW.ie_tipo_cirurgia,
                                   OUT qt_pt_tipo_cirurgia_w;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_tipo_cirurgia: '||NEW.ie_tipo_cirurgia||'-'||'qt_pt_tipo_cirurgia_w: '||qt_pt_tipo_cirurgia_w);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_TP_CIRUR_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      qt_pt_tipo_cirurgia_w := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_FISIOTERAP_EP_MD(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10,:11,:12) INTO :result';

    EXECUTE EXEC_W USING IN qt_pt_idade_w,
                                   IN qt_pt_cardiovascular_w,
                                   IN qt_pt_respiratorio_w,
                                   IN qt_pt_pa_sist_w,
                                   IN qt_pt_fc_w,
                                   IN qt_pt_glasgow_w,
                                   IN qt_pt_hemoglobina_w,
                                   IN qt_pt_glob_brancos_w,
                                   IN qt_pt_ureia_w,
                                   IN qt_pt_sodio_w,
                                   IN qt_pt_potassio_w,
                                   IN qt_pt_ecg_w,
                                   OUT NEW.qt_pontos_fisio;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          'qt_pt_idade_w: '||qt_pt_idade_w||'-'||'qt_pt_cardiovascular_w: '||qt_pt_cardiovascular_w||'-'||'qt_pt_respiratorio_w: '||qt_pt_respiratorio_w||'-'||
                          'qt_pt_pa_sist_w: '||qt_pt_pa_sist_w||'-'||'qt_pt_fc_w: '||qt_pt_fc_w||'-'||'qt_pt_glasgow_w: '||qt_pt_glasgow_w||'-'||
                          'qt_pt_hemoglobina_w: '||qt_pt_hemoglobina_w||'-'||'qt_pt_glob_brancos_w: '||qt_pt_glob_brancos_w||'-'||'qt_pt_ureia_w: '||qt_pt_ureia_w||'-'||
                          'qt_pt_sodio_w: '||qt_pt_sodio_w||'-'||'qt_pt_potassio_w: '||qt_pt_potassio_w||'-'||'qt_pt_ecg_w: '||qt_pt_ecg_w||'-'||
                          ':new.qt_pontos_fisio: '||NEW.qt_pontos_fisio);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_FISIOTERAP_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      NEW.qt_pontos_fisio := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_SCORE_OPERATIVOS_EP_MD(:1,:2,:3,:4,:5,:6) INTO :result';

    EXECUTE EXEC_W USING IN coalesce(NEW.ie_porte_cirurgia,0),
                                   IN qt_pt_procedimento_w,
                                   IN qt_pt_perda_sangue_w,
                                   IN coalesce(NEW.ie_secrecao_peritonial,0),
                                   IN coalesce(NEW.ie_cancer,0),
                                   IN qt_pt_tipo_cirurgia_w,
                                   OUT NEW.qt_pontos_operativos;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_porte_cirurgia: '||NEW.ie_porte_cirurgia||'-'||'qt_pt_procedimento_w: '||qt_pt_procedimento_w||'-'||'qt_pt_perda_sangue_w: '||qt_pt_perda_sangue_w||'-'||
                          'new.ie_secrecao_peritonial: '||NEW.ie_secrecao_peritonial||'-'||':new.ie_cancer: '||NEW.ie_cancer||'-'||'qt_pt_tipo_cirurgia_w: '||qt_pt_tipo_cirurgia_w||'-'||
                          ':new.qt_pontos_operativos: '||NEW.qt_pontos_operativos);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_SCORE_OPERATIVOS_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      NEW.qt_pontos_operativos := null;
  end;

  BEGIN
    EXEC_W := 'CALL OBTER_PERC_MORTAL_EP_MD(:1,:2) INTO :result';

    EXECUTE EXEC_W USING IN NEW.qt_pontos_operativos,
                                   IN NEW.qt_pontos_fisio,
                                   OUT NEW.pr_mortalidade;
  exception
    when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_pontos_operativos: '||NEW.qt_pontos_operativos||'-'||':new.qt_pontos_fisio: '||NEW.qt_pontos_fisio||'-'||
                          ':new.pr_mortalidade: '||NEW.pr_mortalidade);

      CALL gravar_log_medical_device('ESCALA_POSSUM_ATUAL','OBTER_PERC_MORTAL_EP_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
    
      NEW.pr_mortalidade := null;
  end;

  <<Final>>
  qt_reg_w	:= 0;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_possum_atual() FROM PUBLIC;

CREATE TRIGGER escala_possum_atual
	BEFORE INSERT OR UPDATE ON escala_possum FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_possum_atual();

