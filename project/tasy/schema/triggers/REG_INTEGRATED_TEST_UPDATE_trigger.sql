-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS reg_integrated_test_update ON reg_integrated_test CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_reg_integrated_test_update() RETURNS trigger AS $BODY$
declare
ds_prefixo_w           varchar(15);
nr_sequencia_w         bigint;
nr_seq_it_w            bigint;


BEGIN

if (OLD.cd_test_id is null) then
	
    select ds_prefixo
      into STRICT ds_prefixo_w
      from reg_intencao_uso
     where nr_sequencia = NEW.nr_seq_intencao_uso;

    select max(a.nr_sequencia)
      into STRICT nr_seq_it_w
      from reg_integrated_test a
     where a.nr_seq_intencao_uso = NEW.nr_seq_intencao_uso;

    if nr_seq_it_w is not null then
      
      select coalesce(obter_somente_numero(cd_test_id), 0) + 1
        into STRICT nr_sequencia_w
        from reg_integrated_test
       where nr_sequencia = nr_seq_it_w;

    end if;

    NEW.cd_test_id := coalesce(ds_prefixo_w, NEW.nr_seq_intencao_uso) || '_IT_' || coalesce(nr_sequencia_w, 1);

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_reg_integrated_test_update() FROM PUBLIC;

CREATE TRIGGER reg_integrated_test_update
	BEFORE INSERT ON reg_integrated_test FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_reg_integrated_test_update();

