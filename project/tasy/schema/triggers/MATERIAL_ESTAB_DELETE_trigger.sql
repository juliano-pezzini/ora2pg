-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_estab_delete ON material_estab CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_estab_delete() RETURNS trigger AS $BODY$
declare
qt_reg_prestador_w		integer;
qt_reg_farmacia_w		integer;


BEGIN
if (OLD.ie_estoque_lote = 'S') then
	-- Este registro não pode ser excluído pois o material é controlado por lote.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(267087);
end if;


/*select	count(*)
into	qt_reg_prestador_w
from	material_tipo_local_est
where	cd_material = :old.cd_material
and	exists (select	1
		from	parametro_gestao_material y,
			estabelecimento x
		where	x.nr_seq_unid_neg	= y.nr_seq_unidade_hosp
		and	x.cd_estabelecimento	= :old.cd_estabelecimento);

select	count(*)
into	qt_reg_farmacia_w
from	material_tipo_local_est
where	cd_material = :old.cd_material
and	exists (select	1
		from	parametro_gestao_material y,
			estabelecimento x
		where	x.nr_seq_unid_neg	= y.nr_seq_unidade_farm
		and	x.cd_estabelecimento	= :old.cd_estabelecimento);

if	(qt_reg_prestador_w > 0) then
	update	material_tipo_local_est
	set	ie_prestador	= 'X'
	where	cd_material	= :old.cd_material;
elsif	(qt_reg_farmacia_w > 0) then
	update	material_tipo_local_est
	set	ie_farmacia	= 'X'
	where	cd_material	= :old.cd_material;
end if;*/
RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_estab_delete() FROM PUBLIC;

CREATE TRIGGER material_estab_delete
	BEFORE DELETE ON material_estab FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_estab_delete();

