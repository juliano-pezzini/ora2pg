-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS agenda_quimio_delete ON agenda_quimio CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_agenda_quimio_delete() RETURNS trigger AS $BODY$
declare

atrib_oldvalue_w		varchar(255);
atrib_newvalue_w		varchar(255);


BEGIN

	atrib_oldvalue_w := substr(obter_valor_dominio(3192,OLD.ie_status_agenda),1,255);
	atrib_newvalue_w := substr(obter_valor_dominio(3192,NEW.ie_status_agenda),1,255);

	/*Controle de exclusão para que não fique registros na tabela Agenda_Quimio_Marcacao*/

	if (OLD.nr_seq_atendimento is not null) then
		delete FROM agenda_quimio_marcacao where nr_seq_atendimento = OLD.nr_seq_atendimento;

		delete FROM w_agenda_quimio where nr_seq_atendimento = OLD.nr_seq_atendimento;
	end if;

	if (OLD.nr_seq_pend_agenda is not null) then
		/*gravar log's de alterações(ICESP)*/

		insert into agenda_quimio_log(NR_SEQUENCIA,
						 DT_ATUALIZACAO,
						 NM_USUARIO,
						 DT_ATUALIZACAO_NREC,
						 NM_USUARIO_NREC,
						 DS_LOG,
						 NR_SEQ_PEND_AGENDA,
						 DT_LOG,
						 DS_STACK)
					values (nextval('agenda_quimio_log_seq'),
						LOCALTIMESTAMP,
						OLD.nm_usuario,
						LOCALTIMESTAMP,
						OLD.nm_usuario,
						substr(wheb_mensagem_pck.get_texto(800192,
										'ATRIB_OLDVALUE='||atrib_oldvalue_w||
										';ATRIB_NEWVALUE='||atrib_newvalue_w||
										';DS_MOTIVO_STATUS_OLD='||OLD.ds_motivo_status||
										';CD_PESSOA_FISICA_OLD='||OLD.cd_pessoa_fisica||
										';NR_SEQ_PEND_AGENDA_OLD='||OLD.nr_seq_pend_agenda||
										';NR_SEQ_LOCAL_OLD='||OLD.nr_seq_local||
										';DT_CANCELADA_OLD='||OLD.dt_cancelada||
										';NR_SEQ_MOT_CANCELAMENTO_OLD='||OLD.nr_seq_mot_cancelamento),1,4000),
						OLD.nr_seq_pend_agenda,
						LOCALTIMESTAMP,
						substr(wheb_mensagem_pck.get_texto(800207,
										'DS_FUNCAO_ATIVA='||obter_funcao_Ativa||
										';DS_PERFIL='||obter_perfil_ativo) || ' -  Stack - ' || dbms_utility.format_call_stack, 1,4000));
	end if;
RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_agenda_quimio_delete() FROM PUBLIC;

CREATE TRIGGER agenda_quimio_delete
	BEFORE DELETE ON agenda_quimio FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_agenda_quimio_delete();

