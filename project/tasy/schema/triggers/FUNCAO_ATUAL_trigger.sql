-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS funcao_atual ON funcao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_funcao_atual() RETURNS trigger AS $BODY$
DECLARE

ds_user_w varchar(100);

qt_porcentagem_w	double precision;
 
BEGIN 

if ( wheb_usuario_pck.get_ie_executar_trigger = 'S') then 

if (( NEW.ds_aplicacao <> 'TasyApps' ) and (( NEW.cd_funcao between 40000 and 49999 ) or ( NEW.cd_funcao between 70000 and 79999 ))) then
   CALL wheb_mensagem_pck.exibir_mensagem_abort(1191768);
 else if (( NEW.ds_aplicacao = 'TasyApps' ) and (not (( NEW.cd_funcao between 40000 and 49999 ) or ( NEW.cd_funcao between 70000 and 79999 )))) then
   CALL wheb_mensagem_pck.exibir_mensagem_abort(1191768);
 end IF;
end if;


select max(USERNAME)
 into STRICT ds_user_w
 from v$session
 where  audsid = (SELECT userenv('sessionid') );
if (ds_user_w = 'TASY') then
 
if (coalesce(NEW.pr_funcao_modulo,0) <> coalesce(OLD.pr_funcao_modulo,0)) then 
	BEGIN 
	qt_porcentagem_w	:= (coalesce(NEW.pr_funcao_modulo,0) - coalesce(OLD.pr_funcao_modulo,0));
 
	update	com_cliente_mod_impl a 
	set	a.pr_utilizacao	= a.pr_utilizacao + qt_porcentagem_w 
	where	exists (	SELECT	1 
				from	com_cliente_fun_impl b 
				where	b.nr_seq_mod_impl	= a.nr_sequencia 
				and	b.cd_funcao		= NEW.cd_funcao);
	end;
  end if;
 end if;
end if;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_funcao_atual() FROM PUBLIC;

CREATE TRIGGER funcao_atual
	BEFORE INSERT OR UPDATE ON funcao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_funcao_atual();

