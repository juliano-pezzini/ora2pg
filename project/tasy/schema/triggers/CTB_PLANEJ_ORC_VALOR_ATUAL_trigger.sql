-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS ctb_planej_orc_valor_atual ON ctb_planej_orc_valor CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_ctb_planej_orc_valor_atual() RETURNS trigger AS $BODY$
declare

cd_empresa_w    empresa.cd_empresa%type;
ie_tipo_w       conta_contabil.ie_tipo%type;

BEGIN

if (NEW.cd_conta_contabil is not null) then
    BEGIN
    select  a.cd_empresa,
            a.ie_tipo
    into STRICT    cd_empresa_w,
            ie_tipo_w
    from    conta_contabil a
    where   a.cd_conta_contabil = NEW.cd_conta_contabil;

    if (ie_tipo_w != 'A') then
        --So pode ser informado Conta contabil analitica!
        CALL wheb_mensagem_pck.exibir_mensagem_abort(266584);
    end if;

    if (cd_empresa_w != obter_empresa_estab(NEW.cd_estabelecimento)) then
        --A conta contabil e de outra empresa.
        CALL wheb_mensagem_pck.exibir_mensagem_abort(280987);
    end if;
    end;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_ctb_planej_orc_valor_atual() FROM PUBLIC;

CREATE TRIGGER ctb_planej_orc_valor_atual
	BEFORE INSERT OR UPDATE ON ctb_planej_orc_valor FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_ctb_planej_orc_valor_atual();

