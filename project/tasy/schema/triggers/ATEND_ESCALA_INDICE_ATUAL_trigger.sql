-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_escala_indice_atual ON atend_escala_indice CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_escala_indice_atual() RETURNS trigger AS $BODY$
declare
    qt_reg_w  				smallint;
    sql_w     				varchar(4000);
    ds_erro_w               varchar(4000);
    ds_parametros_w         varchar(4000);
BEGIN
  BEGIN
    if ( NEW.nr_hora is null ) or ( NEW.dt_avaliacao <> OLD.dt_avaliacao ) then
        BEGIN
            NEW.nr_hora := (to_char(round(NEW.dt_avaliacao, 'hh24'), 'hh24'))::numeric;

        end;
    end if;

    if (coalesce(OLD.dt_avaliacao, LOCALTIMESTAMP + interval '10 days') <> NEW.dt_avaliacao)
	and (NEW.dt_avaliacao is not null)
	then NEW.ds_utc := obter_data_utc(NEW.dt_avaliacao, 'HV');
    end if;
		
    if (coalesce(OLD.dt_liberacao,LOCALTIMESTAMP + interval '10 days') <> NEW.dt_liberacao)
	and (NEW.dt_liberacao is not null)
	then NEW.ds_utc_atualizacao := obter_data_utc(NEW.dt_liberacao, 'HV');
    end if;

    if ( wheb_usuario_pck.get_ie_executar_trigger = 'N' ) then
        goto final;
    end if;

	BEGIN
		sql_w := 'begin calcula_escala_indice_md(:1, :2, :3, :4, :5, :6, :7, :8); end;';
		EXECUTE sql_w using in NEW.ie_resposta_motora,
									  in NEW.ie_resposta_verbal,
									  in NEW.ie_abertura_ocular,
									  in NEW.ie_avaliacao_pupilar,
									  in NEW.qt_glasgow_pupilar,
									  in NEW.qt_glasgow,
									  out NEW.qt_glasgow_pupilar,
									  out NEW.qt_glasgow;

	exception
		when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.cd_paciente: '||NEW.cd_paciente||'-'||'new.nr_atendimento: '||NEW.nr_atendimento||'-'||'new.qt_glasgow: '||NEW.qt_glasgow||'-'||
								':new.qt_glasgow_pupilar: '||NEW.qt_glasgow_pupilar||'-'||':new.ie_resposta_motora: '||NEW.ie_resposta_motora||'-'||':new.ie_resposta_verbal: '||NEW.ie_resposta_verbal||'-'||
								':new.ie_abertura_ocular: '||NEW.ie_abertura_ocular||'-'||':new.ie_avaliacao_pupilar: '||NEW.ie_avaliacao_pupilar||'-'||':new.qt_glasgow: '||NEW.qt_glasgow||'-'||
								':new.qt_glasgow_pupilar: '||NEW.qt_glasgow_pupilar);
			CALL gravar_log_medical_device('atend_escala_indice_atual','calcula_escala_indice_md',ds_parametros_w,ds_erro_w,NEW.nm_usuario,'N');

			NEW.qt_glasgow 		:= null;
			NEW.qt_glasgow_pupilar := null;
	end;

    if (OBTER_SE_INTEGRACAO_ATIVA(961, 245) = 'S') then
      if ( OLD.dt_liberacao is null ) and ( NEW.dt_liberacao is not null ) then
          CALL integrar_sinais_vitais_bb(nr_sequencia_p => NEW.nr_sequencia, nr_atendimento_p => NEW.nr_atendimento, dt_sinal_vital_p => NEW.dt_avaliacao, qt_glasgow_p => NEW.qt_glasgow);
      end if;

      if (OLD.dt_inativacao is null) and (NEW.dt_inativacao is not null) then
          CALL p_cancelar_flowsheet(NEW.nr_sequencia, NEW.nr_atendimento, 'B');
      end if;
    end if;

    << final >>
	qt_reg_w := 0;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_escala_indice_atual() FROM PUBLIC;

CREATE TRIGGER atend_escala_indice_atual
	BEFORE INSERT OR UPDATE ON atend_escala_indice FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_escala_indice_atual();

