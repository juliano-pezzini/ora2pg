-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS agenda_atual ON agenda CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_agenda_atual() RETURNS trigger AS $BODY$
DECLARE
dt_atualizacao 				timestamp	:= LOCALTIMESTAMP;
length_dias_w				bigint;
nr_dias_fut_agendamento_w	bigint;
qt_reg_permissao_w			bigint := 0;
BEGIN
  BEGIN
BEGIN

delete	from agenda_controle_horario
where	dt_agenda >= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
and	cd_agenda	 = NEW.cd_agenda;

select 	max(length(NEW.nr_dias_fut_agendamento)),
		max(trim(both substr(NEW.nr_dias_fut_agendamento,1,9)))
into STRICT	length_dias_w,
	nr_dias_fut_agendamento_w
;

if (coalesce(length_dias_w,0) > 9) then
	NEW.nr_dias_fut_agendamento := nr_dias_fut_agendamento_w;
end if;

select	count(*)
into STRICT	qt_reg_permissao_w
from	med_permissao
where	cd_agenda = NEW.cd_agenda;

if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'es_MX') and (qt_reg_permissao_w > 0) then
	
	if (NEW.cd_pessoa_fisica <> OLD.cd_pessoa_fisica) or
		(OLD.cd_pessoa_fisica is null AND NEW.cd_pessoa_fisica is not null) then
		BEGIN
			update	med_permissao
			set		cd_medico_prop = NEW.cd_pessoa_fisica,
					cd_pessoa_fisica = NEW.cd_pessoa_fisica		
			where	cd_agenda = NEW.cd_agenda;
		end;
	elsif (NEW.cd_pessoa_fisica is null and OLD.cd_pessoa_fisica is not null) then
		BEGIN
			update	med_permissao
			set		cd_medico_prop  = NULL,
					cd_pessoa_fisica  = NULL,
					cd_medico  = NULL
			where	cd_agenda = NEW.cd_agenda; 	
		end;
	end if;
	
end if;

exception
	when others then
      	dt_atualizacao := LOCALTIMESTAMP;
end;
  END;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_agenda_atual() FROM PUBLIC;

CREATE TRIGGER agenda_atual
	BEFORE INSERT OR UPDATE ON agenda FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_agenda_atual();

