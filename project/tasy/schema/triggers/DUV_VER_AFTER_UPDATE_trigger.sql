-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS duv_ver_after_update ON duv_ver CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_duv_ver_after_update() RETURNS trigger AS $BODY$
declare

nr_sequencia_w	bigint;
vl_soma_w	double precision;
pr_total_w	DUV_SVB.pr_total%type;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then
	RETURN NEW;
end if;

select	max(nr_sequencia)
into STRICT	nr_sequencia_w
from	duv_svb
where	nr_seq_mensagem	= NEW.nr_seq_mensagem;

vl_soma_w	:=	coalesce(NEW.PR_ANTEBRACO_DIREITO,0) + coalesce(NEW.PR_ANTEBRACO_ESQUERDO,0) + coalesce(NEW.PR_BRACO_DIREITO,0) + coalesce(NEW.PR_BRACO_ESQUERDO,0) + coalesce(NEW.PR_CABECA,0) + coalesce(NEW.PR_COXA_DIREITA,0) + coalesce(NEW.PR_COXA_ESQUERDA,0) +
			coalesce(NEW.PR_GENITALIA,0) + coalesce(NEW.PR_MAO_DIREITA,0) + coalesce(NEW.PR_MAO_ESQUERDA,0) + coalesce(NEW.PR_NADEGA_DIREITA,0) + coalesce(NEW.PR_NADEGA_ESQUERDA,0) + coalesce(NEW.PR_PE_DIREITO,0) + coalesce(NEW.PR_PE_ESQUERDO,0) +
			coalesce(NEW.PR_PERNA_DIREITA,0) + coalesce(NEW.PR_PERNA_ESQUERDA,0) + coalesce(NEW.PR_PESCOCO,0) + coalesce(NEW.PR_QUEIMADO_COSTAS,0) + coalesce(NEW.PR_QUEIMADO_FRENTE,0);

if (NEW.IE_GRAU_SEVERIDADE = '1') then
	update	duv_svb
	set	pr_2grau_a 	= vl_soma_w
	where	nr_sequencia	= nr_sequencia_w;

elsif (NEW.IE_GRAU_SEVERIDADE = '2') then
	update	duv_svb
	set	pr_2grau_b 	= vl_soma_w
	where	nr_sequencia	= nr_sequencia_w;

elsif (NEW.IE_GRAU_SEVERIDADE = '3') then
	update	duv_svb
	set	pr_3grau 	= vl_soma_w
	where	nr_sequencia	= nr_sequencia_w;

elsif (NEW.IE_GRAU_SEVERIDADE = '4') then
	update	duv_svb
	set	pr_4grau 	= vl_soma_w
	where	nr_sequencia	= nr_sequencia_w;
end if;

select	coalesce(sum(pr_2grau_a),0) +
	coalesce(sum(pr_2grau_b),0) +
	coalesce(sum(pr_3grau),0) +
	coalesce(sum(pr_4grau),0)
into STRICT	pr_total_w
from	duv_svb
where	nr_sequencia	= nr_sequencia_w;

update	duv_svb
set	pr_total 	= pr_total_w
where	nr_sequencia	= nr_sequencia_w;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_duv_ver_after_update() FROM PUBLIC;

CREATE TRIGGER duv_ver_after_update
	AFTER INSERT OR UPDATE ON duv_ver FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_duv_ver_after_update();

