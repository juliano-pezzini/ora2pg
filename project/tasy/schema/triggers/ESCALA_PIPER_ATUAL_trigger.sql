-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_piper_atual ON escala_piper CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_piper_atual() RETURNS trigger AS $BODY$
declare
  qt_reg_comport_w		    integer    := 0;
  qt_result_comport_w	    double precision := 0;

  qt_reg_significado_w	  integer    := 0;
  qt_result_significado_w	double precision := 0;

  qt_reg_sensorial_w		  integer    := 0;
  qt_result_sensorial_w   double precision := 0;

  qt_reg_cognitivo_w		  integer    := 0;
  qt_result_cognitivo_w	  double precision := 0;

  EXEC_W    varchar(300);
  qt_reg_w  smallint;

	ds_erro_w   varchar(4000);
  ds_parametro_w  varchar(4000);
BEGIN
  BEGIN
  if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
		goto Final;
  end if;

  BEGIN
	EXEC_W := 'BEGIN OBTER_SCOR_COMP_E_PIPER_MD(:1,:2,:3,:4,:5,:6, :7, :8, :9); END;';
	
	EXECUTE EXEC_W USING IN NEW.qt_estresse_fadiga,
								   IN NEW.qt_fadiga_intef_capacidade,
								   IN NEW.qt_fadiga_intef_habilidade,
								   IN NEW.qt_fadiga_intef_hab_sexo,
								   IN NEW.qt_fadiga_cap_ativ,
								   IN NEW.qt_intensidade,
								   OUT NEW.QT_SCORE_COMPORTAMENTAL,
								   OUT qt_reg_comport_w,
								   OUT qt_result_comport_w;
  exception
		when others then
			NEW.QT_SCORE_COMPORTAMENTAL := null;
			qt_reg_comport_w             := null;
			qt_result_comport_w          := null;
			ds_erro_w := substr(sqlerrm, 1, 4000);
			ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
			|| ' - :new.qt_estresse_fadiga: ' || NEW.qt_estresse_fadiga || ' - :new.qt_fadiga_intef_capacidade: ' || NEW.qt_fadiga_intef_capacidade || ' - :new.qt_fadiga_intef_habilidade: ' || NEW.qt_fadiga_intef_habilidade
			|| ' - :new.qt_fadiga_intef_hab_sexo: ' || NEW.qt_fadiga_intef_hab_sexo || ' - :new.qt_fadiga_cap_ativ: ' || NEW.qt_fadiga_cap_ativ || ' - :new.qt_intensidade: ' || NEW.qt_intensidade || ' - :new.QT_SCORE_COMPORTAMENTAL: ' || NEW.QT_SCORE_COMPORTAMENTAL
			|| ' - qt_reg_comport_w: ' || qt_reg_comport_w || ' - qt_result_comport_w: ' || qt_result_comport_w, 1, 4000);
			CALL gravar_log_medical_device('ESCALA_PIPER_ATUAL', 'OBTER_SCOR_COMP_E_PIPER_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
  end;

  BEGIN
	EXEC_W := 'BEGIN OBTER_SCORE_AFET_E_PIPER_MD(:1,:2,:3,:4,:5, :6, :7, :8); END;';
	
	EXECUTE EXEC_W USING IN NEW.qt_fadiga_agora_agradavel,
								   IN NEW.qt_fadiga_agora_aceitavel,
								   IN NEW.qt_fadiga_agora_protetora,
								   IN NEW.qt_fadiga_agora_positiva,
								   IN NEW.qt_fadiga_agora_normal,
								   OUT NEW.QT_SCORE_AFETIVO,
								   OUT qt_reg_significado_w,
								   OUT qt_result_significado_w;
  exception
		when others then
			NEW.QT_SCORE_AFETIVO   := null;
			qt_reg_significado_w    := null;
			qt_result_significado_w := null;
			ds_erro_w := substr(sqlerrm, 1, 4000);
			ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
			|| ' - :new.qt_fadiga_agora_agradavel: ' || NEW.qt_fadiga_agora_agradavel || ' - :new.qt_fadiga_agora_aceitavel: ' || NEW.qt_fadiga_agora_aceitavel || ' - :new.qt_fadiga_agora_protetora: ' || NEW.qt_fadiga_agora_protetora
			|| ' - :new.qt_fadiga_agora_positiva: ' || NEW.qt_fadiga_agora_positiva || ' - :new.qt_fadiga_agora_normal: ' || NEW.qt_fadiga_agora_normal || ' - :new.QT_SCORE_AFETIVO: ' || NEW.QT_SCORE_AFETIVO || ' - qt_reg_significado_w: ' || qt_reg_significado_w
			|| ' - qt_result_significado_w: ' || qt_result_significado_w, 1, 4000);
			CALL gravar_log_medical_device('ESCALA_PIPER_ATUAL', 'OBTER_SCORE_AFET_E_PIPER_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
  end;

  BEGIN
	EXEC_W := 'BEGIN OBTER_SCOR_SENS_E_PIPER_MD(:1,:2,:3,:4,:5,:6,:7,:8); END;';
	
	EXECUTE EXEC_W USING IN NEW.QT_SENTINDO_FORTE,
								   IN NEW.QT_SENTINDO_ACORDADO,
								   IN NEW.QT_SENTINDO_VIDA,
								   IN NEW.QT_SENTINDO_VIGOR,
								   IN NEW.QT_SENTINDO_ENERGIA,
								   OUT NEW.QT_SCORE_SENSORIAL,
								   OUT qt_reg_sensorial_w,
								   OUT qt_result_sensorial_w;
  exception
		when others then
			NEW.QT_SCORE_SENSORIAL := null;
			qt_reg_sensorial_w      := null;
			qt_result_sensorial_w   := null;
			ds_erro_w := substr(sqlerrm, 1, 4000);
			ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
			|| ' - :new.QT_SENTINDO_FORTE: ' || NEW.QT_SENTINDO_FORTE || ' - :new.QT_SENTINDO_ACORDADO: ' || NEW.QT_SENTINDO_ACORDADO || ' - :new.QT_SENTINDO_VIDA: ' || NEW.QT_SENTINDO_VIDA
			|| ' - :new.QT_SENTINDO_VIGOR: ' || NEW.QT_SENTINDO_VIGOR || ' - :new.QT_SENTINDO_ENERGIA: ' || NEW.QT_SENTINDO_ENERGIA || ' - :new.QT_SCORE_SENSORIAL: ' || NEW.QT_SCORE_SENSORIAL
			|| ' - qt_reg_sensorial_w: ' || qt_reg_sensorial_w || ' - qt_result_sensorial_w: ' || qt_result_sensorial_w, 1, 4000);
			CALL gravar_log_medical_device('ESCALA_PIPER_ATUAL', 'OBTER_SCOR_SENS_E_PIPER_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
  end;

  BEGIN
	EXEC_W := 'BEGIN OBTER_SCOR_COGN_E_PIPER_MD(:1,:2,:3,:4,:5,:6,:7,:8,:9); END;';
	
	EXECUTE EXEC_W USING IN NEW.QT_SENTINDO_PACIENTE,
								   IN NEW.QT_SENTINDO_RELAXADO,
								   IN NEW.QT_SENTINDO_FELIZ,
								   IN NEW.QT_SENTINDO_CONCENTRAR,
								   IN NEW.QT_SENTINDO_LEMBRAR,
								   IN NEW.QT_SENTINDO_PENSAR,
								   OUT NEW.QT_SCORE_COGNITIVO,
								   OUT qt_reg_cognitivo_w,
								   OUT qt_result_cognitivo_w;
  exception
		when others then
			NEW.QT_SCORE_COGNITIVO := null;
			qt_reg_cognitivo_w      := null;
			qt_result_cognitivo_w   := null;
			ds_erro_w := substr(sqlerrm, 1, 4000);
			ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
			|| ' - :new.QT_SENTINDO_PACIENTE: ' || NEW.QT_SENTINDO_PACIENTE || ' - :new.QT_SENTINDO_RELAXADO: ' || NEW.QT_SENTINDO_RELAXADO || ' - :new.QT_SENTINDO_FELIZ: ' || NEW.QT_SENTINDO_FELIZ
			|| ' - :new.QT_SENTINDO_CONCENTRAR: ' || NEW.QT_SENTINDO_CONCENTRAR || ' - :new.QT_SENTINDO_LEMBRAR: ' || NEW.QT_SENTINDO_LEMBRAR || ' - :new.QT_SENTINDO_PENSAR: ' || NEW.QT_SENTINDO_PENSAR
			|| ' - :new.QT_SCORE_COGNITIVO: ' || NEW.QT_SCORE_COGNITIVO || ' - qt_reg_cognitivo_w: ' || qt_reg_cognitivo_w || ' - qt_result_cognitivo_w: ' || qt_result_cognitivo_w, 1, 4000);
			CALL gravar_log_medical_device('ESCALA_PIPER_ATUAL', 'OBTER_SCOR_COGN_E_PIPER_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
  end;

  BEGIN
	EXEC_W := 'CALL OBTER_SCORE_TOTAL_E_PIPER_MD(:1,:2,:3,:4,:5,:6,:7,:8) INTO :RESULT';
	
	EXECUTE EXEC_W USING IN qt_reg_comport_w,
								   IN qt_reg_significado_w,
								   IN qt_reg_sensorial_w,
								   IN qt_reg_cognitivo_w,
								   IN qt_result_comport_w,
								   IN qt_result_significado_w,
								   IN qt_result_sensorial_w,
								   IN qt_result_cognitivo_w,
								   OUT NEW.QT_SCORE;
  exception
		when others then
			NEW.QT_SCORE := null;
			ds_erro_w := substr(sqlerrm, 1, 4000);
			ds_parametro_w := substr(':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional
			|| ' - :new.QT_SENTINDO_PACIENTE: ' || NEW.QT_SENTINDO_PACIENTE || ' - :new.QT_SENTINDO_RELAXADO: ' || NEW.QT_SENTINDO_RELAXADO || ' - :new.QT_SENTINDO_FELIZ: ' || NEW.QT_SENTINDO_FELIZ
			|| ' - :new.QT_SENTINDO_CONCENTRAR: ' || NEW.QT_SENTINDO_CONCENTRAR || ' - :new.QT_SENTINDO_LEMBRAR: ' || NEW.QT_SENTINDO_LEMBRAR || ' - :new.QT_SENTINDO_PENSAR: ' || NEW.QT_SENTINDO_PENSAR
			|| ' - :new.QT_SCORE_COGNITIVO: ' || NEW.QT_SCORE_COGNITIVO || ' - qt_reg_cognitivo_w: ' || qt_reg_cognitivo_w || ' - qt_result_cognitivo_w: ' || qt_result_cognitivo_w, 1, 4000);
			CALL gravar_log_medical_device('ESCALA_PIPER_ATUAL', 'OBTER_SCORE_TOTAL_E_PIPER_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
  end;

  <<Final>>
  qt_reg_w	:= 0;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_piper_atual() FROM PUBLIC;

CREATE TRIGGER escala_piper_atual
	BEFORE INSERT OR UPDATE ON escala_piper FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_piper_atual();

