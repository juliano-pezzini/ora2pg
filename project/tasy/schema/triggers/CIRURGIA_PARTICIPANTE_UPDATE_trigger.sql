-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cirurgia_participante_update ON cirurgia_participante CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cirurgia_participante_update() RETURNS trigger AS $BODY$
declare
 
qt_reg_w					smallint;
ds_origem_w					varchar(1800);
ie_gerar_particip_w			varchar(255);
ie_gerar_particip_com_pf_w	varchar(255);
ds_stack_w					varchar(2000);
 
BEGIN 
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N') then 
	goto Final;
end if;
 
ie_gerar_particip_com_pf_w	:= Obter_Valor_Param_Usuario(872, 448, Obter_Perfil_Ativo, NEW.nm_usuario, 0);
ie_gerar_particip_w			:= Obter_Valor_Param_Usuario(872, 495, Obter_Perfil_Ativo, NEW.nm_usuario, 0);
 
if	(ie_gerar_particip_w	= 'S' AND wheb_usuario_pck.get_cd_funcao	= 872) or (wheb_usuario_pck.get_cd_funcao	<> 872)	then 
	 
  if (ie_gerar_particip_com_pf_w = 'S') and (wheb_usuario_pck.get_cd_funcao = 872) then 
		 
  	if (NEW.cd_pessoa_fisica is not null) and (coalesce(NEW.ie_situacao,'A') <> 'I') then 
   
  		CALL Ajustar_Participante_Proc( 
  					'DELETE', 
  					OLD.nr_cirurgia, 
  					OLD.nr_sequencia, 
  					OLD.ie_funcao, 
  					OLD.cd_pessoa_fisica, 
  					OLD.nm_participante, 
  					OLD.nr_seq_procedimento, 
  					'');
  		CALL Ajustar_Participante_Proc( 
  					'INSERT', 
  					NEW.nr_cirurgia, 
  					NEW.nr_sequencia, 
  					NEW.ie_funcao, 
  					NEW.cd_pessoa_fisica, 
  					NEW.nm_participante, 
  					NEW.nr_seq_procedimento, 
  					NEW.nm_usuario);
  	end if;
  else 
		if (coalesce(NEW.ie_situacao,'A') <> 'I') then 
			CALL Ajustar_Participante_Proc( 
						'DELETE', 
						OLD.nr_cirurgia, 
						OLD.nr_sequencia, 
						OLD.ie_funcao, 
						OLD.cd_pessoa_fisica, 
						OLD.nm_participante, 
						OLD.nr_seq_procedimento, 
						'');
						 
			CALL Ajustar_Participante_Proc( 
						'INSERT', 
						NEW.nr_cirurgia, 
						NEW.nr_sequencia, 
						NEW.ie_funcao, 
						NEW.cd_pessoa_fisica, 
						NEW.nm_participante, 
						NEW.nr_seq_procedimento, 
						NEW.nm_usuario);
		end if;
  end if;
end if;
 
<<Final>> 
ds_stack_w		:= substr(dbms_utility.format_call_stack,1,2000);
NEW.ds_stack	:= ds_stack_w;
qt_reg_w		:= 0;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cirurgia_participante_update() FROM PUBLIC;

CREATE TRIGGER cirurgia_participante_update
	BEFORE UPDATE ON cirurgia_participante FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cirurgia_participante_update();

