-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_pagar_baixa_ops_insert ON titulo_pagar_baixa_ops CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_pagar_baixa_ops_insert() RETURNS trigger AS $BODY$
declare

ie_contab_tit_interc_cancel_w		pls_parametro_contabil.ie_contab_tit_interc_cancel%type;
cd_estabelecimento_w			estabelecimento.cd_estabelecimento%type;
nr_seq_baixa_w				titulo_pagar_baixa.nr_sequencia%type;
dt_baixa_w				titulo_pagar_baixa.dt_baixa%type;
vl_movimento_w				titulo_pagar_baixa_ops.vl_movimento%type;
nr_seq_trans_financ_w			titulo_pagar_baixa.nr_seq_trans_fin%type;
ie_concil_contab_w			pls_visible_false.ie_concil_contab%type;

c01 CURSOR FOR
	SELECT 	a.nm_atributo,
		36 cd_tipo_lote_contab
	from	atributo_contab a
	where	((a.cd_tipo_lote_contab = 36
		and	a.nm_atributo = 'VL_INTERCAMBIO'
		and	coalesce(NEW.ie_origem, 'X') = 'I')
	or 	(a.cd_tipo_Lote_contab = 7
		and	((a.nm_atributo = 'VL_COPARTICIPACAO'
		and	coalesce(NEW.ie_origem, 'X') = 'C')
		or (a.nm_atributo = 'VL_EVENTO_OPS'
		and	coalesce(NEW.ie_origem, 'X') = 'E')
		or (a.nm_atributo = 'VL_PAGAMENTO_OPS'
		and	coalesce(NEW.ie_origem, 'X') = 'P')
		or (a.nm_atributo = 'VL_REEMBOLSO'
		and	coalesce(NEW.ie_origem, 'X') = 'R'))))
	and	exists	(SELECT	1
			from	titulo_pagar	x,
				ptu_fatura	y
			where	x.nr_titulo		= y.nr_titulo
			and	x.nr_titulo		= NEW.nr_titulo
			and	x.ie_origem_titulo	= '16'
			and	coalesce(x.ie_status,'D')	= 'D'
			and	((x.ie_situacao		!= 'C') or (ie_contab_tit_interc_cancel_w = 'S'))
			
union all

			select	1
			from	titulo_pagar	x,
				ptu_fatura	y
			where	x.nr_titulo		= y.nr_titulo_ndc
			and	x.nr_titulo		= NEW.nr_titulo
			and	x.ie_origem_titulo	= '16'
			and	coalesce(x.ie_status,'D')	= 'D'
			and	((x.ie_situacao		!= 'C') or (ie_contab_tit_interc_cancel_w = 'S')))
	and	ie_concil_contab_w = 'S';

c01_w		c01%rowtype;
BEGIN
  BEGIN

if (coalesce(wheb_usuario_pck.get_ie_executar_trigger,'S')	= 'S')  then
												
	select  max(cd_estabelecimento)
	into STRICT    cd_estabelecimento_w
	from    titulo_pagar
	where   nr_titulo = NEW.nr_titulo;

	select	coalesce(max(ie_contab_tit_interc_cancel), 'S')
	into STRICT	ie_contab_tit_interc_cancel_w
	from	pls_parametro_contabil
	where 	cd_estabelecimento = cd_estabelecimento_w;
	
	select 	nr_sequencia,
		dt_baixa,
		nr_seq_trans_fin
	into STRICT	nr_seq_baixa_w,
		dt_baixa_w,
		nr_seq_trans_financ_w
	from	titulo_pagar_baixa
	where	nr_sequencia 	= NEW.nr_seq_baixa
	and	nr_titulo	= NEW.nr_titulo;

	BEGIN
	select	coalesce(max(ie_concil_contab), 'N')
	into STRICT	ie_concil_contab_w
	from	pls_visible_false
	where	cd_estabelecimento = cd_estabelecimento_w;
	exception when others then
		ie_concil_contab_w := 'N';
	end;

	open c01;
	loop
	fetch c01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
	vl_movimento_w := NEW.vl_movimento;

	if (coalesce(vl_movimento_w, 0) <> 0) then
		CALL ctb_concil_financeira_pck.ctb_gravar_documento(	cd_estabelecimento_w,
									dt_baixa_w,
									c01_w.cd_tipo_lote_contab,
									nr_seq_trans_financ_w,
									13,
									NEW.nr_titulo,
									nr_seq_baixa_w,
									NEW.nr_sequencia,
									vl_movimento_w,
									'TITULO_PAGAR_BAIXA_OPS',
									c01_w.nm_atributo,
									NEW.nm_usuario);
	end if;
	end;
	end loop;
	close c01;
end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_pagar_baixa_ops_insert() FROM PUBLIC;

CREATE TRIGGER titulo_pagar_baixa_ops_insert
	AFTER INSERT ON titulo_pagar_baixa_ops FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_pagar_baixa_ops_insert();

