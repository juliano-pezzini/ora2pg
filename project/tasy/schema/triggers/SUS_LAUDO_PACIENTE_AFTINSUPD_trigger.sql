-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS sus_laudo_paciente_aftinsupd ON sus_laudo_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_sus_laudo_paciente_aftinsupd() RETURNS trigger AS $BODY$
declare

ie_executa		varchar(1) := 'S';
dt_assinatura_w         timestamp;

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	ie_executa := 'N';
end if;

if (ie_executa = 'S') then

        select	max(dt_assinatura)
        into STRICT	dt_assinatura_w
        from	tasy_assinatura_digital
        where	nr_sequencia	= NEW.nr_seq_assinatura;

        if (NEW.dt_liberacao is not null) then
                if (dt_assinatura_w is null) then
                        CALL gerar_registro_pendente_pep(    cd_tipo_registro_p => 'SUS',
                                                        nr_sequencia_registro_p => NEW.nr_seq_interno,
                                                        cd_pessoa_fisica_p => coalesce(NEW.cd_pessoa_fisica,obter_dados_atendimento(NEW.nr_atendimento,'CP')), 
                                                        nr_atendimento_p => NEW.nr_atendimento,
                                                        nm_usuario_p => NEW.nm_usuario,
                                                        ie_tipo_pendencia_p => 'A',
                                                        nr_seq_item_pront_p => 365);
                end if;
        end if;

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_sus_laudo_paciente_aftinsupd() FROM PUBLIC;

CREATE TRIGGER sus_laudo_paciente_aftinsupd
	AFTER INSERT OR UPDATE ON sus_laudo_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_sus_laudo_paciente_aftinsupd();

