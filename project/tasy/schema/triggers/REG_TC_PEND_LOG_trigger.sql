-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS reg_tc_pend_log ON reg_tc_pendencies CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_reg_tc_pend_log() RETURNS trigger AS $BODY$
DECLARE
    ie_acao_w reg_tc_pendencies_log.ie_acao%TYPE;
BEGIN
    IF ( wheb_usuario_pck.get_ie_executar_trigger = 'S' ) THEN

        IF TG_OP = 'UPDATE' AND NEW.ie_status <> 'E' THEN
            ie_acao_w := 'A';
        ELSIF TG_OP = 'INSERT' THEN
            ie_acao_w := 'I';
        ELSIF NEW.ie_status = 'E' THEN
            ie_acao_w := 'E';
        END IF;

        IF ie_acao_w IN ('A', 'I') AND NEW.nr_seq_controle_plano IS NOT NULL THEN

            INSERT INTO reg_tc_pendencies_log(
                dt_atualizacao,
                dt_atualizacao_nrec,
                ie_acao,
                nm_usuario,
                nm_usuario_nrec,
                nr_seq_controle_plano,
                nr_seq_pr,
                nr_seq_tc,
                nr_seq_tc_pendencies,
                nr_sequencia
            ) VALUES (
                LOCALTIMESTAMP,
                LOCALTIMESTAMP,
                ie_acao_w,
                NEW.nm_usuario,
                NEW.nm_usuario_nrec,
                NEW.nr_seq_controle_plano,
                NEW.nr_seq_pr,
                NEW.nr_seq_tc,
                NEW.nr_sequencia,
                nextval('reg_tc_pendencies_log_seq')
            );

        ELSIF ie_acao_w = 'E' THEN

            INSERT INTO reg_tc_pendencies_log(
                dt_atualizacao,
                dt_atualizacao_nrec,
                ie_acao,
                nm_usuario,
                nm_usuario_nrec,
                nr_seq_controle_plano,
                nr_seq_pr,
                nr_seq_tc,
                nr_seq_tc_pendencies,
                nr_sequencia
            ) VALUES (
                LOCALTIMESTAMP,
                LOCALTIMESTAMP,
                ie_acao_w,
                OLD.nm_usuario,
                OLD.nm_usuario_nrec,
                OLD.nr_seq_controle_plano,
                OLD.nr_seq_pr,
                OLD.nr_seq_tc,
                OLD.nr_sequencia,
                nextval('reg_tc_pendencies_log_seq')
            );

        END IF;

    END IF;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_reg_tc_pend_log() FROM PUBLIC;

CREATE TRIGGER reg_tc_pend_log
	AFTER INSERT OR UPDATE ON reg_tc_pendencies FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_reg_tc_pend_log();

