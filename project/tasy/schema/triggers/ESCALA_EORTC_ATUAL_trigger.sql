-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_eortc_atual ON escala_eortc CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_eortc_atual() RETURNS trigger AS $BODY$
declare
    exec_w          varchar(4000) := null;
    ds_erro_w       varchar(4000);
    ds_parametros_w varchar(4000);
    qt_bruto_ql2_w  double precision  := 0;
    qt_bruto_pf2_w  double precision  := 0;
    qt_bruto_rf2_w  double precision  := 0;
    qt_bruto_ef_w   double precision  := 0;
    qt_bruto_cf_w   double precision  := 0;
    qt_bruto_sf_w   double precision  := 0;
    qt_bruto_fa_w   double precision  := 0;
    qt_bruto_nv_w   double precision  := 0;
    qt_bruto_pa_w   double precision  := 0;
    qt_bruto_dy_w   double precision  := 0;
    qt_bruto_sl_w   double precision  := 0;
    qt_bruto_ap_w   double precision  := 0;
    qt_bruto_co_w   double precision  := 0;
    qt_bruto_di_w   double precision  := 0;
    qt_bruto_fi_w   double precision  := 0;
    qt_reg_w        smallint;
BEGIN
  BEGIN
    if (wheb_usuario_pck.get_ie_executar_trigger = 'N')  then
      goto Final;
    end if;

    CALL Consiste_Liberacao_Escala(113);

    BEGIN
        exec_w := 'call obter_eglos_qv_e_eortc_atu_md(:1, :2) into :qt_bruto_ql2_w';

        EXECUTE exec_w using  in NEW.ie_classif_saude,
                                        in NEW.ie_classif_qualidade_vida,
                                        out qt_bruto_ql2_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_classif_saude: '||NEW.ie_classif_saude||'-'||
								':new.ie_classif_qualidade_vida: '||NEW.ie_classif_qualidade_vida||'-'||
								'[OUT] qt_bruto_ql2_w: '||qt_bruto_ql2_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_EGLOS_QV_E_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_ql2_w := null;
    end;

    NEW.QT_ESCORE_QL2 := qt_bruto_ql2_w;

    BEGIN
        exec_w := 'call obter_func_fisic_eortc_atu_md(:1, :2, :3, :4, :5) into :qt_bruto_pf2_w';

        EXECUTE exec_w using  in NEW.ie_dificuldade_esforco,
                                        in NEW.ie_dif_grande_caminhada,
                                        in NEW.ie_dif_curta_caminhada,
                                        in NEW.ie_cama_cadeira_dia,
                                        in NEW.ie_ajuda_alimentar_vestir,
                                        out qt_bruto_pf2_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_dificuldade_esforco: '||NEW.ie_dificuldade_esforco||'-'||
								':new.ie_dif_grande_caminhada: '||NEW.ie_dif_grande_caminhada||'-'||								
								':new.ie_dif_curta_caminhada: '||NEW.ie_dif_curta_caminhada||'-'||
								':new.ie_cama_cadeira_dia: '||NEW.ie_cama_cadeira_dia||'-'||
								':new.ie_ajuda_alimentar_vestir: '||NEW.ie_ajuda_alimentar_vestir||'-'||								
								'[OUT] qt_bruto_pf2_w: '||qt_bruto_pf2_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_FUNC_FISIC_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');

			qt_bruto_pf2_w := null;
    end;

    NEW.qt_escore_pf2	:= 	qt_bruto_pf2_w;

    BEGIN
        exec_w := 'call obter_des_ati_e_eortc_atu_md(:1, :2) into :qt_bruto_rf2_w';

        EXECUTE exec_w using  in NEW.ie_limitado_trabalho,
                                        in NEW.ie_limitado_ativ_lazer,
                                        out qt_bruto_rf2_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_limitado_trabalho: '||NEW.ie_limitado_trabalho||'-'||
								':new.ie_limitado_ativ_lazer: '||NEW.ie_limitado_ativ_lazer||'-'||								
								'[out] qt_bruto_rf2_w: '||qt_bruto_rf2_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_DES_ATI_E_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_rf2_w := null;
    end;

    NEW.QT_ESCORE_RF2	:= 	qt_bruto_rf2_w;

    BEGIN
        exec_w := 'call obter_func_emoc_eortc_atu_md(:1, :2, :3, :4) into :qt_bruto_ef_w';

        EXECUTE exec_w using  in NEW.ie_tenso,
                                        in NEW.ie_preocupado,
                                        in NEW.ie_irritado,
                                        in NEW.ie_deprimido,
                                        out qt_bruto_ef_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_tenso: '||NEW.ie_tenso||'-'||
								':new.ie_preocupado: '||NEW.ie_preocupado||'-'||
								':new.ie_irritado: '||NEW.ie_irritado||'-'||
								':new.ie_deprimido: '||NEW.ie_deprimido||'-'||
								'[out] qt_bruto_ef_w: '||qt_bruto_ef_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_FUNC_EMOC_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_ef_w := null;
    end;

    NEW.QT_ESCORE_EF	:= 	qt_bruto_ef_w;

    BEGIN
        exec_w := 'call obter_func_cogni_eortc_atu_md(:1, :2) into :qt_bruto_cf_w';

        EXECUTE exec_w using  in NEW.ie_dif_concentrar,
                                        in NEW.ie_dif_lembrar,
                                        out qt_bruto_cf_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_dif_concentrar: '|| NEW.ie_dif_concentrar||'-'||
								':new.ie_dif_lembrar: '|| NEW.ie_dif_lembrar||'-'||
								'[out] qt_bruto_cf_w: '|| qt_bruto_cf_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_FUNC_COGNI_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_cf_w := null;
    end;

    NEW.qt_escore_cf	:= 	qt_bruto_cf_w;

    BEGIN
        exec_w := 'call obter_func_soc_eortc_atu_md(:1, :2) into :qt_bruto_sf_w';

        EXECUTE exec_w using  in NEW.ie_interf_vida_fam,
                                        in NEW.ie_interf_vida_social,
                                        out qt_bruto_sf_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_interf_vida_fam: '|| NEW.ie_interf_vida_fam||'-'||
								':new.ie_interf_vida_social: '|| NEW.ie_interf_vida_social||'-'||
								'[out] qt_bruto_sf_w: '|| qt_bruto_sf_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_FUNC_SOC_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_sf_w := null;
    end;

    NEW.QT_ESCORE_SF	:= 	qt_bruto_sf_w;

    BEGIN

        exec_w := 'call obter_scor_fad_eortc_atu_md(:1, :2, :3) into :qt_bruto_fa_w';

        EXECUTE exec_w using  in NEW.ie_repousar, 
                                        in NEW.ie_fraco,
                                        in NEW.ie_cansado,
                                        out qt_bruto_fa_w;
    exception
        when others then
          ds_erro_w := sqlerrm;
          ds_parametros_w := (':new.ie_repousar: '|| NEW.ie_repousar ||'-'||
                              ':new.ie_fraco: '|| NEW.ie_fraco ||'-'||
                              ':new.ie_cansado: '|| NEW.ie_cansado ||'-'||
                              '[out] qt_bruto_fa_w: '|| qt_bruto_fa_w);
          CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_SCOR_FAD_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
          qt_bruto_fa_w := null;
    end;

    NEW.QT_ESCORE_FA	:= 	qt_bruto_fa_w;

    BEGIN
        exec_w := 'call obter_naus_vomit_eortc_atu_md(:1, :2) into :qt_bruto_nv_w';

        EXECUTE exec_w using  in NEW.ie_nauseado,
                                        in NEW.ie_vomitado,
                                        out qt_bruto_nv_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_nauseado: '|| NEW.ie_nauseado ||'-'||
								':new.ie_vomitado: '|| NEW.ie_vomitado ||'-'||
								'[out] qt_bruto_nv_w: '|| qt_bruto_nv_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_NAUS_VOMIT_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_nv_w := null;
    end;

    NEW.qt_escore_nv	:= 	qt_bruto_nv_w;

    BEGIN
        exec_w := 'call obter_scor_dor_e_eortc_atu_md(:1, :2) into :qt_bruto_pa_w';

        EXECUTE exec_w using  in NEW.ie_dor,
                                        in NEW.ie_dor_interferiu,
                                        out qt_bruto_pa_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_dor: '|| NEW.ie_dor ||'-'||
								':new.ie_dor_interferiu: '|| NEW.ie_dor_interferiu ||'-'||
								'[out] qt_bruto_pa_w: '|| qt_bruto_pa_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_SCOR_DOR_E_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_pa_w := null;
    end;

    NEW.qt_escore_pa	:= 	qt_bruto_pa_w;

    BEGIN
        exec_w := 'call obter_scor_disp_eortc_atu_md(:1) into :qt_bruto_dy_w';

        EXECUTE exec_w using in NEW.ie_falta_ar,
                                       out qt_bruto_dy_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_falta_ar: '|| NEW.ie_falta_ar ||'-'||
								'[out] qt_bruto_dy_w: '|| qt_bruto_dy_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_SCOR_DISP_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_dy_w := null;
    end;

    NEW.qt_escore_dy	:= 	qt_bruto_dy_w;

    BEGIN
        exec_w := 'call obter_scor_inson_eortc_atu_md(:1) into :qt_bruto_sl_w';

        EXECUTE exec_w using in NEW.ie_probl_dormir,
                                       out qt_bruto_sl_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_probl_dormir: '|| NEW.ie_probl_dormir ||'-'||
								'[out] qt_bruto_sl_w: '|| qt_bruto_sl_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_SCOR_INSON_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_sl_w := null;
    end;

    NEW.QT_ESCORE_SL	:= 	qt_bruto_dy_w;

    BEGIN
        exec_w := 'call obter_perd_apet_eortc_atu_md(:1) into :qt_bruto_ap_w';

        EXECUTE exec_w using in NEW.ie_falta_apedite,
                                       out qt_bruto_ap_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_falta_apedite: '|| NEW.ie_falta_apedite ||'-'||
								'[out] qt_bruto_ap_w: '|| qt_bruto_ap_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_PERD_APET_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_ap_w := null;
    end;

    NEW.qt_escore_ap	:= 	qt_bruto_ap_w;

    BEGIN
        exec_w := 'call obter_constip_e_eortc_atu_md(:1) into :qt_bruto_co_w';

        EXECUTE exec_w using in NEW.ie_constipado,
                                       out qt_bruto_co_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_constipado: '|| NEW.ie_constipado ||'-'||
								'[out] qt_bruto_co_w: '|| qt_bruto_co_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_CONSTIP_E_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_co_w := null;
    end;

    NEW.qt_escore_co	:= 	qt_bruto_co_w;

    BEGIN
        exec_w := 'call obter_diarr_esc_eortc_atu_md(:1) into :qt_bruto_di_w';

        EXECUTE exec_w using in NEW.ie_diarreia,
                                       out qt_bruto_di_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_diarreia: '|| NEW.ie_diarreia ||'-'||
								'[out] qt_bruto_di_w: '|| qt_bruto_di_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_DIARR_ESC_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_di_w := null;
    end;

    NEW.qt_escore_di	:= 	qt_bruto_di_w;

    BEGIN
        exec_w := 'call obter_dif_fina_e_eortc_atu_md(:1) into :qt_bruto_fi_w';

        EXECUTE exec_w using in NEW.ie_dif_financeira,
                                       out qt_bruto_fi_w;
    exception
        when others then
			ds_erro_w := sqlerrm;
			ds_parametros_w := (':new.ie_dif_financeira: '|| NEW.ie_dif_financeira ||'-'||
								'[out] qt_bruto_fi_w: '|| qt_bruto_fi_w);
			CALL gravar_log_medical_device('ESCALA_EORTC_ATUAL', 'OBTER_DIF_FINA_E_EORTC_ATU_MD', ds_parametros_w, ds_erro_w, NEW.nm_usuario, 'N');
			qt_bruto_fi_w := null;
    end;

    NEW.qt_escore_fi := qt_bruto_fi_w;

    <<Final>>
    qt_reg_w := 0;
	
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_eortc_atual() FROM PUBLIC;

CREATE TRIGGER escala_eortc_atual
	BEFORE INSERT OR UPDATE ON escala_eortc FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_eortc_atual();

