-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS log_envio_email_temp_afinsert ON log_envio_email_temp CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_log_envio_email_temp_afinsert() RETURNS trigger AS $BODY$
declare
qt_maximo_w			bigint;
qt_pendente_w		bigint;
ie_email_dia_util_w	varchar(2);
qt_registros_w		bigint;
 
BEGIN 
 
ie_email_dia_util_w := 'N';
 
select	coalesce(max(qt_maximo_pendente),0) 
into STRICT	qt_maximo_w 
from	regra_envio_compra_agrup 
where	cd_estabelecimento = NEW.cd_estabelecimento 
and	ie_tipo_mensagem = NEW.ie_tipo_mensagem;
 
select	count(*) 
into STRICT	qt_registros_w 
from	regra_envio_email_compra 
where	cd_estabelecimento = NEW.cd_estabelecimento 
and	ie_tipo_mensagem = NEW.ie_tipo_mensagem 
and	ie_email_dia_util = 'S' 
and	ie_situacao = 'A';
 
if (qt_registros_w > 0) then 
	ie_email_dia_util_w := 'S';
end if;
 
if (coalesce(qt_maximo_w,0) >= 0) then 
	BEGIN 
	 
	select	count(distinct a.nr_sequencia) 
	into STRICT	qt_pendente_w 
	from	envio_email_compra_agrup a, 
		email_compra_agrup_dest x 
	where	x.nr_seq_envio = a.nr_sequencia	 
	and	cd_estabelecimento = NEW.cd_estabelecimento 
	and	coalesce(a.ie_cancelado,'N') = 'N' 
	and	coalesce(x.ie_enviado,'N') = 'N';
	 
	if (qt_pendente_w >= qt_maximo_w) then 
		BEGIN 
		if (ie_email_dia_util_w = 'S') then 
			if (obter_se_dia_util(LOCALTIMESTAMP, NEW.cd_estabelecimento) = 'S')then 
				CALL envia_email_compra_agrupado(NEW.ie_tipo_mensagem, 'N', NEW.cd_estabelecimento);
			end if;
		else 
			CALL envia_email_compra_agrupado(NEW.ie_tipo_mensagem, 'N', NEW.cd_estabelecimento);
		end if;
		end;
	end if;
 
	end;
end if;
 
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_log_envio_email_temp_afinsert() FROM PUBLIC;

CREATE TRIGGER log_envio_email_temp_afinsert
	AFTER INSERT ON log_envio_email_temp FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_log_envio_email_temp_afinsert();

