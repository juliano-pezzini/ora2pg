-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS convenio_receb_adic_insert ON convenio_receb_adic CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_convenio_receb_adic_insert() RETURNS trigger AS $BODY$
declare

dt_documento_w		timestamp;
vl_movimento_w		double precision;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;

c01 CURSOR FOR
	SELECT		a.nm_atributo,
			a.cd_tipo_lote_contab
	from		atributo_contab a
	where 		a.cd_tipo_lote_contab = 11
	and 		a.nm_atributo in ('VL_ADICIONAL', 'VL_CAMBIAL_ATIVO', 'VL_CAMBIAL_PASSIVO');

c01_w		c01%rowtype;

BEGIN

if (TG_OP = 'INSERT') then

	select  dt_recebimento,
		cd_estabelecimento
	into STRICT    dt_documento_w,
		cd_estabelecimento_w
	from    Convenio_Receb a
	where   a.nr_sequencia		= NEW.nr_seq_receb;

	open c01;
	loop
	fetch c01 into
	c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		BEGIN

		vl_movimento_w		:= NEW.vl_adicional;

		if (c01_w.nm_atributo = 'VL_CAMBIAL_ATIVO') and (coalesce(NEW.vl_cambial_ativo,0) != 0) then
			BEGIN
			vl_movimento_w	:= NEW.vl_cambial_ativo;
			end;
		elsif (c01_w.nm_atributo = 'VL_CAMBIAL_PASSIVO') and (coalesce(NEW.vl_cambial_passivo,0) != 0) then
			BEGIN
			vl_movimento_w	:= NEW.vl_cambial_passivo;
			end;
		end if;

		if (coalesce(vl_movimento_w, 0) <> 0) and (coalesce(NEW.nr_seq_trans_financ, 0) <> 0) then
			BEGIN
			CALL ctb_concil_financeira_pck.ctb_gravar_documento(
										cd_estabelecimento_w,
										trunc(dt_documento_w),
										c01_w.cd_tipo_lote_contab,
										NEW.nr_seq_trans_financ,
										8,
										NEW.nr_seq_receb,
										NEW.nr_sequencia,
										null,
										vl_movimento_w,
										'CONVENIO_RECEB_ADIC',
										c01_w.nm_atributo,
										NEW.nm_usuario);

			end;
		end if;
		end;
	end loop;
	close c01;

elsif (TG_OP = 'UPDATE') then
	BEGIN
	update  ctb_documento
	set     vl_movimento 		= coalesce(NEW.vl_adicional,0),
		nr_seq_trans_financ	= NEW.nr_seq_trans_financ
	where     nm_tabela   		= 'CONVENIO_RECEB_ADIC'
	and     nr_documento		= NEW.nr_seq_receb
	and	nr_seq_doc_compl 	= NEW.nr_sequencia
	and	nm_atributo		= 'VL_ADICIONAL'
	and	coalesce(nr_lote_contabil,0)	= 0;

	update  ctb_documento
	set     vl_movimento 		= coalesce(NEW.vl_cambial_ativo,0),
		nr_seq_trans_financ	= NEW.nr_seq_trans_financ
	where     nm_tabela   		= 'CONVENIO_RECEB_ADIC'
	and     nr_documento		= NEW.nr_seq_receb
	and	nr_seq_doc_compl 	= NEW.nr_sequencia
	and	nm_atributo		= 'VL_CAMBIAL_ATIVO'
	and	coalesce(nr_lote_contabil,0)	= 0;

	update  ctb_documento
	set     vl_movimento 		= coalesce(NEW.vl_cambial_passivo,0),
		nr_seq_trans_financ	= NEW.nr_seq_trans_financ
	where     nm_tabela   		= 'CONVENIO_RECEB_ADIC'
	and     nr_documento		= NEW.nr_seq_receb
	and	nr_seq_doc_compl 	= NEW.nr_sequencia
	and	nm_atributo		= 'VL_CAMBIAL_PASSIVO'
	and	coalesce(nr_lote_contabil,0)	= 0;
	end;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_convenio_receb_adic_insert() FROM PUBLIC;

CREATE TRIGGER convenio_receb_adic_insert
	AFTER INSERT OR UPDATE ON convenio_receb_adic FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_convenio_receb_adic_insert();

