-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS ish_pessoa_classif_afterpost ON pessoa_classif CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_ish_pessoa_classif_afterpost() RETURNS trigger AS $BODY$
declare

reg_integracao_w		gerar_int_padrao.reg_integracao;
nr_prontuario_w			pessoa_fisica.nr_prontuario%type;
ie_funcionario_w		pessoa_fisica.ie_funcionario%type;
nr_seq_conselho_w		pessoa_fisica.nr_seq_conselho%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nr_cpf_w 			pessoa_fisica.nr_cpf%type;

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then
	cd_pessoa_fisica_w		:=	coalesce(NEW.cd_pessoa_fisica, OLD.cd_pessoa_fisica);
	reg_integracao_w.ie_operacao	:=	'A';

	if (cd_pessoa_fisica_w is not null) then
		select	pf.nr_prontuario,
			pf.ie_funcionario,
			pf.nr_seq_conselho,
			nr_cpf
		into STRICT	nr_prontuario_w,
			ie_funcionario_w,
			nr_seq_conselho_w,
			nr_cpf_w
		from	pessoa_fisica pf
		where	pf.cd_pessoa_fisica = cd_pessoa_fisica_w;

		reg_integracao_w.nr_prontuario		:=	nr_prontuario_w;
		reg_integracao_w.cd_pessoa_fisica	:=	cd_pessoa_fisica_w;
		reg_integracao_w.ie_funcionario		:=	coalesce(ie_funcionario_w,'N');
		reg_integracao_w.nr_seq_conselho	:=	nr_seq_conselho_w;
		reg_integracao_w.nr_seq_classif_pessoa	:=	coalesce(NEW.nr_seq_classif, OLD.nr_seq_classif);

		select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
		into STRICT	reg_integracao_w.ie_pessoa_atend
		from	pessoa_fisica_aux
		where	cd_pessoa_fisica = cd_pessoa_fisica_w
		and	nr_primeiro_atend is not null;

		if (nr_cpf_w is not null) then
			reg_integracao_w.ie_possui_cpf := 'S';
		end if;

		if (wheb_usuario_pck.get_ie_lote_contabil = 'N') then
			reg_integracao_w := gerar_int_padrao.gravar_integracao('12', cd_pessoa_fisica_w, coalesce(NEW.nm_usuario, obter_usuario_ativo), reg_integracao_w);
			
			if (reg_integracao_w.nr_prontuario is not null) then
				BEGIN
				if (TG_OP = 'DELETE') then
					reg_integracao_w.ie_operacao	:=	'E';
				end if;
				
				reg_integracao_w := gerar_int_padrao.gravar_integracao('370', coalesce(NEW.nr_sequencia, OLD.nr_sequencia) || '|' || cd_pessoa_fisica_w, coalesce(NEW.nm_usuario, obter_usuario_ativo), reg_integracao_w);	
				reg_integracao_w.ie_operacao	:=	'A';
				end;
			end if;
		end if;

		if (ie_funcionario_w = 'S') then
			reg_integracao_w := gerar_int_padrao.gravar_integracao('304', cd_pessoa_fisica_w, coalesce(NEW.nm_usuario, obter_usuario_ativo), reg_integracao_w);
		end if;
	end if;
end if;

IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_ish_pessoa_classif_afterpost() FROM PUBLIC;

CREATE TRIGGER ish_pessoa_classif_afterpost
	AFTER INSERT OR UPDATE OR DELETE ON pessoa_classif FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_ish_pessoa_classif_afterpost();

