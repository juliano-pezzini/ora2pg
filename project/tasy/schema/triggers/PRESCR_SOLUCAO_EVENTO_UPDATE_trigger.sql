-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_solucao_evento_update ON prescr_solucao_evento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_solucao_evento_update() RETURNS trigger AS $BODY$
DECLARE

ie_status_w	varchar(5);
BEGIN
	
if ((coalesce(OLD.ie_evento_valido,'S') = 'S') and (coalesce(NEW.ie_evento_valido,'S') = 'N')) then

	update EVOLUCAO_PACIENTE
	set ie_situacao 	= 'I',
		dt_inativacao 	= LOCALTIMESTAMP,
		nm_usuario_inativacao = NEW.nm_usuario
	where cd_evolucao 	= OLD.cd_evolucao
	and ie_situacao 	= 'A';
end if;

if (NEW.ie_evento_valido	= 'N') then
	update	atendimento_perda_ganho
	set	dt_inativacao		= LOCALTIMESTAMP,
		nm_usuario_inativacao	= NEW.nm_usuario,
    ie_situacao = 'I'
	where	nr_seq_evento_Adep	= NEW.nr_sequencia;
end if;

if (OLD.ie_evento_valido	= 'S') and --So executar se estiver inativando.
	(NEW.ie_evento_valido	= 'N') and (NEW.ie_tipo_solucao	=  2 ) and (NEW.nr_seq_nut_atend is not null) then
	
	Select	CASE WHEN NEW.ie_alteracao=1 THEN  'I' WHEN NEW.ie_alteracao=2 THEN  'INT' WHEN NEW.ie_alteracao=3 THEN  'I' WHEN NEW.ie_alteracao=4 THEN  'T' END
	into STRICT	ie_status_w
	;
					
	update	nut_atend_serv_dia
	set	ie_status_adep	= CASE WHEN ie_status_w='T' THEN  'I' WHEN ie_status_w='INT' THEN  'I' WHEN ie_status_w='I' THEN  'N'  ELSE 'N' END ,
		nm_usuario_adm	 = NULL,
		dt_fim_horario	 = NULL
	where	nr_sequencia	= NEW.nr_seq_nut_atend;
end if;

RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_solucao_evento_update() FROM PUBLIC;

CREATE TRIGGER prescr_solucao_evento_update
	BEFORE UPDATE ON prescr_solucao_evento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_solucao_evento_update();

