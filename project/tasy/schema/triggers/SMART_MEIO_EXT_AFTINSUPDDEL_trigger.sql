-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS smart_meio_ext_aftinsupddel ON conversao_meio_externo CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_smart_meio_ext_aftinsupddel() RETURNS trigger AS $BODY$
declare

reg_integracao_w		gerar_int_padrao.reg_integracao;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
ie_integra_w			varchar(1) := 'N';
nr_seq_conversao_w		conversao_meio_externo.nr_sequencia%type;
nm_usuario_w			conversao_meio_externo.nm_usuario%type;
ie_evento_w				varchar(10) := '327';

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;

If (coalesce(NEW.ie_sistema_externo,OLD.ie_sistema_externo) = 'SMART') and (coalesce(NEW.nm_tabela,OLD.nm_tabela) = 'PE_PROCEDIMENTO')
	then
	
		
	Select	OBTER_ESTABELECIMENTO_ATIVO
	into STRICT	cd_estabelecimento_w
	;	
	
	if (TG_OP = 'DELETE') then
	
		nr_seq_conversao_w := OLD.CD_INTERNO;
		nm_usuario_w 		:= OLD.nm_usuario;
	
	else
	
		nr_seq_conversao_w := NEW.CD_INTERNO;
		nm_usuario_w 		:= NEW.nm_usuario;
	
	end if;
	
	Select 	Smart_obter_se_sae(nr_seq_conversao_w, cd_estabelecimento_w, ie_evento_w,'RC',nm_usuario_w)
	into STRICT	ie_integra_w
	;
			
	if (coalesce( ie_integra_w,'N') = 'S') then

		reg_integracao_w.cd_estab_documento	:=	cd_estabelecimento_w;
	
		if (TG_OP = 'INSERT') then
			BEGIN	
				reg_integracao_w := gerar_int_padrao.gravar_integracao(ie_evento_w, nr_seq_conversao_w, nm_usuario_w, reg_integracao_w, 'DS_OPERACAO_P=CREATE');
			END;	
		elsif (TG_OP = 'UPDATE') then
			BEGIN		
				reg_integracao_w := gerar_int_padrao.gravar_integracao(ie_evento_w, nr_seq_conversao_w, nm_usuario_w, reg_integracao_w, 'DS_OPERACAO_P=UPDATE');	
			END;
		elsif (TG_OP = 'DELETE') then
			BEGIN	
				reg_integracao_w := gerar_int_padrao.gravar_integracao(ie_evento_w, nr_seq_conversao_w, nm_usuario_w, reg_integracao_w, 'DS_OPERACAO_P=DELETE');
			END;
		end if;
	
	end if;

end if;

<<Final>>
ie_integra_w	:= 'N';

IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_smart_meio_ext_aftinsupddel() FROM PUBLIC;

CREATE TRIGGER smart_meio_ext_aftinsupddel
	AFTER INSERT OR UPDATE OR DELETE ON conversao_meio_externo FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_smart_meio_ext_aftinsupddel();

