-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS rp_tratamento_delete ON rp_tratamento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_rp_tratamento_delete() RETURNS trigger AS $BODY$
declare

qtd_w			integer;
ie_permite_excluir_w	varchar(1);

BEGIN
ie_permite_excluir_w := obter_param_usuario(9091, 33, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_permite_excluir_w);

if (ie_permite_excluir_w <> 'S') then
	SELECT 	count(*)
	into STRICT	qtd_w
	FROM   	RP_PAC_MODELO_AGENDAMENTO  a
	WHERE  	a.NR_SEQ_PAC_REAB = OLD.NR_SEQ_PAC_REAV
	AND    	EXISTS ( SELECT 1
			FROM   RP_PAC_MODELO_AGEND_ITEM x
			WHERE  x.NR_SEQ_MODELO_PAC = a.nr_sequencia
			and	exists (
					SELECT 1
					from 	agenda_consulta c
					where	c.NR_SEQ_RP_MOD_ITEM = x.nr_sequencia));

	if (qtd_w > 0) then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264207);
	end if;
end if;
RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_rp_tratamento_delete() FROM PUBLIC;

CREATE TRIGGER rp_tratamento_delete
	BEFORE DELETE ON rp_tratamento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_rp_tratamento_delete();

