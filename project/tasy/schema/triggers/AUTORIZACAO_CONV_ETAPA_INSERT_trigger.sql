-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS autorizacao_conv_etapa_insert ON autorizacao_conv_etapa CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_autorizacao_conv_etapa_insert() RETURNS trigger AS $BODY$
declare

dt_inicio_vigencia_w	timestamp;
dt_fim_vigencia_w	timestamp;
nr_seq_autor_conv_w	bigint;
ie_param_w		varchar(1);


pragma autonomous_transaction;
BEGIN
  BEGIN

if (NEW.nr_seq_autor_conv is null) and (NEW.nr_seq_autor_cir is not null) then
	BEGIN

	select	max(nr_seq_autor_conv)
	into STRICT	nr_seq_autor_conv_w
	from	autorizacao_cirurgia
	where	nr_sequencia = NEW.nr_seq_autor_cir;

	if (nr_seq_autor_conv_w is not null) then
		BEGIN
		NEW.nr_seq_autor_conv  := nr_seq_autor_conv_w;
		end;
	end if;

	end;
end if;

select	max(dt_inicio_vigencia),
	max(dt_fim_vigencia)
into STRICT	dt_inicio_vigencia_w,
	dt_fim_vigencia_w
from	autorizacao_convenio
where 	nr_sequencia	= NEW.nr_seq_autor_conv;

if (dt_inicio_vigencia_w is not null) and (NEW.dt_inicio_vigencia is null) then
	NEW.dt_inicio_vigencia	:= dt_inicio_vigencia_w;
end if;

if (dt_fim_vigencia_w is not null) and (NEW.dt_fim_vigencia is null) then
	NEW.dt_fim_vigencia	:= dt_fim_vigencia_w;
end if;

if (NEW.nr_seq_autor_conv is not null) then
	BEGIN
	NEW.vl_autorizacao		:=  coalesce(obter_valor_autorizacao(NEW.nr_seq_autor_conv),0);
	exception
		when others then
		NEW.vl_autorizacao		:= 0;
	end;
end if;

ie_param_w := obter_param_usuario(3004, 116, obter_perfil_ativo, NEW.nm_usuario, obter_estabelecimento_ativo, ie_param_w);

if (ie_param_w = 'S') then

	update	autorizacao_conv_etapa
	set     dt_fim_etapa = LOCALTIMESTAMP
	where   nr_seq_autor_conv = NEW.nr_seq_autor_conv
	and     dt_fim_etapa is null
	and     nr_sequencia <> NEW.nr_sequencia;

end if;

commit;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_autorizacao_conv_etapa_insert() FROM PUBLIC;

CREATE TRIGGER autorizacao_conv_etapa_insert
	BEFORE INSERT ON autorizacao_conv_etapa FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_autorizacao_conv_etapa_insert();

