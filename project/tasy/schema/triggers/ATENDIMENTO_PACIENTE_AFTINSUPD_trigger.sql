-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atendimento_paciente_aftinsupd ON atendimento_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atendimento_paciente_aftinsupd() RETURNS trigger AS $BODY$
declare
ie_insere_profissional_w	varchar(1);
nm_medico_resp_usuario_w atendimento_paciente.nm_usuario%type;

C01 CURSOR FOR
SELECT distinct obter_usuario_pf(a.cd_prescritor) nm_usuario_medico
from pessoa_fisica c,
medico b,
prescr_medica a
where b.cd_pessoa_fisica = c.cd_pessoa_fisica
and a.cd_prescritor = b.cd_pessoa_fisica
and a.nr_atendimento = NEW.nr_atendimento
and b.ie_situacao = 'A'

union

select distinct obter_usuario_pf(a.cd_medico ) nm_usuario_medico
from pessoa_fisica c,
medico b,
evolucao_paciente a
where b.cd_pessoa_fisica = c.cd_pessoa_fisica
and a.cd_medico = b.cd_pessoa_fisica
and a.nr_atendimento =  NEW.nr_atendimento
and b.ie_situacao = 'A'

union

select distinct obter_usuario_pf(b.cd_medico)  nm_usuario_medico
from pessoa_fisica c,
pf_medico_externo b,
pessoa_fisica m
where b.cd_pessoa_fisica = c.cd_pessoa_fisica
and c.cd_pessoa_fisica = b.cd_pessoa_fisica
and m.cd_pessoa_fisica = b.cd_medico
and b.cd_pessoa_fisica = NEW.cd_pessoa_fisica;
BEGIN
  BEGIN

if (coalesce(pkg_i18n.get_user_locale, 'pt_BR')='ja_JP' and NEW.ie_tipo_atendimento = 1) then
     
    if (NEW.cd_medico_resp is not null) then
    CALL generate_hosp_plan_pendency(NEW.nr_atendimento,NEW.cd_pessoa_fisica,obter_usuario_pf(NEW.cd_medico_resp));
    end if;
    if (NEW.cd_medico_referido is not null) then
    CALL generate_hosp_plan_pendency(NEW.nr_atendimento,NEW.cd_pessoa_fisica,obter_usuario_pf(NEW.cd_medico_referido ));
    end if;
		for r_C01  in C01 loop
		BEGIN
			if (r_C01.nm_usuario_medico is not null) then
			CALL generate_hosp_plan_pendency(NEW.nr_atendimento,NEW.cd_pessoa_fisica,r_C01.nm_usuario_medico);
			end if;
		exception
			when others then
			null;
		end;
		end loop;
end if;
ie_insere_profissional_w := obter_valor_param_usuario(7009, 283, Obter_Perfil_Ativo, NEW.nm_usuario, NEW.cd_estabelecimento);
if (ie_insere_profissional_w = 'S') then
	if (NEW.cd_medico_resp is not null)
	and	((OLD.cd_medico_resp <> NEW.cd_medico_resp)
	or (OLD.cd_medico_resp is null and NEW.cd_medico_resp is not null)
	or (TG_OP = 'INSERT')) then
		CALL hd_gerar_profissional_rotina(NEW.nm_usuario,NEW.cd_pessoa_fisica,'M',NEW.cd_medico_resp,'U',OLD.cd_medico_resp,NEW.cd_estabelecimento);
	end if;
end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atendimento_paciente_aftinsupd() FROM PUBLIC;

CREATE TRIGGER atendimento_paciente_aftinsupd
	AFTER INSERT OR UPDATE ON atendimento_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atendimento_paciente_aftinsupd();

