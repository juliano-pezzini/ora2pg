-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS exame_lab_result_item_bef_upd ON exame_lab_result_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_exame_lab_result_item_bef_upd() RETURNS trigger AS $BODY$
declare
nr_prescricao_w		exame_lab_resultado.nr_prescricao%type;
cd_estabelecimento_w	prescr_medica.cd_estabelecimento%type;
nr_atendimento_w	prescr_medica.nr_atendimento%type;
ie_imp_cultura_aprov_w	cih_parametros.ie_imp_cultura_aprov%type;
cd_medico_resp_w	atendimento_paciente.cd_medico_resp%type;
ie_clinica_w		atendimento_paciente.ie_clinica%type;
nr_ficha_ocorrencia_w	cih_ficha_ocorrencia.nr_ficha_ocorrencia%type;
ie_libera_ficha_w	varchar(255);
qt_ficha_ocorrencia_w	integer;
 
pragma autonomous_transaction;
 
BEGIN 
if	(NEW.dt_aprovacao is not null AND OLD.dt_aprovacao is null) then 
 
	select 	max(nr_prescricao) 
	into STRICT	nr_prescricao_w 
	from 	exame_lab_resultado 
	where 	nr_seq_resultado = NEW.nr_seq_resultado;
 
	select	coalesce(max(cd_estabelecimento),1), 
		max(nr_atendimento) 
	into STRICT	cd_estabelecimento_w, 
		nr_atendimento_w 
	from	prescr_medica 
	where	nr_prescricao = nr_prescricao_w;
 
	select	coalesce(max(ie_imp_cultura_aprov),'N') 
	into STRICT	ie_imp_cultura_aprov_w 
	from	cih_parametros 
	where	cd_estabelecimento = cd_estabelecimento_w;		
 
	if (ie_imp_cultura_aprov_w = 'S') then 
 
		select	count(*) 
		into STRICT	qt_ficha_ocorrencia_w 
		from	cih_ficha_ocorrencia 
		where	nr_atendimento = nr_atendimento_w;			
 
		if (qt_ficha_ocorrencia_w = 0) then 
		 
			select	max(cd_medico_resp), 
				max(ie_clinica) 
			into STRICT	cd_medico_resp_w, 
				ie_clinica_w 
			from	atendimento_paciente 
			where	nr_atendimento = nr_atendimento_w;
			 
			ie_libera_ficha_w := Obter_Param_Usuario(936, 23, obter_perfil_ativo, NEW.nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_libera_ficha_w);
						 
			CALL ccih_gerar_ficha_ocorrencia(	nr_atendimento_w, 
							null, 
							cd_medico_resp_w, 
							NEW.nm_usuario, 
							ie_libera_ficha_w, 
							ie_clinica_w);
		end if;
		 
		select	max(nr_ficha_ocorrencia) 
		into STRICT	nr_ficha_ocorrencia_w 
		from	cih_ficha_ocorrencia 
		where	nr_atendimento = nr_atendimento_w;
			 
		if (coalesce(nr_ficha_ocorrencia_w,0) > 0) then 
			CALL cih_importar_cultura(	nr_ficha_ocorrencia_w, NEW.nm_usuario);
		end if;
		commit;	
	end if;
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_exame_lab_result_item_bef_upd() FROM PUBLIC;

CREATE TRIGGER exame_lab_result_item_bef_upd
	BEFORE UPDATE ON exame_lab_result_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_exame_lab_result_item_bef_upd();

