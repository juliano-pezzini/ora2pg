-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_aha_acc_atual ON escala_aha_acc CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_aha_acc_atual() RETURNS trigger AS $BODY$
declare
    qt_reg_w     smallint;
    sql_w        varchar(300);
    ds_retorno_w varchar(255);
    ds_erro_w   varchar(2000);
    ds_parametro_w  varchar(2000);
BEGIN
  BEGIN

    if (wheb_usuario_pck.get_ie_executar_trigger = 'N')  then
        goto Final;
    end if;

    NEW.ie_risco := null;

    /** Medical Device **/


    BEGIN
        sql_w := 'begin calcula_aha_acc_md(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14); end;';
        EXECUTE sql_w using in out NEW.ie_cirurgia_emergencia,
                                      in out NEW.ie_condicao_cardiaca,
                                      in out NEW.ie_cir_baixo_risco,
                                      in out NEW.ie_classe_funcional,
                                      in out NEW.ie_fat_risco,
                                      in NEW.ie_cardiomiopatia,
                                      in NEW.ie_isquemica,
                                      in NEW.ie_insuf_cardiaca,
                                      in NEW.ie_diabete,
                                      in NEW.ie_insuf_renal,
                                      in NEW.ie_cerebrovascular,
                                      in NEW.ie_tipo_cirurgia,
                                      out NEW.ie_risco,
                                      out ds_retorno_w;
    exception
        when others then
            NEW.ie_cirurgia_emergencia := null;
            NEW.ie_condicao_cardiaca := null;
            NEW.ie_cir_baixo_risco := null;
            NEW.ie_classe_funcional := null;
            NEW.ie_fat_risco := null;
            NEW.ie_risco := null;
            ds_retorno_w := null;

            ds_erro_w := sqlerrm;ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
            ds_parametro_w := ds_parametro_w || ' - :new.ie_cirurgia_emergencia: ' || NEW.ie_cirurgia_emergencia || ' - :new.ie_condicao_cardiaca: ' || NEW.ie_condicao_cardiaca || ' - :new.ie_cir_baixo_risco: ' || NEW.ie_cir_baixo_risco || ' - :new.ie_classe_funcional: ' || NEW.ie_classe_funcional;
            ds_parametro_w := ds_parametro_w || ' - :new.ie_fat_risco: ' || NEW.ie_fat_risco || ' - :new.ie_risco: ' || NEW.ie_risco || ' - ds_retorno_w: ' || ds_retorno_w;
            CALL gravar_log_medical_device('escala_aha_acc_atual', 'calcula_aha_acc_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;

    NEW.ds_resultado := substr(ds_retorno_w, 1, 255);

    <<Final>>
    qt_reg_w := 0;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_aha_acc_atual() FROM PUBLIC;

CREATE TRIGGER escala_aha_acc_atual
	BEFORE INSERT OR UPDATE ON escala_aha_acc FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_aha_acc_atual();

