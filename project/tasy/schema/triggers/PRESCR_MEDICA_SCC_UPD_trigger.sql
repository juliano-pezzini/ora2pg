-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_medica_scc_upd ON prescr_medica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_medica_scc_upd() RETURNS trigger AS $BODY$
DECLARE
    ds_param_integ_hl7_scc_w   varchar(2000);
    nr_sequencia_scc_w         prescr_procedimento.nr_sequencia%TYPE;
BEGIN
    IF (wheb_usuario_pck.get_ie_executar_trigger  = 'N') THEN
       GOTO Final;
    END IF;
    <<Final>>
    IF ( wheb_usuario_pck.is_evento_ativo(942) = 'S' ) AND ( NEW.dt_liberacao IS NOT NULL ) AND ( NEW.cd_medico <> OLD.cd_medico ) THEN
        SELECT MAX(a.nr_sequencia)
        INTO STRICT nr_sequencia_scc_w
        FROM
            prescr_procedimento   a,
            lab_exame_equip       e,
            equipamento_lab       f,
            exame_laboratorio     c
        WHERE
            a.nr_seq_exame = c.nr_seq_exame
            AND e.cd_equipamento = f.cd_equipamento
            AND f.ds_sigla = 'SCC'
            AND a.nr_seq_exame = e.nr_seq_exame
            AND a.nr_prescricao = NEW.nr_prescricao
            AND a.dt_cancelamento IS NULL
            AND a.dt_suspensao IS NULL
            AND a.dt_envio_integracao IS NOT NULL  LIMIT 1;

        IF ( nr_sequencia_scc_w IS NOT NULL ) THEN
            ds_param_integ_hl7_scc_w := 'NR_PRESCRICAO_P='
                                        || NEW.nr_prescricao
                                        || '#@#@IE_ALTERACAO_MEDICO_P='
                                        || 'S'
                                        || '#@#@';

            CALL gravar_agend_integracao(942, ds_param_integ_hl7_scc_w);
        END IF;

    END IF;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_medica_scc_upd() FROM PUBLIC;

CREATE TRIGGER prescr_medica_scc_upd
	BEFORE UPDATE OF cd_medico ON prescr_medica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_medica_scc_upd();

