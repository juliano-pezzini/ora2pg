-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_consistir_evento_lote_fat ON pls_conta_pos_estabelecido CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_consistir_evento_lote_fat() RETURNS trigger AS $BODY$
declare

BEGIN
if (coalesce(wheb_usuario_pck.get_ie_executar_trigger,'S') = 'S') then

	if (NEW.nr_seq_lote_fat is not null) and (NEW.nr_seq_evento_fat is null) then
		-- Não é permitido conta pós-estabelecido com lote de faturamento e sem evento informado.
		CALL wheb_mensagem_pck.exibir_mensagem_abort(323392);
	end if;

	if (NEW.nr_seq_lote_fat is null) and (NEW.nr_seq_evento_fat is not null) then
		-- Não é permitido conta pós-estabelecido sem lote de faturamento e com evento informado.
		CALL wheb_mensagem_pck.exibir_mensagem_abort(323393);
	end if;

	if (TG_OP = 'INSERT') then
		insert 	into	pls_log_pos_estabelecido(nr_sequencia, dt_atualizacao,	nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, ie_status_faturamento_ant,
			ie_status_faturamento_new, nr_seq_conta, nr_seq_conta_pos,
			ie_tipo_registro, ds_log)
		values (nextval('pls_log_pos_estabelecido_seq'),LOCALTIMESTAMP,NEW.nm_usuario,
			LOCALTIMESTAMP, NEW.nm_usuario, OLD.ie_status_faturamento,
			NEW.ie_status_faturamento, NEW.nr_seq_conta, NEW.nr_sequencia,
			'H',dbms_utility.format_call_stack);
	end if;
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_consistir_evento_lote_fat() FROM PUBLIC;

CREATE TRIGGER pls_consistir_evento_lote_fat
	AFTER INSERT OR UPDATE ON pls_conta_pos_estabelecido FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_consistir_evento_lote_fat();

