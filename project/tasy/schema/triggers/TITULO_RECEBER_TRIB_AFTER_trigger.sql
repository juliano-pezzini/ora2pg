-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_receber_trib_after ON titulo_receber_trib CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_receber_trib_after() RETURNS trigger AS $BODY$
declare

cd_estabelecimento_w	ctb_documento.cd_estabelecimento%type;
dt_movimento_w		ctb_documento.dt_competencia%type;
nr_seq_proj_rec_w       ctb_documento.nr_seq_proj_rec%type;

c01 CURSOR FOR
	SELECT	a.nm_atributo,
		a.cd_tipo_lote_contab
	from	atributo_contab a
	where 	a.cd_tipo_lote_contab = 5
	and 	a.nm_atributo in ( 'VL_TRIB_RETIDO');

c01_w		c01%rowtype;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
select	cd_estabelecimento, nr_seq_proj_rec
into STRICT	cd_estabelecimento_w, nr_seq_proj_rec_w
from	titulo_receber
where	nr_titulo = NEW.nr_titulo;

dt_movimento_w:= coalesce(NEW.dt_tributo,NEW.dt_contabil);

open c01;
loop
fetch c01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN

	if (coalesce(NEW.vl_tributo, 0) <> 0) and (coalesce(NEW.nr_seq_nota_fiscal, 0) <> 0) then
		BEGIN
		
		CALL ctb_concil_financeira_pck.ctb_gravar_documento(	cd_estabelecimento_w,
									trunc(dt_movimento_w),
									c01_w.cd_tipo_lote_contab,
									NEW.nr_seq_trans_financ,
									45,
									NEW.nr_titulo,
									NEW.nr_sequencia,
									0,
									NEW.vl_tributo,
									'TITULO_RECEBER_TRIB',
									c01_w.nm_atributo,
									NEW.nm_usuario,
                                    'P',
                                    null,
                                    nr_seq_proj_rec_w);

		end;
	end if;

	end;
end loop;
close c01;

end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_receber_trib_after() FROM PUBLIC;

CREATE TRIGGER titulo_receber_trib_after
	AFTER INSERT ON titulo_receber_trib FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_receber_trib_after();

