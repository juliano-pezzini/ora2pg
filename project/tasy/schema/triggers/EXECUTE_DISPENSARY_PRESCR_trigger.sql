-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS execute_dispensary_prescr ON prescr_medica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_execute_dispensary_prescr() RETURNS trigger AS $BODY$
DECLARE
    SUBTYPE one_char                        IS varchar(1);
    SUBTYPE two_char                        IS varchar(2);
    SUBTYPE three_char                      IS varchar(3);
    SUBTYPE five_char                       IS varchar(5);
    SUBTYPE ten_char                        IS varchar(10);
    SUBTYPE eleven_char                     IS varchar(11);
    SUBTYPE twelve_char                     IS varchar(12);
    SUBTYPE thirteen_char                   IS varchar(13);
    SUBTYPE fifteen_char                    IS varchar(15);
    SUBTYPE sixteen_char                    IS varchar(16);
    SUBTYPE nineteen_char                   IS varchar(19);
    SUBTYPE twenty_two_char                 IS varchar(22);
    SUBTYPE fourty_three_char               IS varchar(43);
    SUBTYPE two_hundred_fifty_five_char     IS varchar(255);
    SUBTYPE four_thousand_char              IS varchar(4000);

contador_w                     integer;
seqMaterial_w                  prescr_material.nr_seq_material%TYPE;
patientCustomerCode_w          two_hundred_fifty_five_char;
startDate_w                    two_hundred_fifty_five_char;
productCustomerCode_w          prescr_material.cd_material%TYPE;
quantity_w                     prescr_material.qt_material%TYPE;
dosageAmount_w                 prescr_material.qt_dose%TYPE;
dosageFrequency_w              prescr_material.nr_ocorrencia%TYPE;
dosageStartHour_w              two_char;
urgency_w                      two_hundred_fifty_five_char;
json_w                         evolucao_paciente.ds_evolucao%TYPE;
nr_material_w                  integer;
sector_w                       integer;
material_w                     integer;
qtd_products_w                 integer;

c_nr_integration_code CONSTANT integer := 666;
char_S_c CONSTANT one_char := 'S';
sub_11_c CONSTANT five_char := '11';
sub_0_c CONSTANT integer := 0;
sub_1_c CONSTANT integer := 1;
sub_2_c CONSTANT integer := 2;
sub_24_c CONSTANT integer := 24;
error_code_generic_c CONSTANT integer := 21979;
error_message_generic_c CONSTANT fourty_three_char := 'Error executing EXECUTE_DISPENSARY_PRESCR.';
forma_integracao_M_c CONSTANT dis_parametros_int.ie_forma_integracao%TYPE := 'M';
forma_integracao_B_c CONSTANT dis_parametros_int.ie_forma_integracao%TYPE := 'B';
forma_integracao_S_c CONSTANT dis_parametros_int.ie_forma_integracao%TYPE := 'S';
forma_integracao_C_c CONSTANT dis_parametros_int.ie_forma_integracao%TYPE := 'C';
date_formate_c CONSTANT ten_char := 'YYYY-MM-DD';
date_formate_h CONSTANT five_char := 'HH24';
json_comma_c CONSTANT one_char := ',';
json_quotation_mark_c CONSTANT one_char := '"';
json_open_bracket_c CONSTANT one_char := '[';
json_closed_bracket_c CONSTANT one_char := ']';
json_open_brace_c CONSTANT one_char := '{';
json_closed_brace_c CONSTANT one_char := '}';
ie_forma_integracao_w dis_parametros_int.ie_forma_integracao%TYPE;
true_string_c CONSTANT fifteen_char := 'true';
false_string_c CONSTANT fifteen_char := 'false';
json_customerCode_str_c CONSTANT fifteen_char := '"customerCode":';
json_ptCustomCode_string_c CONSTANT twenty_two_char := '"patientCustomerCode":';
json_startDate_string_c CONSTANT thirteen_char := '"startDate": ';

json_products_string_c CONSTANT twelve_char := '"products":';
json_prodCustomCod_string_c CONSTANT twenty_two_char := '"productCustomerCode":';
json_quantity_string_c CONSTANT twelve_char := '"quantity":';
json_dosageAmount_string_c CONSTANT sixteen_char  := '"dosageAmount":';
json_dosageFrequency_string_c CONSTANT nineteen_char := '"dosageFrequency":';
json_dosageStartHour_string_c CONSTANT nineteen_char := '"dosageStartHour":';
json_urgency_string_c CONSTANT eleven_char := '"urgency":';
json_descMaterial_string_c CONSTANT sixteen_char := '"descMaterial":';
json_seqMaterial_string_c CONSTANT fifteen_char := '"seqMaterial":';

pragma autonomous_transaction;

C01 CURSOR FOR
      SELECT
        p.cd_material,
        p.qt_dose,
        round((p.qt_material)::numeric,0) qt_material,
        sub_24_c/p.nr_ocorrencia ocorrencia,
        (to_char(NEW.dt_primeiro_horario, date_formate_h))::numeric  primeiro_horario,
        p.nr_seq_material,
      case when p.ie_urgencia = forma_integracao_S_c then true_string_c
            else false_string_c
      end urgency
      FROM
        prescr_material p
      where nr_prescricao = NEW.nr_prescricao
      and p.nr_ocorrencia  <> 0;
BEGIN
  BEGIN
    IF (wheb_usuario_pck.get_ie_executar_trigger = char_S_c) THEN

      IF (NEW.dt_liberacao is not null) THEN

        SELECT
          count(distinct a.nr_sequencia) 
        INTO STRICT 
          ie_forma_integracao_w 
        FROM dis_parametros_int a 
        WHERE ie_forma_integracao IN (forma_integracao_M_c, forma_integracao_B_c);

        IF (ie_forma_integracao_w is not null AND ie_forma_integracao_w > 0) THEN
            contador_w  := 0;

            select
                count(a.nr_sequencia) 
            into STRICT 
                sector_w
            from 
                DIS_REGRA_SETOR a
            join  DIS_REGRA_LOCAL_SETOR b 
              on a.nr_sequencia = b.nr_seq_dis_regra_setor
            join  local_estoque c 
              on b.cd_local_estoque = c.cd_local_estoque
            where a.cd_setor_atendimento = NEW.cd_setor_atendimento
            and c.ie_tipo_local = sub_11_c;

            IF (sector_w is not null) THEN
                BEGIN
                  <<get_count_products>>

                    SELECT
                        count(p.cd_material)
                    INTO STRICT
                        qtd_products_w
                    FROM
                        prescr_material p
                        where nr_prescricao = NEW.nr_prescricao
                        and p.nr_ocorrencia  <> sub_0_c;
                  end;

                  BEGIN
                  <<get_atendiment_date>>
                    SELECT
                      obter_pessoa_atendimento(NEW.nr_atendimento,forma_integracao_C_c),
                      to_char(NEW.dt_primeiro_horario, date_formate_c)
                    INTO STRICT
                      patientCustomerCode_w,
                      startDate_w
;
                EXCEPTION
                    WHEN no_data_found THEN 
                      RAISE EXCEPTION '%', error_message_generic_c USING ERRCODE = error_code_generic_c;
                    WHEN too_many_rows THEN
                      RAISE EXCEPTION '%', error_message_generic_c USING ERRCODE = error_code_generic_c;
                END;

                if (qtd_products_w is not null AND qtd_products_w > 0) THEN
                    json_w := json_open_bracket_c ||
                    json_open_brace_c ||
                    json_customerCode_str_c || json_quotation_mark_c ||  NEW.nr_prescricao || json_quotation_mark_c || json_comma_c || 
                    json_ptCustomCode_string_c || json_quotation_mark_c ||  patientCustomerCode_w || json_quotation_mark_c || json_comma_c || 
                    json_startDate_string_c || json_quotation_mark_c ||  startDate_w || json_quotation_mark_c;

                    IF (qtd_products_w > sub_0_c) THEN
                        json_w := json_w ||
                        json_comma_c ||
                        json_products_string_c || json_open_bracket_c;
                    END IF;
               END IF;
               OPEN C01;
                  <<cursor_open>>
                    LOOP
                        FETCH C01 INTO
                        productCustomerCode_w,

                        dosageAmount_w,
                        quantity_w,
                        dosageFrequency_w,
                        dosageStartHour_w,
                        seqMaterial_w,
                        urgency_w;
                        EXIT cursor_open WHEN c01%notfound;

                        BEGIN

                          SELECT
                            count(a.cd_material)
                          INTO STRICT
                            nr_material_w 
                          FROM
                            PADRAO_ESTOQUE_LOCAL a
                          JOIN DIS_REGRA_LOCAL_SETOR b
                            ON a.cd_local_estoque = b.cd_local_estoque
                          JOIN DIS_REGRA_SETOR c
                            ON c.nr_sequencia = b.nr_seq_dis_regra_setor
                          where c.cd_setor_atendimento = NEW.cd_setor_atendimento
                            and a.cd_material = productCustomerCode_w;

                            IF (nr_material_w is not null AND nr_material_w > 0 and contador_w > 0) THEN
                                json_w := json_w || json_comma_c ||  json_open_brace_c  ||
                                json_prodCustomCod_string_c || json_quotation_mark_c ||  productCustomerCode_w || json_quotation_mark_c || json_comma_c ||
                                json_dosageAmount_string_c ||  dosageAmount_w || json_comma_c ||
                                json_quantity_string_c ||  quantity_w || json_comma_c ||
                                json_dosageFrequency_string_c ||  dosageFrequency_w || json_comma_c ||
                                json_dosageStartHour_string_c ||  dosageStartHour_w || json_comma_c ||
                                json_seqMaterial_string_c || json_quotation_mark_c ||  seqMaterial_w || json_quotation_mark_c || json_comma_c ||
                                json_urgency_string_c || urgency_w || json_closed_brace_c;
                            END IF;

                            IF (nr_material_w is not null AND nr_material_w > 0 and contador_w = 0) THEN
                                json_w := json_w ||  json_open_brace_c  ||
                                json_prodCustomCod_string_c || json_quotation_mark_c ||  productCustomerCode_w || json_quotation_mark_c || json_comma_c ||
                                json_dosageAmount_string_c ||  dosageAmount_w || json_comma_c ||
                                json_quantity_string_c ||  quantity_w || json_comma_c ||
                                json_dosageFrequency_string_c ||  dosageFrequency_w || json_comma_c ||
                                json_dosageStartHour_string_c ||  dosageStartHour_w || json_comma_c ||
                                json_seqMaterial_string_c || json_quotation_mark_c ||  seqMaterial_w || json_quotation_mark_c || json_comma_c ||
                                json_urgency_string_c || urgency_w || json_closed_brace_c;
                                contador_w := contador_w + sub_1_c;
                            END IF;
                        END;
                END LOOP cursor_open;
                close c01;
                json_w := json_w  || json_closed_bracket_c || json_closed_brace_c || json_closed_bracket_c;
                CALL execute_bifrost_integration(c_nr_integration_code, json_w);
            END IF;
        END IF;
    END IF;
  END IF;
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_execute_dispensary_prescr() FROM PUBLIC;

CREATE TRIGGER execute_dispensary_prescr
	AFTER UPDATE ON prescr_medica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_execute_dispensary_prescr();

