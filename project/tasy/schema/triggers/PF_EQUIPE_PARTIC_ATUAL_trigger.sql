-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pf_equipe_partic_atual ON pf_equipe_partic CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pf_equipe_partic_atual() RETURNS trigger AS $BODY$
DECLARE
ds_alteracao_w			varchar(4000);
ds_funcao_old_w 		funcao_medico.ds_funcao%TYPE;
ds_funcao_new_w			funcao_medico.ds_funcao%TYPE;
ds_cargo_equipe_new_w 	pf_cargo_equipe.ds_cargo%TYPE;
ds_cargo_equipe_old_w 	pf_cargo_equipe.ds_cargo%TYPE;
ds_cargo_old_w			varchar(400);
ds_cargo_new_w			varchar(400);
 
BEGIN 
 
IF (TG_OP = 'UPDATE') THEN 
	IF (coalesce(OLD.CD_PESSOA_FISICA,'X') <> coalesce(NEW.CD_PESSOA_FISICA,'X')) THEN 
		/*806521	780628	Foi alterado o participante de #@NM_PARTICIPANTE_OLD#@ (Código: #@CD_PESSOA_FISICA_OLD#@) para #@NM_PARTICIPANTE_NEW#@ (Código: #@CD_PESSOA_FISICA_NEW#@). */
 
		ds_alteracao_w	:= SUBSTR(wheb_mensagem_pck.get_texto(806521, 
							'NM_PARTICIPANTE_OLD='|| SUBSTR(obter_nome_pf(OLD.CD_PESSOA_FISICA),1,60) || ';CD_PESSOA_FISICA_OLD=' || OLD.CD_PESSOA_FISICA || 
							';NM_PARTICIPANTE_NEW='|| SUBSTR(obter_nome_pf(NEW.CD_PESSOA_FISICA),1,60) || ';CD_PESSOA_FISICA_NEW=' || NEW.CD_PESSOA_FISICA) ,1,4000);
		CALL gravar_hist_pf_equipe_partic(NEW.NR_SEQ_EQUIPE,'U',ds_alteracao_w,NEW.nm_usuario);
	END IF;
 
	IF (coalesce(OLD.CD_CARGO,-1) <> coalesce(NEW.CD_CARGO,-1)) THEN 
		/*806522	780629	Foi alterado o cargo do participante #@NM_PARTICIPANTE#@ (Código: #@CD_PESSOA_FISICA#@) de #@DS_CARGO_OLD#@ (Código: #@CD_CARGO_OLD#@) para #@DS_CARGO_NEW#@ (Código: #@CD_CARGO_NEW#@). */
 
 
		IF (coalesce(OLD.CD_CARGO, -1) > 0)	THEN 
			ds_cargo_old_w	:=	SUBSTR(';DS_CARGO_OLD='|| SUBSTR(obter_desc_cargo(OLD.CD_CARGO),1,200) || ';CD_CARGO_OLD='|| OLD.CD_CARGO, 1, 400);
		ELSE 
			ds_cargo_old_w	:=	SUBSTR(';DS_CARGO_OLD='|| wheb_mensagem_pck.get_texto(806558) || ';CD_CARGO_OLD='|| wheb_mensagem_pck.get_texto(806558), 1, 400);
		END IF;
 
		IF (coalesce(NEW.CD_CARGO,-1) > 0)	THEN 
			ds_cargo_new_w	:=	SUBSTR(';DS_CARGO_NEW='|| SUBSTR(obter_desc_cargo(NEW.CD_CARGO),1,200) || ';CD_CARGO_NEW='|| NEW.CD_CARGO, 1, 400);
		ELSE 
			ds_cargo_new_w	:=	SUBSTR(';DS_CARGO_NEW='|| wheb_mensagem_pck.get_texto(806558)|| ';CD_CARGO_NEW='|| wheb_mensagem_pck.get_texto(806558), 1, 400);
		END IF;
 
		ds_alteracao_w	:= 	SUBSTR(wheb_mensagem_pck.get_texto(806522, 
							'NM_PARTICIPANTE=' || SUBSTR(obter_nome_pf(NEW.CD_PESSOA_FISICA),1,60) || ';CD_PESSOA_FISICA=' || NEW.CD_PESSOA_FISICA || ds_cargo_old_w || ds_cargo_new_w), 1, 4000);
 
		CALL gravar_hist_pf_equipe_partic(NEW.NR_SEQ_EQUIPE,'U',ds_alteracao_w,NEW.nm_usuario);
	END IF;
 
	IF (coalesce(OLD.NR_SEQ_CARGO_EQUIPE,-1) <> coalesce(NEW.NR_SEQ_CARGO_EQUIPE,-1)) THEN 
		/*806524	780630	Foi alterado o campo Função do participante #@NM_PARTICIPANTE#@ (Código: #@CD_PESSOA_FISICA#@) de #@DS_CARGO_EQUIPE_OLD#@ (Código: #@NR_SEQ_CARGO_EQUIPE_OLD#@) para #@DS_CARGO_EQUIPE_NEW#@ (Código: #@NR_SEQ_CARGO_EQUIPE_NEW#@). */
 
		ds_alteracao_w	:=	SUBSTR('NM_PARTICIPANTE=' || SUBSTR(obter_nome_pf(NEW.CD_PESSOA_FISICA),1,60) || ';CD_PESSOA_FISICA=' || NEW.CD_PESSOA_FISICA ,1,4000);
 
		IF (coalesce(OLD.NR_SEQ_CARGO_EQUIPE,-1) > 0)	THEN 
			SELECT	MAX(coalesce(ds_cargo,wheb_mensagem_pck.get_texto(806558))) 
			INTO STRICT	ds_cargo_equipe_old_w 
			FROM  pf_cargo_equipe 
			WHERE	nr_sequencia = OLD.nr_seq_cargo_equipe;
 
			ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_CARGO_EQUIPE_OLD='|| ds_cargo_equipe_old_w || ';NR_SEQ_CARGO_EQUIPE_OLD='|| OLD.NR_SEQ_CARGO_EQUIPE ,1,4000);
		ELSE 
			ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_CARGO_EQUIPE_OLD='|| wheb_mensagem_pck.get_texto(806558) || ';NR_SEQ_CARGO_EQUIPE_OLD='|| wheb_mensagem_pck.get_texto(806558) ,1,4000);
		END IF;
 
		IF (coalesce(OLD.NR_SEQ_CARGO_EQUIPE,-1) > 0)	THEN 
			SELECT	MAX(coalesce(ds_cargo,wheb_mensagem_pck.get_texto(806558))) 
			INTO STRICT 	ds_cargo_equipe_new_w 
			FROM  pf_cargo_equipe 
			WHERE	nr_sequencia = NEW.nr_seq_cargo_equipe;
 
			ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_CARGO_EQUIPE_NEW='|| ds_cargo_equipe_new_w || ';NR_SEQ_CARGO_EQUIPE_NEW='|| OLD.NR_SEQ_CARGO_EQUIPE ,1,4000);
		ELSE 
			ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_CARGO_EQUIPE_NEW='|| wheb_mensagem_pck.get_texto(806558) || ';NR_SEQ_CARGO_EQUIPE_NEW='|| wheb_mensagem_pck.get_texto(806558) ,1,4000);
		END IF;
 
		ds_alteracao_w	:=	SUBSTR(wheb_mensagem_pck.get_texto(806524, SUBSTR(ds_alteracao_w, 1, 4000)), 1, 4000);
		CALL gravar_hist_pf_equipe_partic(NEW.NR_SEQ_EQUIPE,'U',ds_alteracao_w,NEW.nm_usuario);
	END IF;
 
	IF (coalesce(OLD.IE_FUNCAO,-1) <> coalesce(NEW.IE_FUNCAO,-1)) THEN 
		/*806526	780631	Foi alterado o campo Função cirurgia do participante #@NM_PARTICIPANTE#@ (Código: #@CD_PESSOA_FISICA#@) de #@DS_FUNCAO_OLD#@ (Código: #@IE_FUNCAO_OLD#@) para #@DS_FUNCAO_NEW#@ (Código: #@IE_FUNCAO_NEW#@). */
 
 
		ds_alteracao_w	:=	SUBSTR('NM_PARTICIPANTE=' || SUBSTR(obter_nome_pf(NEW.CD_PESSOA_FISICA),1,60) || ';CD_PESSOA_FISICA=' || NEW.CD_PESSOA_FISICA ,1,4000);
 
		IF (coalesce(OLD.IE_FUNCAO,-1) > 0)	THEN 
			SELECT	MAX(coalesce(ds_funcao,wheb_mensagem_pck.get_texto(806558))) 
			INTO STRICT	ds_funcao_old_w 
			FROM  funcao_medico 
			WHERE cd_funcao = OLD.ie_funcao;
 
			ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_FUNCAO_OLD='|| ds_funcao_old_w || ';IE_FUNCAO_OLD='|| OLD.IE_FUNCAO ,1,4000);
 
		ELSE 
			ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_FUNCAO_OLD='|| wheb_mensagem_pck.get_texto(806558) || ';IE_FUNCAO_OLD='|| wheb_mensagem_pck.get_texto(806558) ,1,4000);
		END IF;
 
		IF (coalesce(NEW.IE_FUNCAO,-1) > 0)	THEN 
			SELECT	MAX(coalesce(ds_funcao,wheb_mensagem_pck.get_texto(806558))) 
			INTO STRICT 	ds_funcao_new_w 
			FROM  funcao_medico 
			WHERE	cd_funcao = NEW.ie_funcao;
 
			ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_FUNCAO_NEW='|| ds_funcao_old_w || ';IE_FUNCAO_NEW='|| OLD.IE_FUNCAO ,1,4000);
 
		ELSE 
			ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_FUNCAO_NEW='|| wheb_mensagem_pck.get_texto(806558) || ';IE_FUNCAO_NEW='|| wheb_mensagem_pck.get_texto(806558) ,1,4000);
		END IF;
 
		ds_alteracao_w	:=	SUBSTR(wheb_mensagem_pck.get_texto(806526, SUBSTR(ds_alteracao_w, 1, 4000)), 1, 4000);
		CALL gravar_hist_pf_equipe_partic(NEW.NR_SEQ_EQUIPE,'U',ds_alteracao_w,NEW.nm_usuario);
	END IF;
 
ELSE 
	/*806527	780632	Realizada inclusão do participante #@NM_PARTICIPANTE_NEW#@ (Código: #@CD_PESSOA_FISICA_NEW#@).*/
 
	ds_alteracao_w	:= SUBSTR(wheb_mensagem_pck.get_texto(806527, 'NM_PARTICIPANTE_NEW='|| SUBSTR(obter_nome_pf(NEW.CD_PESSOA_FISICA),1,60) || ';CD_PESSOA_FISICA_NEW=' || NEW.CD_PESSOA_FISICA), 1, 4000);
	CALL gravar_hist_pf_equipe_partic(NEW.NR_SEQ_EQUIPE,'I',ds_alteracao_w,NEW.nm_usuario);
 
END IF;
 
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pf_equipe_partic_atual() FROM PUBLIC;

CREATE TRIGGER pf_equipe_partic_atual
	AFTER INSERT OR UPDATE ON pf_equipe_partic FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pf_equipe_partic_atual();

