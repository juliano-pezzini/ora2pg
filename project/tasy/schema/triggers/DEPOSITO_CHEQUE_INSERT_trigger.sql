-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS deposito_cheque_insert ON deposito_cheque CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_deposito_cheque_insert() RETURNS trigger AS $BODY$
declare
ie_existe_cheque_w	varchar(1)	:= 'N';
ie_consistir_w		varchar(1)	:= 'N';
ie_permite_deposito_w	varchar(1)	:= 'S';
cd_moeda_w		cheque_cr.cd_moeda%type;
nr_cheque_w		cheque_cr.nr_cheque%type;
ds_moeda_w		moeda.ds_moeda%type;
ds_moeda_deposito_w	moeda.ds_moeda%type;
cd_estabelecimento_w	deposito.cd_estabelecimento%type;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	deposito a
where	a.nr_sequencia	= NEW.nr_seq_deposito;

ie_permite_deposito_w := obter_param_usuario(810, 81, obter_perfil_ativo, NEW.nm_usuario, coalesce(cd_estabelecimento_w,0), ie_permite_deposito_w);

if (coalesce(ie_permite_deposito_w,'S') = 'N') then

	select	coalesce(max('S'),'N')
	into STRICT	ie_existe_cheque_w
	from	deposito_cheque a
	where	a.nr_seq_deposito	= NEW.nr_seq_deposito;

	if (ie_existe_cheque_w = 'S') then

		select	max(a.cd_moeda),
			max(a.nr_cheque)
		into STRICT	cd_moeda_w,
			nr_cheque_w
		from	cheque_cr a
		where	a.nr_seq_cheque		= NEW.nr_seq_cheque;
		
		select	coalesce(max('N'),'S')
		into STRICT	ie_consistir_w
		from	deposito_cheque a,
			cheque_cr b
		where	a.nr_seq_cheque		= b.nr_seq_cheque
		and	a.nr_seq_deposito	= NEW.nr_seq_deposito
		and	b.cd_moeda		= cd_moeda_w;
		
		if (ie_consistir_w = 'S') then
			select	max(a.ds_moeda)
			into STRICT	ds_moeda_w
			from	moeda a
			where	a.cd_moeda	= cd_moeda_w;
			
			select	max(c.ds_moeda)
			into STRICT	ds_moeda_deposito_w
			from	deposito_cheque a,
				cheque_cr b,
				moeda c
			where	a.nr_seq_cheque		= b.nr_seq_cheque
			and	b.cd_moeda		= c.cd_moeda
			and	a.nr_seq_deposito	= NEW.nr_seq_deposito;
			
			/* O cheque nr_cheque_w e em cd_moeda_w. O deposito nr_seq_deposito_w so permite cheques em cd_moeda_deposito_w! */


			CALL wheb_mensagem_pck.exibir_mensagem_abort(302904,	'NR_CHEQUE_W='||nr_cheque_w||
									';CD_MOEDA_W='||ds_moeda_w||
									';NR_SEQ_DEPOSITO_W='||NEW.nr_seq_deposito||
									';CD_MOEDA_DEPOSITO_W='||ds_moeda_deposito_w);
		end if;
		
	end if;
end if;

end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_deposito_cheque_insert() FROM PUBLIC;

CREATE TRIGGER deposito_cheque_insert
	BEFORE INSERT ON deposito_cheque FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_deposito_cheque_insert();

