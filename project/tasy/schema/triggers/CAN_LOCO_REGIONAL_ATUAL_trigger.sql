-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS can_loco_regional_atual ON can_loco_regional CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_can_loco_regional_atual() RETURNS trigger AS $BODY$
declare
qt_reg_w	smallint;
ie_situacao_w varchar(1);

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;

if (coalesce(OLD.DT_AVALIACAO,LOCALTIMESTAMP + interval '10 days') <> NEW.DT_AVALIACAO) and (NEW.DT_AVALIACAO is not null) then
	NEW.ds_utc		:= obter_data_utc(NEW.DT_AVALIACAO, 'HV');	
end if;

if (coalesce(OLD.DT_LIBERACAO,LOCALTIMESTAMP + interval '10 days') <> NEW.DT_LIBERACAO) and (NEW.DT_LIBERACAO is not null) then
	NEW.ds_utc_atualizacao	:= obter_data_utc(NEW.DT_LIBERACAO,'HV');
end if;

if (OLD.dt_inativacao is null) and (NEW.dt_inativacao is not  null) then
	
	update 	diagnostico_doenca
	set		dt_inativacao = NEW.dt_inativacao
	where 	nr_seq_loco_reg = NEW.nr_sequencia;
		
end if;

if (NEW.cd_doenca_cid is not null) and (NEW.nr_atendimento is not null) and (NEW.dt_inativacao is null) then
	CALL consistir_diagnostico_atend(NEW.cd_doenca_cid,NEW.nr_atendimento);
end if;

if (NEW.CD_TUMOR_PRIM_PAT is not null) and (NEW.CD_LINFONODO_REG_PAT is not null) and (NEW.CD_METASTASE_DIST_PAT is not null) and (NEW.CD_ESTADIO_OUTRO is not null) and (NEW.DT_PTNM is null) then
	NEW.DT_PTNM	:= LOCALTIMESTAMP;
end if;

select   	max(ie_situacao)
into STRICT 	ie_situacao_w
from   	cido_topografia
where   	cd_topografia = NEW.cd_topografia;

if (ie_situacao_w	= 'I') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(850904);
end if;

<<Final>>
qt_reg_w	:= 0;

RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_can_loco_regional_atual() FROM PUBLIC;

CREATE TRIGGER can_loco_regional_atual
	BEFORE INSERT OR UPDATE ON can_loco_regional FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_can_loco_regional_atual();

