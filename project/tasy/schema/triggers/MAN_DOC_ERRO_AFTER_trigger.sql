-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS man_doc_erro_after ON man_doc_erro CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_man_doc_erro_after() RETURNS trigger AS $BODY$
DECLARE
	ds_log_w				varchar(2000);
	ds_enter_w				varchar(10) := chr(13) || chr(10);
	dt_min_date_w			timestamp := to_date('30/12/1899 00:00:00', 'dd/mm/yyyy hh24:mi:ss');
	ds_erro_w				varchar(2000);
BEGIN
  BEGIN 
	
	
	if (wheb_usuario_pck.get_ie_executar_trigger = 'S') and (coalesce(OLD.NR_SEQUENCIA, 0) > 0) and (coalesce(NEW.DT_LIBERACAO, dt_min_date_w) <> coalesce(OLD.DT_LIBERACAO, dt_min_date_w)) then
		ds_log_w	:= substr('# Dados Tasy #'  || ds_enter_w ||
				'Estabelecimento: ' || wheb_usuario_pck.get_cd_estabelecimento	||	ds_enter_w ||
				'Funcao: '			|| wheb_usuario_pck.get_cd_funcao			||	ds_enter_w ||
				'Perfil: '			|| wheb_usuario_pck.get_cd_perfil			||	ds_enter_w ||
				'Usuario: ' 		|| wheb_usuario_pck.get_nm_usuario			||	ds_enter_w ||
				'Form: '			|| wheb_usuario_pck.get_ds_form 			||	ds_enter_w ||
				'Maquina: ' 		|| wheb_usuario_pck.get_nm_maquina			||	ds_enter_w ||
				'Estacao: ' 		|| wheb_usuario_pck.get_nm_estacao			||	ds_enter_w ||
				'Data_log: '		|| to_char(LOCALTIMESTAMP,'dd/mm/yyyy hh24:mi:ss')	||	ds_enter_w,1,2000);
				
		insert into MAN_DOC_ERRO_LOG(NR_SEQUENCIA,
									NR_SEQ_ORDEM_SERV,
									DT_ATUALIZACAO,
									NM_USUARIO,
									DT_ATUALIZACAO_NREC,
									NM_USUARIO_NREC,
									NR_SEQ_TIPO,
									IE_GRAVIDADE,
									QT_CLIENTE,
									CD_PESSOA_FISICA,
									NR_SEQ_GRUPO_DES,
									DS_ACAO_IMEDIATA,
									DS_SOLUCAO,
									IE_ORIGEM_ERRO,
									NR_SEQ_CLASSIF,
									IE_IDENT_ERRO,
									DT_LIBERACAO,
									IE_FORMA_ORIGEM,
									DS_JUSTIFICATIVA,
									CD_PESSOA_RESP,
									IE_LIBERA_CORRECAO,
									IE_RECORRENTE,
									DT_OCORRENCIA_ERRO,
									NR_SEQ_SUBTIPO,
									IE_FEEDBACK_ORIENTACAO,
									NM_USUARIO_LIBEROU_ERRO,
									NR_SEQ_ORDEM_ORIGEM,
									IE_BASE_CLIENTE,
									NR_SEQ_MOTIVO_TESTES,
									IE_SITUACAO_FUNCAO,
									DS_ACAO_SEVERIDADE,
									CD_EMPRESA,
									CD_APLICACAO,
									CD_VERSAO_ALTERACAO,
									NR_SEQ_LP,
									NR_SEQ_ORDEM_DEF,
									CD_VERSAO_IDENT,
									NR_SEQ_PROJ_DEF,
									DS_LOG_MODIFICAO)
					values (nextval('man_doc_erro_log_seq'),
									NEW.NR_SEQ_ORDEM,
									NEW.DT_ATUALIZACAO,
									NEW.NM_USUARIO,
									NEW.DT_ATUALIZACAO_NREC,
									NEW.NM_USUARIO_NREC,
									NEW.NR_SEQ_TIPO,
									NEW.IE_GRAVIDADE,
									NEW.QT_CLIENTE,
									NEW.CD_PESSOA_FISICA,
									NEW.NR_SEQ_GRUPO_DES,
									NEW.DS_ACAO_IMEDIATA,
									NEW.DS_SOLUCAO,
									NEW.IE_ORIGEM_ERRO,
									NEW.NR_SEQ_CLASSIF,
									NEW.IE_IDENT_ERRO,
									NEW.DT_LIBERACAO,
									NEW.IE_FORMA_ORIGEM,
									NEW.DS_JUSTIFICATIVA,
									NEW.CD_PESSOA_RESP,
									NEW.IE_LIBERA_CORRECAO,
									NEW.IE_RECORRENTE,
									NEW.DT_OCORRENCIA_ERRO,
									NEW.NR_SEQ_SUBTIPO,
									NEW.IE_FEEDBACK_ORIENTACAO,
									NEW.NM_USUARIO_LIBEROU_ERRO,
									NEW.NR_SEQ_ORDEM_ORIGEM,
									NEW.IE_BASE_CLIENTE,
									NEW.NR_SEQ_MOTIVO_TESTES,
									NEW.IE_SITUACAO_FUNCAO,
									NEW.DS_ACAO_SEVERIDADE,
									NEW.CD_EMPRESA,
									NEW.CD_APLICACAO,
									NEW.CD_VERSAO_ALTERACAO,
									NEW.NR_SEQ_LP,
									NEW.NR_SEQ_ORDEM_DEF,
									NEW.CD_VERSAO_IDENT,
									NEW.NR_SEQ_PROJ_DEF,
									ds_log_w);	
	end if;
	
  EXCEPTION
	 when others then 
	ds_erro_w   :=  SUBSTR(SQLERRM, 1, 2000);

	insert into MAN_DOC_ERRO_LOG(NR_SEQUENCIA,
								NR_SEQ_ORDEM_SERV,
								DT_ATUALIZACAO,
								NM_USUARIO,
								DT_ATUALIZACAO_NREC,
								NM_USUARIO_NREC,
								NR_SEQ_TIPO,
								IE_GRAVIDADE,
								QT_CLIENTE,
								CD_PESSOA_FISICA,
								NR_SEQ_GRUPO_DES,
								DS_ACAO_IMEDIATA,
								DS_SOLUCAO,
								IE_ORIGEM_ERRO,
								NR_SEQ_CLASSIF,
								IE_IDENT_ERRO,
								DT_LIBERACAO,
								IE_FORMA_ORIGEM,
								DS_JUSTIFICATIVA,
								CD_PESSOA_RESP,
								IE_LIBERA_CORRECAO,
								IE_RECORRENTE,
								DT_OCORRENCIA_ERRO,
								NR_SEQ_SUBTIPO,
								IE_FEEDBACK_ORIENTACAO,
								NM_USUARIO_LIBEROU_ERRO,
								NR_SEQ_ORDEM_ORIGEM,
								IE_BASE_CLIENTE,
								NR_SEQ_MOTIVO_TESTES,
								IE_SITUACAO_FUNCAO,
								DS_ACAO_SEVERIDADE,
								CD_EMPRESA,
								CD_APLICACAO,
								CD_VERSAO_ALTERACAO,
								NR_SEQ_LP,
								NR_SEQ_ORDEM_DEF,
								CD_VERSAO_IDENT,
								NR_SEQ_PROJ_DEF,
								DS_LOG_MODIFICAO)
				values (nextval('man_doc_erro_log_seq'), 
								NEW.NR_SEQ_ORDEM,
								NEW.DT_ATUALIZACAO,
								NEW.NM_USUARIO,
								NEW.DT_ATUALIZACAO_NREC,
								NEW.NM_USUARIO_NREC,
								NEW.NR_SEQ_TIPO,
								NEW.IE_GRAVIDADE,
								NEW.QT_CLIENTE,
								NEW.CD_PESSOA_FISICA,
								NEW.NR_SEQ_GRUPO_DES,
								NEW.DS_ACAO_IMEDIATA,
								NEW.DS_SOLUCAO,
								NEW.IE_ORIGEM_ERRO,
								NEW.NR_SEQ_CLASSIF,
								NEW.IE_IDENT_ERRO,
								NEW.DT_LIBERACAO,
								NEW.IE_FORMA_ORIGEM,
								NEW.DS_JUSTIFICATIVA,
								NEW.CD_PESSOA_RESP,
								NEW.IE_LIBERA_CORRECAO,
								NEW.IE_RECORRENTE,
								NEW.DT_OCORRENCIA_ERRO,
								NEW.NR_SEQ_SUBTIPO,
								NEW.IE_FEEDBACK_ORIENTACAO,
								NEW.NM_USUARIO_LIBEROU_ERRO,
								NEW.NR_SEQ_ORDEM_ORIGEM,
								NEW.IE_BASE_CLIENTE,
								NEW.NR_SEQ_MOTIVO_TESTES,
								NEW.IE_SITUACAO_FUNCAO,
								NEW.DS_ACAO_SEVERIDADE,
								NEW.CD_EMPRESA,
								NEW.CD_APLICACAO,
								NEW.CD_VERSAO_ALTERACAO,
								NEW.NR_SEQ_LP,
								NEW.NR_SEQ_ORDEM_DEF,
								NEW.CD_VERSAO_IDENT,
								NEW.NR_SEQ_PROJ_DEF,
								ds_erro_w);
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_man_doc_erro_after() FROM PUBLIC;

CREATE TRIGGER man_doc_erro_after
	AFTER UPDATE ON man_doc_erro FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_man_doc_erro_after();

