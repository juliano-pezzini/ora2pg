-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS gestao_vaga_befinsert ON gestao_vaga CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_gestao_vaga_befinsert() RETURNS trigger AS $BODY$
declare

cd_area_proc_w	    bigint;
cd_especial_proc_w  bigint;
cd_grupo_proc_w		bigint;	
BEGIN
  BEGIN

if (NEW.nr_seq_proc_interno = 0) then
	NEW.nr_seq_proc_interno := null;
end if;

if (NEW.cd_procedimento > 0) then
	BEGIN
	select	cd_area_procedimento,
			cd_especialidade,
			cd_grupo_proc
	into STRICT	cd_area_proc_w,
			cd_especial_proc_w,
			cd_grupo_proc_w
	from	estrutura_procedimento_v
	where	cd_procedimento	= NEW.cd_procedimento
	and		ie_origem_proced	= NEW.ie_origem_proced;
	exception
		when no_data_found then
			--' Nao foi encontrada estrutura para este procedimento '||cd_procedimento_p||'! #@#@' || ie_origem_proced_p);

			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(192951, 'CD_PROCEDIMENTO_P=' || NEW.cd_procedimento ||
									';IE_ORIGEM_PROCED_P=' || NEW.ie_origem_proced);
	end;
		
end if;

if (NEW.ie_status = 'R' and OLD.ie_status <> NEW.ie_status) then
  	 NEW.DT_ULT_DATA_RESERVA := LOCALTIMESTAMP;
end if;

  END;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_gestao_vaga_befinsert() FROM PUBLIC;

CREATE TRIGGER gestao_vaga_befinsert
	BEFORE INSERT OR UPDATE ON gestao_vaga FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_gestao_vaga_befinsert();

