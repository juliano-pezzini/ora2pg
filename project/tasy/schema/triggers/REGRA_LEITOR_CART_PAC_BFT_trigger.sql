-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS regra_leitor_cart_pac_bft ON regra_leitor_cartao_pac CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_regra_leitor_cart_pac_bft() RETURNS trigger AS $BODY$
declare ds_senha_p      varchar(255) := NEW.ds_senha;
        result_duplicate_w    varchar(2);
BEGIN

	if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

        result_duplicate_w := is_duplic_regra_leitor_cart(  NEW.nr_sequencia,
                                                            NEW.nr_endereco_ip,
                                                            NEW.nm_computador,
                                                            NEW.ie_tipo_cartao,
                                                            NEW.ie_fabricante,
                                                            NEW.ie_interface,
                                                            NEW.nr_seq_regra_conv);

		IF (NEW.ds_senha is not null
		and     coalesce(OLD.ds_senha, 'null') <> coalesce(NEW.ds_senha, 'null')
		and     result_duplicate_w = 'N') then

			NEW.ds_senha := wheb_seguranca.encrypt(ds_senha_p);
		end if;
	end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_regra_leitor_cart_pac_bft() FROM PUBLIC;

CREATE TRIGGER regra_leitor_cart_pac_bft
	BEFORE INSERT OR UPDATE ON regra_leitor_cartao_pac FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_regra_leitor_cart_pac_bft();

