-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS schem_doc_insert ON tipo_schem_doc CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_schem_doc_insert() RETURNS trigger AS $BODY$
declare

ds_title_w				varchar(2000);
ie_tipo_documentacao_w	varchar(15);
ds_mail_origin_w		varchar(255);
ds_mail_destiny_w		varchar(255);
ds_tipo_documentacao_w	varchar(255);
ds_usuario_w			varchar(255);
ds_content_w			varchar(4000);

c01 CURSOR FOR
	SELECT	a.nm_usuario_regra,
			c.ds_email
	from	usuario c,
			REGRA_ALERTA_SCH_DOC_TIPO b,
			REGRA_ALERTA_SCHEM_DOC a
	where	a.nr_sequencia = b.nr_seq_regra_alerta
	and		a.nm_usuario_regra = c.nm_usuario
	and		b.ie_tipo_documentacao = ie_tipo_documentacao_w
	and		a.ie_situacao = 'A'
	and		c.ds_email is not null;

BEGIN

if (NEW.ds_titulo is not null) and (NEW.dt_liberacao is not null and OLD.dt_liberacao is null) then
	ds_tipo_documentacao_w	:= 	obter_valor_dominio(8334,NEW.ie_tipo_documentacao);
	ds_usuario_w			:= obter_nome_usuario(NEW.nm_usuario);

	ds_title_w	:= 'New schematic documentation - ' || to_char(LOCALTIMESTAMP,'dd/mm/yyyy');
	ds_content_w	:= 'A new documentation was added inside Schematic Documentation function.' || chr(13) || chr(10) ||
						'Title: ' || coalesce(NEW.ds_titulo_eng,NEW.ds_titulo) || chr(13) || chr(10) ||
						'Included by: ' || ds_usuario_w || chr(13) || chr(10) ||
						'Type: ' || ds_tipo_documentacao_w || chr(13) || chr(10) || chr(13) || chr(10) ||
						'Please check more details on the function.';


	select	max(ds_email)
	into STRICT	ds_mail_origin_w
	from	usuario a
	where	a.nm_usuario = 'avisoemail';

	if (ds_mail_origin_w is not null) then
		ie_tipo_documentacao_w	:= NEW.ie_tipo_documentacao;

		for r_c01 in c01 loop
			CALL enviar_email(ds_title_w,
						ds_content_w,
						ds_mail_origin_w,
						r_c01.ds_email,
						'avisoemail',
						'B',
						null);
		end loop;
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_schem_doc_insert() FROM PUBLIC;

CREATE TRIGGER schem_doc_insert
	AFTER INSERT OR UPDATE ON tipo_schem_doc FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_schem_doc_insert();

