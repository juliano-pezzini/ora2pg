-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atendimento_acompanhante_atual ON atendimento_acompanhante CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atendimento_acompanhante_atual() RETURNS trigger AS $BODY$
declare
ie_atend_visit_bloq_w varchar(01) := '';
ie_atend_visit_lib_w varchar(01) := '';
ie_atend_visit_pessoa_w varchar(01) := '';
BEGIN
  BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then	
    BEGIN
        select 'S'
        into STRICT	ie_atend_visit_bloq_w
        from	atendimento_acomp_bloq
        where	nr_atendimento	= NEW.nr_atendimento
        and (cd_pessoa_fisica	= NEW.cd_pessoa_fisica or NM_PESSOA_FISICA = NEW.nm_acompanhante)  LIMIT 1;
    exception
    when others then
        ie_atend_visit_bloq_w := 'N';
    end;
    if (ie_atend_visit_bloq_w = 'S') then
        CALL Wheb_mensagem_pck.exibir_mensagem_abort(1045155);
    end if;

    select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END 
    into STRICT	ie_atend_visit_lib_w
    from	acompanhante_visita_lib
    where	nr_atendimento	= NEW.nr_atendimento
    and (cd_pessoa_lib	is not null or nm_pessoa_liberacao is not null);

    select	CASE WHEN count(*)=0 THEN  'S'  ELSE 'N' END 
    into STRICT	ie_atend_visit_pessoa_w
    from	acompanhante_visita_lib a
    where	a.nr_atendimento	= NEW.nr_atendimento
    and (a.cd_pessoa_lib	= NEW.cd_pessoa_fisica or upper(a.nm_pessoa_liberacao) = upper(NEW.nm_acompanhante))
    and	not exists ( SELECT 	1 
                    from	atendimento_acomp_bloq b
                    where (b.cd_pessoa_fisica	= NEW.cd_pessoa_fisica or b.NM_PESSOA_FISICA = NEW.nm_acompanhante)
                    and		a.nr_atendimento = b.nr_atendimento
                    );

    if (ie_atend_visit_lib_w = 'S' and
        ie_atend_visit_pessoa_w = 'S') then
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1045155);
    end if;

    if (NEW.nr_controle is not null) and
        ((OLD.nr_controle is null) or (NEW.nr_controle != OLD.nr_controle)) then
        CALL valida_cracha_integracao(NEW.nm_usuario, somente_numero(NEW.nr_controle));
    end if;
end if;
      END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atendimento_acompanhante_atual() FROM PUBLIC;

CREATE TRIGGER atendimento_acompanhante_atual
	BEFORE INSERT OR UPDATE ON atendimento_acompanhante FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atendimento_acompanhante_atual();

