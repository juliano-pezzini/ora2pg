-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS autorizacao_convenio_aftupdate ON autorizacao_convenio CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_autorizacao_convenio_aftupdate() RETURNS trigger AS $BODY$
declare
qt_existe_w			bigint;
nr_sequencia_w			bigint;
ie_interno_w			varchar(255) := '';
ie_agua_just_med_w		varchar(1) := '';
ds_classificacao_new_w		varchar(255) := '';
ds_classificacao_old_w		varchar(255) := '';
ds_estagio_w			varchar(255) := '';
ds_titulo_w			varchar(255) := 'Log de alteracao na autorizacao convenio';
ds_historico_w			varchar(4000):= '';
dt_parametro_w			timestamp	:= ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(LOCALTIMESTAMP);
nr_seq_etapa_autor_w		bigint;
ie_medico_w       		varchar(1);
ds_texto_padrao_w		text;
nr_seq_anexo_tiss_w		bigint;
dt_bed_approval_w		timestamp;
ie_status_old_w			varchar(2) := '';
ie_current_bed_status 		varchar(2) := '';
cd_estab_pck_autor_w		estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;
ie_new_bed_status_w		varchar(2) := '';
cd_mapped_profile_w		varchar(10) := '';
ds_modulo_w			varchar(48);
ds_action_old_w			varchar(32) := '';
ie_parcial_w			estagio_autorizacao.ie_parcial%type;
nr_seq_just_exists_w paciente_justificativa.nr_sequencia%type;
ie_tipo_autor_w autorizacao_convenio.ie_tipo_autorizacao%type := NEW.IE_TIPO_AUTORIZACAO;

C01 CURSOR FOR
	SELECT	ds_texto_padrao
	from	texto_padrao_justif_solic
	where	ie_tipo_justificativa = NEW.ie_tipo_autorizacao
	and 	ie_situacao = 'A';
	
c02 CURSOR FOR
SELECT	nr_sequencia
from	tiss_anexo_guia
where	nr_sequencia_autor = NEW.nr_sequencia;
BEGIN
  BEGIN

if coalesce(wheb_usuario_pck.get_ie_executar_trigger, 'S') = 'S' then

	ie_agua_just_med_w := Obter_Param_Usuario(3004, 236, obter_perfil_ativo, NEW.nm_usuario, cd_estab_pck_autor_w, ie_agua_just_med_w);

	if (cd_estab_pck_autor_w is null) then
		cd_estab_pck_autor_w := NEW.cd_estabelecimento;
	end if;

	if (ie_agua_just_med_w = 'S') then
	   select	count(*)
	   into STRICT	   qt_existe_w
	   from	   paciente_justificativa
	   where	   nr_atendimento		   = NEW.nr_atendimento
	   and	   coalesce(nr_seq_autorizacao,0) = coalesce(NEW.nr_seq_autorizacao,0);
	elsif (ie_agua_just_med_w = 'P') then
	   if (NEW.nr_seq_autorizacao is not null) and (NEW.nr_atendimento is not null) then
	      select	count(*)
	      into STRICT	   qt_existe_w
	      from	   paciente_justificativa
	      where	   nr_atendimento		   = NEW.nr_atendimento
	      and	   coalesce(nr_seq_autorizacao,0) = coalesce(NEW.nr_seq_autorizacao,0);
	   else
	      select	count(*)
	      into STRICT	   qt_existe_w
	      from	   paciente_justificativa
	      where	   nr_sequencia_autor	= NEW.nr_sequencia;
	   end if;
	end if;

	if (cd_estab_pck_autor_w is not null) then

		select	max(ds_estagio),
			max(nr_seq_etapa_autor),
			max(ie_interno),
			coalesce(max(ie_parcial),'N')
		into STRICT	ds_estagio_w,
			nr_seq_etapa_autor_w,
			ie_interno_w,
			ie_parcial_w
		from	estagio_autorizacao
		where	nr_sequencia	= NEW.nr_seq_estagio
		and	OBTER_EMPRESA_ESTAB(cd_estab_pck_autor_w) = cd_empresa;

	else
		select	max(ds_estagio),
			max(nr_seq_etapa_autor),
			max(ie_interno),
			coalesce(max(ie_parcial),'N')
		into STRICT	ds_estagio_w,
			nr_seq_etapa_autor_w,
			ie_interno_w,
			ie_parcial_w
		from	estagio_autorizacao
		where	nr_sequencia	= NEW.nr_seq_estagio;
		
	end if;



	if (coalesce(NEW.nr_seq_estagio,0) <> coalesce(OLD.nr_seq_estagio,0)) then

		DBMS_APPLICATION_INFO.READ_MODULE(ds_modulo_w, ds_action_old_w);
		DBMS_APPLICATION_INFO.SET_ACTION('AUTORIZACAO_CONVENIO_AFTUPDATE');

		if (ds_action_old_w <> 'AUTORIZACAO_INTEGRACAO_UPDATE') AND (ds_action_old_w <> 'ATUALIZAR_AUTORIZACAO_CONVENIO_I')then
			
			if (ie_interno_w = '1')  then --Necessidade
				update	autorizacao_integracao set
					cd_status_autorizacao = 'P'
				where	nr_sequencia_autor = NEW.nr_sequencia
				and	coalesce(cd_status_autorizacao,'P') <> 'P';
			/*elsif	(ie_interno_w = '2')  then --Aguardando justificativa medico
			elsif	(ie_interno_w = '3')  then --Justificado pelo medico 
			elsif	(ie_interno_w = '4')  then --Pre Admissao */

			elsif (ie_interno_w = '5')  then -- Encaminhado
				update	autorizacao_integracao set
					cd_status_autorizacao = 'E'
				where	nr_sequencia_autor = NEW.nr_sequencia
				and	coalesce(cd_status_autorizacao,'P') <> 'E';
			elsif (ie_interno_w = '10')  then --Autorizado
				update	autorizacao_integracao set
					cd_status_autorizacao = CASE WHEN ie_parcial_w='S' THEN 'PA'  ELSE 'A' END
				where	nr_sequencia_autor = NEW.nr_sequencia
				and	coalesce(cd_status_autorizacao,'P') <> 'A';
			--elsif	(ie_interno_w = '60')  then --Pendente de cancelamento

			elsif (ie_interno_w = '70')  then --Cancelado
				update	autorizacao_integracao set
					cd_status_autorizacao = 'C' --cancelado

				where	nr_sequencia_autor = NEW.nr_sequencia
				and	coalesce(cd_status_autorizacao,'P') <> 'C';
			elsif (ie_interno_w = '90')  then --Reprovado
				update	autorizacao_integracao set
					cd_status_autorizacao = 'N' --cancelado

				where	nr_sequencia_autor = NEW.nr_sequencia
				and	coalesce(cd_status_autorizacao,'P') <> 'N';
			end if;
		end if;
		
		DBMS_APPLICATION_INFO.SET_ACTION(ds_action_old_w);
		
		
		
	end if;


	BEGIN
	if (coalesce(NEW.nr_atendimento,0) > 0) and (coalesce(OLD.nr_atendimento,0) > 0) and (coalesce(NEW.nr_atendimento,0) <> coalesce(OLD.nr_atendimento,0)) then
	   if (NEW.nr_seq_autorizacao is not null) then
	      update   paciente_justificativa
	      set      nr_atendimento       = NEW.nr_atendimento
	      where    nr_seq_autorizacao	= NEW.nr_seq_autorizacao
		  and 	   nr_atendimento	    = OLD.nr_atendimento;
	   else
	      update   paciente_justificativa
	      set      nr_atendimento       = NEW.nr_atendimento
	      where    nr_sequencia_autor	= NEW.nr_sequencia;
	   end if;
	end if;														
	exception
	when others then
		null;
	end;

	if	((qt_existe_w = 0) or (ie_tipo_autor_w = 2)) and (ie_interno_w = '2') and
	   ((ie_agua_just_med_w = 'P') or (ie_agua_just_med_w = 'S' and NEW.nr_atendimento is not null)) then

		if (coalesce(NEW.ie_tipo_autorizacao,'X') = 'X') then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(236801);
		end if;

		select	nextval('paciente_justificativa_seq')
		into STRICT	nr_sequencia_w
		;
		
		SELECT obter_se_usuario_medico(NEW.nm_usuario)
		into STRICT	ie_medico_w
		;
	
		ds_texto_padrao_w:= '';
		open C01;
		loop
		fetch C01 into	
			ds_texto_padrao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			BEGIN
			ds_texto_padrao_w:= ds_texto_padrao_w;
			end;
		end loop;
		close C01;

        select max(a.nr_sequencia)
        into STRICT nr_seq_just_exists_w
        from paciente_justificativa a
        where a.nr_atendimento	   = NEW.nr_atendimento
        and	  coalesce(a.nr_seq_autorizacao,0) = coalesce(NEW.nr_seq_autorizacao,0)
        and   a.nr_sequencia_autor = NEW.nr_sequencia;

        if (nr_seq_just_exists_w is null) then
            insert into paciente_justificativa(
                nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                nr_seq_autorizacao,
                nr_atendimento,
                dt_justificativa,
                ie_tipo_justificativa,
                qt_dia_prorrogacao,
                nr_sequencia_autor,
                ie_situacao,
                ds_justificativa,
                CD_PROFISSIONAL,
                ie_gerado_job,
                cd_pessoa_fisica,-- Francisco - 23/10/06 - Inclui sequencia
                dt_liberacao_parcial) 
            values (	nr_sequencia_w,
                LOCALTIMESTAMP,
                NEW.nm_usuario,
                LOCALTIMESTAMP,
                NEW.nm_usuario,
                NEW.nr_seq_autorizacao,
                NEW.nr_atendimento,
                LOCALTIMESTAMP,
                NEW.ie_tipo_autorizacao,
                NEW.qt_dia_autorizado,
                NEW.nr_sequencia,
                'A',
                ds_texto_padrao_w,
                coalesce(CASE WHEN ie_medico_w='S' THEN Obter_Medico_Prescricao(NEW.nr_prescricao,'C')  ELSE NEW.cd_medico_solicitante END  ,null),
                'S',
                NEW.cd_pessoa_fisica,
                LOCALTIMESTAMP);
            end if;
	end if;

	--rranganath SO-1844925 - Undo the approval of the bed request when the authorization is disapproved

	BEGIN
		select 	ie_bmgmnt_status,
			cd_profile
		into STRICT 	ie_new_bed_status_w,
			cd_mapped_profile_w
		from 	map_iauth_status
		where 	ie_iauth_status = NEW.nr_seq_estagio;
	exception
		when 	no_data_found then
			BEGIN
			ie_new_bed_status_w := null;
			cd_mapped_profile_w := null;
			end;
	end;

	if (NEW.nr_seq_gestao is not null) and (ie_new_bed_status_w is not null) and (cd_mapped_profile_w is null or obter_perfil_ativo = cd_mapped_profile_w) then
		
		BEGIN
		select 	dt_aprovacao,
			ie_status
		into STRICT 	dt_bed_approval_w,
			ie_current_bed_status
		from 	gestao_vaga
		where 	nr_sequencia = NEW.nr_seq_gestao;
		
		exception
		when 	no_data_found then
			BEGIN
			dt_bed_approval_w	:= null;
			ie_current_bed_status	:= null;
			end;
		end;

		update	gestao_vaga
		set	dt_aprovacao  = NULL,
			nm_usuario_aprov  = NULL,
			nr_seq_motivo_aprov_vaga  = NULL,
			ds_justificativa_aprov  = NULL,
			ie_status = ie_new_bed_status_w
		where 	nr_sequencia = NEW.nr_seq_gestao;
		
	end if;
	--rranganath SO-1844925 - Undo the approval of the bed request when the authorization is disapproved


	if (OLD.nr_seq_classif <> NEW.nr_seq_classif) then

		select	max(ds_classificacao)
		into STRICT	ds_classificacao_old_w
		from	classif_autorizacao
		where	nr_sequencia	= OLD.nr_seq_classif;

		select	max(ds_classificacao)
		into STRICT	ds_classificacao_new_w
		from	classif_autorizacao
		where	nr_sequencia	= NEW.nr_seq_classif;

		insert into autorizacao_convenio_hist(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_atendimento,
			nr_seq_autorizacao,
			ds_historico,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_sequencia_autor)
		SELECT	nextval('autorizacao_convenio_hist_seq'),
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			NEW.nr_atendimento,
			NEW.nr_seq_autorizacao,
			wheb_mensagem_pck.get_texto(1097955) ||' ' || ds_classificacao_old_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(1097956) ||' ' || ds_classificacao_new_w,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			NEW.nr_sequencia
		;

	end if;

	if (ds_estagio_w is not null) and (OLD.nr_seq_estagio <> NEW.nr_seq_estagio) then
		insert into autorizacao_convenio_hist(nr_sequencia,
			 dt_atualizacao,
			 nm_usuario,
			 nr_atendimento,
			 nr_seq_autorizacao,
			 ds_historico,
			 nr_sequencia_autor,
			 nr_seq_estagio)
		values (nextval('autorizacao_convenio_hist_seq'),
			 LOCALTIMESTAMP,
			 NEW.nm_usuario,
			 NEW.nr_atendimento,
			 NEW.nr_seq_autorizacao,
			 ds_estagio_w,
			 NEW.nr_sequencia,
			 NEW.nr_seq_estagio);
	end if;

	if (coalesce(nr_seq_etapa_autor_w,0) <> 0) and (NEW.nr_seq_estagio <> OLD.nr_seq_estagio) then

		insert	into	autorizacao_conv_etapa(nr_sequencia,
			dt_atualizacao,
			dt_atualizacao_nrec,
			dt_etapa,
			nm_usuario,
			nm_usuario_nrec,
			nr_seq_autor_conv,
			nr_seq_etapa,
			cd_pessoa_exec,
			ds_observacao)
		values (nextval('autorizacao_conv_etapa_seq'),
			LOCALTIMESTAMP,
			LOCALTIMESTAMP,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			NEW.nm_usuario,
			NEW.nr_sequencia,
			nr_seq_etapa_autor_w,
			obter_pf_usuario(NEW.nm_usuario,'C'),
			'Gerado pela etapa do estagio'
			);
	end if;

	--Lhalves OS 789476 em 13/10/2014 - A senha e a guia devem ser atualizados tambem no anexo, mesmo se ja liberado e autorizado.

	if (NEW.cd_autorizacao <> OLD.cd_autorizacao) or (NEW.cd_autorizacao is not null and OLD.cd_autorizacao is null) then

		open C02;
		loop
		fetch C02 into	
			nr_seq_anexo_tiss_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			BEGIN
			
			update	tiss_anexo_guia
			set	nr_guia_principal	= coalesce(NEW.cd_autorizacao,nr_guia_principal)
			where	nr_sequencia		= nr_seq_anexo_tiss_w;
			
			end;
		end loop;
		close C02;
	end if;

	if (NEW.cd_senha <> OLD.cd_senha) or (NEW.cd_senha is not null and OLD.cd_senha is null)then

		open C02;
		loop
		fetch C02 into	
			nr_seq_anexo_tiss_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			BEGIN
			
			update	tiss_anexo_guia
			set	cd_senha	= coalesce(NEW.cd_senha,cd_senha)
			where	nr_sequencia	= nr_seq_anexo_tiss_w;
			
			end;
		end loop;
		close C02;
	end if;

	BEGIN
	if (coalesce(NEW.nr_atendimento,0) <> coalesce(OLD.nr_atendimento,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_ATENDIMENTO - Antes: '||OLD.nr_atendimento||' Depois: '||NEW.nr_atendimento||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_autorizacao,0) <> coalesce(OLD.nr_seq_autorizacao,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_AUTORIZACAO - Antes: '||OLD.nr_seq_autorizacao||' Depois: '||NEW.nr_seq_autorizacao||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_convenio,0) <> coalesce(OLD.cd_convenio,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: CD_CONVENIO - Antes: '||OLD.cd_convenio||' Depois: '||NEW.cd_convenio||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_autorizacao,0) <> coalesce(OLD.cd_autorizacao,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: CD_AUTORIZACAO - Antes: '||OLD.cd_autorizacao||' Depois: '||NEW.cd_autorizacao||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.dt_autorizacao,dt_parametro_w) <> coalesce(OLD.dt_autorizacao,dt_parametro_w)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: DT_AUTORIZACAO - Antes: '||OLD.dt_autorizacao||' Depois: '||NEW.dt_autorizacao||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.dt_inicio_vigencia,dt_parametro_w) <> coalesce(OLD.dt_inicio_vigencia,dt_parametro_w)) then
		ds_historico_w := substr(ds_historico_w||'Campo: DT_INICIO_VIGENCIA - Antes: '||OLD.dt_inicio_vigencia||' Depois: '||NEW.dt_inicio_vigencia||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.dt_fim_vigencia,dt_parametro_w) <> coalesce(OLD.dt_fim_vigencia,dt_parametro_w)) then
		ds_historico_w := substr(ds_historico_w||'Campo: DT_FIM_VIGENCIA - Antes: '||OLD.dt_fim_vigencia||' Depois: '||NEW.dt_fim_vigencia||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nm_responsavel,0) <> coalesce(OLD.nm_responsavel,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NM_RESPONSAVEL - Antes: '||OLD.nm_responsavel||' Depois: '||NEW.nm_responsavel||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.ds_observacao,0) <> coalesce(OLD.ds_observacao,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: DS_OBSERVACAO - Antes: '||OLD.ds_observacao||' Depois: '||NEW.ds_observacao||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_senha,0) <> coalesce(OLD.cd_senha,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: CD_SENHA - Antes: '||OLD.cd_senha||' Depois: '||NEW.cd_senha||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_procedimento_principal,0) <> coalesce(OLD.cd_procedimento_principal,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: CD_PROCEDIMENTO_PRINCIPAL - Antes: '||OLD.cd_procedimento_principal||' Depois: '||NEW.cd_procedimento_principal||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.ie_origem_proced,0) <> coalesce(OLD.ie_origem_proced,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: IE_ORIGEM_PROCED - Antes: '||OLD.ie_origem_proced||' Depois: '||NEW.ie_origem_proced||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.dt_pedido_medico,dt_parametro_w) <> coalesce(OLD.dt_pedido_medico,dt_parametro_w)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: DT_PEDIDO_MEDICO - Antes: '||OLD.dt_pedido_medico||' Depois: '||NEW.dt_pedido_medico||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_medico_solicitante,0) <> coalesce(OLD.cd_medico_solicitante,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: CD_MEDICO_SOLICITANTE - Antes: '||OLD.cd_medico_solicitante||' Depois: '||NEW.cd_medico_solicitante||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.ie_tipo_guia,0) <> coalesce(OLD.ie_tipo_guia,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: IE_TIPO_GUIA - Antes: '||OLD.ie_tipo_guia||' Depois: '||NEW.ie_tipo_guia||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.qt_dia_autorizado,0) <> coalesce(OLD.qt_dia_autorizado,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: QT_DIA_AUTORIZADO - Antes: '||OLD.qt_dia_autorizado||' Depois: '||NEW.qt_dia_autorizado||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_prescricao,0) <> coalesce(OLD.nr_prescricao,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_PRESCRICAO - Antes: '||OLD.nr_prescricao||' Depois: '||NEW.nr_prescricao||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.dt_envio,dt_parametro_w) <> coalesce(OLD.dt_envio,dt_parametro_w)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: DT_ENVIO - Antes: '||OLD.dt_envio||' Depois: '||NEW.dt_envio||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.dt_retorno,dt_parametro_w) <> coalesce(OLD.dt_retorno,dt_parametro_w)) then
		ds_historico_w := substr(ds_historico_w||'Campo: DT_RETORNO - Antes: '||OLD.dt_retorno||' Depois: '||NEW.dt_retorno||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_estagio,0) <> coalesce(OLD.nr_seq_estagio,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_ESTAGIO - Antes: '||OLD.nr_seq_estagio||' Depois: '||NEW.nr_seq_estagio||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.ie_tipo_autorizacao,0) <> coalesce(OLD.ie_tipo_autorizacao,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: IE_TIPO_AUTORIZACAO - Antes: '||OLD.ie_tipo_autorizacao||' Depois: '||NEW.ie_tipo_autorizacao||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.ie_tipo_dia,0) <> coalesce(OLD.ie_tipo_dia,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: IE_TIPO_DIA - Antes: '||OLD.ie_tipo_dia||' Depois: '||NEW.ie_tipo_dia||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_tipo_acomodacao,0) <> coalesce(OLD.cd_tipo_acomodacao,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: CD_TIPO_ACOMODACAO - Antes: '||OLD.cd_tipo_acomodacao||' Depois: '||NEW.cd_tipo_acomodacao||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_autor_cirurgia,0) <> coalesce(OLD.nr_seq_autor_cirurgia,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: NR_SEQ_AUTOR_CIRURGIA - Antes: '||OLD.nr_seq_autor_cirurgia||' Depois: '||NEW.nr_seq_autor_cirurgia||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.ds_indicacao,0) <> coalesce(OLD.ds_indicacao,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: DS_INDICACAO - Antes: '||OLD.ds_indicacao||' Depois: '||NEW.ds_indicacao||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.dt_geracao_cih,dt_parametro_w) <> coalesce(OLD.dt_geracao_cih,dt_parametro_w)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: DT_GERACAO_CIH - Antes: '||OLD.dt_geracao_cih||' Depois: '||NEW.dt_geracao_cih||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.qt_dia_solicitado,0) <> coalesce(OLD.qt_dia_solicitado,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: QT_DIA_SOLICITADO - Antes: '||OLD.qt_dia_solicitado||' Depois: '||NEW.qt_dia_solicitado||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_proc_interno,0) <> coalesce(OLD.nr_seq_proc_interno,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: NR_SEQ_PROC_INTERNO - Antes: '||OLD.nr_seq_proc_interno||' Depois: '||NEW.nr_seq_proc_interno||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_procedimento_convenio,0) <> coalesce(OLD.cd_procedimento_convenio,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: CD_PROCEDIMENTO_CONVENIO - Antes: '||OLD.cd_procedimento_convenio||' Depois: '||NEW.cd_procedimento_convenio||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.dt_entrada_prevista,dt_parametro_w) <> coalesce(OLD.dt_entrada_prevista,dt_parametro_w)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: DT_ENTRADA_PREVISTA - Antes: '||OLD.dt_entrada_prevista||' Depois: '||NEW.dt_entrada_prevista||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_gestao,0) <> coalesce(OLD.nr_seq_gestao,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_GESTAO - Antes: '||OLD.nr_seq_gestao||' Depois: '||NEW.nr_seq_gestao||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.ie_carater_int_tiss,0) <> coalesce(OLD.ie_carater_int_tiss,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: IE_CARATER_INT_TISS - Antes: '||OLD.ie_carater_int_tiss||' Depois: '||NEW.ie_carater_int_tiss||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_autor_origem,0) <> coalesce(OLD.nr_seq_autor_origem,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: NR_SEQ_AUTOR_ORIGEM - Antes: '||OLD.nr_seq_autor_origem||' Depois: '||NEW.nr_seq_autor_origem||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.ie_resp_autor,0) <> coalesce(OLD.ie_resp_autor,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: IE_RESP_AUTOR - Antes: '||OLD.ie_resp_autor||' Depois: '||NEW.ie_resp_autor||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_autor_desdob,0) <> coalesce(OLD.nr_seq_autor_desdob,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: NR_SEQ_AUTOR_DESDOB - Antes: '||OLD.nr_seq_autor_desdob||' Depois: '||NEW.nr_seq_autor_desdob||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_cgc_prestador,0) <> coalesce(OLD.cd_cgc_prestador,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: CD_CGC_PRESTADOR - Antes: '||OLD.cd_cgc_prestador||' Depois: '||NEW.cd_cgc_prestador||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_paciente_setor,0) <> coalesce(OLD.nr_seq_paciente_setor,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: NR_SEQ_PACIENTE_SETOR - Antes: '||OLD.nr_seq_paciente_setor||' Depois: '||NEW.nr_seq_paciente_setor||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_ciclo,0) <> coalesce(OLD.nr_ciclo,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_CICLO - Antes: '||OLD.nr_ciclo||' Depois: '||NEW.nr_ciclo||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_age_integ,0) <> coalesce(OLD.nr_seq_age_integ,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_AGE_INTEG - Antes: '||OLD.nr_seq_age_integ||' Depois: '||NEW.nr_seq_age_integ||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_paciente,0) <> coalesce(OLD.nr_seq_paciente,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: NR_SEQ_PACIENTE - Antes: '||OLD.nr_seq_paciente||' Depois: '||NEW.nr_seq_paciente||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_medico_solic_tiss,0) <> coalesce(OLD.cd_medico_solic_tiss,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: CD_MEDICO_SOLIC_TISS - Antes: '||OLD.cd_medico_solic_tiss||' Depois: '||NEW.cd_medico_solic_tiss||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_classif,0) <> coalesce(OLD.nr_seq_classif,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_CLASSIF - Antes: '||OLD.nr_seq_classif||' Depois: '||NEW.nr_seq_classif||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_interno_conta_ref,0) <> coalesce(OLD.nr_interno_conta_ref,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_INTERNO_CONTA_REF - Antes: '||OLD.nr_interno_conta_ref||' Depois: '||NEW.nr_interno_conta_ref||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_agenda_proc,0) <> coalesce(OLD.nr_seq_agenda_proc,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_AGENDA_PROC - Antes: '||OLD.nr_seq_agenda_proc||' Depois: '||NEW.nr_seq_agenda_proc||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_agenda,0) <> coalesce(OLD.nr_seq_agenda,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_AGENDA - Antes: '||OLD.nr_seq_agenda||' Depois: '||NEW.nr_seq_agenda||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.qt_dias_prazo,0) <> coalesce(OLD.qt_dias_prazo,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: QT_DIAS_PRAZO - Antes: '||OLD.qt_dias_prazo||' Depois: '||NEW.qt_dias_prazo||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_pessoa_fisica,0) <> coalesce(OLD.cd_pessoa_fisica,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: CD_PESSOA_FISICA - Antes: '||OLD.cd_pessoa_fisica||' Depois: '||NEW.cd_pessoa_fisica||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.ds_dia_ciclo,0) <> coalesce(OLD.ds_dia_ciclo,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: DS_DIA_CICLO - Antes: '||OLD.ds_dia_ciclo||' Depois: '||NEW.ds_dia_ciclo||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_setor_origem,0) <> coalesce(OLD.cd_setor_origem,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: CD_SETOR_ORIGEM - Antes: '||OLD.cd_setor_origem||' Depois: '||NEW.cd_setor_origem||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.cd_senha_provisoria,0) <> coalesce(OLD.cd_senha_provisoria,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: CD_SENHA_PROVISORIA - Antes: '||OLD.cd_senha_provisoria||' Depois: '||NEW.cd_senha_provisoria||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.dt_referencia,dt_parametro_w) <> coalesce(OLD.dt_referencia,dt_parametro_w)) then
		ds_historico_w := substr(ds_historico_w||'Campo: DT_REFERENCIA - Antes: '||OLD.dt_referencia||' Depois: '||NEW.dt_referencia||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_auditoria,0) <> coalesce(OLD.nr_seq_auditoria,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_AUDITORIA - Antes: '||OLD.nr_seq_auditoria||' Depois: '||NEW.nr_seq_auditoria||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.ds_tarja_cartao,0) <> coalesce(OLD.ds_tarja_cartao,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: DS_TARJA_CARTAO - Antes: '||OLD.ds_tarja_cartao||' Depois: '||NEW.ds_tarja_cartao||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_apres,0) <> coalesce(OLD.nr_seq_apres,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: NR_SEQ_APRES - Antes: '||OLD.nr_seq_apres||' Depois: '||NEW.nr_seq_apres||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_regra_autor,0) <> coalesce(OLD.nr_seq_regra_autor,0)) then
		ds_historico_w := substr(ds_historico_w||'Campo: NR_SEQ_REGRA_AUTOR - Antes: '||OLD.nr_seq_regra_autor||' Depois: '||NEW.nr_seq_regra_autor||chr(13)||chr(10),1,4000);
	end if;
	if (coalesce(NEW.nr_seq_guia_plano,0) <> coalesce(OLD.nr_seq_guia_plano,0)) then
		ds_historico_w  := substr(ds_historico_w||'Campo: NR_SEQ_GUIA_PLANO - Antes: '||OLD.nr_seq_guia_plano||' Depois: '||NEW.nr_seq_guia_plano||chr(13)||chr(10),1,4000);
	end if;
	exception
	when others then
		ds_historico_w := 'X';
	end;

	if (coalesce(ds_historico_w,'X') <> 'X') then
		CALL gravar_autor_conv_log_alter(NEW.nr_sequencia,ds_titulo_w,substr(ds_historico_w,1,2000),NEW.nm_usuario);
	end if;
end if;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_autorizacao_convenio_aftupdate() FROM PUBLIC;

CREATE TRIGGER autorizacao_convenio_aftupdate
	AFTER UPDATE ON autorizacao_convenio FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_autorizacao_convenio_aftupdate();

