-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS privacy_rule_atual ON privacy_rule CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_privacy_rule_atual() RETURNS trigger AS $BODY$
declare

qt_records_w	bigint;

BEGIN

if (NEW.dt_vality_end  < NEW.dt_vality_start) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(823223);
	--'Data de validade deve ser maior que a data de início.'
end if;

if (NEW.ie_situacao <> OLD.ie_situacao AND NEW.ie_situacao = 'I') then
	select	sum(qt)
	into STRICT	qt_records_w
	from (
		SELECT	count(*) qt
		from	privacy_estab_usergroup
		where	nr_seq_privacy_rule = NEW.nr_sequencia
		and	ie_situacao = 'A'
		
union all

		SELECT	count(*) qt
		from	privacy_estab_team
		where	nr_seq_privacy_rule = NEW.nr_sequencia
		and	ie_situacao = 'A'
		
union all

		select	count(*) qt
		from	privacy_estab_profile
		where	nr_seq_privacy_rule = NEW.nr_sequencia
		and	ie_situacao = 'A'
		
union all

		select	count(*) qt
		from	privacy_estab_department
		where	nr_seq_privacy_rule = NEW.nr_sequencia
		and	ie_situacao = 'A'
	) alias6;

	if (qt_records_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(950297);
		--Não é possível inativar esta regra pois ela está associada a uma permissão de acesso.
		--Você precisa excluir ou inativar a permissão de acesso antes de inativar a regra.
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_privacy_rule_atual() FROM PUBLIC;

CREATE TRIGGER privacy_rule_atual
	BEFORE INSERT OR UPDATE ON privacy_rule FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_privacy_rule_atual();

