-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_conta_pos_estab_update ON pls_conta_pos_estabelecido CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_conta_pos_estab_update() RETURNS trigger AS $BODY$
declare

qt_registro_w	bigint;
nr_seq_lote_w	bigint;

BEGIN

if (coalesce(wheb_usuario_pck.get_ie_lote_contabil,'N') = 'N') and (coalesce(wheb_usuario_pck.get_ie_atualizacao_contabil,'N') = 'N') then
	select	max(s.nr_seq_lote)
	into STRICT	nr_seq_lote_w
	from	pls_fatura_proc x,
		pls_fatura_conta c,
		pls_fatura_evento z,
		pls_fatura s,
		pls_lote_faturamento a
	where	s.nr_sequencia	= z.nr_seq_fatura
	and	z.nr_sequencia	= c.nr_seq_fatura_evento
	and	c.nr_sequencia	= x.nr_seq_fatura_conta
	and	a.nr_sequencia	= s.nr_seq_lote
	and	coalesce(s.ie_cancelamento,'X') not in ('C','E')
	and	a.nr_seq_lote_origem is null
	and	x.nr_seq_conta_pos_estab = NEW.nr_sequencia
	and	x.ie_tipo_cobranca in ('1','2');

	if (nr_seq_lote_w is null) then
		select	max(s.nr_seq_lote)
		into STRICT	nr_seq_lote_w
		from	pls_fatura_mat x,
			pls_fatura_conta c,
			pls_fatura_evento z,
			pls_fatura s,
			pls_lote_faturamento a
		where	s.nr_sequencia	= z.nr_seq_fatura
		and	z.nr_sequencia	= c.nr_seq_fatura_evento
		and	c.nr_sequencia	= x.nr_seq_fatura_conta
		and	a.nr_sequencia	= s.nr_seq_lote
		and	a.nr_seq_lote_origem is null
		and	coalesce(s.ie_cancelamento,'X') not in ('C','E')
		and	x.nr_seq_conta_pos_estab = NEW.nr_sequencia
		and	x.ie_tipo_cobranca in ('1','2');
	end if;

	if (nr_seq_lote_w is not null) then

		if (OLD.nr_seq_lote_fat is not null) and (NEW.nr_seq_lote_fat is null) then
			CALL pls_gerar_fatura_log(	nr_seq_lote_w, null, NEW.nr_seq_conta, 'PLS_CONTA_POS_ESTAB_UPDATE -'||
											' Conta: '||NEW.nr_seq_conta||
											' Lote incluso: '||nr_seq_lote_w||
											' Lote old: '||OLD.nr_seq_lote_fat||
											' Lote new: '||NEW.nr_seq_lote_fat||
											' Evento old: '||OLD.nr_seq_evento_fat||
											' Evento new: '||NEW.nr_seq_evento_fat,'CX', 'N', NEW.nm_usuario);

			NEW.nr_seq_lote_fat := nr_seq_lote_w;
			NEW.nr_seq_evento_fat := OLD.nr_seq_evento_fat;
		end if;
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_conta_pos_estab_update() FROM PUBLIC;

CREATE TRIGGER pls_conta_pos_estab_update
	BEFORE UPDATE ON pls_conta_pos_estabelecido FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_conta_pos_estab_update();

