-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_receber_trib_baixa_afte ON titulo_receber_trib_baixa CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_receber_trib_baixa_afte() RETURNS trigger AS $BODY$
declare

reg_integracao_p		gerar_int_padrao.reg_integracao;
qt_reg_w			bigint;
cd_estabelecimento_w    	estabelecimento.cd_estabelecimento%type;
cd_estabelecimento_ww		estabelecimento.cd_estabelecimento%type;
dt_movimento_w          	ctb_documento.dt_competencia%type;
nr_seq_trans_financ_w   	ctb_documento.nr_seq_trans_financ%type;
nr_documento_w          	ctb_documento.nr_documento%type;
nr_seq_doc_compl_w      	ctb_documento.nr_seq_doc_compl%type;
ie_lib_caixa_w			titulo_receber_liq.ie_lib_caixa%type;
ie_contab_tit_cancelado_w	parametro_contas_receber.ie_contab_tit_cancelado%type;
ie_concil_contab_w		pls_visible_false.ie_concil_contab%type;

c01 CURSOR FOR
	SELECT 	a.cd_tipo_lote_contab,
		14 nr_seq_info_ctb,
		'TITULO_RECEBER_TRIB_BAIXA' nm_tabela,
		a.nm_atributo nm_atributo
	from	atributo_contab a
	where 	a.cd_tipo_lote_contab = 39
	and	a.nm_atributo = 'VL_TRIB_TIT_REC'
	and	ie_concil_contab_w = 'S'
	and	exists ( SELECT	1
			from 	titulo_receber_liq y
			where   y.nr_seq_lote_enc_contas is null
			and     y.nr_seq_pls_lote_camara is null
			and	coalesce(y.ie_lib_caixa, 'S') = 'S'
			and	y.nr_titulo 	= NEW.nr_titulo
			and	y.nr_sequencia	= NEW.nr_seq_tit_liq
			and	exists	(select	1
					from	titulo_receber x
					where	x.nr_titulo	= y.nr_titulo
					and	x.ie_pls	= 'S'
					and	x.ie_origem_titulo = '3'
					and	((x.ie_situacao	<> '3' or ie_contab_tit_cancelado_w = 'S')
					or (x.ie_situacao = '3' and y.vl_rec_maior <> 0))));

	vet_c01 c01%rowtype;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
if (NEW.nr_seq_tit_liq is not null) and (NEW.nr_titulo is not null) then

	/*Esse select e para tentar evitar a duplicidade. Pois ao ao atualizar algo no titulo, pode chamar outra proc que atualiza classificacao ou imposto, que tb dispara a trigger das tabelas com esse insert*/


	select	count(*)
	into STRICT	qt_reg_w
	from	intpd_fila_transmissao
	where  	nr_seq_documento 		= to_char(NEW.nr_titulo)
	and		nr_seq_item_documento	= to_char(NEW.nr_seq_tit_liq)
	and     to_char(dt_atualizacao, 'dd/mm/yyyy hh24:mi:ss') = to_char(LOCALTIMESTAMP,'dd/mm/yyyy hh24:mi:ss');
	
	if (qt_reg_w = 0) then
		reg_integracao_p.nr_seq_item_documento_p	:=	NEW.nr_seq_tit_liq;
		reg_integracao_p := gerar_int_padrao.gravar_integracao('27', NEW.nr_titulo, NEW.nm_usuario, reg_integracao_p);
	end if;
	
end if;

if (TG_OP = 'INSERT') then
	BEGIN

	select  max(c.cd_estabelecimento)
	into STRICT 	cd_estabelecimento_w
	from    titulo_receber_trib_baixa a,
		titulo_receber_liq b,
		titulo_receber c
	where   a.nr_sequencia 	 = NEW.nr_sequencia
	and     a.nr_titulo 	 = b.nr_titulo
	and     a.nr_seq_tit_liq = b.nr_sequencia
	and     b.nr_titulo 	 = c.nr_titulo;

	CALL atualiza_tit_receb_trib_baixa(  NEW.dt_contabil,
					cd_estabelecimento_w,
					NEW.nr_seq_tit_trib,
					NEW.vl_baixa,
					NEW.nr_titulo,
					NEW.nr_seq_trans_financ,
					NEW.nr_sequencia,
					NEW.nm_usuario);
	exception when others then
		cd_estabelecimento_w	:= null;
	end;

	BEGIN
	select 	a.cd_estabelecimento,
		b.dt_recebimento,
		b.nr_seq_trans_fin,
		a.nr_titulo,
		b.nr_sequencia,
		b.ie_lib_caixa
	into STRICT	cd_estabelecimento_ww,
		dt_movimento_w,
		nr_seq_trans_financ_w,
		nr_documento_w,
		nr_seq_doc_compl_w,
		ie_lib_caixa_w
	from	titulo_receber a,
		titulo_receber_liq b,
		titulo_receber_trib_baixa c
	where	a.nr_titulo = b.nr_titulo
	and	b.nr_titulo = c.nr_titulo
	and	b.nr_sequencia = c.nr_seq_tit_liq
	and	c.nr_sequencia = NEW.nr_sequencia;
	
	exception when others then
		nr_seq_trans_financ_w	:= null;
	end;

	BEGIN	
	select  coalesce(max(ie_contab_tit_cancelado), 'S')
	into STRICT    ie_contab_tit_cancelado_w
	from    parametro_contas_receber
	where   cd_estabelecimento      = cd_estabelecimento_w;
	exception
	when others then
		ie_contab_tit_cancelado_w := 'S';
	end;

	BEGIN
	select	coalesce(max(ie_concil_contab), 'N')
	into STRICT	ie_concil_contab_w
	from	pls_visible_false
	where	cd_estabelecimento = cd_estabelecimento_ww;
	exception when others then
		ie_concil_contab_w := 'N';
	end;

	if (coalesce(NEW.vl_baixa, 0) <> 0 and coalesce(nr_seq_trans_financ_w,0) <> 0 and coalesce(ie_lib_caixa_w, 'S') = 'S') then
		open c01;
		loop
		fetch c01 into
			vet_c01;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		BEGIN

		CALL ctb_concil_financeira_pck.ctb_gravar_documento(       cd_estabelecimento_ww,
									dt_movimento_w,
									vet_c01.cd_tipo_lote_contab,
									nr_seq_trans_financ_w,
									vet_c01.nr_seq_info_ctb,
									nr_documento_w,
									nr_seq_doc_compl_w,
									NEW.nr_sequencia,
									NEW.vl_baixa,
									vet_c01.nm_tabela,
									vet_c01.nm_atributo,
									NEW.nm_usuario);

		end;
		end loop;
		close c01;
					
	end if;
end if;

end if;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_receber_trib_baixa_afte() FROM PUBLIC;

CREATE TRIGGER titulo_receber_trib_baixa_afte
	AFTER INSERT OR UPDATE ON titulo_receber_trib_baixa FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_receber_trib_baixa_afte();

