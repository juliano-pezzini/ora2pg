-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_autorizado_delete ON material_autorizado CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_autorizado_delete() RETURNS trigger AS $BODY$
declare
ie_gerar_historico_w	varchar(15) := 'N';
BEGIN

ie_gerar_historico_w := obter_param_usuario(3004, 139, obter_perfil_ativo, OLD.nm_usuario, wheb_usuario_pck.Get_cd_estabelecimento, ie_gerar_historico_w);

if (coalesce('N','N') = 'S') then

	insert into AUTORIZACAO_CONVENIO_HIST(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		NR_ATENDIMENTO,
		DS_HISTORICO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		NR_SEQUENCIA_AUTOR)
	values (
		nextval('autorizacao_convenio_hist_seq'),
		LOCALTIMESTAMP,
		OLD.nm_usuario,
		OLD.nr_atendimento,
		substr(WHEB_MENSAGEM_PCK.get_texto(311724) || chr(13) || chr(10) || --Material excluído da autorização
		OLD.cd_material || ' - ' || substr(obter_desc_material(OLD.cd_material),1,100) || chr(13) || chr(10) ||
		WHEB_MENSAGEM_PCK.get_texto(311725) || OLD.qt_solicitada || chr(13) || chr(10) || --Qtde solicitada:
		WHEB_MENSAGEM_PCK.get_texto(311726) || OLD.qt_autorizada,1,4000), ---Qtde autorizada:
		LOCALTIMESTAMP,
		OLD.nm_usuario,
		OLD.nr_sequencia_autor);
end if;

RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_autorizado_delete() FROM PUBLIC;

CREATE TRIGGER material_autorizado_delete
	AFTER DELETE ON material_autorizado FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_autorizado_delete();

