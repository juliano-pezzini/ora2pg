-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cpoe_dialise_insert_updt_after ON cpoe_dialise CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cpoe_dialise_insert_updt_after() RETURNS trigger AS $BODY$
declare

ie_order_integr_type_w 	varchar(10);
nr_entity_identifier_w	cpoe_integracao.nr_sequencia%type;
ie_use_integration_w	varchar(10);
BEGIN
  BEGIN
	if (NEW.dt_liberacao is not null and ((OLD.dt_liberacao_enf is null and  NEW.dt_liberacao_enf is not null) or (OLD.dt_liberacao_farm is null and NEW.dt_liberacao_farm is not null))) then
		CALL cpoe_atualizar_inf_adic(NEW.nr_atendimento, NEW.nr_sequencia, 'D', NEW.dt_liberacao_enf, NEW.dt_liberacao_farm, null, null, null, null, null, NEW.nr_seq_cpoe_order_unit);
	end if;

  if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
  BEGIN
    ie_use_integration_w := obter_param_usuario(9041, 10, obter_perfil_ativo, NEW.nm_usuario, obter_estabelecimento_ativo, ie_use_integration_w);

    if (ie_use_integration_w = 'S')
      and ((OLD.DT_LIBERACAO IS NULL AND NEW.DT_LIBERACAO IS NOT NULL)
        or (OLD.DT_LIB_SUSPENSAO IS NULL AND NEW.DT_LIB_SUSPENSAO IS NOT NULL )) then

      select obter_cpoe_regra_ator('IP')
      into STRICT ie_order_integr_type_w
;

      if (ie_order_integr_type_w = 'OI') then

        nr_entity_identifier_w := cpoe_dial_order_json_pck.getCpoeIntegracaoDial(NEW.nr_sequencia, NEW.nm_usuario, nr_entity_identifier_w);

        if (OLD.DT_LIBERACAO IS NULL AND NEW.DT_LIBERACAO IS NOT NULL) then

          CALL call_bifrost_content('prescription.dialysis.order.request','cpoe_dial_order_json_pck.get_message_clob(' || NEW.nr_sequencia || ', ''NW'', ' || nr_entity_identifier_w || ')', NEW.nm_usuario);

        elsif (OLD.DT_LIB_SUSPENSAO IS NULL AND NEW.DT_LIB_SUSPENSAO IS NOT NULL ) then

          CALL call_bifrost_content('prescription.dialysis.order.request','cpoe_dial_order_json_pck.get_message_clob(' || NEW.nr_sequencia || ', ''CA'', ' || nr_entity_identifier_w || ')', NEW.nm_usuario);

        end if;

      end if;

    end if;
  end;
  end if;

exception
	when others then
		CALL gravar_log_cpoe('CPOE_DIALISE_INSERT_UPDT_AFTER - CPOE_ATUALIZAR_INF_ADIC - Erro: ' || substr(sqlerrm(SQLSTATE),1,1500) || ' :new.nr_sequencia '|| NEW.nr_sequencia, NEW.nr_atendimento);
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cpoe_dialise_insert_updt_after() FROM PUBLIC;

CREATE TRIGGER cpoe_dialise_insert_updt_after
	AFTER INSERT OR UPDATE ON cpoe_dialise FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cpoe_dialise_insert_updt_after();

