-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS sup_int_marca_atual ON sup_int_marca CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_sup_int_marca_atual() RETURNS trigger AS $BODY$
declare

nr_sequencia_w		marca.nr_sequencia%type;
nr_seq_marca_w		marca.nr_sequencia%type := 0;
cd_cnpj_fabricante_w	pessoa_juridica.cd_cgc%type;
nr_seq_tipo_w		tipo_marca.nr_sequencia%type;
qt_existe_erros_w	bigint;

BEGIN

if (NEW.ie_forma_integracao = 'R') then

	NEW.dt_leitura	:= LOCALTIMESTAMP;

	CALL consiste_sup_int_marca(	NEW.nr_sequencia,
				NEW.cd_cnpj_fabricante,
				NEW.nr_seq_tipo,
				NEW.nm_usuario );

	select	count(*)
	into STRICT	qt_existe_erros_w
	from	sup_int_marca_consist
	where	nr_sequencia = NEW.nr_sequencia;

	if (qt_existe_erros_w = 0) then

		if (TG_OP = 'UPDATE') then

			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_marca_w
			from	marca
			where	cd_sistema_ant = to_char(NEW.nr_sequencia);

		end if;

		if (nr_seq_marca_w = 0) then

			select 	nextval('marca_seq')
			into STRICT	nr_sequencia_w
			;

			select 	max(cd_cgc)
			into STRICT	cd_cnpj_fabricante_w
			from 	pessoa_juridica
			where 	cd_sistema_ant = NEW.cd_cnpj_fabricante;

			select 	max(nr_sequencia)
			into STRICT	nr_seq_tipo_w
			from 	tipo_marca
			where	cd_sistema_ant = NEW.nr_seq_tipo;

			insert into marca(
				nr_sequencia,
				ds_marca,
				ie_situacao,
				nr_seq_tipo,
				qt_dia_ressup,
				dt_reprovacao,
				nm_usuario_reprovacao,
				ds_observacao,
				cd_sistema_ant,
				cd_cnpj_fabricante,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec)
			values (	nr_sequencia_w,
				NEW.ds_marca,
				NEW.ie_situacao,
				nr_seq_tipo_w,
				NEW.qt_dia_ressup,
				NEW.dt_reprovacao,
				NEW.nm_usuario_reprovacao,
				NEW.ds_observacao,
				NEW.nr_sequencia,
				cd_cnpj_fabricante_w,
				NEW.dt_atualizacao,
				NEW.nm_usuario,
				NEW.dt_atualizacao_nrec,
				NEW.nm_usuario);

			NEW.dt_confirma_integracao := LOCALTIMESTAMP;
			NEW.cd_sistema_ant := nr_sequencia_w;

		else

			select 	max(cd_cgc)
			into STRICT	cd_cnpj_fabricante_w
			from 	pessoa_juridica
			where 	cd_sistema_ant = NEW.cd_cnpj_fabricante;

			select 	max(nr_sequencia)
			into STRICT	nr_seq_tipo_w
			from 	tipo_marca
			where	cd_sistema_ant = NEW.nr_seq_tipo;

			update	marca
			set	ds_marca = NEW.ds_marca,
				ie_situacao = NEW.ie_situacao,
				nr_seq_tipo = nr_seq_tipo_w,
				qt_dia_ressup = NEW.qt_dia_ressup,
				dt_reprovacao = NEW.dt_reprovacao,
				nm_usuario_reprovacao = NEW.nm_usuario_reprovacao,
				ds_observacao = NEW.ds_observacao,
				cd_cnpj_fabricante = cd_cnpj_fabricante_w,
				dt_atualizacao = NEW.dt_atualizacao,
				nm_usuario = NEW.nm_usuario,
				dt_atualizacao_nrec = NEW.dt_atualizacao_nrec,
				nm_usuario_nrec = NEW.nm_usuario
			where	cd_sistema_ant = NEW.nr_sequencia;

		end if;

	end if;

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_sup_int_marca_atual() FROM PUBLIC;

CREATE TRIGGER sup_int_marca_atual
	BEFORE INSERT OR UPDATE ON sup_int_marca FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_sup_int_marca_atual();

