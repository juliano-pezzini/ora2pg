-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pf_medico_externo_after ON pf_medico_externo CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pf_medico_externo_after() RETURNS trigger AS $BODY$
declare
qt_reg_w		bigint;
reg_integracao_w  gerar_int_padrao.reg_integracao;
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
nr_cpf_w pessoa_fisica.nr_cpf %type;

pragma autonomous_transaction;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then

	cd_pessoa_fisica_w := coalesce(NEW.cd_pessoa_fisica,OLD.cd_pessoa_fisica);

	BEGIN
	select  cd_pessoa_fisica,
		nr_prontuario,
		coalesce(ie_funcionario,'N'),
    nr_cpf
	into STRICT  	reg_integracao_w.cd_pessoa_fisica,
		reg_integracao_w.nr_prontuario,
		reg_integracao_w.ie_funcionario,
    nr_cpf_w
	from  	pessoa_fisica
	where  	cd_pessoa_fisica = cd_pessoa_fisica_w;
	exception
		when others then
		reg_integracao_w.cd_pessoa_fisica  	:= null;
		reg_integracao_w.nr_prontuario    	:= null;
		reg_integracao_w.ie_funcionario    	:= null;
	end;

	reg_integracao_w.ie_operacao	:= 'A';

	select 	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
	into STRICT 	reg_integracao_w.ie_pessoa_atend
	from 	pessoa_fisica_aux
	where 	cd_pessoa_fisica 	= cd_pessoa_fisica_w
	and 	nr_primeiro_atend 	is not null;

  if nr_cpf_w is not null then
     reg_integracao_w.ie_possui_cpf := 'S';
  end if;

	if (wheb_usuario_pck.get_ie_lote_contabil = 'N') then
		reg_integracao_w := gerar_int_padrao.gravar_integracao('12', cd_pessoa_fisica_w, coalesce(NEW.nm_usuario,OLD.nm_usuario), reg_integracao_w);
	end if;

	commit;

end if;

  END;
IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pf_medico_externo_after() FROM PUBLIC;

CREATE TRIGGER pf_medico_externo_after
	AFTER INSERT OR UPDATE OR DELETE ON pf_medico_externo FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pf_medico_externo_after();

