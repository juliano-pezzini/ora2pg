-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cot_compra_insert ON cot_compra CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cot_compra_insert() RETURNS trigger AS $BODY$
DECLARE


ie_seq_proc_cotacao_w		varchar(1);
nr_processo_w			bigint;
nr_processo_ww			bigint;
ie_status_w  bigint;

BEGIN

select count(*)
into STRICT ie_status_w
from cot_compra_item
where nr_cot_compra = NEW.nr_cot_compra and obter_bloq_canc_proj_rec(nr_seq_proj_rec) > 0;

if (ie_status_w > 0) then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(1144309);  -- Registro associado a um projeto bloqueado ou cancelado. 
end if;

select  max(ie_seq_proc_cotacao)
into STRICT    ie_seq_proc_cotacao_w
from 	parametro_compras
where	cd_estabelecimento = NEW.cd_estabelecimento;

if (NEW.ds_titulo is null) then
	 NEW.ds_titulo := obter_titulo_cotacao(NEW.nr_cot_compra, NEW.cd_estabelecimento, NEW.nm_usuario);
end if;

if (ie_seq_proc_cotacao_w = 'S') and (NEW.nr_processo is null) then

	select	max(rownum) + 1
	into STRICT	nr_processo_ww
	from	w_inserir_processo
	where	coalesce(cd_estabelecimento,NEW.cd_estabelecimento) = NEW.cd_estabelecimento;
	
	nr_processo_w := nr_processo_ww||to_char(LOCALTIMESTAMP,'yyyy');
	
	CALL inserir_numero_processo(NEW.nr_cot_compra, nr_processo_w, NEW.cd_estabelecimento);
	
	NEW.nr_processo := nr_processo_w;

end if;

RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cot_compra_insert() FROM PUBLIC;

CREATE TRIGGER cot_compra_insert
	BEFORE INSERT OR UPDATE ON cot_compra FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cot_compra_insert();

