-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cm_ciclo_update ON cm_ciclo CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cm_ciclo_update() RETURNS trigger AS $BODY$
declare

nr_seq_conj_cont_w		cm_conjunto_cont.nr_sequencia%type;

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	cm_conjunto_cont
	where	nr_seq_ciclo = NEW.nr_sequencia;

BEGIN

	--finalizando um ciclo, geramos hist√≥rico/contagem para todos os conjuntos do ciclo finalizado.
	if	(NEW.dt_fim is not null AND OLD.dt_fim is null) then

		open c01;
		loop
		fetch c01 into
			nr_seq_conj_cont_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			BEGIN
				insert into cm_contagem_ciclo(
						  nr_sequencia,
						  dt_atualizacao,
						  nm_usuario,
						  dt_atualizacao_nrec,
						  nm_usuario_nrec,
						  nr_seq_ciclo,
						  nr_seq_conj_cont)
				values (
						  nextval('cm_contagem_ciclo_seq'),
						  LOCALTIMESTAMP,
						  NEW.nm_usuario,
						  LOCALTIMESTAMP,
						  NEW.nm_usuario,
						  NEW.nr_sequencia,
						  nr_seq_conj_cont_w);
			end;
		end loop;
		close c01;

	end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cm_ciclo_update() FROM PUBLIC;

CREATE TRIGGER cm_ciclo_update
	BEFORE UPDATE ON cm_ciclo FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cm_ciclo_update();

