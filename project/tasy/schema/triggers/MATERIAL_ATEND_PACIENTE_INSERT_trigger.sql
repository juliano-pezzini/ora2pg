-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_atend_paciente_insert ON material_atend_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_atend_paciente_insert() RETURNS trigger AS $BODY$
declare
cd_material_w				integer;
ie_baixa_estoq_pac_w			varchar(01);
cd_motivo_baixa_w			smallint;
vl_param_w				varchar(5);
ie_baixa_w				varchar(1) 	:= 'S';
cd_estabelecimento_w			smallint;
cd_cgc_prestador_w			varchar(14);
ie_tipo_atendimento_w			smallint;
cd_grupo_material_w			smallint;
cd_subgrupo_material_w			smallint;
cd_classe_material_w			integer;
ie_buscar_conv_cirurg_w			varchar(01)	:= 'N';
cd_conv_cirurgia_w			bigint	:= 0;
ie_gerar_itens_auditoria_w		varchar(01)	:= 'S';
qt_auditoria_periodo_w			bigint;
nm_usuario_audit_w			varchar(15);
qt_material_w				double precision;
qt_est_w				double precision;
ie_situacao_w				varchar(1);
ds_material_w				varchar(100);
ds_material_ww				varchar(100);
ie_permite_matmed_inativo_w		varchar(01);
ds_observacao_w				varchar(255);
cd_centro_custo_w			bigint;
ie_centro_custo_inativo_w		varchar(01);
nr_atendimento_prescr_w			bigint;
osuser_log_w				varchar(100);
ds_module_log_w				varchar(255);
ie_material_exec_fatur_w		varchar(2);
cd_setor_atendimento_w			bigint;
cd_setor_atendimento_ww			bigint;
ie_tipo_material_w			varchar(3);
ie_consiste_setor_audit_w		varchar(1);
ie_consiste_dt_conta_w			varchar(1);

cd_setor_paciente_w			bigint;
cd_plano_convenio_w			varchar(10);
dt_entrada_w				timestamp;
cd_mot_baixa_adep_w			smallint;

cd_estabelecimento_logado_w		bigint;
cd_estab_prescr_estoque_w		bigint;
ie_estab_movto_w			varchar(10);
cd_convenio_w				integer;
cd_categoria_w				varchar(10);
qt_atendimento_cancelado_w		bigint;
nr_serie_material_w			varchar(80);
cd_medico_resp_w			varchar(10);
qt_reg_w				bigint;
ie_glosa_mat_aut_neg_w			varchar(15) := 'N';
dt_geracao_resumo_w			timestamp;
qt_atendimento_fechado_w		bigint;
ds_call_stack_w				varchar(2000);
cd_unidade_medida_consumo_w		varchar(30);
ie_atualiza_unid_consumo_w		varchar(1);
ie_gerar_dialisador_aut_w		varchar(1);
ie_consiste_motivo_baixa_w		varchar(1) := 'S';
ie_prescr_emergencia_w			varchar(1);
cd_estab_prescricao_w			prescr_medica.cd_estabelecimento%type;
cd_conv_lote_w				material_lote_fornec.cd_convenio%type;
ie_considera_setor_proc_w		varchar(1);

ie_consignado_w				varchar(1);
ie_estoque_lote_w			varchar(1);
nr_seq_regra_w				bigint;

ie_trat_conta_rn_w			atendimento_paciente.ie_trat_conta_rn%type;
qt_atendimento_fechado_mae_w		bigint;
nr_atendimento_mae_w			atendimento_paciente.nr_atendimento%type;
ie_agrupador_w				prescr_material.ie_agrupador%type;
ie_gedipa_fracionado_w		varchar(1);
ie_legenda_baixado_adep_w	varchar(1);
ie_item_substituido_w		varchar(1) := 'N';
BEGIN
  BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then	
cd_estabelecimento_logado_w             := wheb_usuario_pck.get_cd_estabelecimento;

select  max(IE_ESTAB_MOVIMENTO)
into STRICT    ie_estab_movto_w
from    parametro_estoque
where   cd_estabelecimento              = cd_estabelecimento_logado_w;


cd_estab_prescr_estoque_w       := null;

if (ie_estab_movto_w       = 'N') then
        cd_estab_prescr_estoque_w       := cd_estabelecimento_logado_w;
end if;

select	coalesce(max(ie_prescr_emergencia), 'N'),
	max(cd_estabelecimento)
into STRICT	ie_prescr_emergencia_w,
	cd_estab_prescricao_w
from	prescr_medica
where	nr_prescricao = NEW.nr_prescricao;

if (ie_prescr_emergencia_w = 'S') then
	cd_estab_prescr_estoque_w	:= cd_estab_prescricao_w;
end if;

if (NEW.nm_usuario_original is null) then
	NEW.nm_usuario_original := NEW.nm_usuario;
end if;

BEGIN
ie_buscar_conv_cirurg_w	:= coalesce(obter_valor_param_usuario(901, 31, obter_perfil_ativo, NEW.nm_usuario, 0),'N');
exception
when others then
	ie_buscar_conv_cirurg_w	:= 'N';
end;

BEGIN
ie_gerar_itens_auditoria_w := coalesce(obter_valor_param_usuario(67, 139, obter_perfil_ativo, NEW.nm_usuario, 0),'S');
exception
when others then
	ie_gerar_itens_auditoria_w	:= 'S';
end;

BEGIN
ie_consiste_setor_audit_w := coalesce(obter_valor_param_usuario(67, 365, obter_perfil_ativo, NEW.nm_usuario, 0),'N');
exception
when others then
	ie_consiste_setor_audit_w	:= 'N';
end;

BEGIN
ie_consiste_dt_conta_w := coalesce(obter_valor_param_usuario(67, 460, obter_perfil_ativo, NEW.nm_usuario, 0),'N');
exception
when others then
	ie_consiste_dt_conta_w	:= 'N';
end;

BEGIN
cd_mot_baixa_adep_w := coalesce((obter_valor_param_usuario(1113, 258, obter_perfil_ativo, NEW.nm_usuario, 0))::numeric ,0);
exception
when others then
	cd_mot_baixa_adep_w	:= 0;
end;

BEGIN
	ie_gedipa_fracionado_w := coalesce(obter_valor_param_usuario(3112, 63, obter_perfil_ativo, NEW.nm_usuario, 0),'N');
exception
when others then
	ie_gedipa_fracionado_w := 'N';
end;


BEGIN
	ie_legenda_baixado_adep_w := coalesce(obter_valor_param_usuario(1113, 310, obter_perfil_ativo, NEW.nm_usuario, 0),'N');
exception
when others then
	ie_legenda_baixado_adep_w := 'N';
end;

BEGIN
ie_gerar_dialisador_aut_w := coalesce(obter_valor_param_usuario(24, 329, obter_perfil_ativo, NEW.nm_usuario, 0),'N');
exception
when others then
	ie_gerar_dialisador_aut_w	:= 'N';
end;

BEGIN
ie_considera_setor_proc_w := coalesce(obter_valor_param_usuario(cd_funcao_p => 924, -- Prescricao Eletronica Paciente - REP
                                                            nr_sequencia_p => 624, -- Ao executar automaticamente um medicamento associado ao procedimento, considerar o setor de execucao do procedimento
                                                            cd_perfil_p => obter_perfil_ativo,
                                                            nm_usuario_p => NEW.nm_usuario,
                                                            cd_estabelecimento_p => cd_estabelecimento_logado_w), 'N');
exception
when others then
	ie_considera_setor_proc_w	:= 'N';
end;

select	cd_estabelecimento,
	ie_tipo_atendimento,
	obter_dados_categ_conv(nr_atendimento, 'P'),
	dt_entrada,
	cd_medico_resp,
	ie_trat_conta_rn,
	nr_atendimento_mae
into STRICT	cd_estabelecimento_w,
	ie_tipo_atendimento_w,
	cd_plano_convenio_w,
	dt_entrada_w,
	cd_medico_resp_w,
	ie_trat_conta_rn_w,
	nr_atendimento_mae_w
from	atendimento_paciente
where	nr_atendimento = NEW.nr_atendimento;
If (NEW.nr_atendimento is not null) then
	select	count(*)
	into STRICT	qt_atendimento_cancelado_w
	from	atendimento_paciente
	where	nr_atendimento = NEW.nr_atendimento
	and	dt_cancelamento is not null;
	
	If (qt_atendimento_cancelado_w > 0) then
		--Nao e possivel criar conta para um atendimento cancelado!
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(184246);
	End if;
End if;

If (NEW.nr_atendimento is not null) then				
	if (ie_trat_conta_rn_w is not null) then
		select	count(*)
		into STRICT	qt_atendimento_fechado_w
		from	atendimento_paciente
		where	nr_atendimento = NEW.nr_atendimento
		and	dt_fim_conta is not null;

		If (qt_atendimento_fechado_w > 0) then
			select	count(*)
			into STRICT	qt_atendimento_fechado_mae_w
			from	atendimento_paciente
			where	nr_atendimento_mae = nr_atendimento_mae_w
			and	dt_fim_conta is not null;

			If (qt_atendimento_fechado_mae_w > 0) then
				--Nao e possivel executar mat/med para um atendimento fechado!
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(205008);
			End if;
		end if;
	else
		select	count(*)
		into STRICT	qt_atendimento_fechado_w
		from	atendimento_paciente
		where	nr_atendimento = NEW.nr_atendimento
		and	dt_fim_conta is not null;

		If (qt_atendimento_fechado_w > 0) then
			--Nao e possivel executar mat/med para um atendimento fechado!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(205008);
		End if;
	end if;	
End if;

if (ie_gerar_itens_auditoria_w	<> 'S') then
	BEGIN
	
	if (ie_gerar_itens_auditoria_w = 'N') then
	
		--nao permite incluir no periodo auditado (somente p/ auditoria liberada)
		select	 /*+ index (a audcopa_atepaci_fk_i) */			count(*),
			coalesce(max(a.nm_usuario), NEW.nm_usuario)
		into STRICT	qt_auditoria_periodo_w,
			nm_usuario_audit_w
		from	auditoria_conta_paciente a,
			conta_paciente b
		where	a.nr_interno_conta	= b.nr_interno_conta
		and	a.nr_atendimento	= NEW.nr_atendimento
		and	coalesce(NEW.nr_seq_mat_est,0) = 0
		and 	dt_liberacao is not null
		and	b.ie_status_acerto	= 1
		and 	(((coalesce(a.cd_setor_atendimento, coalesce(NEW.cd_setor_atendimento,0)) = coalesce(NEW.cd_setor_atendimento,0)) and (ie_consiste_setor_audit_w = 'S')) or (ie_consiste_setor_audit_w = 'N'))
		and 	ie_gerar_itens_auditoria_w = 'N'
		and	(((NEW.dt_atendimento between a.dt_periodo_inicial and a.dt_periodo_final) and (coalesce(ie_consiste_dt_conta_w,'N') = 'N')) or
			 (((NEW.dt_atendimento between a.dt_periodo_inicial and a.dt_periodo_final) or (NEW.dt_conta between a.dt_periodo_inicial and a.dt_periodo_final)) and (coalesce(ie_consiste_dt_conta_w,'N') = 'S')));
	
	elsif (ie_gerar_itens_auditoria_w = 'E') then
	
		--nao permite incluir nos periodos auditado e "em auditoria" (auditoria liberada e nao liberada)
		select	 /*+ index (a audcopa_atepaci_fk_i) */			count(*),
			coalesce(max(a.nm_usuario), NEW.nm_usuario)
		into STRICT	qt_auditoria_periodo_w,
			nm_usuario_audit_w
		from	auditoria_conta_paciente a,
			conta_paciente b
		where	a.nr_interno_conta	= b.nr_interno_conta
		and	a.nr_atendimento	= NEW.nr_atendimento
		and	coalesce(NEW.nr_seq_mat_est,0) = 0
		and	b.ie_status_acerto	= 1
		and 	(((coalesce(a.cd_setor_atendimento, coalesce(NEW.cd_setor_atendimento,0)) = coalesce(NEW.cd_setor_atendimento,0)) and (ie_consiste_setor_audit_w = 'S')) or (ie_consiste_setor_audit_w = 'N'))
		and 	ie_gerar_itens_auditoria_w = 'E'
		and	(((NEW.dt_atendimento between a.dt_periodo_inicial and a.dt_periodo_final) and (coalesce(ie_consiste_dt_conta_w,'N') = 'N')) or
			 (((NEW.dt_atendimento between a.dt_periodo_inicial and a.dt_periodo_final) or (NEW.dt_conta between a.dt_periodo_inicial and a.dt_periodo_final)) and (coalesce(ie_consiste_dt_conta_w,'N') = 'S')));
			
	end if;
	
	/*
	select	nvl(max(a.nm_usuario), :new.nm_usuario)
	into	nm_usuario_audit_w
	from	auditoria_conta_paciente a,
		conta_paciente b
	where	a.nr_atendimento		= :new.nr_atendimento
	and	a.nr_interno_conta	= b.nr_interno_conta
	and	b.ie_status_acerto	= 1
	and 	a.dt_liberacao is null
	and	:new.dt_atendimento between a.dt_periodo_inicial and a.dt_periodo_final;
	*/
	if (qt_auditoria_periodo_w > 0) then
		--Este item nao pode ser lancado pois esta dentro do periodo auditado.
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(184247);
	elsif (nm_usuario_audit_w <> NEW.nm_usuario) then
		--Este item nao pode ser lancado pois esta dentro do periodo auditado. O usuario e diferente do auditor.
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(184249);
	end if;		
	end;
end if;

if (coalesce(obter_funcao_ativa,0) = 36) then
	ie_consiste_motivo_baixa_w := obter_regra_motivo_atend(NEW.cd_material, NEW.nr_seq_tipo_baixa);
	ds_material_w := substr(obter_desc_material(NEW.cd_material), 1,100);
	if (ie_consiste_motivo_baixa_w = 'N') then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(287935, 'cd_material='|| NEW.cd_material ||';ds_material='||ds_material_w);
	end if;
end if;

if ( NEW.cd_funcao = 924 ) then

	select coalesce(max(a.ie_agrupador),1)
    into STRICT   ie_agrupador_w
    from   prescr_material a
    where  a.nr_prescricao = NEW.nr_prescricao
    and    a.nr_sequencia = NEW.nr_sequencia_prescricao;

    if ( NEW.nr_devolucao is null ) and
	   (( ie_considera_setor_proc_w = 'N' ) or ( ie_agrupador_w <> 5 )) then
        
		select max(cd_setor_atendimento)
        into STRICT   cd_setor_atendimento_w
        from   atend_paciente_unidade
        where  nr_seq_interno = NEW.nr_seq_atepacu;

        if ( cd_setor_atendimento_w is not null ) and ( cd_setor_atendimento_w <> NEW.cd_setor_atendimento ) then
            NEW.cd_setor_atendimento := cd_setor_atendimento_w;
        end if;
				
    end if;
else
    if ( NEW.nr_devolucao is null ) then

		select max(cd_setor_atendimento)
        into STRICT   cd_setor_atendimento_w
        from   atend_paciente_unidade
        where  nr_seq_interno = NEW.nr_seq_atepacu;

        if ( cd_setor_atendimento_w is not null ) and ( cd_setor_atendimento_w <> NEW.cd_setor_atendimento ) then
            NEW.cd_setor_atendimento := cd_setor_atendimento_w;
        end if;
		
    end if;
end if;

cd_setor_atendimento_ww	:= NEW.cd_setor_atendimento;

if (cd_setor_atendimento_w is not null) then
	cd_setor_atendimento_ww := cd_setor_atendimento_w;
end if;

BEGIN
select	coalesce(max(cd_convenio),0)
into STRICT	cd_conv_cirurgia_w
from	cirurgia
where	nr_cirurgia		= NEW.nr_cirurgia
and	ie_buscar_conv_cirurg_w	= 'S';
exception
when others then
	cd_conv_cirurgia_w	:= 0;
end;
if (cd_conv_cirurgia_w <> 0) and (ie_buscar_conv_cirurg_w = 'S') then
	NEW.cd_convenio	:= cd_conv_cirurgia_w;
end if;

NEW.cd_perfil := coalesce(obter_perfil_ativo,0);
NEW.cd_funcao := coalesce(obter_funcao_ativa,0);

select	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	substr(obter_desc_material(cd_material),1,100)
into STRICT	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	ds_material_ww
from	estrutura_material_v
where	cd_material = NEW.cd_material;

select	coalesce(max(ie_permite_matmed_inativo),'S'),
	coalesce(max(ie_centro_custo_inativo),'N'),
	coalesce(max(ie_material_exec_fatur),'N'),
	coalesce(max(ie_atualiza_unid_consumo),'N')
into STRICT	ie_permite_matmed_inativo_w,
	ie_centro_custo_inativo_w,
	ie_material_exec_fatur_w,
	ie_atualiza_unid_consumo_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_w;

select 	coalesce(max(ie_glosa_mat_aut_neg),'N')
into STRICT	ie_glosa_mat_aut_neg_w
from	convenio_estabelecimento
where	cd_convenio		= NEW.cd_convenio
and	cd_estabelecimento	= cd_estabelecimento_w;

if (coalesce(ie_glosa_mat_aut_neg_w,'N') = 'S') and (coalesce(NEW.nr_prescricao,0) > 0) 	and (coalesce(NEW.nr_sequencia_prescricao,0) > 0)then

	BEGIN                                                                                                                                                                                                                                 
	select	count(*)
	into STRICT	qt_reg_w
	from	material_autorizado a,
		autorizacao_convenio b,
		estagio_autorizacao c
	where	a.nr_prescricao		= NEW.nr_prescricao
	and	a.nr_seq_prescricao	= NEW.nr_sequencia_prescricao
	and	a.nr_sequencia_autor	= b.nr_sequencia
	and	b.nr_seq_estagio	= c.nr_sequencia
	and	c.ie_interno		= '90';

	if (qt_reg_w > 0) then
		SELECT * FROM obter_convenio_particular_pf( cd_estabelecimento_w, NEW.cd_convenio, null, NEW.dt_atendimento, cd_convenio_w, cd_categoria_w) INTO STRICT cd_convenio_w, cd_categoria_w;
		NEW.cd_convenio	:= coalesce(cd_convenio_w,NEW.cd_convenio);
		NEW.cd_categoria	:= coalesce(cd_categoria_w,NEW.cd_categoria);
	end if;

	end;
end if;

cd_convenio_w		:= NEW.cd_convenio;
cd_categoria_w		:= NEW.cd_categoria;		

if (coalesce(NEW.nr_interno_conta,0) > 0) then
	
	select	max(cd_convenio_parametro),
		max(cd_categoria_parametro)
	into STRICT	cd_convenio_w,
		cd_categoria_w
	from	conta_paciente
	where	nr_interno_conta = NEW.nr_interno_conta;

end if;

/* tratar arredondamento da quantidade a faturar (baixa estabilidade) edilson/marcus 31/03/2007 */

if (ie_material_exec_fatur_w	= 'N') then
	select	obter_qt_material_fat(
				cd_estabelecimento_w,
				NEW.cd_material,
				cd_convenio_w,
				cd_categoria_w,
				NEW.cd_setor_atendimento,
				NEW.qt_material,
				NEW.cd_kit_material,
				dt_entrada_w,
				NEW.dt_atendimento,
				NEW.nr_prescricao,
				NEW.nr_sequencia_prescricao)
	into STRICT	qt_material_w
	;
		
end if;
if (NEW.qt_material <> qt_material_w) and (coalesce(NEW.nr_seq_cor_exec,0) not in (369,431,1475,1762,6697,1351)) then
	NEW.qt_estoque		:= coalesce(NEW.qt_estoque,NEW.qt_material);
	NEW.qt_material	:= qt_material_w;
end if;
if (NEW.qt_material <> qt_material_w) and (coalesce(NEW.nr_seq_cor_exec,0) in (431,1475,1762,6697,1351)) then
	select	Obter_qtde_estoque_fat(cd_estabelecimento_w, NEW.cd_material, cd_convenio_w, cd_categoria_w, NEW.cd_setor_atendimento,
					coalesce(NEW.qt_estoque,NEW.qt_material), NEW.cd_kit_material,  dt_entrada_w, NEW.dt_atendimento)
	into STRICT	qt_est_w
	;
	
	if (qt_est_w <> NEW.qt_material) then
		NEW.qt_estoque		:= qt_est_w;
		NEW.qt_material	:= NEW.qt_material;
	end if;
end if;
if (ie_centro_custo_inativo_w	= 'S') then
	select	coalesce(max(cd_centro_custo), 0)
	into STRICT	cd_centro_custo_w
	from	setor_atendimento
	where	cd_setor_atendimento	= NEW.cd_setor_atendimento;

	select	coalesce(max(ie_situacao), 'A')
	into STRICT	ie_situacao_w
	from	centro_custo
	where	cd_centro_custo	= cd_centro_custo_w;
	
	if (ie_situacao_w = 'I') then
		--O centro de custo do setor de atendimento esta inativo. O item nao pode ser executado.
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(184250);
	end if;
end if;

/* tratar prestador do matmed adelson - 13/09/05 */

select	obter_prestador_material(
	cd_estabelecimento_w,
	NEW.cd_convenio,
	NEW.cd_categoria,
	ie_tipo_atendimento_w,
	NEW.cd_setor_atendimento,
	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	NEW.cd_material,
	cd_medico_resp_w,
	NEW.dt_atendimento,
	NEW.cd_cgc_fornecedor)
into STRICT	cd_cgc_prestador_w
;

if (coalesce(NEW.nr_seq_mat_est,0) = 0) then
	NEW.cd_cgc_prestador := cd_cgc_prestador_w;
end if;
/* verificar se o material baixa estoque paciente matheus 10/10/2007 os 70591 coloquei nvl do cd_material_exec */

select obter_se_baixa_estoque_pac(NEW.cd_setor_atendimento, coalesce(NEW.cd_material_exec, NEW.cd_material),null,0)
into STRICT	ie_baixa_estoq_pac_w
;

if (NEW.qt_material < 0) then
	NEW.cd_acao	:= 2;
end if;
if (NEW.ie_dispersao is null) then
	NEW.ie_dispersao := 'N';
end if;

/*if	(:new.nr_prescricao is not null) and
	(nvl(:new.ie_auditoria,'N')	= 'N') then
	select	nvl(max(nr_atendimento),0)
	into	nr_atendimento_prescr_w
	from	prescr_medica
	where	nr_prescricao	= :new.nr_prescricao;
	
	if	(nr_atendimento_prescr_w	<> 0) and
		(nr_atendimento_prescr_w	<> :new.nr_atendimento) then
	end if;
end if;*/
/* inicio - tratar duplicidade no hdh - elemar - 08/08/03 */

if (NEW.cd_acao = 1) and (NEW.nr_prescricao is not null) and (NEW.nr_sequencia_prescricao is not null) and (NEW.nr_seq_ordem_prod is null) and (NEW.nr_cirurgia is null) and (NEW.nr_seq_processo is null) and (obter_funcao_ativa <> 1113) and
	(NEW.dt_atendimento > (LOCALTIMESTAMP - interval '5 days'/86400)) and (NEW.nr_seq_mat_glosa is null)	then /* (:new.nr_seq_lote_fornec is null) then matheus os 67360 08/10/2007 retirei este and */
	
	select 	coalesce(max(a.cd_motivo_baixa),0)
	into STRICT	cd_motivo_baixa_w
	from	material b,
		prescr_material a
	where	a.nr_prescricao	= NEW.nr_prescricao
	and	a.nr_sequencia	= NEW.nr_sequencia_prescricao
	and 	a.cd_material = b.cd_material
	and	a.ie_origem_inf	<> 'A'
	and 	b.ie_tipo_material <> 6 -- COnforme solicitado pelo Daniel Dalcastagne foi tratado para quando for sem apresentacao nao consistir
	and	(a.ie_acm = 'N' AND a.ie_se_necessario = 'N');
	
	if (cd_motivo_baixa_w <> 0) and (NEW.nr_devolucao is null) then
		--O item #@NR_SEQUENCIA_PRESCRICAO#@ ja esta baixado.	Material = #@CD_MATERIAL#@	#@DS_MATERIAL#@	!
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(184254,	'NR_SEQUENCIA_PRESCRICAO=' || NEW.nr_sequencia_prescricao ||
								';CD_MATERIAL=' || NEW.cd_material ||
								';DS_MATERIAL=' || ds_material_ww);

	end if;
end if;
/* fim */

if (NEW.cd_convenio is not null) then
	BEGIN
	select obter_material_conta(
		cd_estabelecimento_w,
		NEW.cd_convenio,
		NEW.cd_categoria,
		NEW.cd_material_prescricao,
		NEW.cd_material_exec,
		NEW.cd_material,
		cd_plano_convenio_w,
		cd_setor_atendimento_ww,
		NEW.dt_atendimento,
		NEW.cd_local_estoque,
		NEW.nr_prescricao)
	into STRICT	cd_material_w
	;

	/*os60360 andre verifica se material e inativo*/

	select	max(ie_situacao),
		max(substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30))
	into STRICT	ie_situacao_w,
		cd_unidade_medida_consumo_w
	from	material
	where	cd_material	= cd_material_w;
	
	select	substr(obter_desc_material(cd_material_w),1,100)
	into STRICT	ds_material_w
	;
	/*verifica se item esta inativo*/

	if (ie_permite_matmed_inativo_w = 'N') and (ie_situacao_w is not null) and (ie_situacao_w <> 'A') then
		--O item "'|| cd_material_w || '-' || ds_material_w || '" nao pode ser lancado pois esta inativo.
		--O item "#@CD_MATERIAL#@ - #@DS_MATERIAL#@" nao pode ser lancado pois esta inativo.
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(184256,	'CD_MATERIAL=' || cd_material_w || ';DS_MATERIAL=' || ds_material_w);
	end if;
	
	if (NEW.nr_seq_lote_ap is not null) then
	
		select	count(1)
		into STRICT	qt_reg_w
		from	ap_lote_item_subs;
		
		if (qt_reg_w > 0) then
			
			select	count(1)
			into STRICT	qt_reg_w
			from	ap_lote_item b,
				prescr_mat_hor a
			where	a.nr_sequencia = b.nr_seq_mat_hor
			and	b.nr_seq_lote = NEW.nr_seq_lote_ap
			and	a.nr_prescricao = NEW.nr_prescricao
			and	a.nr_seq_material = NEW.nr_sequencia_prescricao
			and	b.ie_item_substituido = 'S';
			
			if (qt_reg_w > 0) then
				ie_item_substituido_w := 'S';
			end if;
			
		end if;
		
	end if;
	
	if (cd_material_w is not null) and (cd_material_w <> NEW.cd_material) and (ie_item_substituido_w = 'N') then
		NEW.cd_material	:= cd_material_w;
		
		if (ie_atualiza_unid_consumo_w = 'S') then
			NEW.cd_unidade_medida	:= cd_unidade_medida_consumo_w;
		end if;
		
	end if;
	end;
end if;

if (ie_material_exec_fatur_w	= 'S') then
	select	obter_qt_material_fat(
				cd_estabelecimento_w,
				NEW.cd_material,
				cd_convenio_w,
				cd_categoria_w,
				NEW.cd_setor_atendimento,
				NEW.qt_material,
				NEW.cd_kit_material,
				dt_entrada_w,
				NEW.dt_atendimento,
				NEW.nr_prescricao,
				NEW.nr_sequencia_prescricao)
	into STRICT	qt_material_w
	;
	
	if (NEW.qt_material <> qt_material_w) and (coalesce(NEW.nr_seq_cor_exec,0) not in (369,431,1475,1762,6697)) then
		NEW.qt_estoque		:= coalesce(NEW.qt_estoque,NEW.qt_material);
		NEW.qt_material	:= qt_material_w;
	end if;
	if (NEW.qt_material <> qt_material_w) and (coalesce(NEW.nr_seq_cor_exec,0) in (431,1475,1762,6697)) then
		select	Obter_qtde_estoque_fat(cd_estabelecimento_w, NEW.cd_material, cd_convenio_w, cd_categoria_w, NEW.cd_setor_atendimento,
						coalesce(NEW.qt_estoque,NEW.qt_material), NEW.cd_kit_material,  dt_entrada_w, NEW.dt_atendimento)
		into STRICT	qt_est_w
		;		
		
		if (qt_est_w <> NEW.qt_material) then
			NEW.qt_estoque		:= qt_est_w;
			NEW.qt_material	:= NEW.qt_material;
		end if;
	end if;
end if;
if (ie_baixa_estoq_pac_w = 'S') and (NEW.cd_kit_material is null) and (NEW.cd_local_estoque is not null) and (coalesce(NEW.ie_estorno_conta,'N') = 'N') and (NEW.nr_devolucao is null) then /*matheus os 68151 gravar local na exclusao da conta mas nao gerar movto estoque*/
	BEGIN
	ds_observacao_w		:= substr(NEW.ds_observacao || ' ' || wheb_mensagem_pck.get_texto(799745,'NR_CIRURGIA=' || NEW.nr_cirurgia) ,1,255);

	if (obter_funcao_ativa = 24 and NEW.cd_acao = 2) then
			
		select m.ie_consignado,
			obter_se_material_estoque_lote(NEW.cd_material, cd_estabelecimento_logado_w),
			(select	coalesce(max(ie_regra_saldo_consig),0) 
			 from parametro_estoque
			 where cd_estabelecimento = cd_estabelecimento_logado_w)
		into STRICT ie_consignado_w,
			 ie_estoque_lote_w,
			 nr_seq_regra_w		
		from material m
		where m.cd_material = NEW.cd_material;
		
		if	((ie_estoque_lote_w <> 'S') and (ie_consignado_w = '2') and (nr_seq_regra_w > 0)) then
			NEW.cd_cgc_fornecedor := null;
		end if;

	end if;

	CALL gerar_prescricao_estoque(
				cd_estab_prescr_estoque_w,
				NEW.nr_atendimento,
				NEW.dt_entrada_unidade,
				coalesce(NEW.cd_material_exec,NEW.cd_material),
				NEW.dt_atendimento,
				NEW.cd_acao,
				NEW.cd_local_estoque,
				coalesce(NEW.qt_estoque,NEW.qt_material),
				NEW.cd_setor_atendimento,
				NEW.cd_unidade_medida,
				NEW.nm_usuario, 'I',
				NEW.nr_prescricao,
				NEW.nr_sequencia_prescricao,
				NEW.nr_seq_proc_princ,
				NEW.nr_sequencia,
				NEW.cd_cgc_fornecedor,
				ds_observacao_w,
				NEW.nr_seq_lote_fornec,
				NEW.nr_receita,
				NEW.nr_serie_material,
				NEW.nr_seq_lote_ap, 
				'',
				'',
				'');
	NEW.dt_atualizacao_estoque := LOCALTIMESTAMP;
	end;
end if;

if (NEW.nr_seq_lote_fornec is not null) then

	select	nr_serie_material,
		cd_convenio
	into STRICT	nr_serie_material_w,
		cd_conv_lote_w
	from	material_lote_fornec
	where	nr_sequencia = NEW.nr_seq_lote_fornec;
	
	if (cd_conv_lote_w is not null) and (cd_conv_lote_w <> NEW.cd_convenio) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(446037, 'NR_SEQ_LOTE=' || NEW.nr_seq_lote_fornec || ';DS_CONVENIO=' || substr(obter_desc_convenio(cd_conv_lote_w),1,255));
		/*O lote fornecedor seq. #@NR_SEQ_LOTE#@ pode ser utilizado exclusivamente no convenio #@DS_CONVENIO#@!*/

	end if;
	
	NEW.nr_serie_material := nr_serie_material_w;

end if;

/* Fabricio em 31/08/2009 OS 162926, inseri no select a function Obter_Setor_Atend_Data_Ent*/

if (NEW.cd_setor_paciente is null) then
	select	coalesce(Obter_Setor_Atend_Data_Ent(NEW.nr_atendimento, NEW.dt_atendimento),0)
	into STRICT	cd_setor_paciente_w
	;
	
	if (cd_setor_paciente_w = 0) then
		select	somente_numero(obter_unidade_atendimento(NEW.nr_atendimento,'A','CS'))
		into STRICT	cd_setor_paciente_w
		;
	end if;

	if (cd_setor_paciente_w > 0) then
		NEW.cd_setor_paciente	:= cd_setor_paciente_w;
	end if;
end if;

if (obter_funcao_ativa = 36) then   /* 36 = atendimento da prescricao   */
	vl_param_w := obter_param_usuario(obter_funcao_ativa, 28, obter_perfil_ativo, NEW.nm_usuario, 0, vl_param_w);
	if (vl_param_w <> 'P') then
		ie_baixa_w := 'N';
	end if;
end if;

if (obter_funcao_ativa = 24) then   /* 24 = execucao da prescricao   */
	vl_param_w := obter_param_usuario(obter_funcao_ativa, 54, obter_perfil_ativo, NEW.nm_usuario, 0, vl_param_w);
	/* (:new.qt_material < 0)   Retirado do if para que somente se o valor for igual a 'P' deve baixar na trigger */

	if (vl_param_w <> 'P') then
		ie_baixa_w := 'N';
	end if;
end if;

if (obter_funcao_ativa = 42) then   /* 42 = devolucao paciente   */
	vl_param_w := obter_param_usuario(obter_funcao_ativa, 28, obter_perfil_ativo, NEW.nm_usuario, 0, vl_param_w);
	if (vl_param_w <> 'P') then
		ie_baixa_w := 'N';
	end if;
end if;

if (obter_funcao_ativa in (7029, -2, 7030, -204, 4202, 1116, 88)) then   /* 7029 = atendimento do lote da prescricao   */
	ie_baixa_w := 'N';
end if;

if (obter_funcao_ativa = 1113) and /* 1113 = adep ( rafael em 17/4/8 os89339 ) */
	(cd_mot_baixa_adep_w = 0) then
	ie_baixa_w := 'N';
elsif (obter_funcao_ativa = 1113) and /*OS 201313 */
	(cd_mot_baixa_adep_w > 0) and (OLD.nr_seq_mat_glosa is null)	then 	
	ie_baixa_w := 'N';
	
	update	prescr_material a
	set	a.dt_baixa = LOCALTIMESTAMP,
		a.cd_motivo_baixa = cd_mot_baixa_adep_w
	where	a.nr_prescricao  = NEW.nr_prescricao
	and	a.nr_sequencia   = NEW.nr_sequencia_prescricao
	and	a.cd_motivo_baixa = 0;	
end if;

if (obter_funcao_ativa = -1113) then
	ie_baixa_w := 'N';
end if;

if (obter_funcao_ativa = 924) then /* fabio e jonas - os137237 - para nao baixar quando a funcao for prescricao eletronica*/
	ie_baixa_w := 'N';
end if;

if (coalesce(obter_funcao_ativa, 0) = 9001) and (coalesce(NEW.nr_seq_lote_ap, 0) > 0) then
	ie_baixa_w := 'N';
end if;

if (obter_funcao_ativa = 281) then
	ie_baixa_w := 'N';
end if;

if (coalesce(obter_funcao_ativa, 0) = 0) then
	ie_baixa_w := 'N';
end if;

if (obter_funcao_ativa = 3130) then
	ie_baixa_w := 'N';
end if;

if (obter_funcao_ativa = '-4') then
	ie_baixa_w := 'N';
end if;

if (obter_funcao_ativa = 87) then
	ie_baixa_w := 'N';
end if;

if (obter_funcao_ativa = 3112) and (ie_gedipa_fracionado_w = 'S') and (ie_legenda_baixado_adep_w = 'S') then
	ie_baixa_w := 'N';
end if;

/*if	(obter_funcao_ativa = 36) then
	obter_param_usuario(obter_funcao_ativa, 72, obter_perfil_ativo, :new.nm_usuario, 0, vl_param_w);
	if	(nvl(vl_param_w, 'S') = 'N') and
		(:new.qt_material < 0) then
		Wheb_mensagem_pck.exibir_mensagem_abort(290417);
	end if;
end if;*/
if (OLD.nr_seq_mat_glosa is null) then
	update	prescr_material a
	set		a.dt_baixa = LOCALTIMESTAMP,
			a.cd_motivo_baixa = 1
	where	a.nr_prescricao  = NEW.nr_prescricao
	and		a.nr_sequencia   = NEW.nr_sequencia_prescricao
	and		a.cd_motivo_baixa = 0
	and		ie_baixa_w	= 'S';
end if;

/*if	(:new.ie_valor_informado	= 'S') then
	gravar_log_valor_informado(2, :new.nr_sequencia, :new.nr_atendimento, :new.nr_interno_conta, :new.nm_usuario);
end if;*/
if (NEW.tx_material is null) then
	NEW.tx_material:= 100;
end if;

select	substr(max(module||' - ' || machine||' - ' || program|| ' - ' || osuser|| ' - ' || terminal),1,255),
	substr(max(osuser),1,100)
into STRICT	ds_module_log_w,
	osuser_log_w
from	v$session
where	audsid = (SELECT userenv('sessionid') );

ds_call_stack_w	:= substr(dbms_utility.format_call_stack,1,1800);

insert	into mat_atend_pac_log(
	nr_sequencia,
	nr_seq_mat,
	dt_atualizacao,	
	nm_usuario,
	ds_module,
	nr_atendimento,
	nr_interno_conta,
	cd_material,
	dt_atendimento,
	ie_acao,
	qt_material,
	vl_material,
	cd_perfil,
	cd_funcao,
	ie_valor_informado,
	nr_seq_proc_pacote,
	nr_seq_proc_princ,
	cd_setor_atendimento,
	dt_entrada_unidade,
	nr_seq_atepacu,
	nr_prescricao,
	cd_local_estoque,
	ds_call_stack,
	ie_auditoria)
values (nextval('mat_atend_pac_log_seq'),
	NEW.nr_sequencia,
	LOCALTIMESTAMP,
	NEW.nm_usuario,
	ds_module_log_w,
	NEW.nr_atendimento,
	NEW.nr_interno_conta,
	NEW.cd_material,
	NEW.dt_atendimento,
	'I',
	NEW.qt_material,
	NEW.vl_material,
	obter_perfil_ativo,
	obter_funcao_ativa,
	NEW.ie_valor_informado,
	NEW.nr_seq_proc_pacote,
	NEW.nr_seq_proc_princ,
	NEW.cd_setor_atendimento,
	NEW.dt_entrada_unidade,
	NEW.nr_seq_atepacu,
	NEW.nr_prescricao,
	NEW.cd_local_estoque,
	ds_call_stack_w,
	NEW.ie_auditoria);
	
select 	coalesce(max(ie_tipo_material),'1')
into STRICT	ie_tipo_material_w
from	material
where 	cd_material = NEW.cd_material;

if (ie_tipo_material_w = '6') then
	--Nao e permitido inserir um material na conta do tipo (Medicamento sem apresentacao), verifique o cadastro de material
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(184257);
end if;

CALL envia_alerta_mat_execucao(NEW.cd_material,NEW.nr_atendimento,NEW.nr_interno_conta,NEW.nr_sequencia,cd_estabelecimento_w,NEW.nm_usuario, NEW.dt_atendimento,
	NEW.qt_material, NEW.nr_seq_lote_fornec, NEW.nr_serie_material, NEW.nr_prescricao, NEW.nr_seq_atepacu);

if (NEW.dt_atualizacao_nrec is null) then
	NEW.dt_atualizacao_nrec := LOCALTIMESTAMP;
end if;

insert into mat_atend_pac_lote(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_lote_fornec,
	nr_seq_material
)
values (
	nextval('mat_atend_pac_lote_seq'),
	LOCALTIMESTAMP,
	NEW.nm_usuario,
	NEW.dt_atualizacao_nrec,
	NEW.nm_usuario,
	NEW.nr_seq_lote_fornec,
	NEW.nr_sequencia
);

-- OS 465559
if (NEW.nr_interno_conta is not null) then
	
	select	max(dt_geracao_resumo)
	into STRICT	dt_geracao_resumo_w
	from 	conta_paciente
	where 	nr_interno_conta = NEW.nr_interno_conta;
	
	if (dt_geracao_resumo_w is not null) then
		
		update	conta_paciente
		set 	dt_geracao_resumo  = NULL
		where 	nr_interno_conta = NEW.nr_interno_conta;
		
	end if;
	
end if;

if (ie_gerar_dialisador_aut_w = 'S') then
	
	CALL hd_verif_material_mod_dialise(NEW.cd_material,NEW.nr_seq_lote_fornec,NEW.nr_atendimento,NEW.nm_usuario,cd_estabelecimento_w);
	
end if;

NEW.ds_stack	:= substr(dbms_utility.format_call_stack,1,2000);
end if;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_atend_paciente_insert() FROM PUBLIC;

CREATE TRIGGER material_atend_paciente_insert
	BEFORE INSERT ON material_atend_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_atend_paciente_insert();

