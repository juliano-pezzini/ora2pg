-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS man_ordem_ativ_prev_after ON man_ordem_ativ_prev CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_man_ordem_ativ_prev_after() RETURNS trigger AS $BODY$
declare

nr_seq_tipo_exec_w	bigint;
ie_existe_registro_w 	varchar(1);
qt_fila_w			bigint;


BEGIN

	select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT 	ie_existe_registro_w
	from 	man_ordem_servico_exec a
	where 	NEW.nr_seq_ordem_serv = a.nr_seq_ordem
	and 	NEW.nm_usuario_prev = a.nm_usuario_exec
	and 	a.dt_fim_execucao is null;

	select 	max(a.nr_sequencia)
	into STRICT	nr_seq_tipo_exec_w
	from	man_tipo_executor a,
		man_ordem_servico_exec b
	where 	a.nr_sequencia = b.nr_seq_tipo_exec
	and	b.nr_sequencia = NEW.nr_sequencia;

	select	count(*)
	into STRICT	qt_fila_w
	from	cadastro_fila
	where	nm_usuario_fila = NEW.nm_usuario_prev;

	if (NEW.nm_usuario_prev is not null) and (qt_fila_w > 0) then

		if (ie_existe_registro_w = 'N') then
			BEGIN
				insert into man_ordem_servico_exec(
							nr_sequencia,
							nr_seq_ordem,
							dt_atualizacao,
							nm_usuario,
							nm_usuario_exec,
							qt_min_prev,
							dt_ult_visao,
							nr_seq_funcao,
							nr_seq_tipo_exec,
							dt_atualizacao_nrec,
							nm_usuario_nrec)
				values (		nextval('man_ordem_servico_exec_seq'),
							NEW.nr_seq_ordem_serv,
							LOCALTIMESTAMP,
							NEW.nm_usuario,
							NEW.nm_usuario_prev,
							NEW.qt_min_prev,
							null,
							NEW.nr_seq_funcao,
							nr_seq_tipo_exec_w,
							NEW.dt_atualizacao_nrec,
							NEW.nm_usuario_nrec);
			end;
		end if;
	end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_man_ordem_ativ_prev_after() FROM PUBLIC;

CREATE TRIGGER man_ordem_ativ_prev_after
	AFTER INSERT ON man_ordem_ativ_prev FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_man_ordem_ativ_prev_after();

