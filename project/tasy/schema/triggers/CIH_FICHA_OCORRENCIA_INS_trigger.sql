-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cih_ficha_ocorrencia_ins ON cih_ficha_ocorrencia CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cih_ficha_ocorrencia_ins() RETURNS trigger AS $BODY$
declare
qt_hist_w	bigint := 0;

BEGIN

    select    count(*)
            into STRICT	qt_hist_w
            from	wl_regra_item a,
                	wl_worklist b,
                    wl_item c
            where	a.nr_sequencia = b.nr_seq_regra
            and		b.nr_seq_item = c.nr_sequencia
            and		b.nr_atendimento = NEW.nr_atendimento
            and		b.dt_final_real is null
            and		c.cd_categoria = 'IH'
            and     b.nr_seq_regra is not null;

    if (coalesce(qt_hist_w,0) > 0)  then                        
        if (coalesce(wheb_usuario_pck.get_ie_executar_trigger,'S') = 'S') then

          CALL wl_gerar_finalizar_tarefa(
              'IH',
              'F',
              NEW.nr_atendimento,
              null,
              NEW.nm_usuario,
              LOCALTIMESTAMP,
              'N',
              null,
              null,
              null,
              null,
              null,
              null,
              null,
              null,
              null,
              null,
              null,
              LOCALTIMESTAMP,
              null,
              null,
              null,
              '',
              null,
              LOCALTIMESTAMP,
              null,
              null,
              null,
              null,
              null,
              'S',
              null,
              null,
              null );
        end if;
    end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cih_ficha_ocorrencia_ins() FROM PUBLIC;

CREATE TRIGGER cih_ficha_ocorrencia_ins
	AFTER INSERT ON cih_ficha_ocorrencia FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cih_ficha_ocorrencia_ins();

