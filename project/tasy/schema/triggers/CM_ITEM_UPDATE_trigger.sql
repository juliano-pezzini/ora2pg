-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cm_item_update ON cm_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cm_item_update() RETURNS trigger AS $BODY$
declare

qt_reg_w	numeric(20);
qt_reg_con_w	numeric(20);

pragma autonomous_transaction;

BEGIN

if (TG_OP = 'UPDATE') then
	if (coalesce(NEW.ie_situacao,'A') = 'I') then
		update	cm_conjunto_item
		set	ie_status_item = 6
		where	nr_seq_item = NEW.nr_sequencia;
	end if;
	
	if	((coalesce(OLD.ie_unico, 'N') = 'N') and (NEW.ie_unico = 'S')) then
		select 	count(*)
		into STRICT	qt_reg_con_w
		from 	cm_conjunto_item
		where	nr_seq_item = NEW.nr_sequencia;
		
		if (coalesce(qt_reg_con_w ,0) > 0) then
			--Nao eh possivel definir o item como unico. O item esta vinculado em mais de um conjunto.

			CALL wheb_mensagem_pck.exibir_mensagem_abort(1035493);
		end if;
		
	end if;
	
end if;

	select	count(*)
	into STRICT	qt_reg_w
	from 	cm_item
	where	cd_codigo = NEW.cd_codigo;

if (coalesce(qt_reg_w ,0)> 0)  and (coalesce(OLD.cd_codigo,0) <> NEW.cd_codigo)then

    if (TG_OP = 'UPDATE') then

        CALL wheb_mensagem_pck.exibir_mensagem_abort(317265);

    else
    
        NEW.cd_codigo := null;

    end if;

end if;
	

commit;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cm_item_update() FROM PUBLIC;

CREATE TRIGGER cm_item_update
	BEFORE INSERT OR UPDATE ON cm_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cm_item_update();

