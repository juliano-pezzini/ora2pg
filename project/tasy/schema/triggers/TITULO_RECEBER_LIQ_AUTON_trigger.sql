-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_receber_liq_auton ON titulo_receber_liq CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_receber_liq_auton() RETURNS trigger AS $BODY$
declare

pragma autonomous_transaction;

cd_estabelecimento_w    ctb_documento.cd_estabelecimento%type;
dt_movimento_w          ctb_documento.dt_competencia%type;
vl_baixa_w              titulo_receber.vl_titulo%type;
vl_movimento_w          ctb_documento.vl_movimento%type;
vl_tributo_tot_w        titulo_receber_trib.vl_tributo%type;
qt_baixas_w             bigint;
nr_seq_proj_rec_w       titulo_receber.nr_seq_proj_rec%type;
qt_registros_w          bigint := 0;
ie_contab_cr_w          ctb_param_lote_tesouraria.ie_contab_cr%type;

c01 CURSOR FOR
    SELECT  a.nm_atributo,
            a.cd_tipo_lote_contab
    from    atributo_contab a
    where   a.cd_tipo_lote_contab = 5
    and     a.nm_atributo in (  'VL_RECEBIDO', 'VL_RECEBIDO_TOTAL');

l_c01 c01%rowtype;
BEGIN
  BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

    BEGIN
        select  CASE WHEN a.ie_ctb_online='S' THEN  coalesce(a.ie_contab_cr, 'N')  ELSE 'N' END
        into STRICT    ie_contab_cr_w
        from    ctb_param_lote_tesouraria a
        where   a.cd_empresa = obter_empresa_estab(cd_estabelecimento_w)
        and     coalesce(a.cd_estab_exclusivo, cd_estabelecimento_w) = cd_estabelecimento_w;
    exception
        when no_data_found then
            ie_contab_cr_w := 'N';
        when too_many_rows then
            ie_contab_cr_w := 'N';
    end;

    BEGIN
    select  1
    into STRICT    qt_baixas_w

    where   exists (
        SELECT  t.nr_titulo
        from    titulo_receber_liq t
        where   t.nr_titulo = NEW.nr_titulo
        and     t.nr_sequencia = NEW.nr_sequencia
        );
    exception
        when no_data_found then
            qt_baixas_w := 0;
    end;

    if ( qt_baixas_w > 0 ) then

        BEGIN
        select  t.cd_estabelecimento,
                t.nr_seq_proj_rec
        into STRICT    cd_estabelecimento_w,
                nr_seq_proj_rec_w
        from    titulo_receber t
        where   t.nr_titulo = NEW.nr_titulo;
        exception
        when others then
            cd_estabelecimento_w:= null;
            nr_seq_proj_rec_w   := null;
        end;

        vl_baixa_w      := NEW.vl_recebido;
        dt_movimento_w  := NEW.dt_recebimento;

        select  sum(t.vl_tributo)
        into STRICT    vl_tributo_tot_w
        from    titulo_receber_trib t
        where   t.nr_titulo = NEW.nr_titulo;

        vl_movimento_w := vl_baixa_w - (vl_tributo_tot_w / qt_baixas_w);

        BEGIN
        select  1
        into STRICT    qt_registros_w

        where exists (
            SELECT  a.nr_sequencia
            from    ctb_documento a
            where   a.nr_documento           = NEW.nr_titulo
            and     a.nr_seq_doc_compl       in (NEW.nr_sequencia, coalesce(NEW.nr_seq_liq_origem,0))
            and     a.cd_tipo_lote_contabil  = 5
            and     a.cd_estabelecimento     = cd_estabelecimento_w
            and     a.nr_seq_trans_financ    = NEW.nr_seq_trans_fin
            and     a.nr_seq_info            = 14
            and     a.nm_tabela              = 'TITULO_RECEBER_LIQ'
            and     a.vl_movimento           = vl_movimento_w
            );
        exception
            when no_data_found then
                qt_registros_w := 0;
        end;

        if (qt_registros_w = 0) and ( coalesce(vl_movimento_w,0) <> 0 ) then
            CALL ctb_concil_financeira_pck.ctb_gravar_documento(
                        cd_estabelecimento_w,
                        dt_movimento_w,
                        5,
                        NEW.nr_seq_trans_fin,
                        14,
                        NEW.nr_titulo,
                        NEW.nr_sequencia,
                        null,
                        vl_movimento_w,
                        'TITULO_RECEBER_LIQ',
                        'VL_BAIXA_SEM_TRIB',
                        NEW.nm_usuario,
                        'P',
                        null,
                        nr_seq_proj_rec_w);
            commit;
        end if;

        if (TG_OP = 'UPDATE') and (NEW.ie_lib_caixa = 'S') then
            open c01;
            loop
            fetch c01 into l_c01;
            EXIT WHEN NOT FOUND; /* apply on c01 */

                vl_movimento_w := case l_c01.nm_atributo
                                when 'VL_RECEBIDO_TOTAL'    then (NEW.vl_recebido + NEW.vl_descontos + NEW.vl_juros + NEW.vl_multa)
                                when 'VL_RECEBIDO'          then NEW.vl_recebido
                                else
                                        null
                                end;
                qt_registros_w := 0;

                if (coalesce(vl_movimento_w, 0) <> 0 and coalesce(NEW.nr_seq_trans_fin, 0) <> 0) then
                    BEGIN
                    select  1
                    into STRICT    qt_registros_w

                    where exists (
                        SELECT  a.nr_sequencia
                        from    ctb_documento a
                        where   a.nr_documento          = NEW.nr_titulo
                        and     a.nr_seq_doc_compl      in (NEW.nr_sequencia, coalesce(NEW.nr_seq_liq_origem,0))
                        and     a.nr_doc_analitico      is null
                        and     a.cd_tipo_lote_contabil = 5  
                        and     a.cd_estabelecimento    = cd_estabelecimento_w
                        and     a.nr_seq_trans_financ   = NEW.nr_seq_trans_fin
                        and     a.nr_seq_info           = 14
                        and     a.nm_tabela             = 'TITULO_RECEBER_LIQ'
                        and     a.vl_movimento          = vl_movimento_w
                        );
                    exception
                        when no_data_found then
                            qt_registros_w := 0;
                    end;

                    if (qt_registros_w = 0) then

                        BEGIN
                        select  1
                        into STRICT    qt_registros_w

                        where exists (
                            SELECT  a.nr_sequencia
                            from    ctb_documento a
                            where   a.nr_documento          = NEW.nr_titulo
                            and     a.nr_seq_doc_compl      in (NEW.nr_sequencia, coalesce(NEW.nr_seq_liq_origem,0))
                            and     a.nr_doc_analitico      is not null
                            and     a.cd_tipo_lote_contabil = 5  
                            and     a.cd_estabelecimento    = cd_estabelecimento_w
                            and     a.nr_seq_trans_financ   = NEW.nr_seq_trans_fin
                            and     a.nr_seq_info           = 14
                            and     a.nm_tabela             = 'TITULO_REC_LIQ_CC'
                            and     a.nm_atributo           = l_c01.nm_atributo
                            );
                        exception
                            when no_data_found then
                                qt_registros_w := 0;
                        end;
                        if (qt_registros_w = 0) then
                            CALL ctb_concil_financeira_pck.ctb_gravar_documento(
                                    cd_estabelecimento_w,
                                    dt_movimento_w,
                                    l_c01.cd_tipo_lote_contab,
                                    NEW.nr_seq_trans_fin,
                                    14,
                                    NEW.nr_titulo,
                                    NEW.nr_sequencia,
                                    null,
                                    vl_movimento_w,
                                    'TITULO_RECEBER_LIQ',
                                    l_c01.nm_atributo,
                                    NEW.nm_usuario,
                                    'P',
                                    null,
                                    nr_seq_proj_rec_w);
                        end if;
                    end if;
                    commit;
                end if;
            end loop;
            close c01;
        end if;
    end if;
end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_receber_liq_auton() FROM PUBLIC;

CREATE TRIGGER titulo_receber_liq_auton
	AFTER INSERT OR UPDATE ON titulo_receber_liq FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_receber_liq_auton();

