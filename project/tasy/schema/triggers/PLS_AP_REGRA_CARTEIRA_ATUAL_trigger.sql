-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_ap_regra_carteira_atual ON pls_ap_regra_carteira CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_ap_regra_carteira_atual() RETURNS trigger AS $BODY$
declare

ie_acao_w		varchar(255);
nr_mes_w		integer := 0;
dt_execucao_w		timestamp;
dt_proxima_exec_w	varchar(255);
hr_exec_w		varchar(10);
nr_job_w		pls_ap_regra_carteira.nr_job%type;

BEGIN
nr_job_w	:= OLD.nr_job;

if (TG_OP = 'INSERT') then
	ie_acao_w := 'I';
elsif (TG_OP = 'UPDATE') then
	ie_acao_w := 'U';
elsif (TG_OP = 'DELETE') then
	ie_acao_w := 'D';
end if;

if (NEW.hr_execucao is not null) then
	hr_exec_w := to_char(NEW.hr_execucao, 'hh24:mi:ss');
else
	hr_exec_w := to_char((fim_dia(LOCALTIMESTAMP) - 1/3072), 'hh24:mi:ss');
end if;

if (NEW.ie_forma_geracao = 'M') then
	if (NEW.nr_dia_geracao is null) and (ie_acao_w in ('I','U')) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1077327);
	end if;
	
	if	(((trunc(LOCALTIMESTAMP,'month') + NEW.nr_dia_geracao) - 1) < trunc(LOCALTIMESTAMP)) then
		nr_mes_w := + 1;
	end if;
	
	dt_execucao_w		:= to_date(to_char(to_char(add_months(((trunc(LOCALTIMESTAMP,'month') + NEW.nr_dia_geracao) - 1),nr_mes_w),'dd/mm/yyyy') || ' ' || hr_exec_w), 'dd/mm/yyyy hh24:mi:ss');
	dt_proxima_exec_w	:= 'add_months(to_date(to_char(to_char(add_months(((trunc(sysdate,''month'') + ' || NEW.nr_dia_geracao || ') - 1),' || nr_mes_w || '),''dd/mm/yyyy'') || '' '' || ''' || hr_exec_w || '''), ''dd/mm/yyyy hh24:mi:ss''),1)';
elsif (NEW.ie_forma_geracao = 'D') then
	if (NEW.nr_dia_geracao is not null) and (ie_acao_w in ('I','U')) then
		NEW.nr_dia_geracao	:= null;
	end if;
	
	dt_execucao_w		:= to_date((to_char(LOCALTIMESTAMP,'dd/mm/yyyy') || ' ' || hr_exec_w),'dd/mm/yyyy hh24:mi:ss');
	dt_proxima_exec_w	:= 'to_date((to_char(sysdate,''dd/mm/yyyy'') || '' '' || ''' || hr_exec_w || '''),''dd/mm/yyyy hh24:mi:ss'') + 1';
end if;

nr_job_w := pls_criar_job_automatizacao(	ie_acao_w, nr_job_w, 'PLS_PA_LOTE_CARTEIRA('''|| to_char(OLD.nr_sequencia) || ''', ''' || NEW.nm_usuario_nrec || ''');', dt_execucao_w, dt_proxima_exec_w, NEW.ie_situacao);

if (ie_acao_w in ('I','U')) then
	NEW.nr_job	:= nr_job_w;
end if;

IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_ap_regra_carteira_atual() FROM PUBLIC;

CREATE TRIGGER pls_ap_regra_carteira_atual
	BEFORE INSERT OR UPDATE OR DELETE ON pls_ap_regra_carteira FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_ap_regra_carteira_atual();

