-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS nota_fiscal_update_consist ON nota_fiscal CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_nota_fiscal_update_consist() RETURNS trigger AS $BODY$
declare
nr_sequencia_w		bigint;
ie_entrada_saida_w	varchar(1);
ie_bloqueio_nr_serie_w	varchar(1);
ie_bloqueio_nr_w	varchar(1);
ie_consiste_estab_w	varchar(1);

pragma autonomous_transaction;

BEGIN

if	( ((TG_OP = 'UPDATE') and (NEW.dt_atualizacao_estoque is not null) and (OLD.dt_atualizacao_estoque is null)) or /*Se a nota já  existir e tiver calculando*/
	(TG_OP = 'INSERT' AND NEW.dt_atualizacao_estoque is not null)) and /*Se a nota está sendo criada já calculada*/
	(NEW.ie_situacao = '1') and
	((NEW.cd_cgc_emitente is not null) or (NEW.ie_tipo_nota = 'EF')) then
	BEGIN
	nr_sequencia_w		:= null;
	ie_bloqueio_nr_serie_w	:= substr(coalesce(obter_valor_param_usuario(40, 102, Obter_perfil_ativo, NEW.nm_usuario, NEW.cd_estabelecimento),'S'),1,1);
	ie_consiste_estab_w	:= substr(coalesce(obter_valor_param_usuario(40, 277, Obter_perfil_ativo, NEW.nm_usuario, NEW.cd_estabelecimento),'S'),1,1);

	if (ie_bloqueio_nr_serie_w = 'D') then
		ie_bloqueio_nr_serie_w := substr(obter_consiste_nf_mesmo_nr(NEW.cd_cgc_emitente, NEW.cd_pessoa_fisica, NEW.cd_estabelecimento),1,1);
	end if;

	if (ie_bloqueio_nr_serie_w = 'P') then

		if (NEW.ie_tipo_nota = 'EF') then
			BEGIN
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_sequencia_w
			from	nota_fiscal
			where (ie_consiste_estab_w = 'N' or cd_estabelecimento = NEW.cd_estabelecimento)
			and	trunc(dt_emissao,'yyyy') = trunc(NEW.dt_emissao,'yyyy')
			and	cd_pessoa_fisica = NEW.cd_pessoa_fisica
			and	cd_serie_nf = NEW.cd_serie_nf
			and	nr_nota_fiscal = NEW.nr_nota_fiscal
			and	ie_situacao = '1'
			and	nr_sequencia <> NEW.nr_sequencia
			and	dt_atualizacao_estoque is not null;
			end;
		else
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_sequencia_w
			from	nota_fiscal
			where (ie_consiste_estab_w = 'N' or cd_estabelecimento = NEW.cd_estabelecimento)
			and	trunc(dt_emissao,'yyyy') = trunc(NEW.dt_emissao,'yyyy')
			and	cd_cgc_emitente = NEW.cd_cgc_emitente
			and	cd_serie_nf = NEW.cd_serie_nf
			and	nr_nota_fiscal = NEW.nr_nota_fiscal
			and	ie_situacao = '1'
			and	nr_sequencia <> NEW.nr_sequencia
			and	dt_atualizacao_estoque is not null;
		end if;


	elsif (ie_bloqueio_nr_serie_w = 'S') then

		if (NEW.ie_tipo_nota = 'EF') then
			BEGIN

			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_sequencia_w
			from	nota_fiscal
			where (ie_consiste_estab_w = 'N' or cd_estabelecimento = NEW.cd_estabelecimento)
			and	cd_pessoa_fisica = NEW.cd_pessoa_fisica
			and	cd_serie_nf = NEW.cd_serie_nf
			and	nr_nota_fiscal = NEW.nr_nota_fiscal
			and	ie_situacao = '1'
			and	nr_sequencia <> NEW.nr_sequencia
			and	dt_atualizacao_estoque is not null;

			end;
		else
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_sequencia_w
			from	nota_fiscal
			where (ie_consiste_estab_w = 'N' or cd_estabelecimento = NEW.cd_estabelecimento)
			and	cd_cgc_emitente = NEW.cd_cgc_emitente
			and	cd_serie_nf = NEW.cd_serie_nf
			and	nr_nota_fiscal = NEW.nr_nota_fiscal
			and	ie_situacao = '1'
			and	nr_sequencia <> NEW.nr_sequencia
			and	dt_atualizacao_estoque is not null;

		end if;


	end if;

	if (nr_sequencia_w is null) then
		BEGIN
		ie_bloqueio_nr_w	:= substr(coalesce(obter_valor_param_usuario(40, 183, Obter_perfil_ativo, NEW.nm_usuario, NEW.cd_estabelecimento),'S'),1,1);

		if (ie_bloqueio_nr_w = 'S') then

			if (NEW.ie_tipo_nota = 'EF') then
				BEGIN
				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from	nota_fiscal
				where (ie_consiste_estab_w = 'N' or cd_estabelecimento = NEW.cd_estabelecimento)
				and	cd_pessoa_fisica = NEW.cd_pessoa_fisica
				and	nr_nota_fiscal = NEW.nr_nota_fiscal
				and	ie_situacao = '1'
				and	nr_sequencia <> NEW.nr_sequencia
				and	dt_atualizacao_estoque is not null;
				end;
			else
				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from	nota_fiscal
				where (ie_consiste_estab_w = 'N' or cd_estabelecimento = NEW.cd_estabelecimento)
				and	cd_cgc_emitente = NEW.cd_cgc_emitente
				and	nr_nota_fiscal = NEW.nr_nota_fiscal
				and	ie_situacao = '1'
				and	nr_sequencia <> NEW.nr_sequencia
				and	dt_atualizacao_estoque is not null;
			end if;

		elsif (ie_bloqueio_nr_w = 'P') then
			if (NEW.ie_tipo_nota = 'EF')  then
				BEGIN
				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from	nota_fiscal
				where (ie_consiste_estab_w = 'N' or cd_estabelecimento = NEW.cd_estabelecimento)
				and	trunc(dt_emissao,'yyyy') = trunc(NEW.dt_emissao,'yyyy')
				and	cd_pessoa_fisica = NEW.cd_pessoa_fisica
				and	nr_nota_fiscal = NEW.nr_nota_fiscal
				and	ie_situacao = '1'
				and	nr_sequencia <> NEW.nr_sequencia
				and	dt_atualizacao_estoque is not null;
				end;
			else
				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from	nota_fiscal
				where (ie_consiste_estab_w = 'N' or cd_estabelecimento = NEW.cd_estabelecimento)
				and	trunc(dt_emissao,'yyyy') = trunc(NEW.dt_emissao,'yyyy')
				and	cd_cgc_emitente = NEW.cd_cgc_emitente
				and	nr_nota_fiscal = NEW.nr_nota_fiscal
				and	ie_situacao = '1'
				and	nr_sequencia <> NEW.nr_sequencia
				and	dt_atualizacao_estoque is not null;
			end if;


		end if;
		end;
	end if;

	if (nr_sequencia_w > 0) then
		CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(248040,'NR_SEQUENCIA_W='||NR_SEQUENCIA_W);
	end if;

	end;
end if;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_nota_fiscal_update_consist() FROM PUBLIC;

CREATE TRIGGER nota_fiscal_update_consist
	BEFORE INSERT OR UPDATE ON nota_fiscal FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_nota_fiscal_update_consist();

