-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS intpd_ordem_compra_item ON ordem_compra_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_intpd_ordem_compra_item() RETURNS trigger AS $BODY$
declare

reg_integracao_p		gerar_int_padrao.reg_integracao;
qt_registros_w			bigint;
dt_aprovacao_w			ordem_compra.dt_aprovacao%type;

pragma autonomous_transaction;
BEGIN
  BEGIN

reg_integracao_p.cd_estab_documento	:= null;
reg_integracao_p.ie_tipo_ordem		:= null;
reg_integracao_p.nr_seq_tipo_compra	:= null;
reg_integracao_p.nr_seq_mod_compra	:= null;
reg_integracao_p.ds_id_origin		:= null;

select 	max(dt_aprovacao)
into STRICT	dt_aprovacao_w
from 	ordem_compra
where 	nr_ordem_compra = NEW.nr_ordem_compra;


if (TG_OP = 'INSERT' or TG_OP = 'UPDATE') and (dt_aprovacao_w is null) then

	BEGIN
	select	1
	into STRICT	qt_registros_w
	from	intpd_fila_transmissao
	where	nr_seq_documento = NEW.nr_ordem_compra
	and	ie_evento = '2'
	and	coalesce(ie_status,'P') not in ('P','R')  LIMIT 1;
	exception
	when others then
		qt_registros_w := 0;
	end;

	if (qt_registros_w > 0) then
		reg_integracao_p.ie_operacao		:= 'A';
		reg_integracao_p := gerar_int_padrao.gravar_integracao('2', NEW.nr_ordem_compra, NEW.nm_usuario, reg_integracao_p);
	end if;

elsif (TG_OP = 'DELETE') then

	BEGIN
	select	1
	into STRICT	qt_registros_w
	from	intpd_fila_transmissao
	where	nr_seq_documento = OLD.nr_ordem_compra
	and	ie_evento = '2'
	and	ie_status in ('S')  LIMIT 1;
	exception
	when others then
		qt_registros_w := 0;
	end;

	if (qt_registros_w > 0) then
		reg_integracao_p.ie_operacao		:= 'E';
		reg_integracao_p := gerar_int_padrao.gravar_integracao('2', OLD.nr_ordem_compra, OLD.nm_usuario, reg_integracao_p);
	end if;
end if;

commit;

  END;
IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_intpd_ordem_compra_item() FROM PUBLIC;

CREATE TRIGGER intpd_ordem_compra_item
	BEFORE INSERT OR UPDATE OR DELETE ON ordem_compra_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_intpd_ordem_compra_item();

