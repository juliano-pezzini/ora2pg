-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS fa_entrega_medicacao_update ON fa_entrega_medicacao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_fa_entrega_medicacao_update() RETURNS trigger AS $BODY$
declare
cd_pessoa_fisica_w	varchar(10);

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'S' ) then
	if (OLD.ie_status_medicacao = NEW.ie_status_medicacao) and (NEW.dt_cancelamento is null) and ((OLD.dt_impressao = NEW.dt_impressao) or (NEW.dt_impressao is null)) then
		if (NEW.ie_status_medicacao = 'AC') then
			-- Status da entrega já está como Aguardando conferência. Favor atualizar a tela!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(215070);
		elsif (NEW.ie_status_medicacao = 'CM') then
			-- Status da entrega já está como Conferência da medicação. Favor atualizar a tela!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(215071);
		elsif (NEW.ie_status_medicacao = 'EM') then
			-- Status da entrega já está como Entrega da medicação. Favor atualizar a tela!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(215072);
		end if;
	end if;

	if (NEW.dt_cancelamento is not null) and (OLD.dt_cancelamento is null) and (NEW.nr_seq_paciente_entrega is not null) then

		update	fa_paciente_entrega
		set	ie_status_paciente = 'EC'
		where 	nr_sequencia = NEW.nr_seq_paciente_entrega;
	end if;

	if (NEW.cd_pessoa_fisica is not null AND NEW.nr_seq_receita_amb is not null) then

		SELECT max(cd_pessoa_fisica)
		INTO STRICT   cd_pessoa_fisica_w
		FROM   fa_receita_farmacia
		WHERE  nr_sequencia = NEW.nr_seq_receita_amb;

		if (NEW.cd_pessoa_fisica <> cd_pessoa_fisica_w) then
			-- O paciente da entrega é diferente da receita. Favor verificar!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(215066);
		end if;

		select 	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_w
		from	fa_paciente_entrega
		where	nr_sequencia 	= NEW.nr_seq_paciente_entrega;

		if (NEW.cd_pessoa_fisica <> cd_pessoa_fisica_w) then
			-- O paciente da entrega é diferente do atendimento. Favor verificar!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(215067);
		end if;
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_fa_entrega_medicacao_update() FROM PUBLIC;

CREATE TRIGGER fa_entrega_medicacao_update
	BEFORE UPDATE ON fa_entrega_medicacao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_fa_entrega_medicacao_update();

