-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pfcs_module_occupancy_upsert ON pfcs_module_occupancy CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pfcs_module_occupancy_upsert() RETURNS trigger AS $BODY$
DECLARE
pragma autonomous_transaction;
cd_unit_type_w      pfcs_unit.cd_type%type  := NEW.cd_unit_classification;
ie_exists_types_w   pfcs_panel.ie_flag%type := PFCS_PCK_CONSTANTS.IE_NO;
ie_exists_tele_w    pfcs_panel.ie_flag%type := PFCS_PCK_CONSTANTS.IE_NO;
ie_duplicated_w     pfcs_panel.ie_flag%type := PFCS_PCK_CONSTANTS.IE_NO;

BEGIN
    if (coalesce(wheb_usuario_pck.get_ie_executar_trigger,PFCS_PCK_CONSTANTS.IE_YES_BR) = PFCS_PCK_CONSTANTS.IE_YES_BR) then
        select coalesce(max(PFCS_PCK_CONSTANTS.IE_YES), PFCS_PCK_CONSTANTS.IE_NO)
        into STRICT ie_exists_types_w
        from pfcs_module_occupancy
        where nr_seq_dynamic_module = NEW.nr_seq_dynamic_module
        and cd_unit_classification <> PFCS_PCK_CONSTANTS.CD_UNIT_TYPE_TELE;

        select coalesce(max(PFCS_PCK_CONSTANTS.IE_YES), PFCS_PCK_CONSTANTS.IE_NO)
        into STRICT ie_exists_tele_w
        from pfcs_module_occupancy
        where nr_seq_dynamic_module = NEW.nr_seq_dynamic_module
        and cd_unit_classification = PFCS_PCK_CONSTANTS.CD_UNIT_TYPE_TELE;

        select coalesce(max(PFCS_PCK_CONSTANTS.IE_YES), PFCS_PCK_CONSTANTS.IE_NO)
        into STRICT ie_duplicated_w
        from pfcs_module_occupancy
        where nr_seq_dynamic_module = NEW.nr_seq_dynamic_module
        and cd_unit_classification = cd_unit_type_w;

        if ( (cd_unit_type_w = PFCS_PCK_CONSTANTS.CD_UNIT_TYPE_TELE and ie_exists_types_w = PFCS_PCK_CONSTANTS.IE_YES)
                or (cd_unit_type_w <> PFCS_PCK_CONSTANTS.CD_UNIT_TYPE_TELE and ie_exists_tele_w = PFCS_PCK_CONSTANTS.IE_YES) ) then
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1216579);
        end if;

        if (ie_duplicated_w = PFCS_PCK_CONSTANTS.IE_YES) then
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1216606);
        end if;
    end if;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pfcs_module_occupancy_upsert() FROM PUBLIC;

CREATE TRIGGER pfcs_module_occupancy_upsert
	BEFORE INSERT OR UPDATE ON pfcs_module_occupancy FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pfcs_module_occupancy_upsert();

