-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS sup_inspecao_receb_atual ON inspecao_recebimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_sup_inspecao_receb_atual() RETURNS trigger AS $BODY$
declare

nr_sequencia_w					inspecao_rec_aspecto_item.nr_sequencia%type;
nr_seq_aspecto_w				inspecao_rec_aspecto.nr_sequencia%type;
qt_registro_w					bigint;
ie_preenche_auto_aspecto			varchar(255);
BEGIN
  BEGIN
select (max(obter_valor_param_usuario(270, 94, obter_perfil_ativo, NEW.nm_usuario, wheb_usuario_pck.get_cd_estabelecimento)))
into STRICT 	ie_preenche_auto_aspecto
;

if (ie_preenche_auto_aspecto = 'S') then
	BEGIN
	if (TG_OP = 'INSERT') then
		BEGIN
		select 	nextval('inspecao_rec_aspecto_item_seq') ,
			sup_obter_aspecto_material(NEW.cd_material,wheb_usuario_pck.get_cd_estabelecimento)
		into STRICT	nr_sequencia_w,
			nr_seq_aspecto_w
		;


		insert into inspecao_rec_aspecto_item(
			NR_SEQUENCIA,
			NR_SEQ_ASPECTO,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NR_SEQ_INSPECAO)
		values (nr_sequencia_w,
			nr_seq_aspecto_w,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			LOCALTIMESTAMP,
			NEW.nr_sequencia);

		end;
	elsif (TG_OP = 'UPDATE') then
		BEGIN

		select 	sup_obter_aspecto_material(NEW.cd_material,wheb_usuario_pck.get_cd_estabelecimento)
		into STRICT	nr_seq_aspecto_w
		;

		BEGIN
		select	1
		into STRICT	qt_registro_w
		from 	inspecao_rec_aspecto_item
		where	nr_seq_inspecao = NEW.nr_sequencia;

		exception
		when others then
			qt_registro_w := 0;
		end;

		if (qt_registro_w > 0)	then
			BEGIN

			update 	inspecao_rec_aspecto_item
			set	DT_ATUALIZACAO = LOCALTIMESTAMP,
				nr_seq_aspecto = nr_seq_aspecto_w
			where	nr_seq_inspecao = NEW.nr_sequencia;

			end;
		else
			BEGIN

			select 	nextval('inspecao_rec_aspecto_item_seq')
			into STRICT	nr_sequencia_w
			;

			insert into inspecao_rec_aspecto_item(
				NR_SEQUENCIA,
				NR_SEQ_ASPECTO,
				DT_ATUALIZACAO,
				NM_USUARIO,
				DT_ATUALIZACAO_NREC,
				NR_SEQ_INSPECAO)
			values (	nr_sequencia_w,
				nr_seq_aspecto_w,
				LOCALTIMESTAMP,
				NEW.nm_usuario,
				LOCALTIMESTAMP,
				NEW.nr_sequencia);

			end;
		end if;

		end;
	end if;

	end;
end if;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_sup_inspecao_receb_atual() FROM PUBLIC;

CREATE TRIGGER sup_inspecao_receb_atual
	AFTER INSERT OR UPDATE ON inspecao_recebimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_sup_inspecao_receb_atual();

