-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pre_pj_beforeinsert ON pre_pessoa_juridica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pre_pj_beforeinsert() RETURNS trigger AS $BODY$
declare

  v_nr_sequencia bigint;
  v_cgc varchar(14);

BEGIN

  if (wheb_usuario_pck.get_ie_executar_trigger = 'S')  then
    -- Verifica se há regra cadastrada para o tipo de pessoa juridica

    select MAX(nr_sequencia)
      into STRICT v_nr_sequencia
      from ( SELECT nr_sequencia
               from regra_pre_cad_pj
              where cd_tipo_pessoa = NEW.cd_tipo_pessoa
                and ie_exige_aprov_cadastro = 'S'

union

             SELECT nr_sequencia
               from regra_pre_cad_pj
              where cd_tipo_pessoa is null
                and ie_exige_aprov_cadastro = 'S' ) alias2;

    if v_nr_sequencia is null then
      CALL wheb_mensagem_pck.exibir_mensagem_abort(1063717);
    end if;

    -- Verifica se a pessoa jurídica já não existe na base de dados

    select MAX(cd_cgc) into STRICT v_cgc from pessoa_juridica where cd_cgc = NEW.cd_cgc;

    if v_cgc is not null then
      CALL wheb_mensagem_pck.exibir_mensagem_abort(1063587);
    end if;
  end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pre_pj_beforeinsert() FROM PUBLIC;

CREATE TRIGGER pre_pj_beforeinsert
	BEFORE INSERT ON pre_pessoa_juridica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pre_pj_beforeinsert();

