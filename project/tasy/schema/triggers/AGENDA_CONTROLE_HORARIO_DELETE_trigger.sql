-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS agenda_controle_horario_delete ON agenda_controle_horario CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_agenda_controle_horario_delete() RETURNS trigger AS $BODY$
DECLARE
  PRAGMA AUTONOMOUS_TRANSACTION;

  qt_dias_sugestao_w bigint;
  qt_reg_w smallint := 0;
BEGIN
  BEGIN

  select coalesce(max(qt_dias_sugestao), 0)
  into STRICT qt_dias_sugestao_w
  from parametro_agenda_integrada;

  select coalesce(max(1), 0)
  into STRICT qt_reg_w
  from user_scheduler_running_jobs
  where job_name like 'AGINT_GERA_JOB%';

  IF (qt_dias_sugestao_w > 0) and (qt_reg_w = 0) THEN
    dbms_scheduler.create_job(job_name   => 'AGINT_GERA_JOB' ||
                                            to_char(LOCALTIMESTAMP + interval '3 days'/24/60/60, 'JHH24MISS'),
                              job_type   => 'PLSQL_BLOCK',
                              job_action => 'Begin AGEINT_SUGERIR_HORARIOS_PCK.AGEINT_VERIFICA_DIAS_LIBERADOS; END;',
                              enabled    => TRUE,
                              auto_drop  => TRUE);
  END IF;

EXCEPTION
  WHEN OTHERS THEN
    NULL;

  END;
RETURN OLD;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_agenda_controle_horario_delete() FROM PUBLIC;

CREATE TRIGGER agenda_controle_horario_delete
	AFTER DELETE ON agenda_controle_horario FOR EACH STATEMENT
	EXECUTE PROCEDURE trigger_fct_agenda_controle_horario_delete();

