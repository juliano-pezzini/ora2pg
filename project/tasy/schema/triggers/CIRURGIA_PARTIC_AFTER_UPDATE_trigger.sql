-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cirurgia_partic_after_update ON cirurgia_participante CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cirurgia_partic_after_update() RETURNS trigger AS $BODY$
declare

ie_participante_carta_w	varchar(1);
nr_seq_carta_w		carta_medica.nr_sequencia%type;
nr_seq_carta_mae_w	carta_medica.nr_seq_carta_mae%type;
ie_cirurgiao_w		funcao_medico.ie_cirurgiao%type;

BEGIN
		
	if (NEW.dt_liberacao is not null and OLD.dt_liberacao is null) then
		
		select 	max(nr_sequencia),
				max(nr_seq_carta_mae)
		into STRICT	nr_seq_carta_w,
				nr_seq_carta_mae_w
		from 	carta_medica
		where 	nr_cirurgia = OLD.nr_cirurgia;
		
		if (nr_seq_carta_w is not null) then
		
			select	coalesce(max('S'), 'N')
			into STRICT	ie_participante_carta_w
			from 	participante_carta_medica a
			where 	nr_seq_carta = nr_seq_carta_w
			and	obter_pessoa_fisica_usuario(a.nm_usuario_resp, 'C') = OLD.cd_pessoa_fisica;
			
			select	coalesce(max(ie_cirurgiao),'N')
			into STRICT	ie_cirurgiao_w
			from 	funcao_medico
			where 	cd_funcao = OLD.ie_funcao;
			
			 if (ie_participante_carta_w <> 'S' and ie_cirurgiao_w = 'S') then
				insert into PARTICIPANTE_CARTA_MEDICA(
					nr_sequencia,
					nr_seq_carta,
					nr_seq_carta_mae,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					nm_usuario_resp,
					ie_deve_assinar
				) 	values (
					nextval('participante_carta_medica_seq'),
					nr_seq_carta_w,
					nr_seq_carta_mae_w,
					LOCALTIMESTAMP,
					LOCALTIMESTAMP,
					NEW.nm_usuario,
					NEW.nm_usuario,
					obter_usuario_pessoa(OLD.cd_pessoa_fisica),
					'S'
				);
			end if;
		end if;
	end if;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cirurgia_partic_after_update() FROM PUBLIC;

CREATE TRIGGER cirurgia_partic_after_update
	AFTER UPDATE ON cirurgia_participante FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cirurgia_partic_after_update();

