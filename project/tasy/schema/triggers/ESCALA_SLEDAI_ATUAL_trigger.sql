-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_sledai_atual ON escala_sledai CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_sledai_atual() RETURNS trigger AS $BODY$
declare
    qt_reg_w    escala_sledai.qt_pontuacao%type;
    qt_pontos_w escala_sledai.qt_pontuacao%type := 0;
    ds_erro_w   dic_objeto.ds_informacao%type;
    ds_parametro_w  dic_objeto.ds_informacao%type;
    ds_nr_sequencia_w dic_objeto.nm_campo_base%type := ':new.nr_sequencia : ';
    ds_nr_atendimento_w dic_objeto.nm_campo_base%TYPE := ' - :new.nr_atendimento: ';
    ds_nm_usuario_w dic_objeto.nm_campo_base%type := ' - :new.nm_usuario: ';
    ds_nm_trigger_w dic_objeto.nm_campo_base%type := 'ESCALA_SLEDAI_ATUAL';
    ds_nm_funcao_w dic_objeto.nm_campo_base%type := 'OBTER_SCORE_ESCALA_SLEDAI';
    ds_formato_hora_w   escala_sledai.CD_PROFISSIONAL%type := 'hh24';
    ds_valor_padrao_s_w   escala_sledai.ie_leucopenia%type := 'S';
    ds_valor_padrao_n_w   escala_sledai.ie_leucopenia%type := 'N';
BEGIN
  BEGIN
    IF (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
        NEW.nr_hora  := (to_char(round(NEW.DT_AVALIACAO, ds_formato_hora_w), ds_formato_hora_w))::numeric;
    END IF;

    IF (wheb_usuario_pck.get_ie_executar_trigger  = ds_valor_padrao_s_w)  THEN
    
        <<BLOCO_PRINCIPAL>>
        BEGIN
            qt_pontos_w := OBTER_SCORE_ESCALA_SLEDAI( NEW.ie_convulsao,
                                                      NEW.ie_psicose,
                                                      NEW.ie_scerebral_organico,
                                                      NEW.ie_disturbio_visual,
                                                      NEW.ie_alteracao_nervos_cranianos,
                                                      NEW.ie_dor_cabeca_sle,
                                                      NEW.ie_acidente_vascular_cerebral,
                                                      NEW.ie_vasculite,
                                                      NEW.ie_artrite,
                                                      NEW.ie_miosite,
                                                      NEW.ie_cilindros,
                                                      NEW.ie_hematuria,
                                                      NEW.ie_proteinuria,
                                                      NEW.ie_piuria,
                                                      NEW.ie_erupcao_pele,
                                                      NEW.ie_alopecia,
                                                      NEW.ie_ulcera_mucosa,
                                                      NEW.ie_pleurisia,
                                                      NEW.ie_pericardite,
                                                      NEW.ie_hipocomplementemia,
                                                      NEW.ie_aumento_ligacao_dna,
                                                      NEW.ie_febre,
                                                      NEW.ie_trombocitopenia,
                                                      NEW.ie_leucopenia);

        EXCEPTION
            WHEN data_exception OR PROGRAM_ERROR OR unique_violation THEN
                qt_pontos_w := null;
                ds_erro_w := sqlerrm;
                ds_parametro_w := ds_nr_sequencia_w || NEW.nr_sequencia  || ds_nr_atendimento_w || NEW.nr_atendimento || ds_nm_usuario_w || NEW.nm_usuario;
                CALL gravar_log_medical_device(ds_nm_trigger_w, ds_nm_funcao_w, ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, ds_valor_padrao_n_w);
        END;

        NEW.qt_pontuacao  := qt_pontos_w;
    ELSE
        qt_reg_w  := 0;
    END IF;

  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_sledai_atual() FROM PUBLIC;

CREATE TRIGGER escala_sledai_atual
	BEFORE INSERT OR UPDATE ON escala_sledai FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_sledai_atual();

