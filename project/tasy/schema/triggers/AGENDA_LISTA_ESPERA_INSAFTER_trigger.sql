-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS agenda_lista_espera_insafter ON agenda_lista_espera CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_agenda_lista_espera_insafter() RETURNS trigger AS $BODY$
DECLARE
  EQ RECORD;
BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then
	  IF TG_OP = 'INSERT' THEN
		BEGIN
			FOR EQ IN (SELECT * FROM CPOE_EQUIPE_CIRURGIA WHERE NR_SEQ_PROC_CPOE = NEW.NR_SEQ_CPOE_PROCEDIMENTO) LOOP
						INSERT INTO EQUIPE_LISTA_ESPERA(NR_SEQUENCIA, DT_ATUALIZACAO, NM_USUARIO, DT_ATUALIZACAO_NREC,
							NM_USUARIO_NREC, NR_SEQ_EQUIPE, NR_SEQ_EQUIPE_CPOE, IE_INDICACAO, 
							CD_PROFISSIONAL, CD_FUNCAO, CD_ESPECIALIDADE, NR_SEQ_LISTA_ESPERA)
						VALUES (nextval('equipe_lista_espera_seq'), LOCALTIMESTAMP, NEW.NM_USUARIO, LOCALTIMESTAMP, NEW.NM_USUARIO, EQ.NR_SEQ_EQUIPE, EQ.NR_SEQUENCIA, EQ.IE_INDICACAO, 
							EQ.CD_PROFISSIONAL, EQ.CD_FUNCAO_MEDICO, EQ.CD_ESPECIALIDADE, NEW.NR_SEQUENCIA);
			END LOOP;

					FOR EQ IN (SELECT * FROM CPOE_PROCED_ADICIONAL WHERE NR_SEQ_PROC_CPOE = NEW.NR_SEQ_CPOE_PROCEDIMENTO) LOOP
						INSERT INTO LISTA_ESPERA_PROC_ADD(NR_SEQUENCIA, DT_ATUALIZACAO, NM_USUARIO, DT_ATUALIZACAO_NREC,
							NM_USUARIO_NREC, NR_SEQ_LISTA_ESPERA, NR_ATENDIMENTO, CD_POSICAO, NR_SEQ_PROC_INTERNO)
						VALUES (nextval('lista_espera_proc_add_seq'), LOCALTIMESTAMP, NEW.NM_USUARIO, LOCALTIMESTAMP, NEW.NM_USUARIO, NEW.NR_SEQUENCIA,EQ.NR_ATENDIMENTO,
							EQ.CD_POSICAO, EQ.NR_SEQ_PROC_INTERNO);
			END LOOP;
		END;
	  END IF;
	
	  IF TG_OP = 'DELETE' THEN
		DELETE FROM EQUIPE_LISTA_ESPERA WHERE NR_SEQ_LISTA_ESPERA = OLD.NR_SEQUENCIA;
	  END IF;
  end if;
IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_agenda_lista_espera_insafter() FROM PUBLIC;

CREATE TRIGGER agenda_lista_espera_insafter
	AFTER INSERT OR DELETE ON agenda_lista_espera FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_agenda_lista_espera_insafter();

