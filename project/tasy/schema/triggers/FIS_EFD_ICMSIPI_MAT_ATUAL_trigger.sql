-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS fis_efd_icmsipi_mat_atual ON material CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_fis_efd_icmsipi_mat_atual() RETURNS trigger AS $BODY$
declare
ie_efd_icmsipi_w	varchar(1);

BEGIN
ie_efd_icmsipi_w := obter_param_usuario(5500, 61, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_efd_icmsipi_w);

if (wheb_usuario_pck.get_ie_executar_trigger = 'S' ) then
	if (coalesce(ie_efd_icmsipi_w,'N') = 'S') then
		-- REGISTRO 0200.DESCR_ITEM
		if (coalesce(NEW.ds_material,'XPTO') <> coalesce(OLD.ds_material,'XPTO')) then
			insert into fis_efd_icmsipi_alteracao(
				nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_campo_alterado,
				ds_valor_anterior,
				cd_material)
			values (nextval('fis_efd_icmsipi_alteracao_seq'),
				LOCALTIMESTAMP,
				obter_usuario_ativo,
				'20', -- Dom√≠nio 8965 - EFD ICMS/IPI - Campo alterado
				substr(OLD.ds_material,1,255),
				NEW.cd_material);
		end if;
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_fis_efd_icmsipi_mat_atual() FROM PUBLIC;

CREATE TRIGGER fis_efd_icmsipi_mat_atual
	AFTER INSERT OR UPDATE OF ds_material ON material FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_fis_efd_icmsipi_mat_atual();

