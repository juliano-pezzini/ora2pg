-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_audit_atual ON escala_audit CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_audit_atual() RETURNS trigger AS $BODY$
DECLARE
  qt_reg_w    smallint;
  sql_w       varchar(200);
  qt_pontos_w smallint;
BEGIN
  BEGIN
    if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
        BEGIN  
            NEW.nr_hora := (to_char(round(NEW.DT_AVALIACAO,'hh24'),'hh24'))::numeric;
        end;
    end if;

    if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then 
        goto Final;
    end if;
 
    if (NEW.cd_pessoa_fisica is null) and (NEW.nr_atendimento is not null) then 
        NEW.cd_pessoa_fisica := obter_pessoa_atendimento(NEW.nr_atendimento, 'C');
    end if;

    /** Medical Device **/


    BEGIN
        sql_w := 'call CALCULA_AUDIT_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10) into :qt_pontos_w';
        EXECUTE sql_w using in NEW.qt_frequencia,
                                      in NEW.qt_dose_dia,
                                      in NEW.qt_freq_cinco_dose,
                                      in NEW.qt_nao_consegue_fazer,
                                      in NEW.qt_beber_manha,
                                      in NEW.qt_culpado_beber,
                                      in NEW.qt_nao_lembrar,
                                      in NEW.qt_ferimento_prej,
                                      in NEW.qt_sugeriu_parar,
                                      in NEW.qt_nao_consegue_parar,
                                      out qt_pontos_w;
    exception
        when others then
            qt_pontos_w := null;
    end;
    NEW.qt_pontos := qt_pontos_w;
 
    <<Final>> 
    qt_reg_w := 0;
  END;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_audit_atual() FROM PUBLIC;

CREATE TRIGGER escala_audit_atual
	BEFORE INSERT OR UPDATE ON escala_audit FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_audit_atual();

