-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS paciente_tratamento_befinsupd ON paciente_tratamento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_paciente_tratamento_befinsupd() RETURNS trigger AS $BODY$
declare

cd_perfil_w		integer;
cd_estabelecimento_w	integer;
qt_reg_w	smallint;
BEGIN
  BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;

if (NEW.dt_final_tratamento is not null) and (NEW.nr_seq_motivo_fim is null) and (NEW.ds_motivo_fim is null) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(182367);
end if;

if (NEW.dt_final_tratamento is null) and (NEW.ie_tratamento in ('CAPD','CO','CPI','DPA','HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DPAV','DDC','IHF','IHDF')) then
	BEGIN
	update	hd_pac_renal_cronico
	set	ie_situacao = 'S'
	where	cd_pessoa_fisica = NEW.cd_pessoa_fisica;
	end;
end if;
	
if (NEW.dt_final_tratamento is not null) then
	BEGIN
	update	hd_pac_renal_cronico
	set	ie_situacao = 'N'
	where	cd_pessoa_fisica = NEW.cd_pessoa_fisica;
	end;
end if;

if (NEW.dt_final_tratamento is not null) and (OLD.dt_final_tratamento is null) and (NEW.ie_tratamento in ('CAPD','CO','CPI','DPA','HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DPAV','DDC','IHF','IHDF')) then
	BEGIN	
	cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
	
	select	max(cd_perfil_paciente_fim)
	into STRICT	cd_perfil_w
	from	hd_parametro
	where	cd_estabelecimento = cd_estabelecimento_w;
	exception
		when others then
		cd_perfil_w	:= 0;
	end;
	
	
	if (cd_perfil_w > 0) then

		if (NEW.cd_pessoa_fisica is not null) then
			insert into comunic_interna(
				dt_comunicado,
				ds_titulo,
				ds_comunicado,
				nm_usuario,
				dt_atualizacao,
				ie_geral,
				nm_usuario_destino,
				ds_perfil_adicional,
				nr_sequencia,
				ie_gerencial,
				dt_liberacao,
				cd_estab_destino
			) values (
				LOCALTIMESTAMP,
				wheb_mensagem_pck.get_texto(793683),
				wheb_mensagem_pck.get_texto(793676)||' ' || NEW.cd_pessoa_fisica ||' - '|| obter_nome_pf(NEW.cd_pessoa_fisica) ||' '|| wheb_mensagem_pck.get_texto(793705) ||' '|| substr(obter_valor_dominio(2197,NEW.IE_TRATAMENTO),1,80) || '.'|| chr(10) || wheb_mensagem_pck.get_texto(793682)|| ' ' || substr(obter_dados_motivo_fim(NEW.nr_seq_motivo_fim,'D'),1,255),
				NEW.nm_usuario,
				LOCALTIMESTAMP,
				'N',
				'',
				cd_perfil_w||', ',
				nextval('comunic_interna_seq'),
				'N',
				LOCALTIMESTAMP,
				cd_estabelecimento_w);
		end if;
	end if;
end if;

if (NEW.dt_final_tratamento is not null) and (OLD.dt_final_tratamento is null) and (NEW.nr_seq_receptor is not null) and (NEW.ie_tratamento in ('PT','TR','TX')) then

	cd_estabelecimento_w	:= tx_obter_estab_receptor(NEW.nr_seq_receptor);

	BEGIN

	select	max(cd_perfil_paciente_fim)
	into STRICT	cd_perfil_w
	from	tx_parametros
	where	cd_estabelecimento = coalesce(cd_estabelecimento_w,cd_estabelecimento);
	exception
		when others then
		cd_perfil_w	:= 0;
	end;

	if (cd_perfil_w > 0) then

		if (NEW.cd_pessoa_fisica is not null) then
			insert into comunic_interna(
				dt_comunicado,
				ds_titulo,
				ds_comunicado,
				nm_usuario,
				dt_atualizacao,
				ie_geral,
				nm_usuario_destino,
				ds_perfil_adicional,
				nr_sequencia,
				ie_gerencial,
				dt_liberacao,
				cd_estab_destino
			) values (
				LOCALTIMESTAMP,
				wheb_mensagem_pck.get_texto(793683),
				wheb_mensagem_pck.get_texto(793676)||' ' || NEW.cd_pessoa_fisica ||' - '|| obter_nome_pf(NEW.cd_pessoa_fisica) ||' '|| wheb_mensagem_pck.get_texto(793705) ||' '|| substr(obter_valor_dominio(2197,NEW.IE_TRATAMENTO),1,80) || '.'|| chr(10) || wheb_mensagem_pck.get_texto(793682)|| ' ' || substr(obter_dados_motivo_fim(NEW.nr_seq_motivo_fim,'D'),1,255),
				NEW.nm_usuario,
				LOCALTIMESTAMP,
				'N',
				'',
				cd_perfil_w||', ',
				nextval('comunic_interna_seq'),
				'N',
				LOCALTIMESTAMP,
				cd_estabelecimento_w);
		end if;
	end if;
end if;

<<Final>>
qt_reg_w	:= 0;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_paciente_tratamento_befinsupd() FROM PUBLIC;

CREATE TRIGGER paciente_tratamento_befinsupd
	BEFORE INSERT OR UPDATE ON paciente_tratamento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_paciente_tratamento_befinsupd();

