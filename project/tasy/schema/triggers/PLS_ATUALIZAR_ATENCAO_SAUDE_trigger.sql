-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_atualizar_atencao_saude ON pls_atencao_saude CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_atualizar_atencao_saude() RETURNS trigger AS $BODY$
declare
ie_permite_atualizar_w	varchar(1);

C01 CURSOR(especialidade_p bigint) FOR
	SELECT	nr_sequencia
	from	pls_prestador_med_espec
	where	cd_especialidade = especialidade_p;


BEGIN

select	coalesce(IE_ATUALIZA_PREST_ATE_SAU, 'N')
into STRICT	ie_permite_atualizar_w
from	PLS_PARAMETROS
where (wheb_usuario_pck.get_cd_estabelecimento is null) or
	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

if (ie_permite_atualizar_w = 'S') then
	for	r_c01_w	in	C01( OLD.cd_especialidade ) loop
		delete	FROM pls_prest_atencao_saude
		where	nr_sequencia = (	SELECT	min(nr_sequencia)
						from	pls_prest_atencao_saude
						where	nr_seq_prest_med_espec = r_c01_w.nr_sequencia
						and	ie_tp_atencao_saude = OLD.ie_tp_atencao_saude);
	end loop;

	if (NEW.nr_sequencia is not null) then
		for	r_c01_w	in	C01( NEW.cd_especialidade ) loop
			insert into pls_prest_atencao_saude(	nr_sequencia,
								nr_seq_prest_med_espec,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								ie_tp_atencao_saude,
								dt_inicio_vigencia,
								dt_fim_vigencia)
			values (nextval('pls_prest_atencao_saude_seq'),
				r_c01_w.nr_sequencia,
				LOCALTIMESTAMP,
				NEW.nm_usuario,
				LOCALTIMESTAMP,
				NEW.nm_usuario,
				NEW.ie_tp_atencao_saude,
				coalesce(NEW.dt_inicio_vigencia, LOCALTIMESTAMP),
				NEW.dt_fim_vigencia);
		end loop;
	end if;
end if;

IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_atualizar_atencao_saude() FROM PUBLIC;

CREATE TRIGGER pls_atualizar_atencao_saude
	AFTER INSERT OR UPDATE OR DELETE ON pls_atencao_saude FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_atualizar_atencao_saude();

