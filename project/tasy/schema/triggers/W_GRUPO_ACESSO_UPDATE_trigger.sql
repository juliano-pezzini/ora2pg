-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS w_grupo_acesso_update ON w_grupo_acesso CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_w_grupo_acesso_update() RETURNS trigger AS $BODY$
declare

cont_w			bigint;
dt_entrada_w		timestamp;
nr_atendimento_w	bigint;
nr_sequencia_w		bigint;
dt_acompanhante_w	timestamp;
nr_seq_atend_visita_w	bigint;

BEGIN

if (NEW.dt_evento <> coalesce(OLD.dt_evento,NEW.dt_evento+1)) and (NEW.dt_evento is not null) then
	select	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	controle_acesso_visita
	where	cd_grupo = NEW.cd_grupo;

	select	max(dt_entrada),
		max(nr_atendimento),
		max(dt_acompanhante),
		max(nr_seq_atend_visita)
	into STRICT	dt_entrada_w,
		nr_atendimento_w,
		dt_acompanhante_w,
		nr_seq_atend_visita_w
	from	atendimento_visita_grupo
	where	nr_sequencia	= NEW.nr_seq_atend;

	if (dt_entrada_w is null) then
		update	atendimento_visita_grupo
		set	dt_entrada	= NEW.dt_evento
		where	nr_sequencia	= NEW.nr_seq_atend;
	else
		update	atendimento_visita_grupo
		set	dt_saida	= NEW.dt_evento
		where	nr_sequencia	= NEW.nr_seq_atend;
	end if;

	if (nr_seq_atend_visita_w is not null) then
		select	count(*)
		into STRICT	cont_w
		from	atendimento_visita_grupo
		where	coalesce(nr_seq_atend_visita,0) = coalesce(nr_seq_atend_visita_w,0)
		and	dt_saida is null;

		if (cont_w = 0) then
			update	atendimento_visita
			set	dt_saida	= NEW.dt_evento
			where	nr_sequencia	= nr_seq_atend_visita_w;
		end if;

	elsif (dt_acompanhante_w is not null) then
		select	count(*)
		into STRICT	cont_w
		from	atendimento_visita_grupo
		where	nr_atendimento	= nr_atendimento_w
		and	dt_acompanhante	= dt_acompanhante_w
		and	dt_saida is null;

		if (cont_w = 0) then
			update	atendimento_acompanhante
			set	dt_saida	= NEW.dt_evento
			where	nr_atendimento	= nr_atendimento_w
			and	dt_acompanhante	= dt_acompanhante_w
			and	dt_saida	is null;
		end if;

	elsif (nr_atendimento_w is not null) then
		select	count(*)
		into STRICT	cont_w
		from	atendimento_visita_grupo
		where	nr_atendimento	= nr_atendimento_w
		and	dt_saida 	is null;

		if (cont_w = 0) then
			update	atendimento_visita
			set	dt_saida	= NEW.dt_evento
			where	nr_atendimento	= nr_atendimento_w
			and	dt_saida	is null;
		end if;

	end if;

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_w_grupo_acesso_update() FROM PUBLIC;

CREATE TRIGGER w_grupo_acesso_update
	BEFORE UPDATE ON w_grupo_acesso FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_w_grupo_acesso_update();

