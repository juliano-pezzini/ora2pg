-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS convenio_retorno_item_insert ON convenio_retorno_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_convenio_retorno_item_insert() RETURNS trigger AS $BODY$
DECLARE
IE_STATUS_RETORNO_w	varchar(100);
vl_guia_w		double precision;
cont_w			bigint;
ie_conv_dif_w		varchar(255);
cd_conv_par_w		bigint;
cd_conv_ret_w		bigint;
ie_perm_conta_sem_titulo_w	varchar(5) := 'S';
ie_perm_lancar_partic_w	varchar(5) := 'n';
ie_bloq_lancto_guia_anl_grg_w	varchar(1);
nr_titulo_w		bigint;
ie_vinc_adiant_prot_pj_w varchar(1);
nr_adiantamento_w	conta_paciente_adiant.nr_adiantamento%type;

dt_pagamento_w		convenio_retorno_item.dt_pagamento%type;
BEGIN
  BEGIN

ie_perm_conta_sem_titulo_w := Obter_Param_Usuario(27, 226, obter_perfil_ativo, NEW.nm_usuario, wheb_usuario_pck.Get_cd_estabelecimento, ie_perm_conta_sem_titulo_w);
ie_perm_lancar_partic_w := Obter_Param_Usuario(27, 53, obter_perfil_ativo, NEW.nm_usuario, wheb_usuario_pck.Get_cd_estabelecimento, ie_perm_lancar_partic_w);

select	max(IE_STATUS_RETORNO)
into STRICT	IE_STATUS_RETORNO_w
from	convenio_retorno
where	nr_sequencia	= NEW.nr_seq_retorno;

if (IE_STATUS_RETORNO_w <> 'R') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(204450);
					
					
end if;

select	max(cd_convenio)
into STRICT	cd_conv_ret_w
from	convenio_retorno
where	nr_sequencia		=  NEW.nr_seq_retorno;

BEGIN
	select	coalesce(conv_est.ie_vinc_adiant_prot_pj,'N')
	into STRICT	ie_vinc_adiant_prot_pj_w
	from	convenio_estabelecimento conv_est,
		convenio_retorno conv_ret
	where	conv_est.cd_convenio = conv_ret.cd_convenio
	and	conv_est.cd_estabelecimento = conv_ret.cd_estabelecimento
	and	conv_ret.nr_sequencia = NEW.nr_seq_retorno;
exception
when others then
	ie_vinc_adiant_prot_pj_w := 'N';
end;


select	max(nr_adiantamento)
into STRICT	nr_adiantamento_w
from	conta_paciente_adiant
where	nr_interno_conta = NEW.nr_interno_conta;

if (ie_vinc_adiant_prot_pj_w = 'S') and (nr_adiantamento_w is not null) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1026496,'nr_adiantamento_w='||nr_adiantamento_w||';'||
							'nr_interno_conta_w='||NEW.nr_interno_conta);
end if;


select	count(*)
into STRICT	cont_w
from	conta_paciente_guia
where	nr_interno_conta		= NEW.nr_interno_conta
and	cd_autorizacao		= NEW.cd_autorizacao;

if (cont_w > 0) then
	select	coalesce(sum(vl_guia),0)
	into STRICT	vl_guia_w
	from	conta_paciente_guia
	where	nr_interno_conta		= NEW.nr_interno_conta
	and	cd_autorizacao		= NEW.cd_autorizacao;

	if (vl_guia_w = 0) then
		select	coalesce(sum(vl_participante),0)
		into STRICT	vl_guia_w
		from	conta_paciente_guia
		where	nr_interno_conta		= NEW.nr_interno_conta
		and	cd_autorizacao		= NEW.cd_autorizacao;
	end if;
	
	if (NEW.vl_pago >= 0) and (NEW.vl_amenor > 0) and (NEW.vl_amenor > vl_guia_w) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(204455,	'NR_INTERNO_CONTA_W='||NEW.NR_INTERNO_CONTA||
								';CD_AUTORIZACAO_W='||NEW.CD_AUTORIZACAO||
								';VL_GUIA_W='||VL_GUIA_W||
								';VL_AMENOR_W='||NEW.VL_AMENOR);
	end if;
end if;

ie_conv_dif_w := Obter_Param_Usuario(27, 70, obter_perfil_ativo, NEW.nm_usuario, 0, ie_conv_dif_w);

if (coalesce(ie_conv_dif_w, 'N') = 'N') then

	select	max(cd_convenio_parametro)
	into STRICT	cd_conv_par_w
	from	conta_paciente
	where	nr_interno_conta	= NEW.nr_interno_conta;

	if (cd_conv_ret_w <> cd_conv_par_w) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(204459);
	end if;

end if;

if (coalesce(ie_perm_conta_sem_titulo_w,'S') = 'N') then
	nr_titulo_w	:= coalesce(obter_nr_titulo_conta_prot(NEW.nr_interno_conta),0);
	
	if (coalesce(nr_titulo_w,0) = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(204461,'NR_INTERNO_CONTA_W=' ||NEW.NR_INTERNO_CONTA);
	end if;
end if;

BEGIN
	select	coalesce(conv_est.ie_bloq_lancto_guia_anl_grg,'N')
	into STRICT	ie_bloq_lancto_guia_anl_grg_w
	from	convenio_estabelecimento conv_est,
		convenio_retorno conv_ret
	where	conv_est.cd_convenio = conv_ret.cd_convenio
	and	conv_est.cd_estabelecimento = conv_ret.cd_estabelecimento
	and	conv_ret.nr_sequencia = NEW.nr_seq_retorno;
exception
when others then
	ie_bloq_lancto_guia_anl_grg_w := 'N';
end;

if (ie_bloq_lancto_guia_anl_grg_w = 'S') then
	
	select	count(*)
	into STRICT	cont_w
	from	lote_audit_hist_guia x,
		lote_audit_hist y
	where	x.nr_interno_conta	= NEW.nr_interno_conta
	and	x.cd_autorizacao	= NEW.cd_autorizacao
	and	x.nr_seq_lote_hist	= y.nr_sequencia
	and	(((x.dt_baixa_glosa	is null) and (obter_valores_guia_grc(x.nr_seq_lote_hist,x.nr_interno_conta,x.cd_autorizacao,'VG') > 0))
	or	 ((y.dt_fechamento is null) and (obter_valores_guia_grc(x.nr_seq_lote_hist,x.nr_interno_conta,x.cd_autorizacao,'VG') = 0)));

	if (cont_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(896840,'NR_GUIA_W=' ||NEW.CD_AUTORIZACAO||';NR_CONTA_W='||NEW.NR_INTERNO_CONTA);
	end if;
	
end if;

if NEW.dt_pagamento is null then
			
	BEGIN
		select	dt_retorno
		into STRICT	dt_pagamento_w
		from	convenio_retorno
		where	nr_sequencia = NEW.nr_seq_retorno;
	exception
	when others then
		dt_pagamento_w := null;
	end;
		
	NEW.dt_pagamento := dt_pagamento_w;
end if;


  END;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_convenio_retorno_item_insert() FROM PUBLIC;

CREATE TRIGGER convenio_retorno_item_insert
	BEFORE INSERT ON convenio_retorno_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_convenio_retorno_item_insert();

