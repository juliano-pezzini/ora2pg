-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS rxt_agenda_befins_uk ON rxt_agenda CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_rxt_agenda_befins_uk() RETURNS trigger AS $BODY$
declare
ie_registros_existentes_w       bigint;

pragma autonomous_transaction;
BEGIN
        if (NEW.IE_STATUS_AGENDA not in ('C','F','H','L','B')) then

                select  count(*)
                into STRICT    ie_registros_existentes_w
                from    rxt_agenda
                where   nr_seq_equipamento      =  NEW.NR_SEQ_EQUIPAMENTO
                and     nr_sequencia            <> NEW.NR_SEQUENCIA
                and     ie_status_agenda        =  NEW.IE_STATUS_AGENDA
                and     to_date(to_char(dt_agenda, 'dd/mm/yyyy hh24:mi'), 'dd/mm/yyyy hh24:mi') = to_date(to_char(NEW.DT_AGENDA, 'dd/mm/yyyy hh24:mi'), 'dd/mm/yyyy hh24:mi')
                and     ie_status_agenda        not  in ('C', 'F', 'H','L','B')
		and	((coalesce(ie_transferencia, 'N') = 'N')
			or 	((coalesce(ie_transferencia, 'N') = 'S')
			and (nr_seq_tratamento <> NEW.NR_SEQ_TRATAMENTO)));

                if (ie_registros_existentes_w > 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(419973);
                end if;
        end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_rxt_agenda_befins_uk() FROM PUBLIC;

CREATE TRIGGER rxt_agenda_befins_uk
	BEFORE INSERT OR UPDATE ON rxt_agenda FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_rxt_agenda_befins_uk();

