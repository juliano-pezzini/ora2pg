-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS radix_proc_paciente_aftinsert ON procedimento_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_radix_proc_paciente_aftinsert() RETURNS trigger AS $BODY$
declare

qt_proc_cir_w			bigint;
nr_seq_conv_w			atend_categoria_convenio.nr_seq_interno%type;
reg_integracao_p		gerar_int_padrao.reg_integracao;

BEGIN

/* Projeto radix - Ponto de integracao - Realizacao do procedimento na conta*/


/* Executa somente quando houver numero de cirurgia na insercao do proc interno e o 
tipo de utilizacao for cirurgico com codigo tuss informado */


if  ((coalesce(NEW.nr_cirurgia,0) > 0) and (coalesce(NEW.nr_seq_proc_interno,0) > 0)) then

	nr_seq_conv_w := obter_atecaco_atendimento(NEW.nr_atendimento);

		select 	max(b.cd_convenio),
        max(b.cd_categoria),
        max(b.cd_plano_convenio),
        max(a.ie_tipo_atendimento),
        max(a.cd_estabelecimento)
		into STRICT	reg_integracao_p.cd_convenio,
				reg_integracao_p.cd_categoria,
				reg_integracao_p.cd_plano_convenio,
				reg_integracao_p.ie_tipo_atendimento,
				reg_integracao_p.cd_estab_documento
		from	atendimento_paciente a,
				atend_categoria_convenio b
		where   a.nr_atendimento = b.nr_atendimento
		and    	b.nr_seq_interno = nr_seq_conv_w;

		select 	count(*)
		into STRICT	qt_proc_cir_w
		from 	proc_interno
		where 	nr_sequencia = NEW.nr_seq_proc_interno
		and 	ie_tipo_util in ('C','SC')
		and		cd_procedimento_tuss is not null;
			
		if (coalesce(qt_proc_cir_w,0) > 0) then
			reg_integracao_p := gerar_int_padrao.gravar_integracao('68', NEW.nr_sequencia, NEW.nm_usuario, reg_integracao_p);
			-- 68 - Ponto de integracao 

			-- reg_integracao_p - Retorno padrao

		end if;		
end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_radix_proc_paciente_aftinsert() FROM PUBLIC;

CREATE TRIGGER radix_proc_paciente_aftinsert
	AFTER INSERT ON procedimento_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_radix_proc_paciente_aftinsert();

