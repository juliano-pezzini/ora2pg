-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_atend_paciente_after ON material_atend_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_atend_paciente_after() RETURNS trigger AS $BODY$
declare
    reg_integracao_w 	gerar_int_padrao.reg_integracao;
    ie_evento_w 		varchar(10); --dominio 8187
	jobno 				bigint;
	qt_integracao_w		bigint;
BEGIN


if (TG_OP = 'INSERT') and (NEW.qt_material >= 0) then
	
	reg_integracao_w.ie_operacao := CASE WHEN TG_OP = 'INSERT' THEN 'I' WHEN TG_OP = 'UPDATE' THEN 'A' WHEN TG_OP = 'DELETE' THEN 'E' END;
	reg_integracao_w.cd_estab_documento := wheb_usuario_pck.get_cd_estabelecimento();
	reg_integracao_w.ie_status		:= 'P';
	reg_integracao_w.nr_seq_item_documento_p := '1';
	ie_evento_w := '161';
	reg_integracao_w := gerar_int_padrao.gravar_integracao(ie_evento_w, NEW.nr_sequencia, NEW.nm_usuario, reg_integracao_w);

else
	if (TG_OP = 'INSERT') then
		
		select 	count(*)
		into STRICT	qt_integracao_w
		from 	intpd_eventos
		where 	ie_evento = 161
		and 	ie_situacao = 'A';
		
		if (qt_integracao_w > 0) then
		
			dbms_job.submit(jobno, 'intpd_gerar_devol_mat_proc(' || to_char(NEW.cd_material) || ', ' ||
										to_char(coalesce(to_char(NEW.nr_seq_lote_fornec), 'null')) || ', ' ||
										to_char(NEW.nr_atendimento) || ', ' ||
										to_char(NEW.nr_sequencia) || ', ' ||
										to_char('null') || ', ' ||
										to_char(replace(NEW.qt_material,',','.')) || ', ' ||
										to_char(NEW.cd_setor_atendimento) || ', ' || chr(39) ||
										to_char(NEW.nm_usuario) || chr(39) || ');');
		end if;
		
	end if;
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_atend_paciente_after() FROM PUBLIC;

CREATE TRIGGER material_atend_paciente_after
	AFTER INSERT ON material_atend_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_atend_paciente_after();

