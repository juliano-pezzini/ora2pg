-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS agenda_paciente_update_hl7 ON agenda_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_agenda_paciente_update_hl7() RETURNS trigger AS $BODY$
declare
ds_sep_bv_w		varchar(100);
ds_param_integ_hl7_w	varchar(4000);
ie_gerar_integracao_w	varchar(1);
ie_integrado_w		varchar(1);
cd_tipo_agenda_w	bigint;
ie_permite_ag_ep12_w  varchar(1);

parametros 		LT_PARAM_INTEGRACAO;
param_element 	T_PARAM_INTEGRACAO;

--pragma autonomous_transaction;
BEGIN

select	coalesce(max(IE_PER_AGEND_EP12),'N')
into STRICT	ie_permite_ag_ep12_w
from	PARAMETRO_MEDICO
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;


select	coalesce(max(ie_integra_rel_dixtal),'N'),
	max(cd_tipo_agenda)
into STRICT	ie_gerar_integracao_w,
	cd_tipo_agenda_w
from	agenda
where	cd_agenda = NEW.cd_agenda;

ds_sep_bv_w := obter_separador_bv;

if (ie_gerar_integracao_w = 'S') then

	parametros := LT_PARAM_INTEGRACAO();

	if (OLD.dt_confirmacao is null) and (NEW.dt_confirmacao is not null) and (NEW.cd_pessoa_fisica is not null) then

		select	coalesce(max('S'),'N')
		into STRICT	ie_integrado_w
		from	pf_codigo_externo
		where	cd_pessoa_fisica = NEW.cd_pessoa_fisica
		and	ie_tipo_codigo_externo = 'DI';

		--ie_integrado_w := 'N';
		if (ie_integrado_w = 'N') then
			insert into	pf_codigo_externo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_tipo_codigo_externo,
				cd_pessoa_fisica,
				cd_pessoa_fisica_externo)
			values (
				nextval('pf_codigo_externo_seq'),
				LOCALTIMESTAMP,
				'Tasy',
				LOCALTIMESTAMP,
				'Tasy',
				'DI',
				NEW.cd_pessoa_fisica,
				'0');

			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w;

			param_element := T_PARAM_INTEGRACAO(25, ds_param_integ_hl7_w);
			parametros.extend(1);
			parametros(parametros.count) :=  param_element;
		end if;

		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
					'nr_sequencia=' || NEW.nr_sequencia || ds_sep_bv_w;

		param_element := T_PARAM_INTEGRACAO(190, ds_param_integ_hl7_w);
		parametros.extend(1);
		parametros(parametros.count) :=  param_element;

		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w;

		param_element := T_PARAM_INTEGRACAO(191, ds_param_integ_hl7_w);
		parametros.extend(1);
		parametros(parametros.count) :=  param_element;
		CALL gravar_agend_integracao_lista(parametros);

	elsif (NEW.dt_confirmacao is not null) then

		if (OLD.ie_status_agenda <>'C') and (NEW.ie_status_agenda = 'C') and (NEW.cd_pessoa_fisica is not null) then

			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
						'nr_sequencia=' || NEW.nr_sequencia || ds_sep_bv_w;
			CALL gravar_agend_integracao(192, ds_param_integ_hl7_w);
		end if;

		if (coalesce(OLD.cd_procedimento,0) <>coalesce(NEW.cd_procedimento,0)) or (coalesce(OLD.ie_origem_proced,0) <>coalesce(NEW.ie_origem_proced,0)) or (coalesce(OLD.nr_minuto_duracao,0) <>coalesce(NEW.nr_minuto_duracao,0)) or (coalesce(OLD.hr_inicio,LOCALTIMESTAMP) <>coalesce(NEW.hr_inicio,LOCALTIMESTAMP)) or (coalesce(OLD.nm_pessoa_contato,'X') <>coalesce(NEW.nm_pessoa_contato,'X')) or (coalesce(OLD.cd_medico,'X') <>coalesce(NEW.cd_medico,'X')) or (coalesce(OLD.cd_anestesista,'X') <>coalesce(NEW.cd_anestesista,'X')) or (coalesce(OLD.cd_agenda,0) <>coalesce(NEW.cd_agenda,'0')) or (coalesce(OLD.nm_usuario_orig,'X') <>coalesce(NEW.nm_usuario_orig,'X')) then

			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
						'nr_sequencia=' || NEW.nr_sequencia || ds_sep_bv_w;
			CALL gravar_agend_integracao(193, ds_param_integ_hl7_w);
		end if;

	end if;
end if;


if (cd_tipo_agenda_w = 2) and ((ie_permite_ag_ep12_w = 'S') or (wheb_usuario_pck.get_cd_estabelecimento = 11)) then



	if (verifica_proced_integracao(NEW.nr_seq_proc_interno,NEW.cd_procedimento,NEW.ie_origem_proced, 46) = 'S') then


		if (NEW.cd_pessoa_Fisica is not null) and (OLD.cd_pessoa_Fisica is null) then

			select	coalesce(max('S'),'N')
			into STRICT	ie_integrado_w
			from	pf_codigo_externo
			where	cd_pessoa_fisica = NEW.cd_pessoa_fisica
			and	ie_tipo_codigo_externo = 'DI';

			if (ie_integrado_w = 'N') then
				ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w;
				CALL gravar_agend_integracao(216, ds_param_integ_hl7_w);
			end if;

			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w;
			CALL gravar_agend_integracao(214, ds_param_integ_hl7_w);

			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
						'nr_sequencia=' || NEW.nr_sequencia || ds_sep_bv_w;

			CALL gravar_agend_integracao(219, ds_param_integ_hl7_w);
		elsif (NEW.ie_status_agenda in ('C', 'F', 'I', 'S')) then
			ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
						'nr_sequencia=' || NEW.nr_sequencia || ds_sep_bv_w;

			CALL gravar_agend_integracao(220, ds_param_integ_hl7_w);
		end if;

	end if;

end if;




if (cd_tipo_agenda_w = 2) and (OLD.dt_confirmacao is null) and (NEW.dt_confirmacao is not null) and (wheb_usuario_pck.is_evento_ativo(531) = 'S') then

	if (verifica_proced_integracao(NEW.nr_seq_proc_interno,NEW.cd_procedimento,NEW.ie_origem_proced, 91) = 'S') then

		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
								'nr_seq_agenda='   	|| NEW.nr_sequencia   || ds_sep_bv_w;

		CALL gravar_agend_integracao(531, ds_param_integ_hl7_w);

	end if;

end if;

--Cancelación de Exámenes
if (cd_tipo_agenda_w = 2) and (NEW.ie_status_agenda = 'C') and (wheb_usuario_pck.is_evento_ativo(531) = 'S') then

		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || OLD.cd_pessoa_fisica || ds_sep_bv_w ||
								'nr_seq_agenda='   	|| OLD.nr_sequencia   || ds_sep_bv_w;

		CALL gravar_agend_integracao(531, ds_param_integ_hl7_w);

end if;

--Cambio de Pacientes
if (cd_tipo_agenda_w = 2) and (NEW.cd_pessoa_fisica <>OLD.cd_pessoa_fisica) and (wheb_usuario_pck.is_evento_ativo(531) = 'S') then

		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || NEW.cd_pessoa_fisica || ds_sep_bv_w ||
								'nr_seq_agenda='   	|| OLD.nr_sequencia   || ds_sep_bv_w;

		CALL gravar_agend_integracao(531, ds_param_integ_hl7_w);

end if;

--Cambio de Procedimientos
if (cd_tipo_agenda_w = 2) and (NEW.nr_seq_proc_interno <>OLD.nr_seq_proc_interno) and (wheb_usuario_pck.is_evento_ativo(531) = 'S') then

		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || OLD.cd_pessoa_fisica || ds_sep_bv_w ||
								'nr_seq_agenda='   	|| OLD.nr_sequencia   || ds_sep_bv_w;

		CALL gravar_agend_integracao(531, ds_param_integ_hl7_w);

end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_agenda_paciente_update_hl7() FROM PUBLIC;

CREATE TRIGGER agenda_paciente_update_hl7
	AFTER UPDATE ON agenda_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_agenda_paciente_update_hl7();

