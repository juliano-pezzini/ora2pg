-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS lib_material_paciente_update ON lib_material_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_lib_material_paciente_update() RETURNS trigger AS $BODY$
declare
nr_sequencia_w	bigint;
 
BEGIN 
 
select	nextval('lib_material_paciente_hist_seq') 
into STRICT	nr_sequencia_w
;	
 
if (NEW.dt_suspenso is not null)	and (OLD.dt_suspenso is null)		then 
	insert into lib_material_paciente_hist( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		cd_pessoa_fisica, 
		cd_material, 
		dt_acao, 
		cd_pessoa_acao, 
		ie_tipo_acao, 
		qt_dias_tratamento, 
		dt_inicio_validade) 
	values ( 
		nr_sequencia_w, 
		LOCALTIMESTAMP, 
		NEW.nm_usuario, 
		NEW.cd_pessoa_fisica, 
		NEW.cd_material, 
		LOCALTIMESTAMP, 
		substr(obter_dados_usuario_opcao(NEW.nm_usuario,'C'),1,100), 
		'S', 
		NEW.qt_dias_tratamento, 
		NEW.dt_inicio_validade);
 
elsif (NEW.dt_suspenso is null)		and (OLD.dt_suspenso is not null)	then 
	insert into lib_material_paciente_hist( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		cd_pessoa_fisica, 
		cd_material, 
		dt_acao, 
		cd_pessoa_acao, 
		ie_tipo_acao, 
		qt_dias_tratamento, 
		dt_inicio_validade) 
	values ( 
		nr_sequencia_w, 
		LOCALTIMESTAMP, 
		NEW.nm_usuario, 
		NEW.cd_pessoa_fisica, 
		NEW.cd_material, 
		LOCALTIMESTAMP, 
		substr(obter_dados_usuario_opcao(NEW.nm_usuario,'C'),1,100), 
		'L', 
		NEW.qt_dias_tratamento, 
		NEW.dt_inicio_validade);
 
elsif (NEW.qt_dias_tratamento <> OLD.qt_dias_tratamento)	then 
	insert into lib_material_paciente_hist( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		cd_pessoa_fisica, 
		cd_material, 
		dt_acao, 
		cd_pessoa_acao, 
		ie_tipo_acao, 
		qt_dias_tratamento, 
		dt_inicio_validade) 
	values ( 
		nr_sequencia_w, 
		LOCALTIMESTAMP, 
		NEW.nm_usuario, 
		NEW.cd_pessoa_fisica, 
		NEW.cd_material, 
		LOCALTIMESTAMP, 
		substr(obter_dados_usuario_opcao(NEW.nm_usuario,'C'),1,100), 
		'A', 
		NEW.qt_dias_tratamento, 
		NEW.dt_inicio_validade);
end if;
 
if (NEW.dt_liberacao is not null) then 
	update	prescr_material 
	set	QT_TOTAL_DIAS_LIB 	= NEW.QT_DIAS_TRATAMENTO 
	where	nr_prescricao		= NEW.NR_PRESCRICAO 
	and	CD_MATERIAL		= NEW.CD_MATERIAL;
end if;
 
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_lib_material_paciente_update() FROM PUBLIC;

CREATE TRIGGER lib_material_paciente_update
	BEFORE UPDATE ON lib_material_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_lib_material_paciente_update();

