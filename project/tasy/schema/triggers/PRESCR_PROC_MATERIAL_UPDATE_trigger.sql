-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_proc_material_update ON prescr_proc_material CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_proc_material_update() RETURNS trigger AS $BODY$
declare
 
nr_seq_evento_w		bigint;
ds_atributo_alt_w	varchar(4000);
qt_volume_alt_w		varchar(255);
qt_tempo_alt_w		varchar(255);
qt_minuto_alt_w		varchar(255);
dt_coleta_alt_w		varchar(255);
ds_condicao_alt_w	varchar(255);
qt_tempo_gest_alt_w	varchar(255);
ds_minuto_alt_w		varchar(255);
ds_mensagem_w		varchar(4000);
ds_titulo_w			varchar(100);
 
c01 CURSOR FOR 
SELECT	a.nr_seq_evento 
from	regra_envio_sms a 
where	a.ie_evento_disp = 'ALTAMO' 
and	coalesce(a.ie_situacao,'A') = 'A';
 
BEGIN 
 
ds_atributo_alt_w := '';
 
CALL gravar_log_lab(97, NEW.qt_volume || ' - ' || OLD.qt_volume, NEW.nm_usuario, NEW.nr_prescricao);
 
if (NEW.qt_volume <> OLD.qt_volume) and (coalesce(OLD.qt_volume,0) <> 0) then 
	qt_volume_alt_w := wheb_mensagem_pck.get_texto(737000) || ' ' || wheb_mensagem_pck.get_texto(737007)||' '||OLD.qt_volume||' '||wheb_mensagem_pck.get_texto(737008)||' '||NEW.qt_volume;	
end if;
 
if (NEW.qt_tempo <> OLD.qt_tempo) and (coalesce(OLD.qt_tempo,0) <> 0) then 
	qt_tempo_alt_w := wheb_mensagem_pck.get_texto(737001) || ' ' || wheb_mensagem_pck.get_texto(737007)||' '||OLD.qt_tempo||' '||wheb_mensagem_pck.get_texto(737008)||' '||NEW.qt_tempo;
end if;
 
if (NEW.qt_minuto <> OLD.qt_minuto) and (coalesce(OLD.qt_minuto,0) <> 0) then 
	qt_minuto_alt_w := wheb_mensagem_pck.get_texto(737002) || ' ' || wheb_mensagem_pck.get_texto(737007)||' '||OLD.qt_minuto||' '||wheb_mensagem_pck.get_texto(737008)||' '||NEW.qt_minuto;
end if;
 
if (NEW.dt_coleta <> OLD.dt_coleta) then 
	dt_coleta_alt_w := wheb_mensagem_pck.get_texto(737003) || ' ' || wheb_mensagem_pck.get_texto(737007)||' '||OLD.dt_coleta||' '||wheb_mensagem_pck.get_texto(737008)||' '||NEW.dt_coleta;
end if;
 
if (NEW.ds_condicao <> OLD.ds_condicao) then 
	ds_condicao_alt_w := wheb_mensagem_pck.get_texto(737004) || ' ' || wheb_mensagem_pck.get_texto(737007)||' '||OLD.ds_condicao||' '||wheb_mensagem_pck.get_texto(737008)||' '||NEW.ds_condicao;
end if;
 
if (NEW.qt_tempo_gest <> OLD.qt_tempo_gest) and (coalesce(OLD.qt_tempo_gest,0) <> 0) then 
	qt_tempo_gest_alt_w := wheb_mensagem_pck.get_texto(737005) || ' ' || wheb_mensagem_pck.get_texto(737007)||' '||OLD.qt_tempo_gest||' '||wheb_mensagem_pck.get_texto(737008)||' '||NEW.qt_tempo_gest;
end if;
 
if (qt_volume_alt_w is not null 
		or qt_tempo_alt_w is not null 
		or qt_minuto_alt_w is not null 
		or dt_coleta_alt_w is not null 
		or ds_condicao_alt_w is not null 
		or qt_tempo_gest_alt_w is not null) then 
	 
	open c01;
		loop 
		fetch c01 into 
			nr_seq_evento_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		BEGIN 
			ds_atributo_alt_w := '';
 
			select	ds_titulo, 
					ds_mensagem 
			into STRICT	ds_titulo_w, 
					ds_mensagem_w 
			from	ev_evento 
			where	nr_sequencia = nr_seq_evento_w;
		 
			if ((ds_mensagem_w like '%@volume%' or ds_titulo_w like '%@volume%') 
					and qt_volume_alt_w is not null) then 
				ds_atributo_alt_w := ds_atributo_alt_w || ' @volume[' || qt_volume_alt_w || ']@';
			end if;
			 
			if ((ds_mensagem_w like '%@tempo%' or ds_titulo_w like '%@tempo%') 
					and qt_tempo_alt_w is not null) then 
				ds_atributo_alt_w := ds_atributo_alt_w || ' @tempo[' || qt_tempo_alt_w || ']@';
			end if;
			 
			if ((ds_mensagem_w like '%@minuto%' or ds_titulo_w like '%@minuto%') 
					and qt_minuto_alt_w is not null) then 
				ds_atributo_alt_w := ds_atributo_alt_w || ' @minuto[' || qt_minuto_alt_w || ']@';
			end if;
			 
			if ((ds_mensagem_w like '%@data_coleta_alt%' or ds_titulo_w like '%@data_coleta_alt%') 
					and dt_coleta_alt_w is not null) then 
				ds_atributo_alt_w := ds_atributo_alt_w || ' @data_coleta_alt[' || dt_coleta_alt_w || ']@';
			end if;
			 
			if ((ds_mensagem_w like '%@ds_condicao%' or ds_titulo_w like '%@ds_condicao%') 
					and ds_condicao_alt_w is not null) then 
				ds_atributo_alt_w := ds_atributo_alt_w || ' @ds_condicao[' || ds_condicao_alt_w || ']@';
			end if;
			 
			if ((ds_mensagem_w like '%@qt_tempo_gest%' or ds_titulo_w like '%@qt_tempo_gest%') 
					and qt_tempo_gest_alt_w is not null) then 
				ds_atributo_alt_w := ds_atributo_alt_w || ' @qt_tempo_gest[' || qt_tempo_gest_alt_w || ']@';
			end if;
 
			if (ds_atributo_alt_w is not null) then 
				CALL gravar_log_lab(99, ds_atributo_alt_w, NEW.nm_usuario, NEW.nr_prescricao);
				 
				CALL gerar_evento_alt_dado_amostra(nr_seq_evento_w, NEW.nm_usuario, NEW.nr_prescricao, NEW.nr_seq_material, NEW.dt_coleta, ds_atributo_alt_w, 'S');
			end if;
			 
 
 
 
 
		end;
		end loop;
	close c01;
end if;
	 
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_proc_material_update() FROM PUBLIC;

CREATE TRIGGER prescr_proc_material_update
	BEFORE UPDATE ON prescr_proc_material FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_proc_material_update();

