-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_apache_iv_atual ON escala_apache_iv CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_apache_iv_atual() RETURNS trigger AS $BODY$
declare
	qt_var_w							bigint;	
	qt_pt_temperatura_w					smallint;
	qt_pt_pressao_arterial_w			smallint;
	qt_pt_fc_w							smallint;
	qt_pt_freq_resp_w					smallint;
	qt_pt_po2_w							smallint;
	qt_pt_ph_w							smallint;
	qt_pt_na_w							smallint;
	qt_pt_creatinina_w					smallint;
	qt_pt_diurese_w						smallint;
	qt_pt_ureia_w						smallint;
	qt_pt_albumina_w					smallint;
	qt_pt_bilirrubina_w					smallint;
	qt_pt_glicose_w						smallint;
	qt_pt_glob_vermelhos_w				smallint;
	qt_pt_glob_brancos_w				smallint;
	qt_pt_glasgow_w						smallint := 0;
	qt_pt_idade_w						smallint;
	qt_pt_doencas_cronicas_w			smallint;
	qt_pt_idade1_w						bigint;
	qt_pt_idade2_w						bigint;
	qt_pt_idade3_w						bigint;
	qt_pt_idade4_w						bigint;
	qt_pt_idade5_w						bigint;
	qt_pt_aps1_w						bigint;
	qt_pt_aps2_w						bigint;
	qt_pt_aps3_w						bigint;
	qt_pt_aps4_w						bigint;
	qt_pt_aps5_w						bigint;
	qt_logit_w							bigint;
	qt_pt_diag_w					    bigint;
	qt_los_w							bigint := 0;
	qt_los1_w							bigint := 0;
	qt_los2_w							bigint := 0;
	qt_los3_w							bigint := 0;
	qt_los4_w							bigint := 0;
	qt_reg_w							smallint;

	EXEC_W                              varchar(500);
	qt_ph_w                             double precision   := null;
	qt_pco2_w                           double precision   := null;
	qt_pontos_aps_w                     integer      := null;
	qt_pontuacao_w                      integer      := null;
	qt_escala_glasgow_w                 smallint      := null;
	pr_mortalidade_w                    real;
	qt_dias_uti_w                       real;
	ds_erro_w   varchar(2000);
	ds_parametro_w  varchar(2000);
BEGIN
  BEGIN
	if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
		BEGIN  
		NEW.nr_hora	:= (to_char(round(NEW.DT_AVALIACAO,'hh24'),'hh24'))::numeric;
		end;
	end if;
	
	if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
		goto Final;
	end if;
	
	BEGIN
		exec_w := 'call obter_ph_eapache_iv_md(:1) into :result';
		
		EXECUTE exec_w using in NEW.qt_ph, out qt_ph_w;
	exception
		when others then
	     	qt_ph_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_ph: ' || NEW.qt_ph || ' - qt_ph_w: ' || qt_ph_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_ph_eapache_iv_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;
	
	if  qt_ph_w is not null then
	   NEW.qt_ph := qt_ph_w;
	end if;

	BEGIN
		exec_w := 'call obter_pco2_eapache_iv_md(:1) into :result';
		
		EXECUTE exec_w using in NEW.qt_pco2, out qt_pco2_w;
	exception
		when others then
		    qt_pco2_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_pco2: ' || NEW.qt_pco2 || ' - qt_pco2_w: ' || qt_pco2_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_pco2_eapache_iv_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;
	
	if  qt_pco2_w is not null then
	   NEW.qt_pco2 := qt_pco2_w;
	end if;

	BEGIN
		exec_w := 'call obter_score_temp_apach_md(:1, :2) into :result ';
		
		EXECUTE exec_w using in NEW.qt_temp, in NEW.qt_temp_max, out qt_pt_temperatura_w;
	exception
		when others then
		    qt_pt_temperatura_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_temp: ' || NEW.qt_temp || ' - :new.qt_temp_max: ' || NEW.qt_temp_max || ' - qt_pt_temperatura_w: ' || qt_pt_temperatura_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_score_temp_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		
		exec_w := 'call obter_scor_pres_art_apac_md(:1, :2, :3, :4) into :result';
		
		EXECUTE exec_w using in NEW.qt_pa_diast,
		                               in NEW.qt_pa_sist,
									   in NEW.qt_pa_diast_max,
									   in NEW.qt_pa_sist_max,
									   out qt_pt_pressao_arterial_w;
	exception
		when others then
		    qt_pt_pressao_arterial_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_pa_diast: ' || NEW.qt_pa_diast || ' - :new.qt_pa_sist: ' || NEW.qt_pa_sist || ' - :new.qt_pa_diast_max: ' || NEW.qt_pa_diast_max || ' - :new.qt_pa_sist_max: ' || NEW.qt_pa_sist_max || ' - qt_pt_pressao_arterial_w: ' || qt_pt_pressao_arterial_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_scor_pres_art_apac_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_scor_freq_car_apach_md(:1, :2) into :result';
		
		EXECUTE exec_w using in NEW.qt_fc, in NEW.qt_fc_max, out qt_pt_fc_w;
	exception
		when others then
			qt_pt_fc_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_fc: ' || NEW.qt_fc || ' - :new.qt_fc_max: ' || NEW.qt_fc_max || ' - qt_pt_fc_w: ' || qt_pt_fc_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_scor_freq_car_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_scor_freqresp_apach_md(:1, :2) into :result';
		
		EXECUTE exec_w using in NEW.qt_freq_resp, in NEW.qt_freq_resp_max, out qt_pt_freq_resp_w;
	exception
		when others then
		     qt_pt_freq_resp_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_freq_resp: ' || NEW.qt_freq_resp || ' - :new.qt_freq_resp_max: ' || NEW.qt_freq_resp_max || ' - qt_pt_freq_resp_w: ' || qt_pt_freq_resp_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_scor_freqresp_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_oxigenacao_eapache_iv_md(:1, :2, :3, :4, :5) into :result';
		
		EXECUTE exec_w using in NEW.qt_altitude,
		                               in NEW.qt_fio2,
									   in NEW.ie_ventilacao,
									   in NEW.qt_pco2,
									   in NEW.qt_po2,
									   out qt_pt_po2_w;
	exception
		when others then
		    qt_pt_po2_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_altitude: ' || NEW.qt_altitude || ' - :new.qt_fio2: ' || NEW.qt_fio2 || ' - :new.ie_ventilacao: ' || NEW.ie_ventilacao || ' - :new.qt_pco2: ' || NEW.qt_pco2 || ' - :new.qt_po2: ' || NEW.qt_po2 || ' - qt_pt_po2_w: ' || qt_pt_po2_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_oxigenacao_eapache_iv_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_score_ph_eapache_iv_md(:1, :2) into :result';
		
		EXECUTE exec_w using in NEW.qt_ph,
		                               in NEW.qt_pco2,
									   out qt_pt_ph_w;
	exception
		when others then
		    qt_pt_ph_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_ph: ' || NEW.qt_ph || ' - :new.qt_pco2: ' || NEW.qt_pco2 || ' - qt_pt_ph_w: ' || qt_pt_ph_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_score_ph_eapache_iv_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_scor_sodio_apach_md(:1, :2) into :result';
		
		EXECUTE exec_w using	in NEW.qt_na,
										in NEW.qt_na_max,
										out qt_pt_na_w;
	exception
		when others then
		    qt_pt_na_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_na: ' || NEW.qt_na || ' - :new.qt_na_max: ' || NEW.qt_na_max || ' - qt_pt_na_w: ' || qt_pt_na_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_scor_sodio_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_score_creat_apache_md(:1, :2, :3, :4) into :result';
		
		EXECUTE exec_w using 	in NEW.ie_renal,
										in NEW.qt_diurese,
										in NEW.qt_creatinina, 
										in NEW.qt_creatinina_max, 
									    out qt_pt_creatinina_w;
	exception
		when others then
			qt_pt_creatinina_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.ie_renal: ' || NEW.ie_renal || ' - :new.qt_diurese: ' || NEW.qt_diurese || ' - :new.qt_creatinina: ' || NEW.qt_creatinina || ' - :new.qt_creatinina_max: ' || NEW.qt_creatinina_max || ' - qt_pt_creatinina_w: ' || qt_pt_creatinina_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_score_creat_apache_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_score_diures_apache_md(:1) into :result';
		
		EXECUTE exec_w using	in NEW.qt_diurese,
										out qt_pt_diurese_w;
	exception
		when others then
		    qt_pt_diurese_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_diurese: ' || NEW.qt_diurese || ' - qt_pt_diurese_w: ' || qt_pt_diurese_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_score_diures_apache_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_scor_ureia_apach_md(:1, :2) into :result';
		
		EXECUTE exec_w using	in NEW.qt_ureia,
		                                in NEW.qt_ureia_max,
										out qt_pt_ureia_w;
	exception
		when others then
		    qt_pt_ureia_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_ureia: ' || NEW.qt_ureia || ' - :new.qt_ureia_max: ' || NEW.qt_ureia_max || ' - qt_pt_ureia_w: ' || qt_pt_ureia_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_score_diures_apache_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_score_albumina_apach_md(:1) into :result';
		
		EXECUTE exec_w using	in NEW.qt_albumina,
										out qt_pt_albumina_w;
	exception
		when others then
		    qt_pt_albumina_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_albumina: ' || NEW.qt_albumina || ' - qt_pt_albumina_w: ' || qt_pt_albumina_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_score_albumina_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_score_bilirru_apache_md(:1) into :result';
		
		EXECUTE exec_w using 	in NEW.qt_bilirrubina,
										out qt_pt_bilirrubina_w;
	
	exception
		when others then
		    qt_pt_bilirrubina_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_bilirrubina: ' || NEW.qt_bilirrubina || ' - qt_pt_bilirrubina_w: ' || qt_pt_bilirrubina_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_score_bilirru_apache_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_scor_glic_apach_md(:1, :2) into :result';
		
		EXECUTE exec_w using 	in NEW.qt_glicose,
		                                in NEW.qt_glicose_max,
										out qt_pt_glicose_w;
	exception
		when others then
		    qt_pt_glicose_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_glicose: ' || NEW.qt_glicose || ' - :new.qt_glicose_max: ' || NEW.qt_glicose_max || ' - qt_pt_glicose_w: ' || qt_pt_glicose_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_scor_glic_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_scor_globver_apach_md(:1, :2) into :result';
		
		EXECUTE exec_w using 	in NEW.qt_glob_vermelhos,
		                                in NEW.qt_glob_vermelhos_max,
										out qt_pt_glob_vermelhos_w;
	exception
		when others then
		    qt_pt_glob_vermelhos_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_glob_vermelhos: ' || NEW.qt_glob_vermelhos || ' - :new.qt_glob_vermelhos_max: ' || NEW.qt_glob_vermelhos_max || ' - qt_pt_glob_vermelhos_w: ' || qt_pt_glob_vermelhos_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_scor_globver_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_scor_globran_apach_md(:1, :2) into :result';
		
		EXECUTE exec_w using 	in NEW.qt_glob_brancos,
		                                in NEW.qt_glob_brancos_max,
										out qt_pt_glob_brancos_w;
	exception
		when others then
		    qt_pt_glob_brancos_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_glob_brancos: ' || NEW.qt_glob_brancos || ' - :new.qt_glob_brancos_max: ' || NEW.qt_glob_brancos_max || ' - qt_pt_glob_brancos_w: ' || qt_pt_glob_brancos_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_scor_globran_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_scor_glasg_apach_md(:1, :2, :3) into :result';
		
		EXECUTE exec_w using 	in NEW.ie_glasgow_ocular,
		                                in NEW.ie_glasgow_motora,
										in NEW.ie_glasgow_verbal,
										out qt_pt_glasgow_w;
	exception
		when others then
		    qt_pt_glasgow_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.ie_glasgow_ocular: ' || NEW.ie_glasgow_ocular || ' - :new.ie_glasgow_motora: ' || NEW.ie_glasgow_motora || ' - :new.ie_glasgow_verbal: ' || NEW.ie_glasgow_verbal || ' - qt_pt_glasgow_w: ' || qt_pt_glasgow_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_scor_glasg_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_score_idad_apach_md(:1) into :result';
		
		EXECUTE exec_w using 	in NEW.qt_idade,
										out qt_pt_idade_w;
	exception
		when others then
		    qt_pt_idade_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_idade: ' || NEW.qt_idade || ' - qt_pt_idade_w: ' || qt_pt_idade_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_score_idad_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_scor_doe_cro_apache_md(:1,:2,:3,:4,:5,:6,:7) into :result';
		
		EXECUTE exec_w using 	in NEW.ie_aids,
		                                in NEW.ie_hepatica,
		                                in NEW.ie_linfoma,
		                                in NEW.ie_cancer_metastatico,
		                                in NEW.ie_leuc_mileoma_mult,
		                                in NEW.ie_imunosupressao,
		                                in NEW.ie_cirrose,
										out qt_pt_doencas_cronicas_w;
	exception
		when others then
		    qt_pt_doencas_cronicas_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.ie_aids: ' || NEW.ie_aids || ' - :new.ie_hepatica: ' || NEW.ie_hepatica || ' - :new.ie_linfoma: ' || NEW.ie_linfoma || ' - :new.ie_cancer_metastatico: ' || NEW.ie_cancer_metastatico || ' - :new.ie_leuc_mileoma_mult: ' || NEW.ie_leuc_mileoma_mult;
			ds_parametro_w := ds_parametro_w || ' - :new.ie_imunosupressao: ' || NEW.ie_imunosupressao || ' - :new.ie_cirrose: ' || NEW.ie_cirrose || ' - qt_pt_doencas_cronicas_w: ' || qt_pt_doencas_cronicas_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_scor_doe_cro_apache_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	BEGIN
		exec_w := 'call obter_score_aps_eapache_iv_md(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10,:11,:12,:13,:14,:15,:16) into :result';
		
		EXECUTE exec_w using	in qt_pt_temperatura_w,
										in qt_pt_pressao_arterial_w,
										in qt_pt_fc_w,
										in qt_pt_freq_resp_w,
										in qt_pt_po2_w,
										in qt_pt_ph_w,
										in qt_pt_na_w,
										in qt_pt_creatinina_w,
										in qt_pt_glob_vermelhos_w,
										in qt_pt_glob_brancos_w,
										in qt_pt_glasgow_w,
										in qt_pt_diurese_w,
										in qt_pt_ureia_w,
										in qt_pt_bilirrubina_w,
										in qt_pt_albumina_w,
										in qt_pt_glicose_w,
										out qt_pontos_aps_w;
	exception
		when others then
		    qt_pontos_aps_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - qt_pt_temperatura_w: ' || qt_pt_temperatura_w || ' - qt_pt_pressao_arterial_w: ' || qt_pt_pressao_arterial_w || ' - qt_pt_fc_w: ' || qt_pt_fc_w || ' - qt_pt_freq_resp_w: ' || qt_pt_freq_resp_w || ' - qt_pt_po2_w: ' || qt_pt_po2_w;
			ds_parametro_w := ds_parametro_w || ' - qt_pt_ph_w: ' || qt_pt_ph_w || ' - qt_pt_na_w: ' || qt_pt_na_w || ' - qt_pt_creatinina_w: ' || qt_pt_creatinina_w || ' - qt_pt_glob_vermelhos_w: ' || qt_pt_glob_vermelhos_w || ' - qt_pt_glob_brancos_w: ' || qt_pt_glob_brancos_w;
			ds_parametro_w := ds_parametro_w || ' - qt_pt_glasgow_w: ' || qt_pt_glasgow_w || ' - qt_pt_diurese_w: ' || qt_pt_diurese_w || ' - qt_pt_ureia_w: ' || qt_pt_ureia_w || ' - qt_pt_bilirrubina_w: ' || qt_pt_bilirrubina_w || ' - qt_pt_albumina_w: ' || qt_pt_albumina_w;
			ds_parametro_w := ds_parametro_w || ' - qt_pt_glicose_w: ' || qt_pt_glicose_w || ' - qt_pontos_aps_w: ' || qt_pontos_aps_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_score_aps_eapache_iv_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	NEW.qt_pontos_aps	:=	qt_pontos_aps_w;

	BEGIN
		exec_w := 'call obter_score_apache_iv_md(:1,:2,:3) into :result';
		
		EXECUTE exec_w using	in NEW.qt_pontos_aps,
										in qt_pt_idade_w,
										in qt_pt_doencas_cronicas_w,
										out qt_pontuacao_w;
	exception
		when others then
			qt_pontuacao_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_pontos_aps: ' || NEW.qt_pontos_aps || ' - qt_pt_idade_w: ' || qt_pt_idade_w || ' - qt_pt_doencas_cronicas_w: ' || qt_pt_doencas_cronicas_w || ' - qt_pontuacao_w: ' || qt_pontuacao_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_score_apache_iv_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	NEW.qt_pontuacao	:=	qt_pontuacao_w;

	BEGIN
		exec_w := 'call obter_scor_es_glasg_apach_md(:1,:2,:3) into :result';
		
		EXECUTE exec_w using	in coalesce(NEW.ie_glasgow_ocular,0),
										in coalesce(NEW.ie_glasgow_verbal,0),
										in coalesce(NEW.ie_glasgow_motora,0),
										out qt_escala_glasgow_w;
	exception
		when others then
		    qt_escala_glasgow_w := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - nvl(:new.ie_glasgow_ocular,0): ' || coalesce(NEW.ie_glasgow_ocular,0) || ' - nvl(:new.ie_glasgow_verbal,0): ' || coalesce(NEW.ie_glasgow_verbal,0) || ' - nvl(:new.ie_glasgow_motora,0): ' || coalesce(NEW.ie_glasgow_motora,0) || ' - qt_escala_glasgow_w: ' || qt_escala_glasgow_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_scor_es_glasg_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	NEW.qt_escala_glasgow	:=	qt_escala_glasgow_w;

	qt_pt_idade1_w	:= 0;
	qt_pt_idade2_w	:= 0;
	qt_pt_idade3_w	:= 0;
	qt_pt_idade4_w	:= 0;
	qt_pt_idade5_w	:= 0;

	BEGIN
		exec_w := 'begin obter_scor_ida_deri_apach_md(:1, :2, :3, :4, :5, :6); end;';
		
		EXECUTE exec_w using in NEW.qt_idade,
									   out qt_pt_idade1_w,
									   out qt_pt_idade2_w,
									   out qt_pt_idade3_w,
									   out qt_pt_idade4_w,
									   out qt_pt_idade5_w;
	exception
		when others then
			qt_pt_idade1_w	:= null;
			qt_pt_idade2_w	:= null;
			qt_pt_idade3_w	:= null;
			qt_pt_idade4_w	:= null;
			qt_pt_idade5_w	:= null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_idade: ' || NEW.qt_idade || ' - qt_pt_idade1_w: ' || qt_pt_idade1_w || ' - qt_pt_idade2_w: ' || qt_pt_idade2_w || ' - qt_pt_idade3_w: ' || qt_pt_idade3_w;
			ds_parametro_w := ds_parametro_w || ' - qt_pt_idade4_w: ' || qt_pt_idade4_w || ' - qt_pt_idade5_w: ' || qt_pt_idade5_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_scor_ida_deri_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;
	
	qt_pt_aps1_w	:= 0;
	qt_pt_aps2_w	:= 0;
	qt_pt_aps3_w	:= 0;
	qt_pt_aps4_w	:= 0;
	qt_pt_aps5_w	:= 0;
	
	BEGIN
		exec_w := 'begin obter_score_aps2_eapache_iv_md(:1, :2, :3, :4, :5, :6); end;';
		
		EXECUTE exec_w using in NEW.qt_pontos_aps,
									   out qt_pt_aps1_w,
									   out qt_pt_aps2_w,
									   out qt_pt_aps3_w,
									   out qt_pt_aps4_w,
									   out qt_pt_aps5_w;
	exception
		when others then
			qt_pt_aps1_w	:= null;
			qt_pt_aps2_w	:= null;
			qt_pt_aps3_w	:= null;
			qt_pt_aps4_w	:= null;
			qt_pt_aps5_w	:= null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_pontos_aps: ' || NEW.qt_pontos_aps || ' - qt_pt_aps1_w: ' || qt_pt_aps1_w || ' - qt_pt_aps2_w: ' || qt_pt_aps2_w || ' - qt_pt_aps3_w: ' || qt_pt_aps3_w;
			ds_parametro_w := ds_parametro_w || ' - qt_pt_aps4_w: ' || qt_pt_aps4_w || ' - qt_pt_aps5_w: ' || qt_pt_aps5_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_score_aps2_eapache_iv_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	if (NEW.nr_seq_diag is not null) then
		qt_pt_diag_w := null;
		select	b.qt_pt_mortalidade
		into STRICT	qt_pt_diag_w
		from 	diag_doenca_apache_iv a,
				map_doenca_apache_iv b		 		 						
		where	a.nr_seq_mapeamento = b.nr_sequencia
		and		a.nr_sequencia = NEW.nr_seq_diag;
	end if;

	BEGIN
		exec_w := 'begin obter_perc_mort_log_apac_md(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10,
		                                             :11, :12, :13, :14, :15, :16, :17, :18, :19, :20,
													 :21, :22, :23, :24, :25, :26, :27, :28, :29, :30, :31); end;';
		
		EXECUTE exec_w using in NEW.qt_idade,
                                       in qt_pt_idade1_w,		
                                       in qt_pt_idade2_w,		
                                       in qt_pt_idade3_w,		
                                       in qt_pt_idade4_w,		
                                       in qt_pt_idade5_w,		
                                       in NEW.qt_pontos_aps,		
                                       in qt_pt_aps1_w,		
                                       in qt_pt_aps2_w,		
                                       in qt_pt_aps3_w,		
                                       in qt_pt_aps4_w,		
                                       in qt_pt_aps5_w,		
                                       in NEW.ie_ventilacao,		
                                       in NEW.qt_po2,		
                                       in NEW.qt_fio2,		
                                       in NEW.ie_origem_paciente,		
                                       in NEW.ie_emergencia,		
                                       in NEW.qt_dias_antes_uti,		
                                       in NEW.ie_aids,		
                                       in NEW.ie_hepatica,		
                                       in NEW.ie_linfoma,		
                                       in NEW.ie_cancer_metastatico,		
                                       in NEW.ie_leuc_mileoma_mult,		
                                       in NEW.ie_imunosupressao,		
                                       in NEW.ie_cirrose,		
                                       in NEW.ie_glasgow_indis,		
                                       in NEW.qt_escala_glasgow,		
                                       in qt_pt_diag_w,		
                                       in NEW.ie_terapia_trombo,		
									   out pr_mortalidade_w,
									   out qt_logit_w;
	exception
		when others then
			pr_mortalidade_w  := null;
			qt_logit_w	      := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_idade: ' || NEW.qt_idade || ' - qt_pt_idade1_w: ' || qt_pt_idade1_w || ' - qt_pt_idade2_w: ' || qt_pt_idade2_w || ' - qt_pt_idade3_w: ' || qt_pt_idade3_w;
			ds_parametro_w := ds_parametro_w || ' - qt_pt_idade4_w: ' || qt_pt_idade4_w || ' - qt_pt_idade5_w: ' || qt_pt_idade5_w || ' - :new.qt_pontos_aps: ' || NEW.qt_pontos_aps || ' - qt_pt_aps1_w: ' || qt_pt_aps1_w;
			ds_parametro_w := ds_parametro_w || ' - qt_pt_aps2_w: ' || qt_pt_aps2_w || ' - qt_pt_aps3_w: ' || qt_pt_aps3_w || ' - qt_pt_aps4_w: ' || qt_pt_aps4_w || ' - qt_pt_aps5_w: ' || qt_pt_aps5_w || ' - :new.ie_ventilacao: ' || NEW.ie_ventilacao;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_po2: ' || NEW.qt_po2 || ' - :new.qt_fio2: ' || NEW.qt_fio2 || ' - :new.ie_origem_paciente: ' || NEW.ie_origem_paciente || ' - :new.ie_emergencia: ' || NEW.ie_emergencia || ' - :new.qt_dias_antes_uti: ' || NEW.qt_dias_antes_uti;
			ds_parametro_w := ds_parametro_w || ' - :new.ie_aids: ' || NEW.ie_aids || ' - :new.ie_hepatica: ' || NEW.ie_hepatica || ' - :new.ie_linfoma: ' || NEW.ie_linfoma || ' - :new.ie_cancer_metastatico: ' || NEW.ie_cancer_metastatico || ' - :new.ie_leuc_mileoma_mult: ' || NEW.ie_leuc_mileoma_mult;
			ds_parametro_w := ds_parametro_w || ' - :new.ie_imunosupressao: ' || NEW.ie_imunosupressao || ' - :new.ie_cirrose: ' || NEW.ie_cirrose || ' - :new.ie_glasgow_indis: ' || NEW.ie_glasgow_indis || ' - :new.qt_escala_glasgow: ' || NEW.qt_escala_glasgow || ' - qt_pt_diag_w: ' || qt_pt_diag_w;
			ds_parametro_w := ds_parametro_w || ' - :new.ie_terapia_trombo: ' || NEW.ie_terapia_trombo || ' - pr_mortalidade_w: ' || pr_mortalidade_w || ' - qt_logit_w: ' || qt_logit_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_perc_mort_log_apac_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
	end;

	NEW.pr_mortalidade		:=	pr_mortalidade_w;
	NEW.qt_pontos_logit	:=	qt_logit_w;

	if (NEW.nr_seq_diag is not null) then
		qt_pt_diag_w := null;

		select	b.qt_pt_uti
		into STRICT	qt_pt_diag_w	
		from 	diag_doenca_apache_iv a,
				map_doenca_apache_iv b		 		 						
		where	a.nr_seq_mapeamento = b.nr_sequencia
		and		a.nr_sequencia = NEW.nr_seq_diag;
	end if;

	BEGIN
		exec_w := 'call obter_qt_dias_uti_apach_md(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10,
		                                           :11, :12, :13, :14, :15, :16, :17, :18, :19, :20,
												   :21, :22, :23, :24, :25, :26, :27, :28, :29, :30) into :result';
		
		EXECUTE exec_w using in NEW.qt_idade,
                                       in qt_pt_idade1_w,		
                                       in qt_pt_idade2_w,		
                                       in qt_pt_idade3_w,		
                                       in qt_pt_idade4_w,		
                                       in qt_pt_idade5_w,		
                                       in NEW.qt_pontos_aps,		
                                       in qt_pt_aps1_w,		
                                       in qt_pt_aps2_w,		
                                       in qt_pt_aps3_w,		
                                       in qt_pt_aps4_w,		
                                       in qt_pt_aps5_w,		
                                       in NEW.ie_ventilacao,		
                                       in NEW.qt_po2,		
                                       in NEW.qt_fio2,		
                                       in NEW.ie_origem_paciente,		
                                       in NEW.ie_emergencia,		
                                       in NEW.qt_dias_antes_uti,		
                                       in NEW.ie_aids,		
                                       in NEW.ie_hepatica,		
                                       in NEW.ie_linfoma,		
                                       in NEW.ie_cancer_metastatico,		
                                       in NEW.ie_leuc_mileoma_mult,		
                                       in NEW.ie_imunosupressao,		
                                       in NEW.ie_cirrose,		
                                       in NEW.ie_readmissao,		
                                       in qt_pt_diag_w,		
                                       in NEW.ie_terapia_trombo,		
                                       in NEW.ie_glasgow_indis,		
									   in NEW.qt_escala_glasgow,
									   out qt_dias_uti_w;
	exception
		when others then
			qt_dias_uti_w  := null;
			ds_erro_w := sqlerrm;
			ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_idade: ' || NEW.qt_idade || ' - qt_pt_idade1_w: ' || qt_pt_idade1_w || ' - qt_pt_idade2_w: ' || qt_pt_idade2_w || ' - qt_pt_idade3_w: ' || qt_pt_idade3_w;
			ds_parametro_w := ds_parametro_w || ' - qt_pt_idade4_w: ' || qt_pt_idade4_w || ' - qt_pt_idade5_w: ' || qt_pt_idade5_w || ' - :new.qt_pontos_aps: ' || NEW.qt_pontos_aps || ' - qt_pt_aps1_w: ' || qt_pt_aps1_w;
			ds_parametro_w := ds_parametro_w || ' - qt_pt_aps2_w: ' || qt_pt_aps2_w || ' - qt_pt_aps3_w: ' || qt_pt_aps3_w || ' - qt_pt_aps4_w: ' || qt_pt_aps4_w || ' - qt_pt_aps5_w: ' || qt_pt_aps5_w || ' - :new.ie_ventilacao: ' || NEW.ie_ventilacao;
			ds_parametro_w := ds_parametro_w || ' - :new.qt_po2: ' || NEW.qt_po2 || ' - :new.qt_fio2: ' || NEW.qt_fio2 || ' - :new.ie_origem_paciente: ' || NEW.ie_origem_paciente || ' - :new.ie_emergencia: ' || NEW.ie_emergencia || ' - :new.qt_dias_antes_uti: ' || NEW.qt_dias_antes_uti;
			ds_parametro_w := ds_parametro_w || ' - :new.ie_aids: ' || NEW.ie_aids || ' - :new.ie_hepatica: ' || NEW.ie_hepatica || ' - :new.ie_linfoma: ' || NEW.ie_linfoma || ' - :new.ie_cancer_metastatico: ' || NEW.ie_cancer_metastatico || ' - :new.ie_leuc_mileoma_mult: ' || NEW.ie_leuc_mileoma_mult;
			ds_parametro_w := ds_parametro_w || ' - :new.ie_imunosupressao: ' || NEW.ie_imunosupressao || ' - :new.ie_cirrose: ' || NEW.ie_cirrose || ' - :new.ie_readmissao: ' || NEW.ie_readmissao || ' - qt_pt_diag_w: ' || qt_pt_diag_w || ' - :new.ie_terapia_trombo: ' || NEW.ie_terapia_trombo || ' - :new.ie_glasgow_indis: ' || NEW.ie_glasgow_indis || ' - :new.qt_escala_glasgow: ' || NEW.qt_escala_glasgow;
			ds_parametro_w := ds_parametro_w || ' - qt_dias_uti_w: ' || qt_dias_uti_w;
			CALL gravar_log_medical_device('ESCALA_APACHE_IV_ATUAL', 'obter_qt_dias_uti_apach_md', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');

	end;

	NEW.qt_dias_uti	:=	qt_dias_uti_w;

	<<Final>>
	qt_reg_w	:= 0;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_apache_iv_atual() FROM PUBLIC;

CREATE TRIGGER escala_apache_iv_atual
	BEFORE INSERT OR UPDATE ON escala_apache_iv FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_apache_iv_atual();

