-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS paciente_tratamento_insert ON paciente_tratamento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_paciente_tratamento_insert() RETURNS trigger AS $BODY$
declare
cd_perfil_w		integer;
cd_funcao_w		integer;
cd_estabelecimento_w	integer;
cd_controle_w		smallint;
pragma autonomous_transaction;
BEGIN
  BEGIN

cd_funcao_w	:= obter_funcao_ativa;

if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then
	goto Final;
end if;

if (NEW.ie_tratamento in ('CAPD','CO','CPI','DPA','HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DPAV','DDC','IHF','IHDF')) or
	((cd_funcao_w = 7009) and (NEW.ie_tratamento in ('PT','TR','TX'))) then


	if (NEW.nr_seq_unid_dialise is null)	 then
		NEW.nr_seq_unid_dialise	:= HD_OBTER_UNIDADE_PRC(NEW.cd_pessoa_fisica,'C');
		commit;
	end if;
	/*
	update 	hd_pac_renal_cronico
	set	NR_SEQ_UNIDADE_ATUAL 	= :new.nr_seq_unid_dialise
	where	cd_pessoa_fisica	= :new.cd_pessoa_fisica;
	*/
 -- Retirado e colocdo para ser tratado no afterPost do DBPanel.
	cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
	
	BEGIN
	select	cd_perfil_inicio_trat
	into STRICT	cd_perfil_w
	from	hd_parametro
	where	cd_estabelecimento = cd_estabelecimento_w;
	exception
		when others then
		cd_perfil_w	:= 0;
	end;

	if (cd_perfil_w > 0) then

		if (NEW.cd_pessoa_fisica is not null) then
			insert into comunic_interna(
				dt_comunicado,
				ds_titulo,
				ds_comunicado,
				nm_usuario,
				dt_atualizacao,
				ie_geral,
				nm_usuario_destino,
				ds_perfil_adicional,
				nr_sequencia,
				ie_gerencial,
				dt_liberacao,
				cd_estab_destino
			) values (
				LOCALTIMESTAMP,
				wheb_mensagem_pck.get_texto(793678)||' ' || substr(obter_valor_dominio(2197,NEW.IE_TRATAMENTO),1,80),
				wheb_mensagem_pck.get_texto(793676)||' ' || NEW.cd_pessoa_fisica ||' - '|| obter_nome_pf(NEW.cd_pessoa_fisica) ||' '|| wheb_mensagem_pck.get_texto(793679) ||' '|| substr(obter_valor_dominio(2197,NEW.IE_TRATAMENTO),1,80) ||'.'||chr(10)||
				wheb_mensagem_pck.get_texto(793677)||' ' || SUBSTR(HD_OBTER_DESC_UNID_DIALISE(NEW.NR_SEQ_UNID_DIALISE),1,255)||'.',
				NEW.nm_usuario,
				LOCALTIMESTAMP,
				'N',
				'',
				cd_perfil_w||', ',
				nextval('comunic_interna_seq'),
				'N',
				LOCALTIMESTAMP,
				cd_estabelecimento_w);
			commit;	
		end if;
	end if;
end if;
	
	
if (NEW.nr_seq_receptor is not null) and (NEW.ie_tratamento in ('PT','TR','TX')) then
	
	cd_estabelecimento_w	:= tx_obter_estab_receptor(NEW.nr_seq_receptor);

	BEGIN
	select	cd_perfil_inicio_trat
	into STRICT	cd_perfil_w
	from	hd_parametro
	where	cd_estabelecimento = cd_estabelecimento_w;
	exception
		when others then
		cd_perfil_w	:= 0;
	end;
	if (cd_perfil_w > 0) then
		if (NEW.cd_pessoa_fisica is not null) then
			insert into comunic_interna(
				dt_comunicado,
				ds_titulo,
				ds_comunicado,
				nm_usuario,
				dt_atualizacao,
				ie_geral,
				nm_usuario_destino,
				ds_perfil_adicional,
				nr_sequencia,
				ie_gerencial,
				dt_liberacao,
				cd_estab_destino
			) values (
				LOCALTIMESTAMP,
				wheb_mensagem_pck.get_texto(793678)||' ' || substr(obter_valor_dominio(2197,NEW.IE_TRATAMENTO),1,80),
				wheb_mensagem_pck.get_texto(793676)||' ' || NEW.cd_pessoa_fisica ||' - '|| obter_nome_pf(NEW.cd_pessoa_fisica) ||' '|| wheb_mensagem_pck.get_texto(793679) ||' '|| substr(obter_valor_dominio(2197,NEW.IE_TRATAMENTO),1,80) || '.',
				NEW.nm_usuario,
				LOCALTIMESTAMP,
				'N',
				'',
				cd_perfil_w||', ',
				nextval('comunic_interna_seq'),
				'N',
				LOCALTIMESTAMP,
				cd_estabelecimento_w);
			commit;	
		end if;
	end if;
end if;	

<<Final>>
cd_controle_w := 0;
commit;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_paciente_tratamento_insert() FROM PUBLIC;

CREATE TRIGGER paciente_tratamento_insert
	BEFORE INSERT ON paciente_tratamento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_paciente_tratamento_insert();

