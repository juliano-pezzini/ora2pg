-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS san_doacao_atual ON san_doacao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_san_doacao_atual() RETURNS trigger AS $BODY$
declare

nr_seq_derivado_padrao_w	bigint;
nr_seq_tipo_bolsa_w			varchar(2);
nr_valor_parametro_w		varchar(2);

BEGIN

nr_valor_parametro_w := Obter_Valor_Param_Usuario(450,362, obter_perfil_ativo, NEW.nm_usuario,obter_estabelecimento_ativo);

if (TG_OP = 'UPDATE') and (NEW.ie_tipo_coleta is not null) then

	select	max(nr_seq_derivado)
	into STRICT	nr_seq_derivado_padrao_w
	from	san_regra_coleta_derivado
	where	ie_tipo_coleta = NEW.ie_tipo_coleta
	and	coalesce(ie_situacao,'A') = 'A';

	NEW.nr_seq_derivado_padrao := nr_seq_derivado_padrao_w;

end if;

if (nr_valor_parametro_w is null) and
	(NEW.dt_fim_coleta is null AND OLD.dt_fim_coleta is null) then

	select 	max(ie_tipo_bolsa)
	into STRICT	nr_seq_tipo_bolsa_w
	from 	san_regra_tipo_bolsa
	where 	nr_seq_tipo_doacao = NEW.nr_seq_tipo
	and   	ie_tipo_coleta = NEW.ie_tipo_coleta
	and   	ie_situacao = 'A';

	if (nr_seq_tipo_bolsa_w is not null) then

		NEW.ie_tipo_bolsa := nr_seq_tipo_bolsa_w;

	end if;

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_san_doacao_atual() FROM PUBLIC;

CREATE TRIGGER san_doacao_atual
	BEFORE INSERT OR UPDATE ON san_doacao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_san_doacao_atual();

