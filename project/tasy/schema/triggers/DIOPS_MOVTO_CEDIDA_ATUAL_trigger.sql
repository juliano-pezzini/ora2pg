-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS diops_movto_cedida_atual ON diops_movto_corresp_cedida CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_diops_movto_cedida_atual() RETURNS trigger AS $BODY$
declare

dt_mes_competencia_w	timestamp;
nr_campo_alteracao_w	smallint	:= null;
vl_evento_w		double precision 	:= 0;
nm_usuario_w		varchar(255);

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
	if (OLD.vl_mes_n	<> NEW.vl_mes_n) then
		vl_evento_w		:= NEW.vl_mes_n;
		nr_campo_alteracao_w	:= 0;
	elsif (OLD.vl_mes_n1	<> NEW.vl_mes_n1) then
		vl_evento_w		:= NEW.vl_mes_n1;
		nr_campo_alteracao_w	:= -1;
	elsif (OLD.vl_mes_n2	<> NEW.vl_mes_n2) then
		vl_evento_w		:= NEW.vl_mes_n2;
		nr_campo_alteracao_w	:= -2;
	end if;

	if (nr_campo_alteracao_w is not null) then
		select	add_months(trunc(a.dt_periodo_final,'month'),nr_campo_alteracao_w)
		into STRICT	dt_mes_competencia_w
		from	diops_periodo	a
		where	a.nr_sequencia	= NEW.nr_seq_periodo;

		nm_usuario_w	:= wheb_usuario_pck.get_nm_usuario;

		update 	w_diops_movto_pel
		set	vl_evento 				= vl_evento_w,
			dt_atualizacao 				= LOCALTIMESTAMP,
			nm_usuario 				= nm_usuario_w
		where	nr_seq_periodo 				= NEW.nr_seq_periodo
		and	nr_seq_tipo_movto			= NEW.nr_seq_tipo_movto
		and	trunc(dt_mes_competencia, 'month')	= dt_mes_competencia_w
		and	ie_tipo_segurado			= 'R';

		NEW.nm_usuario		:= nm_usuario_w;
		NEW.dt_atualizacao	:= LOCALTIMESTAMP;
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_diops_movto_cedida_atual() FROM PUBLIC;

CREATE TRIGGER diops_movto_cedida_atual
	BEFORE UPDATE ON diops_movto_corresp_cedida FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_diops_movto_cedida_atual();

