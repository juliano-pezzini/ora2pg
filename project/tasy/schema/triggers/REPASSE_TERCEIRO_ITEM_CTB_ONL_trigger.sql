-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS repasse_terceiro_item_ctb_onl ON repasse_terceiro_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_repasse_terceiro_item_ctb_onl() RETURNS trigger AS $BODY$
declare
   -- local variables here
   cd_estabelecimento_w    ctb_documento.cd_estabelecimento%type;
   dt_competencia_w        ctb_documento.dt_competencia%type;
   cd_tipo_lote_contabil_w ctb_documento.cd_tipo_lote_contabil%type;
   nr_seq_trans_financ_w   ctb_documento.nr_seq_trans_financ%type;
   nr_seq_info_w           ctb_documento.nr_seq_info%type;
   nr_documento_w          ctb_documento.nr_documento%type;
   nr_seq_doc_compl_w      ctb_documento.nr_seq_doc_compl%type;
   nr_doc_analitico_w      ctb_documento.nr_doc_analitico%type;
   vl_movimento_w          ctb_documento.vl_movimento%type;
   nm_tabela_w             ctb_documento.nm_tabela%type;
   nm_atributo_w           ctb_documento.nm_atributo%type;
   ie_situacao_ctb_w       ctb_documento.ie_situacao_ctb%type;
   ds_origem_w             ctb_documento.ds_origem%type;
   nr_sequencia_doc_w      ctb_documento.nr_sequencia%type;

BEGIN

   --- Define estabelecimnto
   select max(t.cd_estabelecimento)
     into STRICT cd_estabelecimento_w
     from terceiro t
    where t.nr_sequencia = NEW.nr_seq_terceiro;

   cd_estabelecimento_w    := cd_estabelecimento_w;
   dt_competencia_w        := coalesce(NEW.dt_contabil, NEW.dt_lancamento);
   cd_tipo_lote_contabil_w := 14;
   nr_seq_trans_financ_w   := NEW.nr_seq_trans_fin_prov;
   nr_seq_info_w           := 69;
   nr_documento_w          := NEW.nr_sequencia;
   nr_seq_doc_compl_w      := NEW.nr_seq_terceiro;
   nr_doc_analitico_w      := null;
   nm_tabela_w             := 'REPASSE_TERCEIRO_ITEM';

   if (TG_OP = 'INSERT') then
      if (NEW.nr_seq_terceiro is not null) and (NEW.dt_lancamento is not null) and (NEW.nr_seq_trans_fin_prov is not null) then

         if (coalesce(NEW.vl_repasse,0) <> 0) then
            vl_movimento_w := NEW.vl_repasse;
            nm_atributo_w  := 'VL_REPASSE';

            CALL ctb_concil_financeira_pck.ctb_gravar_documento(cd_estabelecimento_p    => cd_estabelecimento_w,
                                                           dt_competencia_p        => dt_competencia_w,
                                                           cd_tipo_lote_contabil_p => cd_tipo_lote_contabil_w,
                                                           nr_seq_trans_financ_p   => nr_seq_trans_financ_w,
                                                           nr_seq_info_p           => nr_seq_info_w,
                                                           nr_documento_p          => nr_documento_w,
                                                           nr_seq_doc_compl_p      => nr_seq_doc_compl_w,
                                                           nr_doc_analitico_p      => nr_doc_analitico_w,
                                                           vl_movimento_p          => vl_movimento_w,
                                                           nm_tabela_p             => nm_tabela_w,
                                                           nm_atributo_p           => nm_atributo_w,
                                                           nm_usuario_p            => NEW.nm_usuario);
         end if;

         if (coalesce(NEW.vl_dia_antecipacao,0) <> 0) then
            vl_movimento_w := NEW.vl_dia_antecipacao;
            nm_atributo_w  := 'VL_DIA_ANTECIPACAO';

            CALL ctb_concil_financeira_pck.ctb_gravar_documento(cd_estabelecimento_p    => cd_estabelecimento_w,
                                                           dt_competencia_p        => dt_competencia_w,
                                                           cd_tipo_lote_contabil_p => cd_tipo_lote_contabil_w,
                                                           nr_seq_trans_financ_p   => nr_seq_trans_financ_w,
                                                           nr_seq_info_p           => nr_seq_info_w,
                                                           nr_documento_p          => nr_documento_w,
                                                           nr_seq_doc_compl_p      => nr_seq_doc_compl_w,
                                                           nr_doc_analitico_p      => nr_doc_analitico_w,
                                                           vl_movimento_p          => vl_movimento_w,
                                                           nm_tabela_p             => nm_tabela_w,
                                                           nm_atributo_p           => nm_atributo_w,
                                                           nm_usuario_p            => NEW.nm_usuario);
         end if;
      end if;
   elsif (TG_OP = 'UPDATE') then
      if (coalesce(NEW.vl_repasse,0) <> 0) then
         vl_movimento_w := coalesce(NEW.vl_repasse, OLD.vl_repasse);
         nm_atributo_w  := 'VL_REPASSE';

         update ctb_documento a
            set a.dt_competencia      = dt_competencia_w,
                a.vl_movimento        = vl_movimento_w,
                a.nr_seq_trans_financ = nr_seq_trans_financ_w
          where a.nr_documento = nr_documento_w
            and a.nr_seq_doc_compl = nr_seq_doc_compl_w
            and a.cd_tipo_lote_contabil = 14
            and a.nr_seq_info = 69
            and a.nm_atributo = nm_atributo_w
         returning a.nr_sequencia into nr_sequencia_doc_w;

         if (nr_sequencia_doc_w is null) then
            CALL ctb_concil_financeira_pck.ctb_gravar_documento(cd_estabelecimento_p    => cd_estabelecimento_w,
                                                           dt_competencia_p        => dt_competencia_w,
                                                           cd_tipo_lote_contabil_p => cd_tipo_lote_contabil_w,
                                                           nr_seq_trans_financ_p   => nr_seq_trans_financ_w,
                                                           nr_seq_info_p           => nr_seq_info_w,
                                                           nr_documento_p          => nr_documento_w,
                                                           nr_seq_doc_compl_p      => nr_seq_doc_compl_w,
                                                           nr_doc_analitico_p      => nr_doc_analitico_w,
                                                           vl_movimento_p          => vl_movimento_w,
                                                           nm_tabela_p             => nm_tabela_w,
                                                           nm_atributo_p           => nm_atributo_w,
                                                           nm_usuario_p            => NEW.nm_usuario);
         end if;
      end if;

      if (coalesce(NEW.vl_dia_antecipacao,0) <> 0) then
         vl_movimento_w := coalesce(NEW.vl_dia_antecipacao,
                               OLD.vl_dia_antecipacao);
         nm_atributo_w  := 'VL_DIA_ANTECIPACAO';

         update ctb_documento a
            set a.dt_competencia      = dt_competencia_w,
                a.vl_movimento        = vl_movimento_w,
                a.nr_seq_trans_financ = nr_seq_trans_financ_w
          where a.nr_documento = nr_documento_w
            and a.nr_seq_doc_compl = nr_seq_doc_compl_w
            and a.cd_tipo_lote_contabil = 14
            and a.nr_seq_info = 69
            and a.nm_atributo = nm_atributo_w
         returning a.nr_sequencia into nr_sequencia_doc_w;

         if (nr_sequencia_doc_w is null) then
            CALL ctb_concil_financeira_pck.ctb_gravar_documento(cd_estabelecimento_p    => cd_estabelecimento_w,
                                                           dt_competencia_p        => dt_competencia_w,
                                                           cd_tipo_lote_contabil_p => cd_tipo_lote_contabil_w,
                                                           nr_seq_trans_financ_p   => nr_seq_trans_financ_w,
                                                           nr_seq_info_p           => nr_seq_info_w,
                                                           nr_documento_p          => nr_documento_w,
                                                           nr_seq_doc_compl_p      => nr_seq_doc_compl_w,
                                                           nr_doc_analitico_p      => nr_doc_analitico_w,
                                                           vl_movimento_p          => vl_movimento_w,
                                                           nm_tabela_p             => nm_tabela_w,
                                                           nm_atributo_p           => nm_atributo_w,
                                                           nm_usuario_p            => NEW.nm_usuario);
         end if;
      end if;
   end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_repasse_terceiro_item_ctb_onl() FROM PUBLIC;

CREATE TRIGGER repasse_terceiro_item_ctb_onl
	AFTER INSERT OR UPDATE ON repasse_terceiro_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_repasse_terceiro_item_ctb_onl();

