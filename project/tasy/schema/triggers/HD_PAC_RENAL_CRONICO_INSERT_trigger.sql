-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS hd_pac_renal_cronico_insert ON hd_pac_renal_cronico CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_hd_pac_renal_cronico_insert() RETURNS trigger AS $BODY$
declare
 
cd_perfil_w			integer;
ie_insere_tratamento_w		varchar(1);
ie_pac_agudo_w			varchar(1);
ie_nova_forma_w			varchar(1);
nr_seq_protocolo_w		bigint;
ie_tipo_paciente_w		varchar(1);
BEGIN
  BEGIN 
ie_insere_tratamento_w := Obter_Valor_Param_Usuario(7009, 126, obter_perfil_ativo, NEW.nm_usuario, NEW.cd_estabelecimento);
ie_pac_agudo_w := obter_valor_param_usuario(7009, 141, Obter_Perfil_Ativo, NEW.nm_usuario, NEW.cd_estabelecimento);
NEW.ie_situacao := 'S';
 
NEW.nr_seq_unidade_atual := NEW.NR_SEQ_UNID_DIALISE;
 
if (ie_insere_tratamento_w = 'S') then 
 
	insert into paciente_tratamento( 
		nr_sequencia, 
		cd_pessoa_fisica, 
		ie_tratamento, 
		dt_inicio_tratamento, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_unid_dialise, 
		ie_paciente_agudo 
	) values ( 
		nextval('paciente_tratamento_seq'), 
		NEW.cd_pessoa_fisica, 
		'HD', 
		LOCALTIMESTAMP, 
		LOCALTIMESTAMP, 
		NEW.nm_usuario, 
		LOCALTIMESTAMP, 
		NEW.nm_usuario, 
		NEW.NR_SEQ_UNID_DIALISE, 
		CASE WHEN ie_pac_agudo_w='S' THEN 'S'  ELSE NEW.ie_paciente_agudo END  
	);
	 
	 
	 
	select	max(ie_nova_forma_dialise) 
	into STRICT	ie_nova_forma_w 
	from	hd_parametro 
	where	cd_estabelecimento = NEW.cd_estabelecimento;
 
	if (ie_nova_forma_w = 'S') then		 
 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_protocolo_w 
		from	hd_prot_exame_padrao 
		where	ie_tratamento = 'HD' 
		and (cd_estabelecimento = NEW.cd_estabelecimento or cd_estabelecimento is null) 
		and (cd_convenio = NEW.cd_convenio or cd_convenio is null) 
		and		ie_situacao = 'A' 
		and		((coalesce(ie_tipo_paciente,'A') = CASE WHEN ie_pac_agudo_w='S' THEN 'S'  ELSE NEW.ie_paciente_agudo END ) or (coalesce(ie_tipo_paciente,'A') = 'A'));
		 
		if (nr_seq_protocolo_w is not null) then 
			insert into hd_protocolo_exame(nr_sequencia, 
							dt_atualizacao, 
							nm_usuario, 
							dt_atualizacao_nrec, 
							nm_usuario_nrec, 
							nr_seq_protocolo, 
							ie_tratamento, 
							cd_pessoa_fisica, 
							ie_manual) 
						values (	nextval('hd_protocolo_exame_seq'), 
							LOCALTIMESTAMP, 
							NEW.nm_usuario, 
							LOCALTIMESTAMP, 
							NEW.nm_usuario, 
							nr_seq_protocolo_w, 
							'HD', 
							NEW.cd_pessoa_fisica, 
							'N');
		end if;
	end if;	
end if;
 
BEGIN 
select	cd_perfil_paciente 
into STRICT	cd_perfil_w 
from	hd_parametro 
where	cd_estabelecimento = NEW.cd_estabelecimento;
exception 
	when others then 
	cd_perfil_w	:= 0;
end;
 
if (cd_perfil_w > 0) then 
 
	if (NEW.cd_pessoa_fisica is not null) then 
		insert into comunic_interna( 
			dt_comunicado, 
			ds_titulo, 
			ds_comunicado, 
			nm_usuario, 
			dt_atualizacao, 
			ie_geral, 
			nm_usuario_destino, 
			ds_perfil_adicional, 
			nr_sequencia, 
			ie_gerencial, 
			dt_liberacao, 
			cd_estab_destino 
		) values ( 
			LOCALTIMESTAMP, 
			wheb_mensagem_pck.get_texto(802538) || ' ' || substr(obter_valor_dominio(2197,'HD'),1,80), 
			wheb_mensagem_pck.get_texto(791350) || ' ' || NEW.cd_pessoa_fisica ||' - '|| obter_nome_pf(NEW.cd_pessoa_fisica) || ' ' || wheb_mensagem_pck.get_texto(802539) || ' ' || substr(obter_valor_dominio(2197,'HD'),1,80) || '.' || chr(10) || 
				wheb_mensagem_pck.get_texto(795798) || ': ' || SUBSTR(HD_OBTER_DESC_UNID_DIALISE(NEW.NR_SEQ_UNID_DIALISE),1,90), 
			NEW.nm_usuario, 
			LOCALTIMESTAMP, 
			'N', 
			'', 
			cd_perfil_w||', ', 
			nextval('comunic_interna_seq'), 
			'N', 
			LOCALTIMESTAMP, 
			NEW.cd_estabelecimento 
		);
	end if;
end if;
	 
 
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_hd_pac_renal_cronico_insert() FROM PUBLIC;

CREATE TRIGGER hd_pac_renal_cronico_insert
	BEFORE INSERT ON hd_pac_renal_cronico FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_hd_pac_renal_cronico_insert();

