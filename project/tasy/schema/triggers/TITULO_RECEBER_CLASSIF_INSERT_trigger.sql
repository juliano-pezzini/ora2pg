-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_receber_classif_insert ON titulo_receber_classif CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_receber_classif_insert() RETURNS trigger AS $BODY$
declare

cd_estabelecimento_w            ctb_documento.cd_estabelecimento%type;
nr_seq_trans_financ_w           ctb_documento.nr_seq_trans_financ%type;
dt_movimento_w                  ctb_documento.dt_competencia%type;
ie_contab_classif_tit_rec_w     parametro_contas_receber.ie_contab_classif_tit_rec%type;
nr_seq_proj_rec_w               ctb_documento.nr_seq_proj_rec%type;

c01 CURSOR FOR
        SELECT  a.nm_atributo,
                a.cd_tipo_lote_contab
        from    atributo_contab a
        where   a.cd_tipo_lote_contab = 5
        and     a.nm_atributo in ('VL_TITULO_RECEBER');

c01_w           c01%rowtype;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
select  cd_estabelecimento,
        nr_seq_trans_fin_contab,
        dt_contabil,
        nr_seq_proj_rec
into STRICT    cd_estabelecimento_w,
        nr_seq_trans_financ_w,
        dt_movimento_w,
        nr_seq_proj_rec_w
from    titulo_receber
where   nr_titulo = NEW.nr_titulo;


BEGIN
select  coalesce(ie_contab_classif_tit_rec, 'N')
into STRICT    ie_contab_classif_tit_rec_w
from    parametro_contas_receber
where   cd_estabelecimento = cd_estabelecimento_w;
exception when others then
        ie_contab_classif_tit_rec_w := 'N';
end;

BEGIN
select  CASE WHEN a.ie_ctb_online='S' THEN  coalesce(a.ie_contab_classif_tit_rec, 'N')  ELSE ie_contab_classif_tit_rec_w END
into STRICT    ie_contab_classif_tit_rec_w
from    ctb_param_lote_contas_rec a
where   a.cd_empresa = obter_empresa_estab(cd_estabelecimento_w)
and     coalesce(a.cd_estab_exclusivo, cd_estabelecimento_w) = cd_estabelecimento_w;
exception when others then
        null;
end;

open c01;
loop
fetch c01 into
        c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
        BEGIN

        if (coalesce(NEW.vl_classificacao, 0) <> 0 and ie_contab_classif_tit_rec_w = 'S') then
                BEGIN
                
                CALL ctb_concil_financeira_pck.ctb_gravar_documento(       cd_estabelecimento_w,
                                                                        trunc(dt_movimento_w),
                                                                        c01_w.cd_tipo_lote_contab,
                                                                        nr_seq_trans_financ_w,
                                                                        3,
                                                                        NEW.nr_titulo,
                                                                        NEW.nr_sequencia,
                                                                        0,
                                                                        NEW.vl_classificacao,
                                                                        'TITULO_RECEBER_CLASSIF',
                                                                        c01_w.nm_atributo,
                                                                        NEW.nm_usuario,
                                                                        'P',
                                                                        null,
                                                                        nr_seq_proj_rec_w);

                end;
        end if;

        end;
end loop;
close c01;
end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_receber_classif_insert() FROM PUBLIC;

CREATE TRIGGER titulo_receber_classif_insert
	AFTER INSERT ON titulo_receber_classif FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_receber_classif_insert();

