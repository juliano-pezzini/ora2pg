-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS nascimento_afterpost ON nascimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_nascimento_afterpost() RETURNS trigger AS $BODY$
declare

cd_pessoa_rn_w		varchar(10);
ie_operacao_w		varchar(1)	:=	'X';
reg_integracao_w		gerar_int_padrao.reg_integracao;
nr_seq_episodio_w		atendimento_paciente.nr_seq_episodio%type;
cd_pessoa_fisica_w	atendimento_paciente.cd_pessoa_fisica%type;

BEGIN
if (NEW.nr_atend_rn is not null) then
	CALL gerar_igc_rn(NEW.nr_atend_rn,NEW.nm_usuario);
end if;

if (coalesce(NEW.ie_sexo,'0') <> coalesce(OLD.ie_sexo,'0')) then
	BEGIN
	if (NEW.cd_pessoa_rn is not null) then
		cd_pessoa_rn_w	:=	NEW.cd_pessoa_rn;	
	elsif (NEW.nr_atend_rn is not null) then
		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_rn_w
		from	atendimento_paciente
		where	nr_atendimento = NEW.nr_atend_rn;		
	end if;
	
	if (cd_pessoa_rn_w is not null) then
		update	pessoa_fisica
		set	ie_sexo = NEW.ie_sexo
		where	cd_pessoa_fisica = cd_pessoa_rn_w;
	end if;
	end;
end if;

if (TG_OP = 'INSERT') and (NEW.dt_liberacao is not null) and (NEW.dt_inativacao is null) then
	ie_operacao_w	:=	'I';
elsif (TG_OP = 'UPDATE') and (NEW.dt_liberacao is not null) and (OLD.dt_liberacao is null) then
	ie_operacao_w	:=	'I';
elsif (TG_OP = 'UPDATE') and (NEW.dt_inativacao is not null) and (OLD.dt_inativacao is null) then
	ie_operacao_w	:=	'E';
elsif (TG_OP = 'UPDATE') and (NEW.dt_liberacao is not null) and (NEW.dt_inativacao is null) then
	ie_operacao_w	:=	'A';
end if;

if (ie_operacao_w <> 'X') then
	BEGIN
	select	max(cd_pessoa_fisica)		
	into STRICT	cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento	 = NEW.nr_atendimento;
	
	reg_integracao_w.ie_operacao	:=	ie_operacao_w;
	reg_integracao_w.cd_pessoa_fisica	:=	cd_pessoa_fisica_w;
	reg_integracao_w.nr_atendimento	:=	NEW.nr_atendimento;
	
	reg_integracao_w := gerar_int_padrao.gravar_integracao('190', NEW.nr_atendimento || 'Â¬' || NEW.nr_sequencia, coalesce(obter_usuario_ativo,NEW.nm_usuario), reg_integracao_w);
	end;
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_nascimento_afterpost() FROM PUBLIC;

CREATE TRIGGER nascimento_afterpost
	AFTER INSERT OR UPDATE ON nascimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_nascimento_afterpost();

