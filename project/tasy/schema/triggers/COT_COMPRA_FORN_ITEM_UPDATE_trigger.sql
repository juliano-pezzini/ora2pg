-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cot_compra_forn_item_update ON cot_compra_forn_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cot_compra_forn_item_update() RETURNS trigger AS $BODY$
DECLARE

ie_situacao_w				varchar(1);
ds_historico_w				varchar(255);

BEGIN

if (NEW.vl_unitario_material <> OLD.vl_unitario_material) then
	select	coalesce(ie_situacao,'A')
	into STRICT	ie_situacao_w
	from	cot_compra_item
	where	nr_cot_compra = NEW.nr_cot_compra
	and	nr_item_cot_compra = NEW.nr_item_cot_compra;

	ds_historico_w	:= 	WHEB_MENSAGEM_PCK.get_texto(298865,'NR_ITEM_COT_COMPRA_W='||NEW.nr_item_cot_compra||
							';NR_SEQUENCIA_W='||NEW.nr_sequencia||
							';NR_SEQ_COT_FORN_W='||NEW.nr_seq_cot_forn||
							';VL_OLD_UNIT_MAT_W='||campo_mascara(OLD.vl_unitario_material,4)||
							';VL_NEW_UNIT_MAT_W='||campo_mascara(NEW.vl_unitario_material,4));

	CALL gerar_hist_cotacao_sem_commit(NEW.nr_cot_compra, WHEB_MENSAGEM_PCK.get_texto(298885), ds_historico_w, 'S', NEW.nm_usuario);


	if (ie_situacao_w = 'I') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265963);
		--'Este item está inativo na pasta Itens cotação, portanto não pode ser alterado.'
	end if;
end if;

if (NEW.qt_material <> OLD.qt_material) then

	ds_historico_w	:= 	WHEB_MENSAGEM_PCK.get_texto(298887,'NR_ITEM_COT_COMPRA_W='||NEW.nr_item_cot_compra||
							';NR_SEQUENCIA_W='||NEW.nr_sequencia||
							';NR_SEQ_COT_FORN_W='||NEW.nr_seq_cot_forn||
							';QT_MAT_OLD_W='||campo_mascara(OLD.qt_material,4)||
							';QT_MAT_NEW_W='||campo_mascara(NEW.qt_material,4));

	CALL gerar_hist_cotacao_sem_commit(NEW.nr_cot_compra, WHEB_MENSAGEM_PCK.get_texto(298888), ds_historico_w, 'S', NEW.nm_usuario);
end if;

if (NEW.cd_material <> OLD.cd_material) then

	ds_historico_w	:= 	WHEB_MENSAGEM_PCK.get_texto(298895,'NR_ITEM_COT_COMPRA_W='||NEW.nr_item_cot_compra||
						';NR_SEQUENCIA_W='||NEW.nr_sequencia||
						';NR_SEQ_COT_FORN_W='||NEW.nr_seq_cot_forn||
						';NM_USUARIO_W='||NEW.nm_usuario||
						';CD_MATERIAL_OLD='||OLD.cd_material||
						';CD_MATERIAL_NEW='||NEW.cd_material);

	CALL gerar_hist_cotacao_sem_commit(NEW.nr_cot_compra, WHEB_MENSAGEM_PCK.get_texto(298902), ds_historico_w, 'S', NEW.nm_usuario);
end if;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cot_compra_forn_item_update() FROM PUBLIC;

CREATE TRIGGER cot_compra_forn_item_update
	BEFORE UPDATE ON cot_compra_forn_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cot_compra_forn_item_update();

