-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS convenio_retorno_item_update ON convenio_retorno_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_convenio_retorno_item_update() RETURNS trigger AS $BODY$
DECLARE
vl_guia_w		double precision;
cont_w			bigint;
cd_conv_ret_w		bigint;
cd_conv_par_w		bigint;
ie_conv_dif_w		varchar(255);
vl_partic_w		double precision;
BEGIN

select	count(*)
into STRICT	cont_w
from	conta_paciente_guia
where	nr_interno_conta	= NEW.nr_interno_conta
and	cd_autorizacao		= NEW.cd_autorizacao;

if (cont_w > 0) then
	select	coalesce(sum(vl_guia),0),
		coalesce(sum(vl_participante),0)
	into STRICT	vl_guia_w,
		vl_partic_w
	from	conta_paciente_guia
	where	nr_interno_conta	= NEW.nr_interno_conta
	and	cd_autorizacao		= NEW.cd_autorizacao;

	if (vl_guia_w = 0) and (vl_partic_w > 0) then
		vl_guia_w := vl_partic_w;
	end if;

	if (NEW.vl_pago >= 0) and (NEW.vl_amenor > 0) and (NEW.vl_amenor > vl_guia_w) and (NEW.vl_adicional >= 0) then
		/* O valor a menor da guia não pode ser maior que o valor da guia na conta paciente!
		Conta: #@NR_INTERNO_CONTA#@
		Guia: #@CD_AUTORIZACAO#@
		Vl guia: #@VL_GUIA#@
		Vl a menor: #@VL_AMENOR#@ */
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266931, 'NR_INTERNO_CONTA=' || NEW.nr_interno_conta || ';' ||
								'CD_AUTORIZACAO=' || NEW.cd_autorizacao || ';'||
								'VL_GUIA=' || vl_guia_w || ';' ||
								'VL_AMENOR=' || NEW.vl_amenor);
	end if;
end if;

ie_conv_dif_w := Obter_Param_Usuario(27, 70, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, 0, ie_conv_dif_w);

if (coalesce(ie_conv_dif_w, 'N') = 'N') then

	select	max(cd_convenio)
	into STRICT	cd_conv_ret_w
	from	convenio_retorno
	where	nr_sequencia		= NEW.nr_seq_retorno;

	select	max(cd_convenio_parametro)
	into STRICT	cd_conv_par_w
	from	conta_paciente
	where	nr_interno_conta	= NEW.nr_interno_conta;

	if (cd_conv_ret_w <> cd_conv_par_w) then
		-- O convênio da conta não pode ser diferente do convênio do retorno!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266932, 'NR_INTERNO_CONTA_W=' || NEW.nr_interno_conta);
	end if;

end if;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_convenio_retorno_item_update() FROM PUBLIC;

CREATE TRIGGER convenio_retorno_item_update
	BEFORE UPDATE ON convenio_retorno_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_convenio_retorno_item_update();

