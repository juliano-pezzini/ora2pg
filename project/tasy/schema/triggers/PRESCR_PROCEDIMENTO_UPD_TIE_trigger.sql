-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_procedimento_upd_tie ON prescr_procedimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_procedimento_upd_tie() RETURNS trigger AS $BODY$
declare

ie_status_envio_w lab_parametro.ie_status_envio%type;
ie_integra_w varchar(1);
jobno bigint;
BEGIN
  BEGIN
	if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then
	BEGIN
        if (OLD.ie_status_atend < 35) and (NEW.ie_status_atend >= 35) then
            if (Obter_Equipamento_Exame(NEW.nr_seq_exame, null, 'COVID19') is not null) then
                CALL send_Exam_Result_DataSus(NEW.nr_prescricao, NEW.nr_seq_exame, NEW.NR_SEQUENCIA, 'COVID19');
            end if;

            CALL send_oru_prescricao(NEW.nr_prescricao, NEW.nr_seq_exame, NEW.nr_sequencia, NEW.ie_status_atend);
        end if;
		
		SELECT CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  ie_integra
		into STRICT ie_integra_w
		FROM exame_laboratorio     a,
		     lab_exame_equip       c
		WHERE a.nr_seq_exame = c.nr_seq_exame
		AND coalesce(a.ie_anatomia_patologica, 'N') = 'N'
		AND obter_equipamento_exame(a.nr_seq_exame, NULL, lab_obter_conversao_externa(NULL, 'EQUIPAMENTO_LAB', 'CD_EQUIPAMENTO', c.cd_equipamento)) IS NOT NULL
		AND a.nr_seq_exame = NEW.nr_seq_exame;

        if (ie_integra_w = 'S' AND NEW.ie_status_atend <= 30) then
            select  b.ie_status_envio
            into STRICT    ie_status_envio_w
            from    lab_parametro b
            where   b.cd_estabelecimento = obter_estabelecimento_ativo;

            if (OLD.ie_status_atend <> NEW.ie_status_atend) and (NEW.ie_status_atend = ie_status_envio_w) then
                dbms_job.submit(jobno, 'LAB_INTEGRA_REQUEST_SEND(' || NEW.nr_prescricao ||','|| NEW.nr_sequencia||','''||NEW.nm_usuario||''');');
            end if;
        end if;
    exception
        when others then
            CALL gravar_log_lab_pragma(6644, 'ERRO prescr_procedimento_upd_tie - '+sqlerrm, 'TASY', NEW.nr_prescricao);
    end;
	end if;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_procedimento_upd_tie() FROM PUBLIC;

CREATE TRIGGER prescr_procedimento_upd_tie
	AFTER UPDATE ON prescr_procedimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_procedimento_upd_tie();

