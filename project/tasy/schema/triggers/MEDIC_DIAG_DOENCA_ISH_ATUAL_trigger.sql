-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS medic_diag_doenca_ish_atual ON medic_diagnostico_doenca CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_medic_diag_doenca_ish_atual() RETURNS trigger AS $BODY$
declare

reg_integracao_p	gerar_int_padrao.reg_integracao;
nr_sequencia_w	varchar(35);
qt_eventos_w	bigint;
nr_seq_interno_w	diagnostico_doenca.nr_seq_interno%type;
dt_liberacao_w	diagnostico_doenca.dt_liberacao%type;

pragma autonomous_transaction;

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'S')  then
	select	count(1)
	into STRICT	qt_eventos_w
	from	intpd_eventos
	where	ie_evento	= '82'
	and	ie_situacao	= 'A';

	select	max(nr_seq_interno),
		max(dt_liberacao)
	into STRICT	nr_seq_interno_w,
		dt_liberacao_w
	from	diagnostico_doenca
	where	nr_atendimento = coalesce(NEW.nr_atendimento,OLD.nr_atendimento)
	and	cd_doenca = coalesce(NEW.cd_doenca, OLD.cd_doenca)
	and	dt_diagnostico = coalesce(NEW.dt_diagnostico, OLD.dt_diagnostico);

	if (qt_eventos_w > 0) and (nr_seq_interno_w > 0) and (dt_liberacao_w is not null) then
		BEGIN
		reg_integracao_p.ie_status := 'AB';

		reg_integracao_p.ie_operacao	:=	'A';
		reg_integracao_p.ie_status		:=	'P';
		reg_integracao_p.nr_atendimento	:=	coalesce(NEW.nr_atendimento,OLD.nr_atendimento);

		nr_sequencia_w := coalesce(NEW.nr_atendimento,OLD.nr_atendimento)||'¬' || nr_seq_interno_w || '¬'||coalesce(NEW.cd_doenca, OLD.cd_doenca);
		reg_integracao_p := gerar_int_padrao.gravar_integracao('82', nr_sequencia_w, coalesce(NEW.nm_usuario, OLD.nm_usuario), reg_integracao_p);
		end;
	end if;
end if;

commit;

IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_medic_diag_doenca_ish_atual() FROM PUBLIC;

CREATE TRIGGER medic_diag_doenca_ish_atual
	AFTER INSERT OR UPDATE OR DELETE ON medic_diagnostico_doenca FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_medic_diag_doenca_ish_atual();

