-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS paciente_acessorio_afinsup ON paciente_acessorio CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_paciente_acessorio_afinsup() RETURNS trigger AS $BODY$
declare

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	accessory_pac_value_attrib		
	where	nr_seq_accessory = NEW.nr_seq_acessorio
	and	ie_situacao = 'A'
	order by nr_seq_display_order;

c01_w	c01%rowtype;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S')  and
	((TG_OP = 'INSERT') or
	((TG_OP = 'UPDATE') and (coalesce(OLD.nr_seq_acessorio,0)) <> coalesce(NEW.nr_seq_acessorio,0))) then
	
	if (TG_OP = 'UPDATE') then
		delete from result_value_pac_accessory
		where nr_seq_pac_acessory = NEW.nr_sequencia;
	end if;
	
	if (NEW.nr_seq_acessorio > 0) then
		
		open c01;
		loop
		fetch C01 into	
			C01_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			BEGIN
			insert into result_value_pac_accessory(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_pac_acessory,
				nr_seq_attribute)
			values (	nextval('result_value_pac_accessory_seq'),
				LOCALTIMESTAMP,
				NEW.nm_usuario,
				LOCALTIMESTAMP,
				NEW.nm_usuario,
				NEW.nr_sequencia,
				C01_w.nr_sequencia);
			end;
		end loop;
		close C01;
	end if;	
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_paciente_acessorio_afinsup() FROM PUBLIC;

CREATE TRIGGER paciente_acessorio_afinsup
	AFTER INSERT OR UPDATE ON paciente_acessorio FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_paciente_acessorio_afinsup();

