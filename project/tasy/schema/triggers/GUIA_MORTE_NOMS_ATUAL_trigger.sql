-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS guia_morte_noms_atual ON guia_morte_noms CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_guia_morte_noms_atual() RETURNS trigger AS $BODY$
declare

qt_idade_paciente_w	varchar(10);
qt_idade_w		bigint;
qt_cid_w		bigint;

BEGIN

if	not(NEW.ie_emissor_certif in (1,2,3)) then
	NEW.nr_cedula_medico_certif := '8888888';
end if;
if (NEW.dt_liberacao is not null) and (OLD.dt_liberacao is null) then
	if (TG_OP = 'UPDATE') then

		if (NEW.CD_TEMPO_CAUSA_1 = 4) and /*Minuto*/

			(NEW.QT_TEMPO_CAUSA_1 > 59) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1079532);  --El rango maximo para el tipo de tiempo minuto és 59.  #@#@'); -- 944751 
		end if;

		if (NEW.CD_TEMPO_CAUSA_1 = 0) and /*horas*/

			(NEW.QT_TEMPO_CAUSA_1 > 23) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1079533); --'El rango maximo para el tipo de tiempo horas és 23 #@#@'); --944753
		end if;

		if (NEW.CD_TEMPO_CAUSA_1 = 2) and /*meses*/

			(NEW.QT_TEMPO_CAUSA_1 > 11) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1079534); -- 'El rango maximo para el tipo de tiempo meses és 11 #@#@'); --944759
		end if;

		if (NEW.CD_TEMPO_CAUSA_1 = 1) and /*dias*/

			(NEW.QT_TEMPO_CAUSA_1 > 29) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1079535); --  'El rango maximo para el tipo de tiempo dias és 29 #@#@'); -- 944800
		end if;

		if (NEW.nr_seq_lingua_indigena_def  <> OLD.nr_seq_lingua_indigena_def ) then
			select	obter_idade(NEW.dt_nascimento_def, LOCALTIMESTAMP, 'A')
			into STRICT	qt_idade_paciente_w
			;
			if (qt_idade_paciente_w < 5) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1079536); -- 'El paciente tiene menos de 5 años de edad, no es possible cambiar la Lengua Indígena'); -- 944802
			end if;
		end if;

		if (NEW.nr_certificado_nasc_def  <> OLD.nr_certificado_nasc_def) then
			if (length(NEW.nr_certificado_nasc_def) < 9) then
				 CALL wheb_mensagem_pck.exibir_mensagem_abort(1079537); --  'El certificado del	 nascimiento no puede ser menor que 9 dígitos.'); -- 944804
			elsif (length(NEW.nr_certificado_nasc_def) > 14) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1079537); -- 'El certificado del	 nascimiento no puede ser maior que 14 dígitos.'); --944804
			elsif (length(NEW.nr_certificado_nasc_def) > 9 and length(NEW.nr_certificado_nasc_def) <= 14 and substr(upper(NEW.nr_certificado_nasc_def), 6,1) <> 'E') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1079538); --  'El sexto dígito del certificado del nacimiento debe ser obrigatoriamente ''E''');  -- 944808
			end if;
		end if;


		select	obter_idade_pf(cd_pessoa_fisica,LOCALTIMESTAMP,'A')
		into STRICT	qt_idade_w
		from	atendimento_paciente
		where	nr_atendimento = NEW.nr_atendimento;

		if (qt_idade_w <= 11) and (NEW.DS_FAMILY_NAME_INF in ('03','01','13','02','07')) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1079539); -- 'Tipo de parentesco del informante no válido para la edad del falecido.'); --944824
		end if;

	end if;
end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_guia_morte_noms_atual() FROM PUBLIC;

CREATE TRIGGER guia_morte_noms_atual
	BEFORE INSERT OR UPDATE ON guia_morte_noms FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_guia_morte_noms_atual();

