-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS checkup_etapa_log ON checkup_etapa CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_checkup_etapa_log() RETURNS trigger AS $BODY$
DECLARE


ds_old_values_w		varchar(4000) := '';
ds_new_values_w		varchar(4000) := '';
nm_atributo_w		varchar(50);
ds_label_w			varchar(50);
ie_tipo_atributo_w	varchar(10);
ie_tipo_log_w		varchar(10);


nm_usuario_w		varchar(50);
nr_sequencia_w		bigint;
nr_seq_checkup_w	checkup.nr_sequencia%type;
dt_atualizacao_w    timestamp := LOCALTIMESTAMP;
cd_pessoa_fisica_w	checkup.cd_pessoa_fisica%type;

c01 CURSOR FOR
	SELECT NM_ATRIBUTO,
		CASE WHEN CD_EXP_LABEL IS NULL THEN  NM_ATRIBUTO  ELSE OBTER_DESC_EXPRESSAO(CD_EXP_LABEL) END  DS_LABEL, 
		IE_TIPO_ATRIBUTO
	from tabela_atributo 
	where nm_tabela = 'CHECKUP_ETAPA'
	  and ie_tipo_atributo not in ('FUNCTION', 'VISUAL')
	order by nm_atributo;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

if (Obter_Valor_Param_Usuario(996, 70, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento) = 'S') then
	if TG_OP = 'UPDATE' then
		open c01;
		loop
		fetch c01 into
			nm_atributo_w,
			ds_label_w,
			ie_tipo_atributo_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			
			if (TG_OP = 'UPDATE' AND NEW.nm_atributo_w IS DISTINCT FROM OLD.nm_atributo_w) then
				
			if (nm_atributo_w = 'DT_ATUALIZACAO') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || to_char(NEW.DT_ATUALIZACAO, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || to_char(OLD.DT_ATUALIZACAO, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			elsif (nm_atributo_w = 'NM_USUARIO') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.NM_USUARIO, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.NM_USUARIO, 1, 4000);
			elsif (nm_atributo_w = 'NR_SEQ_CHECKUP') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.NR_SEQ_CHECKUP, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.NR_SEQ_CHECKUP, 1, 4000);
			elsif (nm_atributo_w = 'NR_SEQ_ETAPA') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.NR_SEQ_ETAPA, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.NR_SEQ_ETAPA, 1, 4000);
			elsif (nm_atributo_w = 'CD_PESSOA_FISICA') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.CD_PESSOA_FISICA, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.CD_PESSOA_FISICA, 1, 4000);
			elsif (nm_atributo_w = 'DT_CANCELAMENTO') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || to_char(NEW.DT_CANCELAMENTO, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || to_char(OLD.DT_CANCELAMENTO, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			elsif (nm_atributo_w = 'NM_USUARIO_CANCEL') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.NM_USUARIO_CANCEL, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.NM_USUARIO_CANCEL, 1, 4000);
			elsif (nm_atributo_w = 'NM_CONTATO_CANCEL') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.NM_CONTATO_CANCEL, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.NM_CONTATO_CANCEL, 1, 4000);
			elsif (nm_atributo_w = 'DT_PREVISTA') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || to_char(NEW.DT_PREVISTA, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || to_char(OLD.DT_PREVISTA, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			elsif (nm_atributo_w = 'DT_CONFIRMACAO') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || to_char(NEW.DT_CONFIRMACAO, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || to_char(OLD.DT_CONFIRMACAO, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			elsif (nm_atributo_w = 'NM_USUARIO_CONF') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.NM_USUARIO_CONF, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.NM_USUARIO_CONF, 1, 4000);
			elsif (nm_atributo_w = 'NM_CONTATO_CONF') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.NM_CONTATO_CONF, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.NM_CONTATO_CONF, 1, 4000);
			elsif (nm_atributo_w = 'DT_INICIO_REAL') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || to_char(NEW.DT_INICIO_REAL, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || to_char(OLD.DT_INICIO_REAL, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			elsif (nm_atributo_w = 'NR_SEQUENCIA') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.NR_SEQUENCIA, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.NR_SEQUENCIA, 1, 4000);
			elsif (nm_atributo_w = 'DT_ATUALIZACAO_NREC') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || to_char(NEW.DT_ATUALIZACAO_NREC, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || to_char(OLD.DT_ATUALIZACAO_NREC, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			elsif (nm_atributo_w = 'NM_USUARIO_NREC') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.NM_USUARIO_NREC, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.NM_USUARIO_NREC, 1, 4000);
			elsif (nm_atributo_w = 'IE_FORMA_CONF') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.IE_FORMA_CONF, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.IE_FORMA_CONF, 1, 4000);
			elsif (nm_atributo_w = 'DT_FIM_ETAPA') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || to_char(NEW.DT_FIM_ETAPA, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || to_char(OLD.DT_FIM_ETAPA, 'DD/MM/YYYY hh24:mi:ss') , 1, 4000);
			elsif (nm_atributo_w = 'DS_PERFIL_ADICIONAL') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.DS_PERFIL_ADICIONAL, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.DS_PERFIL_ADICIONAL, 1, 4000);
			elsif (nm_atributo_w = 'DS_SETOR_ADICIONAL') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.DS_SETOR_ADICIONAL, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.DS_SETOR_ADICIONAL, 1, 4000);
			elsif (nm_atributo_w = 'NM_USUARIO_DESTINO') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.NM_USUARIO_DESTINO, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.NM_USUARIO_DESTINO, 1, 4000);
			elsif (nm_atributo_w = 'NR_SEQ_STATUS_DOC') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.NR_SEQ_STATUS_DOC, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.NR_SEQ_STATUS_DOC, 1, 4000);
			elsif (nm_atributo_w = 'IE_CHAMADO') then
			  ds_new_values_w := substr(ds_new_values_w || ' | '|| ds_label_w || ': ' || NEW.IE_CHAMADO, 1, 4000);
			  ds_old_values_w := substr(ds_old_values_w || ' | '|| ds_label_w || ': ' || OLD.IE_CHAMADO, 1, 4000);
			end if;

			end if;

		end loop;
		close c01;
		if (coalesce(length(ds_old_values_w), 0) > 0 or coalesce(length(ds_new_values_w), 0) > 0) then

			ds_old_values_w := substr(ds_old_values_w, 4, 4000);
			ds_new_values_w := substr(ds_new_values_w, 4, 4000);

			insert into log_checkup(
				nr_sequencia,
				dt_log,
				nm_usuario,
				nm_usuario_nrec,
				ie_tipo_log,
				nm_tabela,
				nr_seq_tabela,
				ds_log_anterior,
				ds_log_novo,
				ds_obs_anterior,
				ds_obs_novo,
				cd_estabelecimento,
				cd_setor_atendimento,
				dt_atualizacao,
				dt_atualizacao_nrec,
				cd_pessoa_fisica)
			values (
				nextval('log_checkup_seq'),
				dt_atualizacao_w,
				NEW.nm_usuario,
				NEW.nm_usuario,
				'UPDATE',
				'CHECKUP_ETAPA',
				NEW.nr_sequencia,
				ds_old_values_w,
				ds_new_values_w,
				null,
				null,
				obter_estabelecimento_ativo,
				obter_setor_ativo,
				dt_atualizacao_w,
				dt_atualizacao_w,
				NEW.cd_pessoa_fisica);
		end if;

	else
		if TG_OP = 'INSERT' then
			ie_tipo_log_w := 'INSERT';
			nm_usuario_w := NEW.nm_usuario;
			nr_sequencia_w := NEW.nr_sequencia;
			nr_seq_checkup_w := NEW.nr_seq_checkup;
			cd_pessoa_fisica_w := NEW.cd_pessoa_fisica;
		elsif TG_OP = 'DELETE' then
			ie_tipo_log_w := 'DELETE';
			nm_usuario_w := OLD.nm_usuario;
			nr_sequencia_w := OLD.nr_sequencia;
			nr_seq_checkup_w := OLD.nr_seq_checkup;
			cd_pessoa_fisica_w := OLD.cd_pessoa_fisica;
		end if;

		select	CASE WHEN CD_EXP_LABEL IS NULL THEN  NM_ATRIBUTO  ELSE OBTER_DESC_EXPRESSAO(CD_EXP_LABEL) END  || ': ' || nr_seq_checkup_w DS_LABEL
		into STRICT ds_new_values_w
		from tabela_atributo
		where nm_tabela = 'CHECKUP_ETAPA'
		  and nm_atributo = 'NR_SEQ_CHECKUP';

		insert into log_checkup(
			nr_sequencia,
			dt_log,
			nm_usuario,
			nm_usuario_nrec,
			ie_tipo_log,
			nm_tabela,
			nr_seq_tabela,
			ds_log_anterior,
			ds_log_novo,
			ds_obs_anterior,
			ds_obs_novo,
			cd_estabelecimento,
			cd_setor_atendimento,
			dt_atualizacao,
			dt_atualizacao_nrec,
			cd_pessoa_fisica)
		values (
			nextval('log_checkup_seq'),
			dt_atualizacao_w,
			nm_usuario_w,
			nm_usuario_w,
			ie_tipo_log_w,
			'CHECKUP_ETAPA',
			nr_sequencia_w,
			null,
			ds_new_values_w,
			null,
			null,
			obter_estabelecimento_ativo,
			obter_setor_ativo,
			dt_atualizacao_w,
			dt_atualizacao_w,
			cd_pessoa_fisica_w);

	end if;
end if;
end if;
IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_checkup_etapa_log() FROM PUBLIC;

CREATE TRIGGER checkup_etapa_log
	AFTER INSERT OR UPDATE OR DELETE ON checkup_etapa FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_checkup_etapa_log();

