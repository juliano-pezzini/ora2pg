-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS hd_pac_renal_cron_aft_insert ON hd_pac_renal_cronico CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_hd_pac_renal_cron_aft_insert() RETURNS trigger AS $BODY$
declare
ie_insere_profissional_w	varchar(1);
cd_medico_resp_w		atendimento_paciente.cd_medico_resp%type;

BEGIN
ie_insere_profissional_w := obter_valor_param_usuario(7009, 283, Obter_Perfil_Ativo, NEW.nm_usuario, NEW.cd_estabelecimento);
if (ie_insere_profissional_w = 'S') then	
	select 	max(cd_medico_resp)
	into STRICT	cd_medico_resp_w
	from 	atendimento_paciente a
	where 	cd_pessoa_fisica = NEW.cd_pessoa_fisica
	and		nr_atendimento = (SELECT	max(nr_atendimento)
							from		atendimento_paciente b
							where		cd_pessoa_fisica = NEW.cd_pessoa_fisica
							and			cd_medico_resp is not null
							and			b.dt_cancelamento is null);
							
	if (cd_medico_resp_w is not null) then
		CALL hd_gerar_profissional_rotina(NEW.nm_usuario,NEW.cd_pessoa_fisica,'M',cd_medico_resp_w,'I',null,NEW.cd_estabelecimento,'S');
	end if;
	
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_hd_pac_renal_cron_aft_insert() FROM PUBLIC;

CREATE TRIGGER hd_pac_renal_cron_aft_insert
	AFTER INSERT ON hd_pac_renal_cronico FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_hd_pac_renal_cron_aft_insert();

