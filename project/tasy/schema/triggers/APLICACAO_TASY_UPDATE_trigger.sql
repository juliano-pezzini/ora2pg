-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS aplicacao_tasy_update ON aplicacao_tasy CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_aplicacao_tasy_update() RETURNS trigger AS $BODY$
declare
qt_registro_w 	bigint;
nm_user_w 	varchar(10);
ds_Sep_bv_w 	varchar(50);
BEGIN
	ds_sep_bv_w := obter_separador_bv;

	qt_registro_w := obter_valor_dinamico_bv('select 1 from estabelecimento where cd_cgc = :cd_cgc and cd_estabelecimento = :cd_estabelecimento and ie_situacao = :ie_situacao', 'cd_cgc=01950338000177'||ds_sep_bv_w||'cd_estabelecimento=1'||ds_sep_bv_w||'ie_situacao=A', qt_registro_w);

	if ( qt_registro_w > 0 ) then
		select substr(user,1,4)
		into STRICT nm_user_w
		;

		if ( nm_user_w = 'TASY' ) then
			if (OLD.cd_versao_atual <> NEW.cd_versao_atual) then
				NEW.ie_status_aplicacao := 'U';
			elsif (OLD.ie_status_aplicacao = 'U') and (NEW.ie_status_aplicacao = 'A') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(281866);
			end if;
		end if;
	end if;

	if (OLD.ie_status_aplicacao <> NEW.ie_status_aplicacao)  and ( OLD.cd_aplicacao_tasy = 'Tasy' )then
		CALL gravar_log_status_tasy(NEW.ie_status_aplicacao,'Tasy');
	end if;
	/*Liberar as funções bloqueadas no incio da atualização pela procedure (TASY_BLOQUEAR_FUNCAO_TAB_TEMP) que possuiam tabelas temporárias a serem alteradas*/

	if (NEW.ie_status_aplicacao = 'A') then
		update	funcao
		set	ie_bloqueada = 'N'
		where 	ie_bloqueada = 'S';
	end if;

	if (OLD.cd_versao_atual <> NEW.cd_versao_atual) and (OLD.ie_atualizacao_versao = 'S') then
		NEW.ie_atualizacao_versao := 'N';
	end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_aplicacao_tasy_update() FROM PUBLIC;

CREATE TRIGGER aplicacao_tasy_update
	BEFORE UPDATE ON aplicacao_tasy FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_aplicacao_tasy_update();

