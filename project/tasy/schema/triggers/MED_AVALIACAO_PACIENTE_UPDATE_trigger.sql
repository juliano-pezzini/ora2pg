-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS med_avaliacao_paciente_update ON med_avaliacao_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_med_avaliacao_paciente_update() RETURNS trigger AS $BODY$
DECLARE
qt_reg_w	smallint;
cd_evolucao_pendencia_w 	evolucao_paciente.cd_evolucao%type;

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;
/* Almir em 15/07/2008 OS89916  */


if (OLD.dt_liberacao is null) and (NEW.dt_liberacao is not null) then

	CALL Gerar_comunic_aval(NEW.nr_sequencia, NEW.cd_pessoa_fisica, NEW.nr_atendimento, NEW.nr_seq_tipo_avaliacao, NEW.dt_avaliacao, NEW.nm_usuario);

	if (NEW.nr_seq_contato is not null)then
		update	cih_contato a
		set	dt_lib_avaliacao	= LOCALTIMESTAMP,
			nm_usuario_lib_aval	= NEW.nm_usuario
		where 	a.nr_sequencia 		= NEW.nr_seq_contato;
	end if;
end if;

if (OLD.dt_inativacao is null) and (NEW.dt_inativacao is not null) then
	update	evolucao_paciente
	set	dt_inativacao = NEW.dt_inativacao,
		IE_SITUACAO = 'I',
		NM_USUARIO_INATIVACAO = NEW.NM_USUARIO_INATIVACAO,
		DS_JUSTIFICATIVA = NEW.DS_JUSTIFICATIVA
	where	nr_seq_avaliacao = NEW.nr_sequencia;
	
	select 	max(cd_evolucao)
	into STRICT   	cd_evolucao_pendencia_w
	from   	evolucao_paciente
	where	nr_seq_avaliacao = NEW.nr_sequencia;
	
	if (cd_evolucao_pendencia_w > 0) then
		CALL Gerar_registro_pendente_PEP('XE', cd_evolucao_pendencia_w, NEW.cd_pessoa_fisica, NEW.nr_atendimento, NEW.nm_usuario,'A');
	end if;

	if (NEW.nr_seq_contato is not null)then
		update	cih_contato a
		set	dt_inativacao_aval	= LOCALTIMESTAMP,
			nm_usuario_inat_aval	= NEW.nm_usuario
		where 	a.nr_sequencia 		= NEW.nr_seq_contato;
	end if;
end if;


<<Final>>
qt_reg_w	:= 0;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_med_avaliacao_paciente_update() FROM PUBLIC;

CREATE TRIGGER med_avaliacao_paciente_update
	AFTER UPDATE ON med_avaliacao_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_med_avaliacao_paciente_update();

