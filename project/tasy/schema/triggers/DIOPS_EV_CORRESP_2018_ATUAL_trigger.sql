-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS diops_ev_corresp_2018_atual ON diops_contrap_ev_corresp CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_diops_ev_corresp_2018_atual() RETURNS trigger AS $BODY$
declare

ie_tipo_movimentacao_w 		diops_contr_ev_corresp_en.ie_tipo_movimentacao%type;
ds_plano_w			diops_contr_ev_corresp_en.ds_plano%type;

BEGIN

select	CASE WHEN NEW.cd_tipo_movimento=7 THEN  	'0' WHEN NEW.cd_tipo_movimento=8 THEN  	'1' WHEN NEW.cd_tipo_movimento=14 THEN  	'1' WHEN NEW.cd_tipo_movimento=9 THEN  	'2' WHEN NEW.cd_tipo_movimento=13 THEN  	'2' WHEN NEW.cd_tipo_movimento=12 THEN  	'3' WHEN NEW.cd_tipo_movimento=15 THEN  	'4' WHEN NEW.cd_tipo_movimento=16 THEN  	'5' END ,
	CASE WHEN NEW.cd_tipo_movimento_sup=1 THEN  	'IFAL' WHEN NEW.cd_tipo_movimento_sup=2 THEN  	'IFPL' WHEN NEW.cd_tipo_movimento_sup=3 THEN  	'PLAL' WHEN NEW.cd_tipo_movimento_sup=4 THEN  	'PLAP' WHEN NEW.cd_tipo_movimento_sup=5 THEN  	'PCEA' WHEN NEW.cd_tipo_movimento_sup=6 THEN  	'PCEL' END
into STRICT	ie_tipo_movimentacao_w,
	ds_plano_w
;

if (NEW.ie_tipo_evento = 'C') then

	update	diops_contr_ev_corresp_en
	set	vl_movimento 		= NEW.vl_preco_pre_corresp_pre
	where	ds_plano 		= ds_plano_w
	and	ie_tipo_cobertura	= '1'
	and	ie_tipo_origem		= '1'
	and	ie_tipo_movimentacao 	= ie_tipo_movimentacao_w
	and	cd_estabelecimento	= NEW.cd_estabelecimento
	and	nr_seq_periodo		= NEW.nr_seq_periodo;

	update	diops_contr_ev_corresp_en
	set	vl_movimento 		= NEW.vl_preco_pre_corresp_pos
	where	ds_plano 		= ds_plano_w
	and	ie_tipo_cobertura	= '1'
	and	ie_tipo_origem		= '2'
	and	ie_tipo_movimentacao 	= ie_tipo_movimentacao_w
	and	cd_estabelecimento	= NEW.cd_estabelecimento
	and	nr_seq_periodo		= NEW.nr_seq_periodo;

	update	diops_contr_ev_corresp_en
	set	vl_movimento 		= NEW.vl_preco_pos_corresp_pre
	where	ds_plano 		= ds_plano_w
	and	ie_tipo_cobertura	= '2'
	and	ie_tipo_origem		= '1'
	and	ie_tipo_movimentacao 	= ie_tipo_movimentacao_w
	and	cd_estabelecimento	= NEW.cd_estabelecimento
	and	nr_seq_periodo		= NEW.nr_seq_periodo;

	update	diops_contr_ev_corresp_en
	set	vl_movimento 		= NEW.vl_preco_pos_corresp_pos
	where	ds_plano 		= ds_plano_w
	and	ie_tipo_cobertura	= '2'
	and	ie_tipo_origem		= '2'
	and	ie_tipo_movimentacao 	= ie_tipo_movimentacao_w
	and	cd_estabelecimento	= NEW.cd_estabelecimento
	and	nr_seq_periodo		= NEW.nr_seq_periodo;


elsif (NEW.ie_tipo_evento = 'E') then
	update	diops_contr_ev_corresp_en
	set	vl_movimento 		= NEW.vl_preco_pre_cart_propr
	where	ds_plano 		= ds_plano_w
	and	ie_tipo_cobertura	= '1'
	and	ie_tipo_origem		= '3'
	and	ie_tipo_movimentacao 	= ie_tipo_movimentacao_w
	and	cd_estabelecimento	= NEW.cd_estabelecimento
	and	nr_seq_periodo		= NEW.nr_seq_periodo;

	update	diops_contr_ev_corresp_en
	set	vl_movimento 		= NEW.vl_preco_pre_corresp_assum
	where	ds_plano 		= ds_plano_w
	and	ie_tipo_cobertura	= '1'
	and	ie_tipo_origem		= '4'
	and	ie_tipo_movimentacao 	= ie_tipo_movimentacao_w
	and	cd_estabelecimento	= NEW.cd_estabelecimento
	and	nr_seq_periodo		= NEW.nr_seq_periodo;

	update	diops_contr_ev_corresp_en
	set	vl_movimento 		= NEW.vl_preco_pos_cart_propr
	where	ds_plano 		= ds_plano_w
	and	ie_tipo_cobertura	= '2'
	and	ie_tipo_origem		= '3'
	and	ie_tipo_movimentacao 	= ie_tipo_movimentacao_w
	and	cd_estabelecimento	= NEW.cd_estabelecimento
	and	nr_seq_periodo		= NEW.nr_seq_periodo;

	update	diops_contr_ev_corresp_en
	set	vl_movimento 		= NEW.vl_preco_pos_corresp_assum
	where	ds_plano 		= ds_plano_w
	and	ie_tipo_cobertura	= '2'
	and	ie_tipo_origem		= '4'
	and	ie_tipo_movimentacao 	= ie_tipo_movimentacao_w
	and	cd_estabelecimento	= NEW.cd_estabelecimento
	and	nr_seq_periodo		= NEW.nr_seq_periodo;
end if;


if (NEW.cd_tipo_movimento in (9, 11)) then
	NEW.vl_preco_pre_corresp_pre := null;
	NEW.vl_preco_pos_corresp_pre := null;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_diops_ev_corresp_2018_atual() FROM PUBLIC;

CREATE TRIGGER diops_ev_corresp_2018_atual
	BEFORE INSERT OR UPDATE ON diops_contrap_ev_corresp FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_diops_ev_corresp_2018_atual();

