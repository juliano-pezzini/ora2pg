-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS finalizar_triagem_pa_atual ON triagem_pronto_atend CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_finalizar_triagem_pa_atual() RETURNS trigger AS $BODY$
declare

PRAGMA AUTONOMOUS_TRANSACTION;

ie_evolucao_triagem_w	varchar(10);
nm_usuario_w 			varchar(50);

BEGIN
if (OLD.dt_fim_triagem is null) and (NEW.dt_fim_triagem is not null) and (NEW.ds_observacao is not null) then
	nm_usuario_w := coalesce(wheb_usuario_pck.get_nm_usuario, NEW.nm_usuario_nrec);
	ie_evolucao_triagem_w := Obter_Valor_Param_Usuario(281, 1169, Obter_Perfil_Ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento);
	if (ie_evolucao_triagem_w is not null) then
		CALL gerar_evolucao_fim_triagem_pa(NEW.nr_atendimento,nm_usuario_w,ie_evolucao_triagem_w,NEW.ds_observacao,NEW.cd_pessoa_fisica);
	end if;
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_finalizar_triagem_pa_atual() FROM PUBLIC;

CREATE TRIGGER finalizar_triagem_pa_atual
	AFTER INSERT OR UPDATE ON triagem_pronto_atend FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_finalizar_triagem_pa_atual();

