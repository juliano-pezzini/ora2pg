-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS parecer_medico_update ON parecer_medico CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_parecer_medico_update() RETURNS trigger AS $BODY$
declare

nr_atendimento_w	bigint;
ie_gerar_lancto_auto_w	varchar(1);
ie_gerar_evol_in_ref_w varchar(5);

pragma autonomous_transaction;
BEGIN
  BEGIN

BEGIN
ie_gerar_evol_in_ref_w := obter_param_usuario(281, 1641, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1), ie_gerar_evol_in_ref_w);

ie_gerar_lancto_auto_w := coalesce(obter_valor_param_usuario(281, 1104, obter_perfil_ativo, NEW.nm_usuario, wheb_usuario_pck.get_cd_estabelecimento),'S');
exception
when others then
	ie_gerar_lancto_auto_w	:= 'S';
end;

if (NEW.dt_liberacao is not null) and (OLD.dt_liberacao is null) then
	
	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	parecer_medico_req
	where	nr_parecer = NEW.nr_parecer;	
	
	if (ie_gerar_lancto_auto_w = 'S') then
		CALL gerar_lancamento_automatico(nr_atendimento_w, null, 321, NEW.nm_usuario,
			NEW.nr_sequencia, NEW.nr_parecer, NEW.cd_medico, to_char(NEW.dt_liberacao,'dd/mm/yyyy hh24:mi:ss'), null, null);
		commit;
	end if;
end if;
if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
if (ie_gerar_evol_in_ref_w ='S' and NEW.cd_evolucao is not null and NEW.dt_inativacao is not null and OLD.dt_inativacao is null ) then
	delete from clinical_note_soap_data where cd_evolucao = NEW.cd_evolucao and ie_med_rec_type = 'INTERNAL_REF' and nr_seq_med_item = NEW.NR_SEQ_INTERNO;
	commit;
    end if;
end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_parecer_medico_update() FROM PUBLIC;

CREATE TRIGGER parecer_medico_update
	AFTER UPDATE ON parecer_medico FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_parecer_medico_update();

