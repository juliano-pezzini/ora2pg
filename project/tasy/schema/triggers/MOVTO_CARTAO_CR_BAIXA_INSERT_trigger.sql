-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS movto_cartao_cr_baixa_insert ON movto_cartao_cr_baixa CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_movto_cartao_cr_baixa_insert() RETURNS trigger AS $BODY$
DECLARE

dt_transacao_w			timestamp;
ds_comprovante_w		varchar(100);
nr_autorizacao_w			varchar(40);
ie_permite_sem_mes_bco_w		varchar(1);
cd_estabelecimento_w		smallint;
qt_saldo_banco_w			bigint;
ie_permite_data_retroativa_w	varchar(1);
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
CALL consiste_movto_banco(NEW.nr_seq_conta_banco,NEW.dt_baixa);

/* Francisco - 24/10/2007 - Inclui o tratamento abaixo para nao haver problemas com posicao contabil */



select	max(dt_transacao),
	max(nr_autorizacao),
	max(ds_comprovante),
	max(cd_estabelecimento)
into STRICT	dt_transacao_w,
	nr_autorizacao_w,
	ds_comprovante_w,
	cd_estabelecimento_w
from	movto_cartao_cr
where	nr_sequencia	= NEW.nr_seq_movto;

BEGIN
ie_permite_data_retroativa_w := obter_param_usuario(3020, 30, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_permite_data_retroativa_w);
exception when others then
	ie_permite_data_retroativa_w	:= 'N';
end;

if (ie_permite_data_retroativa_w = 'N') then
	if (trunc(NEW.dt_baixa,'dd') < trunc(dt_transacao_w,'dd')) then
		/*'A data da baixa nao pode ser inferior a data do movimento!'  
		'Autorizacao: ' || nr_autorizacao_w || ', CV: ' || ds_comprovante_w); */

		CALL wheb_mensagem_pck.exibir_mensagem_abort(237911,'NR_AUTORIZACAO_W=' || nr_autorizacao_w || ';DS_COMPROVANTE_W=' || ds_comprovante_w);
	end if;
end if;


select	count(*)
into STRICT	qt_saldo_banco_w
from	banco_saldo a
where	a.nr_seq_conta			= NEW.nr_seq_conta_banco
and	trunc(a.dt_referencia,'mm')	= trunc(NEW.dt_baixa,'mm');

if (coalesce(qt_saldo_banco_w,0) = 0) then
	BEGIN
	ie_permite_sem_mes_bco_w := obter_param_usuario(3020, 18, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_permite_sem_mes_bco_w);
	exception when others then
		ie_permite_sem_mes_bco_w	:= 'S';
	end;
	if (coalesce(ie_permite_sem_mes_bco_w,'S') = 'N') then
		/*'Nao existe mes aberto no Controle Bancario! Parametro [18]'*/


		CALL wheb_mensagem_pck.exibir_mensagem_abort(237913);
	end if;
end if;	
end if;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_movto_cartao_cr_baixa_insert() FROM PUBLIC;

CREATE TRIGGER movto_cartao_cr_baixa_insert
	BEFORE INSERT ON movto_cartao_cr_baixa FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_movto_cartao_cr_baixa_insert();

