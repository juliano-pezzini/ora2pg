-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS comunic_interna_insert ON comunic_interna CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_comunic_interna_insert() RETURNS trigger AS $BODY$
DECLARE

nr_sequencia_w			bigint;
nm_usuario_oculto_w		varchar(255);
ie_tipo_w				varchar(255);
ie_usuario_oculto_destino_w		bigint;
ds_usuarios_copia_w		varchar(2000);
perfil_ativo_w			numeric(20);
BEGIN

if (NEW.nr_sequencia is null) then
	select	nextval('comunic_interna_seq')
	into STRICT	NEW.nr_sequencia
	;
	NEW.ie_geral	:= 'N';
	NEW.ie_gerencial	:= 'N';
	NEW.dt_liberacao	:= NEW.dt_comunicado;
	NEW.dt_atualizacao	:= LOCALTIMESTAMP;
end if;

select	max(coalesce(vl_parametro, vl_parametro_padrao))
into STRICT	nm_usuario_oculto_w
from	funcao_parametro
where	cd_funcao		= 87
and	nr_sequencia		= 12;

select	coalesce(max(ie_tipo),'C'),
	substr(max(ds_usuarios_copia) ||',',1,2000)
into STRICT	ie_tipo_w,
		ds_usuarios_copia_w
from	comunic_interna_classif
where	nr_sequencia		= NEW.nr_seq_classif;

if (nm_usuario_oculto_w is not null) and (ie_tipo_w 		<> 'G') and (NEW.ie_gerencial	<> 'S') then
	/* Francisco - OS 60685 - Quando o usu√°rio oculto estiver na lista destino deve aparecer entre os que leram */

	ie_usuario_oculto_destino_w := position(nm_usuario_oculto_w in NEW.nm_usuario_destino);
	if ( ie_usuario_oculto_destino_w = 0 ) then
		NEW.nm_usuario_oculto	:= nm_usuario_oculto_w;
	end if;
else
	NEW.nm_usuario_oculto	:= null;
end if;

if (ds_usuarios_copia_w is not null) and (ds_usuarios_copia_w <> ',') then
	NEW.ds_usuarios_ocultos  := substr(NEW.ds_usuarios_ocultos|| ds_usuarios_copia_w,1,2000);
end if;

perfil_ativo_w := obter_perfil_ativo;

if (coalesce(perfil_ativo_w,0) <> 0) then
	NEW.cd_perfil_origem := perfil_ativo_w;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_comunic_interna_insert() FROM PUBLIC;

CREATE TRIGGER comunic_interna_insert
	BEFORE INSERT ON comunic_interna FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_comunic_interna_insert();

