-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS kit_material_atual ON kit_material CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_kit_material_atual() RETURNS trigger AS $BODY$
declare

qt_existe_w 		bigint;
cd_kit_material_w		integer;
BEGIN
  BEGIN

if (obter_se_prot_lib_regras = 'S') then
	update	protocolo_medicacao
	set	nm_usuario_aprov	 = NULL,
		dt_aprovacao		 = NULL,
		ie_status		=	'PA'
	where	nr_seq_interna		=	NEW.nr_seq_protocolo;
end if;

if (TG_OP = 'INSERT') and (NEW.cd_kit_material <> coalesce(OLD.cd_kit_material,0)) then
	BEGIN

	BEGIN

	select 1
	into STRICT	qt_existe_w
	from	kit_material
	where	cd_kit_material = NEW.cd_kit_material;

	exception
	when others then
		qt_existe_w := 0;
	end;

	if (qt_existe_w > 0) then
		BEGIN
		select	coalesce(max(cd_kit_material),0) + 1
		into STRICT	cd_kit_material_w
		from	kit_material;

		NEW.cd_kit_material := cd_kit_material_w;
		end;
	end if;

	end;
end if;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_kit_material_atual() FROM PUBLIC;

CREATE TRIGGER kit_material_atual
	BEFORE INSERT OR UPDATE ON kit_material FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_kit_material_atual();

