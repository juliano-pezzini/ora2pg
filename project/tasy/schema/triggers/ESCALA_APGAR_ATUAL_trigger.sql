-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_apgar_atual ON escala_apgar CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_apgar_atual() RETURNS trigger AS $BODY$
declare
  sql_w varchar(800);
  qt_pontuacao_w bigint;
  ds_erro_w   varchar(2000);
  ds_parametro_w  varchar(2000);
BEGIN
  BEGIN
  if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then
    BEGIN
      if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
        BEGIN
          NEW.nr_hora	:= (to_char(round(NEW.DT_AVALIACAO,'hh24'),'hh24'))::numeric;
        end;
      end if;

      if (coalesce(OLD.dt_avaliacao, LOCALTIMESTAMP + interval '10 days') <> NEW.dt_avaliacao)
	and (NEW.dt_avaliacao is not null)
	then NEW.ds_utc := obter_data_utc(NEW.dt_avaliacao, 'HV');
      end if;
		
      if (coalesce(OLD.dt_liberacao,LOCALTIMESTAMP + interval '10 days') <> NEW.dt_liberacao)
	and (NEW.dt_liberacao is not null)
	then NEW.ds_utc_atualizacao := obter_data_utc(NEW.dt_liberacao, 'HV');
      end if;

      sql_w := 'CALL OBTER_SCORE_APGAR_ATUAL_MD(:1, :2, :3, :4, :5) INTO :qt_pontuacao_w';
      EXECUTE sql_w USING IN NEW.qt_freq_cardiaca,
                                    IN NEW.qt_esforco,
                                    IN NEW.qt_tonus_muscular,
                                    IN NEW.qt_irritabilidade_reflexa,
                                    IN NEW.qt_cor,
                                    OUT qt_pontuacao_w;
    exception
      when others then
        NEW.QT_PONTUACAO := null;
        ds_erro_w := sqlerrm;
        ds_parametro_w := ':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.cd_profissional: ' || NEW.cd_profissional || ' - :new.ie_situacao: ' || NEW.ie_situacao;
        ds_parametro_w := ds_parametro_w || ' - :new.qt_freq_cardiaca: ' || NEW.qt_freq_cardiaca || ' - :new.qt_esforco: ' || NEW.qt_esforco || ' - :new.qt_tonus_muscular: ' || NEW.qt_tonus_muscular || ' - :new.qt_irritabilidade_reflexa: ' || NEW.qt_irritabilidade_reflexa || ' - :new.qt_cor: ' || NEW.qt_cor || ' - qt_pontuacao_w: ' || qt_pontuacao_w;
        CALL gravar_log_medical_device('ESCALA_APGAR_ATUAL', 'OBTER_SCORE_APGAR_ATUAL_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');

      end;

      NEW.QT_PONTUACAO := qt_pontuacao_w;
  end if;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_apgar_atual() FROM PUBLIC;

CREATE TRIGGER escala_apgar_atual
	BEFORE INSERT OR UPDATE ON escala_apgar FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_apgar_atual();

