-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_pagar_adiant_delete ON titulo_pagar_adiant CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_pagar_adiant_delete() RETURNS trigger AS $BODY$
declare

vl_saldo_juros_w	titulo_pagar.vl_saldo_juros%type;
vl_saldo_multa_w	titulo_pagar.vl_saldo_multa%type;

BEGIN

select	coalesce(max(vl_saldo_juros),0),
	coalesce(max(vl_saldo_multa),0)
into STRICT	vl_saldo_juros_w,
	vl_saldo_multa_w
from	titulo_pagar
where	nr_titulo = OLD.nr_titulo;

vl_saldo_juros_w := vl_saldo_juros_w + OLD.vl_juros;
vl_saldo_multa_w := vl_saldo_multa_w + OLD.vl_multa;

if (vl_saldo_juros_w < 0) then
	vl_saldo_juros_w := 0;
end if;

if (vl_saldo_multa_w < 0) then
	vl_saldo_multa_w := 0;
end if;

update	titulo_pagar
set	vl_saldo_juros = coalesce(vl_saldo_juros_w,0),
	vl_saldo_multa = coalesce(vl_saldo_multa_w,0)
where	nr_titulo = OLD.nr_titulo;

RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_pagar_adiant_delete() FROM PUBLIC;

CREATE TRIGGER titulo_pagar_adiant_delete
	BEFORE DELETE ON titulo_pagar_adiant FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_pagar_adiant_delete();

