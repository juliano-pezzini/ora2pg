-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_cod_barra_atual ON material_cod_barra CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_cod_barra_atual() RETURNS trigger AS $BODY$
declare
 
qt_existe_w			smallint;
ie_swisslog_w			varchar(1);
ds_param_integ_hl7_w		varchar(4000) := '';
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_seq_estrut_int_w		mat_estrutura.nr_sequencia%type;
BEGIN
  BEGIN 
cd_estabelecimento_w := obter_estabelecimento_ativo;
 
if (NEW.ie_considerar_fornecedor <> OLD.ie_considerar_fornecedor) then 
	-- Rotina para envio de materiais para integração Swisslog 
	BEGIN 
	select	nr_seq_estrut_int 
	into STRICT	nr_seq_estrut_int_w 
	from	parametros_farmacia 
	where	cd_estabelecimento = cd_estabelecimento_w;
 
	select	consistir_se_mat_contr_estrut(nr_seq_estrut_int_w,NEW.cd_material) 
	into STRICT	ie_swisslog_w 
	;
	exception 
	when others then 
		nr_seq_estrut_int_w := 0;
		ie_swisslog_w := 'N';
	end;
	 
	if (coalesce(ie_swisslog_w,'N') = 'S') then 
		ds_param_integ_hl7_w := 'cd_material=' || NEW.cd_material || obter_separador_bv;
		CALL swisslog_gerar_integracao(438, ds_param_integ_hl7_w);
	end if;
end if;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_cod_barra_atual() FROM PUBLIC;

CREATE TRIGGER material_cod_barra_atual
	BEFORE INSERT OR UPDATE ON material_cod_barra FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_cod_barra_atual();

