-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_sumario_alta_afupdate ON atend_sumario_alta CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_sumario_alta_afupdate() RETURNS trigger AS $BODY$
DECLARE
    c01 CURSOR FOR 
      SELECT nr_sequencia 
      FROM   wl_worklist 
      WHERE  nr_seq_disc_summary = NEW.nr_sequencia 
             AND dt_final_real IS NULL;
    c01_w c01%ROWTYPE;
BEGIN 
    IF ( NEW.ie_situacao = 'I' ) 
       AND ( OLD.ie_situacao = 'A' ) THEN 
      OPEN c01;

      LOOP 
          FETCH c01 INTO c01_w;

          EXIT WHEN NOT FOUND; /* apply on c01 */

          BEGIN 
              UPDATE wl_worklist 
              SET    dt_final_real = LOCALTIMESTAMP, 
                     nm_usuario = NEW.nm_usuario, 
                     dt_atualizacao = LOCALTIMESTAMP 
              WHERE  nr_sequencia = c01_w.nr_sequencia 
                     AND dt_final_real IS NULL;

              INSERT INTO wl_worklist_historico(nr_sequencia, 
                           nr_seq_worklist, 
                           ds_motivo, 
                           nm_usuario, 
                           dt_atualizacao) 
              VALUES ( nextval('wl_worklist_historico_seq'), 
                          c01_w.nr_sequencia, 
                          Obter_desc_expressao(965060), 
                          NEW.nm_usuario, 
                          LOCALTIMESTAMP);
          END;
      END LOOP;

      CLOSE c01;
    END IF;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_sumario_alta_afupdate() FROM PUBLIC;

CREATE TRIGGER atend_sumario_alta_afupdate
	AFTER UPDATE ON atend_sumario_alta FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_sumario_alta_afupdate();

