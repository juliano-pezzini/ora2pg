-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS devolucao_material_pac_update ON devolucao_material_pac CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_devolucao_material_pac_update() RETURNS trigger AS $BODY$
declare

ds_log_w		varchar(2000);
reg_integracao_p	gerar_int_padrao.reg_integracao;

BEGIN

if (TG_OP = 'INSERT') then
  ds_log_w := substr(ds_log_w ||';NR_DEVOLUCAO='||NEW.nr_devolucao || ';call stack='|| substr(dbms_utility.format_call_stack,1,1800),1,2000);
	CALL gravar_log_tasy(5135, ds_log_w, NEW.nm_usuario);		CALL gravar_log_tasy(5135, ds_log_w, NEW.nr_devolucao);
else
  BEGIN

  if	(OLD.dt_liberacao_baixa is null AND NEW.dt_liberacao_baixa is not null) or
    (NEW.dt_liberacao_baixa is null AND OLD.dt_liberacao_baixa is not null) then	
    reg_integracao_p.cd_setor_atendimento	:= NEW.cd_setor_atendimento;
    reg_integracao_p.nr_seq_agrupador	:= NEW.nr_devolucao;

    reg_integracao_p := gerar_int_padrao.gravar_integracao('290', NEW.nr_devolucao, NEW.nm_usuario, reg_integracao_p);
  end if;

  if (coalesce(NEW.dt_liberacao_baixa,LOCALTIMESTAMP) <> coalesce(OLD.dt_liberacao_baixa,LOCALTIMESTAMP - interval '15 days')) then
    ds_log_w := 'DT_LIBERACAO OLD/NEW:' || to_char(OLD.dt_liberacao_baixa,'dd/mm/yyyy hh24:mi:ss') || '-' || to_char(NEW.dt_liberacao_baixa,'dd/mm/yyyy hh24:mi:ss');
  end if;

  if (coalesce(NEW.dt_baixa_total, LOCALTIMESTAMP) <> coalesce(OLD.dt_baixa_total, LOCALTIMESTAMP)) then
    ds_log_w := 'DT_BAIXA_TOTAL OLD/NEW:' || to_char(OLD.dt_baixa_total,'dd/mm/yyyy hh24:mi:ss') || '-' || to_char(NEW.dt_baixa_total,'dd/mm/yyyy hh24:mi:ss');
  end if;

  if (ds_log_w is not null) then
    ds_log_w := substr(ds_log_w ||';NR_DEVOLUCAO='||NEW.nr_devolucao || ';call stack='|| substr(dbms_utility.format_call_stack,1,1800),1,2000);
    CALL gravar_log_tasy(5135, ds_log_w, NEW.nm_usuario);
  end if;

  end;
end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_devolucao_material_pac_update() FROM PUBLIC;

CREATE TRIGGER devolucao_material_pac_update
	AFTER INSERT OR UPDATE ON devolucao_material_pac FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_devolucao_material_pac_update();

