-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_mews_atual ON escala_mews CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_mews_atual() RETURNS trigger AS $BODY$
DECLARE
    qt_pontuacao_w   bigint;
    qt_pont_aux_w    bigint;
    sql_w            varchar(300);
    ds_erro_w        varchar(4000);
    ds_parametros_w  varchar(4000);
    param1537        varchar(1);
    atributo         varchar(50);
    minimo           double precision;
    maximo           double precision;
    pontuacao        bigint;
    indice           varchar(1);
    c01 CURSOR FOR
    SELECT
        nm_atributo,
        qt_min,
        qt_max,
        qt_score
    FROM
        itens_escala_mews
    WHERE
        nm_atributo = 'QT_FREQ_CARDIACA';

    c02 CURSOR FOR
    SELECT
        nm_atributo,
        qt_min,
        qt_max,
        qt_score
    FROM
        itens_escala_mews
    WHERE
        nm_atributo = 'QT_FREQ_RESP';

    c03 CURSOR FOR
    SELECT
        nm_atributo,
        qt_min,
        qt_max,
        qt_score
    FROM
        itens_escala_mews
    WHERE
        nm_atributo = 'QT_PA_SISTOLICA';

    c04 CURSOR FOR
    SELECT
        nm_atributo,
        qt_min,
        qt_max,
        qt_score
    FROM
        itens_escala_mews
    WHERE
        nm_atributo = 'QT_TEMP';

    c05 CURSOR FOR
    SELECT
        nm_atributo,
        ie_nivel_consciencia,
        qt_score
    FROM
        itens_escala_mews
    WHERE
        nm_atributo = 'IE_NIVEL_CONSCIENCIA';
BEGIN
  BEGIN
    IF ( NEW.nr_hora IS NULL ) OR ( NEW.dt_avaliacao <> OLD.dt_avaliacao ) THEN
        BEGIN
            NEW.nr_hora := (to_char(round(NEW.dt_avaliacao, 'hh24'), 'hh24'))::numeric;

        END;
    END IF;

    IF ( wheb_usuario_pck.get_ie_executar_trigger = 'S' ) THEN
        qt_pontuacao_w := 0;
        param1537 := obter_param_usuario(281, 1537, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, obter_estabelecimento_ativo, param1537);
        IF ( coalesce(param1537, 'N') = 'N' ) THEN
            BEGIN
                sql_w := 'call obter_escala_mews_01_md(:1, :2, :3, :4, :5) into :qt_pontuacao_w';
                EXECUTE sql_w
                    USING IN NEW.qt_freq_cardiaca, IN NEW.qt_freq_resp, IN NEW.qt_pa_sistolica, IN NEW.ie_nivel_consciencia, IN NEW.qt_temp,
                    OUT qt_pontuacao_w;

            EXCEPTION
                WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_freq_cardiaca: '||NEW.qt_freq_cardiaca||'-'||':new.qt_freq_resp: '||NEW.qt_freq_resp||'-'||':new.qt_pa_sistolica: '||NEW.qt_pa_sistolica||'-'||
                          ':new.ie_nivel_consciencia: '||NEW.ie_nivel_consciencia||'-'||':new.qt_temp: '||NEW.qt_temp||'-'||'qt_pontuacao_w: '||qt_pontuacao_w);
      CALL gravar_log_medical_device('escala_mews_atual','obter_escala_mews_01_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
                
                    qt_pontuacao_w := NULL;
            END;

            NEW.qt_pontuacao := qt_pontuacao_w;
        ELSE
            qt_pont_aux_w := 0;
            sql_w := 'call obter_escala_mews_02_md(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11) into :qt_pontuacao_w';
            IF ( NEW.qt_freq_cardiaca IS NOT NULL ) THEN
                OPEN c01;
                LOOP
                    FETCH c01 INTO
                        atributo,
                        minimo,
                        maximo,
                        pontuacao;
                    EXIT WHEN NOT FOUND; /* apply on c01 */
                    BEGIN
                        EXECUTE sql_w
                            USING IN NEW.qt_freq_cardiaca, IN NEW.qt_freq_resp, IN NEW.qt_pa_sistolica, IN NEW.ie_nivel_consciencia,
                            IN NEW.qt_temp, IN atributo, IN minimo, IN maximo, IN pontuacao, IN indice, 'FC', OUT qt_pontuacao_w;
                    EXCEPTION
                        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_freq_cardiaca: '||NEW.qt_freq_cardiaca||'-'||':new.qt_freq_resp: '||NEW.qt_freq_resp||'-'||':new.qt_pa_sistolica: '||NEW.qt_pa_sistolica||'-'||
                          ':new.ie_nivel_consciencia: '||NEW.ie_nivel_consciencia||'-'||':new.qt_temp: '||NEW.qt_temp||'-'||
                          'atributo: '||atributo||'-'||'minimo: '||minimo||'-'||'maximo: '||maximo||'-'||'pontuacao: '||pontuacao||'-'||'indice: '||indice||'-'||
                          'qt_pontuacao_w: '||qt_pontuacao_w);
      CALL gravar_log_medical_device('escala_mews_atual','obter_escala_mews_02_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
                        
                            qt_pontuacao_w := NULL;
                    END;

                    qt_pont_aux_w := qt_pont_aux_w + qt_pontuacao_w;
                END LOOP;

                CLOSE c01;
            END IF;

            IF ( NEW.qt_freq_resp IS NOT NULL ) THEN
                OPEN c02;
                LOOP
                    FETCH c02 INTO
                        atributo,
                        minimo,
                        maximo,
                        pontuacao;
                    EXIT WHEN NOT FOUND; /* apply on c02 */
                    BEGIN
                        EXECUTE sql_w
                            USING IN NEW.qt_freq_cardiaca, IN NEW.qt_freq_resp, IN NEW.qt_pa_sistolica, IN NEW.ie_nivel_consciencia,
                            IN NEW.qt_temp, IN atributo, IN minimo, IN maximo, IN pontuacao, IN indice, 'FR', OUT qt_pontuacao_w;
                    EXCEPTION
                        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_freq_cardiaca: '||NEW.qt_freq_cardiaca||'-'||':new.qt_freq_resp: '||NEW.qt_freq_resp||'-'||':new.qt_pa_sistolica: '||NEW.qt_pa_sistolica||'-'||
                          ':new.ie_nivel_consciencia: '||NEW.ie_nivel_consciencia||'-'||':new.qt_temp: '||NEW.qt_temp||'-'||
                          'atributo: '||atributo||'-'||'minimo: '||minimo||'-'||'maximo: '||maximo||'-'||'pontuacao: '||pontuacao||'-'||'indice: '||indice||'-'||
                          'qt_pontuacao_w: '||qt_pontuacao_w);
      CALL gravar_log_medical_device('escala_mews_atual','obter_escala_mews_02_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
                        
                            qt_pontuacao_w := NULL;
                    END;

                    qt_pont_aux_w := qt_pont_aux_w + qt_pontuacao_w;
                END LOOP;

                CLOSE c02;
            END IF;

            IF ( NEW.qt_pa_sistolica IS NOT NULL ) THEN
                OPEN c03;
                LOOP
                    FETCH c03 INTO
                        atributo,
                        minimo,
                        maximo,
                        pontuacao;
                    EXIT WHEN NOT FOUND; /* apply on c03 */
                    BEGIN
                        EXECUTE sql_w
                            USING IN NEW.qt_freq_cardiaca, IN NEW.qt_freq_resp, IN NEW.qt_pa_sistolica, IN NEW.ie_nivel_consciencia,
                            IN NEW.qt_temp, IN atributo, IN minimo, IN maximo, IN pontuacao, IN indice, 'PaS', OUT qt_pontuacao_w;
                    EXCEPTION
                        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_freq_cardiaca: '||NEW.qt_freq_cardiaca||'-'||':new.qt_freq_resp: '||NEW.qt_freq_resp||'-'||':new.qt_pa_sistolica: '||NEW.qt_pa_sistolica||'-'||
                          ':new.ie_nivel_consciencia: '||NEW.ie_nivel_consciencia||'-'||':new.qt_temp: '||NEW.qt_temp||'-'||
                          'atributo: '||atributo||'-'||'minimo: '||minimo||'-'||'maximo: '||maximo||'-'||'pontuacao: '||pontuacao||'-'||'indice: '||indice||'-'||
                          'qt_pontuacao_w: '||qt_pontuacao_w);
      CALL gravar_log_medical_device('escala_mews_atual','obter_escala_mews_02_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
                        
                            qt_pontuacao_w := NULL;
                    END;

                    qt_pont_aux_w := qt_pont_aux_w + qt_pontuacao_w;
                END LOOP;

                CLOSE c03;
            END IF;

            IF ( NEW.qt_temp IS NOT NULL ) THEN
                OPEN c04;
                LOOP
                    FETCH c04 INTO
                        atributo,
                        minimo,
                        maximo,
                        pontuacao;
                    EXIT WHEN NOT FOUND; /* apply on c04 */
                    BEGIN
                        EXECUTE sql_w
                            USING IN NEW.qt_freq_cardiaca, IN NEW.qt_freq_resp, IN NEW.qt_pa_sistolica, IN NEW.ie_nivel_consciencia,
                            IN NEW.qt_temp, IN atributo, IN minimo, IN maximo, IN pontuacao, IN indice, 'T', OUT qt_pontuacao_w;
                    EXCEPTION
                        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_freq_cardiaca: '||NEW.qt_freq_cardiaca||'-'||':new.qt_freq_resp: '||NEW.qt_freq_resp||'-'||':new.qt_pa_sistolica: '||NEW.qt_pa_sistolica||'-'||
                          ':new.ie_nivel_consciencia: '||NEW.ie_nivel_consciencia||'-'||':new.qt_temp: '||NEW.qt_temp||'-'||
                          'atributo: '||atributo||'-'||'minimo: '||minimo||'-'||'maximo: '||maximo||'-'||'pontuacao: '||pontuacao||'-'||'indice: '||indice||'-'||
                          'qt_pontuacao_w: '||qt_pontuacao_w);
      CALL gravar_log_medical_device('escala_mews_atual','obter_escala_mews_02_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
                        
                            qt_pontuacao_w := NULL;
                    END;

                    qt_pont_aux_w := qt_pont_aux_w + qt_pontuacao_w;
                END LOOP;

                CLOSE c04;
            END IF;

            IF ( NEW.ie_nivel_consciencia IS NOT NULL ) THEN
                OPEN c05;
                LOOP
                    FETCH c05 INTO
                        atributo,
                        indice,
                        pontuacao;
                    EXIT WHEN NOT FOUND; /* apply on c05 */
                    BEGIN
                        EXECUTE sql_w
                            USING IN NEW.qt_freq_cardiaca, IN NEW.qt_freq_resp, IN NEW.qt_pa_sistolica, IN NEW.ie_nivel_consciencia,
                            IN NEW.qt_temp, IN atributo, IN minimo, IN maximo, IN pontuacao, IN indice, 'NC', OUT qt_pontuacao_w;
                    EXCEPTION
                        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_freq_cardiaca: '||NEW.qt_freq_cardiaca||'-'||':new.qt_freq_resp: '||NEW.qt_freq_resp||'-'||':new.qt_pa_sistolica: '||NEW.qt_pa_sistolica||'-'||
                          ':new.ie_nivel_consciencia: '||NEW.ie_nivel_consciencia||'-'||':new.qt_temp: '||NEW.qt_temp||'-'||
                          'atributo: '||atributo||'-'||'minimo: '||minimo||'-'||'maximo: '||maximo||'-'||'pontuacao: '||pontuacao||'-'||'indice: '||indice||'-'||
                          'qt_pontuacao_w: '||qt_pontuacao_w);
      CALL gravar_log_medical_device('escala_mews_atual','obter_escala_mews_02_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
                        
                            qt_pontuacao_w := NULL;
                    END;

                    qt_pont_aux_w := qt_pont_aux_w + qt_pontuacao_w;
                END LOOP;

                CLOSE c05;
            END IF;

            NEW.qt_pontuacao := qt_pont_aux_w;
        END IF;

    END IF;

  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_mews_atual() FROM PUBLIC;

CREATE TRIGGER escala_mews_atual
	BEFORE INSERT OR UPDATE ON escala_mews FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_mews_atual();

