-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS solic_compra_insert ON solic_compra CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_solic_compra_insert() RETURNS trigger AS $BODY$
declare

cd_perfil_w		integer;
ie_status_w  bigint;

BEGIN

select count(*)
into STRICT ie_status_w
from solic_compra_item
where nr_solic_compra = NEW.nr_solic_compra and obter_bloq_canc_proj_rec(nr_seq_proj_rec) > 0;

if (ie_status_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1144309);  -- Registro associado a um projeto bloqueado ou cancelado. 
end if;

NEW.nm_usuario_nrec		:=	coalesce(NEW.nm_usuario_nrec, NEW.nm_usuario);
NEW.dt_atualizacao_nrec	:=	coalesce(NEW.dt_atualizacao_nrec, NEW.dt_atualizacao);

if (TG_OP = 'INSERT') then
	NEW.ds_stack := substr(dbms_utility.format_call_stack,1,2000);
end if;

select	obter_perfil_ativo
into STRICT	cd_perfil_w
;

if (cd_perfil_w > 0) then
	NEW.cd_perfil := cd_perfil_w;
end if;

if (NEW.nr_seq_ordem_serv > 0) and (coalesce(NEW.ie_tipo_servico,'ES') = 'ES') then
	NEW.ie_tipo_servico := null;
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_solic_compra_insert() FROM PUBLIC;

CREATE TRIGGER solic_compra_insert
	BEFORE INSERT ON solic_compra FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_solic_compra_insert();

