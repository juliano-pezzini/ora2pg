-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pessoa_fisica_egk_after ON pessoa_fisica_egk CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pessoa_fisica_egk_after() RETURNS trigger AS $BODY$
declare
reg_integracao_p	gerar_int_padrao.reg_integracao;
nr_sequencia_w		varchar(35);
ie_gravar_w		varchar(1);
qt_eventos_w		bigint	:= 0;
qt_registros_w		bigint	:= 0;
ie_inserindo_conv_w	bigint	:= 0;

BEGIN
null;
/* OS 2016648,  evento não será mais agendado nesta trigger.
if	(wheb_usuario_pck.get_ie_executar_trigger = 'S') and
	(:new.cd_pessoa_fisica is not null) then
	begin
	select	1
	into	qt_eventos_w
	from	intpd_eventos
	where	ie_evento	= '360'
	and	ie_situacao	= 'A'
	and	rownum		= 1;
	exception
	when others then
		qt_eventos_w	:= 0;
	end;
	
	begin
	select	1
	into	qt_registros_w
	from	atendimento_paciente a,
		atend_paciente_unidade b,
		episodio_paciente c
	where	a.cd_pessoa_fisica	= :new.cd_pessoa_fisica
	and	a.dt_cancelamento	is null
	and	a.nr_seq_episodio	= c.nr_sequencia
	and	c.dt_cancelamento	is null
	and	c.dt_fim_episodio	is null
	and	a.nr_atendimento	= b.nr_atendimento;
	exception
	when others then
		qt_registros_w	:= 0;
	end;
	
	if	((qt_eventos_w > 0) and
		(qt_registros_w > 0)) then	
		if	(inserting) then
			reg_integracao_p.nr_seq_agrupador	:= :new.cd_pessoa_fisica;
			reg_integracao_p.cd_pessoa_fisica	:= :new.cd_pessoa_fisica;
			reg_integracao_p.ie_status		:= 'P';
			reg_integracao_p.ie_operacao		:= 'I';
			nr_sequencia_w				:= :new.nr_sequencia;
			
			gerar_int_padrao.gravar_integracao('360', nr_sequencia_w, :new.nm_usuario, reg_integracao_p);
			
		elsif	(updating) then
			
			reg_integracao_p.nr_seq_agrupador	:= :new.cd_pessoa_fisica;
			reg_integracao_p.cd_pessoa_fisica	:= :new.cd_pessoa_fisica;
			reg_integracao_p.ie_status		:= 'P';
			reg_integracao_p.ie_operacao		:= 'A';
			nr_sequencia_w				:= :new.nr_sequencia;
			
			gerar_int_padrao.gravar_integracao('360', nr_sequencia_w, :new.nm_usuario, reg_integracao_p);
						
		end if;
	end if;
end if;*/


RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pessoa_fisica_egk_after() FROM PUBLIC;

CREATE TRIGGER pessoa_fisica_egk_after
	AFTER INSERT OR UPDATE ON pessoa_fisica_egk FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pessoa_fisica_egk_after();

