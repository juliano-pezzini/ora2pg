-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS gerint_pessoa_fisica ON pessoa_fisica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_gerint_pessoa_fisica() RETURNS trigger AS $BODY$
declare

ie_integra_gerint_w		varchar(1);
nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
ds_sep_bv_w				varchar(50);

BEGIN

if 	((wheb_usuario_pck.get_ie_executar_trigger = 'S' ) and (obter_dados_param_atend(NEW.cd_estabelecimento,'GI') = 'S') and
	((OLD.NR_CPF is null AND NEW.NR_CPF is not null) or
	(OLD.NR_CARTAO_NAC_SUS is null AND NEW.NR_CARTAO_NAC_SUS is not null))) then

	select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END ,
			max(nr_atendimento)
	into STRICT	ie_integra_gerint_w,
			nr_atendimento_w
	from	gerint_solic_internacao
	where	cd_pessoa_fisica = NEW.cd_pessoa_fisica
	and		nr_atendimento is not null
	and		ie_situacao not in ('E','N','L');

	if (ie_integra_gerint_w = 'S') then

		ds_sep_bv_w	:=	obter_separador_bv;

		--Atualiza dados na Solicitação de internação.
		update	GERINT_SOLIC_INTERNACAO
		set		NM_PESSOA_FISICA = NEW.nm_pessoa_fisica,
				NR_CPF_PACIENTE = NEW.nr_cpf,
				NR_CARTAO_SUS = NEW.nr_cartao_nac_sus
		where	cd_pessoa_fisica = NEW.cd_pessoa_fisica
		and		nr_atendimento = nr_atendimento_w;

		--Dispara o evento de integração.
		CALL exec_sql_dinamico_bv('TASY', Gerint_desc_de_para('QUERY'), 	'nm_usuario_p='					|| NEW.nm_usuario  							|| ds_sep_bv_w ||
																	'cd_estabelecimento_p=' 		|| NEW.cd_estabelecimento				 		|| ds_sep_bv_w ||
																	'id_evento_p=' 					|| '13'				 							|| ds_sep_bv_w ||
																	'nr_atendimento_p=' 			|| nr_atendimento_w	 							|| ds_sep_bv_w ||
																	'ie_leito_extra_p=' 			|| null				 							|| ds_sep_bv_w ||
																	'dt_alta_p=' 					|| null											|| ds_sep_bv_w ||
																	'ds_motivo_alta_p=' 			|| null											|| ds_sep_bv_w ||
																	'ds_justif_transferencia_p='	|| null 										|| ds_sep_bv_w ||
																	'nr_seq_solic_internacao_p=' 	|| null 										|| ds_sep_bv_w ||
																	'nr_seq_leito_p=' 				|| null											|| ds_sep_bv_w ||
																	'ds_ident_leito_p='				|| null											|| ds_sep_bv_w ||
																	'nr_seq_classif_p=' 			|| null											|| ds_sep_bv_w ||
																	'ie_status_unidade_p=' 			|| null											|| ds_sep_bv_w ||
																	'nr_cpf_paciente_p=' 			|| NEW.NR_CPF									|| ds_sep_bv_w ||
																	'nr_cartao_sus_p=' 				|| NEW.NR_CARTAO_NAC_SUS						|| ds_sep_bv_w ||
																	'cd_cid_p='						|| null											|| ds_sep_bv_w ||
																	'cd_evolucao_p='				|| null);
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_gerint_pessoa_fisica() FROM PUBLIC;

CREATE TRIGGER gerint_pessoa_fisica
	AFTER UPDATE ON pessoa_fisica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_gerint_pessoa_fisica();

