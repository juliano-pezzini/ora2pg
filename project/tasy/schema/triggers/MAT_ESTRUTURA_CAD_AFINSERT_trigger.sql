-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS mat_estrutura_cad_afinsert ON mat_estrutura_cadastro CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_mat_estrutura_cad_afinsert() RETURNS trigger AS $BODY$
declare

cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_seq_estrut_int_w		parametros_farmacia.nr_seq_estrut_int%type;
ds_param_integ_hl7_w		varchar(4000) := '';
BEGIN
  BEGIN
BEGIN
select	b.cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	mat_estrutura a,
	mat_tipo_estrutura b
where	a.nr_sequencia = NEW.nr_seq_estrutura
and	b.nr_sequencia = a.nr_seq_tipo;
exception
when others then
	cd_estabelecimento_w := 1;
end;

select	coalesce(max(nr_seq_estrut_int),0)
into STRICT	nr_seq_estrut_int_w
from	parametros_farmacia
where	cd_estabelecimento = cd_estabelecimento_w;

if (NEW.nr_seq_estrutura = nr_seq_estrut_int_w) then

	ds_param_integ_hl7_w := 'cd_material=' || NEW.cd_material || obter_separador_bv;
	CALL swisslog_gerar_integracao(438,ds_param_integ_hl7_w);
	CALL gravar_agend_integracao(438,ds_param_integ_hl7_w);
end if;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_mat_estrutura_cad_afinsert() FROM PUBLIC;

CREATE TRIGGER mat_estrutura_cad_afinsert
	AFTER INSERT ON mat_estrutura_cadastro FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_mat_estrutura_cad_afinsert();

