-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_diaria_adic_atual ON escala_diaria_adic CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_diaria_adic_atual() RETURNS trigger AS $BODY$
DECLARE

ie_situacao_w varchar(1);
nr_seq_escala_w escala_diaria.nr_seq_escala%type;
ds_bloq_alt_escala_inativa_w varchar(255);
nr_seq_escala_diaria_w	escala_diaria_adic.nr_seq_escala_diaria%type;
ie_cascade_w		bigint	:= 0;
BEGIN
  BEGIN

	BEGIN
		select	count(*) ie_cascade
		into STRICT	ie_cascade_w
		from	v$session v
		where	v.audsid		= (SELECT userenv('sessionid') sessionid  d )
		and	upper(v.action) 	= 'DELETE_CASCADE';
	exception
	when no_data_found then
		ie_cascade_w := 0;
	end;

	IF (coalesce(wheb_usuario_pck.get_ie_executar_trigger, 'S') != 'N' and ie_cascade_w = 0) THEN
		ie_situacao_w := 'S';

		ds_bloq_alt_escala_inativa_w := obter_valor_param_usuario(3009, 40, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);
	
		if TG_OP = 'DELETE' then
			nr_seq_escala_diaria_w := OLD.nr_seq_escala_diaria;
		else
			nr_seq_escala_diaria_w := NEW.nr_seq_escala_diaria;
		end if;
		
		SELECT nr_seq_escala
		INTO STRICT nr_seq_escala_w
		FROM escala_diaria
		WHERE nr_sequencia = nr_seq_escala_diaria_w;
	
		ie_situacao_w := fis_obter_escala_ativa(nr_seq_escala_w, 'ESCALA');
	
		IF (ie_situacao_w = 'N' AND coalesce(ds_bloq_alt_escala_inativa_w, 'N') = 'S') THEN
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1186376, 'SEQ=' || nr_seq_escala_w);
		END IF;		
	END IF;
  END;
IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_diaria_adic_atual() FROM PUBLIC;

CREATE TRIGGER escala_diaria_adic_atual
	BEFORE INSERT OR UPDATE OR DELETE ON escala_diaria_adic FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_diaria_adic_atual();

