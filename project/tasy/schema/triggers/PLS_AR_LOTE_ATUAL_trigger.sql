-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_ar_lote_atual ON pls_ar_lote CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_ar_lote_atual() RETURNS trigger AS $BODY$
declare
 
BEGIN 
if (NEW.dt_mes_competencia <> OLD.dt_mes_competencia) or (OLD.dt_mes_competencia is null) then	 
	NEW.dt_inicio 	:= trunc(NEW.dt_mes_competencia, 'mm');
	NEW.dt_fim 	:= last_day(trunc(NEW.dt_mes_competencia)) + 0.99999;
end if;
 
if (NEW.cd_estabelecimento <> OLD.cd_estabelecimento) or (OLD.cd_estabelecimento is null) then 
	select	coalesce(max(ie_forma_pagamento), 'P') 
	into STRICT	NEW.ie_forma_pagamento 
	from	pls_parametro_pagamento 
	where	cd_estabelecimento = NEW.cd_estabelecimento;
	 
	select	coalesce(max(ie_pro_rata_dia), 'S') 
	into STRICT	NEW.ie_pro_rata_dia 
	from	pls_parametros 
	where	cd_estabelecimento = NEW.cd_estabelecimento;
end if;
 
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_ar_lote_atual() FROM PUBLIC;

CREATE TRIGGER pls_ar_lote_atual
	BEFORE INSERT OR UPDATE ON pls_ar_lote FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_ar_lote_atual();

