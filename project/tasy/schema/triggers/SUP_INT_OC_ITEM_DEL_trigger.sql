-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS sup_int_oc_item_del ON sup_int_oc_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_sup_int_oc_item_del() RETURNS trigger AS $BODY$
declare
dt_liberacao_w			timestamp;
nr_documento_externo_w		bigint;
nr_ordem_existente_w		bigint;
nr_ano_ordem_w			smallint;
nr_ordem_compra_w		bigint;
nr_serie_oc_w			smallint;
 
BEGIN 
 
select	dt_liberacao, 
	nr_documento_externo 
into STRICT	dt_liberacao_w, 
	nr_documento_externo_w 
from	sup_int_oc 
where	nr_sequencia = OLD.nr_sequencia;
 
if (dt_liberacao_w is not null) then 
	BEGIN 
 
	select	(substr(to_char(nr_documento_externo_w),1,length(nr_documento_externo_w)-5))::numeric , 
		(substr(to_char(nr_documento_externo_w),length(nr_documento_externo_w)-4,1))::numeric , 
		(substr(to_char(nr_documento_externo_w),length(nr_documento_externo_w)-3,4))::numeric  
	into STRICT	nr_ordem_existente_w, 
		nr_serie_oc_w, 
		nr_ano_ordem_w 
	;
 
	select	coalesce(max(nr_ordem_compra),0) 
	into STRICT	nr_ordem_compra_w 
	from	ordem_compra 
	where	(substr(to_char(nr_documento_externo),1,4))::numeric  = nr_ordem_existente_w 
	and	(to_char(dt_ordem_compra,'yyyy'))::numeric  = nr_ano_ordem_w 
	and 	(substr(to_char(nr_documento_externo),length(to_char(nr_documento_externo))-4,1))::numeric  = nr_serie_oc_w 
	and	dt_liberacao is null;
 
	delete 
	from	ordem_compra_item 
	where	nr_ordem_compra = nr_ordem_compra_w 
	and	nr_item_oci = OLD.nr_item_oci;
 
	end;
end if;
 
RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_sup_int_oc_item_del() FROM PUBLIC;

CREATE TRIGGER sup_int_oc_item_del
	BEFORE DELETE ON sup_int_oc_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_sup_int_oc_item_del();

