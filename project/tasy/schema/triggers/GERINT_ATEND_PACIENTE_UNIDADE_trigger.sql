-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS gerint_atend_paciente_unidade ON atend_paciente_unidade CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_gerint_atend_paciente_unidade() RETURNS trigger AS $BODY$
declare


ie_prim_movimentacao_w			varchar(1);
nr_seq_leito_w					unidade_atendimento.nr_seq_interno%type;
ie_leito_extra_w				varchar(1);
ds_sep_bv_w						varchar(50);
ie_integra_gerint_w				varchar(1);
ie_gerint_w						varchar(1);
ie_existe_diagnostico_w			diagnostico_doenca.cd_doenca%type;
nr_cpf_medico_w					pessoa_fisica.nr_cpf%type;
ie_leito_integrado_w			bigint;
ie_diagnostico_w				varchar(1);


BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
/*			I N T E G R A ? ? O  -  G E R I N T				
	Evento 3: Servi?o de Interna??o
	Evento 4: Servi?o de Interna??o em um leito extra
	Evento 6: Servi?o de Transfer?ncia do Leito da Interna??o
	Evento 25: Servico de ocupacao de leito sem solicitacao previa cadastrada no GERINT
	*/


	if (obter_dados_param_atend(obter_estab_atend(NEW.nr_atendimento),'GI') = 'S') and (obter_tipo_atendimento(NEW.nr_atendimento) = 1) then


		ie_prim_movimentacao_w := GERINT_OBTER_prim_mov(NEW.nr_atendimento);
		ie_diagnostico_w := Obter_Param_Usuario(10230, 1, obter_perfil_ativo, NEW.nm_usuario, OBTER_ESTABELECIMENTO_ATIVO, ie_diagnostico_w);	
		select	max(nr_seq_interno),
				coalesce(max(ie_temporario),'N'),
				coalesce(max(ie_gerint),'N')
		into STRICT	nr_seq_leito_w,
				ie_leito_extra_w,
				ie_gerint_w
		from 	unidade_atendimento
		where 	cd_unidade_basica		= NEW.cd_unidade_basica
		and 	cd_unidade_compl  	    = NEW.cd_unidade_compl
		and 	cd_setor_atendimento 	= NEW.cd_setor_atendimento;

		select max(cd_doenca), obter_cpf_pessoa_fisica(max(cd_medico))
		into STRICT ie_existe_diagnostico_w, nr_cpf_medico_w
		from (
				SELECT x.cd_doenca, x.cd_medico from DIAGNOSTICO_DOENCA x
				where x.nr_atendimento = NEW.nr_atendimento
				and x.IE_TIPO_DIAGNOSTICO = 2
				and x.dt_liberacao is not null
				order by x.dt_liberacao desc
			 ) alias3 LIMIT 1;

		select coalesce(max(1),0)
		into STRICT ie_leito_integrado_w
		from GERINT_EVENTO_INT_DADOS a, GERINT_EVENTO_INTEGRACAO b
		where a.NR_SEQ_EVENTO = b.NR_SEQUENCIA
		and b.ID_EVENTO = '25'
		and a.DS_IDENT_LEITO = (SELECT max(x.nm_leito_integracao) from  unidade_atendimento x where x.nr_seq_interno = NEW.nr_seq_interno)
		and b.nr_atendimento = NEW.nr_atendimento;

		ds_sep_bv_w	:=	obter_separador_bv;

		if (obter_tipo_convenio_atend(NEW.nr_atendimento) = 3) then

			if (ie_prim_movimentacao_w = 'S') then

				if (ie_leito_extra_w = 'S') then --Evento 4: Servi?o de Interna??o em um leito extra
					CALL exec_sql_dinamico_bv('TASY', Gerint_desc_de_para('QUERY'), 	'nm_usuario_p='					|| NEW.nm_usuario  						|| ds_sep_bv_w ||
																				'cd_estabelecimento_p=' 		|| obter_estab_atend(NEW.nr_atendimento) 	|| ds_sep_bv_w ||
																				'id_evento_p=' 					|| '4'				 						|| ds_sep_bv_w ||
																				'nr_atendimento_p=' 			|| NEW.nr_atendimento 						|| ds_sep_bv_w ||
																				'ie_leito_extra_p=' 			|| ie_leito_extra_w 						|| ds_sep_bv_w ||
																				'dt_alta_p=' 					|| null 									|| ds_sep_bv_w ||
																				'ds_motivo_alta_p=' 			|| null 									|| ds_sep_bv_w ||
																				'ds_justif_transferencia_p='	|| null 									|| ds_sep_bv_w ||
																				'nr_seq_solic_internacao_p=' 	|| null 									|| ds_sep_bv_w ||
																				'nr_seq_leito_p=' 				|| nr_seq_leito_w							|| ds_sep_bv_w ||
																				'ds_ident_leito_p='				|| null										|| ds_sep_bv_w ||
																				'nr_seq_classif_p=' 			|| null										|| ds_sep_bv_w ||
																				'ie_status_unidade_p=' 			|| null										|| ds_sep_bv_w ||
																				'nr_cpf_paciente_p=' 			|| null										|| ds_sep_bv_w ||
																				'nr_cartao_sus_p=' 				|| null										|| ds_sep_bv_w ||
																				'cd_cid_p='						|| null										|| ds_sep_bv_w ||
																				'cd_evolucao_p='				|| null);
				else	--Evento 3: Servi?o de Interna??o																	
					CALL exec_sql_dinamico_bv('TASY', Gerint_desc_de_para('QUERY'), 	'nm_usuario_p='					|| NEW.nm_usuario  						|| ds_sep_bv_w ||
																				'cd_estabelecimento_p=' 		|| obter_estab_atend(NEW.nr_atendimento) 	|| ds_sep_bv_w ||
																				'id_evento_p=' 					|| '3'				 						|| ds_sep_bv_w ||
																				'nr_atendimento_p=' 			|| NEW.nr_atendimento 						|| ds_sep_bv_w ||
																				'ie_leito_extra_p=' 			|| ie_leito_extra_w 						|| ds_sep_bv_w ||
																				'dt_alta_p=' 					|| null 									|| ds_sep_bv_w ||
																				'ds_motivo_alta_p=' 			|| null 									|| ds_sep_bv_w ||
																				'ds_justif_transferencia_p='	|| null 									|| ds_sep_bv_w ||
																				'nr_seq_solic_internacao_p=' 	|| null 									|| ds_sep_bv_w ||
																				'nr_seq_leito_p=' 				|| nr_seq_leito_w							|| ds_sep_bv_w ||
																				'ds_ident_leito_p='				|| null										|| ds_sep_bv_w ||
																				'nr_seq_classif_p=' 			|| null										|| ds_sep_bv_w ||
																				'ie_status_unidade_p=' 			|| null										|| ds_sep_bv_w ||
																				'nr_cpf_paciente_p=' 			|| null										|| ds_sep_bv_w ||
																				'nr_cartao_sus_p=' 				|| null										|| ds_sep_bv_w ||
																				'cd_cid_p='						|| null										|| ds_sep_bv_w ||
																				'cd_evolucao_p='				|| null);
				end if;

			else --Evento 6: Servi?o de Transfer?ncia do Leito da Interna??o

				select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END 
				into STRICT	ie_integra_gerint_w
				from	gerint_solic_internacao
				where	nr_atendimento = NEW.nr_atendimento
				and		ie_situacao not in ('L','N');

				if (ie_integra_gerint_w = 'S') and ((coalesce(NEW.ie_passagem_setor,'N') = 'N') or (coalesce(NEW.ie_passagem_setor,'L') = 'L')) then

					if (nr_seq_leito_w > 0) then 	

						CALL exec_sql_dinamico_bv('TASY', Gerint_desc_de_para('QUERY'), 	'nm_usuario_p='					|| NEW.nm_usuario  										|| ds_sep_bv_w ||
																					'cd_estabelecimento_p=' 		|| obter_estab_atend(NEW.nr_atendimento)					|| ds_sep_bv_w ||
																					'id_evento_p=' 					|| '6'				 										|| ds_sep_bv_w ||
																					'nr_atendimento_p=' 			|| NEW.nr_atendimento 										|| ds_sep_bv_w ||
																					'ie_leito_extra_p=' 			|| ie_leito_extra_w	 										|| ds_sep_bv_w ||
																					'dt_alta_p=' 					|| null 													|| ds_sep_bv_w ||
																					'ds_motivo_alta_p=' 			|| null 													|| ds_sep_bv_w ||
																					'ds_justif_transferencia_p='	|| Obter_desc_motivo_transf_pac(NEW.nr_seq_motivo_transf)	|| ds_sep_bv_w ||
																					'nr_seq_solic_internacao_p=' 	|| null 													|| ds_sep_bv_w ||
																					'nr_seq_leito_p=' 				|| nr_seq_leito_w											|| ds_sep_bv_w ||
																					'ds_ident_leito_p='				|| null														|| ds_sep_bv_w ||
																					'nr_seq_classif_p=' 			|| null														|| ds_sep_bv_w ||
																					'ie_status_unidade_p=' 			|| null														|| ds_sep_bv_w ||
																					'nr_cpf_paciente_p=' 			|| null														|| ds_sep_bv_w ||
																					'nr_cartao_sus_p=' 				|| null														|| ds_sep_bv_w ||
																					'cd_cid_p='						|| null														|| ds_sep_bv_w ||
																					'cd_evolucao_p='				|| null);
					end if;
				end if;
			end if;
		else
			if (ie_diagnostico_w = 'S' and ie_gerint_w = 'S') then

				if (ie_existe_diagnostico_w is not null and ie_leito_integrado_w = 0 and ie_prim_movimentacao_w = 'S') then
			--Evento 25: Servico de ocupacao de leito sem solicitacao previa cadastrada no GERINT

					CALL exec_sql_dinamico_bv('TASY', Gerint_desc_de_para('QUERY'), 	'nm_usuario_p='					|| NEW.nm_usuario  						|| ds_sep_bv_w ||
																				'cd_estabelecimento_p=' 		|| obter_estab_atend(NEW.nr_atendimento) 	|| ds_sep_bv_w ||
																				'id_evento_p=' 					|| '25'				 						|| ds_sep_bv_w ||
																				'nr_atendimento_p=' 			|| NEW.nr_atendimento 						|| ds_sep_bv_w ||
																				'ie_leito_extra_p=' 			|| ie_leito_extra_w 						|| ds_sep_bv_w ||
																				'dt_alta_p=' 					|| null 									|| ds_sep_bv_w ||
																				'ds_motivo_alta_p=' 			|| null 									|| ds_sep_bv_w ||
																				'ds_justif_transferencia_p='	|| null 									|| ds_sep_bv_w ||
																				'nr_seq_solic_internacao_p=' 	|| null 									|| ds_sep_bv_w ||
																				'nr_seq_leito_p=' 				|| nr_seq_leito_w							|| ds_sep_bv_w ||
																				'ds_ident_leito_p='				|| null										|| ds_sep_bv_w ||
																				'nr_seq_classif_p=' 			|| null										|| ds_sep_bv_w ||
																				'ie_status_unidade_p=' 			|| null										|| ds_sep_bv_w ||
																				'nr_cpf_paciente_p=' 			|| nr_cpf_medico_w							|| ds_sep_bv_w ||
																				'nr_cartao_sus_p=' 				|| null										|| ds_sep_bv_w ||
																				'cd_cid_p='						|| ie_existe_diagnostico_w					|| ds_sep_bv_w || 		
																				'cd_evolucao_p='				|| null);
				elsif (ie_existe_diagnostico_w is not null and ie_leito_integrado_w > 0 and ie_prim_movimentacao_w = 'N') then
			--Evento 25: Servico de ocupacao de leito sem solicitacao previa cadastrada no GERINT

					CALL exec_sql_dinamico_bv('TASY', Gerint_desc_de_para('QUERY'), 	'nm_usuario_p='					|| NEW.nm_usuario  						|| ds_sep_bv_w ||
																				'cd_estabelecimento_p=' 		|| obter_estab_atend(NEW.nr_atendimento) 	|| ds_sep_bv_w ||
																				'id_evento_p=' 					|| '25'				 						|| ds_sep_bv_w ||
																				'nr_atendimento_p=' 			|| NEW.nr_atendimento 						|| ds_sep_bv_w ||
																				'ie_leito_extra_p=' 			|| ie_leito_extra_w 						|| ds_sep_bv_w ||
																				'dt_alta_p=' 					|| null 									|| ds_sep_bv_w ||
																				'ds_motivo_alta_p=' 			|| null 									|| ds_sep_bv_w ||
																				'ds_justif_transferencia_p='	|| null 									|| ds_sep_bv_w ||
																				'nr_seq_solic_internacao_p=' 	|| null 									|| ds_sep_bv_w ||
																				'nr_seq_leito_p=' 				|| nr_seq_leito_w							|| ds_sep_bv_w ||
																				'ds_ident_leito_p='				|| null										|| ds_sep_bv_w ||
																				'nr_seq_classif_p=' 			|| null										|| ds_sep_bv_w ||
																				'ie_status_unidade_p=' 			|| null										|| ds_sep_bv_w ||
																				'nr_cpf_paciente_p=' 			|| nr_cpf_medico_w							|| ds_sep_bv_w ||
																				'nr_cartao_sus_p=' 				|| null										|| ds_sep_bv_w ||
																				'cd_cid_p='						|| ie_existe_diagnostico_w					|| ds_sep_bv_w || 
																				'cd_evolucao_p='				|| null);
				end if;
			elsif (ie_diagnostico_w = 'N' and ie_gerint_w = 'S') then
			--Evento 25: Servico de ocupacao de leito sem solicitacao previa cadastrada no GERINT

					CALL exec_sql_dinamico_bv('TASY', Gerint_desc_de_para('QUERY'), 	'nm_usuario_p='					|| NEW.nm_usuario  						|| ds_sep_bv_w ||
																				'cd_estabelecimento_p=' 		|| obter_estab_atend(NEW.nr_atendimento) 	|| ds_sep_bv_w ||
																				'id_evento_p=' 					|| '25'				 						|| ds_sep_bv_w ||
																				'nr_atendimento_p=' 			|| NEW.nr_atendimento 						|| ds_sep_bv_w ||
																				'ie_leito_extra_p=' 			|| ie_leito_extra_w 						|| ds_sep_bv_w ||
																				'dt_alta_p=' 					|| null 									|| ds_sep_bv_w ||
																				'ds_motivo_alta_p=' 			|| null 									|| ds_sep_bv_w ||
																				'ds_justif_transferencia_p='	|| null 									|| ds_sep_bv_w ||
																				'nr_seq_solic_internacao_p=' 	|| null 									|| ds_sep_bv_w ||
																				'nr_seq_leito_p=' 				|| nr_seq_leito_w							|| ds_sep_bv_w ||
																				'ds_ident_leito_p='				|| null										|| ds_sep_bv_w ||
																				'nr_seq_classif_p=' 			|| null										|| ds_sep_bv_w ||
																				'ie_status_unidade_p=' 			|| null										|| ds_sep_bv_w ||
																				'nr_cpf_paciente_p=' 			|| nr_cpf_medico_w							|| ds_sep_bv_w ||
																				'nr_cartao_sus_p=' 				|| null										|| ds_sep_bv_w ||
																				'cd_cid_p='						|| null										|| ds_sep_bv_w || 
																				'cd_evolucao_p='				|| null);
			end if;
		end if;
	end if;
/*		I N T E G R A ? ? O  -  G E R I N T  -  F I M		*/


end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_gerint_atend_paciente_unidade() FROM PUBLIC;

CREATE TRIGGER gerint_atend_paciente_unidade
	AFTER INSERT ON atend_paciente_unidade FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_gerint_atend_paciente_unidade();

