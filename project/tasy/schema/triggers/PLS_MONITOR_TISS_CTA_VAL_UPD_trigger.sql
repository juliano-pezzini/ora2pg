-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_monitor_tiss_cta_val_upd ON pls_monitor_tiss_cta_val CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_monitor_tiss_cta_val_upd() RETURNS trigger AS $BODY$
declare

ds_observacao_w	varchar(4000);

BEGIN


	if (pls_se_aplicacao_tasy = 'N') then

		ds_observacao_w := 'Modificação de registro via fora do tasy - Modificação registrada na tabela pls_monitor_tiss_cta_val'||chr(13)||chr(10);

		if (coalesce(OLD.ie_carater_atendimento,'X') <> coalesce(NEW.ie_carater_atendimento,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					' Caráter atendimento: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.ie_carater_atendimento||' - Modificada: '||NEW.ie_carater_atendimento;
		end if;

		if (coalesce(OLD.ie_conta_atualizada,'X') <> coalesce(NEW.ie_conta_atualizada,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Conta atualizada: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.ie_conta_atualizada||' - Modificada: '||NEW.ie_conta_atualizada;
		end if;

		if (coalesce(OLD.ie_glosa,'X') <> coalesce(NEW.ie_glosa,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Glosa: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.ie_glosa||' - Modificada: '||NEW.ie_glosa;
		end if;

		if (coalesce(OLD.ie_identif_prest_exec,'X') <> coalesce(NEW.ie_identif_prest_exec,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Identif prest: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.ie_identif_prest_exec ||' - Modificada: '||NEW.ie_identif_prest_exec;
		end if;

		if (coalesce(OLD.ie_origem_evento,'X') <> coalesce(NEW.ie_origem_evento,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Origem evento: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.ie_origem_evento||' - Modificada: '||NEW.ie_origem_evento;
		end if;

		if (coalesce(OLD.ie_recem_nasc,'X') <> coalesce(NEW.ie_recem_nasc,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Recém nascido: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.ie_recem_nasc||' - Modificada: '||NEW.ie_recem_nasc;
		end if;

		if (coalesce(OLD.ie_reembolso,'X') <> coalesce(NEW.ie_reembolso,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						' ie_reembolso: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.ie_reembolso||' - Modificada: '||NEW.ie_reembolso;
		end if;

		if (coalesce(OLD.ie_status,'X') <> coalesce(NEW.ie_status,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'ie_status: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.ie_status||' - Modificada: '||NEW.ie_status;
		end if;

		if (coalesce(OLD.cd_guia_operadora,'X') <> coalesce(NEW.cd_guia_operadora,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Guia operadora: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.cd_guia_operadora||' - Modificada: '||NEW.cd_guia_operadora;
		end if;

		if (coalesce(OLD.cd_guia_prestador,'X') <> coalesce(NEW.cd_guia_prestador,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Guia prestador: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.cd_guia_prestador||' - Modificada: '||NEW.cd_guia_prestador;
		end if;

		if (coalesce(OLD.cd_guia_principal,'X') <> coalesce(NEW.cd_guia_principal,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Guia principal: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.cd_guia_principal||' - Modificada: '||NEW.cd_guia_principal;
		end if;

		if (coalesce(OLD.cd_guia_sadt_princ,'X') <> coalesce(NEW.cd_guia_sadt_princ,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Guia SADT princ: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.cd_guia_sadt_princ||' - Modificada: '||NEW.cd_guia_sadt_princ;
		end if;

		if (OLD.nr_seq_conta <> NEW.nr_seq_conta) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Seq conta: '||chr(13)||chr(10)||
						chr(9)||'Anterior: '|| OLD.nr_seq_conta||' - Modificada: '||NEW.nr_seq_conta;
		end if;


		insert into pls_monitor_log_lote(nr_sequencia, ds_log, dt_atualizacao , dt_atualizacao_nrec,
											nm_usuario, nm_usuario_nrec, nr_seq_lote  )
		values (nextval('pls_monitor_log_lote_seq'), ds_observacao_w, LOCALTIMESTAMP, LOCALTIMESTAMP,
				NEW.nm_usuario, NEW.nm_usuario, NEW.nr_seq_conta);


	end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_monitor_tiss_cta_val_upd() FROM PUBLIC;

CREATE TRIGGER pls_monitor_tiss_cta_val_upd
	BEFORE UPDATE ON pls_monitor_tiss_cta_val FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_monitor_tiss_cta_val_upd();

