-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS ordem_compra_item_entrega_log ON ordem_compra_item_entrega CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_ordem_compra_item_entrega_log() RETURNS trigger AS $BODY$
declare

dt_liberacao_w ordem_compra.dt_liberacao%type;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

	select dt_liberacao
	into STRICT dt_liberacao_w
	from ordem_compra
	where nr_ordem_compra = coalesce(NEW.nr_ordem_compra,OLD.nr_ordem_compra);

	if (dt_liberacao_w is not null) then
	
		if (TG_OP = 'INSERT') then
			CALL grava_log_tasy(360, substr('INSERT -' ||
			                           ' nr_ordem_compra: ' || NEW.nr_ordem_compra ||
			                           ' nr_item_oci: ' || NEW.nr_item_oci ||
			                           ' nr_sequencia: ' || NEW.nr_sequencia ||
			                           ' qt_prevista_entrega: ' || NEW.qt_prevista_entrega ||
			                           ' dt_prevista_entrega: ' || to_char(NEW.dt_prevista_entrega, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' qt_real_entrega: ' || NEW.qt_real_entrega ||
			                           ' dt_real_entrega: ' || to_char(NEW.dt_real_entrega, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_entrega_original: ' || to_char(NEW.dt_entrega_original, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_entrega_limite: ' || to_char(NEW.dt_entrega_limite, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_baixa: ' || to_char(NEW.dt_baixa, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_cancelamento: ' || to_char(NEW.dt_cancelamento, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' ie_cancelada_inspecao: ' || NEW.ie_cancelada_inspecao ||
			                           ' ds_observacao: ' || NEW.ds_observacao ||
			                           ' dt_atualizacao: ' || to_char(NEW.dt_atualizacao, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' nm_usuario: ' || NEW.nm_usuario ||
			                           ' call_stack: ' || dbms_utility.format_call_stack,1,2000), wheb_usuario_pck.get_nm_usuario);
		elsif (TG_OP = 'UPDATE') then
			CALL grava_log_tasy(360, substr('UPDATE -' ||
			                           ' nr_ordem_compra: ' || NEW.nr_ordem_compra ||
			                           ' nr_item_oci: ' || NEW.nr_item_oci ||
			                           ' nr_sequencia: ' || NEW.nr_sequencia ||
			                           ' qt_prevista_entrega: ' || NEW.qt_prevista_entrega ||
			                           ' qt_prevista_entrega_old: ' || OLD.qt_prevista_entrega ||
			                           ' dt_prevista_entrega: ' || to_char(NEW.dt_prevista_entrega, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_prevista_entrega_old: ' || to_char(OLD.dt_prevista_entrega, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' qt_real_entrega: ' || NEW.qt_real_entrega ||
			                           ' qt_real_entrega_old: ' || OLD.qt_real_entrega ||
			                           ' dt_real_entrega: ' || to_char(NEW.dt_real_entrega, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_real_entrega_old: ' || to_char(OLD.dt_real_entrega, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_entrega_original: ' || to_char(NEW.dt_entrega_original, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_entrega_original_old: ' || to_char(OLD.dt_entrega_original, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_entrega_limite: ' || to_char(NEW.dt_entrega_limite, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_entrega_limite_old: ' || to_char(OLD.dt_entrega_limite, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_baixa: ' || to_char(NEW.dt_baixa, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_baixa_old: ' || to_char(OLD.dt_baixa, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_cancelamento: ' || to_char(NEW.dt_cancelamento, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_cancelamento_old: ' || to_char(OLD.dt_cancelamento, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' ie_cancelada_inspecao: ' || NEW.ie_cancelada_inspecao ||
			                           ' ie_cancelada_inspecao_old: ' || OLD.ie_cancelada_inspecao ||
			                           ' ds_observacao: ' || NEW.ds_observacao ||
			                           ' ds_observacao_old: ' || OLD.ds_observacao ||
			                           ' dt_atualizacao: ' || to_char(NEW.dt_atualizacao, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_atualizacao_old: ' || to_char(OLD.dt_atualizacao, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' nm_usuario: ' || NEW.nm_usuario ||
			                           ' nm_usuario_old: ' || OLD.nm_usuario ||
			                           ' call_stack: ' || dbms_utility.format_call_stack,1,2000), wheb_usuario_pck.get_nm_usuario);
		elsif (TG_OP = 'DELETE') then
			CALL grava_log_tasy(360, substr('DELETE -' ||
			                           ' nr_ordem_compra: ' || OLD.nr_ordem_compra ||
			                           ' nr_item_oci: ' || OLD.nr_item_oci ||
			                           ' nr_sequencia: ' || OLD.nr_sequencia ||
			                           ' qt_prevista_entrega: ' || OLD.qt_prevista_entrega ||
			                           ' dt_prevista_entrega: ' || to_char(OLD.dt_prevista_entrega, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' qt_real_entrega: ' || OLD.qt_real_entrega ||
			                           ' dt_real_entrega: ' || to_char(OLD.dt_real_entrega, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_entrega_original: ' || to_char(OLD.dt_entrega_original, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_entrega_limite: ' || to_char(OLD.dt_entrega_limite, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_baixa: ' || to_char(OLD.dt_baixa, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' dt_cancelamento: ' || to_char(OLD.dt_cancelamento, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' ie_cancelada_inspecao: ' || OLD.ie_cancelada_inspecao ||
			                           ' ds_observacao: ' || OLD.ds_observacao ||
			                           ' dt_atualizacao: ' || to_char(OLD.dt_atualizacao, 'dd/mm/yyyy hh24:mi:ss') ||
			                           ' nm_usuario: ' || OLD.nm_usuario ||
			                           ' call_stack: ' || dbms_utility.format_call_stack,1,2000), wheb_usuario_pck.get_nm_usuario);
		end if;
		
	end if;

end if;

IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_ordem_compra_item_entrega_log() FROM PUBLIC;

CREATE TRIGGER ordem_compra_item_entrega_log
	AFTER INSERT OR UPDATE OR DELETE ON ordem_compra_item_entrega FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_ordem_compra_item_entrega_log();

