-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS part_carta_medica_update ON participante_carta_medica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_part_carta_medica_update() RETURNS trigger AS $BODY$
declare
nr_seq_regra_w	wl_regra_item.nr_sequencia%type;

BEGIN			
	if ((NEW.dt_assinatura is not null
		and OLD.dt_assinatura is not null
		and NEW.dt_assinatura != OLD.dt_assinatura)
		or (NEW.dt_assinatura is not null
			and OLD.dt_assinatura is null)) then
		if (obter_permissao_ass_med(NEW.nm_usuario_resp, NEW.nm_usuario, 'S') = 'S') then
			NEW.nm_usuario_assinat := NEW.nm_usuario;
		end if;	
	elsif (NEW.dt_assinatura is null
			and OLD.dt_assinatura is not null) then
		NEW.nm_usuario_assinat := null;	
	end if;	

	if (NEW.dt_assinatura is not null and OLD.dt_assinatura is null) then
		select	max(a.nr_seq_regra)
		into STRICT	nr_seq_regra_w
		from	wl_worklist a,
				wl_item b,
				wl_regra_item c
		where	a.nr_seq_carta_mae = NEW.nr_seq_carta_mae
		and		b.nr_sequencia = a.nr_seq_item
		and		c.nr_sequencia = a.nr_seq_regra
		and		a.dt_final_real is null
		and		b.cd_categoria = 'ML'
		and		c.ie_tipo_pend_carta = 'A'
		and		b.ie_situacao = 'A'
		and		c.ie_situacao = 'A';

		CALL wl_gerar_finalizar_tarefa('ML','F',null,null,wheb_usuario_pck.get_nm_usuario,null,'N',null,null,null,null,null,NEW.nr_seq_carta_mae,null,null,null,nr_seq_regra_w,
									null,null,null,null,null,null,null,null,null,null,obter_pf_usuario(NEW.nm_usuario_resp,'C'));
	end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_part_carta_medica_update() FROM PUBLIC;

CREATE TRIGGER part_carta_medica_update
	BEFORE UPDATE ON participante_carta_medica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_part_carta_medica_update();

