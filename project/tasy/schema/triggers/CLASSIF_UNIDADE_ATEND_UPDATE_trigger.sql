-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS classif_unidade_atend_update ON classif_unidade_atend CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_classif_unidade_atend_update() RETURNS trigger AS $BODY$
declare
ie_possui_registro_w	bigint;
ds_setor_atendimento_w	varchar(255);
ds_setor_setor_msg_w	varchar(4000);
cd_setor_atendimento_w	bigint;
ie_acao_inativar_unidade_w	varchar(1);

C01 CURSOR FOR
		SELECT	distinct(cd_setor_atendimento),
				substr(obter_nome_setor(cd_setor_atendimento),1,40)
		from	unidade_atendimento
		where	nr_seq_classif = NEW.nr_sequencia;

BEGIN

ie_acao_inativar_unidade_w := Obter_param_Usuario(1, 27, obter_perfil_ativo, NEW.nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_acao_inativar_unidade_w);

if (NEW.ie_situacao <> OLD.ie_situacao) and (NEW.ie_situacao = 'I') then
	select	count(*)
	into STRICT	ie_possui_registro_w
	from	unidade_atendimento
	where	nr_seq_classif = NEW.nr_sequencia;

	if (coalesce(ie_possui_registro_w,0) > 0) then
		open C01;
		loop
		fetch C01 into
			cd_setor_atendimento_w,
			ds_setor_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			BEGIN
			ds_setor_setor_msg_w	:= ds_setor_setor_msg_w||', '||ds_setor_atendimento_w;
			end;
		end loop;
		if (ie_acao_inativar_unidade_w <> 'N') then
			if (ie_acao_inativar_unidade_w = 'B') then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(242734,'DS_SETOR_ATEND=' ||substr(ds_setor_setor_msg_w,2,4000));
			elsif (ie_acao_inativar_unidade_w = 'A') then
				update	unidade_atendimento
				set		nr_seq_classif  = NULL
				where	nr_seq_classif = NEW.nr_sequencia;
			end if;
		end if;
		close C01;
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_classif_unidade_atend_update() FROM PUBLIC;

CREATE TRIGGER classif_unidade_atend_update
	BEFORE UPDATE ON classif_unidade_atend FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_classif_unidade_atend_update();

