-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atendimento_visita_forponto ON atendimento_visita CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atendimento_visita_forponto() RETURNS trigger AS $BODY$
DECLARE
    json_w                          PHILIPS_JSON;
    json_data_w                     text;

    company_code_w                  ATENDIMENTO_VISITA.cd_empresa%TYPE;
    natural_person_code_w           ATENDIMENTO_VISITA.cd_pessoa_fisica%TYPE;
    section_code_w                  ATENDIMENTO_VISITA.cd_setor_atendimento%TYPE;
    notes_w                         ATENDIMENTO_VISITA.ds_observacao%TYPE;
    last_updated_date_w             ATENDIMENTO_VISITA.dt_atualizacao%TYPE;
    last_updated_nrec_date_w        ATENDIMENTO_VISITA.dt_atualizacao_nrec%TYPE;
    entry_date_w                    ATENDIMENTO_VISITA.dt_entrada%TYPE;
    accurate_entry_date_w           ATENDIMENTO_VISITA.dt_entrada_real%TYPE;
    access_release_date_w           ATENDIMENTO_VISITA.dt_liberacao_acesso%TYPE;
    birth_date_w                    ATENDIMENTO_VISITA.dt_nascimento%TYPE;
    departure_date_w                ATENDIMENTO_VISITA.dt_saida%TYPE;
    accurate_departure_date_w       ATENDIMENTO_VISITA.dt_saida_real%TYPE;
    gender_code_w                   ATENDIMENTO_VISITA.ie_sexo%TYPE;
    last_updated_by_w               ATENDIMENTO_VISITA.nm_usuario%TYPE;
    last_updated_nrec_by_w          ATENDIMENTO_VISITA.nm_usuario_nrec%TYPE;
    departure_by_w                  ATENDIMENTO_VISITA.nm_usuario_saida%TYPE;
    guest_name_w                    ATENDIMENTO_VISITA.nm_visitante%TYPE;
    encounter_number_w              ATENDIMENTO_VISITA.nr_atendimento%TYPE;
    access_control_number_w         ATENDIMENTO_VISITA.nr_controle_acesso%TYPE;
    phone_dd_w                      ATENDIMENTO_VISITA.nr_ddi_telefone%TYPE;
    civil_id_w                      ATENDIMENTO_VISITA.nr_identidade%TYPE;
    control_number_w                ATENDIMENTO_VISITA.nr_seq_controle%TYPE;
    type_number_w                   ATENDIMENTO_VISITA.nr_seq_tipo%TYPE;
    phone_number_w                  ATENDIMENTO_VISITA.nr_telefone%TYPE;
    action_w                        varchar(1);
    guest_type_w                    varchar(1);

PRAGMA AUTONOMOUS_TRANSACTION;

BEGIN
    IF (
        wheb_usuario_pck.get_ie_executar_trigger = 'S'
        AND wheb_usuario_pck.get_nm_usuario IS NOT NULL
        AND obter_parametro_funcao(8014, 93, obter_usuario_ativo) <> 'P'
    ) THEN

        IF (TG_OP = 'INSERT') THEN
            company_code_w                  := NEW.cd_empresa;
            natural_person_code_w           := NEW.cd_pessoa_fisica;
            section_code_w                  := NEW.cd_setor_atendimento;
            notes_w                         := NEW.ds_observacao;
            last_updated_date_w             := NEW.dt_atualizacao;
            last_updated_nrec_date_w        := NEW.dt_atualizacao_nrec;
            entry_date_w                    := NEW.dt_entrada;
            accurate_entry_date_w           := NEW.dt_entrada_real;
            access_release_date_w           := NEW.dt_liberacao_acesso;
            birth_date_w                    := NEW.dt_nascimento;
            departure_date_w                := NEW.dt_saida;
            accurate_departure_date_w       := NEW.dt_saida_real;
            gender_code_w                   := NEW.ie_sexo;
            last_updated_by_w               := NEW.nm_usuario;
            last_updated_nrec_by_w          := NEW.nm_usuario_nrec;
            departure_by_w                  := NEW.nm_usuario_saida;
            guest_name_w                    := NEW.nm_visitante;
            encounter_number_w              := NEW.nr_atendimento;
            access_control_number_w         := NEW.nr_controle_acesso;
            phone_dd_w                      := NEW.nr_ddi_telefone;
            civil_id_w                      := NEW.nr_identidade;
            control_number_w                := NEW.nr_seq_controle;
            type_number_w                   := NEW.nr_seq_tipo;
            phone_number_w                  := NEW.nr_telefone;
            action_w                        := 'I';
        ELSE
            company_code_w                  := OLD.cd_empresa;
            natural_person_code_w           := OLD.cd_pessoa_fisica;
            section_code_w                  := OLD.cd_setor_atendimento;
            notes_w                         := OLD.ds_observacao;
            last_updated_date_w             := OLD.dt_atualizacao;
            last_updated_nrec_date_w        := OLD.dt_atualizacao_nrec;
            entry_date_w                    := OLD.dt_entrada;
            accurate_entry_date_w           := OLD.dt_entrada_real;
            access_release_date_w           := OLD.dt_liberacao_acesso;
            birth_date_w                    := OLD.dt_nascimento;
            departure_date_w                := OLD.dt_saida;
            accurate_departure_date_w       := OLD.dt_saida_real;
            gender_code_w                   := OLD.ie_sexo;
            last_updated_by_w               := OLD.nm_usuario;
            last_updated_nrec_by_w          := OLD.nm_usuario_nrec;
            departure_by_w                  := OLD.nm_usuario_saida;
            guest_name_w                    := OLD.nm_visitante;
            encounter_number_w              := OLD.nr_atendimento;
            access_control_number_w         := OLD.nr_controle_acesso;
            phone_dd_w                      := OLD.nr_ddi_telefone;
            civil_id_w                      := OLD.nr_identidade;
            control_number_w                := OLD.nr_seq_controle;
            type_number_w                   := OLD.nr_seq_tipo;
            phone_number_w                  := OLD.nr_telefone;
            action_w                        := 'D';
        END IF;

        IF (control_number_w IS NOT NULL) THEN
          guest_type_w := 'V';

          json_w := philips_json();
          json_w.put('companyCode', company_code_w);
          json_w.put('naturalPersonCode', natural_person_code_w);
          json_w.put('sectionCode', section_code_w);
          json_w.put('notes', notes_w);
          json_w.put('lastUpdatedDate', last_updated_date_w);
          json_w.put('lastUpdatedNrecDate', last_updated_nrec_date_w);
          json_w.put('entryDate', entry_date_w);
          json_w.put('accurateEntryDate', accurate_entry_date_w);
          json_w.put('accessReleaseDate', access_release_date_w);
          json_w.put('birthDate', birth_date_w);
          json_w.put('departureDate', departure_date_w);
          json_w.put('accurateDepartureDate', accurate_departure_date_w);
          json_w.put('genderCode', gender_code_w);
          json_w.put('lastUpdatedBy', last_updated_by_w);
          json_w.put('lastUpdatedNrecBy', last_updated_nrec_by_w);
          json_w.put('departureBy', departure_by_w);
          json_w.put('guestName', guest_name_w);
          json_w.put('encounterNumber', encounter_number_w);
          json_w.put('accessControlNumber', access_control_number_w);
          json_w.put('phoneDd', phone_dd_w);
          json_w.put('civilId', civil_id_w);
          json_w.put('fiscalId', OBTER_CPF_PESSOA_FISICA(natural_person_code_w));
          json_w.put('controlNumber', control_number_w);
          json_w.put('typeNumber', type_number_w);
          json_w.put('phoneNumber', phone_number_w);
          json_w.put('guestType', guest_type_w);
          json_w.put('action', action_w);

          DBMS_LOB.CREATETEMPORARY(json_data_w, true);
          json_w.(json_data_w);

          json_data_w := bifrost.send_integration_content('forponto.send.request', json_data_w, wheb_usuario_pck.get_nm_usuario);
        END IF;
    END IF;
IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atendimento_visita_forponto() FROM PUBLIC;

CREATE TRIGGER atendimento_visita_forponto
	AFTER INSERT OR DELETE ON atendimento_visita FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atendimento_visita_forponto();

