-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS compl_pessoa_fisica_afterup ON compl_pessoa_fisica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_compl_pessoa_fisica_afterup() RETURNS trigger AS $BODY$
declare
reg_integracao_p		gerar_int_padrao.reg_integracao;
ie_existe_medico_p		bigint := 0;
nr_identidade_w				varchar(15);
nm_pessoa_fisica_w			varchar(60);
nr_telefone_celular_w			varchar(40);
ie_grau_instrucao_w			smallint;
nr_cep_cidade_nasc_w			varchar(15);
nr_prontuario_w				bigint;
cd_religiao_w				integer;
nr_pis_pasep_w				varchar(11);
cd_nacionalidade_w			varchar(8);
ie_dependencia_sus_w			varchar(1);
qt_altura_cm_w				real;
ie_tipo_sangue_w				varchar(2);
ie_fator_rh_w				varchar(1);
dt_nascimento_w				timestamp;
dt_obito_w				timestamp;
ie_sexo_w				varchar(1);
nr_iss_w					varchar(20);
ie_estado_civil_w				varchar(2);
nr_inss_w					varchar(20);
nr_cpf_w					varchar(11);
nr_cert_nasc_w				varchar(255);
cd_cargo_w				bigint;
nr_cert_casamento_w			varchar(255);
ds_codigo_prof_w				varchar(15);
cd_empresa_w				smallint;
ie_funcionario_w				varchar(1);
nr_seq_cor_pele_w				bigint;
ds_orgao_emissor_ci_w			pessoa_fisica.ds_orgao_emissor_ci%type;
nr_cartao_nac_sus_w			varchar(20);
cd_cbo_sus_w				integer;
cd_atividade_sus_w			smallint;
ie_vinculo_sus_w				smallint;
cd_estabelecimento_w			smallint;
cd_sistema_ant_w				varchar(20);
ie_frequenta_escola_w			varchar(1);
cd_funcionario_w        varchar(15);
nr_pager_bip_w        varchar(25);
nr_transacao_sus_w      varchar(20);
cd_medico_w        varchar(10);
ie_tipo_prontuario_w      smallint;
dt_emissao_ci_w        timestamp;
nr_seq_conselho_w        bigint;
dt_admissao_hosp_w      timestamp;
ie_fluencia_portugues_w      varchar(5);
nr_titulo_eleitor_w        varchar(20);
nr_zona_w        varchar(5);
nr_secao_w        varchar(15);
nr_cartao_estrangeiro_w      varchar(30);
nr_reg_geral_estrang_w      varchar(30);
dt_chegada_brasil_w      timestamp;
sg_emissora_ci_w        varchar(2);
dt_naturalizacao_pf_w      timestamp;
nr_ctps_w        pessoa_fisica.nr_ctps%type;
nr_serie_ctps_w        pessoa_fisica.nr_serie_ctps%type;
uf_emissora_ctps_w      pessoa_fisica.uf_emissora_ctps%type;
dt_emissao_ctps_w        timestamp;
nr_portaria_nat_w        varchar(16);
nr_seq_cartorio_nasc_w      bigint;
nr_seq_cartorio_casamento_w    bigint;
dt_emissao_cert_nasc_w      timestamp;
dt_emissao_cert_casamento_w    timestamp;
nr_livro_cert_nasc_w      bigint;
nr_livro_cert_casamento_w      bigint;
dt_cadastro_original_w      timestamp;
nr_folha_cert_nasc_w      bigint;
nr_folha_cert_casamento_w      bigint;
nr_same_w        bigint;
ds_observacao_w        varchar(2000);
qt_dependente_w        smallint;
nr_transplante_w        bigint;
dt_validade_rg_w        timestamp;
dt_revisao_w        timestamp;
dt_demissao_hosp_w      timestamp;
cd_puericultura_w        integer;
cd_cnes_w        varchar(20);
ds_apelido_w        varchar(60);
ie_endereco_correspondencia_w    smallint;
qt_peso_nasc_w        real;
uf_conselho_w        pessoa_fisica.uf_conselho%type;
nm_abreviado_w        varchar(80);
nr_ccm_w        bigint;
dt_fim_experiencia_w      timestamp;
dt_validade_conselho_w      timestamp;
ds_profissao_w        varchar(255);
ds_empresa_pf_w        varchar(255);
nr_passaporte_w        varchar(255);
nr_cnh_w          varchar(255);
nr_cert_militar_w        varchar(255);
nr_pront_ext_w        varchar(100);
ie_escolaridade_cns_w      varchar(10);
ie_situacao_conj_cns_w      varchar(10);
nr_folha_cert_div_w      bigint;
nr_cert_divorcio_w        varchar(20);
nr_seq_cartorio_divorcio_w      bigint;
dt_emissao_cert_divorcio_w      timestamp;
nr_livro_cert_divorcio_w      bigint;
dt_alta_institucional_w      timestamp;
dt_transplante_w        timestamp;
nr_matricula_nasc_w      varchar(32);
ie_doador_w        varchar(15);
dt_vencimento_cnh_w      timestamp;
ds_categoria_cnh_w      varchar(30);
qt_existe_w        bigint;
ie_opcao_w        varchar(1) := 'A';
ie_estab_prontuario_w varchar(30);

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

select  count(*)
into STRICT  qt_existe_w
from  sup_parametro_integracao a,
  sup_int_regra_pf b
where  a.nr_sequencia = b.nr_seq_integracao
and  a.ie_evento = 'PF'
and  a.ie_forma = 'E'
and  a.ie_situacao = 'A'
and  b.ie_situacao = 'A';

if (qt_existe_w > 0) and (NEW.nm_usuario <> 'INTEGR_TASY') then

  select  nr_identidade,
    substr(obter_nome_pf(NEW.cd_pessoa_fisica),1,60),
    nr_telefone_celular,
    ie_grau_instrucao,
    nr_cep_cidade_nasc,
    nr_prontuario,
    cd_religiao,
    nr_pis_pasep,
    cd_nacionalidade,
    ie_dependencia_sus,
    qt_altura_cm,
    ie_tipo_sangue,
    ie_fator_rh,
    dt_nascimento,
    dt_obito,
    ie_sexo,
    nr_iss,
    ie_estado_civil,
    nr_inss,
    nr_cpf,
    nr_cert_nasc,
    cd_cargo,
    nr_cert_casamento,
    ds_codigo_prof,
    cd_empresa,
    ie_funcionario,
    nr_seq_cor_pele,
    ds_orgao_emissor_ci,
    nr_cartao_nac_sus,
    cd_cbo_sus,
    cd_atividade_sus,
    ie_vinculo_sus,
    cd_sistema_ant,
    ie_frequenta_escola,
    cd_funcionario,
    nr_pager_bip,
    nr_transacao_sus,
    cd_medico,
    ie_tipo_prontuario,
    dt_emissao_ci,
    nr_seq_conselho,
    dt_admissao_hosp,
    ie_fluencia_portugues,
    nr_titulo_eleitor,
    nr_zona,
    nr_secao,
    nr_cartao_estrangeiro,
    nr_reg_geral_estrang,
    dt_chegada_brasil,
    sg_emissora_ci,
    dt_naturalizacao_pf,
    nr_ctps,
    nr_serie_ctps,
    uf_emissora_ctps,
    dt_emissao_ctps,
    nr_portaria_nat,
    nr_seq_cartorio_nasc,
    nr_seq_cartorio_casamento,
    dt_emissao_cert_nasc,
    dt_emissao_cert_casamento,
    nr_livro_cert_nasc,
    nr_livro_cert_casamento,
    dt_cadastro_original,
    nr_folha_cert_nasc,
    nr_folha_cert_casamento,
    nr_same,
    ds_observacao,
    qt_dependente,
    nr_transplante,
    dt_validade_rg,
    dt_revisao,
    dt_demissao_hosp,
    cd_puericultura,
    cd_cnes,
    ds_apelido,
    ie_endereco_correspondencia,
    qt_peso_nasc,
    uf_conselho,
    nm_abreviado,
    nr_ccm,
    dt_fim_experiencia,
    dt_validade_conselho,
    ds_profissao,
    ds_empresa_pf,
    nr_passaporte,
    nr_cnh,
    nr_cert_militar,
    nr_pront_ext,
    ie_escolaridade_cns,
    ie_situacao_conj_cns,
    nr_folha_cert_div,
    nr_cert_divorcio,
    nr_seq_cartorio_divorcio,
    dt_emissao_cert_divorcio,
    nr_livro_cert_divorcio,
    dt_alta_institucional,
    dt_transplante,
    nr_matricula_nasc,
    ie_doador,
    dt_vencimento_cnh,
    ds_categoria_cnh
  into STRICT  nr_identidade_w,
    nm_pessoa_fisica_w,
    nr_telefone_celular_w,
    ie_grau_instrucao_w,
    nr_cep_cidade_nasc_w,
    nr_prontuario_w,
    cd_religiao_w,
    nr_pis_pasep_w,
    cd_nacionalidade_w,
    ie_dependencia_sus_w,
    qt_altura_cm_w,
    ie_tipo_sangue_w,
    ie_fator_rh_w,
    dt_nascimento_w,
    dt_obito_w,
    ie_sexo_w,
    nr_iss_w,
    ie_estado_civil_w,
    nr_inss_w,
    nr_cpf_w,
    nr_cert_nasc_w,
    cd_cargo_w,
    nr_cert_casamento_w,
    ds_codigo_prof_w,
    cd_empresa_w,
    ie_funcionario_w,
    nr_seq_cor_pele_w,
    ds_orgao_emissor_ci_w,
    nr_cartao_nac_sus_w,
    cd_cbo_sus_w,
    cd_atividade_sus_w,
    ie_vinculo_sus_w,
    cd_sistema_ant_w,
    ie_frequenta_escola_w,
    cd_funcionario_w,
    nr_pager_bip_w,
    nr_transacao_sus_w,
    cd_medico_w,
    ie_tipo_prontuario_w,
    dt_emissao_ci_w,
    nr_seq_conselho_w,
    dt_admissao_hosp_w,
    ie_fluencia_portugues_w,
    nr_titulo_eleitor_w,
    nr_zona_w,
    nr_secao_w,
    nr_cartao_estrangeiro_w,
    nr_reg_geral_estrang_w,
    dt_chegada_brasil_w,
    sg_emissora_ci_w,
    dt_naturalizacao_pf_w,
    nr_ctps_w,
    nr_serie_ctps_w,
    uf_emissora_ctps_w,
    dt_emissao_ctps_w,
    nr_portaria_nat_w,
    nr_seq_cartorio_nasc_w,
    nr_seq_cartorio_casamento_w,
    dt_emissao_cert_nasc_w,
    dt_emissao_cert_casamento_w,
    nr_livro_cert_nasc_w,
    nr_livro_cert_casamento_w,
    dt_cadastro_original_w,
    nr_folha_cert_nasc_w,
    nr_folha_cert_casamento_w,
    nr_same_w,
    ds_observacao_w,
    qt_dependente_w,
    nr_transplante_w,
    dt_validade_rg_w,
    dt_revisao_w,
    dt_demissao_hosp_w,
    cd_puericultura_w,
    cd_cnes_w,
    ds_apelido_w,
    ie_endereco_correspondencia_w,
    qt_peso_nasc_w,
    uf_conselho_w,
    nm_abreviado_w,
    nr_ccm_w,
    dt_fim_experiencia_w,
    dt_validade_conselho_w,
    ds_profissao_w,
    ds_empresa_pf_w,
    nr_passaporte_w,
    nr_cnh_w,
    nr_cert_militar_w,
    nr_pront_ext_w,
    ie_escolaridade_cns_w,
    ie_situacao_conj_cns_w,
    nr_folha_cert_div_w,
    nr_cert_divorcio_w,
    nr_seq_cartorio_divorcio_w,
    dt_emissao_cert_divorcio_w,
    nr_livro_cert_divorcio_w,
    dt_alta_institucional_w,
    dt_transplante_w,
    nr_matricula_nasc_w,
    ie_doador_w,
    dt_vencimento_cnh_w,
    ds_categoria_cnh_w
  from  pessoa_fisica
  where  cd_pessoa_fisica = NEW.cd_pessoa_fisica;

  ie_estab_prontuario_w := Obter_param_Usuario(0, 120, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1), ie_estab_prontuario_w);

  if (ie_estab_prontuario_w = 'ESTAB') then
	nr_prontuario_w := obter_prontuario_estab(NEW.cd_pessoa_fisica);	
  end if;


  CALL envia_sup_int_pf(
    NEW.cd_pessoa_fisica,
    nr_identidade_w,
    nm_pessoa_fisica_w,
    nr_telefone_celular_w,
    ie_grau_instrucao_w,
    nr_cep_cidade_nasc_w,
    nr_prontuario_w,
    NEW.nm_usuario,
    cd_religiao_w,
    nr_pis_pasep_w,
    cd_nacionalidade_w,
    ie_dependencia_sus_w,
    qt_altura_cm_w,
    ie_tipo_sangue_w,
    ie_fator_rh_w,
    dt_nascimento_w,
    dt_obito_w,
    ie_sexo_w,
    nr_iss_w,
    ie_estado_civil_w,
    nr_inss_w,
    nr_cpf_w,
    nr_cert_nasc_w,
    cd_cargo_w,
    nr_cert_casamento_w,
    ds_codigo_prof_w,
    cd_empresa_w,
    ie_funcionario_w,
    nr_seq_cor_pele_w,
    ds_orgao_emissor_ci_w,
    nr_cartao_nac_sus_w,
    cd_cbo_sus_w,
    cd_atividade_sus_w,
    ie_vinculo_sus_w,
    cd_sistema_ant_w,
    ie_frequenta_escola_w,
    cd_funcionario_w,
    nr_pager_bip_w,
    nr_transacao_sus_w,
    cd_medico_w,
    ie_tipo_prontuario_w,
    dt_emissao_ci_w,
    nr_seq_conselho_w,
    dt_admissao_hosp_w,
    ie_fluencia_portugues_w,
    nr_titulo_eleitor_w,
    nr_zona_w,
    nr_secao_w,
    nr_cartao_estrangeiro_w,
    nr_reg_geral_estrang_w,
    dt_chegada_brasil_w,
    sg_emissora_ci_w,
    dt_naturalizacao_pf_w,
    nr_ctps_w,
    nr_serie_ctps_w,
    uf_emissora_ctps_w,
    dt_emissao_ctps_w,
    nr_portaria_nat_w,
    nr_seq_cartorio_nasc_w,
    nr_seq_cartorio_casamento_w,
    dt_emissao_cert_nasc_w,
    dt_emissao_cert_casamento_w,
    nr_livro_cert_nasc_w,
    nr_livro_cert_casamento_w,
    dt_cadastro_original_w,
    nr_folha_cert_nasc_w,
    nr_folha_cert_casamento_w,
    nr_same_w,
    ds_observacao_w,
    qt_dependente_w,
    nr_transplante_w,
    dt_validade_rg_w,
    dt_revisao_w,
    dt_demissao_hosp_w,
    cd_puericultura_w,
    cd_cnes_w,
    ds_apelido_w,
    ie_endereco_correspondencia_w,
    qt_peso_nasc_w,
    uf_conselho_w,
    nm_abreviado_w,
    nr_ccm_w,
    dt_fim_experiencia_w,
    dt_validade_conselho_w,
    ds_profissao_w,
    ds_empresa_pf_w,
    nr_passaporte_w,
    nr_cnh_w,
    nr_cert_militar_w,
    nr_pront_ext_w,
    ie_escolaridade_cns_w,
    ie_situacao_conj_cns_w,
    nr_folha_cert_div_w,
    nr_cert_divorcio_w,
    nr_seq_cartorio_divorcio_w,
    dt_emissao_cert_divorcio_w,
    nr_livro_cert_divorcio_w,
    dt_alta_institucional_w,
    dt_transplante_w,
    nr_matricula_nasc_w,
    ie_doador_w,
    dt_vencimento_cnh_w,
    ds_categoria_cnh_w,

    NEW.nm_contato,
    NEW.ds_endereco,
    NEW.cd_cep,
    NEW.nr_endereco,
    NEW.ds_complemento,
    NEW.ds_municipio,
    substr(NEW.ds_bairro,1,40),
    NEW.sg_estado,
    NEW.nr_telefone,
    NEW.nr_ramal,
    NEW.ds_fone_adic,
    NEW.ds_email,
    NEW.cd_profissao,
    NEW.cd_empresa_refer,
    NEW.ds_setor_trabalho,
    NEW.ds_horario_trabalho,
    NEW.nr_matricula_trabalho,
    NEW.cd_municipio_ibge,
    NEW.ds_fax,
    NEW.cd_tipo_logradouro,
    NEW.nr_ddd_telefone,
    NEW.nr_ddi_telefone,
    NEW.nr_ddi_fax,
    NEW.nr_ddd_fax,
    NEW.ds_website,
    NEW.nm_contato_pesquisa,
    NEW.ie_tipo_complemento);
end if;

reg_integracao_p.ie_operacao    :=  'A';
reg_integracao_p.nr_prontuario       :=   nr_prontuario_w;
reg_integracao_p.cd_pessoa_fisica       :=   NEW.cd_pessoa_fisica;
reg_integracao_p.ie_funcionario    :=  coalesce(ie_funcionario_w,'N');
reg_integracao_p.nr_seq_conselho  :=  nr_seq_conselho_w;

SELECT CASE WHEN COUNT(*)=0 THEN  'N'  ELSE 'S' END
  INTO STRICT reg_integracao_p.ie_pessoa_atend
  FROM pessoa_fisica_aux
 WHERE cd_pessoa_fisica = NEW.cd_pessoa_fisica
   AND nr_primeiro_atend IS NOT NULL;

if nr_cpf_w is not null then
   reg_integracao_p.ie_possui_cpf := 'S';
end if;

if (wheb_usuario_pck.get_ie_lote_contabil = 'N') then
  reg_integracao_p := gerar_int_padrao.gravar_integracao('12', NEW.cd_pessoa_fisica, NEW.nm_usuario, reg_integracao_p);
end if;

if (ie_funcionario_w = 'S') then
  reg_integracao_p := gerar_int_padrao.gravar_integracao('304', NEW.cd_pessoa_fisica, NEW.nm_usuario, reg_integracao_p);
end if;

CALL send_physician_intpd(NEW.cd_pessoa_fisica, NEW.nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, 'U');

end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_compl_pessoa_fisica_afterup() FROM PUBLIC;

CREATE TRIGGER compl_pessoa_fisica_afterup
	AFTER INSERT OR UPDATE ON compl_pessoa_fisica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_compl_pessoa_fisica_afterup();

