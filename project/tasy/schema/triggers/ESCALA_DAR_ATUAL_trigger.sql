-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_dar_atual ON escala_dar CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_dar_atual() RETURNS trigger AS $BODY$
declare
sql_w		varchar(400);
ds_erro_w   	varchar(2000);
ds_parametro_w  varchar(2000);
qt_pontos_w 	escala_dar.qt_pontos%type;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then
	BEGIN
	sql_w := 'CALL OBTER_SCORE_DAR_ATUAL_MD(:1, :2, :3, :4, :5) INTO :qt_pontos_w';
	EXECUTE sql_w USING IN NEW.ie_raiva,
				    IN NEW.ie_furioso,
				    IN NEW.ie_cont_raiva,
				    IN NEW.ie_bater,
				    IN NEW.ie_junto,
				    OUT qt_pontos_w;
	exception
	  when others then
	    NEW.qt_pontos := null;
	    ds_erro_w := sqlerrm;
	    ds_parametro_w := ' - :new.ie_raiva: ' || NEW.ie_raiva || ' - :new.ie_furioso: ' || NEW.ie_furioso || ' - :new.ie_cont_raiva: ' || NEW.ie_cont_raiva || ' - :new.ie_bater: ' || NEW.ie_bater || ' - :new.ie_junto: ' || NEW.ie_junto;
	    CALL gravar_log_medical_device('ESCALA_DAR_ATUAL', 'OBTER_SCORE_DAR_ATUAL_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');	
      	    raise;
	  end;
	
	NEW.qt_pontos := qt_pontos_w;
end if;
  END;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_dar_atual() FROM PUBLIC;

CREATE TRIGGER escala_dar_atual
	BEFORE INSERT OR UPDATE ON escala_dar FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_dar_atual();

