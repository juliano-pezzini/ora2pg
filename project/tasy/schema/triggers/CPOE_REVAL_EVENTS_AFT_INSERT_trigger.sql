-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cpoe_reval_events_aft_insert ON cpoe_revalidation_events CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cpoe_reval_events_aft_insert() RETURNS trigger AS $BODY$
declare

	ds_stack_w		varchar(2000);
	ds_log_cpoe_w	varchar(2000);
	dt_min_date_w	timestamp := to_date('30/12/1899 00:00:00', 'dd/mm/yyyy hh24:mi:ss');
BEGIN
  BEGIN

	if (coalesce(NEW.nr_sequencia,0) <> coalesce(OLD.nr_sequencia,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_sequencia(' || coalesce(OLD.nr_sequencia,0) || '/' || coalesce(NEW.nr_sequencia,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.nr_atendimento,0) <> coalesce(OLD.nr_atendimento,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_atendimento(' || coalesce(OLD.nr_atendimento,0) || '/' || coalesce(NEW.nr_atendimento,0)||'); ',1,2000);
	end if;
	
	if (coalesce(NEW.cd_medico,0) <> coalesce(OLD.cd_medico,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' cd_medico(' || coalesce(OLD.cd_medico,0) || '/' || coalesce(NEW.cd_medico,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.cd_medico_anterior,0) <> coalesce(OLD.cd_medico_anterior,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' cd_medico_anterior(' || coalesce(OLD.cd_medico_anterior,0) || '/' || coalesce(NEW.cd_medico_anterior,0)||'); ',1,2000);
	end if;
	
	if (coalesce(NEW.dt_validacao, dt_min_date_w) <> coalesce(OLD.dt_validacao, dt_min_date_w)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_validacao(' || coalesce(to_char(OLD.dt_validacao,'dd/mm/yyyy hh24:mi:ss'),'<NULL>') || '/' || coalesce(to_char(NEW.dt_validacao,'dd/mm/yyyy hh24:mi:ss'),'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.dt_envio_comunicado, dt_min_date_w) <> coalesce(OLD.dt_envio_comunicado, dt_min_date_w)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_envio_comunicado(' || coalesce(to_char(OLD.dt_envio_comunicado,'dd/mm/yyyy hh24:mi:ss'),'<NULL>') || '/' || coalesce(to_char(NEW.dt_envio_comunicado,'dd/mm/yyyy hh24:mi:ss'),'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.nr_seq_dialysis,0) <> coalesce(OLD.nr_seq_dialysis,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_dialysis(' || coalesce(OLD.nr_seq_dialysis,0) || '/' || coalesce(NEW.nr_seq_dialysis,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.nr_seq_diet,0) <> coalesce(OLD.nr_seq_diet,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_diet(' || coalesce(OLD.nr_seq_diet,0) || '/' || coalesce(NEW.nr_seq_diet,0)||'); ',1,2000);
	end if;
	
	if (coalesce(NEW.nr_seq_hemotherapy,0) <> coalesce(OLD.nr_seq_hemotherapy,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_hemotherapy(' || coalesce(OLD.nr_seq_hemotherapy,0) || '/' || coalesce(NEW.nr_seq_hemotherapy,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.nr_seq_material,0) <> coalesce(OLD.nr_seq_material,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_material(' || coalesce(OLD.nr_seq_material,0) || '/' || coalesce(NEW.nr_seq_material,0)||'); ',1,2000);
	end if;
	
	if (coalesce(NEW.nr_seq_exam,0) <> coalesce(OLD.nr_seq_exam,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_exam(' || coalesce(OLD.nr_seq_exam,0) || '/' || coalesce(NEW.nr_seq_exam,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.nr_seq_recomendation,0) <> coalesce(OLD.nr_seq_recomendation,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_recomendation(' || coalesce(OLD.nr_seq_recomendation,0) || '/' || coalesce(NEW.nr_seq_recomendation,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.nr_seq_gasotherapy,0) <> coalesce(OLD.nr_seq_gasotherapy,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_gasotherapy(' || coalesce(OLD.nr_seq_gasotherapy,0) || '/' || coalesce(NEW.nr_seq_gasotherapy,0)||'); ',1,2000);
	end if;	

	if (coalesce(NEW.nr_seq_revalidation_rule,0) <> coalesce(OLD.nr_seq_revalidation_rule,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_revalidation_rule(' || coalesce(OLD.nr_seq_revalidation_rule,0) || '/' || coalesce(NEW.nr_seq_revalidation_rule,0)||'); ',1,2000);
	end if;	

	if (ds_log_cpoe_w is not null) then
		
		if (coalesce(OLD.nr_sequencia, 0) > 0) then
			ds_log_cpoe_w := substr('Alterações(old/new)= ' || ds_log_cpoe_w,1,2000);
		else
			ds_log_cpoe_w := substr('Criação(old/new)= ' || ds_log_cpoe_w,1,2000);
		end if;

		ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
		ds_log_cpoe_w := substr('CPOE_REVAL_EVENTS_AFT_INSERT: ' || ds_log_cpoe_w ||' FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);

		insert into log_cpoe(	nr_sequencia,
								nr_atendimento,
								dt_atualizacao,
								nm_usuario,
								nr_seq_material,
								nr_seq_dieta, 
								nr_seq_gasoterapia, 
								nr_seq_recomendacao, 
								nr_seq_procedimento, 
								nr_seq_dialise, 
								nr_seq_hemoterapia,
								ds_log,
								ds_stack) 
					values (	nextval('log_cpoe_seq'), 
								NEW.nr_atendimento, 
								LOCALTIMESTAMP,
								NEW.nm_usuario,
								NEW.nr_seq_material,
								NEW.nr_seq_diet,
								NEW.nr_seq_gasotherapy,
								NEW.nr_seq_recomendation,
								NEW.nr_seq_exam,
								NEW.nr_seq_dialysis,
								NEW.nr_seq_hemotherapy,
								ds_log_cpoe_w,
								ds_stack_w);
	end if;

exception
	when others then
		ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
		ds_log_cpoe_w := substr('EXCEPTION CPOE_REVAL_EVENTS_AFT_INSERT ' || to_char(sqlerrm),1, 2000);
		
		insert into log_cpoe(nr_sequencia,
							nr_atendimento, 
							dt_atualizacao, 
							nm_usuario, 
							ds_log, 
							ds_stack) 
		values (			nextval('log_cpoe_seq'), 
							NEW.nr_atendimento, 
							LOCALTIMESTAMP, 
							NEW.nm_usuario, 
							ds_log_cpoe_w, 
							ds_stack_w);
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cpoe_reval_events_aft_insert() FROM PUBLIC;

CREATE TRIGGER cpoe_reval_events_aft_insert
	AFTER INSERT OR UPDATE ON cpoe_revalidation_events FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cpoe_reval_events_aft_insert();

