-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS tx_registro_snt_befupdate ON tx_registro_snt CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_tx_registro_snt_befupdate() RETURNS trigger AS $BODY$
declare
ie_tipo_orgao_receptor_w	varchar(15);
qt_registro_w			bigint;
nr_seq_equipe_w		bigint;
ie_permite_lib_w	varchar(1);
ie_liberado_w 		varchar(1);
cd_estabelecimento_w	integer;
BEGIN 
 
 
select	max(cd_estabelecimento) 
into STRICT	cd_estabelecimento_w 
from 	tx_central_trAnspl 
where	nr_sequencia = NEW.nr_seq_central;
 
ie_permite_lib_w := Obter_Param_Usuario(7006, 8, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_permite_lib_w);
 
if (ie_permite_lib_w = 'S') and (NEW.ie_status_rgct = 'A') then 
 
	ie_liberado_w	:= substr(TX_Obter_se_lista_servico(NEW.nr_seq_receptor),1,1);
 
	if (ie_liberado_w = 'N') then 
 
		--O paciente não está liberado na lista de serviço. 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(264146);
 
	end if;
	 
end if;
 
/* Verifica compatibilidade entre órgãos */
 
select	substr(tx_obter_dados_receptor(NEW.nr_seq_receptor, 'TO'),1,15) 
into STRICT	ie_tipo_orgao_receptor_w
;
 
/* Verifica compatibilidade com o centro */
 
select	count(*) 
into STRICT	qt_registro_w 
from	tx_central_orgao 
where	ie_orgao		= ie_tipo_orgao_receptor_w 
and	nr_seq_central	= NEW.nr_seq_central;
 
if (qt_registro_w = 0) then 
	--Os órgãos do receptor e autorizados para o centro de transplantes são incompatíveis. 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(264149);
end if;
 
/* Verifica compatibilidade com a equipe */
 
select	max(nr_seq_equipe) 
into STRICT	nr_seq_equipe_w 
from	tx_central_equipe 
where	nr_sequencia		= NEW.nr_seq_equipe_centro;
 
select	count(*) 
into STRICT	qt_registro_w 
from	tx_equipe_orgao 
where	ie_orgao		= ie_tipo_orgao_receptor_w 
and	nr_seq_equipe		= nr_seq_equipe_w;
 
if (qt_registro_w = 0) then 
	--Os órgãos do receptor e autorizados para a equipe de transplantes são incompatíveis. 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(264150);
end if;
 
/* Registra a alteração no histórico */
 
insert into tx_registro_snt_hist( 
	nr_sequencia, 
	nr_seq_registro, 
	ie_status, 
	ie_status_rgct, 
	ie_motivo_status, 
	dt_historico, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	ds_observacao 
) values ( 
	nextval('tx_registro_snt_hist_seq'), 
	NEW.nr_sequencia, 
	NEW.ie_status, 
	NEW.ie_status_rgct, 
	NEW.ie_motivo_status, 
	LOCALTIMESTAMP, 
	LOCALTIMESTAMP, 
	NEW.nm_usuario, 
	LOCALTIMESTAMP, 
	NEW.nm_usuario, 
	NEW.ds_observacao 
);
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_tx_registro_snt_befupdate() FROM PUBLIC;

CREATE TRIGGER tx_registro_snt_befupdate
	BEFORE INSERT OR UPDATE ON tx_registro_snt FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_tx_registro_snt_befupdate();

