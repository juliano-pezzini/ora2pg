-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_goldman_atual ON escala_goldman CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_goldman_atual() RETURNS trigger AS $BODY$
declare
    EXEC_w        varchar(300);
    qt_reg_w	  smallint;
    qt_pontos_w	  integer;
    ds_erro_w      varchar(4000);
    ds_parametro_w varchar(4000);
BEGIN
  BEGIN
    if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
        NEW.nr_hora	:= (to_char(round(NEW.DT_AVALIACAO,'hh24'),'hh24'))::numeric;
    end if;
    
    if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
        goto Final;
    end if;

    BEGIN
        EXEC_w := 'CALL OBTER_SCORE_ESCALA_GOLDMAN_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11,
                                                            :12, :13, :14, :15, :16, :17, :18, :19, :20) INTO :qt_pontos_w';

        EXECUTE EXEC_w USING  IN coalesce(NEW.qt_idade,0),
                                        IN coalesce(NEW.ie_iam,'N'),
                                        IN coalesce(NEW.ie_galope_b3,'N'),
                                        IN coalesce(NEW.ie_distensao,'N'),
                                        IN coalesce(NEW.ie_estenose,'N'),
                                        IN coalesce(NEW.ie_disritmia_sinusal,'N'),
                                        IN coalesce(NEW.ie_disritmia_ventricular,'N'),
                                        IN coalesce(NEW.qt_pao2,0),
                                        IN coalesce(NEW.qt_paco2,0),
                                        IN coalesce(NEW.qt_potassio,0),
                                        IN coalesce(NEW.qt_hco3,0),
                                        IN coalesce(NEW.qt_ureia,0),
                                        IN coalesce(NEW.qt_creatinina,0),
                                        IN coalesce(NEW.ie_tgo,'N'),
                                        IN coalesce(NEW.ie_doenca_hepatica,'N'),
                                        IN coalesce(NEW.ie_pac_acamado,'N'),
                                        IN coalesce(NEW.ie_cir_abdominal,'N'),
                                        IN coalesce(NEW.ie_cir_toracica,'N'),
                                        IN coalesce(NEW.ie_cir_aortica,'N'),
                                        IN coalesce(NEW.ie_cir_emergencia,'N'),
                                        OUT qt_pontos_w;
    exception
        when others then
            qt_pontos_w := null;
            ds_erro_w := sqlerrm;
            ds_parametro_w := ':new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional;
            ds_parametro_w := ds_parametro_w || ' :new.qt_idade: ' || coalesce(NEW.qt_idade,0) || ' :new.ie_iam: ' || coalesce(NEW.ie_iam,'N') || ' :new.ie_galope_b3: ' || coalesce(NEW.ie_galope_b3,'N');
            ds_parametro_w := ds_parametro_w || ' :new.ie_distensao: ' || coalesce(NEW.ie_distensao,'N') || ' :new.ie_estenose: ' || coalesce(NEW.ie_estenose,'N') || ' :new.ie_disritmia_sinusal: ' || coalesce(NEW.ie_disritmia_sinusal,'N') || ' :new.ie_disritmia_ventricular: ' || coalesce(NEW.ie_disritmia_ventricular,'N');
            ds_parametro_w := ds_parametro_w || ' :new.qt_pao2: ' || coalesce(NEW.qt_pao2,0) || ' :new.qt_paco2: ' || coalesce(NEW.qt_paco2,0) || ' :new.qt_potassio: ' || coalesce(NEW.qt_potassio,0) || ' :new.qt_hco3: ' || coalesce(NEW.qt_hco3,0) || ' :new.qt_ureia: ' || coalesce(NEW.qt_ureia,0);
            ds_parametro_w := ds_parametro_w || ' :new.qt_creatinina: ' || coalesce(NEW.qt_creatinina,0) || ' :new.ie_tgo: ' || coalesce(NEW.ie_tgo,'N') || ' :new.ie_doenca_hepatica: ' || coalesce(NEW.ie_doenca_hepatica,'N') || ' :new.ie_pac_acamado: ' || coalesce(NEW.ie_pac_acamado,'N') || ' :new.ie_cir_toracica: ' || coalesce(NEW.ie_cir_toracica,'N');
            ds_parametro_w := ds_parametro_w || ' :new.ie_cir_aortica: ' || coalesce(NEW.ie_cir_aortica,'N') || ' :new.ie_cir_emergencia: ' || coalesce(NEW.ie_cir_emergencia,'N') || ' - qt_pontos_w: ' || qt_pontos_w;
            CALL gravar_log_medical_device('ESCALA_EPWORTH_ATUAL', 'OBTER_SCORE_ESCALA_EPWORTH_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
    end;

    NEW.qt_pontuacao	:= qt_pontos_w;
<<Final>>
qt_reg_w	:= 0;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_goldman_atual() FROM PUBLIC;

CREATE TRIGGER escala_goldman_atual
	BEFORE INSERT OR UPDATE ON escala_goldman FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_goldman_atual();

