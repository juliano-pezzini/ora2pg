-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_saps3_atual ON escala_saps3 CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_saps3_atual() RETURNS trigger AS $BODY$
DECLARE
    qt_reg_w                smallint;
    qt_pontuacao_w          bigint := 0;
    qt_logit_w              double precision;
    qt_logit_america_sul_w  double precision;
    pr_risco_america_sul_w  real;
    exec_w                  varchar(500);
    ds_erro_w               varchar(4000);
    ds_parametros_w         varchar(4000);
BEGIN
  BEGIN
    IF ( NEW.nr_hora IS NULL ) OR ( NEW.dt_avaliacao <> OLD.dt_avaliacao ) THEN
        BEGIN
            NEW.nr_hora := (to_char(round(NEW.dt_avaliacao, 'hh24'), 'hh24'))::numeric;

        END;
    END IF;

    IF ( wheb_usuario_pck.get_ie_executar_trigger = 'N' ) THEN
        GOTO final;
    END IF;
    BEGIN
        exec_w := 'BEGIN OBTER_PERC_RIS_PTTOT_SAPS3_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, 
                                                    :11, :12, :13, :14, :15, :16, :17, :18, :19, :20,
                                                    :21, :22, :23, :24, :25, :26, :27, :28, :29, :30,
                                                    :31, :32, :33, :34, :35, :36, :37, :38, :39, :40,
                                                    :41, :42, :43, :44); END;';
        EXECUTE exec_w
            USING IN NEW.ie_tipo_saps3, IN NEW.qt_idade, IN NEW.qt_dias_internacao_prev, IN NEW.ie_aids, IN NEW.ie_cirrose, IN NEW.ie_malig_hematologica,
            IN NEW.ie_icc_nyha, IN NEW.ie_quimioterapia, IN NEW.ie_metastase, IN NEW.ie_famacos_vasoativos,
            IN NEW.ie_origem_paciente, IN NEW.ie_tipo_admissao, IN NEW.ie_urgencia, IN NEW.ie_tipo_operacao, IN NEW.ie_neurologica,
            IN NEW.ie_cardiologica, IN NEW.ie_abdomem, IN NEW.ie_hepatico, IN NEW.ie_infec_nosocomial, IN NEW.ie_infec_resp,
            IN NEW.qt_glasgow, IN NEW.qt_freq_cardiaca, IN NEW.qt_pa_sistolica, IN NEW.qt_temp, IN NEW.qt_globulos_brancos, IN NEW.qt_bilirrubina, 
            IN NEW.qt_creatinina, IN NEW.qt_ph, IN NEW.qt_plaquetas, IN NEW.ie_oxigenacao, IN NEW.qt_bmi,
            IN NEW.ie_infec_extensao, IN NEW.ie_infec_agente, IN NEW.ie_disfuncao_renal, IN NEW.ie_disfuncao_coagulacao, IN NEW.ie_falencia_renal, 
            IN NEW.ie_falencia_coagulacao, IN NEW.ie_falencia_cardiaca, IN NEW.ie_falencia_respiratoria,
            IN NEW.ie_falencia_snc, IN NEW.pr_risco_america_sul, OUT pr_risco_america_sul_w, OUT NEW.qt_pontuacao, OUT qt_logit_w;

    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_tipo_saps3: '||NEW.ie_tipo_saps3||'-'||':new.qt_idade: '||NEW.qt_idade||'-'||':new.qt_dias_internacao_prev: '||NEW.qt_dias_internacao_prev||'-'||
                          ':new.ie_aids: '||NEW.ie_aids||'-'||':new.ie_cirrose: '||NEW.ie_cirrose||'-'||':new.ie_malig_hematologica: '||NEW.ie_malig_hematologica||'-'||
                          ':new.ie_icc_nyha: '||NEW.ie_icc_nyha||'-'||':new.ie_quimioterapia: '||NEW.ie_quimioterapia||'-'||':new.ie_metastase: '||NEW.ie_metastase||'-'||
                          ':new.ie_famacos_vasoativos: '||NEW.ie_famacos_vasoativos||'-'||':new.ie_origem_paciente: '||NEW.ie_origem_paciente||'-'||':new.ie_tipo_admissao: '||NEW.ie_tipo_admissao||'-'||
                          ':new.ie_urgencia: '||NEW.ie_urgencia||'-'||':new.ie_tipo_operacao: '||NEW.ie_tipo_operacao||'-'||':new.ie_neurologica: '||NEW.ie_neurologica||'-'||
                          ':new.ie_cardiologica: '||NEW.ie_cardiologica||'-'||':new.ie_abdomem: '||NEW.ie_abdomem||'-'||':new.ie_hepatico: '||NEW.ie_hepatico||'-'||
                          ':new.ie_infec_nosocomial: '||NEW.ie_infec_nosocomial||'-'||':new.ie_infec_resp: '||NEW.ie_infec_resp||'-'||':new.qt_glasgow: '||NEW.qt_glasgow||'-'||
                          ':new.qt_freq_cardiaca: '||NEW.qt_freq_cardiaca||'-'||':new.qt_pa_sistolica: '||NEW.qt_pa_sistolica||'-'||':new.qt_temp: '||NEW.qt_temp||'-'||
                          ':new.qt_globulos_brancos: '||NEW.qt_globulos_brancos||'-'||':new.qt_bilirrubina: '||NEW.qt_bilirrubina||'-'||':new.qt_creatinina: '||NEW.qt_creatinina||'-'||
                          ':new.qt_ph: '||NEW.qt_ph||'-'||':new.qt_plaquetas: '||NEW.qt_plaquetas||'-'||':new.ie_oxigenacao: '||NEW.ie_oxigenacao||'-'||
                          ':new.qt_bmi: '||NEW.qt_bmi||'-'||':new.ie_infec_extensao: '||NEW.ie_infec_extensao||'-'||':new.ie_infec_agente: '||NEW.ie_infec_agente||'-'||
                          ':new.ie_disfuncao_renal: '||NEW.ie_disfuncao_renal||'-'||':new.ie_disfuncao_coagulacao: '||NEW.ie_disfuncao_coagulacao||'-'||':new.ie_falencia_renal: '||NEW.ie_falencia_renal||'-'||
                          ':new.ie_falencia_coagulacao: '||NEW.ie_falencia_coagulacao||'-'||':new.ie_falencia_cardiaca: '||NEW.ie_falencia_cardiaca||'-'||':new.ie_falencia_respiratoria: '||NEW.ie_falencia_respiratoria||'-'||
                          ':new.ie_falencia_snc: '||NEW.ie_falencia_snc||'-'||':new.pr_risco_america_sul: '||NEW.pr_risco_america_sul||'-'||'pr_risco_america_sul_w: '||pr_risco_america_sul_w||'-'||
                          ':new.qt_pontuacao: '||NEW.qt_pontuacao||'-'||'qt_logit_w: '||qt_logit_w);

      CALL gravar_log_medical_device('escala_saps3_atual','OBTER_PERC_RIS_PTTOT_SAPS3_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            pr_risco_america_sul_w := NULL;
            NEW.qt_pontuacao := NULL;
            qt_logit_w := NULL;
    END;

    NEW.pr_risco_america_sul := pr_risco_america_sul_w;
    BEGIN
        exec_w := 'CALL OBTER_PERC_RIS_E_SAPS3_MD(:1) INTO :RESULT';
        EXECUTE exec_w
            USING IN qt_logit_w, OUT NEW.pr_risco;
    EXCEPTION
        WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          'qt_logit_w: '||qt_logit_w||'-'||':new.pr_risco: '||NEW.pr_risco);

      CALL gravar_log_medical_device('escala_saps3_atual','OBTER_PERC_RIS_E_SAPS3_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
            NEW.pr_risco := NULL;
    END;

    IF ( OLD.dt_liberacao IS NULL )
        AND ( NEW.dt_liberacao IS NOT NULL )
    THEN
        CALL send_saps3_integration(NEW.nr_atendimento, NEW.nr_sequencia, NEW.dt_atualizacao, NEW.ie_cardiologica, NEW.ie_hepatico,
                              NEW.ie_abdomem,
                              NEW.ie_neurologica,
                              NEW.ie_tipo_operacao,
                              NEW.ie_infec_nosocomial,
                              NEW.ie_infec_resp);
    END IF;

    IF ( OLD.dt_inativacao IS NULL )
        AND ( NEW.dt_inativacao IS NOT NULL )
    THEN
        CALL send_saps3_integration(NEW.nr_atendimento, NEW.nr_sequencia, NEW.dt_atualizacao, NEW.ie_cardiologica, NEW.ie_hepatico,
                              NEW.ie_abdomem,
                              NEW.ie_neurologica,
                              NEW.ie_tipo_operacao,
                              NEW.ie_infec_nosocomial,
                              NEW.ie_infec_resp);
    END IF;

    << final >> qt_reg_w := 0;
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_saps3_atual() FROM PUBLIC;

CREATE TRIGGER escala_saps3_atual
	BEFORE INSERT OR UPDATE ON escala_saps3 FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_saps3_atual();

