-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cpoe_procedimento_reab_update ON cpoe_procedimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cpoe_procedimento_reab_update() RETURNS trigger AS $BODY$
declare

nr_seq_w bigint;
ie_gerar_reabilitacao_w	varchar(10);
cd_estabelecimento_w	smallint;
nr_seq_paciente_reab_w 	rp_paciente_reabilitacao.nr_sequencia%type;
nr_seq_rp_tratamento_w 	rp_tratamento.nr_sequencia%type;
ie_tipo_w   			varchar(10);
cd_medico_setor_w       rp_tratamento.cd_medico_setor%type;
qt_reg_w				smallint;

BEGIN
	if (wheb_usuario_pck.get_ie_executar_trigger = 'N')  then
		goto Final;
	end if;
	
	select max(wheb_usuario_pck.get_cd_estabelecimento)
	into STRICT cd_estabelecimento_w
	;
	
	ie_gerar_reabilitacao_w := obter_param_usuario(2314, 40, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_gerar_reabilitacao_w);

	if (ie_gerar_reabilitacao_w = 'S' and OLD.dt_liberacao is null and NEW.dt_liberacao is not null) then
		select max(dm.ds_depto)
        into STRICT cd_medico_setor_w
        from depto_medico dm,
            medico_especialidade mc,
            medico m,
            depto_medico_espec dme
        where mc.cd_pessoa_fisica = m.cd_pessoa_fisica
            and mc.cd_especialidade = dme.cd_especialidade
            and dme.nr_seq_depto = dm.nr_sequencia
            and mc.cd_pessoa_fisica = NEW.cd_solicitante_medico
            and mc.nr_seq_prioridade = ( SELECT min(mde.nr_seq_prioridade)
                        from depto_medico dpm,
                            medico_especialidade mde,
                            medico medc,
                            depto_medico_espec dpme
                        where mde.cd_pessoa_fisica = medc.cd_pessoa_fisica
                            and mde.cd_especialidade = dpme.cd_especialidade
                            and dpme.nr_seq_depto = dpm.nr_sequencia
                            and medc.cd_pessoa_fisica = m.cd_pessoa_fisica);

        select max(upper(ie_tipo))
		into STRICT ie_tipo_w
		from proc_interno
		where nr_sequencia = NEW.nr_seq_proc_interno;
	
		if (ie_tipo_w = 'REAB') then
			select max(nr_sequencia)
			into STRICT nr_seq_paciente_reab_w
			from rp_paciente_reabilitacao
			where cd_pessoa_fisica = NEW.cd_pessoa_fisica
				  and ie_situacao = 'A';

			if (nr_seq_paciente_reab_w is null) then
				select nextval('rp_paciente_reabilitacao_seq')
				into STRICT nr_seq_paciente_reab_w
				;
				
				insert into rp_paciente_reabilitacao(
					nr_sequencia,
					cd_pessoa_fisica,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					cd_estabelecimento,
					ie_situacao,
					cd_medico_resp)
				values (
					nr_seq_paciente_reab_w,
					NEW.cd_pessoa_fisica,
					LOCALTIMESTAMP,
					LOCALTIMESTAMP,
					NEW.nm_usuario,
					NEW.nm_usuario,
					cd_estabelecimento_w,
					'A',
					NEW.cd_medico);
			end if;
			
			select nextval('rp_tratamento_seq')
			into STRICT nr_seq_rp_tratamento_w
			;

			insert into rp_tratamento(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_pac_reav,
				nr_seq_tipo_tratamento,
				dt_inicio_tratamento,
				dt_fim_tratamento,
				dt_prevista_alta,
				ie_calculation_date,
				nr_seq_calc_classif,
				ds_diagnosis,
				dt_diagnostico,
				nr_seq_dis_classif,
				ds_complicacao,
                dt_periodo_inicial_prev,
                cd_solicitante_medico,
                cd_medico_setor,
				rp_disability_status,
				rp_instruct_prescript,
				rp_comments,
                nr_seq_cpoe_procedimento)
			values (
				nr_seq_rp_tratamento_w,
				LOCALTIMESTAMP,
				NEW.nm_usuario,
				LOCALTIMESTAMP,
				NEW.nm_usuario,
				nr_seq_paciente_reab_w,
				NEW.nr_seq_tipo_tratamento,
				NEW.dt_inicio,
				NEW.dt_fim,
				NEW.dt_prevista_alta,
				NEW.ie_calculation_date,
				NEW.nr_seq_calc_classif,
				NEW.ds_diagnosis,
				NEW.dt_diagnostico,
				NEW.nr_seq_dis_classif,
				NEW.ds_complicacao,
                NEW.dt_periodo_inicial_prev,
                NEW.cd_solicitante_medico,
                cd_medico_setor_w,
				NEW.disablity_status,
				NEW.priscription_instruction,
				NEW.rp_comments,
                NEW.nr_sequencia);
		end if;
	end if;

	<<Final>>
	qt_reg_w := 0;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cpoe_procedimento_reab_update() FROM PUBLIC;

CREATE TRIGGER cpoe_procedimento_reab_update
	AFTER UPDATE ON cpoe_procedimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cpoe_procedimento_reab_update();

