-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS execute_dispensary_suspended ON prescr_material CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_execute_dispensary_suspended() RETURNS trigger AS $BODY$
DECLARE
    SUBTYPE one_char                        IS varchar(1);
    SUBTYPE two_char                        IS varchar(2);
    SUBTYPE three_char                      IS varchar(3);
    SUBTYPE five_char                       IS varchar(5);
    SUBTYPE ten_char                        IS varchar(10);
    SUBTYPE eleven_char                     IS varchar(11);
    SUBTYPE twelve_char                     IS varchar(12);
    SUBTYPE thirteen_char                   IS varchar(13);
    SUBTYPE fifteen_char                    IS varchar(15);
    SUBTYPE sixteen_char                    IS varchar(16);
    SUBTYPE nineteen_char                   IS varchar(19);
    SUBTYPE twenty_two_char                 IS varchar(22);
    SUBTYPE fourty_three_char               IS varchar(43);
    SUBTYPE fourty_five_char                IS varchar(45);
    SUBTYPE two_hundred_fifty_five_char     IS varchar(255);
    SUBTYPE four_thousand_char              IS varchar(4000);

seqMaterial_w                  prescr_material.nr_seq_material%TYPE;
patientCustomerCode_w          two_hundred_fifty_five_char;
startDate_w                    two_hundred_fifty_five_char;
productCustomerCode_w          prescr_material.cd_material%TYPE;
quantity_w                     prescr_material.qt_material%TYPE;
dosageAmount_w                 prescr_material.qt_dose%TYPE;
dosageFrequency_w              prescr_material.nr_ocorrencia%TYPE;
dosageStartHour_w              two_char;
urgency_w                      two_hundred_fifty_five_char;
json_w                         evolucao_paciente.ds_evolucao%TYPE;
sector_w                       integer;
suspensionDate_w               fourty_three_char;
ie_forma_integracao_w		   integer;

c_nr_integration_code CONSTANT integer := 984;
char_S_c CONSTANT one_char := 'S';
sub_11_c CONSTANT five_char := '11';
sub_0_c CONSTANT integer := 0;
sub_2_c CONSTANT integer := 2;
sub_24_c CONSTANT integer := 24;
error_code_generic_c CONSTANT integer := 21984;
error_message_generic_c CONSTANT fourty_five_char := 'Error executing EXECUTE_DISPENSARY_SUSPENDED.';
forma_integracao_M_c CONSTANT dis_parametros_int.ie_forma_integracao%TYPE := 'M';
forma_integracao_B_c CONSTANT dis_parametros_int.ie_forma_integracao%TYPE := 'B';
forma_integracao_S_c CONSTANT dis_parametros_int.ie_forma_integracao%TYPE := 'S';
forma_integracao_C_c CONSTANT dis_parametros_int.ie_forma_integracao%TYPE := 'C';
date_formate_c CONSTANT ten_char := 'YYYY-MM-DD';
json_comma_c CONSTANT one_char := ',';
json_quotation_mark_c CONSTANT one_char := '"';
json_open_bracket_c CONSTANT one_char := '[';
json_closed_bracket_c CONSTANT one_char := ']';
json_open_brace_c CONSTANT one_char := '{';
json_closed_brace_c CONSTANT one_char := '}';
																  
true_string_c CONSTANT fifteen_char := 'true';
false_string_c CONSTANT fifteen_char := 'false';
json_customerCode_str_c CONSTANT fifteen_char := '"customerCode":';
json_ptCustomCode_string_c CONSTANT twenty_two_char := '"patientCustomerCode":';
json_startDate_string_c CONSTANT thirteen_char := '"startDate": ';
json_products_string_c CONSTANT twelve_char := '"products":';
json_prodCustomCod_string_c CONSTANT twenty_two_char := '"productCustomerCode":';
json_quantity_string_c CONSTANT twelve_char := '"quantity":';
json_dosageAmount_string_c CONSTANT sixteen_char  := '"dosageAmount":';
json_dosageFrequency_string_c CONSTANT nineteen_char := '"dosageFrequency":';
json_dosageStartHour_string_c CONSTANT nineteen_char := '"dosageStartHour":';
json_urgency_string_c CONSTANT eleven_char := '"urgency":';
json_seqMaterial_string_c CONSTANT fifteen_char := '"seqMaterial":';
json_suspensionDate_string_c CONSTANT nineteen_char := '"suspensionDate":';

pragma autonomous_transaction;
BEGIN
  BEGIN
    IF (wheb_usuario_pck.get_ie_executar_trigger = char_S_c) THEN

      IF (NEW.IE_SUSPENSO LIKE forma_integracao_S_c) THEN

         SELECT
          count(distinct a.nr_sequencia)
         INTO STRICT 
          ie_forma_integracao_w
        FROM dis_parametros_int a
        WHERE ie_forma_integracao IN (forma_integracao_M_c, forma_integracao_B_c);

        IF (ie_forma_integracao_w is not null AND ie_forma_integracao_w > sub_0_c) THEN

        SELECT
            NEW.cd_material,
            (NEW.qt_dose)::numeric  qt_dose,
            round((NEW.qt_material)::numeric,0) qt_material,
            sub_24_c/NEW.nr_ocorrencia ocorrencia,		
			CASE
			WHEN is_number(SUBSTR(NEW.HR_PRIM_HORARIO, sub_0_c,sub_2_c)) > 0
			THEN (SUBSTR(NEW.HR_PRIM_HORARIO, sub_0_c,sub_2_c))::numeric
			ELSE NULL
			END primeiro_horario,
            NEW.nr_sequencia,
          case when NEW.ie_urgencia = forma_integracao_S_c then true_string_c
                else false_string_c
          end urgency
        INTO STRICT
              productCustomerCode_w,
              dosageAmount_w,
              quantity_w,
              dosageFrequency_w,
              dosageStartHour_w,
              seqMaterial_w,
              urgency_w
;
		
            select
                count(a.nr_sequencia) 
            into STRICT 
                sector_w
            from 
                DIS_REGRA_SETOR a
            join  DIS_REGRA_LOCAL_SETOR b 
              on a.nr_sequencia = b.nr_seq_dis_regra_setor
            join  local_estoque c 
              on b.cd_local_estoque = c.cd_local_estoque
            join prescr_medica d
              on d.nr_prescricao = NEW.nr_prescricao
            where a.cd_setor_atendimento = d.cd_setor_atendimento
            and c.ie_tipo_local = sub_11_c;

            IF (sector_w is not null AND sector_w > sub_0_c) THEN
                BEGIN
                    <<exec_trigger>>
                  BEGIN
                  <<get_atendiment_date>>
                    SELECT
                      obter_pessoa_atendimento(a.nr_atendimento,forma_integracao_C_c),
                      to_char(a.dt_primeiro_horario, date_formate_c),
                      to_char(LOCALTIMESTAMP, date_formate_c)
                    INTO STRICT 
                      patientCustomerCode_w,
                      startDate_w,
                      suspensionDate_w
                    FROM
                      prescr_medica a
                    where nr_prescricao = NEW.nr_prescricao;
                EXCEPTION
                    WHEN no_data_found THEN 
                      RAISE EXCEPTION '%', error_message_generic_c USING ERRCODE = error_code_generic_c;
                    WHEN too_many_rows THEN
                      RAISE EXCEPTION '%', error_message_generic_c USING ERRCODE = error_code_generic_c;
                END;

                    json_w := json_w ||
                    json_open_bracket_c ||
                    json_open_brace_c ||
                    json_customerCode_str_c || json_quotation_mark_c ||  NEW.nr_prescricao || json_quotation_mark_c || json_comma_c ||
                    json_ptCustomCode_string_c || json_quotation_mark_c ||  patientCustomerCode_w || json_quotation_mark_c || json_comma_c || 
                    json_suspensionDate_string_c || json_quotation_mark_c ||  suspensionDate_w || json_quotation_mark_c || json_comma_c ||
                    json_startDate_string_c || json_quotation_mark_c ||  startDate_w || json_quotation_mark_c;
                    json_w := json_w ||
                    json_comma_c ||
                    json_products_string_c || json_open_bracket_c;
                    json_w := json_w ||  json_open_brace_c  ||
                    json_prodCustomCod_string_c || json_quotation_mark_c ||  productCustomerCode_w || json_quotation_mark_c || json_comma_c ||
                    json_dosageAmount_string_c ||  dosageAmount_w || json_comma_c ||
                    json_quantity_string_c ||  quantity_w || json_comma_c ||
                    json_dosageFrequency_string_c ||  dosageFrequency_w || json_comma_c ||
                    json_dosageStartHour_string_c ||  dosageStartHour_w || json_comma_c ||
                    json_seqMaterial_string_c || json_quotation_mark_c ||  seqMaterial_w || json_quotation_mark_c || json_comma_c ||
                    json_urgency_string_c || urgency_w || json_closed_brace_c;
                    json_w := json_w  || json_closed_bracket_c || json_closed_brace_c || json_closed_bracket_c;

                    CALL execute_bifrost_integration(c_nr_integration_code, json_w);
                END;
            END IF;
            END IF;
        END IF;
    END IF;
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_execute_dispensary_suspended() FROM PUBLIC;

CREATE TRIGGER execute_dispensary_suspended
	AFTER UPDATE ON prescr_material FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_execute_dispensary_suspended();

