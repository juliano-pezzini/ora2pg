-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_pagar_imposto_insert ON titulo_pagar_imposto CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_pagar_imposto_insert() RETURNS trigger AS $BODY$
declare
qt_pag_prest_venc_w	integer	:= 0;
cd_estabelecimento_w		ctb_documento.cd_estabelecimento%type;

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
/* ebcabral - 30/01/2014 - Se for pagamento de producao medica, pode gerar imposto negativo */


select	count(1)
into STRICT	qt_pag_prest_venc_w
from	pls_pag_prest_vencimento 	b,
	pls_pag_prest_venc_trib		a
where	a.nr_seq_vencimento 	= b.nr_sequencia
and	b.nr_titulo 		= NEW.nr_titulo
and	a.vl_imposto 		< 0  LIMIT 1;

if (qt_pag_prest_venc_w = 0) and (NEW.vl_imposto < 0) and (NEW.nr_seq_baixa is null) then		-- Edgar 13/02/2008, inclui este if
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263383,'VL_TRIBUTO=' || NEW.vl_imposto);
end if;


select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	titulo_pagar
where	nr_titulo = NEW.nr_titulo;
			/* Projeto Davita  - Nao deixa gerar movimento contabil apos fechamento  da data */


			CALL philips_contabil_pck.valida_se_dia_fechado(OBTER_EMPRESA_ESTAB(cd_estabelecimento_w),NEW.dt_imposto);
NEW.ds_stack := substr('CallStack Insert: ' || substr(dbms_utility.format_call_stack,1,3980),1,4000);
end if;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_pagar_imposto_insert() FROM PUBLIC;

CREATE TRIGGER titulo_pagar_imposto_insert
	BEFORE INSERT ON titulo_pagar_imposto FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_pagar_imposto_insert();

