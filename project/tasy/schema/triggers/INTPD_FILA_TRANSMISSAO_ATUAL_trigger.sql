-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS intpd_fila_transmissao_atual ON intpd_fila_transmissao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_intpd_fila_transmissao_atual() RETURNS trigger AS $BODY$
declare

procedure agendar_xdok(nr_sequencia_p	bigint) is
pragma autonomous_transaction;
BEGIN
  BEGIN
	BEGIN
		CALL job_gravar_agend_integracao(614, 'NR_SEQUENCIA=' || NEW.nr_sequencia, 1, null, null);
		commit;
	exception
	when others then
		rollback;
	end;
end;

BEGIN
	if (wheb_usuario_pck.get_ie_executar_trigger = 'S')  then
		if (coalesce(OLD.ie_status,'NULL') <> coalesce(NEW.ie_status,'NULL')) then
			NEW.dt_status	:=	LOCALTIMESTAMP;

			/*'Tratamento para erro fake, ou seja, sistema externo retorna erro, mas deve ser tratado como sucesso'*/


			if (NEW.ie_status = 'E') and (coalesce(OLD.ie_tipo_erro, 'NULL') <> coalesce(NEW.ie_tipo_erro, 'NULL')) and (NEW.ie_tipo_erro = 'K') then
				NEW.ie_status	:=	'S';
			end if;

			if (NEW.ie_status <> 'E') then
				NEW.ie_tipo_erro	:=	null;
			end if;	
		end if;

		if (TG_OP = 'INSERT') then
			NEW.ds_stack := substr(dbms_utility.format_call_stack,1,4000);

			if (NEW.ie_evento = '505') and (NEW.ie_status = 'P') then
				BEGIN
				NEW.ie_status := 'R';
				agendar_xdok(NEW.nr_sequencia);
				end;
			end if;
		end if;

		if (NEW.nr_seq_documento is null) then
			NEW.nr_seq_documento	:=	0;
		end if;

		if (coalesce(NEW.ie_geracao,'X') = 'X') then
			NEW.ie_geracao	:=	'S';
		end if;
	end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_intpd_fila_transmissao_atual() FROM PUBLIC;

CREATE TRIGGER intpd_fila_transmissao_atual
	BEFORE INSERT OR UPDATE ON intpd_fila_transmissao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_intpd_fila_transmissao_atual();

