-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_titulo_rec_liq_mens_after ON pls_titulo_rec_liq_mens CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_titulo_rec_liq_mens_after() RETURNS trigger AS $BODY$
declare

reg_integracao_p		gerar_int_padrao.reg_integracao;
qt_reg_w			bigint;
dt_movimento_w          	ctb_documento.dt_competencia%type;
nr_seq_trans_financ_w   	ctb_documento.nr_seq_trans_financ%type;
nr_documento_w          	ctb_documento.nr_documento%type;
nr_seq_doc_compl_w      	ctb_documento.nr_seq_doc_compl%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ie_contab_tit_cancelado_w	parametro_contas_receber.ie_contab_tit_cancelado%type;
ie_concil_contab_w		pls_visible_false.ie_concil_contab%type;

c01 CURSOR FOR
	SELECT 	c.cd_tipo_lote_contab,
		14 nr_seq_info_ctb,
		'PLS_TITULO_REC_LIQ_MENS' nm_tabela,
		c.nm_atributo nm_atributo
	from	atributo_contab c
	where 	c.cd_tipo_lote_contab = 39
	and	c.nm_atributo = 'VL_REC_PLS_MENS'
	and	ie_concil_contab_w = 'S'
	and exists (	SELECT 	1
			from 	titulo_receber_liq y
			where	y.nr_seq_lote_enc_contas is null
			and     y.nr_seq_pls_lote_camara is null
			and	coalesce(y.ie_lib_caixa, 'S') = 'S'
			and	exists	(select	1
					from	titulo_receber x
					where	x.nr_titulo	= y.nr_titulo
					and	x.ie_pls	= 'S'
					and	x.ie_origem_titulo = '3'
					and	((x.ie_situacao	<> '3' or ie_contab_tit_cancelado_w = 'S')
					or (x.ie_situacao = '3' and y.vl_rec_maior <> 0)))
			and	y.nr_sequencia 	= NEW.nr_seq_baixa
			and	y.nr_titulo 	= NEW.nr_titulo);

	vet_c01 c01%rowtype;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
BEGIN
if (NEW.nr_seq_baixa is not null) and (NEW.nr_titulo is not null) then

	/*Esse select e para tentar evitar a duplicidade. Pois ao ao atualizar algo no titulo, pode chamar outra proc que atualiza classificacao ou imposto, que tb dispara a trigger das tabelas com esse insert*/


	select	count(*)
	into STRICT	qt_reg_w
	from	intpd_fila_transmissao
	where  	nr_seq_documento 	= to_char(NEW.nr_titulo)
	and	nr_seq_item_documento	= to_char(NEW.nr_seq_baixa)
	and     to_char(dt_atualizacao, 'dd/mm/yyyy hh24:mi:ss') = to_char(LOCALTIMESTAMP,'dd/mm/yyyy hh24:mi:ss');
	
	if (qt_reg_w = 0) then
		reg_integracao_p.nr_seq_item_documento_p :=	NEW.nr_seq_baixa;
		reg_integracao_p := gerar_int_padrao.gravar_integracao('27', NEW.nr_titulo, NEW.nm_usuario, reg_integracao_p);
	end if;
	
end if;

select 	a.cd_estabelecimento,
	c.dt_contabil,
	b.nr_seq_trans_fin,
	a.nr_titulo,
	b.nr_sequencia
into STRICT	cd_estabelecimento_w,
	dt_movimento_w,
	nr_seq_trans_financ_w,
	nr_documento_w,
	nr_seq_doc_compl_w
from	titulo_receber a,
	titulo_receber_liq b,
	pls_titulo_rec_liq_mens c
where	a.nr_titulo = b.nr_titulo
and	b.nr_titulo = c.nr_titulo
and	b.nr_sequencia = c.nr_seq_baixa
and	c.nr_sequencia = NEW.nr_sequencia;

exception when others then
	nr_seq_trans_financ_w	:= null;
end;

select	coalesce(max(ie_concil_contab), 'N')
into STRICT	ie_concil_contab_w
from	pls_visible_false
where	cd_estabelecimento = cd_estabelecimento_w;

select  coalesce(max(ie_contab_tit_cancelado), 'S')
into STRICT   	ie_contab_tit_cancelado_w
from    parametro_contas_receber
where   cd_estabelecimento = cd_estabelecimento_w;

if (coalesce(NEW.vl_lancamento, 0) <> 0 and coalesce(nr_seq_trans_financ_w,0) <> 0) then
	open c01;
	loop
	fetch c01 into
		vet_c01;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN

	CALL ctb_concil_financeira_pck.ctb_gravar_documento(       cd_estabelecimento_w,
								dt_movimento_w,
								vet_c01.cd_tipo_lote_contab,
								nr_seq_trans_financ_w,
								vet_c01.nr_seq_info_ctb,
								nr_documento_w,
								nr_seq_doc_compl_w,
								NEW.nr_sequencia,
								NEW.vl_lancamento,
								vet_c01.nm_tabela,
								vet_c01.nm_atributo,
								NEW.nm_usuario);

	end;
	end loop;
	close c01;
				
end if;
end if;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_titulo_rec_liq_mens_after() FROM PUBLIC;

CREATE TRIGGER pls_titulo_rec_liq_mens_after
	AFTER INSERT OR UPDATE ON pls_titulo_rec_liq_mens FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_titulo_rec_liq_mens_after();

