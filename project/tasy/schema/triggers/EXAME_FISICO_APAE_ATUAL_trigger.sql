-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS exame_fisico_apae_atual ON exame_fisico_apae CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_exame_fisico_apae_atual() RETURNS trigger AS $BODY$
declare

nr_cirurgia_w	bigint;
qt_peso_w	double precision;
BEGIN
  BEGIN
BEGIN
select 	max(coalesce(nr_cirurgia,0))
into STRICT		nr_cirurgia_w
from		aval_pre_anestesica
where 	nr_sequencia	=	NEW.nr_seq_aval_pre;

if (nr_cirurgia_w > 0) then
	select 	coalesce(max(qt_peso),0)
	into STRICT		qt_peso_w
	from		cirurgia
	where		nr_cirurgia = nr_cirurgia_w;

	if (qt_peso_w = 0) and (NEW.qt_peso is not null) then
		update	cirurgia
		set		qt_peso	 	=	NEW.qt_peso
		where		nr_cirurgia = nr_cirurgia_w;
	end if;
end if;

exception
when others then
	nr_cirurgia_w := 0;
end;


  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_exame_fisico_apae_atual() FROM PUBLIC;

CREATE TRIGGER exame_fisico_apae_atual
	BEFORE INSERT OR UPDATE ON exame_fisico_apae FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_exame_fisico_apae_atual();

