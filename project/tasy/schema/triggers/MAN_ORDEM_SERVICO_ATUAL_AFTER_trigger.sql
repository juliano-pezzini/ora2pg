-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS man_ordem_servico_atual_after ON man_ordem_servico CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_man_ordem_servico_atual_after() RETURNS trigger AS $BODY$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
	Parâmetro 299 - [194] - Enviar comunicação interna ao solicitante ao alterar o estágio da ordem de serviço
-------------------------------------------------------------------------------------------------------------------

Referências:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


nm_usuario_exec_w		varchar(15);
qt_reg_w				smallint;
nm_user_w			varchar(30);
nr_seq_funcao_w			bigint;
nr_seq_gerencia_w			bigint;
nr_seq_gerencia_sup_w		bigint;
qt_existe_w			bigint;

ie_desenv_w			varchar(01) := 'S';
nr_seq_plano_w			bigint;
nr_seq_meta_os_w     	   	bigint;
ie_tipo_os_meta_w			varchar(03);
dt_geracao_meta_w		timestamp;

nr_seq_proj_vinc_w			bigint;
nr_seq_proj_orig_w			bigint;
nr_seq_proj_acomp_w		bigint;
nr_seq_tipo_exec_w		bigint;
ie_adiciona_exec_w		varchar(15);
nm_usu_resp_geren_w		varchar(15);
nm_usuario_fila_w			varchar(50);
ds_sep_bv_w			varchar(50) := obter_separador_bv;
nr_seq_skill_w			FUNCAO_GRUPO_DES.NR_SEQ_SKILL%Type;
qt_existe_exec_w			bigint;

nr_seq_cliente_w			bigint;
ie_possui_executor_w		varchar(1);
ie_cliente_direto_w			varchar(1);
ie_envia_ci_alt_estagio_w		varchar(255);
nr_seq_classif_w			comunic_interna_classif.nr_sequencia%type;
nm_usuario_destino_w		usuario.nm_usuario%type;

BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;

if (NEW.nr_seq_grupo_des is not null) then
	
	if (coalesce(NEW.nr_seq_origem,0) > 0) then /*Verificar se é uma OS de revisão */


		select	max(nr_seq_gerencia)
		into STRICT	nr_seq_gerencia_w
		from	grupo_desenvolvimento
		where	nr_sequencia	= NEW.nr_seq_grupo_des;

		if (nr_seq_gerencia_w in (3,11)) and (NEW.nr_seq_localizacao = 1272) then
			select	max(a.nm_usuario_exec)
			into STRICT	nm_usuario_exec_w
			from	man_ordem_servico_exec a
			where	nr_seq_ordem = NEW.nr_seq_origem
			and		nm_usuario_exec <> 'Haertel'
			and		dt_fim_execucao is null
			and		exists (	SELECT	1
						from	usuario_grupo_des b
						where	a.nm_usuario_exec	= b.nm_usuario_grupo
						and	coalesce(b.IE_FUNCAO_USUARIO,'XPTO') <> 'N');

			if (nm_usuario_exec_w is not null) then
				select	max(nm_usuario_exec)
				into STRICT	nm_usuario_fila_w
				from	man_ordem_servico_exec a
				where	nr_seq_ordem = NEW.nr_seq_origem
				and	dt_fim_execucao is not null
				and	exists (	SELECT	1
						from	cadastro_fila b
						where	a.nm_usuario_exec = b.nm_usuario_fila);
			end if;
		end if;
	end if;
	
	if (nm_usuario_exec_w is null) then
		Select	min(a.nm_usuario_exec),
			min(a.nr_seq_skill)
		into STRICT	nm_usuario_exec_w,
			nr_seq_skill_w
		from	funcao_grupo_des a,
			funcao_grupo_des_cli c
		where	a.cd_funcao	= NEW.cd_funcao
		and	a.nr_seq_grupo	= NEW.nr_seq_grupo_des
		AND	a.nr_sequencia = c.nr_seq_funcao_grupo
		and	c.nr_seq_localizacao = NEW.nr_seq_localizacao;
		
		if (nm_usuario_exec_w is null) then
			Select	coalesce(min(a.nm_usuario_exec), obter_executor_desenv_item(NEW.nr_seq_func_item, NEW.cd_funcao, NEW.nr_seq_grupo_des)),
				min(a.nr_seq_skill)
			into STRICT	nm_usuario_exec_w,
				nr_seq_skill_w
			from	funcao_grupo_des a
			where	a.cd_funcao	= NEW.cd_funcao
			and	a.nr_seq_grupo	= NEW.nr_seq_grupo_des
			and	coalesce(a.nr_seq_func_item, 0) = coalesce(NEW.nr_seq_func_item, 0)
			and	not exists (SELECT 1
				from	funcao_grupo_des_cli x
				where	a.nr_sequencia = x.nr_seq_funcao_grupo);
		end if;
	end if;
	
else
	Select	min(a.nm_usuario_exec),
		min(a.nr_seq_skill)
	into STRICT	nm_usuario_exec_w,
		nr_seq_skill_w
	from	grupo_desenvolvimento b,
		funcao_grupo_des a,
		funcao_grupo_des_cli c
	where	a.nr_seq_grupo	= b.nr_sequencia
	and	a.cd_funcao	= NEW.cd_funcao
	AND	a.nr_sequencia = c.nr_seq_funcao_grupo
	and	c.nr_seq_localizacao = NEW.nr_seq_localizacao;
	
	if (nm_usuario_exec_w is null) then		
		select	coalesce(min(a.nm_usuario_exec), obter_executor_desenv_item(NEW.nr_seq_func_item, NEW.cd_funcao,NEW.nr_seq_grupo_des)),
			min(a.nr_seq_skill)
			into STRICT nm_usuario_exec_w,
			nr_seq_skill_w
		from	funcao_grupo_des a
		where	a.cd_funcao = NEW.cd_funcao
		and	coalesce(a.nr_seq_func_item, 0) = coalesce(NEW.nr_seq_func_item, 0)
		and not exists (SELECT	1
				from	funcao_grupo_des_cli x
				where	a.nr_sequencia = x.nr_seq_funcao_grupo);
	end if;
end if;

select	count(*)
into STRICT	qt_existe_w
from	man_ordem_servico_exec a
where	a.nr_seq_ordem	= NEW.nr_sequencia
and	exists (	SELECT	1
			from	usuario_grupo_des b
			where	a.nm_usuario_exec	= b.NM_USUARIO_GRUPO
			and	b.nr_seq_grupo		= NEW.nr_seq_grupo_des);	--**

select	username
into STRICT	nm_user_w
from	user_users;
	
if (NEW.nr_seq_corresp is null) and (nm_usuario_exec_w is not null) and (qt_existe_w = 0) then
	if (nm_user_w = 'CORP') then
		nr_seq_funcao_w	:= 31; /* Analise */

		
		/* Francisco/Adriano - 18/08/2010 - Colocar como responsável pela Análise */


		select	max(a.nr_sequencia)
		into STRICT	nr_seq_tipo_exec_w
		from	man_tipo_executor a
		where	a.ie_tipo_executor	= 3;
	end if;
	
	select	count(*)
	into STRICT	qt_existe_exec_w
	from	man_ordem_servico_exec
	where	nr_seq_ordem = NEW.nr_sequencia
	and	nm_usuario_exec = nm_usuario_exec_w;
	
	if (qt_existe_exec_w = 0) then
		insert into man_ordem_servico_exec(
			nr_sequencia,
			nr_seq_ordem,
			dt_atualizacao,
			nm_usuario,
			nm_usuario_exec,
			qt_min_prev,
			dt_recebimento,
			nr_seq_funcao,
			nr_seq_tipo_exec)
		SELECT	nextval('man_ordem_servico_exec_seq'),
			NEW.nr_sequencia,
			LOCALTIMESTAMP,
			'Tasy',
			nm_usuario_exec_w,
			CASE WHEN nm_user_w='CORP' THEN 10  ELSE 45 END ,/*45,  Francisco - 14/12/2010, mudei para 10 a pedido do Marcus */

			LOCALTIMESTAMP,
			nr_seq_funcao_w,
			nr_seq_tipo_exec_w
		;
	end if;
	
	if (nm_user_w = 'CORP') then /* Gravar Ativ Prev de Análise do lider*/

		/* Francisco - 04/12/2010 - O Marcus solicitou para fazer esta alteração, pois a partir desta data o analista deve definir
		as atividades previstas, os tempos e as datas */

		CALL man_gerar_ativ_prevista(NEW.nr_sequencia, nr_seq_funcao_w, 60, nm_usuario_exec_w,'N', 'Tasy',28,NEW.ie_classificacao, NEW.nr_seq_estagio, coalesce(NEW.nr_seq_origem,0), NEW.NR_SEQ_LOCALIZACAO, nr_seq_gerencia_w);
		null;
	end if;
	
	if (nm_usuario_fila_w is not null) then /* Inserir o executor da fila da OS de origem! */

		select	count(*)
		into STRICT	qt_existe_exec_w
		from	man_ordem_servico_exec
		where	nr_seq_ordem = NEW.nr_sequencia
		and	nm_usuario_exec = nm_usuario_fila_w;
		
		if (qt_existe_exec_w = 0) then
			insert into man_ordem_servico_exec(
				nr_sequencia,
				nr_seq_ordem,
				dt_atualizacao,
				nm_usuario,
				nm_usuario_exec,
				qt_min_prev,
				dt_recebimento,
				nr_seq_funcao,
				nr_seq_tipo_exec,
				dt_fim_execucao)
			SELECT	nextval('man_ordem_servico_exec_seq'),
				NEW.nr_sequencia,
				LOCALTIMESTAMP,
				'Tasy',
				nm_usuario_fila_w,
				CASE WHEN nm_user_w='CORP' THEN 10  ELSE 45 END ,/*45,  Francisco - 14/12/2010, mudei para 10 a pedido do Marcus */

				LOCALTIMESTAMP,
				nr_seq_funcao_w,
				nr_seq_tipo_exec_w,
				LOCALTIMESTAMP
			;		
		end if;	
	end if;
	
	if (nr_seq_skill_w is not null) then
		select  max(ie_desenv)
		into STRICT    ie_desenv_w
		from    man_estagio_processo
		where   nr_sequencia    = NEW.nr_seq_estagio;
		
		if (ie_desenv_w = 'S') then
			insert into man_ordem_serv_skill(
				nr_sequencia,
				nr_seq_ordem_serv,
				nr_seq_skill,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec)
			values (	nextval('man_ordem_serv_skill_seq'),
				NEW.nr_sequencia,
				nr_seq_skill_w,
				LOCALTIMESTAMP,
				'Tasy',
				LOCALTIMESTAMP,
				'Tasy');
		end if;
		
	end if;
	
end if;

if (TG_OP = 'INSERT') and		/*Solicitação OS330098 - OS's do HSC serão sempre direcionadas ao desenvolvimento e sempre terão o usuário da Bruna*/

	(nm_user_w = 'CORP') and (NEW.ie_classificacao = 'E') and (NEW.nr_seq_localizacao = 15) then
	BEGIN
	select	count(*)
	into STRICT	qt_existe_w
	from	man_ordem_servico_exec
	where	nr_seq_ordem	= NEW.nr_sequencia
	and	nm_usuario_exec	= 'Bruna';
	
	if (qt_existe_w = 0) then
		insert into man_ordem_servico_exec(
				nr_sequencia,
				nr_seq_ordem,
				dt_atualizacao,
				nm_usuario,
				nm_usuario_exec,
				qt_min_prev,
				dt_recebimento,
				nr_seq_funcao,
				nr_seq_tipo_exec)
			values (	nextval('man_ordem_servico_exec_seq'),
				NEW.nr_sequencia,
				LOCALTIMESTAMP,
				'Tasy',
				'Bruna',
				10,
				LOCALTIMESTAMP,
				null,
				3);
	end if;
	end;
end if;

if (TG_OP = 'INSERT') and (nm_user_w = 'CORP') then
	BEGIN
	select	max(nr_seq_gerencia)
	into STRICT	nr_seq_gerencia_w
	from	grupo_desenvolvimento
	where	nr_sequencia	= NEW.nr_seq_grupo_des;
	
	select	max(ie_adiciona_executor)
	into STRICT	ie_adiciona_exec_w
	from	desenv_regra_os_cliente
	where	nr_sequencia = (SELECT	max(nr_sequencia)
				from	desenv_regra_os_cliente
				where	coalesce(nr_seq_localizacao,NEW.nr_seq_localizacao) = NEW.nr_seq_localizacao
				and	coalesce(ie_classificacao,NEW.ie_classificacao) = NEW.ie_classificacao
				and	coalesce(nr_seq_gerencia,nr_seq_gerencia_w) = nr_seq_gerencia_w
				and	ie_situacao = 'A');
	
	select	max(b.nm_usuario)
	into STRICT	nm_usu_resp_geren_w
	from	usuario b,
		gerencia_wheb a
	where	b.cd_pessoa_fisica = a.cd_responsavel
	and	a.nr_sequencia = nr_seq_gerencia_w;
	
	if (coalesce(ie_adiciona_exec_w,'N') = 'S') and (coalesce(nm_usu_resp_geren_w, 'X') <> 'X') then
		BEGIN
		select	count(*)
		into STRICT	qt_existe_w
		from	man_ordem_servico_exec
		where	nr_seq_ordem	= NEW.nr_sequencia
		and	nm_usuario_exec	= nm_usu_resp_geren_w;
		
		if (qt_existe_w = 0) then
			insert into man_ordem_servico_exec(
					nr_sequencia,
					nr_seq_ordem,
					dt_atualizacao,
					nm_usuario,
					nm_usuario_exec,
					qt_min_prev,
					dt_recebimento,
					nr_seq_funcao,
					nr_seq_tipo_exec)
				values (	nextval('man_ordem_servico_exec_seq'),
					NEW.nr_sequencia,
					LOCALTIMESTAMP,
					'Tasy',
					nm_usu_resp_geren_w,
					10,
					LOCALTIMESTAMP,
					null,
					3);
		end if;
		end;
	end if;
	end;
end if;

if (OLD.cd_funcao is not null) and (NEW.cd_funcao <> OLD.cd_funcao) then	
	insert into man_ordem_serv_funcao(
			nr_sequencia,
			nr_seq_ordem_serv,
			cd_funcao,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (	nextval('man_ordem_serv_funcao_seq'),
			NEW.nr_sequencia,
			OLD.cd_funcao,
			LOCALTIMESTAMP,
			NEW.nm_usuario,
			LOCALTIMESTAMP,
			NEW.nm_usuario);
end if;

select	max(a.nm_usuario_lider),
	max(a.nr_seq_gerencia_sup)
into STRICT	nm_usuario_exec_w,
	nr_seq_gerencia_sup_w
from	grupo_suporte a
where	a.nr_sequencia = NEW.nr_seq_grupo_sup;
		
/*Anderson em 27/05/2010 - Ao passar automaticamente para desenv. aguardando triagem, 
o usuário do suporte não esta mais sendo criado, gerar o líder do grupo do suporte nestes casos*/

if (nm_user_w = 'CORP') then
	BEGIN
	if 	/*( :new.nr_seq_estagio = 1051) and -- Aguardando Triagem desenvolvimento - retirei tratamento do estágio, pois ao alterar apenas a função, ele não gerava o usuário suporte*/

		(NEW.ie_classificacao in ('T','S','E')) then /*Solicitação / Sugestão / Erro*/

		BEGIN
		select	max(nr_seq_gerencia)
		into STRICT	nr_seq_gerencia_w
		from	grupo_desenvolvimento
		where	nr_sequencia	= NEW.nr_seq_grupo_des;
	
		if (nr_seq_gerencia_w in (2,3,4,7,11,17,20,21,60)) then			
			BEGIN
			if (coalesce(nr_seq_gerencia_sup_w,0) <> 12) and (NEW.nr_seq_proj_cron_etapa is null) and (NEW.cd_funcao is not null) then /*Não deve gerar o líder do grupo 'testes' pois a própria analista de testes se coloca como executora*/

				select	count(*)
				into STRICT	qt_existe_w
				from	man_ordem_servico_exec
				where	nm_usuario_exec	= coalesce(nm_usuario_exec_w,'Simone')
				and	nr_seq_ordem	= NEW.nr_sequencia;
				
				if (qt_existe_w = 0) then
					insert into man_ordem_servico_exec(
						nr_sequencia,
						nr_seq_ordem,
						dt_atualizacao,
						nm_usuario,
						nm_usuario_exec,
						qt_min_prev,
						dt_recebimento,
						nr_seq_funcao)
					SELECT	nextval('man_ordem_servico_exec_seq'),
						NEW.nr_sequencia,
						LOCALTIMESTAMP,
						'Tasy',
						coalesce(nm_usuario_exec_w,'Simone'),
						45,
						LOCALTIMESTAMP,
						nr_seq_funcao_w
					;
				end if;
			end if;
			end;
		end if;
		end;
	end if;
	
	if (TG_OP = 'UPDATE') and (NEW.ie_status_ordem = 3) then
		BEGIN
		select	count(*)
		into STRICT	qt_existe_w
		from	proj_ata_pendencia b,
			proj_ata_pendencia_os a
		where	a.nr_seq_ordem 		= NEW.nr_sequencia
		and	a.nr_seq_pendencia	= b.nr_sequencia
		and	b.ie_status 		<> 'C'; /*concluida*/

		
		if (qt_existe_w > 0) then
			update	proj_ata_pendencia b
			set	b.ie_status 		= 'C',
				b.dt_conclusao_real	= LOCALTIMESTAMP,
				b.dt_atualizacao	= LOCALTIMESTAMP,
				b.nm_usuario		= NEW.nm_usuario
			where	exists (SELECT	1
					from	proj_ata_pendencia_os a
					where	a.nr_seq_ordem 		= NEW.nr_sequencia
					and	a.nr_seq_pendencia	= b.nr_sequencia)
			and	b.ie_status 		<> 'C';
		end if;
		end;
	end if;
	end;
end if;

if (nm_user_w = 'CORP') and (coalesce(nm_usuario_exec_w,'X') <> 'X') and (NEW.nr_seq_grupo_sup is not null) and	
	((TG_OP = 'INSERT' and NEW.nr_seq_grupo_sup <> 31) or (not TG_OP = 'INSERT')) then	/*Testes - ao cadastrar não deve ir para ninguém, elas que adicionam o executor*/

	/*Só adicionar o analista/líder do suporte caso não tenha nenhum usuário do grupo como executor*/


	select	count(*)
	into STRICT	qt_existe_w
	from	usuario_grupo_sup b,
		man_ordem_servico_exec a
	where	a.nr_seq_ordem	= NEW.nr_sequencia
	and	b.nr_seq_grupo	= NEW.nr_seq_grupo_sup
	and	a.nm_usuario_exec = b.nm_usuario_grupo;
	
	select	count(*)
	into STRICT	qt_existe_exec_w
	from	man_ordem_servico_exec
	where	nr_seq_ordem = NEW.nr_sequencia
	and	nm_usuario_exec = coalesce(nm_usuario_exec_w,'Simone');
	
	if (qt_existe_w = 0) and (qt_existe_exec_w = 0)then
		insert into man_ordem_servico_exec(
			nr_sequencia,
			nr_seq_ordem,
			dt_atualizacao,
			nm_usuario,
			nm_usuario_exec,
			qt_min_prev,
			dt_recebimento,
			nr_seq_funcao)
		SELECT	nextval('man_ordem_servico_exec_seq'),
			NEW.nr_sequencia,
			LOCALTIMESTAMP,
			'Tasy',
			coalesce(nm_usuario_exec_w,'Simone'),
			45,
			LOCALTIMESTAMP,
			nr_seq_funcao_w
		;
	end if;
end if;

if (nm_user_w = 'CORP') and (NEW.nr_seq_estagio <> OLD.nr_seq_estagio) then
        BEGIN
        select  max(ie_desenv)
        into STRICT    ie_desenv_w
        from    man_estagio_processo
        where   nr_sequencia    = NEW.nr_seq_estagio;

		-------- GESTÃO DOS REQUISITOS LEVANTADOS NA ALEMANHA E OUTROS PAÍSES

		if (NEW.nr_seq_estagio in (2216,1811)) then -- Aguardando Informações Produto, Desenv pendente análise de negócio
			update	latam_requisito
			set		ie_situacao_req = 'P' -- Produto

			where  	nr_seq_ordem_serv = NEW.nr_sequencia;
		elsif (NEW.nr_seq_estagio in (2218,2226,2228,2230)) then -- Aguardando Informações GSS,  Aguardando Informações GSS - Cliente, Aguardando Informações GSS - Análise, Aguardando Informações GSS Configuração
			update	latam_requisito
			set		ie_situacao_req = 'C' -- Consultoria

			where  	nr_seq_ordem_serv = NEW.nr_sequencia;
		elsif (coalesce(ie_desenv_w,'N') = 'S') then -- Desenvolvimento
			update	latam_requisito
			set		ie_situacao_req = 'D' -- Desenvolvimento

			where  	nr_seq_ordem_serv = NEW.nr_sequencia;
		end if;

	select	substr(proj_obter_dados_ordem_serv(NEW.nr_sequencia, 'PROJ'),1,10) nr_seq_proj_vinc,
		substr(proj_obter_dados_ordem_serv(NEW.nr_sequencia, 'PROJD'),1,10) nr_seq_proj_orig,
		substr(proj_obter_dados_ordem_serv(NEW.nr_sequencia, 'PROJA'),1,10) nr_seq_proj_acomp
	into STRICT	nr_seq_proj_vinc_w,
		nr_seq_proj_orig_w,
		nr_seq_proj_acomp_w
	;
	
        if (ie_desenv_w = 'S') and (coalesce(nr_seq_proj_vinc_w,'0') = '0') and (coalesce(nr_seq_proj_orig_w,'0') = '0') and (coalesce(nr_seq_proj_acomp_w,'0') = '0') then
		
		select  max(nr_seq_gerencia)
		into STRICT    nr_seq_gerencia_w
		from    grupo_desenvolvimento
		where   nr_sequencia            = NEW.nr_seq_grupo_des;

		select  coalesce(max(nr_sequencia),0)
		into STRICT    nr_seq_plano_w
		from    desenvolvimento_plano_meta
		where   nr_seq_gerencia         = nr_seq_gerencia_w
		and     dt_meta_real is null;
					
		select	max(dt_geracao)
		into STRICT	dt_geracao_meta_w
		from	desenvolvimento_plano_meta
		where	nr_sequencia	= nr_seq_plano_w;

		if (nr_seq_plano_w > 0) and (dt_geracao_meta_w >= NEW.dt_ordem_servico) then
			select  count(*)
			into STRICT    qt_reg_w
			from    desenv_plano_meta_os
			where   nr_seq_plano            = nr_seq_plano_w
			and	NR_SEQ_ORDEM_SERV       = NEW.nr_sequencia;

			if (qt_reg_w = 0) then
				select  nextval('desenv_plano_meta_os_seq')
				into STRICT    nr_seq_meta_os_w
				;

				if (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), LOCALTIMESTAMP - interval '60 days') = 'S') then
					ie_tipo_os_meta_w	:= '0';
				elsif (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), LOCALTIMESTAMP - interval '59 days', LOCALTIMESTAMP - interval '45 days') = 'S') then
					ie_tipo_os_meta_w	:= '1';
				elsif (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), LOCALTIMESTAMP - interval '44 days', LOCALTIMESTAMP - interval '30 days') = 'S') then
					ie_tipo_os_meta_w	:= '2';
				elsif (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), LOCALTIMESTAMP - interval '29 days', LOCALTIMESTAMP - interval '15 days') = 'S') then
					ie_tipo_os_meta_w	:= '3';
				elsif (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), LOCALTIMESTAMP - interval '14 days', LOCALTIMESTAMP - interval '7 days') = 'S') then
					ie_tipo_os_meta_w	:= '4';
				elsif (obter_se_data_periodo(trunc(NEW.dt_ordem_servico, 'dd'), LOCALTIMESTAMP - interval '6 days', LOCALTIMESTAMP) = 'S') then
					ie_tipo_os_meta_w	:= '5';
				end if;
				
				if (ie_tipo_os_meta_w is not null) then
					insert  into desenv_plano_meta_os(nr_sequencia,
							nr_seq_plano,
							nr_seq_ordem_serv,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							ie_tipo_os_meta,
							nr_seq_estagio_orig,
							nr_seq_estagio_meta,
							ie_recorrente)
					values (nr_seq_meta_os_w,
							nr_seq_plano_w,
							NEW.nr_sequencia,
							LOCALTIMESTAMP,
							NEW.nm_usuario,
							LOCALTIMESTAMP,
							NEW.nm_usuario,
							ie_tipo_os_meta_w,
							NEW.nr_seq_estagio,
							null, 'S');
				end if;
			end if;
		end if;
	end if;
        end;
end if;

if (nm_user_w = 'CORP') and (NEW.ie_status_ordem = 3) and (coalesce(OLD.ie_status_ordem,1) <> NEW.ie_status_ordem) and (NEW.nr_seq_nivel_valor = 1) then
	BEGIN
	select	count(*)
	into STRICT	qt_existe_w
	from	gpw_pendencia
	where	nr_seq_ordem_serv = NEW.nr_sequencia;
	
	if (qt_existe_w = 0) then
		CALL exec_sql_dinamico_bv('','begin gpw_gerar_pendencia_ordem_serv(:nr_sequencia,:nm_usuario); end;',
					'nr_sequencia=' || NEW.nr_sequencia || ds_sep_bv_w ||
					'nm_usuario=' || NEW.nm_usuario || ds_sep_bv_w);
	end if;	
	end;
end if;

if (OLD.nr_seq_grupo_sup is not null) and (NEW.nr_seq_grupo_sup <> OLD.nr_seq_grupo_sup) then
	BEGIN
	insert	into man_ordem_log_grupo_sup(nr_sequencia,
					 dt_atualizacao,
					 nm_usuario,
					 dt_atualizacao_nrec,
					 nm_usuario_nrec,
					 nr_seq_ordem_serv,
					 nr_seq_grupo_sup)
		values (nextval('man_ordem_log_grupo_sup_seq'),
					 LOCALTIMESTAMP,
					 NEW.nm_usuario,
					 LOCALTIMESTAMP,
					 NEW.nm_usuario,
					 NEW.nr_sequencia,
					 NEW.nr_seq_grupo_sup);
	end;
end if;

if (TG_OP = 'INSERT') or
	((TG_OP = 'UPDATE') and (coalesce(NEW.nr_seq_grupo_des,0) <> coalesce(OLD.nr_seq_grupo_des,0))) then
	BEGIN
	insert	into man_ordem_log_grupo_des(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_ordem_serv,
		nr_seq_grupo_des,
		cd_funcao)
	values (	nextval('man_ordem_log_grupo_des_seq'),
		LOCALTIMESTAMP,
		coalesce(wheb_usuario_pck.get_nm_usuario, NEW.nm_usuario),
		LOCALTIMESTAMP,
		coalesce(wheb_usuario_pck.get_nm_usuario, NEW.nm_usuario),
		NEW.nr_sequencia,
		NEW.nr_seq_grupo_des,
		OLD.cd_funcao);
	end;
end if;

if (TG_OP = 'INSERT') and (user = 'CORP') then
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_possui_executor_w
	from	man_ordem_servico_exec
	where	nr_seq_ordem = NEW.nr_sequencia;
	
	if (ie_possui_executor_w = 'N') and (NEW.nr_seq_localizacao = 52) and (NEW.nr_seq_equipamento = 1362) and (NEW.nr_seq_estagio = 371) then
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_cliente_w
		from	com_cliente
		where	dt_atualizacao = (SELECT max(dt_atualizacao) from com_cliente);
		
		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_cliente_direto_w
		from	com_canal a,
			com_canal_cliente b
		where	a.nr_sequencia = b.nr_seq_canal
		and	a.nr_sequencia = 3 -- Philips
		and	b.ie_tipo_atuacao = 'V' -- Venda

		and	b.dt_fim_atuacao is null
		and	b.nr_seq_cliente = nr_seq_cliente_w;
		
		if (ie_cliente_direto_w = 'S') then
			select	max(nm_usuario)
			into STRICT	nm_usuario_exec_w
			from	usuario
			where	cd_pessoa_fisica = (	SELECT	max(cd_responsavel)
							from	gerencia_wheb
							where	nr_sequencia = NEW.nr_seq_localizacao); -- Pós vendas
		else
			nm_usuario_exec_w := 'EPolastri';
		end if;
		
		insert into man_ordem_servico_exec(	nr_sequencia,
							nr_seq_ordem, 
							dt_atualizacao, 
							nm_usuario, 
							nm_usuario_exec)
		values ( nextval('man_ordem_servico_exec_seq'),
			NEW.nr_sequencia,
			LOCALTIMESTAMP,
			'Tasy',
			nm_usuario_exec_w);
		
	end if;
end if;

if (OLD.nr_seq_estagio != NEW.nr_seq_estagio) and (OLD.nr_seq_estagio is not null) and (NEW.nr_seq_estagio is not null) then
	ie_envia_ci_alt_estagio_w	:= coalesce(Obter_Valor_Param_Usuario(299,194,Obter_Perfil_Ativo,NEW.nm_usuario,0),'N');

	if (ie_envia_ci_alt_estagio_w = 'S') then
		select	min(nr_sequencia)
		into STRICT	nr_seq_classif_w
		from	comunic_interna_classif
		where	ie_tipo	= 'F';

		CALL Gerar_Comunic_Padrao(LOCALTIMESTAMP,
			wheb_mensagem_pck.get_texto(439851,'NR_SEQ_ORDEM=' || NEW.nr_sequencia),
			wheb_mensagem_pck.get_texto(439852,'NR_SEQ_ORDEM=' || NEW.nr_sequencia || ';DS_EST_ANT=' || substr(man_obter_dados_estagio(OLD.nr_seq_estagio, 'D'),1,60) || ';DS_EST_ATUAL=' || substr(man_obter_dados_estagio(NEW.nr_seq_estagio, 'D'),1,60)),
			NEW.nm_usuario,
			'N',
			substr(obter_usuario_pessoa(NEW.cd_pessoa_solicitante),1,15),
			'N',
			nr_seq_classif_w,
			null,
			null,
			null,
			LOCALTIMESTAMP,
			null,
			null);
	end if;
end if;

nm_usuario_exec_w	:= null;
<<Final>>
qt_reg_w	:= 0;

RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_man_ordem_servico_atual_after() FROM PUBLIC;

CREATE TRIGGER man_ordem_servico_atual_after
	AFTER INSERT OR UPDATE ON man_ordem_servico FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_man_ordem_servico_atual_after();

