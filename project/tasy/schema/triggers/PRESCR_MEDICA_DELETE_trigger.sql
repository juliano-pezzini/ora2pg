-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_medica_delete ON prescr_medica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_medica_delete() RETURNS trigger AS $BODY$
DECLARE

ie_muda_status_w	varchar(1);
ds_erro_w		varchar(4000);
ie_excl_rep_lib_w	varchar(1);
qt_prescr_w		bigint;
ie_rep_cpoe_w		parametro_medico.ie_rep_cpoe%type;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

	ie_muda_status_w := obter_param_usuario(1700, 33, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_muda_status_w);
	ie_excl_rep_lib_w := obter_param_usuario(916, 945, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_excl_rep_lib_w);
		
	if (OLD.nr_seq_transcricao is not null) and (coalesce(ie_muda_status_w,'S') = 'S') then		/*David em 31/07/2008 OS 100500*/

		update	transcricao_prescricao
		set	ie_status	= 'S',
			nm_usuario_transcricao	 = NULL,
			dt_transcricao		 = NULL
		where	nr_sequencia	= OLD.nr_seq_transcricao;
	end if;

	if	((ie_excl_rep_lib_w = 'N') or (wheb_usuario_pck.get_cd_funcao = 924) or (wheb_usuario_pck.get_cd_funcao = 950)) and
		((coalesce(NEW.dt_liberacao, NEW.dt_liberacao_medico) is not null) or (coalesce(OLD.dt_liberacao, OLD.dt_liberacao_medico) is not null)) then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(193074);
	end if;
	
	select	coalesce(max(ie_rep_cpoe),'N')
	into STRICT	ie_rep_cpoe_w
	from 	parametro_medico
	where 	cd_estabelecimento  = wheb_usuario_pck.get_cd_estabelecimento;
	
	if (ie_rep_cpoe_w = 'S') then
		CALL gravar_log_cpoe(substr('PRESCR_MEDICA_DELETE TRIGGER '
				  || 'nr_prescricao: ' || OLD.nr_prescricao
							  || 'nr_atendimento: ' || OLD.nr_atendimento, 1,2000), OLD.nr_atendimento);
	end if;
						
	/* Francisco - 12/11/2009 - OS 178491 */


	update	autorizacao_cirurgia
	set	nr_prescricao	 = NULL
	where	nr_prescricao is not null
	and	nr_prescricao	= OLD.nr_prescricao;

	update 	autorizacao_convenio
	set	nr_prescricao  = NULL
	where	nr_prescricao is not null
	and	nr_prescricao = OLD.nr_prescricao;

	update	ageint_exame_lab
	set	nr_prescricao  = NULL
	where	nr_prescricao = OLD.nr_prescricao;

	update 	paciente_atendimento
	set		nr_prescricao  = NULL
	where	nr_prescricao = OLD.nr_prescricao;

	/*Desvincular a prescricao e o atendimento da prevenda, quando deleta*/


	update	pre_venda_item
	set	nr_atendimento  = NULL,
		nr_prescricao  = NULL,
		nr_seq_interno  = NULL
	where	nr_prescricao = NEW.nr_prescricao;
	
end if;

RETURN OLD;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_medica_delete() FROM PUBLIC;

CREATE TRIGGER prescr_medica_delete
	BEFORE DELETE ON prescr_medica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_medica_delete();

