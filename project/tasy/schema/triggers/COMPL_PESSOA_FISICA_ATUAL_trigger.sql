-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS compl_pessoa_fisica_atual ON compl_pessoa_fisica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_compl_pessoa_fisica_atual() RETURNS trigger AS $BODY$
DECLARE
nr_seq_cbos_tiss_w				bigint;
qt_reg_w						smallint;
nm_usuario_ww					varchar(20);
qt_registro_w					bigint;
ie_atualizar_email_usuario_w	varchar(1);
cd_estabelecimento_w			smallint;
ie_revisar_alt_w				varchar(10);
ie_lancar_mensagem_alt_w		varchar(10);
nr_seq_prestador_w				pls_prestador.nr_sequencia%type;
qt_valid_mail_w					bigint;
 
esocial_altera_cad_det_w	gerar_esocial_dados_pck.t_esocial_altera_cad_det;
 
c_prestadores CURSOR FOR 
	SELECT	a.nr_sequencia nr_seq_prestador 
	from	pls_prestador a 
	where	a.cd_pessoa_fisica = NEW.cd_pessoa_fisica;
BEGIN
  BEGIN 
 
select	coalesce(max(nm_usuario), 'X'), 
	max(cd_estabelecimento) 
into STRICT	nm_usuario_ww, 
	cd_estabelecimento_w 
from	usuario 
where	cd_pessoa_fisica	= NEW.cd_pessoa_fisica;
 
ie_atualizar_email_usuario_w := Obter_Param_Usuario(0, 166, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_atualizar_email_usuario_w);
 
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N') then 
	goto Final;
end if;
 
/*aaschlote 25/04/2013 - OS 574467 -Tratamento para a apresentação da mensagem de alteração enviada a análise*/
 
ie_lancar_mensagem_alt_w	:= pls_usuario_pck.get_ie_lancar_mensagem_alt;
 
	/* Coelho em 03/01/07 	OS45273 */
 
if	((NEW.nm_contato <> OLD.nm_contato) or (OLD.ds_fonetica is null )) then 
	NEW.ds_fonetica := gera_fonetica(NEW.nm_contato,'N');
end if;
 
if (NEW.cd_profissao is not null) and (OLD.cd_profissao is null) then 
	BEGIN 
	select	nr_seq_cbos_tiss 
	into STRICT	nr_seq_cbos_tiss_w 
	from	profissao 
	where	cd_profissao	= NEW.cd_profissao;
	exception 
	when others then 
		nr_seq_cbos_tiss_w	:= null;
	end;
	 
	update	pessoa_fisica 
	set	nr_seq_cbo_saude	= nr_seq_cbos_tiss_w, 
		nm_usuario 		= NEW.nm_usuario, 
		dt_atualizacao		= LOCALTIMESTAMP 
	where	cd_pessoa_fisica	= NEW.cd_pessoa_fisica 
	and	nr_seq_cbo_saude is null 
	and	nr_seq_cbos_tiss_w is not null;
end if;
 
/*aaschlote 27/12/2012 OS 524353*/
 
ie_revisar_alt_w := Obter_Param_Usuario(0, 189, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w, ie_revisar_alt_w);
 
ie_revisar_alt_w	:= coalesce(ie_revisar_alt_w,'R');
 
/* Francisco em 11/03/2008 - OS 82683 - Se é do plano e foi alterado, deve mudar o campo IE_REVISAR */
 
if (ie_revisar_alt_w <> 'M') then 
	select	count(*) 
	into STRICT	qt_registro_w 
	from	pls_contrato 
	where	cd_pf_estipulante	= NEW.cd_pessoa_fisica;
	 
	if (qt_registro_w > 0) then 
		update	pessoa_fisica 
		set	ie_revisar	= ie_revisar_alt_w, 
			nm_usuario 	= NEW.nm_usuario, 
			dt_atualizacao	= LOCALTIMESTAMP 
		where	cd_pessoa_fisica	= NEW.cd_pessoa_fisica;
	else 
		select	count(*) 
		into STRICT	qt_registro_w 
		from	pls_contrato_pagador 
		where	cd_pessoa_fisica	= NEW.cd_pessoa_fisica;
		 
		if (qt_registro_w > 0) then 
			update	pessoa_fisica 
			set	ie_revisar	= ie_revisar_alt_w, 
				nm_usuario 	= NEW.nm_usuario, 
				dt_atualizacao	= LOCALTIMESTAMP 
			where	cd_pessoa_fisica	= NEW.cd_pessoa_fisica;
		else 
			select	count(*) 
			into STRICT	qt_registro_w 
			from	pls_segurado 
			where	cd_pessoa_fisica	= NEW.cd_pessoa_fisica;
			 
			if (qt_registro_w > 0) then 
				update	pessoa_fisica 
				set	ie_revisar	= ie_revisar_alt_w, 
					nm_usuario 	= NEW.nm_usuario, 
					dt_atualizacao	= LOCALTIMESTAMP 
				where	cd_pessoa_fisica	= NEW.cd_pessoa_fisica;
			else 
				select	count(*) 
				into STRICT	qt_registro_w 
				from	pls_prestador 
				where	cd_pessoa_fisica = NEW.cd_pessoa_fisica;
				 
				if (qt_registro_w > 0) then 
					update	pessoa_fisica 
					set	ie_revisar	= ie_revisar_alt_w, 
						nm_usuario 	= NEW.nm_usuario, 
						dt_atualizacao	= LOCALTIMESTAMP 
					where	cd_pessoa_fisica	= NEW.cd_pessoa_fisica;
				end if;
			end if;
		end if;
	end if;
end if;
/* Fim Francisco em 11/03/2008 */
 
 
/*    Coelho 03/07/2008 OS95248 */
 
if (NEW.nm_contato	<> OLD.nm_contato) or (NEW.nm_contato_pesquisa is null) then 
	NEW.nm_contato_pesquisa	:= padronizar_nome(NEW.nm_contato);
end if;
 
if (nm_usuario_ww <> 'X') and (NEW.ie_tipo_complemento = 1) and (NEW.ds_email <> OLD.ds_email) and (ie_atualizar_email_usuario_w = 'S') then 
	update	usuario 
	set	ds_email	= NEW.ds_email 
	where	nm_usuario	= nm_usuario_ww;
end if;
 
BEGIN 
if (NEW.ie_tipo_complemento = 1) and (TG_OP = 'UPDATE') then 
 
	open c_prestadores;
	loop 
	fetch c_prestadores into 
		nr_seq_prestador_w;
	EXIT WHEN NOT FOUND; /* apply on c_prestadores */
		BEGIN 
		 
		/* Verifica se houve alteração em algum dos campos utilizados no E-Social */
 
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('CD_CEP', OLD.cd_cep, NEW.cd_cep, esocial_altera_cad_det_w);
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('NR_CPF', OLD.nr_cpf, NEW.nr_cpf, esocial_altera_cad_det_w);
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('NR_DDD_TELEFONE', OLD.nr_ddd_telefone, NEW.nr_ddd_telefone, esocial_altera_cad_det_w);
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('NR_DDI_TELEFONE', OLD.nr_ddi_telefone, NEW.nr_ddi_telefone, esocial_altera_cad_det_w);
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('NR_ENDERECO', OLD.nr_endereco, NEW.nr_endereco, esocial_altera_cad_det_w);
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('NR_IDENTIDADE', OLD.nr_identidade, NEW.nr_identidade, esocial_altera_cad_det_w);
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('NR_TELEFONE', OLD.nr_telefone, NEW.nr_telefone, esocial_altera_cad_det_w);
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('SG_ESTADO', OLD.sg_estado, NEW.sg_estado, esocial_altera_cad_det_w);
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('CD_TIPO_LOGRADOURO', OLD.cd_tipo_logradouro, NEW.cd_tipo_logradouro, esocial_altera_cad_det_w);
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('DS_BAIRRO', OLD.ds_bairro, NEW.ds_bairro, esocial_altera_cad_det_w);
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('DS_COMPLEMENTO', OLD.ds_complemento, NEW.ds_complemento, esocial_altera_cad_det_w);
		esocial_altera_cad_det_w := gerar_esocial_dados_pck.adicionar_alteracao_cad_det('DS_ENDERECO', OLD.ds_endereco, NEW.ds_endereco, esocial_altera_cad_det_w);
		 
		if (esocial_altera_cad_det_w.count > 0) then		 
			esocial_altera_cad_det_w := gerar_esocial_dados_pck.gravar_alteracao_cad_det(nr_seq_prestador_w, NEW.nm_usuario, esocial_altera_cad_det_w);		
		end if;
		 
		end;
	end loop;
	close c_prestadores;
end if;
exception 
when others then 
	nr_seq_prestador_w	:= null;
end;
 
--Validar se e-mail informado está correto 
if (NEW.ds_email is not null) or (OLD.ds_email is not null) then	 
	 
	select count(*) 
	into STRICT  qt_valid_mail_w 
	 
	where  REGEXP_LIKE(NEW.ds_email,'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,8}$');	
	 
	if	((qt_valid_mail_w = 0) and (coalesce((pkg_i18n.get_user_locale), 'pt_BR') = 'es_MX')) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(139551);
	end if;
	 
end if;
 
 
CALL pls_usuario_pck.set_ie_lancar_mensagem_alt(ie_lancar_mensagem_alt_w);
 
<<Final>> 
qt_reg_w	:= 0;
 
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_compl_pessoa_fisica_atual() FROM PUBLIC;

CREATE TRIGGER compl_pessoa_fisica_atual
	BEFORE INSERT OR UPDATE ON compl_pessoa_fisica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_compl_pessoa_fisica_atual();

