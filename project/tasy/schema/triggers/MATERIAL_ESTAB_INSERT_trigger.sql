-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_estab_insert ON material_estab CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_estab_insert() RETURNS trigger AS $BODY$
declare
ie_estoque_lote_w   material_estab.ie_estoque_lote%type;
cd_material_estoque_w   material.cd_material_estoque%type;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

    if (NEW.ie_estoque_lote <> OLD.ie_estoque_lote or OLD.ie_estoque_lote is null) then

        BEGIN
        select	cd_material_estoque
        into STRICT	cd_material_estoque_w
        from	material
        where	cd_material = NEW.cd_material;
        exception
                when others then
            cd_material_estoque_w := '';
        end;
        if (cd_material_estoque_w <> NEW.cd_material) then
            BEGIN
            select ie_estoque_lote
            into STRICT ie_estoque_lote_w
            from material_estab
            where cd_material = cd_material_estoque_w
            and cd_estabelecimento = NEW.cd_estabelecimento;
            exception
                    when others then
                ie_estoque_lote_w := '';
            end;
            if (ie_estoque_lote_w <> NEW.ie_estoque_lote and ie_estoque_lote_w <> '') then
               if (TG_OP = 'UPDATE') then
                    CALL Wheb_mensagem_pck.exibir_mensagem_abort(1140301);
                else
                    NEW.ie_estoque_lote := ie_estoque_lote_w;
                end if;
            end if;

        end if;

    end if;

end if;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_estab_insert() FROM PUBLIC;

CREATE TRIGGER material_estab_insert
	BEFORE INSERT OR UPDATE ON material_estab FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_estab_insert();

