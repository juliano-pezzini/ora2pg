-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_mif_atual ON escala_mif CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_mif_atual() RETURNS trigger AS $BODY$
DECLARE
    sql_w            varchar(300);
    qt_reg_w         smallint;
    qt_pontuacao_w   bigint;
    ds_erro_w        varchar(4000);
    ds_parametros_w  varchar(4000);
BEGIN
  BEGIN
    IF ( NEW.nr_hora IS NULL ) OR ( NEW.dt_avaliacao <> OLD.dt_avaliacao ) THEN
        BEGIN
            NEW.nr_hora := (to_char(round(NEW.dt_avaliacao, 'hh24'), 'hh24'))::numeric;

        END;
    END IF;

    IF ( wheb_usuario_pck.get_ie_executar_trigger = 'N' ) THEN
        GOTO final;
    END IF;
    BEGIN
        sql_w := 'CALL OBTER_SCORE_ESCALA_MIF_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16, :17, :18) into :qt_pontuacao_w';
        EXECUTE sql_w
            USING IN NEW.qt_alimentacao, IN NEW.qt_higiene_pessoal, IN NEW.qt_banho, IN NEW.qt_vest_tronc_sup, IN NEW.qt_vest_tronc_inf,
            IN NEW.qt_sanitario, IN NEW.qt_controle_vesical, IN NEW.qt_controle_intestinal, IN NEW.qt_trans_leito, IN NEW.qt_trans_sanitario,
            IN NEW.qt_trans_banheiro, IN NEW.qt_loc_cadeira, IN NEW.qt_escada, IN NEW.qt_comp_audicao, IN NEW.qt_expressao, IN NEW.qt_problema,
            IN NEW.qt_interacao_social, IN NEW.qt_memoria, OUT qt_pontuacao_w;

    EXCEPTION
        WHEN OTHERS THEN
            ds_erro_w := sqlerrm;
            ds_parametros_w := ( ':new.nr_atendimento: '
                                 || NEW.nr_atendimento
                                 || '-'
                                 || ':new.cd_profissional: '
                                 || NEW.cd_profissional
                                 || '-'
                                 || ':new.ie_situacao: '
                                 || NEW.ie_situacao
                                 || '-'
                                 || ':new.qt_alimentacao: '
                                 || NEW.qt_alimentacao
                                 || '-'
                                 || ':new.qt_higiene_pessoal: '
                                 || NEW.qt_higiene_pessoal
                                 || '-'
                                 || ':new.qt_banho: '
                                 || NEW.qt_banho
                                 || '-'
                                 || ':new.qt_vest_tronc_sup: '
                                 || NEW.qt_vest_tronc_sup
                                 || '-'
                                 || ':new.qt_vest_tronc_inf: '
                                 || NEW.qt_vest_tronc_inf
                                 || '-'
                                 || ':new.qt_sanitario: '
                                 || NEW.qt_sanitario
                                 || '-'
                                 || ':new.qt_controle_vesical: '
                                 || NEW.qt_controle_vesical
                                 || '-'
                                 || ':new.qt_controle_intestinal: '
                                 || NEW.qt_controle_intestinal
                                 || '-'
                                 || ':new.qt_trans_leito: '
                                 || NEW.qt_trans_leito
                                 || '-'
                                 || ':new.qt_trans_sanitario: '
                                 || NEW.qt_trans_sanitario
                                 || '-'
                                 || ':new.qt_trans_banheiro: '
                                 || NEW.qt_trans_banheiro
                                 || '-'
                                 || ':new.qt_loc_cadeira: '
                                 || NEW.qt_loc_cadeira
                                 || '-'
                                 || ':new.qt_escada: '
                                 || NEW.qt_escada
                                 || '-'
                                 || ':new.qt_comp_audicao: '
                                 || NEW.qt_comp_audicao
                                 || '-'
                                 || ':new.qt_loc_cadeira: '
                                 || NEW.qt_expressao
                                 || '-'
                                 || ':new.qt_problema: '
                                 || NEW.qt_problema
                                 || '-'
                                 || ':new.qt_interacao_social: '
                                 || NEW.qt_interacao_social
                                 || '-'
                                 || ':new.qt_memoria: '
                                 || NEW.qt_memoria
                                 || '-'
                                 || 'qt_pontuacao_w: '
                                 || qt_pontuacao_w );

            CALL gravar_log_medical_device('escala_mif_atual', 'OBTER_SCORE_ESCALA_MIF_MD',
                                     ds_parametros_w,
                                     substr(ds_erro_w, 4000),
                                     NEW.nm_usuario,
                                     'N');

            qt_pontuacao_w := NULL;
    END;

    NEW.qt_pontuacao := qt_pontuacao_w;
    << final >> qt_reg_w := 0;
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_mif_atual() FROM PUBLIC;

CREATE TRIGGER escala_mif_atual
	BEFORE INSERT OR UPDATE ON escala_mif FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_mif_atual();

