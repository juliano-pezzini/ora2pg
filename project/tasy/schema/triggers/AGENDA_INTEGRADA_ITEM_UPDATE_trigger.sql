-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS agenda_integrada_item_update ON agenda_integrada_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_agenda_integrada_item_update() RETURNS trigger AS $BODY$
DECLARE

cd_estabelecimento_w	smallint;
cd_convenio_w		integer;
cd_categoria_w		varchar(10);
dt_inicio_agendamento_w	timestamp;
cd_plano_w		varchar(10);
vl_procedimento_w	double precision;
vl_aux_w		double precision;
ds_aux_w		varchar(10);
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
cd_convenio_ww		integer;
cd_categoria_ww		varchar(10);
cd_plano_ww		varchar(10);
ie_tipo_convenio_w	smallint;
ie_regra_w		integer;
ie_glosa_w		varchar(1);
cd_usuario_convenio_w	varchar(30);
qt_idade_w		smallint;
dt_nascimento_w		timestamp;
ie_Sexo_w		varchar(1);
cd_pessoa_fisica_w	varchar(10);
CD_EDICAO_AMB_w         integer;
VL_LANC_AUTOM_W         double precision;
ie_calcula_lanc_auto_w	varchar(1);
ie_atualiza_medico_req_w varchar(1);
vl_custo_operacional_w	double precision;
vl_anestesista_w	double precision;
vl_medico_w		double precision;
vl_auxiliares_w		double precision;
vl_materiais_w		double precision;
cd_medico_item_w	varchar(10);
ie_tipo_Atendimento_w	smallint;
nr_seq_ageint_w		bigint;
cd_conv_item_w		integer;
cd_categ_item_w		varchar(10);
cd_plano_item_w		varchar(10);
nr_seq_regra_w		bigint;
nr_minuto_duracao_w	bigint;
ie_resp_autor_w		varchar(10);
cd_medico_solicitante_w varchar(10);

ie_edicao_w                  varchar(1);
cd_edicao_ajuste_w      bigint;
qt_item_edicao_w         bigint;
cd_estab_agenda_w	integer;
ie_perm_agenda_w	varchar(1)	:= 'S';
qt_estab_user_w		bigint;
ie_estab_usuario_w	varchar(1);
nm_paciente_w		varchar(60);
cd_paciente_agenda_w	varchar(10);
nm_paciente_agenda_w	varchar(60);
ie_pacote_w		varchar(1);
ie_inserir_prof_w	varchar(1);
ds_erro_w		varchar(255);
dt_nascimento_Ww	timestamp;
nr_seq_tipo_classif_pac_w	bigint;
ie_orient_long_w	varchar(1);

C01 CURSOR FOR
	SELECT	a.cd_medico,
		c.cd_estabelecimento,
		ageint_obter_se_regra_med_ex(a.cd_medico, c.cd_Agenda, NEW.nr_seq_proc_interno, NEW.nr_seq_agenda_int, cd_procedimento_w, ie_origem_proced_w)
	from    agenda c,
		pessoa_fisica b,
		agenda_medico a
	where   Obter_Se_Ageint_Item(a.cd_agenda, NEW.nr_seq_agenda_int, cd_estabelecimento_w, NEW.nr_seq_proc_interno, NEW.cd_Especialidade,

NEW.cd_medico, a.cd_medico, cd_procedimento_w, ie_origem_proced_w,NEW.nr_sequencia, qt_idade_w) = 'S'
	and     a.cd_medico    			= b.cd_pessoa_fisica
	and	c.cd_agenda			= a.cd_agenda
	and	coalesce(c.ie_agenda_integrada,'N')	= 'S'
	and     a.ie_situacao  			= 'A'
	and	c.ie_situacao			= 'A'
	and	c.cd_tipo_Agenda = 2
	and	((qt_idade_w	>= coalesce(qt_idade_min,0)
	and	qt_idade_w	<= coalesce(qt_idade_max,999))
	or	qt_idade_w = 0);
BEGIN
  BEGIN

select	coalesce(max(Obter_Valor_Param_Usuario(869, 7, Obter_Perfil_Ativo, NEW.nm_usuario, 0)), 'S'),
	coalesce(max(Obter_Valor_Param_Usuario(869, 81, Obter_Perfil_Ativo, NEW.nm_usuario, 0)), 'N')
into STRICT	ie_calcula_lanc_auto_w,
	ie_atualiza_medico_req_w
;
BEGIN
select	cd_estabelecimento,
	cd_convenio,
	cd_categoria,
	dt_inicio_agendamento,
	cd_plano,
	cd_usuario_convenio,
	cd_pessoa_fisica,
	ie_tipo_Atendimento,
	dt_nascimento,
	nr_sequencia,
	nm_paciente,
	cd_medico_solicitante,
	nr_seq_tipo_classif_pac
into STRICT	cd_estabelecimento_w,
	cd_convenio_ww,
	cd_categoria_ww,
	dt_inicio_agendamento_w,
	cd_plano_ww,
	cd_usuario_convenio_w,
	cd_pessoa_fisica_w,
	ie_tipo_Atendimento_w,
	dt_nascimento_w,
	nr_seq_ageint_w,
	nm_paciente_w,
	cd_medico_solicitante_w,
	nr_seq_tipo_classif_pac_w
from	agenda_integrada
where	nr_sequencia	= NEW.nr_seq_agenda_int;
exception
when others then
	nr_seq_ageint_w	:= null;
end;

ie_estab_usuario_w	:= coalesce(Obter_Valor_Param_Usuario(869, 1, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w), 'S');
ie_orient_long_w	:= coalesce(Obter_Valor_Param_Usuario(869, 176, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w), 'N');

if (ie_orient_long_w	= 'S') then
	select	max(cd_convenio),
		max(cd_categoria),
		max(cd_plano)
	into STRICT	cd_conv_item_w,
		cd_categ_item_w,
		cd_plano_item_w
	from	agenda_integrada_conv_item
	where	nr_seq_agenda_item	= NEW.nr_sequencia;

	if (cd_conv_item_w is not null) then
		cd_convenio_ww	:= cd_conv_item_w;
		cd_categoria_ww	:= cd_categ_item_w;
		cd_plano_ww	:= cd_plano_item_w;
	end if;

	if (NEW.cd_estabelecimento is not null) then
		cd_estabelecimento_w	:= NEW.cd_estabelecimento;
	end if;

	cd_procedimento_w	:= NEW.cd_procedimento;
	ie_origem_proced_w	:= NEW.ie_origem_proced;

	if	(OLD.nr_seq_proc_interno is null AND NEW.nr_seq_proc_interno is not null) or
		((OLD.nr_seq_proc_interno is not null) and (NEW.nr_seq_proc_interno is not null) and (NEW.nr_seq_proc_interno	<> OLD.nr_seq_proc_interno)) or
		((OLD.cd_medico is null AND NEW.cd_medico is not null) or
		(OLD.cd_medico is not null AND NEW.cd_medico is null) or (NEW.cd_medico <> OLD.cd_medico))then
		CALL Ageint_Gerar_Orient_Item(cd_pessoa_fisica_w, NEW.nr_sequencia, NEW.nr_seq_proc_interno, NEW.cd_procedimento, NEW.ie_origem_proced,
								cd_convenio_ww, nr_seq_tipo_classif_pac_w, cd_estabelecimento_w, NEW.nm_usuario, NEW.cd_medico);
	end if;
end if;

  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_agenda_integrada_item_update() FROM PUBLIC;

CREATE TRIGGER agenda_integrada_item_update
	AFTER INSERT OR UPDATE ON agenda_integrada_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_agenda_integrada_item_update();

