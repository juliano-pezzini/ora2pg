-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pontuacao_escala_asg_atual ON escala_asg_ppp CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pontuacao_escala_asg_atual() RETURNS trigger AS $BODY$
DECLARE

    qt_pontuacao_ingest_w         smallint;
    qt_pontuacao_sint_w           smallint;
    qt_pontuacao_ativ_w           smallint;
    qt_pontuacao_score_a_w        integer;
    qt_pontuacao_doenca_w         smallint;
    qt_pontuacao_demanda_w        integer;
    qt_pontuacao_peso_w           smallint;
    qt_ponto_exame_fis_w          smallint;
    qt_ponto_total_w              integer;
    qt_reg_w                      smallint;
    sql_w                         varchar(200);
BEGIN
  BEGIN

    IF ( wheb_usuario_pck.get_ie_executar_trigger = 'N' ) THEN
        GOTO final;
    END IF;




    sql_w := 'begin CALCULA_PESO_ASG_ATUAL_MD(:1, :2, :3, :4, :5); end;';

    BEGIN
    EXECUTE sql_w  USING IN NEW.qt_peso_mes,
                                   IN NEW.qt_peso_atual,
                                   IN NEW.qt_peso_6_mes,
                                   OUT NEW.pr_perda_mes,
                                   OUT NEW.pr_perda_6_mes;
     EXCEPTION
     WHEN OTHERS THEN
       NEW.pr_perda_mes := null;
       NEW.pr_perda_6_mes := null;
     END;

    BEGIN
        sql_w := 'CALL OBTER_PONT_PESO_ASG_ATUAL_MD (:1, :2, :3, :4) INTO :qt_pontuacao_peso_w';

        EXECUTE sql_w USING IN NEW.ie_aumento_peso, IN NEW.ie_peso_mes_ant,
                                      IN NEW.ie_peso_6_meses, IN NEW.qt_peso_mes, OUT qt_pontuacao_peso_w;

    EXCEPTION
        WHEN OTHERS THEN
            qt_pontuacao_peso_w := NULL;
    END;

    NEW.qt_ponto_peso := qt_pontuacao_peso_w;

    BEGIN
        sql_w := 'CALL OBTER_PONT_INGESTAO_ASG_MD (:1, :2, :3, :4, :5, :6) INTO :qt_pontuacao_ingest_w';

        EXECUTE sql_w USING IN NEW.ie_ingestao_mes, IN NEW.ie_pouca_comida,
                                      IN NEW.ie_apenas_liquido, IN NEW.ie_apenas_suplemento,
                                      IN NEW.ie_comida_normal_pouca, IN NEW.ie_comida_normal_menor,
                                      OUT qt_pontuacao_ingest_w;

    EXCEPTION
        WHEN OTHERS THEN
            qt_pontuacao_ingest_w := NULL;
    END;
    NEW.qt_ponto_ingestao := qt_pontuacao_ingest_w;

    BEGIN
        sql_w := 'CALL OBTER_PONT_SINTOMAS_ASG_MD (:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14) INTO :qt_pontuacao_sint_w';

        EXECUTE sql_w USING IN NEW.ie_sem_apetite, IN NEW.ie_nausea,
                                      IN NEW.ie_vomito, IN NEW.ie_constipacao,
                                      IN NEW.ie_diarreia, IN NEW.ie_ferida_boca,
                                      IN NEW.ie_boca_seca, IN NEW.ie_alimento_sem_gosto,
                                      IN NEW.ie_cheiro_enjoam, IN NEW.ie_problema_engolir,
                                      IN NEW.ie_rapidamente_sat, IN NEW.ie_fadiga,
                                      IN NEW.ie_dor, IN NEW.ie_outros,
                                      OUT qt_pontuacao_sint_w;

    EXCEPTION
        WHEN OTHERS THEN
            qt_pontuacao_sint_w := NULL;
    END;
    NEW.qt_ponto_sintomas := qt_pontuacao_sint_w;


    BEGIN
        sql_w := 'CALL OBTER_PONT_ATIVIDADE_ASG_MD(:1) INTO :qt_pontuacao_ativ_w';

        EXECUTE sql_w USING IN NEW.ie_atividade, OUT qt_pontuacao_ativ_w;

    EXCEPTION
        WHEN OTHERS THEN
            qt_pontuacao_ativ_w := NULL;
    END;
    NEW.qt_ponto_atividade := qt_pontuacao_ativ_w;

    BEGIN
        sql_w := 'CALL OBTER_PONT_PONTO_A_ASG_MD (:1, :2, :3, :4) INTO :qt_pontuacao_score_a_w';

        EXECUTE sql_w USING IN  qt_pontuacao_peso_w,IN NEW.qt_ponto_ingestao, IN qt_pontuacao_sint_w, IN qt_pontuacao_ativ_w,
                                      OUT qt_pontuacao_score_a_w;

    EXCEPTION
        WHEN OTHERS THEN
            qt_pontuacao_score_a_w := NULL;
    END;
    NEW.qt_ponto_a := qt_pontuacao_score_a_w;


    BEGIN
        sql_w := 'CALL OBTER_PONTUACAO_DOENCA_ASG_MD(:1, :2, :3, :4, :5, :6, :7) INTO :qt_pontuacao_doenca_w';

        EXECUTE sql_w USING IN  NEW.ie_cancer, IN NEW.ie_aids, IN NEW.ie_caqueixa, IN NEW.ie_ulcera,
                                      IN  NEW.ie_idade_65, IN NEW.ie_insuf_renal_cronica, IN NEW.ie_trauma,
                                       OUT qt_pontuacao_doenca_w;

    EXCEPTION
        WHEN OTHERS THEN
            qt_pontuacao_doenca_w := NULL;
    END;
    NEW.qt_ponto_doenca := qt_pontuacao_doenca_w;

    BEGIN
        sql_w := 'CALL OBTER_PONT_ESTRESSE_ASG_MD(:1, :2, :3) INTO :qt_pontuacao_demanda_w';

        EXECUTE sql_w USING IN  NEW.ie_febre, IN NEW.ie_duracao_febre, IN NEW.ie_corticosteroides, OUT qt_pontuacao_demanda_w;

    EXCEPTION
        WHEN OTHERS THEN
            qt_pontuacao_demanda_w := NULL;
    END;
    NEW.qt_ponto_estresse := qt_pontuacao_demanda_w;
    NEW.qt_pontos_gordura := NEW.ie_geral_def_gordura;
    NEW.qt_pontos_musculo := NEW.ie_geral_def_musc;
    NEW.qt_pontos_hidratacao := NEW.ie_geral_est_hidratacao;

    BEGIN
        sql_w := 'CALL OBTER_PONT_EXAME_FIS_ASG_MD(:1, :2, :3) INTO :qt_ponto_exame_fis_w';

        EXECUTE sql_w USING IN  NEW.ie_geral_def_gordura, IN NEW.ie_geral_def_musc,
                                      IN NEW.ie_geral_est_hidratacao, OUT qt_ponto_exame_fis_w;

    EXCEPTION
        WHEN OTHERS THEN
            qt_ponto_exame_fis_w := NULL;
    END;
    NEW.qt_ponto_exame_fis := qt_ponto_exame_fis_w;

    BEGIN
        sql_w := 'CALL OBTER_PONTUACAO_TOTAL_ASG_MD (:1, :2, :3, :4) INTO :qt_ponto_total_w';

        EXECUTE sql_w USING IN  qt_pontuacao_score_a_w,IN qt_pontuacao_doenca_w, IN qt_pontuacao_demanda_w,
                                      IN  NEW.qt_ponto_exame_fis, OUT qt_ponto_total_w;

    EXCEPTION
        WHEN OTHERS THEN
            qt_ponto_total_w := NULL;
    END;
    NEW.qt_ponto_total := qt_ponto_total_w;


    << final >>
    qt_reg_w := 0;


  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pontuacao_escala_asg_atual() FROM PUBLIC;

CREATE TRIGGER pontuacao_escala_asg_atual
	BEFORE INSERT OR UPDATE ON escala_asg_ppp FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pontuacao_escala_asg_atual();

