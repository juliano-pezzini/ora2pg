-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cheque_cr_negociado_atual ON cheque_cr_negociado CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cheque_cr_negociado_atual() RETURNS trigger AS $BODY$
DECLARE

vl_saldo_negociado_w	double precision;
cd_estabelecimento_w	cheque_cr.cd_estabelecimento%type;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
BEGIN
select	coalesce(vl_saldo_negociado,vl_cheque)
into STRICT	vl_saldo_negociado_w
from	cheque_cr
where	nr_seq_cheque	= NEW.nr_seq_cheque;
exception when others then
	vl_saldo_negociado_w	:= 0;
end;

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	cheque_cr
where	nr_seq_cheque	= NEW.nr_seq_cheque;


if (NEW.vl_negociado > vl_saldo_negociado_w) then
	/*O valor a ser negociado nao pode ser maior que o saldo a negociar do cheque!*/


	CALL wheb_mensagem_pck.exibir_mensagem_abort(237887);
end if;

if (NEW.dt_negociacao <> OLD.dt_negociacao) then
	/* Projeto Davita  - Nao deixa gerar movimento contabil apos fechamento  da data */


	CALL philips_contabil_pck.valida_se_dia_fechado(OBTER_EMPRESA_ESTAB(cd_estabelecimento_w),NEW.dt_negociacao);
end if;
end if;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cheque_cr_negociado_atual() FROM PUBLIC;

CREATE TRIGGER cheque_cr_negociado_atual
	BEFORE INSERT OR UPDATE ON cheque_cr_negociado FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cheque_cr_negociado_atual();

