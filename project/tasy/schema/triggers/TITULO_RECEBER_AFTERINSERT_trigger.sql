-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_receber_afterinsert ON titulo_receber CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_receber_afterinsert() RETURNS trigger AS $BODY$
declare

dt_documento_w			ctb_documento.dt_competencia%type;
ie_contab_classif_tit_rec_w	parametro_contas_receber.ie_contab_classif_tit_rec%type;
ie_contab_curto_prazo_w		parametro_contas_receber.ie_contab_curto_prazo%type;
nr_seq_trans_financ_w		ctb_documento.nr_seq_trans_financ%type;
qt_titulo_rec_classif_w		bigint;
vl_movimento_w			ctb_documento.vl_movimento%type;
vl_tributo_w			titulo_receber_trib.vl_tributo%type;
ie_contab_tit_interc_cancel_w	pls_parametro_contabil.ie_contab_tit_interc_cancel%type;
nr_seq_info_ctb_w		ctb_documento.nr_seq_info%type;
ie_concil_contab_w		pls_visible_false.ie_concil_contab%type;

c01 CURSOR FOR
	SELECT	a.nm_atributo,
		a.cd_tipo_lote_contab
	from	atributo_contab a
	where 	a.cd_tipo_lote_contab = 5
	and 	a.nm_atributo in ( 'VL_TITULO_RECEBER', 'VL_LIQUIDO_TIT', 'VL_CURTO_PRAZO', 'VL_LONGO_PRAZO')
	
union all

	SELECT 	a.nm_atributo,
		a.cd_tipo_Lote_contab
	from	atributo_contab a
	where	a.cd_tipo_lote_contab = 36
	and	a.nm_atributo = 'VL_TITULO_RECEBER'
	and	NEW.ie_origem_titulo	= '8'
	and	NEW.nr_seq_ptu_fatura is not null
	and	ie_concil_contab_w = 'S'
	and	((NEW.ie_situacao != '3') or (ie_contab_tit_interc_cancel_w = 'S'))
	
union all

	select 	a.nm_atributo,
		a.cd_tipo_Lote_contab
	from	atributo_contab a
	where	a.cd_tipo_lote_contab = 37
	and	a.nm_atributo = 'VL_TITULO_RECEBER'
	and	NEW.ie_origem_titulo	= '11'
	and	ie_concil_contab_w = 'S'
	and	((NEW.nr_seq_pls_lote_contest is not null) or (NEW.nr_seq_pls_lote_disc is not null))
	and 	NEW.ie_situacao <> 3;

c01_w		c01%rowtype;
BEGIN
  BEGIN

if (coalesce(wheb_usuario_pck.get_ie_executar_trigger,'S')	= 'S')  then
											
if (TG_OP = 'INSERT') then

        /* Projeto MXM (7077)  - Exportar título a receber 
        Dispara somente quando houver nota fiscal vinculada */

        if (coalesce(NEW.nr_seq_nf_saida,0) <> 0) then
                if (NEW.cd_pessoa_fisica is not null) then
                        CALL gravar_agend_integracao(556,'CD_PESSOA_FISICA='||NEW.cd_pessoa_fisica||';CD_PESSOA_JURIDICA='||null||';'); --Fornecedor
                        CALL gravar_agend_integracao(562,'CD_PESSOA_FISICA='||NEW.cd_pessoa_fisica||';'); --Cliente
                else
                        CALL gravar_agend_integracao(556,'CD_PESSOA_JURIDICA='||NEW.cd_cgc||';CD_PESSOA_FISICA='||null||';'); --Fornecedor
                end if;
                CALL gravar_agend_integracao(559,'NR_TITULO='||NEW.nr_titulo||';');
        end if;

        /* Grava o agendamento da informação para atualização do fluxo de caixa. */


        CALL gravar_agend_fluxo_caixa(NEW.nr_titulo,null,'TR',coalesce(NEW.dt_pagamento_previsto,NEW.dt_vencimento),'I',NEW.nm_usuario);

end if;

BEGIN
select	a.ie_contab_classif_tit_rec,
	a.ie_contab_curto_prazo
into STRICT	ie_contab_classif_tit_rec_w,
	ie_contab_curto_prazo_w
from	parametro_contas_receber a
where	a.cd_estabelecimento    = NEW.cd_estabelecimento;
exception when others then
        ie_contab_classif_tit_rec_w := 'N';
        ie_contab_curto_prazo_w := 'N';
end;

BEGIN
select  x.*
							
into STRICT    ie_contab_classif_tit_rec_w,
		ie_contab_curto_prazo_w
from (
        SELECT  coalesce(a.ie_contab_classif_tit_rec, 'N'),
				coalesce(a.ie_contab_curto_prazo, 'N')
        from    ctb_param_lote_contas_rec a
							 
        where   a.cd_empresa    = obter_empresa_estab(NEW.cd_estabelecimento)
        and     coalesce(a.cd_estab_exclusivo, NEW.cd_estabelecimento) = NEW.cd_estabelecimento
		and		ie_ctb_online = 'S'
        order   by coalesce(a.cd_estab_exclusivo, 0) desc
        ) x LIMIT 1;
exception when others then
	null;
end;

select	coalesce(max(ie_contab_tit_interc_cancel), 'S')
into STRICT	ie_contab_tit_interc_cancel_w
from	pls_parametro_contabil 
where 	cd_estabelecimento = NEW.cd_estabelecimento;

BEGIN
select	coalesce(max(ie_concil_contab), 'N')
into STRICT	ie_concil_contab_w
from	pls_visible_false
where	cd_estabelecimento = NEW.cd_estabelecimento;
exception when others then
	ie_concil_contab_w := 'N';
end;

open c01;
loop
fetch c01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
	
	vl_movimento_w := 0;
	if (c01_w.cd_tipo_lote_contab = 5) then
		nr_seq_info_ctb_w	:= 3;
		if (c01_w.nm_atributo = 'VL_LIQUIDO_TIT') then
			BEGIN
			
			select	coalesce(sum(CASE WHEN b.ie_soma_diminui='S' THEN  a.vl_tributo WHEN b.ie_soma_diminui='D' THEN  a.vl_tributo * -1  ELSE 0 END ),0)
			into STRICT	vl_tributo_w
			from	titulo_receber_trib	a,
				tributo			b
			where	a.cd_tributo		= b.cd_tributo
			and	a.nr_seq_nota_fiscal    is null
			and	a.nr_seq_mens_trib      is null
			and	a.nr_titulo		= NEW.nr_titulo
			and (a.ie_origem_tributo = 'D' or coalesce(b.ie_incide_conta,'N') = 'N');

			vl_movimento_w	        := NEW.vl_titulo + vl_tributo_w;
			dt_documento_w          := NEW.dt_contabil;
			nr_seq_trans_financ_w   := NEW.nr_seq_trans_fin_contab;
			
			end;
		elsif (c01_w.nm_atributo = 'VL_TITULO_RECEBER') then
			BEGIN
			
			BEGIN
			select	count(1)
			into STRICT	qt_titulo_rec_classif_w
			from	titulo_receber_classif
			where	nr_titulo = NEW.nr_titulo;
			exception
			when others then
				qt_titulo_rec_classif_w:= 0;
			end;	

			if (ie_contab_classif_tit_rec_w = 'N') or (qt_titulo_rec_classif_w = 0) then
				BEGIN
				
				vl_movimento_w:= NEW.vl_titulo;
				dt_documento_w:= NEW.dt_contabil;
				nr_seq_trans_financ_w:= NEW.nr_seq_trans_fin_contab;
				
				end;
			end if;

		
			end;
		elsif (c01_w.nm_atributo = 'VL_CURTO_PRAZO') or (c01_w.nm_atributo = 'VL_LONGO_PRAZO') then
			BEGIN
				
			if (ie_contab_curto_prazo_w = 'S') then
				BEGIN
				
				vl_movimento_w:= NEW.vl_titulo;
				dt_documento_w:= NEW.dt_contabil;

				if (c01_w.nm_atributo = 'VL_CURTO_PRAZO') then
					BEGIN
					dt_documento_w:= pkg_date_utils.add_month(NEW.dt_vencimento,-12,0);
					end;
				end if;
				
						
				if (pkg_date_utils.add_month(NEW.dt_vencimento,-12,0) >= NEW.dt_contabil) and (c01_w.nm_atributo = 'VL_CURTO_PRAZO')
					or (NEW.dt_vencimento > pkg_date_utils.add_month(NEW.dt_contabil,12,0)) and (c01_w.nm_atributo = 'VL_LONGO_PRAZO') then
					BEGIN
					
					if (coalesce(NEW.nr_seq_tf_curto_prazo, 0) <> 0) then
						BEGIN

						nr_seq_trans_financ_w:= NEW.nr_seq_tf_curto_prazo;
						end;
									else
											BEGIN
											vl_movimento_w := null;
											end;
					end if;
					
					end;				
				end if;
				
				end;			
			end if;
			end;
		end if;
	elsif (c01_w.cd_tipo_lote_contab = 36) then
		vl_movimento_w		:= NEW.vl_titulo;
		dt_documento_w 		:= NEW.dt_contabil;
		nr_seq_trans_financ_w 	:= NEW.nr_seq_trans_fin_contab;
		nr_seq_info_ctb_w	:= 46;
	elsif (c01_w.cd_tipo_lote_contab = 37) then
		vl_movimento_w 		:= NEW.vl_titulo;
		dt_documento_w		:= NEW.dt_contabil;
		nr_seq_trans_financ_w 	:= NEW.nr_seq_trans_fin_contab;
		nr_seq_info_ctb_w	:= 46;
	end if;

	if (TG_OP = 'INSERT') then
		BEGIN
		
		if (coalesce(vl_movimento_w, 0) <> 0) then
			BEGIN
			
			CALL ctb_concil_financeira_pck.ctb_gravar_documento(	NEW.cd_estabelecimento,
										trunc(dt_documento_w),
										c01_w.cd_tipo_lote_contab,
										nr_seq_trans_financ_w,
										nr_seq_info_ctb_w,
										NEW.nr_titulo,
										null,
										null,
										vl_movimento_w,
										'TITULO_RECEBER',
										c01_w.nm_atributo,
										NEW.nm_usuario);

			end;
		end if;
		
		end;
	end if;

	end;
end loop;
close c01;

if (TG_OP = 'UPDATE') then
	BEGIN
	
	update	ctb_documento
	set	nr_seq_trans_financ = NEW.nr_seq_trans_fin_contab
	where	nr_documento = NEW.nr_titulo
	and 	coalesce(nr_seq_doc_compl, 0) = 0
	and	nm_tabela = 'TITULO_RECEBER'
	and 	nm_atributo in ('VL_TITULO_RECEBER', 'VL_LIQUIDO_TIT');
	
	
	update	ctb_documento
	set	nr_seq_trans_financ = NEW.nr_seq_tf_curto_prazo
	where	nr_documento = NEW.nr_titulo
	and 	coalesce(nr_seq_doc_compl, 0) = 0
	and	nm_tabela = 'TITULO_RECEBER'
	and 	nm_atributo in ('VL_CURTO_PRAZO', 'VL_LONGO_PRAZO');

	end;
end if;

end if;	


  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_receber_afterinsert() FROM PUBLIC;

CREATE TRIGGER titulo_receber_afterinsert
	AFTER INSERT OR UPDATE ON titulo_receber FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_receber_afterinsert();

