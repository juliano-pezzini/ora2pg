-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS auditoria_matpaci_insert ON auditoria_matpaci CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_auditoria_matpaci_insert() RETURNS trigger AS $BODY$
declare

nr_seq_pend_w		bigint;
nr_seq_estagio_pend_w	bigint;
vl_item_w		double precision;
nr_interno_conta_w	bigint;
nr_atendimento_w	bigint;
nr_conta_audit_w	bigint;
ds_call_stack_w		varchar(2000);
dt_periodo_inicial_w	timestamp;
dt_periodo_final_w	timestamp;
dt_conta_w		timestamp;
dt_atendimento_w	timestamp;
qt_item_periodo_w	bigint;
BEGIN
  BEGIN

select 	max(nr_sequencia)
into STRICT	nr_seq_pend_w
from 	cta_pendencia
where 	nr_seq_auditoria = NEW.nr_seq_auditoria;

if (coalesce(nr_seq_pend_w,0) > 0) then

	select 	max(nr_seq_estagio)
	into STRICT	nr_seq_estagio_pend_w
	from  	cta_pendencia
	where 	nr_sequencia = nr_seq_pend_w;

	if (coalesce(nr_seq_estagio_pend_w,0) > 0) then

		NEW.nr_seq_estagio_pend:= nr_seq_estagio_pend_w;

	end if;
end if;

BEGIN
select	coalesce(a.vl_material,0)
into STRICT	vl_item_w
from	material_atend_paciente a
where	a.nr_sequencia		= NEW.nr_seq_matpaci
and	a.cd_motivo_exc_conta is null
and	coalesce(a.nr_seq_proc_pacote,0)	<> a.nr_sequencia;
exception
	when others then
	NEW.vl_total_ajuste:= 0;
	vl_item_w:= 0;
end;

NEW.vl_total_ajuste:= vl_item_w;

NEW.ie_exige_auditoria := obter_se_exige_auditoria(NEW.nr_seq_matpaci, 1);

select	max(nr_interno_conta),
	max(nr_atendimento),
	max(dt_conta),
	max(dt_atendimento)
into STRICT	nr_interno_conta_w,
	nr_atendimento_w,
	dt_conta_w,
	dt_atendimento_w
from	material_atend_paciente
where	nr_sequencia = NEW.nr_seq_matpaci;

select	max(nr_interno_conta),
	max(dt_periodo_inicial),
	max(dt_periodo_final)
into STRICT	nr_conta_audit_w,
	dt_periodo_inicial_w,
	dt_periodo_final_w
from	auditoria_conta_paciente
where	nr_sequencia = NEW.nr_seq_auditoria;

qt_item_periodo_w	:= 1;
BEGIN
select	coalesce(max(1),0)
into STRICT	qt_item_periodo_w

where	((dt_conta_w between dt_periodo_inicial_w and dt_periodo_final_w) or (dt_atendimento_w between dt_periodo_inicial_w and dt_periodo_final_w));
exception
	when others then
	qt_item_periodo_w	:= 1;
end;

if	((coalesce(nr_interno_conta_w,0) <> 0) and (coalesce(nr_conta_audit_w,0) <> 0) and (coalesce(nr_interno_conta_w,0) <> coalesce(nr_conta_audit_w,0))) or (qt_item_periodo_w = 0) then

	ds_call_stack_w	:= substr(dbms_utility.format_call_stack,1,1800);

	insert into w_log_atend_audit(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_audit_item,
		nr_seq_auditoria,
		ds_call_stack,
		ie_tipo_item,
		nr_seq_item,
		dt_periodo_inicial,
		dt_periodo_final,
		ds_observacao
	) values (
		nextval('w_log_atend_audit_seq'),
		LOCALTIMESTAMP,
		NEW.nm_usuario,
		LOCALTIMESTAMP,
		NEW.nm_usuario,
		NEW.nr_sequencia,
		NEW.nr_seq_auditoria,
		ds_call_stack_w,
		'M',
		NEW.nr_seq_matpaci,
		dt_periodo_inicial_w,
		dt_periodo_final_w,
		CASE WHEN qt_item_periodo_w=0 THEN  substr(wheb_mensagem_pck.get_texto(309510),1,255)  ELSE substr(wheb_mensagem_pck.get_texto(309511),1,255) END
	);

end if;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_auditoria_matpaci_insert() FROM PUBLIC;

CREATE TRIGGER auditoria_matpaci_insert
	BEFORE INSERT ON auditoria_matpaci FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_auditoria_matpaci_insert();

