-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS agenda_pac_opme_update_autor ON agenda_pac_opme CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_agenda_pac_opme_update_autor() RETURNS trigger AS $BODY$
DECLARE

nr_seq_autorizacao_w		bigint;

c01 CURSOR FOR
SELECT	a.nr_sequencia
from	autorizacao_convenio a
where	a.nr_seq_agenda	= NEW.nr_seq_agenda;

BEGIN

if	(wheb_usuario_pck.get_ie_executar_trigger = 'S' AND OLD.ie_gerar_autor <> NEW.ie_gerar_autor)  then

	open c01;
	loop
	fetch c01 into
		nr_seq_autorizacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		BEGIN

 		delete
		from	material_autorizado
		where	cd_material	= NEW.cd_material
		and	NEW.ie_gerar_autor	= 'N'
		and	nr_sequencia_autor	= nr_seq_autorizacao_w;
		end;

	end loop;
	close c01;

end if;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_agenda_pac_opme_update_autor() FROM PUBLIC;

CREATE TRIGGER agenda_pac_opme_update_autor
	BEFORE UPDATE ON agenda_pac_opme FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_agenda_pac_opme_update_autor();

