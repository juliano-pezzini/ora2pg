-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS nota_fiscal_trib_update2 ON nota_fiscal_trib CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_nota_fiscal_trib_update2() RETURNS trigger AS $BODY$
declare

vl_base_calculo_w		double precision;
ie_forma_arred_nf_w	varchar(15);
ie_tipo_nota_w		varchar(15);
BEGIN
  BEGIN

select	coalesce(max(ie_forma_arred_nf), 'N')
into STRICT	ie_forma_arred_nf_w
from	tributo
where	cd_tributo	= NEW.cd_tributo;

select	coalesce(max(obter_se_nota_entrada_saida(NEW.nr_sequencia)),'E')
into STRICT	ie_tipo_nota_w
;

if (ie_forma_arred_nf_w = 'S') then
	BEGIN

	vl_base_calculo_w	:= coalesce(NEW.vl_base_calculo, 0) - coalesce(NEW.vl_reducao_base, 0);

	if (vl_base_calculo_w is not null) and (NEW.tx_tributo is not null) then

		if (NEW.vl_tributo <> 0) then /* RFOLIVEIRA - Inclui este IF pois existem vezes em que não é retido o valor (acumulado) e esta trigger acaba gerando mesmo assim*/
			BEGIN
			NEW.vl_tributo	:= trunc(dividir(vl_base_calculo_w * NEW.tx_tributo, 100),2);
			exception when others then
				vl_base_calculo_w := vl_base_calculo_w;
				/*insert into log__tasy(
					DT_ATUALIZACAO,
					NM_USUARIO,
					CD_LOG,
					DS_LOG)
				values(	sysdate,
					'Trigger',
					1544,
					'Erro ao tentar ajustar o valor do tributo na nota' || chr(13) ||
					'NF: ' || :new.nr_sequencia || chr(13) ||
					'Tributo: ' || :new.CD_TRIBUTO);*/
			end;

		end if;
	end if;
	end;
end if;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_nota_fiscal_trib_update2() FROM PUBLIC;

CREATE TRIGGER nota_fiscal_trib_update2
	BEFORE INSERT OR UPDATE ON nota_fiscal_trib FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_nota_fiscal_trib_update2();

