-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cpoe_proc_insert_update_after ON cpoe_procedimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cpoe_proc_insert_update_after() RETURNS trigger AS $BODY$
declare

ds_stack_w		varchar(2000);
ds_log_cpoe_w	varchar(2000);
cd_intervalo_w	intervalo_prescricao.cd_intervalo%type;
dt_min_date_w	timestamp := to_date('30/12/1899 00:00:00', 'dd/mm/yyyy hh24:mi:ss');
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;

nr_seq_ageint_w	agenda_integrada.nr_sequencia%type;	

qtd_integracao_w integer;
ie_order_integr_type_w 	varchar(10);
nr_entity_identifier_w	cpoe_integracao.nr_sequencia%type;
ie_use_integration_w	varchar(10);
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then

    goto final;

end if;

	BEGIN

	if (coalesce(NEW.nr_sequencia,0) <> coalesce(OLD.nr_sequencia,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_sequencia(' || coalesce(OLD.nr_sequencia,0) || '/' || coalesce(NEW.nr_sequencia,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.nr_seq_cpoe_anterior,0) <> coalesce(OLD.nr_seq_cpoe_anterior,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_cpoe_anterior(' || coalesce(OLD.nr_seq_cpoe_anterior,0) || '/' || coalesce(NEW.nr_seq_cpoe_anterior,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.nr_seq_proc_interno,0) <> coalesce(OLD.nr_seq_proc_interno,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_proc_interno(' || coalesce(OLD.nr_seq_proc_interno,0) || '/' || coalesce(NEW.nr_seq_proc_interno,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.dt_liberacao, dt_min_date_w) <> coalesce(OLD.dt_liberacao, dt_min_date_w)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_liberacao(' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(OLD.dt_liberacao, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>') || '/' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_liberacao, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.dt_suspensao, dt_min_date_w) <> coalesce(OLD.dt_suspensao, dt_min_date_w)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_suspensao(' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(OLD.dt_suspensao, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>') || '/' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_suspensao, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.ie_forma_suspensao,'XPTO') <> coalesce(OLD.ie_forma_suspensao,'XPTO')) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' ie_forma_suspensao(' || coalesce(OLD.ie_forma_suspensao,'<NULL>') || '/' || coalesce(NEW.ie_forma_suspensao,'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.dt_lib_suspensao, dt_min_date_w) <> coalesce(OLD.dt_lib_suspensao, dt_min_date_w)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_lib_suspensao(' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(OLD.dt_lib_suspensao, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>') || '/' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_lib_suspensao, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.dt_liberacao_enf, dt_min_date_w) <> coalesce(OLD.dt_liberacao_enf, dt_min_date_w)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_liberacao_enf(' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(OLD.dt_liberacao_enf, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>') || '/' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_liberacao_enf, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.dt_liberacao_farm, dt_min_date_w) <> coalesce(OLD.dt_liberacao_farm, dt_min_date_w)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_liberacao_farm(' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(OLD.dt_liberacao_farm, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>') || '/' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_liberacao_farm, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.dt_prox_geracao, LOCALTIMESTAMP) <> coalesce(OLD.dt_prox_geracao, LOCALTIMESTAMP)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_prox_geracao(' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(OLD.dt_prox_geracao, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>') || '/' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_prox_geracao, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.dt_inicio, LOCALTIMESTAMP) <> coalesce(OLD.dt_inicio, LOCALTIMESTAMP)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_inicio(' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(OLD.dt_inicio, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>') || '/' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_inicio, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.dt_fim, LOCALTIMESTAMP) <> coalesce(OLD.dt_fim, LOCALTIMESTAMP)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_fim(' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(OLD.dt_fim, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>') || '/' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_fim, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.ds_horarios,'XPTO') <> coalesce(OLD.ds_horarios,'XPTO')) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' ds_horarios(' || coalesce(OLD.ds_horarios,'<NULL>') || '/' || coalesce(NEW.ds_horarios,'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.ie_evento_unico,'XPTO') <> coalesce(OLD.ie_evento_unico,'XPTO')) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' ie_evento_unico(' || coalesce(OLD.ie_evento_unico,'<NULL>') || '/' || coalesce(NEW.ie_evento_unico,'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.ie_administracao,'XPTO') <> coalesce(OLD.ie_administracao,'XPTO')) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' ie_administracao(' || coalesce(OLD.ie_administracao,'<NULL>') || '/' || coalesce(NEW.ie_administracao,'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.ds_justificativa,'XPTO') <> coalesce(OLD.ds_justificativa,'XPTO')) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' ds_justificativa(' || coalesce(length(OLD.ds_justificativa),0) || '/' || coalesce(length(NEW.ds_justificativa),0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.hr_prim_horario,'XPTO') <> coalesce(OLD.hr_prim_horario,'XPTO')) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' hr_prim_horario(' || coalesce(OLD.hr_prim_horario,'<NULL>') || '/' || coalesce(NEW.hr_prim_horario,'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.cd_setor_atendimento,0) <> coalesce(OLD.cd_setor_atendimento,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' cd_setor_atendimento(' || coalesce(OLD.cd_setor_atendimento,0) || '/' || coalesce(NEW.cd_setor_atendimento,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.cd_intervalo,'XPTO') <> coalesce(OLD.cd_intervalo,'XPTO')) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' cd_intervalo(' || coalesce(OLD.cd_intervalo,'<NULL>') || '/' || coalesce(NEW.cd_intervalo,'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.ie_baixado_por_alta,'XPTO') <> coalesce(OLD.ie_baixado_por_alta,'XPTO')) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' ie_baixado_por_alta(' || coalesce(OLD.ie_baixado_por_alta,'<NULL>') || '/' || coalesce(NEW.ie_baixado_por_alta,'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.dt_alta_medico, dt_min_date_w) <> coalesce(OLD.dt_alta_medico, dt_min_date_w)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' dt_alta_medico(' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(OLD.dt_alta_medico, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>') || '/' || coalesce(PKG_DATE_FORMATERS_TZ.TO_VARCHAR(NEW.dt_alta_medico, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),'<NULL>')||'); ',1,2000);
	end if;

	if (coalesce(NEW.nr_ocorrencia,0) <> coalesce(OLD.nr_ocorrencia,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_ocorrencia(' || coalesce(OLD.nr_ocorrencia,0) || '/' || coalesce(NEW.nr_ocorrencia,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.cd_material_exame,0) <> coalesce(OLD.cd_material_exame,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' cd_material_exame(' || coalesce(OLD.cd_material_exame,0) || '/' || coalesce(NEW.cd_material_exame,0)||'); ',1,2000);
	end if;

	if (coalesce(NEW.nr_seq_prot_glic,0) <> coalesce(OLD.nr_seq_prot_glic,0)) then
		ds_log_cpoe_w	:= substr(ds_log_cpoe_w || ' nr_seq_prot_glic(' || coalesce(OLD.nr_seq_prot_glic,0) || '/' || coalesce(NEW.nr_seq_prot_glic,0)||'); ',1,2000);
	end if;

	if (TG_OP = 'UPDATE' and NEW.dt_liberacao is null and NEW.nr_seq_agenda is not null and (coalesce(NEW.ds_dado_clinico,'XPTO') <> coalesce(OLD.ds_dado_clinico,'XPTO') or
		coalesce(NEW.ds_observacao,'XPTO') <> coalesce(OLD.ds_observacao,'XPTO'))) then
		
		select	max(b.nr_seq_agenda_int)
		into STRICT	nr_seq_ageint_w
		from	agenda_integrada_item b
		where	b.nr_seq_agenda_exame = NEW.nr_seq_agenda;

		update agenda_integrada
		set ds_indicacao = NEW.ds_dado_clinico,
			ds_observacao = NEW.ds_observacao
		where nr_sequencia = nr_seq_ageint_w;
	end if;

	if (ds_log_cpoe_w is not null) then
		
		if (coalesce(OLD.nr_sequencia, 0) > 0) then
			ds_log_cpoe_w := substr('Alteracoes(old/new)= ' || ds_log_cpoe_w,1,2000);
		else
			ds_log_cpoe_w := substr('Criacao(old/new)= ' || ds_log_cpoe_w,1,2000);
		end if;
		
		ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
		ds_log_cpoe_w := substr(ds_log_cpoe_w ||' FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);
		
		insert into log_cpoe(nr_sequencia, nr_atendimento, dt_atualizacao, nm_usuario, nr_seq_procedimento, ds_log, ds_stack) values (nextval('log_cpoe_seq'), NEW.nr_atendimento, LOCALTIMESTAMP, NEW.nm_usuario, NEW.nr_sequencia, ds_log_cpoe_w, ds_stack_w);
	end if;

	exception
	when others then
		ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
		
		insert into log_cpoe(nr_sequencia,
							nr_atendimento, 
							dt_atualizacao, 
							nm_usuario, 
							nr_seq_procedimento, 
							ds_log, 
							ds_stack) 
		values (			nextval('log_cpoe_seq'), 
							NEW.nr_atendimento, 
							LOCALTIMESTAMP, 
							NEW.nm_usuario, 
							NEW.nr_sequencia, 
							'EXCEPTION CPOE_PROC_INSERT_UPDATE_AFTER', 
							ds_stack_w);
	end;

	BEGIN
		if (NEW.dt_liberacao is not null and ((OLD.dt_liberacao_enf is null and  NEW.dt_liberacao_enf is not null) or (OLD.dt_liberacao_farm is null and NEW.dt_liberacao_farm is not null))) then
			CALL cpoe_atualizar_inf_adic(NEW.nr_atendimento, NEW.nr_sequencia, 'P', NEW.dt_liberacao_enf, NEW.dt_liberacao_farm, null, null, null, null, null, NEW.nr_seq_cpoe_order_unit);
		end if;
	exception
	when others then
		CALL gravar_log_cpoe('CPOE_PROC_INSERT_UPDATE_AFTER - CPOE_ATUALIZAR_INF_ADIC - Erro: ' || substr(sqlerrm(SQLSTATE),1,1500) || ' :new.nr_sequencia '|| NEW.nr_sequencia, NEW.nr_atendimento);
	end;
	
if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') and (OLD.dt_liberacao is null) and (NEW.dt_liberacao is not null) and (NEW.dt_suspensao is null) then
	
	select	wheb_usuario_pck.get_cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	;
	
	BEGIN
	CALL gerar_consentimento_proced( 	NEW.nr_atendimento,
					cd_estabelecimento_w,
					null,
					null,
					NEW.nr_seq_proc_interno,
					null,
					NEW.cd_perfil_ativo,
					null,
					NEW.nm_usuario,
					NEW.nr_sequencia,
					NEW.dt_inicio);
	exception
	when others then		
		cd_estabelecimento_w := 0;		
	end;	
end if;

if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') and (OLD.dt_suspensao is null) and (NEW.dt_suspensao is not null) then
	
	update	pep_pac_ci
	set	ie_situacao = 'I',
		nm_usuario_inativacao = NEW.nm_usuario,
		dt_inativacao = LOCALTIMESTAMP		
	where	nr_seq_proc_cpoe = NEW.nr_sequencia;
end if;

ie_use_integration_w := obter_param_usuario(9041, 10, obter_perfil_ativo, NEW.nm_usuario, obter_estabelecimento_ativo, ie_use_integration_w);

select count(1)
into STRICT qtd_integracao_w
from PROC_INTERNO_INTEGRACAO
where NR_SEQ_PROC_INTERNO = NEW.nr_seq_proc_interno;

if (ie_use_integration_w = 'S')
  and (qtd_integracao_w > 0)
  and ((OLD.DT_LIBERACAO IS NULL AND NEW.DT_LIBERACAO IS NOT NULL)
    or (OLD.DT_LIB_SUSPENSAO IS NULL AND NEW.DT_LIB_SUSPENSAO IS NOT NULL )) then

  if (obter_se_proc_IVC(NEW.nr_seq_proc_interno) = 'S') then
    select obter_cpoe_regra_ator('IP')
    into STRICT ie_order_integr_type_w
;
  else
    select obter_cpoe_regra_ator('P')
    into STRICT ie_order_integr_type_w
;
  end if;

  if (ie_order_integr_type_w = 'OI') then

    nr_entity_identifier_w := cpoe_proced_order_json_pck.getCpoeIntegracaoProced(NEW.nr_sequencia, NEW.nm_usuario, nr_entity_identifier_w);

    if (OLD.DT_LIBERACAO IS NULL AND NEW.DT_LIBERACAO IS NOT NULL) then

      CALL call_bifrost_content('prescription.procedure.order.request','cpoe_proced_order_json_pck.get_message_clob(' || NEW.nr_sequencia || ', ''NW'', ' || nr_entity_identifier_w || ')', NEW.nm_usuario);

    elsif (OLD.DT_LIB_SUSPENSAO IS NULL AND NEW.DT_LIB_SUSPENSAO IS NOT NULL ) then

      CALL call_bifrost_content('prescription.procedure.order.request','cpoe_proced_order_json_pck.get_message_clob(' || NEW.nr_sequencia || ', ''CA'', ' || nr_entity_identifier_w || ')', NEW.nm_usuario);

    end if;

  end if;

end if;

<<final>>
null;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cpoe_proc_insert_update_after() FROM PUBLIC;

CREATE TRIGGER cpoe_proc_insert_update_after
	AFTER INSERT OR UPDATE ON cpoe_procedimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cpoe_proc_insert_update_after();

