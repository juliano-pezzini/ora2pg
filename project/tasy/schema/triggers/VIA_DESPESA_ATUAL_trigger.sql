-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS via_despesa_atual ON via_despesa CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_via_despesa_atual() RETURNS trigger AS $BODY$
declare

nr_seq_viagem_w		bigint;
dt_saida_w		timestamp;
dt_retorno_w	timestamp;

BEGIN

	select	nr_seq_viagem
	into STRICT	nr_seq_viagem_w
	from	via_relat_desp
	where	nr_sequencia = NEW.nr_seq_relat;

	select	coalesce(dt_saida_real,dt_saida_prev),
		coalesce(dt_retorno_real,dt_retorno_prev)
	into STRICT	dt_saida_w,
		dt_retorno_w
	from	via_viagem
	where	nr_sequencia = nr_seq_viagem_w;

	if (trunc(NEW.dt_despesa) <  trunc(dt_saida_w)) or (trunc(NEW.dt_despesa) > trunc(dt_retorno_w)) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(296846);
	end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_via_despesa_atual() FROM PUBLIC;

CREATE TRIGGER via_despesa_atual
	BEFORE INSERT OR UPDATE ON via_despesa FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_via_despesa_atual();

