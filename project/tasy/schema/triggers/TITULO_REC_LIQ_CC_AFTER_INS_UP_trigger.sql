-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_rec_liq_cc_after_ins_up ON titulo_rec_liq_cc CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_rec_liq_cc_after_ins_up() RETURNS trigger AS $BODY$
declare

ie_contab_baixas_pro_rata_w     pls_parametros_cr.ie_contab_baixas_pro_rata%type;
vl_movimento_w                  ctb_documento.vl_movimento%type;
nr_seq_trans_fin_w              ctb_documento.nr_seq_trans_financ%type;
nr_seq_proj_rec_w               ctb_documento.nr_seq_proj_rec%type;
dt_referencia_w                 pls_mensalidade.dt_referencia%type;
nr_seq_mensalidade_w            pls_mensalidade.nr_sequencia%type;
dt_recebimento_w                titulo_receber_liq.dt_recebimento%type;
dt_referencia_pls_mens_w        titulo_receber_liq.dt_referencia_pls_mens%type;
cd_estabelecimento_w            titulo_receber.cd_estabelecimento%type;
ie_contab_cr_w                  ctb_param_lote_tesouraria.ie_contab_cr%type;
ie_acao_w                       titulo_receber_liq.ie_acao%type;
nr_multiplicador_w              smallint;
nr_seq_baixa_w                  titulo_receber_liq.nr_sequencia%type;
ie_contab_rec_classif_w         parametro_contas_receber.ie_contab_rec_classif%type;
ie_cc_glosa_w                   parametro_contas_receber.ie_cc_glosa%type;
ie_origem_titulo_w              titulo_receber.ie_origem_titulo%type;
ie_contab_tit_interc_cancel_w	pls_parametro_contabil.ie_contab_tit_interc_cancel%type;
qt_pls_fatura_w                 smallint:= 0;
nr_seq_caixa_rec_w              titulo_receber_liq.nr_seq_caixa_rec%type;
qt_movto_trans_financ_w         smallint:= 0;
nr_seq_trans_caixa_w            titulo_receber_liq.nr_seq_trans_caixa%type;
nr_seq_movto_trans_fin_w        titulo_receber_liq.nr_seq_movto_trans_fin%type;
nr_seq_info_w                   ctb_documento.nr_seq_info%type;
nr_documento_w                  ctb_documento.nr_documento%type;
nr_seq_doc_compl_w              ctb_documento.nr_seq_doc_compl%type;
nm_tabela_w                     ctb_documento.nm_tabela%type;
dt_movimento_w                  ctb_documento.dt_competencia%type;
ie_contab_classif_mens_w        pls_parametro_contabil.ie_contab_classif_mens%type;
nm_atributo_w                   ctb_documento.nm_atributo%type;
qt_ctb_documento_w              bigint;
nr_doc_analitico_w              ctb_documento.nr_doc_analitico%type;
reg_integracao_p                gerar_int_padrao.reg_integracao;
qt_reg_w                        bigint;
ie_concil_contab_w              pls_visible_false.ie_concil_contab%type;
ie_contab_glosa_detalhe_w	ctb_param_lote_contas_rec.ie_contab_glosa_detalhe%type;
ie_contab_tit_cancelado_w	parametro_contas_receber.ie_contab_tit_cancelado%type;

c01 CURSOR FOR
        SELECT  a.nm_atributo,
                10 cd_tipo_lote_contab
        from    atributo_contab a
        where   ((a.cd_tipo_lote_contab = 10 and a.nm_atributo  ( 'VL_RECEBIDO_TESOURARIA', 'VL_FATURAMENTO_OPS'))
      	or (a.cd_tipo_lote_contab  = 5  and a.nm_atributo in ( 'VL_ORIGINAL_BAIXA','VL_DESCONTOS', 'VL_JUROS','VL_MULTA', 'VL_GLOSA', 'VL_REC_MAIOR')
                and (ie_contab_cr_w = 'S')))

union all

        SELECT  a.nm_atributo,
                18 cd_tipo_lote_contab
        from    atributo_contab a
        where (a.cd_tipo_lote_contab = 18
                and     a.nm_atributo in (      'VL_FATURAMENTO_OPS'))
	
union all

	select	a.nm_atributo,
		36 cd_tipo_lote_contab
	from	atributo_contab a
	where	a.cd_tipo_lote_contab = 36
	and	a.nm_atributo = 'VL_RECEBIDO'
	and	ie_concil_contab_w = 'S'
	and	exists	(select	1
			from	titulo_receber	x,
				titulo_receber_liq y
			where	NEW.nr_titulo		= x.nr_titulo
			and	NEW.nr_seq_baixa	= y.nr_sequencia
			and	x.nr_titulo		= y.nr_titulo
			and	x.ie_origem_titulo	= '8'
			and	x.nr_seq_ptu_fatura is not null
			and	coalesce(y.ie_lib_caixa,'N')	= 'S'
			and	((x.ie_situacao		!= '3') or (ie_contab_tit_interc_cancel_w = 'S')))
        
union all

        select  a.nm_atributo,
                39 cd_tipo_lote_contab
        from    atributo_contab a
        where (a.cd_tipo_lote_contab = 39
	and     a.nm_atributo in ( 'VL_RECEBIDO', 'VL_PERDAS', 'VL_GLOSA'))
	and	ie_concil_contab_w = 'S'
	and	exists ( select	1
			 from 	titulo_receber_liq y
			 where  y.nr_seq_lote_enc_contas is null
			 and    y.nr_seq_pls_lote_camara is null
			 and	coalesce(y.ie_lib_caixa, 'S') = 'S'
			 and	y.nr_titulo 	= NEW.nr_titulo
			 and	y.nr_sequencia	= NEW.nr_seq_baixa
			 and	exists	(select	1
					from	titulo_receber x
					where	x.nr_titulo	= y.nr_titulo
					and	x.ie_pls	= 'S'
					and	x.ie_origem_titulo = '3'
					and	((x.ie_situacao	<> '3' or ie_contab_tit_cancelado_w = 'S') 
					or (x.ie_situacao = '3' and y.vl_rec_maior <> 0))))
        
union all

        select  a.nm_atributo,
		a.cd_tipo_lote_contab
	from    atributo_contab a
	where   a.cd_tipo_lote_contab = 5
	and (a.nm_atributo in ( 'VL_RECEBIDO','VL_GLOSA_DETALHE', 'VL_PERDAS', 'VL_RECEBIDO_ESTRANG', 'VL_MOEDA_COMPLEMENTAR')
	or (a.nm_atributo in ( 'VL_ORIGINAL_BAIXA','VL_DESCONTOS', 'VL_JUROS', 'VL_MULTA', 'VL_GLOSA', 'VL_REC_MAIOR')
                and (ie_contab_cr_w = 'N')));

c01_w           c01%rowtype;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
	if (NEW.nr_seq_baixa is not null) and (NEW.nr_titulo is not null) then

        /*Esse select existe para tentar evitar a duplicidade. Pois ao ao atualizar algo no titulo, pode chamar outra proc que atualiza classificacao ou imposto, que tb dispara a trigger das tabelas com esse insert*/


        select  count(*)
        into STRICT    qt_reg_w
        from    intpd_fila_transmissao
        where   nr_seq_documento	= to_char(NEW.nr_titulo)
        and	nr_seq_item_documento   = to_char(NEW.nr_seq_baixa)
        and     to_char(dt_atualizacao, 'dd/mm/yyyy hh24:mi:ss') = to_char(LOCALTIMESTAMP,'dd/mm/yyyy hh24:mi:ss');

        if (qt_reg_w = 0) then
                reg_integracao_p.nr_seq_item_documento_p        :=      NEW.nr_seq_baixa;
                reg_integracao_p := gerar_int_padrao.gravar_integracao('27', NEW.nr_titulo, NEW.nm_usuario, reg_integracao_p);
        end if;

	end if;

	BEGIN

	select  a.cd_estabelecimento,
		b.nr_seq_trans_fin,
		a.nr_seq_mensalidade,
		b.dt_recebimento,
		b.dt_referencia_pls_mens,
		b.ie_acao,
		b.nr_sequencia,
		a.ie_origem_titulo,
		b.nr_seq_caixa_rec,
		b.nr_seq_trans_caixa,
		b.nr_seq_movto_trans_fin,
        a.nr_seq_proj_rec
	into STRICT    cd_estabelecimento_w,
		nr_seq_trans_fin_w,
		nr_seq_mensalidade_w,
		dt_recebimento_w,
		dt_referencia_pls_mens_w,
		ie_acao_w,
		nr_seq_baixa_w,
		ie_origem_titulo_w,
		nr_seq_caixa_rec_w,
		nr_seq_trans_caixa_w,
		nr_seq_movto_trans_fin_w,
        nr_seq_proj_rec_w
	from    titulo_receber a,
		titulo_receber_liq b
	where   a.nr_titulo = b.nr_titulo
	and     b.nr_sequencia 	= NEW.nr_seq_baixa
	and     a.nr_titulo 	= NEW.nr_titulo;

	select	coalesce(max(ie_concil_contab), 'N')
	into STRICT	ie_concil_contab_w
	from	pls_visible_false
	where	cd_estabelecimento = cd_estabelecimento_w;

	if (TG_OP = 'INSERT') then
		BEGIN

		BEGIN
                    select  CASE WHEN a.ie_ctb_online='S' THEN  coalesce(a.ie_contab_cr, 'N')  ELSE 'N' END
                    into STRICT    ie_contab_cr_w
                    from    ctb_param_lote_tesouraria a
                    where   a.cd_empresa = obter_empresa_estab(cd_estabelecimento_w)
                    and     coalesce(a.cd_estab_exclusivo, cd_estabelecimento_w) = cd_estabelecimento_w;
                exception
                    when no_data_found then
                        ie_contab_cr_w := 'N';
                    when too_many_rows then
                        ie_contab_cr_w := 'N';
                end;

                BEGIN
			select  dt_referencia
			into STRICT    dt_referencia_w
			from    pls_mensalidade
			where   nr_sequencia = nr_seq_mensalidade_w;

		exception
		when others then
			dt_referencia_w:= LOCALTIMESTAMP;
		end;
		
		BEGIN
		
		select  coalesce(ie_contab_rec_classif,'N'),
			coalesce(ie_cc_glosa,'N'),
			coalesce(ie_contab_tit_cancelado, 'S')
		into STRICT    ie_contab_rec_classif_w,
			ie_cc_glosa_w,
			ie_contab_tit_cancelado_w
		from    parametro_contas_receber
		where   cd_estabelecimento      = cd_estabelecimento_w;
		
		exception
		when others then
			ie_contab_rec_classif_w := 'N';
			ie_cc_glosa_w := 'N';
			ie_contab_tit_cancelado_w := 'S';
		end;
		
		BEGIN
		
		select  coalesce(max(a.ie_contab_classif_mens),'N')
		into STRICT    ie_contab_classif_mens_w
		from    pls_parametro_contabil a
		where   a.cd_estabelecimento    = cd_estabelecimento_w;
		
		exception
		when others then
			ie_contab_classif_mens_w:= 'N';
		end;
		
		BEGIN
		select  x.*
		into STRICT    ie_contab_rec_classif_w,
				ie_cc_glosa_w,
				ie_contab_glosa_detalhe_w
		from (
				SELECT  coalesce(a.ie_contab_rec_classif, 'N'),
					coalesce(a.ie_cc_glosa, 'N'),
					coalesce(a.ie_contab_glosa_detalhe, 'N')
				from    ctb_param_lote_contas_rec a
				where   a.cd_empresa    = obter_empresa_estab(cd_estabelecimento_w)
				and     coalesce(a.cd_estab_exclusivo, cd_estabelecimento_w) = cd_estabelecimento_w
				and	ie_ctb_online = 'S'
				order   by coalesce(a.cd_estab_exclusivo, 0) desc
				) x LIMIT 1;
		exception when others then
			null;
		end;
			
		nr_multiplicador_w := -1;
		if (ie_acao_w = 'I') then
			BEGIN
			nr_multiplicador_w := 1;
			end;
		end if;

		select	coalesce(max(ie_contab_tit_interc_cancel), 'S')
		into STRICT	ie_contab_tit_interc_cancel_w
		from	pls_parametro_contabil 
		where 	cd_estabelecimento = cd_estabelecimento_w;

		open c01;
		loop
		fetch c01 into
			c01_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
				BEGIN
				
				vl_movimento_w:= 0;
				
				BEGIN
				nm_atributo_w:= c01_w.nm_atributo;
				
				if      ((ie_contab_cr_w = 'S' AND c01_w.cd_tipo_lote_contab = 10)
					or (c01_w.cd_tipo_lote_contab = 18 AND c01_w.nm_atributo = 'VL_FATURAMENTO_OPS') 
					or (c01_w.cd_tipo_lote_contab = 39)
					or (c01_w.cd_tipo_lote_contab = 5))     then
					BEGIN
					
					vl_movimento_w  := 0;
					vl_movimento_w  :=      case c01_w.nm_atributo
								when 'VL_DEB_ANTECIP' then NEW.vl_recebido * nr_multiplicador_w
								when 'VL_DESCONTOS' then NEW.vl_desconto * nr_multiplicador_w
								when 'VL_GLOSA' then NEW.vl_baixa * nr_multiplicador_w                                                 
								when 'VL_GLOSA_DETALHE' then NEW.vl_baixa * nr_multiplicador_w
								when 'VL_JUROS' then NEW.vl_juros * nr_multiplicador_w
								when 'VL_MOEDA_COMPLEMENTAR' then NEW.vl_complemento * nr_multiplicador_w
								when 'VL_MULTA'  then NEW.vl_multa * nr_multiplicador_w
								when 'VL_ORIGINAL_BAIXA'  then NEW.vl_recebido + NEW.vl_juros + NEW.vl_multa + NEW.vl_desconto
								when 'VL_PERDAS' then NEW.vl_perdas * nr_multiplicador_w
								when 'VL_RECEBIDO'  then NEW.vl_recebido * nr_multiplicador_w
								when 'VL_RECEBIDO_ESTRANG' then NEW.vl_recebido_estrang * nr_multiplicador_w
								when 'VL_RECEBIDO_TESOURARIA'  then NEW.vl_recebido * nr_multiplicador_w
								when 'VL_REC_ANTECIP' then NEW.vl_recebido * nr_multiplicador_w
								when 'VL_REC_MAIOR' then NEW.vl_amaior * nr_multiplicador_w
								when 'VL_PERDAS' then NEW.vl_perdas * nr_multiplicador_w
								end;
											
					if (c01_w.nm_atributo = 'VL_FATURAMENTO_OPS') then
							BEGIN
							
							
							BEGIN
							
							select  count(1)
							into STRICT    qt_pls_fatura_w
							from    pls_fatura w 
							where (w.nr_titulo = NEW.nr_titulo or w.nr_titulo_ndc = NEW.nr_titulo)  LIMIT 1;
							
							exception
							when others then
									qt_pls_fatura_w:= 0;
							end;
							
																	
							if (c01_w.cd_tipo_lote_contab = 10) then
									BEGIN
									
									BEGIN
									
									select  count(1)
									into STRICT    qt_movto_trans_financ_w
									from    movto_trans_financ x
									where   x.nr_sequencia          = nr_seq_movto_trans_fin_w
									and     x.nr_seq_saldo_caixa    is not null  LIMIT 1;
									
									exception
									when others then
											qt_movto_trans_financ_w:= 0;
									end;
									
									
									if (ie_cc_glosa_w <> 'N') and
											((NEW.ie_origem_classif = 'FO') or (ie_origem_titulo_w = 13) and (qt_pls_fatura_w = 0)) and 
											((coalesce(nr_seq_caixa_rec_w, 0) <> 0) or (qt_movto_trans_financ_w > 0) or (coalesce(nr_seq_trans_caixa_w, 0) <> 0))then
											BEGIN
													vl_movimento_w:= NEW.vl_amaior;
													
											end;
									end if;
									
									end;
							elsif (c01_w.cd_tipo_lote_contab = 18) then
									BEGIN
									
									if      ((NEW.ie_origem_classif = 'FO') or (ie_origem_titulo_w = 13) and (qt_pls_fatura_w = 0)) then
											BEGIN
											
											vl_movimento_w:= NEW.vl_recebido * nr_multiplicador_w;
													
											end;
									end if;
									
									end;
							elsif (c01_w.cd_tipo_lote_contab = 5) then
									BEGIN
									
									if      ((NEW.ie_origem_classif = 'FO')  or (ie_origem_titulo_w = 13 AND qt_pls_fatura_w  = 0)) then
											BEGIN
											
											vl_movimento_w:= NEW.vl_recebido * nr_multiplicador_w;
											
											end;
									end if;
							
									end;
							end if;
							
							
							end;
					end if;
					
					nr_seq_info_w := 14;
					dt_movimento_w := dt_recebimento_w;
							
					if (c01_w.cd_tipo_lote_contab = 10)  then
							BEGIN
							
							delete
							from    ctb_documento
							where   nm_atributo = c01_w.nm_atributo
							and     nr_documento = NEW.nr_titulo
							and     dt_competencia = dt_recebimento_w
							and     nr_seq_doc_compl = nr_seq_baixa_w;
							
							nr_documento_w := NEW.nr_titulo;
							nr_seq_doc_compl_w := NEW.nr_seq_baixa;
							nr_doc_analitico_w := NEW.nr_sequencia;
							nm_tabela_w := 'TITULO_RECEBER_LIQ_CONTAB_V2';
							
							end;
					elsif   ((c01_w.cd_tipo_lote_contab = 18) or (c01_w.cd_tipo_lote_contab = 39)) then
						BEGIN
						
						nr_documento_w := NEW.nr_titulo;
						nr_seq_doc_compl_w := NEW.nr_seq_baixa;
						nr_doc_analitico_w := NEW.nr_sequencia;
						nm_tabela_w := 'TITULO_REC_LIQ_CC';
						
						if (c01_w.nm_atributo = 'VL_GLOSA' and ie_cc_glosa_w = 'N') then
							vl_movimento_w := null;
						end if;

						if (c01_w.cd_tipo_lote_contab = 39
							and ie_contab_rec_classif_w = 'N' 
							and c01_w.nm_atributo = 'VL_RECEBIDO') then
							vl_movimento_w := null;
						end if;
						end;

					elsif (c01_w.cd_tipo_lote_contab = 5) then
							BEGIN
							
							nr_documento_w 		:= NEW.nr_titulo;
							nr_seq_doc_compl_w 	:= NEW.nr_seq_baixa;
							nr_doc_analitico_w 	:= NEW.nr_sequencia;
							
							nm_tabela_w 		:=  case c01_w.nm_atributo
													when 'VL_DEB_ANTECIP' then 'TITULO_RECEBER_LIQ_CC'
													when 'VL_DESCONTOS' then 'TITULO_RECEBER_LIQ_CONTAB_V2'
													when 'VL_FATURAMENTO_OPS' then 'TITULO_RECEBER_LIQ_CC'
													when 'VL_GLOSA' then 'TITULO_REC_LIQ_CC'                                                        
													when 'VL_GLOSA_DETALHE' then 'TITULO_RECEBER_LIQ_CC' 
													when 'VL_JUROS' then 'TITULO_RECEBER_LIQ_CONTAB_V2'
													when 'VL_MOEDA_COMPLEMENTAR' then 'TITULO_REC_LIQ_CC'
													when 'VL_MULTA'  then 'TITULO_RECEBER_LIQ_CONTAB_V2'
													when 'VL_PERDAS' then 'TITULO_REC_LIQ_CC'
													when 'VL_RECEBIDO' then 'TITULO_REC_LIQ_CC'
													when 'VL_RECEBIDO_ESTRANG' then 'TITULO_REC_LIQ_CC'
													when 'VL_REC_ANTECIP' then 'TITULO_RECEBER_LIQ_CC'
													when 'VL_REC_MAIOR' then 'TITULO_RECEBER_LIQ_CC'
													end;
							
							if (c01_w.nm_atributo in ('VL_DESCONTOS', 'VL_JUROS', 'VL_MOEDA_COMPLEMENTAR', 'VL_MULTA', 'VL_PERDAS', 'VL_RECEBIDO_ESTRANG')) then
									BEGIN
									delete
									from    ctb_documento
									where   nm_atributo 			= c01_w.nm_atributo
									and     nr_documento 			= nr_documento_w
									and     nr_seq_doc_compl 		= nr_seq_doc_compl_w
									and	coalesce(nr_doc_analitico,0)		= 0
									and     dt_competencia 			= trunc(dt_recebimento_w)
									and	ie_situacao_ctb			= 'N'
									and	coalesce(nr_lote_contabil,0)	= 0;
									end;
							end if;
							
							if (c01_w.nm_atributo  = 'VL_DEB_ANTECIP') then
									BEGIN
									nr_seq_info_w:= 50;
									end;
							elsif (c01_w.nm_atributo in ('VL_REC_ANTECIP', 'VL_MOEDA_COMPLEMENTAR', 'VL_RECEBIDO_ESTRANG')) then
									BEGIN
									nr_seq_info_w:= 49;
									end;
							elsif (c01_w.nm_atributo = 'VL_RECEBIDO') then
									BEGIN
									if      ((NEW.ie_lote_pro_rata is not null AND ie_contab_rec_classif_w = 'S') or (ie_contab_rec_classif_w = 'N')) then
											BEGIN
											
											vl_movimento_w := null;
											
											end;
									else
											BEGIN
											delete
											from    ctb_documento
											where   nm_atributo 			= c01_w.nm_atributo
											and     nr_documento 			= nr_documento_w
											and     nr_seq_doc_compl 		= nr_seq_doc_compl_w
											and	coalesce(nr_doc_analitico,0)	= 0
											and     dt_competencia 			= trunc(dt_recebimento_w)
											and	ie_situacao_ctb			= 'N'
											and	nm_tabela				= 'TITULO_RECEBER_LIQ'
											and	coalesce(nr_lote_contabil,0)	= 0;
											end;

											BEGIN
											select  count(1)
										        into STRICT    qt_ctb_documento_w
										
										        where exists (
										                SELECT  a.nr_sequencia
										                from    ctb_documento a
												where   a.nm_tabela             = 'TITULO_REC_LIQ_CC'
												and     a.nr_documento          = NEW.nr_titulo
												and     a.dt_competencia        = dt_recebimento_w
												and     a.nr_seq_doc_compl      = nr_seq_baixa_w
												and     a.nr_doc_analitico      = nr_doc_analitico_w
												and     a.nm_atributo in (SELECT t.nm_atributo from trans_financ_contab t
                                                                                                                          where  t.nr_seq_trans_financ = nr_seq_trans_fin_w 
                                                                                                                          and    t.cd_estabelecimento  = cd_estabelecimento_w)
												and     a.cd_tipo_lote_contabil = 10
												and     ie_contab_cr_w        = 'S');
										        exception
										            when no_data_found then
										                qt_ctb_documento_w := 0;
										        end;

											if (coalesce(qt_ctb_documento_w, 0) > 0) then
												vl_movimento_w := null;
											end if;
									end if;
									end;
							elsif (c01_w.nm_atributo in ('VL_GLOSA', 'VL_REC_MAIOR') and ie_cc_glosa_w = 'N') then
									BEGIN
									vl_movimento_w := null;
									end;
							elsif (c01_w.nm_atributo = 'VL_GLOSA_DETALHE' and (ie_cc_glosa_w = 'N' or ie_contab_glosa_detalhe_w = 'N')) then
									BEGIN
									vl_movimento_w := null;
									end;
							end if;
					
							end;
					end if;
					
					end;
				end if;
			
				if (ie_contab_rec_classif_w = 'S') and
							((c01_w.cd_tipo_lote_contab = 10) or 
							(c01_w.cd_tipo_lote_contab = 39 AND c01_w.nm_atributo = 'VL_RECEBIDO')) then
						BEGIN

						delete  from    ctb_documento
						where   nm_atributo = c01_w.nm_atributo
						and     nr_documento = NEW.nr_titulo
						and     dt_competencia = dt_recebimento_w
						and     nr_seq_doc_compl = nr_seq_baixa_w;
						
						
						nr_seq_info_w := 14;
						nr_documento_w := NEW.nr_titulo;
						nr_seq_doc_compl_w := NEW.nr_seq_baixa;
						nr_doc_analitico_w := NEW.nr_sequencia;
						nm_tabela_w := 'TITULO_REC_LIQ_CC';
						dt_movimento_w := dt_recebimento_w;
						vl_movimento_w:= NEW.vl_recebido * nr_multiplicador_w;
						
						if (coalesce(vl_movimento_w, 0) <> 0) then
								BEGIN
								
								CALL ctb_concil_financeira_pck.ctb_gravar_documento(       cd_estabelecimento_w,
															dt_movimento_w,
															c01_w.cd_tipo_lote_contab,
															nr_seq_trans_fin_w,
															nr_seq_info_w,
															nr_documento_w,
															nr_seq_doc_compl_w,
															nr_doc_analitico_w,
															vl_movimento_w,
															nm_tabela_w,
															nm_atributo_w,
															NEW.nm_usuario,
                                                            'P',
                                                            null,
                                                            nr_seq_proj_rec_w);
								end;
						end if;
						vl_movimento_w:= null;
						end;
				end if;
				
				if (c01_w.cd_tipo_lote_contab = 36) then
					nr_seq_info_w 		:= 14;
					nm_tabela_w 		:= 'TITULO_REC_LIQ_CC';
					dt_movimento_w 		:= dt_recebimento_w;
					nm_atributo_w		:= c01_w.nm_atributo;
					nr_documento_w 		:= NEW.nr_titulo;
					nr_seq_doc_compl_w 	:= NEW.nr_seq_baixa;
					nr_doc_analitico_w 	:= NEW.nr_sequencia;
					vl_movimento_w 		:= NEW.vl_recebido * nr_multiplicador_w;
				end if;
				end;

				if (coalesce(vl_movimento_w, 0) <> 0) then
					BEGIN
					
					CALL ctb_concil_financeira_pck.ctb_gravar_documento(       cd_estabelecimento_w,
												dt_movimento_w,
												c01_w.cd_tipo_lote_contab,
												nr_seq_trans_fin_w,
												nr_seq_info_w,
												nr_documento_w,
												nr_seq_doc_compl_w,
												nr_doc_analitico_w,
												vl_movimento_w,
												nm_tabela_w,
												nm_atributo_w,
												NEW.nm_usuario,
                                                'P',
                                                null,
                                                nr_seq_proj_rec_w);
					end;
				end if;
				
				
				end;
		end loop;
		close c01;
		end;
	end if;

	if (TG_OP = 'UPDATE') then
			BEGIN

				if (NEW.vl_amaior <> OLD.vl_amaior) then
						BEGIN
						
								update  ctb_documento
								set     vl_movimento = NEW.vl_amaior
								where   nr_documento = NEW.nr_titulo
								and     nr_seq_doc_compl = NEW.nr_sequencia;
						
						end;
				end if;
				
				open c01;
				loop
				fetch c01 into
						c01_w;
				EXIT WHEN NOT FOUND; /* apply on c01 */
						BEGIN
						qt_ctb_documento_w:= 0;
						
						if (c01_w.nm_atributo = 'VL_PERDAS') and (coalesce(NEW.vl_perdas, 0) <> coalesce(OLD.vl_perdas, 0))then
								BEGIN
								
								
								select  count(1)
								into STRICT    qt_ctb_documento_w
								from    ctb_documento
								where   nm_atributo = c01_w.nm_atributo
								and     nm_tabela = 'TITULO_REC_LIQ_CC'
								and     dt_competencia = dt_recebimento_w
								and     nr_Seq_info = 14
								and     nr_documento = NEW.nr_titulo
								and     nr_seq_doc_compl = nr_seq_baixa_w
								and     nr_doc_analitico = NEW.nr_sequencia
								and     cd_estabelecimento = cd_estabelecimento_w;
								
								if (coalesce(qt_ctb_documento_w, 0) = 0) then
										BEGIN
										
										
										CALL ctb_concil_financeira_pck.ctb_gravar_documento(       cd_estabelecimento_w,
																	dt_recebimento_w,
																	c01_w.cd_tipo_lote_contab,
																	nr_seq_trans_fin_w,
																	14,
																	NEW.nr_sequencia,
																	nr_seq_baixa_w,
																	nr_doc_analitico_w,
																	NEW.vl_perdas,
																	'TITULO_REC_LIQ_CC',
																	c01_w.nm_atributo,
																	NEW.nm_usuario,
                                                                    'P',
                                                                    null,
                                                                    nr_seq_proj_rec_w);
										
										end;
								else
										BEGIN
										
										update  ctb_documento
										set     vl_movimento = NEW.vl_perdas,
                                                nr_seq_proj_rec = nr_seq_proj_rec_w
										where   nm_atributo = c01_w.nm_atributo
										and     nm_tabela = 'TITULO_REC_LIQ_CC'
										and     dt_competencia = dt_recebimento_w
										and     nr_Seq_info = 14
										and     nr_documento = NEW.nr_titulo
										and     nr_seq_doc_compl = nr_seq_baixa_w
										and     nr_doc_analitico = NEW.nr_sequencia
										and     cd_estabelecimento = cd_estabelecimento_w;
										
										end;
								end if;
								
								end;
						elsif   ((c01_w.nm_atributo = 'VL_DESCONTOS') and (coalesce(NEW.vl_desconto, 0) <> coalesce(OLD.vl_desconto, 0)))
								or ((c01_w.nm_atributo = 'VL_MULTA')and (coalesce(NEW.vl_multa, 0) <> coalesce(OLD.vl_multa, 0))) 
								or ((c01_w.nm_atributo = 'VL_JUROS') and (coalesce(NEW.vl_juros, 0) <> coalesce(OLD.vl_juros, 0))) then
								BEGIN
								
								vl_movimento_w:=        case    c01_w.nm_atributo
														when    'VL_DESCONTOS' then NEW.vl_desconto
														when    'VL_MULTA' then NEW.vl_multa
														when    'VL_JUROS' then NEW.vl_juros
														end;
								
								update  ctb_documento
								set     vl_movimento = vl_movimento_w,
                                        nr_seq_proj_rec = nr_seq_proj_rec_w
								where   nm_atributo = c01_w.nm_atributo
								and     nm_tabela = 'TITULO_RECEBER_LIQ_CONTAB_V2'
								and     dt_competencia = dt_recebimento_w
								and     nr_Seq_info = 14
								and     nr_documento = NEW.nr_titulo
								and     nr_seq_doc_compl = nr_seq_baixa_w
								and     nr_doc_analitico = NEW.nr_sequencia
								and     cd_estabelecimento = cd_estabelecimento_w;
						
								end;
						elsif   (((c01_w.nm_atributo = 'VL_RECEBIDO') or (c01_w.nm_atributo = 'VL_REC_ANTECIP')) and (coalesce(NEW.vl_recebido, 0) <> coalesce(OLD.vl_recebido, 0))) then
								BEGIN
								
								update  ctb_documento
								set     vl_movimento = NEW.vl_recebido,
                                        nr_seq_proj_rec = nr_seq_proj_rec_w
								where   nm_atributo = c01_w.nm_atributo
								and     nm_tabela = 'TITULO_REC_LIQ_CC'
								and     dt_competencia = dt_recebimento_w
								and     nr_Seq_info = 14
								and     nr_documento = NEW.nr_titulo
								and     nr_seq_doc_compl = nr_seq_baixa_w
								and     nr_doc_analitico = NEW.nr_sequencia
								and     cd_estabelecimento = cd_estabelecimento_w;
								
								end;
						end if;
				
						end;
				end loop;
				close c01;

			end;
	end if;
	end;
end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_rec_liq_cc_after_ins_up() FROM PUBLIC;

CREATE TRIGGER titulo_rec_liq_cc_after_ins_up
	AFTER INSERT OR UPDATE ON titulo_rec_liq_cc FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_rec_liq_cc_after_ins_up();

