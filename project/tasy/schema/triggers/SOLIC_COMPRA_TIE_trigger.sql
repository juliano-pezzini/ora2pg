-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS solic_compra_tie ON solic_compra CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_solic_compra_tie() RETURNS trigger AS $BODY$
declare

nm_artefato_w              regra_integr_solic_compra.nm_artefato%type;
ds_retorno_integracao_w    text;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

	if (wheb_usuario_pck.get_nm_usuario is not null) then

		if (OLD.dt_autorizacao is null and NEW.dt_autorizacao is not null) then
		
			if (obter_se_integra_sc(NEW.nr_solic_compra, 'T') <> 'N') then
			
			    select max(nm_artefato)
			    into STRICT nm_artefato_w
			    from regra_integr_solic_compra
			    where ie_integracao = 'TIE'
			    and ie_tipo_servico = NEW.ie_tipo_servico
			    and (coalesce(cd_centro_custo, NEW.cd_centro_custo) = NEW.cd_centro_custo or cd_centro_custo is null)
			    and (cd_perfil = wheb_usuario_pck.get_cd_perfil or cd_perfil is null);
			
			    ds_retorno_integracao_w := bifrost.send_integration(nm_event => coalesce(nm_artefato_w, 'purchase.request.send'),
			    													nm_javaclass => 'com.philips.tasy.integration.purchaserequest.outbound.PurchaseRequestCallback',
			    													ds_arguments => to_char(NEW.nr_solic_compra),
			    													nm_user => wheb_usuario_pck.get_nm_usuario);
			
			end if;

		end if;

	end if;

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_solic_compra_tie() FROM PUBLIC;

CREATE TRIGGER solic_compra_tie
	AFTER UPDATE ON solic_compra FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_solic_compra_tie();

