-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS log_establishment_atual ON log_establishment CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_log_establishment_atual() RETURNS trigger AS $BODY$
declare

nr_seq_log_cleaning_w	log_cleaning.nr_sequencia%type;
qt_month_w		log_cleaning.qt_month%type;
ds_log_type_w		varchar(255);

BEGIN

	--Checks if the time to storage the logs from the establishment is smaller than the smaller time to storage the logs from the log type.
	--Privacy Project: 9208 - BR05
	select 	coalesce(max(nr_sequencia),0)
	into STRICT 	nr_seq_log_cleaning_w
	from 	log_cleaning
	where	cd_estabelecimento = NEW.cd_estabelecimento
	and	nr_seq_log_estab = NEW.nr_sequencia
	and	NEW.qt_storage_month <= qt_month
	and	coalesce(ie_situacao, 'I') = 'A';

	if (nr_seq_log_cleaning_w > 0) then

		select	max(substr(obter_valor_dominio(8382, cd_log_type), 1, 255)),
			max(qt_month)
		into STRICT 	ds_log_type_w,
			qt_month_w
		from	log_cleaning
		where	nr_sequencia = nr_seq_log_cleaning_w;


		if (qt_month_w > 1) then
            		CALL wheb_mensagem_pck.exibir_mensagem_abort(806408, 'DS_LOG_TYPE=' || ds_log_type_w || ';QT_MONTH=' || qt_month_w);
        	else
            		CALL wheb_mensagem_pck.exibir_mensagem_abort(806407, 'DS_LOG_TYPE=' || ds_log_type_w || ';QT_MONTH=' || qt_month_w);
        	end if;

       	end if;

       	if (TG_OP = 'UPDATE') and (OLD.cd_estabelecimento <> NEW.cd_estabelecimento) then
       		CALL wheb_mensagem_pck.exibir_mensagem_abort(806907);
       	end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_log_establishment_atual() FROM PUBLIC;

CREATE TRIGGER log_establishment_atual
	BEFORE INSERT OR UPDATE ON log_establishment FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_log_establishment_atual();

