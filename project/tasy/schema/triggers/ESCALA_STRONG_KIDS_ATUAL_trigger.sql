-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_strong_kids_atual ON escala_strong_kids CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_strong_kids_atual() RETURNS trigger AS $BODY$
DECLARE
    ie_diarreia_w            varchar(1);
    ie_vomito_w              varchar(1);
    ie_diarreia_excessiva_w  varchar(1);
    qt_ponto_w               bigint;
    sql_w                    varchar(2000);
    ds_erro_w                varchar(4000);
    ds_parametros_w          varchar(4000);
BEGIN
  BEGIN
--- Inicio MD 1
    IF ( wheb_usuario_pck.get_ie_executar_trigger = 'S' ) THEN
        BEGIN
            sql_w := 'CALL OBTER_PONTOS_STRONG_KIDS_MD(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16, :17)';
            EXECUTE sql_w
                USING IN NEW.ie_deficit_nut, IN NEW.ie_diarreia_excessiva, IN OLD.ie_diarreia_excessiva, IN OUT NEW.ie_diarreia,
                IN OUT NEW.ie_vomito, IN NEW.ie_reducao_ingestao, IN NEW.ie_intervencao_nutricional, IN NEW.ie_ingestao_nutricional,
                IN NEW.ie_sinal_deficit, IN NEW.ie_doenca_cirurgia, IN NEW.ie_desnutricao, IN NEW.ie_diminuicao_alimentar, IN NEW.ie_dificuldade_dor,
                IN NEW.ie_intervencao_prev, IN NEW.ie_perda_peso, OUT ie_diarreia_excessiva_w, OUT qt_ponto_w;

        EXCEPTION
            WHEN OTHERS THEN
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_deficit_nut: '||NEW.ie_deficit_nut||'-'||':new.ie_diarreia_excessiva: '||NEW.ie_diarreia_excessiva||'-'||':old.ie_diarreia_excessiva: '||OLD.ie_diarreia_excessiva||'-'||
                          ':new.ie_diarreia: '||NEW.ie_diarreia||'-'||':new.ie_vomito: '||NEW.ie_vomito||'-'||':new.ie_reducao_ingestao: '||NEW.ie_reducao_ingestao||'-'||
                          ':new.ie_intervencao_nutricional: '||NEW.ie_intervencao_nutricional||'-'||':new.ie_ingestao_nutricional: '||NEW.ie_ingestao_nutricional||'-'||
                          ':new.ie_sinal_deficit: '||NEW.ie_sinal_deficit||'-'||':new.ie_doenca_cirurgia: '||NEW.ie_doenca_cirurgia||'-'||
                          ':new.ie_desnutricao: '||NEW.ie_desnutricao||'-'||':new.ie_diminuicao_alimentar: '||NEW.ie_diminuicao_alimentar||'-'||
                          ':new.ie_dificuldade_dor: '||NEW.ie_dificuldade_dor||'-'||':new.ie_intervencao_prev: '||NEW.ie_intervencao_prev||'-'||
                          ':new.ie_perda_peso: '||NEW.ie_perda_peso||'-'||'ie_diarreia_excessiva_w: '||ie_diarreia_excessiva_w||'-'||
                          'qt_ponto_w: '||qt_ponto_w);
      CALL gravar_log_medical_device('escala_strong_kids_atual','OBTER_PONTOS_STRONG_KIDS_MD'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
            
                NEW.ie_diarreia_excessiva := NULL;
                NEW.qt_ponto := NULL;
        END;

        NEW.ie_diarreia_excessiva := ie_diarreia_excessiva_w;
        NEW.qt_ponto := qt_ponto_w;
    END IF;
--- Fim MD1
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_strong_kids_atual() FROM PUBLIC;

CREATE TRIGGER escala_strong_kids_atual
	BEFORE INSERT OR UPDATE ON escala_strong_kids FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_strong_kids_atual();

