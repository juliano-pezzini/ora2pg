-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS ordem_compra_item_delete ON ordem_compra_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_ordem_compra_item_delete() RETURNS trigger AS $BODY$
declare

pragma autonomous_transaction;

ie_frete_w				ordem_compra.ie_frete%type;
vl_frete_w				ordem_compra.vl_frete%type;
vl_frete_rateado_w		ordem_compra.vl_frete%type;
qt_itens_oc_w			ordem_compra_item.nr_item_oci%type;
nr_ordem_compra_w		ordem_compra_item_trib.nr_ordem_compra%type;
nr_item_oci_w			ordem_compra_item_trib.nr_item_oci%type;
cd_tributo_w			ordem_compra_item_trib.cd_tributo%type;
pr_tributo_w			ordem_compra_item_trib.pr_tributo%type;
qt_material_w			ordem_compra_item.qt_material%type;
vl_unitario_material_w	ordem_compra_item.vl_unitario_material%type;
vl_desconto_w			ordem_compra_item.vl_desconto%type;
ie_desc_nf_w			tributo.ie_desc_nf%type;
vl_tributo_w			ordem_compra_item_trib.vl_tributo%type;

c02 CURSOR FOR
SELECT	ocit.nr_ordem_compra,
		ocit.nr_item_oci,
		ocit.cd_tributo,
		ocit.pr_tributo,
		CASE WHEN OLD.nr_item_oci=ocit.nr_item_oci THEN  OLD.qt_material  ELSE obter_inf_itens_oc(ocit.nr_ordem_compra, ocit.nr_item_oci, 1) END ,
		CASE WHEN OLD.nr_item_oci=ocit.nr_item_oci THEN  OLD.vl_unitario_material  ELSE obter_inf_itens_oc(ocit.nr_ordem_compra, ocit.nr_item_oci, 2) END ,
		CASE WHEN OLD.nr_item_oci=ocit.nr_item_oci THEN  OLD.vl_desconto  ELSE obter_inf_itens_oc(ocit.nr_ordem_compra, ocit.nr_item_oci, 3) END
from	ordem_compra_item_trib ocit,
		tributo t
where	ocit.nr_ordem_compra = OLD.nr_ordem_compra
and		ocit.cd_tributo = t.cd_tributo
and		t.ie_tipo_tributo = 'IPI'
and		coalesce(CASE WHEN OLD.nr_item_oci=ocit.nr_item_oci THEN  OLD.vl_frete_rateio  ELSE obter_inf_itens_oc(ocit.nr_ordem_compra, ocit.nr_item_oci, 4) END ,0) = 0;

BEGIN
if (compras_pck.get_is_oci_delete = 'S') then
	select	max(ie_frete),
			max(vl_frete)
	into STRICT	ie_frete_w,
			vl_frete_w
	from	ordem_compra
	where	nr_ordem_compra = OLD.nr_ordem_compra;

	if (ie_frete_w = 'F') and (vl_frete_w > 0) then
		BEGIN
		qt_itens_oc_w := obter_inf_itens_oc(OLD.nr_ordem_compra, null, null) - 1;

		vl_frete_rateado_w := DIVIDIR_SEM_ROUND(vl_frete_w, qt_itens_oc_w);

		open c02;
		loop
		fetch c02 into
			nr_ordem_compra_w,
			nr_item_oci_w,
			cd_tributo_w,
			pr_tributo_w,
			qt_material_w,
			vl_unitario_material_w,
			vl_desconto_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			BEGIN
			select	coalesce(ie_desc_nf,'N')
			into STRICT	ie_desc_nf_w
			from	tributo
			where	cd_tributo = cd_tributo_w;

			if (ie_desc_nf_w = 'S') then
				vl_tributo_w	:= (pr_tributo_w / 100) * ((qt_material_w * vl_unitario_material_w) - vl_desconto_w + vl_frete_rateado_w);
			else
				vl_tributo_w	:= (pr_tributo_w / 100) * ((qt_material_w * vl_unitario_material_w) + vl_frete_rateado_w);
			end if;

			if (vl_tributo_w is not null) then
				update	ordem_compra_item_trib
				set		vl_tributo = vl_tributo_w
				where	nr_ordem_compra = nr_ordem_compra_w
				and		nr_item_oci = nr_item_oci_w
				and		cd_tributo = cd_tributo_w;
			end if;
			end;
		end loop;
		close c02;
		end;
	end if;

	commit;
end if;
RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_ordem_compra_item_delete() FROM PUBLIC;

CREATE TRIGGER ordem_compra_item_delete
	BEFORE DELETE ON ordem_compra_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_ordem_compra_item_delete();

