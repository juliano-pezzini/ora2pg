-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_pag_prest_vencimento_atual ON pls_pag_prest_vencimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_pag_prest_vencimento_atual() RETURNS trigger AS $BODY$
declare

nr_seq_protocolo_w		pls_protocolo_conta.nr_sequencia%type;
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;
nr_seq_lote_w			pls_lote_pagamento.nr_sequencia%type;

BEGIN

if (NEW.nr_titulo is null) and (OLD.nr_titulo is not null) then
	select	max(c.nr_seq_protocolo),
		max(b.nr_seq_prestador),
		max(b.nr_seq_lote)
	into STRICT	nr_seq_protocolo_w,
		nr_seq_prestador_w,
		nr_seq_lote_w
	from	pls_pagamento_prestador		b,
		pls_conta_medica_resumo		c
	where	b.nr_seq_prestador	= c.nr_seq_prestador_pgto
	and	b.nr_seq_lote		= c.nr_seq_lote_pgto
	and	((c.ie_situacao = 'A') or (c.ie_situacao is null))
	and	b.nr_sequencia		= NEW.nr_seq_pag_prestador;

	if (nr_seq_protocolo_w is not null) then
		insert into log_tasy(dt_atualizacao,
			nm_usuario,
			cd_log,
			ds_log)
		values (LOCALTIMESTAMP,
			'Trigger',
			99601,
			' Lote pgto prod m√©dica: ' || nr_seq_lote_w || chr(13) ||
			' Prestador: ' || nr_seq_prestador_w || chr(13) ||
			' Protocolo ref: ' || nr_seq_protocolo_w);
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_pag_prest_vencimento_atual() FROM PUBLIC;

CREATE TRIGGER pls_pag_prest_vencimento_atual
	BEFORE UPDATE ON pls_pag_prest_vencimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_pag_prest_vencimento_atual();

