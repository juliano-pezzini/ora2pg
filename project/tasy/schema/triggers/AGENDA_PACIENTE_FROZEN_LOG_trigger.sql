-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS agenda_paciente_frozen_log ON agenda_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_agenda_paciente_frozen_log() RETURNS trigger AS $BODY$
declare

ie_user_allowed_w	varchar(4000);
ie_frozen_status_w 	varchar(4000);
ie_freeze_enabled_w	varchar(1);
ie_cont_status_w	varchar(1);
ie_freeze_process_enable_w varchar(1);

BEGIN
	
	if (obter_tipo_agenda(NEW.cd_agenda) = 1) then
		SELECT * FROM get_frozen_schedule_rule(ie_frozen_status_w, ie_user_allowed_w, ie_freeze_enabled_w, ie_freeze_process_enable_w) INTO STRICT ie_frozen_status_w, ie_user_allowed_w, ie_freeze_enabled_w, ie_freeze_process_enable_w;
		
		select 	coalesce(max('S'), 'N')
		into STRICT 	ie_cont_status_w
		from 	regra_agenda_fechada
		where 	ie_status_agenda = OLD.IE_STATUS_AGENDA;
		
		if (ie_freeze_enabled_w = 'S'
			and ie_cont_status_w = 'S') then
			
			if (OLD.DT_AGENDA <> NEW.DT_AGENDA or 
				OLD.HR_INICIO <> NEW.HR_INICIO or
				OLD.CD_AGENDA <> NEW.CD_AGENDA or
				OLD.IE_STATUS_AGENDA <> NEW.IE_STATUS_AGENDA) then
				
				insert into agenda_pac_frozen_log(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					hr_inicio,
					cd_agenda,
					nr_seq_agenda
				) values (
					nextval('agenda_pac_frozen_log_seq'),
					NEW.dt_atualizacao,
					NEW.nm_usuario,
					LOCALTIMESTAMP,
					NEW.nm_usuario,
					OLD.hr_inicio,
					OLD.cd_agenda,
					NEW.nr_sequencia
				);
								
			end if;
		end if;
	end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_agenda_paciente_frozen_log() FROM PUBLIC;

CREATE TRIGGER agenda_paciente_frozen_log
	AFTER UPDATE ON agenda_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_agenda_paciente_frozen_log();

