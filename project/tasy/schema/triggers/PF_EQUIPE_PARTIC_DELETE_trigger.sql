-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pf_equipe_partic_delete ON pf_equipe_partic CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pf_equipe_partic_delete() RETURNS trigger AS $BODY$
DECLARE
ds_alteracao_w			varchar(4000);
ds_funcao_old_w 		funcao_medico.ds_funcao%TYPE;
ds_cargo_equipe_old_w 	pf_cargo_equipe.ds_cargo%TYPE;
ds_auxiliar_w			varchar(4000);
BEGIN

IF (OLD.nr_sequencia IS NOT NULL) THEN
	/*806528	780633	Realizada exclusao: Participante #@NM_PARTICIPANTE_OLD#@ (Codigo: #@CD_PESSOA_FISICA_OLD#@) Cargo: #@DS_CARGO_OLD#@ (Codigo: #@CD_CARGO_OLD#@) Funcao na equipe: #@DS_CARGO_EQUIPE_OLD#@ (Codigo: #@NR_SEQ_CARGO_EQUIPE_OLD#@) Funcao na cirurgia: #@DS_FUNCAO_OLD#@ (Codigo: #@IE_FUNCAO_OLD#@).*/



	IF (coalesce(OLD.CD_CARGO,-1) > 0)	THEN
		ds_auxiliar_w := OLD.CD_CARGO;
	ELSE
		ds_auxiliar_w := wheb_mensagem_pck.get_texto(806558);
	END IF;

	ds_alteracao_w	:=	SUBSTR('NM_PARTICIPANTE_OLD=' || SUBSTR(obter_nome_pf(OLD.CD_PESSOA_FISICA),1,60) || ';CD_PESSOA_FISICA_OLD=' || OLD.CD_PESSOA_FISICA ||
								';DS_CARGO_OLD='|| coalesce(SUBSTR(obter_desc_cargo(OLD.CD_CARGO),1,200), wheb_mensagem_pck.get_texto(806558)) || ';CD_CARGO_OLD='||  ds_auxiliar_w,1,4000);


	IF (coalesce(OLD.NR_SEQ_CARGO_EQUIPE,-1) > 0)	THEN
		SELECT	MAX(coalesce(ds_cargo,wheb_mensagem_pck.get_texto(806558)))
		INTO STRICT	ds_cargo_equipe_old_w
		FROM     pf_cargo_equipe
		WHERE 	nr_sequencia = OLD.nr_seq_cargo_equipe;

		ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_CARGO_EQUIPE_OLD='|| ds_cargo_equipe_old_w || ';NR_SEQ_CARGO_EQUIPE_OLD='|| OLD.NR_SEQ_CARGO_EQUIPE ,1,4000);
	ELSE
		ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_CARGO_EQUIPE_OLD='|| wheb_mensagem_pck.get_texto(806558) || ';NR_SEQ_CARGO_EQUIPE_OLD='|| wheb_mensagem_pck.get_texto(806558) ,1,4000);
	END IF;

	IF (coalesce(OLD.IE_FUNCAO,-1) > 0)	THEN
		SELECT	MAX(coalesce(ds_funcao,wheb_mensagem_pck.get_texto(806558)))
		INTO STRICT	ds_funcao_old_w
		FROM    funcao_medico
		WHERE cd_funcao = OLD.ie_funcao;

		ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_FUNCAO_OLD='|| ds_funcao_old_w || ';IE_FUNCAO_OLD='|| OLD.IE_FUNCAO ,1,4000);

	ELSE
		ds_alteracao_w	:=	SUBSTR(ds_alteracao_w || ';DS_FUNCAO_OLD='|| wheb_mensagem_pck.get_texto(806558) || ';IE_FUNCAO_OLD='|| wheb_mensagem_pck.get_texto(806558) ,1,4000);
	END IF;

	ds_alteracao_w	:=	SUBSTR(wheb_mensagem_pck.get_texto(806528, SUBSTR(ds_alteracao_w, 1, 4000)), 1, 4000);

END IF;

IF (ds_alteracao_w IS NOT NULL) THEN
	CALL gravar_hist_pf_equipe_partic(OLD.NR_SEQ_EQUIPE,'D',ds_alteracao_w,coalesce(obter_usuario_ativo,OLD.nm_usuario));
END IF;

RETURN OLD;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pf_equipe_partic_delete() FROM PUBLIC;

CREATE TRIGGER pf_equipe_partic_delete
	BEFORE DELETE ON pf_equipe_partic FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pf_equipe_partic_delete();

