-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_conta_rec_resumo_item_atu ON pls_conta_rec_resumo_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_conta_rec_resumo_item_atu() RETURNS trigger AS $BODY$
BEGIN
 
-- Se for incluso o resumo item em um lote de pagamento, deverá estar com o status "Valido" 
-- Essa regra também se aplica quando for alterado o status, pois não deveria ser possivel inativar um resumo dento de um pagamento 
-- Ainda, caso o lote de pagamento for cancelado, os vinculos com eles deverão ser desfeitos, portanto em resumos com pagamento será necessario 
-- cancelar o lote para então inativar o resumo 
if	((NEW.nr_seq_lote_pgto is not null AND NEW.nr_seq_pag_item is not null) and 
	 (OLD.nr_seq_lote_pgto is null AND OLD.nr_seq_pag_item is null) and (NEW.ie_situacao != 'A')) then 
	-- Apenas escolhe qual a melhor mensagem, para deixar mais claro para o cliente 
	-- Se o que foi alterado foi a situação 
	if	(OLD.ie_situacao is not null AND NEW.ie_situacao != OLD.ie_situacao) then 
		 
		--Não é possível inativar o resumo de recurso de glosa seq: #@NR_SEQ_CONTA_REC_RESUMO#@, quando está contido no lote de pagamento:#@NR_SEQ_LOTE_PGTO#@, item: #@NR_SEQ_PAG_ITEM#@ 
		CALL wheb_mensagem_pck.exibir_mensagem_abort('Não é possível inativar o resumo de recurso de glosa seq: '||to_char(NEW.nr_sequencia)||', quando está contido no lote de pagamento: '||to_char(NEW.nr_seq_lote_pgto)||', item: '||to_char(NEW.nr_seq_pag_item));
	else -- senão parte do principio que foi vinculado incorretamente em um lote de pagamento 
		 
		--Não é possível incluir o resumo de recurso de glosa seq: #@NR_SEQ_CONTA_REC_RESUMO#@ no lote de pagamento: #@NR_SEQ_LOTE_PGTO#@, item: #@NR_SEQ_PAG_ITEM#@, pois ele está inativo. 
		CALL wheb_mensagem_pck.exibir_mensagem_abort('Não é possível incluir o resumo de recurso de glosa seq: '||to_char(NEW.nr_sequencia)||' no lote de pagamento: '||to_char(NEW.nr_seq_lote_pgto)||', item: '||to_char(NEW.nr_seq_pag_item)||', pois ele está inativo.');
	end if;
end if;
 
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_conta_rec_resumo_item_atu() FROM PUBLIC;

CREATE TRIGGER pls_conta_rec_resumo_item_atu
	BEFORE UPDATE ON pls_conta_rec_resumo_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_conta_rec_resumo_item_atu();

