-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_latch_atual ON escala_latch CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_latch_atual() RETURNS trigger AS $BODY$
declare
  sql_w       varchar(200);
  qt_reg_w    smallint;
  qt_pontos_w bigint := 0;
    ds_erro_w        varchar(4000);
    ds_parametros_w  varchar(4000);
BEGIN
  BEGIN
    if (wheb_usuario_pck.get_ie_executar_trigger	= 'N') then
        goto Final;
    end if;

  BEGIN
    sql_w := 'call obter_score_escala_latch_md(:1, :2, :3, :4, :5) into :qt_pontos_w';

    EXECUTE sql_w using in NEW.qt_pega,
                                  in NEW.qt_succao_audivel, 
                                  in NEW.qt_tipo_mamilo, 
                                  in NEW.qt_bem_estar_mamario, 
                                  in NEW.qt_colo, 
                                  out qt_pontos_w;
  exception
      when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_succao_audivel: '||NEW.qt_succao_audivel||'-'||':new.qt_tipo_mamilo: '||NEW.qt_tipo_mamilo||'-'||':new.qt_bem_estar_mamario: '||NEW.qt_bem_estar_mamario||'-'||
                          ':new.qt_colo: '||NEW.qt_colo||'-'||'qt_pontos_w: '||qt_pontos_w);
      CALL gravar_log_medical_device('ESCALA_LATCH_ATUAL','obter_score_escala_latch_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
          qt_pontos_w := null;
  end;

  NEW.qt_pontos :=  qt_pontos_w;

  <<Final>>
  qt_reg_w	:= 0;
  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_latch_atual() FROM PUBLIC;

CREATE TRIGGER escala_latch_atual
	BEFORE INSERT OR UPDATE ON escala_latch FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_latch_atual();

