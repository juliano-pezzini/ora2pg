-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS material_lote_fornec_update ON material_lote_fornec CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_material_lote_fornec_update() RETURNS trigger AS $BODY$
DECLARE
reg_integracao_p		gerar_int_padrao.reg_integracao;
cd_grupo_material_w     grupo_material.cd_grupo_material%type;
cd_subgrupo_material_w     subgrupo_material.cd_subgrupo_material%type;
cd_classe_material_w     classe_material.cd_classe_material%type;
nr_seq_familia_w     material.nr_seq_familia%type;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
reg_integracao_p.ie_operacao		:=	'A';

if (TG_OP = 'INSERT') then
	BEGIN
	reg_integracao_p.ie_operacao	:=	'I';
	
	NEW.ie_bloqueio	:=	coalesce(NEW.ie_bloqueio, 'N');
	
	if (NEW.dt_atualizacao_nrec is null) then
		BEGIN
		NEW.dt_atualizacao_nrec	:=	NEW.dt_atualizacao;
		NEW.nm_usuario_nrec	:=	NEW.nm_usuario;
		end;
	end if;

    select
		gm.cd_grupo_material,
		sm.cd_subgrupo_material,
		cm.cd_classe_material,
		coalesce(m.nr_seq_familia, 0) as nr_seq_familia	
    into STRICT cd_grupo_material_w,
         cd_subgrupo_material_w,
         cd_classe_material_w,
         nr_seq_familia_w
	from material m,
		classe_material cm,
		subgrupo_material sm,
		grupo_material gm
	where m.cd_classe_material = cm.cd_classe_material
      and cm.cd_subgrupo_material = sm.cd_subgrupo_material
      and sm.cd_grupo_material = gm.cd_grupo_material
      and m.cd_material = NEW.cd_material;

    if (NEW.ie_origem_manual IS NULL OR NEW.ie_origem_manual = 'N') THEN
        if (NEW.ie_tipo_programa is null) THEN
            NEW.ie_tipo_programa := obter_regra_prog_saude(NEW.cd_material, NEW.cd_estabelecimento, cd_grupo_material_w, cd_subgrupo_material_w,cd_classe_material_w,nr_seq_familia_w);
        end if;
        -- Buscar IE_CLASSIF_RENAME pelo caso venha vazio

        if (NEW.ie_classif_rename is null) THEN
            NEW.ie_classif_rename := obter_regra_rename(NEW.cd_material, NEW.cd_estabelecimento, cd_grupo_material_w, cd_subgrupo_material_w,cd_classe_material_w,nr_seq_familia_w);
        end if;
    end if;
	end;
end if;

if (NEW.ie_validade_indeterminada = 'N') and (NEW.dt_validade is null) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266254);
	--'Deve ser informado a validade do lote, ou como validade indeterminada');

elsif (NEW.ie_validade_indeterminada = 'S') and (NEW.dt_validade is not null) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266255);
	--'Se a validade for indeterminada, nao deve ser informado a data de validade');

end if;

/*Enviar para integracao padrao*/



select	a.cd_grupo_material,
	a.cd_subgrupo_material,
	a.cd_classe_material
into STRICT	reg_integracao_p.cd_grupo_material,
	reg_integracao_p.cd_subgrupo_material,
	reg_integracao_p.cd_classe_material
from	estrutura_material_v a
where	a.cd_material = NEW.cd_material;


reg_integracao_p.cd_estab_documento	:= NEW.cd_estabelecimento;
reg_integracao_p.ie_origem_lote	:= NEW.ie_origem_lote;
reg_integracao_p.cd_material		:= NEW.cd_material;

reg_integracao_p := gerar_int_padrao.gravar_integracao('75', NEW.nr_sequencia, NEW.nm_usuario, reg_integracao_p);

/* Chamada da procedure dankia_atualizar_ds_barras */


if (OLD.ds_barras <> NEW.ds_barras) then
   CALL gerar_int_dankia_pck.dankia_atualizar_ds_barras(OLD.ds_barras, NEW.ds_barras, OLD.nm_usuario);
	end if;
end if;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_material_lote_fornec_update() FROM PUBLIC;

CREATE TRIGGER material_lote_fornec_update
	BEFORE INSERT OR UPDATE ON material_lote_fornec FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_material_lote_fornec_update();

