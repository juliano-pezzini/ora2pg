-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS sismama_mam_anamnese_atual ON sismama_mam_anamnese CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_sismama_mam_anamnese_atual() RETURNS trigger AS $BODY$
declare

nr_data_mamo_w	bigint;
nr_atendimento_w	bigint;
dt_nascimento_w		timestamp;

BEGIN

if (NEW.DT_ULTIMA_MAMOGRAFIA	is not null) then
	nr_data_mamo_w	:= somente_numero(NEW.DT_ULTIMA_MAMOGRAFIA);
	
	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	SISMAMA_ATENDIMENTO
	where	nr_sequencia	= NEW.nr_seq_sismama;
	
	select	max(a.dt_nascimento)
	into STRICT	dt_nascimento_w
	from	atendimento_paciente b,
		pessoa_fisica a
	where	a.cd_pessoa_fisica 	= b.cd_pessoa_fisica
	and	b.nr_atendimento	= nr_atendimento_w;	
	
	
	if (nr_data_mamo_w	> 0) then
	   	
		if	((nr_data_mamo_w	> to_char(ESTABLISHMENT_TIMEZONE_UTILS.startOfYear(LOCALTIMESTAMP),'yyyy')) or (dt_nascimento_w is not null and nr_data_mamo_w	< to_char(ESTABLISHMENT_TIMEZONE_UTILS.startOfYear(dt_nascimento_w),'yyyy'))) then
			CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(235879);
		
		end if;
		
	end if;
	
	
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_sismama_mam_anamnese_atual() FROM PUBLIC;

CREATE TRIGGER sismama_mam_anamnese_atual
	BEFORE INSERT OR UPDATE ON sismama_mam_anamnese FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_sismama_mam_anamnese_atual();

