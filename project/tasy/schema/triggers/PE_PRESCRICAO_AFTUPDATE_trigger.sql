-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pe_prescricao_aftupdate ON pe_prescricao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pe_prescricao_aftupdate() RETURNS trigger AS $BODY$
declare
qt_reg_w		bigint;
qt_acomp_w		bigint;
ie_lib_dieta_w 		varchar(15);
ie_idade_w		bigint;
qt_atend_categ		bigint;
qt_dieta_w		bigint;
cd_risco_queda_w	bigint;
ie_considera_sae_w	varchar(1);
cd_tipo_acomodacao_w	bigint;
ie_gerar_evolucao_care_plan_w     varchar(1);

BEGIN
if (OLD.dt_liberacao is null) and (NEW.dt_liberacao is not null) then
	BEGIN

	select	coalesce(obter_idade_pf(obter_pessoa_atendimento(NEW.nr_atendimento,'C'),LOCALTIMESTAMP,'A'),0)
	into STRICT	ie_idade_w
	;

	if 	((ie_idade_w <= 8) or (obter_se_pac_isolamento(NEW.nr_atendimento) = 'S')) then
		ie_lib_dieta_w := 'T';
	else	ie_lib_dieta_w := 'L';
	end if;
	
	select 	coalesce(max(cd_risco_queda),0)
	into STRICT	cd_risco_queda_w
	from	parametro_atendimento;

	select	count(*)
	into STRICT	qt_reg_w
	from	PE_PRESCR_DIAG a
	where	a.nr_seq_diag	=	cd_risco_queda_w
	and	a.nr_seq_prescr = 	NEW.nr_sequencia;

	select 	coalesce(obter_se_considera_sae(NEW.cd_setor_atendimento,NEW.cd_pessoa_fisica,NEW.nr_atendimento),0)
	into STRICT	ie_considera_sae_w
	;
	
	select 	coalesce(obter_dados_categ_conv(NEW.nr_atendimento,'A'),0)
	into STRICT	cd_tipo_acomodacao_w
	;

	if	(qt_reg_w > 0 AND ie_considera_sae_w = 'S') then


		select 	coalesce(nr_acompanhante,0),
			coalesce(qt_dieta_acomp,0)
		into STRICT	qt_acomp_w,
			qt_dieta_w
		from	atend_categoria_convenio
		where 	nr_atendimento = NEW.nr_atendimento
		and	nr_seq_interno = obter_atecaco_atendimento(NEW.nr_atendimento);


		if      (qt_acomp_w = 0  AND qt_dieta_w = 0)then
			if ((obter_se_pac_isolamento(NEW.nr_atendimento) = 'N') or (ie_idade_w > 18) or (ie_idade_w < 59)) then
			update  atend_categoria_convenio
			set 	nr_acompanhante = 1,
				qt_dieta_acomp = 1,
				ie_lib_dieta = ie_lib_dieta_w
			where   nr_atendimento =  NEW.nr_atendimento;
			end if;

		end if;
	elsif (cd_risco_queda_w > 0) then
		CALL atualizar_dados_convenio(NEW.nr_atendimento,obter_setor_atendimento(NEW.nr_atendimento),cd_tipo_acomodacao_w,'N',NEW.nr_sequencia);
	end if;

	end;
end if;

ie_gerar_evolucao_care_plan_w := obter_param_usuario(281, 1635, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1), ie_gerar_evolucao_care_plan_w);

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
	if ( ie_gerar_evolucao_care_plan_w = 'S' ) then
		if (NEW.dt_liberacao is not null and OLD.dt_inativacao is null and NEW.dt_inativacao is not null  and NEW.ie_situacao = 'I' and NEW.cd_evolucao is not null) then

			delete from clinical_note_soap_data where cd_evolucao = NEW.cd_evolucao and ie_med_rec_type = 'CARE_PLAN' and ie_stage = 1  and ie_soap_type = 'P' and nr_seq_med_item = NEW.nr_sequencia;
		end if;
    end if;
end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pe_prescricao_aftupdate() FROM PUBLIC;

CREATE TRIGGER pe_prescricao_aftupdate
	AFTER UPDATE ON pe_prescricao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pe_prescricao_aftupdate();

