-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS alteracao_portador_after ON alteracao_portador CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_alteracao_portador_after() RETURNS trigger AS $BODY$
declare

cd_estabelecimento_w    ctb_documento.cd_estabelecimento%type;
vl_movimento_w          ctb_documento.vl_movimento%type;
nr_seq_proj_rec_w       ctb_documento.nr_seq_proj_rec%type;

c01 CURSOR FOR
        SELECT  a.nm_atributo,
                a.cd_tipo_lote_contab
        from    atributo_contab a
        where   a.cd_tipo_lote_contab = 5
        and     a.nm_atributo in ( 'VL_ALTERACAO_PORTADOR', 'VL_TIT_ALT_PORTADOR');

c01_w           c01%rowtype;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
if ( coalesce(NEW.nr_titulo, 0) <> 0 ) then
        BEGIN

        select  cd_estabelecimento, nr_seq_proj_rec
        into STRICT    cd_estabelecimento_w, nr_seq_proj_rec_w
        from    titulo_Receber
        where   nr_titulo = NEW.nr_titulo;

        exception
                when no_data_found then
                        cd_estabelecimento_w := null;
                        nr_seq_proj_rec_w := null;
                when too_many_rows then
                        cd_estabelecimento_w := null;
                        nr_seq_proj_rec_w := null;


	/* Projeto Davita  - Nao deixa gerar movimento contabil apos fechamento  da data */


	CALL philips_contabil_pck.valida_se_dia_fechado(OBTER_EMPRESA_ESTAB(cd_estabelecimento_w),NEW.dt_alteracao);

        open c01;
        loop
        fetch c01 into
                c01_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
                BEGIN

                vl_movimento_w  :=      case    c01_w.nm_atributo
                                        when    'VL_ALTERACAO_PORTADOR'    then NEW.vl_despesa
                                        when    'VL_TIT_ALT_PORTADOR'      then NEW.vl_saldo_titulo
                                        else
                                                null
                                        end;

                if (coalesce(vl_movimento_w, 0) <> 0) and (coalesce(NEW.nr_seq_trans_fin, 0) <> 0) then
                        BEGIN

                        CALL ctb_concil_financeira_pck.ctb_gravar_documento(       cd_estabelecimento_w,
                                                                                trunc(NEW.dt_alteracao),
                                                                                c01_w.cd_tipo_lote_contab,
                                                                                NEW.nr_seq_trans_fin,
                                                                                43,
                                                                                NEW.nr_titulo,
                                                                                NEW.nr_sequencia,
                                                                                0,
                                                                                vl_movimento_w,
                                                                                'ALTERACAO_PORTADOR',
                                                                                c01_w.nm_atributo,
                                                                                NEW.nm_usuario,
                                                                                'P',
                                                                                null,
                                                                                nr_seq_proj_rec_w);

                        end;
                end if;




                end;
        end loop;
        close c01;

        end;
end if;
end if;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_alteracao_portador_after() FROM PUBLIC;

CREATE TRIGGER alteracao_portador_after
	AFTER INSERT ON alteracao_portador FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_alteracao_portador_after();

