-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS movimento_contabil_doc_before ON movimento_contabil_doc CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_movimento_contabil_doc_before() RETURNS trigger AS $BODY$
declare
nr_seq_ctb_documento_w          ctb_documento.nr_sequencia%type;
cd_estabelecimento_w            ctb_documento.cd_estabelecimento%type;
cd_tipo_lote_contabil_w         ctb_documento.cd_tipo_lote_contabil%type;
ie_concil_contab_w              pls_visible_false.ie_concil_contab%type;
nm_atributo_w                   ctb_documento.nm_atributo%type;
nm_atributo_ret_w               varchar(255);
id_indx_aux_w                   integer:= 0;
ie_atributo_unico_w             boolean:= false;
BEGIN
  BEGIN

if (coalesce(wheb_usuario_pck.get_ie_executar_trigger, 'S') = 'S') then
        /*Variavel recebendo N como valor padrao pois a funcionalidade ainda nao esta disponibilizada aos clientes para utilizacao*/


        ie_concil_contab_w := 'N';

        if (ie_concil_contab_w = 'S') then
                BEGIN

                if (TG_OP = 'INSERT') then
                        BEGIN
                        select  a.cd_estabelecimento,
                                b.cd_tipo_lote_contabil
                        into STRICT    cd_estabelecimento_w,
                                cd_tipo_lote_contabil_w
                        from    movimento_contabil a,
                                lote_contabil b
                        where   a.nr_lote_contabil      = b.nr_lote_contabil
                        and     a.nr_sequencia          = NEW.nr_seq_movimento
                        and     a.nr_lote_contabil      = NEW.nr_lote_contabil;

                        exception
                        when others then
                                cd_estabelecimento_w    := 0;
                                cd_tipo_lote_contabil_w := 0;
                        end;

                        nm_atributo_ret_w:= ctb_concil_financeira_pck.formata_atributos_conciliacao(NEW.nm_atributo);

                        for i in 1..length(nm_atributo_ret_w)loop
                                if ( substr(nm_atributo_ret_w,i,1) = '|') then
                                        id_indx_aux_w := id_indx_aux_w + 1;
                                end if;
                        end loop;

                        if (id_indx_aux_w = 0) and (length(nm_atributo_ret_w) > 0) then
                                id_indx_aux_w           := 1;
                                ie_atributo_unico_w     := true;
                        end if;

                        for i in 1..id_indx_aux_w loop
                                if (id_indx_aux_w = 1) and (ie_atributo_unico_w) then
                                        nm_atributo_w           := nm_atributo_ret_w;
                                else
                                        nm_atributo_w           := substr(nm_atributo_ret_w,1 , position('|' in nm_atributo_ret_w) - 1);
                                        nm_atributo_ret_w       := substr(nm_atributo_ret_w, position('|' in nm_atributo_ret_w) + 1, length(nm_atributo_ret_w));
                                end if;

                                BEGIN

                                select  nr_sequencia
                                into STRICT    nr_seq_ctb_documento_w
                                from    ctb_documento a
                                where   trunc(a.dt_competencia, 'dd')   = trunc(NEW.dt_movimento, 'dd')
                                and     a.cd_tipo_lote_contabil         = cd_tipo_lote_contabil_w
                                and     a.nr_seq_info                   = NEW.nr_seq_info
                                and     a.nr_documento                  = NEW.nr_documento
                                and     coalesce(a.nr_seq_doc_compl, 0)      = coalesce(NEW.nr_seq_doc_compl,0)
                                and     coalesce(a.nr_doc_analitico, 0)      = coalesce(NEW.nr_doc_analitico, 0)
                                and     a.nm_tabela                     = NEW.nm_tabela
                                and     a.nm_atributo                   = nm_atributo_w
                                and     ((a.vl_movimento                = NEW.vl_movimento)
                                        or a.cd_tipo_lote_contabil in (2, 51));

                                exception
                                when others then
                                        nr_seq_ctb_documento_w:= 0;

                                end;

                                if (coalesce(nr_seq_ctb_documento_w, 0) <> 0) then
                                        NEW.nr_seq_ctb_documento       := nr_seq_ctb_documento_w;
                                        NEW.nm_usuario                 := NEW.nm_usuario;
                                        NEW.dt_atualizacao             := LOCALTIMESTAMP;

                                        update  ctb_documento
                                        set     nr_lote_contabil        = NEW.nr_lote_contabil,
                                                ie_status               = 'P',
                                                nm_usuario              = NEW.nm_usuario,
                                                dt_atualizacao          = LOCALTIMESTAMP
                                        where   nr_sequencia            = nr_seq_ctb_documento_w
                                        and     cd_tipo_lote_contabil   = cd_tipo_lote_contabil_w;
                                end if;
                        end loop;
                else
                        update  ctb_documento
                        set     nr_lote_contabil         = NULL
                        where   nr_lote_contabil        = OLD.nr_lote_contabil;
                end if;

                end;
        end if;
end if;
  END;
IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_movimento_contabil_doc_before() FROM PUBLIC;

CREATE TRIGGER movimento_contabil_doc_before
	BEFORE INSERT OR DELETE ON movimento_contabil_doc FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_movimento_contabil_doc_before();

