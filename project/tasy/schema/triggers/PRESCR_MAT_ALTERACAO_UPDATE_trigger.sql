-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS prescr_mat_alteracao_update ON prescr_mat_alteracao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_prescr_mat_alteracao_update() RETURNS trigger AS $BODY$
declare
cd_evolucao_w     integer;
nr_sequencia_w    integer;
nr_data_considerada_w   bigint;

c01 CURSOR FOR
    SELECT 	nr_sequencia
    from 	atendimento_perda_ganho
    where 	nr_atendimento 	= OLD.nr_atendimento
    and	nr_seq_horario 	= nr_data_considerada_w
    and	ie_situacao 	= 'A';

BEGIN
nr_data_considerada_w:= null;
  if ((coalesce(OLD.ie_evento_valido,'S') = 'S')
      and (coalesce(NEW.ie_evento_valido,'S') = 'N')) then
		select max(cd_evolucao)
		into STRICT cd_evolucao_w
		from Prescr_mat_alteracao_comp
		where NR_SEQUENCIA_PRESCR = OLD.NR_SEQUENCIA;

		update EVOLUCAO_PACIENTE
			set ie_situacao 	= 'I',
			dt_inativacao 	= LOCALTIMESTAMP,
			nm_usuario_inativacao = NEW.nm_usuario
		where cd_evolucao 	= cd_evolucao_w
		and ie_situacao 	= 'A';

		if (OLD.ie_alteracao = 3) then

			if (OLD.ie_tipo_item in ('M', 'LD'))
			and (coalesce(OLD.nr_seq_horario, 0) > 0) then

				nr_data_considerada_w := OLD.nr_seq_horario;

			elsif (OLD.ie_tipo_item in ('D', 'DS'))
			and (coalesce(OLD.nr_seq_horario_dieta, 0) > 0) then

				nr_data_considerada_w := OLD.nr_seq_horario_dieta;

			elsif (OLD.ie_tipo_item in ('DE'))
			and (coalesce(OLD.nr_seq_servico, 0) > 0) then

				nr_data_considerada_w := OLD.nr_seq_servico;

			end if;
		end if;

		if (nr_data_considerada_w is not null) then
		    open c01;
			loop
			fetch c01 into
			    nr_sequencia_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
			
			update	atendimento_perda_ganho
			    set	ie_situacao = 'I',
				dt_inativacao = LOCALTIMESTAMP,
				nm_usuario_inativacao = NEW.nm_usuario,
				ds_justificativa  = NULL
			    where	nr_sequencia = nr_sequencia_w;	
		    end loop;
		end if;	
  end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_prescr_mat_alteracao_update() FROM PUBLIC;

CREATE TRIGGER prescr_mat_alteracao_update
	AFTER UPDATE OF ie_evento_valido ON prescr_mat_alteracao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_prescr_mat_alteracao_update();

