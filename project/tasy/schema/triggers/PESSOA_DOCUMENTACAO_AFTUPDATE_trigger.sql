-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pessoa_documentacao_aftupdate ON pessoa_documentacao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pessoa_documentacao_aftupdate() RETURNS trigger AS $BODY$
declare


ie_res_w   				varchar(1);
cd_pessoa_usuario_w		varchar(10);
cd_pf_usuario_w			varchar(10);
ds_param_integ_hl7_w 	varchar(4000);
cd_estabelecimento_w	integer;
BEGIN
  BEGIN
BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then

	if (NEW.IE_ENTREGUE <> OLD.IE_ENTREGUE) and (NEW.IE_ENTREGUE = 'S' )then

		
		Select 	coalesce(max('S'),'N')
		into STRICT	ie_res_w
		from   	conversao_meio_externo b
		where  	nm_tabela = 'PESSOA_DOCUMENTACAO'
		and		nm_atributo = 'IE_DOC_EXTERNO'
		and		b.cd_interno  = NEW.NR_SEQ_DOCUMENTO
		and		b.CD_EXTERNO = 'ACTPF'
		and    	b.ie_sistema_externo = 'TERUNIMED16';

		
		if (ie_res_w = 'S') then
		
			Select  max(Obter_Pf_Usuario(NEW.nm_usuario, 'C')),
					max(wheb_usuario_pck.get_cd_estabelecimento)
			into STRICT	cd_pessoa_usuario_w,
					cd_estabelecimento_w
			;
		
			if (NEW.cd_pessoa_fisica = cd_pessoa_usuario_w) then
		
			
					ds_param_integ_hl7_w := 'cd_transacao='              || '00880'|| ';' ||
											'cd_estabelecimento='        || cd_estabelecimento_w|| ';' ||
											'cd_pf_usuario='             || cd_pessoa_usuario_w      || ';';

											
					CALL gravar_agend_integracao(682, ds_param_integ_hl7_w);
					
			end if;
		
		end if;
		
		
	end if;
	
end if;

exception
	when others then
	null;
end;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pessoa_documentacao_aftupdate() FROM PUBLIC;

CREATE TRIGGER pessoa_documentacao_aftupdate
	AFTER UPDATE ON pessoa_documentacao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pessoa_documentacao_aftupdate();

