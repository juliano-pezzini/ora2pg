-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS can_ordem_prod_mat_delete ON can_ordem_prod_mat CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_can_ordem_prod_mat_delete() RETURNS trigger AS $BODY$
DECLARE
nr_seq_cabine_w		bigint;
cd_estab_w			smallint;
ie_baixa_kit_w varchar(1);
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then
	RETURN OLD;
end if;

ie_baixa_kit_w := obter_param_usuario(3130, 511, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_baixa_kit_w);

select	b.nr_seq_cabine
into STRICT	nr_seq_cabine_w
from	far_etapa_producao b,
	can_ordem_prod a
where	a.nr_sequencia = OLD.nr_seq_ordem
and	b.nr_sequencia = a.nr_seq_etapa_prod;

select	cd_estabelecimento
into STRICT	cd_estab_w
from	far_cabine_seg_biol
where	nr_sequencia = nr_seq_cabine_w;

BEGIN
if (coalesce(OLD.ie_devolve_cabine,'S') <> 'N') and (OLD.nr_seq_kit is null or ie_baixa_kit_w = 'S') and (OLD.IE_SOBRA_OVERFILL not in ('Y','X','Z')) then --nao tratar diluentes dos medic diluidos
	CALL wheb_usuario_pck.set_ie_commit('N');
	CALL Adiciona_item_cabine(OLD.cd_material, OLD.qt_dose_real, OLD.nr_seq_lote_fornec, OLD.nm_usuario, nr_seq_cabine_w, OLD.IE_SOBRA_OVERFILL, OLD.NR_SEQ_ORDEM_ORIGEM);
	CALL wheb_usuario_pck.set_ie_commit('S');
end if;
if (coalesce(OLD.ie_devolve_cabine,'S') <> 'N') and (OLD.nr_seq_kit is null or ie_baixa_kit_w = 'S') and (OLD.IE_SOBRA_OVERFILL in ('Y','X')) then
--restaura a dose do medicamento diluido

	update	quimio_sobra_overfill
	set		qt_saldo = qt_saldo + round((Obter_conversao_ml(OLD.cd_material, OLD.qt_dose_real, OLD.cd_unidade_medida_real))::numeric,3)
	where	nr_sequencia = OLD.nr_seq_quimio_sobra_overfill;
end if;
exception
	when others then
      	nr_seq_cabine_w := 1;
end;
  END;
RETURN OLD;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_can_ordem_prod_mat_delete() FROM PUBLIC;

CREATE TRIGGER can_ordem_prod_mat_delete
	AFTER DELETE ON can_ordem_prod_mat FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_can_ordem_prod_mat_delete();

