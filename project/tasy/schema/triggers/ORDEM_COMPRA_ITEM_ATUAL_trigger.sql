-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS ordem_compra_item_atual ON ordem_compra_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_ordem_compra_item_atual() RETURNS trigger AS $BODY$
DECLARE


cd_tributo_w			integer;
pr_tributo_w			double precision;
qt_registro_w			integer;
vl_tributo_w			double precision;
qt_reg_w				smallint;
nr_seq_reg_lic_compra_w		bigint;
nr_solic_compra_w			bigint;
nr_item_solic_compra_w		bigint;
nr_seq_licitacao_w			bigint;
nr_sequencia_w			bigint;
qt_mat_solicitacao_w		double precision;
qt_diferenca_w			double precision;
qt_alterada_w			double precision;
vl_ultima_compra_w		double precision;
vl_dif_ultima_compra_w		double precision;
pr_dif_ultima_compra_w		double precision;
cd_estabelecimento_w		bigint;
ie_sistema_origem_w		varchar(15);
ie_tipo_tributo_w		tributo.ie_tipo_tributo%type;
ie_considera_rateio_trib_w	varchar(15);
ie_frete_w				ordem_compra.ie_frete%type;
vl_frete_w				ordem_compra.vl_frete%type;
vl_frete_rateado_w		ordem_compra.vl_frete%type;
qt_itens_oc_w			ordem_compra_item.nr_item_oci%type;
nr_ordem_compra_w		ordem_compra_item_trib.nr_ordem_compra%type;
nr_item_oci_w			ordem_compra_item_trib.nr_item_oci%type;
qt_material_w			ordem_compra_item.qt_material%type;
vl_unitario_material_w	ordem_compra_item.vl_unitario_material%type;
vl_desconto_w			ordem_compra_item.vl_desconto%type;

ie_desc_nf_w			varchar(15);

C01 CURSOR FOR
SELECT	a.cd_tributo,
	a.pr_tributo,
	b.ie_tipo_tributo
from	ordem_compra_item_trib a,
	tributo b
where	a.cd_tributo = b.cd_tributo
and	nr_ordem_compra	= NEW.nr_ordem_compra
and	nr_item_oci	= NEW.nr_item_oci;

c02 CURSOR FOR
SELECT	ocit.nr_ordem_compra,
		ocit.nr_item_oci,
		ocit.cd_tributo,
		ocit.pr_tributo,
		CASE WHEN NEW.nr_item_oci=ocit.nr_item_oci THEN  NEW.qt_material  ELSE obter_inf_itens_oc(ocit.nr_ordem_compra, ocit.nr_item_oci, 1) END ,
		CASE WHEN NEW.nr_item_oci=ocit.nr_item_oci THEN  NEW.vl_unitario_material  ELSE obter_inf_itens_oc(ocit.nr_ordem_compra, ocit.nr_item_oci, 2) END ,
		CASE WHEN NEW.nr_item_oci=ocit.nr_item_oci THEN  NEW.vl_desconto  ELSE obter_inf_itens_oc(ocit.nr_ordem_compra, ocit.nr_item_oci, 3) END
from	ordem_compra_item_trib ocit,
		tributo t
where	ocit.nr_ordem_compra = NEW.nr_ordem_compra
and		ocit.cd_tributo = t.cd_tributo
and		t.ie_tipo_tributo = 'IPI'
and		coalesce(CASE WHEN NEW.nr_item_oci=ocit.nr_item_oci THEN  NEW.vl_frete_rateio  ELSE obter_inf_itens_oc(ocit.nr_ordem_compra, ocit.nr_item_oci, 4) END ,0) = 0;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;

if (obter_bloq_canc_proj_rec(NEW.nr_seq_proj_rec) > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1144309);  -- Registro associado a um projeto bloqueado ou cancelado. 
end if;

NEW.pr_descontos		:= coalesce(NEW.pr_descontos,0);
NEW.vl_unitario_material	:= coalesce(NEW.vl_unitario_material,0);
NEW.qt_material		:= coalesce(NEW.qt_material,0);

if (coalesce(NEW.vl_desconto,0) > 0) then
	NEW.vl_item_liquido		:= 	round((NEW.vl_total_item - coalesce(NEW.vl_desconto,0))::numeric,2);
else
	NEW.vl_item_liquido		:= 	round(NEW.vl_total_item - ((NEW.vl_total_item * NEW.pr_descontos) / 100),2);
end if;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	ordem_compra
where	nr_ordem_compra = NEW.nr_ordem_compra;

if (TG_OP = 'INSERT') then

	vl_ultima_compra_w		:= coalesce(obter_dados_ult_compra_data(cd_estabelecimento_w,NEW.cd_material, null, trunc(LOCALTIMESTAMP,'dd'), 0, 'VU'),0);
	vl_dif_ultima_compra_w		:= vl_ultima_compra_w - coalesce(NEW.vl_unitario_material,0);
	BEGIN
		pr_dif_ultima_compra_w	:= round((dividir(vl_dif_ultima_compra_w, vl_ultima_compra_w) * 100),2);
	exception
	when others then
		pr_dif_ultima_compra_w	:= 99999999;
	end;
	
	NEW.vl_ultima_compra		:= vl_ultima_compra_w;
	NEW.vl_dif_ultima_compra	:= vl_dif_ultima_compra_w;
	NEW.pr_dif_ultima_compra	:= pr_dif_ultima_compra_w;
end if;
		
		
select	obter_valor_param_usuario(915, 190, obter_perfil_ativo, NEW.nm_usuario, cd_estabelecimento_w)
into STRICT	ie_considera_rateio_trib_w
;
					
select	count(*)
into STRICT	qt_registro_w
from	ordem_compra_item_trib
where	nr_ordem_compra	= NEW.nr_ordem_compra
and	nr_item_oci	= NEW.nr_item_oci;

if (qt_registro_w > 0) then
	BEGIN
	open c01;
	loop
	fetch c01 into
		cd_tributo_w,
		pr_tributo_w,
		ie_tipo_tributo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		BEGIN
		
		select	coalesce(ie_desc_nf,'N')
		into STRICT	ie_desc_nf_w
		from	tributo
		where	cd_tributo = cd_tributo_w;
		
		/* - Alterado por Lssilva em 19/09/2017 - OS1494616 */


		if (ie_desc_nf_w = 'S') then
			vl_tributo_w	:= (pr_tributo_w / 100) * ((NEW.qt_material * NEW.vl_unitario_material) - coalesce(NEW.vl_desconto,0));
		else
			vl_tributo_w	:= (pr_tributo_w / 100) * (NEW.qt_material * NEW.vl_unitario_material);
			/* - (:new.qt_material * :new.vl_unitario_material) * (:new.pr_descontos / 100)); Alterado por Anderson em 20/07/2009 - OS154749 */


		end if;
		
		
				
		if (NEW.vl_frete_rateio > 0) and (ie_considera_rateio_trib_w = 'S') and (ie_tipo_tributo_w in ('IPI','ICMS','ICMSST')) then				
			
			vl_tributo_w	:= (pr_tributo_w / 100) * ((NEW.qt_material * NEW.vl_unitario_material)+NEW.vl_frete_rateio);
		end if;
				
		update	ordem_compra_item_trib
		set	vl_tributo			= vl_tributo_w
		where	nr_ordem_compra		= NEW.nr_ordem_compra
		and	nr_item_oci		= NEW.nr_item_oci
		and	cd_tributo			= cd_tributo_w;
		end;
	end loop;
	close c01;
	end;
end if;

if (TG_OP = 'UPDATE') then

	if (coalesce(OLD.nr_seq_marca,0) <> coalesce(NEW.nr_seq_marca,0)) then
		NEW.ds_marca := SUBSTR(obter_desc_material_marca(NEW.nr_seq_marca, NEW.cd_material),1,30);
	end if;

	if (NEW.ie_sistema_origem = 'SGH') and (NEW.cd_centro_custo <> OLD.cd_centro_custo) and (OLD.dt_atualizacao between LOCALTIMESTAMP - interval '432 seconds' and LOCALTIMESTAMP) then
		NEW.cd_centro_custo := OLD.cd_centro_custo;
	end if;
	
	
end if;
		

if (OLD.qt_material <> NEW.qt_material) then

	select	coalesce(max(nr_seq_reg_lic_compra),0),
		coalesce(max(nr_seq_licitacao),0)
	into STRICT	nr_seq_reg_lic_compra_w,
		nr_seq_licitacao_w
	from	ordem_compra
	where	nr_ordem_compra = NEW.nr_ordem_compra;
	
	if (nr_seq_licitacao_w > 0) and (nr_seq_reg_lic_compra_w > 0) and (coalesce(NEW.nr_seq_reg_lic_item,0) > 0) then
	
		select	coalesce(max(nr_solic_compra),0),
			coalesce(max(nr_item_solic_compra),0)
		into STRICT	nr_solic_compra_w,
			nr_item_solic_compra_w
		from	reg_lic_compra_item
		where	nr_seq_reg_lic_compra = nr_seq_reg_lic_compra_w
		and	nr_seq_lic_item = NEW.nr_seq_reg_lic_item
		and	nr_seq_licitacao = nr_seq_licitacao_w;
		
		/*UPDATE DA SOLICITACAO DE COMPRAS*/


		if (nr_solic_compra_w > 0) and (nr_item_solic_compra_w > 0) then
	
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_sequencia_w
			from	reg_lic_item_solic
			where	nr_solic_compra = nr_solic_compra_w
			and	nr_item_solic_compra = nr_item_solic_compra_w
			and	nr_seq_licitacao = nr_seq_licitacao_w;
			
			if (nr_sequencia_w > 0) then
				update	reg_lic_item_solic
				set	qt_item = NEW.qt_material
				where	nr_sequencia = nr_sequencia_w;			
			end if;
			
			select	coalesce(qt_material,0)
			into STRICT	qt_mat_solicitacao_w
			from	solic_compra_item
			where	nr_solic_compra = nr_solic_compra_w
			and	nr_item_solic_compra = nr_item_solic_compra_w;
			
			qt_diferenca_w 	:= OLD.qt_material - NEW.qt_material;
			qt_alterada_w	:= qt_mat_solicitacao_w - qt_diferenca_w;
			
			update	solic_compra_item
			set	qt_material = qt_alterada_w
			where	nr_solic_compra = nr_solic_compra_w
			and	nr_item_solic_compra = nr_item_solic_compra_w;
			
			update	solic_compra_item_entrega
			set	qt_entrega_solicitada = qt_alterada_w
			where	nr_solic_compra = nr_solic_compra_w
			and	nr_item_solic_compra = nr_item_solic_compra_w;
		
			/*Foi alterado a quantidade do material #@CD_MATERIAL#@, pois foi alterado a quantidade do item na ordem de compra (#@NR_ORDEM_COMPRA#@) gerada pelo registro de precos (#@NR_SEQ_REG_LIC_COMPRA#@).
			Qt. Original: #@QT_MATERIAL_SOLIC#@ Qt. Atual: #@QT_MATERI*/

				
			CALL gerar_hist_solic_sem_commit(
				nr_solic_compra_w,
				/*'Alteracao na quantidade do material #@CD_MATERIAL#@*/


				wheb_mensagem_pck.get_texto(306365, 'CD_MATERIAL=' || NEW.cd_material),							
				substr(wheb_mensagem_pck.get_texto(306367,
					'CD_MATERIAL=' || NEW.cd_material ||
					';NR_ORDEM_COMPRA=' || NEW.nr_ordem_compra ||
					';NR_SEQ_REG_LIC_COMPRA=' || nr_seq_reg_lic_compra_w ||
					';QT_MATERIAL_SOLIC=' || campo_mascara_virgula(qt_mat_solicitacao_w) || 
					';QT_MATERIAL_ALTERADO=' || campo_mascara_virgula(qt_alterada_w)),1,255),
				'Q',
				NEW.nm_usuario);
		end if;
		/* FIM DO UPDATE DA SOLICITACAO DE COMPRAS*/


		
		/*UPDATE NO REGISTRO DE COMPRA*/


		update	reg_lic_compra_item
		set	qt_material = NEW.qt_material
		where	nr_seq_reg_lic_compra = nr_seq_reg_lic_compra_w
		and	nr_seq_lic_item = NEW.nr_seq_reg_lic_item
		and	nr_seq_licitacao = nr_seq_licitacao_w;
		
		/*FIM DO UPDATE DO REGISTRO DE COMPRA*/


	end if;
end if;

select	max(ie_frete),
		max(vl_frete)
into STRICT	ie_frete_w,
		vl_frete_w
from	ordem_compra
where	nr_ordem_compra = NEW.nr_ordem_compra;

if (ie_frete_w = 'F') and (vl_frete_w > 0) then
	BEGIN
	qt_itens_oc_w := obter_inf_itens_oc(NEW.nr_ordem_compra, null, null);
	
	if (TG_OP = 'INSERT') then
		qt_itens_oc_w := qt_itens_oc_w + 1;
	end if;	
	
	BEGIN
		vl_frete_rateado_w := vl_frete_w / qt_itens_oc_w;
	exception
	when others then
		vl_frete_rateado_w := vl_frete_w / 1;
	end;
	
	open c02;
	loop
	fetch c02 into
		nr_ordem_compra_w,
		nr_item_oci_w,
		cd_tributo_w,
		pr_tributo_w,
		qt_material_w,
		vl_unitario_material_w,
		vl_desconto_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		BEGIN
		select	coalesce(ie_desc_nf,'N')
		into STRICT	ie_desc_nf_w
		from	tributo
		where	cd_tributo = cd_tributo_w;
		
		if (ie_desc_nf_w = 'S') then
			vl_tributo_w	:= (pr_tributo_w / 100) * ((qt_material_w * vl_unitario_material_w) - vl_desconto_w + vl_frete_rateado_w);
		else
			vl_tributo_w	:= (pr_tributo_w / 100) * ((qt_material_w * vl_unitario_material_w) + vl_frete_rateado_w);
		end if;
				
		if (vl_tributo_w is not null) then
			update	ordem_compra_item_trib
			set		vl_tributo = vl_tributo_w
			where	nr_ordem_compra = nr_ordem_compra_w
			and		nr_item_oci = nr_item_oci_w
			and		cd_tributo = cd_tributo_w;	
		end if;
		end;
	end loop;
	close c02;
	end;
end if;

--OS 1296310

--:new.vl_total_item := :new.vl_unitario_material * :new.qt_material;


<<Final>>

qt_reg_w	:= 0;

  END;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_ordem_compra_item_atual() FROM PUBLIC;

CREATE TRIGGER ordem_compra_item_atual
	BEFORE INSERT OR UPDATE ON ordem_compra_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_ordem_compra_item_atual();

