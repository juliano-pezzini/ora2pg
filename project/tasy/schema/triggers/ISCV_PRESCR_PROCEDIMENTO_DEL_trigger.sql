-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS iscv_prescr_procedimento_del ON prescr_procedimento CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_iscv_prescr_procedimento_del() RETURNS trigger AS $BODY$
declare
ie_proc_integra_w	varchar(10);
ds_sep_bv_w			varchar(100)	:= obter_separador_bv;
cd_pessoa_fisica_w	atendimento_paciente.cd_pessoa_fisica%type;
nr_atendimento_w	atendimento_paciente.nr_atendimento%type;

function permiteIntegrarISCV
return boolean is
qt_resultado_w	bigint;
BEGIN

select	count(*) qt_resultado
into STRICT	qt_resultado_w
from 	regra_proc_interno_integra
where	ie_tipo_integracao = 17; --Dominio criado para a integração
return qt_resultado_w > 0;
end;


BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'S') and (permiteIntegrarISCV()) and
	((OLD.cd_funcao_origem = 900) or (OLD.cd_funcao_origem = 872)) then
	ie_proc_integra_w := Obter_Se_Integr_Proc_Interno(OLD.nr_seq_proc_interno, 17,null,OLD.ie_lado,wheb_usuario_pck.get_cd_estabelecimento);
	if (ie_proc_integra_w = 'S') and (OLD.nr_acesso_dicom is not null) then
		select	max(a.cd_pessoa_fisica),
				max(a.nr_atendimento)
		into STRICT	cd_pessoa_fisica_w,
				nr_atendimento_w
		from	atendimento_paciente a,
				prescr_medica b
		where	a.nr_atendimento = b.nr_atendimento
		and		b.nr_prescricao = OLD.nr_prescricao;

		CALL gravar_agend_integracao(749,'cd_pessoa_fisica='	|| cd_pessoa_fisica_w	|| ds_sep_bv_w ||
											'nr_atendimento='	|| nr_atendimento_w		|| ds_sep_bv_w ||
											'nr_prescricao='	|| OLD.nr_prescricao		|| ds_sep_bv_w ||
											'nr_acesso_dicom='	|| OLD.nr_acesso_dicom		|| ds_sep_bv_w ||
											'order_control=OC'	|| ds_sep_bv_w				||
											'order_status=CA'	|| ds_sep_bv_w
											, OLD.cd_setor_atendimento);
	end if;
end if;

RETURN OLD;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_iscv_prescr_procedimento_del() FROM PUBLIC;

CREATE TRIGGER iscv_prescr_procedimento_del
	AFTER DELETE ON prescr_procedimento FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_iscv_prescr_procedimento_del();

