-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS motion_agenda_paciente_aft_upt ON agenda_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_motion_agenda_paciente_aft_upt() RETURNS trigger AS $BODY$
declare
reg_integracao_p	gerar_int_padrao.reg_integracao;

C01 CURSOR FOR
	SELECT	cd_externo
	from 	agenda_paciente_proc
	where	nr_sequencia = NEW.nr_sequencia
	and		cd_externo is not null
	order	by dt_atualizacao;

c01_w				c01%rowtype;

BEGIN
if (NEW.cd_agendamento_Externo is not null) then
	if	(NEW.nr_atendimento is not null AND OLD.nr_atendimento is null) then
		reg_integracao_p := gerar_int_padrao.gravar_integracao('116', NEW.CD_AGENDAMENTO_EXTERNO, NEW.nm_usuario, reg_integracao_p, 'IE_STATUS=S');
		open C01;
		loop
		fetch C01 into c01_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			reg_integracao_p := gerar_int_padrao.gravar_integracao('116', c01_w.cd_externo, NEW.nm_usuario, reg_integracao_p, 'IE_STATUS=S');
		end loop;
		close C01;
	elsif ((NEW.nr_atendimento is null ) and (NEW.ie_status_agenda in ('I', 'F') and (OLD.ie_status_agenda not in ('I', 'F') ) )) then
		reg_integracao_p := gerar_int_padrao.gravar_integracao('116', NEW.CD_AGENDAMENTO_EXTERNO, NEW.nm_usuario, reg_integracao_p, 'IE_STATUS=N');
		open C01;
		loop
		fetch C01 into c01_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			reg_integracao_p := gerar_int_padrao.gravar_integracao('116', c01_w.cd_externo, NEW.nm_usuario, reg_integracao_p, 'IE_STATUS=N');
		end loop;
		close C01;
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_motion_agenda_paciente_aft_upt() FROM PUBLIC;

CREATE TRIGGER motion_agenda_paciente_aft_upt
	AFTER UPDATE ON agenda_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_motion_agenda_paciente_aft_upt();

