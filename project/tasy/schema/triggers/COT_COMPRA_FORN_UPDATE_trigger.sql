-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS cot_compra_forn_update ON cot_compra_forn CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_cot_compra_forn_update() RETURNS trigger AS $BODY$
DECLARE
qt_registro_w		integer;
qt_reg_w	smallint;
BEGIN 
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N') then 
	goto Final;
end if;
select	count(*) 
into STRICT	qt_registro_w 
from	cot_compra_forn_item 
where	nr_seq_cot_forn = NEW.nr_sequencia;
 
if (qt_registro_w > 0) and (NEW.cd_cgc_fornecedor <> OLD.cd_cgc_fornecedor) then 
	update	cot_compra_forn_item 
	set	cd_cgc_fornecedor = NEW.cd_cgc_fornecedor 
	where	nr_seq_cot_forn = NEW.nr_sequencia;
end if;
 
if (NEW.ie_status <> OLD.ie_status) and (NEW.ie_status in ('FF','FH')) then 
	CALL confirmar_cotacao_eletronica(NEW.nr_cot_compra,NEW.nr_sequencia);
end if;
<<Final>> 
qt_reg_w	:= 0;
 
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_cot_compra_forn_update() FROM PUBLIC;

CREATE TRIGGER cot_compra_forn_update
	BEFORE UPDATE ON cot_compra_forn FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_cot_compra_forn_update();

