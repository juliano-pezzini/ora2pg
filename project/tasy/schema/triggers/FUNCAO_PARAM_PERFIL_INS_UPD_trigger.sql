-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS funcao_param_perfil_ins_upd ON funcao_param_perfil CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_funcao_param_perfil_ins_upd() RETURNS trigger AS $BODY$
declare

ie_protocolo_vig_w	varchar(1);

C01 CURSOR FOR
	SELECT 	distinct
			nr_seq_protocolo
	from   	concorde_perfil
	where  	cd_perfil = NEW.cd_perfil
	order by 1;

c01_w				C01%rowtype;

BEGIN

if (OLD.vl_parametro is null) and (NEW.vl_parametro is not null) or (NEW.vl_parametro <> OLD.vl_parametro) then
	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		BEGIN
			select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT   	ie_protocolo_vig_w
			from	concorde_protocolo
			where   nr_sequencia = c01_w.nr_seq_protocolo
			and		LOCALTIMESTAMP between dt_inicio_vigencia and dt_fim_vigencia;

			if (ie_protocolo_vig_w = 'S') then
				update 	concorde_protocolo
				set		dt_alteracao = LOCALTIMESTAMP,
						dt_atualizacao = LOCALTIMESTAMP,
						nm_usuario = NEW.nm_usuario
				where 	nr_sequencia = c01_w.nr_seq_protocolo;

				update 	perfil
				set		dt_alteracao = LOCALTIMESTAMP,
						dt_atualizacao = LOCALTIMESTAMP,
						nm_usuario = NEW.nm_usuario
				where 	cd_perfil = NEW.cd_perfil;
			end if;
		end;
	end loop;
	close C01;
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_funcao_param_perfil_ins_upd() FROM PUBLIC;

CREATE TRIGGER funcao_param_perfil_ins_upd
	BEFORE INSERT OR UPDATE ON funcao_param_perfil FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_funcao_param_perfil_ins_upd();

