-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS long_running_proc_param_atual ON long_running_process_param CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_long_running_proc_param_atual() RETURNS trigger AS $BODY$
DECLARE
  PRAGMA AUTONOMOUS_TRANSACTION;

  ds_funcao_l       FUNCAO.DS_FUNCAO%TYPE;
  nm_server_class_l LONG_RUNNING_PROCESS_ITEM.NM_SERVER_CLASS%TYPE;
  nm_method_l       LONG_RUNNING_PROCESS_ITEM.NM_METHOD%TYPE;

  duplicated_item_c CURSOR(
    nr_seq_lrp_item_p  LONG_RUNNING_PROCESS_PARAM.NR_SEQ_LRP_ITEM%TYPE
  , nm_key_p           LONG_RUNNING_PROCESS_PARAM.NM_KEY%TYPE
  , ds_value_p         LONG_RUNNING_PROCESS_PARAM.DS_VALUE%TYPE
  ) FOR
    SELECT f.ds_funcao
         , lrpi.nm_server_class
         , lrpi.nm_method
      FROM long_running_process_param lrpp
         , long_running_process_item  lrpi
         , long_running_process       lrp
         , long_running_process_item  lrpi2
         , funcao                     f
     WHERE lrpp.nr_seq_lrp_item = lrpi.nr_sequencia
       AND lrpi.nr_seq_lrp      = lrp.nr_sequencia
       AND lrpi.nm_server_class = lrpi2.nm_server_class
       AND lrpi.nm_method       = lrpi2.nm_method
       AND lrp.nr_seq_funcao    = f.cd_funcao
       AND lrpi.ie_situacao     = 'A'
       AND lrp.dt_liberacao    <= LOCALTIMESTAMP
       AND lrpi2.nr_sequencia   = nr_seq_lrp_item_p
       AND lrpp.nm_key          = nm_key_p
       AND lrpp.ds_value        = ds_value_p
     GROUP BY f.ds_funcao
            , lrpi.nm_server_class
            , lrpi.nm_method
     HAVING COUNT(1) > 0;

BEGIN

    IF wheb_usuario_pck.get_ie_executar_trigger = 'S' THEN
        OPEN duplicated_item_c(NEW.nr_seq_lrp_item, NEW.nm_key, NEW.ds_value);
            FETCH duplicated_item_c INTO ds_funcao_l, nm_server_class_l, nm_method_l;
            IF duplicated_item_c%FOUND THEN
                CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort('ERROR: Duplicated process item identification in the Tasy function "'
||
                ds_funcao_l ||'" for class "'||nm_server_class_l||'" and method "'||nm_method_l||'"');
            END IF;
        CLOSE duplicated_item_c;
    END IF;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_long_running_proc_param_atual() FROM PUBLIC;

CREATE TRIGGER long_running_proc_param_atual
	BEFORE INSERT OR UPDATE ON long_running_process_param FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_long_running_proc_param_atual();

