-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pat_conta_contabil_atual ON pat_conta_contabil CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pat_conta_contabil_atual() RETURNS trigger AS $BODY$
declare

cd_estabelecimento_w	smallint;
cd_empresa_w			smallint;
ie_conta_vigente_w		varchar(1);

ds_ajuste_pat_w		varchar(100);
ds_baixa_w			varchar(100);
ds_cap_social_w		varchar(100);
ds_contabil_w		varchar(100);
ds_deprec_acum_w	varchar(100);
ds_deprec_res_w		varchar(100);
ds_entrada_aval_w	varchar(100);
BEGIN
  BEGIN
ds_ajuste_pat_w		:= substr(wheb_mensagem_pck.get_texto(351019,''),1, 100);
ds_baixa_w			:= substr(wheb_mensagem_pck.get_texto(351026,''),1, 100);
ds_cap_social_w		:= substr(wheb_mensagem_pck.get_texto(351027,''),1, 100);
ds_contabil_w		:= substr(wheb_mensagem_pck.get_texto(351029,''),1, 100);
ds_deprec_acum_w	:= substr(wheb_mensagem_pck.get_texto(351030,''),1, 100);
ds_deprec_res_w		:= substr(wheb_mensagem_pck.get_texto(351031,''),1, 100);
ds_entrada_aval_w	:= substr(wheb_mensagem_pck.get_texto(351032,''),1, 100);


if (NEW.cd_empresa is null) then
	BEGIN
	cd_estabelecimento_w	:= coalesce(NEW.cd_estabelecimento, wheb_usuario_pck.get_cd_estabelecimento);

	BEGIN
	select	cd_empresa
	into STRICT	cd_empresa_w
	from	estabelecimento
	where	cd_estabelecimento = cd_estabelecimento_w;
	exception when others then
		cd_empresa_w	:= null;
	end;

	NEW.cd_empresa	:= cd_empresa_w;
	end;
end if;

CALL CTB_Consistir_Conta_Titulo(NEW.cd_conta_ajuste_pat, ds_ajuste_pat_w);
CALL CTB_Consistir_Conta_Titulo(NEW.cd_conta_baixa, ds_baixa_w);
CALL CTB_Consistir_Conta_Titulo(NEW.cd_conta_cap_social, ds_cap_social_w);
CALL CTB_Consistir_Conta_Titulo(NEW.cd_conta_contabil, ds_contabil_w);
CALL CTB_Consistir_Conta_Titulo(NEW.cd_conta_deprec_acum, ds_deprec_acum_w);
CALL CTB_Consistir_Conta_Titulo(NEW.cd_conta_deprec_res, ds_deprec_res_w);
CALL CTB_Consistir_Conta_Titulo(NEW.cd_conta_entrada_aval, ds_entrada_aval_w);

select	substr(obter_se_conta_vigente(NEW.cd_conta_contabil, NEW.dt_vigencia),1,1)
into STRICT	ie_conta_vigente_w
;
if (ie_conta_vigente_w = 'N') then
	/* 'A conta contábil informada está fora da data de vigência.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(232821,'CD_CONTA_CONTABIL_W=' || NEW.cd_conta_contabil);

end if;

select	substr(obter_se_conta_vigente(NEW.cd_conta_deprec_acum, NEW.dt_vigencia),1,1)
into STRICT	ie_conta_vigente_w
;
if (ie_conta_vigente_w = 'N') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266465);
	/*A conta de deprec. acumulada está fora da data de vigência.');*/

end if;

select	substr(obter_se_conta_vigente(NEW.cd_conta_deprec_res, NEW.dt_vigencia),1,1)
into STRICT	ie_conta_vigente_w
;
if (ie_conta_vigente_w = 'N') then
	/*A conta de deprec. resultado está fora da data de vigência.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(266466);
end if;

select	substr(obter_se_conta_vigente(NEW.cd_conta_baixa, NEW.dt_vigencia),1,1)
into STRICT	ie_conta_vigente_w
;
if (ie_conta_vigente_w = 'N') then
	/*A conta contábil de baixa está fora da data de vigência.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(266467);
end if;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pat_conta_contabil_atual() FROM PUBLIC;

CREATE TRIGGER pat_conta_contabil_atual
	BEFORE INSERT OR UPDATE ON pat_conta_contabil FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pat_conta_contabil_atual();

