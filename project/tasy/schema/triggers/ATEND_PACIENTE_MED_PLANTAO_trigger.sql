-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_paciente_med_plantao ON atendimento_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_paciente_med_plantao() RETURNS trigger AS $BODY$
declare

ie_altera_fila_w		bigint;
ie_altera_fila_ww		smallint;
ie_altera_fila_www		bigint;
qt_max_atend_w			bigint := 0;
qt_max_novo_atend_w		bigint := 0;

BEGIN
if (NEW.ie_tipo_convenio <> 1) then			
	select 	coalesce(max(a.qt_atendimento), 0)
	into STRICT	qt_max_atend_w
	from	eup_cad_plantao_medico a, 			
			TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 	= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica	
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss') 					
	AND 	a.ie_intervalo 			= 'N';
	
	select 	coalesce(max(1), 0)
	into STRICT	ie_altera_fila_www
	from	eup_cad_plantao_medico a, 			
			TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 	= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica			
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss')		
	and	a.qt_atendimento < qt_max_atend_w-1
	AND 	a.ie_intervalo 			= 'N';
	
	if (ie_altera_fila_www = 1) then
	
		update 	eup_cad_plantao_medico a
		set	ie_novo_medico = 'N'
		where 	1 = 1
		and 	a.cd_estabelecimento 		= NEW.cd_estabelecimento
		and 	a.ie_clinica 			= NEW.ie_clinica						
		and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
		and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
		and exists (SELECT 1 from turno_atendimento c
			where c.nr_sequencia = a.nr_seq_turno 
			and to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss')  LIMIT 1)
		and	a.qt_atendimento >= qt_max_atend_w-1;
	
	end if;		

	select 	coalesce(max(a.qt_atendimento), -1)
	into STRICT	qt_max_novo_atend_w
	from	eup_cad_plantao_medico a, 			
			TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 	= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica			
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss') 			
	and	coalesce(a.IE_NOVO_MEDICO, 'S') = 'N'
	AND 	a.ie_intervalo 			= 'N';	
	
	select 	count(*)
	into STRICT	ie_altera_fila_w
	from	eup_cad_plantao_medico a,
			TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 	= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica			
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)	
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss') 			
	and	coalesce(a.IE_NOVO_MEDICO, 'S') = 'N'
	and	coalesce(a.qt_atendimento, 0) = qt_max_novo_atend_w-1
	AND 	a.ie_intervalo 			= 'N';

	select coalesce(max(1), 0)
	into STRICT	ie_altera_fila_ww
	from	eup_cad_plantao_medico a,
		TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 		= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica
	and	a.cd_medico			= NEW.cd_medico_resp	
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)	
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss') 			
	and	coalesce(a.IE_NOVO_MEDICO, 'S') = 'N';

	select count(*)
	into STRICT	ie_altera_fila_www
	from	eup_cad_plantao_medico a,
		TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 		= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica	
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)	
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss') 			
	and	coalesce(a.qt_atendimento, 0) = 0
	and	coalesce(a.IE_NOVO_MEDICO, 'S') = 'S';		

	if (ie_altera_fila_w = 1 AND ie_altera_fila_ww = 0) or (ie_altera_fila_www > 1) or (qt_max_novo_atend_w = -1) then
		update 	eup_cad_plantao_medico a
		set	a.qt_atendimento 		= coalesce(a.qt_atendimento,0)+1
		where	a.cd_estabelecimento 		= NEW.cd_estabelecimento
		and	a.cd_medico			= NEW.cd_medico_resp
		and 	a.ie_clinica 			= NEW.ie_clinica		
		and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
 		and (a.dt_saida is null OR a.dt_saida > LOCALTIMESTAMP)
		and 	exists (SELECT	1
				from	turno_atendimento c
				where	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss')
				and		c.nr_sequencia = a.nr_seq_turno);
	else		
		if (ie_altera_fila_w > 1) then
			update 	eup_cad_plantao_medico a
			set	a.qt_atendimento 		= coalesce(a.qt_atendimento,0)+1
			where	a.cd_estabelecimento 		= NEW.cd_estabelecimento
			and	a.cd_medico			= NEW.cd_medico_resp
			and 	a.ie_clinica 			= NEW.ie_clinica			
			and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
			and (a.dt_saida is null OR a.dt_saida > LOCALTIMESTAMP)
			and 	exists (SELECT	1
					from	turno_atendimento c
					where	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss')
					and		c.nr_sequencia = a.nr_seq_turno);
		else
			update 	eup_cad_plantao_medico a
			set	a.qt_atendimento 		= 0,
				IE_NOVO_MEDICO			= 'S'
			where	a.cd_estabelecimento 		= NEW.cd_estabelecimento			
			and 	a.ie_clinica 			= NEW.ie_clinica			
			and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
			and (a.dt_saida is null OR a.dt_saida > LOCALTIMESTAMP)
			and 	exists (SELECT	1
					from	turno_atendimento c
					where	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss')
					and		c.nr_sequencia = a.nr_seq_turno);
		end if;
		
	end if;
else
	select 	coalesce(max(a.QT_PARTICULAR_CONTROLE), 0)
	into STRICT	qt_max_atend_w
	from	eup_cad_plantao_medico a, 			
			TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 	= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica			
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss') 					
	AND 	a.ie_intervalo 			= 'N';
	
	select 	coalesce(max(1), 0)
	into STRICT	ie_altera_fila_www
	from	eup_cad_plantao_medico a, 			
			TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 	= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica			
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss')		
	and	a.QT_PARTICULAR_CONTROLE < qt_max_atend_w-1
	AND 	a.ie_intervalo 			= 'N';
	
	if (ie_altera_fila_www = 1) then
	
		update 	eup_cad_plantao_medico a
		set	ie_prioriza_particular = 'N'
		where 	1 = 1
		and 	a.cd_estabelecimento 		= NEW.cd_estabelecimento
		and 	a.ie_clinica 			= NEW.ie_clinica						
		and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
		and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
		and exists (SELECT 1 from turno_atendimento c
			where c.nr_sequencia = a.nr_seq_turno 
			and to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss')  LIMIT 1)
		and	a.QT_PARTICULAR_CONTROLE >= qt_max_atend_w-1;
	
	end if;		

	select 	coalesce(max(a.QT_PARTICULAR_CONTROLE), -1)
	into STRICT	qt_max_novo_atend_w
	from	eup_cad_plantao_medico a, 			
			TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 	= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica			
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss') 			
	and	coalesce(a.ie_prioriza_particular, 'S') = 'N'
	AND 	a.ie_intervalo 			= 'N';	
	
	select 	count(*)
	into STRICT	ie_altera_fila_w
	from	eup_cad_plantao_medico a,
			TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 	= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica			
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)	
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss') 			
	and	coalesce(a.ie_prioriza_particular, 'S') = 'N'
	and	coalesce(a.QT_PARTICULAR_CONTROLE, 0) = qt_max_novo_atend_w-1
	AND 	a.ie_intervalo 			= 'N';

	select coalesce(max(1), 0)
	into STRICT	ie_altera_fila_ww
	from	eup_cad_plantao_medico a,
		TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 		= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica
	and	a.cd_medico			= NEW.cd_medico_resp	
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)	
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss') 			
	and	coalesce(a.ie_prioriza_particular, 'S') = 'N';		

	select count(*)
	into STRICT	ie_altera_fila_www
	from	eup_cad_plantao_medico a,
		TURNO_ATENDIMENTO c
	where 	1 = 1	
	and 	a.cd_estabelecimento 		= NEW.cd_estabelecimento
	and 	a.ie_clinica 			= NEW.ie_clinica	
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)	
	and (a.dt_saida is null    OR a.dt_saida > LOCALTIMESTAMP)	
	and     c.nr_sequencia 			= a.nr_seq_turno
	and 	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss') 			
	and	coalesce(a.QT_PARTICULAR_CONTROLE, 0) = 0
	and	coalesce(a.ie_prioriza_particular, 'S') = 'S';	
	
	if (ie_altera_fila_w = 1 AND ie_altera_fila_ww = 0) or (ie_altera_fila_www > 1) or (qt_max_novo_atend_w = -1) then
		update 	eup_cad_plantao_medico a
		set	a.QT_PARTICULAR_CONTROLE 		= coalesce(a.QT_PARTICULAR_CONTROLE,0)+1,
			a.qt_atend_particular			= coalesce(a.qt_atend_particular, 0)+1
		where	a.cd_estabelecimento 		= NEW.cd_estabelecimento
		and	a.cd_medico			= NEW.cd_medico_resp
		and 	a.ie_clinica 			= NEW.ie_clinica		
		and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
		and (a.dt_saida is null OR a.dt_saida > LOCALTIMESTAMP)
		and 	exists (SELECT	1
				from	turno_atendimento c
				where	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss')
				and		c.nr_sequencia = a.nr_seq_turno);
	else		
		if (ie_altera_fila_w > 1) then
			update 	eup_cad_plantao_medico a
			set	a.QT_PARTICULAR_CONTROLE 		= coalesce(a.QT_PARTICULAR_CONTROLE,0)+1,
				a.qt_atend_particular			= coalesce(a.qt_atend_particular, 0)+1
			where	a.cd_estabelecimento 		= NEW.cd_estabelecimento
			and	a.cd_medico			= NEW.cd_medico_resp
			and 	a.ie_clinica 			= NEW.ie_clinica			
			and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
			and (a.dt_saida is null OR a.dt_saida > LOCALTIMESTAMP)
			and 	exists (SELECT	1
					from	turno_atendimento c
					where	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss')
					and		c.nr_sequencia = a.nr_seq_turno);
		else
			update 	eup_cad_plantao_medico a
			set	a.QT_PARTICULAR_CONTROLE 		= 0,
				ie_prioriza_particular			= 'S'				
			where	a.cd_estabelecimento 		= NEW.cd_estabelecimento			
			and 	a.ie_clinica 			= NEW.ie_clinica			
			and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
			and (a.dt_saida is null OR a.dt_saida > LOCALTIMESTAMP)
			and 	exists (SELECT	1
					from	turno_atendimento c
					where	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss')
					and		c.nr_sequencia = a.nr_seq_turno);
			
			update 	eup_cad_plantao_medico a
			set	a.qt_atend_particular			= coalesce(a.qt_atend_particular, 0)+1
			where	a.cd_estabelecimento 		= NEW.cd_estabelecimento
			and	a.cd_medico			= NEW.cd_medico_resp
			and 	a.ie_clinica 			= NEW.ie_clinica			
			and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_entrada) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(LOCALTIMESTAMP)
			and (a.dt_saida is null OR a.dt_saida > LOCALTIMESTAMP)
			and 	exists (SELECT	1
					from	turno_atendimento c
					where	to_char(a.dt_entrada, 'hh24:mi:ss') between to_char(c.dt_inicial, 'hh24:mi:ss') and to_char(c.dt_final, 'hh24:mi:ss')
					and		c.nr_sequencia = a.nr_seq_turno);
		end if;		
		
	end if;		
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_paciente_med_plantao() FROM PUBLIC;

CREATE TRIGGER atend_paciente_med_plantao
	AFTER INSERT ON atendimento_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_paciente_med_plantao();

