-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS laudo_paciente_insert_hl7 ON laudo_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_laudo_paciente_insert_hl7() RETURNS trigger AS $BODY$
declare
ds_sep_bv_w		varchar(100);
ds_param_integ_hl7_w	varchar(4000);
 
cd_pessoa_fisica_w	varchar(60);
nr_seq_interno_w	bigint;
nr_seq_superior_w	bigint;
nr_seq_prescricao_w	bigint;
nr_seq_proc_interno_w	bigint;
 
 
ie_status_result_w	varchar(2);
ie_permite_proc_mdc_w	varchar(2);
ie_permite_proc_isite_w varchar(2);
 
BEGIN 
 
if (NEW.nr_prescricao is not null) then 
	 
	select	max(cd_pessoa_fisica) 
	into STRICT	cd_pessoa_fisica_w 
	from	prescr_medica 
	where	nr_prescricao 	= NEW.nr_prescricao;
	 
	select	max(obter_atepacu_paciente( NEW.nr_atendimento ,'A')) 
	into STRICT	nr_seq_interno_w 
	;
	 
	select	max(nr_sequencia_prescricao), 
		max(nr_seq_proc_interno) 
	into STRICT	nr_seq_prescricao_w, 
		nr_seq_proc_interno_w 
	from	procedimento_paciente 
	where	nr_sequencia	= NEW.nr_seq_proc;
	 
	select 	max(permite_proc_interno_integ(x.nr_seq_proc_interno,11)) 
	into STRICT	ie_permite_proc_mdc_w 
	from 	procedimento_paciente x 
	where	x.nr_prescricao = NEW.nr_prescricao 
	and	x.nr_sequencia_prescricao = nr_seq_prescricao_w;
	 
	/* 
	select	obter_integracao_proc_interno(null, null, nr_seq_proc_interno_w, 2) 
	into	ie_permite_proc_isite_w 
	from	dual; 
	*/
 
	 
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
	into STRICT	ie_permite_proc_isite_w 
	from	regra_proc_interno_integra 
	where	nr_seq_proc_interno	= nr_seq_proc_interno_w 
	and	ie_tipo_integracao	= 2 
	and	cd_integracao 		is not null;
	 
	 
	ds_sep_bv_w := obter_separador_bv;
	 
	if (NEW.nr_seq_superior is null) then	 
		ie_status_result_w := 'P';
	else 
		ie_status_result_w := 'C';
	end if;
	 
	if (ie_permite_proc_mdc_w = 'S') then --or (ie_permite_proc_isite_w = 'S') then --OS481347 09/08/2012 tbschulz - removido pois HSVP informou que ao salvar não deve ser enviado, somente na primeira aprovação 
 
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || cd_pessoa_fisica_w || ds_sep_bv_w || 
					'nr_atendimento='  || NEW.nr_atendimento || ds_sep_bv_w || 
					'nr_seq_interno='  || nr_seq_interno_w  || ds_sep_bv_w || 
					'nr_prescricao='  || NEW.nr_prescricao || ds_sep_bv_w || 
					'nr_seq_prescr='  || nr_seq_prescricao_w || ds_sep_bv_w ||	 
					'nr_seq_laudo='   || NEW.nr_sequencia  || ds_sep_bv_w || 
					'ie_status_result=' || ie_status_result_w || ds_sep_bv_w;
			 
		CALL gravar_agend_integracao(24, ds_param_integ_hl7_w);
 
	end if;
 
	 
end if;
 
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_laudo_paciente_insert_hl7() FROM PUBLIC;

CREATE TRIGGER laudo_paciente_insert_hl7
	AFTER INSERT ON laudo_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_laudo_paciente_insert_hl7();

