-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS parametro_compras_update ON parametro_compras CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_parametro_compras_update() RETURNS trigger AS $BODY$
declare

nr_seq_contrato_w	bigint;
qt_registros_w		integer;
nm_usuario_lib_w	varchar(15);

c01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	contrato a
	where	a.ie_classificacao not in ('AD','ER')
	order by 1;

BEGIN

if (NEW.ie_atualiza_resp_contrato = 'S') and (NEW.cd_responsavel_contratos <> OLD.cd_responsavel_contratos) then

	select	obter_usuario_pf(NEW.cd_responsavel_contratos)
	into STRICT	nm_usuario_lib_w
	;

	nr_seq_contrato_w := 0;
	open c01;
	loop
	fetch c01 into
		nr_seq_contrato_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		BEGIN

		select	count(*)
		into STRICT	qt_registros_w
		from	contrato_usuario_lib
		where	nr_seq_contrato = nr_seq_contrato_w
		and	nm_usuario_lib = nm_usuario_lib_w;

		if	qt_registros_w > 0 then
			update	contrato_usuario_lib
			set	dt_atualizacao = LOCALTIMESTAMP,
				nm_usuario = nm_usuario_lib_w,
				ie_aviso_vencimento  = 'A',
				ie_aviso_revisao = 'A',
				ie_permite = 'S'
			where	nr_seq_contrato = nr_seq_contrato_w
			and	nm_usuario_lib = nm_usuario_lib_w;

		else
			insert into contrato_usuario_lib(
				nr_seq_contrato,
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nm_usuario_lib,
				ie_aviso_vencimento,
				ie_aviso_revisao,
				ie_permite)
			values (	nr_seq_contrato_w,
				nextval('contrato_usuario_lib_seq'),
				LOCALTIMESTAMP,
				nm_usuario_lib_w,
				nm_usuario_lib_w,
				'A',
				'A',
				'S');
		end if;
		end;
	end loop;
	close c01;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_parametro_compras_update() FROM PUBLIC;

CREATE TRIGGER parametro_compras_update
	BEFORE UPDATE ON parametro_compras FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_parametro_compras_update();

