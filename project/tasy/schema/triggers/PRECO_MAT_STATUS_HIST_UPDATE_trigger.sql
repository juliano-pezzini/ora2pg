-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS preco_mat_status_hist_update ON preco_mat_status_hist CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_preco_mat_status_hist_update() RETURNS trigger AS $BODY$
declare
cd_tab_mat_atualizacao_w	smallint;
BEGIN

if (NEW.IE_STATUS_ITEM = 1) then

	select	coalesce(max(cd_tab_mat_atualizacao),0)
	into STRICT	cd_tab_mat_atualizacao_w
	from	convenio_preco_mat
	where	cd_tab_preco_mat = NEW.cd_tab_preco_mat;

	if (cd_tab_mat_atualizacao_w > 0) then
		update	preco_material a
		set	ie_preco_venda = 'N'
		where	a.cd_tab_preco_mat		= cd_tab_mat_atualizacao_w
		and	a.cd_material        		= NEW.cd_material
		and	a.dt_inicio_vigencia		< NEW.dt_vigencia
		and	a.vl_preco_venda		< coalesce(NEW.vl_material,0);
	end if;
end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_preco_mat_status_hist_update() FROM PUBLIC;

CREATE TRIGGER preco_mat_status_hist_update
	BEFORE UPDATE ON preco_mat_status_hist FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_preco_mat_status_hist_update();

