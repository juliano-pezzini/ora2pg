-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS alteracao_valor_insert ON alteracao_valor CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_alteracao_valor_insert() RETURNS trigger AS $BODY$
DECLARE

cd_estabelecimento_w  integer;
cd_convenio_w   integer;
ie_processo_camara_w  pls_parametros_camara.ie_processo_camara%type;
nr_titulo_receber_w   pls_titulo_lote_camara.nr_titulo_receber%type;
nr_seq_lote_w    pls_titulo_lote_camara.nr_sequencia%type;
dt_hora_w		timestamp;
BEGIN
  BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
select max(cd_estabelecimento),
 obter_convenio_tit_rec(max(nr_titulo))
into STRICT cd_estabelecimento_w,
 cd_convenio_w
from titulo_receber
where nr_titulo = NEW.nr_titulo;

	/* Projeto Davita  - Nao deixa gerar movimento contabil apos fechamento  da data */


	CALL philips_contabil_pck.valida_se_dia_fechado(OBTER_EMPRESA_ESTAB(cd_estabelecimento_w),NEW.DT_ALTERACAO);
	
/*OS 2869560, o delphi nao lanca horas no dt_alteracao. Essa hora  precisa ser lancada devido na rotina gerar_bloqueto_tit_rec verificar se a data da alteracao e apos a ultima via/emissao do boleto para nova geracoa*/


BEGIN
if (to_char(NEW.dt_alteracao,'hh24:mi:ss') = '00:00:00') then
	dt_hora_w := NEW.dt_atualizacao;
	NEW.dt_alteracao := to_date(to_char(NEW.dt_alteracao,'dd/MM/yyyy')||' '||to_char(dt_hora_w,'hh24:mi:ss'), 'dd/MM/yyyy hh24:mi:ss');
end if;
exception
	when data_exception then
		NEW.dt_alteracao := NEW.dt_alteracao;
	when others then
		NEW.dt_alteracao := NEW.dt_alteracao;
end;

if (cd_estabelecimento_w is not null) then

 /*verificar se o titulo que esta recebendo a baixa esta em um lote de camra de compensacao que nao esta baixado.*/


 select count(a.nr_titulo_receber),
   max(b.nr_sequencia)
 into STRICT nr_titulo_receber_w,
   nr_seq_lote_w
 from pls_titulo_lote_camara a,
   pls_lote_camara_comp b
 where a.nr_seq_lote_camara = b.nr_sequencia
 and  a.nr_titulo_receber  = NEW.nr_titulo;

 select max(a.ie_processo_camara)
 into STRICT ie_processo_camara_w
 from pls_parametros_camara a
 where  cd_estabelecimento = cd_estabelecimento_w;

 /*Nao deixar alterar  valor para titulos que estao em lote de camara de compensacao.*/


 if (coalesce(ie_processo_camara_w,'CO') = 'CA') and (nr_titulo_receber_w > 0) then /*se  o processo camara de compensacao for regime de caixa e o titulo estiver na camara*/


   CALL wheb_mensagem_pck.exibir_mensagem_abort(335788, 'NR_SEQ_LOTE_W=' || nr_seq_lote_w ||
         ';NR_TITULO_W=' || NEW.nr_titulo);
 end if;
end if;
end if;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_alteracao_valor_insert() FROM PUBLIC;

CREATE TRIGGER alteracao_valor_insert
	BEFORE INSERT ON alteracao_valor FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_alteracao_valor_insert();

