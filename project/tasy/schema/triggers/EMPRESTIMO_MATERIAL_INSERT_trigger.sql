-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS emprestimo_material_insert ON emprestimo_material CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_emprestimo_material_insert() RETURNS trigger AS $BODY$
declare

dt_mesano_referencia_w	timestamp;
ie_consignado_w		varchar(1);
ie_material_estoque_w	varchar(1);
cd_estabelecimento_w		integer;
cd_local_estoque_w		integer;
qt_reg_saldo_w		integer;
cd_material_w			integer;

BEGIN
if	((TG_OP = 'INSERT') or
	(TG_OP = 'UPDATE' AND NEW.qt_emprestimo <> OLD.qt_emprestimo)) and (NEW.qt_emprestimo <= 0)then
	/*A quantidade informada deve ser maior que zero.*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(283707);
end if;

if (TG_OP = 'UPDATE') and (NEW.qt_emprestimo <> OLD.qt_emprestimo) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(157714); /*Não pode ser alterado a quantidade do material no empréstimo.*/
end if;

if (TG_OP = 'UPDATE') and (NEW.CD_MATERIAL <> OLD.CD_MATERIAL) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(157713); /*Não pode ser alterado o material do empréstimo.*/
end if;

if (coalesce(NEW.ie_atualiza_estoque,'X') <> 'S') then
	NEW.ie_atualiza_estoque	:=	'N';
end if;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	emprestimo
where	nr_emprestimo		= NEW.nr_emprestimo;

select	ie_consignado,
	substr(obter_se_material_estoque(cd_estabelecimento_w, 0, cd_material),1,1),
	cd_material_estoque
into STRICT	ie_consignado_w,
	ie_material_estoque_w,
	cd_material_w
from	material
where	cd_material = NEW.cd_material;

if (ie_material_estoque_w	= 'S') and (ie_consignado_w 		<> '1') then
	BEGIN
	select	cd_local_estoque,
		trunc(dt_emprestimo,'month')
	into STRICT	cd_local_estoque_w,
		dt_mesano_referencia_w
	from	emprestimo
	where	nr_emprestimo		= NEW.nr_emprestimo;
	if (dt_mesano_referencia_w > trunc(LOCALTIMESTAMP,'month')) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265976);
		--'O emprestimo não pode ter data superior que o mes vigente'
	end if;
	select	count(*)
	into STRICT	qt_reg_saldo_w
	from	saldo_estoque
	where	dt_mesano_referencia	= dt_mesano_referencia_w
	and	cd_estabelecimento	= cd_estabelecimento_w
	and	cd_local_estoque	= cd_local_estoque_w
	and	cd_material		= cd_material_w;
	if (qt_reg_saldo_w = 0) then
		insert into saldo_estoque(
			cd_estabelecimento, cd_local_estoque, cd_material,
			dt_mesano_referencia, qt_estoque, vl_estoque,
			qt_reservada_requisicao, qt_reservada, dt_atualizacao,
			nm_usuario, vl_custo_medio, vl_preco_ult_compra,
			dt_ult_compra, ie_status_valorizacao, ie_bloqueio_inventario)
		values (
			cd_estabelecimento_w, cd_local_estoque_w, cd_material_w,
			dt_mesano_referencia_w, 0, 0,
			0, 0, LOCALTIMESTAMP,
			NEW.nm_usuario, 0, 0,
			null, 'N', 'N');
	end if;
	end;
end if;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_emprestimo_material_insert() FROM PUBLIC;

CREATE TRIGGER emprestimo_material_insert
	BEFORE INSERT OR UPDATE ON emprestimo_material FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_emprestimo_material_insert();

