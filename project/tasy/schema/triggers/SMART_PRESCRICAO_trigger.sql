-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS smart_prescricao ON prescr_medica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_smart_prescricao() RETURNS trigger AS $BODY$
declare

reg_integracao_w		gerar_int_padrao.reg_integracao;
qt_medicamento_w        bigint;
qt_recomendacao_w		bigint;
qt_jejum_w				bigint;
qt_glicemia_w			bigint;
qt_procedimento_w 		bigint;
qt_dieta_w				bigint;

BEGIN
	if (OLD.DT_LIBERACAO is null) and (NEW.DT_LIBERACAO is not null) then
		BEGIN	
		reg_integracao_w.cd_estab_documento := wheb_usuario_pck.get_cd_estabelecimento;		
		SELECT (SELECT COUNT(*)
			FROM PRESCR_MATERIAL A
			WHERE A.NR_PRESCRICAO = NEW.NR_PRESCRICAO
				AND A.NR_SEQUENCIA_DIETA IS NULL
				AND A.NR_SEQUENCIA_DILUICAO IS NULL
				AND obter_se_medic_cih(CD_MATERIAL) = 'S'
				AND OBTER_SE_ACM_SN(IE_ACM,IE_SE_NECESSARIO) <> 'S'
				AND A.IE_AGRUPADOR IN (1,4)) qt_medicamento,
			(SELECT COUNT(*)
			FROM PRESCR_RECOMENDACAO A
			WHERE A.NR_PRESCRICAO = NEW.NR_PRESCRICAO
				AND obter_se_envia_recomendacao(NEW.cd_estabelecimento, a.cd_recomendacao) = 'S') qt_recomendacao,
			(SELECT COUNT(*)
			FROM REP_JEJUM A
			WHERE A.NR_PRESCRICAO = NEW.NR_PRESCRICAO) qt_jejum,
			(SELECT COUNT(*)
			FROM PRESCR_PROCEDIMENTO A
			WHERE A.NR_PRESCRICAO = NEW.NR_PRESCRICAO
				AND NR_SEQ_PROT_GLIC IS NOT NULL
				AND OBTER_SE_ACM_SN(IE_ACM,IE_SE_NECESSARIO) <> 'S') qt_glicemia,
			(SELECT COUNT(*)
			FROM PRESCR_PROCEDIMENTO A
			WHERE A.NR_PRESCRICAO = NEW.NR_PRESCRICAO
				AND NR_SEQ_PROT_GLIC  IS NULL
				AND ((Obter_dados_proc_interno(nr_seq_proc_interno,'TU') = 'E')
					OR obter_cod_exame_lab(NR_SEQ_EXAME) IS NOT NULL)) qt_procedimento, 
			(SELECT COUNT(*)
				FROM PRESCR_DIETA  A
				WHERE A.NR_PRESCRICAO = NEW.NR_PRESCRICAO) qt_dieta				   INTO STRICT qt_medicamento_w,
																							qt_recomendacao_w,
																							qt_jejum_w,
																							qt_glicemia_w,
																							qt_procedimento_w, 
																							qt_dieta_w
		;
			
		if (qt_medicamento_w > 0) then --Medicamentos  - 305
			reg_integracao_w := gerar_int_padrao.gravar_integracao('305', NEW.NR_PRESCRICAO, NEW.nm_usuario, reg_integracao_w, 'NR_PRESCRICAO=' || NEW.NR_PRESCRICAO || ';DS_OPERACAO=CREATE');
		end if;
		if (qt_recomendacao_w > 0) then  --Recomendacao - 300
		 reg_integracao_w := gerar_int_padrao.gravar_integracao('300', NEW.NR_PRESCRICAO, NEW.nm_usuario, reg_integracao_w, 'NR_PRESCRICAO=' || NEW.NR_PRESCRICAO || ';DS_OPERACAO=CREATE');
		end if;
		if (qt_procedimento_w > 0 ) then --Procedimento  - 310
			reg_integracao_w := gerar_int_padrao.gravar_integracao('310', NEW.NR_PRESCRICAO, NEW.nm_usuario, reg_integracao_w, 'NR_PRESCRICAO=' || NEW.NR_PRESCRICAO || ';DS_OPERACAO=CREATE');
		end if;
		if (qt_jejum_w > 0) then --Jejun  - 306
			reg_integracao_w := gerar_int_padrao.gravar_integracao('306', NEW.NR_PRESCRICAO, NEW.nm_usuario, reg_integracao_w, 'NR_PRESCRICAO=' || NEW.NR_PRESCRICAO || ';DS_OPERACAO=CREATE');
		end if;
		if (qt_glicemia_w > 0) then --Glicemia  - 328
			reg_integracao_w := gerar_int_padrao.gravar_integracao('328', NEW.NR_PRESCRICAO, NEW.nm_usuario, reg_integracao_w, 'NR_PRESCRICAO=' || NEW.NR_PRESCRICAO || ';DS_OPERACAO=CREATE');
		end if;
		if (qt_dieta_w > 0) then -- Dieta oral  - 320
			reg_integracao_w := gerar_int_padrao.gravar_integracao('320', NEW.NR_PRESCRICAO, NEW.nm_usuario, reg_integracao_w, 'NR_PRESCRICAO=' || NEW.NR_PRESCRICAO || ';DS_OPERACAO=CREATE');
		end if;
	 end;	
	end if;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_smart_prescricao() FROM PUBLIC;

CREATE TRIGGER smart_prescricao
	AFTER INSERT OR UPDATE ON prescr_medica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_smart_prescricao();

