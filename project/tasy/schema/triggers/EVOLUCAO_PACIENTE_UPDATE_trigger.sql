-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS evolucao_paciente_update ON evolucao_paciente CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_evolucao_paciente_update() RETURNS trigger AS $BODY$
DECLARE

dt_entrada_w		timestamp;
dt_alta_w		timestamp;
cd_estabelecimento_w	smallint;
qt_hora_w		double precision;
qt_hora_med_w		double precision;
ie_medico_w		varchar(1);
qt_reg_w	smallint;
ie_evolucao_clinica_alta_w	varchar(10);
qt_hora_retroativa_w	double precision;
BEGIN
  BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger	= 'N')  then
	goto Final;
end if;

BEGIN
	if (OLD.dt_inativacao is null and NEW.dt_inativacao is not null) then
		CALL inativar_registro_template(NEW.nr_seq_ehr_reg, NEW.nm_usuario_inativacao, NEW.ds_justificativa);
	end if;
exception
  when others then
  null;
end;

if (coalesce(NEW.ie_situacao,'A') = coalesce(OLD.ie_situacao,'A')) then
	BEGIN
	select 	coalesce(max('S'),'N')
	into STRICT	ie_medico_w
	from	Medico
	where 	cd_pessoa_fisica	= NEW.cd_medico;

	if (NEW.dt_evolucao > LOCALTIMESTAMP) and (NEW.nr_atendimento is not null) then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(267636);
	end if;
	
	if (NEW.nr_atendimento is not null) then
		select	dt_entrada,
			cd_estabelecimento,
			dt_alta
		into STRICT	dt_entrada_w,
			cd_estabelecimento_w,
			dt_alta_w
		from	atendimento_paciente
		where	nr_atendimento	= NEW.nr_atendimento;
		
		ie_evolucao_clinica_alta_w	:= Obter_Valor_Param_Usuario(281,477,obter_Perfil_Ativo,NEW.nm_usuario,0);
		qt_hora_retroativa_w		:= Obter_Valor_Param_Usuario(281,592,obter_Perfil_Ativo,NEW.nm_usuario,0);

		select	coalesce(max(coalesce((qt_hora_retroativa_w)::numeric ,qt_horas_passado_evo)),-1),
			coalesce(max(qt_horas_passado_evo_med),-1)
		into STRICT	qt_hora_w,
			qt_hora_med_w
		from	parametro_medico
		where	cd_estabelecimento	= cd_estabelecimento_w;

		
		if	((OLD.nr_atendimento) = (NEW.nr_atendimento)) and (qt_hora_w >= 0) and (ie_medico_w = 'N') and
			(NEW.dt_evolucao < (LOCALTIMESTAMP - qt_hora_w/24)) and (coalesce(OLD.nr_seq_assinatura,0) = coalesce(NEW.nr_seq_assinatura,0)) then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(267637,	'QT_HORA_W='||QT_HORA_W);
			
		end if;
		
		
		if	((OLD.nr_atendimento) = (NEW.nr_atendimento)) and (qt_hora_med_w >= 0) and (ie_medico_w = 'S') and
			(NEW.dt_evolucao < (LOCALTIMESTAMP - qt_hora_med_w/24)) and (coalesce(OLD.nr_seq_assinatura,0) = coalesce(NEW.nr_seq_assinatura,0)) then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(267638,	'QT_HORA_MED_W='||QT_HORA_MED_W);
		end if;
		if (OLD.nr_atendimento	is null) and (NEW.nr_atendimento is not null) and (dt_alta_w	is not null) and (ie_evolucao_clinica_alta_w is not null) then
			NEW.ie_evolucao_clinica		:= ie_evolucao_clinica_alta_w;
		end if;
		
		if	(dt_entrada_w > NEW.dt_evolucao AND OLD.nr_atendimento = NEW.nr_atendimento) then
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(267640);
		end if;
	end if;
	end;
end if;
<<Final>>
qt_reg_w	:= 0;


if (OLD.dt_liberacao is not null) and (NEW.dt_liberacao is null) then
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(267641);
end if;

if (NEW.dt_liberacao is not null) and (OLD.dt_liberacao is not null) and (OLD.dt_liberacao	<> NEW.dt_liberacao)and (OLD.nr_atendimento = NEW.nr_atendimento) then
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(267643);
end if;


  END;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_evolucao_paciente_update() FROM PUBLIC;

CREATE TRIGGER evolucao_paciente_update
	BEFORE UPDATE ON evolucao_paciente FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_evolucao_paciente_update();

