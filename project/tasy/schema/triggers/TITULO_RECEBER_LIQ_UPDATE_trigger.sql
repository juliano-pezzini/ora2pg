-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_receber_liq_update ON titulo_receber_liq CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_receber_liq_update() RETURNS trigger AS $BODY$
DECLARE

dt_fechamento_w			timestamp	:= null;
nr_recibo_w			bigint;
ie_origem_baixa_w		varchar(2)	:= '';
nr_seq_banco_w			movto_trans_financ.nr_seq_banco%type;
nr_seq_caixa_w			movto_trans_financ.nr_seq_caixa%type;
qt_tit_pagar_w			bigint;
ie_altera_vl_glosa_w	varchar(1);

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
ie_altera_vl_glosa_w := obter_param_usuario(801, 208, obter_perfil_ativo, NEW.nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_altera_vl_glosa_w);

if (coalesce(ie_altera_vl_glosa_w,'S') = 'N') and (coalesce(OLD.vl_glosa,0) <> coalesce(NEW.vl_glosa,0)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(458443);
end if;

if (OLD.nr_seq_caixa_rec is not null) and (OLD.dt_antecipacao_pls_mens is null) and (coalesce(wheb_usuario_pck.get_ie_lote_contabil,'N') = 'N') and (coalesce(wheb_usuario_pck.get_ie_atualizacao_contabil,'N') = 'N') and (coalesce(OLD.nr_lote_contabil,0) = coalesce(NEW.nr_lote_contabil,0)) and (coalesce(OLD.nr_lote_contab_antecip,0) = coalesce(NEW.nr_lote_contab_antecip,0)) and (coalesce(OLD.nr_lote_contab_pro_rata,0) = coalesce(NEW.nr_lote_contab_pro_rata,0)) and (coalesce(OLD.nr_seq_movto_trans_fin,0) = coalesce(NEW.nr_seq_movto_trans_fin,0)) and (coalesce(OLD.nr_seq_trans_fin,0) = coalesce(NEW.nr_seq_trans_fin,0)) and (coalesce(OLD.nr_adiantamento,0) = coalesce(NEW.nr_adiantamento,0)) and (coalesce(OLD.dt_autenticacao,to_date('01/01/2008','dd/mm/yyyy')) = coalesce(NEW.dt_autenticacao,to_date('01/01/2008','dd/mm/yyyy'))) and (coalesce(OLD.dt_antecipacao_pls_mens,to_date('01/01/2010','dd/mm/yyyy')) =
			coalesce(NEW.dt_antecipacao_pls_mens,to_date('01/01/2010','dd/mm/yyyy'))) and (coalesce(OLD.dt_referencia_pls_mens,to_date('01/01/2010','dd/mm/yyyy')) = 
			coalesce(NEW.dt_referencia_pls_mens,to_date('01/01/2010','dd/mm/yyyy'))) and (OLD.dt_atualizacao <> NEW.dt_atualizacao) then

	select	max(dt_fechamento),
		max(nr_recibo)
	into STRICT	dt_fechamento_w,
		nr_recibo_w
	from	caixa_receb
	where	nr_sequencia	= OLD.nr_seq_caixa_rec;

	if (dt_fechamento_w is not null) then
		/* Nao e possivel excluir a baixa.
		O recibo #@NR_RECIBO#@ ja foi fechado!*/

		CALL wheb_mensagem_pck.exibir_mensagem_abort(267076, 'NR_RECIBO=' || nr_recibo_w);
	end if;
end if;	

/* Controle Bancario e Tesouraria */


select	max(a.nr_seq_banco),
	max(a.nr_seq_caixa)
into STRICT 	nr_seq_banco_w,
	nr_seq_caixa_w
from 	movto_trans_financ a
where 	a.nr_sequencia	= NEW.nr_seq_movto_trans_fin;

if (NEW.dt_recebimento <> OLD.dt_recebimento) then
	/* Projeto Davita  - Nao deixa gerar movimento contabil apos fechamento da data */


	CALL philips_contabil_pck.valida_se_dia_fechado(OBTER_EMPRESA_ESTAB(wheb_usuario_pck.get_cd_estabelecimento),NEW.dt_recebimento);
end if;

/* abatimento */


select	count(*)
into STRICT	qt_tit_pagar_w
from	titulo_pagar_baixa a
where	a.nr_seq_baixa_rec	= NEW.nr_sequencia
and	a.nr_tit_receber	= NEW.nr_titulo;

if (NEW.nr_seq_pls_lote_contest is not null) then
	ie_origem_baixa_w	:= 'CT';
elsif (NEW.nr_seq_liq_origem is not null) then
	ie_origem_baixa_w	:= 'ET';
elsif (coalesce(qt_tit_pagar_w,0)	> 0) then
	ie_origem_baixa_w	:= 'AB';
elsif (NEW.nr_bordero is not null) then
	ie_origem_baixa_w	:= 'BR';
elsif (NEW.nr_seq_movto_trans_fin is not null) and (nr_seq_banco_w is not null) then
	ie_origem_baixa_w	:= 'CB';
elsif (NEW.nr_seq_cobranca is not null) then
	ie_origem_baixa_w	:= 'CE';
elsif (NEW.nr_seq_retorno is not null) then
	ie_origem_baixa_w	:= 'CR';
elsif (NEW.nr_adiantamento is not null) then	
	ie_origem_baixa_w	:= 'DA';
elsif (NEW.nr_seq_deposito_ident is not null) then
	ie_origem_baixa_w	:= 'DI';
elsif (NEW.nr_seq_lote_hist_guia is not null) then
	ie_origem_baixa_w	:= 'GR';
elsif (NEW.nr_seq_negociacao_cr is not null) then
	ie_origem_baixa_w	:= 'NR';
elsif (NEW.nr_seq_caixa_rec is not null) then
	ie_origem_baixa_w	:= 'RC';
elsif (NEW.nr_repasse_terceiro is not null) then
	ie_origem_baixa_w	:= 'RT';
elsif (NEW.nr_seq_movto_trans_fin is not null) and (nr_seq_caixa_w is not null) then
	ie_origem_baixa_w	:= 'TS';
else
	ie_origem_baixa_w	:= 'MR';
end if;	

if (ie_origem_baixa_w is not null) then
	NEW.ie_origem_baixa	:= ie_origem_baixa_w;
end if;

end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_receber_liq_update() FROM PUBLIC;

CREATE TRIGGER titulo_receber_liq_update
	BEFORE UPDATE ON titulo_receber_liq FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_receber_liq_update();

