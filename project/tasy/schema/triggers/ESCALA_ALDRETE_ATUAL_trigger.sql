-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_aldrete_atual ON escala_aldrete CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_aldrete_atual() RETURNS trigger AS $BODY$
declare
  sql_w varchar(800);
  qt_aldrete_w bigint;
  ds_erro_w   varchar(2000);
  ds_parametro_w  varchar(2000);
BEGIN
  BEGIN
	BEGIN
		if (wheb_usuario_pck.get_ie_executar_trigger	= 'S')  then
			if (NEW.nr_atendimento is null) and (NEW.nr_cirurgia is not null) then
				select
					nr_atendimento
				into STRICT
					NEW.nr_atendimento
				from
					cirurgia
				where
					nr_cirurgia = NEW.nr_cirurgia;
			end if;

			--INICIO MD

			sql_w := 'CALL CALCULA_ALDRETE_MD(:1, :2, :3, :4, :5, :6) INTO :qt_pontuacao_w';
			EXECUTE sql_w USING IN NEW.ie_atividade,
																		IN NEW.ie_respiracao,
																		IN NEW.ie_pressao_arterial, 
																		IN NEW.ie_consciencia,
																		IN NEW.ie_coloracao,
																		IN coalesce(NEW.ie_saturation_o2,0),
																		OUT qt_aldrete_w;
			--FIM MD

		end if;
	exception
		when others then
			qt_aldrete_w := null;
      ds_erro_w := sqlerrm;
      ds_parametro_w := ':new.nr_sequencia: ' || NEW.nr_sequencia || ' - :new.nr_atendimento: ' || NEW.nr_atendimento || ' - :new.ie_situacao: ' || NEW.ie_situacao || ' - :new.cd_profissional: ' || NEW.cd_profissional || ' - :new.nr_cirurgia: ' || NEW.nr_cirurgia;
      ds_parametro_w := ds_parametro_w || ' - :new.ie_atividade: ' || NEW.ie_atividade || ' - :new.ie_respiracao: ' || NEW.ie_respiracao || ' - :new.ie_pressao_arterial: ' || NEW.ie_pressao_arterial || ' - :new.ie_consciencia: ' || NEW.ie_consciencia;
      ds_parametro_w := ds_parametro_w || ' - :new.ie_coloracao: ' || NEW.ie_coloracao || ' - nvl(:new.ie_saturation_o2,0): ' || coalesce(NEW.ie_saturation_o2,0) || ' - qt_aldrete_w: ' || qt_aldrete_w;
      CALL gravar_log_medical_device('escala_aldrete_atual', 'CALCULA_ALDRETE_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
		end;

		NEW.qt_aldrete := qt_aldrete_w;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_aldrete_atual() FROM PUBLIC;

CREATE TRIGGER escala_aldrete_atual
	BEFORE INSERT OR UPDATE ON escala_aldrete FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_aldrete_atual();

