-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS carta_medica_after_insert ON carta_medica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_carta_medica_after_insert() RETURNS trigger AS $BODY$
DECLARE
nr_seq_regra_w	wl_regra_item.nr_sequencia%type;
ie_modelo_carta_w   carta_medica_modelo.ie_modelo_cirurgia%type;

BEGIN
        if (wheb_usuario_pck.get_ie_executar_trigger    = 'S') then
                select	max(a.nr_seq_regra)
                into STRICT	nr_seq_regra_w
                from	wl_worklist a,
                        wl_item b,
                        wl_regra_item c
                where	a.cd_pessoa_fisica = NEW.cd_pessoa_fisica
                and	a.nr_atendimento = NEW.nr_atendimento
                and	b.nr_sequencia = a.nr_seq_item
                and	c.nr_sequencia = a.nr_seq_regra
                and	a.dt_final_real is null
                and	b.cd_categoria = 'ML'
                and	c.ie_tipo_pend_carta = 'N'
                and	b.ie_situacao = 'A'
                and	c.ie_situacao = 'A';

                select  max(cmm.ie_modelo_cirurgia)
                into STRICT    ie_modelo_carta_w
                from    carta_medica_modelo cmm,
                        wl_regra_item wri
                where   cmm.nr_sequencia = NEW.nr_seq_modelo
                and     wri.nr_sequencia = (to_char(nr_seq_regra_w))::numeric 
                and     wri.ie_modelo_carta = cmm.ie_modelo_cirurgia;

                CALL wl_gerar_finalizar_tarefa('ML','F',NEW.nr_atendimento,NEW.cd_pessoa_fisica,wheb_usuario_pck.get_nm_usuario,null,'N',null,null,null,null,null,coalesce(NEW.nr_seq_carta_mae,NEW.nr_sequencia),null,null,null,nr_seq_regra_w,null,null,null,
                null,null,null,null,null,null,null,null,null,null,null,null,null,ie_modelo_carta_w);
        end if;
RETURN NEW;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_carta_medica_after_insert() FROM PUBLIC;

CREATE TRIGGER carta_medica_after_insert
	AFTER INSERT ON carta_medica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_carta_medica_after_insert();

