-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_saps_atual ON escala_saps CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_saps_atual() RETURNS trigger AS $BODY$
DECLARE
    cd_pessoa_fisica_w  varchar(10);
    qt_reg_w            smallint;
    sql_w               varchar(700);
    ie_idade_pf_w       varchar(10);
    ie_sexo_w           varchar(10);
    ds_erro_w           varchar(4000);
    ds_parametros_w     varchar(4000);
BEGIN
  BEGIN
    IF ( wheb_usuario_pck.get_ie_executar_trigger = 'N' ) THEN
        GOTO final;
    END IF;

  /* Obter pessoa fisica */

    SELECT
        cd_pessoa_fisica
    INTO STRICT cd_pessoa_fisica_w
    FROM
        atendimento_paciente
    WHERE
        nr_atendimento = NEW.nr_atendimento;

    BEGIN
        ie_idade_pf_w := obter_idade_pf(cd_pessoa_fisica_w, LOCALTIMESTAMP, 'A');
        ie_sexo_w := obter_sexo_pf(cd_pessoa_fisica_w, 'C');
        sql_w := 'begin calcular_escala_saps_md(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10,
                                            :11, :12, :13, :14, :15, :16, :17, :18, :19, :20,
                                            :21, :22, :23, :24, :25, :26, :27, :28, :29, :30,
                                            :31, :32, :33, :34, :35, :36, :37, :38, :39, :40,
                                            :41, :42, :43, :44, :45, :46, :47, :48, :49, :50); end;';
        EXECUTE sql_w
            USING IN philips_param_pck.get_cd_pais(), IN NEW.ie_tipo_admissao, IN NEW.ie_aids, IN NEW.ie_malig_hematologica, IN NEW.ie_cancro_metastatico,
            IN NEW.qt_glasgow, IN OLD.qt_idade, IN ie_idade_pf_w, IN NEW.qt_idade, IN NEW.qt_pa_sistolica,
            IN NEW.qt_freq_cardiaca, IN NEW.qt_temp, IN NEW.qt_rel_pao2_fio2, IN NEW.qt_ureia, IN NEW.qt_diurese, IN NEW.qt_globulos_brancos,
            IN NEW.qt_potassio, IN NEW.qt_sodio, IN NEW.qt_bicarbonato, IN NEW.qt_bilirrubina, IN ie_sexo_w, IN NEW.qt_dias_antes_uti,
            IN NEW.ie_origem_paciente, IN NEW.ie_categoria_clinica, IN NEW.ie_intoxicacao, OUT NEW.qt_idade, OUT NEW.qt_pto_tipo_adm,
            OUT NEW.qt_pto_doenca_cro, OUT NEW.qt_pto_glasgow, OUT NEW.qt_pto_idade, OUT NEW.qt_pto_pa_sitolica, OUT NEW.qt_pto_frec_card,
            OUT NEW.qt_pto_temp, OUT NEW.qt_pto_pao2_fio2, OUT NEW.qt_pto_ureia, OUT NEW.qt_pto_diurese, OUT NEW.qt_pto_glob_branco,
            OUT NEW.qt_pto_potassio, OUT NEW.qt_pto_sodio, OUT NEW.qt_pto_bicarbonato, OUT NEW.qt_pto_bilirrubina, OUT NEW.qt_pto_sexo,
            OUT NEW.qt_pto_dias_uti, OUT NEW.qt_pto_origem_pac, OUT NEW.qt_pto_categ_clinica, OUT NEW.qt_pto_intoxic, OUT NEW.qt_saps, 
            OUT NEW.qt_saps_expand, OUT NEW.pr_mortalidade, OUT NEW.pr_mort_expand;

    EXCEPTION
        WHEN OTHERS THEN

      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          'philips_param_pck.get_cd_pais(): '||philips_param_pck.get_cd_pais()||'-'||':new.ie_tipo_admissao: '||NEW.ie_tipo_admissao||'-'||':new.ie_aids: '||NEW.ie_aids||'-'||
                          ':new.ie_malig_hematologica: '||NEW.ie_malig_hematologica||'-'||':new.ie_cancro_metastatico: '||NEW.ie_cancro_metastatico||'-'||':new.qt_glasgow: '||NEW.qt_glasgow||'-'||
                          ':old.qt_idade: '||OLD.qt_idade||'-'||'ie_idade_pf_w: '||ie_idade_pf_w||'-'||':new.qt_idade: '||NEW.qt_idade||'-'||
                          ':new.qt_pa_sistolica: '||NEW.qt_pa_sistolica||'-'||':new.qt_freq_cardiaca: '||NEW.qt_freq_cardiaca||'-'||':new.qt_temp: '||NEW.qt_temp||'-'||
                          ':new.qt_rel_pao2_fio2: '||NEW.qt_rel_pao2_fio2||'-'||':new.qt_ureia: '||NEW.qt_ureia||'-'||':new.qt_diurese: '||NEW.qt_diurese||'-'||
                          ':new.qt_globulos_brancos: '||NEW.qt_globulos_brancos||'-'||':new.qt_potassio: '||NEW.qt_potassio||'-'||':new.qt_sodio: '||NEW.qt_sodio||'-'||
                          ':new.qt_bicarbonato: '||NEW.qt_bicarbonato||'-'||':new.qt_bilirrubina: '||NEW.qt_bilirrubina||'-'||'ie_sexo_w: '||ie_sexo_w||'-'||
                          ':new.qt_dias_antes_uti: '||NEW.qt_dias_antes_uti||'-'||':new.ie_origem_paciente: '||NEW.ie_origem_paciente||'-'||':new.ie_categoria_clinica: '||NEW.ie_categoria_clinica||'-'||
                          ':new.ie_intoxicacao: '||NEW.ie_intoxicacao||'-'||':new.qt_idade: '||NEW.qt_idade||'-'||':new.qt_pto_tipo_adm: '||NEW.qt_pto_tipo_adm||'-'||
                          ':new.qt_pto_doenca_cro: '||NEW.qt_pto_doenca_cro||'-'||':new.qt_pto_glasgow: '||NEW.qt_pto_glasgow||'-'||':new.qt_pto_idade: '||NEW.qt_pto_idade||'-'||
                          ':new.qt_pto_pa_sitolica: '||NEW.qt_pto_pa_sitolica||'-'||':new.qt_pto_frec_card: '||NEW.qt_pto_frec_card||'-'||':new.qt_pto_temp: '||NEW.qt_pto_temp||'-'||
                          ':new.qt_pto_pao2_fio2: '||NEW.qt_pto_pao2_fio2||'-'||':new.qt_pto_ureia: '||NEW.qt_pto_ureia||'-'||':new.qt_pto_diurese: '||NEW.qt_pto_diurese||'-'||
                          ':new.qt_pto_glob_branco: '||NEW.qt_pto_glob_branco||'-'||':new.qt_pto_potassio: '||NEW.qt_pto_potassio||'-'||':new.qt_pto_sodio: '||NEW.qt_pto_sodio||'-'||
                          ':new.qt_pto_bicarbonato: '||NEW.qt_pto_bicarbonato||'-'||':new.qt_pto_bilirrubina: '||NEW.qt_pto_bilirrubina||'-'||':new.qt_pto_sexo: '||NEW.qt_pto_sexo||'-'||
                          ':new.qt_pto_dias_uti: '||NEW.qt_pto_dias_uti||'-'||':new.qt_pto_origem_pac: '||NEW.qt_pto_origem_pac||'-'||':new.qt_pto_categ_clinica: '||NEW.qt_pto_categ_clinica||'-'||
                          ':new.qt_pto_intoxic: '||NEW.qt_pto_intoxic||'-'||':new.qt_saps: '||NEW.qt_saps||'-'||':new.qt_saps_expand: '||NEW.qt_saps_expand||'-'||
                          ':new.pr_mortalidade: '||NEW.pr_mortalidade||'-'||':new.pr_mort_expand: '||NEW.pr_mort_expand);

      CALL gravar_log_medical_device('escala_saps_atual','calcular_escala_saps_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
        
        
            NEW.qt_idade := NULL;
            NEW.qt_pto_tipo_adm := NULL;
            NEW.qt_pto_doenca_cro := NULL;
            NEW.qt_pto_glasgow := NULL;
            NEW.qt_pto_idade := NULL;
            NEW.qt_pto_pa_sitolica := NULL;
            NEW.qt_pto_frec_card := NULL;
            NEW.qt_pto_temp := NULL;
            NEW.qt_pto_pao2_fio2 := NULL;
            NEW.qt_pto_ureia := NULL;
            NEW.qt_pto_diurese := NULL;
            NEW.qt_pto_glob_branco := NULL;
            NEW.qt_pto_potassio := NULL;
            NEW.qt_pto_sodio := NULL;
            NEW.qt_pto_bicarbonato := NULL;
            NEW.qt_pto_bilirrubina := NULL;
            NEW.qt_pto_sexo := NULL;
            NEW.qt_pto_dias_uti := NULL;
            NEW.qt_pto_origem_pac := NULL;
            NEW.qt_pto_categ_clinica := NULL;
            NEW.qt_pto_intoxic := NULL;
            NEW.qt_saps := NULL;
            NEW.qt_saps_expand := NULL;
            NEW.pr_mortalidade := NULL;
            NEW.pr_mort_expand := NULL;
    END;

    << final >> qt_reg_w := 0;
  END;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_saps_atual() FROM PUBLIC;

CREATE TRIGGER escala_saps_atual
	BEFORE INSERT OR UPDATE ON escala_saps FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_saps_atual();

