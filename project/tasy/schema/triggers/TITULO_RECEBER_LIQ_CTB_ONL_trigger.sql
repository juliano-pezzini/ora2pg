-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_receber_liq_ctb_onl ON titulo_receber_liq CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_receber_liq_ctb_onl() RETURNS trigger AS $BODY$
declare

ie_contab_cr_w          ctb_param_lote_tesouraria.ie_contab_cr%type;
cd_estabelecimento_w    estabelecimento.cd_estabelecimento%type;
nr_multiplicador_w      smallint;
vl_movimento_w          ctb_documento.vl_movimento%type;
dt_movimento_w          ctb_documento.dt_competencia%type;
nr_seq_trans_financ_w   ctb_documento.nr_seq_trans_financ%type;
nr_seq_info_w           ctb_documento.nr_seq_info%type;
nr_documento_w          ctb_documento.nr_documento%type;
nr_seq_doc_compl_w      ctb_documento.nr_seq_doc_compl%type;
nr_doc_analitico_w      ctb_documento.nr_doc_analitico%type;
nm_tabela_w             ctb_documento.nm_tabela%type;
nr_seq_proj_rec_w ctb_documento.nr_seq_proj_rec%type;
qt_registros_w          bigint := 0;
ie_pls_w                bigint := 0;

c01 CURSOR FOR
    SELECT  a.nm_atributo,
            10 cd_tipo_lote_contab
    from    atributo_contab a
    where (a.cd_tipo_lote_contab = 5
    and     a.nm_atributo  (  'VL_DESCONTOS', 'VL_JUROS', 'VL_MULTA',
                                'VL_DESPESA_BANCARIA',  'VL_ORIGINAL_BAIXA',
                                'VL_CAMBIAL_ATIVO', 'VL_CAMBIAL_PASSIVO' ))
    or (a.cd_tipo_lote_contab = 10
    and     a.nm_atributo in (  'VL_RECEBIDO_TESOURARIA' ));

c01_w c01%rowtype;
BEGIN
  BEGIN
if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

    select  t.cd_estabelecimento,
            t.nr_seq_proj_rec
    into STRICT    cd_estabelecimento_w,
            nr_seq_proj_rec_w
    from    titulo_receber t
    where   t.nr_titulo = NEW.nr_titulo;

    BEGIN
    select  x.ie_contab_cr
    into STRICT    ie_contab_cr_w
    from (
        SELECT  coalesce(ie_contab_cr,'N') ie_contab_cr
        from    ctb_param_lote_tesouraria a
        where   a.cd_empresa    = obter_empresa_estab(cd_estabelecimento_w)
        and     coalesce(a.cd_estab_exclusivo, cd_estabelecimento_w) = cd_estabelecimento_w
    order by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;
    exception
        when no_data_found then
            ie_contab_cr_w := 'N';
        when too_many_rows then
            ie_contab_cr_w := 'N';
    end;

    BEGIN
    select  1
    into STRICT    ie_pls_w

    where exists (
        SELECT  t.nr_titulo
        from    titulo_receber t
        where   t.nr_titulo = NEW.nr_titulo
        and not exists (SELECT  1
                        from    movto_trans_financ x
                        where   x.nr_sequencia = NEW.nr_seq_movto_trans_fin)
        and exists (select  1
                    from    pls_titulo_rec_liq_mens x
                    where   x.nr_titulo = NEW.nr_titulo
                    and     x.nr_seq_baixa = NEW.nr_sequencia)
        and exists (select  1
                    from    pls_mensalidade x,
                            titulo_receber  y
                    where   y.nr_seq_mensalidade = x.nr_sequencia
                    and     y.nr_titulo = NEW.nr_titulo )
        );
    exception
        when no_data_found then
            ie_pls_w := 0;
    end;

    if (    ie_contab_cr_w = 'S'
            and ie_pls_w = 0
            and NEW.ie_lib_caixa = 'S'
            and NEW.nr_seq_conta_banco is null
            and NEW.nr_seq_lote_enc_contas is null /* Francisco - 30/10/2010 - Vai entrar em outro lote */

            and NEW.nr_seq_pls_lote_camara is null /* Francisco - 30/10/2010 - Vai entrar em outro lote */

            and NEW.nr_seq_movto_trans_fin is not null -- Edgar 27/05/2008, OS 93779
            ) then

        BEGIN
        open c01;
        loop
        fetch c01 into
                c01_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
            BEGIN

            nr_multiplicador_w := 1;

            if (NEW.ie_acao <> 'I') then
              nr_multiplicador_w := -1;
            end if;

            vl_movimento_w:=        case c01_w.nm_atributo
                        when 'VL_DESCONTOS'             then NEW.vl_descontos * nr_multiplicador_w
                        when 'VL_JUROS'                 then NEW.vl_juros * nr_multiplicador_w
                        when 'VL_MULTA'                 then NEW.vl_multa * nr_multiplicador_w
                        when 'VL_DESPESA_BANCARIA'      then NEW.vl_despesa_bancaria * nr_multiplicador_w
                        when 'VL_RECEBIDO_TESOURARIA'   then NEW.vl_recebido * nr_multiplicador_w
                        when 'VL_ORIGINAL_BAIXA'        then NEW.vl_recebido + NEW.vl_juros + NEW.vl_multa + NEW.vl_descontos
                        when 'VL_CAMBIAL_ATIVO'         then NEW.vl_cambial_ativo * nr_multiplicador_w
                        when 'VL_CAMBIAL_PASSIVO'       then NEW.vl_cambial_passivo * nr_multiplicador_w
                        end;

            dt_movimento_w          := NEW.dt_recebimento;
            nr_seq_trans_financ_w   := NEW.nr_seq_trans_fin;
            nr_seq_info_w           := 14;
            nr_documento_w          := NEW.nr_titulo;
            nr_seq_doc_compl_w      := NEW.nr_sequencia;
            nr_doc_analitico_w      := null;
            nm_tabela_w             := 'TITULO_RECEBER_LIQ_CONTAB_V2';

            BEGIN
            select  1
            into STRICT    qt_registros_w

            where exists (
                SELECT  a.nr_sequencia
                from    ctb_documento a
                where   a.nr_documento          = nr_documento_w
                and     a.nr_seq_doc_compl      = nr_seq_doc_compl_w
                and     a.cd_tipo_lote_contabil = c01_w.cd_tipo_lote_contab
                and     a.cd_estabelecimento    = cd_estabelecimento_w
                and     a.nr_seq_trans_financ   = nr_seq_trans_financ_w
                and     a.nr_seq_info           = nr_seq_info_w
                and     a.nm_tabela             = nm_tabela_w
                and    a.nm_atributo            = c01_w.nm_atributo
                );
            exception
                when no_data_found then
                    qt_registros_w := 0;
            end;

            if (qt_registros_w = 0) and (coalesce(vl_movimento_w, 0) <> 0 and coalesce(nr_seq_trans_financ_w, 0) <> 0) then
                   CALL ctb_concil_financeira_pck.ctb_gravar_documento(   cd_estabelecimento_w,
                                                                       dt_movimento_w,
                                                                       c01_w.cd_tipo_lote_contab,
                                                                       nr_seq_trans_financ_w,
                                                                       nr_seq_info_w,
                                                                       nr_documento_w,
                                                                       nr_seq_doc_compl_w,
                                                                       nr_doc_analitico_w,
                                                                       vl_movimento_w,
                                                                       nm_tabela_w,
                                                                       c01_w.nm_atributo,
                                                                       NEW.nm_usuario,
                                                                       'P',
                                                                       null,
                                                                       nr_seq_proj_rec_w);
            end if;
            end;
        end loop;
        close c01;
        end;
    end if;

end if;
  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_receber_liq_ctb_onl() FROM PUBLIC;

CREATE TRIGGER titulo_receber_liq_ctb_onl
	AFTER INSERT OR UPDATE ON titulo_receber_liq FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_receber_liq_ctb_onl();

