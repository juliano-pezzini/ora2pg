-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_conta_copartic_alt ON pls_conta_coparticipacao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_conta_copartic_alt() RETURNS trigger AS $BODY$
declare

ds_log_call_w 		varchar(1500);
ds_observacao_w		varchar(2000);
ie_opcao_w		varchar(3);
nr_seq_conta_w		pls_conta_proc.nr_sequencia%type;

BEGIN
if (coalesce(wheb_usuario_pck.get_ie_lote_contabil,'N') = 'N') and (coalesce(wheb_usuario_pck.get_ie_atualizacao_contabil,'N') = 'N') then
	if (NEW.nr_seq_regra_exclusao is not null) and (NEW.vl_coparticipacao	> 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(259055);
	end if;
end if;


if ( TG_OP = 'UPDATE' )then	
	 

	ds_log_call_w := substr(pls_obter_detalhe_exec(false),1,1500);
	
	if ( pls_se_aplicacao_tasy = 'N') then
		ds_observacao_w	:= 'Alteração efetuada via update fora do Tasy.';
		if (coalesce(NEW.vl_coparticipacao,0) <> coalesce(OLD.vl_coparticipacao,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
							'Valor coparticipação: '||chr(13)||chr(10)||
							chr(9)||'Anterior: '||OLD.vl_coparticipacao||' - Modificado: '||NEW.vl_coparticipacao||chr(13)||chr(10);
		end if;
		
		if (coalesce(NEW.nr_seq_mensalidade_seg,0) <> coalesce(OLD.nr_seq_mensalidade_seg,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
							'Seq mensalidade seg.: '||chr(13)||chr(10)||
							chr(9)||'Anterior: '||OLD.nr_seq_mensalidade_seg||' - Modificado: '||NEW.nr_seq_mensalidade_seg||chr(13)||chr(10);
		end if;
		
		if (coalesce(NEW.ie_status_mensalidade,'X') <> coalesce(OLD.ie_status_mensalidade,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
							'Status mensalidade: '||chr(13)||chr(10)||
							chr(9)||'Anterior: '||OLD.ie_status_mensalidade||' - Modificado: '||NEW.ie_status_mensalidade||chr(13)||chr(10);
		end if;
		
		if (coalesce(NEW.ie_status_coparticipacao,'X') <> coalesce(OLD.ie_status_coparticipacao,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
							'Status coparticipação alterado fora do tasy: '||chr(13)||chr(10)||
							chr(9)||'Anterior: '||OLD.ie_status_coparticipacao||' - Modificado: '||NEW.ie_status_coparticipacao||chr(13)||chr(10);
		end if;
		
		if (coalesce(NEW.ie_gerar_mensalidade,'X') <> coalesce(OLD.ie_gerar_mensalidade,'X')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
							'Mensalidade gerada: '||chr(13)||chr(10)||
							chr(9)||'Anterior: '||OLD.ie_gerar_mensalidade||' - Modificado: '||NEW.ie_gerar_mensalidade||chr(13)||chr(10);
		end if;
	end if;
	
	if (OLD.dt_estorno is null AND NEW.dt_estorno is not null) then
	
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
							'dt_estorno: '||chr(13)||chr(10)||
							chr(9)||'Anterior: '||OLD.dt_estorno||' - Modificado: '||NEW.dt_estorno||chr(13)||chr(10)||
							'Status coparticipação: '||chr(13)||chr(10)||
								chr(9)||'Anterior: '||OLD.ie_status_coparticipacao||' - Modificado: '||NEW.ie_status_coparticipacao||chr(13)||chr(10)||
							'Status mensalidade: '||chr(13)||chr(10)||
								chr(9)||'Anterior(cancelada): '||OLD.ie_status_mensalidade||' - Modificado: '||NEW.ie_status_mensalidade||chr(13)||chr(10);	
							
	
	else
	
		if	( (NEW.ie_status_coparticipacao = 'N') and (NEW.ie_status_coparticipacao <> coalesce(OLD.ie_status_coparticipacao,'N'))) then
				ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
								'Status coparticipação: '||chr(13)||chr(10)||
								chr(9)||'Anterior: '||OLD.ie_status_coparticipacao||' - Modificado: '||NEW.ie_status_coparticipacao||chr(13)||chr(10);
		end if;
		
		if	((coalesce(NEW.ie_status_mensalidade,'X') <> coalesce(OLD.ie_status_mensalidade,'X')) and (coalesce(OLD.ie_status_mensalidade,'X') = 'C')) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
								'Status mensalidade: '||chr(13)||chr(10)||
								chr(9)||'Anterior(cancelada): '||OLD.ie_status_mensalidade||' - Modificado: '||NEW.ie_status_mensalidade||chr(13)||chr(10);
		end if;
		
		if (coalesce(NEW.nr_seq_conta,0) <> coalesce(OLD.nr_seq_conta,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
							'Conta: '||chr(13)||chr(10)||
							chr(9)||'Anterior: '||OLD.nr_seq_conta||' - Modificado: '||NEW.nr_seq_conta||chr(13)||chr(10);
		end if;
		
		if (coalesce(NEW.nr_seq_conta_proc,0) <> coalesce(OLD.nr_seq_conta_proc,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
							'Conta proc: '||chr(13)||chr(10)||
							chr(9)||'Anterior: '||OLD.nr_seq_conta_proc||' - Modificado: '||NEW.nr_seq_conta_proc||chr(13)||chr(10);
		end if;
		
		if (coalesce(NEW.nr_seq_conta_mat,0) <> coalesce(OLD.nr_seq_conta_mat,0)) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
							'Conta mat: '||chr(13)||chr(10)||
							chr(9)||'Anterior: '||OLD.nr_seq_conta_mat||' - Modificado: '||NEW.nr_seq_conta_mat||chr(13)||chr(10);
		end if;
		
	end if;
	
	if (ds_observacao_w is not null) then
		insert	into	pls_conta_copartic_log(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_conta_copartic,nr_seq_conta,nr_seq_conta_proc,nr_seq_conta_mat,vl_coparticipacao,
				vl_coparticipacao_old,nr_seq_mensalidade_seg,nr_seq_mensalidade_seg_old,ie_status_mensalidade,ie_status_mensalidade_old,
				ie_status_coparticipacao,ie_status_coparticipacao_old,ie_gerar_mensalidade,ie_gerar_mensalidade_old,
				nm_maquina,ds_log_call,ds_log,
				ie_tipo_registro)
		values (	nextval('pls_conta_copartic_log_seq'),LOCALTIMESTAMP,NEW.nm_usuario,LOCALTIMESTAMP,NEW.nm_usuario,
				NEW.nr_sequencia,NEW.nr_seq_conta,NEW.nr_seq_conta_proc,NEW.nr_seq_conta_mat,NEW.vl_coparticipacao,
				OLD.vl_coparticipacao,NEW.nr_seq_mensalidade_seg,OLD.nr_seq_mensalidade_seg,NEW.ie_status_mensalidade,OLD.ie_status_mensalidade,
				NEW.ie_status_coparticipacao,OLD.ie_status_coparticipacao,NEW.ie_gerar_mensalidade,OLD.ie_gerar_mensalidade,
				wheb_usuario_pck.get_machine,ds_log_call_w,substr(ds_observacao_w,1,2000),
				'A');
	end if;
end if;



if (TG_OP = 'INSERT') then
	if (NEW.nr_seq_conta_proc is not null) then
		select	max(nr_seq_conta)
		into STRICT	nr_seq_conta_w
		from	pls_conta_proc
		where	nr_sequencia	= NEW.nr_seq_conta_proc;
		
		if (nr_seq_conta_w <> NEW.nr_seq_conta) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Conta insert: '||chr(13)||chr(10)||
						chr(9)||'Conta proc: '||nr_seq_conta_w||' - Conta copart: '||NEW.nr_seq_conta||chr(13)||chr(10);
		end if;
	end if;
	
	if (NEW.nr_seq_conta_mat is not null) then
		select	max(nr_seq_conta)
		into STRICT	nr_seq_conta_w
		from	pls_conta_mat
		where	nr_sequencia	= NEW.nr_seq_conta_mat;
		
		if (nr_seq_conta_w <> NEW.nr_seq_conta) then
			ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
						'Conta insert: '||chr(13)||chr(10)||
						chr(9)||'Conta mat: '||nr_seq_conta_w||' - Conta copart: '||NEW.nr_seq_conta||chr(13)||chr(10);
		end if;
	end if;
	
	if (ds_observacao_w is not null) then
		
		ds_log_call_w := substr(pls_obter_detalhe_exec(false),1,1500);
	
		insert	into	pls_conta_copartic_log(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_conta_copartic,nr_seq_conta,nr_seq_conta_proc,nr_seq_conta_mat,
				nm_maquina,ds_log_call,ds_log,
				ie_tipo_registro)
		values (	nextval('pls_conta_copartic_log_seq'),LOCALTIMESTAMP,NEW.nm_usuario,LOCALTIMESTAMP,NEW.nm_usuario,
				NEW.nr_sequencia,NEW.nr_seq_conta,NEW.nr_seq_conta_proc,NEW.nr_seq_conta_mat,
				wheb_usuario_pck.get_machine,ds_log_call_w,substr(ds_observacao_w,1,2000),
				'A');
	end if;
	
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_conta_copartic_alt() FROM PUBLIC;

CREATE TRIGGER pls_conta_copartic_alt
	BEFORE INSERT OR UPDATE ON pls_conta_coparticipacao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_conta_copartic_alt();

