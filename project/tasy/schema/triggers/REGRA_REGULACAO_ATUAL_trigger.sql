-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS regra_regulacao_atual ON regra_regulacao CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_regra_regulacao_atual() RETURNS trigger AS $BODY$
declare

ie_resultado_w  varchar(1);
ds_expressao_w	varchar(255);
	
BEGIN

  if (NEW.cd_material is not null  and
	   NEW.ie_tipo = 'ME' ) then 
	   
	   Select coalesce(max('S'),'N')
		into STRICT   ie_resultado_w
  		from   material a,
			   material_estab b
		where  a.cd_material = b.cd_material
		and    b.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
		and    b.ie_classif_custo = 'A'
		and    a.ie_tipo_material in ('2','8','3','0','6','9')
		and	   a.cd_material = NEW.cd_material;
	
		
		if ( ie_resultado_w = 'N') then
		
			Select  obter_desc_expressao(941031,'O medicamento selecionado não é considerado um medicamento de alto custo.')
			into STRICT	ds_expressao_w
			;
		
			CALL exibir_erro_abortar(ds_expressao_w,null);

		
		end if;
		
	
  end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_regra_regulacao_atual() FROM PUBLIC;

CREATE TRIGGER regra_regulacao_atual
	BEFORE INSERT OR UPDATE ON regra_regulacao FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_regra_regulacao_atual();

