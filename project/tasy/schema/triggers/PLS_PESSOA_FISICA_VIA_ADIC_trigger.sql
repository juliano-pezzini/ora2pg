-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pls_pessoa_fisica_via_adic ON pessoa_fisica CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pls_pessoa_fisica_via_adic() RETURNS trigger AS $BODY$
declare

vl_parametro_w			varchar(20);
qt_beneficiarios_plano_w	bigint;
ie_lancar_via_adic		varchar(20);
ie_possui_benef_w		varchar(1) := 'N';

BEGIN
ie_lancar_via_adic	:= 'N';
select	count(1)
into STRICT	qt_beneficiarios_plano_w
from	pls_segurado
where	cd_pessoa_fisica	= OLD.cd_pessoa_fisica
and	((dt_rescisao is null) or (dt_rescisao > LOCALTIMESTAMP));

if (wheb_usuario_pck.get_ie_executar_trigger	= 'S') and (qt_beneficiarios_plano_w > 0)	then
	CALL pls_usuario_pck.set_ie_commit('S');
	if (wheb_usuario_pck.get_cd_funcao in (1220,1268)) then
		vl_parametro_w := Obter_Param_Usuario(1220, 39, obter_perfil_ativo, NEW.nm_usuario, NEW.cd_estabelecimento, vl_parametro_w);
	elsif (wheb_usuario_pck.get_cd_funcao = 1286) then
		vl_parametro_w := Obter_Param_Usuario(1286, 10, obter_perfil_ativo, NEW.nm_usuario, NEW.cd_estabelecimento, vl_parametro_w);
		if (vl_parametro_w = 'P') then
			vl_parametro_w	:= 'S';
		end if;
	else
		vl_parametro_w := 'N';
	end if;
	
	if (vl_parametro_w = 'S') then
		null;

	end if;
end if;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pls_pessoa_fisica_via_adic() FROM PUBLIC;

CREATE TRIGGER pls_pessoa_fisica_via_adic
	AFTER UPDATE ON pessoa_fisica FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pls_pessoa_fisica_via_adic();

