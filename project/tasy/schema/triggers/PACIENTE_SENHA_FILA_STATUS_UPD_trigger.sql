-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS paciente_senha_fila_status_upd ON paciente_senha_fila CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_paciente_senha_fila_status_upd() RETURNS trigger AS $BODY$
declare
ie_canceled_reason_changed_w varchar(1);

BEGIN

if (NEW.ie_sistema_externo = 'WHY') then
	ie_canceled_reason_changed_w := 'N';

	if (coalesce(NEW.dt_inutilizacao, to_date('01/01/3300', 'dd/mm/yyyy')) <> (coalesce(OLD.dt_inutilizacao, to_date('01/01/3300', 'dd/mm/yyyy')))) then
		ie_canceled_reason_changed_w := 'S';
	end if;

    if (OLD.dt_primeira_chamada is null and (coalesce(NEW.dt_primeira_chamada, to_date('01/01/3300', 'dd/mm/yyyy')) <> (coalesce(OLD.dt_primeira_chamada, to_date('01/01/3300', 'dd/mm/yyyy'))))) then
        CALL bft_request_senha_status(NEW.cd_estabelecimento, NEW.nr_seq_fila_senha, NEW.cd_senha_gerada, 'processing', NEW.nm_usuario, ie_canceled_reason_changed_w);
	end if;
	
	if (OLD.dt_fim_atendimento is null and (coalesce(NEW.dt_fim_atendimento, to_date('01/01/3300', 'dd/mm/yyyy')) <> (coalesce(OLD.dt_fim_atendimento, to_date('01/01/3300', 'dd/mm/yyyy'))))) then
		CALL bft_request_senha_status(NEW.cd_estabelecimento, NEW.nr_seq_fila_senha, NEW.cd_senha_gerada, 'completed', NEW.nm_usuario, ie_canceled_reason_changed_w);
	end if;
	
	if (OLD.dt_inutilizacao is null and (coalesce(NEW.dt_inutilizacao, to_date('01/01/3300', 'dd/mm/yyyy')) <> (coalesce(OLD.dt_inutilizacao, to_date('01/01/3300', 'dd/mm/yyyy'))))) then
        CALL bft_request_senha_status(NEW.cd_estabelecimento, NEW.nr_seq_fila_senha, NEW.cd_senha_gerada, 'canceled', NEW.nm_usuario, ie_canceled_reason_changed_w);
	end if;
	
	if (OLD.dt_retorno_senha is null and (coalesce(NEW.dt_retorno_senha, to_date('01/01/3300', 'dd/mm/yyyy')) <> (coalesce(OLD.dt_retorno_senha, to_date('01/01/3300', 'dd/mm/yyyy'))))) then
		CALL bft_request_senha_status(NEW.cd_estabelecimento, NEW.nr_seq_fila_senha, NEW.cd_senha_gerada, 'processing', NEW.nm_usuario, ie_canceled_reason_changed_w);
	end if;

end if;

RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_paciente_senha_fila_status_upd() FROM PUBLIC;

CREATE TRIGGER paciente_senha_fila_status_upd
	BEFORE UPDATE ON paciente_senha_fila FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_paciente_senha_fila_status_upd();

