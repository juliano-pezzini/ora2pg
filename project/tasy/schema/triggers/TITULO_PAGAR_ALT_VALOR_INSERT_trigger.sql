-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS titulo_pagar_alt_valor_insert ON titulo_pagar_alt_valor CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_titulo_pagar_alt_valor_insert() RETURNS trigger AS $BODY$
DECLARE

cd_estabelecimento_w		integer;
ie_altera_valor_tit_escrit_w	varchar(1);
qt_registro_w			integer;
ie_tipo_titulo_cpa_w		varchar(2);
ie_processo_camara_w		pls_parametros_camara.ie_processo_camara%type;
nr_titulo_pagar_w			pls_titulo_lote_camara.nr_titulo_pagar%type;
nr_seq_lote_w				pls_titulo_lote_camara.nr_sequencia%type;
ie_baixa_camara_compensacao_w	bigint;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
select	max(cd_estabelecimento),
	max(ie_tipo_titulo)
into STRICT	cd_estabelecimento_w,
	ie_tipo_titulo_cpa_w
from	titulo_pagar
where	nr_titulo	= NEW.nr_titulo;

if (fin_obter_se_mes_aberto(cd_estabelecimento_w, NEW.dt_alteracao,'CP',ie_tipo_titulo_cpa_w,null,null,null) = 'N') then
	/* O mes/dia financeiro de emissao do titulo ja esta fechado! Nao e possivel incluir novos titulos neste mes/dia. */


	CALL wheb_mensagem_pck.exibir_mensagem_abort(262134);
end if;

/* Projeto Davita  - Nao deixa gerar movimento contabil apos fechamento  da data */


CALL philips_contabil_pck.valida_se_dia_fechado(OBTER_EMPRESA_ESTAB(cd_estabelecimento_w),NEW.dt_alteracao);

/* nao deixar salvar se tem registro na titulo_pagar_escrit vinculado ao titulo */



select	coalesce(max(ie_altera_valor_tit_escrit),'S')
into STRICT	ie_altera_valor_tit_escrit_w
from	parametros_contas_pagar
where	cd_estabelecimento	= cd_estabelecimento_w;

if (ie_altera_valor_tit_escrit_w = 'N') then

	select	count(*)
	into STRICT	qt_registro_w
	from	titulo_pagar_escrit
	where	nr_titulo	= NEW.nr_titulo;

	if (qt_registro_w > 0) then
		/* Titulo ja vinculado a uma remessa de pagamento escritural.
		O mesmo so pode ser baixado pela funcao "Pagamento escritural".
		Titulo: :new.nr_titulo */

		CALL wheb_mensagem_pck.exibir_mensagem_abort(262125,'NR_TITULO_W='||NEW.nr_titulo);
	end if;
end if;

if (cd_estabelecimento_w is not null) then
	
	/*verificar se o titulo que esta recebendo a baixa esta em um lote de camra de compensacao que nao esta baixado.*/


	select	count(a.nr_titulo_pagar),
			max(b.nr_sequencia)
	into STRICT	nr_titulo_pagar_w,
			nr_seq_lote_w
	from	pls_titulo_lote_camara a,
			pls_lote_camara_comp b
	where	a.nr_seq_lote_camara	= b.nr_sequencia
	and		a.nr_titulo_pagar		= NEW.nr_titulo;	
	
	select	max(a.ie_processo_camara)
	into STRICT	ie_processo_camara_w
	from	pls_parametros_camara a
	where 	cd_estabelecimento = cd_estabelecimento_w;

	if (coalesce(ie_processo_camara_w,'CO') = 'CA') and (nr_titulo_pagar_w > 0) then /*se  o processo camara de compensacao for regime de caixa e o titulo estiver na camara*/

		
			CALL wheb_mensagem_pck.exibir_mensagem_abort(335779,	'NR_SEQ_LOTE_W=' || nr_seq_lote_w ||
									';NR_TITULO_W=' || NEW.nr_titulo);
	end if;
end if;

NEW.DS_STACK := substr('CallStack Insert: ' || substr(dbms_utility.format_call_stack,1,3980),1,4000);
end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_titulo_pagar_alt_valor_insert() FROM PUBLIC;

CREATE TRIGGER titulo_pagar_alt_valor_insert
	BEFORE INSERT ON titulo_pagar_alt_valor FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_titulo_pagar_alt_valor_insert();

