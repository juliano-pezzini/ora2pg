-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_nas_atual ON escala_nas CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_nas_atual() RETURNS trigger AS $BODY$
declare

	qt_pontuacao_w	double precision := 0;
	sql_w           varchar(300);
	qt_reg_w	smallint;
	cd_setor_atendimento_w	bigint;
  ds_erro_w   varchar(2000);
  ds_parametro_w  varchar(2000);
BEGIN
  BEGIN
  if (NEW.nr_hora is null) or (NEW.DT_AVALIACAO <> OLD.DT_AVALIACAO) then
	BEGIN  
	  NEW.nr_hora := (to_char(round(NEW.DT_AVALIACAO, 'hh24'), 'hh24'))::numeric;
	end;
  end if;
  if (wheb_usuario_pck.get_ie_executar_trigger = 'N')  then
    goto Final;
  end if;

  /** Inicio Medical Device **/


  BEGIN
	  sql_w := 'call obter_score_nas_md(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16,
										:17, :18, :19, :20, :21, :22, :23, :24, :25, :26, :27, :28, :29, :30,
										:31, :32) into :qt_pontuacao_w';
										
	  EXECUTE sql_w using in NEW.ds_item_1a, in NEW.ds_item_1b, in NEW.ds_item_1c, in NEW.ds_item_2,
									in NEW.ds_item_3, in NEW.ds_item_4a, in NEW.ds_item_4b, in NEW.ds_item_4c,
									in NEW.ds_item_5, in NEW.ds_item_6a, in NEW.ds_item_6b, in NEW.ds_item_6c,
									in NEW.ds_item_7a, in NEW.ds_item_7b, in NEW.ds_item_8a, in NEW.ds_item_8b,
									in NEW.ds_item_8c, in NEW.ds_item_9, in NEW.ds_item_10, in NEW.ds_item_11,
									in NEW.ds_item_12, in NEW.ds_item_13, in NEW.ds_item_14, in NEW.ds_item_15,
									in NEW.ds_item_16, in NEW.ds_item_17, in NEW.ds_item_18, in NEW.ds_item_19,
									in NEW.ds_item_20, in NEW.ds_item_21, in NEW.ds_item_22, in NEW.ds_item_23,
									out qt_pontuacao_w;
  exception
    when others then
      qt_pontuacao_w := null;
      ds_erro_w := sqlerrm;
      ds_parametro_w := ':new.ds_item_1a: ' || NEW.ds_item_1a || ' - :new.ds_item_1b: ' || NEW.ds_item_1b
      || ' - :new.ds_item_1c: ' || NEW.ds_item_1c || ' - :new.ds_item_2: ' || NEW.ds_item_2
      || ' - :new.ds_item_3: ' || NEW.ds_item_3 || ' - :new.ds_item_4a: ' || NEW.ds_item_4a
      || ' - :new.ds_item_4b: ' || NEW.ds_item_4b || ' - :new.ds_item_4c: ' || NEW.ds_item_4c
      || ' - :new.ds_item_5: ' || NEW.ds_item_5 || ' - :new.ds_item_6a: ' || NEW.ds_item_6a
      || ' - :new.ds_item_6b: ' || NEW.ds_item_6b || ' - :new.ds_item_6c: ' || NEW.ds_item_6c
      || ' - :new.ds_item_7a: ' || NEW.ds_item_7a || ' - :new.ds_item_7b: ' || NEW.ds_item_7b
      || ' - :new.ds_item_8a: ' || NEW.ds_item_8a || ' - :new.ds_item_8b: ' || NEW.ds_item_8b
      || ' - :new.ds_item_8c: ' || NEW.ds_item_8c || ' - :new.ds_item_9: ' || NEW.ds_item_9
      || ' - :new.ds_item_10: ' || NEW.ds_item_10 || ' - :new.ds_item_11: ' || NEW.ds_item_11
      || ' - :new.ds_item_12: ' || NEW.ds_item_12 || ' - :new.ds_item_13: ' || NEW.ds_item_13
      || ' - :new.ds_item_14: ' || NEW.ds_item_14 || ' - :new.ds_item_15: ' || NEW.ds_item_15
      || ' - :new.ds_item_16: ' || NEW.ds_item_16 || ' - :new.ds_item_17: ' || NEW.ds_item_17
      || ' - :new.ds_item_18: ' || NEW.ds_item_18 || ' - :new.ds_item_19: ' || NEW.ds_item_19
      || ' - :new.ds_item_20: ' || NEW.ds_item_20 || ' - :new.ds_item_21: ' || NEW.ds_item_21
      || ' - :new.ds_item_22: ' || NEW.ds_item_22 || ' - :new.ds_item_23: ' || NEW.ds_item_23
      || ' - qt_pontuacao_w: ' || qt_pontuacao_w;
      CALL gravar_log_medical_device('ESCALA_NAS_ATUAL', 'OBTER_SCORE_NAS_MD', ds_parametro_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'N');
  end;

  NEW.qt_pontuacao := qt_pontuacao_w;

  /** fim Medical Device **/


					 
  if (NEW.nr_atendimento	is not null) then
	BEGIN
	cd_setor_atendimento_w	:= obter_setor_atendimento(NEW.nr_atendimento);

	exception
	when others then
		cd_setor_atendimento_w	:= 0;
	end;
	
	if (cd_setor_atendimento_w	is not null) and (cd_setor_atendimento_w	> 0) then
		NEW.cd_setor_atendimento := cd_setor_atendimento_w;
	end if;

end if;

if (OLD.dt_liberacao is null) and (NEW.dt_liberacao is not null) then
	CALL send_nas_integration(NEW.nr_atendimento, NEW.nr_sequencia, NEW.dt_atualizacao, NEW.dt_avaliacao,
					NEW.dt_liberacao, NEW.ie_situacao, NEW.ds_item_1a, NEW.ds_item_1b,
					NEW.ds_item_1c, NEW.ds_item_2, NEW.ds_item_3, NEW.ds_item_4a, NEW.ds_item_4b,
					NEW.ds_item_4c, NEW.ds_item_5, NEW.ds_item_6a, NEW.ds_item_6b, NEW.ds_item_6c,
					NEW.ds_item_7a, NEW.ds_item_7b, NEW.ds_item_8a, NEW.ds_item_8b, NEW.ds_item_8c,
					NEW.ds_item_9, NEW.ds_item_10, NEW.ds_item_11, NEW.ds_item_12, NEW.ds_item_13,
					NEW.ds_item_14, NEW.ds_item_15, NEW.ds_item_16, NEW.ds_item_17, NEW.ds_item_18,
					NEW.ds_item_19, NEW.ds_item_20, NEW.ds_item_21, NEW.ds_item_22, NEW.ds_item_23);	
end if;

if (OLD.dt_inativacao is null) and (NEW.dt_inativacao is not null) then
	CALL send_nas_integration(NEW.nr_atendimento, NEW.nr_sequencia, NEW.dt_atualizacao, NEW.dt_avaliacao,
					NEW.dt_liberacao, NEW.ie_situacao, NEW.ds_item_1a, NEW.ds_item_1b,
					NEW.ds_item_1c, NEW.ds_item_2, NEW.ds_item_3, NEW.ds_item_4a, NEW.ds_item_4b,
					NEW.ds_item_4c, NEW.ds_item_5, NEW.ds_item_6a, NEW.ds_item_6b, NEW.ds_item_6c,
					NEW.ds_item_7a, NEW.ds_item_7b, NEW.ds_item_8a, NEW.ds_item_8b, NEW.ds_item_8c,
					NEW.ds_item_9, NEW.ds_item_10, NEW.ds_item_11, NEW.ds_item_12, NEW.ds_item_13,
					NEW.ds_item_14, NEW.ds_item_15, NEW.ds_item_16, NEW.ds_item_17, NEW.ds_item_18,
					NEW.ds_item_19, NEW.ds_item_20, NEW.ds_item_21, NEW.ds_item_22, NEW.ds_item_23);	
end if;

<<Final>>
qt_reg_w	:= 0;

  END;
RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_nas_atual() FROM PUBLIC;

CREATE TRIGGER escala_nas_atual
	BEFORE INSERT OR UPDATE ON escala_nas FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_nas_atual();

