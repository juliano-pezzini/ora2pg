-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS reg_customer_requirement_after ON reg_customer_requirement CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_reg_customer_requirement_after() RETURNS trigger AS $BODY$
declare

  ie_tipo_alteracao_w reg_customer_req_hist.ie_tipo_alteracao%type;

BEGIN

  if (OLD.dt_aprovacao is null and NEW.dt_aprovacao is not null) or (OLD.ie_situacao = 'I' and NEW.ie_situacao = 'A') then
    ie_tipo_alteracao_w := 'I';
  elsif (OLD.ie_situacao = 'A' and NEW.ie_situacao = 'I') then
    ie_tipo_alteracao_w := 'E';
  elsif (NEW.dt_aprovacao is not null) then
    ie_tipo_alteracao_w := 'A';
  end if;

  if (ie_tipo_alteracao_w is not null) then

    insert into reg_customer_req_hist(  
       nr_sequencia,
       cd_code,
       dt_atualizacao,
       nm_usuario,
       dt_atualizacao_nrec,
       nm_usuario_nrec,
       ds_title,
       dt_aprovacao,
       nr_seq_apresentacao,
       ie_situacao,
       cd_versao,       
       nr_seq_reg_version_rev,       
       nr_seq_features,       
       ds_descricao_cr,       
       nr_seq_customer_req,       
       ds_rationale,       
       nr_seq_estagio,       
       cd_crs_id,       
       nm_curto,      
       nm_liberacao_vv,      
       dt_liberacao_vv,       
       ie_tipo_alteracao,       
       ie_internal_feature,      
       dt_inativacao,       
       nm_usuario_inativacao,       
       ds_motivo_inativacao,
       ie_clinico,
       ds_racional_clinico,
       nm_usuario_aprovacao,
       dt_liberacao,
       nm_usuario_liberacao,
       dt_lancamento,
       nm_usuario_lancamento,
       nr_seq_analise_impacto)
    
    values (       
       nextval('reg_customer_req_hist_seq'),       
       NEW.cd_code,      
       NEW.dt_atualizacao,      
       NEW.nm_usuario,       
       NEW.dt_atualizacao_nrec,       
       NEW.nm_usuario_nrec,       
       NEW.ds_title,       
       NEW.dt_aprovacao,       
       NEW.nr_seq_apresentacao,       
       NEW.ie_situacao,       
       NEW.cd_versao,       
       null,       
       NEW.nr_seq_features,       
       NEW.ds_descricao_cr,       
       NEW.nr_sequencia,       
       NEW.ds_rationale,       
       NEW.nr_seq_estagio,      
       NEW.cd_crs_id,       
       NEW.nm_curto,       
       NEW.nm_liberacao_vv,       
       NEW.dt_liberacao_vv,       
       ie_tipo_alteracao_w,       
       NEW.ie_internal_feature,       
       NEW.dt_inativacao,       
       NEW.nm_usuario_inativacao,       
       NEW.ds_motivo_inativacao,
       NEW.ie_clinico,
       NEW.ds_racional_clinico,
       NEW.nm_usuario_aprovacao,
       NEW.dt_liberacao,
       NEW.nm_usuario_liberacao,
       NEW.dt_lancamento,
       NEW.nm_usuario_lancamento,
       NEW.nr_seq_analise_impacto);

  end if;

RETURN NEW;
end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_reg_customer_requirement_after() FROM PUBLIC;

CREATE TRIGGER reg_customer_requirement_after
	AFTER UPDATE ON reg_customer_requirement FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_reg_customer_requirement_after();

