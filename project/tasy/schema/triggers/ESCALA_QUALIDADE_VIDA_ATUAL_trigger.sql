-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS escala_qualidade_vida_atual ON escala_qualidade_vida CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_escala_qualidade_vida_atual() RETURNS trigger AS $BODY$
declare

	qt_questao_1_w	            real;
	qt_questao_3_w	            smallint;
	qt_questao_4_w	            smallint;
	qt_questao_5_w	            smallint;
	qt_questao_6_w	            smallint;
	qt_questao_7_w	            real;
	qt_questao_8_w	            real;
	qt_questao_9_vitalidade_w	smallint;
	qt_questao_9_saude_mental_w	smallint;
	qt_questao_10_w	            smallint;
	qt_questao_11_w	            smallint;
	qt_reg_w	                smallint;
	
	sql_w                         varchar(300);
	qt_capacidade_funcional_w     smallint;
	qt_limitacao_aspecto_fisico_w smallint;
	qt_dor_w                      smallint;
	qt_estado_geral_saude_w       smallint;
	qt_vitalidade_w               smallint;
	qt_aspectos_sociais_w         smallint;
	qt_aspectos_emocionais_w      smallint;
	qt_saude_mental_w             smallint;
	qt_pontuacao_w                bigint;
    ds_erro_w        varchar(4000);
    ds_parametros_w  varchar(4000);
BEGIN
  BEGIN

	if (NEW.nr_hora is null) or (NEW.dt_avaliacao <> OLD.dt_avaliacao) then 
		BEGIN  
		  NEW.nr_hora := (to_char(round(NEW.dt_avaliacao,'hh24'), 'hh24'))::numeric;
		end;
	end if;
	
	if (wheb_usuario_pck.get_ie_executar_trigger = 'N')  then
	  goto Final;
	end if;

	BEGIN
	  sql_w := 'call obter_score_escala_possum_1_md(:1) into :qt_questao_1_w';
	  EXECUTE sql_w using in NEW.ie_saude, out qt_questao_1_w;
	exception
	  when others then
	    qt_questao_1_w := null;
	end;

	BEGIN
	  sql_w := 'call obter_score_escala_possum_3_md(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10) into :qt_questao_3_w';
	  EXECUTE sql_w using in NEW.ie_atividade_rigorosa,
	                                in NEW.ie_atividade_moderada,
									in NEW.ie_levantar,
									in NEW.ie_subir_varios_lances,
									in NEW.ie_subir_um_lance,
									in NEW.ie_curvarse,
									in NEW.ie_andar_um_quilometro,
									in NEW.ie_andar_quarteiroes,
									in NEW.ie_andar_um_quarteirao,
									in NEW.ie_tomar_banho_vestirse,
	                                out qt_questao_3_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_atividade_rigorosa: '||NEW.ie_atividade_rigorosa||'-'||':new.ie_atividade_moderada: '||NEW.ie_atividade_moderada||'-'||':new.ie_levantar: '||NEW.ie_levantar||'-'||
                          ':new.ie_subir_varios_lances: '||NEW.ie_subir_varios_lances||'-'||':new.ie_subir_um_lance: '||NEW.ie_subir_um_lance||'-'||':new.ie_curvarse: '||NEW.ie_curvarse||'-'||
                          ':new.ie_andar_um_quilometro: '||NEW.ie_andar_um_quilometro||'-'||':new.ie_andar_quarteiroes: '||NEW.ie_andar_quarteiroes||'-'||':new.ie_andar_um_quarteirao: '||NEW.ie_andar_um_quarteirao||'-'||
                          ':new.ie_tomar_banho_vestirse: '||NEW.ie_tomar_banho_vestirse||'-'||'qt_questao_3_w: '||qt_questao_3_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','obter_score_escala_possum_3_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_questao_3_w := null;
	end;
	
	BEGIN
	  sql_w := 'call obter_score_escala_possum_4_md(:1, :2, :3, :4) into :qt_questao_4_w';
	  EXECUTE sql_w using in NEW.ie_diminui_trabalho_fisica,
	                                in NEW.ie_menos_tarefas_fisica,
									in NEW.ie_limit_trabalho_fisica,
									in NEW.ie_dific_trabalho_fisica,
	                                out qt_questao_4_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_diminui_trabalho_fisica: '||NEW.ie_diminui_trabalho_fisica||'-'||':new.ie_menos_tarefas_fisica: '||NEW.ie_menos_tarefas_fisica||'-'||
                          ':new.ie_limit_trabalho_fisica: '||NEW.ie_limit_trabalho_fisica||'-'||':new.ie_dific_trabalho_fisica: '||NEW.ie_dific_trabalho_fisica||'-'||'qt_questao_4_w: '||qt_questao_4_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','obter_score_escala_possum_4_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_questao_4_w := null;
	end;

	BEGIN
	  sql_w := 'call obter_score_escala_possum_5_md(:1, :2, :3) into :qt_questao_5_w';
	  EXECUTE sql_w using in NEW.ie_diminui_trabalho_emoc,
	                                in NEW.ie_menos_tarefas_emoc,
									in NEW.ie_ativ_cuidado,
	                                out qt_questao_5_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_diminui_trabalho_emoc: '||NEW.ie_diminui_trabalho_emoc||'-'||':new.ie_menos_tarefas_emoc: '||NEW.ie_menos_tarefas_emoc||'-'||
                          ':new.ie_ativ_cuidado: '||NEW.ie_ativ_cuidado||'-'||'qt_questao_5_w: '||qt_questao_5_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','obter_score_escala_possum_5_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_questao_5_w := null;
	end;

	BEGIN
	  sql_w := 'begin obter_scr_escala_possum_6_7_md(:1, :2, :3, :4); end;';
	  EXECUTE sql_w using in NEW.ie_atividades_sociais,
	                                in NEW.ie_dor_corpo,
	                                out qt_questao_6_w,
									out qt_questao_7_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_atividades_sociais: '||NEW.ie_atividades_sociais||'-'||':new.ie_dor_corpo: '||NEW.ie_dor_corpo||'-'||
                          'qt_questao_6_w: '||qt_questao_6_w||'-'||'qt_questao_7_w: '||qt_questao_7_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','obter_scr_escala_possum_6_7_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_questao_6_w := null;
		qt_questao_7_w := null;
	end;

	BEGIN
	  sql_w := 'call obter_score_escala_possum_8_md(:1, :2) into :qt_questao_8_w';
	  EXECUTE sql_w using in NEW.ie_dor_corpo,
	                                in NEW.ie_dor_trabalho,
	                                out qt_questao_8_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_dor_corpo: '||NEW.ie_dor_corpo||'-'||':new.ie_dor_trabalho: '||NEW.ie_dor_trabalho||'-'||
                          'qt_questao_8_w: '||qt_questao_8_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','obter_score_escala_possum_8_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_questao_8_w := null;
	end;
						
	BEGIN
	  sql_w := 'begin obter_score_escala_possum_9_md(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11); end;';
	  EXECUTE sql_w using in NEW.ie_vigor,
	                                in NEW.ie_energia,									
									in NEW.ie_esgotado,
	                                in NEW.ie_cansado,									
									in NEW.ie_nervosa,
	                                in NEW.ie_deprimido,									
									in NEW.ie_calmo,
	                                in NEW.ie_desanimado,									
									in NEW.ie_feliz,									
	                                out qt_questao_9_vitalidade_w,
									out qt_questao_9_saude_mental_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_vigor: '||NEW.ie_vigor||'-'||':new.ie_energia: '||NEW.ie_energia||'-'||':new.ie_esgotado: '||NEW.ie_esgotado||'-'||
                          ':new.ie_cansado: '||NEW.ie_cansado||'-'||':new.ie_nervosa: '||NEW.ie_nervosa||'-'||':new.ie_deprimido: '||NEW.ie_deprimido||'-'||
                          ':new.ie_calmo: '||NEW.ie_calmo||'-'||':new.ie_desanimado: '||NEW.ie_desanimado||'-'||':new.ie_feliz: '||NEW.ie_feliz||'-'||
                          'qt_questao_9_vitalidade_w: '||qt_questao_9_vitalidade_w||'-'||'qt_questao_9_saude_mental_w: '||qt_questao_9_saude_mental_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','obter_score_escala_possum_9_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_questao_9_vitalidade_w := null;
		qt_questao_9_saude_mental_w := null;
	end;
					
	BEGIN
	  sql_w := 'begin obter_scr_escal_possum_1011_md(:1, :2, :3, :4, :5, :6, :7); end;';
	  EXECUTE sql_w using in NEW.ie_tempo_atividades,
	                                in NEW.ie_obedece_facilmente,									
									in NEW.ie_saudavel_outros,
	                                in NEW.ie_saude_piorar,									
									in NEW.ie_saude_excelente,									
	                                out qt_questao_10_w,
									out qt_questao_11_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.ie_tempo_atividades: '||NEW.ie_tempo_atividades||'-'||':new.ie_obedece_facilmente: '||NEW.ie_obedece_facilmente||'-'||':new.ie_saudavel_outros: '||NEW.ie_saudavel_outros||'-'||
                          ':new.ie_saude_piorar: '||NEW.ie_saude_piorar||'-'||':new.ie_saude_excelente: '||NEW.ie_saude_excelente||'-'||'qt_questao_10_w: '||qt_questao_10_w||'-'||
                          'qt_questao_11_w: '||qt_questao_11_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','obter_scr_escal_possum_1011_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_questao_10_w := null;
		qt_questao_11_w := null;
	end;


	BEGIN
	  sql_w := 'call calcular_capacid_funcional_md(:1) into :qt_capacidade_funcional_w';
	  EXECUTE sql_w using in qt_questao_3_w,
	                                out qt_capacidade_funcional_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                         'qt_questao_3_w: '||qt_questao_3_w||'-'||'qt_capacidade_funcional_w: '||qt_capacidade_funcional_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','calcular_capacid_funcional_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_capacidade_funcional_w := null;	
	end;
	NEW.qt_capacidade_funcional := qt_capacidade_funcional_w;
	
	BEGIN
	  sql_w := 'call calcular_limit_aspec_fisic_md(:1) into :qt_limitacao_aspecto_fisico_w';
	  EXECUTE sql_w using in qt_questao_4_w,
	                                out qt_limitacao_aspecto_fisico_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                         'qt_questao_4_w: '||qt_questao_4_w||'-'||'qt_limitacao_aspecto_fisico_w: '||qt_limitacao_aspecto_fisico_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','calcular_limit_aspec_fisic_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_limitacao_aspecto_fisico_w := null;	
	end;
	NEW.qt_limitacao_aspecto_fisico := qt_limitacao_aspecto_fisico_w;
	
	BEGIN
	  sql_w := 'call calcular_quantidade_dor_md(:1, :2) into :qt_dor_w';
	  EXECUTE sql_w using in qt_questao_7_w,
	                                in qt_questao_8_w,
	                                out qt_dor_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                         'qt_questao_7_w: '||qt_questao_7_w||'-'||'qt_questao_8_w: '||qt_questao_8_w||'-'||'qt_dor_w: '||qt_dor_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','calcular_quantidade_dor_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_dor_w := null;	
	end;
	NEW.qt_dor := qt_dor_w;
	
	BEGIN
	  sql_w := 'call calcular_estado_saude_md(:1, :2) into :qt_estado_geral_saude_w';
	  EXECUTE sql_w using in qt_questao_1_w,
	                                in qt_questao_11_w,
	                                out qt_estado_geral_saude_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                         'qt_questao_1_w: '||qt_questao_1_w||'-'||'qt_questao_11_w: '||qt_questao_11_w||'-'||'qt_estado_geral_saude_w: '||qt_estado_geral_saude_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','calcular_estado_saude_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');

	    qt_estado_geral_saude_w := null;	
	end;
	NEW.qt_estado_geral_saude := qt_estado_geral_saude_w;
	
	BEGIN
	  sql_w := 'call calcular_vitalidade_md(:1) into :qt_vitalidade_w';
	  EXECUTE sql_w using in qt_questao_9_vitalidade_w,
	                                out qt_vitalidade_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                         'qt_questao_9_vitalidade_w: '||qt_questao_9_vitalidade_w||'-'||'qt_vitalidade_w: '||qt_vitalidade_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','calcular_vitalidade_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_vitalidade_w := null;	
	end;
	NEW.qt_vitalidade := qt_vitalidade_w;
	
	BEGIN
	  sql_w := 'call calcular_aspectos_social_md(:1, :2) into :qt_aspectos_sociais_w';
	  EXECUTE sql_w using in qt_questao_6_w,
	                                in qt_questao_10_w,
	                                out qt_aspectos_sociais_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                         'qt_questao_6_w: '||qt_questao_6_w||'-'||'qt_questao_10_w: '||qt_questao_10_w||'-'||'qt_aspectos_sociais_w: '||qt_aspectos_sociais_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','calcular_aspectos_social_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_aspectos_sociais_w := null;	
	end;
	NEW.qt_aspectos_sociais := qt_aspectos_sociais_w;
	
	BEGIN
	  sql_w := 'call calcular_aspectos_emocional_md(:1) into :qt_aspectos_emocionais_w';
	  EXECUTE sql_w using in qt_questao_5_w,
	                                out qt_aspectos_emocionais_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                         'qt_questao_5_w: '||qt_questao_5_w||'-'||'qt_aspectos_emocionais_w: '||qt_aspectos_emocionais_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','calcular_aspectos_emocional_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_aspectos_emocionais_w := null;	
	end;
	NEW.qt_aspectos_emocionais := qt_aspectos_emocionais_w;
	
	BEGIN
	  sql_w := 'call calcular_saude_mental_md(:1) into :qt_saude_mental_w';
	  EXECUTE sql_w using in qt_questao_9_saude_mental_w,
	                                out qt_saude_mental_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                         'qt_questao_9_saude_mental_w: '||qt_questao_9_saude_mental_w||'-'||'qt_saude_mental_w: '||qt_saude_mental_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','calcular_saude_mental_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');

	    qt_saude_mental_w := null;	
	end;
	NEW.qt_saude_mental := qt_saude_mental_w;
	
	BEGIN
	  sql_w := 'call calcular_pontuacao_total_md(:1, :2, :3, :4, :5, :6, :7, :8) into :qt_pontuacao_w';
	  EXECUTE sql_w using in NEW.qt_capacidade_funcional,
	                                in NEW.qt_limitacao_aspecto_fisico,
									in NEW.qt_dor,
									in NEW.qt_estado_geral_saude,
									in NEW.qt_vitalidade,
									in NEW.qt_aspectos_sociais,
									in NEW.qt_aspectos_emocionais,
									in NEW.qt_saude_mental,
	                                out qt_pontuacao_w;
	exception
	  when others then
      ds_erro_w := sqlerrm;
      ds_parametros_w := (':new.nr_atendimento: '||NEW.nr_atendimento||'-'||':new.cd_profissional: '||NEW.cd_profissional||'-'||':new.ie_situacao: '||NEW.ie_situacao||'-'||
                          ':new.qt_capacidade_funcional: '||NEW.qt_capacidade_funcional||'-'||':new.qt_limitacao_aspecto_fisico: '||NEW.qt_limitacao_aspecto_fisico||'-'||':new.qt_dor: '||NEW.qt_dor||'-'||
                          ':new.qt_estado_geral_saude: '||NEW.qt_estado_geral_saude||'-'||':new.qt_vitalidade: '||NEW.qt_vitalidade||'-'||':new.qt_aspectos_sociais: '||NEW.qt_aspectos_sociais||'-'||
                          ':new.qt_aspectos_emocionais: '||NEW.qt_aspectos_emocionais||'-'||':new.qt_saude_mental: '||NEW.qt_saude_mental||'-'||
                          'qt_pontuacao_w: '||qt_pontuacao_w);

      CALL gravar_log_medical_device('escala_qualidade_vida_atual','calcular_pontuacao_total_md'
                                 ,ds_parametros_w,substr(ds_erro_w, 4000),NEW.nm_usuario,'N');
      
	    qt_pontuacao_w := null;	
	end;
	NEW.qt_pontuacao := qt_pontuacao_w;
	
	<<Final>>
	qt_reg_w	:= 0;

  END;
RETURN NEW;
end
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_escala_qualidade_vida_atual() FROM PUBLIC;

CREATE TRIGGER escala_qualidade_vida_atual
	BEFORE INSERT OR UPDATE ON escala_qualidade_vida FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_escala_qualidade_vida_atual();

