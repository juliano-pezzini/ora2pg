-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS valida_dt_vig_banco_classif ON banco_classif CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_valida_dt_vig_banco_classif() RETURNS trigger AS $BODY$
DECLARE
subtype                     nr_seq_reg_size is smallint;
ie_reg_w	                  nr_seq_reg_size;
dt_vigencia_indeterminada_w BANCO_CLASSIF.dt_inicio_vigencia%TYPE;
dt_fim_vigencia_max_w       BANCO_CLASSIF.dt_fim_vigencia%TYPE;

pragma autonomous_transaction;
BEGIN

IF (wheb_usuario_pck.get_ie_executar_trigger = 'S') THEN
  IF (NEW.dt_fim_vigencia IS NOT NULL AND NEW.dt_fim_vigencia < NEW.dt_inicio_vigencia) THEN
    CALL wheb_mensagem_pck.exibir_mensagem_abort(449902);		
  END IF;

  SELECT max(dt_fim_vigencia)
  INTO STRICT   dt_fim_vigencia_max_w
  FROM   BANCO_CLASSIF a
  WHERE  a.nr_sequencia <> NEW.nr_sequencia
  AND    a.cd_banco = NEW.cd_banco;

  SELECT max(dt_inicio_vigencia)
  INTO STRICT   dt_vigencia_indeterminada_w
  FROM   BANCO_CLASSIF a
  WHERE  a.nr_sequencia <> NEW.nr_sequencia
  AND    dt_fim_vigencia IS NULL
  AND    a.cd_banco = NEW.cd_banco;

  SELECT
      CASE WHEN EXISTS(
        SELECT   a.NR_SEQUENCIA
        FROM     BANCO_CLASSIF a
        WHERE    a.nr_sequencia <> NEW.nr_sequencia
        AND      ((NEW.dt_fim_vigencia IS NOT NULL
        AND (a.dt_inicio_vigencia BETWEEN NEW.dt_inicio_vigencia AND NEW.dt_fim_vigencia
        OR       a.dt_fim_vigencia BETWEEN NEW.dt_inicio_vigencia AND NEW.dt_fim_vigencia)
        OR       NEW.dt_inicio_vigencia > dt_vigencia_indeterminada_w)
        OR (NEW.dt_fim_vigencia IS NULL AND (NEW.dt_inicio_vigencia < dt_fim_vigencia_max_w
        OR       dt_vigencia_indeterminada_w IS NOT NULL))) AND a.cd_banco = NEW.cd_banco)
      THEN 1 ELSE 0
      END
  INTO STRICT ie_reg_w;

  IF (ie_reg_w = 1) THEN
    CALL wheb_mensagem_pck.exibir_mensagem_abort(1099887);
  END IF;

END IF;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_valida_dt_vig_banco_classif() FROM PUBLIC;

CREATE TRIGGER valida_dt_vig_banco_classif
	BEFORE INSERT OR UPDATE ON banco_classif FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_valida_dt_vig_banco_classif();

