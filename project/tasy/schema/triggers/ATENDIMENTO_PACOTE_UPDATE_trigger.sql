-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atendimento_pacote_update ON atendimento_pacote CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atendimento_pacote_update() RETURNS trigger AS $BODY$
declare

ie_status_acerto_w	bigint;
ds_module_log_w		varchar(255);
ds_call_stack_w		varchar(2000);

BEGIN

if (NEW.dt_inicio_pacote <> OLD.dt_inicio_pacote) then

	select	max(b.ie_status_acerto)
	into STRICT	ie_status_acerto_w
	from	procedimento_paciente a,
		conta_paciente b
	where	a.nr_interno_conta	= b.nr_interno_conta
	and	a.nr_sequencia 		= NEW.nr_seq_procedimento;

	update 	procedimento_paciente
	set 	dt_conta = NEW.dt_inicio_pacote,
		dt_procedimento = NEW.dt_inicio_pacote
	where 	nr_sequencia = NEW.nr_seq_procedimento
	and	ie_status_acerto_w	= 1;

	/*insert into log_tasy	(	dt_atualizacao,
					nm_usuario,
					cd_log,
					ds_log)
		values		(	sysdate,
					:new.nm_usuario,
					66123,
					'Alterando a data do pacote de: '||
					to_char(:old.dt_inicio_pacote,'dd/mm/yyyy hh24:mi:ss') ||
					' Para : '||to_char(:new.dt_inicio_pacote,'dd/mm/yyyy hh24:mi:ss'));*/
end if;

if (coalesce(NEW.nr_seq_procedimento,0) <> coalesce(OLD.nr_seq_procedimento,0)) then

	select	substr(max(module||' - ' || machine||' - ' || program|| ' - ' || osuser|| ' - ' || terminal),1,255)
	into STRICT	ds_module_log_w
	from	v$session
	where	audsid = (SELECT userenv('sessionid') );

	ds_call_stack_w	:= substr(dbms_utility.format_call_stack,1,1800);

	insert into proc_pac_log(dt_atualizacao,
		dt_atualizacao_nrec,
		ie_acao,
		nm_usuario,
		nm_usuario_nrec,
		nr_atendimento,
		nr_seq_propaci,
		nr_sequencia,
		qt_procedimento,
		ds_observacao,
		ds_call_stack,
		ds_module)
	values (LOCALTIMESTAMP,
		LOCALTIMESTAMP,
		'AP',
		NEW.nm_usuario,
		NEW.nm_usuario,
		NEW.nr_atendimento,
		NEW.nr_seq_procedimento,
		nextval('proc_pac_log_seq'),
		0,
		--'Alterado o número de sequencia do procedimento pacote, dentro do próprio pacote.',
		WHEB_MENSAGEM_PCK.get_texto(298660),
		'OLD= ' || OLD.nr_seq_procedimento || chr(10) || chr(13) || ds_call_stack_w,
		ds_module_log_w);

end if;

RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atendimento_pacote_update() FROM PUBLIC;

CREATE TRIGGER atendimento_pacote_update
	BEFORE UPDATE ON atendimento_pacote FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atendimento_pacote_update();

