-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS nota_fiscal_venc_trib_delete ON nota_fiscal_venc_trib CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_nota_fiscal_venc_trib_delete() RETURNS trigger AS $BODY$
declare
PRAGMA AUTONOMOUS_TRANSACTION;
ds_benefic_w	varchar(80);
dt_emissao_w	timestamp;
vl_vencimento_w	double precision;
ds_tributo_w	varchar(40);
dt_vencimento_w	timestamp;
 
BEGIN 
 
select	substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,80), 
	b.dt_emissao, 
	a.dt_vencimento, 
	a.vl_vencimento 
into STRICT	ds_benefic_w, 
	dt_emissao_w, 
	dt_vencimento_w, 
	vl_vencimento_w 
from	nota_fiscal b, 
	nota_fiscal_venc a 
where	a.nr_sequencia	= b.nr_sequencia 
and	a.nr_sequencia	= OLD.nr_sequencia 
and	a.dt_vencimento	= OLD.dt_vencimento;
 
select	ds_tributo 
into STRICT	ds_tributo_w 
from	tributo 
where	cd_tributo = OLD.cd_tributo;
 
/*insert	into log__tasy 
	(dt_atualizacao, 
	nm_usuario, 
	cd_log, 
	ds_log) 
values	(sysdate, 
	'Tasy', 
	5800, 
	'Pessoa nota: ' || ds_benefic_w || chr(13) || 
	'Emissão: ' || dt_emissao_w || chr(13) || 
	'Vencimento: ' || dt_vencimento_w || chr(13) || 
	'Dt criação tributo: ' || to_char(:old.dt_atualizacao_nrec,'dd/mm/yyyy hh24:mi:ss') || chr(13) || 
	'Valor vencimento: ' || vl_vencimento_w || chr(13) || 
	'Tributo: ' || ds_tributo_w || chr(13) || 
	'Valor tributo ' || :old.vl_tributo);*/
 
 
 
commit;
RETURN OLD;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_nota_fiscal_venc_trib_delete() FROM PUBLIC;

CREATE TRIGGER nota_fiscal_venc_trib_delete
	BEFORE DELETE ON nota_fiscal_venc_trib FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_nota_fiscal_venc_trib_delete();

