-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS atend_categ_convenio_delete ON atend_categoria_convenio CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_atend_categ_convenio_delete() RETURNS trigger AS $BODY$
DECLARE

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then

	insert	into	log_exclusao(
					nm_tabela,
					dt_atualizacao,
					nm_usuario,
					ds_chave
					)
				values (
					'ATEND_CATEGORIA_CONVENIO',
					LOCALTIMESTAMP,
					OLD.nm_usuario,
					substr('Cascade atendimento_paciente:'									||
					' NR_ATENDIMENTO= '	|| OLD.nr_atendimento							||
					' CD_CONVENIO= ' 	|| OLD.cd_convenio								||
					' CD_CATEGORIA= '	|| OLD.cd_categoria								||
					' DT_INICIO_VIGENCIA= ' || to_char(OLD.dt_inicio_vigencia,'dd/mm/yyyy hh24:mi:ss')	||
					' DS_CONVENIO= '	|| substr(obter_nome_convenio(OLD.cd_convenio),1,40),1,255)
					);
					
	if (OLD.ie_tipo_conveniado = 6) then
		delete from atend_convenio_end_cob where nr_atendimento = OLD.nr_atendimento;
	end if;
			
end if;
	
RETURN OLD;
END;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_atend_categ_convenio_delete() FROM PUBLIC;

CREATE TRIGGER atend_categ_convenio_delete
	BEFORE DELETE ON atend_categoria_convenio FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_atend_categ_convenio_delete();

