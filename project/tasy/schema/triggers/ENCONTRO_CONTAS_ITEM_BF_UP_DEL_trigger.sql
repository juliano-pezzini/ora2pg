-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS encontro_contas_item_bf_up_del ON encontro_contas_item CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_encontro_contas_item_bf_up_del() RETURNS trigger AS $BODY$
declare
ie_possui_baixa_w		bigint := 0;
nr_seq_lote_enc_contas_w	bigint;

BEGIN

if (wheb_usuario_pck.get_ie_executar_trigger = 'S') then
if (NEW.nr_titulo_receber is null) or (NEW.nr_titulo_pagar is null) Then

	select	b.nr_seq_lote
	into STRICT	nr_seq_lote_enc_contas_w
	from	pessoa_encontro_contas b
	where	b.nr_sequencia		= OLD.nr_seq_pessoa;

	if (OLD.nr_titulo_receber is not null) and (OLD.nr_titulo_receber <> coalesce(NEW.nr_titulo_receber, 0))then
		/*select	count(1)
		into	ie_possui_baixa_w
		from	titulo_receber_liq a
		where	a.nr_titulo			= :old.nr_titulo_receber
		and	a.nr_seq_lote_enc_contas 	= nr_seq_lote_enc_contas_w
		and	rownum <= 1;*/

		
		SELECT	COUNT(*)
		INTO STRICT	ie_possui_baixa_w
		FROM	titulo_receber_liq a
		WHERE	a.nr_titulo			= OLD.nr_titulo_receber
		AND	a.nr_seq_lote_enc_contas 	= nr_seq_lote_enc_contas_w
		AND	    	NOT EXISTS (	SELECT 1 -- AAMFIRMO OS 658286 Inclui para nao considerar baixas que possuem estorno.
						FROM	 	titulo_receber_liq x
						WHERE  		x.nr_titulo = a.nr_titulo
						AND    		x.nr_seq_lote_enc_contas = nr_seq_lote_enc_contas_w
						AND    		x.nr_seq_liq_origem IS NOT NULL)  LIMIT 1;
		
		
	elsif (OLD.nr_titulo_pagar is not null) and (OLD.nr_titulo_pagar <> coalesce(NEW.nr_titulo_pagar, 0)) then
		/*select	count(1)
		into	ie_possui_baixa_w
		from	titulo_pagar_baixa a
		where	a.nr_titulo 			= :old.nr_titulo_receber
		and	a.nr_seq_lote_enc_contas 	= nr_seq_lote_enc_contas_w
		and	rownum <= 1;*/

		
		SELECT	COUNT(*)
		INTO STRICT	ie_possui_baixa_w
		FROM	titulo_pagar_baixa a
		WHERE	a.nr_titulo			= OLD.nr_titulo_pagar
		AND	a.nr_seq_lote_enc_contas 	= nr_seq_lote_enc_contas_w
		AND	    	NOT EXISTS (	SELECT 1 -- AAMFIRMO OS 658286 Inclui para nao considerar baixas que possuem estorno.
						FROM	 	titulo_pagar_baixa x
						WHERE  		x.nr_titulo = a.nr_titulo
						AND    		x.nr_seq_lote_enc_contas = nr_seq_lote_enc_contas_w
						AND    		x.nr_seq_baixa_origem IS NOT NULL)  LIMIT 1;				
	end if;

	if (ie_possui_baixa_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(211087);
	end if;
end if;
end if;
IF TG_OP = 'DELETE' THEN
	RETURN OLD;
ELSE
	RETURN NEW;
END IF;

end;
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_encontro_contas_item_bf_up_del() FROM PUBLIC;

CREATE TRIGGER encontro_contas_item_bf_up_del
	BEFORE UPDATE OR DELETE ON encontro_contas_item FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_encontro_contas_item_bf_up_del();

