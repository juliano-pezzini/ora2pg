-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

DROP TRIGGER IF EXISTS pessoa_domicilio_moradia_after ON pessoa_domicilio_moradia CASCADE;
CREATE OR REPLACE FUNCTION trigger_fct_pessoa_domicilio_moradia_after() RETURNS trigger AS $BODY$
DECLARE CD_MEDICO_W varchar(100);
NR_SEQ_EQUIPE_W  bigint;
NR_SEQ_AREA_W  bigint;

BEGIN

	SELECT coalesce(MAX(NR_SEQ_AREA),0)
		INTO STRICT NR_SEQ_AREA_W
			FROM DOMICILIO_FAMILIA
			WHERE NR_SEQUENCIA = NEW.NR_SEQ_DOMICILIO;

	IF (NR_SEQ_AREA_W > 0) THEN

		SELECT coalesce(MAX(NR_SEQ_EQUIPE),0)
			INTO STRICT NR_SEQ_EQUIPE_W
			FROM PSF_AREA
			WHERE NR_SEQUENCIA = NR_SEQ_AREA_W;

		IF (NR_SEQ_EQUIPE_W > 0) THEN

			SELECT MAX(CD_PESSOA_FISICA)
				INTO STRICT CD_MEDICO_W
				FROM PF_EQUIPE
				WHERE NR_SEQUENCIA = NR_SEQ_EQUIPE_W;
			IF (CD_MEDICO_W > 0) THEN

				IF CD_MEDICO_W IS NOT NULL THEN
					UPDATE PESSOA_FISICA
						SET DT_ATUALIZACAO = LOCALTIMESTAMP,
						NM_USUARIO = WHEB_USUARIO_PCK.GET_NM_USUARIO,
						CD_MEDICO = CD_MEDICO_W
					WHERE CD_PESSOA_FISICA = NEW.CD_PESSOA_FISICA;
				END IF;
			END IF;
		END IF;
	END IF;
RETURN NEW;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION trigger_fct_pessoa_domicilio_moradia_after() FROM PUBLIC;

CREATE TRIGGER pessoa_domicilio_moradia_after
	AFTER INSERT OR UPDATE ON pessoa_domicilio_moradia FOR EACH ROW
	EXECUTE PROCEDURE trigger_fct_pessoa_domicilio_moradia_after();

