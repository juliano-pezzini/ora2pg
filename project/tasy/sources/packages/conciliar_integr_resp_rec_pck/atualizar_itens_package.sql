-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE conciliar_integr_resp_rec_pck.atualizar_itens () AS $body$
DECLARE

current_setting('conciliar_integr_resp_rec_pck.i')::integer integer := 0;
ie_status_protocolo_w	imp_resp_recurso_prot.ie_status%type;
ie_status_guia_w	imp_resp_recurso_guia.ie_status%type;

BEGIN
if (current_setting('conciliar_integr_resp_rec_pck.campos_itens_w')::campos_itens_v.count > 0) then
	FOR current_setting('conciliar_integr_resp_rec_pck.i')::integer IN 0..campos_itens_w.count - 1 LOOP
        /*
			nfcunha - OS 2466841 - 11/Jun/2021
			Atualizar item conforme status da tabela superior.
		*/


		select 	max(x.ie_status)
		into STRICT	ie_status_guia_w
		from 	imp_resp_recurso_guia x 
		where 	x.nr_sequencia = current_setting('conciliar_integr_resp_rec_pck.campos_itens_w')::campos_itens_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).nr_seq_res_rec_guia;

		if	ie_status_guia_w <> 'C' then
			current_setting('conciliar_integr_resp_rec_pck.campos_itens_w')::campos_itens_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).ie_status := ie_status_guia_w;
		end if;

		select 	max(x.ie_status)
		into STRICT	ie_status_guia_w
		from 	imp_resp_recurso_guia x 
		where 	x.nr_sequencia = current_setting('conciliar_integr_resp_rec_pck.campos_itens_w')::campos_itens_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).nr_seq_res_rec_guia;

		if	ie_status_guia_w <> 'C' then
			current_setting('conciliar_integr_resp_rec_pck.campos_itens_w')::campos_itens_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).ie_status := ie_status_guia_w;
		end if;

		update	imp_resp_recurso_item
		set	dt_atualizacao 		    = clock_timestamp(),
			nm_usuario     		    = 'Integration',
			ie_status      		    = current_setting('conciliar_integr_resp_rec_pck.campos_itens_w')::campos_itens_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).ie_status
		where	nr_seq_res_rec_guia = current_setting('conciliar_integr_resp_rec_pck.campos_itens_w')::campos_itens_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).NR_SEQ_RES_REC_GUIA
		and     nr_sequencia   		= current_setting('conciliar_integr_resp_rec_pck.campos_itens_w')::campos_itens_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).nr_sequencia;

		current_setting('conciliar_integr_resp_rec_pck.campos_itens_w')::campos_itens_v.delete(current_setting('conciliar_integr_resp_rec_pck.i')::integer);

	END LOOP;
end if;
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE conciliar_integr_resp_rec_pck.atualizar_itens () FROM PUBLIC;
