-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE conciliar_integr_resp_rec_pck.gerar_itens_sem_resposta () AS $body$
DECLARE

current_setting('conciliar_integr_resp_rec_pck.i')::integer integer;

nr_seq_analise_antiga_w		lote_audit_hist_guia.nr_Sequencia%type;
nr_seq_analise_atual_w		lote_audit_hist_guia.nr_Sequencia%type;
nr_seq_guia_w			lote_audit_hist_guia.nr_sequencia%type;

c_lote_audit_hist_guia CURSOR FOR
SELECT	l.nr_sequencia nr_Seq_guia_antiga,
	coalesce((obter_saldo_conpaci(l.nr_interno_conta,l.cd_autorizacao))::numeric ,0) vl_saldo
from 	lote_audit_hist_guia l
where 	exists (SELECT	1 from lote_audit_hist_item x where x.nr_seq_guia = l.nr_sequencia and x.ie_acao_glosa <> 'A')
and 	l.nr_seq_lote_hist = nr_seq_analise_antiga_w
and 	(obter_saldo_conpaci(l.nr_interno_conta,l.cd_autorizacao))::numeric  > 0
and 	not exists (	select 	1 
			from 	lote_audit_hist_guia la
			where 	la.nr_seq_lote_hist = nr_seq_analise_atual_w
			and 	la.nr_interno_conta = l.nr_interno_conta
			and 	la.cd_autorizacao = l.cd_autorizacao);


c_lote_audit_hist_guia_w c_lote_audit_hist_guia%rowtype;


BEGIN
if (current_setting('conciliar_integr_resp_rec_pck.campos_guia_w')::campos_guia_v.count > 0) then
	for current_setting('conciliar_integr_resp_rec_pck.i')::integer in current_setting('conciliar_integr_resp_rec_pck.campos_guia_w')::campos_guia_v.first .. current_setting('conciliar_integr_resp_rec_pck.campos_guia_w')::campos_guia_v.last loop

		if (current_setting('conciliar_integr_resp_rec_pck.campos_guia_w')::campos_guia_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).ie_status = 'C') and (current_setting('conciliar_integr_resp_rec_pck.campos_guia_w')::campos_guia_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).nr_seq_analise_antiga > 0) and (current_setting('conciliar_integr_resp_rec_pck.campos_guia_w')::campos_guia_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).nr_seq_analise_atual > 0)then

			nr_seq_analise_antiga_w  := current_setting('conciliar_integr_resp_rec_pck.campos_guia_w')::campos_guia_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).nr_seq_analise_antiga;
			nr_seq_analise_atual_w  := current_setting('conciliar_integr_resp_rec_pck.campos_guia_w')::campos_guia_v(current_setting('conciliar_integr_resp_rec_pck.i')::integer).nr_seq_analise_antiga;

			for c_lote_audit_hist_guia_w in c_lote_audit_hist_guia loop


				select	nextval('lote_audit_hist_guia_seq')
				into STRICT	nr_seq_guia_w
				;


				insert	into lote_audit_hist_guia(cd_autorizacao,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					nr_interno_conta,
					nr_seq_lote_hist,
					nr_sequencia,
					nr_seq_retorno,
					ie_guia_sem_saldo,
					vl_saldo_guia,
					ie_guia_sem_resposta,
					dt_integracao,
					dt_pagamento)
				SELECT	a.cd_autorizacao,
					clock_timestamp(),
					clock_timestamp(),
					'Integration',
					'Integration',
					a.nr_interno_conta,
					nr_seq_analise_atual_w,
					nr_seq_guia_w,
					null,
					a.ie_guia_sem_saldo,
					c_lote_audit_hist_guia_w.vl_saldo,
					'S',
					clock_timestamp(),
					dt_pagamento
				from	lote_audit_hist_guia a
				where	nr_sequencia	= c_lote_audit_hist_guia_w.nr_seq_guia_antiga;

				insert	into lote_audit_hist_item(nr_sequencia,
					 dt_atualizacao,
					 nm_usuario,
					 dt_atualizacao_nrec,
					 nm_usuario_nrec,
					 nr_seq_lote,
					 nr_seq_conpaci_ret,
					 dt_historico,
					 vl_historico,
					 nr_seq_hist_audit,
					 nr_seq_ret_item,
					 ds_observacao,
					 dt_reapresentacao,
					 dt_receb_prev,
					 cd_motivo_glosa,
					 cd_processo_receb,
					 cd_resposta,
					 nr_seq_ret_glosa,
					 ie_status,
					 vl_pago,
					 vl_saldo,
					 nr_seq_guia,
					 nr_seq_propaci,
					 nr_seq_matpaci,
					 vl_glosa,
					 vl_amenor,
					 qt_item,
					 nr_seq_matpaci_partic,
					 cd_setor_responsavel,
					 ie_acao_glosa,
					 vl_saldo_amenor,
					 vl_glosa_informada,
					 ds_complemento,
					 vl_adicional,
					 nr_seq_partic,
					 ie_ajustado,
					 ie_tipo_glosa,
					 ie_pago_convenio,
					 cd_motivo_glosa_tiss,
					 cd_material_atend_paciente,
					 cd_material_atend_tiss,
					 cd_item_conversao,
					 cd_procedimento_pac,
					 ie_origem_proced_pac,
					 dt_item,
					 dt_conta_item,
					 cd_setor_atendimento,
					 cd_autorizacao,
					 nr_interno_conta,
					 cd_item_tuss,
					 ie_forma_agrupamento,
					 vl_acatado,
					 ds_justificativa_oper,
					 ie_item_sem_resposta,
					 nr_doc_conv_item_conta,
					 nr_atendimento_item,
					 cd_pessoa_fisica_item,
					 nm_pessoa_fisica_item,
					 ds_item_convenio,
					 ds_item_tiss,
					 ds_item_tuss,
					 dt_integracao)
				SELECT	nextval('lote_audit_hist_item_seq') seq,
					clock_timestamp(),
					'Integration',
					clock_timestamp(),
					'Integration',
					nr_seq_analise_atual_w,
					l.nr_seq_conpaci_ret,
					l.dt_historico,
					l.vl_historico,
					l.nr_seq_hist_audit,
					l.nr_seq_ret_item,
					l.ds_observacao,
					l.dt_reapresentacao,
					l.dt_receb_prev,
					l.cd_motivo_glosa,
					l.cd_processo_receb,
					l.cd_resposta,
					l.nr_seq_ret_glosa,
					l.ie_status,
					l.vl_pago,
					l.vl_saldo,
					nr_seq_guia_w,
					l.nr_seq_propaci,
					l.nr_seq_matpaci,
					l.vl_glosa,
					l.vl_amenor,
					l.qt_item,
					l.nr_seq_matpaci_partic,
					l.cd_setor_responsavel,
					l.ie_acao_glosa,
					l.vl_saldo_amenor,
					l.vl_glosa_informada,
					l.ds_complemento,
					l.vl_adicional,
					l.nr_seq_partic,
					l.ie_ajustado,
					l.ie_tipo_glosa,
					l.ie_pago_convenio,
					l.cd_motivo_glosa_tiss,
					l.cd_material_atend_paciente,
					l.cd_material_atend_tiss,
					l.cd_item_conversao,
					l.cd_procedimento_pac,
					l.ie_origem_proced_pac,
					l.dt_item,
					l.dt_conta_item,
					l.cd_setor_atendimento,
					l.cd_autorizacao,
					l.nr_interno_conta,
					l.cd_item_tuss,
					l.ie_forma_agrupamento,
					l.vl_acatado,
					l.ds_justificativa_oper,
					'S',
					l.nr_doc_conv_item_conta,
					l.nr_atendimento_item,
					l.cd_pessoa_fisica_item,
					l.nm_pessoa_fisica_item,
					l.ds_item_convenio,
					l.ds_item_tiss,
					l.ds_item_tuss,
					clock_timestamp()
				from	lote_audit_hist_item l
				where 	l.nr_seq_guia = c_lote_audit_hist_guia_w.nr_seq_guia_antiga
				and     l.ie_acao_glosa in ('R','P');


			end loop;

		end if;

	end loop;
end if;
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE conciliar_integr_resp_rec_pck.gerar_itens_sem_resposta () FROM PUBLIC;
