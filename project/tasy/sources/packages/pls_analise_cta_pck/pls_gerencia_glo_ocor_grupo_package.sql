-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Essa rotina foi criada para gerenciar a atualiza??o das ocorr?ncias da an?lise no que se refere aos grupos. Acredito que no futuro a rotina PLS_GERAR_FLUXO_AUDIT_ITEM deve ser mesclada com ela.



CREATE OR REPLACE PROCEDURE pls_analise_cta_pck.pls_gerencia_glo_ocor_grupo ( nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_grupo_atual_p pls_auditoria_conta_grupo.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_fluxo_p pls_analise_fluxo_item.nr_sequencia%type, ie_finalizacao_p pls_analise_glo_ocor_grupo.ie_finalizacao%type default null, nr_seq_conta_glosa_p pls_analise_glo_ocor_grupo.nr_seq_conta_glosa%type default null, ie_fluxo_gerado_p pls_analise_glo_ocor_grupo.ie_fluxo_gerado%type default 'S') AS $body$
DECLARE


qt_fluxo_w  integer;
ie_status_w pls_analise_glo_ocor_grupo.ie_status%type;

C01 CURSOR( nr_seq_conta_proc_p   pls_conta_proc_v.nr_sequencia%type,
    nr_seq_conta_mat_p    pls_conta_mat_v.nr_sequencia%type) FOR
  --glosas do procedimento

  SELECT  a.nr_sequencia nr_seq_glosa,
    a.nr_seq_ocorrencia_benef ,
    b.cd_motivo_tiss,
    a.ie_situacao
  from  tiss_motivo_glosa b,
    pls_conta_glosa a
  where a.nr_seq_motivo_glosa = b.nr_sequencia
  and a.nr_seq_conta_proc = nr_seq_conta_proc_p
  
union

  --Glosas do material

  SELECT  a.nr_sequencia nr_seq_glosa,
    a.nr_seq_ocorrencia_benef nr_seq_ocorrencia_benef,
    b.cd_motivo_tiss,
    a.ie_situacao
  from  tiss_motivo_glosa b,
    pls_conta_glosa a
  where a.nr_seq_motivo_glosa = b.nr_sequencia
  and a.nr_seq_conta_mat  = nr_seq_conta_mat_p
  
union

  --ocorr?ncias do procedimento

  select  a.nr_seq_glosa,
    a.nr_sequencia nr_seq_ocorrencia_benef,
    c.cd_motivo_tiss,
    a.ie_situacao
  FROM pls_ocorrencia_benef a, pls_ocorrencia b
LEFT OUTER JOIN tiss_motivo_glosa c ON (b.nr_seq_motivo_glosa = c.nr_sequencia)
WHERE a.nr_seq_ocorrencia = b.nr_sequencia  and a.nr_seq_conta_proc = nr_seq_conta_proc_p
   
union

  --ocorr?ncias do material

  select  a.nr_seq_glosa,
    a.nr_sequencia nr_seq_ocorrencia_benef,
    c.cd_motivo_tiss,
    a.ie_situacao
  FROM pls_ocorrencia_benef a, pls_ocorrencia b
LEFT OUTER JOIN tiss_motivo_glosa c ON (b.nr_seq_motivo_glosa = c.nr_sequencia)
WHERE a.nr_seq_ocorrencia = b.nr_sequencia  and a.nr_seq_conta_mat  = nr_seq_conta_mat_p;

BEGIN
-- percorre todas as ocorr?ncias para fazer a manuten??o na tabela

for r_C01_w in C01(nr_seq_conta_proc_p, nr_seq_conta_mat_p) loop
  -- por default o status sempre ser? liberado a n?o ser que for uma glosa de valor

  ie_status_w   := 'L';

  -- verifica a quantidade de registros  que existem na tabela

  select  count(1)
  into STRICT  qt_fluxo_w
  from  pls_analise_glo_ocor_grupo x
  where x.nr_seq_analise  = nr_seq_analise_p
  and ((x.nr_seq_ocor_benef = r_C01_w.nr_seq_ocorrencia_benef) or (coalesce(x.nr_seq_ocor_benef::text, '') = '' and coalesce(r_C01_w.nr_seq_ocorrencia_benef::text, '') = ''))
  and x.nr_seq_grupo    = nr_seq_grupo_atual_p
  and   ((x.nr_seq_conta_glosa = coalesce(r_c01_w.nr_seq_glosa,nr_seq_conta_glosa_p)) or (coalesce(x.nr_seq_conta_glosa::text, '') = '' and coalesce(coalesce(r_c01_w.nr_seq_glosa,nr_seq_conta_glosa_p)::text, '') = '' ));

  if (qt_fluxo_w = 0) then
    -- insere novo fluxo

    insert into pls_analise_glo_ocor_grupo(nr_sequencia,
      nm_usuario,
      dt_atualizacao,
      nm_usuario_nrec,
      dt_atualizacao_nrec,
      nr_seq_analise,
      nr_seq_ocor_benef,
      nr_seq_grupo,
      nr_seq_fluxo,
      ie_fluxo_gerado,
      nm_usuario_analise,
      dt_analise,
      ie_status,
      ie_finalizacao,
      nr_seq_conta_glosa)
    values (nextval('pls_analise_glo_ocor_grupo_seq'),
      nm_usuario_p,
      clock_timestamp(),
      nm_usuario_p,
      clock_timestamp(),
      nr_seq_analise_p,
      r_C01_w.nr_seq_ocorrencia_benef,
      nr_seq_grupo_atual_p,
      nr_seq_fluxo_p,
      ie_fluxo_gerado_p,
      nm_usuario_p,
      clock_timestamp(),
      ie_status_w,
      ie_finalizacao_p,
      coalesce(r_c01_w.nr_seq_glosa,nr_seq_conta_glosa_p));
  else
    -- atualiza somente os campos necess?rios

    update  pls_analise_glo_ocor_grupo x
    set ie_status   = ie_status_w,
      nm_usuario    = nm_usuario_p,
      dt_atualizacao    = clock_timestamp(),
      nm_usuario_analise  = nm_usuario_p,
      dt_analise    = clock_timestamp(),
      nr_seq_fluxo    = nr_seq_fluxo_p
    where x.nr_seq_analise  = nr_seq_analise_p
    and ((x.nr_seq_ocor_benef = r_C01_w.nr_seq_ocorrencia_benef) or (coalesce(x.nr_seq_ocor_benef::text, '') = '' and coalesce(r_C01_w.nr_seq_ocorrencia_benef::text, '') = ''))
    and x.nr_seq_grupo    = nr_seq_grupo_atual_p
    and   ((x.nr_seq_conta_glosa = coalesce(r_c01_w.nr_seq_glosa,nr_seq_conta_glosa_p)) or (coalesce(x.nr_seq_conta_glosa::text, '') = '' and coalesce(coalesce(r_c01_w.nr_seq_glosa,nr_seq_conta_glosa_p)::text, '') = '' ));

  end if;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_analise_cta_pck.pls_gerencia_glo_ocor_grupo ( nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_grupo_atual_p pls_auditoria_conta_grupo.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_fluxo_p pls_analise_fluxo_item.nr_sequencia%type, ie_finalizacao_p pls_analise_glo_ocor_grupo.ie_finalizacao%type default null, nr_seq_conta_glosa_p pls_analise_glo_ocor_grupo.nr_seq_conta_glosa%type default null, ie_fluxo_gerado_p pls_analise_glo_ocor_grupo.ie_fluxo_gerado%type default 'S') FROM PUBLIC;
