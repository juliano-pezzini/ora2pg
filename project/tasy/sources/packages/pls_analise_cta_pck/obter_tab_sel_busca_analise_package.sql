-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_analise_cta_pck.obter_tab_sel_busca_analise ( ds_tabela_p text, ie_select_p integer, dados_select_p pls_util_pck.dados_select, dados_filtro_p table_dados_busca_analise) RETURNS PLS_UTIL_PCK.DADOS_SELECT AS $body$
DECLARE


dados_restricao_w   pls_util_pck.dados_select;
nr_seq_lote_disc_w    pls_lote_discussao.nr_sequencia%type;
nr_seq_protocolo_rec_w    pls_rec_glosa_protocolo.nr_sequencia%type;


BEGIN
-- armazena na vari?vel tudo o que j? foi declarado previamente

dados_restricao_w := dados_select_p;

if (dados_filtro_p.nr_seq_lote_analise IS NOT NULL AND dados_filtro_p.nr_seq_lote_analise::text <> '') then
  select  max(nr_sequencia)
  into STRICT  nr_seq_lote_disc_w
  from  pls_lote_discussao
  where nr_seq_lote_conta = dados_filtro_p.nr_seq_lote_analise;

  if (coalesce(nr_seq_lote_disc_w::text, '') = '') then
    select  max(nr_sequencia)
    into STRICT  nr_seq_protocolo_rec_w
    from  pls_rec_glosa_protocolo
    where nr_seq_lote_conta = dados_filtro_p.nr_seq_lote_analise;
  end if;
end if;

case(ds_tabela_p)
  when 'pls_conta' then
    dados_restricao_w := pls_util_pck.sql_tabela('pls_conta', 'conta', dados_restricao_w);

    if (nr_seq_lote_disc_w IS NOT NULL AND nr_seq_lote_disc_w::text <> '') then               
      dados_restricao_w := pls_util_pck.sql_tabela('pls_contestacao_discussao', 'disc', dados_restricao_w);
      dados_restricao_w := pls_util_pck.sql_restricao('and disc.nr_seq_analise = a.nr_sequencia', dados_restricao_w);

      dados_restricao_w := pls_util_pck.sql_tabela('pls_lote_discussao', 'lotdis', dados_restricao_w);
      dados_restricao_w := pls_util_pck.sql_restricao('and lotdis.nr_sequencia = disc.nr_seq_lote', dados_restricao_w);

      dados_restricao_w := pls_util_pck.sql_tabela('pls_contestacao', 'contest', dados_restricao_w);
      dados_restricao_w := pls_util_pck.sql_restricao('and contest.nr_sequencia = disc.nr_seq_contestacao', dados_restricao_w);
    end if;

    if (nr_seq_protocolo_rec_w IS NOT NULL AND nr_seq_protocolo_rec_w::text <> '') or (dados_filtro_p.ie_origem_analise in ('4','8')) then
      -- Protocolo de recurso de glosa

      dados_restricao_w := pls_util_pck.sql_tabela('pls_rec_glosa_protocolo', 'prec', dados_restricao_w);
      dados_restricao_w := pls_util_pck.sql_restricao('and prec.nr_sequencia = crec.nr_seq_protocolo', dados_restricao_w);
      -- Conta de recurso de glosa

      dados_restricao_w := pls_util_pck.sql_tabela('pls_rec_glosa_conta', 'crec', dados_restricao_w);
      dados_restricao_w := pls_util_pck.sql_restricao('and conta.nr_sequencia = crec.nr_seq_conta', dados_restricao_w);
    end if;

    -- Verificar parte de uso.

    -- se for para fazer pela an?lise normal ou buscar as an?lises referenciadas

    -- join entre pls_analise_conta e pls_conta

    
    if (ie_select_p = 1) then
      if (coalesce(nr_seq_lote_disc_w::text, '') = '') and (coalesce(nr_seq_protocolo_rec_w::text, '') = '') and
        ((dados_filtro_p.ie_origem_analise not in ('4','8')) or (coalesce(dados_filtro_p.ie_origem_analise::text, '') = '')) then
        dados_restricao_w := pls_util_pck.sql_restricao('and conta.nr_seq_analise = a.nr_sequencia', dados_restricao_w);

      elsif (nr_seq_lote_disc_w IS NOT NULL AND nr_seq_lote_disc_w::text <> '') then
        dados_restricao_w := pls_util_pck.sql_restricao('and conta.nr_sequencia = contest.nr_seq_conta', dados_restricao_w);

      elsif (nr_seq_protocolo_rec_w IS NOT NULL AND nr_seq_protocolo_rec_w::text <> '') or (dados_filtro_p.ie_origem_analise in ('4','8')) then
        dados_restricao_w := pls_util_pck.sql_restricao('and crec.nr_seq_analise = a.nr_sequencia', dados_restricao_w);
      end if;
    else
      if (nr_seq_protocolo_rec_w IS NOT NULL AND nr_seq_protocolo_rec_w::text <> '') or (dados_filtro_p.ie_origem_analise in ('4','8')) then
        dados_restricao_w := pls_util_pck.sql_restricao('and crec.nr_seq_analise = a.nr_seq_analise_ref', dados_restricao_w);
      else
        dados_restricao_w := pls_util_pck.sql_restricao('and conta.nr_seq_analise = a.nr_seq_analise_ref', dados_restricao_w);
      end if;
    end if;

  when 'pls_protocolo_conta' then
  
    dados_restricao_w := pls_util_pck.sql_tabela('pls_protocolo_conta', 'proto', dados_restricao_w);
    -- join entre pls_conta e pls_protocolo_conta

    dados_restricao_w := pls_util_pck.sql_restricao('and proto.nr_sequencia = conta.nr_seq_protocolo', dados_restricao_w);

  when 'pls_lote_protocolo_conta' then
    
    dados_restricao_w := pls_util_pck.sql_tabela('pls_lote_protocolo_conta', 'lote', dados_restricao_w);

    if (coalesce(nr_seq_lote_disc_w::text, '') = '') and (coalesce(nr_seq_protocolo_rec_w::text, '') = '') and
      ((dados_filtro_p.ie_origem_analise not in ('4','8')) or (coalesce(dados_filtro_p.ie_origem_analise::text, '') = ''))then
      -- join entre pls_conta e pls_protocolo_conta

      dados_restricao_w := pls_util_pck.sql_restricao('and lote.nr_sequencia = proto.nr_seq_lote_conta', dados_restricao_w);

    elsif (nr_seq_lote_disc_w IS NOT NULL AND nr_seq_lote_disc_w::text <> '') then
      dados_restricao_w := pls_util_pck.sql_restricao('and lote.nr_sequencia = lotdis.nr_seq_lote_conta', dados_restricao_w);

    elsif (nr_seq_protocolo_rec_w IS NOT NULL AND nr_seq_protocolo_rec_w::text <> '') or (dados_filtro_p.ie_origem_analise in ('4','8')) then
      dados_restricao_w := pls_util_pck.sql_restricao('and lote.nr_sequencia = prec.nr_seq_lote_conta', dados_restricao_w);
    end if;
  else
    null;
end case;

return dados_restricao_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_analise_cta_pck.obter_tab_sel_busca_analise ( ds_tabela_p text, ie_select_p integer, dados_select_p pls_util_pck.dados_select, dados_filtro_p table_dados_busca_analise) FROM PUBLIC;
