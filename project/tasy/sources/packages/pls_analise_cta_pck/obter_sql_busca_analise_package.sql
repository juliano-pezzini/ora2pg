-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_analise_cta_pck.obter_sql_busca_analise ( dados_filtro_p table_dados_busca_analise, ie_select_p integer, nr_id_transacao_p pls_analise_conta_temp.nr_id_transacao%type, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE


ds_sql_final_w      varchar(32000);
dados_restricao_w   pls_util_pck.dados_select;
ie_analise_conta_medica_w pls_controle_estab.ie_analise_conta_medica%type;
ds_restr_estab_w    varchar(50);
ds_restr_cond_pagto_w varchar(4000);
ie_masc_emissor_w pls_param_analise_conta.ie_masc_emissor%type;


BEGIN


-- obt?m as restri??es

valor_bind_p := pls_analise_cta_pck.obter_restr_busca_analise(dados_filtro_p, ie_select_p, nr_id_transacao_p, valor_bind_p);
ds_restr_estab_w  := pls_analise_cta_pck.obter_restr_estab_logado();

if (dados_filtro_p.nr_seq_analise IS NOT NULL AND dados_filtro_p.nr_seq_analise::text <> '') then

ds_restr_cond_pagto_w := 'null cd_condicao_pagamento,'|| pls_util_pck.enter_w ||'';

else
ds_restr_cond_pagto_w := '  pls_analise_cta_pck.obter_cond_pagto(conta.nr_sequencia, a.nr_sequencia) cd_condicao_pagamento, ';

end if;

select coalesce(max(ie_masc_emissor),'N')
into STRICT	ie_masc_emissor_w
from pls_param_analise_conta;

ds_sql_final_w := 
    'select distinct a.nr_sequencia, ' || pls_util_pck.enter_w ||
    ' a.cd_guia, ' || pls_util_pck.enter_w ||
    ' a.nr_seq_lote_protocolo, ' || pls_util_pck.enter_w ||
    ' a.nr_seq_prestador, ' || pls_util_pck.enter_w ||
    ' substr(pls_obter_dados_prestador(a.nr_seq_prestador, ''N''), 1, 255) nm_prestador_f, ' || pls_util_pck.enter_w ||
    ' a.nm_cooperativa, ';
    if ( ie_masc_emissor_w = 'S') then
	ds_sql_final_w := ds_sql_final_w|| pls_util_pck.enter_w ||' substr(pls_obter_cart_masc_benef(a.nr_seq_segurado), 1, 30) cd_usuario_plano, ';
    else
	ds_sql_final_w := ds_sql_final_w|| pls_util_pck.enter_w ||' substr(pls_obter_dados_segurado(a.nr_seq_segurado, ''CR''), 1, 30) cd_usuario_plano, ';
    end if;
    ds_sql_final_w := ds_sql_final_w|| pls_util_pck.enter_w ||' substr(pls_obter_dados_segurado(a.nr_seq_segurado,''N''),1,255) nm_segurado,' || pls_util_pck.enter_w ||
    ' a.dt_analise,' || pls_util_pck.enter_w ||
    ' a.ie_status,' || pls_util_pck.enter_w ||
    ' substr(obter_valor_dominio(3783, a.ie_status), 1, 255) ds_status,' || pls_util_pck.enter_w ||
    ' substr(obter_dif_horario(a.dt_inicio_analise, nvl(a.dt_final_analise, sysdate)), 1, 255) qt_tempo_analise,' || pls_util_pck.enter_w ||
    ' substr(obter_valor_dominio(4572, nvl(a.ie_origem_analise, 1)), 1, 255) ds_origem_analise, ' || pls_util_pck.enter_w ||
    ' substr(nvl(a.nr_fatura, pls_obter_dados_analise_disc(a.nr_sequencia, ''FAT'')), 1, 255) nr_fatura_f, ' || pls_util_pck.enter_w ||
    ' (select max(x.nr_nota_credito_debito)' || pls_util_pck.enter_w ||
    ' from  ptu_fatura x' || pls_util_pck.enter_w ||
    ' where x.nr_sequencia in(select z.nr_seq_fatura' || pls_util_pck.enter_w ||
    '       from  pls_conta z' || pls_util_pck.enter_w ||
    '       where z.nr_seq_analise = a.nr_sequencia)) nr_nota_credito_debito, ' || pls_util_pck.enter_w ||
    ' substr(pls_obter_dados_analise_disc(a.nr_sequencia, ''NEF''), 1, 255) nr_nota_credito_debito_f, ' || pls_util_pck.enter_w ||
    ' substr(pls_obter_dados_analise_disc(a.nr_sequencia, ''NEN''), 1, 255) nr_nota_credito_debito_ndr_f,' || pls_util_pck.enter_w ||
    ' substr(pls_obter_dados_analise_disc(a.nr_sequencia, ''NIF''), 1, 255) nr_titulo_receber_f,' || pls_util_pck.enter_w ||
    ' substr(pls_obter_dados_analise_disc(a.nr_sequencia, ''NIN''), 1, 255) nr_titulo_receber_ndr_f, ' || pls_util_pck.enter_w ||
    ' substr(obter_valor_dominio(1746, a.ie_tipo_guia), 1, 255) ds_tipo_guia, ' || pls_util_pck.enter_w ||
    ' (select sum(x.vl_cobrado)' || pls_util_pck.enter_w ||
    ' from  pls_conta x' || pls_util_pck.enter_w ||
    ' where x.nr_seq_analise = a.nr_sequencia) ds_vl_apresentado,' || pls_util_pck.enter_w ||
    ' to_date(substr(pls_obter_dt_emissao_conta(a.nr_sequencia), 1, 255), ''dd/mm/yyyy'') dt_atendimento,' || pls_util_pck.enter_w ||
    ' a.ie_origem_analise,' || pls_util_pck.enter_w ||
    ' (select max(decode(y.ie_apresentacao, ''A'', ''Apresenta??o'', ''R'', ''Reapresenta??o''))' || pls_util_pck.enter_w ||
    ' from  pls_conta x,' || pls_util_pck.enter_w ||
    '   pls_protocolo_conta     y' || pls_util_pck.enter_w ||
    ' where   x.nr_seq_analise = a.nr_sequencia' || pls_util_pck.enter_w ||
    ' and     y.nr_sequencia = x.nr_seq_protocolo) ds_apresentacao, ' || pls_util_pck.enter_w ||
    ' a.nr_seq_analise_ref, ' || pls_util_pck.enter_w ||
    ' (select max(x.ie_status) ' || pls_util_pck.enter_w ||
    ' from  pls_analise_conta x ' || pls_util_pck.enter_w ||
    ' where x.nr_sequencia = a.nr_seq_analise_ref) ie_status_analise_ref, ' || pls_util_pck.enter_w ||
    ' (select max(x.ie_status) ' || pls_util_pck.enter_w ||
    ' from  pls_analise_conta x ' || pls_util_pck.enter_w ||
    ' where x.cd_guia = a.cd_guia ' || pls_util_pck.enter_w ||
    ' and x.nr_seq_analise_ref is null) ie_status_analise_pos_ref, ' || pls_util_pck.enter_w ||
    ' a.nr_seq_grupo_auditor, ' || pls_util_pck.enter_w ||
    ' a.nr_seq_segurado, ' || pls_util_pck.enter_w ||
    ' a.ie_tipo_guia, ' || pls_util_pck.enter_w ||
    ' (select sum(x.vl_total)' || pls_util_pck.enter_w ||
    ' from  pls_conta x' || pls_util_pck.enter_w ||
    ' where x.nr_seq_analise = a.nr_sequencia) vl_liberado,' || pls_util_pck.enter_w ||
    ' a.ie_origem_conta, ' ||
    ' a.nm_usuario, ' || 
    ' a.nm_usuario_nrec, ' ||
    ' a.dt_atualizacao, ' || 
    ' a.dt_atualizacao_nrec, ' ||  
    ' (select max(nvl(y.ie_refaturamento, ''N''))' || pls_util_pck.enter_w ||
    ' from  pls_conta x,' || pls_util_pck.enter_w ||
    '   pls_protocolo_conta     y' || pls_util_pck.enter_w ||
    ' where   x.nr_seq_analise = nvl(a.nr_seq_analise_ref,a.nr_sequencia)' || pls_util_pck.enter_w ||
    ' and     y.nr_sequencia = x.nr_seq_protocolo) ie_refaturamento, ' || pls_util_pck.enter_w ||
    '       a.dt_prazo_analise, ' || pls_util_pck.enter_w ||
    ' (select sum(pos.vl_beneficiario) ' || pls_util_pck.enter_w ||
    ' from  pls_conta_pos_estabelecido pos ' || pls_util_pck.enter_w ||
    ' where pos.nr_seq_analise = a.nr_sequencia
    and   pos.ie_status_faturamento <> ''A'') vl_lib_pos_estab, ' || pls_util_pck.enter_w ||
	'coalesce((select max(x.nr_seq_protocolo)' || pls_util_pck.enter_w  ||
	'from  pls_conta x' || pls_util_pck.enter_w  ||
	'where x.nr_seq_analise = a.nr_sequencia),' || pls_util_pck.enter_w  ||
	'(Select max(c.nr_seq_protocolo)' || pls_util_pck.enter_w  ||
	'from pls_conta c, pls_conta_pos_estabelecido d' || pls_util_pck.enter_w  ||
	'where a.nr_sequencia = d.nr_seq_analise and d.nr_seq_conta = c.nr_sequencia),' || pls_util_pck.enter_w  ||
	'(Select max(c.nr_seq_protocolo)' || pls_util_pck.enter_w  ||
	'from pls_conta c, pls_rec_glosa_conta d' || pls_util_pck.enter_w  ||
	'where a.nr_sequencia = d.nr_seq_analise and d.nr_seq_conta = c.nr_sequencia)) nr_seq_protocolo,' || pls_util_pck.enter_w  ||
	ds_restr_cond_pagto_w||
    ' (select max(x.cd_guia_prestador)' || pls_util_pck.enter_w ||
    ' from  pls_conta x' || pls_util_pck.enter_w ||
    ' where x.nr_seq_analise = a.nr_sequencia) cd_guia_prestador,' || pls_util_pck.enter_w ||
    ' (select max(y.nr_seq_transacao)' || pls_util_pck.enter_w ||
    ' from  pls_conta x,' || pls_util_pck.enter_w ||
    '   pls_protocolo_conta     y' || pls_util_pck.enter_w ||
    ' where   x.nr_seq_analise = a.nr_sequencia' || pls_util_pck.enter_w ||
    ' and     y.nr_sequencia = x.nr_seq_protocolo) nr_seq_transacao, ' || pls_util_pck.enter_w ||
    ' decode(a.ie_origem_analise, 4, pls_obter_valores_rec_analise(a.nr_sequencia, ''VA''), 0) vl_acatado, ' || pls_util_pck.enter_w ||
    ' decode(a.ie_origem_analise, 4, pls_obter_valores_rec_analise(a.nr_sequencia, ''VR''), 0) vl_recursado ' || pls_util_pck.enter_w ||
    dados_restricao_w.ds_campos || pls_util_pck.enter_w ||
    'from pls_analise_conta_ap_v a ' ||
    dados_restricao_w.ds_tabelas || pls_util_pck.enter_w ||
    ' where a.ie_pre_analise = ''N'''   || pls_util_pck.enter_w ||
    ' and a.ie_status <> ''D'' '  || pls_util_pck.enter_w ||
    ds_restr_estab_w|| pls_util_pck.enter_w ||
    dados_restricao_w.ds_restricao;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_analise_cta_pck.obter_sql_busca_analise ( dados_filtro_p table_dados_busca_analise, ie_select_p integer, nr_id_transacao_p pls_analise_conta_temp.nr_id_transacao%type, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
