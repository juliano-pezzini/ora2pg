-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Insere nova(s) an?lise(s) e atualiza refer?ncia na tabela pls_conta



CREATE OR REPLACE PROCEDURE pls_analise_cta_pck.insere_analise_conta ( dados_analise_p table_dados_analise_conta, tb_seq_conta_insert_p dbms_sql.number_table, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
BEGIN

--Se realmente tiver registros

if (tb_seq_conta_insert_p.count > 0) then

  forall i in dados_analise_p.nr_sequencia.first..dados_analise_p.nr_sequencia.last
    insert into pls_analise_conta(nr_sequencia, nr_seq_lote_protocolo, nr_seq_prestador,
      nr_seq_segurado, nm_usuario, nm_usuario_nrec, 
      dt_atualizacao, dt_atualizacao_nrec, cd_guia, 
      ie_status, dt_analise, dt_inicio_analise, 
      ie_auditoria, nr_seq_congenere, ie_pre_analise, 
      ie_origem_analise, nr_fatura, ie_origem_conta, 
      ie_preco, cd_estabelecimento, ie_tipo_guia, 
      nm_prestador, nm_cooperativa, nm_segurado, 
      cd_cooperativa, ie_pcmso, nr_seq_regra_agrup)
    values (dados_analise_p.nr_sequencia(i), dados_analise_p.nr_seq_lote_protocolo(i), dados_analise_p.nr_seq_prestador(i),
      dados_analise_p.nr_seq_segurado(i), nm_usuario_p, nm_usuario_p, 
      clock_timestamp(), clock_timestamp(), dados_analise_p.cd_guia(i),
       'S', clock_timestamp(), clock_timestamp(), 
       'N', dados_analise_p.nr_seq_congenere(i), dados_analise_p.ie_pre_analise(i), 
       dados_analise_p.ie_origem_analise(i), dados_analise_p.nr_fatura(i), dados_analise_p.ie_origem_conta(i), 
       dados_analise_p.ie_preco(i), cd_estabelecimento_p, dados_analise_p.ie_tipo_guia(i), 
       dados_analise_p.nm_prestador(i), dados_analise_p.nm_cooperativa(i), dados_analise_p.nm_segurado(i), 
       dados_analise_p.cd_cooperativa(i), dados_analise_p.ie_pcmso(i), dados_analise_p.nr_seq_regra_agrup(i));

  commit;

  --Atualiza refer?ncia  ? an?lise nas contas

  forall i in tb_seq_conta_insert_p.first..tb_seq_conta_insert_p.last
    update  pls_conta
    set nr_seq_analise  = dados_analise_p.nr_sequencia(i)
    where nr_sequencia  = tb_seq_conta_insert_p(i);

  commit;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_analise_cta_pck.insere_analise_conta ( dados_analise_p table_dados_analise_conta, tb_seq_conta_insert_p dbms_sql.number_table, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
