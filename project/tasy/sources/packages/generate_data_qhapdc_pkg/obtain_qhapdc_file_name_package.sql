-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE generate_data_qhapdc_pkg.obtain_qhapdc_file_name (dt_extract_date_p timestamp, nr_seq_batch_p bigint, nm_usuario_p text, nm_filetype_p text, cd_estabelecimento_p bigint, nr_file_seq_p INOUT bigint, returned_value_p INOUT bigint, other_exception_p INOUT text) AS $body$
DECLARE

    cd_estabelecimento_w estabelecimento.cd_estabelecimento%TYPE;
    cd_facility_number_w pessoa_juridica.cd_facility_code%TYPE;
    ds_collection_year_w varchar(8);
    nr_seq_file_w        qhapdc_rule_filename.nr_sequencia%TYPE;
    nr_seq_qhapdc_file_w qhapdc_file.nr_sequencia%TYPE;
    nr_extract_seq_w     qhapdc_rule_filename.nr_extract_seq%TYPE;
    ds_initial_gen_w     varchar(4);
    nm_filename_w        qhapdc_file.ds_file_name%TYPE;
    ds_erro_w            varchar(2000);
    nr_seq_log_w         bigint;
    v_errm               varchar(100 );

BEGIN 
      /* five-digit facility number */
 
      SELECT coalesce(max(cd_facility_code),'0') 
      INTO STRICT   cd_facility_number_w 
      FROM   pessoa_juridica pj, 
             estabelecimento es 
      WHERE  pj.cd_cgc = es.cd_cgc 
             AND es.cd_estabelecimento = cd_estabelecimento_p;

      /* collection year */
 
      SELECT ( To_char(dt_initial_generation, 'YYYY') 
               || To_char(Add_months(dt_initial_generation, 12), 'YYYY') ) 
      INTO STRICT   ds_collection_year_w 
      FROM   qhapdc_batch_sending 
      WHERE  nr_sequencia = nr_seq_batch_p;

      SELECT To_char(dt_initial_generation, 'YYYY') 
      INTO STRICT   ds_initial_gen_w 
      FROM   qhapdc_batch_sending 
      WHERE  nr_sequencia = nr_seq_batch_p;

      /*data extract number for collection year*/
 
      SELECT coalesce(Max(nr_extract_seq), 0) + 1 
      INTO STRICT   nr_extract_seq_w 
      FROM   qhapdc_rule_filename 
      WHERE  To_char(dt_extraction, 'YYYY') = ds_initial_gen_w;

      RAISE NOTICE 'Hello Reader!';

      RAISE NOTICE '%', nr_extract_seq_w;

      SELECT nextval('qhapdc_rule_filename_seq') 
      INTO STRICT   nr_seq_file_w 
;

      /* create the filename */
 
      SELECT Substr(Lpad(To_char(cd_facility_number_w), 5, '0'), 1, 5) 
             || ds_collection_year_w 
             || Substr(Lpad(To_char(nr_extract_seq_w), 3, '0'), 1, 3) 
             || '.' 
             || nm_filetype_p 
             || '.HQI' 
      INTO STRICT   nm_filename_w 
;

      SELECT nextval('qhapdc_file_seq') 
      INTO STRICT   nr_seq_qhapdc_file_w 
;

      /* insert filenmae */
 
      INSERT INTO qhapdc_rule_filename(nr_sequencia, 
                   dt_atualizacao, 
                   nm_usuario, 
                   dt_atualizacao_nrec, 
                   nm_usuario_nrec, 
                   dt_start_ref, 
                   nr_extract_seq, 
                   dt_extraction) 
      VALUES (nextval('qhapdc_file_seq'), 
                  clock_timestamp(), 
                  nm_usuario_p, 
                  clock_timestamp(), 
                  nm_usuario_p, 
                  clock_timestamp(), 
                  nr_extract_seq_w, 
                  dt_extract_date_p );

      /* insert file */
 
      INSERT INTO qhapdc_file(nr_sequencia, 
                   dt_atualizacao, 
                   nm_usuario, 
                   dt_atualizacao_nrec, 
                   nm_usuario_nrec, 
                   ds_file_name, 
                   nr_qhapdc_batch) 
      VALUES (nr_seq_qhapdc_file_w, 
                   clock_timestamp(), 
                   nm_usuario_p, 
                   clock_timestamp(), 
                   nm_usuario_p, 
                   nm_filename_w, 
                   nr_seq_batch_p );

      nr_file_seq_p := nr_seq_qhapdc_file_w;

      returned_value_p := 1;

      other_exception_p := NULL;
  EXCEPTION 
    WHEN data_exception OR unique_violation OR invalid_cursor_state THEN 
               v_errm := Substr(SQLERRM, 1, 100);

               returned_value_p := 0;

               other_exception_p := v_errm;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_data_qhapdc_pkg.obtain_qhapdc_file_name (dt_extract_date_p timestamp, nr_seq_batch_p bigint, nm_usuario_p text, nm_filetype_p text, cd_estabelecimento_p bigint, nr_file_seq_p INOUT bigint, returned_value_p INOUT bigint, other_exception_p INOUT text) FROM PUBLIC;
