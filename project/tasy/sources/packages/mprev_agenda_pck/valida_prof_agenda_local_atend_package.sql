-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/*---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	|			VALIDA PROFISSIONAL AGENDAMENTO LOCAL ATENDIMENTO				|
	*/
CREATE OR REPLACE PROCEDURE mprev_agenda_pck.valida_prof_agenda_local_atend ( dados_agenda_p dados_agendamento, nm_usuario_p text) AS $body$
DECLARE


	cd_agenda_profissional_w	mprev_agendamento.cd_agenda_profissional%type;
	ie_agenda_local_w		varchar(1);
	cd_agenda_w			mprev_agendamento.cd_agenda%type;
	cd_profissional_w		pessoa_fisica.cd_pessoa_fisica%type;

	
BEGIN

	if (dados_agenda_p.nr_seq_w_agendamento IS NOT NULL AND dados_agenda_p.nr_seq_w_agendamento::text <> '') then
		select	cd_agenda,
			cd_agenda_profissional
		into STRICT	cd_agenda_w,
			cd_agenda_profissional_w
		from	w_mprev_agendamento a
		where	nr_sequencia = dados_agenda_p.nr_seq_w_agendamento;
	end if;

	if (cd_agenda_w IS NOT NULL AND cd_agenda_w::text <> '') then
		select  CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_agenda_local_w
		from	agenda a
		where	a.cd_agenda = cd_agenda_w
		and 	exists (	SELECT 	1
					from 	mprev_local_atend_agenda x
					where 	x.cd_agenda = a.cd_agenda);
	end if;

	if (coalesce(ie_agenda_local_w,'N') = 'S') then

		if (cd_agenda_profissional_w IS NOT NULL AND cd_agenda_profissional_w::text <> '') then
			select	max(a.cd_pessoa_fisica)
			into STRICT	cd_profissional_w
			from	agenda a
			where	a.cd_agenda	= cd_agenda_profissional_w;

		else
			select	max(a.cd_pessoa_fisica)
			into STRICT	cd_profissional_w
			from	agenda a
			where	a.cd_agenda	= cd_agenda_w;
		end if;

		if (coalesce(cd_profissional_w::text, '') = '') then
			/*Agendamento de local de atendimento precisa ter uma agenda de  profissional informada no agendamento ou profissional cadastrado na pasta "Configuracoes/Conf Agenda/Agenda" campo "Profissional".*/

			CALL CALL CALL mprev_agenda_pck.gravar_inconsistencia(dados_agenda_p, 449437, null, 'E', '11', null,nm_usuario_p);

		end if;
	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_agenda_pck.valida_prof_agenda_local_atend ( dados_agenda_p dados_agendamento, nm_usuario_p text) FROM PUBLIC;
