-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/*---------------------------------------------------------------------------------------------------------------------------------------------
	|			CONSISTIR_AGENDAMENTO				|
	*/
CREATE OR REPLACE PROCEDURE mprev_agenda_pck.consistir_agendamento ( dados_agenda_p dados_agendamento, nm_usuario_p text, qt_mensagens_erro_p INOUT bigint, qt_mensagens_atencao_p INOUT bigint, qt_mensagens_confirm_p INOUT bigint) AS $body$
BEGIN

	-- Valida o turno da agenda
	CALL mprev_agenda_pck.valida_turno(dados_agenda_p,nm_usuario_p);

	-- Valida se o horario nao esta bloqueado
	CALL mprev_agenda_pck.valida_horario_bloqueado(dados_agenda_p,nm_usuario_p);

	-- Valida se a agenda esta disponinel
	CALL mprev_agenda_pck.valida_horario_agenda(dados_agenda_p,nm_usuario_p);

	--Valida se recurso esta disponivel para o horario do agendamento
	CALL mprev_agenda_pck.valida_disp_recurso_agenda(dados_agenda_p, nm_usuario_p);

	--Valida tempo de duracao do agendamento
	if (dados_agenda_p.nr_minutos < 10) then
		--A duracao minima permitida para os agendamentos e de 10 minutos, favor verificar.
		CALL CALL CALL mprev_agenda_pck.gravar_inconsistencia(dados_agenda_p, 316657, null, 'E', '7', null,nm_usuario_p);
	end if;

	-- Se o usuario ja confirm
	if (current_setting('mprev_agenda_pck.ie_confirmacao_w')::varchar(1) = 'N') then
		if (coalesce(dados_agenda_p.nr_seq_turma,0) > 0) then
			-- Valida a turma
			CALL mprev_agenda_pck.valida_horario_turma(dados_agenda_p,nm_usuario_p);
		else
			-- Valida o participante
			CALL mprev_agenda_pck.valida_horario_partic(dados_agenda_p,nm_usuario_p);
		end if;
	end if;

	qt_mensagens_erro_p := current_setting('mprev_agenda_pck.qt_mensagens_erro_w')::smallint;
	qt_mensagens_atencao_p := current_setting('mprev_agenda_pck.qt_mensagens_atencao_w')::smallint;
	qt_mensagens_confirm_p := current_setting('mprev_agenda_pck.qt_mensagens_confirm_w')::smallint;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_agenda_pck.consistir_agendamento ( dados_agenda_p dados_agendamento, nm_usuario_p text, qt_mensagens_erro_p INOUT bigint, qt_mensagens_atencao_p INOUT bigint, qt_mensagens_confirm_p INOUT bigint) FROM PUBLIC;
