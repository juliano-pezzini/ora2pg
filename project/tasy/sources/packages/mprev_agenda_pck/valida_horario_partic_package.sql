-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/*---------------------------------------------------------------------------------------------------------------------------------------------
	|			VALIDA_HORARIO_PARTIC				|
	*/
	/* Vai validar se o horario do agendamento esta disponivel para o participante */

CREATE OR REPLACE PROCEDURE mprev_agenda_pck.valida_horario_partic (dados_agenda_p dados_agendamento, nm_usuario_p text) AS $body$
DECLARE


	cd_agenda_w		mprev_agendamento.cd_agenda%type;
	dt_agenda_w		varchar(255);

	
BEGIN

	begin
	if (coalesce(dados_agenda_p.nr_sequencia,0 ) = 0) then
		select	cd_agenda,
			to_char(dt_agenda, 'dd/mm/yyyy hh24:mi') || ' ' || wheb_mensagem_pck.get_texto(69052) ||' '|| to_char((dt_agenda + (nr_minuto_duracao * (1/24/60))), 'dd/mm/yyyy hh24:mi')
		into STRICT	cd_agenda_w,
			dt_agenda_w
		from	mprev_agendamento a
		where	nr_seq_participante = dados_agenda_p.nr_seq_participante
		and	((dados_agenda_p.dt_final_agendamento- (60/86400)  between dt_agenda and  (dt_agenda + (nr_minuto_duracao * (1/24/60)))- (60/86400) )  --decrementa 1 minuto
		or	(dados_agenda_p.dt_agendamento between dt_agenda and (dt_agenda + (nr_minuto_duracao * (1/24/60)))- (60/86400) ))
		and	ie_status_agenda <> 'C'
		and	ie_status_agenda <> 'E'  LIMIT 1;
	else
		select	cd_agenda,
			to_char(dt_agenda, 'dd/mm/yyyy hh24:mi') || ' ' || wheb_mensagem_pck.get_texto(69052) ||' '|| to_char((dt_agenda + (nr_minuto_duracao * (1/24/60))), 'dd/mm/yyyy hh24:mi')
		into STRICT	cd_agenda_w,
			dt_agenda_w
		from	mprev_agendamento a
		where	nr_seq_participante =  dados_agenda_p.nr_seq_participante
		and	((dados_agenda_p.dt_final_agendamento- (60/86400)  between dt_agenda and  (dt_agenda + (nr_minuto_duracao * (1/24/60)))- (60/86400) )  --decrementa 1 minuto
		or	(dados_agenda_p.dt_agendamento between dt_agenda and (dt_agenda + (nr_minuto_duracao * (1/24/60)))- (60/86400) ))
		and     nr_sequencia <> coalesce(dados_agenda_p.nr_sequencia,0 )
		and	ie_status_agenda <> 'C'
		and	ie_status_agenda <> 'E'
		and	not exists (SELECT	 1
				    from	 mprev_agendamento b
				    where (b.cd_agenda_local = a.cd_agenda
				    or		 b.cd_agenda_profissional = a.cd_agenda )
				    and		 b.dt_agenda = a.dt_agenda)
		and	not exists (select	 1
				    from	 mprev_agendamento b
				    where (a.cd_agenda_local = b.cd_agenda
				    or		 a.cd_agenda_profissional = b.cd_agenda )
				    and		 b.dt_agenda = a.dt_agenda)  LIMIT 1;
	end if;
	exception
		when others then
		cd_agenda_w	:= null;
		dt_agenda_w	:= null;
	end;

	if (cd_agenda_w IS NOT NULL AND cd_agenda_w::text <> '') then
		--Paciente ja possui horario agendado para #@DT_AGENDAMENTO#@ na agenda #@CD_AGENDA#@ que coincide com este horario, deseja marcar mesmo assim?
		CALL CALL CALL mprev_agenda_pck.gravar_inconsistencia(dados_agenda_p, 269374, 'DT_AGENDAMENTO='|| dt_agenda_w ||';CD_AGENDA='|| cd_agenda_w,
				      'C',  '7', null,nm_usuario_p);
	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_agenda_pck.valida_horario_partic (dados_agenda_p dados_agendamento, nm_usuario_p text) FROM PUBLIC;
