-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/*---------------------------------------------------------------------------------------------------------------------------------------------
	|			OBTER_PERMISSAO_AGENDA				|
	*/
CREATE OR REPLACE FUNCTION mprev_agenda_pck.obter_permissao_agenda (cd_agenda_p bigint, cd_pessoa_fisica_p bigint, cd_perfil_p bigint, cd_setor_atend_p bigint) RETURNS varchar AS $body$
DECLARE


	ie_permissao_w		varchar(2);
	nr_dia_semana_w 	bigint := pkg_date_utils.get_weekday(clock_timestamp());
	cd_perfil_w		med_permissao.cd_perfil%type;
	cd_setor_atendimento_w	med_permissao.cd_setor_atendimento%type;
	cd_pessoa_fisica_w	med_permissao.cd_pessoa_fisica%type;

	C01 CURSOR FOR
		SELECT	ie_permissao
		from	med_permissao
		where	coalesce( cd_pessoa_fisica, cd_pessoa_fisica_w) = cd_pessoa_fisica_w
		and	coalesce( cd_perfil, cd_perfil_w) = cd_perfil_w
		and	coalesce( cd_setor_atendimento, cd_setor_atendimento_w) = cd_setor_atendimento_w
		and	cd_agenda = cd_agenda_p
		and (coalesce(ie_dia_semana,nr_dia_semana_w) = nr_dia_semana_w or (ie_dia_semana = '9' and nr_dia_semana_w > 1 and nr_dia_semana_w < 7))
		order 	by coalesce(cd_pessoa_fisica, 0) ,
			   coalesce(cd_perfil,0) ,
			   coalesce(cd_setor_atendimento, 0),
			   coalesce(ie_dia_semana, 0);

	
BEGIN

	cd_perfil_w := coalesce(cd_perfil_p ,0);
	cd_setor_atendimento_w := coalesce(cd_setor_atend_p, 0);
	cd_pessoa_fisica_w := coalesce(cd_pessoa_fisica_p, 0);

	for cr_01 in C01 loop
		begin
			ie_permissao_w := cr_01.ie_permissao;
		end;
	end loop;

	return	coalesce(ie_permissao_w, 'T');

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION mprev_agenda_pck.obter_permissao_agenda (cd_agenda_p bigint, cd_pessoa_fisica_p bigint, cd_perfil_p bigint, cd_setor_atend_p bigint) FROM PUBLIC;
