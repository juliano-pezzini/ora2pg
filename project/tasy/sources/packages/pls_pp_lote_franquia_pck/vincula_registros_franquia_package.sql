-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_lote_franquia_pck.vincula_registros_franquia ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

 
tb_nr_seq_franq_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_prest_w	pls_util_cta_pck.t_number_table;
tb_vl_ajuste_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_evento_w	pls_util_cta_pck.t_number_table;

c01 CURSOR(	nr_seq_lote_pc	pls_pp_lote.nr_sequencia%type) FOR 
	SELECT	b.nr_sequencia, 
		b.nr_seq_prestador, 
		b.vl_ajuste, 
		-- se o valor do ajuste for menor que zero retorna o evento de débito se não é o de crédito 
		case 
			when 	b.vl_ajuste < 0 then c.nr_seq_evento_deb 
			else	c.nr_seq_evento_cred 
		end nr_seq_evento 
	from	pls_franq_pag a, 
		pls_franq_pag_prest b, 
		pls_regra_franq_pag c 
	where	a.nr_seq_pp_lote_pgto = nr_seq_lote_pc 
	and	b.nr_seq_franq_pag = a.nr_sequencia 
	and	b.vl_ajuste <> 0 
	and	c.nr_sequencia = b.nr_seq_regra 
	and not exists (	SELECT	1 
			from	pls_pp_item_lote x 
			where	x.nr_seq_franq_prest_pag = b.nr_sequencia 
			and	x.ie_cancelado = 'N');


BEGIN 
-- retorna todos os prestador que tiveram valor de franquia para gerar os registros no lote de pagamento 
open c01(nr_seq_lote_p);
loop 
	fetch c01 bulk collect into	tb_nr_seq_franq_w, tb_nr_seq_prest_w, tb_vl_ajuste_w, 
					tb_nr_seq_evento_w 
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_franq_w.count = 0;
 
	-- insere os registros de franquia no lote de pagamento 
	forall i in tb_nr_seq_franq_w.first..tb_nr_seq_franq_w.last 
		insert into pls_pp_item_lote( 
			nr_sequencia, nr_seq_lote, nm_usuario_nrec, 
			nm_usuario, dt_atualizacao_nrec, dt_atualizacao, 
			ie_cancelado, ie_tipo_item, nr_seq_evento, 
			nr_seq_prestador, nr_seq_prestador_origem, vl_glosa, 
			vl_item, vl_liquido, nr_seq_franq_prest_pag 
		) values ( 
			nextval('pls_pp_item_lote_seq'), nr_seq_lote_p, nm_usuario_p, 
			nm_usuario_p, clock_timestamp(), clock_timestamp(), 
			'N', '9', tb_nr_seq_evento_w(i), 
			tb_nr_seq_prest_w(i), tb_nr_seq_prest_w(i), 0, 
			tb_vl_ajuste_w(i), tb_vl_ajuste_w(i), tb_nr_seq_franq_w(i) 
		);
	commit;
end loop;
close c01;
 
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_lote_franquia_pck.vincula_registros_franquia ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
