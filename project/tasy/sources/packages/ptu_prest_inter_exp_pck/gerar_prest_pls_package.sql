-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Gerar os prestadores da operadora
CREATE OR REPLACE PROCEDURE ptu_prest_inter_exp_pck.gerar_prest_pls ( nr_seq_lote_p pls_lote_prestador_interc.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, dt_exclusao_ini_p timestamp, dt_exclusao_fim_p timestamp, dt_contrato_ini_p timestamp, dt_contrato_fim_p timestamp, dt_servico_ini_p timestamp, dt_servico_fim_p timestamp, nr_seq_tipo_prestador_p pls_prestador.nr_seq_tipo_prestador%type) AS $body$
DECLARE


ie_inserir_w		varchar(50) := 'S';

C01 CURSOR(nr_seq_lote_pc			pls_lote_prestador_interc.nr_sequencia%type,
		cd_estabelecimento_pc		estabelecimento.cd_estabelecimento%type,
		nr_seq_prestador_pc		pls_prestador.nr_sequencia%type,
		nr_seq_tipo_prestador_pc	pls_prestador.nr_seq_tipo_prestador%type) FOR
	SELECT	a.nr_sequencia nr_seq_prestador,
		trunc(a.dt_exclusao) dt_exclusao,
		trunc(a.dt_inicio_servico) dt_inicio_servico,
		trunc(a.dt_inicio_contrato) dt_inicio_contrato,
		trunc(a.dt_fim_contrato) dt_fim_contrato,
		substr(elimina_caractere_especial(obter_dados_pf(a.cd_pessoa_fisica, 'CPF')),1,14) nr_cpf,
		substr(a.cd_cgc,1,14) cd_cgc,
		substr(elimina_caractere_especial(obter_nome_pf(a.cd_pessoa_fisica)),1,60) nm_pessoa_fisica,
		substr(elimina_caractere_especial(obter_dados_pf_pj(null,a.cd_cgc,'N')),1,60) ds_razao_social,
		CASE WHEN a.ie_tipo_relacao='P' THEN '1000'  ELSE '2000' END  ie_tipo,
		substr(pls_obter_dados_prestador(a.nr_sequencia,'IBGEC'),1,7) cd_municipio_ibge,
		CASE WHEN a.ie_tipo_relacao='C' THEN 'D' WHEN a.ie_tipo_relacao='D' THEN 'D' WHEN a.ie_tipo_relacao='I' THEN 'I' WHEN a.ie_tipo_relacao='N' THEN 'I' WHEN a.ie_tipo_relacao='P' THEN 'D' END  ie_contratacao,
		trunc(a.dt_inicio_contrato) dt_contratacao,
		substr(pls_obter_cnes_prestador(a.nr_sequencia),1,7) cd_cnes,
		trunc(a.dt_cadastro) dt_vinculo,
		a.ie_tipo_classif_ptu cd_classificacao,
		null cd_ans_int,
		'T' ie_disponibilidade_serv,
		a.ie_urgencia_emergencia ie_urgencia_emergencia
	from	pls_prestador	a
	where	a.ie_tipo_relacao != 'F'
	and	a.cd_estabelecimento		= cd_estabelecimento_pc
	and (a.nr_sequencia			= nr_seq_prestador_pc or coalesce(nr_seq_prestador_pc::text, '') = '')
	and (a.nr_seq_tipo_prestador	= nr_seq_tipo_prestador_pc or coalesce(nr_seq_tipo_prestador_pc::text, '') = '')
	and	not exists (SELECT	1
				from	pls_prestador_interc_movto m
				where	m.nr_seq_lote		= nr_seq_lote_pc
				and	m.nr_seq_prestador	= a.nr_sequencia);

BEGIN
for r_c01_w in c01( nr_seq_lote_p, cd_estabelecimento_p, nr_seq_prestador_p, nr_seq_tipo_prestador_p ) loop
	ie_inserir_w := 'S';

	if	((dt_exclusao_ini_p IS NOT NULL AND dt_exclusao_ini_p::text <> '') or (dt_exclusao_fim_p IS NOT NULL AND dt_exclusao_fim_p::text <> '')) and (not(r_c01_w.dt_exclusao between coalesce(dt_exclusao_ini_p, r_c01_w.dt_exclusao) and coalesce(dt_exclusao_fim_p, r_c01_w.dt_exclusao)) or (coalesce(r_c01_w.dt_exclusao::text, '') = '')) then
		ie_inserir_w	:= 'N';
	end if;

	if	((dt_servico_ini_p IS NOT NULL AND dt_servico_ini_p::text <> '') or (dt_servico_fim_p IS NOT NULL AND dt_servico_fim_p::text <> '')) and (not(r_c01_w.dt_inicio_servico between coalesce(dt_servico_ini_p, r_c01_w.dt_inicio_servico) and coalesce(dt_servico_fim_p, r_c01_w.dt_inicio_servico)) or (coalesce(r_c01_w.dt_inicio_servico::text, '') = '')) then
		ie_inserir_w	:= 'N';
	end if;

	if (dt_contrato_ini_p IS NOT NULL AND dt_contrato_ini_p::text <> '') then
		if (r_c01_w.dt_inicio_contrato IS NOT NULL AND r_c01_w.dt_inicio_contrato::text <> '') and (not(r_c01_w.dt_inicio_contrato between dt_contrato_ini_p and coalesce(dt_contrato_fim_p, r_c01_w.dt_inicio_contrato))) then
			ie_inserir_w	:= 'N';
		elsif (coalesce(r_c01_w.dt_inicio_contrato::text, '') = '') then
			ie_inserir_w	:= 'N';
		end if;
	end if;

	if (dt_contrato_fim_p IS NOT NULL AND dt_contrato_fim_p::text <> '') then
		if (r_c01_w.dt_fim_contrato IS NOT NULL AND r_c01_w.dt_fim_contrato::text <> '') and (not(r_c01_w.dt_fim_contrato between coalesce(dt_contrato_ini_p, r_c01_w.dt_fim_contrato) and dt_contrato_fim_p)) then
			ie_inserir_w	:= 'N';
		end if;

		if (dt_contrato_fim_p < r_c01_w.dt_inicio_contrato) then
			ie_inserir_w	:= 'N';
		end if;
	end if;

	if (ie_inserir_w = 'S') then
		-- Inserir os prestadores
		CALL ptu_prest_inter_exp_pck.inserir_prestadores(	nr_seq_lote_p, cd_estabelecimento_p, nm_usuario_p, coalesce(r_c01_w.cd_cgc,r_c01_w.nr_cpf),
					coalesce(r_c01_w.ds_razao_social,r_c01_w.nm_pessoa_fisica), r_c01_w.ie_tipo, r_c01_w.cd_municipio_ibge, r_c01_w.ie_contratacao,
					r_c01_w.dt_contratacao, r_c01_w.cd_cnes, r_c01_w.dt_vinculo, r_c01_w.cd_classificacao,
					r_c01_w.cd_ans_int, r_c01_w.ie_disponibilidade_serv, r_c01_w.ie_urgencia_emergencia, r_c01_w.nr_seq_prestador);
	end if;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_prest_inter_exp_pck.gerar_prest_pls ( nr_seq_lote_p pls_lote_prestador_interc.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, dt_exclusao_ini_p timestamp, dt_exclusao_fim_p timestamp, dt_contrato_ini_p timestamp, dt_contrato_fim_p timestamp, dt_servico_ini_p timestamp, dt_servico_fim_p timestamp, nr_seq_tipo_prestador_p pls_prestador.nr_seq_tipo_prestador%type) FROM PUBLIC;
