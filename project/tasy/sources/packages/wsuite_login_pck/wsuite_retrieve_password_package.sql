-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wsuite_login_pck.wsuite_retrieve_password ( ds_login_p wsuite_usuario.ds_login%type, ds_path_p wsuite_token.ds_path%type, ds_endereco_ip_p wsuite_log_portal.ds_endereco_ip%type, ds_email_p INOUT text, ds_endereco_p INOUT text, cd_cep_p INOUT text, sg_estado_p INOUT text, nr_telefone_p INOUT text, ds_razao_social_p INOUT pessoa_juridica.ds_razao_social%type, ds_email_remetente_p INOUT wsuite_configuracao.ds_email_remetente%type, ds_link_retrieve_p INOUT text, ds_token_p INOUT wsuite_token.ds_token%type, ie_novo_usuario_p text default 'N') AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finality: Recover password, used in the option Forgot password
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Caution
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


id_subject_w	wsuite_usuario.id_subject%type;
ds_observacao_w	wsuite_log_portal.ds_observacao%type;
ds_token_w	wsuite_token.ds_token%type;
qt_expiration_token_w bigint;


BEGIN

qt_expiration_token_w := coalesce(TWS_OBTER_PARAM_TIPO_LOGIN(coalesce(current_setting('wsuite_login_pck.cd_estabelecimento_pck')::estabelecimento.cd_estabelecimento%type,wheb_usuario_pck.get_cd_estabelecimento),9111,11),24);

select	max(id_subject)
into STRICT	id_subject_w
from	wsuite_usuario
where	ds_login = ds_login_p;


if (id_subject_w IS NOT NULL AND id_subject_w::text <> '') then

	select	max(ds_token)
	into STRICT	ds_token_w
	from	wsuite_token
	where	id_subject = id_subject_w
	and	coalesce(dt_used::text, '') = ''
	and	dt_expiration > clock_timestamp();
	
	

	if (ds_token_w IS NOT NULL AND ds_token_w::text <> '')  then
		ds_token_p := ds_token_w;	
	else
		ds_token_p := wsuite_login_pck.wsuite_generate_hash();

		insert into wsuite_token( 	nr_sequencia, dt_atualizacao, nm_usuario,
						dt_atualizacao_nrec, nm_usuario_nrec, ds_token,
						ds_path, dt_generation, dt_expiration,
						ie_process, dt_used, id_subject)
					values ( nextval('wsuite_token_seq'), clock_timestamp(), ds_login_p,
						clock_timestamp(), ds_login_p, ds_token_p,
						ds_path_p, clock_timestamp(), (clock_timestamp() + qt_expiration_token_w/24 ),
						'RP', null, id_subject_w);
		commit;
	end if;
	--Forgot password

	ds_observacao_w := '';
	ds_link_retrieve_p := ds_path_p || '?token=' || ds_token_p;
	SELECT * FROM wsuite_login_pck.wsuite_data_email_wsuite( 	ds_email_p, ds_endereco_p, cd_cep_p, sg_estado_p, nr_telefone_p, ds_razao_social_p, ds_email_remetente_p) INTO STRICT  	ds_email_p, ds_endereco_p, cd_cep_p, sg_estado_p, nr_telefone_p, ds_razao_social_p, ds_email_remetente_p;

	--Generate log

	if (ie_novo_usuario_p = 'S') then
		CALL wsuite_save_log( '12', ds_observacao_w, ds_endereco_ip_p, ds_login_p );
	else
		CALL wsuite_save_log( '3', ds_observacao_w, ds_endereco_ip_p, ds_login_p );
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_login_pck.wsuite_retrieve_password ( ds_login_p wsuite_usuario.ds_login%type, ds_path_p wsuite_token.ds_path%type, ds_endereco_ip_p wsuite_log_portal.ds_endereco_ip%type, ds_email_p INOUT text, ds_endereco_p INOUT text, cd_cep_p INOUT text, sg_estado_p INOUT text, nr_telefone_p INOUT text, ds_razao_social_p INOUT pessoa_juridica.ds_razao_social%type, ds_email_remetente_p INOUT wsuite_configuracao.ds_email_remetente%type, ds_link_retrieve_p INOUT text, ds_token_p INOUT wsuite_token.ds_token%type, ie_novo_usuario_p text default 'N') FROM PUBLIC;
