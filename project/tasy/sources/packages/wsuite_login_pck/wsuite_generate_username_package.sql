-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wsuite_login_pck.wsuite_generate_username ( nr_cpf_p pessoa_fisica.nr_cpf%type, cd_rfc_p pessoa_fisica.cd_rfc%type, ds_email_p compl_pessoa_fisica.ds_email%type, nr_seq_wsuite_user_p wsuite_usuario.nr_sequencia%type, ie_tipo_login_p wsuite_usuario.ie_tipo_login%type, ds_replacement_login_p INOUT wsuite_usuario.nm_usuario_web%type, ds_alternative_login_p INOUT wsuite_usuario.ds_alternative_login%type, ds_login_p INOUT usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finality: Generate username and Tasy control user
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Caution:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


ds_sigla_w 			varchar(5);
ds_login_w			varchar(15);
ds_replacemento_login_w		varchar(100);
ds_alternative_login_w		varchar(50);
ie_reg_w			varchar(1) := 'N';


C01 CURSOR( ds_alternative_login_pc 	wsuite_usuario.ds_alternative_login%type )FOR
	SELECT	count(1) qt_registro
	from	wsuite_usuario
	where	ds_alternative_login = ds_alternative_login_pc;

BEGIN

-- Pacient User

if ( ie_tipo_login_p = 'PA' ) then
	ds_sigla_w := 'WPA00';

	ds_login_w 		:= ds_sigla_w || nr_seq_wsuite_user_p;
	ds_replacemento_login_w := ds_email_p;
	ds_alternative_login_w	:= substr(ds_email_p,1,position('@' in ds_email_p)-1);

	
	--Verify that the alternate login is already in use, if it is being used then concatenates a random number

	while( ie_reg_w = 'N' ) loop
		for c01_w in c01( ds_alternative_login_w ) loop
			
			if ( c01_w.qt_registro = 0) then
				ie_reg_w := 'S';
			else
				ds_alternative_login_w := ds_alternative_login_w || round(dbms_random.value(1,999));
			end if;		
		end loop;
	end loop;
end if;

ds_login_p		:= ds_login_w;
ds_replacement_login_p	:= ds_replacemento_login_w;
ds_alternative_login_p  := ds_alternative_login_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_login_pck.wsuite_generate_username ( nr_cpf_p pessoa_fisica.nr_cpf%type, cd_rfc_p pessoa_fisica.cd_rfc%type, ds_email_p compl_pessoa_fisica.ds_email%type, nr_seq_wsuite_user_p wsuite_usuario.nr_sequencia%type, ie_tipo_login_p wsuite_usuario.ie_tipo_login%type, ds_replacement_login_p INOUT wsuite_usuario.nm_usuario_web%type, ds_alternative_login_p INOUT wsuite_usuario.ds_alternative_login%type, ds_login_p INOUT usuario.nm_usuario%type) FROM PUBLIC;
