-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wsuite_login_pck.wsuite_resend_activation_link ( nr_sequencia_p wsuite_usuario.nr_sequencia%type, ie_type_p text, ds_email_remetente_p INOUT wsuite_configuracao.ds_email_remetente%type, ds_link_retrieve_p INOUT text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finality: 
	RA    Resend Activation Link
  RP    Resend Password Link  
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


ds_path_w		wsuite_token.ds_path%type;
ds_login_w		wsuite_usuario.ds_login%type;
ds_token_hash_w  		wsuite_token.ds_token%type;
id_subject_w   		subject.id%type;
ie_aplicacao_w		wsuite_configuracao.ie_aplicacao%type;
out_var_w 		varchar(255);
qt_expiration_token_w bigint;


BEGIN
	qt_expiration_token_w := coalesce(TWS_OBTER_PARAM_TIPO_LOGIN(coalesce(current_setting('wsuite_login_pck.cd_estabelecimento_pck')::estabelecimento.cd_estabelecimento%type,wheb_usuario_pck.get_cd_estabelecimento),9111,11),24);

  select MAX(b.DS_LOGIN),
		 CASE WHEN max(ds_client)='PROPOSALHPMS' THEN  3 WHEN max(ds_client)='PATIENT' THEN  1 WHEN max(ds_client)='HEALTHPROFESSIONAL' THEN  5 WHEN max(ds_client)='BENEFICIARY' THEN  2 WHEN max(ds_client)='CONCURRENTAUDIT' THEN  4 WHEN max(ds_client)='RESULTSPORTAL' THEN  7 WHEN max(ds_client)='STIPULATOR' THEN  6 WHEN max(ds_client)='PROVIDERACCREDITATION' THEN  8 WHEN max(ds_client)='PROVIDERHPMS' THEN  9  ELSE null END  ie_aplicacao
  INTO STRICT ds_login_w,
	   ie_aplicacao_w
  from 	wsuite_usuario b,
		wsuite_subject_client_v c
  where c.id_subject = b.id_subject
  and b.nr_sequencia = nr_sequencia_p;

  SELECT concat(ds_link_web_suite,CASE WHEN ie_type_p ='RA' THEN  'resend-link' WHEN ie_type_p ='RP' THEN  'reset-password' END ),
    ds_email_remetente
  INTO STRICT ds_path_w,
    ds_email_remetente_p
  FROM wsuite_configuracao
  WHERE cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
  and   ie_aplicacao = ie_aplicacao_w  LIMIT 1;

IF (ie_type_p = 'RP') THEN
  SELECT * FROM wsuite_login_pck.wsuite_retrieve_password(ds_login_w, ds_path_w, '', out_var_w, out_var_w, out_var_w, out_var_w, out_var_w, out_var_w, out_var_w, ds_link_retrieve_p, out_var_w) INTO STRICT out_var_w, out_var_w, out_var_w, out_var_w, out_var_w, out_var_w, out_var_w, ds_link_retrieve_p, out_var_w;

ELSE
  SELECT ID INTO STRICT id_subject_w  FROM SUBJECT
  WHERE DS_LOGIN      = ds_login_w;
  ds_token_hash_w    :=  wsuite_login_pck.wsuite_generate_hash();
  ds_link_retrieve_p := ds_path_w || '/' || ds_token_hash_w;

  INSERT
  INTO wsuite_token( nr_sequencia, dt_atualizacao,  nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, ds_token,
      ds_path, dt_generation, dt_expiration, ie_process, dt_used, id_subject )
    VALUES ( nextval('wsuite_token_seq'), clock_timestamp(),  ds_login_w,  clock_timestamp(),  ds_login_w,  ds_token_hash_w,
      ds_path_w, clock_timestamp(), (clock_timestamp() + qt_expiration_token_w/24 ), 'LC', NULL, id_subject_w);

END IF;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_login_pck.wsuite_resend_activation_link ( nr_sequencia_p wsuite_usuario.nr_sequencia%type, ie_type_p text, ds_email_remetente_p INOUT wsuite_configuracao.ds_email_remetente%type, ds_link_retrieve_p INOUT text) FROM PUBLIC;
