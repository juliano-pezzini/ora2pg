-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wsuite_login_pck.wsuite_validate_data ( nr_cpf_p pessoa_fisica.nr_cpf%type, nr_identidade_p pessoa_fisica.nr_identidade%type, cd_rfc_p pessoa_fisica.cd_rfc%type, nr_passaporte_p pessoa_fisica.nr_passaporte%type, nm_pessoa_fisica_p pessoa_fisica.nm_pessoa_fisica%type, dt_nascimento_p pessoa_fisica.dt_nascimento%type, ds_email_p compl_pessoa_fisica.ds_email%type, cd_usuario_plano_p pls_segurado_carteira.cd_usuario_plano%type, nr_seq_termo_uso_p wsuite_termo_uso.nr_sequencia%type, ds_retorno_p INOUT text, ds_retorno_cod_p INOUT text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finality: Check the input parameters from users to use on web-wuite .
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  x] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Caution:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */

ds_replacement_login_w	 	wsuite_usuario.nm_usuario_web%type;
ds_alternative_login_w		wsuite_usuario.ds_alternative_login%type;
ds_login_w			usuario.nm_usuario%type;

ds_email_w		compl_pessoa_fisica.ds_email%type;
ds_retorno_w     	varchar(100);
ds_retorno_cod_w 	varchar(100);
sql_from_str     	varchar(4000) := '';
sql_constr_str   	varchar(4000) := '';
cd_pessoa_fisica_w 	varchar(60);
qtd_registro_w 		integer;
v_select 		integer;
v_execute 		integer;


BEGIN

--check the mandatory fields

if 	( 	( coalesce(dt_nascimento_p::text, '') = '' or coalesce(ds_email_p::text, '') = '' or coalesce(nr_seq_termo_uso_p::text, '') = '')
		or ( coalesce(cd_rfc_p::text, '') = '' and coalesce(nr_passaporte_p::text, '') = '' and coalesce(nr_cpf_p::text, '') = '' and coalesce(nr_identidade_p::text, '') = '') ) then
	ds_retorno_cod_p := '04';
else
	sql_from_str := ' select count(1) over() qt_registro, '|| current_setting('wsuite_login_pck.enter_w')::varchar(2) ||
			'	cd_pessoa_fisica, '|| current_setting('wsuite_login_pck.enter_w')::varchar(2) ||
			'	obter_compl_pf(cd_pessoa_fisica,1,''M'') ds_email ' || current_setting('wsuite_login_pck.enter_w')::varchar(2) ||
			' from pessoa_fisica '|| current_setting('wsuite_login_pck.enter_w')::varchar(2) ||
			' where 1 = 1 ';

	if (dt_nascimento_p IS NOT NULL AND dt_nascimento_p::text <> '')then
		sql_constr_str := sql_constr_str || ' and dt_nascimento = :dt_nascimento ' || current_setting('wsuite_login_pck.enter_w')::varchar(2);
	end if;

	if (nr_cpf_p IS NOT NULL AND nr_cpf_p::text <> '') then
		sql_constr_str := sql_constr_str || ' and nr_cpf = :nr_cpf '|| current_setting('wsuite_login_pck.enter_w')::varchar(2);
	end if;

	if (nr_identidade_p IS NOT NULL AND nr_identidade_p::text <> '') then
		sql_constr_str := sql_constr_str || ' and nr_identidade = :nr_identidade '|| current_setting('wsuite_login_pck.enter_w')::varchar(2);
	end if;

	if (cd_rfc_p IS NOT NULL AND cd_rfc_p::text <> '')then
		sql_constr_str := sql_constr_str || ' and cd_rfc = :cd_rfc '|| current_setting('wsuite_login_pck.enter_w')::varchar(2);
	end if;

	if (nr_passaporte_p IS NOT NULL AND nr_passaporte_p::text <> '')then
		sql_constr_str := sql_constr_str || ' and nr_passaporte = :nr_passaporte '|| current_setting('wsuite_login_pck.enter_w')::varchar(2);
	end if;

	/* setup cursor for bind*/


	v_select := dbms_sql.open_cursor;
	dbms_sql.parse( v_select, sql_from_str || sql_constr_str, dbms_sql.native);

	dbms_sql.define_column(v_select, 1,qtd_registro_w);
	dbms_sql.define_column(v_select, 2,cd_pessoa_fisica_w,100);
	dbms_sql.define_column(v_select, 3,ds_email_w,500);

	if (dt_nascimento_p IS NOT NULL AND dt_nascimento_p::text <> '')then
		dbms_sql.bind_variable(v_select, ':dt_nascimento',dt_nascimento_p);
	end if;

	if (nr_cpf_p IS NOT NULL AND nr_cpf_p::text <> '')then
		dbms_sql.bind_variable(v_select, ':nr_cpf',nr_cpf_p);
	end if;

	if (nr_identidade_p IS NOT NULL AND nr_identidade_p::text <> '')then
		dbms_sql.bind_variable(v_select, ':nr_identidade',nr_identidade_p);
	end if;

	if (cd_rfc_p IS NOT NULL AND cd_rfc_p::text <> '')then
		dbms_sql.bind_variable(v_select, ':cd_rfc',cd_rfc_p);
	end if;

	if (nr_passaporte_p IS NOT NULL AND nr_passaporte_p::text <> '')then
		dbms_sql.bind_variable(v_select, ':nr_passaporte',nr_passaporte_p);
	end if;

	v_execute := dbms_sql.execute( v_select );

	loop
		exit when dbms_sql.fetch_rows(v_select) = 0;

		if ( dbms_sql.last_row_count > 1) then
			exit;
		end if;

		dbms_sql.column_value(v_select,1,qtd_registro_w);
		dbms_sql.column_value(v_select,2,cd_pessoa_fisica_w);
		dbms_sql.column_value(v_select,3,ds_email_w);

	end loop;
	dbms_sql.close_cursor(v_select);

	/*Message return:
	01:  User found
	02: User not found
	03:  Duplicated data - The user's registration is duplicate. Please check with the institution.
	04: Mandatory field
	05: Existing user -  There is a user already registered with those data.
	06: Incompatible data - The user's data are incomplete. Please check with the institution. */


	ds_retorno_cod_p 	:= '01';
	ds_retorno_p 		:= cd_pessoa_fisica_w;

	if ( coalesce(qtd_registro_w::text, '') = '' ) then
		ds_retorno_cod_p := '02';
	elsif ( ds_email_p <> ds_email_w ) then
		ds_retorno_p := '';
		ds_retorno_cod_p := '06';
	elsif ( qtd_registro_w > 1 ) then
		ds_retorno_p := '';
		ds_retorno_cod_p := '03';
	elsif (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
		ds_retorno_cod_p 	:= '02';
		ds_retorno_p		:= null;		
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_login_pck.wsuite_validate_data ( nr_cpf_p pessoa_fisica.nr_cpf%type, nr_identidade_p pessoa_fisica.nr_identidade%type, cd_rfc_p pessoa_fisica.cd_rfc%type, nr_passaporte_p pessoa_fisica.nr_passaporte%type, nm_pessoa_fisica_p pessoa_fisica.nm_pessoa_fisica%type, dt_nascimento_p pessoa_fisica.dt_nascimento%type, ds_email_p compl_pessoa_fisica.ds_email%type, cd_usuario_plano_p pls_segurado_carteira.cd_usuario_plano%type, nr_seq_termo_uso_p wsuite_termo_uso.nr_sequencia%type, ds_retorno_p INOUT text, ds_retorno_cod_p INOUT text) FROM PUBLIC;
