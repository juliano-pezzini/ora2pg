-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wsuite_login_pck.wsuite_include_request ( ds_given_name_P person_name.ds_given_name%type, ds_family_name_P person_name.ds_family_name%type, ds_component_name1_P person_name.ds_component_name_1%type, ds_component_name2_P person_name.ds_component_name_2%type, ds_component_name3_P person_name.ds_component_name_3%type, nr_cpf_p pessoa_fisica.nr_cpf%type, nr_identidade_p pessoa_fisica.nr_identidade%type, cd_rfc_p pessoa_fisica.cd_rfc%type, nm_pessoa_fisica_p pessoa_fisica.nm_pessoa_fisica%type, dt_nascimento_p pessoa_fisica.dt_nascimento%type, ds_email_p compl_pessoa_fisica.ds_email%type, ie_sexo_p pessoa_fisica.ie_sexo%type, cd_usuario_plano_p pls_segurado_carteira.cd_usuario_plano%type, nr_ddd_celular_p pessoa_fisica.nr_ddd_celular%type, nr_telefone_celular_p pessoa_fisica.nr_telefone_celular%type, cd_cep_p compl_pessoa_fisica.cd_cep%type, ds_endereco_p compl_pessoa_fisica.ds_endereco%type, cd_municipio_ibge_p compl_pessoa_fisica.cd_municipio_ibge%type, nr_seq_pais_p pais.nr_sequencia%type, nr_passaporte_p pessoa_fisica.nr_passaporte%type, sg_estado_p compl_pessoa_fisica.sg_estado%type, ds_municipio_p compl_pessoa_fisica.ds_municipio%type, nr_endereco_p compl_pessoa_fisica.nr_endereco%type, ds_bairro_p compl_pessoa_fisica.ds_bairro%type, nr_ddi_celular_p wsuite_solic_inclusao_pf.nr_ddi_celular%type, nr_crm_p wsuite_solic_inclusao_pf.nr_crm%type, cd_especialidade_p wsuite_solic_inclusao_pf.cd_especialidade%type, uf_crm_p wsuite_solic_inclusao_pf.uf_crm%type, ie_origem_solicitacao_p wsuite_solic_inclusao_pf.ie_origem_solicitacao%type, sg_departamento_p pessoa_fisica_aux.sg_departamento%type, nr_digito_verif_p pessoa_fisica_aux.nr_digito_verif%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_solic_inclusao_p INOUT wsuite_solic_inclusao_pf.nr_sequencia%type) AS $body$
DECLARE


nr_seq_solic_w	 	wsuite_solic_inclusao_pf.nr_sequencia%type;
nr_seq_person_name_w	person_name.nr_sequencia%type;
nm_pessoa_fisica_w	pessoa_fisica.nm_pessoa_fisica%type;



BEGIN


if ( (nm_pessoa_fisica_p IS NOT NULL AND nm_pessoa_fisica_p::text <> '') or (ds_given_name_p IS NOT NULL AND ds_given_name_p::text <> '') ) then
	nm_pessoa_fisica_w := nm_pessoa_fisica_p;

	if (ds_given_name_p IS NOT NULL AND ds_given_name_p::text <> '') then

		insert	into person_name( 	nr_sequencia, dt_atualizacao, nm_usuario,
						dt_atualizacao_nrec, nm_usuario_nrec, ds_type,
						ds_given_name, ds_family_name, ds_component_name_1,
						ds_component_name_2, ds_component_name_3)
					values (	nextval('person_name_seq'), clock_timestamp(), nm_usuario_p,
						clock_timestamp(), nm_usuario_p, 'main',
						ds_given_name_p, ds_family_name_p, ds_component_name1_p,
						ds_component_name2_p, ds_component_name3_p)  returning nr_sequencia into nr_seq_person_name_w;
		--Concatenate the person's name

		nm_pessoa_fisica_w :=  coalesce(pkg_name_utils.get_person_name(nr_seq_person_name_w, current_setting('wsuite_login_pck.cd_estabelecimento_pck')::estabelecimento.cd_estabelecimento%type, 'full', 'main'), ds_given_name_p||' '||ds_component_name1_p||' '||ds_family_name_p);



	end if;

	insert into wsuite_solic_inclusao_pf( 	nr_sequencia, dt_atualizacao, nm_usuario,
						dt_atualizacao_nrec, nm_usuario_nrec, nm_pessoa_fisica,
						dt_nascimento, nr_cpf, ds_email, ds_endereco,
						nr_telefone_celular, nr_ddd_celular, nr_identidade, cd_rfc, ie_status,
						cd_municipio_ibge, nr_seq_pais, nr_passaporte,
						sg_estado, ds_municipio, ie_sexo,
						nr_endereco, ds_bairro, nr_ddi_celular,
						nr_crm,	cd_especialidade, uf_crm, cd_cep,
						dt_solicitacao, nr_seq_person_name, ie_origem_solicitacao,
						sg_departamento, nr_digito_verif)
				      values (	nextval('wsuite_solic_inclusao_pf_seq'), clock_timestamp(), nm_usuario_p,
						clock_timestamp(), nm_usuario_p, nm_pessoa_fisica_w,
						dt_nascimento_p, nr_cpf_p, ds_email_p,
						ds_endereco_p, nr_telefone_celular_p, nr_ddd_celular_p,
						nr_identidade_p, cd_rfc_p, 1,
						cd_municipio_ibge_p, nr_seq_pais_p, nr_passaporte_p,
						sg_estado_p, ds_municipio_p, ie_sexo_p,
						nr_endereco_p, ds_bairro_p, nr_ddi_celular_p,
						nr_crm_p,cd_especialidade_p, uf_crm_p, cd_cep_p,
						clock_timestamp(), nr_seq_person_name_w, ie_origem_solicitacao_p,
						sg_departamento_p, nr_digito_verif_p)  returning nr_sequencia into nr_seq_solic_w;
	commit;
	
	CALL CALL wsuite_login_pck.wsuite_generate_homonym( nm_pessoa_fisica_w, dt_nascimento_p, nr_cpf_p, cd_rfc_p, sg_departamento_p, nr_digito_verif_p, nr_seq_solic_w, 'Web-Suite');

end if;

nr_seq_solic_inclusao_p := nr_seq_solic_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_login_pck.wsuite_include_request ( ds_given_name_P person_name.ds_given_name%type, ds_family_name_P person_name.ds_family_name%type, ds_component_name1_P person_name.ds_component_name_1%type, ds_component_name2_P person_name.ds_component_name_2%type, ds_component_name3_P person_name.ds_component_name_3%type, nr_cpf_p pessoa_fisica.nr_cpf%type, nr_identidade_p pessoa_fisica.nr_identidade%type, cd_rfc_p pessoa_fisica.cd_rfc%type, nm_pessoa_fisica_p pessoa_fisica.nm_pessoa_fisica%type, dt_nascimento_p pessoa_fisica.dt_nascimento%type, ds_email_p compl_pessoa_fisica.ds_email%type, ie_sexo_p pessoa_fisica.ie_sexo%type, cd_usuario_plano_p pls_segurado_carteira.cd_usuario_plano%type, nr_ddd_celular_p pessoa_fisica.nr_ddd_celular%type, nr_telefone_celular_p pessoa_fisica.nr_telefone_celular%type, cd_cep_p compl_pessoa_fisica.cd_cep%type, ds_endereco_p compl_pessoa_fisica.ds_endereco%type, cd_municipio_ibge_p compl_pessoa_fisica.cd_municipio_ibge%type, nr_seq_pais_p pais.nr_sequencia%type, nr_passaporte_p pessoa_fisica.nr_passaporte%type, sg_estado_p compl_pessoa_fisica.sg_estado%type, ds_municipio_p compl_pessoa_fisica.ds_municipio%type, nr_endereco_p compl_pessoa_fisica.nr_endereco%type, ds_bairro_p compl_pessoa_fisica.ds_bairro%type, nr_ddi_celular_p wsuite_solic_inclusao_pf.nr_ddi_celular%type, nr_crm_p wsuite_solic_inclusao_pf.nr_crm%type, cd_especialidade_p wsuite_solic_inclusao_pf.cd_especialidade%type, uf_crm_p wsuite_solic_inclusao_pf.uf_crm%type, ie_origem_solicitacao_p wsuite_solic_inclusao_pf.ie_origem_solicitacao%type, sg_departamento_p pessoa_fisica_aux.sg_departamento%type, nr_digito_verif_p pessoa_fisica_aux.nr_digito_verif%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_solic_inclusao_p INOUT wsuite_solic_inclusao_pf.nr_sequencia%type) FROM PUBLIC;
