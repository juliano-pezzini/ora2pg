-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wsuite_login_pck.wsuite_update_client ( nr_seq_regra_p wsuite_regra_login.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


				
--Object used in the Web Suite Management function

id_client_w		client.id%type;
qt_bloqueio_login_w	wsuite_regra_login.qt_bloqueio_login%type;
qt_dias_troca_senha_w	wsuite_regra_login.qt_dias_troca_senha%type;
	
C01 CURSOR(nr_seq_regra_pc wsuite_regra_login.nr_sequencia%type)  FOR

	SELECT  qt_bloqueio_login,
		qt_dias_troca_senha,
		CASE WHEN ie_aplicacao=1 THEN  'PATIENT' WHEN ie_aplicacao=2 THEN 'BENEFICIARY' WHEN ie_aplicacao=3 THEN 'PROPOSALHPMS' WHEN ie_aplicacao=4 THEN 'CONCURRENTAUDIT' WHEN ie_aplicacao=6 THEN 'STIPULATOR' WHEN ie_aplicacao=7 THEN 'RESULTSPORTAL' WHEN ie_aplicacao=8 THEN 'PROVIDERACCREDITATION' WHEN ie_aplicacao=9 THEN 'PROVIDERHPMS' WHEN ie_aplicacao=12 THEN 'PURCHASEPORTAL' WHEN ie_aplicacao=13 THEN 'CUSTOMERPORTAL' WHEN ie_aplicacao=14 THEN 'CUSTOMERPORTALADM'  ELSE '' END  ds_aplicacao
	from    wsuite_regra_login
	where   nr_sequencia = nr_seq_regra_pc
	and	(ie_aplicacao IS NOT NULL AND ie_aplicacao::text <> '');
	
BEGIN
	for c01_w in C01(nr_seq_regra_p) loop
	
		if (c01_w.ds_aplicacao IS NOT NULL AND c01_w.ds_aplicacao::text <> '') then
			select	max(id)
			into STRICT	id_client_w
			from	client
			where	ds_client = c01_w.ds_aplicacao;
			
			--User lockout cannot be greater than 10 attempts.

			if (  c01_w.qt_bloqueio_login > 10 or c01_w.qt_bloqueio_login < 0 ) then
				qt_bloqueio_login_w := 10;
			end if;
			
			if (  c01_w.qt_dias_troca_senha < 0 or coalesce(c01_w.qt_dias_troca_senha::text, '') = '' ) then
				qt_dias_troca_senha_w := 90;
			end if;
			
			update	client
			set	vl_allowed_login_attempts = coalesce(qt_bloqueio_login_w, c01_w.qt_bloqueio_login),
				vl_password_expires_after = coalesce(qt_dias_troca_senha_w, c01_w.qt_dias_troca_senha)
			where	id = id_client_w;
			
			commit;			
		end if;	
	end loop;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_login_pck.wsuite_update_client ( nr_seq_regra_p wsuite_regra_login.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
