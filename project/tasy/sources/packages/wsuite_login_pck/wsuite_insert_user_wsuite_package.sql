-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wsuite_login_pck.wsuite_insert_user_wsuite ( ie_tipo_login_p wsuite_usuario.ie_tipo_login%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_cpf_p pessoa_fisica.nr_cpf%type, cd_rfc_p pessoa_fisica.cd_rfc%type, ds_email_p compl_pessoa_fisica.ds_email%type, nr_seq_solic_inclusao_p wsuite_solic_inclusao_pf.nr_sequencia%type, nr_seq_termo_uso_p wsuite_termo_uso.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ds_replacement_login_p INOUT wsuite_usuario.nm_usuario_web%type, ds_alternative_login_p INOUT wsuite_usuario.ds_alternative_login%type, ds_login_p INOUT wsuite_usuario.ds_login%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finality: Insert user on the Web Suite users table, it is necessary to control users on the Tasy System
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Caution:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


nr_seq_wsuite_usuario_w		wsuite_usuario.nr_sequencia%type;
ds_alternative_login_w		wsuite_usuario.ds_alternative_login%type;
ds_replacement_login_w	 	wsuite_usuario.nm_usuario_web%type;
ds_login_w			wsuite_usuario.ds_login%type;
ds_hash_w			wsuite_usuario.ds_hash_ativacao%type;


C01 CURSOR FOR
	SELECT	nm_usuario_web,
		ds_login
	from	wsuite_usuario
	where	nr_seq_inclusao_pf = nr_seq_solic_inclusao_p;

C02 CURSOR FOR
	SELECT	nm_usuario_web,
		ds_login
	from	wsuite_usuario
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;

BEGIN

--If a user already exists for the include request, the system should not regenerate

if (nr_seq_solic_inclusao_p IS NOT NULL AND nr_seq_solic_inclusao_p::text <> '') then

	for c01_w in C01 loop
		ds_replacement_login_w  := c01_w.nm_usuario_web;
		ds_login_w		:= c01_w.ds_login;
	end loop;

--If a user already exists for the person code, the system should not regenerate

elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	for c02_w in C02 loop
		ds_replacement_login_w  := c02_w.nm_usuario_web;
		ds_login_w		:= c02_w.ds_login;
	end loop;
end if;

if ( (ds_email_p IS NOT NULL AND ds_email_p::text <> '') and ie_tipo_login_p = 'PA' and coalesce(ds_replacement_login_w::text, '') = '' ) then

	select	nextval('wsuite_usuario_seq')
	into STRICT	nr_seq_wsuite_usuario_w
	;

	--Only return the user name

	SELECT * FROM wsuite_login_pck.wsuite_generate_username( nr_cpf_p, cd_rfc_p, ds_email_p, nr_seq_wsuite_usuario_w, ie_tipo_login_p, ds_replacement_login_w, ds_alternative_login_w, ds_login_w ) INTO STRICT ds_replacement_login_w, ds_alternative_login_w, ds_login_w;

	ds_hash_w := wsuite_login_pck.wsuite_generate_hash();

	insert into wsuite_usuario(
		nr_sequencia, ie_situacao, nm_usuario_web,
		dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
		nm_usuario_nrec, id_subject, cd_pessoa_fisica,
		ds_login, ie_tipo_login, nr_seq_inclusao_pf,
		dt_criacao, ds_hash_ativacao, nr_seq_termo_uso,
		ds_alternative_login, ie_origem_conta)
	values (	nr_seq_wsuite_usuario_w, 'I', ds_replacement_login_w,
		clock_timestamp(), nm_usuario_p, clock_timestamp(),
		nm_usuario_p, null, cd_pessoa_fisica_p,
		ds_login_w, ie_tipo_login_p, nr_seq_solic_inclusao_p,
		clock_timestamp(), ds_hash_w, nr_seq_termo_uso_p,
		ds_alternative_login_w, 'AP');

	commit;
end if;

ds_alternative_login_p	:= ds_alternative_login_w;
ds_replacement_login_p 	:= ds_replacement_login_w;
ds_login_p		:= ds_login_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_login_pck.wsuite_insert_user_wsuite ( ie_tipo_login_p wsuite_usuario.ie_tipo_login%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_cpf_p pessoa_fisica.nr_cpf%type, cd_rfc_p pessoa_fisica.cd_rfc%type, ds_email_p compl_pessoa_fisica.ds_email%type, nr_seq_solic_inclusao_p wsuite_solic_inclusao_pf.nr_sequencia%type, nr_seq_termo_uso_p wsuite_termo_uso.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ds_replacement_login_p INOUT wsuite_usuario.nm_usuario_web%type, ds_alternative_login_p INOUT wsuite_usuario.ds_alternative_login%type, ds_login_p INOUT wsuite_usuario.ds_login%type) FROM PUBLIC;
