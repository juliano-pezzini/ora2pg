-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_visita_tecnica_prest_pck.enviar_email ( nr_seq_visita_p pls_visita_tecnica.nr_sequencia%type, nr_seq_auditor_p pls_visita_tecnica_auditor.nr_sequencia%type, ds_assunto_p pls_email.ds_assunto%type, ds_mensagem_p pls_email.ds_mensagem%type, ds_email_p pls_email.ds_destinatario%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

cd_estabelecimento_w	pls_visita_tecnica.cd_estabelecimento%type;
nm_auditor_w		varchar(255);
ds_prestador_w		varchar(255);
cd_prioridade_email_w	pls_email_parametros.cd_prioridade%type;
ds_assunto_w		pls_email.ds_assunto%type;
ds_mensagem_w		pls_email.ds_mensagem%type;
ds_email_w		pls_email.ds_destinatario%type;

BEGIN

if (coalesce(ds_assunto_p::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1211066);
end if;

if (coalesce(ds_mensagem_p::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1211067);
end if;

begin
select	a.cd_estabelecimento,
	coalesce(pls_obter_dados_prestador(a.nr_seq_prestador,'N'), coalesce(b.ds_razao_social,b.nm_fantasia)) ds_prestador
into STRICT	cd_estabelecimento_w,
	ds_prestador_w
FROM pls_visita_tecnica a
LEFT OUTER JOIN pls_creden_prestador b ON (a.nr_seq_credenciamento = b.nr_sequencia)
WHERE a.nr_sequencia		= nr_seq_visita_p;
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1207549); --Registro invalido
end;

begin
select	obter_nome_usuario(nm_usuario_auditor),
	Obter_dados_usuario_opcao(nm_usuario_auditor, 'E')
into STRICT	nm_auditor_w,
	ds_email_w
from	pls_visita_tecnica_auditor
where	nr_sequencia	= nr_seq_auditor_p;
exception
when others then
	nm_auditor_w	:= null;
end;

ds_email_w	:= coalesce(ds_email_p,ds_email_w);

if (coalesce(ds_email_w::text, '') = '') then
	if (nm_auditor_w IS NOT NULL AND nm_auditor_w::text <> '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1211064,'NM_AUDITOR='||nm_auditor_w);
	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1211065);
	end if;
end if;

select	coalesce(max(cd_prioridade),5)
into STRICT	cd_prioridade_email_w
from	pls_email_parametros
where	ie_origem		= '9'
and	cd_estabelecimento	= cd_estabelecimento_w
and	ie_situacao		= 'A';

ds_assunto_w	:= ds_assunto_p;
ds_mensagem_w	:= ds_mensagem_p;

ds_assunto_w	:= replace(ds_assunto_w,'@NR_VISITA',nr_seq_visita_p);
ds_assunto_w	:= replace(ds_assunto_w,'@NM_AUDITOR',nm_auditor_w);
ds_assunto_w	:= replace(ds_assunto_w,'@DS_PRESTADOR',ds_prestador_w);

ds_mensagem_w	:= replace(ds_mensagem_w,'@NR_VISITA',nr_seq_visita_p);
ds_mensagem_w	:= replace(ds_mensagem_w,'@NM_AUDITOR',nm_auditor_w);
ds_mensagem_w	:= replace(ds_mensagem_w,'@DS_PRESTADOR',ds_prestador_w);

insert	into	pls_email(	nr_sequencia, cd_estabelecimento, nm_usuario_nrec,
		dt_atualizacao_nrec, nm_usuario, dt_atualizacao,
		ie_tipo_mensagem, ie_status, ie_origem,
		ds_remetente, cd_prioridade, ds_destinatario,
		nr_seq_visita, ds_assunto, ds_mensagem )
	values (nextval('pls_email_seq'), cd_estabelecimento_w, nm_usuario_p,
		clock_timestamp(), nm_usuario_p, clock_timestamp(),
		'11', 'P', '9',
		null, cd_prioridade_email_w, ds_email_w,
		nr_seq_visita_p, ds_assunto_w, ds_mensagem_w );

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_visita_tecnica_prest_pck.enviar_email ( nr_seq_visita_p pls_visita_tecnica.nr_sequencia%type, nr_seq_auditor_p pls_visita_tecnica_auditor.nr_sequencia%type, ds_assunto_p pls_email.ds_assunto%type, ds_mensagem_p pls_email.ds_mensagem%type, ds_email_p pls_email.ds_destinatario%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
