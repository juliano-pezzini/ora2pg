-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_visita_tecnica_prest_pck.duplicar_formulario ( nr_seq_formulario_p pls_formulario_visita.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_formulario_w	pls_formulario_visita.nr_sequencia%type;
nr_seq_grupo_w		pls_formulario_visita_grup.nr_sequencia%type;
nr_seq_pergunta_w	pls_formulario_visita_perg.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	f.ds_formulario,
		f.cd_estabelecimento,
		f.nr_sequencia
	from	pls_formulario_visita f
	where	f.nr_sequencia = nr_seq_formulario_p;

C02 CURSOR(p_nr_seq_formulario bigint) FOR
	SELECT	g.ds_grupo,
		g.nr_ordem nr_ordem_grupo,
		g.nr_sequencia
	from	pls_formulario_visita_grup g
	where	g.nr_seq_formulario = p_nr_seq_formulario;

C03 CURSOR(p_nr_seq_grupo bigint) FOR
	SELECT	p.ds_pergunta,
		p.nr_ordem nr_ordem_pergunta,
		p.nr_sequencia
	from	pls_formulario_visita_perg p
	where	p.nr_seq_grupo = p_nr_seq_grupo;

C04 CURSOR(p_nr_seq_pergunta bigint) FOR
	SELECT	r.ds_resposta,
		r.qt_peso,
		r.ie_desconsiderar_pergunta,
		r.ie_exige_justificativa
	from	pls_formulario_visita_resp r
	where	r.nr_seq_pergunta = p_nr_seq_pergunta;
BEGIN
for c01_w in C01 loop
	begin
	
	-- Formulario
	insert	into	pls_formulario_visita(	nr_sequencia, ds_formulario, cd_estabelecimento,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec, ie_situacao)
		values (nextval('pls_formulario_visita_seq'), obter_desc_expressao(735670)||' '||c01_w.ds_formulario, c01_w.cd_estabelecimento,
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			nm_usuario_p, 'A')
		return;
	
	-- Grupo
	for c02_w in C02(c01_w.nr_sequencia) loop
		begin
		
		insert	into	pls_formulario_visita_grup(	nr_sequencia, nr_seq_formulario, ds_grupo,
				nr_ordem, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec)
			values (nextval('pls_formulario_visita_grup_seq'), nr_seq_formulario_w, c02_w.ds_grupo,
				c02_w.nr_ordem_grupo, clock_timestamp(), nm_usuario_p,
				clock_timestamp(), nm_usuario_p)
			returning nr_sequencia into nr_seq_grupo_w;
		
		-- Perguntas
		for c03_w in C03(c02_w.nr_sequencia) loop
			begin
			
			insert	into	pls_formulario_visita_perg(	nr_sequencia, nr_seq_grupo, ds_pergunta,
					nr_ordem, dt_atualizacao, nm_usuario,
					dt_atualizacao_nrec, nm_usuario_nrec)
				values (nextval('pls_formulario_visita_perg_seq'), nr_seq_grupo_w, c03_w.ds_pergunta,
					c03_w.nr_ordem_pergunta, clock_timestamp(), nm_usuario_p,
					clock_timestamp(), nm_usuario_p)
				returning nr_sequencia into nr_seq_pergunta_w;
			
			-- Respostas
			for c04_w in C04(c03_w.nr_sequencia) loop
				begin
				
				insert	into	pls_formulario_visita_resp(	nr_sequencia, nr_seq_pergunta, ds_resposta,
						qt_peso, dt_atualizacao, nm_usuario,
						dt_atualizacao_nrec, nm_usuario_nrec, ie_desconsiderar_pergunta,
						ie_exige_justificativa)
					values (nextval('pls_formulario_visita_resp_seq'), nr_seq_pergunta_w, c04_w.ds_resposta,
						c04_w.qt_peso, clock_timestamp(), nm_usuario_p,
						clock_timestamp(), nm_usuario_p, c04_w.ie_desconsiderar_pergunta,
						c04_w.ie_exige_justificativa);
				end;
			end loop; --C04
			
			end;
		end loop; --C03
		
		end;
	end loop; --C02
	
	insert	into	pls_formulario_visita_clas(	nr_sequencia, nr_seq_formulario, dt_atualizacao,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			nr_seq_classificacao, pr_inicial, pr_final )
		(SELECT	nextval('pls_formulario_visita_clas_seq'), nr_seq_formulario_w, clock_timestamp(),
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			a.nr_seq_classificacao, a.pr_inicial, a.pr_final
		from	pls_formulario_visita_clas a
		where	a.nr_seq_formulario	= nr_seq_formulario_p);
	end;
end loop; --C01
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_visita_tecnica_prest_pck.duplicar_formulario ( nr_seq_formulario_p pls_formulario_visita.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
