-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_visita_tecnica_prest_pck.duplicar_visita_form ( nr_seq_visita_form_p pls_visita_tecnica_form.nr_sequencia%type, ie_copiar_respostas_p text, nm_usuario_p usuario.nm_usuario%type, ie_commit_p text) AS $body$
DECLARE

nr_seq_visita_form_w	pls_visita_tecnica_form.nr_sequencia%type;
nr_seq_visita_w		pls_visita_tecnica_form.nr_seq_visita%type;
ie_responsavel_w	pls_visita_tecnica_form.ie_responsavel%type;
nr_seq_formulario_w	pls_visita_tecnica_form.nr_seq_formulario%type;
ie_status_w		pls_visita_tecnica_form.ie_status%type;

C01 CURSOR FOR
	SELECT	nr_seq_pergunta,
		CASE WHEN ie_copiar_respostas_p='S' THEN nr_seq_resposta  ELSE null END  nr_seq_resposta,
		CASE WHEN ie_copiar_respostas_p='S' THEN ds_justificativa  ELSE null END  ds_justificativa
	from	pls_visita_tecnica_form_pr
	where	nr_seq_visita_form	= nr_seq_visita_form_p
	order by nr_sequencia;

BEGIN

begin
select	nr_seq_visita,
	ie_responsavel,
	nr_seq_formulario,
	ie_status
into STRICT	nr_seq_visita_w,
	ie_responsavel_w,
	nr_seq_formulario_w,
	ie_status_w
from	pls_visita_tecnica_form
where	nr_sequencia	= nr_seq_visita_form_p;
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1207549); --Registro invalido
end;

if (ie_status_w <> 3) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1208755); --O formulario precisa estar preenchido para permitir a acao
end if;

insert	into	pls_visita_tecnica_form(	nr_sequencia, nr_seq_visita, ie_responsavel,
		nr_seq_formulario, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, ie_situacao,
		ie_status, nr_seq_form_origem )
	values (nextval('pls_visita_tecnica_form_seq'), nr_seq_visita_w, ie_responsavel_w,
		nr_seq_formulario_w, clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, 'A',
		1, nr_seq_visita_form_p )
	returning nr_sequencia into nr_seq_visita_form_w;

for c01_w in C01 loop
	begin
	
	insert	into	pls_visita_tecnica_form_pr(	nr_sequencia, nr_seq_visita_form, nr_seq_pergunta,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec, nr_seq_resposta, ds_justificativa )
		values (nextval('pls_visita_tecnica_form_pr_seq'), nr_seq_visita_form_w, c01_w.nr_seq_pergunta,
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			nm_usuario_p, c01_w.nr_seq_resposta, c01_w.ds_justificativa );
	
	end;
end loop;

update	pls_visita_tecnica_form
set	ie_situacao		= 'I',
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_seq_visita_form_p;

if (ie_commit_p = 'S') then
	commit;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_visita_tecnica_prest_pck.duplicar_visita_form ( nr_seq_visita_form_p pls_visita_tecnica_form.nr_sequencia%type, ie_copiar_respostas_p text, nm_usuario_p usuario.nm_usuario%type, ie_commit_p text) FROM PUBLIC;
