-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_visita_tecnica_prest_pck.cancelar_visita ( nr_seq_visita_p pls_visita_tecnica.nr_sequencia%type, nr_seq_motivo_cancel_p pls_visita_tecnica.nr_seq_motivo_cancel%type, nm_usuario_p usuario.nm_usuario%type, ie_commit_p text) AS $body$
DECLARE

nr_count_w			integer;
nr_seq_credenciamento_w		pls_creden_prestador.nr_sequencia%type;
ie_status_credenciamento_w	pls_creden_prestador.ie_status%type;
ie_status_visita_w		pls_visita_tecnica.ie_status%type;
ds_motivo_cancelamento_w	pls_motivo_cancel_visita.ds_motivo%type;

BEGIN

begin
select	a.ie_status,
	a.nr_seq_credenciamento,
	b.ie_status,
	(	select	max(x.ds_motivo)
		from	pls_motivo_cancel_visita x
		where	x.nr_sequencia	= nr_seq_motivo_cancel_p) ds_motivo_cancelamento
into STRICT	ie_status_visita_w,
	nr_seq_credenciamento_w,
	ie_status_credenciamento_w,
	ds_motivo_cancelamento_w
FROM pls_visita_tecnica a
LEFT OUTER JOIN pls_creden_prestador b ON (a.nr_seq_credenciamento = b.nr_sequencia)
WHERE a.nr_sequencia		= nr_seq_visita_p;
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1207549); --Registro invalido
end;

if (ie_status_visita_w in (2,3)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1209740);
end if;

update	pls_visita_tecnica
set	ie_status		= 5,
	nr_seq_motivo_cancel	= nr_seq_motivo_cancel_p,
	dt_cancelamento		= clock_timestamp(),
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_seq_visita_p;

if (nr_seq_credenciamento_w IS NOT NULL AND nr_seq_credenciamento_w::text <> '') then
	if (ie_status_credenciamento_w = 8) then
		update	pls_creden_prestador
		set	ie_status	= 2,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_seq_credenciamento_w;
	end if;
end if;

CALL CALL pls_visita_tecnica_prest_pck.gravar_log_sistema(	nr_seq_visita_p	=> nr_seq_visita_p,
				ie_tipo_log_p	=> 10,
				ds_log_p	=> wheb_mensagem_pck.get_texto(1210992,'DS_MOTIVO='||ds_motivo_cancelamento_w),
				nm_usuario_p	=> nm_usuario_p,
				ie_commit_p	=> 'N');

CALL CALL pls_visita_tecnica_prest_pck.gerar_alerta_evento(	nr_seq_visita_p		=> nr_seq_visita_p,
			ie_tipo_processo_p	=> 8,
			nm_usuario_p		=> nm_usuario_p,
			ie_commit_p		=> 'N');

if (ie_commit_p = 'S') then
	commit;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_visita_tecnica_prest_pck.cancelar_visita ( nr_seq_visita_p pls_visita_tecnica.nr_sequencia%type, nr_seq_motivo_cancel_p pls_visita_tecnica.nr_seq_motivo_cancel%type, nm_usuario_p usuario.nm_usuario%type, ie_commit_p text) FROM PUBLIC;
