-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pfcs_pck_bed_requests.get_transfers ( cd_establishment_p bigint, cd_unit_classification_p text, cd_unit_p bigint, ie_option_p text, ie_transfer_type_p text ) RETURNS bigint AS $body$
DECLARE

        qt_transfers_w integer := 0;
        qt_transfer_rule_w integer := 240;
        ie_stepdown_w varchar(1);

BEGIN
        if (ie_option_p in (current_setting('pfcs_pck_bed_requests.cd_transfer_out_delay_w')::varchar(7),current_setting('pfcs_pck_bed_requests.cd_transfer_out_w')::varchar(5))) then
            select count(pd.nr_sequencia)
            into STRICT qt_transfers_w
            from pfcs_panel_detail pd,
                pfcs_detail_patient pat,
                pfcs_detail_bed bed
            where pd.nr_seq_indicator = 100
                and pat.nr_seq_detail = bed.nr_seq_detail
                and bed.nr_seq_detail = pd.nr_sequencia
                and pat.ie_transfer_order_status = ie_transfer_type_p
                and pd.nr_seq_operational_level = cd_establishment_p
                and pfcs_pck_bed_requests.get_requested_unit(pat.nr_seq_encounter, current_setting('pfcs_pck_bed_requests.ie_option_cd_w')::varchar(2)) <> bed.cd_department
                and ((bed.ie_classification = cd_unit_classification_p) or (coalesce(cd_unit_classification_p::text, '') = ''))
                and ((isnumber(bed.cd_department) = cd_unit_p) or (coalesce(cd_unit_p::text, '') = ''))
                and ((pat.ie_over_threshold = PFCS_PCK_CONSTANTS.IE_YES and ie_option_p = current_setting('pfcs_pck_bed_requests.cd_transfer_out_delay_w')::varchar(7)) or (ie_option_p = current_setting('pfcs_pck_bed_requests.cd_transfer_out_w')::varchar(5)));
        elsif (ie_option_p in (current_setting('pfcs_pck_bed_requests.cd_transfer_in_delay_w')::varchar(6),current_setting('pfcs_pck_bed_requests.cd_transfer_in_w')::varchar(4))) then
            if (cd_unit_classification_p = PFCS_PCK_CONSTANTS.CD_TCU) then
                ie_stepdown_w := PFCS_PCK_CONSTANTS.IE_YES_BR;
                PERFORM set_config('pfcs_pck_bed_requests.cd_unit_classification_w', PFCS_PCK_CONSTANTS.CD_ICU, false);
            else
                PERFORM set_config('pfcs_pck_bed_requests.cd_unit_classification_w', cd_unit_classification_p, false);
            end if;

            if (ie_option_p = current_setting('pfcs_pck_bed_requests.cd_transfer_in_delay_w')::varchar(6)) then
                select coalesce(max(qt_time_transfer),240)
                into STRICT qt_transfer_rule_w
                from pfcs_general_rule;
            end if;

            select count(pat.nr_sequencia)
            into STRICT qt_transfers_w
            from pfcs_encounter enc,
                pfcs_patient pat,
                unidade_atendimento uni,
                setor_atendimento sec,
                pfcs_service_request svc,
                unidade_atendimento uniReq,
                setor_atendimento secReq
            where uni.nr_seq_location = coalesce(enc.nr_seq_location, pfcs_get_pat_location(pat.nr_sequencia, enc.nr_sequencia))
                and uni.cd_setor_atendimento = sec.cd_setor_atendimento
                and enc.nr_seq_patient = pat.nr_sequencia
                and (enc.period_start IS NOT NULL AND enc.period_start::text <> '')
                and svc.nr_seq_encounter = enc.nr_sequencia
                and svc.nr_seq_patient = pat.nr_sequencia
                and svc.cd_service = PFCS_PCK_CONSTANTS.CD_TRANSFER
                and ((ie_transfer_type_p = current_setting('pfcs_pck_bed_requests.ie_transfer_type_proposal_w')::varchar(1)
                        and svc.si_status = PFCS_PCK_CONSTANTS.SI_STATUS_DRAFT
                        and svc.si_intent = PFCS_PCK_CONSTANTS.SI_INTENT_PROPOSAL
                    ) or ie_transfer_type_p = current_setting('pfcs_pck_bed_requests.ie_transfer_type_order_w')::varchar(1))
                and svc.nr_seq_location = uniReq.nr_seq_location
                and uniReq.cd_setor_atendimento = secReq.cd_setor_atendimento
                and secReq.cd_setor_atendimento <> sec.cd_setor_atendimento
                and (secReq.cd_setor_atendimento = cd_unit_p or coalesce(cd_unit_p::text, '') = '')
                and (secreq.cd_classif_setor = current_setting('pfcs_pck_bed_requests.cd_unit_classification_w')::pfcs_unit.cd_type%type or current_setting('pfcs_pck_bed_requests.cd_unit_classification_w')::pfcs_unit.cd_type%coalesce(type::text, '') = '')
                and (secReq.ie_semi_intensiva = ie_stepdown_w or coalesce(ie_stepdown_w::text, '') = '')
                and ( ((((clock_timestamp() - svc.dt_authored_on) * 1440) > qt_transfer_rule_w) and ie_option_p = current_setting('pfcs_pck_bed_requests.cd_transfer_in_delay_w')::varchar(6)) or (ie_option_p = current_setting('pfcs_pck_bed_requests.cd_transfer_in_w')::varchar(4)) )
                and secReq.cd_estabelecimento = cd_establishment_p
                and sec.cd_estabelecimento = cd_establishment_p;
        end if;
        RETURN qt_transfers_w;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_bed_requests.get_transfers ( cd_establishment_p bigint, cd_unit_classification_p text, cd_unit_p bigint, ie_option_p text, ie_transfer_type_p text ) FROM PUBLIC;
