-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_pck_bed_requests.calc_admission_orders (cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE

        qt_admission_orders_w   integer := 0;
        ie_over_threshold_w     pfcs_panel.ie_flag%type;
        qt_time_admission_w     pfcs_general_rule.qt_time_admission%type := 240;

BEGIN
        select max(coalesce(qt_time_admission,240))
        into STRICT qt_time_admission_w
        from pfcs_general_rule;

        for c01_w in pfcs_pck_cursors.cur_units(cd_establishment_p) loop
            qt_admission_orders_w := 0;
            for c02_w in current_setting('pfcs_pck_bed_requests.cur_admission_orders')::CURSOR(cd_unit_p(c01_w.cd_unit, c01_w.ds_unit, c01_w.cd_unit_classification) loop
                qt_admission_orders_w := qt_admission_orders_w + 1;

                ie_over_threshold_w := PFCS_PCK_CONSTANTS.IE_NO;
                if ( ((clock_timestamp() - c02_w.dt_request) * 1440) > qt_time_admission_w ) then
                    ie_over_threshold_w := PFCS_PCK_CONSTANTS.IE_YES;
                end if;

                select  nextval('pfcs_panel_detail_seq')
                into STRICT	current_setting('pfcs_pck_bed_requests.pfcs_panel_detail_seq_w')::pfcs_panel_detail.nr_sequencia%type
;

                insert into pfcs_panel_detail(
                    nr_sequencia,
                    nm_usuario,
                    dt_atualizacao,
                    nm_usuario_nrec,
                    dt_atualizacao_nrec,
                    ie_situation,
                    nr_seq_indicator,
                    nr_seq_operational_level)
                values (
                    current_setting('pfcs_pck_bed_requests.pfcs_panel_detail_seq_w')::pfcs_panel_detail.nr_sequencia%type,
                    nm_user_p,
                    clock_timestamp(),
                    nm_user_p,
                    clock_timestamp(),
                    'T',
                    94,
                    cd_establishment_p);

                insert into pfcs_detail_bed(
                    nr_sequencia,
                    nm_usuario,
                    dt_atualizacao,
                    nm_usuario_nrec,
                    dt_atualizacao_nrec,
                    nr_seq_detail,
                    ds_location,
                    cd_department,
                    ds_department,
                    cd_status)
                values (
                    nextval('pfcs_detail_bed_seq'),
                    nm_user_p,
                    clock_timestamp(),
                    nm_user_p,
                    clock_timestamp(),
                    current_setting('pfcs_pck_bed_requests.pfcs_panel_detail_seq_w')::pfcs_panel_detail.nr_sequencia%type,
                    c02_w.ds_location,
                    c01_w.cd_unit,
                    c01_w.ds_unit,
                    c02_w.cd_bed_status);

                insert into pfcs_detail_patient(
                    nr_sequencia,
                    nm_usuario,
                    dt_atualizacao,
                    nm_usuario_nrec,
                    dt_atualizacao_nrec,
                    nr_seq_detail,
                    nr_encounter_varchar,
                    dt_entrance,
                    id_patient,
                    nm_patient,
                    ds_gender,
                    dt_birthdate,
                    ds_age_range,
                    ds_symptoms,
                    dt_request,
                    ds_physician,
                    ds_special_request,
                    ds_dnr_status,
                    ds_care_status,
                    ds_checklist,
                    ie_over_threshold,
                    qt_edi_score,
                    ie_freq_flyer,
                    ds_readmission_risk,
                    ds_readm_risk_contrb,
                    ds_rec_pat_adm_data,
                    ds_rec_pat_comorbd,
                    ds_rec_pat_reasons,
                    ds_edi_vitals_warn,
                    ds_edi_contrb,
                    vl_los_remaining,
                    ds_admit_source,
                    ds_discharge_disposition,
					dt_expected_discharge)
                values (
                    nextval('pfcs_detail_patient_seq'),
                    nm_user_p,
                    clock_timestamp(),
                    nm_user_p,
                    clock_timestamp(),
                    current_setting('pfcs_pck_bed_requests.pfcs_panel_detail_seq_w')::pfcs_panel_detail.nr_sequencia%type,
                    c02_w.nr_encounter,
                    c02_w.dt_period_start,
                    c02_w.id_patient,
                    c02_w.nm_patient,
                    c02_w.ds_gender,
                    c02_w.dt_birthdate,
                    c02_w.qt_patient_age,
                    c02_w.ds_problem,
                    c02_w.dt_request,
                    c02_w.nm_physician,
                    c02_w.ds_special_requests,
                    c02_w.code_status,
                    c02_w.ds_care_status,
                    c02_w.ds_checklist,
                    ie_over_threshold_w,
                    c02_w.qt_trs,
                    c02_w.ie_frequent_flyer,
                    c02_w.ds_readmission_risk,
                    c02_w.ds_readm_risk_contrb,
                    c02_w.ds_recur_pat_adm_data,
                    c02_w.ds_recur_pat_comorbd,
                    c02_w.ds_recur_pat_reasons,
                    c02_w.ds_edi_vitals_warn,
                    c02_w.ds_edi_contrb,
                    c02_w.vl_los_remaining,
                    c02_w.ds_admit_source,
	                c02_w.ds_discharge_disposition,
					c02_w.dt_expected_discharge);
            end loop;

             := pfcs_pck.pfcs_generate_results(
                ds_reference_value_p => c01_w.ds_unit, cd_reference_value_p => c01_w.cd_unit, cd_reference_aux_p => c01_w.cd_unit_classification, vl_indicator_p => qt_admission_orders_w, nr_seq_indicator_p => 94, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => current_setting('pfcs_pck_bed_requests.pfcs_panel_seq_w')::pfcs_panel.nr_sequencia%type);
        end loop;

        CALL pfcs_pck.pfcs_update_detail(
            nr_seq_indicator_p => 94,
            nr_seq_panel_p => current_setting('pfcs_pck_bed_requests.pfcs_panel_seq_w')::pfcs_panel.nr_sequencia%type,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
        CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => 94,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_bed_requests.calc_admission_orders (cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;
