-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

--=========================================== Variables ===========================================
    

    --=========================================== Cursors ===========================================
    ---- Admission Orders
    

	---- Transfer Orders / Delays
	

    --=========================================== Procedures ===========================================
CREATE OR REPLACE PROCEDURE pfcs_pck_bed_requests.calc_expected_admissions (cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE

        cur_expected CURSOR FOR
        SELECT count(svc.nr_sequencia) qt_expected_admissions,
            tab.cd_unit,
            tab.ds_unit,
            tab.cd_unit_classification,
            tab.ie_hospital_occupancy
        FROM (SELECT sec.cd_setor_atendimento cd_unit,
                sec.ds_setor_atendimento ds_unit,
                (CASE   WHEN sec.ie_semi_intensiva = PFCS_PCK_CONSTANTS.IE_YES_BR THEN PFCS_PCK_CONSTANTS.CD_TCU
                        WHEN sec.ie_rpa = PFCS_PCK_CONSTANTS.IE_YES_BR THEN PFCS_PCK_CONSTANTS.CD_UNIT_TYPE_PACU
                        ELSE sec.cd_classif_setor
                END) cd_unit_classification,
                sec.ie_ocup_hospitalar ie_hospital_occupancy
            from setor_atendimento sec
            where sec.ie_situacao = PFCS_PCK_CONSTANTS.IE_ACTIVE
                and sec.cd_estabelecimento_base = cd_establishment_p
            ) tab, unidade_atendimento uni
LEFT OUTER JOIN pfcs_service_request svc ON (uni.nr_seq_location = svc.nr_seq_location)
, pfcs_pck_constants
LEFT OUTER JOIN pfcs_service_request svc ON (PFCS_PCK_CONSTANTS.CD_ADMISSION = svc.cd_service AND PFCS_PCK_CONSTANTS.SI_INTENT_PROPOSAL = svc.si_intent AND PFCS_PCK_CONSTANTS.SI_STATUS_DRAFT = svc.si_status)
WHERE uni.cd_setor_atendimento = tab.cd_unit group by uni.cd_setor_atendimento, tab.cd_unit, tab.ds_unit, tab.cd_unit_classification, tab.ie_hospital_occupancy;

BEGIN
        for c01_w in cur_expected loop
             := pfcs_pck.pfcs_generate_results(
                ds_reference_value_p => c01_w.ds_unit, cd_reference_value_p => c01_w.cd_unit, cd_reference_aux_p => c01_w.cd_unit_classification, vl_indicator_p => c01_w.qt_expected_admissions, ie_flag_p => c01_w.ie_hospital_occupancy, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_VC_EXPECTED_ADMISSIONS, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => current_setting('pfcs_pck_bed_requests.pfcs_panel_seq_w')::pfcs_panel.nr_sequencia%type);
        end loop;

        CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_VC_EXPECTED_ADMISSIONS,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_bed_requests.calc_expected_admissions (cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;
