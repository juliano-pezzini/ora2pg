-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_pck_bed_requests.calc_transfer_orders (cd_establishment_p bigint,nm_user_p text) AS $body$
DECLARE

        qt_transfer_orders_w    integer := 0;
        qt_delays_w             integer := 0;
        ie_over_threshold_w     pfcs_panel.ie_flag%type;
        qt_time_transfer_w      pfcs_general_rule.qt_time_transfer%type := 240;
	
BEGIN
		select max(coalesce(qt_time_transfer,0))
		into STRICT qt_time_transfer_w
		from pfcs_general_rule;

		for c01_w in pfcs_pck_cursors.cur_units(cd_establishment_p) loop
			qt_transfer_orders_w := 0;
			qt_delays_w := 0;

			for c03_w in current_setting('pfcs_pck_bed_requests.cur_transfer_orders')::CURSOR(cd_unit_p(c01_w.cd_unit, c01_w.ds_unit, c01_w.cd_unit_classification) loop
				qt_transfer_orders_w := qt_transfer_orders_w + 1;

				ie_over_threshold_w := 'N';
				if ( ((clock_timestamp() - c03_w.dt_request) * 1440) > qt_time_transfer_w ) then
					qt_delays_w := qt_delays_w + 1;
					ie_over_threshold_w := 'Y';
				end if;

				select  nextval('pfcs_panel_detail_seq')
				into STRICT	current_setting('pfcs_pck_bed_requests.pfcs_panel_detail_seq_w')::pfcs_panel_detail.nr_sequencia%type
				;

				insert into pfcs_panel_detail(
					nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					ie_situation,
					nr_seq_indicator,
					nr_seq_operational_level)
				values (
					current_setting('pfcs_pck_bed_requests.pfcs_panel_detail_seq_w')::pfcs_panel_detail.nr_sequencia%type,
					nm_user_p,
					clock_timestamp(),
					nm_user_p,
					clock_timestamp(),
					'T',
					PFCS_PCK_INDICATORS.NR_ICU_TRANSFER_ORDERS,
					cd_establishment_p);

				insert into pfcs_detail_bed(
					nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					nr_seq_detail,
					ds_location,
					cd_department,
					ds_department,
					cd_status)
				values (
					nextval('pfcs_detail_bed_seq'),
					nm_user_p,
					clock_timestamp(),
					nm_user_p,
					clock_timestamp(),
					current_setting('pfcs_pck_bed_requests.pfcs_panel_detail_seq_w')::pfcs_panel_detail.nr_sequencia%type,
					c03_w.ds_location,
					c01_w.cd_unit,
					c03_w.ds_requested_unit,
					c03_w.cd_bed_status);

				insert into pfcs_detail_patient(
					nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					nr_seq_detail,
					nr_encounter_varchar,
					dt_entrance,
					id_patient,
					nm_patient,
					ds_gender,
					dt_birthdate,
					ds_age_range,
					ds_symptoms,
					dt_request,
					ds_physician,
					ds_special_request,
					ds_dnr_status,
					ds_care_status,
					ds_checklist,
					ie_over_threshold,
					qt_edi_score,
					ie_freq_flyer,
					ds_readmission_risk,
					ds_readm_risk_contrb,
					ds_rec_pat_adm_data,
					ds_rec_pat_comorbd,
					ds_rec_pat_reasons,
					ds_edi_vitals_warn,
					ds_edi_contrb,
					vl_los_remaining,
                    ds_admit_source,
					ds_discharge_disposition,
					dt_expected_discharge)
				values (
					nextval('pfcs_detail_patient_seq'),
					nm_user_p,
					clock_timestamp(),
					nm_user_p,
					clock_timestamp(),
					current_setting('pfcs_pck_bed_requests.pfcs_panel_detail_seq_w')::pfcs_panel_detail.nr_sequencia%type,
					c03_w.nr_encounter,
					c03_w.dt_period_start,
					c03_w.id_patient,
					c03_w.nm_patient,
					c03_w.ds_gender,
					c03_w.dt_birthdate,
					c03_w.qt_patient_age,
					c03_w.ds_problem,
					c03_w.dt_request,
					c03_w.nm_physician,
					c03_w.ds_special_requests,
					c03_w.code_status,
					c03_w.ds_care_status,
					c03_w.ds_checklist,
					ie_over_threshold_w,
					c03_w.qt_trs,
					c03_w.ie_frequent_flyer,
					c03_w.ds_readmission_risk,
					c03_w.ds_readm_risk_contrb,
					c03_w.ds_recur_pat_adm_data,
					c03_w.ds_recur_pat_comorbd,
					c03_w.ds_recur_pat_reasons,
					c03_w.ds_edi_vitals_warn,
					c03_w.ds_edi_contrb,
					c03_w.vl_los_remaining,
                    c03_w.ds_admit_source,
					c03_w.ds_discharge_disposition,
					c03_w.dt_expected_discharge);
			end loop;

			 := pfcs_pck.pfcs_generate_results(
				ds_reference_value_p => c01_w.ds_unit, cd_reference_value_p => c01_w.cd_unit, cd_reference_aux_p => c01_w.cd_unit_classification, vl_indicator_p => qt_transfer_orders_w, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_ICU_TRANSFER_ORDERS, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => current_setting('pfcs_pck_bed_requests.pfcs_panel_seq_w')::pfcs_panel.nr_sequencia%type);

			 := pfcs_pck.pfcs_generate_results(
				ds_reference_value_p => c01_w.ds_unit, cd_reference_value_p => c01_w.cd_unit, cd_reference_aux_p => c01_w.cd_unit_classification, vl_indicator_p => qt_delays_w, nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_ICU_DELAYS, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => current_setting('pfcs_pck_bed_requests.pfcs_panel_seq_w')::pfcs_panel.nr_sequencia%type);
		end loop;

		CALL pfcs_pck.pfcs_update_detail(
				nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_ICU_TRANSFER_ORDERS,
				nr_seq_panel_p => current_setting('pfcs_pck_bed_requests.pfcs_panel_seq_w')::pfcs_panel.nr_sequencia%type,
				nr_seq_operational_level_p => cd_establishment_p,
				nm_usuario_p => nm_user_p);
		CALL pfcs_pck.pfcs_activate_records(
				nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_ICU_TRANSFER_ORDERS,
				nr_seq_operational_level_p => cd_establishment_p,
				nm_usuario_p => nm_user_p);
		CALL pfcs_pck.pfcs_activate_records(
				nr_seq_indicator_p => PFCS_PCK_INDICATORS.NR_ICU_DELAYS,
				nr_seq_operational_level_p => cd_establishment_p,
				nm_usuario_p => nm_user_p);
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pck_bed_requests.calc_transfer_orders (cd_establishment_p bigint,nm_user_p text) FROM PUBLIC;
