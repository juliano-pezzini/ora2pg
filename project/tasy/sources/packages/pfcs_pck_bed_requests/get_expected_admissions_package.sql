-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


    /*=========================================== Functions ===========================================*/

CREATE OR REPLACE FUNCTION pfcs_pck_bed_requests.get_expected_admissions ( cd_establishment_p bigint, cd_unit_classification_p text default null, cd_unit_p bigint default null, ie_hospital_occupancy_p text default PFCS_PCK_CONSTANTS.IE_NO) RETURNS bigint AS $body$
DECLARE

        qt_expected_admissions_w    integer := 0;
        ie_stepdown_w               setor_atendimento.ie_semi_intensiva%type;

BEGIN
        if (cd_unit_classification_p = PFCS_PCK_CONSTANTS.CD_TCU) then
            ie_stepdown_w := PFCS_PCK_CONSTANTS.IE_YES_BR;
            PERFORM set_config('pfcs_pck_bed_requests.cd_unit_classification_w', PFCS_PCK_CONSTANTS.CD_ICU, false);
        elsif (cd_unit_classification_p = PFCS_PCK_CONSTANTS.CD_ICU)then
            ie_stepdown_w := PFCS_PCK_CONSTANTS.IE_NO;
            PERFORM set_config('pfcs_pck_bed_requests.cd_unit_classification_w', cd_unit_classification_p, false);
        else
            PERFORM set_config('pfcs_pck_bed_requests.cd_unit_classification_w', cd_unit_classification_p, false);
        end if;

        select count(svc.nr_sequencia)
        into STRICT qt_expected_admissions_w
        from pfcs_service_request svc,
            setor_atendimento sec,
            unidade_atendimento uni
        where svc.cd_service = PFCS_PCK_CONSTANTS.CD_ADMISSION
            and svc.si_intent = PFCS_PCK_CONSTANTS.SI_INTENT_PROPOSAL
            and svc.si_status = PFCS_PCK_CONSTANTS.SI_STATUS_DRAFT
            and svc.nr_seq_location = uni.nr_seq_location
            and ((sec.cd_classif_setor = current_setting('pfcs_pck_bed_requests.cd_unit_classification_w')::pfcs_unit.cd_type%type) or (current_setting('pfcs_pck_bed_requests.cd_unit_classification_w')::pfcs_unit.cd_type%coalesce(type::text, '') = ''))
            and (sec.cd_setor_atendimento = cd_unit_p or coalesce(cd_unit_p::text, '') = '')
            and sec.cd_estabelecimento = cd_establishment_p
            and (coalesce(sec.ie_semi_intensiva,PFCS_PCK_CONSTANTS.IE_NO) = ie_stepdown_w or coalesce(ie_stepdown_w::text, '') = '')
            and (ie_hospital_occupancy_p = PFCS_PCK_CONSTANTS.IE_NO or sec.ie_ocup_hospitalar = ie_hospital_occupancy_p)
            and uni.cd_setor_atendimento = sec.cd_setor_atendimento;
        return qt_expected_admissions_w;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_bed_requests.get_expected_admissions ( cd_establishment_p bigint, cd_unit_classification_p text default null, cd_unit_p bigint default null, ie_hospital_occupancy_p text default PFCS_PCK_CONSTANTS.IE_NO) FROM PUBLIC;
