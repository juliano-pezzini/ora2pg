-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_alterar_status_lote_pck.gerar_regra_liberacao_lote ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, vl_lote_p pls_lote_mensalidade.vl_lote%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_mens_liberacao_w	pls_mensalidade_liberacao.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_regra_mens_liberacao
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	vl_lote_p between coalesce(vl_lote_inicial,vl_lote_p) and coalesce(vl_lote_final,vl_lote_p)
	and	clock_timestamp() between	coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp());

C02 CURSOR(	nr_seq_regra_pc	pls_regra_mens_liberacao.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		a.ds_grupo
	from	pls_regra_mens_lib_grupo a
	where	a.nr_seq_regra	= nr_seq_regra_pc
	and	exists (SELECT	1
			from	pls_regra_mens_lib_usuario x
			where	x.nr_seq_grupo_regra = a.nr_sequencia);
BEGIN

for c01_w in C01 loop
	begin
	
	for C02_w in C02(c01_w.nr_sequencia) loop
		begin
		insert	into	pls_mensalidade_liberacao(	nr_sequencia,
				nr_seq_lote,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_descricao)
			values (	nextval('pls_mensalidade_liberacao_seq'),
				nr_seq_lote_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				c02_w.ds_grupo)
			returning nr_sequencia into nr_seq_mens_liberacao_w;
		
		insert	into	pls_mensalidade_lib_perfil(	nr_sequencia,
				nr_seq_liberacao,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nm_usuario_liberacao,
				cd_perfil_liberacao)
				
			(SELECT	nextval('pls_mensalidade_lib_perfil_seq'),
				nr_seq_mens_liberacao_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				a.nm_usuario_liberacao,
				a.cd_perfil_liberacao
			from	pls_regra_mens_lib_usuario a
			where	a.nr_seq_grupo_regra = c02_w.nr_sequencia);
		end;
	end loop;
	
	
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_status_lote_pck.gerar_regra_liberacao_lote ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, vl_lote_p pls_lote_mensalidade.vl_lote%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
