-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_alterar_status_lote_pck.alterar_status_lote_definitivo ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ie_status_w			pls_lote_mensalidade.ie_status%type;
vl_lote_w			pls_lote_mensalidade.vl_lote%type;
dt_mesano_referencia_w		timestamp;
ie_mes_fechado_w		varchar(1);
ie_gerar_comissao_w		varchar(1);
ie_liberar_portal_w		varchar(1);
ie_esquema_contabil_w		varchar(1);
qt_movimento_w			bigint := 0;
nr_seq_atualizacao_w		bigint;
nr_seq_lote_w			bigint;
dt_ref_inicial_w		timestamp;
dt_ref_final_w			timestamp;
dt_referencia_w			timestamp;
dt_referencia_month_w		timestamp;
vl_movimento_w			ctb_documento.vl_movimento%type;
nm_atributo_w			ctb_documento.nm_atributo%type;
dt_competencia_apro_w		ctb_documento.dt_competencia%type;
ie_concil_contab_w		pls_visible_false.ie_concil_contab%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
qt_critica_impeditiva_w		bigint;


BEGIN

select	pls_obter_se_mes_fechado(dt_mesano_referencia_w,'T', cd_estabelecimento_w),
	obter_valor_param_usuario(1205,9,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w),
	coalesce(obter_valor_param_usuario(1205,35,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w),'A')
into STRICT	ie_mes_fechado_w,
	ie_gerar_comissao_w,
	ie_liberar_portal_w
;

if (ie_mes_fechado_w = 'S') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(191856, null ); /* Nao e possivel realizar esta operacao pois o mes de competencia ou a contabilidade do mes esta fechada! */
end if;

if (ie_status_w	= '1') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(191857, null ); /* Lote nao foi gerado. Verifique! */
end if;

select	ie_status,
	coalesce(dt_contabilizacao,dt_mesano_referencia),
	cd_estabelecimento,
	(select	count(1)
	from	pls_critica_mensalidade q,
		pls_mensalidade_critica x,
		pls_mensalidade_segurado y,
		pls_mensalidade w
	where	q.nr_sequencia = x.nr_seq_critica
	and	y.nr_sequencia = x.nr_seq_mensalidade_seg
	and	w.nr_sequencia = y.nr_seq_mensalidade
	and	q.ie_impeditiva = 'S') qt_critica_impeditiva,
	vl_lote
into STRICT	ie_status_w,
	dt_mesano_referencia_w,
	cd_estabelecimento_w,
	qt_critica_impeditiva_w,
	vl_lote_w
from	pls_lote_mensalidade
where	nr_sequencia	= nr_seq_lote_p;

if (qt_critica_impeditiva_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1072551);
end if;

CALL pls_gravar_historico_lote_mens(nr_seq_lote_p, 3, null, nm_usuario_p, 'N');

update	pls_lote_mensalidade
set	ie_status		= '2',
	dt_liberacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp(),
	ie_visualizar_portal	= CASE WHEN ie_liberar_portal_w='A' THEN 'S'  ELSE coalesce(ie_visualizar_portal,'N') END
where	nr_sequencia		= nr_seq_lote_p;

CALL pls_alterar_status_lote_pck.atualizar_conta_financeira(nr_seq_lote_p);

if (coalesce(ie_gerar_comissao_w,'N')	= 'S') then
	CALL pls_gerar_comissao_vendedor(nr_seq_lote_p, null, null, nm_usuario_p);
end if;

dt_ref_inicial_w	:= dt_mesano_referencia_w;
dt_ref_final_w		:= fim_dia(fim_mes(dt_mesano_referencia_w));

dt_referencia_month_w	:= trunc(dt_mesano_referencia_w,'month');

begin
select	count(*)
into STRICT	qt_movimento_w
from	pls_mensalidade_seg_item	a,
	pls_mensalidade_segurado	b,
	pls_mensalidade			c,
	pls_lote_mensalidade		d
where	a.nr_seq_mensalidade_seg	= b.nr_sequencia
and	b.nr_seq_mensalidade		= c.nr_sequencia
and	c.nr_seq_lote			= d.nr_sequencia
and	d.nr_sequencia = nr_seq_lote_p;

select	coalesce(ie_esquema_contabil,'N')
into STRICT	ie_esquema_contabil_w
from	pls_parametro_contabil
where	cd_estabelecimento	= cd_estabelecimento_w;
exception
when others then
	ie_esquema_contabil_w	:= 'N';
end;

pls_gerar_atualizacao_contabil(	dt_mesano_referencia_w,
				nm_usuario_p,
				cd_estabelecimento_w,
				21,
				'G',
				qt_movimento_w,
				nr_seq_atualizacao_w);

if (ie_esquema_contabil_w = 'S') then
	ctb_pls_atualizar_receita_in(	nr_seq_lote_p,
					null,
					null,
					nr_seq_atualizacao_w,
					nm_usuario_p,
					cd_estabelecimento_w,
					null,
					'P',
					qt_movimento_w);
end if;

if (ie_esquema_contabil_w = 'N') then
	CALL ctb_pls_atualizar_mensal(	nr_seq_lote_p,
					null,
					nm_usuario_p,
					cd_estabelecimento_w);
end if;

ctb_pls_atualizar_imposto_in(	nr_seq_lote_p,
								null,
								nm_usuario_p,
								cd_estabelecimento_w);

pls_gerar_atualizacao_contabil(	dt_mesano_referencia_w,
				nm_usuario_p,
				cd_estabelecimento_w,
				21,
				'A',
				qt_movimento_w,
				nr_seq_atualizacao_w);

commit;

select	coalesce(max(ie_concil_contab), 'N')
into STRICT	ie_concil_contab_w
from	pls_visible_false;

if (ie_concil_contab_w = 'S') then
	CALL pls_ctb_onl_gravar_movto_pck.gravar_movto_lote_mens_defin(nr_seq_lote_p, cd_estabelecimento_w, nm_usuario_p);
end if;

CALL pls_alterar_status_lote_pck.gerar_regra_liberacao_lote(nr_seq_lote_p, vl_lote_w, cd_estabelecimento_w, nm_usuario_p); --TO-DO BRANDON
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_status_lote_pck.alterar_status_lote_definitivo ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
