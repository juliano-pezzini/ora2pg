-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_alterar_status_lote_pck.atualizar_conta_financeira ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type) AS $body$
DECLARE


cd_conta_financ_w		pls_conta_financ_regra.cd_conta_financ%type;
nr_seq_sca_w			pls_plano.nr_sequencia%type;

C01 CURSOR(	nr_seq_lote_pc			pls_lote_mensalidade.nr_sequencia%type
		) FOR
	SELECT	a.nr_sequencia			nr_seq_item_mens,
		e.ie_tipo_contratacao		ie_tipo_contratacao,
		a.ie_tipo_item			ie_tipo_item,
		a.nr_seq_tipo_lanc		nr_seq_tipo_lanc,
		a.nr_seq_vinculo_sca		nr_seq_vinculo_sca,
		d.ie_tipo_contratacao		ie_tipo_produto,
		d.ie_tipo_operacao		ie_tipo_operacao_plano,
		d.ie_preco			ie_preco,
		d.ie_regulamentacao		ie_regulamentacao,
		e.ie_tipo_lote			ie_tipo_lote,
		e.ie_primeira_mensalidade	ie_primeira_mensalidade,
		b.nr_seq_plano			nr_seq_plano
	from	pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_mensalidade			c,
		pls_plano			d,
		pls_lote_mensalidade		e
	where	b.nr_sequencia		= a.nr_seq_mensalidade_seg
	and	c.nr_sequencia		= b.nr_seq_mensalidade
	and	e.nr_sequencia		= nr_seq_lote_pc
	and	d.nr_sequencia		= b.nr_seq_plano
	and	e.nr_sequencia		= c.nr_seq_lote;

C02 CURSOR(	ie_tipo_contratacao_pc		pls_lote_mensalidade.ie_tipo_contratacao%type,
		ie_tipo_item_pc			pls_mensalidade_seg_item.nr_sequencia%type,
		nr_seq_tipo_lanc_adic_pc	pls_mensalidade_seg_item.nr_seq_tipo_lanc%type,
		nr_seq_plano_sca_pc		pls_mensalidade_seg_item.nr_seq_vinculo_sca%type,
		ie_tipo_produto_pc		pls_plano.ie_tipo_contratacao%type,
		ie_tipo_operacao_plano_pc	pls_plano.ie_tipo_operacao%type,
		ie_preco_pc			pls_plano.ie_preco%type,
		ie_regulamentacao_pc		pls_plano.ie_regulamentacao%type,
		ie_tipo_lote_pc			pls_lote_mensalidade.ie_tipo_lote%type,
		ie_primeira_mensalidade_pc	pls_lote_mensalidade.ie_primeira_mensalidade%type,
		nr_seq_plano_pc			pls_plano.nr_sequencia%type
		) FOR
	SELECT	a.cd_conta_financ
	from	pls_conta_financ_regra a
	where	a.ie_tipo_operacao = 'M'
	and	(((a.ie_tipo_contratacao = ie_tipo_contratacao_pc) or (coalesce(a.ie_tipo_contratacao::text, '') = ''))
		or ((a.ie_tipo_contratacao = 'C') and (ie_tipo_contratacao_pc in ('CA','CE')))
		or (a.ie_tipo_contratacao = 'T'))
	and	((a.ie_tipo_item_mens = ie_tipo_item_pc) or (coalesce(a.ie_tipo_item_mens::text, '') = ''))
	and	((a.nr_seq_tipo_lanc_adic = nr_seq_tipo_lanc_adic_pc) or (coalesce(a.nr_seq_tipo_lanc_adic::text, '') = ''))
	and	((a.nr_seq_plano_sca = nr_seq_plano_sca_pc) or (coalesce(a.nr_seq_plano_sca::text, '') = ''))
	and	((a.ie_tipo_produto = ie_tipo_produto_pc) or (coalesce(a.ie_tipo_produto::text, '') = ''))
	and	((a.ie_tipo_operacao_plano = ie_tipo_operacao_plano_pc) or (coalesce(a.ie_tipo_operacao_plano::text, '') = ''))
	and	((a.ie_preco = ie_preco_pc) or (coalesce(a.ie_preco::text, '') = ''))
	and	((a.ie_regulamentacao = ie_regulamentacao_pc) or (coalesce(a.ie_regulamentacao::text, '') = ''))
	and	((a.ie_tipo_lote = ie_tipo_lote_pc) or (coalesce(a.ie_tipo_lote::text, '') = ''))
	and	((a.ie_primeira_mensalidade = ie_primeira_mensalidade_pc) or (coalesce(a.ie_primeira_mensalidade::text, '') = ''))
	and	((a.nr_seq_plano = nr_seq_plano_pc) or (coalesce(a.nr_seq_plano::text, '') = ''))
	order by
		CASE WHEN a.ie_tipo_contratacao='T' THEN 'A'  ELSE coalesce(a.ie_tipo_contratacao,'A') END ,
		coalesce(a.ie_tipo_item_mens,0),
		coalesce(a.nr_seq_tipo_lanc_adic,0),
		coalesce(a.nr_seq_plano_sca,0),
		coalesce(a.ie_tipo_produto,'A'),
		coalesce(a.ie_tipo_operacao_plano,'A'),
		coalesce(a.ie_preco,0),
		coalesce(a.ie_regulamentacao,'A'),
		coalesce(a.ie_tipo_lote,'A'),
		coalesce(a.ie_primeira_mensalidade,'N'),
		coalesce(a.nr_seq_plano,0);
BEGIN

current_setting('pls_alterar_status_lote_pck.tb_nr_seq_item_mens_w')::pls_util_cta_pck.t_number_table.delete;
CALL CALL pls_alterar_status_lote_pck.atualizar_registros();

for r_c01_w in c01(nr_seq_lote_p) loop
	begin

	cd_conta_financ_w := null;

	if (r_c01_w.nr_seq_vinculo_sca IS NOT NULL AND r_c01_w.nr_seq_vinculo_sca::text <> '') then
		select	max(nr_seq_plano)
		into STRICT	nr_seq_sca_w
		from	pls_sca_vinculo
		where	nr_sequencia = r_c01_w.nr_seq_vinculo_sca;
	else
		nr_seq_sca_w := null;
	end if;

	for r_c02_w in c02(	r_c01_w.ie_tipo_contratacao,
				r_c01_w.ie_tipo_item,
				r_c01_w.nr_seq_tipo_lanc,
				nr_seq_sca_w,
				r_c01_w.ie_tipo_produto,
				r_c01_w.ie_tipo_operacao_plano,
				r_c01_w.ie_preco,
				r_c01_w.ie_regulamentacao,
				r_c01_w.ie_tipo_lote,
				r_c01_w.ie_primeira_mensalidade,
				r_c01_w.nr_seq_plano
				) loop
		begin

		cd_conta_financ_w	:= r_c02_w.cd_conta_financ;

		end;
	end loop;

	current_setting('pls_alterar_status_lote_pck.tb_nr_seq_item_mens_w')::pls_util_cta_pck.t_number_table(current_setting('pls_alterar_status_lote_pck.nr_indice_w')::integer)	:= r_c01_w.nr_seq_item_mens;
	current_setting('pls_alterar_status_lote_pck.tb_cd_conta_financ_w')::pls_util_cta_pck.t_number_table(current_setting('pls_alterar_status_lote_pck.nr_indice_w')::integer)	:= cd_conta_financ_w;

	if (current_setting('pls_alterar_status_lote_pck.nr_indice_w')::integer >= pls_util_pck.qt_registro_transacao_w) then
		CALL CALL pls_alterar_status_lote_pck.atualizar_registros();
	else
		PERFORM set_config('pls_alterar_status_lote_pck.nr_indice_w', current_setting('pls_alterar_status_lote_pck.nr_indice_w')::integer + 1, false);
	end if;
	end;
end loop;

CALL CALL pls_alterar_status_lote_pck.atualizar_registros();

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_status_lote_pck.atualizar_conta_financeira ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type) FROM PUBLIC;
