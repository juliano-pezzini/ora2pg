-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION localiza_cm_conjunto_pck.localiza_conjunto ( nr_seq_conjunto_p bigint, nm_conjunto_p text, ie_forma_visualiza_p text, cd_setor_selec_p bigint) RETURNS SETOF T_CM_CONJUNTO AS $body$
DECLARE


t_conjunto_row				t_cm_conjunto_row;
nr_seq_conjunto_w			CM_CONJUNTO.nr_sequencia%type;
nm_conjunto_w				CM_CONJUNTO.nm_conjunto%type;
nr_seq_classif_w			CM_CONJUNTO.nr_seq_classif%type;
cd_estabelecimento_w		CM_CONJUNTO.cd_estabelecimento%type;
ie_avulso_w					varchar(1);
ie_controla_processo_lav_w	CM_CONJUNTO.ie_controla_processo_lav%type;
cd_setor_atendimento_w		setor_atendimento.cd_setor_atendimento%type;

c01 CURSOR FOR
SELECT	nr_sequencia,
		nm_conjunto,
		nr_seq_classif,
		cd_estabelecimento,
		substr(cm_obter_se_conj_avulso(nr_sequencia),1,1) ie_avulso,
		ie_controla_processo_lav
from	cm_conjunto a
where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
and		ie_forma_visualiza_p = 'T'
and (coalesce(nm_conjunto_p,'-1') = '-1' or upper(nm_conjunto) like '%' || upper(nm_conjunto_p) || '%')
and (nr_sequencia = coalesce(nr_seq_conjunto_p,0) or coalesce(nr_seq_conjunto_p,0) = 0)
and		coalesce(a.ie_reserva,'N') = 'N'
and		coalesce(a.ie_administracao,'S') = 'S'
and		a.ie_situacao = 'A'
and		not exists ( select  1 from cm_manutencao_conj b where b.nr_seq_conjunto = a.nr_sequencia and coalesce(b.dt_retorno::text, '') = '')

union

select	nr_sequencia,
		nm_conjunto,
		nr_seq_classif,
		cd_estabelecimento,
		substr(cm_obter_se_conj_avulso(nr_sequencia),1,1) ie_avulso,
		ie_controla_processo_lav
from	cm_conjunto a
where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
and		ie_forma_visualiza_p = 'S'
and (coalesce(nm_conjunto_p,'-1') = '-1' or upper(nm_conjunto) like '%' || upper(nm_conjunto_p) || '%')
and (nr_sequencia = coalesce(nr_seq_conjunto_p,0) or coalesce(nr_seq_conjunto_p,0) = 0)
and		coalesce(a.ie_reserva,'N') = 'N'
and		coalesce(a.ie_administracao,'S') = 'S'
and		coalesce(a.cd_setor_atendimento,0) = cd_setor_atendimento_w
and		a.ie_situacao = 'A'
and		not exists ( select  1 from cm_manutencao_conj b where b.nr_seq_conjunto = a.nr_sequencia and coalesce(b.dt_retorno::text, '') = '')


union

select	nr_sequencia,
		nm_conjunto,
		nr_seq_classif,
		cd_estabelecimento,
		substr(cm_obter_se_conj_avulso(nr_sequencia),1,1) ie_avulso,
		ie_controla_processo_lav
from	cm_conjunto a
where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
and 	ie_forma_visualiza_p = 'SN'
and (coalesce(nm_conjunto_p,'-1') = '-1' or upper(nm_conjunto) like '%' || upper(nm_conjunto_p) || '%')
and (nr_sequencia = coalesce(nr_seq_conjunto_p,0) or coalesce(nr_seq_conjunto_p,0) = 0)
and		coalesce(a.ie_reserva,'N') = 'N'
and		coalesce(a.ie_administracao,'S') = 'S'
and		coalesce(a.cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w
and		a.ie_situacao = 'A'
and		not exists ( select  1 from cm_manutencao_conj b where b.nr_seq_conjunto = a.nr_sequencia and coalesce(b.dt_retorno::text, '') = '')

union

select	nr_sequencia,
		nm_conjunto,
		nr_seq_classif,
		cd_estabelecimento,
		substr(cm_obter_se_conj_avulso(nr_sequencia),1,1) ie_avulso,
		ie_controla_processo_lav
from	cm_conjunto a
where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
and 	ie_forma_visualiza_p = 'E'
and (coalesce(nm_conjunto_p,'-1') = '-1' or upper(nm_conjunto) like '%' || upper(nm_conjunto_p) || '%')
and (nr_sequencia = coalesce(nr_seq_conjunto_p,0) or coalesce(nr_seq_conjunto_p,0) = 0)
and		coalesce(a.ie_administracao,'S') = 'S'
and (a.cd_setor_atendimento = cd_setor_selec_p or coalesce(a.cd_setor_atendimento,0) = 0)
and		a.ie_situacao = 'A'
and		not exists ( select  1 from cm_manutencao_conj b where b.nr_seq_conjunto = a.nr_sequencia and coalesce(b.dt_retorno::text, '') = '')

union

select	nr_sequencia,
		nm_conjunto,
		nr_seq_classif,
		cd_estabelecimento,
		substr(cm_obter_se_conj_avulso(nr_sequencia),1,1) ie_avulso,
		ie_controla_processo_lav
from	cm_conjunto a
where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
and 	ie_forma_visualiza_p = 'EN'
and (coalesce(nm_conjunto_p,'-1') = '-1' or upper(nm_conjunto) like '%' || upper(nm_conjunto_p) || '%')
and (nr_sequencia = coalesce(nr_seq_conjunto_p,0) or coalesce(nr_seq_conjunto_p,0) = 0)
and		coalesce(a.ie_reserva,'N') = 'N'
and		coalesce(a.ie_administracao,'S') = 'S'
and		coalesce(a.cd_setor_atendimento,cd_setor_selec_p) = cd_setor_selec_p
and		a.ie_situacao = 'A'
and		not exists ( select  1 from cm_manutencao_conj b where b.nr_seq_conjunto = a.nr_sequencia and coalesce(b.dt_retorno::text, '') = '');


BEGIN

cd_setor_atendimento_w		:= wheb_usuario_pck.get_cd_setor_atendimento;

open c01;
loop
fetch c01 into
	nr_seq_conjunto_w,
	nm_conjunto_w,
	nr_seq_classif_w,
	cd_estabelecimento_w,
	ie_avulso_w,
	ie_controla_processo_lav_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	t_conjunto_row.nr_seq_conjunto			:= nr_seq_conjunto_w;
	t_conjunto_row.nm_conjunto				:= nm_conjunto_w;
	t_conjunto_row.nr_seq_classif			:= nr_seq_classif_w;
	t_conjunto_row.cd_estabelecimento		:= cd_estabelecimento_w;
	t_conjunto_row.ie_controla_processo_lav	:= coalesce(ie_controla_processo_lav_w,'N');
	t_conjunto_row.ie_avulso				:= ie_avulso_w;

	RETURN NEXT t_conjunto_row;

	end;
end loop;
close c01;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION localiza_cm_conjunto_pck.localiza_conjunto ( nr_seq_conjunto_p bigint, nm_conjunto_p text, ie_forma_visualiza_p text, cd_setor_selec_p bigint) FROM PUBLIC;
