-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION alto_custo_artrite_pck.get_diagnostico (cd_pessoa_fisica_p text, ie_doenca_cronica_p text, ie_atend_p text) RETURNS varchar AS $body$
DECLARE


	ds_retorno_w    varchar(255);
	dt_artrite_w    timestamp;

	/*
	Parametro:
	ie_atend_p:
	  F = First (primeiro atendimento)
	  L = Last (ultimo atendimento)
	*/
  
	
BEGIN
      
		select  CASE WHEN ie_atend_p='F' THEN  trunc(min(dd.dt_cid)) WHEN ie_atend_p='L' THEN  trunc(max(dd.dt_cid)) END 
		into STRICT    dt_artrite_w
		from    diagnostico_doenca dd
		where   (dd.dt_liberacao IS NOT NULL AND dd.dt_liberacao::text <> '')
		and     (dd.dt_cid IS NOT NULL AND dd.dt_cid::text <> '')
		and     coalesce(dd.dt_inativacao::text, '') = ''
		and     alto_custo_pck.obter_se_tipo_doenca(dd.cd_doenca, 'A') = 'S'
		and     dd.nr_atendimento = alto_custo_pck.get_first_or_last_atendimento(cd_pessoa_fisica_p, 'A', ie_atend_p);

		if (dt_artrite_w IS NOT NULL AND dt_artrite_w::text <> '') then
			select  CASE WHEN ie_atend_p='F' THEN  					case					when trunc(min(dd.dt_cid)) < add_months(trunc(dt_artrite_w), -3) then '1'					when trunc(min(dd.dt_cid)) > add_months(trunc(dt_artrite_w), 3) then '1'					when (min(dd.dt_cid) IS NOT NULL AND (min(dd.dt_cid))::text <> '') then '0'					else '300' end WHEN ie_atend_p='L' THEN  case					when trunc(max(dd.dt_cid)) < add_months(dt_artrite_w,-3) then '1'					when trunc(max(dd.dt_cid)) > add_months(dt_artrite_w,3) then '1'					when (max(dd.dt_cid) IS NOT NULL AND (max(dd.dt_cid))::text <> '') then '0'					else '300' end END
			into STRICT    ds_retorno_w
			from    diagnostico_doenca dd
			where   (dd.dt_liberacao IS NOT NULL AND dd.dt_liberacao::text <> '')
			and     (dd.dt_cid IS NOT NULL AND dd.dt_cid::text <> '')
			and     coalesce(dd.dt_inativacao::text, '') = ''
			and     dd.nr_atendimento in (SELECT a.nr_atendimento from table(alto_custo_pck.get_atendimentos_paciente('A')) a)
			and     dd.cd_doenca in (	select cd_doenca_cid 
										from cid_doenca 
										where ie_doenca_cronica_mx = ie_doenca_cronica_p);

		else 
			ds_retorno_w := '300';
		end if;

		return ds_retorno_w;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION alto_custo_artrite_pck.get_diagnostico (cd_pessoa_fisica_p text, ie_doenca_cronica_p text, ie_atend_p text) FROM PUBLIC;
