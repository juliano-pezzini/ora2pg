-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION apap_pending_itens_pck.get_pending_item ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_documento_p documento.nr_sequencia%type) RETURNS SETOF T_PENDING_TABLE AS $body$
DECLARE


	row_w			t_pending_row;
	nm_usuario_w	usuario.nm_usuario%type := wheb_usuario_pck.get_nm_usuario;
	
	c_pending CURSOR FOR
		SELECT  d.nr_sequencia nr_seq_valor,
				d.dt_registro,
				b.ds_grupo_informacao, 
				c.ds_informacao,
				d.ds_result_desc,
				d.vl_resultado,
				d.ds_resultado,
				d.dt_resultado,
				c.ds_unid_med,
				coalesce(e.ie_componente,g.ie_componente) ie_componente,
				case when(c.nr_seq_temp_conteudo IS NOT NULL AND c.nr_seq_temp_conteudo::text <> '') then position(d.ds_resultado in '1,0')
					 else	position(d.ds_resultado in trim(both coalesce(obter_desc_expressao(e.cd_exp_valores),e.ds_valores))) 
				end	 ie_status,
				coalesce(d.ie_resumo,'N') ie_resumo,
				b.nr_seq_apresentacao nr_seq_apres_secao,
				c.nr_seq_apresentacao nr_seq_apres_linha,
				coalesce(d.ie_status_registro,'P') ie_status_registro,
				coalesce(d.ie_integracao,'N') ie_integracao,
				c.nr_seq_temp_conteudo
		FROM w_apap_pac_registro d, w_apap_pac_grupo b, w_apap_pac a, w_apap_pac_informacao c
LEFT OUTER JOIN tabela_visao_atributo e ON (c.nr_seq_visao = e.nr_sequencia AND c.nm_atributo_tabela = e.nm_atributo)
LEFT OUTER JOIN ehr_template_conteudo f ON (c.nr_seq_temp_conteudo = f.nr_sequencia)
LEFT OUTER JOIN ehr_elemento g ON (f.nr_seq_elemento = g.nr_sequencia)
WHERE a.nr_sequencia 			= b.nr_seq_mod_apap and b.nr_sequencia 			= c.nr_seq_apap_grupo and c.nr_sequencia 			= d.nr_seq_apap_inf and ((coalesce(d.nr_seq_origem::text, '') = '') or (d.ie_status_houdini = 'L') or
				((coalesce(d.ie_integracao,'N') = 'S') and (coalesce(d.dt_liberacao::text, '') = '')))     and a.nr_atendimento		= nr_atendimento_p and a.nr_seq_documento 		= nr_seq_documento_p and a.nm_usuario 			= nm_usuario_w and coalesce(d.ie_situacao,'A')	= 'A' and ((d.ie_resumo  = 'S') or (coalesce(c.nr_seq_superior::text, '') = ''));


BEGIN
	<<read_pending>>
	for r_pending in c_pending
		loop
		row_w.nr_seq_valor			:= r_pending.nr_seq_valor;
		row_w.dt_registro			:= r_pending.dt_registro;
        row_w.ds_grupo_informacao	:= r_pending.ds_grupo_informacao;
        row_w.ds_informacao			:= r_pending.ds_informacao;
		row_w.nr_seq_apres_secao	:= r_pending.nr_seq_apres_secao;
		row_w.nr_seq_apres_linha	:= r_pending.nr_seq_apres_linha;
		row_w.ds_result_desc		:= r_pending.ds_result_desc;
		row_w.ie_status_registro	:= r_pending.ie_status_registro;
		row_w.ie_integracao			:= r_pending.ie_integracao;
		row_w.ie_status				:= null;
		if (coalesce(row_w.ds_result_desc::text, '') = '') then
			if (r_pending.dt_resultado IS NOT NULL AND r_pending.dt_resultado::text <> '') then
				row_w.ds_result_desc	:= pkg_date_formaters_tz.to_varchar(r_pending.dt_resultado,'shortDate',establishment_timezone_utils.gettimezone);
			elsif (r_pending.vl_resultado IS NOT NULL AND r_pending.vl_resultado::text <> '') then
				row_w.ds_result_desc	:= r_pending.vl_resultado ||' '||r_pending.ds_unid_med;
			elsif (r_pending.ds_resultado IS NOT NULL AND r_pending.ds_resultado::text <> '') then
				if (r_pending.ie_componente = 'cb') then
					if (r_pending.ie_status = 1) then
						row_w.ds_result_desc	:= obter_valor_dominio(6, 'S');
						row_w.ie_status			:= r_pending.ie_status;
					elsif (r_pending.ie_status = 3) then
						row_w.ds_result_desc	:= obter_valor_dominio(6, 'N');
						row_w.ie_status			:= r_pending.ie_status;
					end if;	
				else
					row_w.ds_result_desc	:= r_pending.ds_resultado;
				end if;
			end if;
		elsif (r_pending.ie_resumo = 'N') then
			row_w.ds_result_desc	:= r_pending.ds_result_desc ||' '||r_pending.ds_unid_med;
		end if;	
		RETURN NEXT row_w;
		end loop	read_pending;
	return;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION apap_pending_itens_pck.get_pending_item ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_documento_p documento.nr_sequencia%type) FROM PUBLIC;
