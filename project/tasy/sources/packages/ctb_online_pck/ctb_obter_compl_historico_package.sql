-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ctb_online_pck.ctb_obter_compl_historico (cd_tipo_lote_contabil_p bigint, cd_historico_p bigint) RETURNS varchar AS $body$
DECLARE


  ds_retorno_w  varchar(4000);
  vl_atributo_w varchar(4000);

  C02 CURSOR FOR
      SELECT a.nm_atributo,
              b.ds_caracter_pre,
              b.ds_caracter_pos,
              b.ie_funcao,
              b.ds_mascara,
              coalesce(b.ie_manter_nulo,'N') ie_manter_nulo
      from   historico_padrao_atributo b,
              atributo_compl_hist       a
      where  b.nr_seq_atributo = a.nr_sequencia
      and    b.cd_tipo_lote_contabil = cd_tipo_lote_contabil_p
      and    b.cd_historico = cd_historico_p
      and    b.cd_tipo_lote_contabil = a.cd_tipo_lote_contab
      order  by b.nr_seq_apres;

BEGIN
  ds_retorno_w := null;
  /* Identificar a ordem dos campos para o historico e tipo de lote e montar o complemento a ser retornado */


  for dados_w in C02 loop
      begin
          if (current_setting('ctb_online_pck.atrib_compl_hist_w')::(vetor_compl_historico(dados_w.nm_atributo) IS NOT NULL AND (vetor_compl_historico(dados_w.nm_atributo))::text <> '') or dados_w.ie_manter_nulo = 'S') then
              if (dados_w.ie_funcao = 'Upper') then
                  current_setting('ctb_online_pck.atrib_compl_hist_w')::vetor_compl_historico(dados_w.nm_atributo) := upper(current_setting('ctb_online_pck.atrib_compl_hist_w')::vetor_compl_historico(dados_w.nm_atributo));
              elsif (dados_w.ie_funcao = 'Lower') then
                  current_setting('ctb_online_pck.atrib_compl_hist_w')::vetor_compl_historico(dados_w.nm_atributo) := Lower(current_setting('ctb_online_pck.atrib_compl_hist_w')::vetor_compl_historico(dados_w.nm_atributo));
              elsif (dados_w.ie_funcao = 'Initcap') then
                  current_setting('ctb_online_pck.atrib_compl_hist_w')::vetor_compl_historico(dados_w.nm_atributo) := Initcap(current_setting('ctb_online_pck.atrib_compl_hist_w')::vetor_compl_historico(dados_w.nm_atributo));
              end if;
              if (dados_w.ds_mascara IS NOT NULL AND dados_w.ds_mascara::text <> '') then
                  begin
                      vl_atributo_w := current_setting('ctb_online_pck.atrib_compl_hist_w')::vetor_compl_historico(dados_w.nm_atributo);
                      current_setting('ctb_online_pck.atrib_compl_hist_w')::vetor_compl_historico(dados_w.nm_atributo) := to_char(to_date(current_setting('ctb_online_pck.atrib_compl_hist_w')::vetor_compl_historico(dados_w.nm_atributo),'dd/mm/yy hh24:mi:ss'),dados_w.ds_mascara);
                  exception
                      when others then
                          current_setting('ctb_online_pck.atrib_compl_hist_w')::vetor_compl_historico(dados_w.nm_atributo) := vl_atributo_w;
                  end;
              end if;
              ds_retorno_w := substr( ds_retorno_w ||
                                      dados_w.ds_caracter_pre ||
                                      current_setting('ctb_online_pck.atrib_compl_hist_w')::vetor_compl_historico(dados_w.nm_atributo) ||
                                      dados_w.ds_caracter_pos,
                                      1,4000);
          end if;
      end;
  END LOOP;

  return substr(ds_retorno_w,1,255);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ctb_online_pck.ctb_obter_compl_historico (cd_tipo_lote_contabil_p bigint, cd_historico_p bigint) FROM PUBLIC;
