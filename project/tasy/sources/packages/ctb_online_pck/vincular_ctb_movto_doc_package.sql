-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_online_pck.vincular_ctb_movto_doc (nr_seq_ctb_movto_p ctb_movimento.nr_sequencia%type, nr_seq_ctb_doc_p ctb_documento.nr_sequencia%type, ie_operacao_p text, nm_usuario_p text) AS $body$
DECLARE


  ctb_movto_w        ctb_movimento%rowtype;
  ctb_doc_w          ctb_documento%rowtype;
  nr_seq_mov_ctb_doc movimento_contabil_doc.nr_sequencia%type;


BEGIN
  if (ie_operacao_p = 'V') then
      select coalesce(max(nr_sequencia),0)
      into STRICT   nr_seq_mov_ctb_doc
      from   movimento_contabil_doc c
      where  nr_seq_ctb_movto = nr_seq_ctb_movto_p
      and    nr_seq_ctb_documento = nr_seq_ctb_doc_p;

      if (nr_seq_mov_ctb_doc = 0) then
          begin
              select * into STRICT ctb_movto_w from ctb_movimento where nr_sequencia = nr_seq_ctb_movto_p;

              select * into STRICT ctb_doc_w from ctb_documento where nr_sequencia = nr_seq_ctb_doc_p;

              insert into movimento_contabil_doc(nr_sequencia,
                    nr_lote_contabil,
                    nr_seq_info,
                    dt_atualizacao,
                    nm_usuario,
                    dt_atualizacao_nrec,
                    nm_usuario_nrec,
                    nr_documento,
                    vl_movimento,
                    nm_tabela,
                    nm_atributo,
                    nr_seq_doc_compl,
                    cd_historico,
                    ds_compl_historico,
                    dt_movimento,
                    nr_seq_ctb_movto,
                    nr_seq_ctb_documento,
                    nr_doc_analitico,
                    cd_sequencia_parametro)
              values (nextval('movimento_contabil_doc_seq'),
                    ctb_movto_w.nr_lote_contabil,
                    ctb_doc_w.nr_seq_info,
                    clock_timestamp(),
                    nm_usuario_p,
                    clock_timestamp(),
                    nm_usuario_p,
                    ctb_doc_w.nr_documento,
                    ctb_movto_w.vl_movimento,
                    ctb_doc_w.nm_tabela,
                    ctb_doc_w.nm_atributo,
                    ctb_doc_w.nr_seq_doc_compl,
                    ctb_movto_w.cd_historico,
                    ctb_movto_w.ds_compl_historico,
                    ctb_movto_w.dt_movimento,
                    nr_seq_ctb_movto_p,
                    nr_seq_ctb_doc_p,
                    ctb_doc_w.nr_doc_analitico,
                    current_setting('ctb_online_pck.cd_sequencia_parametro_ww')::movimento_contabil_doc.cd_sequencia_parametro%type);

              update ctb_documento
              set    ie_situacao_ctb  = 'C',
                      nr_lote_contabil = ctb_movto_w.nr_lote_contabil
              where  nr_sequencia = nr_seq_ctb_doc_p;
          end;
      end if;
  elsif (ie_operacao_p = 'D') then
      begin
          delete from movimento_contabil_doc
          where  nr_seq_ctb_movto = nr_seq_ctb_movto_p
          and    nr_seq_ctb_documento = nr_seq_ctb_doc_p;

          update ctb_documento
          set    ie_situacao_ctb  = 'P',
                  nr_lote_contabil  = NULL
          where  nr_sequencia = nr_seq_ctb_doc_p;
      end;
  end if;

  commit;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_online_pck.vincular_ctb_movto_doc (nr_seq_ctb_movto_p ctb_movimento.nr_sequencia%type, nr_seq_ctb_doc_p ctb_documento.nr_sequencia%type, ie_operacao_p text, nm_usuario_p text) FROM PUBLIC;
