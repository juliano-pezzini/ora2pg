-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

/* Function que busca o modo do lote online/offline*/




CREATE OR REPLACE FUNCTION ctb_online_pck.get_modo_lote (cd_tipo_lote_contabil_p bigint, cd_estabelecimento_p bigint, cd_empresa_p bigint default null) RETURNS varchar AS $body$
DECLARE


ie_ctb_online_w         ctb_param_lote_nf.ie_ctb_online%type := 'N';
current_setting('ctb_online_pck.cd_tipo_lote_contabil_w')::ctb_regra_estab_dif.cd_tipo_lote_contabil%type tipo_lote_contabil.cd_tipo_lote_contabil%type := cd_tipo_lote_contabil_p;
cd_estab_exclusivo_w    ctb_param_lote_nf.cd_estab_exclusivo%type := cd_estabelecimento_p;
cd_empresa_w            ctb_param_lote_nf.cd_empresa%type := cd_empresa_p;
ds_erro_w               varchar(4000);


BEGIN
        if (coalesce(cd_empresa_w,0) = 0) then
                cd_empresa_w := obter_empresa_estab(coalesce(cd_estabelecimento_p,wheb_usuario_pck.get_cd_estabelecimento));
        end if;
        begin
                if coalesce(cd_estab_exclusivo_w::text, '') = '' then
                        cd_estab_exclusivo_w := wheb_usuario_pck.get_cd_estabelecimento;
                end if;
                ie_ctb_online_w := current_setting('ctb_online_pck.vetor_lote_w')::vetor_lote(current_setting('ctb_online_pck.cd_tipo_lote_contabil_w')::ctb_regra_estab_dif.cd_tipo_lote_contabil%type) (cd_empresa_w) (cd_estab_exclusivo_w);

        exception
        when others then
                ie_ctb_online_w := null;
        end;
        if (coalesce(ie_ctb_online_w,'X') = 'X') then
                begin
                        select case current_setting('ctb_online_pck.cd_tipo_lote_contabil_w')::ctb_regra_estab_dif.cd_tipo_lote_contabil%type
                        when 2 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_nf a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 3 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_consumo a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 5 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_contas_rec a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 6 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_receita a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 7 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_contas_pag a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 8 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_pre_fatur a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 9 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_cont_terc a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 10 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_tesouraria a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 11 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_receb_conv a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 14 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_repasse a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 16 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_tit_repasse a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 17 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_patrimonio a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 18 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_cont_banco a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 25 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_producao a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 26 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_consignado a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 29 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_nota_cred a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        when 51 then (select coalesce(max(x.ie_ctb_online),'N')
                                from (select ie_ctb_online
                                        from   ctb_param_lote_nf a
                                        where  a.cd_empresa = cd_empresa_w
                                        and    coalesce(a.cd_estab_exclusivo,cd_estab_exclusivo_w) = cd_estab_exclusivo_w
                                        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1)
                        else
                                'N'
                        end
                        into STRICT   ie_ctb_online_w
;
                exception
                when others then
                        ie_ctb_online_w := 'N';
                end;
                begin
                        current_setting('ctb_online_pck.vetor_lote_w')::vetor_lote(current_setting('ctb_online_pck.cd_tipo_lote_contabil_w')::ctb_regra_estab_dif.cd_tipo_lote_contabil%type)(cd_empresa_w)(cd_estab_exclusivo_w) := ie_ctb_online_w;
                exception
                when others then
                        ds_erro_w := substr('cd_tipo_lote_contabil_w: ' || current_setting('ctb_online_pck.cd_tipo_lote_contabil_w')::ctb_regra_estab_dif.cd_tipo_lote_contabil%type || '|cd_empresa_w: ' || cd_empresa_w || '|cd_estab_exclusivo_w: ' ||
                                cd_estab_exclusivo_w || '|' || chr(13) || chr(10) ||'End: ' || dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
                        CALL wheb_mensagem_pck.exibir_mensagem_abort(184609, ds_erro_w);
                end;

        end if;

        return ie_ctb_online_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ctb_online_pck.get_modo_lote (cd_tipo_lote_contabil_p bigint, cd_estabelecimento_p bigint, cd_empresa_p bigint default null) FROM PUBLIC;
