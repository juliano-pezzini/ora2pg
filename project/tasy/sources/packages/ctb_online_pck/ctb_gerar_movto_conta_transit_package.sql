-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_online_pck.ctb_gerar_movto_conta_transit (ctb_movimento_p INOUT ctb_movimento, nm_usuario_p text, ie_consistir_p text default 'S', ie_atualizar_saldo_p text default 'S') AS $body$
DECLARE


  ctb_movimento_doc_w     ctb_online_pck.ctb_movimento_doc;
  current_setting('ctb_online_pck.cd_tipo_lote_contabil_w')::ctb_regra_estab_dif.cd_tipo_lote_contabil%type lote_contabil.cd_tipo_lote_contabil%type;
  qt_hist_w               bigint;


BEGIN

  if (coalesce(ctb_movimento_p.nr_lote_contabil,0) != 0) then
      begin
          select cd_tipo_lote_contabil into STRICT current_setting('ctb_online_pck.cd_tipo_lote_contabil_w')::ctb_regra_estab_dif.cd_tipo_lote_contabil%type from lote_contabil where nr_lote_contabil = ctb_movimento_p.nr_lote_contabil;
      exception
          when no_data_found then
              PERFORM set_config('ctb_online_pck.cd_tipo_lote_contabil_w', null, false);
      end;
  end if;

  if (coalesce(ctb_movimento_p.ds_compl_historico,'X') = 'X'
     and coalesce(ctb_movimento_p.cd_historico,0) <> 0
     and current_setting('ctb_online_pck.cd_tipo_lote_contabil_w')::ctb_regra_estab_dif.cd_tipo_lote_contabil%(type IS NOT NULL AND type::text <> '')) then
      begin
          select count(*)
          into STRICT   qt_hist_w
          from   historico_padrao_atributo c,
                  historico_padrao          b
          where  b.cd_historico = c.cd_historico
          and    b.cd_historico = ctb_movimento_p.cd_historico;

          if (qt_hist_w > 0) then
              ctb_movimento_p.ds_compl_historico := ctb_online_pck.ctb_obter_compl_historico(current_setting('ctb_online_pck.cd_tipo_lote_contabil_w')::ctb_regra_estab_dif.cd_tipo_lote_contabil%type,ctb_movimento_p.cd_historico);
          end if;
      end;
  else
      ctb_movimento_p.ds_compl_historico := coalesce(ctb_movimento_p.ds_compl_historico,substr(ctb_movimento_p.nr_documento,1,255));
  end if;

  ctb_movimento_p.nr_seq_agrupamento := coalesce(ctb_movimento_p.nr_seq_agrupamento,somente_numero(substr(ctb_movimento_p.nr_documento,1,10)));
  ctb_movimento_p.nr_documento       := substr(ctb_movimento_p.nr_documento,1,20);
  ctb_movimento_p.ie_transitorio     := 'S';

  ctb_movimento_doc_w.nr_sequencia          := ctb_movimento_p.nr_sequencia;
  ctb_movimento_doc_w.nr_lote_contabil      := ctb_movimento_p.nr_lote_contabil;
  ctb_movimento_doc_w.cd_tipo_lote_contabil := current_setting('ctb_online_pck.cd_tipo_lote_contabil_w')::ctb_regra_estab_dif.cd_tipo_lote_contabil%type;
  ctb_movimento_doc_w.cd_estabelecimento    := ctb_movimento_p.cd_estabelecimento;
  ctb_movimento_doc_w.dt_movimento          := ctb_movimento_p.dt_movimento;
  ctb_movimento_doc_w.vl_movimento          := ctb_movimento_p.vl_movimento;
  ctb_movimento_doc_w.cd_conta_debito       := ctb_movimento_p.cd_conta_debito;
  ctb_movimento_doc_w.cd_conta_credito      := ctb_movimento_p.cd_conta_credito;
  ctb_movimento_doc_w.cd_historico          := ctb_movimento_p.cd_historico;
  ctb_movimento_doc_w.nr_seq_agrupamento    := ctb_movimento_p.nr_seq_agrupamento;
  ctb_movimento_doc_w.ds_compl_historico    := ctb_movimento_p.ds_compl_historico;
  ctb_movimento_doc_w.nr_documento          := ctb_movimento_p.nr_documento;
  ctb_movimento_doc_w.ie_origem_documento   := ctb_movimento_p.ie_origem_documento;
  ctb_movimento_doc_w.nr_seq_movto_partida  := ctb_movimento_p.nr_seq_movto_partida;
  ctb_movimento_doc_w.ie_transitorio        := ctb_movimento_p.ie_transitorio;

  ctb_movimento_doc_w := ctb_online_pck.ctb_gravar_movto(ctb_movimento_doc_w, nm_usuario_p, 'S', ie_consistir_p, ie_atualizar_saldo_p, ctb_movimento_p.nr_seq_proj_rec);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_online_pck.ctb_gerar_movto_conta_transit (ctb_movimento_p INOUT ctb_movimento, nm_usuario_p text, ie_consistir_p text default 'S', ie_atualizar_saldo_p text default 'S') FROM PUBLIC;
