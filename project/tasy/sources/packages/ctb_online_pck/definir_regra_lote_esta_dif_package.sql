-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_online_pck.definir_regra_lote_esta_dif (cd_tipo_lote_contabil_p ctb_regra_estab_dif.cd_tipo_lote_contabil%type, cd_estab_origem_p ctb_regra_estab_dif.cd_estab_origem%type) AS $body$
DECLARE

  C01 CURSOR FOR
      SELECT ie_permite,
              cd_conta_contabil,
              cd_historico,
              cd_estabelecimento
      from   ctb_regra_estab_dif
      where  cd_tipo_lote_contabil = cd_tipo_lote_contabil_p
      and    (((coalesce(cd_estab_origem,current_setting('ctb_online_pck.cd_estab_origem_w')::ctb_regra_estab_dif.cd_estab_origem%type) = current_setting('ctb_online_pck.cd_estab_origem_w')::ctb_regra_estab_dif.cd_estab_origem%type)
              and (current_setting('ctb_online_pck.cd_estab_origem_w')::ctb_regra_estab_dif.cd_estab_origem%type > 0))
              or (((cd_estab_origem = coalesce(cd_estab_origem,cd_estab_origem_p))
              and (current_setting('ctb_online_pck.cd_estab_origem_w')::ctb_regra_estab_dif.cd_estab_origem%type = 0))));


BEGIN
  if (((coalesce(cd_tipo_lote_contabil_p,0) <> coalesce(current_setting('ctb_online_pck.cd_tipo_lote_contabil_w')::ctb_regra_estab_dif.cd_tipo_lote_contabil%type,0)) or (coalesce(cd_estab_origem_p,0) <> coalesce(current_setting('ctb_online_pck.cd_estab_origem_w')::ctb_regra_estab_dif.cd_estab_origem%type,0)))) then
      begin
          PERFORM set_config('ctb_online_pck.cd_tipo_lote_contabil_w', cd_tipo_lote_contabil_p, false);
          PERFORM set_config('ctb_online_pck.cd_estab_origem_w', coalesce(cd_estab_origem_p,
                                          0), false);
          PERFORM set_config('ctb_online_pck.ie_permite_w', 'N', false);
          PERFORM set_config('ctb_online_pck.cd_conta_contabil_w', null, false);
          PERFORM set_config('ctb_online_pck.cd_historico_w', null, false);

          open C01;
          loop
              fetch C01
                  into current_setting('ctb_online_pck.ie_permite_w')::ctb_regra_estab_dif.ie_permite%type,
                        current_setting('ctb_online_pck.cd_conta_contabil_w')::ctb_regra_estab_dif.cd_conta_contabil%type,
                        current_setting('ctb_online_pck.cd_historico_w')::ctb_regra_estab_dif.cd_historico%type,
                        current_setting('ctb_online_pck.cd_estab_contabil_w')::ctb_regra_estab_dif.cd_estab_origem%type;
              EXIT WHEN NOT FOUND; /* apply on c01 */
          end loop;
          close C01;
      end;
  end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_online_pck.definir_regra_lote_esta_dif (cd_tipo_lote_contabil_p ctb_regra_estab_dif.cd_tipo_lote_contabil%type, cd_estab_origem_p ctb_regra_estab_dif.cd_estab_origem%type) FROM PUBLIC;
