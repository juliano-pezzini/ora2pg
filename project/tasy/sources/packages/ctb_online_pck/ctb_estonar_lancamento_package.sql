-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_online_pck.ctb_estonar_lancamento (nr_seq_lancamento_p bigint, nr_lote_contabil_p bigint, dt_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


  nr_seq_mes_ref_w           ctb_movimento.nr_seq_mes_ref%type;
  dt_movimento_w             ctb_movimento.dt_movimento%type;
  vl_movimento_w             ctb_movimento.vl_movimento%type;
  current_setting('ctb_online_pck.cd_historico_w')::ctb_regra_estab_dif.cd_historico%type             ctb_movimento.cd_historico%type;
  cd_conta_credito_w         ctb_movimento.cd_conta_credito%type;
  cd_conta_debito_w          ctb_movimento.cd_conta_debito%type;
  ds_compl_historico_w       ctb_movimento.ds_compl_historico%type;
  nr_seq_agrupamento_w       ctb_movimento.nr_seq_agrupamento%type;
  cd_estabelecimento_w       ctb_movimento.cd_estabelecimento%type;
  ds_consistencia_w          ctb_movimento.ds_consistencia%type;
  cd_classif_credito_w       ctb_movimento.cd_classif_credito%type;
  cd_classif_debito_w        ctb_movimento.cd_classif_debito%type;
  nr_agrup_sequencial_w      ctb_movimento.nr_agrup_sequencial%type;
  nr_documento_w             ctb_movimento.nr_documento%type;
  ie_origem_documento_w      ctb_movimento.ie_origem_documento%type;
  ie_status_concil_w         ctb_movimento.ie_status_concil%type;
  ie_status_origem_w         ctb_movimento.ie_status_origem%type;
  nr_seq_movto_partida_est_w ctb_movimento.nr_seq_movto_partida%type;
  nr_seq_movimento_est_w     ctb_movimento.nr_sequencia%type;
  nr_seq_movimento_w         ctb_movimento.nr_sequencia%type;
  nr_seq_proj_rec_w          ctb_movimento.nr_seq_proj_rec%type;
  ie_validacao_ww            ctb_movimento.ie_validacao%type;

  C01 CURSOR FOR
      SELECT a.nr_sequencia,
              a.nr_seq_mes_ref,
              a.dt_movimento,
              a.vl_movimento,
              a.cd_historico,
              a.cd_conta_credito,
              a.cd_conta_debito,
              a.ds_compl_historico,
              a.nr_seq_agrupamento,
              a.cd_estabelecimento,
              a.ds_consistencia,
              a.cd_classif_credito,
              a.cd_classif_debito,
              a.nr_documento,
              a.ie_origem_documento,
              a.ie_status_concil,
              a.ie_status_origem,
              a.nr_seq_proj_rec,
              a.ie_validacao
      from   ctb_movimento a
      where  a.nr_agrup_sequencial = nr_seq_lancamento_p
      and    a.nr_lote_contabil = nr_lote_contabil_p
      order  by a.nr_seq_movto_partida asc;


BEGIN

  /* Removido pois esta informacao sera gerada posteriormente na reatualizacao do saldo */


  -- nr_agrup_sequencial_w:= ctb_online_pck.get_agrup_sequencial(obter_empresa_estab(cd_estabelecimento_p), dt_referencia_p);


  open C01;
  loop
      fetch C01
          into nr_seq_movimento_w,
                nr_seq_mes_ref_w,
                dt_movimento_w,
                vl_movimento_w,
                current_setting('ctb_online_pck.cd_historico_w')::ctb_regra_estab_dif.cd_historico%type,
                cd_conta_credito_w,
                cd_conta_debito_w,
                ds_compl_historico_w,
                nr_seq_agrupamento_w,
                cd_estabelecimento_w,
                ds_consistencia_w,
                cd_classif_credito_w,
                cd_classif_debito_w,
                nr_documento_w,
                ie_origem_documento_w,
                ie_status_concil_w,
                ie_status_origem_w,
                nr_seq_proj_rec_w,
                ie_validacao_ww;
      EXIT WHEN NOT FOUND; /* apply on C01 */
      begin

          select nextval('ctb_movimento_seq') into STRICT nr_seq_movimento_est_w;

          insert into ctb_movimento(nr_sequencia,
                nr_lote_contabil,
                nr_seq_mes_ref,
                dt_movimento,
                vl_movimento,
                dt_atualizacao,
                nm_usuario,
                cd_historico,
                cd_conta_debito,
                cd_conta_credito,
                ds_compl_historico,
                nr_seq_agrupamento,
                ie_revisado,
                cd_estabelecimento,
                ds_consistencia,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                cd_classif_debito,
                cd_classif_credito,
                dt_revisao,
                nm_usuario_revisao,
                nr_agrup_sequencial,
                nr_documento,
                ie_origem_documento,
                nr_seq_movto_partida,
                ie_status_concil,
                ie_status_origem,
                nr_seq_proj_rec,
                ie_validacao)
          values (nr_seq_movimento_est_w,
                nr_lote_contabil_p,
                nr_seq_mes_ref_w,
                dt_movimento_w,
                vl_movimento_w,
                clock_timestamp(),
                nm_usuario_p,
                current_setting('ctb_online_pck.cd_historico_w')::ctb_regra_estab_dif.cd_historico%type,
                cd_conta_credito_w,
                cd_conta_debito_w,
                ds_compl_historico_w,
                nr_seq_agrupamento_w,
                'N',
                cd_estabelecimento_w,
                ds_consistencia_w,
                clock_timestamp(),
                nm_usuario_p,
                cd_classif_credito_w,
                cd_classif_debito_w,
                clock_timestamp(),
                nm_usuario_p,
                nr_agrup_sequencial_w,
                nr_documento_w,
                ie_origem_documento_w,
                nr_seq_movto_partida_est_w,
                'NC',
                'I',
                nr_seq_proj_rec_w,
                ie_validacao_ww);

          if (coalesce(nr_seq_movto_partida_est_w,0) = 0) then
              begin
                  nr_seq_movto_partida_est_w := nr_seq_movimento_est_w;
              end;
          end if;

          insert into ctb_movto_centro_custo(nr_sequencia,
                cd_centro_custo,
                dt_atualizacao,
                nm_usuario,
                nr_seq_movimento,
                vl_movimento)
              (SELECT nextval('ctb_movto_centro_custo_seq'),
                      a.cd_centro_custo,
                      clock_timestamp(),
                      nm_usuario_p,
                      nr_seq_movimento_est_w,
                      a.vl_movimento
                from   ctb_movto_centro_custo a
                where  a.nr_seq_movimento = nr_seq_movimento_w);

          insert into movimento_contabil_doc(nr_sequencia,
                cd_cnpj,
                cd_conta_contabil,
                cd_pessoa_fisica,
                dt_atualizacao,
                dt_atualizacao_nrec,
                ie_debito_credito,
                nm_atributo,
                nm_tabela,
                nm_usuario,
                nm_usuario_nrec,
                nr_documento,
                nr_seq_ctb_movto,
                nr_seq_regra_tf,
                vl_movimento)
              (SELECT nextval('movimento_contabil_doc_seq'),
                      a.cd_cnpj,
                      a.cd_conta_contabil,
                      a.cd_pessoa_fisica,
                      clock_timestamp(),
                      clock_timestamp(),
                      CASE WHEN a.ie_debito_credito='D' THEN 'C'  ELSE 'D' END ,
                      a.nm_atributo,
                      a.nm_tabela,
                      nm_usuario_p,
                      nm_usuario_p,
                      a.nr_documento,
                      nr_seq_movimento_est_w,
                      a.nr_seq_regra_tf,
                      a.vl_movimento
                from   movimento_contabil_doc a
                where  a.nr_seq_movimento = nr_seq_movimento_w);

      end;
  end loop;

  close C01;

  commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_online_pck.ctb_estonar_lancamento (nr_seq_lancamento_p bigint, nr_lote_contabil_p bigint, dt_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
