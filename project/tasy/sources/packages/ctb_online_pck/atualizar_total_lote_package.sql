-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_online_pck.atualizar_total_lote (nr_lote_contabil_p lote_contabil.nr_lote_contabil%type, ie_commit_p text default 'N') AS $body$
BEGIN

    update  lote_contabil l
    set     l.vl_debito =
                (SELECT sum(y.vl_movimento)
                from   ctb_movimento y
                where  y.nr_lote_contabil = nr_lote_contabil_p
                and    (y.cd_conta_debito IS NOT NULL AND y.cd_conta_debito::text <> '')
                and    coalesce(y.ds_consistencia::text, '') = ''),
            l.vl_credito =
                (select sum(y.vl_movimento)
                from   ctb_movimento y
                where  y.nr_lote_contabil = nr_lote_contabil_p
                and    (y.cd_conta_credito IS NOT NULL AND y.cd_conta_credito::text <> '')
                and    coalesce(y.ds_consistencia::text, '') = '')
    where  l.nr_lote_contabil = nr_lote_contabil_p;

    begin
    update  lote_contabil a
    set     a.dt_atualizacao_saldo = clock_timestamp(),
            a.dt_consistencia      = clock_timestamp()
    where   a.nr_lote_contabil = nr_lote_contabil_p
    and not exists (SELECT 1
            from   ctb_movimento b
            where  b.nr_lote_contabil = a.nr_lote_contabil
            and    coalesce(b.dt_atualizacao_saldo::text, '') = ''  LIMIT 1);

    if (NOT FOUND) then
        update  lote_contabil a
        set     a.dt_atualizacao_saldo  = NULL,
                a.dt_consistencia       = NULL
        where   a.nr_lote_contabil = nr_lote_contabil_p;
    end if;
    end;

  if (ie_commit_p = 'S') then
      commit;
  end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_online_pck.atualizar_total_lote (nr_lote_contabil_p lote_contabil.nr_lote_contabil%type, ie_commit_p text default 'N') FROM PUBLIC;
