-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_online_pck.get_ctb_mes_ref ( dt_referencia_p ctb_mes_ref.dt_referencia%type, cd_empresa_p ctb_mes_ref.cd_empresa%type, nm_usuario_p ctb_mes_ref.nm_usuario%type, nr_sequencia_p INOUT ctb_mes_ref.nr_sequencia%type) AS $body$
DECLARE


nr_seq_mes_ref_w          ctb_mes_ref.nr_sequencia%type;


BEGIN

    begin
        select a.nr_sequencia
        into STRICT   nr_seq_mes_ref_w
        from   ctb_mes_ref a
        where  a.dt_referencia = trunc(dt_referencia_p,'MONTH')
        and    a.cd_empresa    = cd_empresa_p;
    exception
    when no_data_found then
        select nextval('ctb_mes_ref_seq') into STRICT nr_seq_mes_ref_w;

        insert into ctb_mes_ref(
            nr_sequencia,
            cd_empresa,
            dt_referencia,
            dt_abertura,
            nm_usuario_abertura,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec)
        values (
            nr_seq_mes_ref_w,
            cd_empresa_p,
            trunc(dt_referencia_p,'MONTH'),
            clock_timestamp(),
            nm_usuario_p,
            clock_timestamp(),
            nm_usuario_p,
            clock_timestamp(),
            nm_usuario_p);
    end;

    nr_sequencia_p    := nr_seq_mes_ref_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_online_pck.get_ctb_mes_ref ( dt_referencia_p ctb_mes_ref.dt_referencia%type, cd_empresa_p ctb_mes_ref.cd_empresa%type, nm_usuario_p ctb_mes_ref.nm_usuario%type, nr_sequencia_p INOUT ctb_mes_ref.nr_sequencia%type) FROM PUBLIC;
