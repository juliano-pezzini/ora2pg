-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/* Funcao para buscar geracao do lote RECEITA */




CREATE OR REPLACE FUNCTION ctb_online_pck.get_geracao_lote_receita (cd_convenio_p bigint default null, cd_estabelecimento_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_tipo_convenio_p bigint default null) RETURNS varchar AS $body$
DECLARE


ie_geracao_w ctb_regra_geracao_lote_rec.ie_geracao%type;
cd_empresa_w empresa.cd_empresa%type;


BEGIN
  cd_empresa_w := obter_empresa_estab(cd_estabelecimento_p);

  begin
      select x.ie_geracao
      into STRICT   ie_geracao_w
      from (SELECT a.ie_geracao
              from   ctb_regra_geracao_lote_rec a
              where  coalesce(a.cd_estab_exclusivo,cd_estabelecimento_p) = cd_estabelecimento_p
              and    a.cd_empresa = cd_empresa_w
              and    coalesce(a.ie_tipo_convenio,coalesce(cd_tipo_convenio_p,0)) = coalesce(cd_tipo_convenio_p,0)
              and    coalesce(a.cd_convenio,coalesce(cd_convenio_p,0)) = coalesce(cd_convenio_p,0)
              order  by coalesce(a.cd_convenio,0) desc,coalesce(a.ie_tipo_convenio,0) desc,coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;

  exception
      when others then
          ie_geracao_w := 'X';
  end;

  return ie_geracao_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ctb_online_pck.get_geracao_lote_receita (cd_convenio_p bigint default null, cd_estabelecimento_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_tipo_convenio_p bigint default null) FROM PUBLIC;
