-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/** 
   +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Common Header among Systems
	unique_key :- prescription number / encounter number
	message type:- 1D -> Order Request confirm information
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
   **/
CREATE OR REPLACE PROCEDURE carestream_phys_japan_l10n_pck.common_header ( unique_key_p text, sequence_number_p bigint, file_sequence_p bigint ) AS $body$
DECLARE


        c01 CURSOR FOR
        SELECT
            b.patient_id                    patient_id,
            obter_prontuario_paciente(b.patient_id) patient_mrn,
            a.release_date_time             order_date,
            a.prescription_number           prescription_number,
            b.encounter_id                  encounter_number,
            null unique_id,
            'L0'||to_char(clock_timestamp(), 'YYMMDD')|| lpad(file_sequence_p, 5, '0') ||'00' accession_number,
            coalesce(CASE WHEN b.type_encounter_id=1 THEN  2 WHEN b.type_encounter_id=8 THEN  1 END , 1) encounter_type,
            b.department_id                 department_code,
            b.department_name               department_name,
            coalesce(b.room_id, '')                  ward_code,
            coalesce(b.bed_id,'')                       ward_name,
            b.encounter_doctor_id           requested_physician_id,
            '' requested_physician_kana,
            b.encounter_doctor_given_name   requested_physician_name,
            a.requested_date_time           request_date,
            coalesce(a.suspended_time , c.dt_cancelamento)    discontinue_date,
            CASE WHEN coalesce(coalesce(a.suspended_time,c.dt_cancelamento)::text, '') = '' THEN ' '  ELSE '0' END      discontinue_reason  -- 0: Stop 1: Stop for change 2: New by change
        from
            bft_order_v                a,
            bft_encounter_v            b,
            prescr_procedimento         c
        where
            a.encounter_id = b.encounter_id
            and a.prescription_number = c.nr_prescricao
            and a.prescription_number = unique_key_p
            and c.nr_sequencia = sequence_number_p  LIMIT 1;


BEGIN
        for r_c01 in c01 loop
            begin
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.patient_mrn, 10, 'L', '0'); -- PT_ID
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(to_char(r_c01.order_date, 'YYYYMMDD'), 8); -- HASSEI_DATE
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(to_char(r_c01.order_date, 'HH24MISS'), 6); -- SEQ_NO
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(' ', 15); -- WS_NO, INDEX_KBN, XX_KBN, XX_SYBT, XX_SEQ
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.prescription_number, 14, 'L', '0'); -- NR_PRESCRICAO
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(sequence_number_p, 10, 'L', '0'); -- NR_SEQUENCIA
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.accession_number, 15); -- ACCESSION_NO
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.encounter_type, 1); -- NYUGAI_KBN
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.department_code, 3, 'L', '0'); -- KA_CD
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.department_name, 20); -- KA_NAME
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.ward_code, 3, 'L', '0'); -- BYOTO_CD 
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.ward_name, 20); -- BYOTO_NAME
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.requested_physician_id, 10, 'L', '0'); -- DR_ID
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.requested_physician_kana, 20); -- SH_KANA_NAME
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.requested_physician_name, 20); -- SH_NAME
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(to_char(r_c01.request_date, 'YYYYMMDD'), 8); -- IN_DATE
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(to_char(r_c01.discontinue_date, 'YYYYMMDD'), 8); -- STOP_DATE
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(r_c01.discontinue_reason, 1); -- STOP_RSN_FLG
                CALL CALL CALL CALL CALL CALL CALL CALL CALL CALL carestream_phys_japan_l10n_pck.append_text(1, 8, 'L', '0'); -- KOBETU_CNT
            end;
        end loop;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_phys_japan_l10n_pck.common_header ( unique_key_p text, sequence_number_p bigint, file_sequence_p bigint ) FROM PUBLIC;
