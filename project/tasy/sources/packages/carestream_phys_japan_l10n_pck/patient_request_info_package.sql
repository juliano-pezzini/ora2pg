-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE carestream_phys_japan_l10n_pck.patient_request_info (file_name_p text) AS $body$
DECLARE


    message_code_w   varchar(2);
    current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint    varchar(10);
    patient_id_w     varchar(20);
    file_name_like_w varchar(8);
    nm_usuario_w  varchar(255) := 'tasy_phy';
    cd_establishment_w  integer;
    message_char_w   varchar(32000);



BEGIN

        PERFORM set_config('carestream_phys_japan_l10n_pck.ds_local_w', null, false);
        PERFORM set_config('carestream_phys_japan_l10n_pck.interface_event_w', 937, false);
        PERFORM set_config('carestream_phys_japan_l10n_pck.nm_interface_w', 'Japan Carestream - PHY', false);
        PERFORM set_config('carestream_phys_japan_l10n_pck.ds_message_w', 'CareStream Physiology - Patient Info Request', false);
        PERFORM set_config('carestream_phys_japan_l10n_pck.initial_position_w', 1, false);
        PERFORM set_config('carestream_phys_japan_l10n_pck.message_type_w', '2H', false);
        nm_usuario_w := 'tasy_phy';
        PERFORM set_config('carestream_phys_japan_l10n_pck.log_sequence_number_w', 0, false);


        select carestream_japan_l10n_pck.get_directory_event_code(current_setting('carestream_phys_japan_l10n_pck.message_type_w')::varchar(2), 'CARE_PHY_PDATA'),
               obter_estabelecimento_ativo
        into STRICT   current_setting('carestream_phys_japan_l10n_pck.cd_integartion_event_w')::philips_json,
               cd_establishment_w                      
;


        file_name_like_w := 'H'||current_setting('carestream_phys_japan_l10n_pck.physiology_dept_code_w')::varchar(2)||current_setting('carestream_phys_japan_l10n_pck.his_system_code')::varchar(2)||current_setting('carestream_phys_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['control_code'].value_of();

        select carestream_japan_l10n_pck.get_log_file_name(current_setting('carestream_phys_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['control_code'].value_of(),
                      current_setting('carestream_phys_japan_l10n_pck.his_system_code')::varchar(2), current_setting('carestream_phys_japan_l10n_pck.physiology_dept_code_w')::varchar(2), 'R')
        into STRICT current_setting('carestream_phys_japan_l10n_pck.log_file_name_w')::varchar(100)
;
        begin

            current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.read_file(file_name_p, file_name_like_w, current_setting('carestream_phys_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['cd_event_data'].value_of(), current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767));
            select utl_i18n.raw_to_char(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767))
            into STRICT message_char_w
;
            --retriving the relevant field from the inbound message
            select
                utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 0), 2), 'JA16SJIS'), -- 1 
                (utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 43), 10), 'JA16SJIS'))::numeric   --44
            into STRICT
                message_code_w,
                current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint
;

            PERFORM set_config('carestream_phys_japan_l10n_pck.ds_log_message_w', 'Successfully processed the integration message for Patient information request'
                                    || chr(10)
                                    || 'Integration name : japan_carestream_phy(Patient Request Info)'
                                    || chr(10)
                                    || 'Message Type:'
                                    || current_setting('carestream_phys_japan_l10n_pck.message_type_w')::varchar(2)
                                    || chr(10)
                                    || 'Time of processed : '
                                    || clock_timestamp() || chr(10)
                                    || 'Patient MRN:'
                                    || current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint, false);


            record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), current_setting('carestream_phys_japan_l10n_pck.nm_interface_w')::varchar(255), current_setting('carestream_phys_japan_l10n_pck.ds_message_w')::varchar(255),
                                            'P', 'R', null, current_setting('carestream_phys_japan_l10n_pck.ds_log_message_w')::varchar(32767), message_char_w,
                                            null, file_name_p, current_setting('carestream_phys_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint, null);

            CALL carestream_phys_japan_l10n_pck.patient_change_info(current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint, nm_usuario_w , current_setting('carestream_phys_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, null, cd_establishment_w, 'N');

        exception
                when others then
                    PERFORM set_config('carestream_phys_japan_l10n_pck.log_sequence_number_w', 0, false);
                    PERFORM set_config('carestream_phys_japan_l10n_pck.nm_interface_w', 'Japan Carestream - PHY', false);
                    PERFORM set_config('carestream_phys_japan_l10n_pck.ds_message_w', 'CareStream Physiology - Patient Info Request', false);

                    CALL carestream_japan_l10n_pck.update_recieve_error_file(file_name_p, current_setting('carestream_phys_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_phys_japan_l10n_pck.message_type_w')::varchar(2));
                    PERFORM set_config('carestream_phys_japan_l10n_pck.ds_log_message_w', 'Error occured while reading the information for patient information retransmit'
                                        || chr(10)
                                        || 'Integration name : japan_carestream_phy(Patient Request Info)'
                                        || chr(10)
                                        || 'Message Type:'
                                        || current_setting('carestream_phys_japan_l10n_pck.message_type_w')::varchar(2)
                                        || chr(10)
                                        || 'Time of faliure : '
                                        || clock_timestamp() || chr(10)
                                        || 'Patient MRN:'
                                        || current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint || chr(10)
                                        ||' -ERROR- '
                                        || SQLERRM, false);

                    record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), current_setting('carestream_phys_japan_l10n_pck.nm_interface_w')::varchar(255), current_setting('carestream_phys_japan_l10n_pck.ds_message_w')::varchar(255),
                                                'F', 'R', null, current_setting('carestream_phys_japan_l10n_pck.ds_log_message_w')::varchar(32767), message_char_w,
                                                current_setting('carestream_phys_japan_l10n_pck.ds_log_message_w')::varchar(32767), file_name_p, current_setting('carestream_phys_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint, null);

                    CALL carestream_japan_l10n_pck.save_log(current_setting('carestream_phys_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['cd_event_log'].value_of(), current_setting('carestream_phys_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_phys_japan_l10n_pck.ds_log_message_w')::varchar(32767));
                    return;
                end;

            -- processing the inbound message and updating it in tasy
            PERFORM set_config('carestream_phys_japan_l10n_pck.nm_interface_w', 'Japan Carestream - PHY', false);
            PERFORM set_config('carestream_phys_japan_l10n_pck.ds_message_w', 'CareStream Physiology - Patient Info Request', false);

            -- if file succcessfully read and info saved in tasy,calling function to move the file to repective ok folder from data and index folder
            CALL carestream_japan_l10n_pck.update_recieve_ok_file(file_name_p, current_setting('carestream_phys_japan_l10n_pck.log_file_name_w')::varchar(100), message_code_w);

            PERFORM set_config('carestream_phys_japan_l10n_pck.ds_log_message_w', 'Patient information retransmited successfully'
                                    || chr(10)
                                    || 'Integration name : japan_carestream_phy(Patient Request Info)'
                                    || chr(10)
                                    || 'Message Type:'
                                    || '2H'
                                    || chr(10)
                                    || 'Time of success : '
                                    || clock_timestamp() || chr(10)
                                    || 'Patient MRN:'
                                    || current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint || chr(10)
                                    ||' -ERROR- '
                                    || SQLERRM, false);

                record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), current_setting('carestream_phys_japan_l10n_pck.nm_interface_w')::varchar(255), current_setting('carestream_phys_japan_l10n_pck.ds_message_w')::varchar(255),
                                            'S', 'R', null, current_setting('carestream_phys_japan_l10n_pck.ds_log_message_w')::varchar(32767), message_char_w,
                                            null, file_name_p, current_setting('carestream_phys_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint, null);


    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_phys_japan_l10n_pck.patient_request_info (file_name_p text) FROM PUBLIC;
