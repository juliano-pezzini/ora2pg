-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE carestream_phys_japan_l10n_pck.patient_exam_execution_info (file_name_p text) AS $body$
DECLARE


    phy_exam_exec_seq phy_exam_exec_info.NR_SEQUENCIA%type;
    phy_exam_proc_seq phy_exam_exec_proc.NR_SEQUENCIA%type;
    message_code_w          varchar(2);
    file_name_like_w        varchar(8);
    nm_usuario_w            varchar(255) := 'tasy_phy';
    cd_establishment_w      integer;
    process_classif_w       varchar(1);
    ie_cancel_w             varchar(1);
    current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint           varchar(10);
    current_setting('carestream_phys_japan_l10n_pck.patient_id_w')::varchar(10)            varchar(10);
    physician_code_w        varchar(10);
    order_number_w          varchar(14);
    order_seq_number_w      varchar(10);
    medical_dept_code_w     varchar(3);
    cd_material_classif_w   varchar(2);
    exam_exec_date_w        timestamp;
    update_date_w           timestamp;
    dt_update_w             timestamp;
    exam_clasification_w    varchar(2);
    exam_item_code_w        smallint;
    qt_proc_execution_w     smallint;
    update_by_w             varchar(10);
    loop_counter_w          smallint;
    procedure_code_w        varchar(8);
    qt_dosage_w             integer;
    medicine_count_w        smallint;
    equipment_count_w       smallint;	
    addition_info_count_w   smallint;
    time_info_count_w       smallint;	
    procedure_count_pos_w   integer;
    medicine_code_w         varchar(8);
    used_medicine_amt_w     varchar(15);
    medicine_std_code_w     varchar(2);
    equipment_code_w        varchar(8);
    qt_equipments_w         varchar(15);
    equipment_std_code_w    varchar(2);
    addition_code_w         varchar(8);
    addition_amt_w          varchar(5);
    additional_proc_flag_w  varchar(1);
    execution_time_w        smallint;
    dt_start_w              timestamp;
    dt_stop_w               timestamp;
    ie_status_report_w      smallint;
    ie_status_execucao_w    smallint;
    ie_retrogrado_w cpoe_procedimento.ie_retrogrado%type;
    ie_transmit_special_order_w varchar(1);
    message_char_w             varchar(32000);


BEGIN
        PERFORM set_config('carestream_phys_japan_l10n_pck.ds_local_w', null, false);
        PERFORM set_config('carestream_phys_japan_l10n_pck.interface_event_w', 937, false);
        PERFORM set_config('carestream_phys_japan_l10n_pck.nm_interface_w', 'Japan Carestream - PHY', false);
        PERFORM set_config('carestream_phys_japan_l10n_pck.ds_message_w', 'CareStream Physiology - Patient Exam Execution Information', false);
        PERFORM set_config('carestream_phys_japan_l10n_pck.initial_position_w', 1, false);
        PERFORM set_config('carestream_phys_japan_l10n_pck.message_type_w', '2F', false);
        nm_usuario_w := 'tasy_phy';
        PERFORM set_config('carestream_phys_japan_l10n_pck.log_sequence_number_w', 0, false);
        phy_exam_exec_seq :=0;
        phy_exam_proc_seq :=0;

        select carestream_japan_l10n_pck.get_directory_event_code(current_setting('carestream_phys_japan_l10n_pck.message_type_w')::varchar(2), 'CARE_PHY_COST')
        into STRICT   current_setting('carestream_phys_japan_l10n_pck.cd_integartion_event_w')::philips_json
;


        file_name_like_w := 'H'||current_setting('carestream_phys_japan_l10n_pck.physiology_dept_code_w')::varchar(2)||current_setting('carestream_phys_japan_l10n_pck.his_system_code')::varchar(2)||current_setting('carestream_phys_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['control_code'].value_of();

        select carestream_japan_l10n_pck.get_log_file_name(current_setting('carestream_phys_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['control_code'].value_of(),
                    current_setting('carestream_phys_japan_l10n_pck.his_system_code')::varchar(2), current_setting('carestream_phys_japan_l10n_pck.physiology_dept_code_w')::varchar(2), 'R')
        into STRICT    current_setting('carestream_phys_japan_l10n_pck.log_file_name_w')::varchar(100)
;

        begin
        current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767) := carestream_japan_l10n_pck.read_file(file_name_p, file_name_like_w, current_setting('carestream_phys_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['cd_event_data'].value_of(), current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767));
        select utl_i18n.raw_to_char(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767))
        into STRICT message_char_w
;

        PERFORM set_config('carestream_phys_japan_l10n_pck.message_type_w', utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 0), 2), 'JA16SJIS'), false); -- 1 MESSAGE_TYPE
        process_classif_w := utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 28), 1), 'JA16SJIS'); -- 29 PROCESSING_CLASSIFICATION
        if ( current_setting('carestream_phys_japan_l10n_pck.message_type_w')::varchar(2) <> '2F') then
            return;
        end if;

        exam_exec_date_w := to_date(trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 1), 14), 'JA16SJIS')),'YYYYMMDDHH24MISS'); -- 30 PROCESSING_DATE_TIME
        PERFORM set_config('carestream_phys_japan_l10n_pck.patient_mrn_w', (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 14), 10), 'JA16SJIS')))::numeric , false);                    -- 44 PATIENT_ID     
        update_date_w := to_date(trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 10), 14), 'JA16SJIS')), 'YYYYMMDDHH24MISS');  --54 REGISTRATION_DATE
        order_number_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 29), 14), 'JA16SJIS')))::numeric;                   -- 83 NR_PRESCRICAO
        order_seq_number_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 14), 10), 'JA16SJIS')))::numeric;               --97 NR_SEQUENCIA_ORDER
        medical_dept_code_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 26), 3), 'JA16SJIS'));                    --123 MEDICAL_DEPARTMENT_CODE         
        physician_code_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 46), 10), 'JA16SJIS')))::numeric;                 -- 169 PHYSICIAN_ID
        dt_start_w := to_date(trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 50), 8), 'JA16SJIS')), 'YYYYMMDD');              --219 START_DATE         
        dt_stop_w := to_date(trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 8), 8), 'JA16SJIS')), 'YYYYMMDD');                --227 STOP_DATE
        exam_clasification_w := utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 17), 2), 'JA16SJIS');                         --244 EXAM_CLASIFICATION
        exam_item_code_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 2), 4), 'JA16SJIS')))::numeric;                   -- 246 EXAM_ITEM_CODE
        qt_proc_execution_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 4), 2), 'JA16SJIS')))::numeric;                -- 250 PROCEDURE_EXECUTION_COUNT         
        update_by_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 2), 10), 'JA16SJIS'));                            --252 RECEPTION_CODE_LAST_UPDATE
        PERFORM set_config('carestream_phys_japan_l10n_pck.initial_position_w', current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer + 10, false);

        select 	'carestream_phy' ,
                nextval('phy_exam_exec_info_seq'),
                CASE WHEN process_classif_w ='1' THEN  '0' WHEN process_classif_w ='3' THEN  '1' END ,
                CASE WHEN process_classif_w ='1' THEN  '8' WHEN process_classif_w ='3' THEN  '9' END ,
                obter_paciente_prontuario(current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint, 'C')
        into STRICT 	nm_usuario_w ,
                phy_exam_exec_seq,
                ie_cancel_w,
                ie_status_report_w,
                current_setting('carestream_phys_japan_l10n_pck.patient_id_w')::varchar(10)
;

        insert into phy_exam_exec_info(
            nr_sequencia,
            cd_doctor_id,
            cd_exam_item,
            cd_exam_type,
            cd_exec_user_id,
            cd_med_department,
            cd_patient_id,
            cd_update_user_id,
            dt_atualizacao,
            dt_atualizacao_nrec,
            dt_exam_exec,
            dt_update,
            ie_cancel,
            nm_usuario,
            nm_usuario_nrec,
            nr_prescricao,
            nr_seq_order )
        values (
            phy_exam_exec_seq,
            physician_code_w,
            exam_item_code_w,
            exam_clasification_w,
            physician_code_w,
            medical_dept_code_w,
            current_setting('carestream_phys_japan_l10n_pck.patient_id_w')::varchar(10),
            update_by_w,
            clock_timestamp(),
            clock_timestamp(),
            exam_exec_date_w,
            coalesce(update_date_w, exam_exec_date_w),
            ie_cancel_w,
            nm_usuario_w,
            nm_usuario_w,
            order_number_w,
            order_seq_number_w);

        select COALESCE(
            (SELECT max(ds_login) FROM CREDENCIAIS_INTEGRACAO where IE_SISTEMA = 'CSTREAM') ,
            (select max(nm_usuario) from prescr_procedimento where nr_prescricao = order_number_w ),
            'carestream_ris') into STRICT current_setting('carestream_phys_japan_l10n_pck.nm_interface_name_w')::varchar(255)
;

        CALL wheb_usuario_pck.set_nm_usuario(current_setting('carestream_phys_japan_l10n_pck.nm_interface_name_w')::varchar(255));

        if (qt_proc_execution_w > 0) then

            for  i  in 1..qt_proc_execution_w loop
            begin
                procedure_code_w :=	trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 0), 8), 'JA16SJIS'));            -- 262 PROEDURE_CODE
                qt_dosage_w :=	(trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 8), 5), 'JA16SJIS')))::numeric;           -- 270 DOSAGE
                medicine_count_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 5), 2), 'JA16SJIS')))::numeric;       -- 275 MEDICINE_COUNT
                equipment_count_w :=	(trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 2), 2), 'JA16SJIS')))::numeric;   -- 277 EQUIPMENT_COUNT
                addition_info_count_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 2), 2), 'JA16SJIS')))::numeric; -- 279 ADDITION_INFO_COUNT
                time_info_count_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 2), 2), 'JA16SJIS')))::numeric; -- 281 TIME_INFO_COUNT
                PERFORM set_config('carestream_phys_japan_l10n_pck.initial_position_w', current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer + 2, false);

                select 	nextval('phy_exam_exec_proc_seq')
                into STRICT 	phy_exam_proc_seq 
;

                insert into phy_exam_exec_proc(
                    nr_sequencia,
                    cd_procedure,
                    cd_update_user_id,
                    dt_atualizacao,
                    dt_atualizacao_nrec,
                    dt_update,
                    nm_usuario,
                    nm_usuario_nrec,
                    nr_seq_phy_exam_exec_info,
                    vl_amount_exec)
                values (
                    phy_exam_proc_seq,
                    procedure_code_w,
                    update_by_w,
                    clock_timestamp(),
                    clock_timestamp(),
                    coalesce(update_date_w, exam_exec_date_w),
                    nm_usuario_w,
                    nm_usuario_w,
                    phy_exam_exec_seq,
                    qt_dosage_w);

                if ( medicine_count_w > 0 ) then

                    for  j in 1..medicine_count_w loop
                    begin

                        cd_material_classif_w := '0';
                        medicine_code_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 0), 8), 'JA16SJIS'));     -- MEDICINE_CODE
                        used_medicine_amt_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 8), 8), 'JA16SJIS')); -- USED_MEDICINE_AMOUNT
                        medicine_std_code_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 8), 2), 'JA16SJIS')); -- MEDICINE_STANDARD_CODE
                        used_medicine_amt_w := used_medicine_amt_w * 1000;
                        PERFORM set_config('carestream_phys_japan_l10n_pck.initial_position_w', current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer + 2, false);

                        insert into phy_exam_exec_mat(
                            nr_sequencia,
                            cd_material_classif,
                            cd_material_unit,
                            cd_material_used,
                            cd_update_user_id,
                            dt_atualizacao,
                            dt_atualizacao_nrec,
                            dt_update,
                            nm_usuario,
                            nm_usuario_nrec,
                            nr_seq_phy_exam_exec_proc,
                            vl_amount_used)
                        values (
                            nextval('phy_exam_exec_mat_seq'),
                            cd_material_classif_w,
                            medicine_std_code_w,
                            medicine_code_w,
                            update_by_w,
                            clock_timestamp(),
                            clock_timestamp(),
                             coalesce(update_date_w, exam_exec_date_w),
                            nm_usuario_w,
                            nm_usuario_w,
                            phy_exam_proc_seq,
                            used_medicine_amt_w	 );

                    end;
                    end loop;
                end if;

                if ( equipment_count_w > 0 ) then
                    for  j in 1..equipment_count_w loop
                    begin
                        cd_material_classif_w := '1';
                        equipment_code_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 0), 8), 'JA16SJIS'));        -- EQUIPMENT_CODE
                        qt_equipments_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 8), 8), 'JA16SJIS'));         -- QUANTITY_OF_EQUIPMENTS
                        equipment_std_code_w:= (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 8), 2), 'JA16SJIS')))::numeric;-- EQUIPMENT_STANDARD_CODE
                        qt_equipments_w := qt_equipments_w * 1000;
                        PERFORM set_config('carestream_phys_japan_l10n_pck.initial_position_w', current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer + 2, false);

                        insert into phy_exam_exec_mat(
                            nr_sequencia,
                            cd_material_classif,
                            cd_material_unit,
                            cd_material_used,
                            cd_update_user_id,
                            dt_atualizacao,
                            dt_atualizacao_nrec,
                            dt_update,
                            nm_usuario,
                            nm_usuario_nrec,
                            nr_seq_phy_exam_exec_proc,
                            vl_amount_used )
                        values (
                            nextval('phy_exam_exec_mat_seq'),
                            cd_material_classif_w,
                            equipment_std_code_w,
                            equipment_code_w,
                            update_by_w,
                            clock_timestamp(),
                            clock_timestamp(),
                             coalesce(update_date_w, exam_exec_date_w),
                            nm_usuario_w,
                            nm_usuario_w,
                            phy_exam_proc_seq,
                            qt_equipments_w	 );
                    end;
                    end loop;
                end if;


                if ( addition_info_count_w > 0 ) then
                    for  j in 1..addition_info_count_w loop
                    begin
                        cd_material_classif_w := '2';
                        addition_code_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 0), 8), 'JA16SJIS'));         -- ADDITION_CODE
                        addition_amt_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 8), 5), 'JA16SJIS'));          -- ADDITION_AMOUNT
                        additional_proc_flag_w := trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 5), 1), 'JA16SJIS'));  -- ADDITIONAL_PROCEDURE_FLAG
                        PERFORM set_config('carestream_phys_japan_l10n_pck.initial_position_w', current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer + 1, false);

                        insert into phy_exam_exec_mat(
                            nr_sequencia,
                            cd_material_classif,
                            cd_material_unit,
                            cd_material_used,
                            cd_update_user_id,
                            dt_atualizacao,
                            dt_atualizacao_nrec,
                            dt_update,
                            nm_usuario,
                            nm_usuario_nrec,
                            nr_seq_phy_exam_exec_proc,
                            vl_amount_used )
                        values (
                            nextval('phy_exam_exec_mat_seq'),
                            cd_material_classif_w,
                            additional_proc_flag_w,
                            addition_code_w,
                            update_by_w,
                            clock_timestamp(),
                            clock_timestamp(),
                             coalesce(update_date_w, exam_exec_date_w),
                            nm_usuario_w,
                            nm_usuario_w,
                            phy_exam_proc_seq,
                            addition_amt_w );
                    end;
                    end loop;	
                end if;


                if ( time_info_count_w > 0 ) then
                    for  j in 1..time_info_count_w loop
                    begin
                        cd_material_classif_w := '3';
                        execution_time_w := (trim(both utl_i18n.raw_to_char(utl_raw.substr(current_setting('carestream_phys_japan_l10n_pck.ds_local_w')::varchar(32767), carestream_phys_japan_l10n_pck.update_initial_position(current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer, 0), 4), 'JA16SJIS')))::numeric; --Time_of_execution in minutes
                        PERFORM set_config('carestream_phys_japan_l10n_pck.initial_position_w', current_setting('carestream_phys_japan_l10n_pck.initial_position_w')::integer + 4, false);

                         insert into phy_exam_exec_mat(
                            nr_sequencia,
                            cd_material_classif,
                            cd_material_unit,
                            cd_material_used,
                            cd_update_user_id,
                            dt_atualizacao,
                            dt_atualizacao_nrec,
                            dt_update,
                            nm_usuario,
                            nm_usuario_nrec,
                            nr_seq_phy_exam_exec_proc,
                            vl_amount_used)
                        values (
                            nextval('phy_exam_exec_mat_seq'),
                            cd_material_classif_w,
                            null,
                            null,
                            update_by_w,
                            clock_timestamp(),
                            clock_timestamp(),
                            coalesce(update_date_w, exam_exec_date_w),
                            nm_usuario_w,
                            nm_usuario_w,
                            phy_exam_proc_seq,
                            execution_time_w		
                            );
                    end;
                    end loop;
                end if;

            end;
            end loop;
        end if;
        commit;
        select  coalesce(max(a.cd_estabelecimento),obter_estabelecimento_ativo)
        into STRICT    cd_establishment_w
        from    prescr_medica b,
                atendimento_paciente a
        where   a.nr_atendimento = b.nr_atendimento
        and     b.nr_prescricao = order_number_w;

        select ie_status_execucao
            into STRICT   ie_status_execucao_w
            from prescr_procedimento
            where   nr_prescricao        	=  order_number_w
            and     nr_sequencia         	=  order_seq_number_w;

        CALL carestream_japan_l10n_pck.update_exam_execution_status(order_number_w, order_seq_number_w, ie_status_report_w, nm_usuario_w);

        if (ie_status_report_w = '9') then
            if (ie_status_execucao_w IN (13,14)) then
                CALL atualizar_status_prep_prescr(order_number_w , order_seq_number_w, 'D' , nm_usuario_w, cd_establishment_w, clock_timestamp(),nm_usuario_w);
            elsif (ie_status_execucao_w IN (11)) then
                CALL atualizar_status_prep_prescr(order_number_w , order_seq_number_w, 'SD' , nm_usuario_w, cd_establishment_w, clock_timestamp(),nm_usuario_w);
            elsif (ie_status_execucao_w IN (20)) then
                CALL desfazer_execucao_proc_ge(order_number_w, order_seq_number_w, 'I', 'N', cd_establishment_w , nm_usuario_w);
            end if;

        elsif (ie_status_report_w = '8') then
            CALL atualiza_status_proced_exec(order_seq_number_w, order_number_w, 0 ,nm_usuario_w);
        end if;

	select	coalesce(a.ie_retrogrado,'N')
        into STRICT    ie_retrogrado_w
        from	cpoe_procedimento a,
                prescr_procedimento b
        where	a.nr_sequencia = b.nr_seq_proc_cpoe
        and     b.nr_sequencia = order_seq_number_w
        and     nr_prescricao = order_number_w;

        select  is_special_order_rule('FI','A',cd_establishment_w)
        into STRICT ie_transmit_special_order_w 
;

        if (ie_retrogrado_w = 'N' or (ie_retrogrado_w = 'S' and ie_transmit_special_order_w = 'S')) then
            CALL execute_bifrost_integration(273,  '{"recordId" : "' || phy_exam_exec_seq || '"' || '}');
        end if;

        exception
                when others then
                    rollback;
                    PERFORM set_config('carestream_phys_japan_l10n_pck.log_sequence_number_w', 0, false);
                    PERFORM set_config('carestream_phys_japan_l10n_pck.nm_interface_w', 'Japan Carestream - PHY', false);
                    PERFORM set_config('carestream_phys_japan_l10n_pck.ds_message_w', 'CareStream Physiology - Patient Info Request', false);

                    CALL carestream_japan_l10n_pck.update_recieve_error_file(file_name_p, current_setting('carestream_phys_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_phys_japan_l10n_pck.message_type_w')::varchar(2));
                    PERFORM set_config('carestream_phys_japan_l10n_pck.ds_log_message_w', 'Error occured while reading the information for recieved patient exam execution information'
                                        || chr(10)
                                        || 'Integration name : japan_carestream_phy(Patient Exam Execution Info)'
                                        || chr(10)
                                        || 'Message Type:'
                                        || current_setting('carestream_phys_japan_l10n_pck.message_type_w')::varchar(2)
                                        || chr(10)
                                        || 'Time of faliure : '
                                        || clock_timestamp() || chr(10)
                                        || 'Patient MRN:'
                                        || current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint || chr(10)
                                        ||' -ERROR- '
                                        || SQLERRM, false);

                    record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), current_setting('carestream_phys_japan_l10n_pck.nm_interface_w')::varchar(255), current_setting('carestream_phys_japan_l10n_pck.ds_message_w')::varchar(255),
                                                'F', 'R', null, current_setting('carestream_phys_japan_l10n_pck.ds_log_message_w')::varchar(32767), message_char_w,
                                                current_setting('carestream_phys_japan_l10n_pck.ds_log_message_w')::varchar(32767), file_name_p, current_setting('carestream_phys_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint, null);

                    CALL carestream_japan_l10n_pck.save_log(current_setting('carestream_phys_japan_l10n_pck.cd_integartion_event_w')::philips_json.get['cd_event_log'].value_of(), current_setting('carestream_phys_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_phys_japan_l10n_pck.ds_log_message_w')::varchar(32767));
                    return;
                end;

            -- if file succcessfully read and info saved in tasy,calling function to move the file to repective ok folder from data and index folder
            CALL carestream_japan_l10n_pck.update_recieve_ok_file(file_name_p, current_setting('carestream_phys_japan_l10n_pck.log_file_name_w')::varchar(100), current_setting('carestream_phys_japan_l10n_pck.message_type_w')::varchar(2));

             PERFORM set_config('carestream_phys_japan_l10n_pck.ds_log_message_w', 'Successfully processed the integration message for Patient Exam Execution information and file moved to respective OK Folder'
                                    || chr(10)
                                    || 'Integration name : japan_carestream_phy(Patient Exam Execution Info)'
                                    || chr(10)
                                    || 'Message Type:'
                                    || current_setting('carestream_phys_japan_l10n_pck.message_type_w')::varchar(2)
                                    || chr(10)
                                    || 'Time of processed : '
                                    || clock_timestamp() || chr(10)
                                    || 'Patient MRN:'
                                    || current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint, false);


            record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), current_setting('carestream_phys_japan_l10n_pck.nm_interface_w')::varchar(255), current_setting('carestream_phys_japan_l10n_pck.ds_message_w')::varchar(255),
                                            'S', 'R', null, current_setting('carestream_phys_japan_l10n_pck.ds_log_message_w')::varchar(32767), message_char_w,
                                            null, file_name_p, current_setting('carestream_phys_japan_l10n_pck.log_sequence_number_w')::integration_message_log.nr_seq_int_call_log%type, current_setting('carestream_phys_japan_l10n_pck.patient_mrn_w')::bigint, null);



    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carestream_phys_japan_l10n_pck.patient_exam_execution_info (file_name_p text) FROM PUBLIC;
