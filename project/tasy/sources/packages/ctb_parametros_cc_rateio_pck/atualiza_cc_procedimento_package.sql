-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Atualiza o centro de custo conforme regra de conta contabil rateio
CREATE OR REPLACE PROCEDURE ctb_parametros_cc_rateio_pck.atualiza_cc_procedimento ( nr_atendimento_p conta_paciente.nr_atendimento%type, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w	centro_custo.cd_centro_custo%type;
cd_setor_atendimento_w	atend_paciente_unidade.cd_setor_atendimento%type;


BEGIN

begin

--Busca o centro de custo do ultimo setor de atendimento do atendimento em questao
select	a.cd_centro_custo
into STRICT	cd_centro_custo_w
from	setor_atendimento a
where	cd_setor_atendimento = obter_ultimo_setor_atendimento(nr_atendimento_p);

exception
when others then
	cd_centro_custo_w:= null;
end;

if (coalesce(cd_centro_custo_w, 0) <> 0) then
	begin
	
	--Realiza a atualizacao dos centro de custo do rateio do procedimento se a origem for U ultimo setor de atendimento
	update	proc_paciente_rateio_cc a
	set	cd_centro_custo = cd_centro_custo_w,
		nm_usuario	= nm_usuario_p
	where	nr_seq_proc_pac in (	SELECT	b.nr_sequencia
					from	procedimento_paciente b
					where	b.nr_atendimento = nr_atendimento_p)
	and 	exists (	select	1
				from	parametros_cc_rateio c
				where	c.nr_sequencia = a.nr_seq_par_cc_rateio
				and 	c.ie_origem_centro_custo = 'U');
	
	end;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_parametros_cc_rateio_pck.atualiza_cc_procedimento ( nr_atendimento_p conta_paciente.nr_atendimento%type, nm_usuario_p text) FROM PUBLIC;
