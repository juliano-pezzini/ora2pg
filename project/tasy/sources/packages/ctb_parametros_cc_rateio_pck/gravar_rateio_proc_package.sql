-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_parametros_cc_rateio_pck.gravar_rateio_proc ( nr_seq_proc_paciente_p procedimento_paciente.nr_sequencia%type, cd_sequencia_parametro_p parametros_conta_contabil.cd_sequencia_parametro%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


vl_procedimento_w	procedimento_paciente.vl_procedimento%type:= 0;
ds_valor_w		varchar(4000);


BEGIN
--Limpa a tabela de rateio para nos insercao
delete from proc_paciente_rateio_cc where nr_seq_proc_pac = nr_seq_proc_paciente_p;

begin

--Busca o valor do procedimento para envio a function retorna_ctb_param_cc_rateio realizar o devido rateio
select	a.vl_procedimento
into STRICT	vl_procedimento_w
from	procedimento_paciente a
where	a.nr_sequencia	= nr_seq_proc_paciente_p;

exception
when others then
	vl_procedimento_w:= null;
end;

if (coalesce(vl_procedimento_w,0) > 0) then
	begin
	
	--Insert para gerar os registros filhos do procedimento do paciente com seus devidos rateios
	insert into proc_paciente_rateio_cc(	nr_sequencia,
							cd_conta_contabil,
							cd_centro_custo,
							vl_rateio,
							nr_seq_par_cc_rateio,
							nr_seq_proc_pac,
							dt_atualizacao,
							dt_atualizacao_nrec,
							nm_usuario,
							nm_usuario_nrec
							)
	SELECT	nextval('proc_paciente_rateio_cc_seq'),
		cd_conta_receita,
		cd_centro_custo,
		vl_valor_rateio,
		nr_seq_par_cc_rateio,
		nr_seq_proc_paciente_p,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p
	from	table(ctb_parametros_cc_rateio_pck.retorna_ctb_param_cc_rateio(cd_sequencia_parametro_p, vl_procedimento_w));
	
	end;
end if;

--Rotinas da conta paciente podem ser chamadas em trigger 
--commit;
/*Libera memoria*/

dbms_session.free_unused_user_memory;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_parametros_cc_rateio_pck.gravar_rateio_proc ( nr_seq_proc_paciente_p procedimento_paciente.nr_sequencia%type, cd_sequencia_parametro_p parametros_conta_contabil.cd_sequencia_parametro%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
