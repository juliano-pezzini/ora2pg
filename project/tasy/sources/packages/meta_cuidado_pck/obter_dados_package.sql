-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION meta_cuidado_pck.obter_dados ( nr_atendimento_p bigint, ie_html_p text default 'S', ie_tipo_meta text default 'A', ie_ignorar_mensuracao_p text default 'N') RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE


t_objeto_row_w			t_objeto_row;
ds_inconsistencia_w		varchar(4000);
lista_w					dbms_sql.varchar2_table;
ds_linha_w				varchar(255);
ds_valores_w			varchar(255);
qt_reg_w				bigint := 0;
ds_espaco_w				varchar(255) := chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;';

C01 CURSOR FOR
	 SELECT  a.nr_seq_meta nr_seq_meta,
			 max(coalesce(a.nm_meta,c.ds_meta)) ds_meta,  
			 max(a.nr_sequencia) nr_sequencia,  
			 max(a.ie_status) ie_status,  
			 max(a.dt_inicio) dt_inicio,
			 max(c.nr_sequencia) nr_seq_meta_tof,
			 max(a.nm_meta) nm_meta,
			 max(a.dt_final_prevista) dt_final_prevista
	from  	 tof_meta_atend a,  
			 tof_meta_atend_hor b,  
			 tof_meta c  
	where      a.nr_seq_meta = c.nr_sequencia  	
	and      Obter_se_meta_liberada(a.nr_atendimento,a.nr_seq_meta) =  'S' 	
	and      c.ie_tipo_meta = 'D'  
	and	     a.nr_atendimento = nr_atendimento_p
	and      (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and      coalesce(a.dt_inativacao::text, '') = ''
	and      coalesce(a.dt_finalizacao::text, '') = ''
	and (ie_ignorar_mensuracao_p = 'S'
	or exists (SELECT 1 from tof_meta_atend_hor b
		where a.nr_sequencia = b.nr_seq_meta_atend
		and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
		and coalesce(b.dt_inativacao::text, '') = ''))
	group by a.nr_seq_meta
	order by ds_meta;
		
c01_w c01%rowtype;


C02 CURSOR FOR
	 SELECT   a.nr_seq_meta nr_seq_meta,
	       max(coalesce(a.nm_meta,c.ds_meta)) ds_meta,  
	       max(a.nr_sequencia) nr_sequencia,
           max(a.nm_meta) nm_meta,
           max(a.dt_final_prevista) dt_final_prevista  ,
		   max(a.dt_inicio) dt_inicio
	from  	tof_meta_atend a,  
	       tof_meta_atend_hor b,  
	       tof_meta c  
	where      a.nr_seq_meta = c.nr_sequencia  	
	and      Obter_se_meta_liberada(a.nr_atendimento,a.nr_seq_meta) =  'S' 	
	and      c.ie_tipo_meta = 'U'  
	and	     a.nr_atendimento = nr_atendimento_p
	and      (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and      coalesce(a.dt_inativacao::text, '') = ''
	and      coalesce(a.dt_finalizacao::text, '') = ''
	and (ie_ignorar_mensuracao_p = 'S'
	or exists (SELECT 1 from tof_meta_atend_hor b
		where a.nr_sequencia = b.nr_seq_meta_atend
		and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
		and coalesce(b.dt_inativacao::text, '') = ''))
	group by a.nr_seq_meta
	order by ds_meta;

c02_w c02%rowtype;


BEGIN

if (ie_html_p = 'N') then
	ds_espaco_w := chr(32)||chr(32)||chr(32);
end if;

if (coalesce(ie_tipo_meta,'A') = 'A' or coalesce(ie_tipo_meta,'A') = 'D') then
	open C01;
	loop
	fetch C01 into	
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin	
		if (qt_reg_w	= 0) then
				if (ie_html_p = 'N') then
					t_objeto_row_w.ds_meta	:= obter_desc_expressao(297359);
				else
					t_objeto_row_w.ds_meta	:= '<b>'||obter_desc_expressao(297359)||'</b>';
				end if;
				t_objeto_row_w.ie_meta	:= 'D';
				t_objeto_row_w.ie_valor	:= 'T';
			
			RETURN NEXT t_objeto_row_w;
		end if;
		
		t_objeto_row_w.ds_meta	:= ds_espaco_w|| c01_w.ds_meta;
		t_objeto_row_w.ie_meta	:= 'D';
		t_objeto_row_w.ie_valor	:= 'D';
		t_objeto_row_w.dt_inicio	:= c01_w.dt_inicio;
		t_objeto_row_w.nr_seq_meta	:= c01_w.nr_seq_meta;
		t_objeto_row_w.nr_sequencia	:= c01_w.nr_sequencia;
		t_objeto_row_w.ie_status_geral := c01_w.ie_status;
		t_objeto_row_w.ie_status_hoje	:= meta_cuidado_pck.getstatusdia(nr_atendimento_p, c01_w.nr_seq_meta_tof,0);
		t_objeto_row_w.ie_status_1	:= meta_cuidado_pck.getstatusdia(nr_atendimento_p, c01_w.nr_seq_meta_tof,1);
		t_objeto_row_w.ie_status_2	:= meta_cuidado_pck.getstatusdia(nr_atendimento_p, c01_w.nr_seq_meta_tof,2);
		t_objeto_row_w.ie_status_3	:= meta_cuidado_pck.getstatusdia(nr_atendimento_p, c01_w.nr_seq_meta_tof,3);
		t_objeto_row_w.ie_status_4	:= meta_cuidado_pck.getstatusdia(nr_atendimento_p, c01_w.nr_seq_meta_tof,4);
		t_objeto_row_w.ie_status_5	:= meta_cuidado_pck.getstatusdia(nr_atendimento_p, c01_w.nr_seq_meta_tof,5);
		t_objeto_row_w.ie_status_6	:= meta_cuidado_pck.getstatusdia(nr_atendimento_p, c01_w.nr_seq_meta_tof,6);
		t_objeto_row_w.ie_status_7	:= meta_cuidado_pck.getstatusdia(nr_atendimento_p, c01_w.nr_seq_meta_tof,7);
		t_objeto_row_w.nm_meta := c01_w.nm_meta;
		t_objeto_row_w.dt_final_prevista := c01_w.dt_final_prevista;
		
		RETURN NEXT t_objeto_row_w;
		qt_reg_w	:= qt_reg_w+1;
		end;
	end loop;
	close C01;
end if;

qt_reg_w	:= 0;

if (coalesce(ie_tipo_meta,'A') = 'A' or coalesce(ie_tipo_meta,'A') = 'U') then
open C02;
loop
fetch C02 into	
	c02_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	if (qt_reg_w	= 0) then
		if (ie_html_p = 'N') then
			t_objeto_row_w.ds_meta	:= obter_desc_expressao(303885);
		else
			t_objeto_row_w.ds_meta	:= '<b>'||obter_desc_expressao(303885)||'</b>';
		end if;
		t_objeto_row_w.ie_meta	:= 'U';
		t_objeto_row_w.ie_valor	:= 'T';
		t_objeto_row_w.dt_inicio := null;
		t_objeto_row_w.ie_status_geral	:= null;
		t_objeto_row_w.ie_status_hoje	:= null;
		t_objeto_row_w.ie_status_1	:= null;
		t_objeto_row_w.ie_status_2	:= null;
		t_objeto_row_w.ie_status_3	:= null;
		t_objeto_row_w.ie_status_4	:= null;
		t_objeto_row_w.ie_status_5	:= null;
		t_objeto_row_w.ie_status_6	:= null;
		t_objeto_row_w.ie_status_7	:= null;
		t_objeto_row_w.nm_meta := null;
		RETURN NEXT t_objeto_row_w;
	end if;
	
	t_objeto_row_w.ds_meta	:= ds_espaco_w|| c02_w.ds_meta;
	t_objeto_row_w.ie_meta	:= 'U';
	t_objeto_row_w.ie_valor	:= 'D';
	t_objeto_row_w.ie_status_geral	:= meta_cuidado_pck.getstatussingle(c02_w.nr_sequencia);
	t_objeto_row_w.dt_inicio	:= c02_w.dt_inicio;
	t_objeto_row_w.nr_seq_meta	:= c02_w.nr_seq_meta;
	t_objeto_row_w.nr_sequencia	:= c02_w.nr_sequencia;
	t_objeto_row_w.ie_status_hoje	:= null;
	t_objeto_row_w.ie_status_1	:= null;
	t_objeto_row_w.ie_status_2	:= null;
	t_objeto_row_w.ie_status_3	:= null;
	t_objeto_row_w.ie_status_4	:= null;
	t_objeto_row_w.ie_status_5	:= null;
	t_objeto_row_w.ie_status_6	:= null;
	t_objeto_row_w.ie_status_7	:= null;
	t_objeto_row_w.nm_meta :=  null;
	
	RETURN NEXT t_objeto_row_w;
	qt_reg_w	:= qt_reg_w+1;
	end;
end loop;
close C02;
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION meta_cuidado_pck.obter_dados ( nr_atendimento_p bigint, ie_html_p text default 'S', ie_tipo_meta text default 'A', ie_ignorar_mensuracao_p text default 'N') FROM PUBLIC;
