-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--enviar intercâmbio pelo portal
CREATE OR REPLACE PROCEDURE ptu_envio_scs_ws_pck.ptu_envio_intercambio_portal ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_req_p pls_requisicao.nr_sequencia%type, ds_transacao_p text, ds_observacao_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_execucao_p INOUT ptu_cancelamento.nr_seq_execucao%type) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:   Gerar guia de intercâmbio no portal web
----------------------------------------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [ x ] Portal [  ] Relatórios [ ] Outros:
 ----------------------------------------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
*/cd_usuario_plano_w		varchar(255);
cd_cooperativa_w		varchar(255) := '';
cd_operadora_usuario_w		varchar(10);
nr_seq_emissor_w		pls_parametros.nr_seq_emissor%type;
nr_seq_origem_w			ptu_resposta_auditoria.nr_seq_origem%type;



BEGIN

if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
	select	substr(pls_obter_dados_segurado(nr_seq_segurado,'CR'),1,255)
	into STRICT	cd_usuario_plano_w
	from	pls_guia_plano
	where	nr_sequencia = nr_seq_guia_p;
elsif (nr_seq_req_p IS NOT NULL AND nr_seq_req_p::text <> '') then
	CALL pls_finalizar_requisicao_web(nr_seq_req_p, nm_usuario_p);

	select	substr(pls_obter_dados_segurado(nr_seq_segurado,'CR'),1,255)
	into STRICT	cd_usuario_plano_w
	from	pls_requisicao
	where	nr_sequencia = nr_seq_req_p;
end if;

if (cd_usuario_plano_w IS NOT NULL AND cd_usuario_plano_w::text <> '') then

	select	max(nr_seq_emissor)
	into STRICT	nr_seq_emissor_w
	from	pls_parametros
	where	cd_estabelecimento	= cd_estabelecimento_p;

	select	pls_obter_campos_carteira(cd_usuario_plano_w,nr_seq_emissor_w,'CM')
	into STRICT	cd_cooperativa_w
	;

	cd_operadora_usuario_w := coalesce(pls_obter_unimed_estab(cd_estabelecimento_p), '0');

	if ((cd_operadora_usuario_w)::numeric  <> (cd_cooperativa_w)::numeric ) then
		/*  Pedido audotiração 00600
		     Cancelamento 00311
		      Pedido de Complemento de Autorização  00605
		*/
		if (ds_transacao_p = '00600' ) then
			nr_seq_execucao_p := ptu_envio_scs_ws_pck.ptu_envio_ped_autorizacao_web(nr_seq_req_p, nr_seq_guia_p, cd_estabelecimento_p, nm_usuario_p, nr_seq_execucao_p);
		elsif (ds_transacao_p = '00311' ) then
			nr_seq_execucao_p := ptu_envio_scs_ws_pck.ptu_envio_cancelamento_web(nr_seq_guia_p, nr_seq_req_p, ds_observacao_p, '050', nm_usuario_p, nr_seq_execucao_p);
		elsif (ds_transacao_p = '00605' ) then
			nr_seq_execucao_p := ptu_envio_scs_ws_pck.ptu_envio_ped_compl_aut_web(nr_seq_guia_p, nr_seq_req_p, cd_estabelecimento_p, nm_usuario_p, nr_seq_execucao_p);
		end if;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_envio_scs_ws_pck.ptu_envio_intercambio_portal ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_req_p pls_requisicao.nr_sequencia%type, ds_transacao_p text, ds_observacao_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_execucao_p INOUT ptu_cancelamento.nr_seq_execucao%type) FROM PUBLIC;
