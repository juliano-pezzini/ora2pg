-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE configura_psa_tws_pack.configure_psa_tws_clear ( u_nm_client client.nm_client%type, u_nm_application application.nm_application%type ) AS $body$
DECLARE

  /* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  finality: clean all data related to tws structure inside philips security application
  -------------------------------------------------------------------------------------------------------------------
  locais de chamada direta:
  [  ]  objetos do dicionário [ ] tasy (delphi/java) [  ] portal [  ]  relatórios [x] outros: psa
   ------------------------------------------------------------------------------------------------------------------
  caution:
  ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
BEGIN
	delete from subject_datasource_role
	where	id_datasource_role in (	SELECT	a.id_datasource_role
					from    subject_datasource_role a
					inner 	join datasource_role b on b.id = a.id_datasource_role
					inner 	join role c on c.id = b.id_role
					inner 	join application d on d.id = c.id_application
					where	d.nm_application = u_nm_application );

	delete from datasource_role_permission
	where	id_datasource_role in (	SELECT 	distinct a.id_datasource_role
					from	datasource_role_permission a
					inner 	join datasource_role b on b.id = a.id_datasource_role
					inner 	join role c on c.id = b.id_role
					inner 	join application d on d.id = c.id_application
					where 	d.nm_application = u_nm_application);

	delete from permission
	where id_application in (SELECT a.id_application
				from	permission a
				inner 	join application b on b.id = a.id_application
				where	b.nm_application = u_nm_application);

	delete from datasource_role
	where	id in (	SELECT	a.id
			from	datasource_role a
			inner 	join role b on b.id = a.id_role
			inner 	join application c on c.id = b.id_application
			where	c.nm_application = u_nm_application);

	delete 	from role
	where	id in (	SELECT	a.id
			from	role a
			inner 	join application b on b.id = a.id_application
			where	b.nm_application = u_nm_application);

	delete 	from application_subject
	where	id_application in (	SELECT 	a.id_application
					from 	application_subject a
					inner 	join application b on b.id = a.id_application
					where	b.nm_application = u_nm_application);


	delete from datasource_client
	where	id_client in (	SELECT 	a.id_client
				from 	datasource_client a
				inner 	join client b on b.id = a.id_client
				where	b.nm_client = u_nm_client);

	delete from subject_datasource
	where	id in (	SELECT	a.id
			from	subject_datasource a
			inner 	join datasource b on b.id = a.id_datasource
			inner 	join application c on c.id = b.id_application
			where	c.nm_application = u_nm_application);

	delete 	from token
	where	id in (	SELECT	a.id
		from	token a
		inner 	join datasource b on b.id = a.id_datasource
		inner 	join client c on c.id = a.id_client
		inner 	join application d on d.id = b.id_application
		where 	d.nm_application = u_nm_application
		and	c.nm_client = u_nm_client);

	delete from datasource
	where id in (	SELECT	a.id
			from	datasource a
			inner 	join application b on b.id = a.id_application
			where	b.nm_application = u_nm_application);

	delete 	from client
	where	nm_client = u_nm_client;

	delete 	from application
	where	nm_application = u_nm_application;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE configura_psa_tws_pack.configure_psa_tws_clear ( u_nm_client client.nm_client%type, u_nm_application application.nm_application%type ) FROM PUBLIC;
