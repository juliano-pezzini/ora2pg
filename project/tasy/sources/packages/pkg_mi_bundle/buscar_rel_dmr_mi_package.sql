-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pkg_mi_bundle.buscar_rel_dmr_mi ( dtInicio timestamp, dtFim timestamp, setor SETOR_ATENDIMENTO.CD_SETOR_ATENDIMENTO%TYPE, estabelecimento ESTABELECIMENTO.CD_ESTABELECIMENTO%TYPE ) RETURNS SETOF DMR_MI_TABLE_TYPE AS $body$
DECLARE


  C_MI_BUNDLE CURSOR FOR
    SELECT DISTINCT obter_leito_atual_pac(ap.nr_atendimento) bed,
              PKG_VAP_REPORT.GET_PATIENT_NAME(ap.nr_atendimento)
              ||' PID: '||
              ap.nr_atendimento
              ||' Acct.#: '||
              ap.cd_pessoa_fisica patient,
              ap.dt_entrada hosp_admit,
              obter_data_entrada_setor(ap.nr_atendimento)  as unit_admit,
              CASE WHEN dd.cd_doenca='R102' THEN  'Y' WHEN dd.cd_doenca='Z00' THEN  'Y' WHEN dd.cd_doenca='1' THEN  'Y' WHEN dd.cd_doenca='J45' THEN  'Y' WHEN dd.cd_doenca='A22.7' THEN  'Y' END   mi_stemi,
              CASE WHEN lv.nr_atendimento='Y' THEN  'N' END  LVfxn,
              ldl.qt_resultado LDL,
              CASE WHEN m.cd_classe_material=46 THEN  'Y'  ELSE NULL END  CT_BB,
              CASE WHEN m.cd_classe_material=209 THEN  'Y'  ELSE NULL END  CT_ACEI,
              CASE WHEN m.cd_classe_material=57 THEN  'Y'  ELSE NULL END  CT_ARB,
              coles.mat as CT_CHOLESTEROL,
              coags.mat as CT_ANTICOAGULANT,
              plat.mat as CT_ANTIPLATELETS
        FROM atendimento_paciente ap
       INNER JOIN atend_paciente_unidade apu
          ON apu.nr_atendimento = ap.nr_atendimento
       INNER JOIN setor_atendimento sa
          ON apu.cd_setor_atendimento = sa.cd_setor_atendimento
         AND sa.ie_situacao = 'A'
       INNER JOIN estabelecimento e
          ON ap.cd_estabelecimento = e.cd_estabelecimento
         AND e.ie_situacao = 'A'
       INNER JOIN diagnostico_doenca dd
          ON ap.nr_atendimento = dd.nr_atendimento
         AND dd.ie_classificacao_doenca = 'P'
         AND dd.ie_tipo_diagnostico = 2
         AND dd.cd_doenca IN ('R102', 'Z00', '1', 'J45', 'A22.7', 'J13', 'I10', 'A90', 'R51', 'H674', 'R10', 'J11')
        LEFT JOIN(
                   SELECT b.nr_atendimento,
                          b.cd_pessoa_fisica,
                          qt_feg
                     FROM atend_monit_hemod a
                    INNER JOIN atendimento_paciente b
                       ON a.nr_atendimento = b.nr_atendimento
           ) lv
          ON ap.nr_atendimento = lv.nr_atendimento
         AND ap.cd_pessoa_fisica = lv.cd_pessoa_fisica
        LEFT JOIN(
                   SELECT elr.nr_atendimento,
                          elr.cd_pessoa_fisica,
                          b.qt_resultado
                     FROM exame_laboratorio a
                    INNER JOIN exame_lab_result_item b
                       ON a.nr_seq_exame = b.nr_seq_exame
                    INNER JOIN exame_lab_resultado elr
                       ON b.nr_seq_resultado = elr.nr_seq_resultado
                    WHERE a.ie_tipo_exame_rel = 4
           ) ldl
        ON ap.nr_atendimento = ldl.nr_atendimento
       AND ap.cd_pessoa_fisica = ldl.cd_pessoa_fisica
      LEFT JOIN(
                 SELECT pm.nr_seq_atendimento,
                        pm.cd_material,
                        m.cd_classe_material
                   FROM prescr_material pm
                  INNER JOIN material m
                     ON m.cd_material = pm.cd_material
                  WHERE m.cd_classe_material IN (
                         SELECT cm.cd_classe_material
                           FROM classe_material cm
                          WHERE cm.ie_classe_material_rel IN (6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21)
                      )

UNION ALL

                 SELECT c.nr_atendimento,
                        caa.cd_material,
                        m.cd_classe_material
                   FROM cirurgia_agente_anestesico caa
                  INNER JOIN cirurgia c
                     ON caa.nr_cirurgia = c.nr_cirurgia
                  INNER JOIN material m
                     ON m.cd_material = caa.cd_material
                  WHERE m.cd_classe_material IN (
                         SELECT cm.cd_classe_material
                           FROM classe_material cm
                          WHERE cm.ie_classe_material_rel IN (6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21)
                      )
         ) m
        ON m.nr_seq_atendimento = ap.nr_atendimento
      LEFT JOIN(
                 SELECT a.nr_atendimento,
                        TO_CHAR(rtrim(xmlagg(XMLELEMENT(name e, a.ds_reduzida, ',')).extract['//text()'].getclobval(), ',')) mat
                   FROM (
                         SELECT ap.nr_atendimento,
                                m.ds_reduzida
                           FROM atendimento_paciente ap
                           LEFT JOIN prescr_material pm
                             ON pm.nr_seq_atendimento = ap.nr_atendimento
                           LEFT JOIN cirurgia c
                             ON ap.nr_atendimento = c.nr_atendimento
                           LEFT JOIN cirurgia_agente_anestesico caa
                             ON caa.nr_cirurgia = c.nr_cirurgia
                          INNER JOIN material m
                             ON coalesce(pm.cd_material, caa.cd_material) = m.cd_material
                            AND m.cd_classe_material IN(
                                 SELECT cm.cd_classe_material
                                   FROM classe_material cm
                                  WHERE cm.ie_classe_material_rel IN (8, 10)
                                )
                          GROUP BY ap.nr_atendimento, m.ds_reduzida
                      ) a
                  GROUP BY a.nr_atendimento
          ) coles
         ON coles.nr_atendimento = ap.nr_atendimento
      LEFT JOIN(
                 SELECT a.nr_atendimento,
                        TO_CHAR(rtrim(xmlagg(XMLELEMENT(name e, a.ds_reduzida, ',')).extract['//text()'].getclobval(), ',')) mat
                   FROM (
                         SELECT ap.nr_atendimento,
                                m.ds_reduzida
                           FROM atendimento_paciente ap
                           LEFT JOIN prescr_material pm
                             ON pm.nr_seq_atendimento = ap.nr_atendimento
                           LEFT JOIN cirurgia c
                             ON ap.nr_atendimento = c.nr_atendimento
                           LEFT JOIN cirurgia_agente_anestesico caa
                             ON caa.nr_cirurgia = c.nr_cirurgia
                          INNER JOIN material m
                             ON coalesce(pm.cd_material, caa.cd_material) = m.cd_material
                            AND m.cd_classe_material IN(
                                 SELECT cm.cd_classe_material
                                   FROM classe_material cm
                                  WHERE cm.ie_classe_material_rel = 22
                                )
                          GROUP BY ap.nr_atendimento, m.ds_reduzida
                      ) a
                  GROUP BY a.nr_atendimento
         ) coags
        ON coags.nr_atendimento = ap.nr_atendimento
      LEFT JOIN(
                 SELECT a.nr_atendimento,
                        TO_CHAR(rtrim(xmlagg(XMLELEMENT(name e, a.ds_reduzida, ',')).extract['//text()'].getclobval(), ',')) mat
                   FROM (
                         SELECT ap.nr_atendimento,
                                m.ds_reduzida
                           FROM atendimento_paciente ap
                           LEFT JOIN prescr_material pm
                             ON pm.nr_seq_atendimento = ap.nr_atendimento
                           LEFT JOIN cirurgia c
                             ON ap.nr_atendimento = c.nr_atendimento
                           LEFT JOIN cirurgia_agente_anestesico caa
                             ON caa.nr_cirurgia = c.nr_cirurgia
                          INNER JOIN material m
                             ON coalesce(pm.cd_material, caa.cd_material) = m.cd_material
                            AND m.cd_classe_material IN(
                                 SELECT cm.cd_classe_material
                                   FROM classe_material cm
                                  WHERE cm.ie_classe_material_rel = 21
                                )
                          GROUP BY ap.nr_atendimento, m.ds_reduzida
                      ) a
                  GROUP BY a.nr_atendimento
         ) plat
        ON plat.nr_atendimento = ap.nr_atendimento
     WHERE ap.dt_entrada BETWEEN dtInicio AND dtFim
       AND ((setor != 0 AND sa.cd_setor_atendimento = setor) OR setor = 0)
       AND ((estabelecimento != 0 AND e.cd_estabelecimento = estabelecimento) OR estabelecimento = 0)
       AND coalesce(ap.dt_alta::text, '') = ''
       AND coalesce(ap.dt_saida_real::text, '') = ''
     ORDER BY BED;

TYPE T_MI_BUNDLE IS TABLE OF C_MI_BUNDLE%ROWTYPE;
R_MI_BUNDLE T_MI_BUNDLE;

BEGIN
  OPEN C_MI_BUNDLE;
  LOOP
    FETCH C_MI_BUNDLE BULK COLLECT INTO R_MI_BUNDLE LIMIT 1000;

      BEGIN
        FOR i IN R_MI_BUNDLE.FIRST..R_MI_BUNDLE.LAST LOOP
          RETURN NEXT R_MI_BUNDLE(i);
        END LOOP;
      EXCEPTION WHEN OTHERS THEN
        NULL;
      END;

    EXIT WHEN NOT FOUND; /* apply on C_MI_BUNDLE */

  END LOOP;
  CLOSE C_MI_BUNDLE;

  RETURN;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pkg_mi_bundle.buscar_rel_dmr_mi ( dtInicio timestamp, dtFim timestamp, setor SETOR_ATENDIMENTO.CD_SETOR_ATENDIMENTO%TYPE, estabelecimento ESTABELECIMENTO.CD_ESTABELECIMENTO%TYPE ) FROM PUBLIC;
