-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_pp_filtro_prod_medica_pck.obter_restricao_padrao ( ie_considera_selecao_p boolean, ie_tipo_data_ref_p pls_pp_lote.ie_tipo_dt_referencia%type, dt_inicio_referencia_p pls_pp_lote.dt_referencia_inicio%type, dt_fim_referencia_p pls_pp_lote.dt_referencia_fim%type, ie_recurso_proprio_p pls_pp_lote.ie_recurso_proprio%type, cd_estabelecimento_p pls_pp_lote.cd_estabelecimento%type, ds_restricao_mat_p out text, ds_restricao_proc_p out text, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE

					
ds_restricao_w 		varchar(2000);
ds_restricao_mat_w	varchar(2000);
ds_restricao_proc_w	varchar(2000);
ds_restr_cpag_w		varchar(500);

ds_alias_con_w		varchar(60);
ds_alias_prot_w		varchar(60);
ds_alias_res_w		varchar(60);
ds_alias_pres_w		varchar(60);

ie_forma_pagamento_w	pls_parametro_pagamento.ie_forma_pagamento%type := pls_pp_lote_pagamento_pck.ie_forma_pagamento_w;


BEGIN

-- inicia a variavel com null
ds_restricao_w := null;
ds_restricao_mat_w := null;
ds_restricao_proc_w := null;

-- so faz estes filtros caso nao seja para considerar a tabela de selecao
-- se for para considerar a tabela, tudo o que ja existe dentro dela ja passou por estes filtros antes
if (ie_considera_selecao_p = false) then

	ds_alias_con_w := pls_pp_filtro_prod_medica_pck.obter_alias_tabela('conta');
	ds_alias_prot_w := pls_pp_filtro_prod_medica_pck.obter_alias_tabela('protocolo');
	ds_alias_res_w := pls_pp_filtro_prod_medica_pck.obter_alias_tabela('resumo');
	ds_alias_pres_w := pls_pp_filtro_prod_medica_pck.obter_alias_tabela('prestador');

	ds_restricao_w := ds_restricao_w || ' and ' || ds_alias_con_w || '.ie_status = ''F''' || pls_util_pck.enter_w;

	if (ie_forma_pagamento_w = 'P') then
		ds_restricao_w := ds_restricao_w || ' and ' || ds_alias_res_w || '.ie_status_protocolo in (''3'',''4'') ' || pls_util_pck.enter_w;
		
		-- OS 000000 - jtrindade - Caso futuramente haja a necessidade de tratamento do campo PLS_PARAMETRO_PAGAMENTO.IE_PROT_SEM_PAGTO
		/*if	(ie_prot_sem_pagto_w = 'N') then
			ds_restricao_w := ds_restricao_w || ' and ' || ds_alias_res_w || '.ie_status_protocolo = ''3'' ' || pls_util_pck.enter_w;
		else
			ds_restricao_w := ds_restricao_w || ' and ' || ds_alias_res_w || '.ie_status_protocolo in (''3'',''4'') ' || pls_util_pck.enter_w;
		end if;*/
	elsif (ie_forma_pagamento_w = 'C') then
		ds_restricao_w := ds_restricao_w || 	' and ' || ds_alias_res_w || '.ie_status = ''F'' ' || pls_util_pck.enter_w ||
							' and ' || ds_alias_con_w || '.ie_status = ''F'' ' || pls_util_pck.enter_w;
	end if;
	
	-- data de competencia do protocolo
	if (ie_tipo_data_ref_p = '1') then
		ds_restricao_w := ds_restricao_w || ' and ' || ds_alias_prot_w || '.dt_mes_competencia between :dt_inicio_pc and fim_dia(:dt_fim_pc)' || pls_util_pck.enter_w;

	-- data de liberacao de pagamento do protocolo
	elsif (ie_tipo_data_ref_p = '2') then
		ds_restricao_w := ds_restricao_w || ' and ' || ds_alias_prot_w || '.dt_lib_pagamento between :dt_inicio_pc and fim_dia(:dt_fim_pc)' || pls_util_pck.enter_w;
		
	-- data de competencia do resumo de conta medica
	elsif (ie_tipo_data_ref_p = '3') then
		ds_restricao_w := ds_restricao_w || ' and ' || ds_alias_res_w || '.dt_competencia_pgto between :dt_inicio_pc and fim_dia(:dt_fim_pc)' || pls_util_pck.enter_w;	
	end if;
	
	-- binds variables dos filtros de data acima
	valor_bind_p := sql_pck.bind_variable(':dt_inicio_pc', dt_inicio_referencia_p, valor_bind_p);
	valor_bind_p := sql_pck.bind_variable(':dt_fim_pc', dt_fim_referencia_p, valor_bind_p);

	-- filtro de estabelecimento
	ds_restricao_w := ds_restricao_w || ' and ' || ds_alias_prot_w || '.cd_estabelecimento = :cd_estabelecimento_pc' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':cd_estabelecimento_pc', cd_estabelecimento_p, valor_bind_p);
end if;

-- parametros OUT
ds_restricao_mat_p	:= ds_restricao_mat_w;
ds_restricao_proc_p	:= ds_restricao_proc_w;

-- retorna a restricao que sera utilizada no select
return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_pp_filtro_prod_medica_pck.obter_restricao_padrao ( ie_considera_selecao_p boolean, ie_tipo_data_ref_p pls_pp_lote.ie_tipo_dt_referencia%type, dt_inicio_referencia_p pls_pp_lote.dt_referencia_inicio%type, dt_fim_referencia_p pls_pp_lote.dt_referencia_fim%type, ie_recurso_proprio_p pls_pp_lote.ie_recurso_proprio%type, cd_estabelecimento_p pls_pp_lote.cd_estabelecimento%type, ds_restricao_mat_p out text, ds_restricao_proc_p out text, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
