-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ppm_painel_pck.get_resultados_metrica (nr_seq_metrica_p bigint, dt_referencia_p timestamp) RETURNS SETOF T_PPM_PAINEL AS $body$
DECLARE


	line_w			t_ppm_painel_row;
	qt_target_w					ppm_objetivo_metrica.qt_target%type;
	qt_target_final_w			ppm_objetivo_metrica.qt_target_final%type;
	qt_target_exceeds_w			ppm_objetivo_metrica.qt_target_exceeds%type;
	qt_target_exceeds_final_w	ppm_objetivo_metrica.qt_target_exceeds_final%type;
	ie_condicao_w				ppm_objetivo_metrica.ie_condicao%type;
	ie_condicao_exceeds_w		ppm_objetivo_metrica.ie_condicao_exceeds%type;
	ie_informacao_w				ppm_metrica.ie_informacao%type;
	nr_sequencia_w				bigint;
	nr_seq_metrica_w			bigint;
	vl_resultado_calc_w			double precision;
	dt_referencia_w				timestamp;
	i							integer;
	ie_passou_w					boolean	:= false;

	
BEGIN

		if (coalesce(nr_seq_metrica_p,0) > 0) then

			select	qt_target,
					qt_target_final,
				qt_target_exceeds,
				qt_target_exceeds_final,
				ie_condicao,
				ie_condicao_exceeds,
				nr_seq_metrica
			into STRICT	qt_target_w,
					qt_target_final_w,
				qt_target_exceeds_w,
				qt_target_exceeds_final_w,
				ie_condicao_w,
				ie_condicao_exceeds_w,
				nr_seq_metrica_w
			from	ppm_objetivo_metrica
			where	nr_sequencia = nr_seq_metrica_p;
			
			select	coalesce(max(ie_informacao),'P')
			into STRICT	ie_informacao_w
			from	ppm_metrica
			where	nr_sequencia	= nr_seq_metrica_w;
						
			i := 1;
			for i in 1..12 loop
				begin
				
				nr_sequencia_w		:= null;
				vl_resultado_calc_w	:= null;
				dt_referencia_w		:= null;
				
				begin
				select	nr_sequencia,
					vl_resultado_calc,
					dt_referencia
				into STRICT	nr_sequencia_w,
					vl_resultado_calc_w,
					dt_referencia_w
				from	ppm_objetivo_result a
				where	a.nr_seq_metrica = nr_seq_metrica_p				
				and	PKG_DATE_UTILS.start_of(DT_REFERENCIA,'YEAR') 	= PKG_DATE_UTILS.start_of(dt_referencia_p,'YEAR')
				and	(to_char(dt_referencia,'MM'))::numeric  	= i
				and	dt_referencia <> PKG_DATE_UTILS.end_of(to_date('31/12/' || to_char(dt_referencia_p,'yyyy'),'dd/mm/yyyy'),'DAY') /* Nao considerar acumulado */
  LIMIT 1;				
				exception
				when others then
					nr_sequencia_w		:= null;
					vl_resultado_calc_w	:= null;
					dt_referencia_w		:= null;
				end;
				
				line_w.nr_seq_resultado		:= nr_sequencia_w;
				line_w.nr_seq_metrica		:= nr_seq_metrica_p;
				line_w.dt_resultado		:= dt_referencia_w;
				line_w.nr_mes_resultado		:= i;
				line_w.vl_resultado		:= vl_resultado_calc_w;
				line_w.ie_informacao		:= ie_informacao_w;
				
				if (coalesce(nr_sequencia_w::text, '') = '') then
					line_w.ie_resultado	:= null;
				else
					ie_passou_w	:= true;
				
					line_w.ie_resultado	:= ppm_painel_pck.get_tipo_resultado(	qt_target_w,
											qt_target_final_w,
											qt_target_exceeds_w,
											qt_target_exceeds_final_w,
											ie_condicao_w,
											ie_condicao_exceeds_w,
											vl_resultado_calc_w);
				end if;
				
				RETURN NEXT line_w;
				
				end;
			end loop;
			
			/* Acumulado */

			if (ie_passou_w) then
				nr_sequencia_w		:= null;
				vl_resultado_calc_w	:= null;
				dt_referencia_w		:= null;
				
				begin
				select	nr_sequencia,
						vl_resultado_calc,
						dt_referencia
				into STRICT	nr_sequencia_w,
						vl_resultado_calc_w,
						dt_referencia_w
				from	ppm_objetivo_result a
				where	a.nr_seq_metrica = nr_seq_metrica_p				
				and		DT_REFERENCIA	= PKG_DATE_UTILS.end_of(to_date('31/12/' || to_char(dt_referencia_p,'yyyy'),'dd/mm/yyyy'),'DAY')  LIMIT 1;				
				exception
				when others then
					nr_sequencia_w		:= null;
					vl_resultado_calc_w	:= null;
					dt_referencia_w		:= null;
				end;
				
				line_w.nr_seq_resultado		:= nr_sequencia_w;
				line_w.nr_seq_metrica		:= nr_seq_metrica_p;
				line_w.dt_resultado			:= PKG_DATE_UTILS.end_of(to_date('31/12/' || to_char(dt_referencia_p,'yyyy'),'dd/mm/yyyy'),'DAY');
				line_w.nr_mes_resultado		:= 99;
				line_w.vl_resultado			:= vl_resultado_calc_w;
				line_w.ie_informacao		:= ie_informacao_w;
				if (coalesce(nr_sequencia_w::text, '') = '') then
					line_w.ie_resultado	:= null;
				else
					line_w.ie_resultado	:= ppm_painel_pck.get_tipo_resultado(	qt_target_w,
											qt_target_final_w,
											qt_target_exceeds_w,
											qt_target_exceeds_final_w,
											ie_condicao_w,
											ie_condicao_exceeds_w,
											vl_resultado_calc_w);
				end if;
				
				RETURN NEXT line_w;
				
			end if;

			return;
		end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ppm_painel_pck.get_resultados_metrica (nr_seq_metrica_p bigint, dt_referencia_p timestamp) FROM PUBLIC;
