-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

					
-- Carrregar os dados da guia Honorario Individual do arquivo A520 de XML
CREATE OR REPLACE PROCEDURE ptu_aviso_imp_pck.carregar_a520_honorario ( ds_arquivo_xml_p ptu_aviso_arq_xml.ds_arquivo%type, nr_seq_aviso_protocolo_p ptu_aviso_protocolo.nr_sequencia%type, nr_guias_p bigint, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_guia_w			bigint := 1;
nr_proc_w			bigint := 1;
nr_equipe_w			bigint := 1;
nr_tag_proc_w			bigint := 0;
nr_tag_equipe_w			bigint := 0;
ds_guia_w			text; -- guia
ds_exec_w			text; -- executor
ds_procs_w			text; -- procedimentos
ds_proc_w			text; -- procedimento
ds_equipe_w			text; -- equipe
-- Guia
nr_seq_aviso_conta_w		ptu_aviso_conta.nr_sequencia%type;
nr_guia_principal_w		ptu_aviso_conta.nr_guia_principal%type;
nr_guia_operadora_w		ptu_aviso_conta.nr_guia_operadora%type;
nr_guia_prestador_w		ptu_aviso_conta.nr_guia_prestador%type;
cd_registro_ans_w		ptu_aviso_conta.cd_registro_ans%type;
cd_senha_w			ptu_aviso_conta.cd_senha%type;
nr_carteira_benef_w		ptu_aviso_conta.nr_carteira_benef%type;
nm_beneficiario_w		ptu_aviso_conta.nm_beneficiario%type;
ie_ident_beneficiario_w		ptu_aviso_conta.ie_ident_beneficiario%type;
ie_atendimento_rn_w		ptu_aviso_conta.ie_atendimento_rn%type;
cd_prestador_executante_w	ptu_aviso_conta.cd_prestador_executante%type;
cd_cnpj_executante_w		ptu_aviso_conta.cd_cnpj_executante%type;
nm_executante_w			ptu_aviso_conta.nm_executante%type;
cd_cnes_executante_w		ptu_aviso_conta.cd_cnes_executante%type;
ds_observacao_w			ptu_aviso_conta.ds_observacao%type;
vl_procedimento_w		ptu_aviso_conta.vl_procedimento%type;
vl_total_geral_w		ptu_aviso_conta.vl_total_geral%type;
dt_inicio_faturamento_w		varchar(255);
dt_fim_faturamento_w		varchar(255);
dt_atendimento_ref_w		varchar(255);
-- Procedimento
nr_seq_aviso_procedimento_w	ptu_aviso_procedimento.nr_sequencia%type;
dt_execucao_w			varchar(255);
hr_inicial_w			ptu_aviso_procedimento.hr_inicial%type;
hr_final_w			ptu_aviso_procedimento.hr_final%type;
cd_tabela_w			ptu_aviso_procedimento.cd_tabela%type;
cd_proc_envio_w			ptu_aviso_procedimento.cd_proc_envio%type;
ds_procedimento_w		ptu_aviso_procedimento.ds_procedimento%type;
qt_executada_w			ptu_aviso_procedimento.qt_executada%type;
ie_via_acesso_w			ptu_aviso_procedimento.ie_via_acesso%type;
ie_tecnica_utilizada_w		ptu_aviso_procedimento.ie_tecnica_utilizada%type;
tx_reducao_acrescimo_w		ptu_aviso_procedimento.tx_reducao_acrescimo%type;
vl_unitario_w			ptu_aviso_procedimento.vl_unitario%type;
vl_total_w			ptu_aviso_procedimento.vl_total%type;
nr_seq_item_tiss_w		ptu_aviso_procedimento.nr_seq_item_tiss%type;
-- Equipe
nr_seq_aviso_participante_w	ptu_aviso_participante.nr_sequencia%type;
ie_grau_participante_w		ptu_aviso_participante.ie_grau_participante%type;
cd_prestador_w			ptu_aviso_participante.cd_prestador%type;
cd_cpf_contratado_w		ptu_aviso_participante.cd_cpf_contratado%type;
nm_profissional_w		ptu_aviso_participante.nm_profissional%type;
sg_conselho_w			ptu_aviso_participante.sg_conselho%type;
nr_conselho_w			ptu_aviso_participante.nr_conselho%type;
sg_uf_w				ptu_aviso_participante.sg_uf%type;
nr_cbo_w			ptu_aviso_participante.nr_cbo%type;
nr_seq_segurado_w		ptu_aviso_conta.nr_seq_segurado%type;
					

BEGIN

while(nr_guia_w <= nr_guias_p) loop
	ds_guia_w := ptu_aviso_imp_pck.obter_conteudo_tag(ds_arquivo_xml_p,'ans:guiaHonorarios',nr_guia_w);
	
	-- Guia
	nr_guia_principal_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:guiaSolicInternacao',1);
	nr_guia_operadora_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:numeroGuiaOperadora',1);
	nr_guia_prestador_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:numeroGuiaPrestador',1);
	cd_registro_ans_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:registroANS',1);
	-- Autorizacao
	cd_senha_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:senha',1);
	-- Beneficiario
	nr_carteira_benef_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:numeroCarteira',1);
	nm_beneficiario_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:nomeBeneficiario',1);
	ie_ident_beneficiario_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:identificadorBeneficiario',1);
	ie_atendimento_rn_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:atendimentoRN',1);
	
	-- Dados local contrato exec
	-- inicialmente busca os dados da tag  dadosContratadoExecutante
	ds_exec_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:dadosContratadoExecutante',1);
	cd_prestador_executante_w	:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:codigonaOperadora',1);
	cd_cnpj_executante_w		:= '';
	nm_executante_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:nomeContratadoExecutante',1);
	cd_cnes_executante_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:cnesContratadoExecutante',1);

	-- caso nao houver busca da tag localContratado
	ds_exec_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:localContratado',1);
	-- se nao tiver codigo do prestador da operadora, busca da tav do local do contratdo
	if somente_numero(cd_prestador_executante_w) = 0 then
		cd_prestador_executante_w	:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:codigoNaOperadora',1);
	end if;
	
	-- se ainda assim nao possuir o valor , busca as demais tags
	if somente_numero(cd_prestador_executante_w) = 0 then
		cd_cnpj_executante_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:cnpjLocalExecutante',1);
		nm_executante_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:nomeContratado',1);
		cd_cnes_executante_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:cnes',1);
	end if;
	
	-- Dados internacao
	dt_inicio_faturamento_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:dataInicioFaturamento',1);
	dt_fim_faturamento_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:dataFimFaturamento',1);
	dt_atendimento_ref_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:dataEmissaoGuia',1);
	-- Dados atendimento
	ds_observacao_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:observacao',1);
	-- Valores
	vl_procedimento_w		:= ptu_aviso_imp_pck.converte_numero(ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:valorTotalHonorarios',1));
	vl_total_geral_w		:= ptu_aviso_imp_pck.converte_numero(ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:valorTotalHonorarios',1));
	
	select	max(nr_seq_segurado)
	into STRICT	nr_seq_segurado_w
	from	pls_segurado_carteira
	where	cd_usuario_plano	= nr_carteira_benef_w;
	
	-- Inserir guia A520
		nr_seq_aviso_conta_w := ptu_aviso_imp_pck.inserir_a520_guias(	nr_seq_aviso_conta_w, nm_usuario_p, nr_seq_aviso_protocolo_p, null, nr_seq_segurado_w, nr_guia_principal_w, nr_guia_operadora_w, nr_guia_prestador_w, cd_registro_ans_w, null, cd_senha_w, null, nr_carteira_benef_w, ie_atendimento_rn_w, nm_beneficiario_w, null, ie_ident_beneficiario_w, null, null, null, null, null, null, null, null, null, null, null, null, null, cd_prestador_executante_w, null, cd_cnpj_executante_w, null, null, null, null, null, nm_executante_w, cd_cnes_executante_w, null, null, null, null, ds_observacao_w, vl_procedimento_w, 0, 0, 0, 0, 0, 0, vl_total_geral_w, null, dt_inicio_faturamento_w, dt_fim_faturamento_w, null, null, null, null, null, dt_atendimento_ref_w);
				
	-- Procedimentos
	ds_procs_w 			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:procedimentosRealizados',1);
	nr_tag_proc_w			:= ptu_aviso_imp_pck.obter_numero_tag(ds_procs_w,'ans:procedimentoRealizado');
	while(nr_proc_w <= nr_tag_proc_w) loop
		ds_proc_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_procs_w,'ans:procedimentoRealizado',nr_proc_w);
		dt_execucao_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:dataExecucao',1);
		hr_inicial_w			:= ptu_aviso_imp_pck.converte_data_hora(dt_execucao_w,ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:horaInicial',1));
		hr_final_w			:= ptu_aviso_imp_pck.converte_data_hora(dt_execucao_w,ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:horaFinal',1));		
		cd_tabela_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:codigoTabela',1);
		cd_proc_envio_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:codigoProcedimento',1);
		ds_procedimento_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:descricaoProcedimento',1);
		qt_executada_w			:= ptu_aviso_imp_pck.converte_numero(ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:quantidadeExecutada',1));
		ie_via_acesso_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:viaAcesso',1);
		ie_tecnica_utilizada_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:tecnicaUtilizada',1);
		tx_reducao_acrescimo_w		:= ptu_aviso_imp_pck.converte_numero(ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:reducaoAcrescimo',1));
		vl_unitario_w			:= ptu_aviso_imp_pck.converte_numero(ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:valorUnitario',1));
		vl_total_w			:= ptu_aviso_imp_pck.converte_numero(ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:valorTotal',1));
		nr_seq_item_tiss_w		:= ptu_aviso_imp_pck.converte_numero(ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:sequencialItem',1));
		
		-- Inserir procedimento A520
			nr_seq_aviso_procedimento_w := ptu_aviso_imp_pck.inserir_a520_proc(	nr_seq_aviso_procedimento_w, nm_usuario_p, nr_seq_aviso_conta_w, null, null, null, '00', dt_execucao_w, hr_inicial_w, hr_final_w, cd_tabela_w, cd_proc_envio_w, ds_procedimento_w, qt_executada_w, ie_via_acesso_w, ie_tecnica_utilizada_w, tx_reducao_acrescimo_w, vl_unitario_w, vl_total_w, nr_seq_item_tiss_w);
		
		-- Participantes
		nr_tag_equipe_w			:= ptu_aviso_imp_pck.obter_numero_tag(ds_proc_w,'ans:profissionais');
		while(nr_equipe_w <= nr_tag_equipe_w) loop
			ds_equipe_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_proc_w,'ans:profissionais',nr_equipe_w);
			ie_grau_participante_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_equipe_w,'ans:grauParticipacao',1);
			cd_prestador_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_equipe_w,'ans:codigoPrestadorNaOperadora',1);
			cd_cpf_contratado_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_equipe_w,'ans:cpfContratado',1);
			nm_profissional_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_equipe_w,'ans:nomeProfissional',1);
			sg_conselho_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_equipe_w,'ans:conselhoProfissional',1);
			nr_conselho_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_equipe_w,'ans:numeroConselhoProfissional',1);
			sg_uf_w				:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_equipe_w,'ans:UF',1);
			nr_cbo_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_equipe_w,'ans:CBOS',1);
			
			-- Inserir participante A520
				nr_seq_aviso_participante_w := ptu_aviso_imp_pck.inserir_a520_proc_part(	nr_seq_aviso_participante_w, null, ie_grau_participante_w, cd_prestador_w, cd_cpf_contratado_w, nm_profissional_w, sg_conselho_w, nr_conselho_w, sg_uf_w, nr_cbo_w, nm_usuario_p, nr_seq_aviso_procedimento_w);
			
			nr_equipe_w := nr_equipe_w + 1;
		end loop;
		nr_equipe_w := 1;
		
		nr_proc_w := nr_proc_w + 1;
	end loop;
	nr_proc_w := 1;

	nr_guia_w := nr_guia_w + 1;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_aviso_imp_pck.carregar_a520_honorario ( ds_arquivo_xml_p ptu_aviso_arq_xml.ds_arquivo%type, nr_seq_aviso_protocolo_p ptu_aviso_protocolo.nr_sequencia%type, nr_guias_p bigint, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
