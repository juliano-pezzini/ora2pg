-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

				
-- Carrregar os dados da guia Consulta do arquivo A520 de XML
CREATE OR REPLACE PROCEDURE ptu_aviso_imp_pck.carregar_a520_consulta ( ds_arquivo_xml_p ptu_aviso_arq_xml.ds_arquivo%type, nr_seq_aviso_protocolo_p ptu_aviso_protocolo.nr_sequencia%type, nr_guias_p bigint, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_guia_w			bigint := 1;
ds_guia_w			text;
ds_exec_w			text;
nr_seq_aviso_conta_w		ptu_aviso_conta.nr_sequencia%type;

-- Guia
nr_guia_operadora_w		ptu_aviso_conta.nr_guia_operadora%type;
nr_guia_prestador_w		ptu_aviso_conta.nr_guia_prestador%type;
cd_registro_ans_w		ptu_aviso_conta.cd_registro_ans%type;
dt_autorizacao_w		ptu_aviso_conta.dt_autorizacao%type;
cd_senha_w			ptu_aviso_conta.cd_senha%type;
dt_validade_senha_w		ptu_aviso_conta.dt_validade_senha%type;
nr_carteira_benef_w		ptu_aviso_conta.nr_carteira_benef%type;
ie_atendimento_rn_w		ptu_aviso_conta.ie_atendimento_rn%type;
nm_beneficiario_w		ptu_aviso_conta.nm_beneficiario%type;
nr_cns_benef_w			ptu_aviso_conta.nr_cns_benef%type;
ie_ident_beneficiario_w		ptu_aviso_conta.ie_ident_beneficiario%type;
cd_cnes_solicitante_w		ptu_aviso_conta.cd_cnes_solicitante%type;
cd_prestador_executante_w	ptu_aviso_conta.cd_prestador_executante%type;
cd_cpf_executante_w		ptu_aviso_conta.cd_cpf_executante%type;
cd_cnpj_executante_w		ptu_aviso_conta.cd_cnpj_executante%type;
nm_profissional_executante_w	ptu_aviso_conta.nm_profissional_executante%type;
sg_conselho_executante_w	ptu_aviso_conta.sg_conselho_executante%type;
nr_conselho_executante_w	ptu_aviso_conta.nr_conselho_executante%type;
sg_uf_executante_w		ptu_aviso_conta.sg_uf_executante%type;
nr_cbo_executante_w		ptu_aviso_conta.nr_cbo_executante%type;
nm_executante_w			ptu_aviso_conta.nm_executante%type;
cd_cnes_executante_w		ptu_aviso_conta.cd_cnes_executante%type;
ie_indicacao_acidente_w		ptu_aviso_conta.ie_indicacao_acidente%type;
ie_tipo_consulta_w		ptu_aviso_conta.ie_tipo_consulta%type;
ds_observacao_w			ptu_aviso_conta.ds_observacao%type;
dt_atendimento_ref_w		varchar(255);
-- Procedimento
nr_seq_aviso_procedimento_w	ptu_aviso_procedimento.nr_sequencia%type;
cd_tabela_w			ptu_aviso_procedimento.cd_tabela%type;
cd_proc_envio_w			ptu_aviso_procedimento.cd_proc_envio%type;
vl_unitario_w			ptu_aviso_procedimento.vl_unitario%type;
vl_total_w			ptu_aviso_procedimento.vl_total%type;
nr_seq_segurado_w		ptu_aviso_conta.nr_seq_segurado%type;
					

BEGIN

while(nr_guia_w <= nr_guias_p) loop
	ds_guia_w := ptu_aviso_imp_pck.obter_conteudo_tag(ds_arquivo_xml_p,'ans:guiaConsulta',nr_guia_w);
	
	-- Guia
	nr_guia_operadora_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:numeroGuiaOperadora',1);
	nr_guia_prestador_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:numeroGuiaPrestador',1);
	cd_registro_ans_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:registroANS',1);
	-- Beneficiario
	nr_carteira_benef_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:numeroCarteira',1);
	ie_atendimento_rn_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:atendimentoRN',1);
	nm_beneficiario_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:nomeBeneficiario',1);
	nr_cns_benef_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:numeroCNS',1);
	ie_ident_beneficiario_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:identificadorBeneficiario',1);
	-- Dados executante
	ds_exec_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:contratadoExecutante',1);
	cd_prestador_executante_w	:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:codigoPrestadorNaOperadora',1);
	cd_cpf_executante_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:cpfContratado',1);
	cd_cnpj_executante_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:cnpjContratado',1);
	nm_executante_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:nomeContratado',1);
	cd_cnes_executante_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:CNES',1);
	-- Dados profissional exec
	ds_exec_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:profissionalExecutante',1);
	nm_profissional_executante_w	:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:nomeProfissional',1);
	sg_conselho_executante_w	:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:conselhoProfissional',1);
	nr_conselho_executante_w	:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:numeroConselhoProfissional',1);
	sg_uf_executante_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:UF',1);
	nr_cbo_executante_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_exec_w,'ans:CBOS',1);
	-- Dados atendimento
	ie_indicacao_acidente_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:indicacaoAcidente',1);
	dt_atendimento_ref_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:dataAtendimento',1);
	ie_tipo_consulta_w		:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:tipoConsulta',1);
	ds_observacao_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:observacao',1);
	-- Procedimento
	cd_tabela_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:codigoTabela',1);
	cd_proc_envio_w			:= ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:codigoProcedimento',1);
	vl_unitario_w			:= ptu_aviso_imp_pck.converte_numero(ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:valorProcedimento',1));
	vl_total_w			:= ptu_aviso_imp_pck.converte_numero(ptu_aviso_imp_pck.obter_conteudo_tag(ds_guia_w,'ans:valorProcedimento',1));
	
	select	max(nr_seq_segurado)
	into STRICT	nr_seq_segurado_w
	from	pls_segurado_carteira
	where	cd_usuario_plano	= nr_carteira_benef_w;
	
	-- Inserir guia A520
		nr_seq_aviso_conta_w := ptu_aviso_imp_pck.inserir_a520_guias(	nr_seq_aviso_conta_w, nm_usuario_p, nr_seq_aviso_protocolo_p, null, nr_seq_segurado_w, null, nr_guia_operadora_w, nr_guia_prestador_w, cd_registro_ans_w, null, null, null, nr_carteira_benef_w, ie_atendimento_rn_w, nm_beneficiario_w, nr_cns_benef_w, ie_ident_beneficiario_w, null, null, null, null, null, null, null, null, null, null, null, null, null, cd_prestador_executante_w, cd_cpf_executante_w, cd_cnpj_executante_w, nm_profissional_executante_w, sg_conselho_executante_w, nr_conselho_executante_w, sg_uf_executante_w, nr_cbo_executante_w, nm_executante_w, cd_cnes_executante_w, null, ie_indicacao_acidente_w, ie_tipo_consulta_w, null, ds_observacao_w, vl_total_w, 0, 0, 0, 0, 0, 0, vl_total_w, null, null, null, null, null, null, null, null, dt_atendimento_ref_w);
				
	-- Inserir procedimento A520
		nr_seq_aviso_procedimento_w := ptu_aviso_imp_pck.inserir_a520_proc(	nr_seq_aviso_procedimento_w, nm_usuario_p, nr_seq_aviso_conta_w, null, null, null, '00', null, null, null, cd_tabela_w, cd_proc_envio_w, null, null, null, null, null, vl_unitario_w, vl_total_w, null);
				
	nr_guia_w := nr_guia_w + 1;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_aviso_imp_pck.carregar_a520_consulta ( ds_arquivo_xml_p ptu_aviso_arq_xml.ds_arquivo%type, nr_seq_aviso_protocolo_p ptu_aviso_protocolo.nr_sequencia%type, nr_guias_p bigint, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
