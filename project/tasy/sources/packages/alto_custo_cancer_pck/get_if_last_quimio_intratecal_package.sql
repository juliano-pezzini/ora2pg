-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION alto_custo_cancer_pck.get_if_last_quimio_intratecal (nr_atendimento_p bigint) RETURNS bigint AS $body$
DECLARE


      ds_retorno_w    integer;


BEGIN        
        begin
            select CASE WHEN nr_seq_via_anvisa=18 THEN  1  ELSE 2 END 
            into STRICT    ds_retorno_w
            from (
                        SELECT  a.ie_via_aplicacao, va.nr_seq_via_anvisa
                        from    paciente_protocolo_medic a,
                                paciente_setor b,
                                via_aplicacao va
                        where   a.nr_seq_paciente = b.nr_seq_paciente
                        and     b.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_p,'C')
                        and     obter_se_ciclo_gerado(b.nr_seq_paciente) <> 'N'
                        and (b.ie_status = 'A'
                                or b.ie_status = 'F')
                        and     trunc(b.dt_protocolo) between alto_custo_pck.get_data_inicio_emissao_guia
                                                    and alto_custo_pck.get_data_corte
                        and     va.ie_via_aplicacao = a.ie_via_aplicacao
                        order by    b.dt_protocolo desc
                    ) alias4 LIMIT 1;

            exception
                when no_data_found then
                    ds_retorno_w := null;
          end;

        return ds_retorno_w;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION alto_custo_cancer_pck.get_if_last_quimio_intratecal (nr_atendimento_p bigint) FROM PUBLIC;
