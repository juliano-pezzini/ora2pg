-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_comissao_equipe_pck.inserir_beneficiario_vendedor ( nr_seq_lote_comissao_p pls_lote_comissao.nr_sequencia%type, dt_referencia_p pls_lote_comissao.dt_referencia%type) AS $body$
DECLARE



qt_vidas_meta_w			bigint;
						
cursor_w			sql_pck.t_cursor;
tb_nr_seq_segurado_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_vendedor_canal_w	pls_util_cta_pck.t_number_table;
current_setting('pls_comissao_equipe_pck.tb_nr_seq_mensalidade_seg_w')::pls_util_cta_pck.t_number_table	pls_util_cta_pck.t_number_table;
tb_ie_acao_contrato_w		pls_util_cta_pck.t_varchar2_table_2;
tb_ie_tipo_vendedor_benef_w	pls_util_cta_pck.t_varchar2_table_1;
tb_nr_titulo_w			pls_util_cta_pck.t_number_table;
tb_nr_seq_vendedor_pf_w		pls_util_cta_pck.t_number_table;
current_setting('pls_comissao_equipe_pck.tb_nr_proposta_adesao_w')::pls_util_cta_pck.t_number_table		pls_util_cta_pck.t_varchar2_table_20;
current_setting('pls_comissao_equipe_pck.tb_cd_pessoa_fisica_w')::pls_util_cta_pck.t_varchar2_table_10		pls_util_cta_pck.t_varchar2_table_10;
tb_qt_idade_w			pls_util_cta_pck.t_number_table;
tb_nr_seq_portabilidade_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_motivo_inclusao_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_tipo_comissao_w	pls_util_cta_pck.t_number_table;
tb_dt_contratacao_w		pls_util_cta_pck.t_date_table;
tb_dt_contrato_w		pls_util_cta_pck.t_date_table;
tb_nr_seq_grupo_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_contrato_w		pls_util_cta_pck.t_number_table;

current_setting('pls_comissao_equipe_pck.c01')::CURSOR CURSOR FOR
	SELECT	nr_seq_equipe,
		nr_seq_canal_venda,
		nr_sequencia,
		ie_recebe_comissao
	from	pls_comissao
	where	nr_seq_lote = nr_seq_lote_comissao_p;

current_setting('pls_comissao_equipe_pck.c02')::CURSOR( CURSOR(	nr_seq_equipe_pc	pls_equipe_vendedor.nr_sequencia%type,
		nr_seq_canal_venda_pc	pls_vendedor.nr_sequencia%type) FOR
	SELECT	a.ie_tipo_contrato,
		a.nr_sequencia,
		a.nr_seq_grupo_produto,
		a.nr_seq_plano,
		a.ie_acao_contrato,
		a.ie_meta_plano,
		CASE WHEN a.ie_tipo_meta_vidas='N' THEN  0  ELSE a.qt_vidas_inicial END  qt_vidas_inicial,
		CASE WHEN a.ie_tipo_meta_vidas='N' THEN  0  ELSE a.qt_vidas_final END  qt_vidas_final,
		a.ie_tipo_meta_vidas
	from	pls_equipe_vend_meta	a,
		pls_equipe_vendedor	b
	where	a.nr_seq_equipe	= b.nr_sequencia
	and	b.nr_sequencia	= nr_seq_equipe_pc
	and	coalesce(a.nr_seq_vendedor_canal,nr_seq_canal_venda_pc) = nr_seq_canal_venda_pc
	and	dt_referencia_p	between a.dt_inicio_vigencia and coalesce(dt_fim_vigencia,dt_referencia_p);
BEGIN

for r_c01_w in current_setting('pls_comissao_equipe_pck.c01')::loop CURSOR
	begin
	for r_c02_w in current_setting('pls_comissao_equipe_pck.c02')::CURSOR( (r_c01_w.nr_seq_equipe, r_c01_w.nr_seq_canal_venda) loop
		begin
		current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind.delete;
		PERFORM set_config('pls_comissao_equipe_pck.ds_sql_w', '	select	a.nr_seq_segurado,												
							a.nr_seq_vendedor_canal,
							a.ie_acao_contrato,
							a.ie_tipo_vendedor_benef,
							x.nr_sequencia nr_seq_mensalidade_seg,
							t.nr_titulo,
							a.nr_seq_vendedor_pf,
							a.nr_proposta_adesao,
							a.cd_pessoa_fisica,
							obter_idade_pf(a.cd_pessoa_fisica, sysdate, ''A'') qt_idade,
							c.dt_contrato,
							c.nr_seq_tipo_comissao,
							a.nr_seq_portabilidade, 
							a.nr_seq_motivo_inclusao, 
							a.dt_contratacao,
							pls_dados_grupo_relac_contr(c.nr_sequencia,''S'') nr_seq_grupo,
							c.nr_sequencia nr_seq_contrato
						from	(select	nr_sequencia nr_seq_segurado,								
								nr_seq_vendedor_canal,
								dt_contratacao,
								nr_seq_plano,
								nr_seq_contrato,
								ie_acao_contrato,
								''N'' ie_tipo_vendedor_benef,
								nr_seq_vendedor_pf,
								nr_proposta_adesao,
								cd_pessoa_fisica,
								nr_seq_portabilidade, 
								nr_seq_motivo_inclusao
							from	pls_segurado									
							where	dt_cancelamento is null
							and	nr_seq_vendedor_canal = :nr_seq_canal_venda	
							union												
							select	b.nr_sequencia nr_seq_segurado,									
								a.nr_seq_vendedor_canal,
								b.dt_contratacao,
								b.nr_seq_plano,
								b.nr_seq_contrato,
								b.ie_acao_contrato,
								''N'' ie_tipo_vendedor_benef,
								b.nr_seq_vendedor_pf,
								b.nr_proposta_adesao,
								b.cd_pessoa_fisica,
								b.nr_seq_portabilidade, 
								b.nr_seq_motivo_inclusao
							from	pls_segurado_canal_compl a,
								pls_segurado b
							where	b.nr_sequencia = a.nr_seq_segurado
							and	b.dt_cancelamento is null
							and	a.nr_seq_vendedor_canal = :nr_seq_canal_venda
							union												
							select	a.nr_sequencia nr_seq_segurado,								
								a.nr_seq_vendedor_canal,
								a.dt_contratacao,
								a.nr_seq_plano,
								a.nr_seq_contrato,
								a.ie_acao_contrato,
								''E'' ie_tipo_vendedor_benef,
								a.nr_seq_vendedor_pf,
								a.nr_proposta_adesao,
								a.cd_pessoa_fisica,
								a.nr_seq_portabilidade, 
								a.nr_seq_motivo_inclusao
							from	pls_segurado a										
							where	a.dt_cancelamento is null
							and	a.nr_seq_vendedor_canal <> :nr_seq_canal_venda
							and	exists (select	1
									from	pls_equipe_vend_vinculo	x
									where	x.nr_seq_equipe		= :nr_seq_equipe
									and	x.nr_seq_vendedor	= a.nr_seq_vendedor_canal)					
							union											
							select	b.nr_sequencia nr_seq_segurado,									
								a.nr_seq_vendedor_canal,
								b.dt_contratacao,
								b.nr_seq_plano,
								b.nr_seq_contrato,
								b.ie_acao_contrato,
								''E'' ie_tipo_vendedor_benef,
								b.nr_seq_vendedor_pf,
								b.nr_proposta_adesao,
								b.cd_pessoa_fisica,
								b.nr_seq_portabilidade, 
								b.nr_seq_motivo_inclusao
							from	pls_segurado_canal_compl a,
								pls_segurado b
							where	b.nr_sequencia = a.nr_seq_segurado
							and	b.dt_cancelamento is null
							and	a.nr_seq_vendedor_canal <> :nr_seq_canal_venda
							and	exists (select	1
									from	pls_equipe_vend_vinculo	x
									where	x.nr_seq_equipe		= :nr_seq_equipe
									and	x.nr_seq_vendedor	= a.nr_seq_vendedor_canal)) a,
							pls_mensalidade_segurado x,
							pls_mensalidade y,
							titulo_receber t,
							pls_contrato c 
						where 	c.nr_sequencia = a.nr_seq_contrato
						and	a.nr_seq_segurado = x.nr_seq_segurado
						and	y.nr_sequencia = x.nr_seq_mensalidade
						and	y.nr_sequencia = t.nr_seq_mensalidade
						and	y.ie_cancelamento is null ' || current_setting('pls_comissao_equipe_pck.ds_restricao_parametros_w')::varchar(4000), false);

		current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_canal_venda', r_c01_w.nr_seq_canal_venda, current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind);
		current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_equipe', r_c01_w.nr_seq_equipe, current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind);		
		current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':dt_referencia_inicio', dt_referencia_p, current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind);
		current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':dt_referencia_fim', current_setting('pls_comissao_equipe_pck.dt_referencia_fim_w')::timestamp, current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind);

		if (r_c02_w.nr_seq_plano IS NOT NULL AND r_c02_w.nr_seq_plano::text <> '') then
			if (r_c02_w.ie_meta_plano  = 'S') then
				PERFORM set_config('pls_comissao_equipe_pck.ds_sql_w', current_setting('pls_comissao_equipe_pck.ds_sql_w')::varchar(32000) || ' and	exists (select	1
									from	pls_sca_vinculo x
									where	x.dt_liberacao is not null
									and	x.nr_seq_segurado = a.nr_seq_segurado
									and	x.nr_seq_plano = :nr_seq_plano)', false);
			else
				PERFORM set_config('pls_comissao_equipe_pck.ds_sql_w', current_setting('pls_comissao_equipe_pck.ds_sql_w')::varchar(32000) || ' and	a.nr_seq_plano = :nr_seq_plano ', false);
			end if;
			
			current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_plano', r_c02_w.nr_seq_plano, current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind);
		end if;
		
		if (r_c02_w.ie_tipo_contrato = 'PF') then
			PERFORM set_config('pls_comissao_equipe_pck.ds_sql_w', current_setting('pls_comissao_equipe_pck.ds_sql_w')::varchar(32000) || ' and	c.cd_pf_estipulante is not null ', false);
		elsif (r_c02_w.ie_tipo_contrato = 'PJ') then
			PERFORM set_config('pls_comissao_equipe_pck.ds_sql_w', current_setting('pls_comissao_equipe_pck.ds_sql_w')::varchar(32000) || ' and	c.cd_cgc_estipulante is not null ', false);
		end if;
		
		if (r_c02_w.nr_seq_grupo_produto IS NOT NULL AND r_c02_w.nr_seq_grupo_produto::text <> '') then
			PERFORM set_config('pls_comissao_equipe_pck.ds_sql_w', current_setting('pls_comissao_equipe_pck.ds_sql_w')::varchar(32000) || ' and	exists (select	1
								from	pls_preco_produto x
								where	x.nr_seq_plano = a.nr_seq_plano
								and	x.nr_seq_grupo = :nr_seq_grupo_produto) ', false);
			current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_grupo_produto', r_c02_w.nr_seq_grupo_produto, current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind);
		end if;
		
		current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.executa_sql_cursor(current_setting('pls_comissao_equipe_pck.ds_sql_w')::varchar(32000), current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind);

		loop
			fetch cursor_w bulk collect into 	tb_nr_seq_segurado_w, tb_nr_seq_vendedor_canal_w, tb_ie_acao_contrato_w,
								tb_ie_tipo_vendedor_benef_w, current_setting('pls_comissao_equipe_pck.tb_nr_seq_mensalidade_seg_w')::pls_util_cta_pck.t_number_table, tb_nr_titulo_w,
								tb_nr_seq_vendedor_pf_w, current_setting('pls_comissao_equipe_pck.tb_nr_proposta_adesao_w')::pls_util_cta_pck.t_number_table, current_setting('pls_comissao_equipe_pck.tb_cd_pessoa_fisica_w')::pls_util_cta_pck.t_varchar2_table_10,
								tb_qt_idade_w, tb_dt_contrato_w, tb_nr_seq_tipo_comissao_w,
								tb_nr_seq_portabilidade_w, tb_nr_seq_motivo_inclusao_w, tb_dt_contratacao_w,
								tb_nr_seq_grupo_w, tb_nr_seq_contrato_w
			limit pls_util_pck.qt_registro_transacao_w;
			exit when tb_nr_seq_segurado_w.count = 0;
			
			for i in tb_nr_seq_segurado_w.first .. tb_nr_seq_segurado_w.last loop
				begin
				qt_vidas_meta_w	:= 0;
				
				if (r_c02_w.ie_tipo_meta_vidas = 'C') then
					qt_vidas_meta_w	:= pls_obter_quantidade_vidas(tb_nr_seq_segurado_w(i),'T','C');
				elsif (r_c02_w.ie_tipo_meta_vidas = 'G') then
					if ((tb_nr_seq_grupo_w(i) IS NOT NULL AND (tb_nr_seq_grupo_w(i))::text <> '')) then
						qt_vidas_meta_w	:= pls_obter_qt_vidas_grupo_relac(tb_nr_seq_grupo_w(i), current_setting('pls_comissao_equipe_pck.dt_referencia_fim_w')::timestamp);
					end if;
				end if;

				if	((coalesce(r_c02_w.ie_acao_contrato::text, '') = '') or (pls_obter_se_item_lista(r_c02_w.ie_acao_contrato, tb_ie_acao_contrato_w(i)) = 'S')) and (qt_vidas_meta_w between coalesce(r_c02_w.qt_vidas_inicial, qt_vidas_meta_w) and coalesce(r_c02_w.qt_vidas_final, qt_vidas_meta_w)) then
					insert	into	pls_comissao_equipe_temp(	nr_seq_segurado, nr_seq_canal_venda, nr_seq_meta,
							nr_seq_comissao, ie_tipo_vendedor_benef, nr_seq_mensalidade_seg,
							nr_titulo, nr_seq_vendedor_pf, nr_proposta_adesao,
							cd_pessoa_fisica, ie_recebe_comissao, ie_acao_contrato,
							qt_idade, nr_seq_portabilidade, nr_seq_motivo_inclusao,
							nr_seq_tipo_comissao, dt_contratacao, dt_contrato,
							nr_seq_equipe)
					values (	tb_nr_seq_segurado_w(i), tb_nr_seq_vendedor_canal_w(i), r_c02_w.nr_sequencia,
							r_c01_w.nr_sequencia, tb_ie_tipo_vendedor_benef_w(i), current_setting('pls_comissao_equipe_pck.tb_nr_seq_mensalidade_seg_w')::pls_util_cta_pck.t_number_table(i),
							tb_nr_titulo_w(i), tb_nr_seq_vendedor_pf_w(i), current_setting('pls_comissao_equipe_pck.tb_nr_proposta_adesao_w')::pls_util_cta_pck.t_number_table(i),
							current_setting('pls_comissao_equipe_pck.tb_cd_pessoa_fisica_w')::pls_util_cta_pck.t_varchar2_table_10(i), r_c01_w.ie_recebe_comissao, tb_ie_acao_contrato_w(i),
							tb_qt_idade_w(i), tb_nr_seq_portabilidade_w(i), tb_nr_seq_motivo_inclusao_w(i),
							tb_nr_seq_tipo_comissao_w(i), tb_dt_contratacao_w(i), tb_dt_contrato_w(i),
							r_c01_w.nr_seq_equipe);
				end if;
				end;
			end loop;
		end loop;

		close cursor_w;
	
		end;
	end loop;
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_comissao_equipe_pck.inserir_beneficiario_vendedor ( nr_seq_lote_comissao_p pls_lote_comissao.nr_sequencia%type, dt_referencia_p pls_lote_comissao.dt_referencia%type) FROM PUBLIC;
