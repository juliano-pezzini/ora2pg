-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_comissao_equipe_pck.inserir_estorno () AS $body$
DECLARE


current_setting('pls_comissao_equipe_pck.c01')::CURSOR CURSOR(	nr_seq_comissao_benef_pc	pls_comissao_beneficiario.nr_sequencia%type) FOR
	SELECT	ie_tipo_item,
		vl_item_mensalidade,
		tx_comissao,
		vl_premio,
		vl_incremento,
		(vl_comissao*-1) vl_comissao,
		nr_seq_plano,
		nr_seq_plano_sca,
		nr_seq_bonificacao,
		nr_seq_regra,
		nr_seq_regra_equipe
	from	pls_comissao_benef_item
	where	nr_seq_comissao_benef = nr_seq_comissao_benef_pc;
BEGIN
if (tb_nr_seq_comi_benef_estorno_w.count > 0) then
	forall i in tb_nr_seq_comi_benef_estorno_w.first..tb_nr_seq_comi_benef_estorno_w.last
		insert into pls_comissao_beneficiario(nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_comissao,
			nr_seq_segurado_mens, nr_seq_segurado, vl_comissao_benef, 
			vl_origem, vl_estorno, nr_seq_comissao_benef, 
			nr_seq_vendedor, vl_incremento, nr_titulo,
			nr_seq_regra_mensal, nr_seq_vendedor_pf, nr_seq_proposta, 
			cd_pessoa_fisica)
		values (nextval('pls_comissao_beneficiario_seq'), clock_timestamp(), nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, tb_nr_seq_comissao_estorno_w(i), 
			tb_nr_seq_seg_mens_estorno_w(i), tb_nr_seq_segurado_estorno_w(i), 0, 
			0, tb_vl_estorno_w(i), tb_nr_seq_comi_benef_estorno_w(i), 
			tb_nr_seq_vendedor_estorno_w(i), current_setting('pls_comissao_equipe_pck.tb_vl_incremento_estorno_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_comissao_equipe_pck.tb_nr_titulo_estorno_w')::pls_util_cta_pck.t_number_table(i),
			current_setting('pls_comissao_equipe_pck.tb_nr_seq_reg_mensal_estorno_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_comissao_equipe_pck.tb_nr_seq_vended_pf_estorno_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_comissao_equipe_pck.tb_nr_seq_proposta_estorno_w')::pls_util_cta_pck.t_number_table(i), 
			current_setting('pls_comissao_equipe_pck.tb_cd_pessoa_fisica_estorno_w')::pls_util_cta_pck.t_varchar2_table_10(i))
		returning 
			nr_sequencia, tb_nr_seq_comi_benef_estorno_w(i), current_setting('pls_comissao_equipe_pck.tb_nr_seq_estorno_comissao_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_comissao_equipe_pck.tb_tx_estorno_w')::pls_util_cta_pck.t_number_table(i)
		bulk collect into 
			current_setting('pls_comissao_equipe_pck.tb_nr_seq_comissao_benef_wr')::pls_util_cta_pck.t_number_table, current_setting('pls_comissao_equipe_pck.tb_nr_seq_comissao_benef_es_wr')::pls_util_cta_pck.t_number_table, current_setting('pls_comissao_equipe_pck.tb_nr_seq_estorno_comissao_wr')::pls_util_cta_pck.t_number_table, current_setting('pls_comissao_equipe_pck.tb_tx_estorno_wr')::pls_util_cta_pck.t_number_table;
	commit;

	for i in current_setting('pls_comissao_equipe_pck.tb_nr_seq_comissao_benef_wr')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_comissao_benef_wr.last loop
		begin
		update	pls_estorno_comissao
		set	nr_seq_comissao_benef = current_setting('pls_comissao_equipe_pck.tb_nr_seq_comissao_benef_wr')::pls_util_cta_pck.t_number_table(i)
		where	nr_sequencia = current_setting('pls_comissao_equipe_pck.tb_nr_seq_estorno_comissao_wr')::pls_util_cta_pck.t_number_table(i);
		
		for r_c01_w in current_setting('pls_comissao_equipe_pck.c01')::CURSOR(current_setting('pls_comissao_equipe_pck.tb_nr_seq_comissao_benef_es_wr')::pls_util_cta_pck.t_number_table(i)) loop
			begin
			insert into pls_comissao_benef_item(nr_sequencia, nr_seq_comissao_benef, ie_tipo_item,
				vl_item_mensalidade, tx_comissao, vl_premio, 
				vl_incremento, vl_comissao, vl_origem, 
				nr_seq_plano, nr_seq_plano_sca, nr_seq_bonificacao, 
				dt_atualizacao, nm_usuario, dt_atualizacao_nrec, 
				nm_usuario_nrec, nr_seq_regra, nr_seq_regra_equipe,
				vl_lanc_adic_item)
			values	(nextval('pls_comissao_benef_item_seq'), current_setting('pls_comissao_equipe_pck.tb_nr_seq_comissao_benef_wr')::pls_util_cta_pck.t_number_table(i), r_c01_w.ie_tipo_item, 
				r_c01_w.vl_item_mensalidade, r_c01_w.tx_comissao, r_c01_w.vl_premio, 
				r_c01_w.vl_incremento, ((r_c01_w.vl_comissao*current_setting('pls_comissao_equipe_pck.tb_tx_estorno_wr')::pls_util_cta_pck.t_number_table(i))/100), r_c01_w.vl_comissao, 
				r_c01_w.nr_seq_plano, r_c01_w.nr_seq_plano_sca, r_c01_w.nr_seq_bonificacao, 
				clock_timestamp(), nm_usuario_p, clock_timestamp(), 
				nm_usuario_p, r_c01_w.nr_seq_regra, r_c01_w.nr_seq_regra_equipe,
				0);
			end;
		end loop;
		end;
	end loop;

	CALL pls_comissao_equipe_pck.limpar_vetor_estorno();
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_comissao_equipe_pck.inserir_estorno () FROM PUBLIC;
