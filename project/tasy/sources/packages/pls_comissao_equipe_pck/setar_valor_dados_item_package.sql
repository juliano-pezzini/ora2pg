-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_comissao_equipe_pck.setar_valor_dados_item ( ie_tipo_item_p pls_mensalidade_seg_item.ie_tipo_item%type, nr_seq_vinculo_sca_p pls_sca_vinculo.nr_sequencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, nr_parcela_p pls_mensalidade_segurado.nr_parcela%type, vl_item_p pls_mensalidade_seg_item.vl_item%type, nr_seq_segurado_preco_origem_p pls_segurado_preco_origem.nr_sequencia%type, nr_seq_segurado_preco_p pls_segurado_preco.nr_sequencia%type, nr_seq_bonificacao_vinculo_p pls_bonificacao_vinculo.nr_sequencia%type) AS $body$
DECLARE


ie_lancamento_mensalidade_w	pls_sca_vinculo.ie_lancamento_mensalidade%type;


BEGIN
PERFORM set_config('pls_comissao_equipe_pck.nr_seq_plano_w', null, false);
PERFORM set_config('pls_comissao_equipe_pck.nr_seq_plano_sca_w', null, false);
PERFORM set_config('pls_comissao_equipe_pck.nr_seq_bonificacao_w', null, false);
PERFORM set_config('pls_comissao_equipe_pck.vl_item_w', null, false);
PERFORM set_config('pls_comissao_equipe_pck.ie_sca_embutido_w', 'N', false);

if (ie_tipo_item_p in ('1','12','15')) then
	if	((nr_seq_vinculo_sca_p IS NOT NULL AND nr_seq_vinculo_sca_p::text <> '') or (ie_tipo_item_p = '15')) then
		select	max(nr_seq_plano),
			max(ie_lancamento_mensalidade)
		into STRICT	current_setting('pls_comissao_equipe_pck.nr_seq_plano_sca_w')::pls_plano.nr_sequencia%type,
			ie_lancamento_mensalidade_w
		from	pls_sca_vinculo
		where	nr_sequencia = nr_seq_vinculo_sca_p;
		
		if	(ie_lancamento_mensalidade_w = 'C' AND ie_tipo_item_p = '1') then
			PERFORM set_config('pls_comissao_equipe_pck.ie_sca_embutido_w', 'S', false);
		end if;
	else
		PERFORM set_config('pls_comissao_equipe_pck.nr_seq_plano_w', nr_seq_plano_p, false);
	end if;
		
	if	((current_setting('pls_comissao_equipe_pck.ie_vl_integral_1_parcela_w')::pls_equipe_meta_comissao.ie_vl_integral_1_parcela%type = 'S') and (nr_parcela_p = 1)) then
		if	((ie_tipo_item_p = '15') or (current_setting('pls_comissao_equipe_pck.ie_sca_embutido_w')::varchar(1) = 'S')) then
			select	coalesce(vl_preco_atual,0)
			into STRICT	current_setting('pls_comissao_equipe_pck.vl_item_w')::pls_mensalidade_seg_item.vl_item%type
			from	pls_segurado_preco_origem
			where	nr_sequencia = nr_seq_segurado_preco_origem_p;
		elsif (ie_tipo_item_p in ('1','12')) then
			select	coalesce(vl_preco_atual,0) - coalesce(vl_desconto,0)
			into STRICT	current_setting('pls_comissao_equipe_pck.vl_item_w')::pls_mensalidade_seg_item.vl_item%type
			from	pls_segurado_preco
			where	nr_sequencia = nr_seq_segurado_preco_p;
		end if;
	end if;
elsif (ie_tipo_item_p = '14') then
	select	max(nr_seq_bonificacao)
	into STRICT	current_setting('pls_comissao_equipe_pck.nr_seq_bonificacao_w')::pls_bonificacao.nr_sequencia%type
	from	pls_bonificacao_vinculo
	where	nr_sequencia = nr_seq_bonificacao_vinculo_p;
end if;

if (current_setting('pls_comissao_equipe_pck.vl_item_w')::pls_mensalidade_seg_item.vl_item%coalesce(type::text, '') = '') then
	PERFORM set_config('pls_comissao_equipe_pck.vl_item_w', vl_item_p, false);
end if;

PERFORM set_config('pls_comissao_equipe_pck.vl_comissao_venda_w', ((current_setting('pls_comissao_equipe_pck.pr_comissao_w')::pls_equipe_meta_comissao.pr_comissao%type * current_setting('pls_comissao_equipe_pck.vl_item_w')::pls_mensalidade_seg_item.vl_item%type) / 100) + current_setting('pls_comissao_equipe_pck.vl_comissao_w')::pls_equipe_meta_comissao.vl_comissao%type, false);
PERFORM set_config('pls_comissao_equipe_pck.vl_origem_w', current_setting('pls_comissao_equipe_pck.vl_comissao_venda_w')::pls_comissao_benef_item.vl_comissao%type, false);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_comissao_equipe_pck.setar_valor_dados_item ( ie_tipo_item_p pls_mensalidade_seg_item.ie_tipo_item%type, nr_seq_vinculo_sca_p pls_sca_vinculo.nr_sequencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, nr_parcela_p pls_mensalidade_segurado.nr_parcela%type, vl_item_p pls_mensalidade_seg_item.vl_item%type, nr_seq_segurado_preco_origem_p pls_segurado_preco_origem.nr_sequencia%type, nr_seq_segurado_preco_p pls_segurado_preco.nr_sequencia%type, nr_seq_bonificacao_vinculo_p pls_bonificacao_vinculo.nr_sequencia%type) FROM PUBLIC;
