-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_comissao_equipe_pck.inserir_lancamento ( ie_descarregar_vetor_p text) AS $body$
BEGIN

if	((ie_descarregar_vetor_p = 'S') or (current_setting('pls_comissao_equipe_pck.nr_indice_lanc_w')::integer >= pls_util_pck.qt_registro_transacao_w)) then
	if (tb_nr_seq_lancamento_vend_w.count > 0) then
		forall i in tb_nr_seq_lancamento_vend_w.first..tb_nr_seq_lancamento_vend_w.last
			insert into pls_repasse_lanc(nr_sequencia, nr_seq_comissao, vl_lancamento,
				vl_lanc_aplicado, dt_atualizacao, nm_usuario, 
				dt_atualizacao_nrec, nm_usuario_nrec, ie_tipo_lancamento,
				nr_seq_lancamento_vend, nr_titulo, ds_observacao)
			values (nextval('pls_repasse_lanc_seq'), tb_nr_seq_comissao_lanc_w(i), tb_vl_lancamento_w(i), 
				tb_vl_lanc_aplicado_w(i), clock_timestamp(), nm_usuario_p, 
				clock_timestamp(), nm_usuario_p, current_setting('pls_comissao_equipe_pck.tb_ie_tipo_lancamento_w')::pls_util_cta_pck.t_varchar2_table_1(i),
				tb_nr_seq_lancamento_vend_w(i), current_setting('pls_comissao_equipe_pck.tb_nr_titulo_lanc_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_comissao_equipe_pck.tb_ds_observacao_lanc_w')::pls_util_cta_pck.t_varchar2_table_4000(i))
		returning 	nr_seq_comissao, nr_seq_lancamento_vend
		bulk collect into 
				current_setting('pls_comissao_equipe_pck.tb_nr_seq_comissao_lanc_adc_wr')::pls_util_cta_pck.t_number_table, current_setting('pls_comissao_equipe_pck.tb_nr_seq_lancamento_vend_wr')::pls_util_cta_pck.t_number_table;
		commit;
	end if;
	
	forall i in current_setting('pls_comissao_equipe_pck.tb_nr_seq_comissao_lanc_adc_wr')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_comissao_lanc_adc_wr.last
		update	pls_vendedor_lanc
		set	nr_seq_comissao = current_setting('pls_comissao_equipe_pck.tb_nr_seq_comissao_lanc_adc_wr')::pls_util_cta_pck.t_number_table(i)
		where	nr_sequencia = current_setting('pls_comissao_equipe_pck.tb_nr_seq_lancamento_vend_wr')::pls_util_cta_pck.t_number_table(i);
	commit;
	
	CALL pls_comissao_equipe_pck.limpar_vetor_lanc();
else
	PERFORM set_config('pls_comissao_equipe_pck.nr_indice_lanc_w', current_setting('pls_comissao_equipe_pck.nr_indice_lanc_w')::integer + 1, false);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_comissao_equipe_pck.inserir_lancamento ( ie_descarregar_vetor_p text) FROM PUBLIC;
