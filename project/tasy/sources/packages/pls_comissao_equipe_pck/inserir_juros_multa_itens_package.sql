-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_comissao_equipe_pck.inserir_juros_multa_itens ( nr_seq_lote_p pls_lote_comissao.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


qt_item_mens_w			integer;
qt_item_comissao_w		integer;
vl_total_itens_mens_w		pls_mensalidade_seg_item.vl_item%type;
vl_juros_w			titulo_receber_liq.vl_juros%type;
vl_multa_w			titulo_receber_liq.vl_multa%type;
vl_juros_item_w			titulo_receber_liq.vl_juros%type;
vl_multa_item_w			titulo_receber_liq.vl_multa%type;
vl_total_juros_w		titulo_receber_liq.vl_juros%type;
vl_total_multa_w		titulo_receber_liq.vl_multa%type;
pr_lancamento_w			double precision;


current_setting('pls_comissao_equipe_pck.c01')::CURSOR CURSOR FOR
	SELECT	nr_sequencia nr_seq_comissao
	from	pls_comissao
	where	nr_seq_lote = nr_seq_lote_p
	order by
		nr_sequencia asc;
		
current_setting('pls_comissao_equipe_pck.c02')::CURSOR( CURSOR(	nr_seq_comissao_pc	pls_comissao.nr_sequencia%type)	FOR
	SELECT	nr_titulo
	from	pls_comissao_beneficiario
	where	nr_seq_comissao = nr_seq_comissao_pc
	group by
		nr_titulo;
		
current_setting('pls_comissao_equipe_pck.c03')::CURSOR( CURSOR(	nr_titulo_pc		titulo_receber.nr_titulo%type,
		nr_seq_comissao_pc	pls_comissao.nr_sequencia%type)	FOR
	SELECT	a.vl_item_mensalidade,
		a.nr_sequencia nr_seq_comissao_item,
		a.tx_comissao,
		a.vl_incremento
	from	pls_comissao_benef_item a
	where	exists (SELECT	1
			from	pls_comissao_beneficiario x
			where	x.nr_sequencia = a.nr_seq_comissao_benef
			and	x.nr_titulo = nr_titulo_pc
			and	x.nr_seq_comissao = nr_seq_comissao_pc)
	order by
		a.vl_item_mensalidade desc;
BEGIN

for r_c01_w in current_setting('pls_comissao_equipe_pck.c01')::loop CURSOR
	begin
	for r_c02_w in current_setting('pls_comissao_equipe_pck.c02')::CURSOR( (r_c01_w.nr_seq_comissao) loop
		begin
		select	coalesce(sum(vl_juros),0),
			coalesce(sum(vl_multa),0)
		into STRICT	vl_juros_w,
			vl_multa_w
		from	titulo_receber_liq
		where	nr_titulo = r_c02_w.nr_titulo;

		if	((vl_juros_w + vl_multa_w) > 0) then
			insert into pls_repasse_lanc(nr_sequencia, nr_seq_comissao, vl_lancamento,
					vl_lanc_aplicado, ie_tipo_lancamento, dt_atualizacao, 
					nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
					nr_titulo)
				values (nextval('pls_repasse_lanc_seq'), r_c01_w.nr_seq_comissao, vl_juros_w + vl_multa_w, 
					vl_juros_w + vl_multa_w, '5', clock_timestamp(), 
					nm_usuario_p, clock_timestamp(), nm_usuario_p,
					r_c02_w.nr_titulo);

			select	count(1),
				sum(a.vl_item)
			into STRICT	qt_item_mens_w,
				vl_total_itens_mens_w
			from	pls_mensalidade_seg_item a,
				pls_mensalidade_segurado d,
				pls_mensalidade b,
				titulo_receber c
			where	d.nr_sequencia = a.nr_seq_mensalidade_seg
			and	b.nr_sequencia = d.nr_seq_mensalidade
			and	b.nr_sequencia = c.nr_seq_mensalidade
			and	c.nr_titulo = r_c02_w.nr_titulo;
			
			if (vl_total_itens_mens_w <> 0) then
				qt_item_comissao_w	:= 0;
				vl_total_juros_w	:= 0;
				vl_total_multa_w	:= 0;
				
				for r_c03_w in current_setting('pls_comissao_equipe_pck.c03')::CURSOR( (	r_c02_w.nr_titulo,
							r_c01_w.nr_seq_comissao) loop
					begin
					
					pr_lancamento_w	:= r_c03_w.vl_item_mensalidade / vl_total_itens_mens_w;
					
					qt_item_comissao_w	:= qt_item_comissao_w + 1;
					
					vl_juros_item_w	:= pr_lancamento_w * vl_juros_w;
					vl_multa_item_w	:= pr_lancamento_w * vl_multa_w;
					
					if (qt_item_comissao_w = qt_item_mens_w) then
						if	(vl_juros_w <> (vl_total_juros_w + vl_juros_item_w)) then
							vl_juros_item_w	:= vl_juros_item_w +  (vl_juros_w - (vl_total_juros_w + vl_juros_item_w));
						end if;
						
						if	(vl_multa_w <> (vl_total_multa_w + vl_multa_item_w)) then
							vl_multa_item_w	:= vl_multa_item_w +  (vl_multa_w - (vl_total_multa_w + vl_multa_item_w));
						end if;
					end if;

					update	pls_comissao_benef_item
					set	vl_juros = vl_juros_item_w,
						vl_multa = vl_multa_item_w,
						vl_comissao = (((vl_juros_item_w + vl_multa_item_w + r_c03_w.vl_item_mensalidade) * r_c03_w.tx_comissao) / 100) + r_c03_w.vl_incremento
					where	nr_sequencia = r_c03_w.nr_seq_comissao_item;
					
					vl_total_juros_w	:= vl_total_juros_w + vl_juros_item_w;
					vl_total_multa_w	:= vl_total_multa_w + vl_multa_item_w;
					end;
				end loop;
			end if;
		end if;
		end;
	end loop;
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_comissao_equipe_pck.inserir_juros_multa_itens ( nr_seq_lote_p pls_lote_comissao.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
