-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_comissao_equipe_pck.inserir_canal_inferior (nr_seq_lote_p pls_lote_comissao.nr_sequencia%type, dt_referencia_p pls_lote_comissao.dt_referencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

		
cursor_repasse_w		sql_pck.t_cursor;
		
tb_nr_seq_segurado_repasse_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_mensal_seg_repasse_w	pls_util_cta_pck.t_number_table;
tb_nr_titulo_repasse_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_vended_pf_repasse_w	pls_util_cta_pck.t_number_table;
tb_cd_pessoa_fisica_repasse_w	pls_util_cta_pck.t_varchar2_table_10;
tb_dt_contratacao_repasse_w	pls_util_cta_pck.t_date_table;
tb_dt_liquidacao_repasse_w	pls_util_cta_pck.t_date_table;
tb_nr_parcela_repasse_w		pls_util_cta_pck.t_number_table;
tb_qt_idade_repasse_w		pls_util_cta_pck.t_number_table;
tb_ie_tipo_estip_repasse_w	pls_util_cta_pck.t_varchar2_table_2;
tb_ie_acao_contrato_repasse_w	pls_util_cta_pck.t_varchar2_table_2;
tb_nr_seq_contrato_repasse_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_plano_repasse_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_seg_preco_repasse_w	pls_util_cta_pck.t_number_table;

tb_nr_seq_comissao_repasse_wr	pls_util_cta_pck.t_number_table;
tb_nr_seq_mensa_seg_repasse_wr	pls_util_cta_pck.t_number_table;
tb_nr_seq_regra_repasse_sup_wr	pls_util_cta_pck.t_number_table;
tb_dt_contratacao_repasse_wr	pls_util_cta_pck.t_date_table;
tb_dt_liquidacao_repasse_wr	pls_util_cta_pck.t_date_table;
tb_qt_idade_repasse_wr		pls_util_cta_pck.t_number_table;
tb_ie_tipo_estip_repasse_wr	pls_util_cta_pck.t_varchar2_table_2;
tb_ie_acao_contrato_repasse_wr	pls_util_cta_pck.t_varchar2_table_2;
tb_nr_seq_contrato_repasse_wr	pls_util_cta_pck.t_number_table;
tb_nr_seq_plano_repasse_wr	pls_util_cta_pck.t_number_table;
tb_nr_parcela_repasse_wr	pls_util_cta_pck.t_number_table;
tb_nr_seq_seg_preco_repasse_wr	pls_util_cta_pck.t_number_table;
tb_nr_seq_canal_venda_repas_wr	pls_util_cta_pck.t_number_table;

nr_seq_regra_repasse_w		pls_regra_repasse_sup_item.nr_sequencia%type;
dt_referencia_w			timestamp;

current_setting('pls_comissao_equipe_pck.c01')::CURSOR CURSOR FOR
	SELECT	nr_seq_equipe,
		nr_seq_canal_venda,
		nr_seq_cargo_canal,
		nr_sequencia nr_seq_comissao
	from	pls_comissao
	where	nr_seq_lote = nr_seq_lote_p
	and	(nr_seq_cargo_canal IS NOT NULL AND nr_seq_cargo_canal::text <> '');
	
current_setting('pls_comissao_equipe_pck.c02')::CURSOR( CURSOR(	nr_seq_cargo_canal_pc	pls_cargo_canal_venda.nr_sequencia%type,
		nr_seq_equipe_pc	pls_equipe_vendedor.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_regra_superior,
		nr_seq_cargo_canal_venda
	from	pls_regra_repasse_superior
	where	nr_seq_cargo_canal_repasse = nr_seq_cargo_canal_pc
	and	nr_seq_equipe = nr_seq_equipe_pc
	and	ie_situacao = 'A';WITH RECURSIVE cte AS (

	
current_setting('pls_comissao_equipe_pck.c03')::CURSOR( CURSOR(	nr_seq_cargo_canal_venda_pc pls_cargo_canal_venda.nr_sequencia%type,
		nr_seq_equipe_pc	pls_equipe_vendedor.nr_sequencia%type,
		nr_seq_canal_venda_pc	pls_vendedor.nr_sequencia%type) FOR
	SELECT	nr_seq_vendedor
	from	pls_equipe_vend_vinculo WHERE nr_seq_vendedor = nr_seq_canal_venda_pc
  UNION ALL

	
current_setting('pls_comissao_equipe_pck.c03')::CURSOR( CURSOR(	nr_seq_cargo_canal_venda_pc pls_cargo_canal_venda.nr_sequencia%type,
		nr_seq_equipe_pc	pls_equipe_vendedor.nr_sequencia%type,
		nr_seq_canal_venda_pc	pls_vendedor.nr_sequencia%type) FOR
	SELECT	nr_seq_vendedor
	from	pls_equipe_vend_vinculo JOIN cte c ON (c.prior
		nr_seq_vendedor = nr_seq_canal_superior)

) SELECT * FROM cte WHERE nr_seq_equipe		= nr_seq_equipe_pc
	and	nr_seq_cargo_canal	= nr_seq_cargo_canal_venda_pc
	and	dt_referencia_p between coalesce(dt_inicio_vigencia, dt_referencia_p) and coalesce(dt_fim_vigencia, dt_referencia_p);
;
	
current_setting('pls_comissao_equipe_pck.c04')::CURSOR CURSOR(	nr_seq_mensalidade_seg_pc	pls_mensalidade_segurado.nr_sequencia%type,
		nr_seq_canal_venda_pc		pls_vendedor.nr_sequencia%type) FOR
	SELECT	a.vl_item,
		a.ie_tipo_item,
		a.nr_sequencia nr_seq_item_mens,
		a.nr_seq_bonificacao_vinculo,
		b.nr_seq_vinculo_sca,
		b.nr_seq_segurado_preco nr_seq_segurado_preco_origem
	FROM pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_mensalidade_sca b ON (a.nr_sequencia = b.nr_seq_item_mens)
WHERE a.nr_seq_mensalidade_seg = nr_seq_mensalidade_seg_pc  and not exists (	SELECT	1
				from	pls_comissao_benef_item x,
					pls_comissao_beneficiario y,
					pls_comissao z
				where	z.nr_sequencia = y.nr_seq_comissao
				and	y.nr_sequencia = x.nr_seq_comissao_benef
				and	a.nr_sequencia = x.nr_seq_item_mens
				and	coalesce(z.ie_cancelado::text, '') = ''
				and	coalesce(y.nr_seq_meta_atingir::text, '') = ''
				and	z.nr_seq_canal_venda = nr_seq_canal_venda_pc);
	
current_setting('pls_comissao_equipe_pck.c05')::CURSOR( CURSOR(	nr_seq_regra_repasse_sup_pc	pls_regra_repasse_superior.nr_sequencia%type,
		dt_referencia_pc		timestamp,
		nr_parcela_pc			pls_mensalidade_segurado.nr_parcela%type,
		qt_idade_pc			bigint) FOR
	SELECT	nr_sequencia nr_seq_regra_repasse,
		tx_repasse,
		coalesce(vl_repasse,0) vl_repasse,
		ie_vl_integral_1_parcela,
		ie_acao_contrato,
		coalesce(ie_tipo_estipulante, 'A') ie_tipo_estipulante,
		nr_seq_contrato,
		ie_tipo_item_mensalidade
	from	pls_regra_repasse_sup_item
	where	nr_seq_regra	= nr_seq_regra_repasse_sup_pc
	and	dt_referencia_p between dt_referencia_p and current_setting('pls_comissao_equipe_pck.dt_referencia_fim_w')::timestamp
	and	nr_parcela_pc between coalesce(nr_parcela_inicial,nr_parcela_pc) and coalesce(nr_parcela_final,nr_parcela_pc)
	and	qt_idade_pc between coalesce(qt_idade_inicial,qt_idade_pc) and coalesce(qt_idade_final,qt_idade_pc)
	order by
		coalesce(ie_tipo_estipulante,'A'),
		coalesce(ie_acao_contrato,' '),
		coalesce(nr_contrato,0),
		coalesce(ie_tipo_item_mensalidade,' ');
	
BEGIN

limpar_vetor_itens;

for r_c01_w in current_setting('pls_comissao_equipe_pck.c01')::loop CURSOR
	begin
	for r_c02_w in current_setting('pls_comissao_equipe_pck.c02')::CURSOR( (	r_c01_w.nr_seq_cargo_canal,
				r_c01_w.nr_seq_equipe) loop
		begin
		for r_c03_w in current_setting('pls_comissao_equipe_pck.c03')::CURSOR( (	r_c02_w.nr_seq_cargo_canal_venda,
					r_c01_w.nr_seq_equipe,
					r_c01_w.nr_seq_canal_venda) loop
			begin
			current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind.delete;
			PERFORM set_config('pls_comissao_equipe_pck.ds_sql_w', '	select	a.nr_sequencia,
							b.nr_sequencia,
							t.nr_titulo,
							a.cd_pessoa_fisica,
							a.nr_seq_vendedor_pf,
							a.dt_contratacao,
							t.dt_liquidacao,
							b.nr_parcela,
							obter_idade_pf(b.dt_mesano_referencia, sysdate, ''A'') qt_idade,
							decode(e.cd_pf_estipulante, null, ''PJ'', ''PF'') ie_tipo_estipulante,
							e.nr_sequencia,
							a.ie_acao_contrato,
							b.nr_seq_plano,
							b.nr_seq_segurado_preco
						from	pls_segurado a,
							pls_mensalidade_segurado b,
							pls_mensalidade c,
							titulo_receber t,
							pls_contrato e
						where	a.nr_sequencia = b.nr_seq_segurado
						and	e.nr_sequencia = a.nr_seq_contrato
						and	c.nr_sequencia = b.nr_seq_mensalidade
						and	c.nr_sequencia = t.nr_seq_mensalidade
						and	a.nr_seq_vendedor_canal = :nr_seq_canal_venda
						and	c.ie_cancelamento is null
						and	a.dt_cancelamento is null ' || current_setting('pls_comissao_equipe_pck.ds_restricao_parametros_w')::varchar(4000), false);
						
			current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':nr_seq_canal_venda', r_c03_w.nr_seq_vendedor, current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind);
			current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':dt_referencia_inicio', dt_referencia_p, current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind);
			current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':dt_referencia_fim', current_setting('pls_comissao_equipe_pck.dt_referencia_fim_w')::timestamp, current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind);

			current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind := sql_pck.executa_sql_cursor(current_setting('pls_comissao_equipe_pck.ds_sql_w')::varchar(32000), current_setting('pls_comissao_equipe_pck.valor_bind_w')::sql_pck.t_dado_bind);

			loop
				fetch cursor_repasse_w bulk collect into 	tb_nr_seq_segurado_repasse_w, tb_nr_seq_mensal_seg_repasse_w, tb_nr_titulo_repasse_w,
										tb_cd_pessoa_fisica_repasse_w, tb_nr_seq_vended_pf_repasse_w, tb_dt_contratacao_repasse_w, 
										tb_dt_liquidacao_repasse_w, tb_nr_parcela_repasse_w, tb_qt_idade_repasse_w,
										tb_ie_tipo_estip_repasse_w, tb_nr_seq_contrato_repasse_w, tb_ie_acao_contrato_repasse_w,
										tb_nr_seq_plano_repasse_w, tb_nr_seq_seg_preco_repasse_w
				limit pls_util_pck.qt_registro_transacao_w;
				exit when tb_nr_seq_mensal_seg_repasse_w.count = 0;
				
				forall i in tb_nr_seq_mensal_seg_repasse_w.first..tb_nr_seq_mensal_seg_repasse_w.last
					insert	into	pls_comissao_beneficiario(	nr_sequencia, nr_seq_comissao, nr_seq_segurado_mens,
							nr_seq_segurado, dt_atualizacao, nm_usuario,
							dt_atualizacao_nrec, nm_usuario_nrec, nr_titulo,
							nr_seq_vendedor_pf, cd_pessoa_fisica)
						values (	nextval('pls_comissao_beneficiario_seq'), r_c01_w.nr_seq_comissao, tb_nr_seq_mensal_seg_repasse_w(i),
							tb_nr_seq_segurado_repasse_w(i), clock_timestamp(), nm_usuario_p,
							clock_timestamp(), nm_usuario_p, tb_nr_titulo_repasse_w(i),
							tb_nr_seq_vended_pf_repasse_w(i), tb_cd_pessoa_fisica_repasse_w(i))
					returning 	nr_sequencia, tb_nr_seq_mensal_seg_repasse_w(i), r_c02_w.nr_seq_regra_superior,
							tb_dt_contratacao_repasse_w(i), tb_dt_liquidacao_repasse_w(i), tb_nr_parcela_repasse_w(i),
							tb_qt_idade_repasse_w(i), tb_ie_tipo_estip_repasse_w(i), tb_nr_seq_contrato_repasse_w(i), 
							tb_ie_acao_contrato_repasse_w(i), tb_nr_seq_plano_repasse_w(i), tb_nr_seq_seg_preco_repasse_w(i),
							r_c01_w.nr_seq_canal_venda
					bulk collect into 
							tb_nr_seq_comissao_repasse_wr, tb_nr_seq_mensa_seg_repasse_wr, tb_nr_seq_regra_repasse_sup_wr,
							tb_dt_contratacao_repasse_wr, tb_dt_liquidacao_repasse_wr, tb_nr_parcela_repasse_wr,
							tb_qt_idade_repasse_wr, tb_ie_tipo_estip_repasse_wr, tb_nr_seq_contrato_repasse_wr, 
							tb_ie_acao_contrato_repasse_wr, tb_nr_seq_plano_repasse_wr, tb_nr_seq_seg_preco_repasse_wr,
							tb_nr_seq_canal_venda_repas_wr;
				commit;

				for i in tb_nr_seq_comissao_repasse_wr.first..tb_nr_seq_comissao_repasse_wr.last loop
					begin
					for r_c04_w in current_setting('pls_comissao_equipe_pck.c04')::CURSOR(	tb_nr_seq_mensa_seg_repasse_wr(i),
								tb_nr_seq_canal_venda_repas_wr(i)) loop
						begin
						nr_seq_regra_repasse_w 	:= null;
						
						if (current_setting('pls_comissao_equipe_pck.ie_dt_ref_comissao_equipe_w')::pls_parametros.ie_dt_ref_comissao_equipe%type = 'L') then
							dt_referencia_w	:= tb_dt_liquidacao_repasse_wr(i);
						else
							dt_referencia_w	:= tb_dt_contratacao_repasse_wr(i);
						end if;

						for r_c05_w in current_setting('pls_comissao_equipe_pck.c05')::CURSOR( (	tb_nr_seq_regra_repasse_sup_wr(i),
									dt_referencia_w,
									tb_nr_parcela_repasse_wr(i),
									tb_qt_idade_repasse_wr(i)) loop
							begin
							if	((r_c05_w.ie_tipo_estipulante = 'A') or (tb_ie_tipo_estip_repasse_wr(i) = r_c05_w.ie_tipo_estipulante)) and
								((coalesce(r_c05_w.nr_seq_contrato::text, '') = '') or (tb_nr_seq_contrato_repasse_wr(i) = r_c05_w.nr_seq_contrato)) and
								((coalesce(r_c05_w.ie_acao_contrato::text, '') = '') or (tb_ie_acao_contrato_repasse_wr(i) = r_c05_w.ie_acao_contrato)) and
								((coalesce(r_c05_w.ie_tipo_item_mensalidade::text, '') = '') or (pls_obter_se_item_lista(r_c05_w.ie_tipo_item_mensalidade, r_c04_w.ie_tipo_item) = 'S')) then
								nr_seq_regra_repasse_w	:= r_c05_w.nr_seq_regra_repasse;
								PERFORM set_config('pls_comissao_equipe_pck.pr_comissao_w', r_c05_w.tx_repasse, false);
								PERFORM set_config('pls_comissao_equipe_pck.vl_comissao_w', r_c05_w.vl_repasse, false);
								PERFORM set_config('pls_comissao_equipe_pck.ie_vl_integral_1_parcela_w', r_c05_w.ie_vl_integral_1_parcela, false);
							end if;
							end;
						end loop;
						
						if (nr_seq_regra_repasse_w IS NOT NULL AND nr_seq_regra_repasse_w::text <> '') then
							CALL pls_comissao_equipe_pck.setar_valor_dados_item(	r_c04_w.ie_tipo_item, r_c04_w.nr_seq_vinculo_sca, tb_nr_seq_plano_repasse_wr(i),
										tb_nr_parcela_repasse_wr(i), r_c04_w.vl_item, r_c04_w.nr_seq_segurado_preco_origem,
										tb_nr_seq_seg_preco_repasse_wr(i), r_c04_w.nr_seq_bonificacao_vinculo);

							current_setting('pls_comissao_equipe_pck.tb_nr_seq_comissao_benef_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)	:= tb_nr_seq_comissao_repasse_wr(i);
							current_setting('pls_comissao_equipe_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_2(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)		:= r_c04_w.ie_tipo_item;
							current_setting('pls_comissao_equipe_pck.tb_nr_seq_item_mens_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)	:= r_c04_w.nr_seq_item_mens;
							current_setting('pls_comissao_equipe_pck.tb_pr_comissao_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)		:= current_setting('pls_comissao_equipe_pck.pr_comissao_w')::pls_equipe_meta_comissao.pr_comissao%type;
							current_setting('pls_comissao_equipe_pck.tb_nr_seq_regra_meta_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)	:= null;
							current_setting('pls_comissao_equipe_pck.tb_vl_comissao_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)		:= current_setting('pls_comissao_equipe_pck.vl_comissao_w')::pls_equipe_meta_comissao.vl_comissao%type;
							current_setting('pls_comissao_equipe_pck.tb_nr_seq_plano_item_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)	:= current_setting('pls_comissao_equipe_pck.nr_seq_plano_w')::pls_plano.nr_sequencia%type;
							current_setting('pls_comissao_equipe_pck.tb_nr_seq_sca_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)		:= current_setting('pls_comissao_equipe_pck.nr_seq_plano_sca_w')::pls_plano.nr_sequencia%type;
							current_setting('pls_comissao_equipe_pck.tb_nr_seq_bonificacao_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)	:= current_setting('pls_comissao_equipe_pck.nr_seq_bonificacao_w')::pls_bonificacao.nr_sequencia%type;
							current_setting('pls_comissao_equipe_pck.tb_vl_item_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)		:= current_setting('pls_comissao_equipe_pck.vl_item_w')::pls_mensalidade_seg_item.vl_item%type;
							current_setting('pls_comissao_equipe_pck.tb_ie_sca_embutido_w')::pls_util_cta_pck.t_varchar2_table_1(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)	:= current_setting('pls_comissao_equipe_pck.ie_sca_embutido_w')::varchar(1);
							current_setting('pls_comissao_equipe_pck.tb_vl_origem_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)		:= current_setting('pls_comissao_equipe_pck.vl_origem_w')::pls_comissao_benef_item.vl_origem%type;
							current_setting('pls_comissao_equipe_pck.tb_vl_comissao_venda_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer)	:= current_setting('pls_comissao_equipe_pck.vl_comissao_venda_w')::pls_comissao_benef_item.vl_comissao%type;
							current_setting('pls_comissao_equipe_pck.tb_nr_seq_regra_equipe_sup_w')::pls_util_cta_pck.t_number_table(current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer) := nr_seq_regra_repasse_w;

							if (current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer >= pls_util_pck.qt_registro_transacao_w) then
								CALL pls_comissao_equipe_pck.inserir_dados_comissao_itens(nm_usuario_p);
							else
								PERFORM set_config('pls_comissao_equipe_pck.nr_indice_itens_comissao_w', current_setting('pls_comissao_equipe_pck.nr_indice_itens_comissao_w')::integer + 1, false);
							end if;
						end if;
						end;
					end loop;
					end;
				end loop;			
			end loop;

			close cursor_repasse_w;
			
			end;
		end loop;
		end;
	end loop;
	end;
end loop;

CALL pls_comissao_equipe_pck.inserir_dados_comissao_itens(nm_usuario_p);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_comissao_equipe_pck.inserir_canal_inferior (nr_seq_lote_p pls_lote_comissao.nr_sequencia%type, dt_referencia_p pls_lote_comissao.dt_referencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
