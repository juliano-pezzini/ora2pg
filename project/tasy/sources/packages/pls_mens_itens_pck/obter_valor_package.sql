-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_mens_itens_pck.obter_valor ( nr_seq_titular_p pls_segurado.nr_sequencia%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, ie_tipo_item_p pls_mensalidade_seg_item.ie_tipo_item%type, nr_seq_centro_apropriacao_p pls_lancamento_mens_aprop.nr_seq_centro_apropriacao%type, nr_seq_tipo_lanc_p pls_tipo_lanc_adic.nr_sequencia%type, dt_mesano_referencia_p timestamp, ie_parcela_p text) RETURNS bigint AS $body$
DECLARE


vl_total_w	double precision := 0;

/*
Para obter o valor da familia deve passar o parametro nr_seq_titular_p com valor e deixar o nr_seq_segurado_p nulo.
Para obter o valor do beneficiario deve passar o parametro nr_seq_segurado_p com valor e deixar o nr_seq_titular_p nulo. 
*/


BEGIN

if (current_setting('pls_mens_itens_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.count > 0) then
	for i in current_setting('pls_mens_itens_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_segurado_w.last loop
		if (current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(i) = ie_tipo_item_p) and
			(((ie_parcela_p = 'B') and (current_setting('pls_mens_itens_pck.tb_dt_mesano_referencia_w')::pls_util_cta_pck.t_date_table(i) = dt_mesano_referencia_p)) or ((ie_parcela_p = 'P') and (current_setting('pls_mens_itens_pck.tb_dt_referencia_w')::pls_util_cta_pck.t_date_table(i) = dt_mesano_referencia_p))) and
			(((current_setting('pls_mens_itens_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_titular_p or current_setting('pls_mens_itens_pck.tb_nr_seq_titular_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_titular_p) and (coalesce(nr_seq_segurado_p::text, '') = '') and ((current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_tipo_lanc_p) or (coalesce(nr_seq_tipo_lanc_p::text, '') = ''))) or --Familia
			((current_setting('pls_mens_itens_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_segurado_p) and (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') and ((current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_tipo_lanc_p) or (coalesce(nr_seq_tipo_lanc_p::text, '') = '')))) then -- Beneficiario
			if (nr_seq_centro_apropriacao_p IS NOT NULL AND nr_seq_centro_apropriacao_p::text <> '') then
				if (current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(i) in ('3','6','7','13')) then
					if (current_setting('pls_mens_itens_pck.tb_conta_indice_item_w')::pls_util_cta_pck.t_number_table.count > 0) then
						for y in current_setting('pls_mens_itens_pck.tb_conta_indice_item_w')::pls_util_cta_pck.t_number_table.first..tb_conta_indice_item_w.last loop
							begin
							if (current_setting('pls_mens_itens_pck.tb_conta_indice_item_w')::pls_util_cta_pck.t_number_table(y) = i) then
								if (current_setting('pls_mens_itens_pck.tb_conta_apropriacao_w')::tb_apropriacao_item_t[y].count > 0) then
									for k in current_setting('pls_mens_itens_pck.tb_conta_apropriacao_w')::tb_apropriacao_item_t[y].first..tb_conta_apropriacao_w[y].last loop
										begin
										if	(current_setting('pls_mens_itens_pck.tb_conta_apropriacao_w')::tb_apropriacao_item_t(y)(k).nr_seq_centro_apropriacao = nr_seq_centro_apropriacao_p) then
											if (current_setting('pls_mens_itens_pck.tb_excecao_item_valor_limite_w')::pls_util_cta_pck.t_varchar2_table_1(y) = 'N') then
												vl_total_w	:= vl_total_w + current_setting('pls_mens_itens_pck.tb_conta_apropriacao_w')::tb_apropriacao_item_t(y)(k).vl_apropriacao;
											end if;
										end if;
										end;
									end loop;
								end if;
							end if;
							end;
						end loop;
					end if;
				else
					if (current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t[i].count > 0) then
						for y in current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t[i].first..tb_apropriacao_item_w[i].last loop
							begin
							if	(current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t(i)(y).nr_seq_centro_apropriacao = nr_seq_centro_apropriacao_p) then
									vl_total_w	:= vl_total_w + current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t(i)(y).vl_apropriacao;
							end if;
							end;
						end loop;
					end if;
				end if;
			else
				if (ie_tipo_Item_p = '20') then
					vl_total_w	:= vl_total_w + current_setting('pls_mens_itens_pck.tb_vl_item_w')::pls_util_cta_pck.t_number_table(i);
				else
					if (current_setting('pls_mens_itens_pck.tb_conta_indice_item_w')::pls_util_cta_pck.t_number_table.count > 0) then
						for y in current_setting('pls_mens_itens_pck.tb_conta_indice_item_w')::pls_util_cta_pck.t_number_table.first..tb_conta_indice_item_w.last loop
							begin
							if (current_setting('pls_mens_itens_pck.tb_conta_indice_item_w')::pls_util_cta_pck.t_number_table(y) = i) then
								if (current_setting('pls_mens_itens_pck.tb_excecao_item_valor_limite_w')::pls_util_cta_pck.t_varchar2_table_1(y) = 'N') then
									vl_total_w	:= vl_total_w + current_setting('pls_mens_itens_pck.tb_conta_vl_item_w')::pls_util_cta_pck.t_number_table(y);							
								end if;							
							end if;
							end;
						end loop;
					end if;
				end if;
			end if;
		end if;
	end loop;
end if;

return coalesce(vl_total_w,0);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_mens_itens_pck.obter_valor ( nr_seq_titular_p pls_segurado.nr_sequencia%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, ie_tipo_item_p pls_mensalidade_seg_item.ie_tipo_item%type, nr_seq_centro_apropriacao_p pls_lancamento_mens_aprop.nr_seq_centro_apropriacao%type, nr_seq_tipo_lanc_p pls_tipo_lanc_adic.nr_sequencia%type, dt_mesano_referencia_p timestamp, ie_parcela_p text) FROM PUBLIC;
