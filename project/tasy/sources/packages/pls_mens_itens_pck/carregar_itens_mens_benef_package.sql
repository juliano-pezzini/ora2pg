-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_itens_pck.carregar_itens_mens_benef ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_mesano_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, ie_existe_mensalidade_p INOUT text) AS $body$
DECLARE


i	integer;
y	integer;
ie_existe_mensalidade_w	varchar(1);

C01 CURSOR(	nr_seq_segurado_pc	pls_segurado.nr_sequencia%type,
		dt_mesano_referencia_pc	pls_mensalidade_segurado.dt_mesano_referencia%type) FOR
	SELECT	a.ie_tipo_item,
		c.nr_seq_pagador,
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		a.nr_sequencia nr_seq_item
	from	pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_mensalidade			c
	where	b.nr_sequencia		= a.nr_seq_mensalidade_seg
	and	c.nr_sequencia		= b.nr_seq_mensalidade
	and	b.nr_seq_segurado	= nr_seq_segurado_pc
	and	b.dt_mesano_referencia	= dt_mesano_referencia_pc
	and	coalesce(c.ie_cancelamento::text, '') = ''
	group by
		a.ie_tipo_item,
		c.nr_seq_pagador,
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		a.nr_sequencia;
		
C02 CURSOR(	nr_seq_item_mens_pc	pls_mensalidade_seg_item.nr_sequencia%type) FOR
	SELECT	nr_seq_centro_apropriacao
	from	pls_mens_seg_item_aprop
		pls_mensalidade_seg_item
	where	nr_seq_item = nr_seq_item_mens_pc;
		
BEGIN
current_setting('pls_mens_itens_pck.tb_itens_gerados_mes_w')::tb_itens_gerados_mes.delete;
current_setting('pls_mens_itens_pck.tb_apropriacoes_geradas_mes_w')::tb_apropriacoes_geradas_mes.delete;
ie_existe_mensalidade_w	:= 'N';

i := 0;
y := 0;

for r_c01_w in C01(nr_seq_segurado_p, dt_mesano_referencia_p) loop
	begin
	current_setting('pls_mens_itens_pck.tb_itens_gerados_mes_w')::tb_itens_gerados_mes[i].ie_tipo_item		:= r_c01_w.ie_tipo_item;
	current_setting('pls_mens_itens_pck.tb_itens_gerados_mes_w')::tb_itens_gerados_mes[i].nr_seq_pagador	:= r_c01_w.nr_seq_pagador;
	current_setting('pls_mens_itens_pck.tb_itens_gerados_mes_w')::tb_itens_gerados_mes[i].dt_inicio_cobertura	:= r_c01_w.dt_inicio_cobertura;
	current_setting('pls_mens_itens_pck.tb_itens_gerados_mes_w')::tb_itens_gerados_mes[i].dt_fim_cobertura	:= r_c01_w.dt_fim_cobertura;
	ie_existe_mensalidade_w				:= 'S'; --Se existir algum item de mensalidade para o beneficiario no mes, entao existe mensalidade

	for r_c02_w in c02(r_c01_w.nr_seq_item) loop
		begin
		current_setting('pls_mens_itens_pck.tb_apropriacoes_geradas_mes_w')::tb_apropriacoes_geradas_mes[y].nr_seq_centro_apropriacao 	:= r_c02_w.nr_seq_centro_apropriacao;
		current_setting('pls_mens_itens_pck.tb_apropriacoes_geradas_mes_w')::tb_apropriacoes_geradas_mes[y].ie_tipo_item			:= r_c01_w.ie_tipo_item;
		
		y := y + 1;
		end;
	end loop;

	i := i + 1;
	end;
end loop;

ie_existe_mensalidade_p	:= ie_existe_mensalidade_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_itens_pck.carregar_itens_mens_benef ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_mesano_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, ie_existe_mensalidade_p INOUT text) FROM PUBLIC;
