-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_itens_pck.definir_pagador_beneficiario ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, ie_pce_proporcional_p pls_mensalidade_segurado.ie_pce_proporcional%type) AS $body$
DECLARE


i	integer;
C01 CURSOR(nr_seq_pagador_pc	pls_contrato_pagador.nr_sequencia%type) FOR
	SELECT	nr_seq_pagador_item,
		ie_tipo_item,
		nr_seq_tipo_lanc,
		nr_seq_centro_apropriacao
	from	pls_pagador_item_mens
	where	nr_seq_pagador	= nr_seq_pagador_pc;

BEGIN
PERFORM set_config('pls_mens_itens_pck.nr_seq_pagador_pce_benef_w', null, false);

--Select realizado com o indice PLSMBPT_I3. Necessario verificar se alterar o select

select	max(nr_seq_pagador)
into STRICT	current_setting('pls_mens_itens_pck.nr_seq_pagador_benef_w')::pls_contrato_pagador.nr_sequencia%type
from	pls_mens_benef_pag_tmp	a
where	nr_seq_segurado	= nr_seq_segurado_p
and	ie_tipo_pagador	= 'B'
and	dt_referencia_p between dt_inicio_vig_pag and dt_fim_vig_pag;

if (current_setting('pls_mens_itens_pck.nr_seq_pagador_benef_w')::pls_contrato_pagador.nr_sequencia%coalesce(type::text, '') = '') then
	select	max(nr_seq_pagador)
	into STRICT	current_setting('pls_mens_itens_pck.nr_seq_pagador_benef_w')::pls_contrato_pagador.nr_sequencia%type
	from	pls_segurado_pagador
	where	nr_seq_segurado	= nr_seq_segurado_p
	and	dt_referencia_p >= dt_inicio_vigencia
	and	dt_referencia_p <= coalesce(dt_fim_vigencia,dt_referencia_p);
end if;

current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_ie_tipo_item_compl_w')::pls_util_cta_pck.t_varchar2_table_5.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_compl_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_centro_aprop_comp_w')::pls_util_cta_pck.t_number_table.delete;

if (current_setting('pls_mens_itens_pck.nr_seq_pagador_benef_w')::pls_contrato_pagador.nr_sequencia%(type IS NOT NULL AND type::text <> '')) then
	i := 0;
	for r_c01_w in C01(current_setting('pls_mens_itens_pck.nr_seq_pagador_benef_w')::pls_contrato_pagador.nr_sequencia%type) loop
		begin
		current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table(i)		:= r_c01_w.nr_seq_pagador_item;
		current_setting('pls_mens_itens_pck.tb_ie_tipo_item_compl_w')::pls_util_cta_pck.t_varchar2_table_5(i)		:= r_c01_w.ie_tipo_item;
		current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_compl_w')::pls_util_cta_pck.t_number_table(i)		:= r_c01_w.nr_seq_tipo_lanc;
		current_setting('pls_mens_itens_pck.tb_nr_seq_centro_aprop_comp_w')::pls_util_cta_pck.t_number_table(i)	:= r_c01_w.nr_seq_centro_apropriacao;
		i := i + 1;
		end;
	end loop;
end if;

if (ie_pce_proporcional_p = 'E') then
	select	max(nr_seq_pagador)
	into STRICT	current_setting('pls_mens_itens_pck.nr_seq_pagador_pce_benef_w')::pls_contrato_pagador.nr_sequencia%type
	from	pls_segurado_pagador
	where	nr_sequencia	=  (	SELECT	max(x.nr_sequencia)
					from	pls_segurado_pagador x,
						pls_contrato_pagador y
					where	y.nr_sequencia		= x.nr_seq_pagador
					and	x.nr_seq_segurado	= nr_seq_segurado_p
					and	(y.cd_cgc IS NOT NULL AND y.cd_cgc::text <> '')
					and	x.nr_seq_pagador	<> current_setting('pls_mens_itens_pck.nr_seq_pagador_benef_w')::pls_contrato_pagador.nr_sequencia%type);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_itens_pck.definir_pagador_beneficiario ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, ie_pce_proporcional_p pls_mensalidade_segurado.ie_pce_proporcional%type) FROM PUBLIC;
