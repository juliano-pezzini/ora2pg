-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_mens_itens_pck.obter_se_pagador_item ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_pagador_p pls_contrato_pagador.nr_sequencia%type, ie_tipo_item_p pls_mensalidade_seg_item.ie_tipo_item%type, nr_seq_tipo_lanc_p pls_tipo_lanc_adic.nr_sequencia%type, ie_pce_proporcional_p pls_mensalidade_segurado.ie_pce_proporcional%type, nr_seq_centro_apropriacao_p pls_centro_apropriacao.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE


ie_pagador_item_w		varchar(1);
nr_seq_pagador_complementar_w	pls_contrato_pagador.nr_sequencia%type;
ie_tipo_item_w			pls_mensalidade_seg_item.ie_tipo_item%type;

BEGIN

nr_seq_pagador_complementar_w	:= null;

if (ie_tipo_item_p in ('5','25')) then -- Os itens de Reajuste variacao de custo e Reajuste mudanca de faixa etaria sao considerados como item pre estabelecido para gerar as apropriacoes
	ie_tipo_item_w	:= '1';
else
	ie_tipo_item_w := ie_tipo_Item_p;
end if;

if (ie_pce_proporcional_p = 'E') and (nr_seq_pagador_p = current_setting('pls_mens_itens_pck.nr_seq_pagador_pce_benef_w')::pls_contrato_pagador.nr_sequencia%type) and (ie_tipo_item_p in ('1','12','15')) then
	ie_pagador_item_w	:= 'S';
elsif (nr_seq_pagador_p = current_setting('pls_mens_itens_pck.nr_seq_pagador_benef_w')::pls_contrato_pagador.nr_sequencia%type) then -- Se estiver gerando a mensalidade para o pagador vinculado ao beneficiario
	if (current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table.count = 0) then
		ie_pagador_item_w	:= 'S';
	else
		ie_pagador_item_w	:= 'S';

		if (nr_seq_centro_apropriacao_p IS NOT NULL AND nr_seq_centro_apropriacao_p::text <> '') then
			for i in current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_pagador_compl_w.last loop
				if	((current_setting('pls_mens_itens_pck.tb_ie_tipo_item_compl_w')::pls_util_cta_pck.t_varchar2_table_5(i) = ie_tipo_item_w) and (current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_compl_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_tipo_lanc_p or current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_compl_w')::coalesce(pls_util_cta_pck.t_number_table(i)::text, '') = '') and
					((current_setting('pls_mens_itens_pck.tb_nr_seq_centro_aprop_comp_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_centro_apropriacao_p) or (current_setting('pls_mens_itens_pck.tb_nr_seq_centro_aprop_comp_w')::coalesce(pls_util_cta_pck.t_number_table(i)::text, '') = ''))) then
					ie_pagador_item_w	:= 'N';
				end if;
			end loop;
		else
			for i in current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_pagador_compl_w.last loop
				if	((current_setting('pls_mens_itens_pck.tb_ie_tipo_item_compl_w')::pls_util_cta_pck.t_varchar2_table_5(i) = ie_tipo_item_w) and (current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_compl_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_tipo_lanc_p or current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_compl_w')::coalesce(pls_util_cta_pck.t_number_table(i)::text, '') = '') and (current_setting('pls_mens_itens_pck.tb_nr_seq_centro_aprop_comp_w')::coalesce(pls_util_cta_pck.t_number_table(i)::text, '') = '')) then
					ie_pagador_item_w	:= 'N';
				end if;
			end loop;
		end if;
	end if;
else --Se for pagador complementar
	if (ie_tipo_item_w = '20') then
		if (current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table.count > 0) then
			--Buscar pagador especifico para o tipo de lancamento

			for i in current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_pagador_compl_w.last loop
				if (current_setting('pls_mens_itens_pck.tb_ie_tipo_item_compl_w')::pls_util_cta_pck.t_varchar2_table_5(i) = ie_tipo_item_w) and (current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_compl_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_tipo_lanc_p) and
					((current_setting('pls_mens_itens_pck.tb_nr_seq_centro_aprop_comp_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_centro_apropriacao_p) or (current_setting('pls_mens_itens_pck.tb_nr_seq_centro_aprop_comp_w')::coalesce(pls_util_cta_pck.t_number_table(i)::text, '') = '')) then
					nr_seq_pagador_complementar_w	:= current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table(i);
				end if;
			end loop;
			
			--Buscar pagador complementar sem lancamento especifico

			if (coalesce(nr_seq_pagador_complementar_w::text, '') = '') then
				for i in current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_pagador_compl_w.last loop
					if (current_setting('pls_mens_itens_pck.tb_ie_tipo_item_compl_w')::pls_util_cta_pck.t_varchar2_table_5(i) = ie_tipo_item_w) and (current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_compl_w')::coalesce(pls_util_cta_pck.t_number_table(i)::text, '') = '') and
						((current_setting('pls_mens_itens_pck.tb_nr_seq_centro_aprop_comp_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_centro_apropriacao_p) or (current_setting('pls_mens_itens_pck.tb_nr_seq_centro_aprop_comp_w')::coalesce(pls_util_cta_pck.t_number_table(i)::text, '') = '')) then
						nr_seq_pagador_complementar_w	:= current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table(i);
					end if;
				end loop;
			end if;
		end if;
	else
		if (current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table.count > 0) then
			if (nr_seq_centro_apropriacao_p IS NOT NULL AND nr_seq_centro_apropriacao_p::text <> '') then
				for i in current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_pagador_compl_w.last loop
					if	((current_setting('pls_mens_itens_pck.tb_ie_tipo_item_compl_w')::pls_util_cta_pck.t_varchar2_table_5(i) = ie_tipo_item_w) and (current_setting('pls_mens_itens_pck.tb_nr_seq_centro_aprop_comp_w')::pls_util_cta_pck.t_number_table(i) = nr_seq_centro_apropriacao_p)) then
						nr_seq_pagador_complementar_w	:= current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table(i);
					end if;
				end loop;
			else
				for i in current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_pagador_compl_w.last loop
					if	((current_setting('pls_mens_itens_pck.tb_ie_tipo_item_compl_w')::pls_util_cta_pck.t_varchar2_table_5(i) = ie_tipo_item_w) and (current_setting('pls_mens_itens_pck.tb_nr_seq_centro_aprop_comp_w')::coalesce(pls_util_cta_pck.t_number_table(i)::text, '') = '')) then
						nr_seq_pagador_complementar_w	:= current_setting('pls_mens_itens_pck.tb_nr_seq_pagador_compl_w')::pls_util_cta_pck.t_number_table(i);
					end if;
				end loop;
			end if;
		end if;
		
		--Select desabilitado devido ao grande impacto na performance, pela quantidade de vezes em que e realizado. Substituido pelo loop acima.

		--select	max(nr_seq_pagador)

		--into	nr_seq_pagador_complementar_w

		--from	pls_mens_benef_pag_tmp

		--where	nr_seq_pagador		= nr_seq_pagador_p

		--and	ie_tipo_pagador		= 'C'

		--and	ie_tipo_item		= ie_tipo_item_p;

	end if;

	if (nr_seq_pagador_complementar_w = nr_seq_pagador_p) then
		ie_pagador_item_w	:= 'S';
	else
		ie_pagador_item_w	:= 'N';
	end if;
end if;

return ie_pagador_item_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_mens_itens_pck.obter_se_pagador_item ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_pagador_p pls_contrato_pagador.nr_sequencia%type, ie_tipo_item_p pls_mensalidade_seg_item.ie_tipo_item%type, nr_seq_tipo_lanc_p pls_tipo_lanc_adic.nr_sequencia%type, ie_pce_proporcional_p pls_mensalidade_segurado.ie_pce_proporcional%type, nr_seq_centro_apropriacao_p pls_centro_apropriacao.nr_sequencia%type) FROM PUBLIC;
