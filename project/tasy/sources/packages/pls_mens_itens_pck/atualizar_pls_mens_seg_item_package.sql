-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_itens_pck.atualizar_pls_mens_seg_item ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


iw	integer;
nr_seq_mensalidade_w		pls_mensalidade.nr_sequencia%type;
vl_apropriacao_w		pls_lancamento_mens_aprop.vl_apropriacao%type;

tb_nr_seq_item_wr		pls_util_cta_pck.t_number_table;
ie_gerou_apropriacao_item_w	boolean;
vl_diferenca_w			double precision;
vl_total_apropriacao_w		double precision;
nr_seq_item_conta_w		pls_mensalidade_item_conta.nr_sequencia%type;
nr_seq_item_estorno_w		pls_mensalidade_seg_item.nr_sequencia%type;

C01 CURSOR(	nr_seq_item_pc			pls_mensalidade_seg_item.nr_sequencia%type) FOR
	SELECT	a.nr_seq_centro_apropriacao	nr_seq_centro_apropriacao,
		sum(a.vl_apropriacao) 		vl_apropriacao
	from	pls_mens_item_conta_aprop 	a,
		pls_mensalidade_item_conta 	b
	where	b.nr_sequencia 	= a.nr_seq_mens_item_conta
	and	b.nr_seq_item 	= nr_seq_item_pc
	group by
		a.nr_seq_centro_apropriacao;

BEGIN
if (current_setting('pls_mens_itens_pck.tb_nr_seq_mensalidade_seg_w')::pls_util_cta_pck.t_number_table.count > 0) then
	forall i in current_setting('pls_mens_itens_pck.tb_nr_seq_mensalidade_seg_w')::pls_util_cta_pck.t_number_table.first..tb_nr_seq_mensalidade_seg_w.last		
		insert	into	pls_mensalidade_seg_item(	nr_sequencia, nr_seq_mensalidade_seg, nr_seq_lote,
				dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec,
				ie_tipo_item, vl_item, ie_tipo_mensalidade,
				nr_seq_conta, nr_seq_protocolo, nr_seq_tipo_lanc,
				vl_ato_cooperado, vl_ato_auxiliar, vl_ato_nao_cooperado,
				nr_seq_carteira_seg, nr_seq_regra_acrescimo, nr_seq_tipo_acrescimo,
				cd_centro_custo, nr_seq_vinculo_sca, nr_parcela_sca,
				dt_inicio_cobertura, dt_fim_cobertura, ds_mensagem_reajuste,
				ds_observacao, vl_sca_embutido, ie_valor_apropriado,
				dt_retroativa, nr_seq_plano, nr_seq_reajuste,
				nr_seq_lancamento_mens, nr_seq_seg_cart_ant, nr_seq_segurado_mens,
				ie_recomposicao)
			values (	nextval('pls_mensalidade_seg_item_seq'), current_setting('pls_mens_itens_pck.tb_nr_seq_mensalidade_seg_w')::pls_util_cta_pck.t_number_table(i), nr_seq_lote_p,
				clock_timestamp(), clock_timestamp(), nm_usuario_p, nm_usuario_p,
				current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(i), current_setting('pls_mens_itens_pck.tb_vl_item_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_ie_tipo_mensalidade_w')::pls_util_cta_pck.t_varchar2_table_1(i),
				current_setting('pls_mens_itens_pck.tb_nr_seq_conta_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_nr_seq_protocolo_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_mens_itens_pck.tb_vl_ato_cooperado_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_vl_ato_auxiliar_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_vl_ato_nao_cooperado_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_mens_itens_pck.tb_nr_seq_carteira_seg_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_nr_seq_regra_acrescimo_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_acrescimo_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_mens_itens_pck.tb_cd_centro_custo_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_nr_seq_vinculo_sca_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_nr_parcela_sca_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_mens_itens_pck.tb_dt_inicio_cobertura_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_mens_itens_pck.tb_dt_fim_cobertura_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_mens_itens_pck.tb_ds_mensagem_reajuste_w')::pls_util_cta_pck.t_varchar2_table_4000(i),
				current_setting('pls_mens_itens_pck.tb_ds_observacao_w')::pls_util_cta_pck.t_varchar2_table_4000(i), current_setting('pls_mens_itens_pck.tb_vl_sca_embutido_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_ie_valor_apropriado_w')::pls_util_cta_pck.t_varchar2_table_1(i),
				current_setting('pls_mens_itens_pck.tb_dt_retroativa_w')::pls_util_cta_pck.t_date_table(i), current_setting('pls_mens_itens_pck.tb_nr_seq_plano_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_nr_seq_reajuste_preco_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_mens_itens_pck.tb_nr_seq_lanc_mens_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_nr_seq_seg_cart_ant_w')::pls_util_cta_pck.t_number_table(i), current_setting('pls_mens_itens_pck.tb_nr_seq_lanc_aut_mens_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_mens_itens_pck.tb_ie_recomposicao_w')::pls_util_cta_pck.t_varchar2_table_1(i))
		RETURNING nr_sequencia
		BULK COLLECT INTO tb_nr_seq_item_wr;
	commit;
	
	for i in tb_nr_seq_item_wr.first..tb_nr_seq_item_wr.last loop
		begin
		iw	:= i-1; --O indice do RETURNING comeca na posicao 1, portanto ao utilizar variaveis do vetor do item, deve utilizar com i-1
		
		ie_gerou_apropriacao_item_w	:= false;
		nr_seq_item_estorno_w		:= null;
		
		if (current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(iw) in ('1','25')) then --1 - Preco pre-estabelecido / 25 - Reajuste - Variacao de custo
			if (current_setting('pls_mens_itens_pck.tb_sca_indice_preco_pre_w')::pls_util_cta_pck.t_number_table.count > 0) then
				for y in current_setting('pls_mens_itens_pck.tb_sca_indice_preco_pre_w')::pls_util_cta_pck.t_number_table.first..tb_sca_indice_preco_pre_w.last loop
					begin
					if (current_setting('pls_mens_itens_pck.tb_sca_indice_preco_pre_w')::pls_util_cta_pck.t_number_table(y) = iw) then
						current_setting('pls_mens_itens_pck.tb_sca_nr_seq_item_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)		:= tb_nr_seq_item_wr(i);
						current_setting('pls_mens_itens_pck.tb_sca_nr_seq_mensalidade_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)	:= current_setting('pls_mens_itens_pck.tb_sca_seq_mensalidade_w')::pls_util_cta_pck.t_number_table(y);
						current_setting('pls_mens_itens_pck.tb_sca_nr_seq_vinculo_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)	:= current_setting('pls_mens_itens_pck.tb_sca_nr_seq_vinculo_sca_w')::pls_util_cta_pck.t_number_table(y);
						current_setting('pls_mens_itens_pck.tb_sca_nr_parcela_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)		:= current_setting('pls_mens_itens_pck.tb_sca_parcela_w')::pls_util_cta_pck.t_number_table(y);
						current_setting('pls_mens_itens_pck.tb_sca_vl_parcela_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)		:= current_setting('pls_mens_itens_pck.tb_sca_vl_item_w')::pls_util_cta_pck.t_number_table(y);
						current_setting('pls_mens_itens_pck.tb_sca_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)	:= current_setting('pls_mens_itens_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table(iw);
						current_setting('pls_mens_itens_pck.tb_sca_nr_seq_preco_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)		:= current_setting('pls_mens_itens_pck.tb_sca_nr_seq_segurado_preco_w')::pls_util_cta_pck.t_number_table(y);
						current_setting('pls_mens_itens_pck.tb_sca_dt_inicio_cobertura_w')::pls_util_cta_pck.t_date_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)	:= current_setting('pls_mens_itens_pck.tb_sca_inicio_cobertura_w')::pls_util_cta_pck.t_date_table(y);
						current_setting('pls_mens_itens_pck.tb_sca_dt_fim_cobertura_w')::pls_util_cta_pck.t_date_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)	:= current_setting('pls_mens_itens_pck.tb_sca_fim_cobertura_w')::pls_util_cta_pck.t_date_table(y);
						PERFORM set_config('pls_mens_itens_pck.nr_indice_sca_w', current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer + 1, false);
					end if;
					end;
				end loop;
			end if;
		elsif (current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(iw) in ('3','6','7','13')) then
			if (current_setting('pls_mens_itens_pck.tb_conta_indice_item_w')::pls_util_cta_pck.t_number_table.count > 0) then
				for y in current_setting('pls_mens_itens_pck.tb_conta_indice_item_w')::pls_util_cta_pck.t_number_table.first..tb_conta_indice_item_w.last loop
					begin
					if (current_setting('pls_mens_itens_pck.tb_conta_indice_item_w')::pls_util_cta_pck.t_number_table(y) = iw) then
						select	nextval('pls_mensalidade_item_conta_seq')
						into STRICT	nr_seq_item_conta_w
						;
					
						insert	into	pls_mensalidade_item_conta(	nr_sequencia, nr_seq_item, nr_seq_conta_copartic, nr_seq_conta_pos_estab, nr_seq_conta_co,
								vl_item, vl_ato_cooperado, vl_ato_auxiliar, vl_ato_nao_cooperado, dt_atualizacao,
								nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_pos_proc, nr_seq_pos_mat,
								ds_observacao)
							values (	nr_seq_item_conta_w, tb_nr_seq_item_wr(i), current_setting('pls_mens_itens_pck.tb_conta_nr_seq_copartic_w')::pls_util_cta_pck.t_number_table(y), current_setting('pls_mens_itens_pck.tb_conta_nr_seq_pos_estab_w')::pls_util_cta_pck.t_number_table(y), current_setting('pls_mens_itens_pck.tb_conta_nr_seq_conta_co_w')::pls_util_cta_pck.t_number_table(y),
								current_setting('pls_mens_itens_pck.tb_conta_vl_item_w')::pls_util_cta_pck.t_number_table(y), current_setting('pls_mens_itens_pck.tb_conta_vl_ato_cooperado_w')::pls_util_cta_pck.t_number_table(y), current_setting('pls_mens_itens_pck.tb_conta_vl_ato_auxiliar_w')::pls_util_cta_pck.t_number_table(y), current_setting('pls_mens_itens_pck.tb_conta_vl_ato_nao_coop_w')::pls_util_cta_pck.t_number_table(y), clock_timestamp(), 
								nm_usuario_p, clock_timestamp(), nm_usuario_p, current_setting('pls_mens_itens_pck.tb_conta_pos_proc_w')::pls_util_cta_pck.t_number_table(y), current_setting('pls_mens_itens_pck.tb_conta_pos_mat_w')::pls_util_cta_pck.t_number_table(y),
								current_setting('pls_mens_itens_pck.tb_conta_ds_observacao_w')::pls_util_cta_pck.t_varchar2_table_4000(y));
						
						if (current_setting('pls_mens_itens_pck.tb_conta_apropriacao_w')::tb_apropriacao_item_t[y].count > 0) then
							for k in current_setting('pls_mens_itens_pck.tb_conta_apropriacao_w')::tb_apropriacao_item_t[y].first..tb_conta_apropriacao_w[y].last loop
								begin
								vl_apropriacao_w	:= current_setting('pls_mens_itens_pck.tb_conta_apropriacao_w')::tb_apropriacao_item_t(y)(k).vl_apropriacao;
								
								if (vl_apropriacao_w <> 0) then
									insert	into	pls_mens_item_conta_aprop(nr_sequencia, nr_seq_mens_item_conta, nr_seq_centro_apropriacao,
										vl_apropriacao, dt_atualizacao, nm_usuario, 
										dt_atualizacao_nrec, nm_usuario_nrec)
									values	(nextval('pls_mens_item_conta_aprop_seq'), nr_seq_item_conta_w, current_setting('pls_mens_itens_pck.tb_conta_apropriacao_w')::tb_apropriacao_item_t(y)(k).nr_seq_centro_apropriacao, 
										vl_apropriacao_w, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p);
										
									ie_gerou_apropriacao_item_w	:= true;
								end if;
								end;
							end loop;
						end if;
					end if;
					end;
				end loop;
			end if;
		elsif (current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(iw) = '21') then --Agravo
			update	pls_segurado_agravo_parc
			set	nr_seq_mensalidade_item	= tb_nr_seq_item_wr(i)
			where	nr_sequencia	= current_setting('pls_mens_itens_pck.tb_nr_seq_agravo_parc_w')::pls_util_cta_pck.t_number_table(iw);
		elsif (current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(iw) in ('15','35')) or (current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(iw) = '4' and current_setting('pls_mens_itens_pck.tb_nr_seq_vinculo_sca_w')::(pls_util_cta_pck.t_number_table(iw) IS NOT NULL AND (pls_util_cta_pck.t_number_table(iw))::text <> '')) then --SCA
			current_setting('pls_mens_itens_pck.tb_sca_nr_seq_item_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)		:= tb_nr_seq_item_wr(i);
			current_setting('pls_mens_itens_pck.tb_sca_nr_seq_mensalidade_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)	:= current_setting('pls_mens_itens_pck.tb_nr_seq_mensalidade_w')::pls_util_cta_pck.t_number_table(iw);
			current_setting('pls_mens_itens_pck.tb_sca_nr_seq_vinculo_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)	:= current_setting('pls_mens_itens_pck.tb_nr_seq_vinculo_sca_w')::pls_util_cta_pck.t_number_table(iw);
			current_setting('pls_mens_itens_pck.tb_sca_nr_parcela_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)		:= current_setting('pls_mens_itens_pck.tb_nr_parcela_sca_w')::pls_util_cta_pck.t_number_table(iw);
			current_setting('pls_mens_itens_pck.tb_sca_vl_parcela_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)		:= current_setting('pls_mens_itens_pck.tb_vl_item_w')::pls_util_cta_pck.t_number_table(iw);
			current_setting('pls_mens_itens_pck.tb_sca_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)	:= current_setting('pls_mens_itens_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table(iw);
			current_setting('pls_mens_itens_pck.tb_sca_nr_seq_preco_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)		:= current_setting('pls_mens_itens_pck.tb_nr_seq_seg_preco_origem_w')::pls_util_cta_pck.t_number_table(iw);
			current_setting('pls_mens_itens_pck.tb_sca_dt_inicio_cobertura_w')::pls_util_cta_pck.t_date_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)	:= current_setting('pls_mens_itens_pck.tb_dt_inicio_cobertura_w')::pls_util_cta_pck.t_date_table(iw);
			current_setting('pls_mens_itens_pck.tb_sca_dt_fim_cobertura_w')::pls_util_cta_pck.t_date_table(current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer)	:= current_setting('pls_mens_itens_pck.tb_dt_fim_cobertura_w')::pls_util_cta_pck.t_date_table(iw);
			PERFORM set_config('pls_mens_itens_pck.nr_indice_sca_w', current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer + 1, false);
		elsif	((current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(iw) = '5') and (current_setting('pls_mens_itens_pck.tb_nr_seq_regra_susp_reaj_fx_w')::(pls_util_cta_pck.t_number_table(iw) IS NOT NULL AND (pls_util_cta_pck.t_number_table(iw))::text <> ''))) then
			insert	into	pls_mensalidade_seg_item(	nr_sequencia, nr_seq_mensalidade_seg, nr_seq_lote,
					dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec,
					ie_tipo_item, vl_item, ie_tipo_mensalidade,
					nr_seq_conta, nr_seq_protocolo, nr_seq_tipo_lanc,
					vl_ato_cooperado, vl_ato_auxiliar, vl_ato_nao_cooperado,
					nr_seq_carteira_seg, nr_seq_regra_acrescimo, nr_seq_tipo_acrescimo,
					cd_centro_custo, nr_seq_vinculo_sca, nr_parcela_sca,
					dt_inicio_cobertura, dt_fim_cobertura, ds_mensagem_reajuste,
					ds_observacao, vl_sca_embutido, ie_valor_apropriado,
					dt_retroativa, nr_seq_plano, nr_seq_reajuste,
					nr_seq_lancamento_mens, nr_seq_seg_cart_ant, nr_seq_segurado_mens,
					nr_seq_item_estorno, ie_recomposicao)
				values (	nextval('pls_mensalidade_seg_item_seq'), current_setting('pls_mens_itens_pck.tb_nr_seq_mensalidade_seg_w')::pls_util_cta_pck.t_number_table(iw), nr_seq_lote_p,
					clock_timestamp(), clock_timestamp(), nm_usuario_p, nm_usuario_p,
					current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(iw), current_setting('pls_mens_itens_pck.tb_vl_item_w')::pls_util_cta_pck.t_number_table(iw)*-1, current_setting('pls_mens_itens_pck.tb_ie_tipo_mensalidade_w')::pls_util_cta_pck.t_varchar2_table_1(iw),
					current_setting('pls_mens_itens_pck.tb_nr_seq_conta_w')::pls_util_cta_pck.t_number_table(iw), current_setting('pls_mens_itens_pck.tb_nr_seq_protocolo_w')::pls_util_cta_pck.t_number_table(iw), current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_w')::pls_util_cta_pck.t_number_table(iw),
					current_setting('pls_mens_itens_pck.tb_vl_ato_cooperado_w')::pls_util_cta_pck.t_number_table(iw)*-1, current_setting('pls_mens_itens_pck.tb_vl_ato_auxiliar_w')::pls_util_cta_pck.t_number_table(iw)*-1, current_setting('pls_mens_itens_pck.tb_vl_ato_nao_cooperado_w')::pls_util_cta_pck.t_number_table(iw)*-1,
					current_setting('pls_mens_itens_pck.tb_nr_seq_carteira_seg_w')::pls_util_cta_pck.t_number_table(iw), current_setting('pls_mens_itens_pck.tb_nr_seq_regra_acrescimo_w')::pls_util_cta_pck.t_number_table(iw), current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_acrescimo_w')::pls_util_cta_pck.t_number_table(iw),
					current_setting('pls_mens_itens_pck.tb_cd_centro_custo_w')::pls_util_cta_pck.t_number_table(iw), current_setting('pls_mens_itens_pck.tb_nr_seq_vinculo_sca_w')::pls_util_cta_pck.t_number_table(iw), current_setting('pls_mens_itens_pck.tb_nr_parcela_sca_w')::pls_util_cta_pck.t_number_table(iw),
					current_setting('pls_mens_itens_pck.tb_dt_inicio_cobertura_w')::pls_util_cta_pck.t_date_table(iw), current_setting('pls_mens_itens_pck.tb_dt_fim_cobertura_w')::pls_util_cta_pck.t_date_table(iw), current_setting('pls_mens_itens_pck.tb_ds_mensagem_reajuste_w')::pls_util_cta_pck.t_varchar2_table_4000(iw),
					current_setting('pls_mens_itens_pck.tb_ds_observacao_w')::pls_util_cta_pck.t_varchar2_table_4000(iw), current_setting('pls_mens_itens_pck.tb_vl_sca_embutido_w')::pls_util_cta_pck.t_number_table(iw)*-1, current_setting('pls_mens_itens_pck.tb_ie_valor_apropriado_w')::pls_util_cta_pck.t_varchar2_table_1(iw),
					current_setting('pls_mens_itens_pck.tb_dt_retroativa_w')::pls_util_cta_pck.t_date_table(iw), current_setting('pls_mens_itens_pck.tb_nr_seq_plano_w')::pls_util_cta_pck.t_number_table(iw), current_setting('pls_mens_itens_pck.tb_nr_seq_reajuste_preco_w')::pls_util_cta_pck.t_number_table(iw),
					current_setting('pls_mens_itens_pck.tb_nr_seq_lanc_mens_w')::pls_util_cta_pck.t_number_table(iw), current_setting('pls_mens_itens_pck.tb_nr_seq_seg_cart_ant_w')::pls_util_cta_pck.t_number_table(iw), current_setting('pls_mens_itens_pck.tb_nr_seq_lanc_aut_mens_w')::pls_util_cta_pck.t_number_table(iw),
					tb_nr_seq_item_wr(i), current_setting('pls_mens_itens_pck.tb_ie_recomposicao_w')::pls_util_cta_pck.t_varchar2_table_1(i))
				returning nr_sequencia into nr_seq_item_estorno_w;
		end if;

		if (current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t[iw].count > 0) then
			for k in current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t[iw].first..tb_apropriacao_item_w[iw].last loop
				begin
				vl_apropriacao_w	:= current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t(iw)(k).vl_apropriacao;
				
				if (current_setting('pls_mens_itens_pck.tb_vl_item_w')::pls_util_cta_pck.t_number_table(iw) < 0) and (vl_apropriacao_w > 0) then
					vl_apropriacao_w	:= vl_apropriacao_w*-1;
				end if;
				
				if (vl_apropriacao_w <> 0) then
					insert	into	pls_mens_seg_item_aprop(	nr_sequencia, nr_seq_item, nr_seq_centro_apropriacao, vl_apropriacao,
							dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec)
						values
						(	nextval('pls_mens_seg_item_aprop_seq'), tb_nr_seq_item_wr(i), current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t(iw)(k).nr_seq_centro_apropriacao, vl_apropriacao_w,
							clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p);
					ie_gerou_apropriacao_item_w	:= true;
				end if;
				end;
			end loop;
			
			if (nr_seq_item_estorno_w IS NOT NULL AND nr_seq_item_estorno_w::text <> '') then
				for k in current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t[iw].first..tb_apropriacao_item_w[iw].last loop
					begin
					vl_apropriacao_w	:= current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t(iw)(k).vl_apropriacao;
					
					if (current_setting('pls_mens_itens_pck.tb_vl_item_w')::pls_util_cta_pck.t_number_table(iw) < 0) and (vl_apropriacao_w > 0) then
						vl_apropriacao_w	:= vl_apropriacao_w*-1;
					end if;
					
					if (vl_apropriacao_w <> 0) then
						insert	into	pls_mens_seg_item_aprop(	nr_sequencia, nr_seq_item, nr_seq_centro_apropriacao, vl_apropriacao,
								dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec)
							values
							(	nextval('pls_mens_seg_item_aprop_seq'), nr_seq_item_estorno_w, current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t(iw)(k).nr_seq_centro_apropriacao, vl_apropriacao_w*-1,
								clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p);
						ie_gerou_apropriacao_item_w	:= true;
					end if;
					end;
				end loop;
			end if;
		end if;
		
		if (current_setting('pls_mens_itens_pck.tb_nr_seq_lanc_aut_mens_w')::(pls_util_cta_pck.t_number_table(iw) IS NOT NULL AND (pls_util_cta_pck.t_number_table(iw))::text <> '')) then
			update	pls_segurado_mensalidade
			set	ie_situacao		= 'I',
				nr_seq_item_mensalidade	= tb_nr_seq_item_wr(i)
			where	nr_sequencia		= current_setting('pls_mens_itens_pck.tb_nr_seq_lanc_aut_mens_w')::pls_util_cta_pck.t_number_table(iw);
		end if;
		
		if (current_setting('pls_mens_itens_pck.nr_indice_sca_w')::integer >= pls_util_pck.qt_registro_transacao_w) then
			CALL pls_mens_itens_pck.inserir_mensalidade_sca(cd_estabelecimento_p, nm_usuario_p);
		end if;


		if	((current_setting('pls_mens_itens_pck.tb_aprop_indice_preco_w')::pls_util_cta_pck.t_number_table.count > 0) and (current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(iw) not in ('6', '13'))) then
			for y in current_setting('pls_mens_itens_pck.tb_aprop_indice_preco_w')::pls_util_cta_pck.t_number_table.first..tb_aprop_indice_preco_w.last loop
				begin
				if (current_setting('pls_mens_itens_pck.tb_aprop_indice_preco_w')::pls_util_cta_pck.t_number_table(y) = iw) then
					insert into pls_mens_seg_item_aprop(nr_sequencia, dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec,
						nr_seq_item, nr_seq_centro_apropriacao, vl_apropriacao)
					values (nextval('pls_mens_seg_item_aprop_seq'), clock_timestamp(), clock_timestamp(), nm_usuario_p, nm_usuario_p,
						tb_nr_seq_item_wr(i), current_setting('pls_mens_itens_pck.tb_aprop_nr_seq_centro_aprop_w')::pls_util_cta_pck.t_number_table(y), current_setting('pls_mens_itens_pck.tb_aprop_vl_apropriacao_w')::pls_util_cta_pck.t_number_table(y));
				end if;
				end;
			end loop;
		end if;
		
		if (current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(iw) in ('3','6','7','13')) then
			for r_c01_w in c01(tb_nr_seq_item_wr(i)) loop
				begin
				insert into pls_mens_seg_item_aprop(nr_sequencia, dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec,
					nr_seq_item, nr_seq_centro_apropriacao, vl_apropriacao)
				values (nextval('pls_mens_seg_item_aprop_seq'), clock_timestamp(), clock_timestamp(), nm_usuario_p, nm_usuario_p,
					tb_nr_seq_item_wr(i), r_c01_w.nr_seq_centro_apropriacao, r_c01_w.vl_apropriacao);
				
				if (not ie_gerou_apropriacao_item_w) then
					ie_gerou_apropriacao_item_w	:= true;
				end if;
				end;
			end loop;
		end if;
		
		if (ie_gerou_apropriacao_item_w) then
			update	pls_mensalidade_seg_item
			set	ie_valor_apropriado	= 'S'
			where	nr_sequencia = tb_nr_seq_item_wr(i);
		end if;
		end;
	end loop;
	
	commit;
end if;

-- reinicializa as variaveis

current_setting('pls_mens_itens_pck.tb_nr_seq_mensalidade_seg_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_lanc_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_vl_item_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_plano_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_ie_tipo_mensalidade_w')::pls_util_cta_pck.t_varchar2_table_1.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_conta_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_protocolo_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_vl_ato_cooperado_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_vl_ato_auxiliar_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_vl_ato_nao_cooperado_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_carteira_seg_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_agravo_parc_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_regra_acrescimo_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_tipo_acrescimo_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_lanc_mens_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_apropriacao_item_w')::tb_apropriacao_item_t.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_lanc_aut_mens_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_cd_centro_custo_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_vinculo_sca_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_parcela_sca_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_dt_inicio_cobertura_w')::pls_util_cta_pck.t_date_table.delete;
current_setting('pls_mens_itens_pck.tb_dt_fim_cobertura_w')::pls_util_cta_pck.t_date_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_segurado_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_titular_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_seg_preco_origem_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_ds_mensagem_reajuste_w')::pls_util_cta_pck.t_varchar2_table_4000.delete;
current_setting('pls_mens_itens_pck.tb_ds_observacao_w')::pls_util_cta_pck.t_varchar2_table_4000.delete;
current_setting('pls_mens_itens_pck.tb_vl_sca_embutido_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_dt_retroativa_w')::pls_util_cta_pck.t_date_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_reajuste_preco_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_regra_susp_reaj_fx_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_nr_seq_seg_cart_ant_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_dt_mesano_referencia_w')::pls_util_cta_pck.t_date_table.delete;
current_setting('pls_mens_itens_pck.tb_dt_referencia_w')::pls_util_cta_pck.t_date_table.delete;

--reiniciar vetores sca

current_setting('pls_mens_itens_pck.tb_sca_indice_preco_pre_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_sca_seq_mensalidade_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_sca_nr_seq_vinculo_sca_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_sca_parcela_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_sca_vl_item_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_sca_nr_seq_segurado_preco_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_sca_inicio_cobertura_w')::pls_util_cta_pck.t_date_table.delete;
current_setting('pls_mens_itens_pck.tb_sca_fim_cobertura_w')::pls_util_cta_pck.t_date_table.delete;

--reiniciar vetores contas

current_setting('pls_mens_itens_pck.tb_conta_indice_item_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_conta_nr_seq_copartic_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_conta_nr_seq_pos_estab_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_conta_nr_seq_conta_co_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_conta_vl_item_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_conta_vl_ato_cooperado_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_conta_vl_ato_auxiliar_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_conta_vl_ato_nao_coop_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_conta_pos_proc_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_excecao_item_valor_limite_w')::pls_util_cta_pck.t_varchar2_table_1.delete;
current_setting('pls_mens_itens_pck.tb_conta_pos_mat_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_conta_ds_observacao_w')::pls_util_cta_pck.t_varchar2_table_4000.delete;
current_setting('pls_mens_itens_pck.tb_conta_apropriacao_w')::tb_apropriacao_item_t.delete;

--reiniciar vetores apropriacao

current_setting('pls_mens_itens_pck.tb_aprop_indice_preco_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_aprop_nr_seq_centro_aprop_w')::pls_util_cta_pck.t_number_table.delete;
current_setting('pls_mens_itens_pck.tb_aprop_vl_apropriacao_w')::pls_util_cta_pck.t_number_table.delete;

PERFORM set_config('pls_mens_itens_pck.nr_indice_w', 0, false);
PERFORM set_config('pls_mens_itens_pck.nr_indice_sca_emb_w', 0, false);
PERFORM set_config('pls_mens_itens_pck.nr_indice_conta_w', 0, false);
PERFORM set_config('pls_mens_itens_pck.nr_indice_aprop_w', 0, false);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_itens_pck.atualizar_pls_mens_seg_item ( nr_seq_lote_p pls_lote_mensalidade.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
