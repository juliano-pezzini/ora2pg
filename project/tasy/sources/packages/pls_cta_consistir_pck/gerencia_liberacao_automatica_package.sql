-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- verifica todas as regras de libera__o autom_tica e executa as mesmas



CREATE OR REPLACE PROCEDURE pls_cta_consistir_pck.gerencia_liberacao_automatica ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ie_atualiza_apresentado_w	pls_parametros.ie_atualizar_valor_apresent%type;
nr_seq_evento_w			pls_evento.nr_sequencia%type;
nr_seq_evento_prod_w		pls_evento_regra_producao.nr_sequencia%type;
ie_evento_w			varchar(5);
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;
nr_seq_prestador_retorno_w	pls_prestador.nr_sequencia%type;
nr_seq_regra_retorno_w		pls_prestador_consistencia.nr_sequencia%type;
ie_gerar_grupo_ans_w		pls_parametro_contabil.ie_consitencia_grupo_ans%type;
nr_seq_grupo_ans_w		ans_grupo_desp_regra.nr_seq_grupo_ans%type;
nr_seq_conselho_w		pessoa_fisica.nr_seq_conselho%type;
qt_glosa_w			integer;
-- procedimentos n_o cancelados de contas n_o fechadas

c_procedimentos CURSOR(	nr_seq_conta_pc		pls_conta.nr_sequencia%type,
			nr_seq_conta_proc_pc	pls_conta_proc.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_conta_proc,
		ie_origem_proced,
		cd_procedimento,
		ie_tipo_despesa,
		ie_status,
		nr_seq_preco_pacote
	from	pls_conta_proc_v
	where (nr_seq_conta = nr_seq_conta_pc or nr_sequencia = nr_seq_conta_proc_pc)
	and	ie_status <> 'D'
	and	ie_status_conta <> 'F';

-- materiais n_o cancelados de contas n_o fechadas

c_materiais CURSOR(	nr_seq_conta_pc		pls_conta.nr_sequencia%type,
			nr_seq_conta_mat_pc	pls_conta_mat.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_conta_mat,
		ie_tipo_despesa,
		nr_seq_conta
	from	pls_conta_mat_v
	where (nr_seq_conta = nr_seq_conta_pc or nr_sequencia = nr_seq_conta_mat_pc)
	and	ie_status <> 'D'
	and	ie_status_conta <> 'F';

BEGIN
nr_seq_grupo_ans_w := null;

-- busca par_metro para saber se _ para liberar ou alimentar os valores calculados nos valores apresentados

select	ie_atualizar_valor_apresent
into STRICT	ie_atualiza_apresentado_w
from	table(pls_parametros_pck.f_retorna_param(cd_estabelecimento_p));

select	coalesce(max(ie_consitencia_grupo_ans), 'S')
into STRICT	ie_gerar_grupo_ans_w
from	pls_parametro_contabil
where	cd_estabelecimento	= cd_estabelecimento_p;

for r_contas_w in current_setting('pls_cta_consistir_pck.c_contas')::CURSOR((	nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p) loop
	
	select	count(1)
	into STRICT	qt_glosa_w
	from	pls_conta_glosa
	where	nr_seq_conta		= r_contas_w.nr_seq_conta
	and	coalesce(nr_seq_conta_proc::text, '') = ''
	and	coalesce(nr_seq_conta_mat::text, '') = ''
	and	ie_situacao		= 'A';
	
	if (qt_glosa_w		= 0) or (r_contas_w.ie_status	!= 'F') then
		-- #D_cioAqui se der vamos refazer

		
		if (r_contas_w.ie_tipo_conta = 'I') then
			ie_evento_w := 'I5';
		else
			ie_evento_w := null;
		end if;
		
		CALL pls_obter_regra_valor_conta(	r_contas_w.nr_seq_conta, null, null,
						ie_evento_w, nm_usuario_p);
		-- busca os procedimentos				

		for r_c_procedimentos_w in c_procedimentos(r_contas_w.nr_seq_conta, nr_seq_conta_proc_p) loop
		
			--Diego - 21/06/2011 - OS  313903 - Ao final da consist_ncia do procedimento este ser_ deixado em status "Pendente de libera__o" para se ter uma diferencia__o entre procedimentos consitidos e que faltam consistir.

			--Francisco - 17/10/2012 - OS 469604 - Se o item estiver na an_lise na pode mudar o status 

			--N_o pode estar  "En an_lise" , "Liberado pelo usu_rio" e "Cancelado"

			if (r_c_procedimentos_w.ie_status not in ('A','D','L')) then
				
				pls_obter_evento_item(	r_c_procedimentos_w.cd_procedimento, r_c_procedimentos_w.ie_origem_proced, null,
							cd_estabelecimento_p, r_contas_w.ie_tipo_guia,
							r_contas_w.ie_origem_conta, r_contas_w.nr_seq_tipo_atendimento, 
							r_c_procedimentos_w.ie_tipo_despesa, r_contas_w.nr_seq_segurado, 
							r_contas_w.nr_seq_conta, 'N',null,  nr_seq_evento_w, 
							nr_seq_evento_prod_w, 'C', r_contas_w.ie_regime_atendimento, r_contas_w.ie_saude_ocupacional);
				update	pls_conta_proc
				set	ie_status 		= 'P',
					nr_seq_evento		= nr_seq_evento_w,
					nr_seq_evento_prod	= nr_seq_evento_prod_w
				where	nr_sequencia		= r_c_procedimentos_w.nr_seq_conta_proc;
				commit;
			end if;
			
			if (r_c_procedimentos_w.ie_tipo_despesa = '4')	and (r_c_procedimentos_w.nr_seq_preco_pacote IS NOT NULL AND r_c_procedimentos_w.nr_seq_preco_pacote::text <> '') then
				-- Gerar a estrutura definida na composi__o do pacote dentro da conta respons_vel pelo procedimento em quest_o. 

				-- Ser_o criados registros de procedimentos e materiais para a conta caso a vig_ncia da composi__o selecionada

				-- esteja valendo para a data de atendimento da conta.

				
				--#D_cioAqui -> fazer uma fun__o que retorna isso

				select	nr_seq_prestador
				into STRICT	nr_seq_prestador_w
				from	pls_protocolo_conta
				where	nr_sequencia	= r_contas_w.nr_seq_protocolo;

				if (r_contas_w.ie_tipo_conta <> 'I') then
					pls_obter_tipo_prest_consist(	r_contas_w.nr_seq_conta, nm_usuario_p, 
									nr_seq_prestador_retorno_w, nr_seq_regra_retorno_w);
				end if;
				
				if (nr_seq_prestador_retorno_w IS NOT NULL AND nr_seq_prestador_retorno_w::text <> '') then
					nr_seq_prestador_w	:= nr_seq_prestador_retorno_w;
				end if;
				-- faz o lan_amento de procedimentos com base nos pacotes

				CALL pls_abrir_proc_pacote(
							r_c_procedimentos_w.nr_seq_preco_pacote, r_contas_w.nr_seq_conta, null,
							null, ie_evento_w, nr_seq_prestador_w,
							r_contas_w.ie_tipo_conta, r_contas_w.dt_atendimento, nm_usuario_p,
							r_c_procedimentos_w.nr_seq_conta_proc);
				commit;
			end if;
		end loop;
		
		-- busca os procedimentos				

		for r_c_materiais_w in c_materiais(r_contas_w.nr_seq_conta, nr_seq_conta_mat_p) loop
		
			pls_obter_evento_item(	null, null, r_c_materiais_w.nr_seq_conta_mat,
						cd_estabelecimento_p, r_contas_w.ie_tipo_guia,
						r_contas_w.ie_origem_conta, r_contas_w.nr_seq_tipo_atendimento, 
						r_c_materiais_w.ie_tipo_despesa, r_contas_w.nr_seq_segurado,
						r_contas_w.nr_seq_conta, 'N', null, nr_seq_evento_w, nr_seq_evento_prod_w, 'C', 
						r_contas_w.ie_regime_atendimento, r_contas_w.ie_saude_ocupacional
						);
						
			if (ie_gerar_grupo_ans_w = 'S') then	
				select	max(nr_seq_conselho)
				into STRICT	nr_seq_conselho_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= r_contas_w.cd_medico_executor;
				
				nr_seq_grupo_ans_w	:= pls_obter_grupo_ans(	null,null, nr_seq_conselho_w,
										r_contas_w.nr_seq_tipo_atendimento, r_contas_w.ie_tipo_guia, 
										r_contas_w.ie_regime_internacao, r_c_materiais_w.ie_tipo_despesa,
										'G',cd_estabelecimento_p, r_c_materiais_w.nr_seq_conta);
			end if;
			
			update	pls_conta_mat
			set	nr_seq_evento		= nr_seq_evento_w,
				nr_seq_evento_prod	= nr_seq_evento_prod_w,
				nr_seq_grupo_ans	= nr_seq_grupo_ans_w
			where	nr_sequencia		= r_c_materiais_w.nr_seq_conta_mat;
			commit;
		end loop;
		commit;
		
		-- trata a libera__o autom_tica do item

		CALL pls_liberar_item_automatic(	r_contas_w.nr_seq_conta, null, null, nm_usuario_p);
		commit;
	end if;
	--Necess_rio rodar o processo para que os valores utilizados para pagamento sejam atualizados corretamente

	CALL pls_atualiza_lib_conta(	r_contas_w.nr_seq_conta,'A',nm_usuario_p);
	commit;
	
	if (ie_atualiza_apresentado_w <> 'N') then
		-- atualiza os valores apresentados no sistema

		-- isso existe porque pode ser que o cliente n_o apresente valor e aceite exatamente o que o sistema calcular.

		-- _ uma daquelas coisas que foi feita, _ estranha e n_o conseguimos mais tirar porque os clientes reclamam se essa funcionalidade for desabilitada

		CALL pls_atualiza_valor_apresentado( null, null, null, r_contas_w.nr_seq_conta, nr_seq_conta_proc_p, cd_estabelecimento_p, nm_usuario_p);
 		commit;
	end if;
	
	--  atualiza o status dos pagamentos

	pls_atualiza_status_pag(r_contas_w.nr_seq_conta, nm_usuario_p);
	commit;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_consistir_pck.gerencia_liberacao_automatica ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
