-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_cta_consistir_pck.gera_views_valorizacao () AS $body$
DECLARE


ie_gera_novamente_w	pls_regra_preco_controle.ie_gera_novamente%type;

C01 CURSOR FOR
	SELECT	ie_tipo_preco,
		ie_tipo_tabela
	from	pls_regra_preco_ordem
	where	1 = 1
	group by
		ie_tipo_preco,
		ie_tipo_tabela;

C02 CURSOR FOR
	SELECT	ie_tipo_preco,
		ie_tipo_tabela
	from	pls_regra_preco_ordem_serv
	where	1 = 1
	group by
		ie_tipo_preco,
		ie_tipo_tabela;

C03 CURSOR FOR
	SELECT	ie_tipo_preco,
		ie_tipo_tabela
	from	pls_regra_preco_ordem_mat
	where	1 = 1
	group by
		ie_tipo_preco,
		ie_tipo_tabela;
BEGIN

select	max(ie_gera_novamente)
into STRICT	ie_gera_novamente_w
from	pls_regra_preco_controle;

-- se acaso n_o existir registro do select acima significa que as views n_o precisam ser regeradas

if (ie_gera_novamente_w = 'S') then

	-- atualiza a view respons_vel por ordenar as regras de pre_o quando existir regra de ordena__o

	-- s_ vai rodar caso seja alterado algo na pls_regra_preco_ordem

	for r_C01_w in C01 loop
		CALL pls_gerar_view_regra_preco(	r_C01_w.ie_tipo_preco, r_C01_w.ie_tipo_tabela);
	end loop;

	for r_C02_w in C02 loop
		CALL pls_gerar_view_regra_serv(	r_C02_w.ie_tipo_preco, r_C02_w.ie_tipo_tabela);
	end loop;

	for r_C03_w in C03 loop
		CALL pls_gerar_view_regra_mat(	r_C03_w.ie_tipo_preco, r_C03_w.ie_tipo_tabela);
	end loop;
	
	-- alimenta para n_o precisar gerar novamente

	CALL pls_cta_consistir_pck.define_ger_view_valorizacao('N');
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_consistir_pck.gera_views_valorizacao () FROM PUBLIC;
