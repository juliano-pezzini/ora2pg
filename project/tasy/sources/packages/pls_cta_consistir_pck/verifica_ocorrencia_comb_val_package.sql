-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- verifica todas as ocorr_ncias combinada que est_o habilitadas para o cliente



CREATE OR REPLACE PROCEDURE pls_cta_consistir_pck.verifica_ocorrencia_comb_val ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_evento_p text) AS $body$
DECLARE

						
c01 CURSOR(	nr_seq_lote_processo_pc	pls_cta_lote_processo.nr_sequencia%type) FOR
	SELECT distinct b.nr_seq_lote_conta
	from 	pls_cta_lote_proc_conta a,
		pls_conta_v b
	where 	a.nr_seq_lote_processo = nr_seq_lote_processo_pc
	and   	b.nr_sequencia = a.nr_seq_conta
	and   	(b.nr_seq_lote_conta IS NOT NULL AND b.nr_seq_lote_conta::text <> '');

c02 CURSOR(	nr_seq_lote_processo_pc	pls_cta_lote_processo.nr_sequencia%type) FOR
	SELECT 	distinct b.nr_seq_protocolo
	from 	pls_cta_lote_proc_conta a,
		pls_conta_v b
	where 	a.nr_seq_lote_processo = nr_seq_lote_processo_pc
	and   	b.nr_sequencia = a.nr_seq_conta
	and   	coalesce(b.nr_seq_lote_conta::text, '') = '';
BEGIN
--#D_cioAqui -> futuramente a rotina pls_atualizar_agrup_analise deve ser inutilizada e no lugar desta chamar a pls_atualizar_agrup_proc da pls_analise_cta_pck					

-- trata da organiza__o e hierarquia dos itens na tela (pr_-requisito para algumas valida__es)

pls_analise_cta_pck.pls_atualizar_agrup_proc(	nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p,
						nr_seq_conta_p, nm_usuario_p, cd_estabelecimento_p, 'C', 'N');
commit;

-- se for passado um lote de processo faz a segmenta__o por lote de an_lise

-- isso _ feito para obter melhor performance, visto que _ melhor segmentar para ter uma maior efici_ncia dos filtros

if (nr_seq_lote_processo_p IS NOT NULL AND nr_seq_lote_processo_p::text <> '') then
	
	-- pega todas as contas que tem nr_seq_lote_analise

	for r_c01_w in c01(nr_seq_lote_processo_p) loop
		CALL pls_cta_consistir_pck.pls_inativar_ocor_comb_val(	r_c01_w.nr_seq_lote_conta, nm_usuario_p	);
		CALL pls_oc_cta_gerar_combinada(	ie_evento_p, 'A', r_c01_w.nr_seq_lote_conta, null, null,
						null, null, null, null,
						'8', null, null, null, null, cd_estabelecimento_p, nm_usuario_p);
		/* Atualizar os pareceres das ocorr_ncias que foram inativas automaticamente */


		CALL pls_cta_consistir_pck.pls_grava_fluxo_ocor(	r_c01_w.nr_seq_lote_conta, null, null,
					null, nm_usuario_p);
	end loop;
	
	-- pega os protocolos de todas as contas que N_O tem nr_seq_lote_analise

	for r_c02_w in c02(nr_seq_lote_processo_p) loop
	
		CALL pls_oc_cta_gerar_combinada(	ie_evento_p, 'A', null, r_c02_w.nr_seq_protocolo, null,
						null, null, null, null,
						'8', null, null, null, null, cd_estabelecimento_p, nm_usuario_p);
	end loop;

else
	-- chama a rotina que gera as combinadas

	CALL pls_oc_cta_gerar_combinada(	ie_evento_p, 'A', nr_seq_lote_p, nr_seq_protocolo_p, null,
					nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_conta_mat_p, null,
					'8', null, null, null,null, cd_estabelecimento_p, nm_usuario_p);
end if;				
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_consistir_pck.verifica_ocorrencia_comb_val ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_evento_p text) FROM PUBLIC;
