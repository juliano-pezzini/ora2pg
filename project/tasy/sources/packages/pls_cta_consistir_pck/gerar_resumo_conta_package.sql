-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Procedure p_blica com os par_metros que definem quais as contas na qual sera gerado resumo



CREATE OR REPLACE PROCEDURE pls_cta_consistir_pck.gerar_resumo_conta ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p pls_outorgante.cd_estabelecimento%type, nr_seq_analise_p pls_conta.nr_seq_analise%type default null) AS $body$
DECLARE

				
_ora2pg_r RECORD;
tb_resumo_update_w	table_dados_resumo_conta;
tb_resumo_insert_w	table_dados_resumo_conta;
nr_indice_update_w	integer;
nr_indice_insert_w	integer;
ie_tipo_operacao_w	varchar(1);

C01 CURSOR(	nr_seq_lote_pc			pls_lote_protocolo_conta.nr_sequencia%type,
		nr_seq_protocolo_pc		pls_protocolo_conta.nr_sequencia%type,
		nr_seq_lote_processo_pc		pls_cta_lote_processo.nr_sequencia%type,
		nr_seq_conta_pc			pls_conta.nr_sequencia%type,
		nr_seq_analise_pc	pls_conta.nr_seq_analise%type)FOR
	
	--Cursor que retorna todas as contas a serem processadas

	SELECT	conta.nr_sequencia nr_sequencia
	from	pls_conta_v conta
	where	conta.nr_sequencia 	= nr_seq_conta_pc
	
union all

	SELECT	conta.nr_sequencia nr_sequencia
	from	pls_conta_v conta
	where	conta.nr_seq_protocolo 	= nr_seq_protocolo_pc
	and	coalesce(nr_seq_conta_pc::text, '') = ''
	
union all

	select	conta.nr_sequencia nr_sequencia
	from	pls_conta_v conta
	where	conta.nr_seq_lote_conta 	= nr_seq_lote_pc
	and	coalesce(nr_seq_conta_pc::text, '') = ''
	and	coalesce(nr_seq_protocolo_pc::text, '') = ''	
	
union all

	select	conta.nr_sequencia nr_sequencia
	from	pls_conta_v conta
	where	conta.nr_seq_analise 	= nr_seq_analise_pc
	and	coalesce(nr_seq_conta_pc::text, '') = ''
	and	coalesce(nr_seq_protocolo_pc::text, '') = ''	
	and	coalesce(nr_seq_lote_pc::text, '') = ''
	
union all

	select	conta.nr_sequencia nr_sequencia
	from	pls_conta_v conta
	where	coalesce(nr_seq_lote_pc::text, '') = ''
	and	coalesce(nr_seq_conta_pc::text, '') = ''
	and	coalesce(nr_seq_protocolo_pc::text, '') = ''	
	and	exists (select	1
			from	pls_cta_lote_proc_conta lote 
			where	lote.nr_seq_lote_processo	= nr_seq_lote_processo_pc 
			and     lote.nr_seq_conta  		= conta.nr_sequencia );	
			
BEGIN

tb_resumo_update_w := pls_cta_consistir_pck.limpa_tabela_resumo(tb_resumo_update_w);
tb_resumo_insert_w := pls_cta_consistir_pck.limpa_tabela_resumo(tb_resumo_insert_w);
nr_indice_update_w	:= 0;
nr_indice_insert_w	:= 0;

--Percorre todas as contas de acordo com par_metro passado, podendo ser uma _nica conta at_ um lote com N contas.

for r_C01_w in C01( nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p, nr_seq_analise_p) loop
			
	--Gera a linha do resumo com as informa__es de procedimentos

	SELECT * FROM pls_cta_consistir_pck.gerar_linha_resumo_proc(r_C01_w.nr_sequencia, nr_indice_update_w, nr_indice_insert_w, tb_resumo_update_w, tb_resumo_insert_w, 1, 'P', nm_usuario_p, cd_estabelecimento_p) INTO STRICT _ora2pg_r;
 nr_indice_update_w := _ora2pg_r.nr_indice_update_p; nr_indice_insert_w := _ora2pg_r.nr_indice_insert_p; tb_resumo_update_w := _ora2pg_r.tb_resumo_update_p; tb_resumo_insert_w := _ora2pg_r.tb_resumo_insert_p;
	--Gera a linha do resumo com as informa__es de di_rias

	SELECT * FROM pls_cta_consistir_pck.gerar_linha_resumo_proc(r_C01_w.nr_sequencia, nr_indice_update_w, nr_indice_insert_w, tb_resumo_update_w, tb_resumo_insert_w, 3, 'D', nm_usuario_p, cd_estabelecimento_p) INTO STRICT _ora2pg_r;
 nr_indice_update_w := _ora2pg_r.nr_indice_update_p; nr_indice_insert_w := _ora2pg_r.nr_indice_insert_p; tb_resumo_update_w := _ora2pg_r.tb_resumo_update_p; tb_resumo_insert_w := _ora2pg_r.tb_resumo_insert_p;
	--Gerada a linha do resumo com as informa__es de taxas

	SELECT * FROM pls_cta_consistir_pck.gerar_linha_resumo_proc(r_C01_w.nr_sequencia, nr_indice_update_w, nr_indice_insert_w, tb_resumo_update_w, tb_resumo_insert_w, 2, 'T', nm_usuario_p, cd_estabelecimento_p) INTO STRICT _ora2pg_r;
 nr_indice_update_w := _ora2pg_r.nr_indice_update_p; nr_indice_insert_w := _ora2pg_r.nr_indice_insert_p; tb_resumo_update_w := _ora2pg_r.tb_resumo_update_p; tb_resumo_insert_w := _ora2pg_r.tb_resumo_insert_p;
	--Gera a linha do resumo com as informa__es de pacotes

	SELECT * FROM pls_cta_consistir_pck.gerar_linha_resumo_proc(r_C01_w.nr_sequencia, nr_indice_update_w, nr_indice_insert_w, tb_resumo_update_w, tb_resumo_insert_w, 4, 'PCT', nm_usuario_p, cd_estabelecimento_p) INTO STRICT _ora2pg_r;
 nr_indice_update_w := _ora2pg_r.nr_indice_update_p; nr_indice_insert_w := _ora2pg_r.nr_indice_insert_p; tb_resumo_update_w := _ora2pg_r.tb_resumo_update_p; tb_resumo_insert_w := _ora2pg_r.tb_resumo_insert_p;
	--Gera a linha do resumo com as informa__es de materiais

	SELECT * FROM pls_cta_consistir_pck.gerar_linha_resumo_materiais(r_C01_w.nr_sequencia, nr_indice_update_w, nr_indice_insert_w, tb_resumo_update_w, tb_resumo_insert_w, 3, 'M', nm_usuario_p, cd_estabelecimento_p) INTO STRICT _ora2pg_r;
 nr_indice_update_w := _ora2pg_r.nr_indice_update_p; nr_indice_insert_w := _ora2pg_r.nr_indice_insert_p; tb_resumo_update_w := _ora2pg_r.tb_resumo_update_p; tb_resumo_insert_w := _ora2pg_r.tb_resumo_insert_p;
	--Gera a linha do resumo com as informa__es de medicamentos

	SELECT * FROM pls_cta_consistir_pck.gerar_linha_resumo_materiais(r_C01_w.nr_sequencia, nr_indice_update_w, nr_indice_insert_w, tb_resumo_update_w, tb_resumo_insert_w, 2, 'ME', nm_usuario_p, cd_estabelecimento_p) INTO STRICT _ora2pg_r;
 nr_indice_update_w := _ora2pg_r.nr_indice_update_p; nr_indice_insert_w := _ora2pg_r.nr_indice_insert_p; tb_resumo_update_w := _ora2pg_r.tb_resumo_update_p; tb_resumo_insert_w := _ora2pg_r.tb_resumo_insert_p;
	--Gera a linha do resumo com as informa__es de OPM

	SELECT * FROM pls_cta_consistir_pck.gerar_linha_resumo_materiais(r_C01_w.nr_sequencia, nr_indice_update_w, nr_indice_insert_w, tb_resumo_update_w, tb_resumo_insert_w, 7, 'O', nm_usuario_p, cd_estabelecimento_p) INTO STRICT _ora2pg_r;
 nr_indice_update_w := _ora2pg_r.nr_indice_update_p; nr_indice_insert_w := _ora2pg_r.nr_indice_insert_p; tb_resumo_update_w := _ora2pg_r.tb_resumo_update_p; tb_resumo_insert_w := _ora2pg_r.tb_resumo_insert_p;
	--Gera a linha do resumo com as informa__es de gases medicinais

	SELECT * FROM pls_cta_consistir_pck.gerar_linha_resumo_materiais(r_C01_w.nr_sequencia, nr_indice_update_w, nr_indice_insert_w, tb_resumo_update_w, tb_resumo_insert_w, 1, 'GM', nm_usuario_p, cd_estabelecimento_p) INTO STRICT _ora2pg_r;
 nr_indice_update_w := _ora2pg_r.nr_indice_update_p; nr_indice_insert_w := _ora2pg_r.nr_indice_insert_p; tb_resumo_update_w := _ora2pg_r.tb_resumo_update_p; tb_resumo_insert_w := _ora2pg_r.tb_resumo_insert_p;
		
end loop;

--Para garantir que todos os dados das listas(A lista utilizada para UPDATE e a lista utilizada para INSERT) sejam efetivamente atualizados.

CALL pls_cta_consistir_pck.atualiza_dados_resumo_conta( tb_resumo_insert_w, tb_resumo_update_w, nm_usuario_p, cd_estabelecimento_p);

tb_resumo_update_w := pls_cta_consistir_pck.limpa_tabela_resumo(tb_resumo_update_w);
tb_resumo_insert_w := pls_cta_consistir_pck.limpa_tabela_resumo(tb_resumo_insert_w);
nr_indice_update_w	:= 0;
nr_indice_insert_w	:= 0;

for r_C01_w in C01( nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p, nr_seq_analise_p) loop

--Gera a linha do resumo com as informa__es de totais

SELECT * FROM pls_cta_consistir_pck.gerar_linha_totais(r_C01_w.nr_sequencia, nr_indice_update_w, nr_indice_insert_w, tb_resumo_update_w, tb_resumo_insert_w, nm_usuario_p, cd_estabelecimento_p) INTO STRICT _ora2pg_r;
 nr_indice_update_w := _ora2pg_r.nr_indice_update_p; nr_indice_insert_w := _ora2pg_r.nr_indice_insert_p; tb_resumo_update_w := _ora2pg_r.tb_resumo_update_p; tb_resumo_insert_w := _ora2pg_r.tb_resumo_insert_p;
	
end loop;
----Para garantir que todos os dados das listas(A lista utilizada para UPDATE e a lista utilizada para INSERT) sejam efetivamente atualizados.

--Nesse caso trata-se apenas da linha de totais no resumo de contas.

CALL pls_cta_consistir_pck.atualiza_dados_resumo_conta( tb_resumo_insert_w, tb_resumo_update_w, nm_usuario_p, cd_estabelecimento_p);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_consistir_pck.gerar_resumo_conta ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p pls_outorgante.cd_estabelecimento%type, nr_seq_analise_p pls_conta.nr_seq_analise%type default null) FROM PUBLIC;
