-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Realiza consist_ncias antes de efetivamente fechar a conta



CREATE OR REPLACE PROCEDURE pls_cta_consistir_pck.pls_consiste_dados_stat_conta ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_origem_conta_p pls_conta.ie_origem_conta%type, ie_status_conta_p pls_conta.ie_status%type, ie_fechar_conta_glosa_p pls_parametros.ie_fechar_conta_glosa%type, ie_atende_glosado_p pls_analise_conta.ie_atende_glosado%type, nr_seq_regra_lib_p pls_analise_conta.nr_seq_regra_lib%type) AS $body$
DECLARE

					
ds_glosas_oc_w			varchar(255);
nr_seq_proc_glosa_inv_w		bigint;

BEGIN
	
--Se tiver glosas que n_o permitem fechamento 

if (pls_cta_consistir_pck.obter_se_glosas_impedem_fechar(nr_seq_conta_p, ie_status_conta_p,  ie_atende_glosado_p, ie_fechar_conta_glosa_p) = 'S') then
	
	--Se n_o tiver regra de libera__o automatica

	if (coalesce(nr_seq_regra_lib_p::text, '') = '') then
		
		ds_glosas_oc_w := pls_obter_glosas_oc_fechar(nr_seq_conta_p, 'G');
		
		-- A(s) glosa(s) (#@DS_GLOSAS#@) da conta (#@NR_SEQ_CONTA#@) n_o permitem o fechamento da mesma!

		CALL wheb_mensagem_pck.exibir_mensagem_abort(174329,	';DS_GLOSAS=' || ds_glosas_oc_w || '(' || ie_fechar_conta_glosa_p || ')' ||
								';' || 'NR_SEQ_CONTA=' ||nr_seq_conta_p);
	end if;
end if;

--Se existir ocorr_ncia que impede o fechamento da conta

if (pls_cta_consistir_pck.obter_se_ocor_impedem_fechar(nr_seq_conta_p, ie_status_conta_p, ie_atende_glosado_p) = 'S') then
	
	--Se n_o tiver regra de libera__o automatica

	if (coalesce(nr_seq_regra_lib_p::text, '') = '') then
		ds_glosas_oc_w := pls_obter_glosas_oc_fechar(nr_seq_conta_p, 'O');
		CALL wheb_mensagem_pck.exibir_mensagem_abort(174333,'DS_GLOSAS=' ||ds_glosas_oc_w|| ';' || 'NR_SEQ_CONTA=' ||nr_seq_conta_p);
	end if;
end if;

--Se existirem procedimentos e/ou materiais n_o liberados

if (pls_cta_consistir_pck.qtde_itens_nao_liberados(nr_seq_conta_p) > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(174331,'NR_SEQ_CONTA=' ||nr_seq_conta_p);
end if;

--Verifica se a soma entre o valor da glosa e liberado _ diferente do valor do procedimento

nr_seq_proc_glosa_inv_w := pls_cta_consistir_pck.obter_inconsist_val_lib_glosa(nr_seq_conta_p);
if (nr_seq_proc_glosa_inv_w IS NOT NULL AND nr_seq_proc_glosa_inv_w::text <> '') then

	CALL wheb_mensagem_pck.exibir_mensagem_abort(194109,'NR_SEQ_CONTA=' ||nr_seq_conta_p|| ';' || 'NR_SEQ_ITEM=' ||nr_seq_proc_glosa_inv_w);
end if;
		
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_consistir_pck.pls_consiste_dados_stat_conta ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_origem_conta_p pls_conta.ie_origem_conta%type, ie_status_conta_p pls_conta.ie_status%type, ie_fechar_conta_glosa_p pls_parametros.ie_fechar_conta_glosa%type, ie_atende_glosado_p pls_analise_conta.ie_atende_glosado%type, nr_seq_regra_lib_p pls_analise_conta.nr_seq_regra_lib%type) FROM PUBLIC;
