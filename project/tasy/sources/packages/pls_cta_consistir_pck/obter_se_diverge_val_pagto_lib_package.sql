-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Retorna  S se existem diverg_ncias entre os valores gerados para pagamento e os valores liberados !



CREATE OR REPLACE FUNCTION pls_cta_consistir_pck.obter_se_diverge_val_pagto_lib ( nr_seq_conta_p pls_conta.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE

ie_divergencia_w	varchar(1):= 'N';
								
C01 CURSOR(	nr_seq_conta_pc	pls_conta.nr_sequencia%type)FOR
	SELECT	a.vl_liberado,
		a.nr_sequencia nr_seq_item,
		( 	SELECT	coalesce(sum(vl_lib_original),0)
			from	pls_conta_medica_resumo
			where	nr_seq_conta_proc	= a.nr_sequencia
			and	ie_tipo_item 		<> 'I'
			and	vl_lib_original 	> 0
			and	((ie_situacao 		<> 'I') or (coalesce(ie_situacao::text, '') = ''))) vl_pagamento
	from	pls_conta_proc_v a
	where	nr_seq_conta 	= nr_seq_conta_p
	and (ie_status <> 'D' or coalesce(ie_status::text, '') = '')
	
union all

	select	b.vl_liberado,
		b.nr_sequencia nr_seq_item,
		(	select	coalesce(sum(vl_lib_original),0)
			from	pls_conta_medica_resumo
			where	nr_seq_conta_mat	= b.nr_sequencia
			and	ie_tipo_item 		<> 'I'
			and	vl_lib_original 	> 0
			and	((ie_situacao 		<>'I') or (coalesce(ie_situacao::text, '') = ''))) vl_pagamento
	from	pls_conta_mat_v b
	where	nr_seq_conta = nr_seq_conta_p
	and (ie_status <> 'D' or coalesce(ie_status::text, '') = '');
					
BEGIN
	
for r_C01_w in C01(nr_seq_conta_p) loop
	
	if (r_C01_w.vl_liberado <> r_C01_w.vl_pagamento) then
		ie_divergencia_w := 'S';
	end if;
end loop;

return ie_divergencia_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_cta_consistir_pck.obter_se_diverge_val_pagto_lib ( nr_seq_conta_p pls_conta.nr_sequencia%type) FROM PUBLIC;
