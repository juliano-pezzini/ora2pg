-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Executa o que for pr_-requisito para gera__o de valoriza__o, verifica__o de glosas e ocorr_ncias



CREATE OR REPLACE PROCEDURE pls_cta_consistir_pck.gerencia_pre_requisitos_gerais ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
BEGIN
-- verifica se _ poss_vel ler as informa__es do contrato do benefici_rio

CALL pls_cta_consistir_pck.verifica_dado_contrato(	nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p);
--  utilizada a fun__o original, por isso foi criado o cursor aqui fora

for r_contas_w in current_setting('pls_cta_consistir_pck.c_contas')::CURSOR((	nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p) loop
	
	update	pls_conta
	set	cd_guia_referencia	= cd_guia_referencia
	where	nr_sequencia		= r_contas_w.nr_seq_conta;
	commit;
end loop;
-- Gera as contas de honor_rio individual de acordo com o cadastro de regras em OPS - Cadastro de Regras, OPS - Contas m_dicas -> Abertura autom_tica de contas

CALL pls_cta_gera_hono_indiv_pck.gera_conta_hono_indiv(	nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p,
							nr_seq_conta_p, nr_seq_conta_proc_p, nm_usuario_p,
							cd_estabelecimento_p);
commit;
-- essa rotina _ chamada para atualizar o lote caso a gera__o seja por ele.

-- isso _ necess_rio pois no processo de gera__o de contas de honor_rio individual s_o criadas novas contas e as mesmas precisam ser inclu_das dentro do lote.

-- Criado o par_metro get_ie_conta_criada_w na rotina pls_util_pck, para que cado n_o seja aberta uma nova conta, n_o seja gerado o processo de gera__o do lote

if (nr_seq_lote_processo_p IS NOT NULL AND nr_seq_lote_processo_p::text <> '') and (pls_util_pck.get_ie_conta_criada_w = 'S') then
	CALL pls_cta_gerar_lote_processo(	nr_seq_lote_processo_p, nm_usuario_p,'N');
	commit;
end if;

--  utilizada a fun__o original, por isso foi criado o cursor aqui fora

for r_contas_w in current_setting('pls_cta_consistir_pck.c_contas')::CURSOR((	nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p) loop
	--necess_ria esta tratativa, pois os processos abaixo precissam da informa__o da an_lise, sem a mesma podem ser geradas descrep_ncias

	if (r_contas_w.nr_seq_analise IS NOT NULL AND r_contas_w.nr_seq_analise::text <> '') then
		-- Executar a regra de itens de lan_amento autom_tico

		CALL pls_lanc_auto_item_consist(	r_contas_w.nr_seq_conta, cd_estabelecimento_p, nm_usuario_p);
		commit;
		
		--Diego - OS 336653 - Gera__o de procedimentos e materiais autom_ticos.

		CALL pls_lanc_consiste_conta(	r_contas_w.nr_seq_conta, cd_estabelecimento_p, nm_usuario_p);
		commit;
		
		-- Diego - OS 351451 - Cancelar solicita__o de mat/med especiais que n_o est_o liberados

		CALL pls_canc_solic_matmed_conta(r_contas_w.nr_seq_conta, cd_estabelecimento_p, nm_usuario_p);
		commit;
	end if;
end loop;

-- executa updates padr_o (Redund_ncias, controles extras, etc)

CALL pls_cta_consistir_pck.executa_update_padrao(	nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p,
			'inicio_processo', nm_usuario_p, cd_estabelecimento_p);
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cta_consistir_pck.gerencia_pre_requisitos_gerais ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
