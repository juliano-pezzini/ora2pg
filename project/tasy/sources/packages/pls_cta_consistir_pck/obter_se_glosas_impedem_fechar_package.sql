-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Obt_m se existem glosas que impedem fechamento da conta



CREATE OR REPLACE FUNCTION pls_cta_consistir_pck.obter_se_glosas_impedem_fechar (nr_seq_conta_p pls_conta.nr_sequencia%type, ie_status_conta_p pls_conta.ie_status%type, ie_atende_glosado_p pls_analise_conta.ie_atende_glosado%type, ie_fechar_conta_glosa_p pls_parametros.ie_fechar_conta_glosa%type) RETURNS varchar AS $body$
DECLARE

ie_glosa_fechar_conta_w		varchar(1);


BEGIN

--Conta em an_lise

-- Pls_analise_conta_item: 

--'P' - status pendente, 'N' - n_o fechar conta, 'G' - glosa 

if (ie_status_conta_p = 'A') then
	select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ie_glosa_fechar_conta_w
	from	pls_analise_conta_item
	where	ie_status	= 'P' 
	and	ie_fechar_conta	= 'N'  
	and	ie_tipo		= 'G' 
	and	nr_seq_conta	= nr_seq_conta_p;
	
	-- Caso o atendimento(analise) esteja glosado, n_o _ consistido exist_ncia de  glosas 

	--e ocorr_ncias que n_o permitem o fechamento.

	if (coalesce(ie_atende_glosado_p,'N') = 'S') then
		ie_glosa_fechar_conta_w := 'N';
	end if;
else

	-- Obt_m a quantidade de glosas que N_O permitem fechar a conta 

	if (ie_fechar_conta_glosa_p = 'S') then
		select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
		into STRICT	ie_glosa_fechar_conta_w
		from	pls_glosa_conta_medica_v
		where	nr_seq_conta	= nr_seq_conta_p
		and	ie_fechar_conta	= 'N';
	else
		select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
		into STRICT	ie_glosa_fechar_conta_w
		from	pls_glosa_conta_medica_v	a
		where	a.nr_seq_conta		= nr_seq_conta_p
		and	a.ie_fechar_conta	= 'N'
		and	a.ie_situacao	= 'A'
		and (coalesce(a.ie_status_item::text, '') = '' or a.ie_status_item <> 'D');
	end if;
end if;

return ie_glosa_fechar_conta_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_cta_consistir_pck.obter_se_glosas_impedem_fechar (nr_seq_conta_p pls_conta.nr_sequencia%type, ie_status_conta_p pls_conta.ie_status%type, ie_atende_glosado_p pls_analise_conta.ie_atende_glosado%type, ie_fechar_conta_glosa_p pls_parametros.ie_fechar_conta_glosa%type) FROM PUBLIC;
