-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_imp_pre_pagto_pck.gerar_fat_conta_proc ( nr_seq_prot_gerado_p pls_faturamento_prot.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_gerada_w	pls_fat_conta_proc.nr_sequencia%type;
								
C01 CURSOR FOR
	SELECT	c.cd_ref_fabricante,
			c.cd_tipo_tabela_conv,
			c.dt_execucao,
			c.dt_fim,
			c.dt_inicio,
			c.ie_tipo_despesa_conv,
			c.nr_sequencia,
			c.cd_procedimento_conv,
			c.ie_origem_proced_conv,
			c.qt_executado,
			c.tx_reducao_acrescimo,
			c.vl_total,
			c.vl_unitario,
			c.ie_via_acesso,
			c.ie_tecnica_utilizada
	from	pls_faturamento_conta b,
			pls_fat_conta_item c
	where	b.nr_seq_protocolo = nr_seq_prot_gerado_p
	and		c.nr_seq_conta = b.nr_sequencia
	and 	c.ie_tipo_item_conv = 'P';
								
BEGIN

	for r_c01_w in C01 loop
	
		insert into pls_fat_conta_proc(	cd_procedimento_conv, cd_tipo_tabela_conv, dt_atualizacao,
					dt_atualizacao_nrec, dt_execucao_conv, dt_fim,                    
					dt_inicio, ie_origem_proced_conv, ie_tecnica_utilizada_conv, 
					ie_tipo_despesa_conv, ie_via_acesso_conv, nm_usuario,                
					nm_usuario_nrec, nr_seq_item_conta, nr_seq_setor_atend_conv,  
					nr_sequencia, qt_executado, tx_reducao_acrescimo, 
					vl_total, vl_unitario)
		values (	r_c01_w.cd_procedimento_conv, r_c01_w.cd_tipo_tabela_conv, clock_timestamp(),
					clock_timestamp(), r_c01_w.dt_execucao, r_c01_w.dt_fim,
					r_c01_w.dt_inicio, r_c01_w.ie_origem_proced_conv, r_c01_w.ie_tecnica_utilizada,
					r_c01_w.ie_tipo_despesa_conv, r_c01_w.ie_via_acesso, nm_usuario_p,
					nm_usuario_p, r_c01_w.nr_sequencia, null,
					nextval('pls_fat_conta_proc_seq'), r_c01_w.qt_executado, r_c01_w.tx_reducao_acrescimo,
					r_c01_w.vl_total, r_c01_w.vl_unitario
					) returning nr_sequencia into nr_seq_gerada_w;

		--agora que criou efetivamente o procedimento, atualiza profissionais importados que tenham vinculo com o mesmo

		update 	pls_fat_conta_item_equipe
		set	nr_seq_conta_proc = nr_seq_gerada_w
		where	nr_seq_item_conta = r_c01_w.nr_sequencia;
					
	end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_pre_pagto_pck.gerar_fat_conta_proc ( nr_seq_prot_gerado_p pls_faturamento_prot.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
