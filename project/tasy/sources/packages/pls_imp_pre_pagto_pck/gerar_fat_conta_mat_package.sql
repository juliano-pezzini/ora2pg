-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_imp_pre_pagto_pck.gerar_fat_conta_mat ( nr_seq_prot_gerado_p pls_faturamento_prot.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT ( 	SELECT 	max(cd_material_ops)
				from 	pls_material
				where	nr_sequencia = c.nr_seq_material_conv)cd_material_conv,
			c.cd_ref_fabricante,
			c.cd_tipo_tabela_conv,
			c.cd_unidade_medida,
			c.dt_execucao,
			c.dt_fim,
			c.dt_inicio,
			c.ie_tipo_despesa_conv,
			c.nr_aut_funcionamento,
			c.nr_registro_anvisa,
			c.nr_sequencia,
			c.nr_seq_material_conv,
			c.qt_executado,
			c.tx_reducao_acrescimo,
			c.vl_total,
			c.vl_unitario
	from	pls_faturamento_conta b,
			pls_fat_conta_item c
	where	b.nr_seq_protocolo = nr_seq_prot_gerado_p
	and		c.nr_seq_conta = b.nr_sequencia
	and 	c.ie_tipo_item_conv = 'M';
								
BEGIN

	for r_c01_w in C01 loop
	
		insert into pls_fat_conta_mat(	cd_material_conv, cd_ref_fabricante, cd_tipo_tabela_conv,
					cd_unidade_medida, dt_atualizacao, dt_atualizacao_nrec, 
					dt_execucao_conv, dt_fim, dt_inicio,           
					ie_tipo_cobertura, ie_tipo_despesa_conv, nm_usuario,          
					nm_usuario_nrec, nr_aut_funcionamento, nr_registro_anvisa,  
					nr_seq_item_conta, nr_seq_material_conv, qt_executado,
					tx_reducao_acrescimo, vl_total, vl_unitario, 
					nr_sequencia)
		values (	r_c01_w.cd_material_conv, r_c01_w.cd_ref_fabricante, r_c01_w.cd_tipo_tabela_conv,
					r_c01_w.cd_unidade_medida, clock_timestamp(), clock_timestamp(),
					r_c01_w.dt_execucao, r_c01_w.dt_fim, r_c01_w.dt_inicio,
					null , r_c01_w.ie_tipo_despesa_conv, nm_usuario_p,
					nm_usuario_p, r_c01_w.nr_aut_funcionamento, r_c01_w.nr_registro_anvisa,
					r_c01_w.nr_sequencia, r_c01_w.nr_seq_material_conv, r_c01_w.qt_executado,
					r_c01_w.tx_reducao_acrescimo, r_c01_w.vl_total, r_c01_w.vl_unitario,
					nextval('pls_fat_conta_mat_seq')
					);
	
	end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_pre_pagto_pck.gerar_fat_conta_mat ( nr_seq_prot_gerado_p pls_faturamento_prot.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
