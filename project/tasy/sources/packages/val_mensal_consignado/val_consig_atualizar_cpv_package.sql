-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



---------------------------------------------------------------
--- atualizar o cpv das operaçoes que não participam do custo medio
---------------------------------------------------------------
CREATE OR REPLACE PROCEDURE val_mensal_consignado.val_consig_atualizar_cpv ( cd_material_p bigint, cd_fornecedor_p text, cd_estabelecimento_p bigint , dt_mesano_referencia_p timestamp, vl_custo_medio_p bigint, nm_usuario_p text, nr_movimento_estoque_p INOUT bigint) AS $body$
DECLARE


nr_movimento_estoque_w		bigint   := 0;
qt_estoque_w			double precision := 0;
vl_movimento_w			double precision := 0;
cd_tipo_valor_w			bigint   := 7;
ie_entrada_saida_w		varchar(1);
vl_custo_medio_w		double precision;
dt_movimento_w			timestamp;
dt_custo_medio_w		timestamp;

c03 CURSOR FOR
SELECT	a.dt_movimento_estoque,
	a.nr_movimento_estoque,
	coalesce(a.qt_estoque,0),
	b.ie_entrada_saida
from	operacao_estoque b,
	movimento_estoque a
where	a.cd_material_estoque	= cd_material_p
and	a.cd_fornecedor		= cd_fornecedor_p
and	a.cd_estabelecimento	= cd_estabelecimento_p
and	a.dt_mesano_referencia	= dt_mesano_referencia_p
and	a.cd_operacao_estoque	= b.cd_operacao_estoque
and	(a.dt_processo IS NOT NULL AND a.dt_processo::text <> '')
and	coalesce(b.ie_consignado,'0') <> '0'
and	b.ie_altera_custo      = 'N'
order by 1;


BEGIN
dt_custo_medio_w            := clock_timestamp() - interval '2000 days';
vl_custo_medio_w            := 0;
nr_movimento_estoque_p      := 0;
open c03;
loop
fetch c03 into
	dt_movimento_w,
	nr_movimento_estoque_w,
	qt_estoque_w,
	ie_entrada_saida_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	delete
	from	movimento_estoque_valor
	where	nr_movimento_estoque  = nr_movimento_estoque_w
	and	cd_tipo_valor <> cd_tipo_valor_w;

	vl_movimento_w  := qt_estoque_w * vl_custo_medio_p;

	update	movimento_estoque_valor
	set	vl_movimento		= vl_movimento_w,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_movimento_estoque	= nr_movimento_estoque_w
	and	cd_tipo_valor		= cd_tipo_valor_w;
	if (NOT FOUND) then
		begin
		insert into movimento_estoque_valor
		values (	nr_movimento_estoque_w,
			cd_tipo_valor_w,
			vl_movimento_w,
			clock_timestamp(),
			nm_usuario_p);
		exception when others then
			qt_estoque_w    := 0;
		end;
	end if;

	if (ie_entrada_saida_w = 'S') then
		nr_movimento_estoque_p := nr_movimento_estoque_w;
	end if;
end loop;
close c03;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE val_mensal_consignado.val_consig_atualizar_cpv ( cd_material_p bigint, cd_fornecedor_p text, cd_estabelecimento_p bigint , dt_mesano_referencia_p timestamp, vl_custo_medio_p bigint, nm_usuario_p text, nr_movimento_estoque_p INOUT bigint) FROM PUBLIC;
