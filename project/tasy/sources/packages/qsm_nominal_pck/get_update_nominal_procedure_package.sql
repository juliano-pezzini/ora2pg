-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


----------------     GET_UPDATE_NOMINAL_PROCEDURE
CREATE OR REPLACE FUNCTION qsm_nominal_pck.get_update_nominal_procedure ( nr_seq_fila_p bigint) RETURNS SETOF T_UPDATE_NOMINAL_PROCEDURE AS $body$
DECLARE


nr_seq_documento_w			intpd_fila_transmissao.nr_seq_documento%type;
ie_evento_w				intpd_fila_transmissao.ie_evento%type;
ie_conversao_w				intpd_eventos_sistema.ie_conversao%type;
nr_seq_sistema_w			intpd_eventos_sistema.nr_seq_sistema%type;
nr_seq_regra_w				intpd_eventos_sistema.nr_seq_regra_conv%type;
r_update_nominal_procedure_w		r_update_nominal_procedure;

C01 CURSOR(nr_seq_documento_pc bigint) FOR
	SELECT	pr.cd_procedimento_loc ds_code,
		to_char(p.dt_procedimento, 'YYYY-MM-DD"T"HH24:MI:SS') dt_date,
		intpd_conv('ATEND_PACIENTE_UNIDADE', 'CD_DEPARTAMENTO', d.cd_departamento, nr_seq_regra_w, ie_conversao_w, 'E') ds_department,
		lpad(obter_conversao_301('C301_6_DEPARTAMENTO','DEPARTAMENTO_MEDICO',null,d.cd_departamento,'I'),4,'0') ds_department_type,
		p.nr_sequencia ds_key,
		CASE WHEN p.ie_lado='E' THEN  'left' WHEN p.ie_lado='D' THEN  'right' WHEN p.ie_lado='A' THEN  'both'  ELSE 'none' END  ds_localization,
		p.nr_atendimento ds_visit
	from	procedimento_paciente p, setor_atendimento s, departamento_setor d, procedimento pr
	where	p.cd_setor_atendimento	= s.cd_setor_atendimento
	and	p.cd_procedimento	= pr.cd_procedimento
	and	p.ie_origem_proced	= pr.ie_origem_proced
	and	s.cd_setor_atendimento	= d.cd_setor_atendimento
	and pr.ie_origem_proced = 11
	and	p.nr_atendimento in (SELECT nr_atendimento
							 from   atendimento_paciente
							 where  nr_seq_episodio = obter_episodio_atendimento(coalesce(nr_seq_documento_pc, 0)));

BEGIN
select	a.nr_seq_documento,
	a.ie_evento,
	coalesce(b.ie_conversao,'I'),
	b.nr_seq_sistema,
	b.nr_seq_regra_conv
into STRICT	nr_seq_documento_w,
	ie_evento_w,
	ie_conversao_w,
	nr_seq_sistema_w,
	nr_seq_regra_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia		= nr_seq_fila_p;

if (ie_evento_w = '54') or (ie_evento_w = '120') then

	for r_C01_w in C01(nr_seq_documento_w) loop
	begin
		r_update_nominal_procedure_w := qsm_nominal_pck.limpar_atributos_procedure(r_update_nominal_procedure_w);

		r_update_nominal_procedure_w.ds_code			:= r_C01_w.ds_code;
		r_update_nominal_procedure_w.dt_date			:= r_C01_w.dt_date;
		r_update_nominal_procedure_w.ds_department		:= r_C01_w.ds_department;
		r_update_nominal_procedure_w.ds_department_type		:= r_C01_w.ds_department_type;
		r_update_nominal_procedure_w.ds_key			:= r_C01_w.ds_key;
		r_update_nominal_procedure_w.ds_localization		:= r_C01_w.ds_localization;
		r_update_nominal_procedure_w.ds_visit			:= r_C01_w.ds_visit;

		RETURN NEXT r_update_nominal_procedure_w;
	end;
	end loop;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION qsm_nominal_pck.get_update_nominal_procedure ( nr_seq_fila_p bigint) FROM PUBLIC;
