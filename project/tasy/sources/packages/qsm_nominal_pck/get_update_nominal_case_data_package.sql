-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



----------------     GET_UPDATE_NOMINAL_DATA_DATA
CREATE OR REPLACE FUNCTION qsm_nominal_pck.get_update_nominal_case_data ( nr_seq_fila_p bigint) RETURNS SETOF T_UPDATE_NOMINAL_CASE_DATA AS $body$
DECLARE


nr_seq_documento_w			intpd_fila_transmissao.nr_seq_documento%type;
ie_evento_w				intpd_fila_transmissao.ie_evento%type;
nr_seq_agrupador_w			intpd_fila_transmissao.nr_seq_agrupador%type;
ie_conversao_w				intpd_eventos_sistema.ie_conversao%type;
nr_seq_sistema_w			intpd_eventos_sistema.nr_seq_sistema%type;
nr_seq_projeto_xml_w			intpd_eventos_sistema.nr_seq_projeto_xml%type;
nr_seq_regra_w				intpd_eventos_sistema.nr_seq_regra_conv%type;
r_update_nominal_case_data_w		r_update_nominal_case_data;
nr_atendimento_w			atendimento_paciente.nr_atendimento%type;
diagnostico_doenca_chave_w		dbms_sql.varchar2_table;

C01 CURSOR(nr_atendimento_pc bigint) FOR
	SELECT	to_char(a.dt_entrada, 'YYYY-MM-DD"T"HH24:MI:SS') dt_admission_date,
		'' ds_admission_occasion,
		lpad(obter_conversao_301('C301_1_MOTIVO_ADM_MOTIVO','CLASSIFICACAO_ATENDIMENTO',null,nr_seq_classificacao,'I'),2,'0') ||
		lpad(obter_conversao_301('C301_1_MOTIVO_ADM_TIPO','QUEIXA_PACIENTE',null,nr_seq_queixa,'I'),2,'0') ds_admission_reason,
		pf.qt_peso nr_admission_weight,
		obter_idade(pf.dt_nascimento, clock_timestamp(), 'A') nr_age,
		obter_idade(pf.dt_nascimento, clock_timestamp(), 'DIA') nr_age_days,
		coalesce(b.nr_episodio, b.nr_sequencia) ds_local_case_id,
		intpd_conv('ESTABELECIMENTO', 'CD_ESTABELECIMENTO', a.cd_estabelecimento, nr_seq_regra_w, ie_conversao_w, 'E') ds_client_id,
		to_char(a.dt_alta, 'YYYY-MM-DD"T"HH24:MI:SS') dt_discharge,
		lpad(obter_conversao_301('C301_5_MOT_ALTA_TRANSF','MOTIVO_ALTA',null,cd_motivo_alta,'I'),3,'0') ds_discharge_reason,
		a.cd_cgc_indicacao ds_ext_hospital_id,
		'true' ds_return_nominal_data,
		'true' ds_return_status,
		'true' ds_return_trigger_info,
		'0' nr_ventilation
	from	atendimento_paciente a,
		episodio_paciente b,
		pessoa_fisica pf
	where	a.nr_atendimento	= nr_atendimento_pc
	and	a.cd_pessoa_fisica	= pf.cd_pessoa_fisica
	and	b.nr_sequencia		= a.nr_seq_episodio;

BEGIN
select	a.nr_seq_documento,
	a.ie_evento,
	a.nr_seq_agrupador,
	coalesce(b.ie_conversao,'I'),
	b.nr_seq_sistema,
	b.nr_seq_projeto_xml,
	b.nr_seq_regra_conv
into STRICT	nr_seq_documento_w,
	ie_evento_w,
	nr_seq_agrupador_w,
	ie_conversao_w,
	nr_seq_sistema_w,
	nr_seq_projeto_xml_w,
	nr_seq_regra_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia		= nr_seq_fila_p;

if (ie_evento_w = '82') then
	diagnostico_doenca_chave_w := obter_lista_string(nr_seq_documento_w, obter_desc_expressao(960897));

	nr_atendimento_w := diagnostico_doenca_chave_w(1);
elsif (ie_evento_w = '54') then
	nr_atendimento_w := nr_seq_agrupador_w;
elsif (ie_evento_w = '120') or (ie_evento_w = '114') then
	nr_atendimento_w := nr_seq_documento_w;
else
	nr_atendimento_w := 0;
end if;

for r_C01_w in C01(nr_atendimento_w) loop
	begin
	r_update_nominal_case_data_w := qsm_nominal_pck.limpar_atributos_case_data(r_update_nominal_case_data_w);

	r_update_nominal_case_data_w.dt_admission_date		:= r_C01_w.dt_admission_date;
	r_update_nominal_case_data_w.ds_admission_occasion	:= r_C01_w.ds_admission_occasion;
	r_update_nominal_case_data_w.ds_admission_reason	:= r_C01_w.ds_admission_reason;
	r_update_nominal_case_data_w.nr_admission_weight	:= r_C01_w.nr_admission_weight;
	r_update_nominal_case_data_w.nr_age			:= r_C01_w.nr_age;
	r_update_nominal_case_data_w.nr_age_days		:= r_C01_w.nr_age_days;
	r_update_nominal_case_data_w.ds_local_case_id		:= r_C01_w.ds_local_case_id;
	r_update_nominal_case_data_w.ds_client_id		:= r_C01_w.ds_client_id;
	r_update_nominal_case_data_w.dt_discharge		:= r_C01_w.dt_discharge;
	r_update_nominal_case_data_w.ds_discharge_reason	:= r_C01_w.ds_discharge_reason;
	r_update_nominal_case_data_w.ds_ext_hospital_id		:= r_C01_w.ds_ext_hospital_id;
	r_update_nominal_case_data_w.ds_return_nominal_data	:= r_C01_w.ds_return_nominal_data;
	r_update_nominal_case_data_w.ds_return_status		:= r_C01_w.ds_return_status;
	r_update_nominal_case_data_w.ds_return_trigger_info	:= r_C01_w.ds_return_trigger_info;
	r_update_nominal_case_data_w.nr_ventilation		:= r_C01_w.nr_ventilation;

	RETURN NEXT r_update_nominal_case_data_w;
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION qsm_nominal_pck.get_update_nominal_case_data ( nr_seq_fila_p bigint) FROM PUBLIC;
