-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pfcs_pck_indicators.get_color ( nr_seq_indicator_p bigint, vl_indicator_p text, cd_establishment_p bigint, ds_cell_p text default null) RETURNS varchar AS $body$
DECLARE

        vl_reference_w  pfcs_panel.vl_indicator_dec%type;
        cd_type_w       pfcs_indicator.cd_type%type;
        cd_mask_w       locale_formats.ds_localized_mask%type;

BEGIN
        cd_type_w := pfcs_pck_indicators.get_type(nr_seq_indicator_p);
        if (substr(cd_type_w,1,5) = PFCS_PCK_CONSTANTS.CD_PREDICTED_PREFIX) then
           return PFCS_PCK_CONSTANTS.CD_COLOR_PREDICTION_BLUE;
        else
            if (cd_type_w = current_setting('pfcs_pck_indicators.cd_type_percentage')::varchar(1)) then
                vl_reference_w := isnumber(replace(vl_indicator_p,PFCS_PCK_CONSTANTS.DS_PERCENT_SIGN,''));
            elsif (cd_type_w = current_setting('pfcs_pck_indicators.cd_type_fraction')::varchar(1)) then
                vl_reference_w := isnumber(REGEXP_SUBSTR(vl_indicator_p,'[^/]+',1,1));
            elsif (cd_type_w = current_setting('pfcs_pck_indicators.cd_type_decimal')::varchar(1)) then
                vl_reference_w := round((to_number(substr(replace(vl_indicator_p,',','.'), 0, 20), '9999999999.99'))::numeric,2);
            elsif (cd_type_w = current_setting('pfcs_pck_indicators.cd_type_datetime')::varchar(1)) then
                cd_mask_w := (case when(position('M' in vl_indicator_p) > 0) then 'HH:Mi AM' else 'HH24:Mi' end);
                vl_reference_w := round( isnumber(to_char(to_date(vl_indicator_p, cd_mask_w),'HH24Mi')) );
            elsif (cd_type_w = current_setting('pfcs_pck_indicators.cd_type_time')::varchar(1)) then
                select  max(vl_indicator)
                into STRICT    vl_reference_w
                from    pfcs_panel
                where   nr_seq_indicator = nr_seq_indicator_p and
                        nr_seq_operational_level = cd_establishment_p;
            else
                vl_reference_w := isnumber(vl_indicator_p);
            end if;
            return pfcs_get_indicator_rule(nr_seq_indicator_p,vl_reference_w,cd_establishment_p,PFCS_PCK_CONSTANTS.CD_COLOR,ds_cell_p);
        end if;

        exception
            when others then
            return null;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_indicators.get_color ( nr_seq_indicator_p bigint, vl_indicator_p text, cd_establishment_p bigint, ds_cell_p text default null) FROM PUBLIC;
