-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_file_pck.pfcs_generate_panel_detail () AS $body$
DECLARE


	ds_err_w				varchar(255);
	ds_directory_w				varchar(255);
	ds_file_w				utl_file.file_type;
	nm_file_w				varchar(255);
	ds_columns_w 				varchar(4000) :=  	'NR_SEQUENCIA;DT_ATUALIZACAO;NM_USUARIO;DT_ATUALIZACAO_NREC;NM_USUARIO_NREC;NR_SEQ_INDICATOR;' ||
									'VL_INDICATOR;IE_SITUATION;NR_SEQ_PANEL;NR_SEQ_OPERATIONAL_LEVEL;NR_SEQ_TACTICAL_LEVEL';

	c_row CURSOR FOR
		SELECT	chr(39) || a.nr_sequencia		|| chr(39) || ';' ||
			chr(39) || to_char(a.dt_atualizacao,'dd/mm/yy hh24:mi:ss') || chr(39) || ';' ||
			chr(39) || a.nm_usuario			|| chr(39) || ';' ||
			chr(39) || to_char(a.dt_atualizacao_nrec,'dd/mm/yy hh24:mi:ss') || chr(39) || ';' ||
			chr(39) || a.nm_usuario_nrec		|| chr(39) || ';' ||
			chr(39) || a.nr_seq_indicator		|| chr(39) || ';' ||
			chr(39) || a.vl_indicator		|| chr(39) || ';' ||
			chr(39) || a.ie_situation		|| chr(39) || ';' ||
			chr(39) || a.nr_seq_panel		|| chr(39) || ';' ||
			chr(39) || b.cd_cgc			|| chr(39) || ';' ||
			chr(39) || cd_enterprise_w 		|| chr(39) ds_row
		from	pfcs_panel_detail	a,
			estabelecimento		b
		where	b.cd_estabelecimento	= a.nr_seq_operational_level
		and	a.ie_situation		= 'A'
		and	a.nr_seq_indicator in (77,78,79,80,83,84,85,86,87,88);
	
BEGIN

	nm_file_w	:= 'PFCS_PANEL_DETAIL_' || current_setting('pfcs_file_pck.ds_time_w')::varchar(255) || '.csv';

	obter_evento_utl_file(34, null, ds_directory_w, ds_err_w);

	ds_file_w := utl_file.fopen(ds_directory_w, nm_file_w, 'W');

	utl_file.put_line(ds_file_w, ds_columns_w);
	utl_file.fflush(ds_file_w);
	for c_row_w in c_row loop
		begin
		utl_file.put_line(ds_file_w,c_row_w.ds_row);
		utl_file.fflush(ds_file_w);
		end;
	end loop;

    utl_file.fclose(ds_file_w);
    EXCEPTION
        WHEN OTHERS
        THEN
          IF UTL_FILE.is_open(ds_file_w)
          THEN
             UTL_FILE.fclose(ds_file_w);
          END IF;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_file_pck.pfcs_generate_panel_detail () FROM PUBLIC;
