-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_file_pck.pfcs_generate_detail_employee () AS $body$
DECLARE


	ds_err_w				varchar(255);
	ds_directory_w				varchar(255);
	ds_file_w				utl_file.file_type;
	nm_file_w				varchar(255);
	ds_columns_w 				varchar(4000) :=  	'CD_PERSON;DS_CLINICAL_NOTE;DS_CONSULTATION_DEPT;DS_PERSON;DT_ATUALIZACAO;DT_ATUALIZACAO_NREC;NM_USUARIO;NM_USUARIO_NREC;NR_SEQ_DETAIL;NR_SEQUENCIA;' ||
									'CD_PERSON_COVID;DT_POSS_CONTACT';

	c_row CURSOR FOR
		SELECT	chr(39) || cd_person			|| chr(39) || ';' ||
			chr(39) || ds_clinical_note		|| chr(39) || ';' ||
			chr(39) || ds_consultation_dept		|| chr(39) || ';' ||
			chr(39) /*|| ds_person	*/
		|| chr(39) || ';' ||
			chr(39) || to_char(dt_atualizacao,'dd/mm/yy hh24:mi:ss') || chr(39) || ';' ||
			chr(39) || to_char(dt_atualizacao_nrec,'dd/mm/yy hh24:mi:ss') || chr(39) || ';' ||
			chr(39) || nm_usuario			|| chr(39) || ';' ||
			chr(39) || nm_usuario_nrec		|| chr(39) || ';' ||
			chr(39) || nr_seq_detail		|| chr(39) || ';' ||
			chr(39) || nr_sequencia 		|| chr(39) || ';' ||
			chr(39) || cd_person_covid 		|| chr(39) || ';' ||
			chr(39) || to_char(dt_poss_contact,'dd/mm/yy hh24:mi:ss') || chr(39) ds_row
		from	pfcs_detail_employee a
		where	exists (SELECT	1
				from	pfcs_panel_detail x
				where	x.nr_sequencia	= a.nr_seq_detail
				and	x.ie_situation	= 'A'
				and	x.nr_seq_indicator in (77,78,79,80,83,84,85,86,87,88));

	
BEGIN

	nm_file_w	:= 'PFCS_DETAIL_EMPLOYEE_' || current_setting('pfcs_file_pck.ds_time_w')::varchar(255) || '.csv';

	obter_evento_utl_file(34, null, ds_directory_w, ds_err_w);

	ds_file_w := utl_file.fopen(ds_directory_w, nm_file_w, 'W');

	utl_file.put_line(ds_file_w, ds_columns_w);
	utl_file.fflush(ds_file_w);
	for c_row_w in c_row loop
		begin
		utl_file.put_line(ds_file_w,c_row_w.ds_row);
		utl_file.fflush(ds_file_w);
		end;
	end loop;

    utl_file.fclose(ds_file_w);
    EXCEPTION
        WHEN OTHERS
        THEN
          IF UTL_FILE.is_open(ds_file_w)
          THEN
             UTL_FILE.fclose(ds_file_w);
          END IF;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_file_pck.pfcs_generate_detail_employee () FROM PUBLIC;
