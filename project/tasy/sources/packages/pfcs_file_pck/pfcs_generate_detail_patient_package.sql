-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_file_pck.pfcs_generate_detail_patient () AS $body$
DECLARE


	ds_err_w				varchar(255);
	ds_directory_w				varchar(255);
	ds_file_w				utl_file.file_type;
	nm_file_w				varchar(255);
	ds_columns_w 				varchar(4000) :=  	'NR_SEQUENCIA;DT_ATUALIZACAO;NM_USUARIO;DT_ATUALIZACAO_NREC;NM_USUARIO_NREC;ID_PATIENT;NM_PATIENT;' ||
									'NR_SEQ_DETAIL;QT_TIME_AWAITING_BED;DS_UNIT_PA;DS_CLASSIFICATION;QT_TIME_BOX_PA;DT_ENTRANCE;NR_ENCOUNTER;' ||
									'QT_TIME_QUEUE;QT_TIME_RECEPTION;QT_TIME_TRIAGE;QT_TIME_CALL;QT_TIME_EXAM;QT_TIME_MEDIC;QT_TIME_OUTCOME;' ||
									'QT_TIME_TOTAL_PA;QT_TIME_TOTAL_HOSPITALIZATION;QT_TIME_AWAIT_AFTER_DISCHARGE;NR_LAST_ENCOUNTER;DT_LAST_ENTRANCE;' ||
									'DS_GENDER;DT_BIRTHDATE;DS_PRIMARY_DIAGNOSIS;DS_DNR_STATUS;QT_TIME_TELEMETRY;DS_REQUESTED_UNIT;DS_BED_ASSIGNED;' ||
									'QT_RED_ALARMS;QT_YELLOW_ALARMS;DS_SERVICE_LINE;QT_TIME_STAGE_PA;IE_STAGE_PA;IE_OVER_THRESHOLD;CD_GROUP_PA;' ||
									'DS_GROUP_PA;IE_CLINIC;DS_CLINIC;DT_EXPECTED_DISCHARGE;DT_LAST_DISCHARGE;DS_PHYSICIAN;DS_REASON_DISCHARGE;CD_REASON_DISCHARGE;' ||
									'QT_TIME_SCHEDULE;CD_CLASSIFICATION;CD_STAGE_PA;DS_STAGE_PA;DS_CURRENT_LOCATION;IE_SYMPTOMS;DS_SYMPTOMS;DS_AGE_RANGE;' ||
									'NM_PHYSICIAN;IE_CONFIRMED;NR_ENCOUNTER_VARCHAR';

	c_row CURSOR FOR
		SELECT	chr(39) || nr_sequencia				|| chr(39) || ';' ||
			chr(39) || to_char(dt_atualizacao,'dd/mm/yy hh24:mi:ss')	|| chr(39) || ';' ||
			chr(39) || nm_usuario				|| chr(39) || ';' ||
			chr(39) || to_char(dt_atualizacao_nrec,'dd/mm/yy hh24:mi:ss') || chr(39) || ';' ||
			chr(39) || nm_usuario_nrec			|| chr(39) || ';' ||
			chr(39) || id_patient				|| chr(39) || ';' ||
			chr(39) /*|| nm_patient */
			|| chr(39) || ';' ||
			chr(39) || nr_seq_detail			|| chr(39) || ';' ||
			chr(39) || qt_time_awaiting_bed			|| chr(39) || ';' ||
			chr(39) || ds_unit_pa				|| chr(39) || ';' ||
			chr(39) || ds_classification			|| chr(39) || ';' ||
			chr(39) || qt_time_box_pa			|| chr(39) || ';' ||
			chr(39) || to_char(dt_entrance,'dd/mm/yy hh24:mi:ss')	|| chr(39) || ';' ||
			chr(39) || nr_encounter				|| chr(39) || ';' ||
			chr(39) || qt_time_queue			|| chr(39) || ';' ||
			chr(39) || qt_time_reception			|| chr(39) || ';' ||
			chr(39) || qt_time_triage			|| chr(39) || ';' ||
			chr(39) || qt_time_call				|| chr(39) || ';' ||
			chr(39) || qt_time_exam				|| chr(39) || ';' ||
			chr(39) || qt_time_medic			|| chr(39) || ';' ||
			chr(39) || qt_time_outcome			|| chr(39) || ';' ||
			chr(39) || qt_time_total_pa			|| chr(39) || ';' ||
			chr(39) || qt_time_total_hospitalization	|| chr(39) || ';' ||
			chr(39) || qt_time_await_after_discharge	|| chr(39) || ';' ||
			chr(39) || nr_last_encounter			|| chr(39) || ';' ||
			chr(39) || to_char(dt_last_entrance,'dd/mm/yy hh24:mi:ss')	|| chr(39) || ';' ||
			chr(39) || ds_gender				|| chr(39) || ';' ||
			chr(39) /*|| to_char(dt_birthdate,'dd/mm/yy hh24:mi:ss')*/
	|| chr(39) || ';' ||
			chr(39) || ds_primary_diagnosis			|| chr(39) || ';' ||
			chr(39) || ds_dnr_status			|| chr(39) || ';' ||
			chr(39) || qt_time_telemetry			|| chr(39) || ';' ||
			chr(39) /*|| ds_requested_unit */
		|| chr(39) || ';' ||
			chr(39) || ds_bed_assigned			|| chr(39) || ';' ||
			chr(39) || qt_red_alarms			|| chr(39) || ';' ||
			chr(39) || qt_yellow_alarms			|| chr(39) || ';' ||
			chr(39) || ds_service_line			|| chr(39) || ';' ||
			chr(39) || qt_time_stage_pa			|| chr(39) || ';' ||
			chr(39) || ie_stage_pa				|| chr(39) || ';' ||
			chr(39) || ie_over_threshold			|| chr(39) || ';' ||
			chr(39) || cd_group_pa				|| chr(39) || ';' ||
			chr(39) || ds_group_pa				|| chr(39) || ';' ||
			chr(39) || ie_clinic				|| chr(39) || ';' ||
			chr(39) || ds_clinic				|| chr(39) || ';' ||
			chr(39) || to_char(dt_expected_discharge,'dd/mm/yy hh24:mi:ss') || chr(39) || ';' ||
			chr(39) || to_char(dt_last_discharge,'dd/mm/yy hh24:mi:ss') || chr(39) || ';' ||
			chr(39) /*|| ds_physician		*/
		|| chr(39) || ';' ||
			chr(39) || ds_reason_discharge			|| chr(39) || ';' ||
			chr(39) || cd_reason_discharge			|| chr(39) || ';' ||
			chr(39) || qt_time_schedule			|| chr(39) || ';' ||
			chr(39) || cd_classification			|| chr(39) || ';' ||
			chr(39) || cd_stage_pa				|| chr(39) || ';' ||
			chr(39) || ds_stage_pa				|| chr(39) || ';' ||
			chr(39) || ds_current_location 			|| chr(39) || ';' ||
			chr(39) || ie_symptoms 				|| chr(39) || ';' ||
			chr(39) || ds_symptoms 				|| chr(39) || ';' ||
			chr(39) || ds_age_range 			|| chr(39) || ';' ||
			chr(39) /*|| nm_physician */
			|| chr(39) || ';' ||
			chr(39) || ie_confirmed 			|| chr(39) || ';' ||
			chr(39) || nr_encounter_varchar			|| chr(39) ds_row
		from	pfcs_detail_patient a
		where	exists (SELECT	1
				from	pfcs_panel_detail x
				where	x.nr_sequencia	= a.nr_seq_detail
				and	x.ie_situation	= 'A'
				and	x.nr_seq_indicator in (77,78,79,80,83,84,85,86,87,88));

	
BEGIN

	nm_file_w	:= 'PFCS_DETAIL_PATIENT_' || current_setting('pfcs_file_pck.ds_time_w')::varchar(255) || '.csv';

	obter_evento_utl_file(34, null, ds_directory_w, ds_err_w);

	ds_file_w := utl_file.fopen(ds_directory_w, nm_file_w, 'W');

	utl_file.put_line(ds_file_w, ds_columns_w);
	utl_file.fflush(ds_file_w);
	for c_row_w in c_row loop
		begin
		utl_file.put_line(ds_file_w,c_row_w.ds_row);
		utl_file.fflush(ds_file_w);
		end;
	end loop;

    utl_file.fclose(ds_file_w);
    EXCEPTION
        WHEN OTHERS
        THEN
          IF UTL_FILE.is_open(ds_file_w)
          THEN
             UTL_FILE.fclose(ds_file_w);
          END IF;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_file_pck.pfcs_generate_detail_patient () FROM PUBLIC;
