-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pfcs_file_pck.pfcs_generate_detail_bed () AS $body$
DECLARE



	ds_err_w				varchar(255);
	ds_directory_w				varchar(255);
	ds_file_w				utl_file.file_type;
	nm_file_w				varchar(255);
	ds_columns_w 				varchar(4000) :=  	'CD_BED;CD_DEPARTMENT;CD_STATUS;CD_TYPE;DS_CLASSIFICATION;DS_DEPARTMENT;DS_LOCATION;DS_REASON_BLOCKED;DS_SANITIZATION_SERVICE;' ||
									'DS_STATUS;DS_TYPE;DT_ATUALIZACAO;DT_ATUALIZACAO_NREC;DT_ENTRY_UNIT;IE_STATUS;IE_TEMPORARY;IE_TYPE;NM_USUARIO;NM_USUARIO_NREC;' ||
									'NR_SEQ_CLASSIF;NR_SEQ_DETAIL;NR_SEQUENCIA;QT_TIME_AVERAGE_AVAILABLE;QT_TIME_BLOCKED;QT_TIME_OCUP_AFTER_DISCHARGE;QT_TIME_SANITIZATION;' ||
									'IE_RESPIRATOR;IE_CLASSIFICATION';

	c_row CURSOR FOR
		SELECT	chr(39) || cd_bed			|| chr(39) || ';' ||
			chr(39) || cd_department		|| chr(39) || ';' ||
			chr(39) || cd_status			|| chr(39) || ';' ||
			chr(39) || cd_type			|| chr(39) || ';' ||
			chr(39) || ds_classification		|| chr(39) || ';' ||
			chr(39) || ds_department		|| chr(39) || ';' ||
			chr(39) || ds_location			|| chr(39) || ';' ||
			chr(39) || ds_reason_blocked		|| chr(39) || ';' ||
			chr(39) || ds_sanitization_service	|| chr(39) || ';' ||
			chr(39) || ds_status			|| chr(39) || ';' ||
			chr(39) || ds_type			|| chr(39) || ';' ||
			chr(39) || to_char(dt_atualizacao,'dd/mm/yy hh24:mi:ss') || chr(39) || ';' ||
			chr(39) || to_char(dt_atualizacao_nrec,'dd/mm/yy hh24:mi:ss') || chr(39) || ';' ||
			chr(39) || to_char(dt_entry_unit,'dd/mm/yy hh24:mi:ss') || chr(39) || ';' ||
			chr(39) || ie_status			|| chr(39) || ';' ||
			chr(39) || ie_temporary			|| chr(39) || ';' ||
			chr(39) || ie_type			|| chr(39) || ';' ||
			chr(39) || nm_usuario			|| chr(39) || ';' ||
			chr(39) || nm_usuario_nrec		|| chr(39) || ';' ||
			chr(39) || nr_seq_classif		|| chr(39) || ';' ||
			chr(39) || nr_seq_detail		|| chr(39) || ';' ||
			chr(39) || nr_sequencia			|| chr(39) || ';' ||
			chr(39) || qt_time_average_available	|| chr(39) || ';' ||
			chr(39) || qt_time_blocked		|| chr(39) || ';' ||
			chr(39) || qt_time_ocup_after_discharge	|| chr(39) || ';' ||
			chr(39) || qt_time_sanitization 	|| chr(39) || ';' ||
			chr(39) || ie_respirator 		|| chr(39) || ';' ||
			chr(39) || ie_classification 		|| chr(39) ds_row
		from	pfcs_detail_bed a
		where	exists (SELECT	1
				from	pfcs_panel_detail x
				where	x.nr_sequencia	= a.nr_seq_detail
				and	x.ie_situation	= 'A'
				and	x.nr_seq_indicator in (77,78,79,80,83,84,85,86,87,88));

	
BEGIN

	nm_file_w	:= 'PFCS_DETAIL_BED_' || current_setting('pfcs_file_pck.ds_time_w')::varchar(255) || '.csv';

	obter_evento_utl_file(34, null, ds_directory_w, ds_err_w);

	ds_file_w := utl_file.fopen(ds_directory_w, nm_file_w, 'W');

	utl_file.put_line(ds_file_w, ds_columns_w);
	utl_file.fflush(ds_file_w);
	for c_row_w in c_row loop
		begin
		utl_file.put_line(ds_file_w,c_row_w.ds_row);
		utl_file.fflush(ds_file_w);
		end;
	end loop;
    utl_file.fclose(ds_file_w);
    EXCEPTION
        WHEN OTHERS
        THEN
          IF UTL_FILE.is_open(ds_file_w)
          THEN
             UTL_FILE.fclose(ds_file_w);
          END IF;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_file_pck.pfcs_generate_detail_bed () FROM PUBLIC;
