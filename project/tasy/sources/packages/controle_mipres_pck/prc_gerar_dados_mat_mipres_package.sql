-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE controle_mipres_pck.prc_gerar_dados_mat_mipres (nr_atendimento_p prescr_mipres.nr_atendimento%type, nr_prescricao_p prescr_mipres.nr_prescricao%type, nm_usuario_p prescr_disp_mipres.nm_usuario%type, cComitar_p text) AS $body$
DECLARE


    nr_seq_mipres_w          prescr_disp_mipres.nr_seq_prescr_mipres%type;
    nr_seq_prescr_mipres_w   prescr_disp_mipres.nr_sequencia%type;
    nr_seq_mat_hor_w         prescr_disp_mipres.nr_seq_mat_hor%type;
    ie_status_w              prescr_disp_mipres.ie_status%type;
    dt_lib_horario_w         prescr_mat_hor.dt_lib_horario%type;

    c01 CURSOR FOR
      SELECT a.nr_sequencia nr_seq_prescr_mipres,
             b.nr_sequencia nr_seq_mat_hor,
             b.ie_situacao ie_status,
             b.dt_lib_horario
      from prescr_mipres a, prescr_mat_hor b
      where a.nr_prescricao = b.nr_prescricao
      and   a.nr_atendimento = b.nr_atendimento
      and   a.nr_prescricao = nr_prescricao_p
      and   a.nr_atendimento = nr_atendimento_p
      and (obter_se_item_mipres(a.nr_prescricao, a.nr_atendimento) = 'S')
      and   (b.dt_lib_horario IS NOT NULL AND b.dt_lib_horario::text <> '')
      and not exists (SELECT 1
                      from prescr_disp_mipres c
                      where c.nr_seq_mat_hor = b.nr_sequencia
                      and c.nr_seq_prescr_mipres = a.nr_sequencia);

    
BEGIN
      open c01;
        loop
          fetch c01 into
            nr_seq_prescr_mipres_w,
            nr_seq_mat_hor_w,
            ie_status_w,
            dt_lib_horario_w;
          EXIT WHEN NOT FOUND; /* apply on c01 */

          select nextval('prescr_disp_mipres_seq')
          into STRICT	nr_seq_mipres_w
;

          insert into prescr_disp_mipres(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            dt_dispensacao_mipres,
            nr_token_mipres,
            nr_seq_proc_hor,
            nr_seq_mat_hor,
            ie_status,
            nr_seq_prescr_mipres,
            ds_stack
          )
          values (
            nr_seq_mipres_w,
            clock_timestamp(),
            nm_usuario_p,
            clock_timestamp(),
            nm_usuario_p,
            null,
            '',
            null,
            nr_seq_mat_hor_w,
            '1', -- Pendente
            nr_seq_prescr_mipres_w,
            ''   
          );

          if (cComitar_p = 'S') then commit; end if;

        end loop;
      close c01;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE controle_mipres_pck.prc_gerar_dados_mat_mipres (nr_atendimento_p prescr_mipres.nr_atendimento%type, nr_prescricao_p prescr_mipres.nr_prescricao%type, nm_usuario_p prescr_disp_mipres.nm_usuario%type, cComitar_p text) FROM PUBLIC;
