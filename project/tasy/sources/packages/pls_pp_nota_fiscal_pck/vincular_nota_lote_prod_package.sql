-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pp_nota_fiscal_pck.vincular_nota_lote_prod (nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_serie_nf_p nota_fiscal.cd_serie_nf%type, cd_operacao_nf_p nota_fiscal.cd_operacao_nf%type, dt_emissao_p timestamp, cd_natureza_operacao_p bigint, ds_observacao_p text, ds_complemento_p text, dt_base_venc_p timestamp, nr_nota_fiscal_p nota_fiscal.nr_nota_fiscal%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_base_venc_p text, nr_seq_nota_fiscal_p INOUT nota_fiscal.nr_sequencia%type) AS $body$
DECLARE


nr_seq_nota_fiscal_w		nota_fiscal.nr_sequencia%type;
ds_consistencia_w		varchar(255);
ie_perm_vin_nf_fechada_w	varchar(1);

C01 CURSOR FOR
	SELECT	b.nr_titulo
	from	titulo_pagar b,
		pls_pp_prestador a
	where	b.nr_titulo	= a.nr_titulo_pagar
	and	b.ie_tipo_titulo	<> '4'
	and	a.nr_seq_lote		= nr_seq_lote_p
	and	a.nr_seq_prestador	= nr_seq_prestador_p
	and	ie_perm_vin_nf_fechada_w = 'N'
	and 	b.ie_situacao = 'A'
	
union all

	SELECT	b.nr_titulo
	from	titulo_pagar b,
		pls_pp_prestador a
	where	b.nr_titulo	= a.nr_titulo_pagar
	and	b.ie_tipo_titulo	<> '4'
	and	a.nr_seq_lote		= nr_seq_lote_p
	and	a.nr_seq_prestador	= nr_seq_prestador_p
	and	ie_perm_vin_nf_fechada_w = 'S';
	
C02 CURSOR FOR
	SELECT	coalesce(sum(CASE WHEN b.ie_situacao='A' THEN 1  ELSE 0 END ),0) qt_aberto,
		coalesce(sum(CASE WHEN b.ie_situacao='A' THEN 0  ELSE 1 END ),0) qt_nao_aberto
	from	titulo_pagar 		b,
		pls_pp_prestador a
	where	b.nr_titulo	= a.nr_titulo_pagar
	and	b.ie_tipo_titulo 	<> '4'
	and	a.nr_seq_lote		= nr_seq_lote_p
	and	a.nr_seq_prestador	= nr_seq_prestador_p;
	
BEGIN
ie_perm_vin_nf_fechada_w := obter_valor_param_usuario(1282, 30, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);

if (ie_perm_vin_nf_fechada_w = 'N') then
	for r_C02_w in C02 loop
		if (r_C02_w.qt_aberto = 0) and (r_C02_w.qt_nao_aberto > 0) then
			--Não é possível vincular notas fiscais em títulos a pagar que não estejam com a situação em "Aberto".
			CALL wheb_mensagem_pck.exibir_mensagem_abort(355986);
		end if;
	end loop;
end if;

-- Verificado se já existe uma nota fiscal gerada para este vencimento
/*select	max(nr_sequencia)
into	nr_seq_nota_fiscal_w
from	nota_fiscal
where	nr_seq_pgto_prest = nr_seq_prestador_pgto_p;

if	(nr_seq_nota_fiscal_w is not null) then
	--Mensagem: Já existe nota fiscal gerada para este vencimento!
	wheb_mensagem_pck.exibir_mensagem_abort(265325,'');
end if;*/
update 	pls_pp_prestador
set	nr_nota_fiscal		= nr_nota_fiscal_p
where	nr_seq_lote		= nr_seq_lote_p
and	nr_seq_prestador	= nr_seq_prestador_p;

nr_seq_nota_fiscal_w := pls_pp_nota_fiscal_pck.gerar_notas_lote_prod(	nr_seq_lote_p, cd_serie_nf_p, cd_operacao_nf_p, dt_emissao_p, cd_natureza_operacao_p, ds_observacao_p, ds_complemento_p, dt_base_venc_p, nr_nota_fiscal_p, nm_usuario_p, 'S', nr_seq_prestador_p, cd_estabelecimento_p, ie_base_venc_p, nr_seq_nota_fiscal_w);

if (coalesce(nr_seq_nota_fiscal_w::text, '') = '') then
	--Mensagem: Não foi gerada nota fiscal para o lote!
	CALL wheb_mensagem_pck.exibir_mensagem_abort(265323,'');
end if;

nr_seq_nota_fiscal_p := nr_seq_nota_fiscal_w;

for r_c01_w in c01 loop
	vincular_titulo_pagar_nf( nr_seq_nota_fiscal_w, r_c01_w.nr_titulo, nm_usuario_p, 'A','S', ds_consistencia_w);
end loop;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_nota_fiscal_pck.vincular_nota_lote_prod (nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_serie_nf_p nota_fiscal.cd_serie_nf%type, cd_operacao_nf_p nota_fiscal.cd_operacao_nf%type, dt_emissao_p timestamp, cd_natureza_operacao_p bigint, ds_observacao_p text, ds_complemento_p text, dt_base_venc_p timestamp, nr_nota_fiscal_p nota_fiscal.nr_nota_fiscal%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_base_venc_p text, nr_seq_nota_fiscal_p INOUT nota_fiscal.nr_sequencia%type) FROM PUBLIC;
