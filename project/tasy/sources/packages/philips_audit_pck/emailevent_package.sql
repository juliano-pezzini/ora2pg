-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE philips_audit_pck.emailevent ( nm_usuario_p text, ds_usuario_p text, cd_estabelecimento_p text, ds_estabelecimento_p text, host_address_p text, sender_p text, recipient_p text, recipientCopy_p text, recipientHidden_p text, subject_p text, content_p text, smtpAddress_p text, smtpPort_p text, smtpUser_p text, smtpPass_p text, smtpSSL_p text, confirmation_p text, priority_p text) AS $body$
DECLARE

    REQ utl_http.req;
    RES utl_http.resp;
    ADDRESS_SERVER varchar(250);
    CONTENT_DATA text;

BEGIN
   ADDRESS_SERVER := philips_audit_pck.getaddress();

    IF (ADDRESS_SERVER IS NOT NULL AND ADDRESS_SERVER::text <> '') THEN

	CONTENT_DATA := '{
			  "userID" : "' || nm_usuario_p || '",
			  "userFullName" : "' || ds_usuario_p || '",
               		  "establishment" : {
                         	"code" : ' || cd_estabelecimento_p || ',
		                "name" : "' || ds_estabelecimento_p || '"
	                  },
			  "hostAddress" : "' || host_address_p || '",
			  "subject" : "' || subject_p || '",
			  "content" : "' || content_p || '",
			  "sender" : "' || sender_p || '",
			  "recipient" : "' || recipient_p || '",
			  "recipientCopy" : "' || recipientCopy_p || '",
			  "recipientHiddenCopy" : "' || recipientHidden_p || '",
			  "userEmail" : "' || smtpUser_p || '",
			  "passwordEmail" : "' || smtpPass_p || '",
			  "smtp" : "' || smtpAddress_p  || '",
			  "port" : "' || smtpPort_p || '",
			  "ssl" : ' || smtpSSL_p || ',
			  "confirmation" : ' || confirmation_p || ',
			  "priority" : "' || priority_p || '"
			}';


        UTL_HTTP.set_wallet(getWallet, NULL);
        REQ := utl_http.begin_request(ADDRESS_SERVER || '/philips-audit/EmailEvent', 'POST');
		utl_http.set_header(REQ, 'content-type', 'application/json');
		utl_http.set_header(REQ, 'Content-Length', LENGTH(CONTENT_DATA));

		utl_http.write_text(REQ, CONTENT_DATA);

		RES := utl_http.get_response(REQ);

		BEGIN
			utl_http.end_response(RES);
		EXCEPTION
			WHEN utl_http.end_of_body THEN
				utl_http.end_response(RES);
		END;
    END IF;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE philips_audit_pck.emailevent ( nm_usuario_p text, ds_usuario_p text, cd_estabelecimento_p text, ds_estabelecimento_p text, host_address_p text, sender_p text, recipient_p text, recipientCopy_p text, recipientHidden_p text, subject_p text, content_p text, smtpAddress_p text, smtpPort_p text, smtpUser_p text, smtpPass_p text, smtpSSL_p text, confirmation_p text, priority_p text) FROM PUBLIC;
