-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION encounter_json_pck.get_encounter_message (NR_ATENDIMENTO_P bigint) RETURNS PHILIPS_JSON AS $body$
DECLARE

    JSON_SYSTEM_W      PHILIPS_JSON;
    JSON_ENCOUNTER_W   PHILIPS_JSON;
    JSON_PATIENT_W     PHILIPS_JSON;
    CD_PESSOA_FISICA_W PESSOA_FISICA.CD_PESSOA_FISICA%TYPE;
    JSON_RETURN_W      PHILIPS_JSON;
    JSON_ALLERGY_W     PHILIPS_JSON_LIST;
    json_card_list_w	philips_json_list;

BEGIN
    JSON_RETURN_W := PHILIPS_JSON();

    SELECT MAX(CD_PESSOA_FISICA)
      INTO STRICT CD_PESSOA_FISICA_W
      FROM ATENDIMENTO_PACIENTE
     WHERE NR_ATENDIMENTO = NR_ATENDIMENTO_P;

    JSON_SYSTEM_W    := PERSON_JSON_PCK.GET_SYSTEM_DATA();
    JSON_ENCOUNTER_W := encounter_json_pck.get_encounter(NR_ATENDIMENTO_P);
    JSON_PATIENT_W   := PERSON_JSON_PCK.GET_PERSON(CD_PESSOA_FISICA_W);
    JSON_ALLERGY_W   := PERSON_JSON_PCK.GET_ALLERGY(CD_PESSOA_FISICA_W);

    JSON_RETURN_W.PUT('systemData', JSON_SYSTEM_W.TO_JSON_VALUE);
    JSON_RETURN_W.PUT('patientIdentification', JSON_PATIENT_W.TO_JSON_VALUE);
    JSON_RETURN_W.PUT('patientVisit', JSON_ENCOUNTER_W.TO_JSON_VALUE);
    JSON_RETURN_W.PUT('patientAllergy', JSON_ALLERGY_W.TO_JSON_VALUE);
    json_card_list_w	:= PERSON_JSON_PCK.get_consession_card(CD_PESSOA_FISICA_W);
    JSON_RETURN_W.put('consessionCard',json_card_list_w.to_json_value);

    RETURN JSON_RETURN_W;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION encounter_json_pck.get_encounter_message (NR_ATENDIMENTO_P bigint) FROM PUBLIC;
