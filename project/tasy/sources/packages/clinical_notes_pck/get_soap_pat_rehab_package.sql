-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_pat_rehab ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_record_sub_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

ds_content_w varchar(32000);
clinical_note_fields CURSOR FOR
SELECT *
from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,ie_record_sub_type_p,ie_soap_type_p,ie_stage_p));

/*Rehabilitation - Patient registration */

c01 CURSOR FOR
SELECT
obter_nome_pf(cd_medico_resp) ds_medico_w,
(select ds_origem_paciente from rp_origem_paciente where nr_sequencia = a.nr_seq_origem_paciente) ds_origin_w,
b.rp_disability_status ds_disability_w,
obter_valor_dominio(6,b.ie_trat_principal)main_trtmnt_w,
(select ds_status from rp_status_reabilitacao where nr_sequencia = a.nr_seq_status) ds_status_w,
a.ds_observacao ds_notes_w,
(select ds_tratamento from rp_tipo_tratamento where nr_sequencia = b.nr_seq_tipo_tratamento) ds_trtmnt_type_w,
(select ds_calc_classif from rp_calc_classif where nr_sequencia = b.nr_seq_calc_classif) ds_calc_classif_w,
pkg_date_formaters.to_varchar(b.dt_inicio_tratamento, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_strt_trtmnt_w,
pkg_date_formaters.to_varchar(b.dt_fim_tratamento, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_end_trtmnt_w,
pkg_date_formaters.to_varchar(b.dt_prevista_alta, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_est_dschrg_w,
obter_valor_dominio(10031,b.ie_calculation_date) ds_date_calc_w,
b.ds_diagnosis ds_diagnosis_w,
b.ds_complicacao ds_complication_w,
(select ds_status from rp_status_reabilitacao where nr_sequencia = b.nr_seq_status) ds_status_trtmn_w,
(select ds_classificacao from rp_disease_classif where nr_sequencia = b.nr_seq_dis_classif) ds_diag_classif_w
from rp_paciente_reabilitacao a,
rp_tratamento b
where b.nr_seq_pac_reav = a.nr_sequencia
and b.nr_seq_cpoe_procedimento = nr_sequencia_p and ie_record_sub_type_p = '1';

/*Rehabilitation - Execution*/

c02 CURSOR FOR
SELECT pkg_date_formaters.to_varchar(a.dt_start_time, 'shortTime', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_strt_time_w,
pkg_date_formaters.to_varchar(c.DT_INICIO_TRATAMENTO,'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) as DT_INICIO_TRATAMENTO ,
pkg_date_formaters.to_varchar(a.dt_end_time, 'shortTime', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_end_time_w,
pkg_date_formaters.to_varchar(a.dt_total_time, 'shortTime', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_total_time_w,
pkg_date_formaters.to_varchar(a.dt_early_addition, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_est_early_addtn_w,
(select max(b.ds_calc_classif) ds from rp_calc_classif b where b.nr_sequencia = a.ds_calculation_category) ds_calc_catg_w,
obter_valor_dominio(10264,a.ds_implementation_category) ds_impl_catg_w,
obter_desc_setor_atend(a.ds_location) ds_location_w,
obter_valor_dominio(6,a.ie_info_acc) ds_info_acc,
substr(ds_observation,1,255) ds_obs_cmnts_w,
(select obter_desc_agenda(max(cd_agenda)) from agenda_consulta b where b.nr_sequencia = a.nr_seq_impl_agenda)ds_schedule_w,
(obter_select_concatenado_bv('select (Select DS_ITEN from itens_por_classif where nr_sequencia=d.NR_SEQ_CLASSIF_ITEM) || Chr(32) ||DECODE(NR_UNIT,null,'''',obter_desc_expressao(729586)||Chr(32)||NR_UNIT ) ||
    DECODE(DS_ITEM_NAME,null,Chr(32),''(''||DS_ITEM_NAME||'')'')
    from rp_implemen_item_reab d where d.nr_seq_impl_reab = :nr_seq_impl_reab_p ','NR_SEQ_IMPL_REAB_P=' || a.nr_sequencia  || ';' , '#')) ds_items_w,
pkg_date_formaters.to_varchar(a.dt_start_implementation, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_strt_implemnetation_w,
(select  DS_CLASSIFICACAO ds from RP_DISEASE_CLASSIF where ie_situacao = 'A' and  NR_SEQUENCIA=c.nr_seq_dis_classif) NR_DIS_CLASSIF
from rp_implementation_reab a  left outer join rp_tratamento c on a.NR_SEQ_TRATAMENTO=c.NR_SEQUENCIA
where a.nr_sequencia = nr_sequencia_p and ie_record_sub_type_p = '2';

/*Rehabilitation - Assessment*/

c03 CURSOR FOR
SELECT substr(obter_nome_pessoa_fisica(a.CD_MEDICO,null),1,200) ds_medico_w,
substr(obter_descricao_padrao('MED_TIPO_AVALIACAO','DS_TIPO', a.NR_SEQ_TIPO_AVALIACAO),1,100) ds_assmnt_type,
pkg_date_formaters.to_varchar(a.DT_AVALIACAO, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_assmnt_w,
pkg_date_formaters.to_varchar(a.DT_LIBERACAO, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_release_w,
substr(a.DS_OBSERVACAO,1,4000) ds_notes_w,
obter_valor_dominio(9957,a.IE_ETAPA_TRATAMENTO) ds_treatment_step_w,
clinical_notes_pck.get_assessment_details(a.nr_sequencia,wheb_usuario_pck.get_nm_usuario) ds_assessment_details_w
from med_avaliacao_paciente a
where nr_sequencia=nr_sequencia_p and ie_record_sub_type_p = '3';

c009 CURSOR(ds_items_p  text) FOR
SELECT CD_REGISTRO from  table(lista_pck.obter_lista_char(ds_items_p,'#'));


BEGIN
    if ( ie_record_type_p ='REHAB' and ie_record_sub_type_p = '3') then
	for r_c03 in c03 loop
      for r_clinical_note_fields in clinical_note_fields loop
        begin
            if (r_clinical_note_fields.ie_field = 'CD_MEDICO' and (r_c03.ds_medico_w IS NOT NULL AND r_c03.ds_medico_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = ''  ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(790062) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_medico_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_medico_w;
                end if;
              end;
			  end if;
            if (r_clinical_note_fields.ie_field = 'TIPO_AVALIACAO' and (r_c03.ds_assmnt_type IS NOT NULL AND r_c03.ds_assmnt_type::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(790062) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_assmnt_type;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_assmnt_type;
                end if;
              end;
			  end if;
            if (r_clinical_note_fields.ie_field = 'DT_ASSESSMENT' and (r_c03.dt_assmnt_w IS NOT NULL AND r_c03.dt_assmnt_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(790062) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.dt_assmnt_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.dt_assmnt_w;
                end if;
              end;
			  end if;
            if (r_clinical_note_fields.ie_field = 'DT_RELEASE' and (r_c03.dt_release_w IS NOT NULL AND r_c03.dt_release_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(790062) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.dt_release_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.dt_release_w;
                end if;
              end;
			  end if;
            if (r_clinical_note_fields.ie_field = 'DS_NOTES' and (r_c03.ds_notes_w IS NOT NULL AND r_c03.ds_notes_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(790062) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_notes_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_notes_w;
                end if;
              end;
			  end if;
		   if (r_clinical_note_fields.ie_field = 'DS_ASMNT_DET' and (r_c03.ds_assessment_details_w IS NOT NULL AND r_c03.ds_assessment_details_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(790062) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_assessment_details_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_assessment_details_w;
                end if;
              end;
             end if;
            if (r_clinical_note_fields.ie_field = 'IE_TRTMNT_STEP' and (r_c03.ds_treatment_step_w IS NOT NULL AND r_c03.ds_treatment_step_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(790062) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_treatment_step_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_treatment_step_w;
                end if;
              end;
			  end if;
        end;
      end loop;
	  end loop;
    elsif ( ie_record_type_p ='REHAB' and ie_record_sub_type_p = '1') then
    for r_c01 in c01
	loop
      for r_clinical_note_fields in clinical_note_fields loop
        begin
              if (r_clinical_note_fields.ie_field = 'CD_MEDICO' and (r_c01.ds_medico_w IS NOT NULL AND r_c01.ds_medico_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_medico_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_medico_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_ORIGIN' and (r_c01.ds_origin_w IS NOT NULL AND r_c01.ds_origin_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_origin_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_origin_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_DISABILITY' and (r_c01.ds_disability_w IS NOT NULL AND r_c01.ds_disability_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_disability_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_disability_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'MAIN_TRTMNT' and (r_c01.main_trtmnt_w IS NOT NULL AND r_c01.main_trtmnt_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.main_trtmnt_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.main_trtmnt_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_STATUS' and (r_c01.ds_status_w IS NOT NULL AND r_c01.ds_status_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_status_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_status_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_NOTES' and (r_c01.ds_notes_w IS NOT NULL AND r_c01.ds_notes_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_notes_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_notes_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'CD_TRTMNT_TYPE' and (r_c01.ds_trtmnt_type_w IS NOT NULL AND r_c01.ds_trtmnt_type_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_trtmnt_type_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_trtmnt_type_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'NR_CALC_CLASSIF' and (r_c01.ds_calc_classif_w IS NOT NULL AND r_c01.ds_calc_classif_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_calc_classif_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_calc_classif_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'DT_STRT_TRTMNT' and (r_c01.dt_strt_trtmnt_w IS NOT NULL AND r_c01.dt_strt_trtmnt_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.dt_strt_trtmnt_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.dt_strt_trtmnt_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'DT_END_TRTMNT' and (r_c01.dt_end_trtmnt_w IS NOT NULL AND r_c01.dt_end_trtmnt_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.dt_end_trtmnt_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.dt_end_trtmnt_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'DT_EST_DSCHRG' and (r_c01.dt_est_dschrg_w IS NOT NULL AND r_c01.dt_est_dschrg_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.dt_est_dschrg_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.dt_est_dschrg_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'IE_DATE_CALC' and (r_c01.ds_date_calc_w IS NOT NULL AND r_c01.ds_date_calc_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_date_calc_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_date_calc_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'DS_DIAGNOSIS' and (r_c01.ds_diagnosis_w IS NOT NULL AND r_c01.ds_diagnosis_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_diagnosis_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_diagnosis_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'DS_COMPLICATION' and (r_c01.ds_complication_w IS NOT NULL AND r_c01.ds_complication_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_complication_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_complication_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'DS_STATUS_TRTMN' and (r_c01.ds_status_trtmn_w IS NOT NULL AND r_c01.ds_status_trtmn_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_status_trtmn_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_status_trtmn_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'IE_DIAG_CLASSIF' and (r_c01.ds_diag_classif_w IS NOT NULL AND r_c01.ds_diag_classif_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(669129) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_diag_classif_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_diag_classif_w;
                end if;
              end;
			  end if;
        end;
      end loop;
	  end loop;
    elsif ( ie_record_type_p ='REHAB' and ie_record_sub_type_p = '2') then
    for r_c02 in c02
	loop
      for r_clinical_note_fields in clinical_note_fields loop
        begin

              if (r_clinical_note_fields.ie_field = 'DT_START' and (r_c02.dt_strt_time_w IS NOT NULL AND r_c02.dt_strt_time_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_strt_time_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_strt_time_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DT_END' and (r_c02.dt_end_time_w IS NOT NULL AND r_c02.dt_end_time_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_end_time_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_end_time_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DT_TOTAL' and (r_c02.dt_total_time_w IS NOT NULL AND r_c02.dt_total_time_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_total_time_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_total_time_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_SCHEDULE' and (r_c02.ds_schedule_w IS NOT NULL AND r_c02.ds_schedule_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_schedule_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_schedule_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DT_EARLY_ADDTN' and (r_c02.dt_est_early_addtn_w IS NOT NULL AND r_c02.dt_est_early_addtn_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_est_early_addtn_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_est_early_addtn_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_CALC_CATG' and (r_c02.ds_calc_catg_w IS NOT NULL AND r_c02.ds_calc_catg_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_calc_catg_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_calc_catg_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_IMPL_CATG' and (r_c02.ds_impl_catg_w IS NOT NULL AND r_c02.ds_impl_catg_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_impl_catg_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_impl_catg_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_LOCATION' and (r_c02.ds_location_w IS NOT NULL AND r_c02.ds_location_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_location_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_location_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'IE_INF_ACC' and (r_c02.ds_info_acc IS NOT NULL AND r_c02.ds_info_acc::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_info_acc;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_info_acc;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_NOTES' and (r_c02.ds_obs_cmnts_w IS NOT NULL AND r_c02.ds_obs_cmnts_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_obs_cmnts_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_obs_cmnts_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_ITEM' and (r_c02.ds_items_w IS NOT NULL AND r_c02.ds_items_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
				  for r_item in c009(r_c02.ds_items_w) loop
					  begin
						  if (r_item.CD_REGISTRO IS NOT NULL AND r_item.CD_REGISTRO::text <> '') then
						  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_item.CD_REGISTRO;
						  end if;
					  end;
				  end loop;
				
                else

                  for r_item in c009(r_c02.ds_items_w) loop 
					  begin
						  if (r_item.CD_REGISTRO IS NOT NULL AND r_item.CD_REGISTRO::text <> '') then
						  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_item.CD_REGISTRO;
                end if;
              end;
				  end loop;
			  end if;
              end;
			  end if;
			
			if (r_clinical_note_fields.ie_field = 'DT_IMPLEMENT' and (r_c02.dt_strt_implemnetation_w IS NOT NULL AND r_c02.dt_strt_implemnetation_w::text <> '') and  (r_c02.dt_strt_time_w IS NOT NULL AND r_c02.dt_strt_time_w::text <> '') and (r_c02.dt_end_time_w IS NOT NULL AND r_c02.dt_end_time_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_strt_implemnetation_w||' '||r_c02.dt_strt_time_w||'-'||r_c02.dt_end_time_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_strt_implemnetation_w||' '||r_c02.dt_strt_time_w||'-'||r_c02.dt_end_time_w;
                end if;
              end;
			end if;
			
			if (r_clinical_note_fields.ie_field = 'DT_START_DATE' and (r_c02.DT_INICIO_TRATAMENTO IS NOT NULL AND r_c02.DT_INICIO_TRATAMENTO::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.DT_INICIO_TRATAMENTO;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.DT_INICIO_TRATAMENTO;
                end if;
				end;
			end if;
			
			if (r_clinical_note_fields.ie_field = 'NR_DIS_CLASSIF' and (r_c02.NR_DIS_CLASSIF IS NOT NULL AND r_c02.NR_DIS_CLASSIF::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1060264) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.NR_DIS_CLASSIF;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.NR_DIS_CLASSIF;
                end if;
              end;
			end if;

			
        end;
      end loop;
	  end loop;
    end if;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_pat_rehab ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_record_sub_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
