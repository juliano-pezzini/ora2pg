-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_patient_discharge ( nr_atendimento_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_content_w varchar(32000);
    ds_care_dept_w varchar(255);
    ds_med_dept_w varchar(255);
    ds_unit_w varchar(255);
    ds_discharge_date_w varchar(255);
    ds_entry_date_w varchar(255);
    ds_entry_reason_w varchar(255);
    nm_physician_name_w varchar(255);
    ds_icd_desc_w varchar(255);
    nm_nurse_primary_w varchar(255);
    ie_amb_transport_w varchar(1);
    ds_discharge_reason_w varchar(255);
    ds_notes_w varchar(255);
    ds_dschg_dest_w varchar(255);
    ds_dschg_hcare_w varchar(255);
    ds_sub_reason_w varchar(255);
    ds_necrospy_w varchar(255);
    ds_disclose_death_w varchar(255);
    ds_hosp_dest_w varchar(255);
    ds_transport_cmpny_w varchar(255);
    ds_physician_ext varchar(255);
    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN
  if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
   select Obter_Unidade_Atendimento(a.nr_atendimento,'IAR','S'),
    obter_nome_departamento_medico(obter_departamento_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAR','CS'))),
    Obter_Unidade_Atendimento(a.nr_atendimento,'IAR','U'),
    pkg_date_formaters.to_varchar(a.dt_entrada, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
    pkg_date_formaters.to_varchar(a.dt_alta, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
    (select max(ds_CLASSIFICACAO) from CLASSIFICACAO_ATENDIMENTO X where x.nr_sequencia = a.NR_SEQ_CLASSIFICACAO),
    Obter_Diag_Princ_atendimento(a.nr_atendimento),
    obter_nome_medico(a.cd_medico_resp,'N'),
    null,
    null,
    (select Obter_Desc_Motivo_Alta(max(x.cd_motivo_alta)) from atend_alta_destino x where x.nr_atendimento  = a.nr_atendimento),
    a.ds_obs_alta,
    (select Obter_Desc_Motivo_Alta(max(x.cd_destino_alta)) from atend_alta_destino x where x.nr_atendimento  = a.nr_atendimento),
    (select Obter_Desc_Motivo_Alta(max(x.cd_tipo_alta_home_care)) from atend_alta_destino x where x.nr_atendimento  = a.nr_atendimento),
    (SELECT	max(z.ds_motivo) FROM submotivo_alta z WHERE	z.nr_sequencia = a.nr_submotivo_alta),
    obter_valor_dominio(6,a.ie_necropsia),
    obter_valor_dominio(6,a.IE_DIVULGAR_OBITO),
    (select OBTER_NOME_FANTASIA_PJ(max(x.cd_cgc)) from atendimento_transf x where x.nr_atendimento = a.nr_atendimento and x.ie_situacao ='A'),
    (select OBTER_NOME_FANTASIA_PJ(max(x.cd_cgc_transporte)) from atendimento_transf x where x.nr_atendimento = a.nr_atendimento and x.ie_situacao ='A'),
    (select OBTER_NOME_FANTASIA_PJ(max(x.nm_medico_externo)) from atendimento_transf x where x.nr_atendimento = a.nr_atendimento and x.ie_situacao ='A')
    into STRICT
    ds_care_dept_w,
    ds_med_dept_w,
    ds_unit_w,
    ds_entry_date_w,
    ds_discharge_date_w,
    ds_entry_reason_w,
    ds_icd_desc_w,
    nm_physician_name_w,
    nm_nurse_primary_w,
    ie_amb_transport_w,
    ds_discharge_reason_w,
    ds_notes_w,
    ds_dschg_dest_w,
    ds_dschg_hcare_w,
    ds_sub_reason_w,
    ds_necrospy_w,
    ds_disclose_death_w,
    ds_hosp_dest_w,
    ds_transport_cmpny_w,
    ds_physician_ext
    from atendimento_paciente a where nr_atendimento = nr_atendimento_p;
    for r_c01 in c01 loop
    if (ie_record_type_p = 'DISCHARGE') then
        if (r_c01.ie_field    = 'CARE_DEPT' and (ds_care_dept_w IS NOT NULL AND ds_care_dept_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_care_dept_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_care_dept_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'MED_DEPT' and (ds_med_dept_w IS NOT NULL AND ds_med_dept_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_med_dept_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_med_dept_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_UNIT' and (ds_unit_w IS NOT NULL AND ds_unit_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_unit_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_unit_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'ENTRY_DATE' and (ds_entry_date_w IS NOT NULL AND ds_entry_date_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_entry_date_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_entry_date_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'ENTRY_REASON' and (ds_entry_reason_w IS NOT NULL AND ds_entry_reason_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_entry_reason_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_entry_reason_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'PHYSICIAN_NAME' and (nm_physician_name_w IS NOT NULL AND nm_physician_name_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_physician_name_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_physician_name_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'ICD_DESC' and (ds_icd_desc_w IS NOT NULL AND ds_icd_desc_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_icd_desc_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_icd_desc_w;
          end if;
          end if;
        if (r_c01.ie_field   = 'NURSE_PRIMARY' and (nm_nurse_primary_w IS NOT NULL AND nm_nurse_primary_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_nurse_primary_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_nurse_primary_w;
          end if;
          end if;
        if (r_c01.ie_field   = 'AMB_TRANSPORT' and (ie_amb_transport_w IS NOT NULL AND ie_amb_transport_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ie_amb_transport_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ie_amb_transport_w;
          end if;
          end if;
        if (r_c01.ie_field   = 'DSCHRG_REASON' and (ds_discharge_reason_w IS NOT NULL AND ds_discharge_reason_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_discharge_reason_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_discharge_reason_w;
          end if;
          end if;
         if (r_c01.ie_field   = 'DSCHRG_DATE' and (ds_discharge_date_w IS NOT NULL AND ds_discharge_date_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_discharge_date_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_discharge_date_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_NOTES' and (ds_notes_w IS NOT NULL AND ds_notes_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_DSCHG_DEST' and (ds_dschg_dest_w IS NOT NULL AND ds_dschg_dest_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_dschg_dest_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_dschg_dest_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_DHSCG_HCARE' and (ds_dschg_hcare_w IS NOT NULL AND ds_dschg_hcare_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_dschg_hcare_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_dschg_hcare_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_SUB_MOTIVE' and (ds_sub_reason_w IS NOT NULL AND ds_sub_reason_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_sub_reason_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_sub_reason_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'IE_NECROPSIA' and (ds_necrospy_w IS NOT NULL AND ds_necrospy_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_necrospy_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_necrospy_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'IE_DISCLOSE_DTH' and (ds_disclose_death_w IS NOT NULL AND ds_disclose_death_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_disclose_death_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_disclose_death_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_HOSPITAL_DES' and (ds_hosp_dest_w IS NOT NULL AND ds_hosp_dest_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_hosp_dest_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_hosp_dest_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_TRANSP_CMPNY' and (ds_transport_cmpny_w IS NOT NULL AND ds_transport_cmpny_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_transport_cmpny_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_transport_cmpny_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'NM_MEDICO_EXT' and (ds_physician_ext IS NOT NULL AND ds_physician_ext::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(283375) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_physician_ext;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_physician_ext;
          end if;
        end if;
        end if;
    end loop;
	end if;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_patient_discharge ( nr_atendimento_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
