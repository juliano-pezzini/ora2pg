-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_temp_leave (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint, ie_option_p text, ie_opcao_p text) RETURNS varchar AS $body$
DECLARE

    ds_content_w varchar(32000);
    ds_care_dept_w varchar(255);
    ds_med_dept_w varchar(255);
    ds_unit_w varchar(255);
    ds_temp_exit_date_w varchar(255);
    ds_temp_exit_return_date_w varchar(255);
    ds_estimated_return_date_w varchar(255);
    nm_physician_name_w varchar(255);
    ds_reason_w varchar(255);
    nr_seq_motive_w varchar(100);
    ds_no_fast_w varchar(255);
	ds_leave_start_w destino_saida_temporaria.ds_destino%type;
    ds_leave_end_w destino_saida_temporaria.ds_destino%type;
ds_meal_in_w varchar(255);
ds_contact_w varchar(255);
ds_destinctaion_w varchar(255);
dt_ini_fast_w varchar(255);
dt_fim_fast_w varchar(255);
ds_meal_fim_w varchar(255);
    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN
    select max(NR_SEQUENCIA)
    into STRICT nr_seq_motive_w
    from atend_pac_un_log_mot_temp
    where nr_atendimento = nr_atendimento_p;

    select  max(ds_care_dept),
            max(ds_reason),
            max(ds_med_dept),
            max(ds_unit),
            max(ds_temp_exit_date),
            max(ds_temp_exit_return_date),
            max(ds_estimated_return_date),
            max(ds_no_fast),
            max(ds_meal_in),
            max(ds_contact),
            max(ds_destinctaion),
            max(dt_ini_fast),
            max(dt_fim_fast),
            max(ds_meal_fim),
            max(ds_leave_start),
            max(ds_leave_end)
    into STRICT
            ds_care_dept_w,
            ds_reason_w,
            ds_med_dept_w,
            ds_unit_w,
            ds_temp_exit_date_w,
            ds_temp_exit_return_date_w,
            ds_estimated_return_date_w,
            ds_no_fast_w,
            ds_meal_in_w,
            ds_contact_w,
            ds_destinctaion_w,
            dt_ini_fast_w,
            dt_fim_fast_w,
            ds_meal_fim_w,
            ds_leave_start_w,
            ds_leave_end_w
    from    (SELECT Obter_Unidade_Atendimento(a.nr_atendimento,'IAR','S') ds_care_dept,
   (select DS_MOTIVO from motivo_transf_pac x where x.nr_sequencia=b.NR_MOTIVO_TEMPORARIO) ds_reason,
    obter_nome_departamento_medico(obter_departamento_setor(a.cd_setor_atendimento)) ds_med_dept,
    Obter_Unidade_Atendimento(a.nr_atendimento,'IAR','U') ds_unit,
    pkg_date_formaters.to_varchar(a.DT_SAIDA_TEMPORARIA, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) ds_temp_exit_date,
    pkg_date_formaters.to_varchar(a.DT_RETORNO_SAIDA_TEMPORARIA, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) ds_temp_exit_return_date,
    pkg_date_formaters.to_varchar(a.DT_EST_RETURN, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) ds_estimated_return_date,
    substr(OBTER_DESC_CAMPO_GRID(336203, IE_SEM_JEJUM ),1,255) ds_no_fast,
    (select DS_TIPO from REP_TIPO_JEJUM x where x.nr_sequencia=NR_CATEGORIA_REFEICAO_INICIO) ds_meal_in,
    (select ds_destino from DESTINO_SAIDA_TEMPORARIA x where x.nr_sequencia= NR_INFORMACAO_CONTATO and ie_tipo='I') ds_contact,
    (select ds_destino from DESTINO_SAIDA_TEMPORARIA x where x.nr_sequencia= NR_DESTINO and ie_tipo='D') ds_destinctaion,
    pkg_date_formaters.to_varchar(b.DT_INICIO_JEJUM, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_ini_fast,
    pkg_date_formaters.to_varchar(b.DT_FINAL_JEJUM, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_fim_fast,
    (select DS_TIPO from REP_TIPO_JEJUM x where x.nr_sequencia=NR_CATEGORIA_REFEICAO_FIM) ds_meal_fim,
	pkg_date_formaters.to_varchar(b.DT_START_DATE, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) ds_leave_start,
    pkg_date_formaters.to_varchar(b.DT_END_DATE, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) ds_leave_end
    from atend_paciente_unidade a,WOCUPACAO_SAIDA_TEMPORARIA b where a.nr_atendimento = nr_atendimento_p and a.nr_seq_interno = nr_sequencia_p and a.nr_atendimento=b.nr_atendimento
    and (exists (select 1 from WOCUPACAO_SAIDA_TEMPORARIA c where c.nr_atendimento = nr_atendimento_p and b.DT_FINAL_SAIDA = c.DT_FINAL_SAIDA) or coalesce(b.DT_FINAL_SAIDA::text, '') = '')
    order by b.DT_FINAL_SAIDA desc nulls last
    ) alias37 LIMIT 1;

    for r_c01 in c01 loop
    if (ie_record_type_p = 'TEMP_LEAVE') then
        if (r_c01.ie_field    = 'DS_DEPT' and (ds_care_dept_w IS NOT NULL AND ds_care_dept_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
          if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_care_dept_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_care_dept_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_care_dept_w;
          end if;
        end if;
        if (r_c01.ie_field    = 'DS_RESON' and (ds_reason_w IS NOT NULL AND ds_reason_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
           if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_reason_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_reason_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_reason_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_MED_DEPT' and (ds_med_dept_w IS NOT NULL AND ds_med_dept_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
          if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_med_dept_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_med_dept_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_med_dept_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_UNIT' and (ds_unit_w IS NOT NULL AND ds_unit_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
             if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_unit_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_unit_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_unit_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_LEAVE' and (ds_temp_exit_date_w IS NOT NULL AND ds_temp_exit_date_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_temp_exit_date_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_temp_exit_date_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_temp_exit_date_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_EST_RETURN' and (ds_estimated_return_date_w IS NOT NULL AND ds_estimated_return_date_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_estimated_return_date_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_estimated_return_date_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_estimated_return_date_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'DT_LEAVE_START' and  (ds_leave_start_w IS NOT NULL AND ds_leave_start_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_leave_start_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_leave_start_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_leave_start_w;
          end if;
        elsif (r_c01.ie_field   = 'DT_LEAVE_END' and (ds_leave_end_w IS NOT NULL AND ds_leave_end_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
           if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_leave_end_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_leave_end_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_leave_end_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_RETURN' and (ds_temp_exit_return_date_w IS NOT NULL AND ds_temp_exit_return_date_w::text <> '') and ie_option_p='R')then
          if (coalesce(ds_content_w::text, '') = '' ) then
           if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_temp_exit_return_date_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_temp_exit_return_date_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_temp_exit_return_date_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_MEAL_CATG_ST' and (ds_meal_in_w IS NOT NULL AND ds_meal_in_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_meal_in_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_meal_in_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_meal_in_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_CONTACT' and (ds_contact_w IS NOT NULL AND ds_contact_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
           if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_contact_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_contact_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_contact_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_DESTINATION' and (ds_destinctaion_w IS NOT NULL AND ds_destinctaion_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
           if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_destinctaion_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_destinctaion_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_destinctaion_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_FAST_START' and (dt_ini_fast_w IS NOT NULL AND dt_ini_fast_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_ini_fast_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_ini_fast_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_ini_fast_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_FAST_TERMN' and (dt_fim_fast_w IS NOT NULL AND dt_fim_fast_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_fim_fast_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_fim_fast_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_fim_fast_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'IE_NO_FAST' and (ds_no_fast_w IS NOT NULL AND ds_no_fast_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
           if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_no_fast_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_no_fast_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_no_fast_w;
          end if;
        end if;
         if (r_c01.ie_field   = 'MEAL_CATG_END' and (ds_meal_fim_w IS NOT NULL AND ds_meal_fim_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            if (ie_option_p ='S')then
            ds_content_w    := '<b>' || obter_desc_expressao(691410)|| ' - ' || obter_desc_expressao(297969) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_meal_fim_w;
            else
            ds_content_w    := '<b>' || obter_desc_expressao(691410) || ' - ' || obter_desc_expressao(1043417) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_meal_fim_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_meal_fim_w;
          end if;
        end if;
      end if;
    end loop;

    return ds_content_w;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_temp_leave (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint, ie_option_p text, ie_opcao_p text) FROM PUBLIC;
