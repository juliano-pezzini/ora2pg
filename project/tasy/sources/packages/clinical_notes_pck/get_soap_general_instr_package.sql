-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_general_instr (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_content_w varchar(32000);
    care_type_w varchar(255);
    cd_professional_w varchar(255);
	ds_comments_w varchar(6000);
    ds_role_w varchar(255);
    ds_spec_prof_w varchar(255);
    ds_ward_w varchar(255);
    dt_record_w varchar(255);
    med_dept_w varchar(255);
    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN
    select
	substr(obter_desc_nivel_atencao(IE_NIVEL_ATENCAO),1,255) ,
	substr(obter_nome_pf(cd_profissional),1,255),
	ds_orientacao_geral,
	substr(Obter_Dados_Usuario_Opcao(nm_usuario,'DF'),1,50),
	substr(obter_desc_espec_medica(CD_ESPECIALIDADE_MEDICO),1,50),
	Obter_Unidade_Atendimento(nr_atendimento,'IAR','S'),
	dt_registro,
	obter_nome_departamento_medico(obter_departamento_setor(cd_setor_atendimento))
    into STRICT
    care_type_w ,
    cd_professional_w ,
	ds_comments_w ,
    ds_role_w ,
    ds_spec_prof_w ,
    ds_ward_w ,
    dt_record_w,
    med_dept_w
	from pep_orientacao_geral
	where nr_sequencia= nr_sequencia_p
	and nr_atendimento = nr_atendimento_p;
    for r_c01 in c01
    loop
      if (ie_record_type_p = 'GNRL_INSTRCT' )then
        if (r_c01.ie_field    = 'CARE_TYPE' and (care_type_w IS NOT NULL AND care_type_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(314145) || '</b>';
            ds_content_w    := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| care_type_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| care_type_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_PROFESSIONAL' and (cd_professional_w IS NOT NULL AND cd_professional_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(314145) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| cd_professional_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| cd_professional_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_COMMENTS' and (ds_comments_w IS NOT NULL AND ds_comments_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(314145) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_comments_w;
          else
            ds_content_w := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_comments_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_ROLE' and (ds_role_w IS NOT NULL AND ds_role_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(314145) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_role_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_role_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_SPEC_PROF' and (ds_spec_prof_w IS NOT NULL AND ds_spec_prof_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(314145) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_spec_prof_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_spec_prof_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_WARD' and (ds_ward_w IS NOT NULL AND ds_ward_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(314145) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_ward_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_ward_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_RECORD' and (dt_record_w IS NOT NULL AND dt_record_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(314145) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_record_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_record_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'MED_DEPT' and (med_dept_w IS NOT NULL AND med_dept_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(314145) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| med_dept_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| med_dept_w;
          end if;
        end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_general_instr (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
