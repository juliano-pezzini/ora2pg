-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_clinical_pathway ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_content_w    varchar(32000);
    nm_pathway_w varchar(255);
    cd_doenca_w varchar(255);
    dt_final_w varchar(255);
    dt_final_est_w     varchar(255);
    dt_inicial_w               varchar(255);
    dt_inicial_est_w                  varchar(255);
    ds_status_w varchar(255);
    nm_insurance_w          varchar(255);
    nm_protocol_w   varchar(255);
    c01 CURSOR FOR
      SELECT *
      from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type,ie_stage_p));

BEGIN
	select
	a.ds_tratamento nm_pathway_w,
	(select max(ds_doenca_cid) from cid_doenca where cd_doenca_cid= a.cd_cid_doenca) cd_doenca_w,
	pkg_date_formaters.to_varchar(a.dt_final_real,'timestamp',wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario)  dt_final_w,
	pkg_date_formaters.to_varchar(a.dt_final_previsto,'timestamp',wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario) dt_final_est_w,
	pkg_date_formaters.to_varchar(a.dt_inicial_real,'timestamp',wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario) dt_inicial_w,
	pkg_date_formaters.to_varchar(a.dt_inicial_previsto,'timestamp',wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario) dt_inicial_est_w,
	obter_valor_dominio(9892, a.ie_status)  ds_status_w,
	(select max(ds_insurance_name_japanese) from nais_insurance where nr_sequencia= a.nr_seq_nais_insurance) nm_insurance_w,
	(select max(ds_protocolo) from protocolo_integrado where nr_sequencia = a.nr_sequencia_protocolo) nm_protocol_w
	into STRICT
	nm_pathway_w,
	cd_doenca_w,
	dt_final_w ,
	dt_final_est_w ,
	dt_inicial_w ,
	dt_inicial_est_w,
	ds_status_w ,
	nm_insurance_w,
	nm_protocol_w
	from protocolo_int_paciente a
	where a.nr_sequencia = nr_sequencia_p;
    for r_c01 in c01
    loop
      if (ie_record_type_p = 'CLNICAL_PATHWAY')then

        if (r_c01.ie_field    = 'DS_STATUS' and (ds_status_w IS NOT NULL AND ds_status_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(950575) || '</b>';
            ds_content_w    := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_status_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_status_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_DOENCA' and (cd_doenca_w IS NOT NULL AND cd_doenca_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(950575) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| cd_doenca_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| cd_doenca_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_FINAL' and (dt_final_w IS NOT NULL AND dt_final_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(950575) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_final_w;
          else
            ds_content_w := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_final_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_FINAL_EST' and (dt_final_est_w IS NOT NULL AND dt_final_est_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(950575) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_final_est_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_final_est_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_INICIAL' and (dt_inicial_w IS NOT NULL AND dt_inicial_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(950575) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_inicial_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_inicial_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_INICIAL_EST' and (dt_inicial_est_w IS NOT NULL AND dt_inicial_est_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(950575) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_inicial_est_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_inicial_est_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'NM_INSURANCE' and (nm_insurance_w IS NOT NULL AND nm_insurance_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(950575) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_insurance_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_insurance_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'NM_PROTOCOL' and (nm_protocol_w IS NOT NULL AND nm_protocol_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(950575) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_protocol_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_protocol_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'NM_PATHWAY' and (nm_pathway_w IS NOT NULL AND nm_pathway_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(950575) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_pathway_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_pathway_w;
          end if;
        end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_clinical_pathway ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type text, ie_stage_p bigint) FROM PUBLIC;
