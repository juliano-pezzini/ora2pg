-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_med_guidance ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

	ds_content_w varchar(32000);
	nr_seq_jpn_med varchar(255);
	ds_procedure varchar(4000);
	dt_guid_date varchar(255);
	dt_guid_time varchar(255);
	ds_calculation_time varchar(255);
	ds_assesmnt varchar(4000);
	ds_guidance_mfee varchar(4000);
	ds_category varchar(4000);
	ds_dept varchar(4000);
	ds_disease varchar(4000);
	ds_info  varchar(4000);

    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN

 SELECT
    nr_seq_jpn_med_guid,
    ( SELECT ds_proc_exame FROM proc_interno pi WHERE pi.nr_sequencia = a.nr_seq_proc_interno),
    pkg_date_formaters.to_varchar(a.dt_guidance, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
    dt_guidance_start_time,
    pkg_date_formaters.to_varchar(a.dt_calculation, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
    substr(obter_descricao_padrao('MED_TIPO_AVALIACAO','DS_TIPO', NR_SEQ_TIPO_AVALIACAO),1,100),
    ds_medical_instruction,
    ds_general_explanation,
    ds_departments
INTO STRICT
    nr_seq_jpn_med,
    ds_procedure,
    dt_guid_date,
    dt_guid_time,
    ds_calculation_time,
    ds_assesmnt,
    ds_guidance_mfee,
    ds_category,
    ds_dept

FROM     medical_guidance_order a
WHERE    nr_sequencia=nr_sequencia_p;
    for r_c01 in c01 loop
    if (ie_record_type_p = 'MED_GUIDANCE') then
        if (r_c01.ie_field    = 'DS_PROC' and (ds_procedure IS NOT NULL AND ds_procedure::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(294903) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_procedure;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_procedure;
          end if;
        end if;
        if (r_c01.ie_field    = 'HR_START' and (dt_guid_time IS NOT NULL AND dt_guid_time::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(294903) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_guid_time;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_guid_time;
          end if;
        end if;
         if (r_c01.ie_field    = 'DS_MED_INSTR' and (ds_guidance_mfee IS NOT NULL AND ds_guidance_mfee::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(294903) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_guidance_mfee;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_guidance_mfee;
          end if;
        end if;
        if (r_c01.ie_field    = 'DT_CALCULATION' and (ds_calculation_time IS NOT NULL AND ds_calculation_time::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(294903) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_calculation_time;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_calculation_time;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_CATEGORY' and (ds_category IS NOT NULL AND ds_category::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(294903) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_category;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_category;
          end if;
        end if;
        if (r_c01.ie_field   = 'IE_TIPO_ASMNT' and (ds_assesmnt IS NOT NULL AND ds_assesmnt::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(294903) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_assesmnt;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_assesmnt;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_GUIDANCE' and (dt_guid_date IS NOT NULL AND dt_guid_date::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(294903) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_guid_date;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_guid_date;
          end if;
        end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_med_guidance ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
