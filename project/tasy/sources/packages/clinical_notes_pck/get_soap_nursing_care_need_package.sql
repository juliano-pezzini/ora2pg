-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_nursing_care_need ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_record_sub_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

ds_content_w varchar(32000);
clinical_note_fields CURSOR FOR
SELECT *
from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,ie_record_sub_type_p,ie_soap_type_p,ie_stage_p));

	/*Need of nursing care */

	c01 CURSOR FOR
	SELECT obter_valor_dominio(10265,a.nr_seq_justificativa) ds_justification_w,
	pkg_date_formaters.to_varchar(a.dt_avaliacao,'shortDate',wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario) dt_assessment_w,
	substr(obter_nome_pf(a.cd_pessoa_fisica),1,60)ds_professional_w,
	(SELECT max(x.nm_formulario) from nursing_care_version x where  x.nr_sequencia = a.nr_seq_nursing_care) ds_nuring_care_w,
	obter_valor_dominio(10261,a.nr_seq_nivel) ds_level_w,
	a.qt_pontuacao_a nr_points_a_w,
	a.qt_pontuacao_b nr_points_b_w,
	a.qt_pontuacao_c nr_points_c_w,
	a.ds_observacao ds_notes_w,
	calc_numero_dias_internacao(a.nr_atendimento,a.dt_avaliacao)nr_hosp_days_w,
	CASE WHEN obter_nome_depart_por_atend(a.nr_atendimento)=' ' THEN  null  ELSE obter_nome_depart_por_atend(a.nr_atendimento) END  ds_department_w,
	retorna_criterio_atendimento(a.nr_atendimento,1,a.nr_sequencia) nr_level_1_w,
	retorna_criterio_atendimento(a.nr_atendimento,2,a.nr_sequencia) nr_level_2_w,
	obter_se_atend_tem_nota_clin(a.nr_atendimento,a.dt_avaliacao) ie_note_reg_w,
	a.qt_pontuacao nr_points_total_w,
    CASE WHEN nr_seq_nivel =1 THEN retorna_criterio_atendimento(nr_atendimento,1,nr_sequencia) WHEN nr_seq_nivel =2 THEN retorna_criterio_atendimento(nr_atendimento,2,nr_sequencia)  ELSE null END  ds_judgement_w,
    clinical_notes_pck.get_nursing_care_assmnt_detail(nr_sequencia) ds_asmnt_details_w
	from nursing_care_encounter a
	where a.nr_sequencia = nr_sequencia_p;

BEGIN
   if ( ie_record_type_p ='NURSE_CARE_NEED' ) then
    for r_c01 in c01
	loop
      for r_clinical_note_fields in clinical_note_fields loop
        begin
              if (r_clinical_note_fields.ie_field = 'DS_JUSTIFY' and (r_c01.ds_justification_w IS NOT NULL AND r_c01.ds_justification_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_justification_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_justification_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DT_ASSESSMENT' and (r_c01.dt_assessment_w IS NOT NULL AND r_c01.dt_assessment_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.dt_assessment_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.dt_assessment_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_PROFESSIONAL' and (r_c01.ds_professional_w IS NOT NULL AND r_c01.ds_professional_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_professional_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_professional_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'NR_SEQ_NCARE' and (r_c01.ds_nuring_care_w IS NOT NULL AND r_c01.ds_nuring_care_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_nuring_care_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_nuring_care_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'NR_LEVEL' and (r_c01.ds_level_w IS NOT NULL AND r_c01.ds_level_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_level_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_level_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'QT_POINTS_A' and (r_c01.nr_points_a_w IS NOT NULL AND r_c01.nr_points_a_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_points_a_w;
                else
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_points_a_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'QT_POINTS_B' and (r_c01.nr_points_b_w IS NOT NULL AND r_c01.nr_points_b_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_points_b_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_points_b_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'QT_POINTS_C' and (r_c01.nr_points_c_w IS NOT NULL AND r_c01.nr_points_c_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_points_c_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_points_c_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'DS_NOTES' and (r_c01.ds_notes_w IS NOT NULL AND r_c01.ds_notes_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_notes_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_notes_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'NR_HOSP_DAYS' and (r_c01.nr_hosp_days_w IS NOT NULL AND r_c01.nr_hosp_days_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_hosp_days_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_hosp_days_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'CD_DEPARTMENT' and (r_c01.ds_department_w IS NOT NULL AND r_c01.ds_department_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_department_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_department_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'TOTAL_LEVEL_1' and (r_c01.nr_level_1_w IS NOT NULL AND r_c01.nr_level_1_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_level_1_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_level_1_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'IE_REGISTRATION' and (r_c01.ie_note_reg_w IS NOT NULL AND r_c01.ie_note_reg_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ie_note_reg_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ie_note_reg_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'TOTAL_LEVEL_2' and (r_c01.nr_level_2_w IS NOT NULL AND r_c01.nr_level_2_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_level_2_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_level_2_w;
                end if;
              end;
			  end if;
              if (r_clinical_note_fields.ie_field = 'QT_POINTS_TOTAL' and (r_c01.nr_points_total_w IS NOT NULL AND r_c01.nr_points_total_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_points_total_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.nr_points_total_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_JUDGEMENT' and (r_c01.ds_judgement_w IS NOT NULL AND r_c01.ds_judgement_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_judgement_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_judgement_w;
                end if;
              end;
			  end if;
             if (r_clinical_note_fields.ie_field = 'DS_ASMNT_DETAIL' and (r_c01.ds_asmnt_details_w IS NOT NULL AND r_c01.ds_asmnt_details_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1046836) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_asmnt_details_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_asmnt_details_w;
                end if;
              end;
			  end if;
        end;
      end loop;
	  end loop;
    end if;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_nursing_care_need ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_record_sub_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
