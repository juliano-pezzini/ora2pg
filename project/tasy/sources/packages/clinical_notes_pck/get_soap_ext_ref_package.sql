-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_ext_ref ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_record_sub_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

ds_content_w varchar(32000);
clinical_note_fields CURSOR FOR
SELECT *
from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,ie_record_sub_type_p,ie_soap_type_p,ie_stage_p));

/*External Referral - Referral to another hospital */

c01 CURSOR FOR
SELECT obter_valor_dominio(10217, IE_DOCUMENT_TYPE) ds_doc_typ_w,
coalesce((select ds_proc_exame from proc_interno z Where z.ie_origem_proced = 24 and z.ie_situacao = 'A' and z.nr_sequencia = a.NR_SEQ_CALCULATION_TYPE),obter_desc_expressao_idioma(499688, null, wheb_usuario_pck.get_nr_seq_idioma))ds_tipo_cal_w,
(select ds_reason_reference from RL_REASON_REFERENCE x where x.nr_sequencia=NR_SEQ_REASON_REF)ds_indic_w,
(select DS_DEPARTAMENTO from DEPARTAMENTO_MEDICO x where x.CD_DEPARTAMENTO=CD_REFERRED_DEPARTMENT) ds_ref_med_w,
(select ds_grounds_reference from RL_GROUNDS_REFERENCE x where x.nr_sequencia=NR_SEQ_GROUNDS_REF)ds_grounds_ref_w,
pkg_date_formaters.to_varchar(a.DT_CALCULATION_TYPE, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario)ds_cal_w,
pkg_date_formaters.to_varchar(a.DT_REFERENCE, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario)ds_refd_w,
(select DS_RAZAO_SOCIAL from PESSOA_JURIDICA x where x.CD_CGC=CD_MEDICAL_INSTITUTION)ds_nme_inst_w,
(select nm_guerra from medico x where x.cd_pessoa_fisica=CD_REFERRING_DOCTOR)ds_ref_doc_w,
(select DS_DEPARTAMENTO from DEPARTAMENTO_MEDICO x where x.CD_DEPARTAMENTO=CD_MEDICAL_DEPARTMENT) ds_med_dept_w
from RL_REF_TO_HOSPITAL a
where nr_sequencia=nr_sequencia_p and ie_record_sub_type_p = '1';

/*External Referral - Referral from another hospital */

c02 CURSOR FOR
SELECT pkg_date_formaters.to_varchar(a.DT_REFERENCE, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario)dt_reference_w ,
coalesce((select ds_proc_exame from proc_interno z Where z.ie_origem_proced = 24 and z.ie_situacao = 'A' and z.nr_sequencia = a.NR_SEQ_CALCULATION_TYPE),obter_desc_expressao_idioma(499688, null, wheb_usuario_pck.get_nr_seq_idioma)) ds_calculation_w,
(select ds_departamento from departamento_medico x where x.cd_departamento =cd_medical_department) ds_med_dept_w,
(select ds_departamento from departamento_medico x where x.cd_departamento =cd_referred_departmenT) ds_ref_dept,
pkg_date_formaters.to_varchar(a.dt_calculation_type, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario)dt_cal_w,
(select DS_RAZAO_SOCIAL from PESSOA_JURIDICA x where x.CD_CGC=CD_MEDICAL_INSTITUTION) ds_nme_inst_w,
(select nm_guerra from medico x where x.cd_pessoa_fisica=CD_REFERRED_DOCTOR) ds_referrd_doc_w,
(select nm_guerra from medico x where x.cd_pessoa_fisica=CD_REFERRING_DOCTOR)ds_ref_doc_w
from rl_ref_from_hospital a
where nr_sequencia=nr_sequencia_p and ie_record_sub_type_p = '2';

/*External Referral - Report to another hospital  */

c03 CURSOR FOR
SELECT (select max(cd_doenca) from RL_REP_TO_HOSP_DIAGNOSIS where nr_seq_rl_rep_to_hosp=a.nr_sequencia) ds_icd_w,
null ds_indication_w,
(select obter_desc_cid(max(cd_doenca)) from RL_REP_TO_HOSP_DIAGNOSIS where nr_seq_rl_rep_to_hosp=a.nr_sequencia)ds_icd_desc_w,
pkg_date_formaters.to_varchar(a.dt_calculation_type, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) ds_caldate_w,
pkg_date_formaters.to_varchar(a.dt_reference, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) ds_refdate_w,
obter_valor_dominio(10217, IE_DOCUMENT_TYPE) ds_doc_type_w,
(select DS_RAZAO_SOCIAL from PESSOA_JURIDICA x where x.CD_CGC=cd_medical_institution) ds_nme_inst_w,
(select nm_guerra from medico x where x.cd_pessoa_fisica=cd_referring_doctor) ds_ref_doc_w,
(select (select nm_guerra from medico x where x.cd_pessoa_fisica=x.CD_DOCTOR) from RL_REP_TO_HOSP_DOCTOR x where x.NR_SEQ_RL_REP_TO_HOSP=a.nr_sequencia)ds_rep_doc_w,
coalesce((select ds_proc_exame from proc_interno z Where z.ie_origem_proced = 24 and z.ie_situacao = 'A' and z.nr_sequencia = a.NR_SEQ_CALCULATION_TYPE),obter_desc_expressao_idioma(499688, null, wheb_usuario_pck.get_nr_seq_idioma))ds_calculation_w,
(select  ds_response_classification ds from RL_RESPONSE_CLASSIFICATION  where nr_sequencia =  nr_seq_response_classif)ds_ground_cl_w,
(select ds_departamento from departamento_medico x where x.cd_departamento =a.cd_referred_department) ds_ref_dept,
(select ds_departamento from departamento_medico x where x.cd_departamento =a.cd_medical_department) ds_to_med_dept_w
from rl_rep_to_hospital a
where nr_sequencia=nr_sequencia_p and ie_record_sub_type_p = '3';

/*External Referral - Report from another hospital */

c04 CURSOR FOR
SELECT pkg_date_formaters.to_varchar(a.DT_RECEPTION, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario)dt_record_w,
(select DS_RAZAO_SOCIAL from PESSOA_JURIDICA x where x.CD_CGC=CD_MEDICAL_INSTITUTION)ds_nme_inst_w,
(select nm_guerra from medico x where x.cd_pessoa_fisica=CD_REFERRED_DOCTOR)ds_referrd_doc_w,
(select DS_DEPARTAMENTO from DEPARTAMENTO_MEDICO x where x.CD_DEPARTAMENTO=CD_REFERRED_DEPARTMENT)ds_ref_med_w,
(select nm_guerra from medico x where x.cd_pessoa_fisica=CD_REFERRING_DOCTOR)ds_ref_doc_w,
(select DS_DEPARTAMENTO from DEPARTAMENTO_MEDICO x where x.CD_DEPARTAMENTO=CD_MEDICAL_DEPARTMENT)ds_med_dept_w
from RL_REP_FROM_HOSPITAL a
where nr_sequencia=nr_sequencia_p and ie_record_sub_type_p = '4';

BEGIN
    if ( ie_record_type_p ='EXT_REFERRAL' and ie_record_sub_type_p = '3') then
	for r_c03 in c03 loop
      for r_clinical_note_fields in clinical_note_fields loop
        begin
            if (r_clinical_note_fields.ie_field = 'DT_CALC' and (r_c03.ds_caldate_w IS NOT NULL AND r_c03.ds_caldate_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = ''  ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_caldate_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_caldate_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'CD_DIAGNOSES' and (r_c03.ds_icd_w IS NOT NULL AND r_c03.ds_icd_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_icd_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_icd_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'NM_MEDICO_RFRNG' and (r_c03.ds_ref_doc_w IS NOT NULL AND r_c03.ds_ref_doc_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_ref_doc_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_ref_doc_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'RFRD_MED_DEPT' and (r_c03.ds_ref_dept IS NOT NULL AND r_c03.ds_ref_dept::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_ref_dept;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_ref_dept;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'NM_INSTITUTION' and (r_c03.ds_nme_inst_w IS NOT NULL AND r_c03.ds_nme_inst_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_nme_inst_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_nme_inst_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'REFRNG_MED_DEPT' and (r_c03.ds_to_med_dept_w IS NOT NULL AND r_c03.ds_to_med_dept_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_to_med_dept_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_to_med_dept_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DT_REFERENCE' and (r_c03.ds_refdate_w IS NOT NULL AND r_c03.ds_refdate_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_refdate_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_refdate_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'NR_GROUNDS_REF' and (r_c03.ds_ground_cl_w IS NOT NULL AND r_c03.ds_ground_cl_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_ground_cl_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_ground_cl_w;
                end if;
              end;
			  end if;
            if (r_clinical_note_fields.ie_field = 'CD_REASON' and (r_c03.ds_indication_w IS NOT NULL AND r_c03.ds_indication_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_indication_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_indication_w;
                end if;
              end;
			  end if;
            if (r_clinical_note_fields.ie_field = 'DS_DIAGNOSIS' and (r_c03.ds_icd_desc_w IS NOT NULL AND r_c03.ds_icd_desc_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_icd_desc_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_icd_desc_w;
                end if;
              end;
			  end if;
            if (r_clinical_note_fields.ie_field = 'IE_DOC_TYPE' and (r_c03.ds_doc_type_w IS NOT NULL AND r_c03.ds_doc_type_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_doc_type_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_doc_type_w;
                end if;
              end;
			  end if;
            if (r_clinical_note_fields.ie_field = 'NM_REP_DOCTOR' and (r_c03.ds_rep_doc_w IS NOT NULL AND r_c03.ds_rep_doc_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_rep_doc_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_rep_doc_w;
                end if;
              end;
			  end if;
            if (r_clinical_note_fields.ie_field = 'NR_CALC_TYPE' and (r_c03.ds_calculation_w IS NOT NULL AND r_c03.ds_calculation_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048593) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_calculation_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c03.ds_calculation_w;
                end if;
              end;
			  end if;

        end;
      end loop;
	  end loop;
    elsif ( ie_record_type_p ='EXT_REFERRAL' and ie_record_sub_type_p = '1') then
    for r_c01 in c01
	loop
      for r_clinical_note_fields in clinical_note_fields
      loop
        begin
				if (r_clinical_note_fields.ie_field = 'CALC_TYPE' and (r_c01.ds_tipo_cal_w IS NOT NULL AND r_c01.ds_tipo_cal_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048591) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_tipo_cal_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_tipo_cal_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_DOC_FORM' and (r_c01.ds_doc_typ_w IS NOT NULL AND r_c01.ds_doc_typ_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048591) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_doc_typ_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_doc_typ_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DT_REFERENCE' and (r_c01.ds_refd_w IS NOT NULL AND r_c01.ds_refd_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048591) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_refd_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_refd_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_REFERRAL_DEP' and (r_c01.ds_med_dept_w IS NOT NULL AND r_c01.ds_med_dept_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048591) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_med_dept_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_med_dept_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_INDICATION' and (r_c01.ds_indic_w IS NOT NULL AND r_c01.ds_indic_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048591) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_indic_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_indic_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_REF_GROUND' and (r_c01.ds_grounds_ref_w IS NOT NULL AND r_c01.ds_grounds_ref_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048591) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_grounds_ref_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_grounds_ref_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'NM_RFRD_HOSP' and (r_c01.ds_nme_inst_w IS NOT NULL AND r_c01.ds_nme_inst_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048591) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_nme_inst_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_nme_inst_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_RFRD_DEPT' and (r_c01.ds_ref_med_w IS NOT NULL AND r_c01.ds_ref_med_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048591) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_ref_med_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_ref_med_w;
                end if;
              end;
			  end if;
             if (r_clinical_note_fields.ie_field = 'NM_RFRNG_DOC' and (r_c01.ds_ref_doc_w IS NOT NULL AND r_c01.ds_ref_doc_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048591) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_ref_doc_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_ref_doc_w;
                end if;
              end;
			  end if;
             if (r_clinical_note_fields.ie_field = 'DT_CALC' and (r_c01.ds_cal_w IS NOT NULL AND r_c01.ds_cal_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048591) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_cal_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c01.ds_cal_w;
                end if;
              end;
			  end if;
        end;
      end loop;
	  end loop;
    elsif ( ie_record_type_p ='EXT_REFERRAL' and ie_record_sub_type_p = '2') then
      for r_c02 in c02
	loop
      for r_clinical_note_fields in clinical_note_fields
      loop
        begin
				if (r_clinical_note_fields.ie_field = 'DT_REEFRENCE' and (r_c02.dt_reference_w IS NOT NULL AND r_c02.dt_reference_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(968438) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_reference_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_reference_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_RFRL_DEPT' and (r_c02.ds_ref_dept IS NOT NULL AND r_c02.ds_ref_dept::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(968438) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_ref_dept;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_ref_dept;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'NM_REFRD_DOCTOR' and (r_c02.ds_referrd_doc_w IS NOT NULL AND r_c02.ds_referrd_doc_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(968438) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_referrd_doc_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_referrd_doc_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'NM_INSTITUTION' and (r_c02.ds_nme_inst_w IS NOT NULL AND r_c02.ds_nme_inst_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(968438) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_nme_inst_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_nme_inst_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DS_MED_DEPT' and (r_c02.ds_med_dept_w IS NOT NULL AND r_c02.ds_med_dept_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(968438) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_med_dept_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_med_dept_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'NM_RFRNG_DOCTOR' and (r_c02.ds_ref_doc_w IS NOT NULL AND r_c02.ds_ref_doc_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(968438) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_ref_doc_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_ref_doc_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'DT_CALC' and (r_c02.dt_cal_w IS NOT NULL AND r_c02.dt_cal_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(968438) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_cal_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.dt_cal_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'CALC_TYPE' and (r_c02.ds_calculation_w IS NOT NULL AND r_c02.ds_calculation_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(968438) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_calculation_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c02.ds_calculation_w;
                end if;
              end;
			  end if;
        end;
      end loop;
	  end loop;
	   elsif ( ie_record_type_p ='EXT_REFERRAL' and ie_record_sub_type_p = '4') then
      for r_c04 in c04
	loop
      for r_clinical_note_fields in clinical_note_fields
      loop
        begin
				if (r_clinical_note_fields.ie_field = 'DT_RECEPTION' and (r_c04.dt_record_w IS NOT NULL AND r_c04.dt_record_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048577) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.dt_record_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.dt_record_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'NM_INSTITUTION' and (r_c04.ds_nme_inst_w IS NOT NULL AND r_c04.ds_nme_inst_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048577) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.ds_nme_inst_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.ds_nme_inst_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'REFRD_MEDICO' and (r_c04.ds_referrd_doc_w IS NOT NULL AND r_c04.ds_referrd_doc_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048577) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.ds_referrd_doc_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.ds_referrd_doc_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'REFRD_MED_DEPT' and (r_c04.ds_ref_med_w IS NOT NULL AND r_c04.ds_ref_med_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048577) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.ds_ref_med_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.ds_ref_med_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'REFRNG_MEDICO' and (r_c04.ds_ref_doc_w IS NOT NULL AND r_c04.ds_ref_doc_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048577) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.ds_ref_doc_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.ds_ref_doc_w;
                end if;
              end;
			  end if;
			  if (r_clinical_note_fields.ie_field = 'REFRNG_MED_DEPT' and (r_c04.ds_med_dept_w IS NOT NULL AND r_c04.ds_med_dept_w::text <> '')) then
              begin
                if ( coalesce(ds_content_w::text, '') = '' ) then
                  ds_content_w    := '<b>' || obter_desc_expressao(1048577) || '</b>';
                  ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.ds_med_dept_w;
                else
                  ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| r_c04.ds_med_dept_w;
                end if;
              end;
			  end if;
        end;
      end loop;
	  end loop;
    end if;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_ext_ref ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_record_sub_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
