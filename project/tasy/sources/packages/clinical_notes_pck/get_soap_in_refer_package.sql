-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_in_refer ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint, ie_option_p text) RETURNS varchar AS $body$
DECLARE

    ds_content_w varchar(32000);
   ds_record_w varchar(255);
ds_medico_w varchar(255);
ds_opinion_type_w varchar(29000);
ds_seq_nais_ins_w  varchar(255);
ds_seq_team_des_w varchar(255);
ds_espec_prof_w varchar(255);
ds_espec_dest_w varchar(255);
ds_pessoa_parec_w varchar(255);
ds_reason_cons_w varchar(4000);
ds_response_w varchar(4000);
nr_seq_parcer_w numeric(20);
nr_parcer_w varchar(255);

    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN
  if ( ie_option_p='R') then
select  b.nr_sequencia,b.nr_parecer
into STRICT
nr_seq_parcer_w,nr_parcer_w
from parecer_medico_req a,parecer_medico b
 where   b.nr_seq_interno=nr_sequencia_p and a.nr_parecer=b.nr_parecer;
 end if;
if ( ie_option_p = 'S') then
select
pkg_date_formaters.to_varchar(a.DT_ATUALIZACAO_NREC, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
obter_pf_usuario(coalesce(a.nm_usuario, a.nm_usuario_nrec),'N'),
(select DS_TIPO_PARECER from TIPO_PARECER where nr_sequencia=a.NR_SEQ_TIPO_PARECER),
(select ds_insurance_name_japanese from nais_insurance where nr_sequencia= a.NR_SEQ_NAIS_INSURANCE),
(select DS_EQUIPE from PF_EQUIPE where nr_sequencia=a.NR_SEQ_EQUIPE_DEST),
(select DS_ESPECIALIDADE from ESPECIALIDADE_MEDICA where CD_ESPECIALIDADE=a.CD_ESPECIALIDADE),
(select DS_ESPECIALIDADE from ESPECIALIDADE_MEDICA where CD_ESPECIALIDADE=a.CD_ESPECIALIDADE_DEST),
(select NM_PESSOA_FISICA from PESSOA_FISICA where CD_PESSOA_FISICA=a.CD_PESSOA_PARECER),
SUBSTR(CONVERT_LONG_TO_VARCHAR2('DS_MOTIVO_CONSULTA', 'PARECER_MEDICO_REQ', ' NR_PARECER = ' || nr_sequencia_p),1,4000) ,
null
into STRICT
ds_record_w ,
ds_medico_w ,
ds_opinion_type_w ,
ds_seq_nais_ins_w  ,
ds_seq_team_des_w ,
ds_espec_prof_w ,
ds_espec_dest_w ,
ds_pessoa_parec_w ,
ds_reason_cons_w ,
ds_response_w
from PARECER_MEDICO_REQ a
where  a.NR_PARECER=nr_sequencia_p
and a.nr_atendimento= nr_atendimento_p;
else
select
pkg_date_formaters.to_varchar(a.DT_ATUALIZACAO_NREC, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
obter_pf_usuario(coalesce(a.nm_usuario, a.nm_usuario_nrec),'N'),
(select DS_TIPO_PARECER from TIPO_PARECER where nr_sequencia=a.NR_SEQ_TIPO_PARECER),
(select ds_insurance_name_japanese from nais_insurance where nr_sequencia= a.NR_SEQ_NAIS_INSURANCE),
(select DS_EQUIPE from PF_EQUIPE where nr_sequencia=a.NR_SEQ_EQUIPE_DEST),
(select DS_ESPECIALIDADE from ESPECIALIDADE_MEDICA where CD_ESPECIALIDADE=a.CD_ESPECIALIDADE),
(select DS_ESPECIALIDADE from ESPECIALIDADE_MEDICA where CD_ESPECIALIDADE=a.CD_ESPECIALIDADE_DEST),
(select NM_PESSOA_FISICA from PESSOA_FISICA where CD_PESSOA_FISICA=a.CD_PESSOA_PARECER),
SUBSTR(CONVERT_LONG_TO_VARCHAR2('DS_MOTIVO_CONSULTA', 'PARECER_MEDICO_REQ', ' NR_PARECER = ' || nr_parcer_w),1,4000) ,
SUBSTR(CONVERT_LONG_TO_VARCHAR2('DS_PARECER', 'PARECER_MEDICO', ' NR_PARECER = ' || nr_parcer_w||'and nr_sequencia = '||nr_seq_parcer_w ),1,4000)
into STRICT
ds_record_w ,
ds_medico_w ,
ds_opinion_type_w ,
ds_seq_nais_ins_w  ,
ds_seq_team_des_w ,
ds_espec_prof_w ,
ds_espec_dest_w ,
ds_pessoa_parec_w ,
ds_reason_cons_w ,
ds_response_w
from PARECER_MEDICO_REQ a,PARECER_MEDICO b
where  b.NR_SEQ_INTERNO=nr_sequencia_p
and a.NR_PARECER=b.NR_PARECER;
end if;
    for r_c01 in c01 loop
    if (ie_record_type_p = 'INTERNAL_REF') then
        if (r_c01.ie_field    = 'DT_RECORD' and (ds_record_w IS NOT NULL AND ds_record_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
          if (ie_option_p ='S') then
            ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(298632) ||'</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_record_w;
            else
             ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(892005)|| '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_record_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_record_w;
          end if;
        end if;
        if (r_c01.ie_field    = 'CD_MEDICO' and (ds_medico_w IS NOT NULL AND ds_medico_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
             if (ie_option_p ='S') then
            ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(298632) ||'</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_medico_w;
            else
             ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(892005)|| '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_medico_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_medico_w;
          end if;
        end if;
         if (r_c01.ie_field    = 'CD_OPINION_TYPE' and (ds_opinion_type_w IS NOT NULL AND ds_opinion_type_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            if (ie_option_p ='S') then
            ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(298632) ||'</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_opinion_type_w;
            else
             ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(892005)|| '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_opinion_type_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_opinion_type_w;
          end if;
        end if;
        if (r_c01.ie_field    = 'NR_SEQ_NAIS_INS' and (ds_seq_nais_ins_w IS NOT NULL AND ds_seq_nais_ins_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            if (ie_option_p ='S') then
            ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(298632) ||'</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_seq_nais_ins_w;
            else
             ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(892005)|| '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_seq_nais_ins_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_seq_nais_ins_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'NR_SEQ_TEAM_DES' and (ds_seq_team_des_w IS NOT NULL AND ds_seq_team_des_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
             if (ie_option_p ='S') then
            ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(298632) ||'</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_seq_team_des_w;
            else
             ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(892005)|| '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_seq_team_des_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_seq_team_des_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_ESPEC_PROF' and (ds_espec_prof_w IS NOT NULL AND ds_espec_prof_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
           if (ie_option_p ='S') then
            ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(298632) ||'</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_espec_prof_w;
            else
             ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(892005)|| '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_espec_prof_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_espec_prof_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_ESPEC_DEST' and (ds_espec_dest_w IS NOT NULL AND ds_espec_dest_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            if (ie_option_p ='S') then
            ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(298632) ||'</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_espec_dest_w;
            else
             ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(892005)|| '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_espec_dest_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_espec_dest_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'CD_PESSOA_PAREC' and (ds_pessoa_parec_w IS NOT NULL AND ds_pessoa_parec_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
           if (ie_option_p ='S') then
            ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(298632) ||'</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_pessoa_parec_w;
            else
             ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(892005)|| '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_pessoa_parec_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_pessoa_parec_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'DS_REASON_CONS' and (ds_reason_cons_w IS NOT NULL AND ds_reason_cons_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
           if (ie_option_p ='S') then
            ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(298632) ||'</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_reason_cons_w;
            else
             ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(892005)|| '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_reason_cons_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_reason_cons_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'DS_RESPONSE' and (ds_response_w IS NOT NULL AND ds_response_w::text <> '') and ie_option_p ='R')then
          if (coalesce(ds_content_w::text, '') = '' ) then
           if (ie_option_p ='S') then
            ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(298632) ||'</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_response_w;
            else
             ds_content_w    := '<b>' || obter_desc_expressao(1042359) ||' - '||obter_desc_expressao(892005)|| '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_response_w;
            end if;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_response_w;
          end if;
        end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_in_refer ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint, ie_option_p text) FROM PUBLIC;
