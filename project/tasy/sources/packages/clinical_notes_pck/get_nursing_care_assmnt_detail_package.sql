-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_nursing_care_assmnt_detail (nr_sequencia_p bigint) RETURNS varchar AS $body$
DECLARE


ds_result_w		varchar(32000);
ie_first_row_w  nursing_care_encounter.ie_situacao%type := 'N';
nr_sequencia_sup_w nursing_care_item.nr_seq_item_sup%type;

c02_a CURSOR FOR
SELECT nci.ds_item,nci.nr_sequencia,
(select max(ds_resultado) from nursing_care_result ncr where ncr.nr_seq_item = nci.nr_sequencia and ncer.nr_seq_item_result = ncr.nr_sequencia) ds_result
from nursing_care_encounter nce
join nursing_care_enc_result ncer on nce.nr_sequencia = ncer.nr_seq_avaliacao
join nursing_care_item nci on nci.nr_sequencia = ncer.nr_seq_item
join nursing_care_version ncv on ncv.nr_sequencia = nci.nr_seq_versao
where nce.nr_sequencia = nr_sequencia_p and nr_seq_classificacao ='A'
and (ncer.nr_seq_item_result IS NOT NULL AND ncer.nr_seq_item_result::text <> '')
and coalesce(nr_seq_item_sup::text, '') = ''
order by nci.nr_seq_apres;

c02_b CURSOR FOR
SELECT nci.ds_item,nci.nr_sequencia,
(select max(ds_resultado) from nursing_care_result ncr where ncr.nr_seq_item = nci.nr_sequencia and ncer.nr_seq_item_result = ncr.nr_sequencia) ds_result
from nursing_care_encounter nce
join nursing_care_enc_result ncer on nce.nr_sequencia = ncer.nr_seq_avaliacao
join nursing_care_item nci on nci.nr_sequencia = ncer.nr_seq_item
join nursing_care_version ncv on ncv.nr_sequencia = nci.nr_seq_versao
where nce.nr_sequencia = nr_sequencia_p and nr_seq_classificacao ='B'
and (ncer.nr_seq_item_result IS NOT NULL AND ncer.nr_seq_item_result::text <> '')
and coalesce(nr_seq_item_sup::text, '') = ''
order by nci.nr_seq_apres;

c02_c CURSOR FOR
SELECT nci.ds_item,nci.nr_sequencia,
(select max(ds_resultado) from nursing_care_result ncr where ncr.nr_seq_item = nci.nr_sequencia and ncer.nr_seq_item_result = ncr.nr_sequencia) ds_result
from nursing_care_encounter nce
join nursing_care_enc_result ncer on nce.nr_sequencia = ncer.nr_seq_avaliacao
join nursing_care_item nci on nci.nr_sequencia = ncer.nr_seq_item
join nursing_care_version ncv on ncv.nr_sequencia = nci.nr_seq_versao
where nce.nr_sequencia = nr_sequencia_p and nr_seq_classificacao ='C'
and (ncer.nr_seq_item_result IS NOT NULL AND ncer.nr_seq_item_result::text <> '')
and coalesce(nr_seq_item_sup::text, '') = ''
order by nci.nr_seq_apres;

c02_child_a CURSOR(nr_seq_item_sup_w bigint) FOR
SELECT nci.ds_item,
(select max(ds_resultado) from nursing_care_result ncr where ncr.nr_seq_item = nci.nr_sequencia and ncer.nr_seq_item_result = ncr.nr_sequencia) ds_result
from nursing_care_encounter nce
join nursing_care_enc_result ncer on nce.nr_sequencia = ncer.nr_seq_avaliacao
join nursing_care_item nci on nci.nr_sequencia = ncer.nr_seq_item
join nursing_care_version ncv on ncv.nr_sequencia = nci.nr_seq_versao
where nce.nr_sequencia = nr_sequencia_p and nr_seq_classificacao ='A'
and nci.nr_seq_item_sup = nr_seq_item_sup_w
and (ncer.nr_seq_item_result IS NOT NULL AND ncer.nr_seq_item_result::text <> '')
order by nci.nr_seq_apres;

c02_child_b CURSOR(nr_seq_item_sup_w bigint) FOR
SELECT nci.ds_item,
(select max(ds_resultado) from nursing_care_result ncr where ncr.nr_seq_item = nci.nr_sequencia and ncer.nr_seq_item_result = ncr.nr_sequencia) ds_result
from nursing_care_encounter nce
join nursing_care_enc_result ncer on nce.nr_sequencia = ncer.nr_seq_avaliacao
join nursing_care_item nci on nci.nr_sequencia = ncer.nr_seq_item
join nursing_care_version ncv on ncv.nr_sequencia = nci.nr_seq_versao
where nce.nr_sequencia = nr_sequencia_p and nr_seq_classificacao ='B'
and nci.nr_seq_item_sup = nr_seq_item_sup_w
and (ncer.nr_seq_item_result IS NOT NULL AND ncer.nr_seq_item_result::text <> '')
order by nci.nr_seq_apres;

c02_child_c CURSOR(nr_seq_item_sup_w bigint) FOR
SELECT nci.ds_item,
(select max(ds_resultado) from nursing_care_result ncr where ncr.nr_seq_item = nci.nr_sequencia and ncer.nr_seq_item_result = ncr.nr_sequencia) ds_result
from nursing_care_encounter nce
join nursing_care_enc_result ncer on nce.nr_sequencia = ncer.nr_seq_avaliacao
join nursing_care_item nci on nci.nr_sequencia = ncer.nr_seq_item
join nursing_care_version ncv on ncv.nr_sequencia = nci.nr_seq_versao
where nce.nr_sequencia = nr_sequencia_p and nr_seq_classificacao ='C'
and nci.nr_seq_item_sup = nr_seq_item_sup_w
and (ncer.nr_seq_item_result IS NOT NULL AND ncer.nr_seq_item_result::text <> '')
order by nci.nr_seq_apres;
BEGIN

for r_c02_a in c02_a loop
begin
    if ( coalesce(ds_result_w::text, '') = '' ) then
        ds_result_w    := '</br>' || '<b>' || obter_desc_expressao(568305) || '</b>';
        ds_result_w    := ds_result_w|| '</br>' || r_c02_a.ds_item || ' - '|| r_c02_a.ds_result;
    else
        ds_result_w    := ds_result_w|| '</br>' || r_c02_a.ds_item || ' - '|| r_c02_a.ds_result;
    end if;
    for r_c02_child_a in c02_child_a(r_c02_a.nr_sequencia) loop
    begin
        ds_result_w    := ds_result_w|| '</br>' || r_c02_child_a.ds_item || ' - '|| r_c02_child_a.ds_result;
    end;
    end loop;
end;
end loop;
ie_first_row_w := 'S';
for r_c02_b in c02_b loop
begin
    if ( coalesce(ds_result_w::text, '') = '' or ie_first_row_w = 'S') then
        ds_result_w    := ds_result_w || '</br>' ||  '<b>' || obter_desc_expressao(309171) || '</b>';
        ds_result_w    := ds_result_w|| '</br>' || r_c02_b.ds_item || ' - '|| r_c02_b.ds_result;
		ie_first_row_w := 'N';
    else
        ds_result_w    := ds_result_w|| '</br>' || r_c02_b.ds_item || ' - '|| r_c02_b.ds_result;
    end if;
    for r_c02_child_b in c02_child_b(r_c02_b.nr_sequencia) loop
    begin
        ds_result_w    := ds_result_w|| '</br>' || r_c02_child_b.ds_item || ' - '|| r_c02_child_b.ds_result;
    end;
    end loop;
end;
end loop;
ie_first_row_w := 'S';
for r_c02_c in c02_c loop
begin
    if ( coalesce(ds_result_w::text, '') = '' or ie_first_row_w = 'S') then
        ds_result_w    := ds_result_w ||  '</br>' ||  '<b>' || obter_desc_expressao(309084) || '</b>';
        ds_result_w    := ds_result_w|| '</br>' || r_c02_c.ds_item || ' - '|| r_c02_c.ds_result;
		ie_first_row_w := 'N';
    else
        ds_result_w    := ds_result_w|| '</br>' || r_c02_c.ds_item || ' - '|| r_c02_c.ds_result;
    end if;
    for r_c02_child_c in c02_child_c(r_c02_c.nr_sequencia) loop
    begin
        ds_result_w    := ds_result_w|| '</br>' || r_c02_child_c.ds_item || ' - '|| r_c02_child_c.ds_result;
    end;
    end loop;
end;
end loop;

return ds_result_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_nursing_care_assmnt_detail (nr_sequencia_p bigint) FROM PUBLIC;
