-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_care_plan (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_content_w    varchar(32000);
    care_plan_summ_w varchar(11000);
    ds_model_w varchar(255);
    ds_notes_w varchar(255);
    ds_professional_w     varchar(255);
    dt_end_w               varchar(255);
    dt_first_hor_w                  varchar(255);
    dt_inicial_w varchar(255);
    dt_record_w          varchar(255);
    pat_asmnt_summ_w   varchar(11000);
    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN
	select
    a.ds_resumo,
    b.nr_seq_modelo,
    b.ds_observacao,
    obter_nome_pf(b.cd_prescritor),
    pkg_date_formaters.to_varchar(b.dt_validade_prescr, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
    pkg_date_formaters.to_varchar(b.dt_primeiro_horario, 'shortTime', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
    pkg_date_formaters.to_varchar(b.dt_inicio_prescr, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
    pkg_date_formaters.to_varchar(b.dt_prescricao, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
    c.ds_summary
    into STRICT
    pat_asmnt_summ_w,
    ds_model_w,
    ds_notes_w,
    ds_professional_w,
    dt_end_w,
    dt_first_hor_w,
    dt_inicial_w,
    dt_record_w,
    care_plan_summ_w
    from pe_prescricao b
    left outer join patient_cp_summary c
    on c.nr_seq_prescr = b.nr_sequencia
    left outer join pe_prescr_resumo a
    on a.nr_seq_pe_prescr = b.nr_sequencia
    where  b.nr_sequencia = nr_sequencia_p;
    for r_c01 in c01
    loop
      if (ie_record_type_p = 'CARE_PLAN')then
        if (r_c01.ie_field    = 'CARE_PLAN_SUMM' and (care_plan_summ_w IS NOT NULL AND care_plan_summ_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(953978) || '</b>';
            ds_content_w    := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| care_plan_summ_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| care_plan_summ_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_MODEL' and (ds_model_w IS NOT NULL AND ds_model_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(953978) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_model_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_model_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_NOTES' and (ds_notes_w IS NOT NULL AND ds_notes_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(953978) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          else
            ds_content_w := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_PROFESSIONAL' and (ds_professional_w IS NOT NULL AND ds_professional_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(953978) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_professional_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_professional_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_END' and (dt_end_w IS NOT NULL AND dt_end_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(953978) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_end_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_end_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_FIRST_HOR' and (dt_first_hor_w IS NOT NULL AND dt_first_hor_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(953978) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_first_hor_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_first_hor_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_INICIAL' and (dt_inicial_w IS NOT NULL AND dt_inicial_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(953978) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_inicial_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_inicial_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'DT_RECORD' and (dt_record_w IS NOT NULL AND dt_record_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(953978) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_record_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_record_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'PAT_ASMNT_SUMM' and (pat_asmnt_summ_w IS NOT NULL AND pat_asmnt_summ_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(953978) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| pat_asmnt_summ_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| pat_asmnt_summ_w;
          end if;
        end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_care_plan (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
