-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_dpc ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_content_w varchar(32000);
   DS_INCL_CLASSIF varchar(255);
DS_START_DATE varchar(255);
DS_END_DATE varchar(255);
DS_EDITION  varchar(255);
DS_DEPARTMENT varchar(255);
DS_MOST_EXP_DISEAS varchar(255);
DS_ADMSN_RES varchar(255);
DS_INPATIENT_ROUTE varchar(255);
DS_EXIT_POINT varchar(255);
DS_OUTCOME varchar(255);
DS_DPC_SCORE varchar(255);

    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN

 select obter_valor_dominio(9603, SI_CATEGORY) ,
 pkg_date_formaters.to_varchar(a.DT_START_DPC, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
pkg_date_formaters.to_varchar(a.DT_END_DPC, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
(select  nr_version from dpc_edition where nr_sequencia =a.NR_SEQ_EDITION ) ,
(select DS_DEPARTAMENTO from DEPARTAMENTO_MEDICO x where x.CD_DEPARTAMENTO=a.CD_DEPARTAMENTO) ,
(select coalesce(b.cd_multiclassif_code, b.cd_icd_code) || ' - ' || b.ds_disease_name  from icd_codes_main_jpn b
where  b.nr_disease_number=a.NR_DISEASE_NUMBER)  ,
obter_valor_dominio(9604,a.SI_ADMISSION_REASON),
obter_valor_dominio(9605,SI_INPATIENT_ROUTE)  ,
obter_valor_dominio(9606,SI_EXIT_POINT) ,
obter_valor_dominio(9602,SI_OUT_COME)  ,
(select
        cd_dpc || '-' ||
        y.nm_dpc || '_' ||
        nm_surgery || '_' ||
        si_surgery_treat_1 || '_' ||
        si_surgery_treat_2 || '_' ||
        si_definition || '_' ||
        si_severity
from    dpc_score y
where   nr_seq_edition = a.nr_seq_edition
and     nr_sequencia = a.nr_seq_dpc_score)
into STRICT
DS_INCL_CLASSIF,
DS_START_DATE,
DS_END_DATE,
DS_EDITION ,
DS_DEPARTMENT,
DS_MOST_EXP_DISEAS,
DS_ADMSN_RES,
DS_INPATIENT_ROUTE,
DS_EXIT_POINT,
DS_OUTCOME,
DS_DPC_SCORE

from PATIENT_DPC  a
WHERE     nr_atendimento = nr_atendimento_p   and nr_sequencia=nr_sequencia_p;
    for r_c01 in c01 loop
    if (ie_record_type_p = 'DPC') then
        if (r_c01.ie_field    = 'INCL_CLASSIF' and (DS_INCL_CLASSIF IS NOT NULL AND DS_INCL_CLASSIF::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(968213) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_INCL_CLASSIF;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_INCL_CLASSIF;
          end if;
        end if;
        if (r_c01.ie_field    = 'START_DATE' and (DS_START_DATE IS NOT NULL AND DS_START_DATE::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(968213) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_START_DATE;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_START_DATE;
          end if;
        end if;
         if (r_c01.ie_field    = 'END_DATE' and (DS_END_DATE IS NOT NULL AND DS_END_DATE::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(968213) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_END_DATE;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_END_DATE;
          end if;
        end if;
        if (r_c01.ie_field    = 'DS_EDITION' and (DS_EDITION IS NOT NULL AND DS_EDITION::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(968213) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_EDITION;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_EDITION;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_DEPARTMENT' and (DS_DEPARTMENT IS NOT NULL AND DS_DEPARTMENT::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(968213) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_DEPARTMENT;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_DEPARTMENT;
          end if;
        end if;
        if (r_c01.ie_field   = 'MOST_EXP_DISEAS' and (DS_MOST_EXP_DISEAS IS NOT NULL AND DS_MOST_EXP_DISEAS::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(968213) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_MOST_EXP_DISEAS;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_MOST_EXP_DISEAS;
          end if;
        end if;
		if (r_c01.ie_field   = 'CD_ADMSN_RES' and (DS_ADMSN_RES IS NOT NULL AND DS_ADMSN_RES::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(968213) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_ADMSN_RES;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_ADMSN_RES;
          end if;
        end if;
		if (r_c01.ie_field   = 'INPATIENT_ROUTE' and (DS_INPATIENT_ROUTE IS NOT NULL AND DS_INPATIENT_ROUTE::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(968213) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_INPATIENT_ROUTE;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_INPATIENT_ROUTE;
          end if;
        end if;
		if (r_c01.ie_field   = 'EXIT_POINT' and (DS_EXIT_POINT IS NOT NULL AND DS_EXIT_POINT::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(968213) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_EXIT_POINT;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_EXIT_POINT;
          end if;
        end if;
		if (r_c01.ie_field   = 'DS_PROCEDURE' and (DS_OUTCOME IS NOT NULL AND DS_OUTCOME::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(968213) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_OUTCOME;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_OUTCOME;
          end if;
        end if;
        if (r_c01.ie_field   = 'DPC_SCORE' and (DS_DPC_SCORE IS NOT NULL AND DS_DPC_SCORE::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(968213) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_DPC_SCORE;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| DS_DPC_SCORE;
          end if;
        end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_dpc ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
