-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE clinical_notes_pck.soap_data_after_delete ( cd_evolucao_p bigint, cd_exp_title_p clinical_note_soap_data.CD_EXP_TITLE%type default null) AS $body$
DECLARE


is_evol_submitted_w varchar(1) := 'N';
is_evol_not_submit_w varchar(1) := 'N';
ie_soap_data_exists_w varchar(1) := 'N';
ds_content_sub_w           evolucao_paciente.ds_evolucao%TYPE;
ds_content_obj_w           evolucao_paciente.ds_evolucao%TYPE;
ds_content_asmnt_w         evolucao_paciente.ds_evolucao%TYPE;
ds_content_pln_w           evolucao_paciente.ds_evolucao%TYPE;
ds_content_sub_free_w      evolucao_paciente.ds_evolucao%TYPE;
ds_content_obj_free_w      evolucao_paciente.ds_evolucao%TYPE;
ds_content_asmnt_free_w    evolucao_paciente.ds_evolucao%TYPE;
ds_content_pln_free_w      evolucao_paciente.ds_evolucao%TYPE;
ds_content_soap_free_w     evolucao_paciente.ds_evolucao%TYPE;
ds_content_new_w           evolucao_paciente.ds_evolucao%TYPE;
nr_seq_text_soap_w         parametro_medico.nr_seq_text_soap%TYPE;
ie_tipo_evolucao_w         usuario.ie_tipo_evolucao%TYPE;
ds_content_w               evolucao_paciente.ds_evolucao%TYPE;
ds_standard_text_w         varchar(32000);
nr_atendimento_w           bigint;
cd_evolucao_w              bigint;

c01 CURSOR FOR
SELECT a.*,b.nr_atendimento
FROM clinical_note_soap_data a , evolucao_paciente b
WHERE a.cd_evolucao = b.cd_evolucao
and b.cd_evolucao = cd_evolucao_p
order by a.nr_sequencia;

BEGIN

select CASE WHEN count(1)=1 THEN 'S'  ELSE 'N' END  into STRICT is_evol_submitted_w
from evolucao_paciente
where cd_evolucao = cd_evolucao_p
and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and ie_situacao = 'A'
and coalesce(dt_inativacao::text, '') = '';

select CASE WHEN count(1)=1 THEN 'S'  ELSE 'N' END  into STRICT is_evol_not_submit_w
from evolucao_paciente
where cd_evolucao = cd_evolucao_p
and coalesce(dt_liberacao::text, '') = ''
and ie_situacao = 'A';

select CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END  into STRICT ie_soap_data_exists_w
from clinical_note_soap_data
where cd_evolucao = cd_evolucao_p;

SELECT nr_seq_text_soap
INTO STRICT nr_seq_text_soap_w
FROM parametro_medico
WHERE cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

select max(txt_soap_subjective),
max(txt_soap_objective),
max(txt_soap_assessment),
max(txt_soap_plan),
max(txt_soap_free)
into STRICT ds_content_sub_free_w,
ds_content_obj_free_w,
ds_content_asmnt_free_w,
ds_content_pln_free_w,
ds_content_soap_free_w
from evolucao_paciente_compl
where nr_seq_evo_paciente = cd_evolucao_p;


IF (nr_seq_text_soap_w IS NOT NULL AND nr_seq_text_soap_w::text <> '') THEN
    SELECT ds_texto
    INTO STRICT ds_standard_text_w
    FROM texto_padrao
    WHERE nr_sequencia = nr_seq_text_soap_w;
ELSE
    CALL wheb_mensagem_pck.exibir_mensagem_abort(1161372);
END IF;
IF ( ie_soap_data_exists_w = 'S'  ) Then
IF (cd_evolucao_p IS NOT NULL AND cd_evolucao_p::text <> '') THEN
    FOR r_c01 IN c01 LOOP
        IF ( r_c01.ie_med_rec_type = 'DIAGNOSIS' OR r_c01.ie_med_rec_type = 'PROBLEM' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_asmnt_w := ds_content_asmnt_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'CPOE_ITEMS' AND r_c01.ie_stage = 1 ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, r_c01.IE_CPOE_ITEM_TYPE, r_c01.ie_soap_type,r_c01.ie_stage, r_c01.ie_option, 0);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'CPOE_ITEMS' AND r_c01.ie_stage = 2 ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, r_c01.IE_CPOE_ITEM_TYPE, r_c01.ie_soap_type,r_c01.ie_stage, r_c01.ie_option);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'INPATIENT' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'DISCHARGE' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'DEPT_TRANSFER' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage,r_c01.cd_exp_title);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'WARD_TRANSFER' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'BED_TRANSFER' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'TEMP_LEAVE' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage,r_c01.ie_option);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'CLNICAL_PATHWAY' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'MED_CERT' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'CONSENT' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'MED_GUIDANCE' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'DPC' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'DSCHRG_INSTR' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'CARE_PLAN' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'SURGERY' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'INTERNAL_REF' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage,r_c01.ie_option);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'BED_RQST' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'MED_DSCHG_REQ' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'EMERG_SERV_CONS' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'CONS_SCHD' OR r_c01.ie_med_rec_type = 'EXAM_SCHD' OR r_c01.ie_med_rec_type = 'SRVC_SCHD' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'GNRL_INSTRCT' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'DIALYSIS_SCHD' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF ( r_c01.ie_med_rec_type = 'SURG_ACHIEVE' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
		ELSIF (r_c01.ie_med_rec_type = 'IP_MED_TP' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
        ELSIF (r_c01.ie_med_rec_type = 'PD_MED_TP' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
		ELSIF (r_c01.ie_med_rec_type = 'EXT_REFERRAL' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, r_c01.ie_cpoe_item_type, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
		ELSIF (r_c01.ie_med_rec_type = 'REHAB' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, r_c01.ie_cpoe_item_type, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
		ELSIF (r_c01.ie_med_rec_type = 'NUT_GUIDANCE' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, r_c01.ie_cpoe_item_type, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_asmnt_w := ds_content_asmnt_w || '</br>' || ds_content_w;
        ELSIF (r_c01.ie_med_rec_type = 'NURSE_CARE_NEED' ) THEN
            ds_content_w := clinical_notes_pck.get_soap_content(r_c01.nr_atendimento, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, r_c01.ie_cpoe_item_type, r_c01.ie_soap_type,r_c01.ie_stage);
            ds_content_obj_w := ds_content_obj_w || '</br>' || ds_content_w;
        END IF;
    END LOOP;
END IF;
	IF (ds_content_pln_free_w IS NOT NULL AND ds_content_pln_free_w::text <> '') THEN
        ds_content_new_w := replace_macro(ds_standard_text_w, '@pln_free', ds_content_pln_free_w);
    ELSE
        ds_content_new_w := replace_macro(ds_standard_text_w, '@pln_free', ' ');
    END IF;

    IF (ds_content_soap_free_w IS NOT NULL AND ds_content_soap_free_w::text <> '') THEN
        ds_content_new_w := replace_macro(ds_content_new_w, '@soap_free', ds_content_soap_free_w);
    ELSE
        ds_content_new_w := replace_macro(ds_content_new_w, '@soap_free', ' ');
    END IF;

    IF (ds_content_obj_free_w IS NOT NULL AND ds_content_obj_free_w::text <> '') THEN
        ds_content_new_w := replace_macro(ds_content_new_w, '@obj_free', ds_content_obj_free_w);
    ELSE
        ds_content_new_w := replace_macro(ds_content_new_w, '@obj_free', ' ');
    END IF;

    IF (ds_content_sub_free_w IS NOT NULL AND ds_content_sub_free_w::text <> '') THEN
        ds_content_new_w := replace_macro(ds_content_new_w, '@subj_free', ds_content_sub_free_w);
    ELSE
        ds_content_new_w := replace_macro(ds_content_new_w, '@subj_free', ' ');
    END IF;

    IF (ds_content_asmnt_free_w IS NOT NULL AND ds_content_asmnt_free_w::text <> '') THEN
        ds_content_new_w := replace_macro(ds_content_new_w, '@asmnt_free', ds_content_asmnt_free_w);
    ELSE
        ds_content_new_w := replace_macro(ds_content_new_w, '@asmnt_free', ' ');
    END IF;

    IF (ds_content_pln_w IS NOT NULL AND ds_content_pln_w::text <> '') THEN
        ds_content_new_w := replace_macro(ds_content_new_w, '@Plan', ds_content_pln_w);
    ELSE
        ds_content_new_w := replace_macro(ds_content_new_w, '@Plan', ' ');
    END IF;

    IF (ds_content_obj_w IS NOT NULL AND ds_content_obj_w::text <> '') THEN
        ds_content_new_w := replace_macro(ds_content_new_w, '@Objective', ds_content_obj_w);
    ELSE
        ds_content_new_w := replace_macro(ds_content_new_w, '@Objective', ' ');
    END IF;

    IF (ds_content_sub_w IS NOT NULL AND ds_content_sub_w::text <> '') THEN
        ds_content_new_w := replace_macro(ds_content_new_w, '@Subjective', ds_content_sub_w);
    ELSE
        ds_content_new_w := replace_macro(ds_content_new_w, '@Subjective', ' ');
    END IF;

    IF (ds_content_asmnt_w IS NOT NULL AND ds_content_asmnt_w::text <> '') THEN
        ds_content_new_w := replace_macro(ds_content_new_w, '@Assessment', ds_content_asmnt_w);
    ELSE
        ds_content_new_w := replace_macro(ds_content_new_w, '@Assessment', ' ');
    END IF;
    IF (is_evol_not_submit_w = 'S') then
        UPDATE evolucao_paciente
        SET ds_evolucao = ds_content_new_w,
        dt_atualizacao = clock_timestamp(),
        nm_usuario = wheb_usuario_pck.get_nm_usuario,
        dt_atualizacao_nrec = clock_timestamp(),
        nm_usuario_nrec = wheb_usuario_pck.get_nm_usuario
        WHERE cd_evolucao = cd_evolucao_p;
    end if;
    IF (is_evol_submitted_w = 'S') then
        UPDATE evolucao_paciente
        SET dt_inativacao = clock_timestamp(),
        dt_atualizacao = clock_timestamp(),
        nm_usuario = wheb_usuario_pck.get_nm_usuario,
        dt_atualizacao_nrec = clock_timestamp(),
        nm_usuario_nrec = wheb_usuario_pck.get_nm_usuario,
        ie_situacao ='I'
        WHERE cd_evolucao = cd_evolucao_p;

		select  nextval('evolucao_paciente_seq') into STRICT cd_evolucao_w;

		INSERT INTO evolucao_paciente(
			cd_evolucao,
			dt_evolucao,
			ie_tipo_evolucao,
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			nr_atendimento,
			ds_evolucao,
			cd_medico,
			dt_liberacao,
			ie_evolucao_clinica,
			cd_setor_atendimento,
			ie_situacao)
	   SELECT
			cd_evolucao_w,
			clock_timestamp(),
			ie_tipo_evolucao,
			cd_pessoa_fisica,
			clock_timestamp(),
			nm_usuario,
			nr_atendimento,
			ds_content_new_w,
			cd_medico,
			clock_timestamp(),
			ie_evolucao_clinica,
			cd_setor_atendimento,
			'A' from evolucao_paciente where cd_evolucao = cd_evolucao_p;
		CALL clinical_notes_pck.update_clinical_note_code(cd_evolucao_p,cd_evolucao_w);
		update clinical_note_soap_data
		set cd_evolucao = cd_evolucao_w,
		cd_exp_title = cd_exp_title_p
		where cd_evolucao = cd_evolucao_p;
		CALL generate_compl_evol_paciente(cd_evolucao_w,cd_evolucao_p);
	end if;
else
        UPDATE evolucao_paciente
        SET dt_inativacao = clock_timestamp(),
        dt_atualizacao = clock_timestamp(),
        nm_usuario = wheb_usuario_pck.get_nm_usuario,
        dt_atualizacao_nrec = clock_timestamp(),
        nm_usuario_nrec = wheb_usuario_pck.get_nm_usuario,
        ie_situacao ='I',
		dt_liberacao = coalesce(dt_liberacao,clock_timestamp())
        WHERE cd_evolucao = cd_evolucao_p;
end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE clinical_notes_pck.soap_data_after_delete ( cd_evolucao_p bigint, cd_exp_title_p clinical_note_soap_data.CD_EXP_TITLE%type default null) FROM PUBLIC;
