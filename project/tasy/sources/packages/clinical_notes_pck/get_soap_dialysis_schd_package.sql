-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_dialysis_schd (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_content_w varchar(32000);
    ds_unit_w varchar(255);
    ds_schedule_w varchar(255);
	ds_shift_w varchar(255);
    ds_score_w varchar(255);
    ds_insurance_w varchar(255);
	dt_start_w varchar(255);
    dt_end_w varchar(255);
    ds_dept_w varchar(255);
    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN
    select 
	substr(hd_obter_desc_unid_dialise(nr_seq_unid_dialise),1,80),
	substr(obter_descricao_padrao('HD_ESCALA','DS_ESCALA',nr_seq_escala),1,80),
	substr(obter_descricao_padrao('HD_TURNO','DS_TURNO',nr_seq_turno),1,80),
   ( select  ds_escala from hd_escala where nr_seq_unid_exclus   = nr_seq_escala),
   (select ds_insurance_name_japanese from nais_insurance where nr_sequencia= nr_seq_convenio),
	dt_inicio,
	dt_fim,
	null
	into STRICT
	ds_unit_w,
	ds_schedule_w,
	ds_shift_w,
    ds_score_w,
    ds_insurance_w,
	dt_start_w,
	dt_end_w,
	ds_dept_w
	from hd_escala_dialise
	where nr_sequencia = nr_sequencia_p;
    for r_c01 in c01
    loop
      if (ie_record_type_p = 'DIALYSIS_SCHD' )then
        if (r_c01.ie_field    = 'DS_UNIT' and (ds_unit_w IS NOT NULL AND ds_unit_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(1049371) || '</b>';
            ds_content_w    := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_unit_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_unit_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_SCHEDULE' and (ds_schedule_w IS NOT NULL AND ds_schedule_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1049371) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_schedule_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_schedule_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_SHIFT' and (ds_shift_w IS NOT NULL AND ds_shift_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1049371) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_shift_w;
          else
            ds_content_w := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_shift_w;
          end if;
		end if;
		  if (r_c01.ie_field   = 'DS_SCORE' and (ds_score_w IS NOT NULL AND ds_score_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1049371) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_score_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_score_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_INSURANCE' and (ds_insurance_w IS NOT NULL AND ds_insurance_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1049371) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_insurance_w;
          else
            ds_content_w := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_insurance_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_START' and (dt_start_w IS NOT NULL AND dt_start_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1049371) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_start_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_start_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_END' and (dt_end_w IS NOT NULL AND dt_end_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1049371) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_end_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_end_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'DS_DEPT' and (ds_dept_w IS NOT NULL AND ds_dept_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1049371) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_dept_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_dept_w;
          end if;
        end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_dialysis_schd (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
