-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_generate_surgery (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_content_w varchar(32000);
    ds_main_proc_w varchar(255);
    ds_add_proc_w  varchar(4000);
    ds_side_w       varchar(255);
    ds_est_start_date_w       varchar(255);
    nm_surgeon_w varchar(255);
    nm_anaesth_w  varchar(255);
    ds_anaesth_type_w varchar(255);
    ds_start_date_w  varchar(255);
    ds_end_date_w  varchar(255);
    ds_notes_w     varchar(4000);
    ds_surg_status_w      varchar(4000);
    ds_equipment_w      varchar(4000);
    nm_event_w varchar(255);


    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN
  
select substr(obter_exame_agenda(a.cd_procedimento_princ, a.ie_origem_proced, a.nr_seq_proc_interno),1,240) ,
	 (obter_select_concatenado_bv('select substr(Obter_Desc_Prescr_Proc_J(b.CD_PROCEDIMENTO,b.IE_ORIGEM_PROCED, b.nr_seq_proc_interno),1,240) from PRESCR_PROCEDIMENTO b  where b.nr_prescricao= :nr_prescricao_p','nr_prescricao_p=' || a.nr_prescricao || ';' , ',')),
     substr(obter_valor_dominio(1372,a.IE_LADO),1,255),
     pkg_date_formaters.to_varchar(a.DT_INICIO_PREVISTA, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
     substr(obter_nome_medico(a.CD_MEDICO_CIRURGIAO,'N'),1,200),
	 substr(obter_nome_medico(a.CD_MEDICO_ANESTESISTA,'N'),1,200),
	 substr(obter_valor_dominio(36,a.CD_TIPO_ANESTESIA),1,150),
	 pkg_date_formaters.to_varchar(a.DT_INICIO_REAL, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
	 pkg_date_formaters.to_varchar(a.DT_TERMINO, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
	 a.DS_OBSERVACAO,
     substr(obter_status_cirurgia(IE_STATUS_CIRURGIA),1,200),
     (obter_select_concatenado_bv('select Obter_Desc_Equipamento(CD_EQUIPAMENTO)  from EQUIPAMENTO_CIRURGIA  where nr_cirurgia= :nr_cirurgia_p','nr_cirurgia_p=' || a.nr_cirurgia || ';' , ',')),
     ''
     into STRICT
    ds_main_proc_w,
    ds_add_proc_w,
    ds_side_w,
    ds_est_start_date_w,
    nm_surgeon_w,
    nm_anaesth_w,
    ds_anaesth_type_w,
    ds_start_date_w,
    ds_end_date_w,
    ds_notes_w,
    ds_surg_status_w,
    ds_equipment_w,
    nm_event_w
    from    cirurgia a
    where   nr_cirurgia =nr_sequencia_p;

     for r_c01 in c01 loop
     if (ie_record_type_p = 'SURGERY') then
        if (r_c01.ie_field    = 'MAIN_PROC' and (ds_main_proc_w IS NOT NULL AND ds_main_proc_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_main_proc_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_main_proc_w;
          end if;
        end if;
        if (r_c01.ie_field    = 'ADD_PROC' and (ds_add_proc_w IS NOT NULL AND ds_add_proc_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_add_proc_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_add_proc_w;
          end if;
        end if;
         if (r_c01.ie_field    = 'EST_START_DATE' and (ds_est_start_date_w IS NOT NULL AND ds_est_start_date_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_est_start_date_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_est_start_date_w;
          end if;
        end if;
        if (r_c01.ie_field    = 'SIDE' and (ds_side_w IS NOT NULL AND ds_side_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_side_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_side_w;
          end if;
        end if;
        if (r_c01.ie_field    = 'NM_SURGEON' and (nm_surgeon_w IS NOT NULL AND nm_surgeon_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_surgeon_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_surgeon_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'NM_ANAESTH' and (nm_anaesth_w IS NOT NULL AND nm_anaesth_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_anaesth_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_anaesth_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'ANAESTH_TYPE' and (ds_anaesth_type_w IS NOT NULL AND ds_anaesth_type_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_anaesth_type_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_anaesth_type_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'START_DATE' and (ds_start_date_w IS NOT NULL AND ds_start_date_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_start_date_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_start_date_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'END_DATE' and (ds_end_date_w IS NOT NULL AND ds_end_date_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_end_date_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_end_date_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'DS_NOTES' and (ds_notes_w IS NOT NULL AND ds_notes_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'SURG_STATUS' and (ds_surg_status_w IS NOT NULL AND ds_surg_status_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_surg_status_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_surg_status_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'EQUIPMENT' and (ds_equipment_w IS NOT NULL AND ds_equipment_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_equipment_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_equipment_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'NM_EVENT' and (nm_event_w IS NOT NULL AND nm_event_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1067940) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_event_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_event_w;
          end if;
          end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_generate_surgery (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
