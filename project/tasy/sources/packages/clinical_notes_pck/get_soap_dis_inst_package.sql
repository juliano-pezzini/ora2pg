-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_dis_inst ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_content_w varchar(32000);
   ds_insurance varchar(255);
ds_professional varchar(255);
ds_notes varchar(29000);
ds_edition  varchar(255);
ds_reocrd varchar(255);
ds_orientn_type varchar(255);
ds_period varchar(255);
ds_period_qt varchar(255);

    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN
select (select ds_insurance_name_japanese from nais_insurance where nr_sequencia= a.NR_SEQ_NAIS_INSURANCE) ,
obter_nome_pf(CD_PROFISSIONAL),
SUBSTR(CONVERT_LONG_TO_VARCHAR2('DS_ORIENTACAO', 'ATENDIMENTO_ALTA', ' NR_SEQUENCIA = ' || nr_sequencia_p),1,4000) ,
pkg_date_formaters.to_varchar(a.DT_REGISTRO, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
obter_valor_dominio(9870,IE_TIPO_ORIENTACAO),
obter_valor_dominio(4300,IE_PERIODO),
QT_PERIODO
into STRICT
 ds_insurance ,
ds_professional ,
ds_notes ,
ds_reocrd  ,
ds_orientn_type ,
ds_period ,
ds_period_qt
from ATENDIMENTO_ALTA a
WHERE  nr_sequencia=nr_sequencia_p;
    for r_c01 in c01 loop
    if (ie_record_type_p = 'DSCHRG_INSTR') then
        if (r_c01.ie_field    = 'CD_INSURANCE' and (ds_insurance IS NOT NULL AND ds_insurance::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(294900) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_insurance;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_insurance;
          end if;
        end if;
        if (r_c01.ie_field    = 'CD_PROFESSIONAL' and (ds_professional IS NOT NULL AND ds_professional::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(294900) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_professional;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_professional;
          end if;
        end if;
         if (r_c01.ie_field    = 'DS_NOTES' and (ds_notes IS NOT NULL AND ds_notes::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(294900) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes;
          end if;
        end if;
        if (r_c01.ie_field    = 'DT_REOCRD' and (ds_reocrd IS NOT NULL AND ds_reocrd::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(294900) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_reocrd;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_reocrd;
          end if;
        end if;
        if (r_c01.ie_field   = 'IE_ORIENTN_TYPE' and (ds_orientn_type IS NOT NULL AND ds_orientn_type::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(294900) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_orientn_type;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_orientn_type;
          end if;
        end if;
        if (r_c01.ie_field   = 'IE_PERIOD' and (ds_period IS NOT NULL AND ds_period::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(294900) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_period;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_period;
          end if;
        end if;
        if (r_c01.ie_field   = 'QT_PERIOD' and (ds_period_qt IS NOT NULL AND ds_period_qt::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(294900) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_period_qt;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_period_qt;
          end if;
        end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_dis_inst ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
