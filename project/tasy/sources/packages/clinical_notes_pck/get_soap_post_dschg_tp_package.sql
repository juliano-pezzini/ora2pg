-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_post_dschg_tp (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_content_w    varchar(32000);
    ds_department_w varchar(255);
    ds_ward_w       varchar(255);
    ds_room_w       varchar(255);
    ds_hosp_date_w       varchar(255);
    ds_est_dscrg_date_w  varchar(255);
    ds_post_dschg_plan_w varchar(255);
    ds_notes_w  varchar(255);
    ds_asst_servc_w  varchar(255);
    ds_nursing_w     varchar(255);
    ds_others_w      varchar(255);
    ds_phy_inchg_w varchar(255);
    ds_phy_asstnt_w  varchar(4000);
    ds_nurse_prim_w varchar(255);
    ds_nurse_asstnt_w varchar(4000);
    ds_other_staff_w varchar(4000);

    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));
	
BEGIN

	select substr(OBTER_NOME_DEPARTAMENTO_MEDICO(a.cd_department, 'N'), 1, 255) ,
	substr(OBTER_NOME_setor(a.CD_WARD), 1, 255),
    (select max(cd_unidade_basica)from   unidade_atendimento c,setor_atendimento d where  c.cd_setor_atendimento = d.cd_setor_atendimento and c.cd_setor_atendimento = a.cd_ward and cd_unidade_basica = a.cd_room),
	 pkg_date_formaters.to_varchar(a.DT_HOSPITALIZATION, 'short', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
	 pkg_date_formaters.to_varchar(a.DT_PREVISAO_ALTA, 'short', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
	 substr(a.DS_PLAN_POS_ALTA,1,255),
	 substr(a.DS_NOTAS_POS_ALTA,1,255),
	 substr(a.DS_SERV_SOCIAL_POS_ALT,1,255),
	 substr(a.DS_ENFERMAGEM_POS_ALTA,1,255),
	 substr(a.DS_OBS_POS_ALTA,1,255),
	 (select obter_nome_medico(b.cd_physician, 'N') from MED_TREATMENT_PLAN_TEAM b where NR_SEQ_MED_TREAT_PLAN = a.nr_sequencia  and SI_PERSON_TYPE = 1),
	 (obter_select_concatenado_bv('select obter_nome_medico(c.cd_physician, ' || '''N''' || ') from MED_TREATMENT_PLAN_TEAM c where c.NR_SEQ_MED_TREAT_PLAN = :NR_SEQ_MED_TREAT_PLAN_P  and c.SI_PERSON_TYPE = 2','NR_SEQ_MED_TREAT_PLAN_P=' || a.nr_sequencia || ';' , ',')),
	 (select obter_nome_pf(d.cd_person) from MED_TREATMENT_PLAN_TEAM d where NR_SEQ_MED_TREAT_PLAN = a.nr_sequencia  and SI_PERSON_TYPE = 3), 
	 (obter_select_concatenado_bv('select substr(obter_nome_pf(d.cd_person),1,255) from MED_TREATMENT_PLAN_TEAM d where d.NR_SEQ_MED_TREAT_PLAN = :NR_SEQ_MED_TREAT_PLAN_P  and d.SI_PERSON_TYPE = 4','NR_SEQ_MED_TREAT_PLAN_P=' || a.nr_sequencia || ';' , ',')),
	 (obter_select_concatenado_bv('select substr(obter_nome_pf(e.cd_person),1,255) from MED_TREATMENT_PLAN_TEAM e where e.NR_SEQ_MED_TREAT_PLAN = :NR_SEQ_MED_TREAT_PLAN_P  and e.SI_PERSON_TYPE = 5','NR_SEQ_MED_TREAT_PLAN_P=' || a.nr_sequencia || ';' , ','))
	 into STRICT
	 ds_department_w,
	 ds_ward_w,
	 ds_room_w,
	 ds_hosp_date_w ,
	 ds_est_dscrg_date_w,
	 ds_post_dschg_plan_w,
	 ds_notes_w,
	 ds_asst_servc_w,
	 ds_nursing_w,
	 ds_others_w,
	 ds_phy_inchg_w,
	 ds_phy_asstnt_w,
	 ds_nurse_prim_w,
	 ds_nurse_asstnt_w,
	 ds_other_staff_w
	 from    MED_TREATMENT_PLAN a
	 WHERE     nr_atendimento = nr_atendimento_p   and nr_sequencia=nr_sequencia_p;
    for r_c01 in c01 loop
        if (ie_record_type_p = 'PD_MED_TP') then
        if (r_c01.ie_field    = 'MED_DEPT' and (ds_department_w IS NOT NULL AND ds_department_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_department_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_department_w;
          end if;
        end if;
        if (r_c01.ie_field    = 'CD_WARD' and (ds_ward_w IS NOT NULL AND ds_ward_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_ward_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_ward_w;
          end if;
        end if;
        if (r_c01.ie_field    = 'CD_ROOM' and (ds_room_w IS NOT NULL AND ds_room_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_room_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_room_w;
          end if;
        end if;
        if (r_c01.ie_field    = 'DT_HOSP' and (ds_hosp_date_w IS NOT NULL AND ds_hosp_date_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_hosp_date_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_hosp_date_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_EST_DSCHG' and (ds_est_dscrg_date_w IS NOT NULL AND ds_est_dscrg_date_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_est_dscrg_date_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_est_dscrg_date_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_POSTDSCG_PLN' and (ds_post_dschg_plan_w IS NOT NULL AND ds_post_dschg_plan_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_post_dschg_plan_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_post_dschg_plan_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'DS_NOTES' and (ds_notes_w IS NOT NULL AND ds_notes_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'DS_ASST_SERVC' and (ds_asst_servc_w IS NOT NULL AND ds_asst_servc_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_asst_servc_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_asst_servc_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'DS_NURSING' and (ds_nursing_w IS NOT NULL AND ds_nursing_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_nursing_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_nursing_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'DS_OTHERS' and (ds_others_w IS NOT NULL AND ds_others_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_others_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_others_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'PHYSICIAN_INCHG' and (ds_phy_inchg_w IS NOT NULL AND ds_phy_inchg_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_phy_inchg_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_phy_inchg_w;
          end if;
          end if;
        if (r_c01.ie_field   = 'PHYSICIAN_ASSTN' and (ds_phy_asstnt_w IS NOT NULL AND ds_phy_asstnt_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_phy_asstnt_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_phy_asstnt_w;
          end if;
          end if;
        if (r_c01.ie_field   = 'PRIM_NURSE' and (ds_nurse_prim_w IS NOT NULL AND ds_nurse_prim_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_nurse_prim_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_nurse_prim_w;
          end if;
          end if;
        if (r_c01.ie_field   = 'NURSE_ASSISTNT' and (ds_nurse_asstnt_w IS NOT NULL AND ds_nurse_asstnt_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_nurse_asstnt_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_nurse_asstnt_w;
          end if;
          end if;
        if (r_c01.ie_field   = 'OTH_STAFF' and (ds_other_staff_w IS NOT NULL AND ds_other_staff_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1034271) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_other_staff_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_other_staff_w;
          end if;
        end if;
        end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_post_dschg_tp (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
