-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_transcheck ( nr_atendimento_p evolucao_paciente.NR_ATENDIMENTO%TYPE, nr_sequencia_p clinical_note_soap_data.NR_SEQ_MED_ITEM%TYPE, ie_record_type_p clinical_note_soap_data.IE_MED_REC_TYPE%TYPE, ie_record_sub_type_p clinical_note_soap_data.IE_CPOE_ITEM_TYPE%TYPE, ie_soap_type_p clinical_note_soap_data.IE_SOAP_TYPE%TYPE, ie_stage_p clinical_note_soap_data.IE_STAGE%TYPE, transfusion_json_p HCP_FILE_DATA.DS_FILE_CONTENT%TYPE DEFAULT NULL) RETURNS EVOLUCAO_PACIENTE.DS_EVOLUCAO%TYPE AS $body$
DECLARE

  ds_content_w evolucao_paciente.ds_evolucao%TYPE;
  transfusion_list_w PHILIPS_JSON_LIST;
  transfusion_w PHILIPS_JSON;
  transfusion_err_list_w PHILIPS_JSON_LIST;
  transfusion_err_w PHILIPS_JSON;
  ds_content_pln_w evolucao_paciente.ds_evolucao%TYPE;
  ie_message_w evolucao_paciente.CD_TOPOGRAFIA%TYPE;
  ds_titulo_w evolucao_paciente.DS_JUSTIFICATIVA%TYPE;
  ds_message_w evolucao_paciente.ds_evolucao%TYPE;
  cd_message_sts_w evolucao_paciente.DS_UTC_ATUALIZACAO%TYPE;
  ds_message_sts_w evolucao_paciente.DS_UTC_ATUALIZACAO%TYPE;
  product_name_w SAN_DERIVADO.DS_DERIVADO%TYPE;
  manufacturing_number_w SAN_PRODUCAO.nr_sangue%TYPE;
  clinical_note_fields CURSOR FOR
    SELECT *
    FROM TABLE(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,ie_record_sub_type_p,ie_soap_type_p,ie_stage_p));
BEGIN
  IF ( ie_record_type_p ='TRANS_CHECK') THEN
    transfusion_list_w :=PHILIPS_JSON_LIST(transfusion_json_p);
    FOR i IN 1..transfusion_list_w.COUNT
    LOOP
      ds_content_w           :=NULL;
      transfusion_w          := PHILIPS_JSON(transfusion_list_w.get(i));
      transfusion_err_list_w :=PHILIPS_JSON_LIST(transfusion_w.get('IE_MESSAGE_P'));
      ds_message_w           :=NULL;
      cd_message_sts_w       :=NULL;
      ds_message_sts_w       :=NULL;
      product_name_w         :=NULL;
      manufacturing_number_w :=NULL;
      FOR j IN 1..transfusion_err_list_w.COUNT
      LOOP
        ds_titulo_w       :=NULL;
        transfusion_err_w :=PHILIPS_JSON(transfusion_err_list_w.get(j));
        ie_message_w      :=transfusion_err_w.get['IE_MSG_TYPE_P'].GET_STRING();
        CASE ie_message_w
        WHEN 'SUCCESS' THEN
          cd_message_sts_w := 973575;
        WHEN 'WARNING' THEN
          cd_message_sts_w := 683928;
        WHEN 'ERROR' THEN
          cd_message_sts_w := 289370;
        END CASE;
        IF ( (transfusion_err_w.get('IE_MESSAGE_CD_P') IS NOT NULL AND (transfusion_err_w.get('IE_MESSAGE_CD_P'))::text <> '') AND NOT(transfusion_err_w.get['IE_MESSAGE_CD_P'].is_null() ) ) THEN
          ds_titulo_w := ' : '||obter_desc_expressao(transfusion_err_w.get['IE_MESSAGE_CD_P'].GET_NUMBER());
        END IF;
        ds_message_sts_w :=obter_desc_expressao(cd_message_sts_w);
        ds_message_w     := ds_message_w ||'</br>'|| j ||' : ' ||ds_message_sts_w|| ds_titulo_w;
      END LOOP;
      IF (cd_message_sts_w = 973575 AND (transfusion_w.get('NR_SEQUENCIA_P') IS NOT NULL AND (transfusion_w.get('NR_SEQUENCIA_P'))::text <> '') AND NOT(transfusion_w.get['NR_SEQUENCIA_P'].is_null()) ) THEN
        SELECT MAX(sd.DS_DERIVADO ),
          MAX(sp.nr_sangue)
        INTO STRICT product_name_w,
          manufacturing_number_w
        FROM SAN_PRODUCAO sp,
          SAN_DERIVADO sd
        WHERE sp.NR_SEQ_DERIVADO  = sd.NR_SEQUENCIA
        AND sp.NR_SEQUENCIA = transfusion_w.get['NR_SEQUENCIA_P'].GET_NUMBER();
      elsif ((transfusion_w.get('CD_PRODUTO_P') IS NOT NULL AND (transfusion_w.get('CD_PRODUTO_P'))::text <> '') AND NOT(transfusion_w.get['CD_PRODUTO_P'].is_null()) ) THEN
        SELECT MAX(sd.DS_DERIVADO )
        INTO STRICT product_name_w
        FROM SAN_DERIVADO sd
        WHERE sd.NR_SEQUENCIA=transfusion_w.get['CD_PRODUTO_P'].GET_NUMBER();
      END IF;
      FOR r_clinical_note_fields IN clinical_note_fields
      LOOP
        BEGIN
          IF (r_clinical_note_fields.ie_field = 'DT_VERIFICATION' ) THEN
            BEGIN
              IF ( coalesce(ds_content_w::text, '') = '' ) THEN
                ds_content_w    := '<b>' || obter_desc_expressao(1072887) || '</b>';
                ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| pkg_date_formaters.to_varchar(clock_timestamp(), 'short', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario);
              ELSE
                ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| pkg_date_formaters.to_varchar(clock_timestamp(), 'short', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario);
              END IF;
            END;

          elsIF (r_clinical_note_fields.ie_field = 'DS_USER_EXEC_1' AND (transfusion_w.get('IE_USER_EXEC_1_P') IS NOT NULL AND (transfusion_w.get('IE_USER_EXEC_1_P'))::text <> '') AND NOT(transfusion_w.get['IE_USER_EXEC_1_P'].is_null()) ) THEN
            BEGIN
              IF ( coalesce(ds_content_w::text, '') = '' ) THEN
                ds_content_w    := '<b>' || obter_desc_expressao(1072887) || '</b>';
                ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - ' ||Obter_dados_usuario_opcao(transfusion_w.get['IE_USER_EXEC_1_P'].GET_STRING(),'NP');
              ELSE
                ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '||Obter_dados_usuario_opcao(transfusion_w.get['IE_USER_EXEC_1_P'].GET_STRING(),'NP');
              END IF;
            END;

          elsIF (r_clinical_note_fields.ie_field = 'DS_USER_EXEC_2' AND (transfusion_w.get('IE_USER_EXEC_2_P') IS NOT NULL AND (transfusion_w.get('IE_USER_EXEC_2_P'))::text <> '') AND NOT(transfusion_w.get['IE_USER_EXEC_2_P'].is_null()) ) THEN
            BEGIN
              IF ( coalesce(ds_content_w::text, '') = '' ) THEN
                ds_content_w    := '<b>' || obter_desc_expressao(1072887) || '</b>';
                ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - ' ||Obter_dados_usuario_opcao(transfusion_w.get['IE_USER_EXEC_2_P'].GET_STRING(),'NP');
              ELSE
                ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - ' ||Obter_dados_usuario_opcao(transfusion_w.get['IE_USER_EXEC_2_P'].GET_STRING(),'NP');
              END IF;
            END;

          ELSIF (r_clinical_note_fields.ie_field = 'CD_INSTRUCAO_TR' AND (transfusion_w.get('CD_INSTRUCAO_TRANSF_P') IS NOT NULL AND (transfusion_w.get('CD_INSTRUCAO_TRANSF_P'))::text <> '') AND NOT(transfusion_w.get['CD_INSTRUCAO_TRANSF_P'].is_null()) ) THEN
            BEGIN
              IF ( coalesce(ds_content_w::text, '') = '' ) THEN
                ds_content_w    := '<b>' || obter_desc_expressao(1072887) || '</b>';
                ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| transfusion_w.get['CD_INSTRUCAO_TRANSF_P'].value_of();
              ELSE
                ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| transfusion_w.get['CD_INSTRUCAO_TRANSF_P'].value_of();
              END IF;
            END;

          ELSIF (r_clinical_note_fields.ie_field = 'NR_FABRICACAO' AND (transfusion_w.get('NR_FABRICACAO_P') IS NOT NULL AND (transfusion_w.get('NR_FABRICACAO_P'))::text <> '') AND NOT(transfusion_w.get['NR_FABRICACAO_P'].is_null()) ) THEN
            BEGIN
              IF ( coalesce(ds_content_w::text, '') = '' ) THEN
                ds_content_w    := '<b>' || obter_desc_expressao(1072887) || '</b>';
                ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| COALESCE(manufacturing_number_w,transfusion_w.get['NR_FABRICACAO_P'].value_of());
              ELSE
                ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| COALESCE(manufacturing_number_w,transfusion_w.get['NR_FABRICACAO_P'].value_of());
              END IF;
            END;

          ELSIF (r_clinical_note_fields.ie_field = 'PRODUCT_NAME' AND (product_name_w IS NOT NULL AND product_name_w::text <> '') ) THEN
            BEGIN
              IF ( coalesce(ds_content_w::text, '') = '' ) THEN
                ds_content_w    := '<b>' || obter_desc_expressao(1072887) || '</b>';
                ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| product_name_w;
              ELSE
                ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| product_name_w;
              END IF;
            END;

          ELSIF (r_clinical_note_fields.ie_field = 'DS_VERF_RLT' AND (ds_message_sts_w IS NOT NULL AND ds_message_sts_w::text <> '') ) THEN
            BEGIN
              IF ( coalesce(ds_content_w::text, '') = '' ) THEN
                ds_content_w    := '<b>' || obter_desc_expressao(1072887) || '</b>';
                ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| ds_message_sts_w;
              ELSE
                ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '|| ds_message_sts_w;
              END IF;
            END;

          ELSIF (r_clinical_note_fields.ie_field = 'DS_MSG_CONT' AND (ds_message_w IS NOT NULL AND ds_message_w::text <> '')) THEN
            BEGIN
              IF ( coalesce(ds_content_w::text, '') = '' ) THEN
                ds_content_w    := '<b>' || obter_desc_expressao(1072887) || '</b>';
                ds_content_w    := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '||ds_message_w;
              ELSE
                ds_content_w := ds_content_w|| '</br>' || coalesce(r_clinical_note_fields.nm_field,r_clinical_note_fields.ds_expressao) || ' - '||ds_message_w;
              END IF;
            END;
          END IF;
        END;
      END LOOP;
      IF (coalesce(ds_content_pln_w::text, '') = '') THEN
        ds_content_pln_w  :=ds_content_w;
      ELSE
        ds_content_pln_w :=ds_content_pln_w||'</br>'||'</br>'|| ds_content_w;
      END IF;
    END LOOP;
  END IF;
  RETURN ds_content_pln_w;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_transcheck ( nr_atendimento_p evolucao_paciente.NR_ATENDIMENTO%TYPE, nr_sequencia_p clinical_note_soap_data.NR_SEQ_MED_ITEM%TYPE, ie_record_type_p clinical_note_soap_data.IE_MED_REC_TYPE%TYPE, ie_record_sub_type_p clinical_note_soap_data.IE_CPOE_ITEM_TYPE%TYPE, ie_soap_type_p clinical_note_soap_data.IE_SOAP_TYPE%TYPE, ie_stage_p clinical_note_soap_data.IE_STAGE%TYPE, transfusion_json_p HCP_FILE_DATA.DS_FILE_CONTENT%TYPE DEFAULT NULL) FROM PUBLIC;
