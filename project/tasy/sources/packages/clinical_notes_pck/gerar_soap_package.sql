-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE clinical_notes_pck.gerar_soap ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_record_sub_type_p text, ie_soap_type_p text, ie_stage_p bigint, cd_evolucao_p INOUT bigint, ie_option_p text DEFAULT NULL, cd_pessoa_fisica_p text DEFAULT NULL, nm_table_p text DEFAULT NULL, dt_exam_exec_p timestamp DEFAULT NULL, ds_proc_exame_p text DEFAULT NULL, ds_proc_dep_p text DEFAULT NULL, cd_exam_type_p text DEFAULT NULL, ds_comments_p text DEFAULT NULL, cd_body_part_p text DEFAULT NULL, transfusion_json_p HCP_FILE_DATA.DS_FILE_CONTENT%TYPE DEFAULT NULL) AS $body$
DECLARE


        nr_seq_text_soap_w         parametro_medico.nr_seq_text_soap%TYPE;
        ds_content_sub_w           evolucao_paciente.ds_evolucao%TYPE;
        ds_content_obj_w           evolucao_paciente.ds_evolucao%TYPE;
        ds_content_asmnt_w         evolucao_paciente.ds_evolucao%TYPE;
        ds_content_pln_w           evolucao_paciente.ds_evolucao%TYPE;
		ds_content_sub_free_w      evolucao_paciente.ds_evolucao%TYPE;
        ds_content_obj_free_w      evolucao_paciente.ds_evolucao%TYPE;
        ds_content_asmnt_free_w    evolucao_paciente.ds_evolucao%TYPE;
        ds_content_pln_free_w      evolucao_paciente.ds_evolucao%TYPE;
		ds_content_soap_free_w     evolucao_paciente.ds_evolucao%TYPE;
        ds_content_w               varchar(32000);
        ds_content_new_w           evolucao_paciente.ds_evolucao%TYPE;
        ds_standard_text_w         varchar(32000);
        ie_evolucao_clinica_pr_w   evolucao_paciente.ie_evolucao_clinica%TYPE;
        ie_evolucao_clinica_fc_w   evolucao_paciente.ie_evolucao_clinica%TYPE;
        ie_tipo_evolucao_w         usuario.ie_tipo_evolucao%TYPE;
        cd_evolucao_w              evolucao_paciente.cd_evolucao%TYPE;
        ie_evolucao_exists         varchar(1) := 'N';
		c01 CURSOR FOR
		SELECT * FROM clinical_note_soap_data
		WHERE cd_evolucao = cd_evolucao_w
		order by nr_sequencia;


BEGIN
        SELECT MAX(ie_tipo_evolucao)
        INTO STRICT ie_tipo_evolucao_w
        FROM usuario
        WHERE nm_usuario = wheb_usuario_pck.get_nm_usuario;

        IF ( coalesce(ie_tipo_evolucao_w::text, '') = '' ) THEN
      /* Evolution type not reported for this user. */

            CALL wheb_mensagem_pck.exibir_mensagem_abort(264634);
        END IF;
        SELECT MAX(cd_tipo_evolucao)
        INTO STRICT ie_evolucao_clinica_pr_w
        FROM tipo_evolucao
        WHERE ie_progress_record = 'S'
        AND ie_situacao = 'A';

        SELECT MAX(cd_tipo_evolucao)
        INTO STRICT ie_evolucao_clinica_fc_w
        FROM tipo_evolucao
        WHERE ie_first_consultation = 'S'
        AND ie_situacao = 'A';

        SELECT nr_seq_text_soap
        INTO STRICT nr_seq_text_soap_w
        FROM parametro_medico
        WHERE cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

        IF (nr_seq_text_soap_w IS NOT NULL AND nr_seq_text_soap_w::text <> '') THEN
            SELECT ds_texto
            INTO STRICT ds_standard_text_w
            FROM texto_padrao
            WHERE nr_sequencia = nr_seq_text_soap_w;
        ELSE
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1161372);
        END IF;

        IF ( clinical_notes_pck.is_active_decease_exists(obter_pessoa_atendimento(nr_atendimento_p, 'C')) = 'S' AND coalesce(ie_evolucao_clinica_pr_w::text, '') = '') THEN
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1049915);
        END IF;

        IF ( clinical_notes_pck.is_active_decease_exists(obter_pessoa_atendimento(nr_atendimento_p, 'C')) = 'N' AND coalesce(ie_evolucao_clinica_fc_w::text, '') = '') THEN
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1161373);
        END IF;

        SELECT CASE WHEN COUNT(*)=0 THEN  'N'  ELSE 'S' END
        INTO STRICT ie_evolucao_exists
        FROM  evolucao_paciente
        WHERE cd_pessoa_fisica = coalesce(obter_pessoa_atendimento(nr_atendimento_p, 'C'), cd_pessoa_fisica_p)
        AND coalesce(dt_liberacao::text, '') = '' AND ie_situacao = 'A'
        AND ( ie_evolucao_clinica = ie_evolucao_clinica_fc_w OR ie_evolucao_clinica = ie_evolucao_clinica_pr_w )
		AND nm_usuario = wheb_usuario_pck.get_nm_usuario
		AND coalesce(ie_record_type_p,'') != 'TRANS_CHECK';

        IF ( ie_evolucao_exists = 'S' ) THEN
            SELECT MAX(cd_evolucao)
            INTO STRICT cd_evolucao_w
            FROM evolucao_paciente
            WHERE cd_pessoa_fisica = coalesce(obter_pessoa_atendimento(nr_atendimento_p, 'C'), cd_pessoa_fisica_p)
            AND coalesce(dt_liberacao::text, '') = '' AND ie_situacao = 'A'
            AND ( ie_evolucao_clinica = ie_evolucao_clinica_fc_w OR ie_evolucao_clinica = ie_evolucao_clinica_pr_w )
			AND nm_usuario = wheb_usuario_pck.get_nm_usuario;
        END IF;
        IF (ds_standard_text_w IS NOT NULL AND ds_standard_text_w::text <> '') THEN
            IF (cd_evolucao_w IS NOT NULL AND cd_evolucao_w::text <> '') THEN
                FOR r_c01 IN c01 LOOP
                    IF ( r_c01.ie_med_rec_type = 'DIAGNOSIS' OR r_c01.ie_med_rec_type = 'PROBLEM' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
                        ds_content_asmnt_w := ds_content_asmnt_w || '</br>' || ds_content_w || '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'CPOE_ITEMS' AND r_c01.ie_stage = 1 ) THEN
						ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type,  r_c01.ie_cpoe_item_type, r_c01.ie_soap_type,r_c01.ie_stage,r_c01.ie_option, 1);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'CPOE_ITEMS' AND r_c01.ie_stage = 2 ) THEN
						ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, r_c01.ie_cpoe_item_type, r_c01.ie_soap_type,r_c01.ie_stage, r_c01.ie_option);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'INPATIENT' ) THEN
						ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'DISCHARGE' ) THEN
						ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'DEPT_TRANSFER' ) THEN
						ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage,r_c01.cd_exp_title);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'WARD_TRANSFER' ) THEN
						ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'BED_TRANSFER' ) THEN
						ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'TEMP_LEAVE' ) THEN
						ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage,r_c01.ie_option, NULL, NULL, NULL, NULL, NULL, NULL, NULL, ie_option_p);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'CLNICAL_PATHWAY' ) THEN
						ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'MED_CERT' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'CONSENT' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'MED_GUIDANCE' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'DPC' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'DSCHRG_INSTR' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'CARE_PLAN' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'SURGERY' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'INTERNAL_REF' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage,r_c01.ie_option);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'BED_RQST' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'MED_DSCHG_REQ' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'EMERG_SERV_CONS' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'CONS_SCHD' OR r_c01.ie_med_rec_type = 'EXAM_SCHD' or r_c01.ie_med_rec_type = 'SRVC_SCHD') THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'GNRL_INSTRCT' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'DIALYSIS_SCHD' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'SURG_ACHIEVE' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'IP_MED_TP' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
                    ELSIF ( r_c01.ie_med_rec_type = 'PD_MED_TP' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w || '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'EXT_REFERRAL' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, r_c01.ie_cpoe_item_type, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w|| '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'REHAB' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, r_c01.ie_cpoe_item_type, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w|| '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'NUT_GUIDANCE' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, r_c01.ie_cpoe_item_type, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_asmnt_w := ds_content_asmnt_w || '</br>' || ds_content_w|| '</br>';
					ELSIF ( r_c01.ie_med_rec_type = 'PHYSIOLOGY' ) THEN
						ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage, NULL, 1, dt_exam_exec_p, ds_proc_exame_p, ds_proc_dep_p);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
					ELSIF ( r_c01.ie_med_rec_type = 'RADIOLOGY' ) THEN
						ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, NULL, r_c01.ie_soap_type,r_c01.ie_stage, NULL, 1, dt_exam_exec_p, ds_proc_exame_p, NULL, cd_exam_type_p, ds_comments_p, cd_body_part_p);
						ds_content_pln_w := ds_content_pln_w || '</br>' || ds_content_w;
                    ELSIF ( r_c01.ie_med_rec_type = 'NURSE_CARE_NEED' ) THEN
                        ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, r_c01.nr_seq_med_item, r_c01.ie_med_rec_type, r_c01.ie_cpoe_item_type, r_c01.ie_soap_type,r_c01.ie_stage);
						ds_content_obj_w := ds_content_obj_w || '</br>' || ds_content_w|| '</br>';
                    END IF;
                END LOOP;
			select max(txt_soap_subjective),
            max(txt_soap_objective),
            max(txt_soap_assessment),
            max(txt_soap_plan),
            max(txt_soap_free)
            into STRICT ds_content_sub_free_w,
            ds_content_obj_free_w,
            ds_content_asmnt_free_w,
            ds_content_pln_free_w,
            ds_content_soap_free_w
            from evolucao_paciente_compl
            where nr_seq_evo_paciente = cd_evolucao_w;
            END IF;

            IF ( ie_record_type_p = 'DIAGNOSIS' OR ie_record_type_p = 'PROBLEM' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'CPOE_ITEMS' AND ie_stage_p = 1 ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, ie_record_sub_type_p, ie_soap_type_p,ie_stage_p,ie_option_p, 1);
            ELSIF ( ie_record_type_p = 'CPOE_ITEMS' AND ie_stage_p = 2 ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, ie_record_sub_type_p, ie_soap_type_p,ie_stage_p, ie_option_p);
            ELSIF ( ie_record_type_p = 'INPATIENT' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'DISCHARGE' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'DEPT_TRANSFER' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p,nm_table_p);
            ELSIF ( ie_record_type_p = 'WARD_TRANSFER' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'BED_TRANSFER' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'TEMP_LEAVE' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p,ie_option_p, NULL, NULL, NULL, NULL, NULL, NULL, NULL, ie_option_p);
            ELSIF ( ie_record_type_p = 'CLNICAL_PATHWAY' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'MED_CERT' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'CONSENT' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'MED_GUIDANCE' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'DPC' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'DSCHRG_INSTR' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'CARE_PLAN' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'SURGERY' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'INTERNAL_REF' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p,ie_option_p);
            ELSIF ( ie_record_type_p = 'BED_RQST' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'MED_DSCHG_REQ' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'EMERG_SERV_CONS' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'CONS_SCHD' OR ie_record_type_p = 'EXAM_SCHD' or ie_record_type_p = 'SRVC_SCHD' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'GNRL_INSTRCT' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'DIALYSIS_SCHD' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF ( ie_record_type_p = 'SURG_ACHIEVE' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
			ELSIF (ie_record_type_p = 'IP_MED_TP' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
            ELSIF (ie_record_type_p = 'PD_MED_TP' ) THEN
                ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p, nr_sequencia_p, ie_record_type_p, NULL, ie_soap_type_p,ie_stage_p);
			ELSIF (ie_record_type_p = 'EXT_REFERRAL') THEN
				ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p,nr_sequencia_p,ie_record_type_p,ie_record_sub_type_p,ie_soap_type_p,ie_stage_p);
			ELSIF (ie_record_type_p = 'REHAB') THEN
				ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p,nr_sequencia_p,ie_record_type_p,ie_record_sub_type_p,ie_soap_type_p,ie_stage_p);
			ELSIF (ie_record_type_p = 'NUT_GUIDANCE') THEN
				ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p,nr_sequencia_p,ie_record_type_p,ie_record_sub_type_p,ie_soap_type_p,ie_stage_p);
            ELSIF (ie_record_type_p = 'NURSE_CARE_NEED') THEN
				ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p,nr_sequencia_p,ie_record_type_p,ie_record_sub_type_p,ie_soap_type_p,ie_stage_p);
			ELSIF (ie_record_type_p = 'PHYSIOLOGY') then
				ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p,nr_sequencia_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p, NULL, 1, dt_exam_exec_p, ds_proc_exame_p, ds_proc_dep_p);
			ELSIF (ie_record_type_p = 'TRANS_CHECK') then
				
				ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p,nr_sequencia_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p, null,NULL, null,null,null,null,null,null,null,transfusion_json_p );
			ELSIF (ie_record_type_p = 'RADIOLOGY') then
				ds_content_w := clinical_notes_pck.get_soap_content(nr_atendimento_p,nr_sequencia_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p, NULL, 1, dt_exam_exec_p, ds_proc_exame_p, NULL, cd_exam_type_p, ds_comments_p, cd_body_part_p);
            END IF;

            IF ( ie_soap_type_p = 'S' ) THEN
                ds_content_sub_w := ds_content_sub_w|| '</br>'|| ds_content_w;
            ELSIF ( ie_soap_type_p = 'O' ) THEN
                ds_content_obj_w := ds_content_obj_w|| '</br>'|| ds_content_w;
            ELSIF ( ie_soap_type_p = 'A' ) THEN
                ds_content_asmnt_w := ds_content_asmnt_w|| '</br>'|| ds_content_w;
            ELSIF ( ie_soap_type_p = 'P' ) THEN
                ds_content_pln_w := ds_content_pln_w|| '</br>'|| ds_content_w;
            END IF;
			IF (ds_content_pln_free_w IS NOT NULL AND ds_content_pln_free_w::text <> '') THEN
                ds_content_new_w := replace_macro(ds_standard_text_w, '@pln_free', ds_content_pln_free_w);
            ELSE
                ds_content_new_w := replace_macro(ds_standard_text_w, '@pln_free', ' ');
            END IF;

			IF (ds_content_soap_free_w IS NOT NULL AND ds_content_soap_free_w::text <> '') THEN
                ds_content_new_w := replace_macro(ds_content_new_w, '@soap_free', ds_content_soap_free_w);
            ELSE
                ds_content_new_w := replace_macro(ds_content_new_w, '@soap_free', ' ');
            END IF;

            IF (ds_content_obj_free_w IS NOT NULL AND ds_content_obj_free_w::text <> '') THEN
                ds_content_new_w := replace_macro(ds_content_new_w, '@obj_free', ds_content_obj_free_w);
            ELSE
                ds_content_new_w := replace_macro(ds_content_new_w, '@obj_free', ' ');
            END IF;

            IF (ds_content_sub_free_w IS NOT NULL AND ds_content_sub_free_w::text <> '') THEN
                ds_content_new_w := replace_macro(ds_content_new_w, '@subj_free', ds_content_sub_free_w);
            ELSE
                ds_content_new_w := replace_macro(ds_content_new_w, '@subj_free', ' ');
            END IF;

            IF (ds_content_asmnt_free_w IS NOT NULL AND ds_content_asmnt_free_w::text <> '') THEN
                ds_content_new_w := replace_macro(ds_content_new_w, '@asmnt_free', ds_content_asmnt_free_w);
            ELSE
                ds_content_new_w := replace_macro(ds_content_new_w, '@asmnt_free', ' ');
            END IF;
            IF (ds_content_pln_w IS NOT NULL AND ds_content_pln_w::text <> '') THEN
                ds_content_new_w := replace_macro(ds_content_new_w, '@Plan', ds_content_pln_w);
            ELSE
                ds_content_new_w := replace_macro(ds_content_new_w, '@Plan', ' ');
            END IF;

            IF (ds_content_obj_w IS NOT NULL AND ds_content_obj_w::text <> '') THEN
                ds_content_new_w := replace_macro(ds_content_new_w, '@Objective', ds_content_obj_w);
            ELSE
                ds_content_new_w := replace_macro(ds_content_new_w, '@Objective', ' ');
            END IF;

            IF (ds_content_sub_w IS NOT NULL AND ds_content_sub_w::text <> '') THEN
                ds_content_new_w := replace_macro(ds_content_new_w, '@Subjective', ds_content_sub_w);
            ELSE
                ds_content_new_w := replace_macro(ds_content_new_w, '@Subjective', ' ');
            END IF;

            IF (ds_content_asmnt_w IS NOT NULL AND ds_content_asmnt_w::text <> '') THEN
                ds_content_new_w := replace_macro(ds_content_new_w, '@Assessment', ds_content_asmnt_w);
            ELSE
                ds_content_new_w := replace_macro(ds_content_new_w, '@Assessment', ' ');
            END IF;

        END IF;

        IF ( (ds_content_new_w IS NOT NULL AND ds_content_new_w::text <> '') AND coalesce(cd_evolucao_w::text, '') = '' ) THEN
            INSERT INTO evolucao_paciente(
                cd_evolucao,
                dt_evolucao,
                ie_tipo_evolucao,
                cd_pessoa_fisica,
                dt_atualizacao,
                nm_usuario,
                nr_atendimento,
                ds_evolucao,
                cd_medico,
                dt_liberacao,
                ie_evolucao_clinica,
                cd_setor_atendimento,
                ie_situacao
            ) VALUES (
                nextval('evolucao_paciente_seq'),
                clock_timestamp(),
                ie_tipo_evolucao_w,
                coalesce(obter_pessoa_atendimento(nr_atendimento_p, 'C'), cd_pessoa_fisica_p),
                clock_timestamp(),
                wheb_usuario_pck.get_nm_usuario,
                nr_atendimento_p,
                ds_content_new_w,
                obter_pf_usuario(wheb_usuario_pck.get_nm_usuario, 'C'),
                null,
                CASE WHEN clinical_notes_pck.is_active_decease_exists(obter_pessoa_atendimento(nr_atendimento_p, 'C'))='S' THEN  ie_evolucao_clinica_pr_w WHEN clinical_notes_pck.is_active_decease_exists(obter_pessoa_atendimento(nr_atendimento_p, 'C'))='N' THEN  ie_evolucao_clinica_fc_w END ,
                Obter_Setor_Atendimento(nr_atendimento_p),
                'A'
            ) RETURNING cd_evolucao INTO cd_evolucao_w;

        ELSE
            UPDATE evolucao_paciente
            SET
                ds_evolucao = ds_content_new_w,
                dt_atualizacao = clock_timestamp(),
                nm_usuario = wheb_usuario_pck.get_nm_usuario,
                dt_atualizacao_nrec = clock_timestamp(),
                nm_usuario_nrec = wheb_usuario_pck.get_nm_usuario
            WHERE
                cd_evolucao = cd_evolucao_w;

        END IF;

        INSERT INTO clinical_note_soap_data(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            cd_evolucao,
            ie_med_rec_type,
            ie_cpoe_item_type,
            ie_stage,
            ie_soap_type,
            nr_seq_med_item,
            ie_option
        ) VALUES (
            nextval('clinical_note_soap_data_seq'),
            clock_timestamp(),
            wheb_usuario_pck.get_nm_usuario,
            clock_timestamp(),
            wheb_usuario_pck.get_nm_usuario,
            cd_evolucao_w,
            ie_record_type_p,
            ie_record_sub_type_p,
            ie_stage_p,
            ie_soap_type_p,
            nr_sequencia_p,
            ie_option_p
        );

        cd_evolucao_p := cd_evolucao_w;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE clinical_notes_pck.gerar_soap ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_record_sub_type_p text, ie_soap_type_p text, ie_stage_p bigint, cd_evolucao_p INOUT bigint, ie_option_p text DEFAULT NULL, cd_pessoa_fisica_p text DEFAULT NULL, nm_table_p text DEFAULT NULL, dt_exam_exec_p timestamp DEFAULT NULL, ds_proc_exame_p text DEFAULT NULL, ds_proc_dep_p text DEFAULT NULL, cd_exam_type_p text DEFAULT NULL, ds_comments_p text DEFAULT NULL, cd_body_part_p text DEFAULT NULL, transfusion_json_p HCP_FILE_DATA.DS_FILE_CONTENT%TYPE DEFAULT NULL) FROM PUBLIC;
