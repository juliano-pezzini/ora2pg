-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_clinical_note_rule ( nr_atendimento_p bigint, ie_record_type_p text, ie_record_sub_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS SETOF T_CLINICAL_NOTE_RULE AS $body$
DECLARE

    r_rule_row_w t_clinical_note_rule_row;
    c01 CURSOR FOR
      SELECT distinct z.ie_field,
        z.nm_field,
        z.nr_seq_display,
        z.ds_expressao,
        z.ie_med_rec_type,
        z.ie_cpoe_item_type,
        z.ie_stage
      from (SELECT a.nr_sequencia,
          b.ie_field,
          b.nm_field,
          coalesce(b.nr_seq_display,0) nr_seq_display,
          get_clinical_note_field_desc(b.ie_field, a.ie_med_rec_type, a.ie_cpoe_item_type, a.ie_stage)ds_expressao,
          a.ie_med_rec_type,
          a.ie_cpoe_item_type,
          a.ie_stage
        from clinical_note_settings a ,
          clinical_note_fields b
        where a.nr_sequencia                                                 = b.nr_seq_settings
        and a.ie_situacao                                                    = 'A'
        and a.ie_med_rec_type                                                = ie_record_type_p
        and (coalesce(a.IE_CPOE_ITEM_TYPE::text, '') = '' or a.IE_CPOE_ITEM_TYPE    = ie_record_sub_type_p)
        and a.ie_soap_type                                                     = ie_soap_type_p
        and a.ie_stage                                                         = ie_stage_p
        and clinical_notes_pck.get_clinical_notes_permission(a.nr_sequencia, nr_atendimento_p) = 'S'
        and a.ie_data_type = 'CLINICAL_NOTE'
        and b.ie_copy_field = 'S'
        and a.ie_default_rule ='S'
        order by a.ie_med_rec_type ,
          a.ie_cpoe_item_type,
          a.ie_stage,
          coalesce(b.nr_seq_display,0)
        ) z order by  z.nr_seq_display;

BEGIN
    for r_c01 in c01
    loop
      begin
        r_rule_row_w.ie_field          := r_c01.ie_field;
        r_rule_row_w.nm_field          := r_c01.nm_field;
        r_rule_row_w.ds_expressao      := r_c01.ds_expressao;
        r_rule_row_w.ie_med_rec_type   := r_c01.ie_med_rec_type;
        r_rule_row_w.ie_cpoe_item_type := r_c01.ie_cpoe_item_type;
        r_rule_row_w.ie_stage          := r_c01.ie_stage;
        RETURN NEXT r_rule_row_w;
      end;
    end loop;
    return;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_clinical_note_rule ( nr_atendimento_p bigint, ie_record_type_p text, ie_record_sub_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
