-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_surg_achieve (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

	ds_content_w varchar(32000);
    dt_record_w varchar(255);
    dt_surgery_w varchar(255);
    ds_ext_assmnt_w varchar(255);
	nm_anaesthetist_w varchar(255);
    nm_surgeon_w varchar(255);
    ds_procedimento_w varchar(255);
	ds_stat_approv_w varchar(255);
	ds_profession_w varchar(255);
    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN
    select
	dt_avaliacao,
	dt_cirurgia,
	nr_aval_clinica_externa,
	(select nm_pessoa_fisica from pessoa_fisica where cd_pessoa_fisica =cd_avaliador),
	(select nm_guerra from medico where cd_pessoa_fisica =cd_medico),
	substr(coalesce(Obter_Desc_Proc_Interno(nr_seq_proc_interno),obter_exame_agenda(cd_procedimento, ie_origem_proced, nr_seq_proc_interno)),1,150),
	obter_status_aprovacao_doc('AVAL_PRE_ANESTESICA', nr_sequencia),
	substr(obter_cargo_pf(CD_AVALIADOR, 'D'), 1, 255)
	into STRICT
	dt_record_w,
	dt_surgery_w,
	ds_ext_assmnt_w,
	nm_anaesthetist_w,
	nm_surgeon_w,
	ds_procedimento_w,
	ds_stat_approv_w,
	ds_profession_w
	from aval_pre_anestesica
	where nr_sequencia = nr_sequencia_p;
    for r_c01 in c01
    loop
      if (ie_record_type_p = 'SURG_ACHIEVE' )then
        if (r_c01.ie_field    = 'DT_RECORD' and (dt_record_w IS NOT NULL AND dt_record_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(1042363) || '</b>';
            ds_content_w    := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_record_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_record_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_SURGERY' and (dt_surgery_w IS NOT NULL AND dt_surgery_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1042363) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_surgery_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_surgery_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_EXT_ASSMNT' and (ds_ext_assmnt_w IS NOT NULL AND ds_ext_assmnt_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1042363) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_ext_assmnt_w;
          else
            ds_content_w := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_ext_assmnt_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'NM_ANAESTHETIST' and (nm_anaesthetist_w IS NOT NULL AND nm_anaesthetist_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1042363) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_anaesthetist_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_anaesthetist_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'NM_SURGEON' and (nm_surgeon_w IS NOT NULL AND nm_surgeon_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1042363) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_surgeon_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_surgeon_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_PROCEDIMENTO' and (ds_procedimento_w IS NOT NULL AND ds_procedimento_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1042363) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_procedimento_w;
          else
            ds_content_w := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_procedimento_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_STAT_APPROV' and (ds_stat_approv_w IS NOT NULL AND ds_stat_approv_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1042363) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_stat_approv_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_stat_approv_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_PROFESSION' and (ds_profession_w IS NOT NULL AND ds_profession_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(1042363) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_profession_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_profession_w;
          end if;
        end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_surg_achieve (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
