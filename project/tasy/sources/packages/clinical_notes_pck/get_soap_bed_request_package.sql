-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_bed_request (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_content_w varchar(32000);
    bed_inf_w varchar(255);
    bed_type_w varchar(255);
	cd_pre_hosp_hom_w varchar(255);
    cd_ward_w varchar(255);
    ds_notes_w varchar(255);
    dt_estimated_w varchar(255);
    dt_request_w varchar(255);
    ie_hosp_rote_w varchar(255);
    ie_shift_w varchar(255);
    is_cons_med_gdn_w varchar(255);
    med_dept_w varchar(255);
    nm_insurance_w varchar(255);
    request_type_w varchar(255);
    ds_main_diag_w varchar(255);
    ds_professional_w varchar(4000);
    ds_accomodation_w varchar(255);
    ds_reason_trnfr_w varchar(255);
    ds_status_w varchar(255);
    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));

BEGIN
    begin
    select
    a.cd_unidade_basica || '-' || a.cd_unidade_compl ,
	obter_valor_dominio(1410,a.ie_tipo_vaga ) ,
	obter_valor_dominio(9889,a.cd_pre_hosp_home ) ,
	(select ds_setor_atendimento from setor_atendimento where cd_setor_atendimento= a.cd_setor_desejado) ,
	a.ds_observacao ,
	pkg_date_formaters.to_varchar(a.dt_prevista, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) ,
    pkg_date_formaters.to_varchar(a.dt_solicitacao, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
	obter_valor_dominio(9729,a.cd_hospitalization_route ) ,
    substr(OBTER_DESC_CAMPO_GRID(337982, a.ds_shift),1,255),
	substr(OBTER_DESC_CAMPO_GRID(336203, a.si_cons_med_guid),1,255),
	(select DS_DEPARTAMENTO from DEPARTAMENTO_MEDICO where cd_departamento= a.CD_DEPARTAMENTO_DESEJADO) ,
	(select ds_convenio from convenio where cd_convenio= a.cd_convenio) ,
	obter_valor_dominio(1407,a.ie_solicitacao ),
    obter_desc_cid(CD_CID_PRINCIPAL),
    substr(obter_lista_prof_str(nr_sequencia),1,4000),
    (select max(DS_TIPO_ACOMODACAO) from TIPO_ACOMODACAO where CD_TIPO_ACOMODACAO = a.CD_TIPO_ACOMOD_DESEJ ),
    (select max(ds_motivo) from motivo_transf_pac where nr_sequencia = a.NR_SEQ_MOTIVO_TRANSF),
    substr(obter_desc_status_gv(IE_STATUS,'D'),1,100)
    into STRICT
    bed_inf_w,
    bed_type_w,
	cd_pre_hosp_hom_w,
    cd_ward_w,
    ds_notes_w,
    dt_estimated_w,
    dt_request_w,
    ie_hosp_rote_w,
    ie_shift_w,
	is_cons_med_gdn_w,
	med_dept_w,
	nm_insurance_w,
	request_type_w,
    ds_main_diag_w,
    ds_professional_w,
    ds_accomodation_w,
    ds_reason_trnfr_w,
    ds_status_w
from gestao_vaga a
where a.nr_sequencia = nr_sequencia_p;
exception when no_data_found then
    bed_inf_w := null;
    bed_type_w := null;
    cd_pre_hosp_hom_w := null;
    cd_ward_w := null;
    ds_notes_w := null;
    dt_estimated_w := null;
    dt_request_w := null;
    ie_hosp_rote_w := null;
    ie_shift_w := null;
    is_cons_med_gdn_w := null;
    med_dept_w := null;
    nm_insurance_w := null;
    request_type_w := null;
    ds_main_diag_w := null;
    ds_professional_w := null;
    ds_accomodation_w := null;
    ds_reason_trnfr_w := null;
    ds_status_w := null;
end;
    for r_c01 in c01
    loop
      if (ie_record_type_p = 'BED_RQST')then
        if (r_c01.ie_field    = 'BED_INF' and (bed_inf_w IS NOT NULL AND bed_inf_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w    := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| bed_inf_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| bed_inf_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'BED_TYPE' and (bed_type_w IS NOT NULL AND bed_type_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| bed_type_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| bed_type_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_PRE_HOSP_HOM' and (cd_pre_hosp_hom_w IS NOT NULL AND cd_pre_hosp_hom_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| cd_pre_hosp_hom_w;
          else
            ds_content_w := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| cd_pre_hosp_hom_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_WARD' and (cd_ward_w IS NOT NULL AND cd_ward_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| cd_ward_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| cd_ward_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_NOTES' and (ds_notes_w IS NOT NULL AND ds_notes_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_ESTIMATED' and (dt_estimated_w IS NOT NULL AND dt_estimated_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_estimated_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_estimated_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_REQUEST' and (dt_request_w IS NOT NULL AND dt_request_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_request_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| dt_request_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'IE_HOSP_ROTE' and (ie_hosp_rote_w IS NOT NULL AND ie_hosp_rote_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ie_hosp_rote_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ie_hosp_rote_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'IE_SHIFT' and (ie_shift_w IS NOT NULL AND ie_shift_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ie_shift_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ie_shift_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'IS_CONS_MED_GDN' and (is_cons_med_gdn_w IS NOT NULL AND is_cons_med_gdn_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| is_cons_med_gdn_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| is_cons_med_gdn_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'MED_DEPT' and (med_dept_w IS NOT NULL AND med_dept_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| med_dept_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| med_dept_w;
          end if;
        end if;
		if (r_c01.ie_field   = 'NM_INSURANCE' and (nm_insurance_w IS NOT NULL AND nm_insurance_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_insurance_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_insurance_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'REQUEST_TYPE' and (request_type_w IS NOT NULL AND request_type_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| request_type_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| request_type_w;
          end if;
        end if;
        if (r_c01.ie_field    = 'DS_MAIN_DIAG' and (ds_main_diag_w IS NOT NULL AND ds_main_diag_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w    := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_main_diag_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_main_diag_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_PROFESSIONAL' and (ds_professional_w IS NOT NULL AND ds_professional_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_professional_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_professional_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_ACCOMODATION' and (ds_accomodation_w IS NOT NULL AND ds_accomodation_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_accomodation_w;
          else
            ds_content_w := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_accomodation_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_REASON_TRNFR' and (ds_reason_trnfr_w IS NOT NULL AND ds_reason_trnfr_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_reason_trnfr_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_reason_trnfr_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_STATUS' and (ds_status_w IS NOT NULL AND ds_status_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(310956) || '</b>';
            ds_content_w   := ds_content_w || '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_status_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_status_w;
          end if;
        end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_bed_request (nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
