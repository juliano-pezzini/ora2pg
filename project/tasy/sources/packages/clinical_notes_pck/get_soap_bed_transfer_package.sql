-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_bed_transfer ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

    ds_content_w varchar(32000);
    ds_care_dept_w varchar(255);
    ds_med_dept_w varchar(255);
    ds_unit_w varchar(255);
    ds_transfer_date_w varchar(255);
    ds_transfer_reason_w varchar(255);
    nm_physician_name_w varchar(255);
    ds_icd_desc_w varchar(255);
    nm_nurse_primary_w varchar(255);
    ds_notes_w varchar(4000);
    ds_professional_w varchar(4000);
    ds_med_guidance_w varchar(10);
    ds_accomodation_w varchar(255);

    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));


BEGIN
    select obter_desc_setor_atend(a.cd_setor_atendimento),
    obter_nome_departamento_medico(a.cd_departamento,obter_departamento_setor(a.cd_setor_atendimento)),
    CASE WHEN coalesce(a.cd_unidade_compl::text, '') = '' THEN a.cd_unidade_basica  ELSE a.cd_unidade_basica || ' - ' || a.cd_unidade_compl END ,
    pkg_date_formaters.to_varchar(a.DT_ENTRADA_UNIDADE, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario),
    substr(obter_desc_motivo_transf_pac(nr_seq_motivo_transf),1,60),
    Obter_medico_resp_atend(a.nr_atendimento,'N'),
    Obter_Diag_Princ_atendimento(a.nr_atendimento),
    null,
    substr(a.ds_observacao,1,4000),
    substr(obter_lista_prof_str(null,a.nr_atendimento),1,4000),
    null,
    (select max(b.ds_tipo_acomodacao)from   tipo_acomodacao b where  b.ie_situacao = 'A' and b.cd_tipo_acomodacao  = a.cd_tipo_acomodacao)
    into STRICT
    ds_care_dept_w,
    ds_med_dept_w,
    ds_unit_w,
    ds_transfer_date_w,
    ds_transfer_reason_w,
    nm_physician_name_w,
    ds_icd_desc_w,
    nm_nurse_primary_w,
    ds_notes_w,
    ds_professional_w,
    ds_med_guidance_w,
    ds_accomodation_w
    from atend_paciente_unidade a where nr_seq_interno = nr_sequencia_p;

    for r_c01 in c01 loop
    if (ie_record_type_p = 'BED_TRANSFER') then
        if (r_c01.ie_field    = 'DS_SETOR' and (ds_care_dept_w IS NOT NULL AND ds_care_dept_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(489187) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_care_dept_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_care_dept_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'MED_DEPT' and (ds_med_dept_w IS NOT NULL AND ds_med_dept_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(489187) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_med_dept_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_med_dept_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_UNIT' and (ds_unit_w IS NOT NULL AND ds_unit_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(489187) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_unit_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_unit_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_TRANSFER' and (ds_transfer_date_w IS NOT NULL AND ds_transfer_date_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(489187) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_transfer_date_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_transfer_date_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'DS_REASON_TRNSF' and (ds_transfer_reason_w IS NOT NULL AND ds_transfer_reason_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(489187) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_transfer_reason_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_transfer_reason_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'ATEND_PHYSICIAN' and (nm_physician_name_w IS NOT NULL AND nm_physician_name_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(489187) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_physician_name_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_physician_name_w;
          end if;
        end if;
        if (r_c01.ie_field   = 'ICD_DESC' and (ds_icd_desc_w IS NOT NULL AND ds_icd_desc_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(489187) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_icd_desc_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_icd_desc_w;
          end if;
          end if;
        if (r_c01.ie_field   = 'PRIM_NURSE' and (nm_nurse_primary_w IS NOT NULL AND nm_nurse_primary_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(489187) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_nurse_primary_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| nm_nurse_primary_w;
          end if;
          end if;
		  if (r_c01.ie_field   = 'DS_NOTES' and (ds_notes_w IS NOT NULL AND ds_notes_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(489187) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_notes_w;
          end if;
          end if;
          if (r_c01.ie_field   = 'DS_PROFESSIONAL' and (ds_professional_w IS NOT NULL AND ds_professional_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(489187) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_professional_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_professional_w;
          end if;
          end if;
          if (r_c01.ie_field   = 'DS_ACCOMODATION' and (ds_accomodation_w IS NOT NULL AND ds_accomodation_w::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' ) then
            ds_content_w   := '<b>' || obter_desc_expressao(489187) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_accomodation_w;
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| ds_accomodation_w;
          end if;
          end if;
      end if;
    end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_bed_transfer ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
