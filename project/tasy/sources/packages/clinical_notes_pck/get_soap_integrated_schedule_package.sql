-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_notes_pck.get_soap_integrated_schedule ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) RETURNS varchar AS $body$
DECLARE

	ds_content_w varchar(32000);
	is_first_record_w varchar(1) := 'S';

    c01 CURSOR FOR
    SELECT *
    from table(clinical_notes_pck.get_clinical_note_rule(nr_atendimento_p,ie_record_type_p,null,ie_soap_type_p,ie_stage_p));
	
	c02 CURSOR FOR
	SELECT substr(obter_valor_dominio(2772,aii.ie_tipo_agendamento),1,255) ds_schedule_typ,
    obter_desc_agenda(ac.cd_agenda) ds_schedule,
	pkg_date_formaters.to_varchar(ac.dt_agenda, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_schedule,
	pkg_date_formaters.to_varchar(ac.dt_agenda, 'shortTime', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_time,
	ac.nr_minuto_duracao qt_duration, 
    substr(obter_nome_pf(aii.cd_medico_req),1,255) nm_phy_req,
	substr(obter_nome_pf(aii.cd_medico),1,255) nm_phy_ref,
    substr(obter_nome_convenio(ai.cd_convenio),1,255) ds_insurance,
    substr(obter_desc_espec_medica(aii.cd_especialidade),1,255) ds_specialty,
	substr(obter_desc_proc_interno(aii.nr_seq_proc_interno),1,255) ds_procedure,
    ai.ds_observacao ds_notes ,
	obter_nome_departamento_medico(obter_departamento_setor(ac.cd_setor_atendimento)) ds_med_dept,
    substr(obter_valor_dominio(83, ac.ie_status_agenda),1,200) ds_schd_stat,
	pkg_date_formaters.to_varchar(ac.dt_cancelamento, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_cancellation,
	substr(obter_valor_dominio(1011, ac.cd_motivo_cancelamento),1,240) ds_resason_canc,
    substr(obter_valor_dominio(1372,aii.ie_lado),1,255) ds_side,
	substr(obter_valor_dominio(6,aii.ie_anestesia),1,255) ie_anesthesia,
    substr(obter_nome_pf(aii.cd_anestesista),1,100) nm_anesthetist,
    substr(obter_nome_pf(ac.cd_medico),1,255) nm_exec_prof,
    (SELECT ds_topografia ds from  topografia_dor x where x.nr_sequencia = ac.CD_TOPOGRAFIA_PROCED) ds_topography,
    ac.QT_TOTAL_SECAO total_session,
    ac.NR_SECAO curr_session
	from agenda_integrada ai , agenda_integrada_item aii , agenda_consulta ac
	where aii.nr_seq_agenda_int	= ai.nr_sequencia and aii.nr_seq_agenda_cons = ac.nr_sequencia
	and aii.nr_seq_agenda_cons = nr_sequencia_p 
	
union

	select substr(obter_valor_dominio(2772,aii.ie_tipo_agendamento),1,255) ds_schedule_typ,
    obter_desc_agenda(ap.cd_agenda) ds_schedule, 
	pkg_date_formaters.to_varchar(ap.dt_agenda, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_schedule,
	pkg_date_formaters.to_varchar(ap.dt_agenda, 'shortTime', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_time,
	ap.nr_minuto_duracao qt_duration,
    substr(obter_nome_pf(aii.cd_medico_req),1,255) nm_phy_req,
	substr(obter_nome_pf(aii.cd_medico),1,255) nm_phy_ref,
    substr(obter_nome_convenio(ai.cd_convenio),1,255)ds_insurance,
    substr(obter_desc_espec_medica(aii.cd_especialidade),1,255) ds_specialty,
	substr(obter_desc_proc_interno(aii.nr_seq_proc_interno),1,255) ds_procedure,
    ai.ds_observacao ds_notes,
	obter_nome_departamento_medico(obter_departamento_setor(ap.cd_setor_atendimento)) ds_med_dept,
    substr(obter_valor_dominio(83, ap.ie_status_agenda),1,200) ds_schd_stat,
	pkg_date_formaters.to_varchar(ap.dt_cancelamento, 'timestamp', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_cancellation,
	substr(obter_valor_dominio(1011, ap.cd_motivo_cancelamento),1,240) ds_resason_canc,
    substr(obter_valor_dominio(1372,aii.ie_lado),1,255) ds_side,
	substr(obter_valor_dominio(6,aii.ie_anestesia),1,255) ie_anesthesia,
    substr(obter_nome_pf(aii.cd_anestesista),1,100) nm_anesthetist,
    null nm_exec_prof,
    null ds_topography,
    null total_session,
    null curr_session
	from agenda_integrada ai , agenda_integrada_item aii , agenda_paciente ap
	where aii.nr_seq_agenda_int	= ai.nr_sequencia and aii.nr_seq_agenda_exame = ap.nr_sequencia
	and aii.nr_seq_agenda_exame = nr_sequencia_p;
	

BEGIN                                        
    for r_c02 in c02 loop
    begin
    for r_c01 in c01 loop
    begin
    if (ie_record_type_p = 'CONS_SCHD' or ie_record_type_p = 'EXAM_SCHD' or ie_record_type_p = 'SRVC_SCHD') then
        if (r_c01.ie_field    = 'IE_SCHEDULE_TYP' and (r_c02.ds_schedule_typ IS NOT NULL AND r_c02.ds_schedule_typ::text <> ''))then
          if (coalesce(ds_content_w::text, '') = ''  and is_first_record_w = 'S' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_schedule_typ;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_schedule_typ;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_SCHEDULE' and  (r_c02.ds_schedule IS NOT NULL AND r_c02.ds_schedule::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_schedule;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_schedule;
          end if;
        end if;
		if (r_c01.ie_field    = 'DT_SCHEDULE' and (r_c02.dt_schedule IS NOT NULL AND r_c02.dt_schedule::text <> ''))then
          if (coalesce(ds_content_w::text, '') = ''  and is_first_record_w = 'S' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.dt_schedule;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.dt_schedule;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_TIME' and  (r_c02.dt_time IS NOT NULL AND r_c02.dt_time::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.dt_time;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.dt_time;
          end if;
        end if;
		if (r_c01.ie_field    = 'QT_DURATION' and (r_c02.qt_duration IS NOT NULL AND r_c02.qt_duration::text <> ''))then
          if (coalesce(ds_content_w::text, '') = ''  and is_first_record_w = 'S' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.qt_duration;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.qt_duration;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_PHY_REF' and  (r_c02.nm_phy_ref IS NOT NULL AND r_c02.nm_phy_ref::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.nm_phy_ref;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.nm_phy_ref;
          end if;
        end if;
        if (r_c01.ie_field    = 'CD_PHY_REQ' and (r_c02.nm_phy_req IS NOT NULL AND r_c02.nm_phy_req::text <> ''))then
          if (coalesce(ds_content_w::text, '') = ''  and is_first_record_w = 'S' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.nm_phy_req;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.nm_phy_req;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_INSURANCE' and  (r_c02.ds_insurance IS NOT NULL AND r_c02.ds_insurance::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_insurance;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_insurance;
          end if;
        end if;
        if (r_c01.ie_field    = 'CD_SPECIALTY' and (r_c02.ds_specialty IS NOT NULL AND r_c02.ds_specialty::text <> ''))then
          if (coalesce(ds_content_w::text, '') = ''  and is_first_record_w = 'S' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_specialty;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_specialty;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_PROCEDURE' and  (r_c02.ds_procedure IS NOT NULL AND r_c02.ds_procedure::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_procedure;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_procedure;
          end if;
        end if;
		if (r_c01.ie_field    = 'DS_NOTES' and (r_c02.ds_notes IS NOT NULL AND r_c02.ds_notes::text <> ''))then
          if (coalesce(ds_content_w::text, '') = ''  and is_first_record_w = 'S' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_notes;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_notes;
          end if;
        end if;
        if (r_c01.ie_field   = 'MED_DEPT' and  (r_c02.ds_med_dept IS NOT NULL AND r_c02.ds_med_dept::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_med_dept;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_med_dept;
          end if;
        end if;
		if (r_c01.ie_field    = 'CD_SCHD_STAT' and (r_c02.ds_schd_stat IS NOT NULL AND r_c02.ds_schd_stat::text <> ''))then
          if (coalesce(ds_content_w::text, '') = ''  and is_first_record_w = 'S' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_schd_stat;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_schd_stat;
          end if;
        end if;
        if (r_c01.ie_field   = 'DT_CANCELLATION' and  (r_c02.dt_cancellation IS NOT NULL AND r_c02.dt_cancellation::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.dt_cancellation;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.dt_cancellation;
          end if;
        end if;
		if (r_c01.ie_field    = 'CD_RESASON_CANC' and (r_c02.ds_resason_canc IS NOT NULL AND r_c02.ds_resason_canc::text <> ''))then
          if (coalesce(ds_content_w::text, '') = ''  and is_first_record_w = 'S' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_resason_canc;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_resason_canc;
          end if;
        end if;
        if (r_c01.ie_field   = 'IE_SIDE' and  (r_c02.ds_side IS NOT NULL AND r_c02.ds_side::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_side;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_side;
          end if;
        end if;
		if (r_c01.ie_field    = 'IE_ANESTHESIA' and (r_c02.ie_anesthesia IS NOT NULL AND r_c02.ie_anesthesia::text <> ''))then
          if (coalesce(ds_content_w::text, '') = ''  and is_first_record_w = 'S' ) then
            ds_content_w    := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w    := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ie_anesthesia;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ie_anesthesia;
          end if;
        end if;
        if (r_c01.ie_field   = 'CD_ANESTHETIST' and  (r_c02.nm_anesthetist IS NOT NULL AND r_c02.nm_anesthetist::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.nm_anesthetist;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.nm_anesthetist;
          end if;
        end if;
		if (r_c01.ie_field   = 'CD_TOPOGRAPHY' and  (r_c02.ds_topography IS NOT NULL AND r_c02.ds_topography::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_topography;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.ds_topography;
          end if;
        end if;
        if (r_c01.ie_field   = 'EXEC_PROF' and  (r_c02.nm_exec_prof IS NOT NULL AND r_c02.nm_exec_prof::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.nm_exec_prof;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.nm_exec_prof;
          end if;
        end if;
        if (r_c01.ie_field   = 'QT_SESSIONS' and  (r_c02.total_session IS NOT NULL AND r_c02.total_session::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.total_session;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.total_session;
          end if;
        end if;
        if (r_c01.ie_field   = 'CURR_SESSION' and  (r_c02.curr_session IS NOT NULL AND r_c02.curr_session::text <> ''))then
          if (coalesce(ds_content_w::text, '') = '' and is_first_record_w = 'S'  ) then
            ds_content_w   := '<b>' || obter_desc_expressao(323414) || '</b>';
            ds_content_w   := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.curr_session;
			is_first_record_w := 'N';
          else
            ds_content_w := ds_content_w|| '</br>' || coalesce(r_c01.nm_field,r_c01.ds_expressao) || ' - '|| r_c02.curr_session;
          end if;
        end if;
        end if;
        end;
    end loop;
    end;
	end loop;
    return ds_content_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION clinical_notes_pck.get_soap_integrated_schedule ( nr_atendimento_p bigint, nr_sequencia_p bigint, ie_record_type_p text, ie_soap_type_p text, ie_stage_p bigint) FROM PUBLIC;
