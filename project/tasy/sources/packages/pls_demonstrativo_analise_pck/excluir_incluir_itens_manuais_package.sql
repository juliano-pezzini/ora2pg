-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_demonstrativo_analise_pck.excluir_incluir_itens_manuais ( nr_seq_versao_p pls_rel_an_conta.nr_seq_versao%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

						
tb_recriar_pag_cont_w		dbms_sql.number_table;
nr_seq_an_pagina_w		pls_rel_an_pagina.nr_sequencia%type;
nr_pagina_w			pls_rel_an_pagina.nr_pagina%type;
						
--Busca todos os itens com valor de glosa

current_setting('pls_demonstrativo_analise_pck.c01')::CURSOR( CURSOR(	nr_seq_versao_pc	pls_rel_an_conta.nr_seq_versao%type,
		ie_itens_manuais_pc	text) FOR
	SELECT	a.nr_sequencia nr_seq_item,
		a.nr_seq_an_conta
	from	pls_rel_an_conta	b,
		pls_rel_an_itens	a,
		pls_conta_proc		c
	where	a.nr_seq_an_conta	= b.nr_sequencia
	and	a.nr_seq_conta_proc	= c.nr_sequencia
	and	b.nr_seq_versao		= nr_seq_versao_pc
	and	((ie_itens_manuais_pc 	= 'E' and (
						 (coalesce(c.ie_acao_analise,'X') = 'I') or (c.nr_seq_regra_lanc_aut IS NOT NULL AND c.nr_seq_regra_lanc_aut::text <> '')))
	or (ie_itens_manuais_pc 	= 'I' and (
						coalesce(c.ie_acao_analise,'X') <> 'I') and (coalesce(c.nr_seq_regra_lanc_aut::text, '') = '')))
	
union all

	SELECT	a.nr_sequencia nr_seq_item,
		a.nr_seq_an_conta
	from	pls_rel_an_conta	b,
		pls_rel_an_itens	a,
		pls_conta_mat		c
	where	a.nr_seq_an_conta	= b.nr_sequencia
	and	a.nr_seq_conta_mat	= c.nr_sequencia
	and	b.nr_seq_versao		= nr_seq_versao_pc
	and	((ie_itens_manuais_pc 	= 'E' and (
						 (coalesce(c.ie_acao_analise,'X') = 'I') or (c.nr_seq_regra_lanc_aut IS NOT NULL AND c.nr_seq_regra_lanc_aut::text <> '')))
	or (ie_itens_manuais_pc 	= 'I' and (
						coalesce(c.ie_acao_analise,'X') <> 'I') and (coalesce(c.nr_seq_regra_lanc_aut::text, '') = '')));
	
--Duplica todos os itens da conta

current_setting('pls_demonstrativo_analise_pck.c02')::CURSOR( CURSOR( nr_seq_an_conta_pc	pls_rel_an_itens.nr_seq_an_conta%type) FOR
	SELECT	nr_sequencia
	from	pls_rel_an_itens
	where	nr_seq_an_conta	= nr_seq_an_conta_pc
	order by ds_item, nr_seq_conta_proc, nr_seq_conta_mat;
								
BEGIN

tb_recriar_pag_cont_w.delete;


for r_c01_w in current_setting('pls_demonstrativo_analise_pck.c01')::CURSOR( (nr_seq_versao_p,current_setting('pls_demonstrativo_analise_pck.ie_itens_manuais_w')::varchar(10)) loop

	if (not tb_recriar_pag_cont_w.exists(r_c01_w.nr_seq_an_conta)) then
		tb_recriar_pag_cont_w(r_c01_w.nr_seq_an_conta) := r_c01_w.nr_seq_an_conta;
	end if;
	
	delete	FROM pls_rel_an_itens
	where	nr_sequencia	= r_c01_w.nr_seq_item;
	
end loop;

if (tb_recriar_pag_cont_w.count > 0) then

	for i in tb_recriar_pag_cont_w.first .. tb_recriar_pag_cont_w.last loop

		nr_pagina_w	:= 1;
		
		--Limpa toda as paginas dos itens

		update	pls_rel_an_itens
		set	nr_seq_an_pagina	 = NULL
		where	nr_seq_an_conta		= i;
		
		--Deleta todas as paginas

		delete	FROM pls_rel_an_pagina
		where	nr_seq_an_conta		= i;
		
		--Recria a primeira pagina

		insert into	pls_rel_an_pagina(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_an_conta,nr_pagina)
		values (	nextval('pls_rel_an_pagina_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				i,nr_pagina_w)
		returning nr_sequencia into nr_seq_an_pagina_w;
		
		for r_c02_w in current_setting('pls_demonstrativo_analise_pck.c02')::CURSOR( (i) loop
			
			--Coloca a pagina para o item

			update	pls_rel_an_itens
			set	nr_seq_an_pagina	= nr_seq_an_pagina_w
			where	nr_sequencia		= r_c02_w.nr_sequencia;
			
			if	(mod(current_setting('pls_demonstrativo_analise_pck.c02')::CURSOR(%rowCount,17) = 0) then	
			
				nr_pagina_w	:= nr_pagina_w + 1;
			
				insert into	pls_rel_an_pagina(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
						nr_seq_an_conta,nr_pagina)
				values (	nextval('pls_rel_an_pagina_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
						i,nr_pagina_w)
				returning nr_sequencia into nr_seq_an_pagina_w;
			end if;
		end loop;
		
		--Deleta a pagina senao houve nenhum item para ela

		delete	FROM pls_rel_an_pagina	a
		where	nr_sequencia	= nr_seq_an_pagina_w
		and	not exists ( SELECT	1
				from	pls_rel_an_itens x
				where	x.nr_seq_an_pagina	= a.nr_sequencia);
				

	end loop;
end if;

tb_recriar_pag_cont_w.delete;

end;



$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_demonstrativo_analise_pck.excluir_incluir_itens_manuais ( nr_seq_versao_p pls_rel_an_conta.nr_seq_versao%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
