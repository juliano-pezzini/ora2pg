-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_demonstrativo_analise_pck.inserir_itens ( nr_seq_rel_an_conta_p bigint) AS $body$
BEGIN

/*Insere a pagina 1*/



if	((current_setting('pls_demonstrativo_analise_pck.nr_seq_conta_anterior_w')::pls_rel_an_conta.nr_seq_conta%type <> nr_seq_rel_an_conta_p) or (current_setting('pls_demonstrativo_analise_pck.qt_reg_conta_w')::integer	= 17)) then
	nr_pagina_w	:= nr_pagina_w + 1;
	insert into	pls_rel_an_pagina(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			nr_seq_an_conta,nr_pagina)
	values (	nextval('pls_rel_an_pagina_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
			nr_seq_rel_an_conta_p,nr_pagina_w)
	returning nr_sequencia into nr_seq_an_pagina_w;
	
	PERFORM set_config('pls_demonstrativo_analise_pck.nr_seq_conta_anterior_w', nr_seq_rel_an_conta_p, false);
	PERFORM set_config('pls_demonstrativo_analise_pck.qt_reg_conta_w', 0, false);
end if;

for z in dt_item_w.first..dt_item_w.last loop
	begin
	
	ds_item_w(z)			:= substr(ptu_somente_caracter_permitido(replace(ds_item_w(z),'"',''), 'TISS'),1,150);
	PERFORM set_config('pls_demonstrativo_analise_pck.qt_reg_conta_w', current_setting('pls_demonstrativo_analise_pck.qt_reg_conta_w')::integer + 1, false); --Contagem  de itens por pagina considerando agrupanmento por guia
	cd_item_w(z)			:= regexp_replace(cd_item_w(z), '[^0-9]', '');
	tb_nr_seq_an_pagina_w(z)	:= nr_seq_an_pagina_w;
	cd_tabela_w(z)			:= lpad(cd_tabela_w(z),2,'0');
			
	/*Caso chegue na linha 17, cria um novo registro ou no caso de agrupamento por guia principal, entao a contagem  tambem e de linhas por conta*/


	if	(((mod(z,17) = 0) and (current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_agrup_atendimento = 'N')) or (current_setting('pls_demonstrativo_analise_pck.qt_reg_conta_w')::integer = 17)) then	
		nr_pagina_w	:= nr_pagina_w + 1;		
		PERFORM set_config('pls_demonstrativo_analise_pck.qt_reg_conta_w', 0, false);
		insert into	pls_rel_an_pagina(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_an_conta,nr_pagina)
		values (	nextval('pls_rel_an_pagina_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				nr_seq_rel_an_conta_p,nr_pagina_w)
		returning nr_sequencia into nr_seq_an_pagina_w;
	end if;
		
	end;
end loop;

--Se parametrizado para retornar valor bruto(Liberado + tx adm)

if (current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_valor_bruto = 'S') then
	forall z in dt_item_w.first..dt_item_w.last
		/*Faz os insert's dos itens da conta alimentados nas tables*/


		insert into pls_rel_an_itens(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_an_conta,nr_seq_an_pagina,dt_item,cd_tabela,cd_procedimento,
				ds_item,cd_grau_partic,vl_informado,qt_executada,vl_processado,
				vl_liberado,vl_glosa,cd_glosa, nr_seq_conta_proc, nr_seq_conta_mat, nr_seq_item_tiss)
		values (	nextval('pls_rel_an_itens_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				nr_seq_rel_an_conta_p, tb_nr_seq_an_pagina_w(z),dt_item_w(z),cd_tabela_w(z),cd_item_w(z),
				ds_item_w(z),cd_grau_partic_w(z),vl_informado_w(z),qt_executada_w(z),vl_processado_w(z),
				vl_lib_com_tx_adm_w(z),vl_glosa_w(z),cd_glosa_w(z),nr_seq_conta_proc_w(z), nr_seq_conta_mat_w(z), tb_nr_seq_item_tiss_w(z));--
else
	forall z in dt_item_w.first..dt_item_w.last
		insert into pls_rel_an_itens(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_an_conta,nr_seq_an_pagina,dt_item,cd_tabela,cd_procedimento,
				ds_item,cd_grau_partic,vl_informado,qt_executada,vl_processado,
				vl_liberado,vl_glosa,cd_glosa, nr_seq_conta_proc, nr_seq_conta_mat, nr_seq_item_tiss)
		values (	nextval('pls_rel_an_itens_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				nr_seq_rel_an_conta_p, tb_nr_seq_an_pagina_w(z),dt_item_w(z),cd_tabela_w(z),cd_item_w(z),
				ds_item_w(z),cd_grau_partic_w(z),vl_informado_w(z),qt_executada_w(z),vl_processado_w(z),
				vl_liberado_w(z),vl_glosa_w(z),cd_glosa_w(z),nr_seq_conta_proc_w(z), nr_seq_conta_mat_w(z), tb_nr_seq_item_tiss_w(z));
end if;
				
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_demonstrativo_analise_pck.inserir_itens ( nr_seq_rel_an_conta_p bigint) FROM PUBLIC;
