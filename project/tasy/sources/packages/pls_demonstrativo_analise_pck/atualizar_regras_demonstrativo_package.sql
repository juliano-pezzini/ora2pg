-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Nao pode dar commit nessa procedure ou fazer comandos de insert, update ou delete



CREATE OR REPLACE PROCEDURE pls_demonstrativo_analise_pck.atualizar_regras_demonstrativo ( ie_prest_demonstrativo_gl_p pls_web_param_geral.ie_prest_demonstrativo%type, nr_seq_prestador_rel_gl_p pls_prestador.nr_sequencia%type, nr_seq_usuario_web_p pls_regra_demons_analise.nr_seq_usuario%type) AS $body$
DECLARE

						
nr_seq_demons_analise_w		pls_regra_demons_analise.nr_sequencia%type;
ie_cad_conta_medica_w		pls_controle_estab.ie_cad_conta_medica%type;
cd_estabelecimento_w		bigint;


BEGIN

--Inicializa tudo como "N"

current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.nr_sequencia			:= null;
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_excluir_itens_sem_glosa		:= 'N';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_excluir_itens_manuais		:= 'N';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_abrir_participante		:= 'N';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_agrup_atendimento		:= 'N';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_restringe_prest_vinc		:= 'N';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_somente_guia_paga		:= 'N';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_retorna_glosa			:= 'N';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_valor_processado			:= 'N';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_qtde_executada			:= 'S';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_tipo_guia_operadora		:= 'R';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_agrup_proc_qtd_exec		:= 'N';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_ocultar_hifen			:= 'N';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_agrup_prot_referencia		:= 'S';
current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_valor_bruto				:= 'N';

select	wheb_usuario_pck.get_cd_estabelecimento
into STRICT	cd_estabelecimento_w
;

select	coalesce(max(ie_cad_conta_medica),'N')
into STRICT	ie_cad_conta_medica_w
from	pls_controle_estab;

--Se prestador atendimento, entao faz o select de regras retritas por esse prestador

if (ie_prest_demonstrativo_gl_p = 'PA') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_demons_analise_w
	from	pls_regra_demons_analise
	where	((nr_seq_prestador_atend = nr_seq_prestador_rel_gl_p) or (nr_seq_usuario = nr_seq_usuario_web_p))
	and	((ie_cad_conta_medica_w = 'N') or (cd_estabelecimento = cd_estabelecimento_w));
--Se pretador de pagamento, entao faz o select de regras retritas por esse prestador

else
	select	max(nr_sequencia)
	into STRICT	nr_seq_demons_analise_w
	from	pls_regra_demons_analise
	where	((nr_seq_prestador_pgto = nr_seq_prestador_rel_gl_p) or (nr_seq_usuario = nr_seq_usuario_web_p))
	and	((ie_cad_conta_medica_w = 'N') or (cd_estabelecimento = cd_estabelecimento_w));
end if;

--Busca uma regra geral, caso nao tive filtrado para prestador ou usuario web

if (coalesce(nr_seq_demons_analise_w::text, '') = '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_demons_analise_w
	from	pls_regra_demons_analise
	where	coalesce(nr_seq_prestador_atend::text, '') = ''
	and	coalesce(nr_seq_usuario::text, '') = ''
	and	coalesce(nr_seq_prestador_pgto::text, '') = ''
	and	((ie_cad_conta_medica_w = 'N') or (cd_estabelecimento = cd_estabelecimento_w));
end if;

--Busca a regra

if (nr_seq_demons_analise_w IS NOT NULL AND nr_seq_demons_analise_w::text <> '') then
	select	max(nr_sequencia),			
	        coalesce(max(ie_excluir_itens_sem_glosa),'N'),	
	        coalesce(max(ie_excluir_itens_manuais),'N'),	
	        coalesce(max(ie_abrir_participante),'N'),		
	        coalesce(max(ie_agrup_atendimento),'N'),		
	        coalesce(max(ie_restringe_prest_vinc),'N'),	
                coalesce(max(ie_somente_guia_paga), 'N'),
		coalesce(max(ie_retorna_glosa),'N'),
		coalesce(max(ie_valor_processado),'N'),
		coalesce(max(ie_qtde_executada),'S'),
		coalesce(max(ie_tipo_guia_operadora),'R'),
		coalesce(max(ie_agrup_proc_qtd_exec),'N'),
		coalesce(max(ie_ocultar_hifen),'N'),
		coalesce(max(ie_agrup_prot_referencia),'S'),
		coalesce(max(ie_valor_bruto),'N')
	into STRICT	current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.nr_sequencia,
	        current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_excluir_itens_sem_glosa,
	        current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_excluir_itens_manuais,	
	        current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_abrir_participante,	
	        current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_agrup_atendimento,	
	        current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_restringe_prest_vinc,	
	        current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_somente_guia_paga,
		current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_retorna_glosa,
		current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_valor_processado,
		current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_qtde_executada,
		current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_tipo_guia_operadora,
		current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_agrup_proc_qtd_exec,
		current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_ocultar_hifen,
		current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_agrup_prot_referencia,
		current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_valor_bruto
	from	pls_regra_demons_analise
	where	nr_sequencia = nr_seq_demons_analise_w;
end if;

end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_demonstrativo_analise_pck.atualizar_regras_demonstrativo ( ie_prest_demonstrativo_gl_p pls_web_param_geral.ie_prest_demonstrativo%type, nr_seq_prestador_rel_gl_p pls_prestador.nr_sequencia%type, nr_seq_usuario_web_p pls_regra_demons_analise.nr_seq_usuario%type) FROM PUBLIC;
