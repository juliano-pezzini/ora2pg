-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_demonstrativo_analise_pck.obter_cd_glosa_item ( nr_seq_item_p bigint, ie_item_p text, vl_glosa_p bigint) RETURNS varchar AS $body$
DECLARE

						
nr_seq_motivo_glosa_w			pls_conta_glosa.nr_seq_motivo_glosa%type;


BEGIN
						
if (vl_glosa_p	> 0) then
	if (ie_item_p = 'P') then
		select	max(b.nr_seq_motivo_glosa)
		into STRICT	nr_seq_motivo_glosa_w
		from	pls_ocorrencia		b,
			pls_ocorrencia_benef	a
		where	b.nr_sequencia			= a.nr_seq_ocorrencia
		and	a.nr_seq_conta_proc		= nr_seq_item_p
		and	coalesce(b.ie_glosar_pagamento,'N') 	= 'S'
		and	a.ie_situacao			!= 'I'
		and	a.nr_sequencia			= (SELECT 	max(x.nr_sequencia)
							   from		pls_ocorrencia		y,
									pls_ocorrencia_benef	x
							   where	y.nr_sequencia			= x.nr_seq_ocorrencia
							   and		x.nr_seq_conta_proc		= nr_seq_item_p
							   and		coalesce(y.ie_glosar_pagamento,'N') 	= 'S'
							   and		x.ie_situacao			!= 'I' );
		
		if (coalesce(nr_seq_motivo_glosa_w::text, '') = '') then
			select	max(a.nr_seq_motivo_glosa)
			into STRICT	nr_seq_motivo_glosa_w
			from	pls_conta_glosa a
			where 	a.nr_seq_conta_proc	= nr_seq_item_p
			and	a.ie_situacao		!= 'I'
			and	a.nr_sequencia		= (	SELECT	max(b.nr_sequencia)
								from	pls_conta_glosa b
								where 	b.nr_seq_conta_proc	= nr_seq_item_p
								and	b.ie_situacao		!= 'I');
		end if;
	elsif (ie_item_p = 'M') then
		
		select	max(b.nr_seq_motivo_glosa)
		into STRICT	nr_seq_motivo_glosa_w
		from	pls_ocorrencia		b,
			pls_ocorrencia_benef	a
		where	b.nr_sequencia			= a.nr_seq_ocorrencia
		and	a.nr_seq_conta_mat		= nr_seq_item_p
		and	coalesce(b.ie_glosar_pagamento,'N') 	= 'S'
		and	a.ie_situacao			!= 'I'
		and	a.nr_sequencia			= (SELECT 	max(x.nr_sequencia)
							   from		pls_ocorrencia		y,
									pls_ocorrencia_benef	x
							   where	y.nr_sequencia			= x.nr_seq_ocorrencia
							   and		x.nr_seq_conta_mat		= nr_seq_item_p
							   and		coalesce(y.ie_glosar_pagamento,'N') 	= 'S'
							   and		x.ie_situacao			!= 'I' );

		if (coalesce(nr_seq_motivo_glosa_w::text, '') = '') then
			select	max(a.nr_seq_motivo_glosa)
			into STRICT	nr_seq_motivo_glosa_w
			from	pls_conta_glosa a
			where 	a.nr_seq_conta_mat	= nr_seq_item_p
			and	a.ie_situacao		!= 'I'
			and	a.nr_sequencia		= (	SELECT	max(b.nr_sequencia)
								from	pls_conta_glosa b
								where 	b.nr_seq_conta_mat	= nr_seq_item_p
								and	b.ie_situacao		!= 'I');
		end if;
	end if;
	
	return substr(tiss_obter_motivo_glosa(nr_seq_motivo_glosa_w,'C'),1,255);
end if;		

return '';			
						
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION pls_demonstrativo_analise_pck.obter_cd_glosa_item ( nr_seq_item_p bigint, ie_item_p text, vl_glosa_p bigint) FROM PUBLIC;
