-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_demonstrativo_analise_pck.atualiza_valores_conta_prot ( nr_seq_versao_rel_p pls_rel_an_versao.nr_sequencia%type, dados_conta_p dados_conta_w_record) AS $body$
DECLARE

			
vl_informado_itens_w			pls_rel_an_itens.vl_informado%type;
vl_processado_itens_w			pls_rel_an_itens.vl_processado%type;
vl_glosa_itens_w			pls_rel_an_itens.vl_glosa%type;
vl_liberado_itens_w			pls_rel_an_itens.vl_liberado%type;

vl_informado_prot_w			pls_rel_an_itens.vl_informado%type	:= 0;
vl_processado_prot_w			pls_rel_an_itens.vl_processado%type	:= 0;
vl_glosa_prot_w				pls_rel_an_itens.vl_glosa%type		:= 0;
vl_liberado_prot_w			pls_rel_an_itens.vl_liberado%type	:= 0;
			
BEGIN

if (dados_conta_p.nr_seq_rel_an_conta.count > 0) then
	for i in dados_conta_p.nr_seq_rel_an_conta.first..dados_conta_p.nr_seq_rel_an_conta.last loop
		begin
				
		select	sum(coalesce(vl_informado,0)),
			sum(coalesce(vl_processado,0)),
			sum(coalesce(vl_glosa,0)),
			sum(coalesce(vl_liberado,0))
		into STRICT	vl_informado_itens_w,
			vl_processado_itens_w,
			vl_glosa_itens_w,
			vl_liberado_itens_w
		from	pls_rel_an_itens
		where	nr_seq_an_conta	= dados_conta_p.nr_seq_rel_an_conta(i);
		
		
		if	((current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_abrir_participante = 'S') or (current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_retorna_glosa = 'S')) then
			--Totalizacao do valor informado

			--aqui eu verificaria se esta configurado para abrir por participante e neses caso o valor informado precisa ser agrupado por 

			--sequencia do procedimento, para que nao seja multiplicado pela quantidade de participantes. Esses itens agrupados somam-se

			--aos demais itens do demnstrativos para ter o valor informado da guia.

			--Necessario fazer esses select sobre selectm, pois por usar group by, o max nao retorna null quando der no data found

			select  sum(vl_informado)
			into STRICT	vl_informado_itens_w
			from (
				SELECT  vl_informado
				from   	pls_rel_an_itens
				where 	nr_seq_an_conta	= dados_conta_p.nr_seq_rel_an_conta(i)
				and	coalesce(nr_seq_conta_mat, 1) = 1
				group by nr_seq_conta_proc,vl_informado
				
union all

				SELECT  vl_informado
				from   	pls_rel_an_itens
				where 	nr_seq_an_conta	= dados_conta_p.nr_seq_rel_an_conta(i)
				and	coalesce(nr_seq_conta_proc, 1) = 1
				group by nr_seq_conta_mat,vl_informado
			) alias10;
			--Totalizacao do valor processado

			--Necessario fazer esses select sobre selectm, pois por usar group by, o max nao retorna null quando der no data found

			select  sum(vl_processado)
			into STRICT	vl_processado_itens_w
		        from (		
				SELECT	vl_processado
				from    pls_rel_an_itens
				where   nr_seq_an_conta  = dados_conta_p.nr_seq_rel_an_conta(i)
				and     coalesce(nr_seq_conta_mat, 1) = 1
				group by nr_seq_conta_proc,vl_processado
				
union all

				SELECT  vl_processado
				from    pls_rel_an_itens
				where   nr_seq_an_conta  = dados_conta_p.nr_seq_rel_an_conta(i)
				and     coalesce(nr_seq_conta_proc, 1) = 1
				group by nr_seq_conta_mat,vl_processado
		  	) alias5;
			
			--Se for o retorno de Glosa, faz a mesma acao com outros campos

			if (current_setting('pls_demonstrativo_analise_pck.dados_regra_demonstrativo_w')::dados_regra_demons_analise.ie_retorna_glosa = 'S') then
				select  sum(vl_liberado)
				into STRICT	vl_liberado_itens_w
				from (	SELECT  vl_liberado
					from   	pls_rel_an_itens
					where 	nr_seq_an_conta	= dados_conta_p.nr_seq_rel_an_conta(i)
					and	coalesce(nr_seq_conta_mat, 1) = 1
					group by nr_seq_conta_proc,vl_liberado
					
union all

					SELECT  vl_liberado
					from   	pls_rel_an_itens
					where 	nr_seq_an_conta	= dados_conta_p.nr_seq_rel_an_conta(i)
					and	coalesce(nr_seq_conta_proc, 1) = 1
					group by nr_seq_conta_mat,vl_liberado) alias7;

				select  sum(vl_glosa)
				into STRICT	vl_glosa_itens_w
				from (	SELECT	vl_glosa
					from    pls_rel_an_itens
					where   nr_seq_an_conta  = dados_conta_p.nr_seq_rel_an_conta(i)
					and     coalesce(nr_seq_conta_mat, 1) = 1
					group by nr_seq_conta_proc,vl_glosa
					
union all

					SELECT  vl_glosa
					from    pls_rel_an_itens
					where   nr_seq_an_conta  = dados_conta_p.nr_seq_rel_an_conta(i)
					and     coalesce(nr_seq_conta_proc, 1) = 1
					group by nr_seq_conta_mat,vl_glosa) alias5;
			
			end if;
		end if;
			
		update	pls_rel_an_conta
		set	vl_informado	= vl_informado_itens_w,
			vl_processado	= vl_processado_itens_w,
			vl_glosa	= vl_glosa_itens_w,
			vl_liberado	= vl_liberado_itens_w
		where	nr_sequencia	= dados_conta_p.nr_seq_rel_an_conta(i);
				
		vl_informado_prot_w		:= vl_informado_prot_w + coalesce(vl_informado_itens_w,0);
		vl_processado_prot_w		:= vl_processado_prot_w + coalesce(vl_processado_itens_w,0);
		vl_glosa_prot_w			:= vl_glosa_prot_w + coalesce(vl_glosa_itens_w,0);
		vl_liberado_prot_w		:= vl_liberado_prot_w + coalesce(vl_liberado_itens_w,0);
		
		end;
	end loop;
end if;

update	pls_rel_an_versao
set	vl_informado		= vl_informado_prot_w,
	vl_processado		= vl_processado_prot_w,
	vl_glosa		= vl_glosa_prot_w,
	vl_liberado		= vl_liberado_prot_w,
	vl_informado_geral	= vl_informado_prot_w,
	vl_processado_geral	= vl_processado_prot_w,
	vl_liberado_geral	= vl_liberado_prot_w,
	vl_glosa_geral		= vl_glosa_prot_w
where	nr_sequencia		= nr_seq_versao_rel_p;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_demonstrativo_analise_pck.atualiza_valores_conta_prot ( nr_seq_versao_rel_p pls_rel_an_versao.nr_sequencia%type, dados_conta_p dados_conta_w_record) FROM PUBLIC;
