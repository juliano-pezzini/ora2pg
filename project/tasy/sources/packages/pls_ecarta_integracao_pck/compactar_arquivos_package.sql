-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ecarta_integracao_pck.compactar_arquivos ( ds_caminho_p pls_ecarta_arquivo_solic.ds_caminho%type, nm_arquivo_p pls_ecarta_arquivo_solic.nm_arquivo%type, ds_caminho_destino_p pls_ecarta_arquivo_solic.ds_caminho%type) AS $body$
DECLARE

	ds_erro_w	varchar(4000);
	nm_arquivos_w	text;
	pls_arquivo_w	pls_arquivo_r;
BEGIN
	-- Seta variáveis globais
	PERFORM set_config('pls_ecarta_integracao_pck.nm_procedimento_w', 'compactar arquivos', false);

	if (current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row.count > 0) then
		-- Monta uma lista com os caminhos dos arquivos a serem compactados e excluídos
		nm_arquivos_w := null;
		for i in current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row.first..pls_arquivo_t.last loop
			-- Seta variáveis globais
			PERFORM set_config('pls_ecarta_integracao_pck.nr_seq_ecarta_solicitacao_w', current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row[i].nr_seq_ecarta_solicitacao, false);
			PERFORM set_config('pls_ecarta_integracao_pck.nr_seq_ecarta_arquivo_solic_w', current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row[i].nr_sequencia, false);

			-- Agrupa os arquivos separados por ponto-e-vírgula (;)
			-- Aqui a barra é fixa pois é enviada ao java
			nm_arquivos_w := nm_arquivos_w || current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row[i].ds_caminho || '/' || current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row[i].nm_arquivo || ';';

			-- Excluir arquivos da tabela
			if (current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row[i](.nr_sequencia IS NOT NULL AND .nr_sequencia::text <> '')) then
				CALL pls_ecarta_integracao_pck.atualizar_arquivo(current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row(i));
			end if;

			-- Inclui arquivo zip para todos os arquivos excluídos da tabela
			pls_arquivo_w.nr_seq_ecarta_solicitacao := current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row[i].nr_seq_ecarta_solicitacao;
			pls_arquivo_w.nm_arquivo := nm_arquivo_p;
			pls_arquivo_w.ds_caminho := ds_caminho_destino_p;
			CALL pls_ecarta_integracao_pck.atualizar_arquivo(pls_arquivo_w);

			-- Seta variáveis globais
			PERFORM set_config('pls_ecarta_integracao_pck.nm_procedimento_w', 'compactar arquivos', false);
		end loop;

		-- Seta variáveis globais
		current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row.delete;
		PERFORM set_config('pls_ecarta_integracao_pck.qt_arq_w', 0, false);
		PERFORM set_config('pls_ecarta_integracao_pck.nr_seq_ecarta_solicitacao_w', null, false);
		PERFORM set_config('pls_ecarta_integracao_pck.nr_seq_ecarta_arquivo_solic_w', null, false);

		-- Inclui arquivos no zip e os exclui do disco
		-- Aqui a barra é fixa pois é enviada ao java
		CALL CALL pls_ecarta_integracao_pck.incluir_log('D', 'Compactar arquivos: Compacta arquivo zip', 'ds_caminho_p = ' || ds_caminho_p || chr(13) || 'nm_arquivo_p = ' || nm_arquivo_p, $$plsql_line);
		ds_erro_w := pls_utl_zip_pck.compactar_arquivos(ds_caminho_p || '/' || nm_arquivo_p, nm_arquivos_w, 'S');
		if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
		end if;

		-- Inclui o arquivo zip na lista de arquivos
		PERFORM set_config('pls_ecarta_integracao_pck.qt_arq_w', current_setting('pls_ecarta_integracao_pck.qt_arq_w')::numeric(22) + 1, false);
		current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row(current_setting('pls_ecarta_integracao_pck.qt_arq_w')::numeric(22)).nm_arquivo := nm_arquivo_p;
		current_setting('pls_ecarta_integracao_pck.pls_arquivo_t')::pls_arquivo_row(current_setting('pls_ecarta_integracao_pck.qt_arq_w')::numeric(22)).ds_caminho := ds_caminho_p;
	end if;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ecarta_integracao_pck.compactar_arquivos ( ds_caminho_p pls_ecarta_arquivo_solic.ds_caminho%type, nm_arquivo_p pls_ecarta_arquivo_solic.nm_arquivo%type, ds_caminho_destino_p pls_ecarta_arquivo_solic.ds_caminho%type) FROM PUBLIC;
