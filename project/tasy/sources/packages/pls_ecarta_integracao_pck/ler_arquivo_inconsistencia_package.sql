-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_ecarta_integracao_pck.ler_arquivo_inconsistencia ( ds_caminho_p pls_ecarta_arquivo_solic.ds_caminho%type, nm_arquivo_p pls_ecarta_arquivo_solic.nm_arquivo%type, nm_arq_zip_p pls_ecarta_arquivo_solic.nm_arquivo%type) RETURNS boolean AS $body$
DECLARE

	-- variáveis
	xml				xml;
	pls_arquivo_w			pls_arquivo_r;
	cd_dom_incons_w			dominio.cd_dominio%type := 8748;
	ie_inconsistencia_arquivo_w	varchar(15);
	ds_inconsistencia_arquivo_w	varchar(255);
	nr_seq_lote_w			pls_ecarta_log_integracao.nr_seq_ecarta_lote%type;

	-- Lote
	c01_w CURSOR FOR
	SELECT	extractValue(value(a), 'notRecebimentoAR/nuLote')							as nr_lote,
		extractValue(value(a), 'notRecebimentoAR/arsNotificacao/InconsistenciaArquivo/cdInconsistenciaArquivo')	as ie_inconsistencia_arquivo,
		extractValue(value(a), 'notRecebimentoAR/arsNotificacao/InconsistenciaArquivo/msgInconsistenciaArquivo')as ds_inconsistencia_arquivo
	from	table(xmlSequence(extract(xml, '/Mensagem/corpoMensagem/*'))) a;

	-- Solicitações
	c02_w CURSOR FOR
	SELECT	extractValue(value(b), 'AR/cdObjetoClienteInconsistente')			as nr_solicitacao,
		extractValue(value(b), 'AR/InconsistenciaObjeto/cdInconsistenciaObjeto')	as ie_inconsistencia_objeto,
		extractValue(value(b), 'AR/InconsistenciaObjeto/msgInconsistenciaObjeto')	as ds_inconsistencia_objeto
	from	table(xmlSequence(extract(xml, '/Mensagem/corpoMensagem/notRecebimentoAR/arsNotificacao/*'))) b;
BEGIN
	-- Seta variáveis globais
	PERFORM set_config('pls_ecarta_integracao_pck.nm_procedimento_w', 'ler arquivo de inconsistência de lote enviado', false);

	-- Carrega o conteúdo do arquivo xml
	xml := xmlparse(DOCUMENT, convert_from(dbms_XSLprocessor.read2clob(ds_caminho_p, nm_arquivo_p, nls_charset_id('UTF8')), 'utf-8'));

	-- Lê o cabeçalho do arquivo xml
	open c01_w;
	fetch c01_w into
		current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_lote_w')::pls_ecarta_lote.nr_sequencia%type,
		ie_inconsistencia_arquivo_w,
		ds_inconsistencia_arquivo_w;
	close c01_w;

	-- Atualiza o lote
	if (current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_lote_w')::pls_ecarta_lote.nr_sequencia%(type IS NOT NULL AND type::text <> '')) then

		-- Verifica se o lote existe não está encerrado
		if (pls_ecarta_integracao_pck.obter_existencia_lote(current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_lote_w')::pls_ecarta_lote.nr_sequencia%type)) then
			if (ie_inconsistencia_arquivo_w IS NOT NULL AND ie_inconsistencia_arquivo_w::text <> '') then
				-- Atualiza lote
				update	pls_ecarta_lote
				set	dt_recebimento_inconsistencia	= clock_timestamp(),
					ie_inconsistencia		= ie_inconsistencia_arquivo_w,
					ds_mensagem_inconsistencia	= ds_inconsistencia_arquivo_w,
					dt_atualizacao			= clock_timestamp(),
					nm_usuario			= current_setting('pls_ecarta_integracao_pck.nm_usuario_w')::usuario.nm_usuario%type
				where	nr_sequencia			= current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_lote_w')::pls_ecarta_lote.nr_sequencia%type;

				-- Verifica se a inconsistência de arquivo enviada existe no domínio
				if (ie_inconsistencia_arquivo_w IS NOT NULL AND ie_inconsistencia_arquivo_w::text <> '') and (coalesce(obter_valor_dominio(cd_dom_incons_w, ie_inconsistencia_arquivo_w)::text, '') = '') then
					-- Inclui log de alerta
					CALL CALL pls_ecarta_integracao_pck.incluir_log(	'A', 'A inconsistência de arquivo: "' || ie_inconsistencia_arquivo_w|| ': ' || ds_inconsistencia_arquivo_w ||
							'" não existe no domínio "' || pls_ecarta_integracao_pck.obter_descricao_dominio(cd_dom_incons_w) || ' (' || cd_dom_incons_w || ')"!');
				end if;
			end if;
		else
			nr_seq_lote_w		:= current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_lote_w')::pls_ecarta_lote.nr_sequencia%type;
			PERFORM set_config('pls_ecarta_integracao_pck.nr_seq_ecarta_lote_w', null, false);
			CALL CALL pls_ecarta_integracao_pck.incluir_log('E', 'O lote: "' || nr_seq_lote_w || '" não existe ou está encerrado!', null, $$plsql_line);

			-- Retorna falha
			return false;
		end if;
	end if;

	-- Processa as solicitações
	for r02_w in c02_w loop
		-- Seta variáveis globais
		PERFORM set_config('pls_ecarta_integracao_pck.nr_seq_ecarta_solicitacao_w', r02_w.nr_solicitacao, false);

		-- Atualiza a solicitação
		if (current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_lote_w')::pls_ecarta_lote.nr_sequencia%(type IS NOT NULL AND type::text <> '') and current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_solicitacao_w')::pls_ecarta_solicitacao.nr_sequencia%(type IS NOT NULL AND type::text <> '')) then
			-- Verifica se a solicitação existe não está encerrada
			if (pls_ecarta_integracao_pck.obter_existencia_solicitacao(current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_lote_w')::pls_ecarta_lote.nr_sequencia%type, current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_solicitacao_w')::pls_ecarta_solicitacao.nr_sequencia%type)) then
				-- Atualiza a solicitação
				update	pls_ecarta_solicitacao
				set	dt_recebimento_inconsistencia	= clock_timestamp(),
					ie_inconsistencia		= r02_w.ie_inconsistencia_objeto,
					ds_mensagem_inconsistencia	= r02_w.ds_inconsistencia_objeto,
					dt_atualizacao			= clock_timestamp(),
					nm_usuario			= current_setting('pls_ecarta_integracao_pck.nm_usuario_w')::usuario.nm_usuario%type
				where	nr_sequencia			= current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_solicitacao_w')::pls_ecarta_solicitacao.nr_sequencia%type;

				-- Verifica se a inconsistência de solicitação enviada existe no domínio
				if (r02_w.ie_inconsistencia_objeto IS NOT NULL AND r02_w.ie_inconsistencia_objeto::text <> '') and (coalesce(obter_valor_dominio(cd_dom_incons_w, r02_w.ie_inconsistencia_objeto)::text, '') = '') then
					-- Inclui log de alerta
					CALL CALL pls_ecarta_integracao_pck.incluir_log(	'A', 'A inconsistência de solicitação: "' || r02_w.ie_inconsistencia_objeto || ': ' || r02_w.ds_inconsistencia_objeto ||
							'" não existe no domínio "' || pls_ecarta_integracao_pck.obter_descricao_dominio(cd_dom_incons_w) || ' (' || cd_dom_incons_w || ')"!');
				end if;

				-- Inclui arquivo zip de inconsistência para todas as solicitações do xml
				pls_arquivo_w.nr_seq_ecarta_solicitacao := current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_solicitacao_w')::pls_ecarta_solicitacao.nr_sequencia%type;
				pls_arquivo_w.nm_arquivo 		:= nm_arq_zip_p;
				pls_arquivo_w.ds_caminho 		:= current_setting('pls_ecarta_integracao_pck.pls_parametro_t')::pls_parametro_r.ds_dir_inconsistencias_comp;
				CALL pls_ecarta_integracao_pck.atualizar_arquivo(pls_arquivo_w);

				-- Seta variáveis globais
				PERFORM set_config('pls_ecarta_integracao_pck.nm_procedimento_w', 'ler arquivo de inconsistência de lote enviado', false);
			else
				PERFORM set_config('pls_ecarta_integracao_pck.nr_seq_ecarta_solicitacao_w', null, false);
				CALL CALL pls_ecarta_integracao_pck.incluir_log('E', 'A solicitação: "' || r02_w.nr_solicitacao || '" não existe, está encerrada ou não pertence ao lote "' || current_setting('pls_ecarta_integracao_pck.nr_seq_ecarta_lote_w')::pls_ecarta_lote.nr_sequencia%type|| '"!', null, $$plsql_line);

				-- Retorna falha
				return false;
			end if;
		end if;
	end loop;

	-- Seta variáveis globais
	PERFORM set_config('pls_ecarta_integracao_pck.nr_seq_ecarta_solicitacao_w', null, false);
	PERFORM set_config('pls_ecarta_integracao_pck.nm_procedimento_w', 'buscar lotes', false);

	-- Retorna sucesso
	return true;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_ecarta_integracao_pck.ler_arquivo_inconsistencia ( ds_caminho_p pls_ecarta_arquivo_solic.ds_caminho%type, nm_arquivo_p pls_ecarta_arquivo_solic.nm_arquivo%type, nm_arq_zip_p pls_ecarta_arquivo_solic.nm_arquivo%type) FROM PUBLIC;
