-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--
-- dblink wrapper to call function ish_rzv_insurance_pck.get_se_conv_integrado_case() as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE FUNCTION ish_rzv_insurance_pck.get_se_conv_integrado_case ( nr_seq_episodio_p bigint, cd_convenio_p bigint) RETURNS varchar AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

	v_ret	varchar;
BEGIN
	v_query := 'SELECT * FROM ish_rzv_insurance_pck.get_se_conv_integrado_case_atx ( ' || quote_nullable(nr_seq_episodio_p) || ',' || quote_nullable(cd_convenio_p) || ' )';
	SELECT * INTO v_ret FROM dblink(v_conn_str, v_query) AS p (ret varchar);
	RETURN v_ret;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE FUNCTION ish_rzv_insurance_pck.get_se_conv_integrado_case_atx ( nr_seq_episodio_p bigint, cd_convenio_p bigint) RETURNS varchar AS $body$
DECLARE

	
ds_retorno_w	varchar(1) := 'N';
BEGIN

begin
select	'S'
into STRICT	ds_retorno_w
from	atend_categoria_convenio a,
	atendimento_paciente b
where	a.nr_atendimento	= b.nr_atendimento
and	a.cd_convenio		= cd_convenio_p
and	b.nr_seq_episodio	= nr_seq_episodio_p
and	exists (SELECT 1
	from	 conversao_meio_externo x,
		 intpd_eventos_sistema y
	where	 y.nr_seq_regra_conv	= x.nr_seq_regra
	and	 y.ds_action		in ('_-rzvish_-insuranceCreate','_-rzvish_-insuranceChange')
	and	 y.ie_situacao		= 'A'
	and	 x.nm_tabela 		= 'ATEND_CATEGORIA_CONVENIO'
	and	 x.nm_atributo 		= 'NR_SEQ_INTERNO'
	and	 x.cd_interno		= a.nr_seq_interno)  LIMIT 1;
exception
when others then
	begin
	select	'S'
	into STRICT	ds_retorno_w
	from	atend_categoria_convenio a,
		atendimento_paciente b
	where	a.nr_atendimento	= b.nr_atendimento
	and	a.cd_convenio		= cd_convenio_p
	and	b.nr_seq_episodio	= nr_seq_episodio_p
	and	exists (SELECT 1
		from	 intpd_fila_transmissao x,
			 intpd_eventos_sistema y
		where	 x.nr_seq_evento_sistema = y.nr_sequencia
		and	 y.ds_action in ('_-rzvish_-insuranceCreate','_-rzvish_-insuranceChange')		
		and	 x.nr_seq_documento = b.nr_atendimento || current_setting('ish_rzv_insurance_pck.ds_separador_w')::varchar(10) || a.nr_seq_interno || current_setting('ish_rzv_insurance_pck.ds_separador_w')::varchar(10) || b.nr_seq_episodio)  LIMIT 1;
	exception
	when others then
		ds_retorno_w := 'N';
	end;	
end;

return	ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ish_rzv_insurance_pck.get_se_conv_integrado_case ( nr_seq_episodio_p bigint, cd_convenio_p bigint) FROM PUBLIC; -- REVOKE ALL ON FUNCTION ish_rzv_insurance_pck.get_se_conv_integrado_case_atx ( nr_seq_episodio_p bigint, cd_convenio_p bigint) FROM PUBLIC;
