-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION doc_export_auto_pkg.split_text (DS_TEXT_P RELATORIO_DINAMICO.DS_SQL%TYPE, DS_SPLITER_P RELATORIO_DINAMICO.DS_LABEL%TYPE) RETURNS SETOF T_TAB_TEXT AS $body$
DECLARE


    C_TEXTS CURSOR FOR
      SELECT SUBSTR(DS_TEXT_P,
                    NR_START_TEXT,
                    CASE WHEN NR_END_TEXT=0 THEN                            LENGTH(DS_TEXT_P) + 1  ELSE NR_END_TEXT END
                    - NR_START_TEXT) DS_TEXT
        FROM (WITH RECURSIVE cte AS (
SELECT CASE WHEN LEVEL=1 THEN  1  ELSE REGEXP_INSTR(DS_TEXT_P, DS_SPLITER_P, 1, LEVEL - 1, 1) END  NR_START_TEXT,
                     REGEXP_INSTR(DS_TEXT_P, DS_SPLITER_P, 1, LEVEL) NR_END_TEXT
                
             CASE WHEN LEVEL=1 THEN  1  ELSE REGEXP_INSTR(DS_TEXT_P, DS_SPLITER_P, 1, LEVEL - 1, 1) END  > 0  UNION ALL
SELECT CASE WHEN LEVEL=1 THEN  1  ELSE REGEXP_INSTR(DS_TEXT_P, DS_SPLITER_P, 1, LEVEL - 1, 1) END  NR_START_TEXT,
                     REGEXP_INSTR(DS_TEXT_P, DS_SPLITER_P, 1, LEVEL) NR_END_TEXT
                
             CASE WHEN LEVEL=1 THEN  1  ELSE REGEXP_INSTR(DS_TEXT_P, DS_SPLITER_P, 1, LEVEL - 1, 1) END  > 0 JOIN cte c ON ()

) SELECT * FROM cte;
) alias5;

    R_TEXTS T_TAB_TEXT;


BEGIN

    IF (DS_TEXT_P IS NOT NULL AND DS_TEXT_P::text <> '') AND (DS_SPLITER_P IS NOT NULL AND DS_SPLITER_P::text <> '') THEN
      BEGIN
        OPEN C_TEXTS;
        LOOP
          FETCH C_TEXTS BULK COLLECT INTO R_TEXTS LIMIT 100;
          EXIT WHEN R_TEXTS.COUNT = 0;

          FOR i IN R_TEXTS.FIRST..R_TEXTS.LAST LOOP

            RETURN NEXT R_TEXTS(i);

          END LOOP;

        END LOOP;
        CLOSE C_TEXTS;
      EXCEPTION WHEN OTHERS THEN
        IF C_TEXTS%ISOPEN THEN
          CLOSE C_TEXTS;
        END IF;
      END;

    END IF;

    RETURN;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION doc_export_auto_pkg.split_text (DS_TEXT_P RELATORIO_DINAMICO.DS_SQL%TYPE, DS_SPLITER_P RELATORIO_DINAMICO.DS_LABEL%TYPE) FROM PUBLIC;
