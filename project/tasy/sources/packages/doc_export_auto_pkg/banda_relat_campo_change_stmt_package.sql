-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE doc_export_auto_pkg.banda_relat_campo_change_stmt () AS $body$
DECLARE


    DS_TABLES_W RELATORIO_DINAMICO.DS_SQL%TYPE;

    C_01 CURSOR(NR_SEQ_BND_P RELATORIO.NR_SEQUENCIA%TYPE) FOR
      SELECT A.NR_SEQUENCIA,
             A.NR_SEQ_RELATORIO
        FROM RELATORIO_AUTO_IMP A,
             BANDA_RELATORIO B
       WHERE A.NR_SEQ_RELATORIO = B.NR_SEQ_RELATORIO
         AND B.NR_SEQUENCIA = NR_SEQ_BND_P
         AND A.IE_EXPORTAR_DOCUMENTO = 'S';

    TYPE T_SEQ IS TABLE OF RELATORIO_AUTO_IMP.NR_SEQUENCIA%TYPE;
    TYPE T_REL IS TABLE OF RELATORIO_AUTO_IMP.NR_SEQ_RELATORIO%TYPE;

    R_SEQ T_SEQ;
    R_REL T_REL;

    C_TABLES CURSOR(DS_TABLES_P RELATORIO_DINAMICO.DS_SQL%TYPE) FOR
      SELECT COLUMN_VALUE
        FROM TABLE(DOC_EXPORT_AUTO_PKG.SPLIT_TEXT(DS_TABLES_P, ';'));

    R_TABLES T_TAB_TEXT;


BEGIN

    IF current_setting('doc_export_auto_pkg.r_tab_cmps')::T_TAB_CMPS.COUNT > 0 THEN

      FOR i IN current_setting('doc_export_auto_pkg.r_tab_cmps')::T_TAB_CMPS.FIRST..R_TAB_CMPS.LAST LOOP

        OPEN C_01(current_setting('doc_export_auto_pkg.r_tab_cmps')::T_TAB_CMPS[i].NR_SEQ_BANDA);
        LOOP
          FETCH C_01 BULK COLLECT INTO R_SEQ, R_REL LIMIT 100;
          EXIT WHEN R_SEQ.COUNT = 0;

          FORALL j IN R_SEQ.FIRST .. R_SEQ.LAST
          DELETE FROM DOC_EXPORT_MONIT WHERE NR_SEQ_AUTO_IMP = R_SEQ(j);

          FOR j IN R_SEQ.FIRST .. R_SEQ.LAST LOOP

            DS_TABLES_W := DOC_EXPORT_AUTO_PKG.GET_REPORT_TABLES(R_REL(j),
                                                                 NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 current_setting('doc_export_auto_pkg.r_tab_cmps')::T_TAB_CMPS[i].NR_SEQUENCIA,
                                                                 current_setting('doc_export_auto_pkg.r_tab_cmps')::T_TAB_CMPS[i].DS_SQL_NEW);

            IF (DS_TABLES_W IS NOT NULL AND DS_TABLES_W::text <> '') THEN

              OPEN C_TABLES(DS_TABLES_W);
              LOOP
                FETCH C_TABLES BULK COLLECT INTO R_TABLES LIMIT 100;
                EXIT WHEN R_TABLES.COUNT = 0;

                FOR k IN R_TABLES.FIRST..R_TABLES.LAST LOOP
                  CALL doc_export_auto_pkg.insert_doc_monit(R_SEQ(j),R_TABLES(k));
                END LOOP;

              END LOOP;
              CLOSE C_TABLES;

            END IF;

          END LOOP;

        END LOOP;
        CLOSE C_01;

      END LOOP;
      current_setting('doc_export_auto_pkg.r_tab_cmps')::T_TAB_CMPS.delete;

    END IF;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE doc_export_auto_pkg.banda_relat_campo_change_stmt () FROM PUBLIC;
