-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE doc_export_auto_pkg.banda_relat_change_stmt () AS $body$
DECLARE


    DS_TABLES_W RELATORIO_DINAMICO.DS_SQL%TYPE;

    C_01 CURSOR(NR_SEQ_REPORT_P RELATORIO.NR_SEQUENCIA%TYPE) FOR
      SELECT NR_SEQUENCIA
        FROM RELATORIO_AUTO_IMP
       WHERE NR_SEQ_RELATORIO = NR_SEQ_REPORT_P
         AND IE_EXPORTAR_DOCUMENTO = 'S';

    TYPE T_01 IS TABLE OF RELATORIO_AUTO_IMP.NR_SEQUENCIA%TYPE;
    R_01 T_01;

    C_TABLES CURSOR(DS_TABLES_P RELATORIO_DINAMICO.DS_SQL%TYPE) FOR
      SELECT COLUMN_VALUE DS_TABLE
        FROM TABLE(DOC_EXPORT_AUTO_PKG.SPLIT_TEXT(DS_TABLES_P, ';'));

    R_TABLES T_TAB_TEXT;


BEGIN

    IF current_setting('doc_export_auto_pkg.r_tab_bnds')::T_TAB_BNDS.COUNT > 0 THEN

      FOR i IN current_setting('doc_export_auto_pkg.r_tab_bnds')::T_TAB_BNDS.FIRST..R_TAB_BNDS.LAST LOOP

        OPEN C_01(current_setting('doc_export_auto_pkg.r_tab_bnds')::T_TAB_BNDS[i].NR_SEQ_RELAT);
        LOOP
          FETCH C_01 BULK COLLECT INTO R_01 LIMIT 100;
          EXIT WHEN R_01.COUNT = 0;

          FORALL j IN R_01.FIRST .. R_01.LAST
          DELETE FROM DOC_EXPORT_MONIT WHERE NR_SEQ_AUTO_IMP = R_01(j);

          FOR j IN R_01.FIRST .. R_01.LAST LOOP

            DS_TABLES_W := DOC_EXPORT_AUTO_PKG.GET_REPORT_TABLES(current_setting('doc_export_auto_pkg.r_tab_bnds')::T_TAB_BNDS[i].NR_SEQ_RELAT,
                                                                 NULL,
                                                                 NULL,
                                                                 current_setting('doc_export_auto_pkg.r_tab_bnds')::T_TAB_BNDS[i].NR_SEQUENCIA,
                                                                 current_setting('doc_export_auto_pkg.r_tab_bnds')::T_TAB_BNDS[i].DS_SQL_NEW,
                                                                 NULL,
                                                                 NULL);

            IF (DS_TABLES_W IS NOT NULL AND DS_TABLES_W::text <> '') THEN

              OPEN C_TABLES(DS_TABLES_W);
              LOOP
                FETCH C_TABLES BULK COLLECT INTO R_TABLES LIMIT 100;
                EXIT WHEN R_TABLES.COUNT = 0;

                FOR k IN R_TABLES.FIRST..R_TABLES.LAST LOOP
                  CALL doc_export_auto_pkg.insert_doc_monit(R_01(j), R_TABLES(k));
                END LOOP;

              END LOOP;
              CLOSE C_TABLES;

            END IF;

          END LOOP;

        END LOOP;
        CLOSE C_01;

      END LOOP;
      current_setting('doc_export_auto_pkg.r_tab_bnds')::T_TAB_BNDS.delete;

    END IF;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE doc_export_auto_pkg.banda_relat_change_stmt () FROM PUBLIC;
