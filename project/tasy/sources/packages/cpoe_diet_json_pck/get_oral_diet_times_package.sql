-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION cpoe_diet_json_pck.get_oral_diet_times (nr_cpoe_diet_p bigint) RETURNS PHILIPS_JSON_LIST AS $body$
DECLARE

	json_item_w		philips_json;
	json_item_list_w	philips_json_list;
	
	C01 CURSOR FOR
		SELECT a.NR_SEQUENCIA,
			a.IE_TIPO_DIETA,
			a.DT_LIBERACAO, 
			a.DT_LIB_SUSPENSAO, 
			a.DT_INICIO, 
			a.DT_FIM, 
			a.IE_DURACAO, 
			a.IE_URGENCIA, 
			a.NR_SEQ_OBJETIVO,
			a.CD_DIETA,
			a.DT_ATUALIZACAO,
			cpoe_obter_dt_suspensao(a.nr_sequencia,'N') dt_suspensao,
			obter_se_intervalo_sn(a.cd_intervalo)   ie_sn,
			obter_se_intervalo_acm(a.cd_intervalo)  ie_acm,
			obter_se_intervalo_agora(a.cd_intervalo) ie_agora,
			a.CD_INTERVALO,
			a.NR_SEQ_PERFIL_CAL, 
			substr(OBTER_DESC_DIETA(a.CD_DIETA),1,200) desc_tipo_dieta, 
			CASE WHEN coalesce(a.DS_OBSERVACAO::text, '') = '' THEN ''  ELSE '. ' ||elimina_acentuacao(a.DS_OBSERVACAO) END  DS_OBSERVACAO, 
			CASE WHEN coalesce(a.DS_JUSTIFICATIVA::text, '') = '' THEN ''  ELSE '. ' ||elimina_acentuacao(a.DS_JUSTIFICATIVA) END  DS_JUSTIFICATIVA, 
			obter_conv_envio('CPOE_DIETA', 'IE_TIPO_DIETA', a.IE_TIPO_DIETA, 'E') diet_type_value,
			a.cd_medico ordering_provider_id_number,
			obter_dados_pf(a.cd_medico,'PNG') ordering_provider_given_name,
			obter_dados_pf(a.cd_medico,'PNL') ordering_provider_last_name,
			obter_dados_pf(a.cd_medico,'PNM') ordering_provider_middle_name, 
			substr(obter_nome_pf(a.cd_medico),1,80) nm_medico_solicitante,
			Obter_Pessoa_Fisica_Usuario(a.nm_usuario_nrec,'C') ordering_user_id_number,
			Obter_Pessoa_Fisica_Usuario(a.nm_usuario_susp,'C') order_prov_susp_id_number,		
			obter_conv_envio('DIETA', 'CD_DIETA', a.cd_dieta, 'E')  code_value,
			obter_conv_envio('DIETA', 'CD_DIETA', a.cd_dieta, 'S')  code_system
		from CPOE_DIETA a
		where a.NR_SEQUENCIA = nr_cpoe_diet_p 
		AND a.IE_TIPO_DIETA = 'O';

		
	
BEGIN
	json_item_list_w	:= philips_json_list();
	
	for r_c01 in c01 loop
		begin
		json_item_w		:= philips_json();
		
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'nrSequencia', r_c01.nr_sequencia);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'ieTipoDieta', r_c01.ie_tipo_dieta);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'dtLiberacao', r_c01.dt_liberacao);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'dtLibSuspensao', r_c01.dt_lib_suspensao);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'dtInicio', r_c01.dt_inicio);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'dtFim', r_c01.dt_fim);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'ieDuracao', r_c01.ie_duracao);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'ieUrgencia', r_c01.ie_urgencia);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'nrSeqObjetivo', r_c01.nr_seq_objetivo);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'cdDieta', r_c01.cd_dieta);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'dtAtualizacao', r_c01.dt_atualizacao);	
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'dtSuspensao', r_c01.dt_suspensao);	
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'ieSn', r_c01.ie_sn);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'ieAcm', r_c01.ie_acm);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'ieAgora', r_c01.ie_agora);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'cdIntervalo', r_c01.cd_intervalo);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'nrSeqPerfilCal', r_c01.nr_seq_perfil_cal);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'descTipoDieta', r_c01.desc_tipo_dieta);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'dsObservacao', r_c01.ds_observacao);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'dsJustificativa', r_c01.ds_justificativa);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'dietTypeValue', r_c01.diet_type_value);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'orderingProviderIdNumber', coalesce(r_c01.order_prov_susp_id_number, r_c01.ordering_provider_id_number));
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'orderingProviderGivenName', r_c01.ordering_provider_given_name);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'orderingProviderLastName', r_c01.ordering_provider_last_name);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'orderingProviderMiddleName', r_c01.ordering_provider_middle_name);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'nmMedicoSolicitante', r_c01.nm_medico_solicitante);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'orderingUserIdNumber', r_c01.ordering_user_id_number);

		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'orderProvSuspIdNumber', r_c01.order_prov_susp_id_number);
		
		if (r_c01.dt_fim IS NOT NULL AND r_c01.dt_fim::text <> '') then
				json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'numberOfDays', OBTER_DIAS_ENTRE_DATAS(r_c01.dt_inicio, r_c01.dt_fim));
		end if;
		
		if (r_c01.ie_sn = 'S' or r_c01.ie_acm = 'S') then
			json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'priority', 'PRN');
		elsif (r_c01.ie_agora = 'S' and r_c01.ie_urgencia = '0') then
			json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'priority', 'S');
		elsif (r_c01.ie_agora = 'S' and r_c01.ie_urgencia = '5') then
			json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'priority', 'TM5');
		elsif (r_c01.ie_agora = 'S' and r_c01.ie_urgencia = '10') then
			json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'priority', 'TM10');
		elsif (r_c01.ie_agora = 'S' and r_c01.ie_urgencia = '15') then
			json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'priority', 'TM15');
		else
			json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'priority', 'R');
		end if;

		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'enteredBy', coalesce(r_c01.order_prov_susp_id_number, r_c01.ordering_user_id_number));
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'effectiveDate', coalesce(r_c01.dt_lib_suspensao, r_c01.dt_liberacao));
		
		if (coalesce(r_c01.desc_tipo_dieta::text, '') = '')
			or (coalesce(r_c01.code_system::text, '') = '')
			or (coalesce(r_c01.code_value::text, '') = '') then
			begin
				select b.DS_COMPOSICAO desc_tipo_dieta,
					   obter_conv_envio('COMPOSICAO_DIETA', 'NR_SEQUENCIA', b.NR_SEQUENCIA, 'S')  code_system,
					   obter_conv_envio('COMPOSICAO_DIETA', 'NR_SEQUENCIA', b.NR_SEQUENCIA, 'E') code_value
				into STRICT r_c01.desc_tipo_dieta,
					r_c01.code_system,
					r_c01.code_value
				from DIETA_COMPOSICAO  a,
					COMPOSICAO_DIETA b 
				where cd_dieta = r_c01.cd_dieta
				and  b.nr_sequencia = a.nr_seq_composicao;
			exception
				when no_data_found then
					r_c01.desc_tipo_dieta := null;
					r_c01.code_value := null;
					r_c01.code_system := null;
			end;
		end if;
		
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'descDieta', r_c01.desc_tipo_dieta);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'codeValue', r_c01.code_value);
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'codeSystem', r_c01.code_system);
		
		json_item_w := cpoe_diet_json_pck.add_json_value(json_item_w, 'testInstruction', r_c01.ds_justificativa || '~' || r_c01.ds_observacao);

		json_item_list_w.append(json_item_w.to_json_value());
		end;
	end loop;
	
	return json_item_list_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION cpoe_diet_json_pck.get_oral_diet_times (nr_cpoe_diet_p bigint) FROM PUBLIC;
