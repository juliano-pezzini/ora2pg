-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_contab_onl_repasse_pck.contabiliza_item_repasse (doc_p INOUT ctb_documento) AS $body$
DECLARE



dados_contab_w ctb_contab_onl_lote_fin_pck.dados_contab_tf;

cd_empresa_w             empresa.cd_empresa%type;
ds_observacao_w          repasse_terceiro.ds_observacao%type;
ie_origem_documento_w    movimento_contabil.ie_origem_documento%type;
nr_documento_www         movimento_contabil.nr_documento%type;
ie_regra_w               varchar(255);
ds_conteudo_w            varchar(4000);
nr_nfe_conta_protocolo_w varchar(255);
nr_seq_protocolo_w       conta_paciente.nr_seq_protocolo%type;
nm_estabelecimento_w     estabelecimento.nm_fantasia_estab%type;
nr_atendimento_w         repasse_terceiro_item.nr_atendimento%type;
cd_pessoa_fisica_w       terceiro.cd_pessoa_fisica%type;
cd_cgc_w                 terceiro.cd_cgc%type;
cd_conta_contabil_w      repasse_terceiro_item.cd_conta_contabil_prov%type;
cd_centro_custo_w        repasse_terceiro_item.cd_centro_custo_prov%type;
nr_repasse_terceiro_w    repasse_terceiro_item.nr_repasse_terceiro%type;
nr_interno_conta_w       repasse_terceiro_item.nr_interno_conta%type;


BEGIN

begin
select  d.nr_atendimento   nr_atendimento,
        e.cd_pessoa_fisica     cd_pessoa_fisica,
        e.cd_cgc               cd_cgc,
        cd_conta_contabil_prov cd_conta_contabil,
        cd_centro_custo_prov   cd_centro_custo,
        d.nr_repasse_terceiro  nr_repasse_terceiro,
        d.nr_interno_conta     nr_interno_conta
into STRICT    nr_atendimento_w,
        cd_pessoa_fisica_w,
        cd_cgc_w,
        cd_conta_contabil_w,
        cd_centro_custo_w,
        nr_repasse_terceiro_w,
        nr_interno_conta_w
from    terceiro e,
        repasse_terceiro_item d
where   d.nr_seq_terceiro = e.nr_sequencia
and     d.nr_sequencia = doc_p.nr_documento;
exception when no_data_found then
    null;
end;

cd_empresa_w := obter_empresa_estab(doc_p.cd_estabelecimento);

if (coalesce(nr_repasse_terceiro_w,0) <> 0) then
    begin
    select a.ds_observacao
    into STRICT   ds_observacao_w
    from   repasse_terceiro a
    where  a.nr_repasse_terceiro = nr_repasse_terceiro_w;
    exception when others then
        ds_observacao_w := '';
    end;
end if;

nr_documento_www      := null;
ie_origem_documento_w := null;

ctb_obter_doc_movto(doc_p.cd_tipo_lote_contabil,
            doc_p.nm_atributo,
            'VR',
            doc_p.dt_competencia,
            null,
            null,
            doc_p.nm_atributo,
            doc_p.nm_usuario,
            ie_regra_w,
            nr_documento_www,
            ie_origem_documento_w);

/* dados para geracao do complemento de historico */

begin
select (nm_fantasia_estab)
into STRICT   nm_estabelecimento_w
from   estabelecimento
where  cd_estabelecimento = doc_p.cd_estabelecimento;
exception when others then
    nm_estabelecimento_w    := '';
end;

if (coalesce(nr_interno_conta_w, 0) <> 0) then
    begin
    select nr_seq_protocolo
    into STRICT   nr_seq_protocolo_w
    from   conta_paciente
    where  nr_interno_conta = nr_interno_conta_w;
    exception when others then
        nr_seq_protocolo_w  := null;
    end;
end if;

if (nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') then
    begin
    select max(substr(obter_nfe_conta_protocolo(nr_seq_protocolo, 0),1,254))
    into STRICT   nr_nfe_conta_protocolo_w
    from   nota_fiscal x
    where  x.nr_sequencia = ( SELECT max(nr_sequencia)
                from    nota_fiscal
                where   nr_seq_protocolo = nr_seq_protocolo_w);
    end;
elsif (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') then
    begin
    select max(substr(obter_nfe_conta_protocolo(0, nr_interno_conta),1,254))
    into STRICT   nr_nfe_conta_protocolo_w
    from   nota_fiscal x
    where  x.nr_sequencia = ( SELECT max(nr_sequencia)
                from   nota_fiscal
                where  nr_interno_conta = nr_interno_conta_w);
    end;
end if;

CALL ctb_online_pck.definir_atrib_compl(doc_p.cd_tipo_lote_contabil);
CALL ctb_online_pck.set_value_compl_hist('NM_BENEFICIARIO', substr(obter_nome_pf_pj(cd_pessoa_fisica_w,cd_cgc_w),1,80));
CALL ctb_online_pck.set_value_compl_hist('DS_CONVENIO', '');
CALL ctb_online_pck.set_value_compl_hist('NR_ATENDIMENTO', nr_atendimento_w);
CALL ctb_online_pck.set_value_compl_hist('NR_REPASSE_TERCEIRO', nr_repasse_terceiro_w);
CALL ctb_online_pck.set_value_compl_hist('DS_TITULOS', substr(OBTER_TITULO_REPASSE(nr_repasse_terceiro_w),1,255));
CALL ctb_online_pck.set_value_compl_hist('NR_INTERNO_CONTA', nr_interno_conta_w);
CALL ctb_online_pck.set_value_compl_hist('CD_REGRA', 0);
CALL ctb_online_pck.set_value_compl_hist('VL_REPASSE', doc_p.vl_movimento);
CALL ctb_online_pck.set_value_compl_hist('NM_ESTABELECIMENTO', nm_estabelecimento_w);
CALL ctb_online_pck.set_value_compl_hist('DS_ESTORNO','');
CALL ctb_online_pck.set_value_compl_hist('NR_NFE_CONTA_PROTOCOLO', nr_nfe_conta_protocolo_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBSERVACAO', ds_observacao_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_FISCAL', null);
CALL ctb_online_pck.set_value_compl_hist('DT_CONTA_PROTOCOLO', null);
CALL ctb_online_pck.set_value_compl_hist('NM_BENEFICIARIO_ANT', '');
CALL ctb_online_pck.set_value_compl_hist('NR_LOTE_CONTABIL_ANT', null);
CALL ctb_online_pck.set_value_compl_hist('NR_ATEND_ESTORNO', null);
CALL ctb_online_pck.set_value_compl_hist('NM_MEDICO_EXECUTOR', '');
CALL ctb_online_pck.set_value_compl_hist('DS_RESPONSAVEL_CREDITO', '');
CALL ctb_online_pck.set_value_compl_hist('DS_SETOR_ATENDIMENTO', '');
CALL ctb_online_pck.set_value_compl_hist('NR_CONTA_ESTORNO', null);

/* Carrega atributos Contab. Trans. financ*/

dados_contab_w.cd_estab_movto      := doc_p.cd_estabelecimento;
dados_contab_w.dt_transacao        := doc_p.dt_competencia;
dados_contab_w.cd_conta_contabil   := cd_conta_contabil_w;
dados_contab_w.cd_centro_custo     := cd_centro_custo_w;
dados_contab_w.nr_seq_agrupamento  := doc_p.nr_seq_doc_compl;
dados_contab_w.ie_origem_documento := ie_origem_documento_w;
dados_contab_w.cd_pessoa_fisica    := cd_pessoa_fisica_w;
dados_contab_w.cd_cnpj             := cd_cgc_w;
dados_contab_w.nr_repasse_terceiro := nr_repasse_terceiro_w;
dados_contab_w.nr_seq_trans_fin    := doc_p.nr_seq_trans_financ;
dados_contab_w.nm_tabela           := 'REPASSE_TERCEIRO_ITEM';
dados_contab_w.nm_atributo         := doc_p.nm_atributo;
dados_contab_w.doc                 := doc_p;

/* Contabilizacao por Transacao Financeira */

ctb_contab_onl_lote_fin_pck.contabiliza_trans_financ(dados_contab_w,
                           doc_p.nm_usuario);

doc_p := dados_contab_w.doc;

/* atualizarepasse_terceiro_item */

if (coalesce(dados_contab_w.doc.ds_inconsistencia::text, '') = '') then

 update repasse_terceiro_item
 set    nr_lote_contabil_prov = doc_p.nr_lote_contabil
 where  nr_sequencia = doc_p.nr_documento;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_repasse_pck.contabiliza_item_repasse (doc_p INOUT ctb_documento) FROM PUBLIC;
