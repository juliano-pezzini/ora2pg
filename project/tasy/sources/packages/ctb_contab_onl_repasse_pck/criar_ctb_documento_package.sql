-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_contab_onl_repasse_pck.criar_ctb_documento ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, nm_usuario_p text, doc_p INOUT ctb_documento) AS $body$
DECLARE


nr_documento_w          ctb_documento.nr_documento%type := null;
nm_tabela_w             ctb_documento.nm_tabela%type    := 'PROTOCOLO_CONVENIO';
nm_atributo_w           ctb_documento.nm_atributo%type  := 'NR_SEQ_PROTOCOLO';
vl_movimento_w          ctb_documento.vl_movimento%type := 0;
doc_w                   ctb_documento%rowtype;


BEGIN

doc_p   := null;

if (coalesce(nr_interno_conta_p,0) != 0) then
    begin
    nm_tabela_w := 'CONTA_PACIENTE';
    nm_atributo_w   := 'NR_INTERNO_CONTA';
    nr_documento_w  := nr_interno_conta_p;

    select  dt_mesano_referencia
    into STRICT    doc_w.dt_competencia
    from    conta_paciente
    where   nr_interno_conta    = nr_interno_conta_p;


    select  coalesce(sum(x.vl_repasse),0)
    into STRICT    vl_movimento_w
    from (SELECT sum(a.vl_repasse) vl_repasse
            from    procedimento_repasse a,
                    procedimento_paciente b
            where   a.nr_seq_procedimento   = b.nr_sequencia
            and     b.nr_interno_conta  = nr_interno_conta_p

union all

            SELECT  sum(a.vl_repasse) vl_repasse
            from    material_repasse a,
                    material_atend_paciente b
            where   a.nr_seq_material   = b.nr_sequencia

            and b.nr_interno_conta  = nr_interno_conta_p) x
    where   1 = 1;

    end;
elsif (coalesce(nr_seq_protocolo_p,0) != 0) then
    begin
    nr_documento_w  := nr_seq_protocolo_p;


    select  dt_mesano_referencia
    into STRICT    doc_w.dt_competencia
    from    protocolo_convenio
    where   nr_seq_protocolo    = nr_seq_protocolo_p;

    select  coalesce(sum(x.vl_repasse),0)
    into STRICT    vl_movimento_w
    from (SELECT sum(a.vl_repasse) vl_repasse
            from    conta_paciente c,
                    procedimento_repasse a,
                    procedimento_paciente b
            where   a.nr_seq_procedimento   = b.nr_sequencia
            and     c.nr_interno_conta  = b.nr_interno_conta
            and     c.nr_seq_protocolo  = nr_seq_protocolo_p

union all

            SELECT  sum(a.vl_repasse) vl_repasse
            from    conta_paciente c,
                    material_repasse a,
                    material_atend_paciente b
            where   a.nr_seq_material   = b.nr_sequencia
            and     c.nr_interno_conta  = b.nr_interno_conta
            and     c.nr_seq_protocolo  = nr_seq_protocolo_p) x
    where   1 = 1;

    end;

end if;

if (vl_movimento_w != 0) then

    CALL ctb_concil_financeira_pck.ctb_gravar_documento(
                    cd_estabelecimento_p    => cd_estabelecimento_p,
                    dt_competencia_p    => doc_w.dt_competencia,
                    cd_tipo_lote_contabil_p => 14,
                    nr_seq_trans_financ_p   => null,
                    nr_seq_info_p       => 69,
                    nr_documento_p      => nr_documento_w,
                    nr_seq_doc_compl_p  => nr_interno_conta_p,
                    nr_doc_analitico_p  => null,
                    vl_movimento_p      => vl_movimento_w,
                    nm_tabela_p     => nm_tabela_w,
                    nm_atributo_p       => nm_atributo_w,
                    nm_usuario_p        => nm_usuario_p,
                    ie_situacao_ctb_p   => 'N',
                    ds_origem_p     => null);
    begin
    select  a.*
    into STRICT    doc_w
    from    ctb_documento a
    where   a.cd_estabelecimento    = cd_estabelecimento_p
    and     a.cd_tipo_lote_contabil = 14
    and     a.dt_competencia    = doc_w.dt_competencia
    and     a.nr_seq_info       = 69
    and     a.nm_tabela     = nm_tabela_w
    and     a.nm_atributo       = nm_atributo_w
    and     a.nr_documento      = nr_documento_w;

    doc_p   := doc_w;
    exception when others then
        doc_w   := null;
    end;

end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_repasse_pck.criar_ctb_documento ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, nm_usuario_p text, doc_p INOUT ctb_documento) FROM PUBLIC;
