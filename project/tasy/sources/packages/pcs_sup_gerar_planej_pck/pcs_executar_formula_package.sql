-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pcs_sup_gerar_planej_pck.pcs_executar_formula ( ds_macro_p text default null, nr_seq_grupamento_p bigint DEFAULT NULL, nr_seq_tipo_lista_p bigint DEFAULT NULL, ie_origem_pcs_p text DEFAULT NULL, nr_seq_relatorio_p bigint DEFAULT NULL, cd_responsavel_p text DEFAULT NULL, nr_ordem_servico_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE

 
cd_material_w				integer;
cd_empresa_w				smallint;
cd_estabelecimento_w		smallint;
nr_seq_segmento_w			bigint;
cd_local_estoque_w			smallint;

C01 CURSOR FOR 
	SELECT distinct cd_material, 
		cd_empresa, 
		cd_estabelecimento, 
		nr_seq_segmento 
	from	pcs_seg_compras_rel_item 
	where	nr_seq_relatorio = nr_seq_relatorio_p 
	and	nr_seq_grupamento = coalesce(nr_seq_grupamento_p,0) 
	and	coalesce(nr_seq_grupamento_p,0) > 0 
	and	((pcs_obter_tipo_lista(nr_seq_tipo_lista_p) not in ('LC','MLC')) or (coalesce(pcs_obter_tipo_lista(nr_seq_tipo_lista_p)::text, '') = '')) 
	and	ie_origem_pcs_p = 'C' 
	
union all
 
	SELECT distinct cd_material, 
		cd_empresa, 
		cd_estabelecimento, 
		nr_seq_segmento 
	from	pcs_seg_compras_rel_item 
	where	nr_seq_relatorio = nr_seq_relatorio_p 
	and	(nr_seq_tipo_lista_p IS NOT NULL AND nr_seq_tipo_lista_p::text <> '') 
	and	cd_pessoa_resp_lc = cd_responsavel_p 
	and	(((obter_dias_estoque_material(cd_estabelecimento,cd_material,nm_usuario_p) <= coalesce(qt_dias_corte_mlc,0)) and (pcs_obter_tipo_lista(nr_seq_tipo_lista_p) = 'MLC')) 
	or	((obter_dias_estoque_material(cd_estabelecimento,cd_material,nm_usuario_p) <= coalesce(qt_dias_corte_lc,0)) and (pcs_obter_tipo_lista(nr_seq_tipo_lista_p) = 'LC'))) 
	and	ie_origem_pcs_p = 'C' 
	
union all
 
	select distinct b.cd_material, 
		b.cd_empresa, 
		b.cd_estabelecimento, 
		b.nr_seq_segmento 
	from	pcs_segmento_compras_rel a, 
		pcs_seg_compras_rel_item b 
	where	a.nr_sequencia = b.nr_seq_relatorio 
	and	b.nr_seq_relatorio = nr_seq_relatorio_p 
	and	(nr_seq_tipo_lista_p IS NOT NULL AND nr_seq_tipo_lista_p::text <> '') 
	and	b.cd_pessoa_resp_lc = cd_responsavel_p 
	and	(b.dt_entrega_prevista_oc IS NOT NULL AND b.dt_entrega_prevista_oc::text <> '') 
	and	((pkg_date_utils.get_time(coalesce(b.dt_entrega_prevista_oc,clock_timestamp()), '00:00:00')	<= coalesce(dt_geracao,clock_timestamp())) and (pcs_obter_tipo_lista(nr_seq_tipo_lista_p) = 'PV')) 
	and	ie_origem_pcs_p = 'C' 
	
union all
 
	select	distinct c.cd_material, 
		a.cd_empresa, 
		c.cd_estabelecimento, 
		b.nr_sequencia 
	from	pcs_grupamentos a, 
		pcs_segmento b, 
		pcs_estrutura_segmento c 
	where	a.nr_sequencia = b.nr_seq_grupamento 
	and	a.nr_sequencia = c.nr_seq_grupamento 
	and	b.nr_sequencia = c.nr_seq_segmento 
	and	ie_origem_pcs_p = 'M' 
	and	exists (select	1 
			from	man_ordem_servico_mat x 
			where	x.nr_seq_ordem_serv = nr_ordem_servico_p 
			and	x.cd_material = c.cd_material);

 

BEGIN 
 
delete	FROM w_pcs_atributo_formula 
where	nm_usuario = nm_usuario_p;
 
 
open C01;
loop 
fetch C01 into 
	cd_material_w, 
	cd_empresa_w, 
	cd_estabelecimento_w, 
	nr_seq_segmento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	CALL pcs_sup_gerar_planej_pck.pcs_montar_consulta(cd_material_w,cd_estabelecimento_w,cd_empresa_w,nm_usuario_p);
 
 
	select max(cd_local_estoque) 
	into STRICT  cd_local_estoque_w 
	from  pcs_local_estoque_grup 
	where nr_seq_grupamento = nr_seq_grupamento_p 
	and	  cd_estab_regra = cd_estabelecimento_w;
 
	CALL pcs_sup_gerar_planej_pck.pcs_gerar_vl_formula(	ds_macro_p, 
							cd_material_w, 
							nr_seq_grupamento_p, 
							nr_seq_segmento_w, 
							cd_local_estoque_w, 
							cd_empresa_w, 
							cd_estabelecimento_w, 
							nm_usuario_p);
 
	end;
end loop;
close C01;
 
commit;
 
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_sup_gerar_planej_pck.pcs_executar_formula ( ds_macro_p text default null, nr_seq_grupamento_p bigint DEFAULT NULL, nr_seq_tipo_lista_p bigint DEFAULT NULL, ie_origem_pcs_p text DEFAULT NULL, nr_seq_relatorio_p bigint DEFAULT NULL, cd_responsavel_p text DEFAULT NULL, nr_ordem_servico_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;
