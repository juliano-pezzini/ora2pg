-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pkg_tie_account_batch.get_validations ( nr_lote_contabil_p lote_contabil.nr_lote_contabil%TYPE, nr_lote_externo_p lote_contabil.nr_lote_externo%TYPE, cd_estabelecimento_p lote_contabil.cd_estabelecimento%TYPE, ie_tipo_p bigint ) RETURNS varchar AS $body$
DECLARE

        ds_erro_w              varchar(500);
        cd_estabelecimento_w   lote_contabil.cd_estabelecimento%TYPE;
        ie_status_origem_w     varchar(10);

BEGIN
        IF ( coalesce(cd_estabelecimento_p::text, '') = '' ) THEN
            ds_erro_w := 'The establishment is a mandatory field.';
        ELSIF ( ( coalesce(nr_lote_contabil_p::text, '') = '' OR nr_lote_contabil_p = 0 /*Codigo 0 nao pode alterado*/
 ) AND ( coalesce(nr_lote_externo_p::text, '') = '' ) ) THEN
            ds_erro_w := 'You must enter an accounting batch or an external batch.';
        ELSE
            --validacao estabelecimento
            SELECT
                coalesce(MAX(cd_estabelecimento), NULL)
            INTO STRICT cd_estabelecimento_w
            FROM
                estabelecimento
            WHERE
                cd_estabelecimento = cd_estabelecimento_p;

            IF coalesce(cd_estabelecimento_w::text, '') = '' THEN
                ds_erro_w := 'There is no establishment '
                             || cd_estabelecimento_p
                             || ' registered in Tasy. ';
            END IF;

            IF (nr_lote_externo_p IS NOT NULL AND nr_lote_externo_p::text <> '') and coalesce(ds_erro_w::text, '') = '' THEN
                -- validacao lote externo  
                SELECT
                    coalesce(MAX(nr_lote_contabil), NULL),
                    MAX(ie_status_origem)
                INTO STRICT
                    current_setting('pkg_tie_account_batch.nr_lote_contabil_w')::lote_contabil.nr_lote_contabil%TYPE,
                    ie_status_origem_w
                FROM
                    lote_contabil
                WHERE
                    upper(trim(both nr_lote_externo)) = upper(trim(both nr_lote_externo_p))
                    AND cd_estabelecimento = cd_estabelecimento_p;

                IF ( current_setting('pkg_tie_account_batch.nr_lote_contabil_w')::lote_contabil.nr_lote_contabil%coalesce(TYPE::text, '') = '' ) THEN
                    ds_erro_w := ds_erro_w
                                 || ' There is no accounting batch number '
                                 || nr_lote_externo_p
                                 || ' registered in Tasy. ';
                END IF;

            END IF;

            --validacao lote_contabil
            IF (nr_lote_contabil_p IS NOT NULL AND nr_lote_contabil_p::text <> '') and coalesce(ds_erro_w::text, '') = '' THEN
                SELECT
                    coalesce(MAX(nr_lote_contabil), NULL),
                    MAX(ie_status_origem)
                INTO STRICT
                    current_setting('pkg_tie_account_batch.nr_lote_contabil_w')::lote_contabil.nr_lote_contabil%TYPE,
                    ie_status_origem_w
                FROM
                    lote_contabil
                WHERE
                    nr_lote_contabil = nr_lote_contabil_p
                    AND cd_estabelecimento = cd_estabelecimento_p;

                IF ( current_setting('pkg_tie_account_batch.nr_lote_contabil_w')::lote_contabil.nr_lote_contabil%coalesce(TYPE::text, '') = '' ) THEN
                    ds_erro_w := ds_erro_w
                                 || ' There is no accounting lot number '
                                 || nr_lote_contabil_p
                                 || ' registered in Tasy.';
                END IF;

            END IF;

            -- validacao IE_ORIGEM = TIE
            IF (coalesce(ie_status_origem_w::text, '') = '' OR ie_status_origem_w != 'TIE') and coalesce(ds_erro_w::text, '') = '' THEN
                IF ( ie_tipo_p = 1 ) THEN
                    ds_erro_w := ds_erro_w
                                 || ' Accounting batch number '
                                 || nr_lote_contabil_p
                                 || ' cannot be deleted as it does not belong to an integration.';
                ELSIF ( ie_tipo_p = 2 ) THEN
                    ds_erro_w := ds_erro_w
                                 || ' Accounting batch number '
                                 || nr_lote_contabil_p
                                 || ' cannot be undone as it does not belong to an integration.';
                END IF;
            END IF;

        END IF;

        RETURN ds_erro_w;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pkg_tie_account_batch.get_validations ( nr_lote_contabil_p lote_contabil.nr_lote_contabil%TYPE, nr_lote_externo_p lote_contabil.nr_lote_externo%TYPE, cd_estabelecimento_p lote_contabil.cd_estabelecimento%TYPE, ie_tipo_p bigint ) FROM PUBLIC;
