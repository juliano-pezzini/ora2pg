-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pkg_tie_account_batch.desfazer_lote_contabil ( cd_estabelecimento_p lote_contabil.cd_estabelecimento%TYPE, nr_lote_contabil_p lote_contabil.nr_lote_contabil%TYPE, nr_lote_externo_p lote_contabil.nr_lote_externo%TYPE, ds_erro_p INOUT text ) AS $body$
DECLARE

        cd_log_w                 bigint;
        ds_erro_w                varchar(255);
        dt_atualizacao_saldo_w   timestamp;

BEGIN
        ds_erro_p := pkg_tie_account_batch.get_validations(nr_lote_contabil_p, nr_lote_externo_p, cd_estabelecimento_p, 2);
        IF coalesce(ds_erro_p::text, '') = '' THEN
            BEGIN
                SELECT
                    MAX(dt_atualizacao_saldo)
                INTO STRICT dt_atualizacao_saldo_w
                FROM
                    lote_contabil
                WHERE
                    nr_lote_contabil = current_setting('pkg_tie_account_batch.nr_lote_contabil_w')::lote_contabil.nr_lote_contabil%TYPE;

                IF (dt_atualizacao_saldo_w IS NOT NULL AND dt_atualizacao_saldo_w::text <> '') THEN
                    ds_erro_w := substr('O lote (W/S): '
                                        || current_setting('pkg_tie_account_batch.nr_lote_contabil_w')::lote_contabil.nr_lote_contabil%TYPE
                                        || '/'
                                        || nr_lote_contabil_p
                                        || ' ja foi atualizado no Tasy!', 1, 255);

                END IF;

                IF ( coalesce(ds_erro_w, 'X') = 'X' ) THEN
                    BEGIN
                        DELETE FROM ctb_movimento
                        WHERE
                            nr_lote_contabil = current_setting('pkg_tie_account_batch.nr_lote_contabil_w')::lote_contabil.nr_lote_contabil%TYPE;

                        UPDATE lote_contabil
                        SET
                            vl_debito = 0,
                            vl_credito = 0,
                            nm_usuario = current_setting('pkg_tie_account_batch.nm_usuario_p')::lote_contabil.nm_usuario%TYPE,
                            dt_atualizacao = clock_timestamp()
                        WHERE
                            nr_lote_contabil = current_setting('pkg_tie_account_batch.nr_lote_contabil_w')::lote_contabil.nr_lote_contabil%TYPE;

                    EXCEPTION
                        WHEN OTHERS THEN
                            ds_erro_w := substr('Erro ao excluir o lote: '
                                                || nr_lote_contabil_p
                                                || ' - '
                                                || sqlerrm(SQLSTATE), 1, 255);
                    END;
                END IF;

                IF ( coalesce(ds_erro_w::text, '') = '' ) THEN
                    ds_erro_p := 'Successful';
                ELSE
                    ds_erro_p := ds_erro_w;
                END IF;

            END;

        END IF;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pkg_tie_account_batch.desfazer_lote_contabil ( cd_estabelecimento_p lote_contabil.cd_estabelecimento%TYPE, nr_lote_contabil_p lote_contabil.nr_lote_contabil%TYPE, nr_lote_externo_p lote_contabil.nr_lote_externo%TYPE, ds_erro_p INOUT text ) FROM PUBLIC;
