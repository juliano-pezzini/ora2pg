-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE import_users_to_psa_tws_pack.import_stipulators () AS $body$
DECLARE


v_id_application  	application.id%TYPE;
v_id_datasource   	datasource.id%TYPE;
v_id_client       	client.id%TYPE;
v_id_role          	role.id%TYPE;
ds_observacao_w		varchar(1000);

  rc_pls_grupo_contrato_web RECORD;

BEGIN
SELECT * FROM import_users_to_psa_tws_pack.load_stipulator_parameters(v_id_application, v_id_datasource, v_id_client, v_id_role) INTO STRICT v_id_application, v_id_datasource, v_id_client, v_id_role;

CALL import_users_to_psa_tws_pack.import_contracts_to_group();

CALL import_users_to_psa_tws_pack.import_stipulator_to_group();

FOR rc_pls_grupo_contrato_web IN (	SELECT	a.*					
					from	pls_grupo_contrato_web a
					where	coalesce(import_users_to_psa_tws_pack.retrive_stipulator(a.nm_usuario_web)::text, '') = ''
					and	a.ie_situacao = 'A'
					and	(a.nm_usuario_web IS NOT NULL AND a.nm_usuario_web::text <> '')
					and	(a.ds_senha IS NOT NULL AND a.ds_senha::text <> '')) LOOP
	
	if (coalesce(rc_pls_grupo_contrato_web.cd_pessoa_fisica::text, '') = '') then
		/*Error message. 
		Usuario web: #@NM_USUARIO_WEB#@ || chr(10) || Grupo: #@NR_SEQ_GRUPO_CONTRATO#@ || chr(10) ||  
		Nao foi possivel importar o usuario web pois nao ha pessoa fisica vinculada. */

		
		ds_observacao_w	:= 	wheb_mensagem_pck.get_texto(1134029,'NM_USUARIO_WEB=' || rc_pls_grupo_contrato_web.nm_usuario_web || ';' || 
					'NR_SEQ_GRUPO_CONTRATO=' || rc_pls_grupo_contrato_web.nr_seq_grupo_contrato);
		
		CALL import_users_to_psa_tws_pack.gerar_log_tws(null, rc_pls_grupo_contrato_web.nr_sequencia, null, ds_observacao_w, 'CE', 'stipulator');
	else
		CALL import_users_to_psa_tws_pack.insert_stipulator(rc_pls_grupo_contrato_web, v_id_application, v_id_datasource, v_id_client, v_id_role);
	end if;
END LOOP;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_users_to_psa_tws_pack.import_stipulators () FROM PUBLIC;
