-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE import_users_to_psa_tws_pack.import_providers () AS $body$
DECLARE


v_id_application  	application.id%TYPE;
v_id_datasource   	datasource.id%TYPE;
v_id_client       	client.id%TYPE;
v_id_role          	role.id%TYPE;
ds_observacao_w		varchar(1000);

  rc_pls_usuario_web RECORD;

BEGIN
SELECT * FROM import_users_to_psa_tws_pack.load_provider_parameters(v_id_application, v_id_datasource, v_id_client, v_id_role) INTO STRICT v_id_application, v_id_datasource, v_id_client, v_id_role;

FOR rc_pls_usuario_web IN (	SELECT	a.*					
				from	pls_usuario_web a
				where	coalesce(import_users_to_psa_tws_pack.retrive_provider(a.nm_usuario_web)::text, '') = ''
				and	a.ie_situacao = 'A'
				and	(a.nm_usuario_web IS NOT NULL AND a.nm_usuario_web::text <> '')
				and	(a.ds_senha IS NOT NULL AND a.ds_senha::text <> '')) LOOP
	
	if (coalesce(rc_pls_usuario_web.cd_pessoa_fisica_resp::text, '') = '') then
		/*Error message. 
		Usuario web: #@NM_USUARIO_WEB#@ || chr(10) || Sequencia: #@NR_SEQ_PREST_USUARIO_WEB#@ || chr(10) ||  
		Nao foi possivel importar o usuario web pois nao ha pessoa fisica vinculada. */

		
		ds_observacao_w	:= 	wheb_mensagem_pck.get_texto(1197839,'NM_USUARIO_WEB=' || rc_pls_usuario_web.nm_usuario_web || ';' || 
					'NR_SEQ_PREST_USUARIO_WEB=' || rc_pls_usuario_web.nr_sequencia);
		
		CALL import_users_to_psa_tws_pack.gerar_log_tws(null, null, rc_pls_usuario_web.nr_sequencia, ds_observacao_w, 'IMP', 'provider');
	else
		CALL import_users_to_psa_tws_pack.insert_provider(rc_pls_usuario_web, v_id_application, v_id_datasource, v_id_client, v_id_role);
	end if;
END LOOP;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_users_to_psa_tws_pack.import_providers () FROM PUBLIC;
