-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE import_users_to_psa_tws_pack.insert_beneficiary ( hpms_pls_segurado_web_p hpms_pls_segurado_web, id_hpms_application_p application.id%TYPE, id_hpms_datasource_p datasource.id%TYPE, id_beneficiary_client_p client.id%TYPE, id_beneficiary_role_p role.id%TYPE ) AS $body$
DECLARE


v_generated_login     subject.ds_login%TYPE;
v_id_subject          subject.id%TYPE;
v_replacement_login   subject.id%TYPE;
v_alternative_login   subject.id%TYPE;
v_new_wsuite_id       wsuite_usuario.nr_sequencia%TYPE;
v_ds_hash	      wsuite_usuario.ds_hash_ativacao%type;


BEGIN
v_id_subject := import_users_to_psa_tws_pack.retrive_beneficiary(hpms_pls_segurado_web_p.cd_carteira_atual,hpms_pls_segurado_web_p.cd_carteira_anterior);

IF
    (v_id_subject IS NOT NULL AND v_id_subject::text <> '')
THEN
    CALL wheb_mensagem_pck.exibir_mensagem_abort('Subject id '
					      || v_id_subject
					      || ' is already linked to beneficiary '
					      || hpms_pls_segurado_web_p.cd_carteira_atual
					      || ', '
					      || hpms_pls_segurado_web_p.cd_carteira_anterior);

END IF;

SELECT	'TWS-' || substr('00000000000' || TO_CHAR(nextval('tws_dslogin_sequence')),-11,11)
INTO STRICT 	v_generated_login
;

INSERT INTO subject(	id,
			dt_creation,
			dt_modification,
			ds_login,
			nm_subject,
			ds_password,
			ds_salt,
			dt_password_modification,
			vl_auth_type,
			ds_replacement_login,
			ds_alternative_login
) VALUES (		psa_uuid_generator,
			hpms_pls_segurado_web_p.dt_atualizacao,
			hpms_pls_segurado_web_p.dt_atualizacao,
			v_generated_login,
			hpms_pls_segurado_web_p.nm_pessoa_fisica,
			hpms_pls_segurado_web_p.ds_senha,
			hpms_pls_segurado_web_p.ds_tec,
			hpms_pls_segurado_web_p.dt_atualizacao,
			0,
			hpms_pls_segurado_web_p.cd_carteira_atual,
			hpms_pls_segurado_web_p.cd_carteira_anterior
) RETURNING id INTO v_id_subject;

/* Links the subject to the application?*/



INSERT INTO application_subject( id_application,
				id_subject
) VALUES (
				id_hpms_application_p,
				v_id_subject
);

/* Links the subject to the datasource */



INSERT INTO subject_datasource(	id,
					dt_creation,
					dt_modification,
					id_subject,
					id_datasource,
					vl_activation_status,
					vl_attempts_so_far
) VALUES (	psa_uuid_generator,
		clock_timestamp(),
		clock_timestamp(),
		v_id_subject,
		id_hpms_datasource_p,
		coalesce(CASE WHEN hpms_pls_segurado_web_p.ie_situacao='A' THEN 0  ELSE 1 END ,0),
		0 );

/* Links the subject to the client */



INSERT INTO subject_client(	id,
				id_subject,
				id_client,
				dt_creation,
				dt_modification,
				vl_activation_status,
				vl_attempts_so_far
) VALUES (	psa_uuid_generator,
		v_id_subject,
		id_beneficiary_client_p,
		clock_timestamp(),
		clock_timestamp(),
		coalesce(CASE WHEN hpms_pls_segurado_web_p.ie_situacao='A' THEN 0  ELSE 1 END ,0),
		0 );

INSERT INTO subject_role(	id_subject,
				id_role,
				dt_creation,
				dt_modification
) VALUES (	v_id_subject,
		id_beneficiary_role_p,
		clock_timestamp(),
		clock_timestamp() );

SELECT	nextval('wsuite_usuario_seq')
INTO STRICT 	v_new_wsuite_id
;

v_ds_hash := wsuite_login_pck.wsuite_generate_hash;

INSERT INTO wsuite_usuario(
	nr_sequencia,
	ie_situacao,
	cd_estabelecimento,
	nm_usuario_web,
	cd_pessoa_fisica,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nr_seq_segurado,
	id_subject,
	ds_login,
	ds_alternative_login,
	ds_hash_ativacao,
	dt_ativacao
) VALUES (
	v_new_wsuite_id,
	coalesce(CASE WHEN hpms_pls_segurado_web_p.ie_situacao='A' THEN 'A'  ELSE 'I' END ,0),
	hpms_pls_segurado_web_p.cd_estabelecimento,
	hpms_pls_segurado_web_p.cd_carteira_atual,
	hpms_pls_segurado_web_p.cd_pessoa_fisica,
	clock_timestamp(),
	'beneficiary',
	clock_timestamp(),
	hpms_pls_segurado_web_p.nr_seq_segurado,
	v_id_subject,
	v_generated_login,
	hpms_pls_segurado_web_p.cd_carteira_anterior,
	v_ds_hash,
	hpms_pls_segurado_web_p.dt_atualizacao
);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_users_to_psa_tws_pack.insert_beneficiary ( hpms_pls_segurado_web_p hpms_pls_segurado_web, id_hpms_application_p application.id%TYPE, id_hpms_datasource_p datasource.id%TYPE, id_beneficiary_client_p client.id%TYPE, id_beneficiary_role_p role.id%TYPE ) FROM PUBLIC;
