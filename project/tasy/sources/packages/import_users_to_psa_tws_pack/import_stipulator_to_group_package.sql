-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE import_users_to_psa_tws_pack.import_stipulator_to_group () AS $body$
DECLARE


qt_usuario_nm_w		integer;
ds_observacao_w		varchar(1000)	:= '';

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.cd_estabelecimento,
		a.cd_pessoa_fisica,
		a.ds_email,
		a.ds_senha,
		a.ds_tec,
		a.nm_usuario_web,
		a.nr_seq_contrato,
		a.nr_seq_contrato_int,
		a.nr_seq_perfil_web,
		a.nr_seq_subestipulante,
		a.ie_situacao,
		(	SELECT	pf.nm_pessoa_fisica
			from	pessoa_fisica pf
			where	a.cd_pessoa_fisica	= pf.cd_pessoa_fisica) nm_pessoa_fisica
	from	pls_estipulante_web a,
		pls_contrato b
	where	a.nr_seq_contrato	= b.nr_sequencia
	and	coalesce(b.dt_rescisao_contrato, clock_timestamp()) >= clock_timestamp()
	and	a.ie_situacao	= 'A'
	and	coalesce(import_users_to_psa_tws_pack.retrive_stipulator(a.nm_usuario_web)::text, '') = ''
	
union	all

	select	a.nr_sequencia,
		a.cd_estabelecimento,
		a.cd_pessoa_fisica,
		a.ds_email,
		a.ds_senha,
		a.ds_tec,
		a.nm_usuario_web,
		a.nr_seq_contrato,
		a.nr_seq_contrato_int,
		a.nr_seq_perfil_web,
		a.nr_seq_subestipulante,
		a.ie_situacao,
		(	select	pf.nm_pessoa_fisica
			from	pessoa_fisica pf
			where	a.cd_pessoa_fisica	= pf.cd_pessoa_fisica) nm_pessoa_fisica
	from	pls_estipulante_web a,
		pls_intercambio b
	where	a.nr_seq_contrato_int	= b.nr_sequencia
	and	coalesce(b.dt_exclusao, clock_timestamp()) >= clock_timestamp()	
	and	a.ie_situacao	= 'A'
	and	coalesce(import_users_to_psa_tws_pack.retrive_stipulator(a.nm_usuario_web)::text, '') = '';

BEGIN

for c01_w in c01 loop	
	begin	
	ds_observacao_w	:= '';
	
	select	count(1)
	into STRICT	qt_usuario_nm_w
	from	pls_grupo_contrato_web
	where	nm_usuario_web	= c01_w.nm_usuario_web;
	
	if (coalesce(c01_w.cd_pessoa_fisica::text, '') = '') then
		/*Error message. 
		Usuario web: #@NM_USUARIO_WEB#@ | Contrato: #@NR_SEQ_CONTRATO#@ | Contrato intercambio: #@NR_SEQ_CONTRATO_INT#@ 
		| Usuario web sem pessoa fisica vinculada. */

		
		ds_observacao_w	:= 	wheb_mensagem_pck.get_texto(1169168,'NM_USUARIO_WEB=' || c01_w.nm_usuario_web || ';' ||
					'NR_SEQ_CONTRATO=' || c01_w.nr_seq_contrato || ';' || 
					'NR_SEQ_CONTRATO_INT=' || c01_w.nr_seq_contrato_int);
					
		CALL import_users_to_psa_tws_pack.gerar_log_tws(c01_w.nr_sequencia, null, null, ds_observacao_w, 'IE', 'stipulator');
		
	elsif (qt_usuario_nm_w > 0) then
		/*Error message. 
		Usuario web: #@NM_USUARIO_WEB#@ || chr(10) || Contrato: #@NR_SEQ_CONTRATO#@ || chr(10) ||  Contrato intercambio: #@NR_SEQ_CONTRATO_INT#@ || chr(10) ||
		Nao foi possivel importar o usuario estipulante pois ja existe usuario de grupo de contrato com mesmo nome. */

		
		ds_observacao_w	:= 	wheb_mensagem_pck.get_texto(1133981,'NM_USUARIO_WEB=' || c01_w.nm_usuario_web || ';' ||
					'NR_SEQ_CONTRATO=' || c01_w.nr_seq_contrato || ';' || 
					'NR_SEQ_CONTRATO_INT=' || c01_w.nr_seq_contrato_int);
					
		CALL import_users_to_psa_tws_pack.gerar_log_tws(c01_w.nr_sequencia, null, null, ds_observacao_w, 'IE', 'stipulator');
	end if;
	
	if (ds_observacao_w <> '') then
		CALL import_users_to_psa_tws_pack.insert_stipulator_to_group(c01_w);	
	end if;
	end;
END LOOP;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_users_to_psa_tws_pack.import_stipulator_to_group () FROM PUBLIC;
