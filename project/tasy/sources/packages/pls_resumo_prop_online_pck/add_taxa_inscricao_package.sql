-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_resumo_prop_online_pck.add_taxa_inscricao ( nr_seq_benef_p pls_proposta_benef_online.nr_sequencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, ie_titularidade_p text, vl_produto_p bigint) AS $body$
DECLARE


	vl_inscricao_w	double precision;

	C01 CURSOR FOR
		SELECT	a.nr_sequencia,
			a.vl_inscricao,
			a.tx_inscricao
		from	pls_regra_inscricao a
		where	a.nr_seq_plano		= nr_seq_plano_p
		and	((coalesce(a.ie_grau_dependencia,ie_titularidade_p) = ie_titularidade_p) or (a.ie_grau_dependencia = 'A'))
		and	1	>= a.qt_parcela_inicial
		and	1	<= a.qt_parcela_final
		and	((a.ie_acao_contrato = 'A') or (coalesce(a.ie_acao_contrato::text, '') = ''))
		and	trunc(clock_timestamp(),'month') between trunc(coalesce(dt_inicio_vigencia,clock_timestamp()),'month') and trunc(coalesce(dt_fim_vigencia,clock_timestamp()),'month')
		and	coalesce(a.ie_tipo_proposta::text, '') = '';
	
BEGIN

	vl_inscricao_w	:= 0;

	for r_c01_w in C01 loop
		begin
		vl_inscricao_w	:= coalesce(vl_inscricao_w,0) + ((coalesce(r_c01_w.tx_inscricao,0) / 100) * coalesce(vl_produto_p,0)) + coalesce(r_c01_w.vl_inscricao,0);
		end;
	end loop;

	if (vl_inscricao_w > 0) then
		CALL CALL pls_resumo_prop_online_pck.add_item('Taxa de inscrição', vl_inscricao_w, nr_seq_benef_p, '2');
	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_resumo_prop_online_pck.add_taxa_inscricao ( nr_seq_benef_p pls_proposta_benef_online.nr_sequencia%type, nr_seq_plano_p pls_plano.nr_sequencia%type, ie_titularidade_p text, vl_produto_p bigint) FROM PUBLIC;
