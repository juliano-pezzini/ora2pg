-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_recalcular_copartic_pck.pls_recalcular_copartic ( nr_seq_lote_recalc_p pls_recalc_copartic_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


qt_coparticipacoes_w 		integer := 0;
t_recalc_coparticipacao_w 	t_recalc_coparticipacao_row;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
nr_seq_plano_w			pls_plano.nr_sequencia%type;
nr_seq_grupo_contrato_w		pls_preco_grupo_contrato.nr_sequencia%type;
nr_seq_grupo_produto_w		pls_preco_grupo_produto.nr_sequencia%type;
dt_inicial_w			timestamp;
dt_final_w			timestamp;
dt_inicial_fechamento_w 	timestamp;
dt_final_fechamento_w 		timestamp;
nr_seq_lote_copartic_w		pls_recalc_copartic_lote.nr_seq_lote_copartic%type;
ds_sql_w			varchar(4000);
ds_sql_mat_w			varchar(4000);
ds_sql_proc_w			varchar(4000);
ds_sql_restr_mat_w		varchar(4000);
ds_sql_restr_proc_w		varchar(4000);
tb_seq_conta_w			pls_util_cta_pck.t_number_table;
tb_mes_comp_w			pls_util_cta_pck.t_date_table;
tb_atend_ref_w			pls_util_cta_pck.t_date_table;
tb_seq_segurado_w		pls_util_cta_pck.t_number_table;
cursor_w			sql_pck.t_cursor;
bind_sql_w			sql_pck.t_dado_bind;
pls_total_test_w		integer;
valor_bind_w			varchar(10);
ie_tipo_contrato_w		pls_recalc_copartic_lote.ie_tipo_contrato%type;

BEGIN

CALL gravar_processo_longo('Gerando lote de rec?lculo de coparticipa??o.' ,'PLS_RECALCULAR_COPARTIC',0);

ds_sql_proc_w := 	' select	a.nr_sequencia nr_seq_conta,'|| pls_util_pck.enter_w ||
					'		c.dt_mes_competencia dt_mes_competencia,'|| pls_util_pck.enter_w ||
					'		c.dt_mes_competencia_trunc dt_atendimento_referencia,'|| pls_util_pck.enter_w ||
					'		a.nr_seq_segurado'|| pls_util_pck.enter_w ||
					' from		pls_conta		a,'|| pls_util_pck.enter_w ||
					'		pls_protocolo_conta_v	c,'	|| pls_util_pck.enter_w ||
					'		pls_segurado	d'	|| pls_util_pck.enter_w ||
					' where	1 = 1'	|| pls_util_pck.enter_w ||
					' and	a.ie_status 	in (''F'',''S'') '|| pls_util_pck.enter_w ||
					' and	not exists (	select	1'|| pls_util_pck.enter_w ||
					'			from	pls_conta_coparticipacao x'|| pls_util_pck.enter_w ||
					'			where	x.nr_seq_conta 		    = a.nr_sequencia'|| pls_util_pck.enter_w ||
					'			and	x.nr_seq_mensalidade_seg is not null'|| pls_util_pck.enter_w ||
					'			and	x.ie_status_mensalidade <> ''P'')'|| pls_util_pck.enter_w ||
					' and ( select  count(1)									'|| pls_util_pck.enter_w ||
					'		from  	pls_mensalidade_item_conta a1,              '|| pls_util_pck.enter_w ||
					'				pls_mensalidade_seg_item b1,                '|| pls_util_pck.enter_w ||
					'				pls_mensalidade_segurado c1,                '|| pls_util_pck.enter_w ||
					'				pls_mensalidade d1,                         '|| pls_util_pck.enter_w ||
					'				pls_conta_coparticipacao e1                 '|| pls_util_pck.enter_w ||
					'		where  b1.nr_sequencia = a1.nr_seq_item             '|| pls_util_pck.enter_w ||
					'		and  	c1.nr_sequencia = b1.nr_seq_mensalidade_seg  '|| pls_util_pck.enter_w ||
					'		and  	d1.nr_sequencia = c1.nr_seq_mensalidade       '|| pls_util_pck.enter_w ||
					'		and  	a1.nr_seq_conta_copartic = e1.nr_sequencia	 '|| pls_util_pck.enter_w ||
					'		and  	a.nr_sequencia = e1.nr_seq_conta		    '|| pls_util_pck.enter_w ||
					'		and		d1.ie_cancelamento is null  ) = 0              '|| pls_util_pck.enter_w ||
					' and	not exists (	select	1 '	|| pls_util_pck.enter_w ||
					'			from	pls_lib_coparticipacao y, '	|| pls_util_pck.enter_w ||
					'				pls_lote_coparticipacao z '	|| pls_util_pck.enter_w ||
					'			where	y.nr_seq_conta	= a.nr_sequencia '	|| pls_util_pck.enter_w ||
					'			and	y.nr_seq_lote 	= z.nr_sequencia '	|| pls_util_pck.enter_w ||
					'			and	z.ie_status = ''D'' )	 '	|| pls_util_pck.enter_w ||

					' and	 (	select	count(1)'|| pls_util_pck.enter_w ||
					'		from	pls_conta_coparticipacao x'|| pls_util_pck.enter_w ||
					'		where	x.nr_seq_conta 		    = a.nr_sequencia'|| pls_util_pck.enter_w ||
					'		and	x.dt_estorno is not null) = 0 '|| pls_util_pck.enter_w ||
					' and   c.nr_sequencia  = a.nr_seq_protocolo'|| pls_util_pck.enter_w ||
					' and	d.nr_sequencia	= a.nr_seq_segurado'|| pls_util_pck.enter_w ||
					' and	a.cd_estabelecimento = :cd_estabelecimento'|| pls_util_pck.enter_w ||'';

ds_sql_mat_w	:=  ' union '|| pls_util_pck.enter_w ||
					' select	a.nr_sequencia nr_seq_conta,'|| pls_util_pck.enter_w ||
					'		c.dt_mes_competencia dt_mes_competencia,'|| pls_util_pck.enter_w ||
					'		c.dt_mes_competencia_trunc dt_atendimento_referencia,'|| pls_util_pck.enter_w ||
					'		a.nr_seq_segurado'|| pls_util_pck.enter_w ||
					' from		pls_conta		a,'|| pls_util_pck.enter_w ||
					'		pls_protocolo_conta_v	c,'	|| pls_util_pck.enter_w ||
					'		pls_segurado	d'	|| pls_util_pck.enter_w ||
					' where		1 = 1'	|| pls_util_pck.enter_w ||
					' and		a.ie_status 	in (''F'',''S'') '|| pls_util_pck.enter_w ||
					' and		not exists (	select	1'|| pls_util_pck.enter_w ||
					'				from	pls_conta_coparticipacao x'|| pls_util_pck.enter_w ||
					'				where	x.nr_seq_conta 		= a.nr_sequencia'|| pls_util_pck.enter_w ||
					'				and	x.nr_seq_mensalidade_seg is not null'|| pls_util_pck.enter_w ||
					'				and	x.ie_status_mensalidade <> ''P'')'|| pls_util_pck.enter_w ||
					' and ( select  count(1)									'|| pls_util_pck.enter_w ||
					'		from  	pls_mensalidade_item_conta a1,              '|| pls_util_pck.enter_w ||
					'				pls_mensalidade_seg_item b1,                '|| pls_util_pck.enter_w ||
					'				pls_mensalidade_segurado c1,                '|| pls_util_pck.enter_w ||
					'				pls_mensalidade d1,                         '|| pls_util_pck.enter_w ||
					'				pls_conta_coparticipacao e1                 '|| pls_util_pck.enter_w ||
					'		where  b1.nr_sequencia = a1.nr_seq_item             '|| pls_util_pck.enter_w ||
					'		and  	c1.nr_sequencia = b1.nr_seq_mensalidade_seg  '|| pls_util_pck.enter_w ||
					'		and  	d1.nr_sequencia = c1.nr_seq_mensalidade       '|| pls_util_pck.enter_w ||
					'		and  	a1.nr_seq_conta_copartic = e1.nr_sequencia	 '|| pls_util_pck.enter_w ||
					'		and  	a.nr_sequencia = e1.nr_seq_conta		    '|| pls_util_pck.enter_w ||
					'		and		d1.ie_cancelamento is null  ) = 0              '|| pls_util_pck.enter_w ||
					' and	not exists (	select	1 '	|| pls_util_pck.enter_w ||
					'			from	pls_lib_coparticipacao y, '	|| pls_util_pck.enter_w ||
					'				pls_lote_coparticipacao z '	|| pls_util_pck.enter_w ||
					'			where	y.nr_seq_conta	= a.nr_sequencia '	|| pls_util_pck.enter_w ||
					'			and	y.nr_seq_lote 	= z.nr_sequencia '	|| pls_util_pck.enter_w ||
					'			and	z.ie_status = ''D'' )	 '	|| pls_util_pck.enter_w ||

					' and	 (	select	count(1)'|| pls_util_pck.enter_w ||
					'		from	pls_conta_coparticipacao x'|| pls_util_pck.enter_w ||
					'		where	x.nr_seq_conta 		    = a.nr_sequencia'|| pls_util_pck.enter_w ||
					'		and	x.dt_estorno is not null) = 0 '|| pls_util_pck.enter_w ||
					' and   	c.nr_sequencia = a.nr_seq_protocolo'|| pls_util_pck.enter_w ||
					' and	  	d.nr_sequencia	= a.nr_seq_segurado'|| pls_util_pck.enter_w ||
					' and	a.cd_estabelecimento = :cd_estabelecimento'|| pls_util_pck.enter_w ||'';

bind_sql_w := sql_pck.bind_variable(':cd_estabelecimento', cd_estabelecimento_p, bind_sql_w);

select	a.nr_seq_contrato,
	a.nr_seq_plano,
	a.dt_inicial,
	a.dt_final,
	a.nr_seq_lote_copartic,
	a.nr_seq_grupo_contrato,
	a.nr_seq_grupo_produto,
	a.ie_tipo_contrato,
	a.dt_inicial_fechamento,
	a.dt_final_fechamento
into STRICT	nr_seq_contrato_w,
	nr_seq_plano_w,
	dt_inicial_w,
	dt_final_w,
	nr_seq_lote_copartic_w,
	nr_seq_grupo_contrato_w,
	nr_seq_grupo_produto_w,
	ie_tipo_contrato_w,
	dt_inicial_fechamento_w,
	dt_final_fechamento_w
from	pls_recalc_copartic_lote a
where	a.nr_sequencia = nr_seq_lote_recalc_p;

-- Adicionado essa verifica??o pois o inicio dia e fim dia colocam um sysdate na data padr?o.
if (dt_inicial_w IS NOT NULL AND dt_inicial_w::text <> '') then
	dt_inicial_w := inicio_dia(dt_inicial_w);
end if;

if (dt_final_w IS NOT NULL AND dt_final_w::text <> '') then
	dt_final_w := fim_dia(dt_final_w);
end if;

if (dt_inicial_fechamento_w IS NOT NULL AND dt_inicial_fechamento_w::text <> '') then
	dt_inicial_fechamento_w := inicio_dia(dt_inicial_fechamento_w);
end if;

if (dt_final_fechamento_w IS NOT NULL AND dt_final_fechamento_w::text <> '') then
	dt_final_fechamento_w := fim_dia(dt_final_fechamento_w);
end if;

--Verifica se ao menos uma restri??o foi aficionada ao lote
if	((nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') or (nr_seq_plano_w IS NOT NULL AND nr_seq_plano_w::text <> '') or (nr_seq_lote_copartic_w IS NOT NULL AND nr_seq_lote_copartic_w::text <> '') or (nr_seq_grupo_contrato_w IS NOT NULL AND nr_seq_grupo_contrato_w::text <> '') or (nr_seq_grupo_produto_w IS NOT NULL AND nr_seq_grupo_produto_w::text <> '')or (ie_tipo_contrato_w <> 'A')) then

	if (nr_seq_plano_w IS NOT NULL AND nr_seq_plano_w::text <> '') then
		ds_sql_restr_mat_w	:= ds_sql_restr_mat_w||' and (d.nr_seq_plano 	= :nr_seq_plano) '|| pls_util_pck.enter_w;
		ds_sql_restr_proc_w	:= ds_sql_restr_proc_w||'and (d.nr_seq_plano 	= :nr_seq_plano) '|| pls_util_pck.enter_w;
		bind_sql_w := sql_pck.bind_variable(':nr_seq_plano', nr_seq_plano_w, bind_sql_w);
	end if;
	if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
		ds_sql_restr_mat_w	:= ds_sql_restr_mat_w||' and (d.nr_seq_contrato	= :nr_seq_contrato) '|| pls_util_pck.enter_w;
		ds_sql_restr_proc_w	:= ds_sql_restr_proc_w||'and (d.nr_seq_contrato	= :nr_seq_contrato ) '|| pls_util_pck.enter_w;
		bind_sql_w := sql_pck.bind_variable(':nr_seq_contrato', nr_seq_contrato_w, bind_sql_w);
	end if;

	--Se foi informado um lote de coparticipa??o, ent?o restringe para apenas as contas do mesmo.
	if (nr_seq_lote_copartic_w IS NOT NULL AND nr_seq_lote_copartic_w::text <> '') then

		ds_sql_restr_mat_w := ds_sql_restr_mat_w ||	'and ((	select	count(1)'||pls_util_pck.enter_w||
													'	from	pls_lib_coparticipacao y'||pls_util_pck.enter_w||
													'	where	y.nr_seq_lote = :nr_seq_lote_copartic'||pls_util_pck.enter_w||
													'	and 	y.nr_seq_conta = a.nr_sequencia) > 0)'||pls_util_pck.enter_w||'';

		ds_sql_restr_proc_w := ds_sql_restr_proc_w ||'and ((	select	count(1)'||pls_util_pck.enter_w||
													 '		from	pls_lib_coparticipacao y '||pls_util_pck.enter_w||
													 '		where	y.nr_seq_lote = :nr_seq_lote_copartic'||pls_util_pck.enter_w||
													 '		and 	y.nr_seq_conta = a.nr_sequencia) > 0)'||pls_util_pck.enter_w||'';

		bind_sql_w := sql_pck.bind_variable(':nr_seq_lote_copartic', nr_seq_lote_copartic_w, bind_sql_w);
	end if;

	ds_sql_restr_proc_w := ds_sql_restr_proc_w ||' and c.dt_mes_competencia_trunc between '||pls_util_pck.enter_w||'';
	ds_sql_restr_mat_w	:= ds_sql_restr_mat_w||' and c.dt_mes_competencia_trunc between '||pls_util_pck.enter_w||'';
	if (dt_inicial_w IS NOT NULL AND dt_inicial_w::text <> '') then
		ds_sql_restr_proc_w := ds_sql_restr_proc_w ||' :dt_inicial ';
		ds_sql_restr_mat_w	:= ds_sql_restr_mat_w||' :dt_inicial ';
		bind_sql_w := sql_pck.bind_variable(':dt_inicial', dt_inicial_w, bind_sql_w);
	else
		ds_sql_restr_proc_w := ds_sql_restr_proc_w ||' inicio_dia(c.dt_mes_competencia_trunc) ';
		ds_sql_restr_mat_w	:= ds_sql_restr_mat_w||' inicio_dia(c.dt_mes_competencia_trunc) ';

	end if;

	if (dt_final_w IS NOT NULL AND dt_final_w::text <> '') then
		ds_sql_restr_proc_w := ds_sql_restr_proc_w ||' and :dt_final '||pls_util_pck.enter_w||'';
		ds_sql_restr_mat_w	:= ds_sql_restr_mat_w||' and :dt_final '||pls_util_pck.enter_w||'';
		bind_sql_w := sql_pck.bind_variable(':dt_final', dt_final_w, bind_sql_w);
	else
		ds_sql_restr_proc_w := ds_sql_restr_proc_w ||' and fim_dia(c.dt_mes_competencia_trunc) '||pls_util_pck.enter_w||'';
		ds_sql_restr_mat_w	:= ds_sql_restr_mat_w||' and fim_dia(c.dt_mes_competencia_trunc) '||pls_util_pck.enter_w||'';
	end if;

	if	(dt_inicial_fechamento_w IS NOT NULL AND dt_inicial_fechamento_w::text <> '' AND dt_final_fechamento_w IS NOT NULL AND dt_final_fechamento_w::text <> '') then
		ds_sql_restr_proc_w := ds_sql_restr_proc_w 	||' and a.dt_fechamento_conta between :dt_inicial_f and :dt_final_f'||pls_util_pck.enter_w||'';
		ds_sql_restr_mat_w	:= ds_sql_restr_mat_w	||' and a.dt_fechamento_conta between :dt_inicial_f and :dt_final_f'||pls_util_pck.enter_w||'';

		bind_sql_w := sql_pck.bind_variable(':dt_inicial_f', dt_inicial_fechamento_w, bind_sql_w);
		bind_sql_w := sql_pck.bind_variable(':dt_final_f', dt_final_fechamento_w, bind_sql_w);
	end if;

	if (nr_seq_grupo_contrato_w IS NOT NULL AND nr_seq_grupo_contrato_w::text <> '') then
		ds_sql_restr_mat_w	:= ds_sql_restr_mat_w||' and exists (	select	1
										from	pls_preco_contrato contrato
										where	contrato.nr_seq_contrato = d.nr_seq_contrato
										and	contrato.nr_seq_grupo = :nr_seq_grupo_contrato) '|| pls_util_pck.enter_w;
		ds_sql_restr_proc_w	:= ds_sql_restr_proc_w||'and exists (	select	1
										from	pls_preco_contrato contrato
										where	contrato.nr_seq_contrato = d.nr_seq_contrato
										and	contrato.nr_seq_grupo = :nr_seq_grupo_contrato) '|| pls_util_pck.enter_w;
		bind_sql_w := sql_pck.bind_variable(':nr_seq_grupo_contrato', nr_seq_grupo_contrato_w, bind_sql_w);
	end if;

	if (nr_seq_grupo_produto_w IS NOT NULL AND nr_seq_grupo_produto_w::text <> '') then
		ds_sql_restr_mat_w	:= ds_sql_restr_mat_w||' and exists (	select	1
										from	pls_preco_produto prod
										where	prod.nr_seq_plano = d.nr_seq_plano
										and	prod.nr_seq_grupo = :nr_seq_grupo_produto) '|| pls_util_pck.enter_w;
		ds_sql_restr_proc_w	:= ds_sql_restr_proc_w||'and exists (	select	1
										from	pls_preco_produto prod
										where	prod.nr_seq_plano = d.nr_seq_plano
										and	prod.nr_seq_grupo = :nr_seq_grupo_produto) '|| pls_util_pck.enter_w;
		bind_sql_w := sql_pck.bind_variable(':nr_seq_grupo_produto', nr_seq_grupo_produto_w, bind_sql_w);
	end if;

	if (ie_tipo_contrato_w = 'PF') then
		ds_sql_restr_mat_w	:= ds_sql_restr_mat_w ||'	and exists (	select	1 ' || pls_util_pck.enter_w ||
								'			from	pls_contrato x '|| pls_util_pck.enter_w ||
								'			where	x.nr_sequencia = d.nr_seq_contrato ' || pls_util_pck.enter_w ||
								'			and	X.cd_pf_estipulante is not null) '|| pls_util_pck.enter_w;
		ds_sql_restr_proc_w	:= ds_sql_restr_proc_w||'	and exists (	select 	1 ' || pls_util_pck.enter_w ||
								'			from	pls_contrato x ' || pls_util_pck.enter_w ||
								'			where	x.nr_sequencia = d.nr_seq_contrato ' || pls_util_pck.enter_w ||
								'			and	x.cd_pf_estipulante is not null) ' || pls_util_pck.enter_w;
	elsif (ie_tipo_contrato_w = 'PJ') then
		ds_sql_restr_mat_w	:= ds_sql_restr_mat_w ||'	and exists (	select	1 ' || pls_util_pck.enter_w ||
								'			from	pls_contrato x '|| pls_util_pck.enter_w ||
								'			where	x.nr_sequencia = d.nr_seq_contrato ' || pls_util_pck.enter_w ||
								'			and	X.cd_cgc_estipulante is not null) '|| pls_util_pck.enter_w;
		ds_sql_restr_proc_w	:= ds_sql_restr_proc_w||'	and exists (	select 	1 ' || pls_util_pck.enter_w ||
								'			from	pls_contrato x ' || pls_util_pck.enter_w ||
								'			where	x.nr_sequencia = d.nr_seq_contrato ' || pls_util_pck.enter_w ||
								'			and	x.cd_cgc_estipulante is not null) ' || pls_util_pck.enter_w;
	end if;

	--Agrupa os peda?os de select para criar um ?nico select
	ds_sql_mat_w := ds_sql_mat_w || ds_sql_restr_mat_w;
	ds_sql_proc_w := ds_sql_proc_w || ds_sql_restr_proc_w;
	ds_sql_w := ds_sql_proc_w || ds_sql_mat_w;

	--Cria um cursor baseado no select din?mico e as binds informadas
	bind_sql_w := sql_pck.executa_sql_cursor(	ds_sql_w, bind_sql_w);
	loop
		--Descarrega as informa??es nas vari?veis tabela
		fetch cursor_w bulk collect into tb_seq_conta_w, tb_mes_comp_w,
						 tb_atend_ref_w, tb_seq_segurado_w
		limit pls_util_pck.qt_registro_transacao_w;
		exit when tb_seq_conta_w.count = 0;

		pls_total_test_w := tb_seq_conta_w.count;

		if (tb_seq_conta_w.count > 0) then

			for i in tb_seq_conta_w.first..tb_seq_conta_w.last loop
				CALL gravar_processo_longo('Obtendo contas para o rec?lculo ' || tb_seq_conta_w(i),'PLS_RECALCULAR_COPARTIC',-1);
				CALL pls_recalcular_copartic_pck.pls_recalc_copartic_contas(	nr_seq_lote_recalc_p, tb_seq_conta_w(i), nm_usuario_p);
			end loop;
		end if;
	end loop;
else -- Favor informar um contrato/produto ou lote de libera??o de coparticipa??o
	CALL wheb_mensagem_pck.exibir_mensagem_abort(336382);
end if;

commit;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_recalcular_copartic_pck.pls_recalcular_copartic ( nr_seq_lote_recalc_p pls_recalc_copartic_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
