-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_dados_atuariais_pck.retorna_sql_dados_estip ( lote_estip_p INOUT lote_atuarial, dado_bind_p INOUT sql_pck.t_dado_bind, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Gera o sql dinamico com os filtro necessarios para os dados do estipulante,
	bem como gera o bind dos parametros

-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

	
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


ds_retorno_w	varchar(32000):= '';

ie_tipo_estipulante_w		pls_atu_estip_regra.ie_tipo_estipulante%type;

ds_situacao_contrato_w		varchar(1000) := '';

BEGIN

-- Carrega demais inf dos filtros

select	coalesce(max(a.ie_tipo_estipulante),'A'),
	-- O tratamento com aspas e necessario, para deixar ja no "formato" IN

	'''2'''||CASE WHEN max(a.ie_contrato_rescindido)='S' THEN  ',''3''' END ||CASE WHEN max(a.ie_contrato_cancelado)='S' THEN  ',''4''' END
into STRICT	ie_tipo_estipulante_w,
	ds_situacao_contrato_w
from	pls_atu_estip_regra	a
where	a.nr_sequencia		= lote_estip_p.nr_seq_estip_regra;



ds_retorno_w	:= ds_retorno_w||	'insert into pls_atu_estip_item(nr_sequencia, '|| pls_util_pck.enter_w ||
					'				cd_cgc_estip, '|| pls_util_pck.enter_w ||
					'				cd_pessoa_fisica_estip, '|| pls_util_pck.enter_w ||
					'				dt_aprovacao, '|| pls_util_pck.enter_w ||
					'				dt_atualizacao, '|| pls_util_pck.enter_w ||
					'				dt_atualizacao_nrec, '|| pls_util_pck.enter_w ||
					'				dt_cancelamento, '|| pls_util_pck.enter_w ||
					'				dt_contrato, '|| pls_util_pck.enter_w ||
					'				dt_rescisao_contrato, '|| pls_util_pck.enter_w ||
					'				nm_usuario, '|| pls_util_pck.enter_w ||
					'				nm_usuario_nrec, '|| pls_util_pck.enter_w ||
					'				nr_cpf_estip, '|| pls_util_pck.enter_w ||
					'				nr_protocolo_ans, '|| pls_util_pck.enter_w ||
					'				nr_seq_contrato, '|| pls_util_pck.enter_w ||
					'				nr_seq_lote, '|| pls_util_pck.enter_w ||
					'				nr_seq_plano) '|| pls_util_pck.enter_w ||
					'select	pls_atu_estip_item_seq.nextVal nr_sequencia, '|| pls_util_pck.enter_w ||
					'	t.cd_cgc_estip, '|| pls_util_pck.enter_w ||
					'	t.cd_pessoa_fisica_estip, '|| pls_util_pck.enter_w ||
					'	t.dt_aprovacao, '|| pls_util_pck.enter_w ||
					'	t.dt_atualizacao, '|| pls_util_pck.enter_w ||
					'	t.dt_atualizacao_nrec, '|| pls_util_pck.enter_w ||
					'	t.dt_cancelamento, '|| pls_util_pck.enter_w ||
					'	t.dt_contrato, '|| pls_util_pck.enter_w ||
					'	t.dt_rescisao_contrato, '|| pls_util_pck.enter_w ||
					'	t.nm_usuario, '|| pls_util_pck.enter_w ||
					'	t.nm_usuario_nrec, '|| pls_util_pck.enter_w ||
					'	t.nr_cpf_estip, '|| pls_util_pck.enter_w ||
					'	t.nr_protocolo_ans, '|| pls_util_pck.enter_w ||
					'	t.nr_seq_contrato, '|| pls_util_pck.enter_w ||
					'	t.nr_seq_lote, '|| pls_util_pck.enter_w ||
					'	t.nr_seq_plano '|| pls_util_pck.enter_w ||
					'from (	select	null cd_cgc_estip, '|| pls_util_pck.enter_w ||
					'		c.cd_pessoa_fisica cd_pessoa_fisica_estip, '|| pls_util_pck.enter_w ||
					'		a.dt_aprovacao, '|| pls_util_pck.enter_w ||
					'		sysdate dt_atualizacao, '|| pls_util_pck.enter_w ||
					'		sysdate dt_atualizacao_nrec, '|| pls_util_pck.enter_w ||
					'		null dt_cancelamento, '|| pls_util_pck.enter_w ||
					'		a.dt_contrato, '|| pls_util_pck.enter_w ||
					'		a.dt_rescisao_contrato, '|| pls_util_pck.enter_w ||
					'		:nm_usuario_p nm_usuario, '|| pls_util_pck.enter_w ||
					'		:nm_usuario_p nm_usuario_nrec, '|| pls_util_pck.enter_w ||
					'		c.nr_cpf nr_cpf_estip, '|| pls_util_pck.enter_w ||
					'		d.nr_protocolo_ans, '|| pls_util_pck.enter_w ||
					'		a.nr_sequencia nr_seq_contrato, '|| pls_util_pck.enter_w ||
					'		:nr_seq_lote nr_seq_lote, '|| pls_util_pck.enter_w ||
					'		d.nr_sequencia nr_seq_plano	 '|| pls_util_pck.enter_w ||
					'	from	pls_contrato		a, '|| pls_util_pck.enter_w ||
					'		pls_contrato_plano	b, '|| pls_util_pck.enter_w ||
					'		pessoa_fisica		c, '|| pls_util_pck.enter_w ||
					'		pls_plano		d '|| pls_util_pck.enter_w ||
					'	where	b.nr_seq_contrato	= a.nr_sequencia '|| pls_util_pck.enter_w ||
					'	and	c.cd_pessoa_fisica	= a.cd_pf_estipulante '|| pls_util_pck.enter_w ||
					'	and	d.nr_sequencia		= b.nr_seq_plano '|| pls_util_pck.enter_w ||
					'	and	a.ie_situacao		in ('||ds_situacao_contrato_w||') '|| pls_util_pck.enter_w ||
					'	and	:ie_tipo_estipulante	in (''PF'', ''A'') ' || pls_util_pck.enter_w ||
					'	and	a.cd_estabelecimento	= :cd_estabelecimento '|| pls_util_pck.enter_w;

dado_bind_p := sql_pck.bind_variable(':ie_tipo_estipulante', ie_tipo_estipulante_w, dado_bind_p);
dado_bind_p := sql_pck.bind_variable(':nm_usuario_p', nm_usuario_p, dado_bind_p);
dado_bind_p := sql_pck.bind_variable(':nr_seq_lote', lote_estip_p.nr_sequencia, dado_bind_p);
dado_bind_p := sql_pck.bind_variable(':cd_estabelecimento', lote_estip_p.cd_estabelecimento, dado_bind_p);


if (lote_estip_p.dt_inicio_comp IS NOT NULL AND lote_estip_p.dt_inicio_comp::text <> '') then
					
	ds_retorno_w	:= ds_retorno_w||	'and	a.dt_contrato		between :dt_inicial_p and :dt_final_p '|| pls_util_pck.enter_w;
	
	dado_bind_p := sql_pck.bind_variable(':dt_inicial_p', lote_estip_p.dt_inicio_comp, dado_bind_p);
	dado_bind_p := sql_pck.bind_variable(':dt_final_p', lote_estip_p.dt_fim_comp, dado_bind_p);
end if;

ds_retorno_w	:= ds_retorno_w||	'	union all '|| pls_util_pck.enter_w ||
					'	select	a.cd_cgc_estipulante cd_cgc_estip, '|| pls_util_pck.enter_w ||
					'		null cd_pessoa_fisica_estip, '|| pls_util_pck.enter_w ||
					'		a.dt_aprovacao, '|| pls_util_pck.enter_w ||
					'		sysdate dt_atualizacao, '|| pls_util_pck.enter_w ||
					'		sysdate dt_atualizacao_nrec, '|| pls_util_pck.enter_w ||
					'		null dt_cancelamento, '|| pls_util_pck.enter_w ||
					'		a.dt_contrato, '|| pls_util_pck.enter_w ||
					'		a.dt_rescisao_contrato, '|| pls_util_pck.enter_w ||
					'		:nm_usuario_p nm_usuario, '|| pls_util_pck.enter_w ||
					'		:nm_usuario_p nm_usuario_nrec, '|| pls_util_pck.enter_w ||
					'		null nr_cpf_estip, '|| pls_util_pck.enter_w ||
					'		d.nr_protocolo_ans, '|| pls_util_pck.enter_w ||
					'		a.nr_sequencia nr_seq_contrato, '|| pls_util_pck.enter_w ||
					'		:nr_seq_lote nr_seq_lote, '|| pls_util_pck.enter_w ||
					'		d.nr_sequencia nr_seq_plano	 '|| pls_util_pck.enter_w ||
					'	from	pls_contrato		a, '|| pls_util_pck.enter_w ||
					'		pls_contrato_plano	b, '|| pls_util_pck.enter_w ||
					'		pessoa_juridica_compl	c, '|| pls_util_pck.enter_w ||
					'		pls_plano		d '|| pls_util_pck.enter_w ||
					'	where	b.nr_seq_contrato	= a.nr_sequencia '|| pls_util_pck.enter_w ||
					'	and	c.cd_cgc		= a.cd_cgc_estipulante '|| pls_util_pck.enter_w ||
					'	and	d.nr_sequencia		= b.nr_seq_plano '|| pls_util_pck.enter_w ||
					'	and	a.ie_situacao		in ('||ds_situacao_contrato_w||') '|| pls_util_pck.enter_w ||
					'	and	:ie_tipo_estipulante	in (''PJ'', ''A'') ' || pls_util_pck.enter_w ||
					'	and	a.cd_estabelecimento	= :cd_estabelecimento '|| pls_util_pck.enter_w;
					
dado_bind_p := sql_pck.bind_variable(':ie_tipo_estipulante', ie_tipo_estipulante_w, dado_bind_p);
dado_bind_p := sql_pck.bind_variable(':nm_usuario_p', nm_usuario_p, dado_bind_p);
dado_bind_p := sql_pck.bind_variable(':nr_seq_lote', lote_estip_p.nr_sequencia, dado_bind_p);
dado_bind_p := sql_pck.bind_variable(':cd_estabelecimento', lote_estip_p.cd_estabelecimento, dado_bind_p);


if (lote_estip_p.dt_inicio_comp IS NOT NULL AND lote_estip_p.dt_inicio_comp::text <> '') then
					
	ds_retorno_w	:= ds_retorno_w||	'and	a.dt_contrato		between :dt_inicial_p and :dt_final_p '|| pls_util_pck.enter_w;
	
	dado_bind_p := sql_pck.bind_variable(':dt_inicial_p', lote_estip_p.dt_inicio_comp, dado_bind_p);
	dado_bind_p := sql_pck.bind_variable(':dt_final_p', lote_estip_p.dt_fim_comp, dado_bind_p);
end if;


ds_retorno_w	:= ds_retorno_w||' ) t ';

-- Gravar log

CALL pls_dados_atuariais_pck.gravar_log(	lote_estip_p.nr_sequencia,
					lote_estip_p.nr_seq_estip_regra, 
					lote_estip_p.ie_tipo_arquivo, 
					ds_retorno_w, 
					dado_bind_p := pls_dados_atuariais_pck.obter_bind_log(dado_bind_p), 
					dbms_utility.format_error_backtrace, 
					nm_usuario_p);

	
return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_dados_atuariais_pck.retorna_sql_dados_estip ( lote_estip_p INOUT lote_atuarial, dado_bind_p INOUT sql_pck.t_dado_bind, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
