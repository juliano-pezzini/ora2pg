-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_dados_atuariais_pck.gerar_dados_atuariais_lote ( nr_seq_lote_p pls_atuarial_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Rotina que vai iniciar a geracao dos dados conforme o lote passado.

	Os dados do lote serao carregados, e entao sera selecionado qual a geracao correta,
	conforme o tipo do arquivo.
	
	O tratamento de excecao deve ser feito aqui, em um nivel mais alto, e devera gravar um log
	com o erro, caso ocorra. 
	
	Como essa rtoina devera ser mais generica, as validacoes tambem serao, portanto
	atualmente e apenas verificado o status do lote, e se ele nao estiver adequado,
	nao devera acontecer nada. Isso esta correto pois o desktop devera controlar por
	status quando pode chamar esta rotina, essa validacao apenas acontece por medida 
	de seguranca redundante.
	
	Como essa rotina vai ser consumida por uma JOB, toda excecao ou mensagem de alerta
	devera ser jogado no log.

-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

	
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


lote_atuarial_w	lote_atuarial;

BEGIN

begin

	lote_atuarial_w := pls_dados_atuariais_pck.retorna_lote_atuarial(nr_seq_lote_p);
	
	-- desfaz o que ja foi gerado, rotina executada apenas por preucaucao, para evitar dados de geracao anterior no lote

	CALL pls_dados_atuariais_pck.desfazer_dados_lote(lote_atuarial_w.nr_sequencia, nm_usuario_p);
	commit;
		
	-- marca o inicio da geracao do lote

	lote_atuarial_w := pls_dados_atuariais_pck.inicio_geracao_lote(lote_atuarial_w, nm_usuario_p);
	commit;

	-- Seleciona a geracao conforme o tipo do lote

	-- Beneficiario

	if (lote_atuarial_w.ie_tipo_arquivo = 1) then
	
		lote_atuarial_w := pls_dados_atuariais_pck.gera_dados_benef(lote_atuarial_w, nm_usuario_p);
	
	-- Contas medicas

	elsif (lote_atuarial_w.ie_tipo_arquivo = 2) then
	
		lote_atuarial_w := pls_dados_atuariais_pck.gera_dados_cta(lote_atuarial_w, nm_usuario_p);
	
	-- Estipulante

	elsif (lote_atuarial_w.ie_tipo_arquivo = 3) then
	
		lote_atuarial_w := pls_dados_atuariais_pck.gera_dados_estip(lote_atuarial_w, nm_usuario_p);
		
	-- Mensalidade

	elsif (lote_atuarial_w.ie_tipo_arquivo = 4) then
		
		lote_atuarial_w := pls_dados_atuariais_pck.gera_dados_mens(lote_atuarial_w, nm_usuario_p);
	
	-- Prestador

	elsif (lote_atuarial_w.ie_tipo_arquivo = 5) then
	
		lote_atuarial_w := pls_dados_atuariais_pck.gera_dados_prest(lote_atuarial_w, nm_usuario_p);
	
	-- Produto

	elsif (lote_atuarial_w.ie_tipo_arquivo = 6) then
	
		lote_atuarial_w := pls_dados_atuariais_pck.gera_dados_prod(lote_atuarial_w, nm_usuario_p);
		
	elsif (lote_atuarial_w.ie_tipo_arquivo = 7) then
		
		lote_atuarial_w := pls_dados_atuariais_pck.gera_dados_proc(lote_atuarial_w, nm_usuario_p);
		
	end if;
	
	

	-- marca o final da execucao

	lote_atuarial_w := pls_dados_atuariais_pck.fim_geracao_lote(lote_atuarial_w, nm_usuario_p);
exception

	when others then
		rollback;
		
		-- marca o final da execucao

		lote_atuarial_w := pls_dados_atuariais_pck.fim_geracao_lote(lote_atuarial_w, nm_usuario_p);
		
		-- Marca a execucao como "falha"			

		lote_atuarial_w := pls_dados_atuariais_pck.falha_processamento_lote(lote_atuarial_w, nm_usuario_p);
		
		commit;			
end;


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_dados_atuariais_pck.gerar_dados_atuariais_lote ( nr_seq_lote_p pls_atuarial_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
