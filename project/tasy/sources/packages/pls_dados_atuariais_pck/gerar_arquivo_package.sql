-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_dados_atuariais_pck.gerar_arquivo ( lote_atuarial_p INOUT lote_atuarial, regra_arquivo_p INOUT regra_arquivo) AS $body$
DECLARE

_ora2pg_r RECORD;
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Gera o arquivo conforme o lote.
	
	E buscado o titulo das colunas, caso todas forem definidas, elas serao atribuidas
	na primeira linha do arquivo. Caso alguma coluna nao tenha o cabecalho informado,
	todas as demais serao ignoradas.
	
	Sera montado um SQL que ira concatenar todos os campos configurados, conforme
	nr_ordem, sera feita a carga destes dados e entao gravados no UTL FILE.

-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

	
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */

ds_titulo_w		varchar(4000):= '';
ds_tabela_dados_w	varchar(30);
campos_arquivo_w	campo_arquivo;


ds_sql_w		varchar(32000):= '';
dado_bind_w		sql_pck.t_dado_bind;



BEGIN

-- levanta a tabela de dados 

ds_tabela_dados_w := pls_dados_atuariais_pck.retorna_tabela_dados_arq(lote_atuarial_p.ie_tipo_arquivo);

-- Carrega os campos

campos_arquivo_w := pls_dados_atuariais_pck.gera_campo_arquivo(regra_arquivo_p.nr_seq_regra, 'a');

-- Retorna o titulo (se houver)

campos_arquivo_w := pls_dados_atuariais_pck.retorna_titulo_arq(campos_arquivo_w);


-- Monta o SQL e os bindings

dado_bind_w.delete;

SELECT * FROM pls_dados_atuariais_pck.retorna_sql_arq(lote_atuarial_p, campos_arquivo_w, ds_tabela_dados_w, dado_bind_w) INTO STRICT _ora2pg_r;
 lote_atuarial_p := _ora2pg_r.lote_atuarial_p; campos_arquivo_w := _ora2pg_r.campos_arquivo_p; dado_bind_w := _ora2pg_r.dado_bind_p;

-- Grava o arquivo

dado_bind_w := pls_dados_atuariais_pck.grava_conteudo_arquivo(regra_arquivo_p, ds_titulo_w, ds_sql_w, dado_bind_w);


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_dados_atuariais_pck.gerar_arquivo ( lote_atuarial_p INOUT lote_atuarial, regra_arquivo_p INOUT regra_arquivo) FROM PUBLIC;
