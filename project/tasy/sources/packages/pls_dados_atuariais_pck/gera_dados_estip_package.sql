-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_dados_atuariais_pck.gera_dados_estip ( lote_estip_p INOUT lote_atuarial, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

_ora2pg_r RECORD;
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Gerar os dados do estipulante conforme o lote passado.

	A rotina vai montar um sql dinamico conforme os filtros existentes do estipulante,
	que ira fazer um bulk insert
	
	Atualmente poucos filtros estao previstos, portanto a estrutura vai se manter com baixa
	complexidade, para permitir a adicao de eventuais filtros posteriormente.
	
	A rotina em si deve possuir apenas chamadas para outras rotinas, exceto no loop
	que fara a carga de dados para o banco.

-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

	
Alteracoes:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


dado_bind_w	sql_pck.t_dado_bind;
sql_w		varchar(32000) :='';

BEGIN

-- Validacao

CALL pls_dados_atuariais_pck.valida_gera_dados_estip(lote_estip_p);
commit;


-- Monta a query dinamica com os filtro do lote em si.

dado_bind_w.delete;
SELECT * FROM pls_dados_atuariais_pck.retorna_sql_dados_estip(lote_estip_p, dado_bind_w, nm_usuario_p) INTO STRICT _ora2pg_r;
 lote_estip_p := _ora2pg_r.lote_estip_p; dado_bind_w := _ora2pg_r.dado_bind_p;

-- Gravar log

CALL pls_dados_atuariais_pck.gravar_log(	lote_estip_p.nr_sequencia,
					lote_estip_p.nr_seq_estip_regra, 
					lote_estip_p.ie_tipo_arquivo, 
					sql_w, 
					dado_bind_w := pls_dados_atuariais_pck.obter_bind_log(dado_bind_w), 
					dbms_utility.format_error_backtrace, 
					nm_usuario_p);

-- Executa o sql dinamico gerando os dados

dado_bind_w := sql_pck.executa_sql(sql_w, dado_bind_w, 'S');


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_dados_atuariais_pck.gera_dados_estip ( lote_estip_p INOUT lote_atuarial, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
