-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION document_builder_pck.obter_modified_tc ( nr_seq_intensao_uso_p reg_intencao_uso.nr_sequencia%type, dt_inicio_p reg_caso_teste_hist.dt_aprovacao%type, dt_final_p reg_caso_teste_hist.dt_inclusao_hist%type ) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE

t_objeto_row_w		t_objeto_row;
ds_sql_w		varchar(4000);
ds_params_w		varchar(255);
nr_result_w		smallint;
dt_geracao_versao_w	timestamp;

  rs_w RECORD;

BEGIN

	for rs_w in
		(
			SELECT  'TASY_TC_'||ct.nr_sequencia tc_id,
				ct.dt_aprovacao approval_date,
				( SELECT  ct1.ds_descricao
				  from    reg_caso_teste_hist ct1
				  where   ct1.nr_seq_caso_teste = ct.nr_sequencia
				  and     ct1.nr_sequencia = (  select  max(ct2.nr_sequencia) 
								from    reg_caso_teste_hist ct2
								where   ct2.nr_seq_caso_teste = ct1.nr_seq_caso_teste
								and     trunc(ct2.dt_aprovacao) < dt_inicio_p
								)
				) 
				old_description,
				(   select  a1.ds_passo
				    from    reg_acao_teste_hist a1 
				    where   a1.nr_seq_caso_teste = ct.nr_sequencia
				    and     a1.nr_seq_acao_teste = a.nr_sequencia
				    and     a1.nr_sequencia = ( select  max(a2.nr_sequencia)
								from    reg_acao_teste_hist a2
								where   a2.nr_seq_acao_teste = a1.nr_seq_acao_teste
								and     trunc(a2.dt_inclusao_hist) < dt_inicio_p
					    )
				) 
				old_step,
				(   select  a1.ds_resultado
				    from    reg_acao_teste_hist a1 
				    where   a1.nr_seq_caso_teste = ct.nr_sequencia
				    and     a1.nr_seq_acao_teste = a.nr_sequencia
				    and     a1.nr_sequencia = ( select  max(a2.nr_sequencia)
								from    reg_acao_teste_hist a2
								where   a2.nr_seq_acao_teste = a1.nr_seq_acao_teste
								and     trunc(a2.dt_inclusao_hist) < dt_inicio_p
					    )
				)
				old_expected_result,
				(   select  a1.ds_result_pass
				    from    reg_acao_teste_hist a1 
				    where   a1.nr_seq_caso_teste = ct.nr_sequencia
				    and     a1.nr_seq_acao_teste = a.nr_sequencia
				    and     a1.nr_sequencia = ( select  max(a2.nr_sequencia)
								from    reg_acao_teste_hist a2
								where   a2.nr_seq_acao_teste = a1.nr_seq_acao_teste
								and     trunc(a2.dt_inclusao_hist) < dt_inicio_p
					    )
				)
				old_result_passed,
				(   select  a1.ds_result_fail
				    from    reg_acao_teste_hist a1 
				    where   a1.nr_seq_caso_teste = ct.nr_sequencia
				    and     a1.nr_seq_acao_teste = a.nr_sequencia
				    and     a1.nr_sequencia = ( select  max(a2.nr_sequencia)
								from    reg_acao_teste_hist a2
								where   a2.nr_seq_acao_teste = a1.nr_seq_acao_teste
								and     trunc(a2.dt_inclusao_hist) < dt_inicio_p
					    )
				)
				old_result_fail,
				ct.ds_descricao updated_description,
				a.ds_passo updated_step,
				a.ds_resultado updated_expected_result,
				a.ds_result_pass,
				a.ds_result_fail,
				( select  max(l.ds_reason)
				  from    reg_artifacts_log l
				  where   l.ds_object_table =  'REG_CASO_TESTE' 
				  and     nr_seq_object = ct.nr_sequencia
				  and     trunc(l.dt_atualizacao_nrec) between dt_inicio_p and dt_final_p
				)
				ds_rational,
				pr.cd_prs_id,
				ct.nr_sequencia nr_seq_caso_teste
			from    reg_caso_teste ct,
				reg_acao_teste  a,
				reg_product_requirement pr
			where   1=1
			and     ct.nr_sequencia = a.nr_seq_caso_teste
			and     ct.nr_seq_product = pr.nr_sequencia
			and     a.ie_situacao = 'A'
			and     exists (   select  1
					    from    reg_caso_teste_hist ct1
					    where   ct1.nr_seq_caso_teste = ct.nr_sequencia
					    and     ct1.ie_tipo_alteracao = 'A'
					    and     trunc(ct1.dt_inclusao_hist) between dt_inicio_p and dt_final_p

					)

			and     exists (    select  * 
					    from    reg_intencao_uso a1,
						    reg_area_customer b1,
						    reg_features_customer c1,
						    reg_customer_requirement d1,
						    reg_product_requirement e1
					    where   1=1
					    and     a1.nr_sequencia = b1.nr_seq_intencao_uso
					    and     b1.nr_sequencia = c1.nr_seq_area_customer
					    and     c1.nr_sequencia = d1.nr_seq_features
					    and     d1.nr_sequencia = e1.nr_customer_requirement
					    and     a1.nr_sequencia = nr_seq_intensao_uso_p  -- intensao de uso Tasy
					    and     e1.nr_sequencia = pr.nr_sequencia 
					)

			order by nr_seq_caso_teste, nr_ordenacao
  )
  loop
	t_objeto_row_w.tc_id        		:= rs_w.tc_id;
	t_objeto_row_w.approval_date		:= rs_w.approval_date;
	t_objeto_row_w.old_description		:= rs_w.old_description;
	t_objeto_row_w.old_step			:= rs_w.old_step;
	t_objeto_row_w.old_expected_result	:= rs_w.old_expected_result;
	t_objeto_row_w.old_result_passed	:= rs_w.old_result_passed;
	t_objeto_row_w.old_result_fail		:= rs_w.old_result_fail;
	t_objeto_row_w.updated_description	:= rs_w.updated_description;
	t_objeto_row_w.updated_step		:= rs_w.updated_step;
	t_objeto_row_w.updated_expected_result	:= rs_w.updated_expected_result;
	t_objeto_row_w.ds_result_pass		:= rs_w.ds_result_pass;
	t_objeto_row_w.ds_result_fail		:= rs_w.ds_result_fail;
	t_objeto_row_w.ds_rational		:= rs_w.ds_rational;
	t_objeto_row_w.cd_prs_id		:= rs_w.cd_prs_id;
	t_objeto_row_w.nr_seq_caso_teste	:= rs_w.nr_seq_caso_teste;

	RETURN NEXT t_objeto_row_w;

  end loop;

  return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION document_builder_pck.obter_modified_tc ( nr_seq_intensao_uso_p reg_intencao_uso.nr_sequencia%type, dt_inicio_p reg_caso_teste_hist.dt_aprovacao%type, dt_final_p reg_caso_teste_hist.dt_inclusao_hist%type ) FROM PUBLIC;
