-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



	-->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>OBTER RESTRICOES BENEFICIARIOS<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<--



CREATE OR REPLACE FUNCTION mprev_pop_alvo_pck.obter_restricao_benef ( dados_regra_p mprev_pop_alvo_pck.regra_benef) RETURNS varchar AS $body$
DECLARE


	ds_retorno_w		varchar(4000)	:= null;
	dt_mim_inclusao_plano_w	timestamp;

	
BEGIN

	--IE_PRECO

	if (dados_regra_p.ie_preco IS NOT NULL AND dados_regra_p.ie_preco::text <> '') then
		-- Aqui monta a restricao e atualiza o valor das binds.

		ds_retorno_w :=	ds_retorno_w || current_setting('mprev_pop_alvo_pck.enter_w')::pls_util_pck.enter_w%type ||
						' and	benef.ie_preco_plano = :ie_preco_pc ';

		current_setting('mprev_pop_alvo_pck.bind_sql_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':ie_preco_pc', dados_regra_p.ie_preco, current_setting('mprev_pop_alvo_pck.bind_sql_w')::sql_pck.t_dado_bind);
	end if;

	--QT_MINIMA_DIAS_PLANO

	if (dados_regra_p.qt_minima_dias_plano IS NOT NULL AND dados_regra_p.qt_minima_dias_plano::text <> '') then
		-- Retorna a data para a quantidade minima de dias no plano. Ajuste de performance.

		dt_mim_inclusao_plano_w := (clock_timestamp() - dados_regra_p.qt_minima_dias_plano);

		-- Aqui monta a restricao e atualiza o valor das binds.

		ds_retorno_w :=	ds_retorno_w || current_setting('mprev_pop_alvo_pck.enter_w')::pls_util_pck.enter_w%type ||
						' and	benef.dt_inclusao_plano < :dt_mim_inclusao_plano_pc ';

		current_setting('mprev_pop_alvo_pck.bind_sql_w')::sql_pck.t_dado_bind := sql_pck.bind_variable(':dt_mim_inclusao_plano_pc', dt_mim_inclusao_plano_w, current_setting('mprev_pop_alvo_pck.bind_sql_w')::sql_pck.t_dado_bind);
	end if;

	--IE_SITUACAO_CONTRATO

	if (dados_regra_p.ie_situacao_contrato IS NOT NULL AND dados_regra_p.ie_situacao_contrato::text <> '') then
		-- Aqui monta a restricao e atualiza o valor das binds.

		if (dados_regra_p.ie_situacao_contrato = 'A') then
			ds_retorno_w :=	ds_retorno_w || current_setting('mprev_pop_alvo_pck.enter_w')::pls_util_pck.enter_w%type ||
							'and	benef.ie_situacao_contrato = ' || current_setting('mprev_pop_alvo_pck.aspas_w')::pls_util_pck.aspas_w%type || '2' || current_setting('mprev_pop_alvo_pck.aspas_w')::pls_util_pck.aspas_w%type;
		elsif (dados_regra_p.ie_situacao_contrato = 'I') then
			ds_retorno_w :=	ds_retorno_w || current_setting('mprev_pop_alvo_pck.enter_w')::pls_util_pck.enter_w%type ||
							'and	benef.ie_situacao_contrato <> ' || current_setting('mprev_pop_alvo_pck.aspas_w')::pls_util_pck.aspas_w%type || '2' || current_setting('mprev_pop_alvo_pck.aspas_w')::pls_util_pck.aspas_w%type;
		else
			null;
		end if;
	end if;

	--IE_ATENDIMENTO_SUSPENSO

	if (dados_regra_p.ie_atendimento_suspenso IS NOT NULL AND dados_regra_p.ie_atendimento_suspenso::text <> '') then
		-- Aqui monta a restricao e atualiza o valor das binds.

		if (dados_regra_p.ie_atendimento_suspenso = 'S') then
			ds_retorno_w :=	ds_retorno_w || current_setting('mprev_pop_alvo_pck.enter_w')::pls_util_pck.enter_w%type ||
							'and	benef.ie_situacao_atend = ' || current_setting('mprev_pop_alvo_pck.aspas_w')::pls_util_pck.aspas_w%type || 'I' || current_setting('mprev_pop_alvo_pck.aspas_w')::pls_util_pck.aspas_w%type;
		elsif (dados_regra_p.ie_atendimento_suspenso = 'N') then
			ds_retorno_w :=	ds_retorno_w || current_setting('mprev_pop_alvo_pck.enter_w')::pls_util_pck.enter_w%type ||
							'and	benef.ie_situacao_atend = ' || current_setting('mprev_pop_alvo_pck.aspas_w')::pls_util_pck.aspas_w%type || 'A' || current_setting('mprev_pop_alvo_pck.aspas_w')::pls_util_pck.aspas_w%type;
		else
			null;
		end if;
	end if;

	return	ds_retorno_w;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION mprev_pop_alvo_pck.obter_restricao_benef ( dados_regra_p mprev_pop_alvo_pck.regra_benef) FROM PUBLIC;
