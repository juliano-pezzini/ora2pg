-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

/*FUNCTION GET_STATUS_COUNT*/

CREATE OR REPLACE FUNCTION intpd_consulta_conta_pac_pkg.get_status_count (nr_seq_fila_p bigint) RETURNS SETOF T_STATUS_COUNT AS $body$
DECLARE

		r_status_count_w r_status_count_row;

	xml_w          xml;
	query_w        text;

	c01 CURSOR FOR
	SELECT	nr_atendimento,
		dt_inicio,
		dt_fim,
		ie_status
	from	xmltable('/STRUCTURE/FILTERS' passing xml_w columns
		nr_atendimento bigint path 'NR_ENCOUNTER',
		dt_inicio varchar(14) path 'DT_START',
		dt_fim varchar(14) path 'DT_END',
		ie_status varchar(1) path 'IE_STATUS');
	c01_w c01%rowtype;

	c02 CURSOR FOR
	SELECT	ie_status,
		count(*) as qt_records
	from (
		SELECT	nr_sequencia,
			nr_atendimento,
			dt_atualizacao,
			ie_status
		from (
			select	nr_sequencia,
				nr_atendimento,
				dt_atualizacao,
				ie_status,
				rank() over (
					partition by nr_seq_propaci
					order by dt_atualizacao desc, nr_sequencia desc) as rnk
			from	status_integr_conta_pac
			where	(nr_seq_propaci IS NOT NULL AND nr_seq_propaci::text <> '')) alias4
		where	rnk = 1
		
union all

		select	nr_sequencia,
			nr_atendimento,
			dt_atualizacao,
			ie_status
		from (
			select	nr_sequencia,
				nr_atendimento,
				dt_atualizacao,
				ie_status,
				rank() over (
					partition by nr_seq_matpaci
					order by dt_atualizacao desc, nr_sequencia desc) as rnk
			from	status_integr_conta_pac
			where	(nr_seq_matpaci IS NOT NULL AND nr_seq_matpaci::text <> '')) alias8
		where	rnk = 1) alias9
	where	1 = 1
	and	nr_atendimento = c01_w.nr_atendimento
	and (ie_status = c01_w.ie_status or coalesce(c01_w.ie_status::text, '') = '')
	and (dt_atualizacao >= to_date(c01_w.dt_inicio, 'yyyymmddhh24miss') or coalesce(c01_w.dt_inicio::text, '') = '')
	and (dt_atualizacao <= to_date(c01_w.dt_fim, 'yyyymmddhh24miss') or coalesce(c01_w.dt_fim::text, '') = '')
	group by ie_status;
	c02_w c02%rowtype;

	
BEGIN
	select	xmlparse(DOCUMENT, convert_from(, 'utf-8'))
	into STRICT	xml_w
	from	intpd_fila_transmissao
	where	nr_sequencia = nr_seq_fila_p;

	open c01;
	fetch c01 into c01_w;
	close c01;

	for c02_w in c02 loop
		r_status_count_w.ie_status	:= c02_w.ie_status;
		r_status_count_w.qt_records	:= c02_w.qt_records;
	RETURN NEXT r_status_count_w;
	end loop;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION intpd_consulta_conta_pac_pkg.get_status_count (nr_seq_fila_p bigint) FROM PUBLIC;
