-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE adep_gerar_horarios_pck.gerar_flag_horarios (nm_usuario_p text) AS $body$
DECLARE

		nr_seq_wadep_w		bigint;
		ds_sep_bv_w			varchar(50);
		current_setting('adep_gerar_horarios_pck.dt_horario_w')::timestamp		timestamp;
		ds_horario_w		varchar(20);
		nr_horario_w		integer;
		ds_comando_update_w	varchar(4000);
		c01 CURSOR FOR	
			SELECT	to_char(dt_horario,'yyyy-mm-dd hh24:mi:ss') ds_horario,
					dt_horario
			from	w_adep_horarios_t
			where	nm_usuario = nm_usuario_p 
			group by	dt_horario 
			order by	dt_horario;
	
BEGIN
		ds_sep_bv_w	:= obter_separador_bv;
		select	nextval('w_adep_t_seq')
		into STRICT	nr_seq_wadep_w		
		;
		insert into w_adep_t(
			nr_sequencia,
			nm_usuario,
			ie_tipo_item		
			)
		values (
			nr_seq_wadep_w,
			nm_usuario_p,
			'XH'
			);
		commit;		
		open c01;				
			loop	
				fetch c01 into
					ds_horario_w,
					current_setting('adep_gerar_horarios_pck.dt_horario_w')::timestamp;
				EXIT WHEN NOT FOUND; /* apply on c01 */
				begin
					nr_horario_w := adep_gerar_horarios_pck.get_posicao_horario(current_setting('adep_gerar_horarios_pck.dt_horario_w')::timestamp);
					if (nr_horario_w IS NOT NULL AND nr_horario_w::text <> '' AND nr_horario_w between 1 and 40) then																								
						ds_comando_update_w	:=	' update w_adep_t ' ||
												' set hora' || to_char(nr_horario_w) || ' = :vl_hora ' ||
												' where nr_sequencia = :nr_sequencia ' ||
												' and nm_usuario = :nm_usuario ' ||
												' and ie_tipo_item = :ie_tipo ';
						CALL exec_sql_dinamico_bv('ADEP', ds_comando_update_w, 'vl_hora=' || to_char(ds_horario_w) || ds_sep_bv_w ||
													'nr_sequencia=' || nr_seq_wadep_w || ds_sep_bv_w ||
													'nm_usuario=' || nm_usuario_p || ds_sep_bv_w ||
													'ie_tipo=XH' || ds_sep_bv_w );				
						commit;												
					end if;				
				end;																	
			end loop;						
		close c01;
	end;		

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_gerar_horarios_pck.gerar_flag_horarios (nm_usuario_p text) FROM PUBLIC;
