-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE adep_gerar_horarios_pck.adep_sincronizar_gas ( cd_estabelecimento_p bigint, cd_setor_usuario_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_atendimento_p bigint, dt_inicial_horarios_p timestamp, dt_final_horarios_p timestamp, dt_validade_limite_p timestamp, ie_exibir_hor_realizadas_p text, ie_exibir_hor_suspensas_p text, ie_regra_inclusao_p text, ie_data_lib_prescr_p text, ie_exibir_suspensos_p text, ie_agrupar_acm_sn_p text, dt_horario_p timestamp, nr_horario_p integer, ie_prescr_setor_p text, cd_setor_paciente_p bigint, ie_gas_horario_p text, ie_palm_p text, ie_html_p text, ie_java_p text) AS $body$
DECLARE

	ds_sep_bv_w		varchar(50);				
	nr_seq_gas_w	bigint;
	nr_seq_horario_w	bigint;
	ie_status_horario_w	varchar(15);
	ds_comando_update_w	varchar(4000);
	nr_etapa_sol_w		bigint;
	dt_etapa_prev_w		timestamp;
	dt_inicial_w		timestamp;
	dt_final_w		timestamp;
	current_setting('adep_gerar_horarios_pck.dt_horario_w')::timestamp	timestamp;
	nr_horario_w	integer;
	ds_prescricao_w		varchar(240);
	ie_recem_nato_w		varchar(1) := adep_gerar_horarios_pck.get_ie_recem_nato();	
	nr_seq_gas_cpoe_w	prescr_gasoterapia.nr_seq_gas_cpoe%type;
	ds_param_cpoe_w		varchar(255);

	c01 CURSOR FOR	
	SELECT	a.nr_prescricao,
			x.nr_sequencia,
			coalesce(substr(obter_status_gasoterapia(x.nr_sequencia, 'C'),1,10),'N'),
			coalesce(x.dt_prev_execucao, a.dt_inicio_prescr),
			x.nr_seq_gas_cpoe
	from	prescr_gasoterapia x,
			prescr_medica a
	where	x.nr_prescricao = a.nr_prescricao
	and		obter_se_exibir_rep_adep_setor(cd_setor_paciente_p,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.nr_atendimento = nr_atendimento_p
	and		((a.dt_validade_prescr between dt_validade_limite_p and dt_fim_w) or
			((getItensGasTerm = 'S') and ((substr(Obter_Status_Gasoterapia(x.nr_sequencia, 'C'),1,80) in ('I','IN','R')) or
			((substr(Obter_Status_Gasoterapia(x.nr_sequencia, 'C'),1,80) = 'N') and (dt_inicial_horarios_p between a.dt_inicio_prescr and a.dt_validade_prescr + get_minutos_vigente/1440)))) or (getItensGasTerm = 'T'))
	and		((ie_exibir_hor_realizadas_p = 'S') or ((ie_exibir_hor_realizadas_p = 'N') and coalesce(substr(obter_Status_Gasoterapia(x.nr_sequencia, 'C'),1,10),'N') <> 'T'))
	and		((ie_exibir_hor_suspensas_p = 'S') or ((ie_exibir_hor_suspensas_p = 'N') and coalesce(substr(obter_status_gasoterapia(x.nr_sequencia, 'C'),1,10),'N') <> 'S'))
	and		((ie_regra_inclusao_p = 'S') or
			((ie_regra_inclusao_p = 'R') and (adep_obter_regra_inclusao(	'OX',
																			cd_estabelecimento_p, 
																			cd_setor_usuario_p, 
																			cd_perfil_p, 
																			null, 
																			null, 
																			null, 
																			null,
																			a.cd_Setor_atendimento,
																			null,
																			null,			-- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e nao haviam passado nada
																			null) = 'S')))	 -- nr_seq_exame_p
	and	 	((coalesce(x.dt_prev_execucao, a.dt_inicio_prescr) between dt_horario_inicio_sinc_w and dt_horario_fim_sinc_w) or 
			((getItensGasTerm = 'S') and ((substr(Obter_Status_Gasoterapia(x.nr_sequencia, 'C'),1,80) in ('I','IN','R')) or 
			((substr(Obter_Status_Gasoterapia(x.nr_sequencia, 'C'),1,80) = 'N') and (dt_inicial_horarios_p between a.dt_inicio_prescr and a.dt_validade_prescr + get_minutos_vigente/1440)))) or (getItensGasTerm = 'T'))
	and	((coalesce(a.ie_recem_nato,'N')	= 'N') or (ie_recem_nato_w = 'S'))	
	and	 	((ie_prescr_setor_p = 'N') or (ie_prescr_setor_p = 'S' AND a.cd_setor_atendimento = cd_setor_paciente_p))
	and		((get_ie_vigente = 'N') or (clock_timestamp() between a.dt_inicio_prescr and a.dt_validade_prescr + get_minutos_vigente/1440))
	group by
			coalesce(x.dt_prev_execucao, a.dt_inicio_prescr),
			a.nr_prescricao,
			x.nr_sequencia,
			x.nr_seq_gas_cpoe
	order by 
			coalesce(x.dt_prev_execucao, a.dt_inicio_prescr) desc;
	c02 CURSOR FOR	
	SELECT	a.nr_prescricao,
			x.nr_sequencia,
			c.nr_sequencia,
			coalesce(substr(obter_status_etapa_gas(x.nr_sequencia,c.nr_etapa,c.dt_fim_horario,c.dt_suspensao),1,10),'N'),
			c.dt_horario,
			x.nr_seq_gas_cpoe,
			CASE WHEN getIeMostraDataGas='S' THEN 			coalesce(Obter_vel_inf_gas(x.nr_sequencia), x.qt_gasoterapia) || ' ' || coalesce(Obter_ie_unidade_gas(x.nr_sequencia), x.ie_unidade_medida)  || ' ' || z.ds_intervalo || '  ' || OBTER_DESC_EXPRESSAO(648277) || ' ' || obter_valor_dominio(2569,x.ie_inicio) || '  ' || OBTER_DESC_EXPRESSAO(888270) || ' ' || to_char(a.dt_prescricao,'dd/mm/yyyy hh24:mi:ss')  ELSE coalesce(Obter_vel_inf_gas(x.nr_sequencia), x.qt_gasoterapia) || ' ' || coalesce(Obter_ie_unidade_gas(x.nr_sequencia), x.ie_unidade_medida)  || ' ' || z.ds_intervalo || '  ' || OBTER_DESC_EXPRESSAO(648277) || ' ' || obter_valor_dominio(2569,x.ie_inicio) END
	FROM prescr_gasoterapia_hor c, prescr_medica a, prescr_gasoterapia x
LEFT OUTER JOIN intervalo_prescricao z ON (x.cd_intervalo = z.cd_intervalo)
WHERE x.nr_prescricao = a.nr_prescricao and x.nr_prescricao = c.nr_prescricao and x.nr_sequencia  = c.nr_seq_gasoterapia  and obter_se_exibir_rep_adep_setor(cd_setor_paciente_p,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S' and a.nr_atendimento = nr_atendimento_p and ((a.dt_validade_prescr between dt_validade_limite_p and dt_fim_w) or 
			((getItensGasTerm = 'S') and ((substr(Obter_Status_Gasoterapia(x.nr_sequencia, 'C'),1,80) in ('I','IN','R')) or 
			((substr(Obter_Status_Gasoterapia(x.nr_sequencia, 'C'),1,80) = 'N') and (dt_inicial_horarios_p between a.dt_inicio_prescr and a.dt_validade_prescr + get_minutos_vigente/1440)))) or (getItensGasTerm = 'T')) and (c.dt_lib_horario IS NOT NULL AND c.dt_lib_horario::text <> '') and c.dt_horario between dt_inicial_horarios_p and dt_final_horarios_p and ((ie_exibir_hor_realizadas_p = 'S') or ((ie_exibir_hor_realizadas_p = 'N') and coalesce(substr(obter_status_gasoterapia(x.nr_sequencia, 'C'),1,10),'N') <> 'T')) and ((ie_exibir_suspensos_p = 'S') or ((ie_exibir_suspensos_p = 'N') and (coalesce(x.dt_suspensao::text, '') = ''))) and ((ie_exibir_hor_suspensas_p = 'S') or ((ie_exibir_hor_suspensas_p = 'N') and coalesce(substr(obter_status_etapa_gas(x.nr_sequencia, c.nr_etapa, c.dt_fim_horario, c.dt_suspensao),1,10),'N') <> 'S')) and ((coalesce(a.ie_recem_nato,'N')	= 'N') or (ie_recem_nato_w = 'S')) and ((ie_regra_inclusao_p = 'S') or
			((ie_regra_inclusao_p = 'R') and (adep_obter_regra_inclusao(	'OX', 
																			cd_estabelecimento_p, 
																			cd_setor_usuario_p, 
																			cd_perfil_p, 
																			null, 
																			null, 
																			null, 
																			null,
																			a.cd_Setor_atendimento,
																			null,
																			null,			-- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e nao haviam passado nada
																			null) = 'S')))  -- nr_seq_exame_p
  and ((ie_prescr_setor_p = 'N') or (ie_prescr_setor_p = 'S' AND a.cd_setor_atendimento = cd_setor_paciente_p)) and ((get_ie_vigente = 'N') or (clock_timestamp() between a.dt_inicio_prescr and a.dt_validade_prescr + get_minutos_vigente/1440)) and coalesce(c.ie_horario_especial,'N') = 'N' and (((coalesce(ie_palm_p,'N') = 'S') and (coalesce(c.dt_interrupcao::text, '') = '')) or (coalesce(ie_palm_p,'N') = 'N')) group by
			c.dt_horario,
			a.nr_prescricao,
			x.nr_sequencia,
			c.nr_sequencia,
			coalesce(substr(obter_status_etapa_gas(x.nr_sequencia,c.nr_etapa,c.dt_fim_horario,c.dt_suspensao),1,10),'N'),
			CASE WHEN getIeMostraDataGas='S' THEN 			coalesce(Obter_vel_inf_gas(x.nr_sequencia), x.qt_gasoterapia) || ' ' || coalesce(Obter_ie_unidade_gas(x.nr_sequencia), x.ie_unidade_medida)  || ' ' || z.ds_intervalo || '  ' || OBTER_DESC_EXPRESSAO(648277) || ' ' || obter_valor_dominio(2569,x.ie_inicio) || '  ' || OBTER_DESC_EXPRESSAO(888270) || ' ' || to_char(a.dt_prescricao,'dd/mm/yyyy hh24:mi:ss')  ELSE coalesce(Obter_vel_inf_gas(x.nr_sequencia), x.qt_gasoterapia) || ' ' || coalesce(Obter_ie_unidade_gas(x.nr_sequencia), x.ie_unidade_medida)  || ' ' || z.ds_intervalo || '  ' || OBTER_DESC_EXPRESSAO(648277) || ' ' || obter_valor_dominio(2569,x.ie_inicio) END ,
			x.nr_seq_gas_cpoe
	order by 
			c.dt_horario desc;
	
BEGIN
	ds_sep_bv_w	:= obter_separador_bv;
	dt_inicial_w	:= dt_horario_p	- 2;
	dt_final_w	:= dt_horario_p + 2;

    if (ie_gas_horario_p = 'N' and (getIeGasSeparada = 'S' or (ie_html_p = 'N' and (ie_java_p = 'N' or (ie_java_p = 'S' and verificar_cpoe_ativa(	cd_estabelecimento_p, nr_atendimento_p) = 'N'))))) then

		open c01;
		loop
		fetch c01 into	current_setting('adep_gerar_horarios_pck.nr_prescricao_w')::prescr_medica.nr_prescricao%type,
				nr_seq_gas_w,
				ie_status_horario_w,
				current_setting('adep_gerar_horarios_pck.dt_horario_w')::timestamp,
				nr_seq_gas_cpoe_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			nr_horario_w := adep_gerar_horarios_pck.get_posicao_horario( current_setting('adep_gerar_horarios_pck.dt_horario_w')::timestamp );
			if (nr_horario_w IS NOT NULL AND nr_horario_w::text <> '') then
				if ('IN' = ie_status_horario_w) then
					ie_status_horario_w := 'T';
				elsif ('T' = ie_status_horario_w) then
					ie_status_horario_w := 'A';
				elsif ('R' = ie_status_horario_w) then
					ie_status_horario_w := 'I';
				elsif ('V' = ie_status_horario_w) then
					ie_status_horario_w := 'I';
				end if;
				ds_comando_update_w	:=	' update w_adep_t ' ||
										' set hora' || to_char(nr_horario_w) || ' = :vl_hora, ' ||
										' nr_prescricoes = adep_juntar_prescricao(nr_prescricoes,:nr_prescricao), ' ||
										' ds_horarios = adep_atualizar_inf_horarios(ds_horarios,:nr_horario,:vl_hora) ' ||
										' where nm_usuario = :nm_usuario ' ||
										' and ie_tipo_item = :ie_tipo ' ||
										' and nvl(nr_prescricao,nvl(:nr_prescricao,0)) = nvl(:nr_prescricao,0) ' ||
										--' and nvl(nr_seq_cpoe,nvl(:nr_seq_cpoe,0)) = nvl(:nr_seq_cpoe,0) ' ||
										' and nvl(nr_seq_item,nvl(:nr_seq_item,0)) = nvl(:nr_seq_item,0) ';
				CALL exec_sql_dinamico_bv('ADEP', ds_comando_update_w,	'vl_hora=S' || to_char(nr_seq_gas_w) || 'H' || ie_status_horario_w || ds_sep_bv_w ||
									 'nr_prescricao=' || to_char(current_setting('adep_gerar_horarios_pck.nr_prescricao_w')::prescr_medica.nr_prescricao%type) || ds_sep_bv_w ||
									-- 'nr_seq_cpoe=' || to_char(nr_seq_gas_cpoe_w) || ds_sep_bv_w || 
									 'nr_horario=' || to_char(nr_horario_p) || ds_sep_bv_w || 
									 'nm_usuario=' || nm_usuario_p || ds_sep_bv_w || 
									 'ie_tipo=O' || ds_sep_bv_w ||
									 'nr_seq_item=' || to_char(nr_seq_gas_w) || ds_sep_bv_w );
				commit;
			end if;
			end;
		end loop;
		close c01;
	elsif	((ie_gas_horario_p = 'S') or (getIeGasSeparada = 'N' and (ie_html_p = 'S' or (ie_java_p = 'S' and verificar_cpoe_ativa(cd_estabelecimento_p, nr_atendimento_p) = 'N')))) then

		open c02;
		loop
		fetch c02 into	current_setting('adep_gerar_horarios_pck.nr_prescricao_w')::prescr_medica.nr_prescricao%type,
				nr_seq_gas_w,
				nr_seq_horario_w,
				ie_status_horario_w,
				current_setting('adep_gerar_horarios_pck.dt_horario_w')::timestamp,
				nr_seq_gas_cpoe_w,
				ds_prescricao_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			nr_horario_w := adep_gerar_horarios_pck.get_posicao_horario( current_setting('adep_gerar_horarios_pck.dt_horario_w')::timestamp );
			ds_param_cpoe_w	:= '';

			if (nr_horario_w IS NOT NULL AND nr_horario_w::text <> '') then
				ds_comando_update_w	:=	' update w_adep_t ' ||
								' set hora' || to_char(nr_horario_w) || ' = :vl_hora, ' ||
								' nr_prescricoes = adep_juntar_prescricao(nr_prescricoes,:nr_prescricao) ' ||
								' ,ds_horarios = adep_atualizar_inf_horarios(ds_horarios,:nr_horario,:vl_hora) ' ||
								' where nm_usuario = :nm_usuario ' ||
								' and ie_tipo_item = :ie_tipo ' ||
								' and nvl(nr_prescricao,nvl(:nr_prescricao,0)) = nvl(:nr_prescricao,0) ' ||
								' and nvl(nr_seq_item,nvl(:nr_seq_item,0)) = nvl(:nr_seq_item,0) ';

				if (getIeGasSeparada = 'N') then
					ds_comando_update_w	:= ds_comando_update_w || ' and	nr_seq_cpoe = :nr_seq_cpoe ';
					ds_param_cpoe_w		:= 'nr_seq_cpoe=' || to_char(nr_seq_gas_cpoe_w) || ds_sep_bv_w;
				else
					ds_comando_update_w	:= ds_comando_update_w || ' and nvl(ds_prescricao,''XPTO'') = nvl(:ds_prescricao,''XPTO'')  ';
					ds_param_cpoe_w		:= 'ds_prescricao='|| ds_prescricao_w || ds_sep_bv_w;
				end if;

				CALL exec_sql_dinamico_bv('ADEP', ds_comando_update_w,	'vl_hora=S' || to_char(nr_seq_horario_w) || 'H' || ie_status_horario_w || ds_sep_bv_w ||
											'nr_prescricao=' || to_char(current_setting('adep_gerar_horarios_pck.nr_prescricao_w')::prescr_medica.nr_prescricao%type) || ds_sep_bv_w ||
											'nr_horario=' || to_char(nr_horario_p) || ds_sep_bv_w ||
											'nm_usuario=' || nm_usuario_p || ds_sep_bv_w ||
											'ie_tipo=O' || ds_sep_bv_w ||
											'nr_seq_item=' || to_char(nr_seq_gas_w) || ds_sep_bv_w ||
											ds_param_cpoe_w);
				commit;
			end if;
			end;
		end loop;
		close c02;
	end if;
	CALL Atualizar_adep_controle(nm_usuario_p, nr_atendimento_p, 'G', 'N');
	commit;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_gerar_horarios_pck.adep_sincronizar_gas ( cd_estabelecimento_p bigint, cd_setor_usuario_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_atendimento_p bigint, dt_inicial_horarios_p timestamp, dt_final_horarios_p timestamp, dt_validade_limite_p timestamp, ie_exibir_hor_realizadas_p text, ie_exibir_hor_suspensas_p text, ie_regra_inclusao_p text, ie_data_lib_prescr_p text, ie_exibir_suspensos_p text, ie_agrupar_acm_sn_p text, dt_horario_p timestamp, nr_horario_p integer, ie_prescr_setor_p text, cd_setor_paciente_p bigint, ie_gas_horario_p text, ie_palm_p text, ie_html_p text, ie_java_p text) FROM PUBLIC;
