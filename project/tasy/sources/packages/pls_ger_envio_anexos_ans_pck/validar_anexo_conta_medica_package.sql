-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ger_envio_anexos_ans_pck.validar_anexo_conta_medica ( nr_lote_guias_rec_p pls_anexo_imp.nr_lote_guias_rec%type, nr_protocolo_prestador_p pls_anexo_imp.nr_protocolo_prestador%type, cd_guia_prestador_p pls_anexo_imp.cd_guia_prestador%type, cd_guia_p pls_anexo_imp.cd_guia%type, nr_documento_prest_p pls_anexo_imp.nr_documento_prest%type, cd_tipo_documento_p pls_anexo_imp.cd_tipo_documento%type, cd_formato_documento_p pls_anexo_imp.cd_formato_documento%type, nr_seq_item_tiss_p pls_anexo_imp.nr_seq_item_tiss%type, nr_seq_prestador_p pls_anexo_imp.nr_seq_prestador%type, nr_seq_conta_p INOUT pls_conta.nr_sequencia%type, nr_seq_protocolo_p INOUT pls_protocolo_conta.nr_sequencia%type, cd_motivo_glosa_p INOUT pls_anexo_imp.cd_motivo_glosa%type, ds_motivo_glosa_p INOUT pls_anexo_imp.ds_motivo_glosa%type, ie_status_p INOUT pls_anexo_imp.ie_status%type) AS $body$
BEGIN

  if (coalesce(cd_guia_p::text, '') = '' and coalesce(cd_guia_prestador_p::text, '') = '') then

    --se nao tem o protocolo informado, emite a msg de lote nao informado, pois nao conseguira localizar a mesma
    if ( (nr_lote_guias_rec_p IS NOT NULL AND nr_lote_guias_rec_p::text <> '') and coalesce(nr_protocolo_prestador_p::text, '') = '') then
		cd_motivo_glosa_p := '5047';
		ds_motivo_glosa_p := obter_texto_dic_objeto( 1211639, wheb_usuario_pck.get_nr_seq_idioma, null);
		ie_status_p := 'G';
    end if;

    --Se nao tem nem lote e nem protocolo informado, tambem nao conseguira localizar.
    if (   coalesce(nr_lote_guias_rec_p::text, '') = '' and coalesce(nr_protocolo_prestador_p::text, '') = '') then
      cd_motivo_glosa_p := '1307';
	  ds_motivo_glosa_p := obter_texto_dic_objeto( 1211640, wheb_usuario_pck.get_nr_seq_idioma, null);
      ie_status_p := 'G';
    end if;

  end if;

  --quando um dos campos de guia estiver informado e o outro nao estiver informado
  if ((coalesce(cd_guia_p::text, '') = '' or coalesce(cd_guia_prestador_p::text, '') = '') and ((cd_guia_p IS NOT NULL AND cd_guia_p::text <> '') or (cd_guia_prestador_p IS NOT NULL AND cd_guia_prestador_p::text <> '')) ) then
    cd_motivo_glosa_p := '1307';
	ds_motivo_glosa_p := obter_texto_dic_objeto( 1211640, wheb_usuario_pck.get_nr_seq_idioma, null);
    ie_status_p := 'G';
  end if;

  if (cd_guia_p IS NOT NULL AND cd_guia_p::text <> '' AND cd_guia_prestador_p IS NOT NULL AND cd_guia_prestador_p::text <> '')then

    SELECT * FROM pls_ger_envio_anexos_ans_pck.validar_anexo_conta_guia(  nr_protocolo_prestador_p, cd_guia_prestador_p, cd_guia_p, nr_seq_prestador_p, nr_seq_conta_p, cd_motivo_glosa_p, ds_motivo_glosa_p, ie_status_p, nr_seq_protocolo_p) INTO STRICT nr_seq_conta_p, cd_motivo_glosa_p, ds_motivo_glosa_p, ie_status_p, nr_seq_protocolo_p;

  elsif (nr_protocolo_prestador_p IS NOT NULL AND nr_protocolo_prestador_p::text <> '') then

    SELECT * FROM pls_ger_envio_anexos_ans_pck.validar_anexo_conta_prot( nr_protocolo_prestador_p, nr_seq_prestador_p, nr_seq_protocolo_p, cd_motivo_glosa_p, ds_motivo_glosa_p, ie_status_p) INTO STRICT nr_seq_protocolo_p, cd_motivo_glosa_p, ds_motivo_glosa_p, ie_status_p;

  end if;

  if (coalesce(cd_motivo_glosa_p::text, '') = '')  then
  
	 if ( coalesce(pls_ger_envio_anexos_ans_pck.obter_regra_cta_medica( nr_seq_protocolo_p, nr_seq_conta_p, cd_tipo_documento_p)::text, '') = '')then
	 
		cd_motivo_glosa_p := '3163';
		ds_motivo_glosa_p := obter_texto_dic_objeto( 1211644, wheb_usuario_pck.get_nr_seq_idioma, null);
		nr_seq_protocolo_p := null;
		nr_seq_conta_p := null;
		ie_status_p := 'G';
	 end if;	
  end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ger_envio_anexos_ans_pck.validar_anexo_conta_medica ( nr_lote_guias_rec_p pls_anexo_imp.nr_lote_guias_rec%type, nr_protocolo_prestador_p pls_anexo_imp.nr_protocolo_prestador%type, cd_guia_prestador_p pls_anexo_imp.cd_guia_prestador%type, cd_guia_p pls_anexo_imp.cd_guia%type, nr_documento_prest_p pls_anexo_imp.nr_documento_prest%type, cd_tipo_documento_p pls_anexo_imp.cd_tipo_documento%type, cd_formato_documento_p pls_anexo_imp.cd_formato_documento%type, nr_seq_item_tiss_p pls_anexo_imp.nr_seq_item_tiss%type, nr_seq_prestador_p pls_anexo_imp.nr_seq_prestador%type, nr_seq_conta_p INOUT pls_conta.nr_sequencia%type, nr_seq_protocolo_p INOUT pls_protocolo_conta.nr_sequencia%type, cd_motivo_glosa_p INOUT pls_anexo_imp.cd_motivo_glosa%type, ds_motivo_glosa_p INOUT pls_anexo_imp.ds_motivo_glosa%type, ie_status_p INOUT pls_anexo_imp.ie_status%type) FROM PUBLIC;
