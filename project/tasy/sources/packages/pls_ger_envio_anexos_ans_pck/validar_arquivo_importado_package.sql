-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ger_envio_anexos_ans_pck.validar_arquivo_importado ( nr_sequencia_p pls_anexo_imp.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_guia_p INOUT pls_guia_plano.nr_sequencia%type, nr_seq_conta_p INOUT pls_conta.nr_sequencia%type, nr_seq_protocolo_p INOUT pls_protocolo_conta.nr_sequencia%type, nr_seq_prot_rec_p INOUT pls_rec_glosa_protocolo.nr_sequencia%type, cd_motivo_glosa_p INOUT pls_anexo_imp.cd_motivo_glosa%type, ds_motivo_glosa_p INOUT pls_anexo_imp.ds_motivo_glosa%type, ie_status_p INOUT pls_anexo_imp.ie_status%type) AS $body$
DECLARE


nr_lote_guias_rec_w    		pls_anexo_imp.nr_lote_guias_rec%type;
nr_protocolo_prestador_w    pls_anexo_imp.nr_protocolo_prestador%type;
cd_guia_prestador_w         pls_anexo_imp.cd_guia_prestador%type;
cd_guia_w                   pls_anexo_imp.cd_guia%type;
nr_documento_prest_w        pls_anexo_imp.nr_documento_prest%type;
cd_natureza_guia_w          pls_anexo_imp.cd_natureza_guia%type;
cd_formato_documento_w      pls_anexo_imp.cd_formato_documento%type;
nr_seq_item_tiss_w          pls_anexo_imp.nr_seq_item_tiss%type;
cd_cgc_prestador_w          pls_anexo_imp.cd_cgc_prestador%type;
nr_cpf_prestador_w          pls_anexo_imp.nr_cpf_prestador%type;
cd_prestador_w            	pls_anexo_imp.cd_prestador%type;
nr_seq_prestador_w    		pls_anexo_imp.nr_seq_prestador%type;
cd_pessoa_fisica_w    		pessoa_fisica.cd_pessoa_fisica%type;
ie_status_w        			pls_anexo_imp.ie_status%type;
nr_seq_prest_w      		pls_anexo_imp.nr_seq_prestador%type;
cd_tipo_documento_w    		pls_anexo_imp.cd_tipo_documento%type;


BEGIN

	select  a.nr_lote_guias_rec,
			a.nr_protocolo_prestador,
			a.cd_guia_prestador,
			a.cd_guia,
			a.nr_documento_prest,
			a.cd_natureza_guia,
			a.cd_formato_documento,
			a.nr_seq_item_tiss,
			a.cd_cgc_prestador,
			a.nr_cpf_prestador,
			a.cd_prestador,
			a.nr_seq_prestador,
			a.cd_tipo_documento
	into STRICT  	nr_lote_guias_rec_w,
			nr_protocolo_prestador_w,
			cd_guia_prestador_w,
			cd_guia_w,
			nr_documento_prest_w,
			cd_natureza_guia_w,
			cd_formato_documento_w,
			nr_seq_item_tiss_w,
			cd_cgc_prestador_w,
			nr_cpf_prestador_w,
			cd_prestador_w,
			nr_seq_prest_w,
			cd_tipo_documento_w
	from	pls_anexo_imp a
	where  	a.nr_sequencia = nr_sequencia_p;

	nr_seq_prestador_w := pls_obter_prestador_imp( cd_cgc_prestador_w, nr_cpf_prestador_w, cd_prestador_w, null, null, null, 'C', cd_estabelecimento_p, null);

	if (nr_seq_prestador_w IS NOT NULL AND nr_seq_prestador_w::text <> '') then
		update  pls_anexo_imp
		set  	nr_seq_prestador = nr_seq_prestador_w
		where   nr_sequencia = nr_sequencia_p;
	end if;

	--solicitacao
	if ( cd_natureza_guia_w = '1') then

		SELECT * FROM pls_ger_envio_anexos_ans_pck.validar_anexo_autorizacao(  cd_guia_prestador_w, cd_guia_w, nr_documento_prest_w, cd_tipo_documento_w, cd_formato_documento_w, nr_seq_item_tiss_w, nr_seq_prest_w, nr_seq_guia_p, cd_motivo_glosa_p, ds_motivo_glosa_p, ie_status_p) INTO STRICT nr_seq_guia_p, cd_motivo_glosa_p, ds_motivo_glosa_p, ie_status_p;

		update  pls_anexo_imp
		set    	nr_seq_guia_plano = nr_seq_guia_p,
				ie_status = ie_status_p,
				cd_motivo_glosa = cd_motivo_glosa_p,
				ds_motivo_glosa = ds_motivo_glosa_p
		where  	nr_sequencia = nr_sequencia_p;

	--Conta medica
	elsif (cd_natureza_guia_w = '2') then

		SELECT * FROM pls_ger_envio_anexos_ans_pck.validar_anexo_conta_medica(  nr_lote_guias_rec_w, nr_protocolo_prestador_w, cd_guia_prestador_w, cd_guia_w, nr_documento_prest_w, cd_tipo_documento_w, cd_formato_documento_w, nr_seq_item_tiss_w, nr_seq_prest_w, nr_seq_conta_p, nr_seq_protocolo_p, cd_motivo_glosa_p, ds_motivo_glosa_p, ie_status_p) INTO STRICT nr_seq_conta_p, nr_seq_protocolo_p, cd_motivo_glosa_p, ds_motivo_glosa_p, ie_status_p;
	
    update  pls_anexo_imp
    set    	nr_seq_conta = nr_seq_conta_p,
			ie_status = ie_status_p,
			cd_motivo_glosa = cd_motivo_glosa_p,
			ds_motivo_glosa = ds_motivo_glosa_p,
			nr_protocolo_prestador = nr_seq_protocolo_p
    where  	nr_sequencia = nr_sequencia_p;

	--recurso de glosa e natureza guia = 3. Definido que a busca sera pelo seq_protocolo enviado e a principio definido que o mesmo se refere ao sequecial do 
	--protocolo de recurso e nao o de conta medica
	else
		SELECT * FROM pls_ger_envio_anexos_ans_pck.validar_anexo_rec_glosa(  nr_protocolo_prestador_w, nr_seq_prest_w, cd_tipo_documento_w, nr_seq_prot_rec_p, cd_motivo_glosa_p, ds_motivo_glosa_p, ie_status_p) INTO STRICT nr_seq_prot_rec_p, cd_motivo_glosa_p, ds_motivo_glosa_p, ie_status_p;
		
		update  pls_anexo_imp
		set    	nr_seq_rec_protocolo = nr_seq_prot_rec_p,
				ie_status = ie_status_p,
				cd_motivo_glosa = cd_motivo_glosa_p,
				ds_motivo_glosa = ds_motivo_glosa_p
		where  	nr_sequencia = nr_sequencia_p;
	end if;

	if ( coalesce(cd_motivo_glosa_p::text, '') = '') then
		-- caso nao tenha sido gerada nenhuma glosa no processo de validacao, popula a tabela 
		--de entrada do anexo com o sequencial da guia, conta. protocolo ou protocolo de recurso que foi identificado
		update	pls_anexo_imp
		set 	nr_seq_guia_plano = nr_seq_guia_p,
				nr_seq_conta = nr_seq_conta_p, 
				nr_seq_protocolo = nr_seq_protocolo_p, 
				nr_seq_rec_protocolo = nr_seq_prot_rec_p
		where 	nr_sequencia = nr_sequencia_p;
	
	end if;	
	commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ger_envio_anexos_ans_pck.validar_arquivo_importado ( nr_sequencia_p pls_anexo_imp.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_guia_p INOUT pls_guia_plano.nr_sequencia%type, nr_seq_conta_p INOUT pls_conta.nr_sequencia%type, nr_seq_protocolo_p INOUT pls_protocolo_conta.nr_sequencia%type, nr_seq_prot_rec_p INOUT pls_rec_glosa_protocolo.nr_sequencia%type, cd_motivo_glosa_p INOUT pls_anexo_imp.cd_motivo_glosa%type, ds_motivo_glosa_p INOUT pls_anexo_imp.ds_motivo_glosa%type, ie_status_p INOUT pls_anexo_imp.ie_status%type) FROM PUBLIC;
