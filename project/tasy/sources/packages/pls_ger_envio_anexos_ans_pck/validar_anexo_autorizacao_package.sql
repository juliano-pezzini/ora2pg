-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ger_envio_anexos_ans_pck.validar_anexo_autorizacao ( cd_guia_prestador_p pls_anexo_imp.cd_guia_prestador%type, cd_guia_p pls_anexo_imp.cd_guia%type, nr_documento_prest_p pls_anexo_imp.nr_documento_prest%type, cd_tipo_documento_p pls_anexo_imp.cd_tipo_documento%type, cd_formato_documento_p pls_anexo_imp.cd_formato_documento%type, nr_seq_item_tiss_p pls_anexo_imp.nr_seq_item_tiss%type, nr_seq_prestador_p pls_anexo_imp.nr_seq_prestador%type, nr_seq_guia_plano_p INOUT pls_guia_plano.nr_sequencia%type, cd_motivo_glosa_p INOUT pls_anexo_imp.cd_motivo_glosa%type, ds_motivo_glosa_p INOUT pls_anexo_imp.ds_motivo_glosa%type, ie_status_p INOUT pls_anexo_imp.ie_status%type) AS $body$
DECLARE


nr_seq_guia_temp_w    pls_guia_plano.nr_sequencia%type;
qt_guias_localizadas_w  integer := 0;


BEGIN

	if ( coalesce(cd_guia_p::text, '') = '' or coalesce(cd_guia_prestador_p::text, '') = '') then
		nr_seq_guia_plano_p  := null;
		cd_motivo_glosa_p  := '1307';
		ds_motivo_glosa_p := obter_texto_dic_objeto( 1211640, wheb_usuario_pck.get_nr_seq_idioma, null);
		ie_status_p      := 'G';

	else
		select  max(nr_sequencia),
				count(1)
		into STRICT  	nr_seq_guia_temp_w,
				qt_guias_localizadas_w
		from  	pls_guia_plano
		where   cd_guia_prestador = cd_guia_prestador_p
		and   	nr_seq_prestador = nr_seq_prestador_p
		and   	cd_guia = cd_guia_p;

		if (qt_guias_localizadas_w > 1) then
			nr_seq_guia_plano_p  := null;
			cd_motivo_glosa_p  := '1307';
			ds_motivo_glosa_p := obter_texto_dic_objeto( 1211642, wheb_usuario_pck.get_nr_seq_idioma, null);
			ie_status_p      := 'G';
		elsif (coalesce(nr_seq_guia_temp_w::text, '') = '') then
			nr_seq_guia_plano_p  := null;
			cd_motivo_glosa_p  := '5052';
			ds_motivo_glosa_p := obter_texto_dic_objeto( 1211641, wheb_usuario_pck.get_nr_seq_idioma, null);
			ie_status_p      := 'G';
		else
			nr_seq_guia_plano_p := nr_seq_guia_temp_w;
		end if;

	end if;
	
	if (coalesce(cd_motivo_glosa_p::text, '') = '')  then

		if ( coalesce(pls_ger_envio_anexos_ans_pck.obter_regra_autorizacao( nr_seq_guia_plano_p, cd_tipo_documento_p)::text, '') = '')then
		 
			cd_motivo_glosa_p := '3163';
			ds_motivo_glosa_p := obter_texto_dic_objeto( 1211644, wheb_usuario_pck.get_nr_seq_idioma, null);
			nr_seq_guia_plano_p := null;
			ie_status_p := 'G';

		end if;	
    end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ger_envio_anexos_ans_pck.validar_anexo_autorizacao ( cd_guia_prestador_p pls_anexo_imp.cd_guia_prestador%type, cd_guia_p pls_anexo_imp.cd_guia%type, nr_documento_prest_p pls_anexo_imp.nr_documento_prest%type, cd_tipo_documento_p pls_anexo_imp.cd_tipo_documento%type, cd_formato_documento_p pls_anexo_imp.cd_formato_documento%type, nr_seq_item_tiss_p pls_anexo_imp.nr_seq_item_tiss%type, nr_seq_prestador_p pls_anexo_imp.nr_seq_prestador%type, nr_seq_guia_plano_p INOUT pls_guia_plano.nr_sequencia%type, cd_motivo_glosa_p INOUT pls_anexo_imp.cd_motivo_glosa%type, ds_motivo_glosa_p INOUT pls_anexo_imp.ds_motivo_glosa%type, ie_status_p INOUT pls_anexo_imp.ie_status%type) FROM PUBLIC;
