-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

/*Variaveis Globais*/

	
		     --   ds_sql,
				 --Um ano
												 --Gerado mais de 4 vez
												


CREATE OR REPLACE PROCEDURE ajusta_relatorio_swing_pck.verifica_sql (ds_sql_p text, ds_campos_p INOUT dbms_sql.desc_tab, col_cnt_p INOUT integer) AS $body$
DECLARE

	ds_sql_w	varchar(5000);
	
BEGIN
		begin
			if (	current_setting('ajusta_relatorio_swing_pck.cursor_w')::coalesce(integer::text, '') = '' ) then
				PERFORM set_config('ajusta_relatorio_swing_pck.cursor_w', DBMS_SQL.OPEN_CURSOR, false);
			end if;
			ds_sql_w := ds_sql_p;
			ds_sql_w := replace(ds_sql_w, '@SQL_WHERE', '');
			ds_sql_w := replace(ds_sql_w, '@SQL_WHERE', '');
			ds_sql_w := replace(ds_sql_w, '@Sql_Where', '');
			ds_sql_w := replace(ds_sql_w, '@sql_where', '');

			if (ds_sql_w IS NOT NULL AND ds_sql_w::text <> '') then
				if (coalesce(trim(both ds_sql_w)::text, '') = '' ) then
					CALL ajusta_relatorio_swing_pck.grava_erro('Comando SQL inválido. Somente espaços em branco!', 'S');
				else
					DBMS_SQL.PARSE(current_setting('ajusta_relatorio_swing_pck.cursor_w')::integer, ds_sql_w, dbms_sql.native);
					dbms_sql.describe_columns(current_setting('ajusta_relatorio_swing_pck.cursor_w')::integer,col_cnt_p,ds_campos_p);
					for i in 1 .. col_cnt_p loop
					if (ajusta_relatorio_swing_pck.verifica_caracteres_invalidos(ds_campos_p[i].col_name) or ds_campos_p[i].col_name = chr(39) || chr(39)) then
						CALL ajusta_relatorio_swing_pck.grava_erro('Coluna no SQL sem alias ' || ds_campos_p[i].col_name, 'S');
					end if;
					end loop;
				end if;
				--DBMS_SQL.CLOSE_CURSOR(cursor_w);
			end if;
		exception when others then
			PERFORM set_config('ajusta_relatorio_swing_pck.ds_erro_w', SQLERRM(SQLSTATE), false);
			ds_campos_p := current_setting('ajusta_relatorio_swing_pck.campos_vazio_w')::dbms_sql.desc_tab;
			--DBMS_SQL.CLOSE_CURSOR(cursor_w);
			CALL ajusta_relatorio_swing_pck.grava_erro('Erro ao analisar a instrução SQL! -> '||chr(13) || chr(10)|| current_setting('ajusta_relatorio_swing_pck.ds_erro_w')::varchar(4000) || ds_sql_w, 'S');
		end;
	end;

	/*
		DS_TIPO_P
		R - tabela Relatório
		B - tabela banda_relatorio
		C - tabela_banda_relat_campo
	*/
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE ajusta_relatorio_swing_pck.verifica_sql (ds_sql_p text, ds_campos_p INOUT dbms_sql.desc_tab, col_cnt_p INOUT integer) FROM PUBLIC;
