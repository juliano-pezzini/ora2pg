-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pfcs_pck_dynamic_cards.get_dashboard_parameters (nr_seq_dynamic_module_p bigint) RETURNS varchar AS $body$
DECLARE

        cur_dashboards CURSOR FOR
        SELECT substr(obter_desc_expressao(dsh.cd_expression , dsh.ds_dashboard ),1,255) ds_dashboard,
            dsh.nr_sequencia nr_seq_dashboard,
            dsh.nr_seq_dynamic_module,
            dsh.cd_type,
            dsh.qt_region,
            dsh.nr_seq_display nr_seq_tab,
            substr(coalesce(dsh.ds_region_1,obter_desc_expressao(dsh.cd_exp_region_1)),1,255) ds_region_1_name,
            substr(coalesce(dsh.ds_region_2,obter_desc_expressao(dsh.cd_exp_region_2)),1,255) ds_region_2_name,
            substr(coalesce(dsh.ds_region_3,obter_desc_expressao(dsh.cd_exp_region_3)),1,255) ds_region_3_name
        from pfcs_dashboard dsh
        where dsh.nr_seq_dynamic_module = nr_seq_dynamic_module_p
            and dsh.ie_situacao = PFCS_PCK_CONSTANTS.IE_ACTIVE
        order by dsh.nr_seq_display, nr_sequencia;

        json_item_w                         PHILIPS_JSON := PHILIPS_JSON();
        list_parameters_w                   varchar(255);
        json_list_w                         PHILIPS_JSON_LIST := PHILIPS_JSON_LIST();
        nr_seq_indicator_w                  pfcs_indicator.nr_sequencia%type;
        nr_seq_dic_object_w                 pfcs_indicator.nr_seq_object%type;
        nr_seq_filter_w                     pfcs_indicator.nr_seq_filter%type;
        nr_seq_list_w                       pfcs_indicator.nr_seq_list%type;
        nr_seq_third_level_w                pfcs_indicator.nr_seq_third_level%type;
        cd_row_density_w                    pfcs_card_indicator.cd_row_density%type;

BEGIN
        for c01_w in cur_dashboards loop
            nr_seq_indicator_w := null;
            nr_seq_dic_object_w := null;
            nr_seq_filter_w := null;
            nr_seq_list_w  := null;
            nr_seq_third_level_w  := null;
            list_parameters_w :='';
            cd_row_density_w := null;

            if (c01_w.cd_type = PFCS_PCK_CONSTANTS.CD_GRID) then
                select  ci.NR_SEQ_INDICATOR,
                        ci.cd_row_density,
                        i.nr_seq_filter,
                        i.nr_seq_list,
                        i.nr_seq_object,
                        i.nr_seq_third_level,
                        pfcs_pck_dynamic_cards.get_detail_parameters_list(ci.nr_seq_indicator)
                into STRICT    nr_seq_indicator_w,
                        cd_row_density_w,
                        nr_seq_filter_w,
                        nr_seq_list_w,
                        nr_seq_dic_object_w,
                        nr_seq_third_level_w,
                        list_parameters_w
                from pfcs_card c,
                    pfcs_card_indicator ci,
                    pfcs_indicator i
                where c.nr_seq_dynamic_module = nr_seq_dynamic_module_p
                    and c.nr_seq_dashboard = c01_w.nr_seq_dashboard
                    and c.nr_sequencia = ci.nr_seq_card
                    and c.cd_card_type = PFCS_PCK_CONSTANTS.CD_WCPANEL
                    and (ci.nr_seq_indicator IS NOT NULL AND ci.nr_seq_indicator::text <> '')
                    and ci.nr_seq_indicator = i.nr_sequencia  LIMIT 1;
            end if;

            json_item_w.put('DS_DASHBOARD', c01_w.ds_dashboard);
            json_item_w.put('NR_SEQ_DYNAMIC', to_char(c01_w.nr_seq_dynamic_module));
            json_item_w.put('NR_SEQ_INDICATOR', to_char(nr_seq_indicator_w));
            json_item_w.put('CD_ROW_DENSITY', to_char(cd_row_density_w));
            json_item_w.put('NR_SEQ_FILTER', to_char(nr_seq_filter_w));
            json_item_w.put('NR_SEQ_LIST', to_char(nr_seq_list_w));
            json_item_w.put('NR_SEQ_DIC_OBJECT', to_char(nr_seq_dic_object_w));
            json_item_w.put('NR_SEQ_THIRD_LEVEL', to_char(nr_seq_third_level_w));
            json_item_w.put('CD_TYPE', c01_w.cd_type);
            json_item_w.put('QT_REGION', to_char(c01_w.qt_region));
            json_item_w.put('NR_SEQ_TAB', to_char(c01_w.nr_seq_tab));
            json_item_w.put('NR_SEQ_DASHBOARD', to_char(c01_w.nr_seq_dashboard));
            json_item_w.put('DS_REGION_1_NAME', c01_w.ds_region_1_name);
            json_item_w.put('DS_REGION_2_NAME', c01_w.ds_region_2_name);
            json_item_w.put('DS_REGION_3_NAME', c01_w.ds_region_3_name);
            json_item_w.put('DS_LIST_PARAMETERS', list_parameters_w);
            json_list_w.append(json_item_w.to_json_value());
        end loop;

        return json_list_w.to_char();
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pfcs_pck_dynamic_cards.get_dashboard_parameters (nr_seq_dynamic_module_p bigint) FROM PUBLIC;
