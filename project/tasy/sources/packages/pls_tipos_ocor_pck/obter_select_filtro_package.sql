-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_tipos_ocor_pck.obter_select_filtro ( ie_considera_selecao_p boolean, nr_id_transacao_p pls_selecao_ocor_cta.nr_id_transacao%type, dados_consistencia_p pls_tipos_ocor_pck.dados_consistencia, dados_regra_p dados_regra, dados_forma_geracao_ocor_p pls_tipos_ocor_pck.dados_forma_geracao_ocor, dados_filtro_p dados_filtro, ds_restricao_p pls_tipos_ocor_pck.dados_select, ds_restricao_proc_p pls_tipos_ocor_pck.dados_select, ds_restricao_mat_p pls_tipos_ocor_pck.dados_select, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Cria os selects padroes de acordo com a aplicacao da regra sendo verificada e de acordo
	com as demais variaveis do processo de geracao das ocorrencias combinadas.
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
ds_restricao_proc_p -> deve ser passado filtros somente quando for incidencia PM
ds_restricao_mat_p -> deve ser passado filtros somente quando for incidencia PM
ds_restricao_p -> deve ser usado em todas as outras situacoes

Alteracoes:
 ------------------------------------------------------------------------------------------------------------------

 usuario OS XXXXXX 01/01/2000 -
 Alteracao:	Descricao da alteracao.
Motivo:	Descricao do motivo.
 ------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


ds_select_w			varchar(12000);
ds_restricao_padrao_w		pls_tipos_ocor_pck.dados_select;
ds_restricao_padrao_proc_w	pls_tipos_ocor_pck.dados_select;
ds_restricao_padrao_mat_w	pls_tipos_ocor_pck.dados_select;
ds_campo_guia_w			varchar(60);


BEGIN

-- nao e mais necessario escolher entre cd_guia_imp, mesmo na importacao a trigger pls_conta_atual ja disponibiliza o cd_guia_referencia

ds_campo_guia_w := 'cd_guia_referencia';


-- so respeita a incidencia do filtro quando for um processo de excecao (filtro ou regra de excecao ou ambos)

-- procedimento


if	((dados_filtro_p.ie_incidencia_selecao = 'P' and dados_filtro_p.ie_processo_excecao = 'S') or (dados_regra_p.ie_incidencia_selecao = 'P')) then

	-- obtem as restricoes padrao para a parte dos procedimentos

	valor_bind_p := pls_tipos_ocor_pck.obter_restricao_padrao_filtro(	ie_considera_selecao_p, nr_id_transacao_p, dados_consistencia_p, dados_regra_p, dados_forma_geracao_ocor_p, dados_filtro_p, cd_estabelecimento_p, valor_bind_p);

	ds_select_w :=	'select	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.nr_seq_conta	nr_seq_conta, '|| pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.nr_sequencia	nr_seq_conta_proc, ' || pls_util_pck.enter_w ||
			'	null			nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.' || ds_campo_guia_w || ', ' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.nr_seq_segurado,' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.dt_procedimento,' || pls_util_pck.enter_w ||
			'	dt_inicio_proc dt_proc_hora_ini,' || pls_util_pck.enter_w ||
			'	dt_fim_proc dt_proc_hora_fim,' || pls_util_pck.enter_w ||
			'	inicio_dia(' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.dt_procedimento) dt_proc_dia_ini,' || pls_util_pck.enter_w ||
			'	fim_dia(' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.dt_procedimento) dt_proc_dia_fim,' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.ie_origem_proced,' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.cd_procedimento,' || pls_util_pck.enter_w ||
			'	null nr_seq_material ' || pls_util_pck.enter_w ||
			ds_restricao_padrao_proc_w.ds_campos || pls_util_pck.enter_w ||
			ds_restricao_p.ds_campos || pls_util_pck.enter_w ||
			'from	pls_conta_proc_ocor_v ' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || pls_util_pck.enter_w ||
			ds_restricao_padrao_proc_w.ds_tabelas || pls_util_pck.enter_w ||
			ds_restricao_p.ds_tabelas || pls_util_pck.enter_w ||
			'where	1 = 1 ' ||
			ds_restricao_padrao_proc_w.ds_restricao ||
			ds_restricao_p.ds_restricao;

-- so respeita a incidencia do filtro quando for um processo de excecao (filtro ou regra de excecao ou ambos)

-- Por material

elsif	((dados_filtro_p.ie_incidencia_selecao = 'M' and dados_filtro_p.ie_processo_excecao = 'S') or (dados_regra_p.ie_incidencia_selecao = 'M')) then

	-- obtem as restricoes padrao para a parte de materiais

	valor_bind_p := pls_tipos_ocor_pck.obter_restricao_padrao_filtro(	ie_considera_selecao_p, nr_id_transacao_p, dados_consistencia_p, dados_regra_p, dados_forma_geracao_ocor_p, dados_filtro_p, cd_estabelecimento_p, valor_bind_p);

	ds_select_w := 	'select	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.nr_seq_conta	nr_seq_conta, ' || pls_util_pck.enter_w ||
			'	null			nr_seq_conta_proc, '|| pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.nr_sequencia	nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.' || ds_campo_guia_w || ', ' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.nr_seq_segurado,' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.dt_atendimento,' || pls_util_pck.enter_w ||
			'	dt_inicio_atend_mat dt_atend_hora_ini,' || pls_util_pck.enter_w ||
			'	dt_fim_atend_mat dt_atend_hora_fim,' || pls_util_pck.enter_w ||
			'	inicio_dia(' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.dt_atendimento) dt_atend_dia_ini,' || pls_util_pck.enter_w ||
			'	fim_dia(' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.dt_atendimento) dt_atend_dia_fim,' || pls_util_pck.enter_w ||
			'	null ie_origem_proced,' || pls_util_pck.enter_w ||
			'	null cd_procedimento,' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.nr_seq_material ' || pls_util_pck.enter_w ||
			ds_restricao_padrao_mat_w.ds_campos || pls_util_pck.enter_w ||
			ds_restricao_p.ds_campos || pls_util_pck.enter_w ||
			'from	pls_conta_mat_ocor_v ' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || pls_util_pck.enter_w ||
			ds_restricao_padrao_mat_w.ds_tabelas || pls_util_pck.enter_w ||
			ds_restricao_p.ds_tabelas || pls_util_pck.enter_w ||
			'where	1 = 1 ' ||
			ds_restricao_padrao_mat_w.ds_restricao ||
			ds_restricao_p.ds_restricao;

-- Por procedimento / material  e Conforme a regra externa.

-- so pode ser aplicado em situacoes que nao sejam excecoes, pois regras de excecao sao aplicadas de acordo com a sua incidencia

elsif (dados_regra_p.ie_incidencia_selecao = 'PM' and dados_filtro_p.ie_processo_excecao = 'N') then
	-- obtem as restricoes padrao para a parte dos procedimentos

	valor_bind_p := pls_tipos_ocor_pck.obter_restricao_padrao_filtro(	ie_considera_selecao_p, nr_id_transacao_p, dados_consistencia_p, dados_regra_p, dados_forma_geracao_ocor_p, dados_filtro_p, cd_estabelecimento_p, valor_bind_p, 'PROC');
	-- obtem as restricoes padrao para a parte de materiais

	valor_bind_p := pls_tipos_ocor_pck.obter_restricao_padrao_filtro(	ie_considera_selecao_p, nr_id_transacao_p, dados_consistencia_p, dados_regra_p, dados_forma_geracao_ocor_p, dados_filtro_p, cd_estabelecimento_p, valor_bind_p, 'MAT');

	ds_select_w := 	'select ' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.nr_seq_conta	nr_seq_conta, '|| pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.nr_sequencia	nr_seq_conta_proc, ' || pls_util_pck.enter_w ||
			'	null			nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.' || ds_campo_guia_w || ', ' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.nr_seq_segurado, ' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.dt_procedimento,' || pls_util_pck.enter_w ||
			'	dt_inicio_proc dt_proc_hora_ini,' || pls_util_pck.enter_w ||
			'	dt_fim_proc dt_proc_hora_fim,' || pls_util_pck.enter_w ||
			'	inicio_dia(' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.dt_procedimento) dt_proc_dia_ini,' || pls_util_pck.enter_w ||
			'	fim_dia(' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.dt_procedimento) dt_proc_dia_fim,' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.ie_origem_proced,' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || '.cd_procedimento,' || pls_util_pck.enter_w ||
			'	null nr_seq_material ' || pls_util_pck.enter_w ||
			ds_restricao_padrao_proc_w.ds_campos || pls_util_pck.enter_w ||
			ds_restricao_proc_p.ds_campos || pls_util_pck.enter_w ||
			'from	pls_conta_proc_ocor_v ' || current_setting('pls_tipos_ocor_pck.ds_alias_proc')::varchar(10) || pls_util_pck.enter_w ||
			ds_restricao_padrao_proc_w.ds_tabelas || pls_util_pck.enter_w ||
			ds_restricao_proc_p.ds_tabelas || pls_util_pck.enter_w ||
			'where	1 = 1 ' ||
			ds_restricao_padrao_proc_w.ds_restricao ||
			ds_restricao_proc_p.ds_restricao || pls_util_pck.enter_w ||
			'union all' || pls_util_pck.enter_w ||
			'select	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.nr_seq_conta	nr_seq_conta, ' || pls_util_pck.enter_w ||
			'	null			nr_seq_conta_proc, '|| pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.nr_sequencia	nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.' || ds_campo_guia_w || ', ' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.nr_seq_segurado,' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.dt_atendimento,' || pls_util_pck.enter_w ||
			'	dt_inicio_atend_mat dt_atend_hora_ini,' || pls_util_pck.enter_w ||
			'	dt_fim_atend_mat dt_atend_hora_fim,' || pls_util_pck.enter_w ||
			'	inicio_dia(' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.dt_atendimento) dt_atend_dia_ini,' || pls_util_pck.enter_w ||
			'	fim_dia(' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.dt_atendimento) dt_atend_dia_fim,' || pls_util_pck.enter_w ||
			'	null ie_origem_proced,' || pls_util_pck.enter_w ||
			'	null cd_procedimento,' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || '.nr_seq_material ' || pls_util_pck.enter_w ||
			ds_restricao_padrao_mat_w.ds_campos || pls_util_pck.enter_w ||
			ds_restricao_mat_p.ds_campos || pls_util_pck.enter_w ||
			'from	pls_conta_mat_ocor_v ' || current_setting('pls_tipos_ocor_pck.ds_alias_mat')::varchar(10) || pls_util_pck.enter_w ||
			ds_restricao_padrao_mat_w.ds_tabelas || pls_util_pck.enter_w ||
			ds_restricao_mat_p.ds_tabelas || pls_util_pck.enter_w ||
			'where	1 = 1 ' ||
			ds_restricao_padrao_mat_w.ds_restricao ||
			ds_restricao_mat_p.ds_restricao;

else
	-- obtem as restricoes padrao para a parte de materiais

	valor_bind_p := pls_tipos_ocor_pck.obter_restricao_padrao_filtro(	ie_considera_selecao_p, nr_id_transacao_p, dados_consistencia_p, dados_regra_p, dados_forma_geracao_ocor_p, dados_filtro_p, cd_estabelecimento_p, valor_bind_p);
	-- se nao for nada acima, fica a nivel de conta

	ds_select_w :=	'select	' || current_setting('pls_tipos_ocor_pck.ds_alias_conta')::varchar(10) || '.nr_sequencia	nr_seq_conta , ' || pls_util_pck.enter_w ||
			'	null			nr_seq_conta_proc, ' || pls_util_pck.enter_w ||
			'	null			nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_conta')::varchar(10) || '.' || ds_campo_guia_w || ', ' || pls_util_pck.enter_w ||
			'	' || current_setting('pls_tipos_ocor_pck.ds_alias_conta')::varchar(10) || '.nr_seq_segurado,' || pls_util_pck.enter_w ||
			'	trunc(' || current_setting('pls_tipos_ocor_pck.ds_alias_conta')::varchar(10) || '.dt_atendimento) dt_atendimento,' || pls_util_pck.enter_w ||
			'	pls_tipos_ocor_pck.gerencia_ins_dt_item_sel(' || current_setting('pls_tipos_ocor_pck.ds_alias_conta')::varchar(10) || '.dt_atendimento, ''INICIO'') dt_atend_hora_ini,' || pls_util_pck.enter_w ||
			'	pls_tipos_ocor_pck.gerencia_ins_dt_item_sel(' || current_setting('pls_tipos_ocor_pck.ds_alias_conta')::varchar(10) || '.dt_atendimento, ''FIM'') dt_atend_hora_fim,' || pls_util_pck.enter_w ||
			'	inicio_dia(' || current_setting('pls_tipos_ocor_pck.ds_alias_conta')::varchar(10) || '.dt_atendimento) dt_atend_dia_ini,' || pls_util_pck.enter_w ||
			'	fim_dia(' || current_setting('pls_tipos_ocor_pck.ds_alias_conta')::varchar(10) || '.dt_atendimento) dt_atend_dia_fim,' || pls_util_pck.enter_w ||
			'	null			ie_origem_proced, ' || pls_util_pck.enter_w ||
			'	null			cd_procedimento, ' || pls_util_pck.enter_w ||
			'	null			nr_seq_material ' || pls_util_pck.enter_w ||
			ds_restricao_padrao_w.ds_campos || pls_util_pck.enter_w ||
			ds_restricao_p.ds_campos || pls_util_pck.enter_w ||
			'from	pls_conta_ocor_v ' || current_setting('pls_tipos_ocor_pck.ds_alias_conta')::varchar(10) || pls_util_pck.enter_w ||
			ds_restricao_padrao_w.ds_tabelas || pls_util_pck.enter_w ||
			ds_restricao_p.ds_tabelas || pls_util_pck.enter_w ||
			'where	1 = 1 ' ||
			ds_restricao_padrao_w.ds_restricao ||
			ds_restricao_p.ds_restricao;
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_tipos_ocor_pck.obter_select_filtro ( ie_considera_selecao_p boolean, nr_id_transacao_p pls_selecao_ocor_cta.nr_id_transacao%type, dados_consistencia_p pls_tipos_ocor_pck.dados_consistencia, dados_regra_p dados_regra, dados_forma_geracao_ocor_p pls_tipos_ocor_pck.dados_forma_geracao_ocor, dados_filtro_p dados_filtro, ds_restricao_p pls_tipos_ocor_pck.dados_select, ds_restricao_proc_p pls_tipos_ocor_pck.dados_select, ds_restricao_mat_p pls_tipos_ocor_pck.dados_select, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
