-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Responsavel por atualizar o campo IE_LIBERADO que dira se o item e valido ou nao para a estrutura do tipo de limitacao.



CREATE OR REPLACE PROCEDURE pls_tipos_ocor_pck.atualizar_registro ( ie_proc_mat_p text, dados_tabela_aux_val_limit_p pls_tipos_ocor_pck.dados_tabela_aux_val_limit, nm_usuario_p usuario.nm_usuario%type) AS $body$
BEGIN

-- Deve ser verificado se e por procedimento ou por material para que se tenha certeza de que esta sendo ataulizada a linha correta

-- e seja acessado a tabela pelos campos corretos e nao fique sendo verificado nas restricoes do update pois tende a ser mais custoso.

-- Procedimento

if (ie_proc_mat_p = 'P') then

	-- Atualiza o campo IE_LIBERADO conforme o cadastrado para o procedimento do tipo de limitacao informado.

	update	pls_oc_cta_val_limit_aux
	set	ie_liberado		= dados_tabela_aux_val_limit_p.ie_liberado,
		dt_atualizacao_nrec	= dt_atualizacao,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario_nrec		= nm_usuario,
		nm_usuario		= nm_usuario_p
	where	nr_id_transacao		= dados_tabela_aux_val_limit_p.nr_id_transacao
	and	nr_seq_tipo_limitacao	= dados_tabela_aux_val_limit_p.nr_seq_tipo_limitacao
	and	nr_seq_segurado		= dados_tabela_aux_val_limit_p.nr_seq_segurado
	and	nr_seq_conta		= dados_tabela_aux_val_limit_p.nr_seq_conta
	and	nr_seq_conta_proc	= dados_tabela_aux_val_limit_p.nr_seq_conta_proc;
-- Material

elsif (ie_proc_mat_p = 'M') then

	-- Atualiza o campo IE_LIBERADO conforme o cadastrado para o material do tipo de limitacao informado.

	update	pls_oc_cta_val_limit_aux
	set	ie_liberado		= dados_tabela_aux_val_limit_p.ie_liberado,
		dt_atualizacao_nrec	= dt_atualizacao,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario_nrec		= nm_usuario,
		nm_usuario		= nm_usuario_p
	where	nr_id_transacao		= dados_tabela_aux_val_limit_p.nr_id_transacao
	and	nr_seq_tipo_limitacao	= dados_tabela_aux_val_limit_p.nr_seq_tipo_limitacao
	and	nr_seq_segurado		= dados_tabela_aux_val_limit_p.nr_seq_segurado
	and	nr_seq_conta		= dados_tabela_aux_val_limit_p.nr_seq_conta
	and	nr_seq_conta_mat	= dados_tabela_aux_val_limit_p.nr_seq_conta_mat;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tipos_ocor_pck.atualizar_registro ( ie_proc_mat_p text, dados_tabela_aux_val_limit_p pls_tipos_ocor_pck.dados_tabela_aux_val_limit, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
