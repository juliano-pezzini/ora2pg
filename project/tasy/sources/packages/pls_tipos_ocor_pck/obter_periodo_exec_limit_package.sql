-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


------------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------

----------------- AS ROTINAS ABAIXO FAZEM PARTE DA VALIDACAO 27 E FUTURAMENTE DEVEM SAIR DESTA PACKAGE -----------------------

------------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------

-- INICIO




CREATE OR REPLACE FUNCTION pls_tipos_ocor_pck.obter_periodo_exec_limit ( dados_limitacao_p pls_tipos_ocor_pck.dados_limitacao, dados_segurado_p pls_tipos_ocor_pck.dados_benef, dt_referencia_p timestamp, nm_usuario_p usuario.nm_usuario%type) RETURNS T_DATAS_PERIODO_LIMIT_ROW AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Obter as datas de inicio e fim que serao utilizadas para verificacao do periodo de verificacao
	da limitacao.
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Esta function foi criada aqui dentro por que nao e possivel criar table functions fora da PACKAGE. Ela fica inutilizavel. Esta function e exclusiva da validacao de limitacao contratual da
ocorrencia nova.

Alteracoes:
-------------------------------------------------------------------------------------------------------------------

jjung 26/08/2013 - OS 596834 - Criacao da function.
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


dt_retorno_w	t_datas_periodo_limit_row;

BEGIN

if (dados_limitacao_p.ie_periodo IS NOT NULL AND dados_limitacao_p.ie_periodo::text <> '') then

	-- Ano calendario. Ira verificar os periodos a partir do ano atual, comecando de 01/01 ate 31/12. Sera verificado em qual o periodo valido para a regra o procedimento foi executado.

	if (dados_limitacao_p.ie_periodo = 'CA') then

		select	max(a.dt_inicio),
			max(a.dt_fim)
		into STRICT	dt_retorno_w.dt_inicio,
			dt_retorno_w.dt_fim
		from	table(pls_util_cta_pck.obter_periodo_execucao(	dt_referencia_p,
									pls_manipulacao_datas_pck.comeco_ano(to_char(dt_referencia_p, 'yyyy')),
									dados_limitacao_p.ie_tipo_periodo,
									dados_limitacao_p.qt_meses_intervalo)) a;

	-- Ano contrato. Sera valido como data inicial a data de assinatura do contrato. Sera verificado em qual periodo valido para a regra os procedimentos foram executados.

	elsif (dados_limitacao_p.ie_periodo = 'CO') then

		select	max(a.dt_inicio),
			max(a.dt_fim)
		into STRICT	dt_retorno_w.dt_inicio,
			dt_retorno_w.dt_fim
		from	table(pls_util_cta_pck.obter_periodo_execucao(	dt_referencia_p,
									dados_segurado_p.dt_contrato,
									dados_limitacao_p.ie_tipo_periodo,
									dados_limitacao_p.qt_meses_intervalo)) a;

	-- Data de Adesao. Sera utilizado como data inicial a data de adesao do beneficiario ao plano. Sera verificado em qual periodo valido para a regra os procedimentos foram executados.

	elsif (dados_limitacao_p.ie_periodo = 'A') then

		select	max(a.dt_inicio),
			max(a.dt_fim)
		into STRICT	dt_retorno_w.dt_inicio,
			dt_retorno_w.dt_fim
		from	table(pls_util_cta_pck.obter_periodo_execucao(	dt_referencia_p,
									dados_segurado_p.dt_adesao,
									dados_limitacao_p.ie_tipo_periodo,
									dados_limitacao_p.qt_meses_intervalo)) a;

	-- Data da Primeira utilizaccao. Sea usada como base a data da primeira conta que foi aceita pela operadora para o beneficiario. Sera verificado em qual periodo valido para a regra os procedimentos foram executados.

	elsif (dados_limitacao_p.ie_periodo = 'D') then

		select	max(a.dt_inicio),
			max(a.dt_fim)
		into STRICT	dt_retorno_w.dt_inicio,
			dt_retorno_w.dt_fim
		from	table(pls_util_cta_pck.obter_periodo_execucao(	dt_referencia_p,
									dados_segurado_p.dt_primeira_utilizacao,
									dados_limitacao_p.ie_tipo_periodo,
									dados_limitacao_p.qt_meses_intervalo)) a;
	end if;
end if;

-- Adiciona os dados ao retorno, esta function vai sempre retornar algo.

return dt_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_tipos_ocor_pck.obter_periodo_exec_limit ( dados_limitacao_p pls_tipos_ocor_pck.dados_limitacao, dados_segurado_p pls_tipos_ocor_pck.dados_benef, dt_referencia_p timestamp, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
