-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--novo filtro criado na funcao de Glosas e ocorrencias - Operadora



CREATE OR REPLACE FUNCTION pls_tipos_ocor_pck.obter_restricao_operadora ( dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_filtro_p pls_tipos_ocor_pck.dados_filtro, dados_filtro_oper_p pls_tipos_ocor_pck.dados_filtro_oper, ie_tipo_tabela_p text, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Monta as restricoes e binds dos campos de filtro de contrato
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
 ------------------------------------------------------------------------------------------------------------------

 usuario OS XXXXXX 01/01/2000 -
 Alteracao:	Descricao da alteracao.
Motivo:	Descricao do motivo.
 ------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


dados_restricao_w	pls_tipos_ocor_pck.dados_select;
ds_alias_w		varchar(5);
ds_alias_oper_w		varchar(5);
ds_select_oper_w	varchar(500);
ds_filtro_oper_w	varchar(2000);


BEGIN
-- Inicializar o retorno

dados_restricao_w.ds_campos	:= null;
dados_restricao_w.ds_tabelas	:= null;
dados_restricao_w.ds_restricao	:= null;
ds_filtro_oper_w	:= null;
ds_alias_oper_w		:= 'oper';

-- obtem o alias da tabela

ds_alias_w := pls_tipos_ocor_pck.obter_alias_tab(	dados_filtro_p.ie_processo_excecao, dados_regra_p.ie_incidencia_selecao,
				dados_filtro_p.ie_incidencia_selecao, ie_tipo_tabela_p);



--Montar o subselect base.

ds_select_oper_w :=	'and	exists (	select	1 ' || pls_util_pck.enter_w||
			'			from	pls_segurado_oper_conta_v ' || ds_alias_oper_w || pls_util_pck.enter_w||
			'			where	oper.nr_sequencia = ' || ds_alias_w || '.nr_seq_segurado ';


--Congenere

if (dados_filtro_oper_p.nr_seq_congenere IS NOT NULL AND dados_filtro_oper_p.nr_seq_congenere::text <> '') then
	ds_filtro_oper_w :=	ds_filtro_oper_w||pls_util_pck.enter_w||
					'and	'||ds_alias_oper_w||'.nr_seq_congenere = :nr_seq_congenere';

	valor_bind_p := sql_pck.bind_variable(	':nr_seq_congenere', dados_filtro_oper_p.nr_seq_congenere, valor_bind_p);
end if;

--Congenere sup

if (dados_filtro_oper_p.nr_seq_congenere_sup IS NOT NULL AND dados_filtro_oper_p.nr_seq_congenere_sup::text <> '') then
	ds_filtro_oper_w :=	ds_filtro_oper_w||pls_util_pck.enter_w||
					'and	'||ds_alias_oper_w||'.nr_seq_congenere_sup = :nr_seq_congenere_sup';

	valor_bind_p := sql_pck.bind_variable(	':nr_seq_congenere_sup', dados_filtro_oper_p.nr_seq_congenere_sup, valor_bind_p);
end if;

--Grupo cooperativa

if (dados_filtro_oper_p.nr_seq_grupo_cooperativa IS NOT NULL AND dados_filtro_oper_p.nr_seq_grupo_cooperativa::text <> '') then
	ds_filtro_oper_w :=	ds_filtro_oper_w||pls_util_pck.enter_w||
					'and	'||ds_alias_oper_w||'.nr_seq_grupo_coop = :nr_seq_grupo_coop';

	valor_bind_p := sql_pck.bind_variable(	':nr_seq_grupo_coop', dados_filtro_oper_p.nr_seq_grupo_cooperativa, valor_bind_p);
end if;

--Estado operadora

if (dados_filtro_oper_p.sg_estado_operadora IS NOT NULL AND dados_filtro_oper_p.sg_estado_operadora::text <> '') then
	ds_filtro_oper_w :=	ds_filtro_oper_w||pls_util_pck.enter_w||
					'and	'||ds_alias_oper_w||'.sg_estado_operadora = :sg_estado_operadora';

	valor_bind_p := sql_pck.bind_variable(	':sg_estado_operadora', dados_filtro_oper_p.sg_estado_operadora, valor_bind_p);
end if;

-- Tipo de intercambio (Nacional ou Estadual) So  adiciona a restricao se ele for diferente de A (Ambos), caso ele seja igual a A ou nulo entao nao deve ser adicionado a restricao

if (dados_filtro_oper_p.ie_tipo_intercambio <> 'A') then
	ds_filtro_oper_w :=	ds_filtro_oper_w||pls_util_pck.enter_w||
					'and	'||ds_alias_oper_w||'.ie_tipo_intercambio = :ie_tipo_intercambio';

	valor_bind_p := sql_pck.bind_variable(	':ie_tipo_intercambio', dados_filtro_oper_p.ie_tipo_intercambio, valor_bind_p);
end if;

-- Se executa a filtragem se tiver algum campo informado no filtro de contrato.

if (ds_filtro_oper_w IS NOT NULL AND ds_filtro_oper_w::text <> '') then

	dados_restricao_w.ds_restricao :=	dados_restricao_w.ds_restricao || pls_util_pck.enter_w ||
						ds_select_oper_w || pls_util_pck.enter_w ||
						ds_filtro_oper_w || '		)';
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_tipos_ocor_pck.obter_restricao_operadora ( dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_filtro_p pls_tipos_ocor_pck.dados_filtro, dados_filtro_oper_p pls_tipos_ocor_pck.dados_filtro_oper, ie_tipo_tabela_p text, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
