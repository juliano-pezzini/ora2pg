-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_tipos_ocor_pck.obter_restricao_intercambio ( dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_filtro_p pls_tipos_ocor_pck.dados_filtro, dados_filtro_interc_p pls_tipos_ocor_pck.dados_filtro_interc, ie_tipo_tabela_p text, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Monta as restricoes e binds dos campos de filtro de intercambio
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
 ------------------------------------------------------------------------------------------------------------------

 usuario OS XXXXXX 01/01/2000 -
 Alteracao:	Descricao da alteracao.
Motivo:	Descricao do motivo.
 ------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


dados_restricao_w	pls_tipos_ocor_pck.dados_select;
ds_alias_w		varchar(5);
ds_alias_interc_w	varchar(6);
ds_select_interc_w	varchar(500);
ds_filtro_interc_w	varchar(2000);


BEGIN
-- Inicializar o retorno

dados_restricao_w.ds_campos	:= null;
dados_restricao_w.ds_tabelas	:= null;
dados_restricao_w.ds_restricao	:= null;
ds_filtro_interc_w		:= null;
ds_alias_interc_w		:= 'interc';

-- obtem o alias da tabela

ds_alias_w := pls_tipos_ocor_pck.obter_alias_tab(	dados_filtro_p.ie_processo_excecao, dados_regra_p.ie_incidencia_selecao,
				dados_filtro_p.ie_incidencia_selecao, ie_tipo_tabela_p);

-- Montar o subselect base.

ds_select_interc_w :=	pls_util_pck.enter_w ||
			'and	exists (' ||pls_util_pck.enter_w ||
			'		select	1 '||pls_util_pck.enter_w ||
			'		from	pls_conta_intercambio_v ' || ds_alias_interc_w || pls_util_pck.enter_w||
			'		where	' || ds_alias_interc_w || '.nr_sequencia = ' || ds_alias_w || '.nr_seq_conta ';

-- Tipo de contrato de Intercambio

if (dados_filtro_interc_p.ie_tipo_contrato_intercambio IS NOT NULL AND dados_filtro_interc_p.ie_tipo_contrato_intercambio::text <> '') then
	ds_filtro_interc_w :=	ds_filtro_interc_w || pls_util_pck.enter_w ||
				'and	' || ds_alias_interc_w || '.ie_tipo_contrato = :ie_tipo_contrato_intercambio ';

	valor_bind_p := sql_pck.bind_variable(	':ie_tipo_contrato_intercambio', dados_filtro_interc_p.ie_tipo_contrato_intercambio, valor_bind_p);
end if;

-- Tipo de intercambio (Nacional ou Estadual) So  adiciona a restricao se ele for diferente de A (Ambos), caso ele seja igual a A ou nulo entao nao deve ser adicionado a restricao

if (dados_filtro_interc_p.ie_tipo_intercambio <> 'A') then
	ds_filtro_interc_w :=	ds_filtro_interc_w || pls_util_pck.enter_w ||
				'and	' || ds_alias_interc_w || '.ie_tipo_intercambio = :ie_tipo_intercambio ';

	valor_bind_p := sql_pck.bind_variable(	':ie_tipo_intercambio', dados_filtro_interc_p.ie_tipo_intercambio, valor_bind_p);
end if;

-- Congenere da conta de Intercambrio

if (dados_filtro_interc_p.nr_seq_congenere IS NOT NULL AND dados_filtro_interc_p.nr_seq_congenere::text <> '') then
	ds_filtro_interc_w :=	ds_filtro_interc_w|| pls_util_pck.enter_w ||
				'and	' || ds_alias_interc_w || '.nr_seq_congenere = :nr_seq_congenere ';

	valor_bind_p := sql_pck.bind_variable(	':nr_seq_congenere', dados_filtro_interc_p.nr_seq_congenere, valor_bind_p);
end if;

-- Contrato de Intercambio

if (dados_filtro_interc_p.nr_seq_intercambio IS NOT NULL AND dados_filtro_interc_p.nr_seq_intercambio::text <> '') then
	ds_filtro_interc_w :=	ds_filtro_interc_w || pls_util_pck.enter_w ||
					'and	' || ds_alias_interc_w || '.nr_seq_intercambio = :nr_seq_intercambio ';

	valor_bind_p := sql_pck.bind_variable(	':nr_seq_intercambio', dados_filtro_interc_p.nr_seq_intercambio, valor_bind_p);
end if;

-- Estado da Operadora Congenere

if (dados_filtro_interc_p.sg_estado_operadora IS NOT NULL AND dados_filtro_interc_p.sg_estado_operadora::text <> '') then
	ds_filtro_interc_w :=	ds_filtro_interc_w || pls_util_pck.enter_w  ||
				'and	' || ds_alias_interc_w || '.sg_estado_congenere = :sg_estado_operadora ';

	valor_bind_p := sql_pck.bind_variable(	':sg_estado_operadora', dados_filtro_interc_p.sg_estado_operadora, valor_bind_p);
end if;

-- So retorna algo se teve algum campo informado.

if (ds_filtro_interc_w IS NOT NULL AND ds_filtro_interc_w::text <> '') then

	dados_restricao_w.ds_restricao := ds_select_interc_w || ds_filtro_interc_w ||'		)';
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_tipos_ocor_pck.obter_restricao_intercambio ( dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_filtro_p pls_tipos_ocor_pck.dados_filtro, dados_filtro_interc_p pls_tipos_ocor_pck.dados_filtro_interc, ie_tipo_tabela_p text, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
