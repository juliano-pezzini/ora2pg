-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_tipos_ocor_pck.gravar_ocorrencias_regra ( nr_id_transacao_p pls_selecao_ocor_cta.nr_id_transacao%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_ocor_p pls_tipos_ocor_pck.dados_ocor, cd_acao_analise_p pls_acao_analise.cd_acao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Realizar a geracao ou reativacao das ocorrencias para os itens e/ou contas que
	foram filtrados para regra
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [  ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
 ------------------------------------------------------------------------------------------------------------------

Usuario OS XXXXXX 01/01/2000 -
Alteracao:	Descricao da alteracao.
Motivo:	Descricao do motivo.
 ------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


ie_tipo_aplicacao_ocor_w	pls_oc_cta_tipo_validacao.ie_aplicacao_ocorrencia%type;
qt_filtro_regra_w		integer;


BEGIN

-- busca a aplicacao da regra

ie_tipo_aplicacao_ocor_w := pls_tipos_ocor_pck.obter_aplicacao_regra(dados_regra_p);

-- Conta

if (ie_tipo_aplicacao_ocor_w = 'C') then
	-- gera ocorrencia para todas as contas que estao como validos na tabela de selecao

	CALL CALL pls_tipos_ocor_pck.grava_ocor_conta(	nr_id_transacao_p, dados_regra_p,
				dados_ocor_p,cd_acao_analise_p, cd_estabelecimento_p,
				nm_usuario_p);

-- Se nao for para gerar por conta entende-se que deve ser gerado para qualquer registro da tabela de selecao.

else
	select	count(1)
	into STRICT	qt_filtro_regra_w
	from	pls_oc_cta_filtro a
	where	a.nr_seq_oc_cta_comb = dados_regra_p.nr_sequencia
	and	a.ie_situacao = 'A';

	--Vai que nao deve utilizar filtro e teve filtro cadastrado no passado

	if (qt_filtro_regra_w > 0 and (dados_regra_p.ie_utiliza_filtro = 'S' or dados_regra_p.ie_validacao = 1)) then
		-- grava as ocorrencias respeitando a incidencia de cada filtro

		CALL CALL pls_tipos_ocor_pck.grava_ocor_filtro(	nr_id_transacao_p, dados_regra_p,
					dados_ocor_p, ie_tipo_aplicacao_ocor_w,
					cd_acao_analise_p, cd_estabelecimento_p, nm_usuario_p);
	else
		-- gera ocorrencia para todos os registros que estao como validos na tabela de selecao

		CALL CALL pls_tipos_ocor_pck.grava_ocor_selecao(	nr_id_transacao_p, dados_regra_p,
					dados_ocor_p, cd_acao_analise_p, cd_estabelecimento_p,
					nm_usuario_p);
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tipos_ocor_pck.gravar_ocorrencias_regra ( nr_id_transacao_p pls_selecao_ocor_cta.nr_id_transacao%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_ocor_p pls_tipos_ocor_pck.dados_ocor, cd_acao_analise_p pls_acao_analise.cd_acao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
