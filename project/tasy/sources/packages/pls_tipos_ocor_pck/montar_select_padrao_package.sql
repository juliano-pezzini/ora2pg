-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_tipos_ocor_pck.montar_select_padrao ( dados_regra_p dados_regra, dados_filtro_p dados_filtro, ie_incidencia_regra_p text, dados_restricao_p pls_tipos_ocor_pck.dados_restricao_select, nm_usuario_p usuario.nm_usuario%type) RETURNS varchar AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Cria os selects padroes de acordo com a aplicacao da regra sendo verificada e de acordo
	com as demais variaveis do processo de geracao das ocorrencias combinadas.
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
-------------------------------------------------------------------------------------------------------------------

jjung - OS 651768 - 16/10/2013 - Criacao da function.
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


ds_select_w	varchar(4000);


BEGIN

-- Por padrao usar o select da conta, se a incidencia da regra for nos itens entao sao montados os selects por item.

-- Por conta

ds_select_w :=	'select	conta.nr_sequencia		nr_seq_conta , ' || pls_util_pck.enter_w ||
		'	null				nr_seq_conta_proc, ' || pls_util_pck.enter_w ||
		'	null				nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
		'	null				ds_observacao ' ||
		dados_restricao_p.ds_campos_sql || pls_util_pck.enter_w ||
		'from	pls_protocolo_conta	prot,' || pls_util_pck.enter_w ||
		'	pls_conta_ocor_v	conta' || pls_util_pck.enter_w ||
		'where	1 = 1 ' ||
		dados_restricao_p.ds_restricao_lote ||
		dados_restricao_p.ds_restricao_protocolo || pls_util_pck.enter_w ||
		'and	conta.nr_seq_protocolo = prot.nr_sequencia ' || pls_util_pck.enter_w ||
		dados_restricao_p.ds_restricao_conta || pls_util_pck.enter_w ||
		dados_restricao_p.ds_restricao_minus;
-- Por procedimento

if (ie_incidencia_regra_p = 'P') then

	ds_select_w :=	'select	proc.nr_seq_conta	nr_seq_conta, '|| pls_util_pck.enter_w ||
			'	proc.nr_sequencia	nr_seq_conta_proc, ' || pls_util_pck.enter_w ||
			'	null			nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
			'	null			ds_observacao ' ||
			dados_restricao_p.ds_campos_sql || pls_util_pck.enter_w ||
			'from	pls_protocolo_conta prot,' || pls_util_pck.enter_w ||
			'	pls_conta_ocor_v conta,' || pls_util_pck.enter_w ||
			'	pls_conta_proc_ocor_v proc' || pls_util_pck.enter_w ||
			'where	1 = 1 ' ||
			dados_restricao_p.ds_restricao_lote ||
			dados_restricao_p.ds_restricao_protocolo || pls_util_pck.enter_w ||
			'and	conta.nr_seq_protocolo = prot.nr_sequencia ' ||
			dados_restricao_p.ds_restricao_conta || pls_util_pck.enter_w ||
			'and	proc.nr_seq_conta = conta.nr_sequencia ' ||
			dados_restricao_p.ds_restricao_proc || pls_util_pck.enter_w ||
			dados_restricao_p.ds_restricao_minus;
-- Por material

elsif (ie_incidencia_regra_p = 'M') then

	ds_select_w := 	'select	mat.nr_seq_conta	nr_seq_conta, ' || pls_util_pck.enter_w ||
			'	null			nr_seq_conta_proc, '|| pls_util_pck.enter_w ||
			'	mat.nr_sequencia	nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
			'	null			ds_observacao ' ||
			dados_restricao_p.ds_campos_sql || pls_util_pck.enter_w ||
			'from	pls_protocolo_conta prot,' || pls_util_pck.enter_w ||
			'	pls_conta_ocor_v conta,' || pls_util_pck.enter_w ||
			'	pls_conta_mat_ocor_v mat' || pls_util_pck.enter_w ||
			'where	1 = 1 ' ||
			dados_restricao_p.ds_restricao_lote ||
			dados_restricao_p.ds_restricao_protocolo || pls_util_pck.enter_w ||
			'and	conta.nr_seq_protocolo = prot.nr_sequencia ' ||
			dados_restricao_p.ds_restricao_conta || pls_util_pck.enter_w ||
			'and	mat.nr_seq_conta = conta.nr_sequencia ' ||
			dados_restricao_p.ds_restricao_mat || pls_util_pck.enter_w ||
			dados_restricao_p.ds_restricao_minus;
-- Por procedimento / material  e Conforme a regra externa.

elsif	((ie_incidencia_regra_p = 'PM') or (ie_incidencia_regra_p = 'RV')) then

	ds_select_w := 	'(select proc.nr_seq_conta	nr_seq_conta, '|| pls_util_pck.enter_w ||
			'	proc.nr_sequencia	nr_seq_conta_proc, ' || pls_util_pck.enter_w ||
			'	null			nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
			'	null			ds_observacao ' ||
			dados_restricao_p.ds_campos_sql || pls_util_pck.enter_w ||
			'from	pls_protocolo_conta prot,' || pls_util_pck.enter_w ||
			'	pls_conta_ocor_v conta,' || pls_util_pck.enter_w ||
			'	pls_conta_proc_ocor_v proc' || pls_util_pck.enter_w ||
			'where	1 = 1 ' ||
			dados_restricao_p.ds_restricao_lote ||
			dados_restricao_p.ds_restricao_protocolo || pls_util_pck.enter_w ||
			'and	conta.nr_seq_protocolo = prot.nr_sequencia ' ||
			dados_restricao_p.ds_restricao_conta || pls_util_pck.enter_w ||
			'and	proc.nr_seq_conta = conta.nr_sequencia ' ||
			dados_restricao_p.ds_restricao_proc || pls_util_pck.enter_w ||
			'union all' || pls_util_pck.enter_w ||
			'select	mat.nr_seq_conta	nr_seq_conta, ' || pls_util_pck.enter_w ||
			'	null			nr_seq_conta_proc, '|| pls_util_pck.enter_w ||
			'	mat.nr_sequencia	nr_seq_conta_mat, ' || pls_util_pck.enter_w ||
			'	null			ds_observacao ' ||
			dados_restricao_p.ds_campos_union || pls_util_pck.enter_w ||
			'from	pls_protocolo_conta prot,' || pls_util_pck.enter_w ||
			'	pls_conta_ocor_v conta,' || pls_util_pck.enter_w ||
			'	pls_conta_mat_ocor_v mat' || pls_util_pck.enter_w ||
			'where	1 = 1 ' ||
			dados_restricao_p.ds_restricao_lote ||
			dados_restricao_p.ds_restricao_protocolo || pls_util_pck.enter_w ||
			'and	conta.nr_seq_protocolo = prot.nr_sequencia ' ||
			dados_restricao_p.ds_restricao_conta || pls_util_pck.enter_w ||
			'and	mat.nr_seq_conta = conta.nr_sequencia ' ||
			dados_restricao_p.ds_restricao_mat || pls_util_pck.enter_w || ')' ||
			dados_restricao_p.ds_restricao_minus;
end if;

return ds_select_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_tipos_ocor_pck.montar_select_padrao ( dados_regra_p dados_regra, dados_filtro_p dados_filtro, ie_incidencia_regra_p text, dados_restricao_p pls_tipos_ocor_pck.dados_restricao_select, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
