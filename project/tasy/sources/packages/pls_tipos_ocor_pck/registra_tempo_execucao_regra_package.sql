-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_tipos_ocor_pck.registra_tempo_execucao_regra ( dt_inicio_processo_p timestamp, dt_fim_processo_p timestamp, dados_consistencia_p pls_tipos_ocor_pck.dados_consistencia, dados_regra_p pls_tipos_ocor_pck.dados_regra, nm_usuario_p usuario.nm_usuario%type, ie_processo_final_p text, nr_id_transacao_p INOUT pls_selecao_ocor_cta.nr_id_transacao%type) AS $body$
DECLARE
_ora2pg_r RECORD;
BEGIN

if (coalesce(nr_id_transacao_p::text, '') = '') then
	select	nextval('pls_id_transacao_ocor_seq')
	into STRICT	nr_id_transacao_p
	;
end if;

-- so alimenta as variaveis se nao for o processo final

if (ie_processo_final_p = 'N') then

	current_setting('pls_tipos_ocor_pck.tb_nm_usuario_w')::pls_util_cta_pck.t_varchar2_table_15(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := nm_usuario_p;
	current_setting('pls_tipos_ocor_pck.nr_seq_lote_processo_w')::pls_util_cta_pck.t_number_table(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := dados_consistencia_p.nr_seq_lote_processo;
	current_setting('pls_tipos_ocor_pck.nr_seq_lote_w')::pls_util_cta_pck.t_number_table(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := dados_consistencia_p.nr_seq_lote;
	current_setting('pls_tipos_ocor_pck.nr_seq_protocolo_w')::pls_util_cta_pck.t_number_table(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := dados_consistencia_p.nr_seq_protocolo;
	current_setting('pls_tipos_ocor_pck.nr_seq_conta_w')::pls_util_cta_pck.t_number_table(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := dados_consistencia_p.nr_seq_conta;
	current_setting('pls_tipos_ocor_pck.nr_seq_ocorrencia_w')::pls_util_cta_pck.t_number_table(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := dados_regra_p.nr_seq_ocorrencia;
	current_setting('pls_tipos_ocor_pck.nr_seq_regra_w')::pls_util_cta_pck.t_number_table(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := dados_regra_p.nr_sequencia;
	current_setting('pls_tipos_ocor_pck.nr_id_transacao_w')::pls_util_cta_pck.t_number_table(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := nr_id_transacao_p;
	current_setting('pls_tipos_ocor_pck.nr_seq_analise_w')::pls_util_cta_pck.t_number_table(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := dados_consistencia_p.nr_seq_analise;
	current_setting('pls_tipos_ocor_pck.dt_inicio_processo_w')::pls_util_cta_pck.t_date_table(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := dt_inicio_processo_p;
	current_setting('pls_tipos_ocor_pck.dt_fim_processo_w')::pls_util_cta_pck.t_date_table(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := dt_fim_processo_p;
	current_setting('pls_tipos_ocor_pck.ds_tempo_execucao_w')::pls_util_cta_pck.t_varchar2_table_50(current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) := pls_manipulacao_datas_pck.obter_tempo_execucao_format(dt_inicio_processo_p, dt_fim_processo_p);
end if;

-- se atingiu a quantidade ou e o processo final grava os dados na tabela

if (current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer >= pls_util_pck.qt_registro_transacao_w or ie_processo_final_p = 'S') then

	if (current_setting('pls_tipos_ocor_pck.dt_inicio_processo_w')::pls_util_cta_pck.t_date_table.count > 0) then

		forall i in current_setting('pls_tipos_ocor_pck.dt_inicio_processo_w')::pls_util_cta_pck.t_date_table.first .. current_setting('pls_tipos_ocor_pck.dt_inicio_processo_w')::pls_util_cta_pck.t_date_table.last

			insert into pls_oc_cta_log_ocor(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_lote_processo,
				nr_seq_lote,
				nr_seq_protocolo,
				nr_seq_conta,
				nr_seq_ocorrencia,
				nr_seq_regra,
				nr_id_transacao,
				nr_seq_analise,
				dt_inicio_processo,
				dt_fim_processo,
				ds_tempo_execucao)
			values (nextval('pls_oc_cta_log_ocor_seq'),
				clock_timestamp(),
				current_setting('pls_tipos_ocor_pck.tb_nm_usuario_w')::pls_util_cta_pck.t_varchar2_table_15(i),
				clock_timestamp(),
				current_setting('pls_tipos_ocor_pck.tb_nm_usuario_w')::pls_util_cta_pck.t_varchar2_table_15(i),
				current_setting('pls_tipos_ocor_pck.nr_seq_lote_processo_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_tipos_ocor_pck.nr_seq_lote_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_tipos_ocor_pck.nr_seq_protocolo_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_tipos_ocor_pck.nr_seq_conta_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_tipos_ocor_pck.nr_seq_ocorrencia_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_tipos_ocor_pck.nr_seq_regra_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_tipos_ocor_pck.nr_id_transacao_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_tipos_ocor_pck.nr_seq_analise_w')::pls_util_cta_pck.t_number_table(i),
				current_setting('pls_tipos_ocor_pck.dt_inicio_processo_w')::pls_util_cta_pck.t_date_table(i),
				current_setting('pls_tipos_ocor_pck.dt_fim_processo_w')::pls_util_cta_pck.t_date_table(i),
				current_setting('pls_tipos_ocor_pck.ds_tempo_execucao_w')::pls_util_cta_pck.t_varchar2_table_50(i)
			);
		
	end if;
	-- limpa as variaveis

	SELECT * FROM pls_tipos_ocor_pck.limpa_dados_tempo_exec(	current_setting('pls_tipos_ocor_pck.tb_nm_usuario_w')::pls_util_cta_pck.t_varchar2_table_15, current_setting('pls_tipos_ocor_pck.nr_seq_lote_processo_w')::pls_util_cta_pck.t_number_table, current_setting('pls_tipos_ocor_pck.nr_seq_lote_w')::pls_util_cta_pck.t_number_table, current_setting('pls_tipos_ocor_pck.nr_seq_protocolo_w')::pls_util_cta_pck.t_number_table, current_setting('pls_tipos_ocor_pck.nr_seq_conta_w')::pls_util_cta_pck.t_number_table, current_setting('pls_tipos_ocor_pck.nr_seq_ocorrencia_w')::pls_util_cta_pck.t_number_table, current_setting('pls_tipos_ocor_pck.nr_seq_regra_w')::pls_util_cta_pck.t_number_table, current_setting('pls_tipos_ocor_pck.nr_id_transacao_w')::pls_util_cta_pck.t_number_table, current_setting('pls_tipos_ocor_pck.nr_seq_analise_w')::pls_util_cta_pck.t_number_table, current_setting('pls_tipos_ocor_pck.dt_inicio_processo_w')::pls_util_cta_pck.t_date_table, current_setting('pls_tipos_ocor_pck.dt_fim_processo_w')::pls_util_cta_pck.t_date_table, current_setting('pls_tipos_ocor_pck.ds_tempo_execucao_w')::pls_util_cta_pck.t_varchar2_table_50, current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer) INTO STRICT _ora2pg_r;
 	current_setting('pls_tipos_ocor_pck.tb_nm_usuario_w')::pls_util_cta_pck.t_varchar2_table_15 := _ora2pg_r.tb_nm_usuario_p; current_setting('pls_tipos_ocor_pck.nr_seq_lote_processo_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.nr_seq_lote_processo_p; current_setting('pls_tipos_ocor_pck.nr_seq_lote_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.nr_seq_lote_p; current_setting('pls_tipos_ocor_pck.nr_seq_protocolo_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.nr_seq_protocolo_p; current_setting('pls_tipos_ocor_pck.nr_seq_conta_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.nr_seq_conta_p; current_setting('pls_tipos_ocor_pck.nr_seq_ocorrencia_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.nr_seq_ocorrencia_p; current_setting('pls_tipos_ocor_pck.nr_seq_regra_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.nr_seq_regra_p; current_setting('pls_tipos_ocor_pck.nr_id_transacao_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.nr_id_transacao_p; current_setting('pls_tipos_ocor_pck.nr_seq_analise_w')::pls_util_cta_pck.t_number_table := _ora2pg_r.nr_seq_analise_p; current_setting('pls_tipos_ocor_pck.dt_inicio_processo_w')::pls_util_cta_pck.t_date_table := _ora2pg_r.dt_inicio_processo_p; current_setting('pls_tipos_ocor_pck.dt_fim_processo_w')::pls_util_cta_pck.t_date_table := _ora2pg_r.dt_fim_processo_p; current_setting('pls_tipos_ocor_pck.ds_tempo_execucao_w')::pls_util_cta_pck.t_varchar2_table_50 := _ora2pg_r.ds_tempo_execucao_p; current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer := _ora2pg_r.nr_indice_p;

else
	PERFORM set_config('pls_tipos_ocor_pck.nr_indice_w', current_setting('pls_tipos_ocor_pck.nr_indice_w')::integer + 1, false);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tipos_ocor_pck.registra_tempo_execucao_regra ( dt_inicio_processo_p timestamp, dt_fim_processo_p timestamp, dados_consistencia_p pls_tipos_ocor_pck.dados_consistencia, dados_regra_p pls_tipos_ocor_pck.dados_regra, nm_usuario_p usuario.nm_usuario%type, ie_processo_final_p text, nr_id_transacao_p INOUT pls_selecao_ocor_cta.nr_id_transacao%type) FROM PUBLIC;
