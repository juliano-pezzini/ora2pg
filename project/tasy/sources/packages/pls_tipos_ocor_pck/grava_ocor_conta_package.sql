-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_tipos_ocor_pck.grava_ocor_conta ( nr_id_transacao_p pls_selecao_ocor_cta.nr_id_transacao%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_ocor_p pls_tipos_ocor_pck.dados_ocor, cd_acao_analise_p pls_acao_analise.cd_acao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: 	Gerar ocorrencia para todas as contas que estao validas na tabela de selecao e que
	nao tem itens que cairam em regras de excecao
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[ X ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

Alteracoes:
 ------------------------------------------------------------------------------------------------------------------

 usuario OS XXXXXX 01/01/2000 -
 Alteracao:	Descricao da alteracao.
Motivo:	Descricao do motivo.
 ------------------------------------------------------------------------------------------------------------------

 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


dados_conta_atual_w		pls_util_cta_pck.dados_conta;
table_feita_w			pls_util_cta_pck.table_conta;
ie_item_valido_w		boolean;
qt_oc_benef_w			integer;
nr_seq_ocorrencia_benef_w	pls_ocorrencia_benef.nr_sequencia%type;

-- Retorna apenas a informacao das contas que estao na tabela de selecao.

c_gera_ocor_conta CURSOR(	nr_id_transacao_pc		pls_selecao_ocor_cta.nr_id_transacao%type,
				cd_estabelecimento_pc		estabelecimento.cd_estabelecimento%type,
				cd_acao_analise_pc		pls_acao_analise.cd_acao%type) FOR
	SELECT	x.nr_seq_conta,
		x.ds_observacao,
		(SELECT	max(CASE WHEN b.ie_filtro_proc='S' THEN  'P'  ELSE CASE WHEN b.ie_filtro_mat='S' THEN  'M'  ELSE 'C' END  END )
		from	pls_oc_cta_filtro b
		where	b.nr_sequencia = x.nr_seq_filtro) ie_incidencia_filtro,
		x.ie_tipo_registro,
		a.nr_seq_segurado,
		x.nr_seq_oc_cta_comb
	from	pls_selecao_ocor_cta	x,
		pls_conta		a
	where	x.nr_id_transacao	= nr_id_transacao_pc
	-- qualquer item com D deve gerar ocorrencia pois era um S que foi desconsiderado por nao atender

	-- as datas de vigencia da regra

	and	x.ie_valido		in ('S', 'D')
	and	a.nr_sequencia		= x.nr_seq_conta
	and	a.cd_estabelecimento	= cd_estabelecimento_pc
	-- tratamento para lancar somente as ocorrencias em contas que sejam validas.

	-- na tabela de selecao pode existir alguma conta fechada, porque contas fechadas sao consideradas durante o processo apenas para leitura

	-- isso existe basicamente pelo motivo de geracao de contas de honorario individual

	-- em resumo, so as contas que tiverem os status abaixo podem ter ocorrencias combinadas

	--Tratamento realizado devido a geracao de ocorrencia combinada durante a acao de valorizacaoa traves da funcao processos

	and	((a.ie_status 		in ('A', 'L', 'P', 'U')) or (a.ie_status = 'F' 	and cd_acao_analise_pc	= '8'))
	-- Quando a aplicacao for na conta nao pode ter nenhum item da conta que caiu em uma excecao, caso contrario a conta toda se torna invalida para a ocorrencia.

	and	not exists (	select	1
				from	pls_oc_cta_conta_ex y
				where	y.nr_seq_conta = x.nr_seq_conta);

BEGIN

-- grava as ocorrencias

for r_c_gera_ocor_conta in c_gera_ocor_conta(nr_id_transacao_p, cd_estabelecimento_p, cd_acao_analise_p) loop

	-- Se ja foi gerado para a conta nao gera novamente.

	if (not table_feita_w.exists(r_c_gera_ocor_conta.nr_seq_conta)) then

		-- Comeca sempre como se fosse para gerar. Este controle e feito por que os filtros por item inserem itens que nao filtraram no controle das excecoes.

		-- portanto precisamos validar.

		ie_item_valido_w := true;

		-- Sempre que o filtro incide nos itens deve verificar se o registro sendo visto e do tipo de incidencia do filtro, Se for gera a ocorrencia, se nao nao gera.

		if (r_c_gera_ocor_conta.ie_incidencia_filtro <> 'C') then

			ie_item_valido_w := (r_c_gera_ocor_conta.ie_tipo_registro = r_c_gera_ocor_conta.ie_incidencia_filtro);
		end if;

		if (ie_item_valido_w) then

			dados_conta_atual_w.nr_sequencia := r_c_gera_ocor_conta.nr_seq_conta;
			table_feita_w(r_c_gera_ocor_conta.nr_seq_conta) := dados_conta_atual_w;

			-- Gera ocorrencia ou Reativar

			qt_oc_benef_w := pls_tipos_ocor_pck.obter_qt_ocorrencia(r_c_gera_ocor_conta.nr_seq_conta, null,
								null, dados_regra_p);

			-- se nao tiver registros insere glosa

			if (qt_oc_benef_w = 0) then

				-- Insere a ocorrencia para o item selecionado.

				pls_inserir_ocorrencia(	r_c_gera_ocor_conta.nr_seq_segurado, dados_regra_p.nr_seq_ocorrencia, null,
							null, r_c_gera_ocor_conta.nr_seq_conta, null, null, null, nm_usuario_p,
							r_c_gera_ocor_conta.ds_observacao, dados_ocor_p.nr_seq_motivo_glosa, 8,
							dados_regra_p.cd_estabelecimento, 'N' ,null,
							nr_seq_ocorrencia_benef_w, null, null, null, null,
							null,r_c_gera_ocor_conta.nr_seq_oc_cta_comb);
			else
				-- Se o item ja tiver a ocorrencia lancada sera reativado a ocorrencia.

				CALL pls_reativar_ocor_conta(	dados_regra_p.nr_seq_ocorrencia, r_c_gera_ocor_conta.nr_seq_conta, null , null,
								nm_usuario_p,null,r_c_gera_ocor_conta.nr_seq_oc_cta_comb);
			end if;
		end if;
	end if;
end loop; -- c_gera_ocor_conta


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tipos_ocor_pck.grava_ocor_conta ( nr_id_transacao_p pls_selecao_ocor_cta.nr_id_transacao%type, dados_regra_p pls_tipos_ocor_pck.dados_regra, dados_ocor_p pls_tipos_ocor_pck.dados_ocor, cd_acao_analise_p pls_acao_analise.cd_acao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
