-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_mla_pathology_pck.process_receipt_comments ( record_p medtreatmentinforedtyp, cd_external_p cpoe_std_comment.cd_external%type, nr_linkage_sequencia_p cpoe_comment_linkage.nr_sequencia%type ) AS $body$
DECLARE


    ds_additional_text_w         cpoe_comment_linkage.ds_additional_text%type;
    si_format_value_w            cpoe_std_comment.si_format_value%type;
    nr_additional_text_w    cpoe_comment_linkage.nr_additional_text%type;
    dt_additional_text_w    cpoe_comment_linkage.dt_additional_text%type;

    comment_loop_counter_w       smallint := 0;
    comment_index_w              smallint := 0;
    initial_length_w             smallint := 0;
    additional_comment_count_w   smallint := 0;
    r_c03_w medtreatmentinforedtyp;

    c04 CURSOR FOR
    SELECT  coalesce(b.ds_additional_text, ' ') free_comments,
            c.si_format_value,
            b.nr_additional_text,
            b.dt_additional_text
    from    cpoe_comment_linkage    b,
            cpoe_std_comment        c
    where   b.nr_seq_std_comment = c.nr_sequencia
    and     b.nr_sequencia = nr_linkage_sequencia_p;

   
BEGIN
   
    r_c03_w := record_p;
    r_c03_w.internal_code := cd_external_p;
    r_c03_w.dosage := 0;
    r_c03_w.unit := ' ';
    r_c03_w.free_comments := ' ';
    r_c03_w.free_input_flag := 0;

    open c04;

    fetch c04 into
        ds_additional_text_w,
        si_format_value_w,
        nr_additional_text_w,
        dt_additional_text_w;

    close c04;

    if ( ds_additional_text_w <> ' ' and coalesce(si_format_value_w::text, '') = '') then
        r_c03_w.free_comments := ' ';
        r_c03_w.free_input_flag := 1;
        comment_loop_counter_w := ceil(length(ds_additional_text_w) / 40);
        additional_comment_count_w := additional_comment_count_w + comment_loop_counter_w;
        comment_index_w := 1;
        initial_length_w := 40;

        for j in 1..comment_loop_counter_w loop begin
            r_c03_w.free_comments := substr(ds_additional_text_w, comment_index_w, initial_length_w);
            comment_index_w := length(r_c03_w.free_comments) + comment_index_w;
           CALL nais_mla_pathology_pck.prepare_pathology_data(r_c03_w);
        end;
        end loop;
    else
        ds_additional_text_w := nais_mla_pathology_pck.get_additional_text(nr_linkage_sequencia_p, si_format_value_w, nr_additional_text_w, dt_additional_text_w);
        r_c03_w.dosage := (coalesce(ds_additional_text_w, 0))::numeric;
        CALL nais_mla_pathology_pck.prepare_pathology_data(r_c03_w);
    end if;
   END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_mla_pathology_pck.process_receipt_comments ( record_p medtreatmentinforedtyp, cd_external_p cpoe_std_comment.cd_external%type, nr_linkage_sequencia_p cpoe_comment_linkage.nr_sequencia%type ) FROM PUBLIC;
