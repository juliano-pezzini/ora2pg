-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE exames_grid_pck.criar_atend_result_exame (nr_atendimento_p bigint, cd_pessoa_fisica_p text, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_exame_p text, nr_seq_grupo_exame_p text, ie_atendimento_p text, ie_sem_aprovacao_p text, ie_ordem_p bigint, nr_seq_protocolo_pep_p bigint, ie_data_p text, ie_data_hora_p text, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_modo_agrup_p text, ie_html_p text default 'N', ie_fora_referencia_p text default 'N', nr_seq_atend_cons_pepa_p exame_lab_resultado.nr_seq_atend_cons_pepa%type default null, ie_nivel_atencao_p text default null, ie_external_lab_result_p text default 'S') AS $body$
BEGIN

  PERFORM set_config('exames_grid_pck.nr_atendimento_param', nr_atendimento_p, false);
  PERFORM set_config('exames_grid_pck.cd_pessoa_fisica_param', cd_pessoa_fisica_p, false);
  PERFORM set_config('exames_grid_pck.dt_inicial_param', dt_inicial_p, false);
  PERFORM set_config('exames_grid_pck.dt_final_param', dt_final_p, false);
  PERFORM set_config('exames_grid_pck.nr_seq_exame_param', nr_seq_exame_p, false);
  PERFORM set_config('exames_grid_pck.ie_atendimento_param', ie_atendimento_p, false);
  PERFORM set_config('exames_grid_pck.ie_sem_aprovacao_param', ie_sem_aprovacao_p, false);
  PERFORM set_config('exames_grid_pck.ie_ordem_param', ie_ordem_p, false);
  PERFORM set_config('exames_grid_pck.nr_seq_protocolo_pep_param', nr_seq_protocolo_pep_p, false);
  PERFORM set_config('exames_grid_pck.ie_data_param', ie_data_p, false);
  PERFORM set_config('exames_grid_pck.ie_data_hora_param', ie_data_hora_p, false);
  PERFORM set_config('exames_grid_pck.nm_usuario_param', nm_usuario_p, false);
  PERFORM set_config('exames_grid_pck.cd_setor_atendimento_param', cd_setor_atendimento_p, false);
  PERFORM set_config('exames_grid_pck.ie_modo_agrup_param', ie_modo_agrup_p, false);
  PERFORM set_config('exames_grid_pck.ie_html_param', ie_html_p, false);
  PERFORM set_config('exames_grid_pck.ie_fora_referencia_param', ie_fora_referencia_p, false);
  PERFORM set_config('exames_grid_pck.nr_seq_atend_cons_pepa_param', nr_seq_atend_cons_pepa_p, false);
  PERFORM set_config('exames_grid_pck.ie_nivel_atencao_param', ie_nivel_atencao_p, false);
  PERFORM set_config('exames_grid_pck.ie_external_lab_result_param', ie_external_lab_result_p, false);
  PERFORM set_config('exames_grid_pck.nr_seq_grupo_exame_param', nr_seq_grupo_exame_p, false);

  if (coalesce(current_setting('exames_grid_pck.ie_external_lab_result_param')::varchar(1),'S') <> 'N') then
	PERFORM set_config('exames_grid_pck.ie_external_lab_result_param', 'S', false);
  end if;
  PERFORM set_config('exames_grid_pck.ie_modo_agrup_w', current_setting('exames_grid_pck.ie_modo_agrup_param')::varchar(1), false);
  if current_setting('exames_grid_pck.ie_modo_agrup_param')::varchar(1) = 'E' then
     PERFORM set_config('exames_grid_pck.ie_modo_agrup_w', 'R', false);
  end if;

  delete FROM w_result_exame_grid where nm_usuario = current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type;
  EXECUTE 'TRUNCATE TABLE RESULT_EXAME_PRESCR_TMP';
  EXECUTE 'TRUNCATE TABLE RESULT_EXAME_TEMP';
  EXECUTE 'TRUNCATE TABLE EXAM_RESULT_ITEM_TMP';
  commit;

  if (current_setting('exames_grid_pck.nr_atendimento_param')::prescr_medica.nr_atendimento%(type IS NOT NULL AND type::text <> '')) and (current_setting('exames_grid_pck.nr_atendimento_param')::prescr_medica.nr_atendimento%type > 0) then
      PERFORM set_config('exames_grid_pck.cd_convenio_w', obter_convenio_atendimento(current_setting('exames_grid_pck.nr_atendimento_param')::prescr_medica.nr_atendimento%type), false);
      PERFORM set_config('exames_grid_pck.ie_tipo_atendimento_w', obter_tipo_atendimento(current_setting('exames_grid_pck.nr_atendimento_param')::prescr_medica.nr_atendimento%type), false);
  end if;

  PERFORM set_config('exames_grid_pck.cd_perfil_w', obter_perfil_ativo, false);
  PERFORM set_config('exames_grid_pck.ie_nivel_atencao_perfil_w', coalesce(current_setting('exames_grid_pck.ie_nivel_atencao_param')::varchar(5), wheb_assist_pck.get_nivel_atencao_perfil), false);
  PERFORM set_config('exames_grid_pck.dt_final_ww', fim_dia(dt_final_p), false);

  if (current_setting('exames_grid_pck.ie_html_param')::varchar(1)  = 'S') then
      PERFORM set_config('exames_grid_pck.ds_espaco_w', chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;'||chr(38)||'nbsp;', false);
  end if;

  if (current_setting('exames_grid_pck.ie_sem_aprovacao_param')::varchar(1) = 'D') then
        PERFORM set_config('exames_grid_pck.ie_status_atend_ww', 25, false);
  elsif (current_setting('exames_grid_pck.ie_sem_aprovacao_param')::varchar(1) = 'S') then
        PERFORM set_config('exames_grid_pck.ie_status_atend_ww', 30, false);
  elsif (current_setting('exames_grid_pck.ie_sem_aprovacao_param')::varchar(1) = 'L') then
        PERFORM set_config('exames_grid_pck.ie_status_atend_ww', 40, false);
  end if;

  obter_param_usuario(281, 1188, obter_perfil_ativo, current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type, wheb_usuario_pck.get_cd_estabelecimento, current_setting('exames_grid_pck.ie_apresenta_exame_bloq_w')::varchar(10));
  obter_param_usuario(281, 1417, obter_perfil_ativo, current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type, wheb_usuario_pck.get_cd_estabelecimento, current_setting('exames_grid_pck.ie_apresentar_digitacao_w')::varchar(1));
  obter_param_usuario(281, 1662, obter_perfil_ativo, current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type, wheb_usuario_pck.get_cd_estabelecimento, current_setting('exames_grid_pck.ie_verifica_liberacao_w')::varchar(1));

  insert into RESULT_EXAME_PRESCR_TMP(nr_prescricao,
                                      nr_seq_prescr,
                                      nr_seq_exame,
                                      ie_status_atend,
                                      cd_pessoa_fisica,
                                      nr_atendimento,
                                      nr_seq_origem,
                                      dt_coleta,
                                      dt_prev_execucao,
                                      ie_nivel_atencao,
                                      nm_usuario)
                              SELECT  pm.nr_prescricao nr_prescricao,
                                      pp.nr_sequencia nr_seq_prescr,
                                      pp.nr_seq_exame nr_seq_exame,
                                      pp.ie_status_atend ie_status_atend,
                                      pm.cd_pessoa_fisica cd_pessoa_fisica,
                                      pm.nr_atendimento nr_atendimento,
                                      pp.nr_seq_origem nr_seq_origem,
                                      pp.dt_coleta dt_coleta,
                                      pp.dt_prev_execucao dt_prev_execucao,
                                      pm.ie_nivel_atencao  ie_nivel_atencao,
                                      current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type
                                from  prescr_medica pm
                                inner join prescr_procedimento pp ON (pp.nr_prescricao = pm.nr_prescricao)
                                where ((current_setting('exames_grid_pck.ie_atendimento_param')::varchar(10) = 'S'  and pm.nr_atendimento   = current_setting('exames_grid_pck.nr_atendimento_param')::prescr_medica.nr_atendimento%type) or (current_setting('exames_grid_pck.ie_atendimento_param')::varchar(10) <> 'S' and pm.cd_pessoa_fisica = current_setting('exames_grid_pck.cd_pessoa_fisica_param')::prescr_medica.cd_pessoa_fisica%type))
                                and   obter_se_lib_nivel_atencao(pm.ie_nivel_atencao, current_setting('exames_grid_pck.ie_nivel_atencao_perfil_w')::varchar(5), pm.nm_usuario, pm.nr_prescricao, current_setting('exames_grid_pck.ie_nivel_atencao_perfil_w')::varchar(5)) = 'S'
                                and   ((current_setting('exames_grid_pck.cd_setor_atendimento_param')::prescr_medica.cd_setor_atendimento%coalesce(type::text, '') = '') or (pm.cd_setor_atendimento = current_setting('exames_grid_pck.cd_setor_atendimento_param')::prescr_medica.cd_setor_atendimento%type))
                                and   ((coalesce(current_setting('exames_grid_pck.ie_apresenta_exame_bloq_w')::varchar(10), 'S') = 'S') or (coalesce(pp.ie_exame_bloqueado,'N')  <> 'S'))
                                and   'S' = Obter_Se_Permite_Result_Novo(pm.nr_atendimento
                                                                        ,pp.nr_prescricao
                                                                        ,pp.nr_sequencia
                                                                        ,pp.nr_seq_exame
                                                                        ,current_setting('exames_grid_pck.cd_perfil_w')::integer
                                                                        ,current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type
                                                                        ,current_setting('exames_grid_pck.cd_convenio_w')::bigint
                                                                        ,current_setting('exames_grid_pck.ie_tipo_atendimento_w')::bigint);

  /* insert nova tabela temporaria */

  insert into EXAM_RESULT_ITEM_TMP(ie_resultado_critico,
                                           ds_referencia_ext,
                                           ie_resultado_referencia,
                                           ds_referencia,
                                           qt_decimais,
                                           dt_digitacao,
                                           dt_aprovacao,
                                           dt_exame_ext,
                                           ie_normalidade,
                                           nr_seq_resultado,
                                           nr_seq_material,
                                           qt_resultado,
                                           ds_resultado,
                                           pr_resultado,
                                           nr_seq_prescr,
                                           ds_unidade_medida,
                                           nr_seq_metodo,
                                           nr_seq_exame,
                                           nr_prescricao,
                                           nr_sequencia,
                                           dt_liberacao,
                                           dt_resultado,
                                           ie_nivel_atencao,
                                           nm_usuario,
                                           cd_pessoa_fisica,
                                           nr_atendimento,
                                           ds_flag,
                                           nr_seq_atend_cons_pepa,
                                           ie_final,
                                           ds_cor_legenda,
                                           ds_observacao)
                                   (SELECT b.ie_resultado_critico,
                                           b.ds_referencia_ext,
                                           b.ie_resultado_referencia,
                                           b.ds_referencia,
                                           b.qt_decimais,
                                           b.dt_digitacao,
                                           b.dt_aprovacao,
                                           b.dt_exame_ext,
                                           b.ie_normalidade,
                                           b.nr_seq_resultado,
                                           b.nr_seq_material,
                                           b.qt_resultado,
                                           b.ds_resultado,
                                           b.pr_resultado,
                                           b.nr_seq_prescr,
                                           b.ds_unidade_medida,
                                           b.nr_seq_metodo,
                                           b.nr_seq_exame,
                                           a.nr_prescricao,
                                           b.nr_sequencia,
                                           a.dt_liberacao,
                                           CASE WHEN current_setting('exames_grid_pck.ie_data_param')::varchar(10)='I' THEN  a.dt_resultado  ELSE coalesce(b.dt_result_item, a.dt_resultado) END ,
                                           a.ie_nivel_atencao,
                                           a.nm_usuario,
                                           a.cd_pessoa_fisica,
                                           a.nr_atendimento,
                                           b.ds_flag,
                                           null,
                                           b.ie_final,
                                           pep_obter_cor_exame_grid(b.qt_resultado,b.qt_minima,b.qt_maxima,b.pr_resultado,b.pr_minimo,b.pr_maximo),
                                           b.ds_observacao
                                    from   RESULT_EXAME_PRESCR_TMP s
                                    inner  join exame_lab_resultado a on (s.nr_prescricao = a.nr_prescricao)
                                    inner  join exame_lab_result_item b   ON (a.nr_seq_resultado = b.nr_seq_resultado and s.nr_seq_prescr = b.nr_seq_prescr)
                                    where  a.dt_resultado between current_setting('exames_grid_pck.dt_inicial_param')::timestamp and current_setting('exames_grid_pck.dt_final_ww')::timestamp
                                    and    s.nm_usuario = current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type
                                    and    CASE WHEN current_setting('exames_grid_pck.ie_verifica_liberacao_w')::varchar(1)='S' THEN  PERFORM lab_obter_se_result_lib_visual(s.nr_prescricao, s.nr_seq_prescr,'E')  ELSE 'S' END  = 'S'

union  all

                                    SELECT b.ie_resultado_critico,
                                           b.ds_referencia_ext,
                                           b.ie_resultado_referencia,
                                           b.ds_referencia,
                                           b.qt_decimais,
                                           b.dt_digitacao,
                                           b.dt_aprovacao,
                                           b.dt_exame_ext,
                                           b.ie_normalidade,
                                           b.nr_seq_resultado,
                                           b.nr_seq_material,
                                           b.qt_resultado,
                                           b.ds_resultado,
                                           b.pr_resultado,
                                           b.nr_seq_prescr,
                                           b.ds_unidade_medida,
                                           b.nr_seq_metodo,
                                           b.nr_seq_exame,
                                           a.nr_prescricao,
                                           b.nr_sequencia,
                                           a.dt_liberacao,
                                           CASE WHEN current_setting('exames_grid_pck.ie_data_param')::varchar(10)='I' THEN  a.dt_resultado  ELSE coalesce(b.dt_result_item, a.dt_resultado) END ,
                                           a.ie_nivel_atencao,
                                           a.nm_usuario,
                                           a.cd_pessoa_fisica,
                                           a.nr_atendimento,
                                           b.ds_flag,
                                           nr_seq_atend_cons_pepa,
                                           b.ie_final,
                                           pep_obter_cor_exame_grid(b.qt_resultado,b.qt_minima,b.qt_maxima,b.pr_resultado,b.pr_minimo,b.pr_maximo),
                                           b.ds_observacao
                                    from   exame_lab_resultado a
                                    inner  join exame_lab_result_item b   ON (a.nr_seq_resultado = b.nr_seq_resultado)
                                    where  a.dt_resultado between current_setting('exames_grid_pck.dt_inicial_param')::timestamp and current_setting('exames_grid_pck.dt_final_ww')::timestamp
                                    and    coalesce(a.nr_prescricao::text, '') = ''
                                    and    (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
                                    and    ((current_setting('exames_grid_pck.cd_setor_atendimento_param')::prescr_medica.cd_setor_atendimento%coalesce(type::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = current_setting('exames_grid_pck.cd_setor_atendimento_param')::prescr_medica.cd_setor_atendimento%type))
                                    and    (((current_setting('exames_grid_pck.ie_atendimento_param')::varchar(10) = 'S') and (a.nr_atendimento = current_setting('exames_grid_pck.nr_atendimento_param')::prescr_medica.nr_atendimento%type)) or
                                           ((current_setting('exames_grid_pck.ie_atendimento_param')::varchar(10) = 'N') and (a.nr_atendimento in (select  nr_atendimento
                                                                                               from    atendimento_paciente
                                                                                               where   cd_pessoa_fisica  = current_setting('exames_grid_pck.cd_pessoa_fisica_param')::prescr_medica.cd_pessoa_fisica%type)))or
                                           ((current_setting('exames_grid_pck.ie_atendimento_param')::varchar(10) <> 'S') and (a.cd_pessoa_fisica = current_setting('exames_grid_pck.cd_pessoa_fisica_param')::prescr_medica.cd_pessoa_fisica%type)))
                                    and    'S' = obter_se_lib_nivel_atencao(a.ie_nivel_atencao,current_setting('exames_grid_pck.ie_nivel_atencao_perfil_w')::varchar(5),a.nm_usuario,a.nr_prescricao, current_setting('exames_grid_pck.ie_nivel_atencao_perfil_w')::varchar(5))
                                    and    'S' = Obter_Se_Permite_Result_Novo(a.nr_atendimento,a.nr_prescricao,b.nr_seq_prescr,b.nr_seq_exame,current_setting('exames_grid_pck.cd_perfil_w')::integer,current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,current_setting('exames_grid_pck.cd_convenio_w')::bigint,current_setting('exames_grid_pck.ie_tipo_atendimento_w')::bigint)
                                    and    current_setting('exames_grid_pck.ie_external_lab_result_param')::varchar(1) ='S'
                                    
union

                                    select b.ie_resultado_critico,
                                           b.ds_referencia_ext,
                                           b.ie_resultado_referencia,
                                           b.ds_referencia,
                                           b.qt_decimais,
                                           b.dt_digitacao,
                                           b.dt_aprovacao,
                                           b.dt_exame_ext,
                                           b.ie_normalidade,
                                           b.nr_seq_resultado,
                                           b.nr_seq_material,
                                           b.qt_resultado,
                                           b.ds_resultado,
                                           b.pr_resultado,
                                           b.nr_seq_prescr,
                                           b.ds_unidade_medida,
                                           b.nr_seq_metodo,
                                           b.nr_seq_exame,
                                           a.nr_prescricao,
                                           b.nr_sequencia,
                                           a.dt_liberacao,
                                           CASE WHEN current_setting('exames_grid_pck.ie_data_param')::varchar(10)='I' THEN  a.dt_resultado  ELSE coalesce(b.dt_result_item, a.dt_resultado) END ,
                                           a.ie_nivel_atencao,
                                           a.nm_usuario,
                                           a.cd_pessoa_fisica,
                                           a.nr_atendimento,
                                           b.ds_flag,
                                           nr_seq_atend_cons_pepa,
                                           b.ie_final,
                                           pep_obter_cor_exame_grid(b.qt_resultado,b.qt_minima,b.qt_maxima,b.pr_resultado,b.pr_minimo,b.pr_maximo),
                                           b.ds_observacao
                                    from   exame_lab_resultado a
                                    inner  join exame_lab_result_item b   ON (a.nr_seq_resultado = b.nr_seq_resultado)
                                    where  a.nr_seq_atend_cons_pepa = current_setting('exames_grid_pck.nr_seq_atend_cons_pepa_param')::exame_lab_resultado.nr_seq_atend_cons_pepa%type
                                    and    ((current_setting('exames_grid_pck.cd_setor_atendimento_param')::prescr_medica.cd_setor_atendimento%coalesce(type::text, '') = '') or (obter_setor_prescricao(a.nr_prescricao,'C') = current_setting('exames_grid_pck.cd_setor_atendimento_param')::prescr_medica.cd_setor_atendimento%type))
                                    and    'S' = obter_se_lib_nivel_atencao(a.ie_nivel_atencao,current_setting('exames_grid_pck.ie_nivel_atencao_perfil_w')::varchar(5),a.nm_usuario,a.nr_prescricao, current_setting('exames_grid_pck.ie_nivel_atencao_perfil_w')::varchar(5))
                                    and    'S' = Obter_Se_Permite_Result_Novo(a.nr_atendimento,a.nr_prescricao,b.nr_seq_prescr,b.nr_seq_exame,current_setting('exames_grid_pck.cd_perfil_w')::integer,current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,current_setting('exames_grid_pck.cd_convenio_w')::bigint,current_setting('exames_grid_pck.ie_tipo_atendimento_w')::bigint));


  if (current_setting('exames_grid_pck.nr_seq_exame_param')::(varchar(4000) IS NOT NULL AND (varchar(4000))::text <> '')) then
       PERFORM set_config('exames_grid_pck.nr_seq_exames_w', '(' || current_setting('exames_grid_pck.nr_seq_exame_param')::varchar(4000) || ')', false);
   end if;

  PERFORM set_config('exames_grid_pck.ivet', 0, false);
  if (current_setting('exames_grid_pck.ie_ordem_param')::bigint = 1) then
      begin
      open  current_setting('exames_grid_pck.c02')::CURSOR;
      loop
      fetch current_setting('exames_grid_pck.c02')::into CURSOR current_setting('exames_grid_pck.rowc02')::c02%rowtype;
      EXIT WHEN NOT FOUND; /* apply on current_setting('exames_grid_pck.c02')::CURSOR */
        begin
          if current_setting('exames_grid_pck.ivet')::integer >= 57 then
             exit;
          end if;
          PERFORM set_config('exames_grid_pck.ivet', current_setting('exames_grid_pck.ivet')::integer + 1, false);
          current_setting('exames_grid_pck.vetor_w')::vetor(current_setting('exames_grid_pck.ivet')::integer).nm_coluna_w := current_setting('exames_grid_pck.rowc02')::c02%rowtype.dt_resultado;
        end;
      end loop;
      close current_setting('exames_grid_pck.c02')::CURSOR;
      end;
  else
      begin
      open  current_setting('exames_grid_pck.c002')::CURSOR;
      loop
      fetch current_setting('exames_grid_pck.c002')::into CURSOR current_setting('exames_grid_pck.rowc002')::current_setting('exames_grid_pck.c002')::CURSOR%rowtype;
      EXIT WHEN NOT FOUND; /* apply on current_setting('exames_grid_pck.c002')::CURSOR */
        begin
          if current_setting('exames_grid_pck.ivet')::integer >= 57 then
             exit;
          end if;
          PERFORM set_config('exames_grid_pck.ivet', current_setting('exames_grid_pck.ivet')::integer + 1, false);
          current_setting('exames_grid_pck.vetor_w')::vetor(current_setting('exames_grid_pck.ivet')::integer).nm_coluna_w := current_setting('exames_grid_pck.rowc002')::current_setting('exames_grid_pck.c002')::CURSOR%rowtype.dt_resultado;
        end;
      end loop;
      close current_setting('exames_grid_pck.c002')::CURSOR;
      end;
  end if;

  /* completar vetor se necessario  */

  PERFORM set_config('exames_grid_pck.ind', current_setting('exames_grid_pck.ivet')::integer, false);
  while(current_setting('exames_grid_pck.ind')::integer < 57) loop
    begin
    PERFORM set_config('exames_grid_pck.ind', current_setting('exames_grid_pck.ind')::integer + 1, false);
    current_setting('exames_grid_pck.vetor_w')::vetor(current_setting('exames_grid_pck.ind')::integer).nm_coluna_w := null;
    end;
  end loop;

  select nextval('w_result_exame_grid_seq')
  into STRICT   current_setting('exames_grid_pck.nr_sequencia_w')::bigint
;

  insert into w_result_exame_grid(nr_sequencia,
                                  nm_usuario,
                                  nr_seq_exame,
                                  nm_exame,
                                  nr_seq_material,
                                  ds_unidade_medida,
                                  ds_referencia,
                                  ie_ordem,
                                  ie_ordem_seg,
                                  nr_apres_grupo,
                                  nr_apres_exame,
                                  ds_metodo,
                                  ds_result1,
                                  ds_result2,
                                  ds_result3,
                                  ds_result4,
                                  ds_result5,
                                  ds_result6,
                                  ds_result7,
                                  ds_result8,
                                  ds_result9,
                                  ds_result10,
                                  ds_result11,
                                  ds_result12,
                                  ds_result13,
                                  ds_result14,
                                  ds_result15,
                                  ds_result16,
                                  ds_result17,
                                  ds_result18,
                                  ds_result19,
                                  ds_result20,
                                  ds_result21,
                                  ds_result22,
                                  ds_result23,
                                  ds_result24,
                                  ds_result25,
                                  ds_result26,
                                  ds_result27,
                                  ds_result28,
                                  ds_result29,
                                  ds_result30,
                                  ds_result31,
                                  ds_result32,
                                  ds_result33,
                                  ds_result34,
                                  ds_result35,
                                  ds_result36,
                                  ds_result37,
                                  ds_result38,
                                  ds_result39,
                                  ds_result40,
                                  ds_result41,
                                  ds_result42,
                                  ds_result43,
                                  ds_result44,
                                  ds_result45,
                                  ds_result46,
                                  ds_result47,
                                  ds_result48,
                                  ds_result49,
                                  ds_result50,
                                  ds_result51,
                                  ds_result52,
                                  ds_result53,
                                  ds_result54,
                                  ds_result55,
                                  ds_result56,
                                  ds_result57,
                                  cd_pessoa_fisica,
                                  ds_referencia_ext,
                                  ie_resultado_referencia)
                           Values (current_setting('exames_grid_pck.nr_sequencia_w')::bigint,
                                  current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,
                                  null,
                                  upper(Wheb_mensagem_pck.get_texto(307233)), /*'HORARIOS'*/
                                  null,
                                  '',
                                  '',
                                  -3,
                                  0,
                                  0,
                                  0,
                                  '',
                                  current_setting('exames_grid_pck.vetor_w')::vetor[1].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[2].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[3].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[4].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[5].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[6].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[7].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[8].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[9].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[10].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[11].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[12].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[13].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[14].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[15].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[16].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[17].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[18].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[19].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[20].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[21].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[22].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[23].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[24].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[25].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[26].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[27].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[28].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[29].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[30].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[31].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[32].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[33].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[34].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[35].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[36].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[37].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[38].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[39].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[40].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[41].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[42].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[43].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[44].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[45].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[46].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[47].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[48].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[49].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[50].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[51].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[52].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[53].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[54].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[55].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[56].nm_coluna_w,
                                  current_setting('exames_grid_pck.vetor_w')::vetor[57].nm_coluna_w,
                                  current_setting('exames_grid_pck.cd_pessoa_fisica_param')::prescr_medica.cd_pessoa_fisica%type,
                                  '',
                                  '');

  open  current_setting('exames_grid_pck.c10')::CURSOR;
  loop
  fetch current_setting('exames_grid_pck.c10')::into CURSOR current_setting('exames_grid_pck.rowc10')::c10%rowtype;
  EXIT WHEN NOT FOUND; /* apply on current_setting('exames_grid_pck.c10')::CURSOR */

    select nextval('w_result_exame_grid_seq')
    into STRICT   current_setting('exames_grid_pck.nr_sequencia_w')::bigint
;

    if (current_setting('exames_grid_pck.ie_html_param')::varchar(1)   = 'S') then
      current_setting('exames_grid_pck.rowc10')::c10%rowtype.ds_grupo_exame_lab := '<b>'||current_setting('exames_grid_pck.rowc10')::c10%rowtype.ds_grupo_exame_lab||'</b>';
    end if;

    insert into w_result_exame_grid(nr_sequencia,
                                    nm_usuario,
                                    nm_exame,
                                    ie_ordem,
                                    ie_ordem_seg,
                                    nr_apres_grupo,
                                    nr_apres_exame,
                                    ds_cor_fundo,
                                    cd_pessoa_fisica)
                             values (current_setting('exames_grid_pck.nr_sequencia_w')::bigint,
                                    current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,
                                    current_setting('exames_grid_pck.rowc10')::c10%rowtype.ds_grupo_exame_lab,
                                    current_setting('exames_grid_pck.rowc10')::c10%rowtype.nr_seq_grupo,
                                    1,
                                    current_setting('exames_grid_pck.rowc10')::c10%rowtype.nr_seq_apresent,
                                    -2,
                                    current_setting('exames_grid_pck.rowc10')::c10%rowtype.ds_cor_fundo,
                                    current_setting('exames_grid_pck.cd_pessoa_fisica_param')::prescr_medica.cd_pessoa_fisica%type);

  end loop;
  close current_setting('exames_grid_pck.c10')::CURSOR;

  open  current_setting('exames_grid_pck.c11')::CURSOR;
  loop
  fetch current_setting('exames_grid_pck.c11')::into CURSOR current_setting('exames_grid_pck.rowc11')::current_setting('exames_grid_pck.c11')::CURSOR%rowtype;
  EXIT WHEN NOT FOUND; /* apply on current_setting('exames_grid_pck.c11')::CURSOR */

    if (current_setting('exames_grid_pck.ie_html_param')::varchar(1)   = 'S') then
        current_setting('exames_grid_pck.rowc11')::current_setting('exames_grid_pck.c11')::CURSOR%rowtype.ds_grupo_exame_lab  := '<b>'||current_setting('exames_grid_pck.rowc11')::current_setting('exames_grid_pck.c11')::CURSOR%rowtype.ds_grupo_exame_lab||'</b>';
    end if;

    select nextval('w_result_exame_grid_seq')
    into STRICT   current_setting('exames_grid_pck.nr_sequencia_w')::bigint
;

    insert into w_result_exame_grid(nr_sequencia,
                                    nm_usuario,
                                    nm_exame,
                                    ie_ordem,
                                    ie_ordem_seg,
                                    nr_apres_grupo,
                                    nr_apres_exame,
                                    cd_pessoa_fisica)
                             values (current_setting('exames_grid_pck.nr_sequencia_w')::bigint,
                                    current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,
                                    current_setting('exames_grid_pck.rowc11')::current_setting('exames_grid_pck.c11')::CURSOR%rowtype.ds_grupo_exame_lab,
                                    current_setting('exames_grid_pck.rowc11')::current_setting('exames_grid_pck.c11')::CURSOR%rowtype.nr_seq_grupo,
                                    1,
                                    current_setting('exames_grid_pck.rowc11')::current_setting('exames_grid_pck.c11')::CURSOR%rowtype.nr_seq_apresent,
                                    -2,
                                    current_setting('exames_grid_pck.cd_pessoa_fisica_param')::prescr_medica.cd_pessoa_fisica%type);

  end loop;
  close current_setting('exames_grid_pck.c11')::CURSOR;

  open current_setting('exames_grid_pck.c15')::CURSOR;
  loop
  fetch current_setting('exames_grid_pck.c15')::into CURSOR current_setting('exames_grid_pck.rowc15')::c15%rowtype;
  EXIT WHEN NOT FOUND; /* apply on current_setting('exames_grid_pck.c15')::CURSOR */
  begin

    PERFORM set_config('exames_grid_pck.entrou_w', false, false);
    if (current_setting('exames_grid_pck.rowc15')::c15%(rowtype.ds_resultado_parcial IS NOT NULL AND rowtype.ds_resultado_parcial::text <> '')) then
        PERFORM set_config('exames_grid_pck.entrou_w', true, false);

        insert into RESULT_EXAME_TEMP(nm_usuario,
                                      nr_seq_exame,
                                      nm_exame,
                                      nr_seq_material,
                                      ds_unidade_medida,
                                      ie_ordem,
                                      ie_ordem_seg,
                                      nr_apres_grupo,
                                      nr_apres_exame,
                                      ie_formato_resultado,
                                      ds_metodo,
                                      nr_seq_superior,
                                      nr_seq_resultado_lab)
                               values (nm_usuario_p,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_exame,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nm_exame,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_material,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ds_unidade_medida,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ie_ordem,
                                      2,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_apresent,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_apresent_exame,
                                      'D',
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ds_metodo,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_superior,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_resultado_lab);
    end if;

    if  ((current_setting('exames_grid_pck.rowc15')::c15%(rowtype.qt_resultado IS NOT NULL AND rowtype.qt_resultado::text <> '')) or (current_setting('exames_grid_pck.ie_status_atend_ww')::bigint = 25))
    and (current_setting('exames_grid_pck.rowc15')::c15%rowtype.ie_formato_result_exame in ('CA','CV','DV','VP','V')) then
        PERFORM set_config('exames_grid_pck.entrou_w', true, false);
        insert into RESULT_EXAME_TEMP(nm_usuario,
                                      nr_seq_exame,
                                      nm_exame,
                                      nr_seq_material,
                                      ds_unidade_medida,
                                      ie_ordem,
                                      ie_ordem_seg,
                                      nr_apres_grupo,
                                      nr_apres_exame,
                                      ie_formato_resultado,
                                      ds_metodo,
                                      nr_seq_superior,
                                      nr_seq_resultado_lab)
                               values (nm_usuario_p,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_exame,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nm_exame,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_material,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ds_unidade_medida,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ie_ordem,
                                      2,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_apresent,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_apresent_exame,
                                      'V',
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ds_metodo,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_superior,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_resultado_lab);

    end if;

    if (current_setting('exames_grid_pck.rowc15')::c15%(rowtype.pr_resultado IS NOT NULL AND rowtype.pr_resultado::text <> ''))
    and (current_setting('exames_grid_pck.rowc15')::c15%rowtype.ie_formato_result_exame in ('CA','P','VP')) then
        PERFORM set_config('exames_grid_pck.entrou_w', true, false);
        insert into RESULT_EXAME_TEMP(nm_usuario,
                                      nr_seq_exame,
                                      nm_exame,
                                      nr_seq_material,
                                      ds_unidade_medida,
                                      ie_ordem,
                                      ie_ordem_seg,
                                      nr_apres_grupo,
                                      nr_apres_exame,
                                      ie_formato_resultado,
                                      ds_metodo,
                                      nr_seq_superior,
                                      nr_seq_resultado_lab)
                               values (nm_usuario_p,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_exame,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nm_exame ||' ( % )',
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_material,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ds_unidade_medida,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ie_ordem,
                                      2,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_apresent,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_apresent_exame,
                                      'P',
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ds_metodo,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_superior,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_resultado_lab);
    end if;

    if (current_setting('exames_grid_pck.rowc15')::c15%rowtype.ie_formato_result_exame in ('D','DD','DL','DV','MS','MSL','S','SDM','SM'))
    and (current_setting('exames_grid_pck.rowc15')::c15%rowtype.ds_resultado <> '0')
    and (current_setting('exames_grid_pck.rowc15')::c15%(rowtype.ds_resultado IS NOT NULL AND rowtype.ds_resultado::text <> ''))
    or  ((current_setting('exames_grid_pck.ie_status_atend_ww')::bigint = 25) and (not current_setting('exames_grid_pck.entrou_w')::boolean)) then
        insert into RESULT_EXAME_TEMP(nm_usuario,
                                      nr_seq_exame,
                                      nm_exame,
                                      nr_seq_material,
                                      ds_unidade_medida,
                                      ie_ordem,
                                      ie_ordem_seg,
                                      nr_apres_grupo,
                                      nr_apres_exame,
                                      ie_formato_resultado,
                                      ds_metodo,
                                      nr_seq_superior,
                                      nr_seq_resultado_lab)
                               values (nm_usuario_p,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_exame,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nm_exame,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_material,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ds_unidade_medida,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ie_ordem,
                                      2,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_apresent,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_apresent_exame,
                                      'D',
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.ds_metodo,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_superior,
                                      current_setting('exames_grid_pck.rowc15')::c15%rowtype.nr_seq_resultado_lab);
    end if;

  end;
  end loop;
  close current_setting('exames_grid_pck.c15')::CURSOR;


  open  current_setting('exames_grid_pck.c30')::CURSOR;
  loop
  fetch current_setting('exames_grid_pck.c30')::into CURSOR current_setting('exames_grid_pck.rowc30')::c30%rowtype;
  EXIT WHEN NOT FOUND; /* apply on current_setting('exames_grid_pck.c30')::CURSOR */

    select  nextval('w_result_exame_grid_seq')
    into STRICT    current_setting('exames_grid_pck.nr_sequencia_w')::bigint
;

    select  ds_cor_fundo,
            ie_negrito,
            ie_italico
    into STRICT    current_setting('exames_grid_pck.ds_cor_fundo_w')::varchar(20),
            current_setting('exames_grid_pck.ie_negrito_w')::varchar(1),
            current_setting('exames_grid_pck.ie_italico_w')::varchar(1)
    from    exame_laboratorio
    where   nr_seq_exame = current_setting('exames_grid_pck.rowc30')::c30%rowtype.nr_seq_exame;


    PERFORM set_config('exames_grid_pck.ie_pode_inserir_w', 'S', false);
    if current_setting('exames_grid_pck.ie_modo_agrup_param')::varchar(1) = 'E' then
       select CASE WHEN count(1)=0 THEN 'S'  ELSE 'N' END
       into STRICT current_setting('exames_grid_pck.ie_pode_inserir_w')::varchar(1)
       from w_result_exame_grid
       where nm_usuario = current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type
       and   nr_seq_exame = current_setting('exames_grid_pck.rowc30')::c30%rowtype.nr_seq_exame
       and   nr_seq_material = current_setting('exames_grid_pck.rowc30')::c30%rowtype.nr_seq_material
       and   CASE WHEN ds_unidade_medida=current_setting('exames_grid_pck.rowc30')::c30%rowtype.ds_unidade_medida THEN  1  ELSE 0 END  = 1
       and   CASE WHEN ds_metodo=current_setting('exames_grid_pck.rowc30')::c30%rowtype.ds_metodo THEN 1  ELSE 0 END  = 1
       and   ie_formato_resultado = current_setting('exames_grid_pck.rowc30')::c30%rowtype.ie_formato_resultado;
    end if;

    if current_setting('exames_grid_pck.ie_pode_inserir_w')::varchar(1) = 'S' then
    insert into w_result_exame_grid(nr_sequencia,
                                    nm_usuario,
                                    nr_seq_exame,
                                    nm_exame,
                                    nr_seq_material,
                                    ds_unidade_medida,
                                    ie_ordem,
                                    ie_ordem_seg,
                                    nr_apres_grupo,
                                    nr_apres_exame,
                                    ie_formato_resultado,
                                    ds_metodo,
                                    ds_cor_fundo,
                                    ie_negrito,
                                    ie_italico,
                                    nr_seq_superior,
                                    cd_pessoa_fisica,
                                    nr_seq_resultado_lab)
                             values (current_setting('exames_grid_pck.nr_sequencia_w')::bigint,
                                    current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.nr_seq_exame,
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.nm_exame,
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.nr_seq_material,
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.ds_unidade_medida,
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.ie_ordem,
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.ie_ordem_seg,
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.nr_seq_apresent,
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.nr_seq_apresent_exame,
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.ie_formato_resultado,
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.ds_metodo,
                                    current_setting('exames_grid_pck.ds_cor_fundo_w')::varchar(20),
                                    coalesce(current_setting('exames_grid_pck.ie_negrito_w')::varchar(1),'N'),
                                    coalesce(current_setting('exames_grid_pck.ie_italico_w')::varchar(1),'N'),
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.nr_seq_superior,
                                    current_setting('exames_grid_pck.cd_pessoa_fisica_param')::prescr_medica.cd_pessoa_fisica%type,
                                    current_setting('exames_grid_pck.rowc30')::c30%rowtype.nr_seq_resultado_lab);
    end if;
  end loop;
  close current_setting('exames_grid_pck.c30')::CURSOR;

  insert into w_result_exame_grid(nr_sequencia,
                                  nm_usuario,
                                  ie_ordem,
                                  ie_ordem_seg,
                                  nr_apres_grupo,
                                  nr_apres_exame,
                                  cd_pessoa_fisica)
                          SELECT  nextval('w_result_exame_grid_seq'),
                                  current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,
                                  -10,
                                  0,
                                  -10,
                                  -10,
                                  current_setting('exames_grid_pck.cd_pessoa_fisica_param')::prescr_medica.cd_pessoa_fisica%type
;

  insert into w_result_exame_grid(nr_sequencia,
                                  nm_usuario,
                                  ie_ordem,
                                  ie_ordem_seg,
                                  nr_apres_grupo,
                                  nr_apres_exame,
                                  cd_pessoa_fisica)
                          SELECT  nextval('w_result_exame_grid_seq'),
                                  current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,
                                  -7,
                                  0,
                                  -7,
                                  -7,
                                  current_setting('exames_grid_pck.cd_pessoa_fisica_param')::prescr_medica.cd_pessoa_fisica%type
;

  insert into w_result_exame_grid(nr_sequencia,
                                  nm_usuario,
                                  ie_ordem,
                                  ie_ordem_seg,
                                  nr_apres_grupo,
                                  nr_apres_exame,
                                  cd_pessoa_fisica)
                          SELECT  nextval('w_result_exame_grid_seq'),
                                  current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,
                                  -4,
                                  0,
                                  -4,
                                  -4,
                                  current_setting('exames_grid_pck.cd_pessoa_fisica_param')::prescr_medica.cd_pessoa_fisica%type
;

  /* gerar itens x horarios */

  PERFORM set_config('exames_grid_pck.ind', 0, false);
  while(current_setting('exames_grid_pck.ind')::integer < current_setting('exames_grid_pck.ivet')::integer) loop
    begin
    PERFORM set_config('exames_grid_pck.ind', current_setting('exames_grid_pck.ind')::integer + 1, false);
    open  current_setting('exames_grid_pck.c03')::CURSOR;
    loop
    fetch current_setting('exames_grid_pck.c03')::into CURSOR current_setting('exames_grid_pck.rowc03')::C03%rowtype;
    EXIT WHEN NOT FOUND; /* apply on current_setting('exames_grid_pck.c03')::CURSOR */
      begin

      PERFORM set_config('exames_grid_pck.ds_resultado_w', substr(current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_resultado,1,2000), false);
      PERFORM set_config('exames_grid_pck.ds_observacao_w', current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_observacao, false);
      PERFORM set_config('exames_grid_pck.dt_resultado_ww', current_setting('exames_grid_pck.rowc03')::C03%rowtype.dt_resultado, false);
      PERFORM set_config('exames_grid_pck.dt_hora_w', current_setting('exames_grid_pck.rowc03')::C03%rowtype.dt_hora, false);
      PERFORM set_config('exames_grid_pck.dt_result_w', current_setting('exames_grid_pck.rowc03')::C03%rowtype.dt_result, false);
      PERFORM set_config('exames_grid_pck.nr_seq_exame_w', current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_exame, false);
      PERFORM set_config('exames_grid_pck.nr_seq_material_w', current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_material, false);

      if (current_setting('exames_grid_pck.rowc03')::C03%rowtype.dt_grid  is not  null) then
          PERFORM set_config('exames_grid_pck.dt_hora_w', to_char(current_setting('exames_grid_pck.rowc03')::C03%rowtype.dt_grid, 'hh24:mi'), false);
          PERFORM set_config('exames_grid_pck.dt_result_w', to_char(current_setting('exames_grid_pck.rowc03')::C03%rowtype.dt_grid, 'dd/mm/yy'), false);
      end if;

      PERFORM set_config('exames_grid_pck.ds_cor_w', '', false);
      PERFORM set_config('exames_grid_pck.ie_digitacao_w', 'N', false);

      if (current_setting('exames_grid_pck.ie_apresentar_digitacao_w')::varchar(1) = 'S')
      and (current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_status_atend  <=30)  then
        begin
          PERFORM set_config('exames_grid_pck.ie_digitacao_w', 'S', false);

          select  CASE WHEN length(to_char(current_setting('exames_grid_pck.ind')::integer))=1 THEN '0'||to_char(current_setting('exames_grid_pck.ind')::integer)  ELSE to_char(current_setting('exames_grid_pck.ind')::integer) END
          into STRICT  current_setting('exames_grid_pck.ds_cor_w')::varchar(20)
;
          PERFORM set_config('exames_grid_pck.ds_cor_w', current_setting('exames_grid_pck.ds_cor_w')::varchar(20) ||'4366,', false);
        end;
      elsif (current_setting('exames_grid_pck.rowc03')::C03%coalesce(rowtype.dt_aprovacao::text, '') = '') then
        begin
          select  CASE WHEN length(to_char(current_setting('exames_grid_pck.ind')::integer))=1 THEN '0'||to_char(current_setting('exames_grid_pck.ind')::integer)  ELSE to_char(current_setting('exames_grid_pck.ind')::integer) END
          into STRICT  current_setting('exames_grid_pck.ds_cor_w')::varchar(20)
;

          PERFORM set_config('exames_grid_pck.ds_cor_w', current_setting('exames_grid_pck.ds_cor_w')::varchar(20) ||'602,', false);
        end;
      ELSIF (current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_final = 'N') then
        begin
          SELECT CASE WHEN length(TO_CHAR(current_setting('exames_grid_pck.ind')::integer))=1 THEN  '0' || TO_CHAR(current_setting('exames_grid_pck.ind')::integer)  ELSE TO_CHAR(current_setting('exames_grid_pck.ind')::integer) END
          INTO STRICT current_setting('exames_grid_pck.ds_cor_w')::varchar(20)
;

          PERFORM set_config('exames_grid_pck.ds_cor_w', current_setting('exames_grid_pck.ds_cor_w')::varchar(20) || '11119,', false);
        end;
      elsif (coalesce(current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_resultado_critico, 'N') = 'S') OR (current_setting('exames_grid_pck.rowc03')::C03%(rowtype.ds_flag IS NOT NULL AND rowtype.ds_flag::text <> '')) then
        begin
          select  CASE WHEN length(to_char(current_setting('exames_grid_pck.ind')::integer))=1 THEN '0'||to_char(current_setting('exames_grid_pck.ind')::integer)  ELSE to_char(current_setting('exames_grid_pck.ind')::integer) END
          into STRICT  current_setting('exames_grid_pck.ds_cor_w')::varchar(20)
;

          PERFORM set_config('exames_grid_pck.ds_cor_w', current_setting('exames_grid_pck.ds_cor_w')::varchar(20) ||'10251,', false);
        end;
      elsif (current_setting('exames_grid_pck.rowc03')::C03%(rowtype.ds_cor_exame IS NOT NULL AND rowtype.ds_cor_exame::text <> '')) and (current_setting('exames_grid_pck.ie_html_param')::varchar(1)  = 'S')then
            SELECT
                CASE WHEN length(TO_CHAR(current_setting('exames_grid_pck.ind')::integer))=1 THEN  '0' || TO_CHAR(current_setting('exames_grid_pck.ind')::integer)  ELSE TO_CHAR(current_setting('exames_grid_pck.ind')::integer) END
            INTO STRICT current_setting('exames_grid_pck.ds_cor_w')::varchar(20)
;
            PERFORM set_config('exames_grid_pck.ds_cor_w', current_setting('exames_grid_pck.ds_cor_w')::varchar(20) || current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_cor_exame||',', false);
      elsif (coalesce(current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_normalidade,0) > 0) then
        begin
          select  CASE WHEN length(to_char(current_setting('exames_grid_pck.ind')::integer))=1 THEN '0'||to_char(current_setting('exames_grid_pck.ind')::integer)  ELSE to_char(current_setting('exames_grid_pck.ind')::integer) END
          into STRICT  current_setting('exames_grid_pck.ds_cor_w')::varchar(20)
;

          PERFORM set_config('exames_grid_pck.ds_cor_w', current_setting('exames_grid_pck.ds_cor_w')::varchar(20) ||to_char(current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_normalidade)||',', false);
        end;
      end if;

      CALL exames_grid_pck.updatetitlecolumn(current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_prescricao,
                        current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_nivel_atencao,
                        current_setting('exames_grid_pck.dt_hora_w')::varchar(15),
                        current_setting('exames_grid_pck.dt_result_w')::varchar(20),
                        current_setting('exames_grid_pck.ind')::integer);

      if (current_setting('exames_grid_pck.rowc03')::C03%(rowtype.qt_resultado IS NOT NULL AND rowtype.qt_resultado::text <> '')) then
        begin
          PERFORM set_config('exames_grid_pck.ds_result_w', current_setting('exames_grid_pck.rowc03')::C03%rowtype.qt_resultado, false);
          if  ((current_setting('exames_grid_pck.rowc03')::C03%rowtype.qt_resultado < 1)  and (current_setting('exames_grid_pck.rowc03')::C03%rowtype.qt_resultado > -1)) then
            if (pkg_i18n.get_user_locale <> 'en_AU') then
              PERFORM set_config('exames_grid_pck.ds_result_w', replace(current_setting('exames_grid_pck.ds_result_w')::varchar(20), ',', '0,'), false);
            else
              PERFORM set_config('exames_grid_pck.ds_result_w', replace(current_setting('exames_grid_pck.ds_result_w')::varchar(20), '.', '0.'), false);
            end if;
          end if;

          if (pkg_i18n.get_user_locale <> 'en_AU') then
          PERFORM set_config('exames_grid_pck.ds_result_w', replace(current_setting('exames_grid_pck.ds_result_w')::varchar(20),'.',','), false);
          end if;

          CALL exames_grid_pck.updateresult(current_setting('exames_grid_pck.ds_result_w')::varchar(20),
                       current_setting('exames_grid_pck.ds_cor_w')::varchar(20),
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_referencia,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_exame,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_material,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_unidade_resultado,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_referencia_ext,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_resultado_referencia,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_metodo,
                       'V',
                       current_setting('exames_grid_pck.ind')::integer);
        end;
      end if;

      if (current_setting('exames_grid_pck.rowc03')::C03%(rowtype.pr_resultado IS NOT NULL AND rowtype.pr_resultado::text <> '')) then
        begin
          PERFORM set_config('exames_grid_pck.ds_result_w', current_setting('exames_grid_pck.rowc03')::C03%rowtype.pr_resultado, false);
          if  ((current_setting('exames_grid_pck.rowc03')::C03%rowtype.pr_resultado < 1) and (current_setting('exames_grid_pck.rowc03')::C03%rowtype.pr_resultado > -1)) then
            if (pkg_i18n.get_user_locale <> 'en_AU') then
              PERFORM set_config('exames_grid_pck.ds_result_w', replace(current_setting('exames_grid_pck.ds_result_w')::varchar(20), ',', '0,'), false);
            else
              PERFORM set_config('exames_grid_pck.ds_result_w', replace(current_setting('exames_grid_pck.ds_result_w')::varchar(20), '.', '0.'), false);
            end if;
          end if;


          if (pkg_i18n.get_user_locale <> 'en_AU') then
             PERFORM set_config('exames_grid_pck.ds_result_w', replace(current_setting('exames_grid_pck.ds_result_w')::varchar(20),'.',','), false);
          end if;

          CALL exames_grid_pck.updateresult(current_setting('exames_grid_pck.ds_result_w')::varchar(20),
                       current_setting('exames_grid_pck.ds_cor_w')::varchar(20),
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_referencia,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_exame,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_material,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_unidade_resultado,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_referencia_ext,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_resultado_referencia,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_metodo,
                       'P',
                       current_setting('exames_grid_pck.ind')::integer);
        end;
      end if;

      if (current_setting('exames_grid_pck.ds_resultado_w')::(varchar(4000) IS NOT NULL AND (varchar(4000))::text <> '')) then
        begin
         if (obtain_user_locale(current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type) = 'de_DE')then
            select CASE WHEN current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_resultado_referencia='H' THEN  '+' WHEN current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_resultado_referencia='HH' THEN  '++' WHEN current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_resultado_referencia='L' THEN  '-' WHEN current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_resultado_referencia='LL' THEN  '--'  ELSE current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_resultado_referencia END
            into STRICT current_setting('exames_grid_pck.ds_resultado_referencia_w')::varchar(10)
;

            PERFORM set_config('exames_grid_pck.ds_resultado_referencia_w', ' '||current_setting('exames_grid_pck.ds_resultado_referencia_w')::varchar(10), false);
            if ((length(current_setting('exames_grid_pck.ds_resultado_w')::varchar(4000))+length(current_setting('exames_grid_pck.ds_resultado_referencia_w')::varchar(10)))>2000) then
           --SUBSTR sendo realizado para diminuir a variavel DS_RESULTADO_W para que quando concatenar com a variavel
           --DS_RESULTADO_REFERENCIA_W nao ultrapasse o valor do campo DS_RESULTX da tabela temporaria
                 PERFORM set_config('exames_grid_pck.ds_resultado_w', substr(current_setting('exames_grid_pck.ds_resultado_w')::varchar(4000),1,(length(current_setting('exames_grid_pck.ds_resultado_w')::varchar(4000))-length(current_setting('exames_grid_pck.ds_resultado_referencia_w')::varchar(10)))), false);
            end if;

            PERFORM set_config('exames_grid_pck.ds_resultado_w', current_setting('exames_grid_pck.ds_resultado_w')::varchar(4000) ||current_setting('exames_grid_pck.ds_resultado_referencia_w')::varchar(10), false);
         end if;

          CALL exames_grid_pck.updateresult(current_setting('exames_grid_pck.ds_resultado_w')::varchar(4000),
                       current_setting('exames_grid_pck.ds_cor_w')::varchar(20),
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_referencia,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_exame,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_material,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_unidade_resultado,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_referencia_ext,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_resultado_referencia,
                       current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_metodo,
                       'D',
                       current_setting('exames_grid_pck.ind')::integer);
        end;
      end if;

      if (current_setting('exames_grid_pck.ie_digitacao_w')::varchar(1) = 'S') then

        PERFORM set_config('exames_grid_pck.ds_comando_w', ' update w_result_exame_grid '||
                          ' set ds_result' || to_char(current_setting('exames_grid_pck.ind')::integer) || ' = :ds_resultado' ||
                          ' ,ds_cor = ds_cor || :ds_cor' ||
                          ' ,ds_referencia = :ds_referencia' ||
                          ' ,ds_referencia_ext = :ds_referencia_ext' ||
                          ' ,ie_resultado_referencia = :ie_resultado_referencia' ||
                          ' where nr_seq_exame  = :nr_seq_exame'    ||
                          ' and nr_seq_material = :nr_seq_material' ||
                          ' and decode(ds_unidade_medida, :ds_unidade_resultado_w, 1, 0) = 1'||
                          ' and decode(ds_metodo, :ds_metodo_w, 1, 0) = 1'||
                          ' and nm_usuario = :nm_usuario', false);

        PERFORM set_config('exames_grid_pck.ds_parametro_w', 'ds_resultado='||current_setting('exames_grid_pck.ds_digitacao_w')::varchar(255)||'#@#@ds_cor='||current_setting('exames_grid_pck.ds_cor_w')::varchar(20)||'#@#@ds_referencia='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_referencia||
                            '#@#@nr_seq_exame='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_exame||'#@#@nr_seq_material='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_material||'#@#@nm_usuario='||current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type||
                            '#@#@ds_unidade_resultado_w='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_unidade_resultado||'#@#@ds_referencia_ext='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_referencia_ext||
                            '#@#@ie_resultado_referencia='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_resultado_referencia||'#@#@ds_metodo_w='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_metodo||'#@#@', false);

        CALL exec_sql_dinamico_bv('TASY', current_setting('exames_grid_pck.ds_comando_w')::varchar(32000),current_setting('exames_grid_pck.ds_parametro_w')::varchar(32000));


      end if;


      if (current_setting('exames_grid_pck.rowc03')::C03%(rowtype.ds_resultado_parcial IS NOT NULL AND rowtype.ds_resultado_parcial::text <> '')) then
        begin

        select  substr(max(DS_RESULTADO_PARCIAL),1,2000)
        into STRICT  current_setting('exames_grid_pck.ds_observacao_w')::varchar(4000)
        from  exame_lab_result_parcial
        where nr_prescricao = current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_prescricao
        and nr_seq_prescr = current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_sequencia;

        PERFORM set_config('exames_grid_pck.ds_comando_w', ' update w_result_exame_grid '||
                          ' set ds_result' || to_char(current_setting('exames_grid_pck.ind')::integer) || ' = :ds_resultado' ||
                          ' ,ds_cor = ds_cor || :ds_cor' ||
                          ' ,ds_referencia = :ds_referencia' ||
                          ' ,ds_referencia_ext = :ds_referencia_ext' ||
                          ' ,ie_resultado_referencia = :ie_resultado_referencia' ||
                          ' where nr_seq_exame  = :nr_seq_exame'    ||
                          ' and nr_seq_material = :nr_seq_material' ||
                          ' and decode(ds_unidade_medida, :ds_unidade_resultado_w, 1, 0) = 1'||
                          ' and decode(ds_metodo, :ds_metodo_w, 1, 0) = 1'||
                          ' and nm_usuario = :nm_usuario', false);

        PERFORM set_config('exames_grid_pck.ds_parametro_w', 'ds_resultado='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_resultado_parcial||'#@#@ds_cor='||current_setting('exames_grid_pck.ds_cor_w')::varchar(20)||'#@#@ds_referencia='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_referencia||
                            '#@#@nr_seq_exame='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_exame||'#@#@nr_seq_material='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_material||'#@#@nm_usuario='||current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type||
                            '#@#@ds_unidade_resultado_w='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_unidade_resultado||'#@#@ds_referencia_ext='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_referencia_ext||
                            '#@#@ie_resultado_referencia='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.ie_resultado_referencia||'#@#@ds_metodo_w='||current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_metodo||'#@#@', false);

        CALL exec_sql_dinamico_bv('TASY', current_setting('exames_grid_pck.ds_comando_w')::varchar(32000),current_setting('exames_grid_pck.ds_parametro_w')::varchar(32000));
        end;
      end if;

      if (current_setting('exames_grid_pck.ds_observacao_w')::(varchar(4000) IS NOT NULL AND (varchar(4000))::text <> '')) then
        begin
          open current_setting('exames_grid_pck.c04')::CURSOR;
          loop
          fetch current_setting('exames_grid_pck.c04')::into CURSOR current_setting('exames_grid_pck.rowc04')::C04%rowtype;
          EXIT WHEN NOT FOUND; /* apply on current_setting('exames_grid_pck.c04')::CURSOR */
            begin
              select  nextval('w_result_exame_obs_seq')
              into STRICT    current_setting('exames_grid_pck.nr_seq_obs_w')::w_result_exame_obs.nr_sequencia%type
;

              insert into w_result_exame_obs(nr_sequencia,
                                             nm_usuario,
                                             nr_seq_result,
                                             dt_resultado,
                                             ds_observacao)
                                      values (current_setting('exames_grid_pck.nr_seq_obs_w')::w_result_exame_obs.nr_sequencia%type,
                                             current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,
                                             current_setting('exames_grid_pck.rowc04')::C04%rowtype.nr_sequencia,
                                             current_setting('exames_grid_pck.dt_resultado_ww')::timestamp,
                                             current_setting('exames_grid_pck.ds_observacao_w')::varchar(4000));
            end;
          end loop;
          close current_setting('exames_grid_pck.c04')::CURSOR;
        end;
      end if;

      if (current_setting('exames_grid_pck.rowc03')::C03%(rowtype.ds_referencia_result IS NOT NULL AND rowtype.ds_referencia_result::text <> '')) then
        begin
          open current_setting('exames_grid_pck.c05')::CURSOR;
          loop
          fetch current_setting('exames_grid_pck.c05')::into CURSOR current_setting('exames_grid_pck.rowc05')::c05%rowtype;
          EXIT WHEN NOT FOUND; /* apply on current_setting('exames_grid_pck.c05')::CURSOR */
            begin
              PERFORM set_config('exames_grid_pck.dt_resultado_ww', to_date(to_char(current_setting('exames_grid_pck.dt_resultado_ww')::timestamp,'dd/mm/yyyy hh24:mi')||':00','dd/mm/yyyy hh24:mi:ss'), false);

              select  nextval('w_result_exame_ref_seq')
              into STRICT    current_setting('exames_grid_pck.nr_seq_ref_w')::w_result_exame_ref.nr_sequencia%type
;

              insert into w_result_exame_ref(nr_sequencia,
                                             nm_usuario,
                                             nr_seq_result,
                                             dt_resultado,
                                             ds_referencia)
                                      values (current_setting('exames_grid_pck.nr_seq_ref_w')::w_result_exame_ref.nr_sequencia%type,
                                             current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,
                                             current_setting('exames_grid_pck.rowc05')::c05%rowtype.nr_seq_ref,
                                             current_setting('exames_grid_pck.dt_resultado_ww')::timestamp,
                                             current_setting('exames_grid_pck.rowc03')::C03%rowtype.ds_referencia_result);
            end;
          end loop;
          close current_setting('exames_grid_pck.c05')::CURSOR;
        end;
      end if;

	 if (current_setting('exames_grid_pck.rowc03')::C03%(rowtype.nr_seq_resultado IS NOT NULL AND rowtype.nr_seq_resultado::text <> '')) then
        begin
          open current_setting('exames_grid_pck.c06')::CURSOR;
          loop
          fetch current_setting('exames_grid_pck.c06')::into CURSOR current_setting('exames_grid_pck.rowc06')::current_setting('exames_grid_pck.c06')::CURSOR%rowtype;
          EXIT WHEN NOT FOUND; /* apply on current_setting('exames_grid_pck.c06')::CURSOR */
            begin

              select  nextval('w_result_exame_img_seq')
              into STRICT    current_setting('exames_grid_pck.nr_seq_img_w')::w_result_exame_img.nr_sequencia%type
;



              insert into w_result_exame_img(nr_sequencia,
                                             nm_usuario,
                                             nr_seq_exame,
                                             nr_seq_result_grid,
                                             nr_seq_prescr,
                                             nr_seq_resultado)
                                      values (current_setting('exames_grid_pck.nr_seq_img_w')::w_result_exame_img.nr_sequencia%type,
                                             current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type,
                                             current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_exame,
                                             current_setting('exames_grid_pck.rowc06')::current_setting('exames_grid_pck.c06')::CURSOR%rowtype.nr_seq_grid,
                                             current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_sequencia,
                                             current_setting('exames_grid_pck.rowc03')::C03%rowtype.nr_seq_resultado);
            end;
          end loop;
          close current_setting('exames_grid_pck.c06')::CURSOR;
        end;
      end if;

      end;
    end loop;
    close current_setting('exames_grid_pck.c03')::CURSOR;
    end;
  end loop;

  PERFORM set_config('exames_grid_pck.ds_comando_w', ' update w_result_exame_grid '||
                    ' set ds_material = Obter_Material_Exame_Lab(nr_seq_material,null,3) '||
                    ' where nm_usuario = :nm_usuario', false);

  PERFORM set_config('exames_grid_pck.ds_parametro_w', 'nm_usuario='||current_setting('exames_grid_pck.nm_usuario_param')::prescr_medica.nm_usuario%type||'#@#@', false);
  CALL exec_sql_dinamico_bv('TASY', current_setting('exames_grid_pck.ds_comando_w')::varchar(32000),current_setting('exames_grid_pck.ds_parametro_w')::varchar(32000));

  commit;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE exames_grid_pck.criar_atend_result_exame (nr_atendimento_p bigint, cd_pessoa_fisica_p text, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_exame_p text, nr_seq_grupo_exame_p text, ie_atendimento_p text, ie_sem_aprovacao_p text, ie_ordem_p bigint, nr_seq_protocolo_pep_p bigint, ie_data_p text, ie_data_hora_p text, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_modo_agrup_p text, ie_html_p text default 'N', ie_fora_referencia_p text default 'N', nr_seq_atend_cons_pepa_p exame_lab_resultado.nr_seq_atend_cons_pepa%type default null, ie_nivel_atencao_p text default null, ie_external_lab_result_p text default 'S') FROM PUBLIC;
