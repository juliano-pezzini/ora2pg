-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ageint_prof_grupos.prof_servico_ageint_grupo ( nr_seq_age_int_p bigint, nr_seq_proc_interno_p bigint) RETURNS SETOF INFO_PROFESSIONAL_REC_TABLE AS $body$
DECLARE


cd_convenio_w	agenda_integrada.cd_convenio%type;
cd_categoria_w agenda_integrada.cd_categoria%type;
cd_plano_w agenda_integrada.cd_plano%type;
info_professional_w info_professional_table;
nm_pessoa_fisica_sem_acento_w pessoa_fisica.nm_pessoa_fisica_sem_acento%type;

C01 CURSOR FOR
  SELECT distinct c.cd_medico
  from agenda a,
       agenda_turno b,
       agenda_turno_classif c
  where a.cd_agenda = b.cd_agenda
  and b.nr_sequencia = c.nr_seq_turno
  and	coalesce(a.ie_agenda_integrada,'N')	= 'S'
  and	a.ie_situacao = 'A'
  and	a.cd_tipo_Agenda = 5
  and (c.cd_medico IS NOT NULL AND c.cd_medico::text <> '')
  and Ageint_Obter_Regra_Ex_Adic(nr_seq_proc_interno_p, a.cd_estabelecimento, a.cd_agenda, cd_convenio_w, cd_categoria_w, cd_plano_w) > 0; --essa function ja valida a agenda_cons_regra_proc para nao criar uma nova
BEGIN

select cd_convenio,
  cd_categoria,
  cd_plano
into STRICT cd_convenio_w,
 cd_categoria_w,
 cd_plano_w
from agenda_integrada
where	nr_sequencia = nr_seq_age_int_p;

for r_c01 in C01 loop
  select max(nm_pessoa_fisica_sem_acento)
  into STRICT nm_pessoa_fisica_sem_acento_w
  from pessoa_fisica
  where cd_pessoa_fisica = r_c01.cd_medico;
  info_professional_w[r_c01.cd_medico].cd_pessoa_fisica := r_c01.cd_medico;
  info_professional_w[r_c01.cd_medico].nm_pessoa_fisica := obter_nome_pf(r_c01.cd_medico);
  info_professional_w[r_c01.cd_medico].ie_sexo := obter_sexo_pf(r_c01.cd_medico, 'C');
  info_professional_w[r_c01.cd_medico].nm_pessoa_fisica_sem_acento := nm_pessoa_fisica_sem_acento_w;
  RETURN NEXT info_professional_w(r_c01.cd_medico);
end loop;

end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION ageint_prof_grupos.prof_servico_ageint_grupo ( nr_seq_age_int_p bigint, nr_seq_proc_interno_p bigint) FROM PUBLIC;
