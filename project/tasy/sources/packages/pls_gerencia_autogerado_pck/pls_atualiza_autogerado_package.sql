-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Atualiza valor do autogerado(ie_autogerado) de acordo com o ie_op??o(L - Lipmpeza, A - Atualiza)



CREATE OR REPLACE PROCEDURE pls_gerencia_autogerado_pck.pls_atualiza_autogerado ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, tb_seq_conta_proc_p dbms_sql.number_table, tb_seq_autogerado_p dbms_sql.number_table, ie_opcao_p text, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

--ie_opcao_p A - ir? atualizar a conta proc com a sequencia da regra de autogerado L - ir? limpar os campos relacionados ao autogerado	


tb_sequencia_w		dbms_sql.number_table;
	
C01 CURSOR(	nr_seq_conta_pc		pls_conta.nr_sequencia%type,
		nr_seq_lote_pc		pls_protocolo_conta.nr_seq_lote_conta%type,
		nr_seq_protocolo_pc	pls_protocolo_conta.nr_sequencia%type,
		nr_seq_lote_processo_pc	pls_cta_lote_proc_conta.nr_seq_lote_processo%type,
		nr_seq_analise_pc	pls_analise_conta.nr_sequencia%type) FOR
	SELECT	nr_sequencia
	from	pls_conta_proc_v	proc
	where	proc.nr_seq_conta 	= nr_seq_conta_pc
	and	(nr_seq_autogerado IS NOT NULL AND nr_seq_autogerado::text <> '')
	
union all

	SELECT	nr_sequencia
	from	pls_conta_proc_v	proc
	where	proc.nr_seq_protocolo 	= nr_seq_protocolo_pc
	and	coalesce(nr_seq_conta_pc::text, '') = ''
	and	(nr_seq_autogerado IS NOT NULL AND nr_seq_autogerado::text <> '')
	
union all

	select	nr_sequencia
	from	pls_conta_proc_v	proc
	where	proc.nr_seq_lote_conta 	= nr_seq_lote_pc
	and	coalesce(nr_seq_conta_pc::text, '') = ''
	and	coalesce(nr_seq_protocolo_pc::text, '') = ''	
	and	(nr_seq_autogerado IS NOT NULL AND nr_seq_autogerado::text <> '')
	
union all

	select	nr_sequencia
	from	pls_conta_proc_v	proc
	where	coalesce(nr_seq_lote_pc::text, '') = ''
	and	coalesce(nr_seq_conta_pc::text, '') = ''
	and	coalesce(nr_seq_protocolo_pc::text, '') = ''	
	and	(nr_seq_autogerado IS NOT NULL AND nr_seq_autogerado::text <> '')
	and	exists (select	1
			from	pls_cta_lote_proc_cta_temp lote
			where	lote.nr_seq_conta = proc.nr_seq_conta)
	
union all

	select	nr_sequencia
	from	pls_conta_proc_v	proc
	where	proc.nr_seq_analise 	= nr_seq_analise_pc
	and	coalesce(nr_seq_conta_pc::text, '') = ''
	and	coalesce(nr_seq_protocolo_pc::text, '') = ''	
	and	(nr_seq_autogerado IS NOT NULL AND nr_seq_autogerado::text <> '');
	

BEGIN

--Limpa as informa??es de autogerado(ie_autogerado e nr_seq_autogerado)

if (ie_opcao_p	= 'L') then
		
	open C01(nr_seq_conta_p, nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_analise_p);

	loop
		-- Limpa os registros da lista para que n?o seja processado o mesmo registro mais de uma vez.

		tb_sequencia_w.delete;
		
		-- Executa o fetch de um n?mero determinado de linhas do cursor na lista.

		fetch c01 bulk collect into tb_sequencia_w limit pls_util_cta_pck.qt_registro_transacao_w;

		-- Quando o cursor n?o tiver mais linhas ent?o sai do loop.

		exit when tb_sequencia_w.count = 0;
					
		--Faz update dos registros(delimitados)

		forall i in tb_sequencia_w.first..tb_sequencia_w.last
			update	pls_conta_proc	cp
			set	ie_autogerado		= 'N',
				nr_seq_autogerado	 = NULL,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp()
			where	nr_sequencia		= tb_sequencia_w(i);
			commit;
	end loop;
	close C01;


--Seta as informa??es do autogerado(ie_autogerado = 'S' e nr_seq_autogerado)

elsif (ie_opcao_p	= 'A') then
	if (tb_seq_conta_proc_p.count > 0 ) then
		--Faz update dos registros(delimitados)

		forall i in tb_seq_conta_proc_p.first..tb_seq_conta_proc_p.last
			update	pls_conta_proc
			set	ie_autogerado		= 'S',
				nr_seq_autogerado	= tb_seq_autogerado_p(i),
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp()
			where	nr_sequencia		= tb_seq_conta_proc_p(i);
			commit;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_autogerado_pck.pls_atualiza_autogerado ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, tb_seq_conta_proc_p dbms_sql.number_table, tb_seq_autogerado_p dbms_sql.number_table, ie_opcao_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
