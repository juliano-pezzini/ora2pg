-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_gerencia_autogerado_pck.pls_obter_restricao_regra_aut ( ie_opcao_p text, dados_regra_p pls_gerencia_autogerado_pck.dados_regra, cursor_p integer, nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type) RETURNS PLS_GERENCIA_AUTOGERADO_PCK.DADOS_RESTRICAO AS $body$
DECLARE

/*ie_tipo_item_p
CP - conta proc
P - Participante*/

ds_retorno_w	pls_gerencia_autogerado_pck.dados_restricao;
ds_condicao_w	varchar(1000);
ds_filtro1_w	varchar(500);
ds_filtro2_w	varchar(500);


BEGIN
ds_retorno_w.ds_campos := null;
ds_retorno_w.ds_tabelas := null;
ds_retorno_w.ds_restricao := null;

--Aqui restringe os procedimentos pela conta

if (nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and	cp.nr_seq_conta = :nr_seq_conta_p '|| pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_conta_p', nr_seq_conta_p);
	end if;
end if;	
--Restri??o dos procedimentos por protocolo

if (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and	cp.nr_seq_protocolo 	= :nr_seq_protocolo_p '|| pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_protocolo_p', nr_seq_protocolo_p);
	end if;
end if;	
--Restri??o dos procedimentos por lote

if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and	cp.nr_seq_lote_conta 	= :nr_seq_lote_conta_p '|| pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_lote_conta_p', nr_seq_lote_p);
	end if;
end if;	
if (nr_seq_lote_processo_p IS NOT NULL AND nr_seq_lote_processo_p::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao||'and	exists	(select	1' || pls_util_pck.enter_w ||
					   '		from	pls_cta_lote_proc_cta_temp lote '|| pls_util_pck.enter_w ||
					   '		where	lote.nr_seq_conta  		= cp.nr_seq_conta )'|| pls_util_pck.enter_w;
	else
		null;
	end if;
end if;
--Aqui restringe os procedimentos pela an?lise

if (nr_seq_analise_p IS NOT NULL AND nr_seq_analise_p::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and	cp.nr_seq_analise = :nr_seq_analise_p '|| pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_analise_p', nr_seq_analise_p);
	end if;
end if;
--Restri??o por grupo de servi?o

if (dados_regra_p.nr_seq_grupo_servico IS NOT NULL AND dados_regra_p.nr_seq_grupo_servico::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		
		if (pls_util_cta_pck.usar_novo_agrup = 'S') then
		
			ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 	'and	exists	(select	1' || pls_util_pck.enter_w ||
											'		 from	pls_grupo_servico_tm grupo '|| pls_util_pck.enter_w ||
											'		 where	grupo.nr_seq_grupo_servico = :nr_seq_grupo_p'|| pls_util_pck.enter_w ||
											'		 and	grupo.ie_origem_proced = cp.ie_origem_proced'|| pls_util_pck.enter_w ||
											'		 and	grupo.cd_procedimento = cp.cd_procedimento'|| pls_util_pck.enter_w ||
											'		)'|| pls_util_pck.enter_w;
		else
			ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and	exists	(select	1' || pls_util_pck.enter_w ||
							   '		from	table(pls_grupos_pck.obter_procs_grupo_servico(:nr_seq_grupo_p, cp.ie_origem_proced, cp.cd_procedimento)) grupo '|| pls_util_pck.enter_w ||
							   '		)'|| pls_util_pck.enter_w;
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_grupo_p', dados_regra_p.nr_seq_grupo_servico);
	end if;
end if;
--Restri??o por c?digo do procedimento

if (dados_regra_p.cd_procedimento IS NOT NULL AND dados_regra_p.cd_procedimento::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and (cp.cd_procedimento	= :cd_procedimento_p and cp.ie_origem_proced = :ie_origem_proced_p ) '|| pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_procedimento_p', dados_regra_p.cd_procedimento);
		dbms_sql.bind_variable(cursor_p, ':ie_origem_proced_p', dados_regra_p.ie_origem_proced);
		
	end if;
end if;
if (dados_regra_p.cd_grupo_proc IS NOT NULL AND dados_regra_p.cd_grupo_proc::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.cd_grupo_proc	= :cd_grupo_proc_p '|| pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_grupo_proc_p', dados_regra_p.cd_grupo_proc);
	end if;
end if;
if (dados_regra_p.cd_especialidade IS NOT NULL AND dados_regra_p.cd_especialidade::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.cd_especialidade	= :cd_especialidade_p '|| pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_especialidade_p', dados_regra_p.cd_especialidade);
	end if;
end if;
if (dados_regra_p.cd_area_procedimento IS NOT NULL AND dados_regra_p.cd_area_procedimento::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.cd_area_procedimento	= :cd_area_procedimento_p '|| pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_area_procedimento_p', dados_regra_p.cd_area_procedimento);
	end if;
end if;
if (dados_regra_p.nr_seq_tipo_acomodacao IS NOT NULL AND dados_regra_p.nr_seq_tipo_acomodacao::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.nr_seq_tipo_acomodacao	= :nr_seq_tipo_acomodacao_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_tipo_acomodacao_p', dados_regra_p.nr_seq_tipo_acomodacao);
	end if;
end if;
if (dados_regra_p.nr_seq_tipo_atendimento IS NOT NULL AND dados_regra_p.nr_seq_tipo_atendimento::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.nr_seq_tipo_atendimento = :nr_seq_tipo_atendimento_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_tipo_atendimento_p', dados_regra_p.nr_seq_tipo_atendimento);
	end if;
end if;
if (dados_regra_p.ie_regime_atendimento IS NOT NULL AND dados_regra_p.ie_regime_atendimento::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.ie_regime_atendimento = :ie_regime_atendimento_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':ie_regime_atendimento_p', dados_regra_p.ie_regime_atendimento);
	end if;
end if;
if (dados_regra_p.ie_saude_ocupacional IS NOT NULL AND dados_regra_p.ie_saude_ocupacional::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.ie_saude_ocupacional = :ie_saude_ocupacional_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':ie_saude_ocupacional_p', dados_regra_p.ie_saude_ocupacional);
	end if;
end if;
if (dados_regra_p.nr_seq_prestador IS NOT NULL AND dados_regra_p.nr_seq_prestador::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.nr_seq_prestador_exec = :nr_seq_prestador_exec_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_prestador_exec_p', dados_regra_p.nr_seq_prestador);
	end if;
end if;
if (dados_regra_p.nr_seq_plano IS NOT NULL AND dados_regra_p.nr_seq_plano::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.nr_seq_plano	= :nr_seq_plano_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_plano_p', dados_regra_p.nr_seq_plano);
	end if;
end if;

if (dados_regra_p.nr_seq_classif_prot IS NOT NULL AND dados_regra_p.nr_seq_classif_prot::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.nr_seq_clas_prest_prot = :nr_seq_classif_prot_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_classif_prot_p ', dados_regra_p.nr_seq_classif_prot);
	end if;
end if;
if (dados_regra_p.nr_seq_classificacao IS NOT NULL AND dados_regra_p.nr_seq_classificacao::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.nr_seq_clas_prest_exec = :nr_seq_classificacao_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_classificacao_p', dados_regra_p.nr_seq_classificacao);
	end if;
end if;
if (dados_regra_p.ie_tipo_guia IS NOT NULL AND dados_regra_p.ie_tipo_guia::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.ie_tipo_guia	= :ie_tipo_guia_p '|| pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':ie_tipo_guia_p', dados_regra_p.ie_tipo_guia);
	end if;
end if;
if (dados_regra_p.cd_prestador IS NOT NULL AND dados_regra_p.cd_prestador::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.cd_prestador_exec = :cd_prestador_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':cd_prestador_p', dados_regra_p.cd_prestador);
	end if;
end if;
if (dados_regra_p.ie_tipo_segurado IS NOT NULL AND dados_regra_p.ie_tipo_segurado::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.ie_tipo_segurado = :ie_tipo_segurado_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':ie_tipo_segurado_p', dados_regra_p.ie_tipo_segurado);
	end if;
end if;
--alterado para buscar a sequ?ncia do prestador e n?o mais o c?digo devido ao custo de performance gerado pelo mesmo dgkorz

if (dados_regra_p.nr_seq_grupo_prest_exec IS NOT NULL AND dados_regra_p.nr_seq_grupo_prest_exec::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_campos	:= ds_retorno_w.ds_campos||', (select	count(1)' || pls_util_pck.enter_w ||
		       				   '		from	pls_preco_prestador grupo '|| pls_util_pck.enter_w ||
						   '		where	grupo.nr_seq_grupo	= :nr_seq_grupo_prest_exec_p '||pls_util_pck.enter_w||
						   '		and     grupo.nr_seq_prestador  = cp.nr_seq_prestador_exec ) qtde_prest_exec'|| pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_grupo_prest_exec_p', dados_regra_p.nr_seq_grupo_prest_exec);
	end if;
else
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_campos	:= ds_retorno_w.ds_campos||', null qtde_prest_exec'|| pls_util_pck.enter_w;
	end if;
end if;
if (dados_regra_p.nr_seq_classif_solic IS NOT NULL AND dados_regra_p.nr_seq_classif_solic::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao	:= ds_retorno_w.ds_restricao || 'and cp.nr_seq_clas_prest_solic = :nr_seq_classif_solic_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_classif_solic_p', dados_regra_p.nr_seq_classif_solic);
	end if;
end if;
if (dados_regra_p.nr_seq_grupo_prest_solic IS NOT NULL AND dados_regra_p.nr_seq_grupo_prest_solic::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_campos	:= ds_retorno_w.ds_campos || ', (select	count(1)' || pls_util_pck.enter_w ||
		       				   '		from	pls_preco_prestador grupo '|| pls_util_pck.enter_w ||
						   '		where	grupo.nr_seq_grupo	= :nr_seq_grupo_prest_solic_p '||pls_util_pck.enter_w||
						   '		and	grupo.nr_seq_prestador	= cp.nr_seq_prestador_solic ) qtde_prest_solic'|| pls_util_pck.enter_w;

	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_grupo_prest_solic_p', dados_regra_p.nr_seq_grupo_prest_solic);
	end if;
else
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_campos	:= ds_retorno_w.ds_campos || ', null qtde_prest_solic'|| pls_util_pck.enter_w;
	end if;
end if;
if (dados_regra_p.nr_seq_tipo_prest_solic IS NOT NULL AND dados_regra_p.nr_seq_tipo_prest_solic::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || ' and cp.nr_seq_tipo_prest_solic	= :nr_seq_tipo_prestador_solic_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_tipo_prestador_solic_p', dados_regra_p.nr_seq_tipo_prest_solic);
	end if;
end if;
if (dados_regra_p.nr_seq_tipo_prest_prot IS NOT NULL AND dados_regra_p.nr_seq_tipo_prest_prot::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.nr_seq_tipo_prest_prot	= :nr_seq_tipo_prest_prot_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_tipo_prest_prot_p', dados_regra_p.nr_seq_tipo_prest_prot);
	end if;
end if;
if (dados_regra_p.nr_seq_tipo_prestador IS NOT NULL AND dados_regra_p.nr_seq_tipo_prestador::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.nr_seq_tipo_prest_exec	= :nr_seq_tipo_prestador_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_tipo_prestador_p', dados_regra_p.nr_seq_tipo_prestador);
	end if;
end if;
if (dados_regra_p.nr_seq_grupo_rec IS NOT NULL AND dados_regra_p.nr_seq_grupo_rec::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and cp.nr_seq_grupo_rec		= :nr_seq_grupo_rec_p '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_grupo_rec_p', dados_regra_p.nr_seq_grupo_rec);
	end if;
end if;

if (dados_regra_p.nr_seq_grupo_med_solic IS NOT NULL AND dados_regra_p.nr_seq_grupo_med_solic::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		if (dados_regra_p.ie_origem_medico_solic = 'C') then
			ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and	exists	(select	1' || pls_util_pck.enter_w ||
		       				   '		from	pls_medico_grupo grupo '|| pls_util_pck.enter_w ||
						   '		where	grupo.nr_sequencia	= :nr_seq_grupo_med_solic_p '||pls_util_pck.enter_w||
						   '		and     grupo.cd_pessoa_fisica  = cp.cd_medico_solicitante )'|| pls_util_pck.enter_w;
		else
			ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and	exists	(select	1' || pls_util_pck.enter_w ||
		       				   '		from	pls_medico_grupo grupo '|| pls_util_pck.enter_w ||
						   '		where	grupo.nr_sequencia	= :nr_seq_grupo_med_solic_p '||pls_util_pck.enter_w||
						   '		and     grupo.cd_pessoa_fisica  = cp.cd_medico_solic_guia )'|| pls_util_pck.enter_w;
		end if;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_grupo_med_solic_p', dados_regra_p.nr_seq_grupo_med_solic);
	end if;
end if;
if (dados_regra_p.nr_seq_grupo_med_exec IS NOT NULL AND dados_regra_p.nr_seq_grupo_med_exec::text <> '') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao || 'and	exists	(select	1' || pls_util_pck.enter_w ||
					   '		from	pls_medico_grupo grupo '|| pls_util_pck.enter_w ||
					   '		where	grupo.nr_sequencia	= :nr_seq_grupo_med_exec_p '||pls_util_pck.enter_w||
					   '		and     grupo.cd_pessoa_fisica  = cp.cd_medico_executante )'|| pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':nr_seq_grupo_med_exec_p', dados_regra_p.nr_seq_grupo_med_exec);
	end if;
end if;	

if (dados_regra_p.ie_vinc_internacao IS NOT NULL AND dados_regra_p.ie_vinc_internacao::text <> '') and (dados_regra_p.ie_vinc_internacao = 'I') then
	if (ie_opcao_p	= 'RESTRICAO') then
		ds_retorno_w.ds_restricao	:= ds_retorno_w.ds_restricao || 'and cp.ie_vinc_internado		= :ie_vinc_internacao '||pls_util_pck.enter_w;
	else
		dbms_sql.bind_variable(cursor_p, ':ie_vinc_internacao', dados_regra_p.ie_vinc_internacao);
	end if;	
end if;

ds_retorno_w.ds_restricao := ds_retorno_w.ds_restricao;
	
return	ds_retorno_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerencia_autogerado_pck.pls_obter_restricao_regra_aut ( ie_opcao_p text, dados_regra_p pls_gerencia_autogerado_pck.dados_regra, cursor_p integer, nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type) FROM PUBLIC;
