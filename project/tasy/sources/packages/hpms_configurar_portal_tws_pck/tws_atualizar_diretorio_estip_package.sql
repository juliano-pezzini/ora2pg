-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Atualizar os diretorio de anexos no storage, usado somente no Delphi
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 


CREATE OR REPLACE PROCEDURE hpms_configurar_portal_tws_pck.tws_atualizar_diretorio_estip ( nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type ) AS $body$
DECLARE



ds_diretorio_anexo_adesao_w	pls_param_estipulante_tws.ds_diretorio_anexo_adesao%type;
ds_diretorio_anexo_resscisao_w	pls_param_estipulante_tws.ds_diretorio_anexo_resscisao%type;
ds_dir_anexo_reinclusao_w	pls_param_estipulante_tws.ds_diretorio_anexo_reinclusao%type;
ds_dir_anexo_auditoria_w	pls_param_estipulante_tws.ds_diretorio_anexo_auditoria%type;
ds_diretorio_temp_w		pls_param_estipulante_tws.ds_diretorio_temp%type;
qt_storage_w			integer;


BEGIN

select  max(ds_diretorio_anexo_adesao),
	max(ds_diretorio_anexo_resscisao),
	max(ds_diretorio_anexo_reinclusao),
	max(ds_diretorio_anexo_auditoria),
	max(ds_diretorio_temp)
into STRICT	ds_diretorio_anexo_adesao_w,
	ds_diretorio_anexo_resscisao_w,
	ds_dir_anexo_reinclusao_w,
	ds_dir_anexo_auditoria_w,
	ds_diretorio_temp_w
from    pls_param_estipulante_tws
where   cd_estabelecimento = cd_estabelecimento_p;

if (ds_diretorio_anexo_adesao_w IS NOT NULL AND ds_diretorio_anexo_adesao_w::text <> '') then
	select  count(1)
	into STRICT	qt_storage_w
	from    file_storage_path
	where   nm_storage = 'HPMS_FILES_PROPOSAL';
	
	if (qt_storage_w > 0) then
		
		update	file_storage_path
		set	ds_path		= ds_diretorio_anexo_adesao_w,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where   nm_storage	= 'HPMS_FILES_PROPOSAL'
		and	cd_uuid		= '78efd01a-a099-4f21-9f60-975367c7b1a4';
	else	
		insert into file_storage_path(nm_storage, cd_uuid, cd_estabelecimento,
			ds_path, ie_writable, ie_readable,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec, ie_driver)
		values ( 'HPMS_FILES_PROPOSAL', '78efd01a-a099-4f21-9f60-975367c7b1a4',cd_estabelecimento_p,
			ds_diretorio_anexo_adesao_w, 'S', 'S',
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			nm_usuario_p, 'local');
	end if;
end if;

qt_storage_w	:= 0;

if (ds_diretorio_anexo_resscisao_w IS NOT NULL AND ds_diretorio_anexo_resscisao_w::text <> '') then
	select  count(1)
	into STRICT	qt_storage_w
	from    file_storage_path
	where   nm_storage = 'HPMS_RESCISSION_ATTACHMENT';
	
	if (qt_storage_w > 0) then
		
		update	file_storage_path
		set	ds_path		= ds_diretorio_anexo_resscisao_w,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where   nm_storage	= 'HPMS_RESCISSION_ATTACHMENT'
		and	cd_uuid		= 'ba4e3f3d-5dc5-46d7-9b55-943200cfa040';
	else	
		insert into file_storage_path(nm_storage, cd_uuid, cd_estabelecimento,
			ds_path, ie_writable, ie_readable,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec, ie_driver)
		values ( 'HPMS_RESCISSION_ATTACHMENT', 'ba4e3f3d-5dc5-46d7-9b55-943200cfa040',cd_estabelecimento_p,
			ds_diretorio_anexo_resscisao_w, 'S', 'S',
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			nm_usuario_p, 'local');
	end if;
end if;

qt_storage_w	:= 0;

if (ds_dir_anexo_reinclusao_w IS NOT NULL AND ds_dir_anexo_reinclusao_w::text <> '') then
	select  count(1)
	into STRICT	qt_storage_w
	from    file_storage_path
	where   nm_storage = 'HPMS_REINCLUSION_REQUEST';
	
	if (qt_storage_w > 0) then
		
		update	file_storage_path
		set	ds_path		= ds_dir_anexo_reinclusao_w,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where   nm_storage	= 'HPMS_REINCLUSION_REQUEST'
		and	cd_uuid		= '45364c84-b548-4c8b-80a9-847ad96b217e';
	else	
		insert into file_storage_path(nm_storage, cd_uuid, cd_estabelecimento,
			ds_path, ie_writable, ie_readable,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec, ie_driver)
		values ( 'HPMS_REINCLUSION_REQUEST', '45364c84-b548-4c8b-80a9-847ad96b217e',cd_estabelecimento_p,
			ds_dir_anexo_reinclusao_w, 'S', 'S',
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			nm_usuario_p, 'local');
	end if;
end if;

qt_storage_w	:= 0;

if (ds_dir_anexo_auditoria_w IS NOT NULL AND ds_dir_anexo_auditoria_w::text <> '') then
	select  count(1)
	into STRICT	qt_storage_w
	from    file_storage_path
	where   nm_storage = 'HPMS_AUT_ANALYSIS_AUDIT';
	
	if (qt_storage_w > 0) then
		
		update	file_storage_path
		set	ds_path		= ds_dir_anexo_auditoria_w,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where   nm_storage	= 'HPMS_AUT_ANALYSIS_AUDIT'
		and	cd_uuid		= 'c12cd047-ba55-4661-8b48-7bd53cac7ad0';
	else	
		insert into file_storage_path(nm_storage, cd_uuid, cd_estabelecimento,
			ds_path, ie_writable, ie_readable,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec, ie_driver)
		values ( 'HPMS_AUT_ANALYSIS_AUDIT', 'c12cd047-ba55-4661-8b48-7bd53cac7ad0',cd_estabelecimento_p,
			ds_dir_anexo_auditoria_w, 'S', 'S',
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			nm_usuario_p, 'local');
	end if;
end if;

qt_storage_w	:= 0;

if (ds_diretorio_temp_w IS NOT NULL AND ds_diretorio_temp_w::text <> '') then
	select  count(1)
	into STRICT	qt_storage_w
	from    file_storage_path
	where   nm_storage = 'TEMP';
	
	if (qt_storage_w > 0) then
		
		update	file_storage_path
		set	ds_path		= ds_diretorio_temp_w,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where   nm_storage	= 'TEMP'
		and	cd_uuid		= '90f39937-aa73-4014-9216-de0388fca363';
	else	
		insert into file_storage_path(nm_storage, cd_uuid, cd_estabelecimento,
			ds_path, ie_writable, ie_readable,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec, ie_driver)
		values ( 'TEMP', '90f39937-aa73-4014-9216-de0388fca363',cd_estabelecimento_p,
			ds_diretorio_temp_w, 'S', 'S',
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			nm_usuario_p, 'local');
	end if;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hpms_configurar_portal_tws_pck.tws_atualizar_diretorio_estip ( nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type ) FROM PUBLIC;
