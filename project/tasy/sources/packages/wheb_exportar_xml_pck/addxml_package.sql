-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE wheb_exportar_xml_pck.addxml (ds_xml_p text) AS $body$
DECLARE

	x	integer;
	ds_xml_aux	varchar(32000);
	
BEGIN
		begin
		-- Quando for para gerar o XML com CLOB utilizar desta forma.

		if (current_setting('wheb_exportar_xml_pck.ie_tipo_w')::varchar(60) = 'INTCOM') or (current_setting('wheb_exportar_xml_pck.ie_tipo_w')::varchar(60) = 'INTDISPMH') or (current_setting('wheb_exportar_xml_pck.ie_tipo_w')::varchar(60) = 'INTDISPAP') then
		
			x	:= coalesce(octet_length(current_setting('wheb_exportar_xml_pck.ds_xml_clob_w')::text),0);
			
			if (x = 0) then
				dbms_lob.write(current_setting('wheb_exportar_xml_pck.ds_xml_clob_w')::text, coalesce(length(ds_xml_p),1), 1, ds_xml_p);
			else
				dbms_lob.write(current_setting('wheb_exportar_xml_pck.ds_xml_clob_w')::text, coalesce(length(ds_xml_p),1), x+1, ds_xml_p);
			end if;
		-- XSIP

		elsif (current_setting('wheb_exportar_xml_pck.ie_tipo_w')::varchar(60) = 'SIP') then
			
			-- Para o SIP faz mais simples e adiciona o valor ao final do arquivo.

			dbms_lob.append(current_setting('wheb_exportar_xml_pck.ds_xml_clob_w')::text, ds_xml_p);
		else
			begin
			ds_xml_aux := ds_xml_p;
			if (current_setting('wheb_exportar_xml_pck.ds_carac_espec_conv_w')::(varchar(255) IS NOT NULL AND (varchar(255))::text <> '')) and (ds_xml_p IS NOT NULL AND ds_xml_p::text <> '') then
				ds_xml_aux	:= wheb_exportar_xml_pck.elimina_caracteres_especiais(ds_xml_aux, current_setting('wheb_exportar_xml_pck.ds_carac_espec_conv_w')::varchar(255));
			end	if;
			if ( current_setting('wheb_exportar_xml_pck.ie_proj_carac_esp_w')::varchar(1) = 'S' ) and ( current_setting('wheb_exportar_xml_pck.ds_carac_espec_w')::(varchar(255) IS NOT NULL AND (varchar(255))::text <> '')) and (ds_xml_p IS NOT NULL AND ds_xml_p::text <> '') then
				ds_xml_aux	:= wheb_exportar_xml_pck.elimina_caracteres_especiais(ds_xml_aux, current_setting('wheb_exportar_xml_pck.ds_carac_espec_w')::varchar(255));
			end	if;
			if ( current_setting('wheb_exportar_xml_pck.ie_consist_acent')::varchar(1) = 'S' ) and (ds_xml_p IS NOT NULL AND ds_xml_p::text <> '') then
				ds_xml_aux	:= Elimina_Acentos(ds_xml_aux, 'S');
			end	if;
			PERFORM set_config('wheb_exportar_xml_pck.ds_xml_w', current_setting('wheb_exportar_xml_pck.ds_xml_w')::varchar(32000) || ds_xml_aux, false);
			end;
		end if;
		exception
			when OTHERS then
			CALL wheb_exportar_xml_pck.salvarxmlbanco();
--			if	(instr(chr(13)||chr(10), ds_xml_p) = 1) then

--				ds_xml_w := substr(ds_xml_p,3,length(ds_xml_p));

			--insert into logxxxxx_Tasy values(sysdate, 'cetrentin', 981, 'testess' || ds_xml_aux);

			if (position(chr(10) in ds_xml_aux) in (1, 2)) then
				PERFORM set_config('wheb_exportar_xml_pck.ds_xml_w', substr(ds_xml_aux,position(chr(10) in ds_xml_aux) + 1,length(ds_xml_aux)), false);
			else
				PERFORM set_config('wheb_exportar_xml_pck.ds_xml_w', ds_xml_aux, false);
			end if;
		end;
	end;
	--Quando alterar este metodo, verificar se nao eh necessario alterar o metodo addXML, no outro metodo fica os valores do arquivo completo


$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE wheb_exportar_xml_pck.addxml (ds_xml_p text) FROM PUBLIC;
