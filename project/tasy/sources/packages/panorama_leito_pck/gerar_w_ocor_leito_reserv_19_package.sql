-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
	----------------------------- 19 ---------------------------------
	XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX*/
CREATE OR REPLACE PROCEDURE panorama_leito_pck.gerar_w_ocor_leito_reserv_19 ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, pIeConcluido text) AS $body$
DECLARE


	ds_alerta_w	varchar(10000)	:= null;
        dt_solicit_w varchar(4000)	:= null;
	dt_solicitacao_w		timestamp;
	ds_status_w				varchar(255);
	dt_alerta_w				varchar(255);
	dt_prevista_w			timestamp;
	ds_tipo_acomodacao_w	varchar(255);
	ds_setor_desejado_w		varchar(255);
	cd_unidade_desejada_w	varchar(255);

	
BEGIN

	select	max(dt_solicitacao),
			max(ie_status),
			max(dt_prevista),
			max(obter_desc_tipo_acomodacao(cd_tipo_acomod_desej)) ds_tipo_acomodacao,
			max(obter_ds_descricao_setor(cd_setor_desejado)) ds_setor_desejado,
			max(cd_unidade_basica||' '||cd_unidade_compl)
	into STRICT	dt_solicitacao_w,
			ds_status_w,
			dt_prevista_w,
			ds_tipo_acomodacao_w,
			ds_setor_desejado_w,
			cd_unidade_desejada_w
	from	gestao_vaga
	where	ie_status = 'R'
	and		nr_atendimento = nr_atendimento_P;

	if (dt_solicitacao_w IS NOT NULL AND dt_solicitacao_w::text <> '') then
        if (dt_prevista_w IS NOT NULL AND dt_prevista_w::text <> '') then
            dt_alerta_w := 'flagStart' || to_char(dt_prevista_w,'dd/mm/yyyy hh24:mi:ss') || 'flagEnd';
        end if;

        dt_solicit_w := 'flagStart' || to_char(dt_solicitacao_w,'dd/mm/yyyy hh24:mi:ss') || 'flagEnd';
        ds_alerta_w  := substr(dt_solicit_w||' ,'||'D_1408'||'S_' || ds_status_w || '_E' ||'<br>'||dt_alerta_w || ' ',1,4000);

		if (ds_tipo_acomodacao_w IS NOT NULL AND ds_tipo_acomodacao_w::text <> '') then
			ds_alerta_w := substr(ds_alerta_w || '#@795063#@' ||': '||ds_tipo_acomodacao_w,1,4000);
		end if;
		if (ds_setor_desejado_w IS NOT NULL AND ds_setor_desejado_w::text <> '') then
			ds_alerta_w := substr(ds_alerta_w || '<br>'|| '#@795066#@' ||': '||ds_setor_desejado_w,1,4000);
		end if;
		if ((trim(both cd_unidade_desejada_w) IS NOT NULL AND (trim(both cd_unidade_desejada_w))::text <> '')) then
			ds_alerta_w := substr(ds_alerta_w || '<br>'|| '#@795070#@' ||': '||cd_unidade_desejada_w,1,4000);
		end if;
	end if;

	if (ds_alerta_w IS NOT NULL AND ds_alerta_w::text <> '') then
		CALL panorama_leito_pck.insert_ocorrencia(nr_atendimento_p,
					19,
					'assets/icons/status-and-feedback/arrow-right-clock.svg',
					'assets/icons/status-and-feedback/arrow-right-clock.svg',
					311208, /* Leito reservado */
					967643,
					null,
					null,
					ds_alerta_w,
					14,
                    pIeConcluido);
	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE panorama_leito_pck.gerar_w_ocor_leito_reserv_19 ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, pIeConcluido text) FROM PUBLIC;
