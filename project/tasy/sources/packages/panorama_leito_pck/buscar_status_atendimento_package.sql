-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION panorama_leito_pck.buscar_status_atendimento (nr_seq_interno_p bigint) RETURNS bigint AS $body$
DECLARE

        c_status_atend CURSOR FOR
        SELECT  nr_atendimento,
                dt_entrada_unidade,
                cd_unidade,
                cd_unidade_basica,
                cd_unidade_compl,
                dt_entrada,
                nm_pessoa_fisica,
                cd_setor_atendimento,
                cd_pessoa_fisica,
                dt_nascimento,
                nr_prontuario,
                ie_status_unidade,
                ie_sexo,
                ds_convenio,
                ds_categoria,
                cd_paciente_reserva,
                nm_paciente_reserva,
                cd_convenio_reserva,
                nm_convenio_reserva,
                nm_usuario_reserva,
                nr_crm,
                nm_guerra,
                ie_classe_acomodacao,
                ie_sexo_paciente,
                ie_sexo_fixo,
                ds_status_unidade,
                ds_observacao,
                qt_dia_permanencia,
                ds_clinica,
                dt_inicio_higienizacao,
                dt_higienizacao,
                nr_seq_interno,
                dt_previsto_alta,
                dt_alta_medico,
                nm_usuario_higienizacao,
                nm_usuario_fim_higienizacao,
                nr_ramal,
                ie_temporario,
                ie_tipo_reserva,
                cd_tipo_acomodacao,
                ie_probabilidade_alta,
                ds_probabilidade,
                cd_psicologo,
                ds_ocupacao,
                nr_agrupamento,
                qt_peso_maximo,
                qt_altura_maxima,
                cd_convenio,
                qt_tempo_prev_higien,
                nr_seq_motivo_reserva,
                ie_acompanhante,
                ds_plano,
                nr_seq_apresent,
                qt_dia_perman_unid,
                ds_carater_int_sus,
                ie_radioterapia,
                nr_atend_alta,
                ie_radiacao,
                ie_interditado_radiacao,
                ds_tipo_acomodacao,
                cd_estabelecimento,
                nm_usuario_intern,
                nr_seq_perfil,
                ds_cor_perfil_pep,
                ds_perfil_pep,
                cd_motivo_alta_medica,
                cd_medico_resp,
                nr_doc_conv_principal,
                ie_reserva_pa,
                ie_necessita_isol_reserva,
                classif,
                ie_clinica,
                ds_unidade_atend,
                qt_dias_prev_interd,
                ie_permite_visita,
                cd_motivo_interdicao,
                dt_aguard_higienizacao,
                ds_motivo_pausa_leito,
                ie_boletim_inform,
                ie_leito_adapt,
                ie_leito_adaptado,
                ds_tipo_atendimento,
                nm_pac_reserva,
                dt_saida_temporaria,
                dt_retorno_saida_temporaria,
                dt_alta,
                ie_tipo_atendimento,
                nm_medico_resp_eup,
                cd_motivo_manutencao,
                nr_seq_motivo_perm
        FROM    ocupacao_unidade_v o
        WHERE   nr_seq_interno = nr_seq_interno_p
        ORDER BY o.nr_seq_apresent, o.cd_unidade;

        nr_status_w            		integer;
		cd_perfil_w					integer;
		cd_estabelecimento_w        integer;
		cd_exp_titulo_w             bigint;
		nr_seq_texto_titulo_w       bigint;
		ie_legenda_ap_w				varchar(1);
		ie_alta_medico_w			varchar(1);
		ie_alta_medico_prioridade_w	varchar(1);
		current_setting('panorama_leito_pck.nm_usuario_w')::usuario.nm_usuario%type				varchar(15);
		ds_imagem_hover_w			varchar(100);
		ds_imagem_padrao_w			varchar(100);
        ds_alerta_w             	varchar(10000) := NULL;
        ie_sexo_w               	ocupacao_unidade_v.ie_sexo%TYPE;
        ie_acompanhante_w       	ocupacao_unidade_v.ie_acompanhante%TYPE;
        ie_paciente_isolado_w   	wocupacao_leito.ie_paciente_isolado%TYPE;
		dt_previsto_alta_w			ocupacao_unidade_v.dt_previsto_alta%TYPE;
        jp_locale_w                 varchar(15);

BEGIN
		PERFORM set_config('panorama_leito_pck.nm_usuario_w', wheb_usuario_pck.get_nm_usuario, false);
		cd_perfil_w  		 := wheb_usuario_pck.get_cd_perfil;
		cd_estabelecimento_w 	 := wheb_usuario_pck.get_cd_estabelecimento;
		obter_param_usuario(44, 119, cd_perfil_w, current_setting('panorama_leito_pck.nm_usuario_w')::usuario.nm_usuario%type, cd_estabelecimento_w, ie_alta_medico_w);
		obter_param_usuario(44, 148, cd_perfil_w, current_setting('panorama_leito_pck.nm_usuario_w')::usuario.nm_usuario%type, cd_estabelecimento_w, ie_legenda_ap_w);
		obter_param_usuario(44, 213, cd_perfil_w, current_setting('panorama_leito_pck.nm_usuario_w')::usuario.nm_usuario%type, cd_estabelecimento_w, ie_alta_medico_prioridade_w);
        FOR r_status_atend IN c_status_atend LOOP

            IF (coalesce(r_status_atend.cd_pessoa_fisica::text, '') = '') THEN
              ie_sexo_w := r_status_atend.ie_sexo_paciente;
            ELSE
              ie_sexo_w := r_status_atend.ie_sexo;
            END IF;
            -- modifica por lpfreitas 17/05/2021
            SELECT obtain_user_locale(current_setting('panorama_leito_pck.nm_usuario_w')::usuario.nm_usuario%type)
              INTO STRICT jp_locale_w 
;


            IF (jp_locale_w = 'ja_JP') THEN
                dt_previsto_alta_w := r_status_atend.dt_previsto_alta;
            ELSE
                IF (ie_legenda_ap_w = 'S') THEN
                    dt_previsto_alta_w := r_status_atend.dt_previsto_alta;
                ELSE
                    dt_previsto_alta_w := NULL;
                END IF;
            END IF;
			--end 
            SELECT MAX(substr(obter_status_isolamento_ocup(cd_estabelecimento_w, r_status_atend.nr_atendimento, r_status_atend.ie_acompanhante, current_setting('panorama_leito_pck.nm_usuario_w')::usuario.nm_usuario%type), 1, 1))
            INTO STRICT   ie_paciente_isolado_w
;


            SELECT coalesce(MAX((obter_imagem_leito_ocup_hosp(obter_status_leito_ocupacao(ie_paciente_isolado_w,
                                                                                          substr(obter_classif_etaria(cd_estabelecimento_w, r_status_atend.cd_pessoa_fisica, 'C'), 1, 3),
                                                                                          ie_sexo_w,
                                                                                          r_status_atend.ie_status_unidade,
                                                                                          r_status_atend.ie_temporario,
                                                                                          r_status_atend.dt_alta_medico,
                                                                                          ie_alta_medico_w,
                                                                                          r_status_atend.nr_atend_alta,
                                                                                          r_status_atend.ie_radiacao,
                                                                                          r_status_atend.ie_interditado_radiacao,
                                                                                          dt_previsto_alta_w,
                                                                                          obter_se_alta_tesouraria(r_status_atend.cd_setor_atendimento, r_status_atend.cd_unidade_basica, r_status_atend.cd_unidade_compl),
                                                                                          NULL,
                                                                                          r_status_atend.nr_seq_interno,
                                                                                          r_status_atend.dt_saida_temporaria,
                                                                                          r_status_atend.dt_retorno_saida_temporaria)))::numeric ), 0)
            INTO STRICT    current_setting('panorama_leito_pck.nr_status_java_w')::integer
;

            RETURN current_setting('panorama_leito_pck.nr_status_java_w')::integer;

        END LOOP;

        RETURN 0;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION panorama_leito_pck.buscar_status_atendimento (nr_seq_interno_p bigint) FROM PUBLIC;
