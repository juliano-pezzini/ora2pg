-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE panorama_leito_pck.gerar_w_pan_ocorrencia ( cd_estabelecimento_p bigint, nr_seq_interno_p bigint, nm_usuario_p text) AS $body$
DECLARE

        nr_atendimento_w bigint;
	
BEGIN

	/*gerar_w_ocor_alergia_0(cd_pessoa_fisica_p	varchar2);
	Ja tratado no paciente
	*/
	if (current_setting('panorama_leito_pck.ie_gerar_log')::varchar(1) = 'S') then
		insert into w_panorama_etapa(ie_panorama_conc,
			ie_etapa,
			dt_inicio_etapa,
			dt_fim_etapa)
		values ('N',
			'OCO',
			clock_timestamp(),
			null);
		commit;
	end if;

	nr_atendimento_w := null;
	if (nr_seq_interno_p IS NOT NULL AND nr_seq_interno_p::text <> '') then
		select	a.nr_atendimento
		into STRICT	nr_atendimento_w
		from	unidade_atendimento a
		where	a.nr_seq_interno	= nr_seq_interno_p;

		if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
			delete from w_pan_ocorrencia where nr_atendimento = nr_atendimento_w and ie_concluido = 'S';

			delete
			from   w_pan_ocorrencia a
			where  a.nr_atendimento in ( SELECT b.nr_atendimento
					             from   atendimento_paciente b
						     where  b.nr_atendimento_mae = nr_atendimento_w)
			and    a.ie_concluido = 'S';

			commit;

			CALL panorama_leito_pck.inserepanocorrencia(nr_seq_interno_p,
                                cd_estabelecimento_p,
                                nm_usuario_p,
                                'S');
		end if;
	else
        CALL panorama_leito_pck.inserepanocorrencia(nr_seq_interno_p,
                            cd_estabelecimento_p,
                            nm_usuario_p,
                            'N');
    end if;

	if (current_setting('panorama_leito_pck.ie_gerar_log')::varchar(1) = 'S') then
		update	w_panorama_etapa
		set		dt_fim_etapa = clock_timestamp()
		where	ie_etapa = 'OCO'
		and		coalesce(dt_fim_etapa::text, '') = ''
		and		coalesce(ie_icone::text, '') = '';

		commit;
	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE panorama_leito_pck.gerar_w_pan_ocorrencia ( cd_estabelecimento_p bigint, nr_seq_interno_p bigint, nm_usuario_p text) FROM PUBLIC;
