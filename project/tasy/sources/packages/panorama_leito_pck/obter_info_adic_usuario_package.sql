-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION panorama_leito_pck.obter_info_adic_usuario (cd_unidade_basica_p text, cd_unidade_compl_p text, cd_perfil_p bigint, cd_pessoa_fisica_p text) RETURNS SETOF T_INFO_ADIC AS $body$
DECLARE


	c_pan_config CURSOR(ie_status_unidade_pc text) FOR
	SELECT	a.nr_sequencia
	from	pan_configuracao a
	where (a.cd_perfil = cd_perfil_p or coalesce(a.cd_perfil::text, '') = '')
	and (obter_se_especialidade_medico(cd_pessoa_fisica_p,a.cd_especialidade_medica) = 'S' or coalesce(a.cd_especialidade_medica::text, '') = '')
	and (a.ie_status_unidade = ie_status_unidade_pc or coalesce(a.ie_status_unidade::text, '') = '');

	c_pan_config_campo CURSOR(nr_seq_config_pc	bigint) FOR
	SELECT	ie_campo_panorama, /* Dominio 8599 */
			a.nr_seq_apresentacao nr_seq_apres
	from	pan_configuracao_campos a
	where	a.nr_seq_configuracao	= nr_seq_config_pc
	and		(nr_seq_config_pc IS NOT NULL AND nr_seq_config_pc::text <> '');

	c_info_adic CURSOR FOR
	SELECT	a.cd_unidade_basica,
			a.cd_unidade_compl,
			a.cd_exp_label,
			a.nr_seq_texto_label,
			a.ds_info_adic,
			a.nr_info_adic,
			a.dt_info_adic,
			a.nr_seq_apres,
			a.ie_concluido,
			a.ds_mascara,
			a.ie_campo_panorama
	from	w_pan_info_adicional a
	where	a.cd_unidade_basica	= cd_unidade_basica_p
	and		a.cd_unidade_compl	= cd_unidade_compl_p;

	nr_seq_apres_w	bigint;
	ie_exibe_inf_adic_w	varchar(1);
	ie_status_unidade_w	varchar(10);
	ie_passou_regra_w	varchar(1);

	linha_w			t_info_adic_row;

	
BEGIN

	select	max(ie_status_unidade)
	into STRICT	ie_status_unidade_w
	from	unidade_atendimento a
	where	a.cd_unidade_basica	= cd_unidade_basica_p
	and		a.cd_unidade_compl	= cd_unidade_compl_p;

	for r_c_info_adic in c_info_adic loop
		ie_exibe_inf_adic_w	:= 'S';
		ie_passou_regra_w	:= 'N';
		nr_seq_apres_w	:= null;
		/* Verificar se ha alguma regra que se encaixe para o usuario */

		for r_c_pan_config in c_pan_config(ie_status_unidade_w) loop
			if (ie_passou_regra_w = 'N') then
				ie_passou_regra_w	:= 'S';
				ie_exibe_inf_adic_w	:= 'N';
			end if;
			/* Verificar se exibe ou nao o campo e a sequencia de apresentacao */

			for r_c_pan_config_campo in c_pan_config_campo(r_c_pan_config.nr_sequencia) loop
				if (r_c_pan_config_campo.ie_campo_panorama = r_c_info_adic.ie_campo_panorama) then
					ie_exibe_inf_adic_w	:= 'S';
					nr_seq_apres_w	:= r_c_pan_config_campo.nr_seq_apres;
				end if;
			end loop;
		end loop;

		if (ie_exibe_inf_adic_w = 'S') and
			((r_c_info_adic.nr_seq_apres IS NOT NULL AND r_c_info_adic.nr_seq_apres::text <> '') or (ie_passou_regra_w = 'S'))then
			linha_w.cd_unidade_basica		:= r_c_info_adic.cd_unidade_basica;
			linha_w.cd_unidade_compl		:= r_c_info_adic.cd_unidade_compl;
			linha_w.cd_exp_label		:= r_c_info_adic.cd_exp_label;
			linha_w.nr_seq_texto_label		:= r_c_info_adic.nr_seq_texto_label;
			linha_w.ds_info_adic		:= r_c_info_adic.ds_info_adic;
			linha_w.nr_info_adic		:= r_c_info_adic.nr_info_adic;
			linha_w.dt_info_adic		:= r_c_info_adic.dt_info_adic;
			linha_w.nr_seq_apres		:= coalesce(nr_seq_apres_w,r_c_info_adic.nr_seq_apres);
			linha_w.ie_concluido		:= r_c_info_adic.ie_concluido;
			linha_w.ds_mascara			:= r_c_info_adic.ds_mascara;
			linha_w.ie_campo_panorama	:= r_c_info_adic.ie_campo_panorama;
			RETURN NEXT linha_w;
		end if;
	end loop;

	end;

	/*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
	-----------------------------  53 Patient Away from be---------------------------------
	XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX*/
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION panorama_leito_pck.obter_info_adic_usuario (cd_unidade_basica_p text, cd_unidade_compl_p text, cd_perfil_p bigint, cd_pessoa_fisica_p text) FROM PUBLIC;
