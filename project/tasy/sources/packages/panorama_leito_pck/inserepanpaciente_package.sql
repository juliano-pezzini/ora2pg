-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE panorama_leito_pck.inserepanpaciente (pIeConcluido text, nr_seq_interno_p bigint) AS $body$
DECLARE

	ie_pendencia_adep_w		w_pan_paciente.ie_pendencia_adep%type;
    jp_locale_w                 varchar(15);
    current_setting('panorama_leito_pck.nm_usuario_w')::usuario.nm_usuario%type				varchar(15);

	cd_pessoa_fisica_rn_w		atendimento_paciente.cd_pessoa_fisica%type;
	dt_nascimento_rn_w		pessoa_fisica.dt_nascimento%type;
	dt_entrada_unidade_atend_w	atend_paciente_unidade.dt_entrada_unidade%type;
	cd_setor_unidade_atend_w	atend_paciente_unidade.cd_setor_atendimento%type;
	ds_departamento_w		departamento_medico.ds_departamento%type;
	ds_short_name_departamento_w	departamento_medico.ds_short_name%type;
	cd_departamento_medico_w	departamento_medico.cd_departamento%type;
	nr_case_w			episodio_paciente.nr_episodio%type;
	ds_classif_esp_paciente_w	classif_especial_paciente.ds_classificacao%type;


BEGIN
     PERFORM set_config('panorama_leito_pck.nm_usuario_w', wheb_usuario_pck.get_nm_usuario, false);
        for	r_c_paciente in current_setting('panorama_leito_pck.c_paciente')::CURSOR(nr_seq_interno_p(nr_seq_interno_p) loop

			select  CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
			into STRICT    ie_pendencia_adep_w
			from    w_pan_ocorrencia
			where   nr_atendimento = r_c_paciente.nr_atendimento
			and     ie_icone = 1;

            PERFORM set_config('panorama_leito_pck.nr_status_java_w', panorama_leito_pck.buscar_status_atendimento(r_c_paciente.nr_seq_interno), false);

            SELECT obtain_user_locale(current_setting('panorama_leito_pck.nm_usuario_w')::usuario.nm_usuario%type)
              INTO STRICT jp_locale_w 
;

             IF (jp_locale_w <> 'ja_JP') THEN
                  if (current_setting('panorama_leito_pck.nr_status_java_w')::integer = 278) then
                      PERFORM set_config('panorama_leito_pck.nr_status_java_w', obter_status_alta_panora(r_c_paciente.nr_atendimento, obter_perfil_ativo()), false);
                  end if;
             END IF;
	
		select	max(cd_setor_atendimento),
			max(dt_entrada_unidade)
		into STRICT	cd_setor_unidade_atend_w,
			dt_entrada_unidade_atend_w
		from (SELECT	a.cd_setor_atendimento,
				a.dt_entrada_unidade,
				row_number() over (order by coalesce(a.dt_saida_unidade, a.dt_entrada_unidade + 9999) desc, a.nr_seq_interno desc) rnum
			FROM	atend_paciente_unidade a
			WHERE	a.nr_atendimento = r_c_paciente.nr_atendimento) alias5
		where	rnum = 1;
		
		SELECT	MAX(z.cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_rn_w
		FROM	atendimento_paciente z
		WHERE	z.nr_atendimento_mae = r_c_paciente.nr_atendimento;
		
		SELECT max(p.dt_nascimento)
		into STRICT	dt_nascimento_rn_w
		FROM pessoa_fisica p
		WHERE p.cd_pessoa_fisica = cd_pessoa_fisica_rn_w;
		
		cd_departamento_medico_w := obter_departamento_data(r_c_paciente.nr_atendimento);
		
		SELECT	max(substr(DS_DEPARTAMENTO,1,100)),
			max(DS_SHORT_NAME)
		into STRICT	ds_departamento_w,
			ds_short_name_departamento_w
		FROM	DEPARTAMENTO_MEDICO
		WHERE	cd_departamento = cd_departamento_medico_w;
		
		SELECT	max(coalesce(b.nr_episodio, to_char(b.nr_sequencia)))
		into STRICT	nr_case_w
		FROM	atendimento_paciente ap,
			episodio_paciente b
		WHERE	b.nr_sequencia = ap.nr_seq_episodio
		AND	ap.nr_atendimento = r_c_paciente.nr_atendimento;

		SELECT	max(cep.ds_classificacao)
		into STRICT	ds_classif_esp_paciente_w
		FROM	CLASSIF_ESPECIAL_PACIENTE cep
		WHERE	cep.nr_sequencia = r_c_paciente.nr_seq_classif_esp;
		
            insert into w_pan_paciente(nr_atendimento,
                    cd_pessoa_paciente,
                    cd_unidade_basica,
                    cd_unidade_compl,
                    ds_cor_risco,
                    nm_paciente,
                    cd_medico,
                    nm_medico,
                    ie_vip,
                    ie_alergia,
                    ie_sexo,
                    cd_exp_alergia,
                    nr_seq_texto_alergia,
                    cd_exp_acao_alergia,
                    nr_seq_texto_acao_alergia,
                    ds_alergias,
                    cd_exp_sexo,
                    ds_sexo,
                    ds_classif_paciente,
                    ds_classif_risco,
                    ie_exibe_classif,
                    ds_vip,
                    ie_classif_paciente,
                    nr_seq_interno,
                    ie_concluido,
                    cd_depart_atend,
                    dt_nascimento,
                    ds_idade,
                    nr_seq_texto_nasc,
                    nr_encounter_status,
					dt_atualizacao,
					ie_pendencia_adep,
			cd_pessoa_fisica_rn,
			dt_nascimento_rn,
			dt_entrada,
			cd_setor_atendimento,
			ds_departament,
			ds_short_departament,
			cd_departament,
			nr_case,
			dt_obito,
			ds_classif_esp_paciente)
            values (r_c_paciente.nr_atendimento,
                    r_c_paciente.cd_pessoa_paciente,
                    r_c_paciente.cd_unidade_basica,
                    r_c_paciente.cd_unidade_compl,
                    r_c_paciente.ds_cor_risco,
                    r_c_paciente.nm_paciente,
                    r_c_paciente.cd_medico,
                    r_c_paciente.nm_medico,
                    r_c_paciente.ie_vip,
                    r_c_paciente.ie_alergia,
                    r_c_paciente.ie_sexo,
                    r_c_paciente.cd_exp_alergia,
                    r_c_paciente.nr_seq_texto_alergia,
                    r_c_paciente.cd_exp_acao_alergia,
                    r_c_paciente.nr_seq_texto_acao_alergia,
                    r_c_paciente.ds_alergias,
                    r_c_paciente.cd_exp_sexo,
                    r_c_paciente.ds_sexo,
                    r_c_paciente.ds_classif_paciente,
                    r_c_paciente.ds_classif_risco,
                    r_c_paciente.ie_exibe_classif,
                    r_c_paciente.ds_vip,
                    r_c_paciente.ie_classif_paciente,
                    r_c_paciente.nr_seq_interno,
                    pIeConcluido,
                    r_c_paciente.cd_depart_atend,
                    r_c_paciente.dt_nascimento,
                    r_c_paciente.ds_idade,
                    r_c_paciente.nr_seq_texto_nasc,
                    current_setting('panorama_leito_pck.nr_status_java_w')::integer,
					clock_timestamp(),
					ie_pendencia_adep_w,
			cd_pessoa_fisica_rn_w,
			dt_nascimento_rn_w,
			dt_entrada_unidade_atend_w,
			cd_setor_unidade_atend_w,
			ds_departamento_w,
			ds_short_name_departamento_w,
			cd_departamento_medico_w,
			nr_case_w,
			r_c_paciente.dt_obito,
			ds_classif_esp_paciente_w
		);
        end loop;

        commit;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE panorama_leito_pck.inserepanpaciente (pIeConcluido text, nr_seq_interno_p bigint) FROM PUBLIC;
