-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE fis_invoice_cancel_integ_mx.generate_invoice_logs ( nr_seq_nota_p nota_fiscal.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_transmissao_p INOUT nfe_transmissao.nr_sequencia%type, nr_seq_log_integracao_p INOUT text, ie_tie_p boolean) AS $body$
DECLARE

	
		nr_seq_transmissao_w	nfe_transmissao.nr_sequencia%type;
		nr_seq_log_integracao_w	varchar(100);
	
BEGIN
	
		GERAR_TRANSMISSAO_NF(	nm_usuario_p			=>	nm_usuario_p,
								ie_tipo_transmissao_p	=> 2,
								ie_tipo_nota_p			=> 'NFSE',				
								nr_seq_transmissao_p	=> nr_seq_transmissao_w,
								nr_seq_lote_p			=> 0);
		
		if (nr_seq_transmissao_w <= 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1199230);
		end if;
		
		CALL GRAVAR_NF_TRANSMISSAO(	nr_seq_transmissao_p    => nr_seq_transmissao_w,
                                nr_seq_nota_fiscal_p    => nr_seq_nota_p,
                                nm_usuario_p            => nm_usuario_p);
		
		if (ie_tie_p) then
			GRAVAR_LOG_INTEGRACAO(	nm_usuario_p			=> nm_usuario_p,
									nr_seq_evento_p			=> '168',
									ds_parametros_p			=> null,
									ie_executa_commit_p		=> 'N',	
									ie_exportar_xml_p		=> 'S',
									nr_seq_log_integracao_p	=> nr_seq_log_integracao_w,
									cd_estabelecimento_p 	=> cd_estabelecimento_p,
									cd_setor_atendimento_p	=> obter_setor_usuario(nm_usuario_p));
			
			if (nr_seq_log_integracao_w <= 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1199230);
			end if;

		end if;

		
		nr_seq_transmissao_p := nr_seq_transmissao_w;
		nr_seq_log_integracao_p := nr_seq_log_integracao_w;
		
		commit;
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_invoice_cancel_integ_mx.generate_invoice_logs ( nr_seq_nota_p nota_fiscal.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_transmissao_p INOUT nfe_transmissao.nr_sequencia%type, nr_seq_log_integracao_p INOUT text, ie_tie_p boolean) FROM PUBLIC;
