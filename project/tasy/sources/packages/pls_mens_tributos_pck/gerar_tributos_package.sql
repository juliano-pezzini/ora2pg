-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_mens_tributos_pck.gerar_tributos ( nr_seq_mensalidade_p pls_mensalidade.nr_sequencia%type, dt_referencia_p pls_mensalidade.dt_referencia%type, cd_cgc_p pls_contrato_pagador.cd_cgc%type, cd_pessoa_fisica_p pls_contrato_pagador.cd_pessoa_fisica%type, nr_seq_contrato_p pls_contrato_pagador.nr_seq_contrato%type, nr_seq_intercambio_p pls_contrato_pagador.nr_seq_pagador_intercambio%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ie_reteu_w			varchar(255)	:= 'N';
ie_acumulativo_w		varchar(10);
ie_saldo_tit_rec_w		varchar(2)	:= 'N';
ie_tipo_contrato_w		varchar(2);
ie_tipo_pessoa_pagador_w	varchar(2);
vl_item_base_w			double precision	:= 0;
vl_minimo_tributo_w		double precision;
vl_tributo_w			double precision;
vl_tributo_ww			double precision;
vl_trib_nao_retido_w		double precision;
vl_base_nao_retido_w		double precision;
vl_trib_adic_w			double precision;
vl_base_adic_w			double precision;
vl_soma_trib_nao_retido_w	double precision;
vl_soma_base_nao_retido_w	double precision;
vl_soma_trib_adic_w		double precision;
vl_soma_base_adic_w		double precision;
vl_minimo_base_w		double precision;
vl_teto_base_w			double precision;
vl_item_ww			double precision;
vl_desc_dependente_w		double precision;
vl_trib_anterior_w		double precision;
vl_total_base_w			double precision;
vl_reducao_w			double precision;
vl_item_base_corpo_w		double precision;
vl_tributo_corpo_w		double precision;
vl_proporcional_base_w		double precision;
vl_base_aux_w			double precision;
vl_itens_mens_w			double precision;
nr_seq_regra_w			bigint;
qt_regra_item_w			integer;
nr_seq_mens_trib_aux_w		bigint;
pr_imposto_w			double precision;
vl_item_base_aux_w		double precision	:= 0;
vl_base_ared_w			double precision;
vl_trib_ared_w			double precision;
ie_origem_titulo_w		smallint;
vl_total_tributo_w		double precision := 0;
vl_arredondamento_w		double precision;
nr_seq_regra_irpf_w		regra_calculo_irpf.nr_sequencia%type;
nr_seq_tipo_lanc_w		pls_mensalidade_seg_item.nr_seq_tipo_lanc%type;
vl_item_w			pls_mensalidade_seg_item.vl_item%type;
pr_desc_base_w			regra_calculo_imposto.pr_desc_base%type;
vl_reducao_ww			pls_mensalidade_trib.vl_reducao_base%type;
ie_retencao_w			regra_calculo_imposto.ie_retencao%type;
vl_trib_adic_ww			double precision;
qt_benef_mens_w			bigint;
vl_adicional_rateio_w		double precision;
vl_diferenca_w			double precision;
vl_trib_adic_rateio_w		double precision;
vl_trib_adic_base_rateio_w	double precision;
vl_diferenca_ww			double precision;
vl_adic_base_rateio_w		double precision;
vl_total_arredondado_w		double precision;
vl_total_tributo_ww		double precision;
nr_seq_mens_trib_w		pls_mensalidade_trib.nr_sequencia%type;
ie_tipo_tributacao_w		pessoa_juridica.ie_tipo_tributacao%type := null;
vl_base_calculo_total_w		pls_mensalidade_trib.vl_base_calculo%type;
vl_reducao_base_total_w		pls_mensalidade_trib.vl_reducao_base%type;
vl_reducao_base_correto_w	pls_mensalidade_trib.vl_reducao_base%type;

cd_darf_w			regra_calculo_imposto.cd_darf%type;

C01 CURSOR FOR
	SELECT	cd_tributo,
		ie_tipo_tributo,
		coalesce(ie_corpo_item, 'C') ie_corpo_item,
		ie_super_simples
	from	tributo
	where	ie_situacao	= 'A'
	and	((ie_pf_pj = 'A') or (ie_pf_pj = ie_tipo_pessoa_pagador_w))
	and	((cd_estabelecimento = cd_estabelecimento_p) or (coalesce(cd_estabelecimento::text, '') = ''))
	and	((coalesce(ie_tipo_tributacao_w, 'X') <> '0') or (coalesce(ie_super_simples, 'S') = 'S'))
	order by
		coalesce(cd_estabelecimento, 0),
		cd_tributo;

C02 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_item,
		a.ie_tipo_item,
		a.nr_seq_tipo_lanc,
		a.vl_item,
		a.vl_ato_cooperado,
		a.vl_ato_auxiliar,
		a.vl_ato_nao_cooperado,
		b.nr_seq_segurado
	from	pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b
	where	b.nr_sequencia		= a.nr_seq_mensalidade_seg
	and	b.nr_seq_mensalidade	= nr_seq_mensalidade_p;

C03 CURSOR(	nr_seq_mensalidade_pc	pls_mensalidade.nr_sequencia%type,
		cd_tributo_pc		tributo.cd_tributo%type) FOR
	SELECT	vl_base_calculo,
		tx_tributo
	from	pls_mensalidade_trib a
	where	a.nr_seq_mensalidade	= nr_seq_mensalidade_pc
	and	a.cd_tributo		= cd_tributo_pc
	and	a.vl_tributo		> 0;

C04 CURSOR(	nr_seq_mensalidade_pc	pls_mensalidade.nr_sequencia%type,
		cd_tributo_pc		tributo.cd_tributo%type) FOR
	SELECT	nr_seq_item_mens
	from	pls_mensalidade_trib
	where	vl_trib_adic <> 0
	and	nr_seq_mensalidade = nr_seq_mensalidade_pc
	and	cd_tributo = cd_tributo_pc;

C05 CURSOR(	nr_seq_mensalidade_pc	pls_mensalidade.nr_sequencia%type,
		cd_tributo_pc		tributo.cd_tributo%type) FOR
	SELECT	nr_sequencia nr_seq_mensalidade_trib
	from	pls_mensalidade_trib
	where	nr_seq_mensalidade = nr_seq_mensalidade_pc
	and	cd_tributo = cd_tributo_pc
	and	vl_reducao_base <> 0
	and	vl_base_calculo <> 0;
	
BEGIN

if (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	ie_tipo_pessoa_pagador_w	:= 'PJ';
	
	select	max(ie_tipo_tributacao)
	into STRICT	ie_tipo_tributacao_w
	from	pessoa_juridica
	where	cd_cgc	= cd_cgc_p;
else
	ie_tipo_pessoa_pagador_w	:= 'PF';
end if;

if (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then
	ie_tipo_contrato_w	:= 'CI';
else
	ie_tipo_contrato_w	:= 'CO';
end if;

ie_origem_titulo_w	:= pls_mensalidade_util_pck.get_origem_titulo;

for r_c01_w in C01 loop
	begin
	vl_total_tributo_w 	:= 0;
	pr_desc_base_w		:= 0;

	select	count(1)
	into STRICT	qt_regra_item_w
	
	where	exists (SELECT	1
			from	pls_regra_base_trib_mens
			where	cd_tributo = r_c01_w.cd_tributo);
	
	ie_reteu_w	:= 'N';

	if (r_c01_w.ie_corpo_item = 'C') and (qt_regra_item_w > 0) then
		select	sum(a.vl_item)
		into STRICT	vl_itens_mens_w
		from	pls_mensalidade_seg_item	a,
			pls_mensalidade_segurado	b
		where	b.nr_sequencia		= a.nr_seq_mensalidade_seg
		and	b.nr_seq_mensalidade	= nr_seq_mensalidade_p		
		and exists	(	SELECT	1
					from	pls_regra_base_trib_mens x
					where	x.cd_tributo	= r_c01_w.cd_tributo
					and	((x.ie_tipo_item_mens = a.ie_tipo_item)	or (coalesce(x.ie_tipo_item_mens::text, '') = ''))
					and	x.ie_incide_base = 'S')
		and not exists (	select	1
					from	pls_regra_base_trib_mens x
					where	x.cd_tributo	= r_c01_w.cd_tributo
					and	((x.ie_tipo_item_mens = a.ie_tipo_item)	or (coalesce(x.ie_tipo_item_mens::text, '') = ''))
					and	coalesce(x.ie_incide_base,'N') = 'N');
		
		pls_obter_base_calc_mens(nr_seq_mensalidade_p, null, r_c01_w.cd_tributo, r_c01_w.ie_tipo_tributo, vl_item_base_corpo_w);
	else
		vl_item_base_corpo_w	:= 0;
	end if;
	
	vl_proporcional_base_w	:= 1;
	
	if (vl_item_base_corpo_w <> 0) then
		obter_dados_trib_tit_rec(r_c01_w.cd_tributo,
					cd_estabelecimento_p,
					null,
					dt_referencia_p,
					'N',
					pr_imposto_w,
					vl_minimo_base_w,
					vl_minimo_tributo_w,
					ie_acumulativo_w,
					vl_teto_base_w,
					vl_desc_dependente_w,
					cd_pessoa_fisica_p,
					cd_cgc_p,
					ie_tipo_contrato_w,
					ie_origem_titulo_w,
					0,
					nr_seq_regra_w,
					cd_darf_w);
		
		select	coalesce(max(pr_desc_base),0)
		into STRICT	pr_desc_base_w
		from	regra_calculo_imposto
		where	nr_sequencia = nr_seq_regra_w;
		
		if (vl_item_base_corpo_w > 0) and (pr_desc_base_w > 0) then
			vl_item_base_corpo_w := vl_item_base_corpo_w - ((vl_item_base_corpo_w*pr_desc_base_w)/100);
		end if;			
		
		if (pr_imposto_w > 0) then
			begin
			select	coalesce(sum(vl_trib_nao_retido),0),
				coalesce(sum(vl_base_nao_retido),0),
				coalesce(sum(vl_trib_adic),0),
				coalesce(sum(vl_base_adic),0),
				coalesce(sum(vl_tributo),0),
				coalesce(sum(vl_base_calculo),0),
				coalesce(sum(vl_reducao_base),0)
			into STRICT	vl_soma_trib_nao_retido_w,
				vl_soma_base_nao_retido_w,
				vl_soma_trib_adic_w,
				vl_soma_base_adic_w,
				vl_trib_anterior_w,
				vl_total_base_w,
				vl_reducao_w
			from (	SELECT	coalesce(a.vl_trib_nao_retido,0) vl_trib_nao_retido,
					coalesce(a.vl_base_nao_retido,0) vl_base_nao_retido,
					coalesce(a.vl_trib_adic,0) vl_trib_adic,
					coalesce(a.vl_base_adic,0) vl_base_adic,
					coalesce(a.vl_tributo,0) vl_tributo,
					coalesce(a.vl_base_calculo,0) vl_base_calculo,
					coalesce(a.vl_reducao_base,0) vl_reducao_base
				from	pls_mensalidade_trib  a,
					pls_mensalidade       b,
					pls_contrato_pagador  c
				where	c.nr_sequencia  = b.nr_seq_pagador
				and	b.nr_sequencia  = a.nr_seq_mensalidade
				and	b.nr_sequencia	<> nr_seq_mensalidade_p
				and	coalesce(b.ie_cancelamento::text, '') = ''
				and	a.cd_tributo	= r_c01_w.cd_tributo
				and	c.cd_pessoa_fisica  = cd_pessoa_fisica_p
				and	(c.cd_pessoa_fisica IS NOT NULL AND c.cd_pessoa_fisica::text <> '')
				and	b.dt_referencia	= dt_referencia_p
				
union all

				SELECT	coalesce(a.vl_trib_nao_retido,0),
					coalesce(a.vl_base_nao_retido,0),
					coalesce(a.vl_trib_adic,0),
					coalesce(a.vl_base_adic,0),
					coalesce(a.vl_tributo,0),
					coalesce(a.vl_base_calculo,0),
					coalesce(a.vl_reducao_base,0)
				from	pls_mensalidade_trib  a,
					pls_mensalidade       b,
					pls_contrato_pagador  c
				where	c.nr_sequencia  = b.nr_seq_pagador
				and	b.nr_sequencia  = a.nr_seq_mensalidade
				and	b.nr_sequencia	<> nr_seq_mensalidade_p
				and	coalesce(b.ie_cancelamento::text, '') = ''
				and	a.cd_tributo	= r_c01_w.cd_tributo
				and	c.cd_cgc  = cd_cgc_p 
				and	(c.cd_cgc IS NOT NULL AND c.cd_cgc::text <> '')
				and	b.dt_referencia	= dt_referencia_p) alias33;
			exception
			when others then
				vl_soma_trib_nao_retido_w	:= 0;
				vl_soma_base_nao_retido_w	:= 0;
				vl_soma_trib_adic_w		:= 0;
				vl_soma_base_adic_w		:= 0;
				vl_trib_anterior_w		:= 0;
				vl_total_base_w			:= 0;
				vl_reducao_w			:= 0;
			end;
			
			obter_valores_tributo(	ie_acumulativo_w,
						pr_imposto_w,
						vl_minimo_base_w,
						vl_minimo_tributo_w,
						vl_soma_trib_nao_retido_w,
						0,--vl_soma_trib_adic_w,
						vl_soma_base_nao_retido_w,
						vl_soma_base_adic_w,
						vl_item_base_corpo_w,
						vl_tributo_corpo_w,
						vl_trib_nao_retido_w,
						vl_trib_adic_w,
						vl_base_nao_retido_w,
						vl_base_adic_w,
						vl_teto_base_w,
						vl_trib_anterior_w,
						'N',
						vl_total_base_w,
						vl_reducao_w,
						vl_desc_dependente_w,
						0,
						0,
						0,
						null,
						0,
						clock_timestamp(),
						nr_seq_regra_irpf_w);
			
			if (vl_tributo_corpo_w > 0) and (vl_item_base_corpo_w >= vl_itens_mens_w)then
				ie_reteu_w	:= 'S';
			elsif (vl_tributo_corpo_w > 0) then
				vl_proporcional_base_w	:= dividir_sem_round(vl_item_base_corpo_w, vl_itens_mens_w);
				ie_reteu_w	:= 'S';
			else
				vl_proporcional_base_w	:= 1;
			end if;
		end if;
	end if;
	
	vl_base_aux_w	:= 0;
	qt_benef_mens_w := 0;
	
	for r_c02_w in C02 loop
		begin
		if (qt_regra_item_w > 0) then
			CALL pls_store_data_mens_pck.set_tributo_item(r_c02_w.ie_tipo_item, r_c02_w.nr_seq_tipo_lanc, r_c02_w.vl_item,
								r_c02_w.vl_ato_cooperado, r_c02_w.vl_ato_auxiliar, r_c02_w.vl_ato_nao_cooperado, r_c02_w.nr_seq_segurado);
			pls_obter_base_calc_mens(null, r_c02_w.nr_seq_item, r_c01_w.cd_tributo, r_c01_w.ie_tipo_tributo, vl_item_base_w);
			CALL pls_store_data_mens_pck.clear_tributo_item();
		else
			vl_item_base_w	:= 0;
		end if;
		
		if (vl_item_base_w <> 0) then
			obter_dados_trib_tit_rec(r_c01_w.cd_tributo,
					cd_estabelecimento_p,
					null,
					dt_referencia_p,
					'N',
					pr_imposto_w,
					vl_minimo_base_w,
					vl_minimo_tributo_w,
					ie_acumulativo_w,
					vl_teto_base_w,
					vl_desc_dependente_w,
					cd_pessoa_fisica_p,
					cd_cgc_p,
					ie_tipo_contrato_w,
					ie_origem_titulo_w,
					0,
					nr_seq_regra_w,
					cd_darf_w);
			
			if (ie_reteu_w = 'S') then
				vl_minimo_tributo_w	:= 0;
				vl_minimo_base_w	:= 0;
			else
				if (vl_proporcional_base_w = 1) then
					vl_minimo_tributo_w	:= 9999999999;
					vl_minimo_base_w	:= vl_minimo_base_w * vl_proporcional_base_w;
				else
					vl_minimo_tributo_w	:= 0;
					vl_minimo_base_w	:= 0;
				end if;
				
				vl_desc_dependente_w	:= vl_desc_dependente_w * vl_proporcional_base_w;
				vl_item_base_aux_w	:= vl_item_base_w;
				if (qt_regra_item_w = 0) then
					vl_item_base_w		:= vl_item_base_w * vl_proporcional_base_w;
				end if;
			end if;
			
			if (pr_imposto_w > 0) then
				if (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
					select	coalesce(sum(a.vl_trib_nao_retido), 0) vl_trib_nao_retido,
						coalesce(sum(a.vl_base_nao_retido), 0) vl_base_nao_retido,
						coalesce(sum(a.vl_trib_adic), 0) vl_trib_adic,
						coalesce(sum(a.vl_base_adic), 0) vl_base_adic,
						coalesce(sum(a.vl_tributo), 0) vl_tributo,
						coalesce(sum(a.vl_base_calculo), 0) vl_base_calculo,
						coalesce(sum(a.vl_reducao_base), 0) vl_reducao_base
					into STRICT	vl_soma_trib_nao_retido_w,
						vl_soma_base_nao_retido_w,
						vl_soma_trib_adic_w,
						vl_soma_base_adic_w,
						vl_trib_anterior_w,
						vl_total_base_w,
						vl_reducao_w
					from	pls_contrato_pagador	c,
						pls_mensalidade		b,
						pls_mensalidade_trib	a
					where	c.nr_sequencia		= b.nr_seq_pagador
					and	b.nr_sequencia		= a.nr_seq_mensalidade
					and	coalesce(b.ie_cancelamento::text, '') = ''
					and	c.cd_cgc	= cd_cgc_p
					and	b.dt_referencia	= dt_referencia_p
					and	b.nr_sequencia <> nr_seq_mensalidade_p
					and	a.ie_tipo_item	= r_c02_w.ie_tipo_item
					and	a.cd_tributo	= r_c01_w.cd_tributo;
				elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
					select 	coalesce(sum(a.vl_trib_nao_retido), 0) vl_trib_nao_retido,
						coalesce(sum(a.vl_base_nao_retido), 0) vl_base_nao_retido,
						coalesce(sum(a.vl_trib_adic), 0) vl_trib_adic,
						coalesce(sum(a.vl_base_adic), 0) vl_base_adic,
						coalesce(sum(a.vl_tributo), 0) vl_tributo,
						coalesce(sum(a.vl_base_calculo), 0) vl_base_calculo,
						coalesce(sum(a.vl_reducao_base), 0) vl_reducao_base
					into STRICT	vl_soma_trib_nao_retido_w,
						vl_soma_base_nao_retido_w,
						vl_soma_trib_adic_w,
						vl_soma_base_adic_w,
						vl_trib_anterior_w,
						vl_total_base_w,
						vl_reducao_w
					from	pls_contrato_pagador c,
						pls_mensalidade b,
						pls_mensalidade_trib a
					where	c.nr_sequencia	= b.nr_seq_pagador
					and	b.nr_sequencia	= a.nr_seq_mensalidade
					and	coalesce(b.ie_cancelamento::text, '') = ''
					and	c.cd_pessoa_fisica = cd_pessoa_fisica_p
					and	b.dt_referencia	= dt_referencia_p
					and	b.nr_sequencia <> nr_seq_mensalidade_p
					and	a.ie_tipo_item	= r_c02_w.ie_tipo_item
					and	a.cd_tributo	= r_c01_w.cd_tributo;
				else
					vl_soma_trib_nao_retido_w	:= 0;
					vl_soma_base_nao_retido_w	:= 0;
					vl_soma_trib_adic_w		:= 0;
					vl_soma_base_adic_w		:= 0;
					vl_trib_anterior_w		:= 0;
					vl_total_base_w			:= 0;
					vl_reducao_w			:= 0;
				end if;
				
				if (vl_proporcional_base_w < 1) and (vl_proporcional_base_w > 0) then
					vl_soma_trib_nao_retido_w	:= vl_soma_trib_nao_retido_w * vl_proporcional_base_w;
					vl_soma_base_nao_retido_w	:= vl_soma_base_nao_retido_w * vl_proporcional_base_w;
					vl_soma_trib_adic_w		:= vl_soma_trib_adic_w * vl_proporcional_base_w;
					vl_soma_base_adic_w		:= vl_soma_base_adic_w * vl_proporcional_base_w;
					vl_trib_anterior_w		:= vl_trib_anterior_w * vl_proporcional_base_w;
					vl_total_base_w			:= vl_total_base_w * vl_proporcional_base_w;
					vl_reducao_w			:= vl_reducao_w * vl_proporcional_base_w;
				end if;

				if (pr_desc_base_w > 0) then
					vl_reducao_ww	:= 	(vl_item_base_w/100) * pr_desc_base_w;
					vl_item_base_w	:= 	vl_item_base_w - vl_reducao_ww;
				elsif (pr_desc_base_w = 0) then
					vl_reducao_ww	:=	0;
				end if;

				obter_valores_tributo(	ie_acumulativo_w,
							pr_imposto_w,
							vl_minimo_base_w,
							vl_minimo_tributo_w,
							vl_soma_trib_nao_retido_w,
							vl_soma_trib_adic_w,
							vl_soma_base_nao_retido_w,
							vl_soma_base_adic_w,
							vl_item_base_w,
							vl_tributo_ww,
							vl_trib_nao_retido_w,
							vl_trib_adic_ww,
							vl_base_nao_retido_w,
							vl_base_adic_w,
							vl_teto_base_w,
							vl_trib_anterior_w,
							'N',
							vl_total_base_w,
							vl_reducao_w,
							vl_desc_dependente_w,
							0,
							0,
							0,
							null,
							0,
							clock_timestamp(),
							nr_seq_regra_irpf_w);
				
				if (vl_tributo_ww > 0 and vl_tributo_ww < 0.01) then
					vl_tributo_w	:= 0.01;
				else
					vl_tributo_w	:= vl_tributo_ww;
				end if;
				
				select	max(ie_saldo_tit_rec),
					max(ie_retencao)
				into STRICT	ie_saldo_tit_rec_w,
					ie_retencao_w
				from	regra_calculo_imposto
				where	nr_sequencia	= nr_seq_regra_w;

				if (ie_retencao_w = 'P') then
					select	ie_soma_diminui
					into STRICT	ie_retencao_w
					from	tributo
					where	cd_tributo = r_c01_w.cd_tributo;
				end if;
				
				ie_saldo_tit_rec_w	:= coalesce(ie_saldo_tit_rec_w, 'N');
				
				vl_base_aux_w	:= vl_base_aux_w + vl_item_base_w;
				
				current_setting('pls_mens_tributos_pck.t_cd_tributo_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)		:= r_c01_w.cd_tributo;
				current_setting('pls_mens_tributos_pck.t_tx_tributo_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)		:= pr_imposto_w;
				current_setting('pls_mens_tributos_pck.t_vl_tributo_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)		:= vl_tributo_w;
				current_setting('pls_mens_tributos_pck.t_vl_base_calculo_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)	:= vl_item_base_w;
				current_setting('pls_mens_tributos_pck.t_vl_trib_nao_retido_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)	:= vl_trib_nao_retido_w;
				current_setting('pls_mens_tributos_pck.t_vl_base_nao_retido_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)	:= vl_base_nao_retido_w;
				current_setting('pls_mens_tributos_pck.t_vl_trib_adic_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)		:= coalesce(vl_trib_adic_w,0);
				current_setting('pls_mens_tributos_pck.t_vl_base_adic_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)		:= 0;
				current_setting('pls_mens_tributos_pck.t_nr_seq_item_mens_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)	:= r_c02_w.nr_seq_item;
				if (ie_saldo_tit_rec_w = 'S') then
					current_setting('pls_mens_tributos_pck.t_ie_origem_tributo_w')::pls_util_cta_pck.t_varchar2_table_5(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)	:= 'CD';
				else
					current_setting('pls_mens_tributos_pck.t_ie_origem_tributo_w')::pls_util_cta_pck.t_varchar2_table_5(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)	:= 'C';
				end if;
				current_setting('pls_mens_tributos_pck.t_ie_tipo_item_w')::pls_util_cta_pck.t_varchar2_table_5(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)		:= r_c02_w.ie_tipo_item;
				current_setting('pls_mens_tributos_pck.t_vl_reducao_base_w')::pls_util_cta_pck.t_number_table(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)	:= vl_reducao_ww;
				current_setting('pls_mens_tributos_pck.t_ie_retencao_w')::pls_util_cta_pck.t_varchar2_table_2(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)		:= ie_retencao_w;
				current_setting('pls_mens_tributos_pck.t_cd_cgc_w')::pls_util_cta_pck.t_varchar2_table_15(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)			:= cd_cgc_p;
				current_setting('pls_mens_tributos_pck.t_cd_pessoa_fisica_w')::pls_util_cta_pck.t_varchar2_table_10(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer)	:= cd_pessoa_fisica_p;
				
				if	(current_setting('pls_mens_tributos_pck.nr_indice_w')::integer >= (pls_util_pck.qt_registro_transacao_w-1)) then
					CALL pls_mens_tributos_pck.inserir_tributo(nr_seq_mensalidade_p, nm_usuario_p);
				else
					PERFORM set_config('pls_mens_tributos_pck.nr_indice_w', current_setting('pls_mens_tributos_pck.nr_indice_w')::integer + 1, false);
				end if;
				
				qt_benef_mens_w := qt_benef_mens_w + 1;
			end if;
		end if;
		end;
	end loop; --C02
	CALL pls_mens_tributos_pck.inserir_tributo(nr_seq_mensalidade_p, nm_usuario_p);

	if (pr_desc_base_w > 0) then
		select	sum(vl_base_calculo),
			sum(vl_reducao_base)
		into STRICT	vl_base_calculo_total_w,
			vl_reducao_base_total_w
		from	pls_mensalidade_trib
		where	nr_seq_mensalidade = nr_seq_mensalidade_p
		and	cd_tributo	= r_c01_w.cd_tributo;
		
		vl_reducao_base_correto_w	:= ((vl_base_calculo_total_w + vl_reducao_base_total_w) /100) * pr_desc_base_w;
		
		if (vl_reducao_base_correto_w <> vl_reducao_base_total_w) then
			for r_c05_w in C05(nr_seq_mensalidade_p, r_c01_w.cd_tributo) loop
				begin

				if (vl_reducao_base_correto_w > vl_reducao_base_total_w) then
					update	pls_mensalidade_trib
					set	vl_base_calculo = vl_base_calculo - 0.01,
						vl_reducao_base	= vl_reducao_base + 0.01
					where	nr_sequencia = r_c05_w.nr_seq_mensalidade_trib;
					
					vl_reducao_base_total_w	:= vl_reducao_base_total_w + 0.01;
				elsif (vl_reducao_base_correto_w < vl_reducao_base_total_w) then
					update	pls_mensalidade_trib
					set	vl_base_calculo = vl_base_calculo + 0.01,
						vl_reducao_base	= vl_reducao_base - 0.01
					where	nr_sequencia = r_c05_w.nr_seq_mensalidade_trib;
					
					vl_reducao_base_total_w	:= vl_reducao_base_total_w - 0.01;
				end if;

				end;
			end loop;
		end if;
	end if;

	for r_c03_w in C03(nr_seq_mensalidade_p, r_c01_w.cd_tributo) loop
		vl_total_tributo_w := vl_total_tributo_w + (r_c03_w.vl_base_calculo * (r_c03_w.tx_tributo/100));
	end loop;

	if (qt_benef_mens_w > 0) then
		vl_adicional_rateio_w	:= vl_trib_adic_w/qt_benef_mens_w;
		
		vl_diferenca_w		:= (vl_adicional_rateio_w * qt_benef_mens_w) - vl_trib_adic_w;
		
		vl_adic_base_rateio_w	:= vl_total_base_w/qt_benef_mens_w;
		
		vl_diferenca_ww		:= (vl_adic_base_rateio_w * qt_benef_mens_w) - vl_total_base_w;
	end if;
	
	for r_c04_w in C04(nr_seq_mensalidade_p, r_c01_w.cd_tributo) loop
		vl_trib_adic_rateio_w	:= vl_adicional_rateio_w;
		vl_trib_adic_base_rateio_w := vl_adic_base_rateio_w;
		
		if (vl_diferenca_w > 0) then
			vl_diferenca_w	:= vl_diferenca_w - 0.01;
			vl_trib_adic_rateio_w	:= vl_adicional_rateio_w - 0.01;
		elsif (vl_diferenca_w < 0) then
			vl_diferenca_w	:= vl_diferenca_w + 0.01;
			vl_trib_adic_rateio_w	:= vl_adicional_rateio_w + 0.01;
		end if;
		
		if (vl_diferenca_ww > 0) then
			vl_diferenca_ww	:= vl_diferenca_ww - 0.01;
			vl_trib_adic_base_rateio_w := vl_adic_base_rateio_w - 0.01;
		elsif (vl_diferenca_ww < 0) then
			vl_diferenca_ww	:= vl_diferenca_ww + 0.01;
			vl_trib_adic_base_rateio_w := vl_adic_base_rateio_w + 0.01;
		end if;
		
		update	pls_mensalidade_trib
		set	vl_trib_adic = vl_trib_adic_rateio_w,
			vl_tributo = vl_tributo + vl_trib_adic_rateio_w,
			vl_base_adic = vl_trib_adic_base_rateio_w
		where	nr_seq_item_mens = r_c04_w.nr_seq_item_mens;
	end loop;
	
	select (coalesce(vl_total_tributo_w,0) + coalesce(vl_trib_adic_w,0)) - coalesce(sum(x.vl_tributo),0)
	into STRICT	vl_arredondamento_w
	from	pls_mensalidade_trib x
	where	x.nr_seq_mensalidade 	= nr_seq_mensalidade_p
	and	x.cd_tributo 		= r_c01_w.cd_tributo;
	
	--Se o total recalculado for diferente que o valor de tributo gerado, e realizado o arredondamento do ultimo tributo gerado
	if (vl_arredondamento_w <> 0) then
		select	max(nr_sequencia)
		into STRICT	nr_seq_mens_trib_w
		from	pls_mensalidade_trib
		where	nr_seq_mensalidade	= nr_seq_mensalidade_p;
		
		if (nr_seq_mens_trib_w IS NOT NULL AND nr_seq_mens_trib_w::text <> '') then
			update 	pls_mensalidade_trib
			set	vl_tributo 	= vl_tributo + vl_arredondamento_w
			where	nr_sequencia 	= nr_seq_mens_trib_w;
		end if;
	end if;
	
	if (vl_base_aux_w > vl_teto_base_w) and (vl_teto_base_w > 0) then
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_mens_trib_aux_w
		from	pls_mensalidade_trib	a
		where	a.nr_seq_mensalidade	= nr_seq_mensalidade_p
		and	a.vl_tributo > 0
		and	a.cd_tributo = r_c01_w.cd_tributo;
		
		update	pls_mensalidade_trib
		set	vl_base_calculo	= vl_base_calculo - (vl_base_aux_w - vl_teto_base_w),
			vl_tributo	= (vl_base_calculo * tx_tributo) / 100
		where	nr_sequencia	= nr_seq_mens_trib_aux_w;
	end if;
	
	select	sum(a.vl_base_calculo),
		sum(a.vl_tributo)
	into STRICT	vl_base_ared_w,
		vl_trib_ared_w
	from	pls_mensalidade_trib	a
	where	a.nr_seq_mensalidade	= nr_seq_mensalidade_p
	and	a.cd_tributo		= r_c01_w.cd_tributo;
	
	if	(((vl_base_ared_w * pr_imposto_w) / 100) <> vl_trib_ared_w) then
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_mens_trib_aux_w
		from	pls_mensalidade_trib	a
		where	a.nr_seq_mensalidade	= nr_seq_mensalidade_p
		and	a.vl_tributo > 0
		and	a.cd_tributo = r_c01_w.cd_tributo;
		
		update	pls_mensalidade_trib
		set	vl_tributo	= (vl_tributo + coalesce(vl_trib_adic_w,0)) - (vl_trib_ared_w - ((vl_base_ared_w * pr_imposto_w) / 100))
		where	nr_sequencia	= nr_seq_mens_trib_aux_w;
		
		vl_total_arredondado_w := round((vl_base_ared_w * pr_imposto_w) / 100,2);
		
		select	sum(vl_tributo)
		into STRICT	vl_total_tributo_ww
		from	pls_mensalidade_trib
		where	nr_seq_mensalidade	= nr_seq_mensalidade_p
		and	cd_tributo		= r_c01_w.cd_tributo;
		
		if (vl_total_arredondado_w > vl_total_tributo_ww) then
			update	pls_mensalidade_trib
			set	vl_tributo	= vl_tributo + 0.01
			where	nr_sequencia	= nr_seq_mens_trib_aux_w;
		end if;
	end if;
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_mens_tributos_pck.gerar_tributos ( nr_seq_mensalidade_p pls_mensalidade.nr_sequencia%type, dt_referencia_p pls_mensalidade.dt_referencia%type, cd_cgc_p pls_contrato_pagador.cd_cgc%type, cd_pessoa_fisica_p pls_contrato_pagador.cd_pessoa_fisica%type, nr_seq_contrato_p pls_contrato_pagador.nr_seq_contrato%type, nr_seq_intercambio_p pls_contrato_pagador.nr_seq_pagador_intercambio%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
