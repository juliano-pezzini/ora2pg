-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_conversao_itens_pck.insere_mat_abertura_pct ( tb_insere_mat_p INOUT table_insere_mat_abert_pct, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

				
tb_seq_mat_w			pls_util_cta_pck.t_number_table;
nr_seq_regra_cooperado_mat_w	pls_conta_mat.nr_seq_regra_cooperado%type;
ie_ato_cooperado_mat_w		pls_conta_mat.ie_ato_cooperado%type;	
ind_w				integer := 0;
tb_seq_mat_recalc_w		pls_util_cta_pck.t_number_table;
tb_seq_regra_w			pls_util_cta_pck.t_number_table;
tb_ie_ato_w			pls_util_cta_pck.t_varchar2_table_1;
nr_seq_novo_mat_w		pls_conta_mat.nr_sequencia%type;
ie_med_solic_coop_w		varchar(1);	
ie_med_exec_coop_w 		varchar(1);
ie_tipo_despesa_w		pls_conta_mat_v.ie_tipo_despesa%type;	
nr_seq_prestador_exec_w		pls_conta_mat_v.nr_seq_prestador_exec%type;	
nr_seq_prestador_solic_w	pls_conta_mat_v.nr_seq_prestador_solic%type;
nr_seq_material_w		pls_conta_mat_v.nr_seq_material%type;	
ie_tipo_protocolo_w		pls_conta_mat_v.ie_tipo_protocolo%type;	
ie_tipo_guia_w			pls_conta_mat_v.ie_tipo_guia%type;		
nr_seq_conta_w			pls_conta_mat_v.nr_seq_conta%type;
nr_seq_prestador_prot_w		pls_conta_mat_v.nr_seq_prestador_prot%type;	
				
BEGIN

	if ( tb_insere_mat_p.nr_sequencia.count > 0 ) then
	
		forall i in tb_insere_mat_p.nr_sequencia.first..tb_insere_mat_p.nr_sequencia.last
			insert  into pls_conta_mat(nr_sequencia, qt_material_imp, vl_unitario_imp,
				vl_material_imp, ie_status,nr_seq_pacote,
				cd_material,nm_usuario,dt_atualizacao,
				nm_usuario_nrec,dt_atualizacao_nrec,ie_situacao,
				nr_seq_conta,vl_liberado,vl_material,
				qt_material,vl_unitario,ie_tipo_despesa,
				nr_seq_regra_pct_fat,nr_Seq_material, dt_atendimento,
				ie_lanc_manual_pos, nr_seq_proc_pct, dt_inicio_atend,
				dt_fim_atend)
			values (	nextval('pls_conta_mat_seq'), tb_insere_mat_p.qt_material_imp(i), tb_insere_mat_p.vl_unitario_imp(i),
				tb_insere_mat_p.vl_material_imp(i), 'M', tb_insere_mat_p.nr_seq_pacote(i),
				tb_insere_mat_p.cd_material(i),nm_usuario_p, clock_timestamp(),
				nm_usuario_p,clock_timestamp(), 'I',
				tb_insere_mat_p.nr_seq_conta(i), tb_insere_mat_p.vl_liberado(i), tb_insere_mat_p.vl_material(i),
				tb_insere_mat_p.qt_material(i), tb_insere_mat_p.vl_unitario(i), tb_insere_mat_p.ie_tipo_despesa(i),
				tb_insere_mat_p.nr_seq_regra_pct_fat(i), tb_insere_mat_p.nr_Seq_material(i), tb_insere_mat_p.dt_atendimento(i),
				'S', tb_insere_mat_p.nr_seq_proc_pct(i), tb_insere_mat_p.dt_inicio_atend(i),
				tb_insere_mat_p.dt_fim_atend(i))
			returning nr_sequencia bulk collect into tb_seq_mat_w;
		
		tb_seq_mat_w := pls_cta_proc_mat_regra_pck.cria_registro_regra_mat_t(tb_seq_mat_w, nm_usuario_p);
		tb_insere_mat_p.nr_seq_conta := pls_cta_proc_mat_regra_pck.gera_seq_tiss_conta_mat_t(tb_insere_mat_p.nr_seq_conta, nm_usuario_p);
			
			
			--Necessario atualizar informaaao de ato cooperado, entao com os novos materiais inseridos faz esse trabalho

			for i in tb_seq_mat_w.first..tb_seq_mat_w.last loop
				
				select	a.ie_tipo_despesa,
					a.nr_seq_prestador_exec,
					a.nr_seq_prestador_solic,
					a.nr_seq_prestador_prot,
					a.nr_seq_material,
					a.ie_tipo_protocolo,
					a.ie_tipo_guia,
					a.nr_seq_conta	
				into STRICT	ie_tipo_despesa_w,	
					nr_seq_prestador_exec_w,	
					nr_seq_prestador_solic_w,
					nr_seq_prestador_prot_w,	
					nr_seq_material_w,	
					ie_tipo_protocolo_w,	
					ie_tipo_guia_w,		
					nr_seq_conta_w		
				from	pls_conta_mat_v 	a
				where	nr_sequencia 	= tb_seq_mat_w(i);
						
					--Aproveira o loop pelos materiais inseridos e gera o log

					CALL pls_gravar_log_conta(	nr_seq_conta_w, null, tb_seq_mat_w(i),
								'Material '||tb_seq_mat_w(i)||' gerado a partir da abertura de pacote! ', nm_usuario_p);
				
					nr_seq_novo_mat_w 	:= tb_seq_mat_w(i);
					ie_med_solic_coop_w	:= tb_insere_mat_p.ie_medico_solic_coope(ind_w);
					ie_med_exec_coop_w	:= tb_insere_mat_p.ie_medico_exec_coope(ind_w);
				
					pls_obter_tipo_ato_cooperado(	null, null, nr_seq_novo_mat_w,
									'M', nr_seq_prestador_exec_w, nr_seq_prestador_solic_w, 
									nr_seq_prestador_prot_w, null, ie_med_solic_coop_w,	
									ie_med_exec_coop_w, nr_seq_material_w, ie_tipo_protocolo_w, 
									ie_tipo_guia_w,	null, ie_tipo_despesa_w, 
									nr_seq_regra_cooperado_mat_w, ie_ato_cooperado_mat_w);
									
					tb_seq_mat_recalc_w(ind_w)	:= tb_seq_mat_w(i);
					tb_seq_regra_w(ind_w)		:= nr_seq_regra_cooperado_mat_w;
					tb_ie_ato_w(ind_w)		:= ie_ato_cooperado_mat_w;
					ind_w := ind_w + 1;
				
			end loop;
				
			if (tb_seq_mat_w.count > 0) then
			
				forall i in tb_seq_mat_recalc_w.first..tb_seq_mat_recalc_w.last
					update 	pls_conta_mat
					set	nr_seq_regra_cooperado	= tb_seq_regra_w(i),
						ie_ato_cooperado	= tb_ie_ato_w(i)
					where	nr_sequencia 		= tb_seq_mat_recalc_w(i);
			
			end if;
			commit;							
					
	end if;
	
	tb_insere_mat_p.ie_medico_exec_coope.delete;
	tb_insere_mat_p.ie_medico_solic_coope.delete;
	tb_insere_mat_p.nr_sequencia.delete;
	tb_insere_mat_p.qt_material_imp.delete; 	
	tb_insere_mat_p.vl_unitario_imp.delete;		
	tb_insere_mat_p.vl_material_imp.delete;		
	tb_insere_mat_p.nr_seq_pacote.delete;		
	tb_insere_mat_p.cd_material.delete;		
	tb_insere_mat_p.nr_seq_conta.delete;		
	tb_insere_mat_p.vl_liberado.delete;		
	tb_insere_mat_p.vl_material.delete;		
	tb_insere_mat_p.qt_material.delete;		
	tb_insere_mat_p.vl_unitario.delete;		
	tb_insere_mat_p.ie_tipo_despesa.delete;		
	tb_insere_mat_p.nr_Seq_material.delete;		
	tb_insere_mat_p.dt_atendimento.delete;		
	tb_insere_mat_p.nr_seq_proc_pct.delete;		
	tb_insere_mat_p.dt_inicio_atend.delete;		
	tb_insere_mat_p.dt_fim_atend.delete;		
	tb_insere_mat_p.nr_sequencia.delete;		
	tb_insere_mat_p.nr_seq_regra_pct_fat.delete;	
		
end;					


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conversao_itens_pck.insere_mat_abertura_pct ( tb_insere_mat_p INOUT table_insere_mat_abert_pct, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
