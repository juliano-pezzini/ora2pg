-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Inseraao de participantes na regra de lanaamento de itens pas



CREATE OR REPLACE PROCEDURE pls_conversao_itens_pck.insere_partic_conv_itens ( tb_insere_participantes_p INOUT table_dados_lanc_partic, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_novo_proc_w	pls_conta_proc.nr_sequencia%type;
					
BEGIN
	
	if (tb_insere_participantes_p.nr_seq_conta_proc_princ.count > 0) then
	
		--Primeiramente precisa atualizar o tb_insere_participantes_p.nr_seq_conta_proc pois nao esta populado ata o momento, ja que os procedimentos recam criados

		-- precisam ser identificados atravas do nr_seq_proc_princ

		for i in tb_insere_participantes_p.nr_seq_conta_proc_princ.first..tb_insere_participantes_p.nr_seq_conta_proc_princ.last loop
		
			select	max(nr_sequencia)
			into STRICT	nr_seq_novo_proc_w
			from	pls_conta_proc
			where	nr_seq_proc_princ 	= tb_insere_participantes_p.nr_seq_conta_proc_princ(i)
			and	cd_procedimento		= tb_insere_participantes_p.cd_procedimento(i)
			and	ie_origem_proced	= tb_insere_participantes_p.ie_origem_proced(i)
			and	ie_status 		= 'M';
			
			tb_insere_participantes_p.nr_seq_conta_proc(i) := nr_seq_novo_proc_w;
	
		end loop;
		
		
		forall i in tb_insere_participantes_p.nr_seq_conta_proc_princ.first..tb_insere_participantes_p.nr_seq_conta_proc_princ.last
			insert into pls_proc_participante(	nr_sequencia,dt_atualizacao, nm_usuario,
					dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_conta_proc,
					nr_seq_grau_partic, qt_liberada, vl_calculado,
					vl_calculado_ant, vl_glosa, vl_honorario_medico,
					vl_participante, ie_insercao_manual, ie_status,
					ie_status_pagamento, cd_medico)
			values (	nextval('pls_proc_participante_seq'), clock_timestamp(), nm_usuario_p,
					clock_timestamp(), nm_usuario_p, tb_insere_participantes_p.nr_seq_conta_proc(i),
					tb_insere_participantes_p.nr_seq_grau_partic(i), tb_insere_participantes_p.qt_liberada(i), 0,
					0, 0, 0,
					0, 'N', 'L',
					'N', tb_insere_participantes_p.cd_medico(i));	
		commit;
	end if;
	tb_insere_participantes_p.nr_seq_conta_proc.delete;	
	tb_insere_participantes_p.nr_seq_conta_proc_princ.delete;
	tb_insere_participantes_p.nr_seq_grau_partic.delete;	
	tb_insere_participantes_p.qt_liberada.delete;		
	tb_insere_participantes_p.cd_medico.delete;	
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conversao_itens_pck.insere_partic_conv_itens ( tb_insere_participantes_p INOUT table_dados_lanc_partic, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
