-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

/*
	Exclusao dos procedimentos que foram lanaados anteriormente pela regra. Sera passado a sequencia do procedimento origem e nao mais a conta e 
	serao excluados os itens cujo nr_seq_proc_princ for igual as sequencias passadas pelo parametro
*/



CREATE OR REPLACE PROCEDURE pls_conversao_itens_pck.excluir_reg_lanc_anteriores ( tb_seq_item_p INOUT pls_util_cta_pck.t_number_table, nr_seq_ajuste_fat_p INOUT pls_util_cta_pck.t_number_table, nm_usuario_p usuario.nm_usuario%type) AS $body$
BEGIN

	if (tb_seq_item_p.count > 0) then
	
		forall i in tb_seq_item_p.first..tb_seq_item_p.last
			update	pls_conta_proc
			set	nr_seq_regra_conv  = NULL,
				dt_atualizacao	  = clock_timestamp()
			where	nr_sequencia = tb_seq_item_p(i);
	
		forall i in tb_seq_item_p.first..tb_seq_item_p.last
			delete 	FROM pls_analise_fluxo_ocor
			where 	coalesce(nr_seq_ajuste_fat_p(i)::text, '') = ''
			and	nr_seq_fluxo_item     in (	SELECT 	nr_sequencia
								from	pls_analise_fluxo_item
								where	nr_seq_conta_proc	in (    SELECT 	nr_sequencia
													from	pls_conta_proc
													where	ie_status	= 'M'
													and	nr_seq_proc_princ = tb_seq_item_p(i)
													and	((coalesce(ie_lanc_manual_pos::text, '') = '') 	or (ie_lanc_manual_pos = 'N') 	or (nr_seq_regra_conv IS NOT NULL AND nr_seq_regra_conv::text <> ''))));
		
		forall i in tb_seq_item_p.first..tb_seq_item_p.last
			delete	FROM pls_analise_fluxo_item
			where	coalesce(nr_seq_ajuste_fat_p(i)::text, '') = ''
			and	nr_seq_conta_proc	in (    SELECT 	nr_sequencia
								from	pls_conta_proc
								where	ie_status	= 'M'
								and	nr_seq_proc_princ = tb_seq_item_p(i)
								and	((coalesce(ie_lanc_manual_pos::text, '') = '') or (ie_lanc_manual_pos = 'N')
									or (nr_seq_regra_conv IS NOT NULL AND nr_seq_regra_conv::text <> '')));
			
		forall i in tb_seq_item_p.first..tb_seq_item_p.last
			delete	FROM pls_ocorrencia_benef
			where	coalesce(nr_seq_ajuste_fat_p(i)::text, '') = ''
			and	nr_seq_conta_proc	in (    SELECT 	nr_sequencia
								from	pls_conta_proc
								where	ie_status	= 'M'
								and	nr_seq_proc_princ = tb_seq_item_p(i)
								and	((coalesce(ie_lanc_manual_pos::text, '') = '') or (ie_lanc_manual_pos = 'N')
									or (nr_seq_regra_conv IS NOT NULL AND nr_seq_regra_conv::text <> '')));

		forall i in tb_seq_item_p.first..tb_seq_item_p.last
			delete	FROM pls_fatura_proc
			where	coalesce(nr_seq_ajuste_fat_p(i)::text, '') = ''
			and	nr_seq_conta_proc	in (    SELECT 	nr_sequencia
								from	pls_conta_proc
								where	ie_status	= 'M'
								and	nr_seq_proc_princ = tb_seq_item_p(i)
								and	((coalesce(ie_lanc_manual_pos::text, '') = '') or (ie_lanc_manual_pos = 'N') 
									or (nr_seq_regra_conv IS NOT NULL AND nr_seq_regra_conv::text <> '')));


								
		forall i in tb_seq_item_p.first..tb_seq_item_p.last
			delete	FROM pls_hist_analise_conta
			where	coalesce(nr_seq_ajuste_fat_p(i)::text, '') = ''
			and	nr_seq_conta_proc	in (    SELECT 	nr_sequencia
								from	pls_conta_proc
								where	ie_status	= 'M'
								and	nr_seq_proc_princ = tb_seq_item_p(i)
								and	((coalesce(ie_lanc_manual_pos::text, '') = '') or (ie_lanc_manual_pos = 'N')
									or (nr_seq_regra_conv IS NOT NULL AND nr_seq_regra_conv::text <> '')));
								
		

		forall i in tb_seq_item_p.first..tb_seq_item_p.last
			delete	FROM pls_conta_pos_proc_contab
			where	coalesce(nr_seq_ajuste_fat_p(i)::text, '') = ''
			and	nr_seq_conta_pos_proc in (  	SELECT 	a.nr_sequencia
								from	pls_conta_proc a,
									pls_conta_pos_proc b
								where	b.nr_seq_conta_proc = a.nr_sequencia
								and	a.ie_status	= 'M'
								and	a.nr_seq_proc_princ = tb_seq_item_p(i)
								and	((coalesce(a.ie_lanc_manual_pos::text, '') = '') or (a.ie_lanc_manual_pos = 'N') or (a.nr_seq_regra_conv IS NOT NULL AND a.nr_seq_regra_conv::text <> '')));	
								

							
		forall i in tb_seq_item_p.first..tb_seq_item_p.last
			delete 	FROM pls_conta_pos_proc
			where	coalesce(nr_seq_ajuste_fat_p(i)::text, '') = ''
			and	nr_seq_conta_proc in (  SELECT 	nr_sequencia
							from	pls_conta_proc
							where	ie_status	= 'M'
							and	nr_seq_proc_princ = tb_seq_item_p(i)
							and	((coalesce(ie_lanc_manual_pos::text, '') = '') or (ie_lanc_manual_pos = 'N') or (nr_seq_regra_conv IS NOT NULL AND nr_seq_regra_conv::text <> '')));


							
		forall i in tb_seq_item_p.first..tb_seq_item_p.last
			delete 	FROM pls_conta_proc	p
			where	coalesce(nr_seq_ajuste_fat_p(i)::text, '') = ''
			and	p.nr_seq_proc_princ	in (	SELECT	nr_sequencia
								from	pls_conta_proc
								where	ie_status	= 'M'
								and	nr_seq_proc_princ = tb_seq_item_p(i)
								and	((coalesce(ie_lanc_manual_pos::text, '') = '') or (ie_lanc_manual_pos = 'N') or (nr_seq_regra_conv IS NOT NULL AND nr_seq_regra_conv::text <> '')));
								
		forall i in tb_seq_item_p.first..tb_seq_item_p.last
			delete 	FROM pls_conta_proc
			where	ie_status	= 'M'
			and	coalesce(nr_seq_ajuste_fat_p(i)::text, '') = ''
			and	nr_seq_proc_princ = tb_seq_item_p(i)
			and	((coalesce(ie_lanc_manual_pos::text, '') = '') or (ie_lanc_manual_pos = 'N') or (nr_seq_regra_conv IS NOT NULL AND nr_seq_regra_conv::text <> ''));
	
		commit;
	end if;
	tb_seq_item_p.delete;
	nr_seq_ajuste_fat_p.delete;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conversao_itens_pck.excluir_reg_lanc_anteriores ( tb_seq_item_p INOUT pls_util_cta_pck.t_number_table, nr_seq_ajuste_fat_p INOUT pls_util_cta_pck.t_number_table, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
