-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_conversao_itens_pck.identificar_regra_item ( nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_regra_p INOUT pls_conta_proc.nr_seq_regra_pct_fat%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

					
nr_irrelevante_w		double precision;
nr_seq_regra_pct_fat_w		pls_conta_proc.nr_seq_regra_pct_fat%type;
dados_conta_proc_w		pls_cta_valorizacao_pck.dados_conta_proc;
dados_prestador_exec_w		pls_cta_valorizacao_pck.dados_prestador_exec;
ie_tipo_intercambio_seg_w	pls_conta_v.ie_tipo_intercambio%type;

c01 CURSOR(	nr_seq_conta_proc_pc	pls_conta_proc.nr_sequencia%type) FOR
	SELECT	a.cd_estabelecimento,
		b.nr_sequencia nr_seq_conta_proc,
		b.nr_seq_conta,
		b.ie_origem_proced,
		b.cd_procedimento,
		a.nr_seq_prestador_exec,
		(SELECT	max(x.nr_seq_classificacao)
		from	pls_prestador x
		where	x.nr_sequencia = a.nr_seq_prestador_exec) nr_seq_clas_prest_exec,
		(select	max(x.cd_prestador)
		from	pls_prestador x
		where	x.nr_sequencia = a.nr_seq_prestador_exec) cd_prestador_exec,
		a.nr_seq_tipo_acomodacao,
		b.dt_procedimento_referencia,
		pls_obter_se_internado(	a.nr_sequencia, null, a.ie_tipo_guia, 
					a.nr_seq_tipo_atendimento, null, a.cd_estabelecimento, 
					'N', a.ie_regime_atendimento, a.ie_saude_ocupacional,
					a.dt_atendimento_referencia) ie_internado,
		(select	max(x.nr_seq_plano)
		from	pls_segurado x
		where	x.nr_sequencia = a.nr_seq_segurado) nr_seq_plano,
		(select	max(x.nr_seq_congenere)
		from	pls_segurado x
		where	x.nr_sequencia = a.nr_seq_segurado) nr_seq_congenere_seg,
		a.ie_origem_conta,
		pls_obter_tipo_intercambio(coalesce(a.nr_seq_congenere, c.nr_seq_congenere), a.cd_estabelecimento) ie_tipo_intercambio,
		(select	max(x.nr_seq_intercambio)
		from	pls_segurado x
		where	x.nr_sequencia = a.nr_seq_segurado) nr_seq_intercambio,
		a.nr_seq_segurado,
		a.nr_seq_prest_inter,
		(select	max(y.nr_contrato)
		from	pls_contrato y,
			pls_segurado x
		where	y.nr_sequencia = x.nr_seq_contrato
		and	x.nr_sequencia = a.nr_seq_segurado) nr_contrato,
		(select	x.nr_seq_contrato
		from	pls_segurado x
		where	x.nr_sequencia = a.nr_seq_segurado) nr_seq_contrato
	from	pls_protocolo_conta c,
		pls_conta a,
		pls_conta_proc b
	where	b.nr_sequencia = nr_seq_conta_proc_pc
	and	b.ie_status not in ('D','M')
	and	a.nr_sequencia = b.nr_seq_conta
	and	c.nr_sequencia = a.nr_seq_protocolo
	and	exists (	select	1
			from	pls_pacote x
			where	x.cd_procedimento = b.cd_procedimento
			and	x.ie_origem_proced = b.ie_origem_proced
			and	x.ie_situacao = 'A')
	and not exists (	select	1
			from	pls_pacote_tipo_acomodacao x
			where	x.nr_sequencia = b.nr_seq_preco_pacote
			and	x.ie_abrir_contas_medicas = 'S');
	
BEGIN



	-- retorna de acordo com o filtro identificado

	for r_c01_w in c01(	nr_seq_conta_proc_p) loop

		-- dados do procedimento

		dados_conta_proc_w.cd_procedimento := r_c01_w.cd_procedimento;
		dados_conta_proc_w.ie_origem_proced:= r_c01_w.ie_origem_proced;
		-- dados do prestador executor

		dados_prestador_exec_w.nr_seq_prestador := r_c01_w.nr_seq_prestador_exec;
		dados_prestador_exec_w.nr_seq_classificacao := r_c01_w.nr_seq_clas_prest_exec;
		dados_prestador_exec_w.cd_prestador := r_c01_w.cd_prestador_exec;
		
		ie_tipo_intercambio_seg_w := pls_obter_tipo_intercambio(r_c01_w.nr_seq_congenere_seg, r_c01_w.cd_estabelecimento);
		
		pls_define_preco_pacote_cta(	coalesce(cd_estabelecimento_p, r_c01_w.cd_estabelecimento), dados_conta_proc_w, dados_prestador_exec_w,
						r_c01_w.nr_seq_tipo_acomodacao, r_c01_w.dt_procedimento_referencia, r_c01_w.ie_internado,
						r_c01_w.nr_seq_plano, r_c01_w.nr_contrato, r_c01_w.nr_seq_congenere_seg,
						nm_usuario_p, r_c01_w.ie_origem_conta, ie_tipo_intercambio_seg_w,
						nr_irrelevante_w, nr_seq_regra_pct_fat_w, nr_irrelevante_w,
						nr_irrelevante_w, nr_irrelevante_w, nr_irrelevante_w,
						nr_irrelevante_w, nr_irrelevante_w, r_c01_w.nr_seq_intercambio,
						r_c01_w.nr_seq_segurado, 'N', r_c01_w.nr_seq_prest_inter,
						1, 'S', r_c01_w.nr_seq_contrato);

		nr_seq_regra_p := nr_seq_regra_pct_fat_w;
	end loop;


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_conversao_itens_pck.identificar_regra_item ( nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_regra_p INOUT pls_conta_proc.nr_seq_regra_pct_fat%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
