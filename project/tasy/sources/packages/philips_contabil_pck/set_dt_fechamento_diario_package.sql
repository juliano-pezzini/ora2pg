-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE philips_contabil_pck.set_dt_fechamento_diario (nr_seq_mes_ref_p ctb_mes_ref.nr_sequencia%type, dt_fech_diario_p timestamp, nm_usuario_p text) AS $body$
DECLARE

	nr_registros_w	integer;
	cd_empresa_w	ctb_mes_ref.cd_empresa%type;
 	current_setting('philips_contabil_pck.dt_referencia_w')::ctb_mes_ref.dt_referencia%type ctb_mes_ref.dt_referencia%type;
  	nr_sequencia_w ctb_mes_ref.nr_sequencia%type;

	c01 CURSOR FOR
		SELECT	cd_empresa
		from	grupo_emp_estrutura a
		where	a.nr_seq_grupo = holding_pck.get_grupo_emp_estrut(cd_empresa_w)
		and		holding_pck.get_emp_controladora_grupo(a.nr_seq_grupo) = cd_empresa_w
        and	exists (SELECT 1
            		from	ctb_mes_ref x
                    where	x.cd_empresa = a.cd_empresa
                    and     x.dt_referencia = current_setting('philips_contabil_pck.dt_referencia_w')::ctb_mes_ref.dt_referencia%type)
		
union

		select	cd_empresa_w
		;

	c01_w		c01%rowtype;

	
BEGIN

		select	count(*)
		into STRICT	nr_registros_w
		from	ctb_mes_ref
		where	nr_sequencia = nr_seq_mes_ref_p;

		if (nr_registros_w = 0) then
			begin
			-- Valor invalido

			CALL wheb_mensagem_pck.exibir_mensagem_abort(1080026);
			end;
		end if;

		if (trunc(dt_fech_diario_p) > trunc(clock_timestamp())) then
			begin
			-- A data nao pode ser superior a data atual!#@#@

			CALL wheb_mensagem_pck.exibir_mensagem_abort(1080023);
			end;
		end if;

		select	cd_empresa,
			dt_referencia
		into STRICT	cd_empresa_w,
			current_setting('philips_contabil_pck.dt_referencia_w')::ctb_mes_ref.dt_referencia%type
		from	ctb_mes_ref
		where	nr_sequencia = nr_seq_mes_ref_p;

		if (trunc(dt_fech_diario_p, 'MONTH') <> trunc(current_setting('philips_contabil_pck.dt_referencia_w')::ctb_mes_ref.dt_referencia%type, 'MONTH')) then
			begin
			-- Nao e permitido informar data de fechamento diario fora do mes contabil.Informe uma data entre #@DT_INICIAL#@ e #@DT_FINAL#@.

			CALL wheb_mensagem_pck.exibir_mensagem_abort(1154298,'DT_INICIAL=' 	|| to_char(pkg_date_utils.start_of(current_setting('philips_contabil_pck.dt_referencia_w')::ctb_mes_ref.dt_referencia%type, 'MONTH'),'dd/mm/yyyy') ||
									';DT_FINAL=' 	|| to_char(pkg_date_utils.end_of(current_setting('philips_contabil_pck.dt_referencia_w')::ctb_mes_ref.dt_referencia%type, 'MONTH'),'dd/mm/yyyy'));
			end;
		end if;

		open c01;
		loop
		fetch c01 into
			c01_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			select	nr_sequencia
			into STRICT	nr_sequencia_w
			from	ctb_mes_ref
			where	dt_referencia = current_setting('philips_contabil_pck.dt_referencia_w')::ctb_mes_ref.dt_referencia%type
			and	cd_empresa = c01_w.cd_empresa;

			CALL philips_contabil_pck.validar_fechamento_diario(dt_fech_diario_p, c01_w.cd_empresa);

			update	ctb_mes_ref
			set	dt_fech_diario 	= dt_fech_diario_p,
				dt_atualizacao 	= clock_timestamp(),
				nm_usuario 	= nm_usuario_p
			where	nr_sequencia 	= nr_sequencia_w;

			end;
		end loop;
		close c01;

	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE philips_contabil_pck.set_dt_fechamento_diario (nr_seq_mes_ref_p ctb_mes_ref.nr_sequencia%type, dt_fech_diario_p timestamp, nm_usuario_p text) FROM PUBLIC;
