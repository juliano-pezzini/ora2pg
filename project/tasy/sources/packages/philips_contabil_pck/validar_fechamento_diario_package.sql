-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE philips_contabil_pck.validar_fechamento_diario (dt_fech_diario_p timestamp, cd_empresa_p bigint) AS $body$
DECLARE


	qt_caixa_aberto_w bigint:= 0;
	qt_banco_aberto_w bigint:= 0;

	
BEGIN
		select  count(*) qt_caixa_aberto
		into STRICT	qt_caixa_aberto_w
		from	caixa_saldo_diario a,
			caixa b
		where   coalesce(a.dt_fechamento::text, '') = ''
		and	trunc(a.dt_saldo, 'dd') <= trunc(dt_fech_diario_p, 'dd')
		and	a.nr_seq_caixa  = b.nr_sequencia
		and     b.ie_situacao = 'A'
		and	obter_empresa_estab(b.cd_estabelecimento) = cd_empresa_p;

		select	count(dt_transacao)
		into STRICT	qt_banco_aberto_w
		from	movto_trans_financ
		where	obter_fechamento_banco_diario(nr_seq_banco, trunc(dt_transacao,'dd'), cd_estabelecimento,'DT') is null
		and	trunc(dt_transacao) = dt_fech_diario_p
		and	(nr_seq_banco IS NOT NULL AND nr_seq_banco::text <> '')
		and	(nr_seq_saldo_banco IS NOT NULL AND nr_seq_saldo_banco::text <> '')
		and	obter_empresa_estab(cd_estabelecimento) = cd_empresa_p;

		if ( qt_banco_aberto_w > 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1087497);
		end if;

		if ( qt_caixa_aberto_w > 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(258407);
		end if;
	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE philips_contabil_pck.validar_fechamento_diario (dt_fech_diario_p timestamp, cd_empresa_p bigint) FROM PUBLIC;
