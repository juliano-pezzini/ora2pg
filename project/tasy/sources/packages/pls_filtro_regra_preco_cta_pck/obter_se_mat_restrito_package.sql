-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_filtro_regra_preco_cta_pck.obter_se_mat_restrito ( nr_seq_material_p pls_material.nr_sequencia%type, dt_vigencia_p timestamp) RETURNS varchar AS $body$
DECLARE


ie_restrito_w		brasindice_preco.ie_restrito%type;
cd_laboratorio_w	brasindice_preco.cd_laboratorio%type;
cd_medicamento_w	brasindice_preco.cd_medicamento%type;
cd_apresentacao_w	brasindice_preco.cd_apresentacao%type;
dt_vigencia_w		timestamp;

C01 CURSOR(	nr_seq_material_pc	pls_material.nr_sequencia%type,
		dt_vigencia_pc		timestamp) FOR
	SELECT	a.cd_laboratorio,
		a.cd_medicamento,
		a.cd_apresentacao
	from	brasindice_preco a,
		pls_material b
	where 	b.nr_sequencia = nr_seq_material_pc
	and	a.cd_tiss = b.cd_tiss_brasindice
	and	a.dt_inicio_vigencia <= dt_vigencia_pc
	order by a.dt_inicio_vigencia desc;

C02 CURSOR(	dt_vigencia_bras_pc	brasindice_preco.dt_inicio_vigencia%type,
		cd_laboratorio_pc	brasindice_preco.cd_laboratorio%type,
		cd_medicamento_pc	brasindice_preco.cd_medicamento%type,
		cd_apresentacao_pc	brasindice_preco.cd_apresentacao%type) FOR
	SELECT 	ie_restrito
	from	brasindice_preco
	where	cd_laboratorio = cd_laboratorio_pc
	and	cd_medicamento = cd_medicamento_pc
	and	cd_apresentacao = cd_apresentacao_pc
	and	dt_inicio_vigencia <= dt_vigencia_bras_pc
	order by dt_inicio_vigencia desc,
		coalesce(vl_preco_final, vl_preco_medicamento) desc;
	
BEGIN

dt_vigencia_w := coalesce(dt_vigencia_p, clock_timestamp());

-- o cursor ir_ retornar o registro mais atual de acordo com a data que foi passada

for r_c01_w in C01(	nr_seq_material_p, dt_vigencia_w) loop

	-- o primeiro registro que retornou _ o v_lido

	cd_laboratorio_w := r_c01_w.cd_laboratorio;
	cd_medicamento_w := r_c01_w.cd_medicamento;
	cd_apresentacao_w := r_c01_w.cd_apresentacao;
	
	-- sai do for e fecha o cursor

	exit;
end loop;

for r_c02_w in C02(	dt_vigencia_w, cd_laboratorio_w,
			cd_medicamento_w, cd_apresentacao_w) loop

	-- o primeiro registro que retornou _ o v_lido

	ie_restrito_w := r_c02_w.ie_restrito;
	
	-- sai do for e fecha o cursor

	exit;
end loop;

-- se for null _ pq n_o retornou nada no select, ent_o n_o _ v_lido

if (coalesce(ie_restrito_w::text, '') = '') then

	ie_restrito_w := 'N';
end if;

return ie_restrito_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_filtro_regra_preco_cta_pck.obter_se_mat_restrito ( nr_seq_material_p pls_material.nr_sequencia%type, dt_vigencia_p timestamp) FROM PUBLIC;
