-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_filtro_regra_preco_cta_pck.obter_ordem_sugerida_regra ( nr_seq_cp_cta_p pls_cp_cta_combinada.nr_sequencia%type) RETURNS bigint AS $body$
DECLARE


nr_valor_total_w	pls_cp_cta_combinada.nr_ordem_execucao%type;
nr_valor_filtro_w	pls_cp_cta_combinada.nr_ordem_execucao%type;
					
C01 CURSOR(nr_seq_cp_cta_pc	pls_cp_cta_combinada.nr_sequencia%type) FOR
	SELECT	b.nr_sequencia nr_seq_cp_filtro,
		b.ie_filtro_beneficiario,
		b.ie_filtro_conta,
		b.ie_filtro_contrato,
		b.ie_filtro_intercambio,
		b.ie_filtro_material,
		b.ie_filtro_participante,
		b.ie_filtro_prestador,
		b.ie_filtro_procedimento,
		b.ie_filtro_produto,
		b.ie_filtro_protocolo,
		b.ie_filtro_servico,
		b.ie_filtro_profissional
	from	pls_cp_cta_combinada a,
		pls_cp_cta_filtro b
	where	a.nr_sequencia = nr_seq_cp_cta_pc
	and	a.ie_ordenacao_sugerida = 'S'
	and	b.nr_seq_cp_combinada = a.nr_sequencia
	and	b.ie_excecao = 'N'
	and	b.ie_situacao = 'A';
	
BEGIN
-- iniciliza a vari_vel

nr_valor_total_w := 0;

-- verifica para cada registro do cursor quais s_o os filtros que est_o ativos, caso o filtro esteja ativo faz 

-- a contagem do valor dos filtros sendo que para cada campo com valor informado vale 100 pontos no peso da regra

-- ap_s verificar os filtros se retornar um valor _ somado 500 pontos por ter algum registro informado no filtro 

-- que est_ ativo ex: filtro benefici_rio est_ ativo e existe 1 regra de filtro nele com um campo informado este 

-- campo dar_ 100 pontos, e por ter um filtro de benefici_rio v_lido recebe mais 500 pontos total 600. ex2: filtro

-- benefici_rio est_ ativo por_m n_o existe nenhuma regra de filtro informada, total de pontos 0 pois para contabilizar 

-- os 500 pontos precisaria ter ao menos 1 regra v_lida

for r_C01_w in C01(nr_seq_cp_cta_p) loop

	-- verifica as regras de filtro de benefic_rio

	if (r_C01_w.ie_filtro_beneficiario = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_BENEF');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;
	-- verifica as regras de filtro de conta

	if (r_C01_w.ie_filtro_conta = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_CONTA');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;
	-- verifica as regras de filtro de contrato

	if (r_C01_w.ie_filtro_contrato = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_CONT');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;
	-- verifica as regras de filtro de interc_mbio

	if (r_C01_w.ie_filtro_intercambio = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_INTERC');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;
	-- verifica as regras de filtro de material

	if (r_C01_w.ie_filtro_material = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_MAT');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;
	-- verifica as regras de filtro de participante

	if (r_C01_w.ie_filtro_participante = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_PARTIC');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;
	-- verifica as regras de filtro de prestador

	if (r_C01_w.ie_filtro_prestador = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_PREST');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;
	-- verifica as regras de filtro de procedimento

	if (r_C01_w.ie_filtro_procedimento = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_PROC');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;	
	-- verifica as regras de filtro de produto

	if (r_C01_w.ie_filtro_produto = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_PRODUTO');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;
	-- verifica as regras de filtro de protocolo

	if (r_C01_w.ie_filtro_protocolo = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_PROT');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;	
	-- verifica as regras de filtro de servico

	if (r_C01_w.ie_filtro_servico = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_SERV');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;
	-- verifica as regras de filtro de profissional

	if (r_C01_w.ie_filtro_profissional = 'S') then
	
		nr_valor_filtro_w := pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro(	r_C01_w.nr_seq_cp_filtro, 'PLS_CP_CTA_FILTRO_PROF');
		
		-- se retornou um valor significa que o filtro _ v_lido ent_o somamos o valor que a regra combinada j_ tem

		-- mais 500 pelo filtro estar v_lido e o valor que retornou dos filtros

		if (nr_valor_filtro_w > 0) then
		
			nr_valor_total_w := nr_valor_total_w + 500 + nr_valor_filtro_w;
		end if;
	end if;
end loop;
	
return nr_valor_total_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_filtro_regra_preco_cta_pck.obter_ordem_sugerida_regra ( nr_seq_cp_cta_p pls_cp_cta_combinada.nr_sequencia%type) FROM PUBLIC;
