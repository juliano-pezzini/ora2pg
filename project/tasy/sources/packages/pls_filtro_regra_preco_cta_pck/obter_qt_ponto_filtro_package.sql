-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro ( nr_seq_cp_cta_filtro_p pls_cp_cta_filtro.nr_sequencia%type, ds_tabela_p text) RETURNS bigint AS $body$
DECLARE


qt_pontos_w	bigint;
ds_campo_temp_w	varchar(500);
ds_campos_w	varchar(32000);
ds_sql_w	varchar(32000);

c01 CURSOR(	ds_tabela_pc	text) FOR
	SELECT	nm_atributo,
		ie_componente
	from	tabela_atributo
	where 	nm_tabela = upper(ds_tabela_pc)
	and   	ie_tipo_atributo != 'FUNCTION'
	and   	nm_atributo not in ('NR_SEQUENCIA', 'DT_ATUALIZACAO', 'NM_USUARIO',
				    'DT_ATUALIZACAO_NREC', 'NM_USUARIO_NREC', 'IE_SITUACAO',
				    'NR_SEQ_CP_CTA_FILTRO', 'IE_TIPO_PRESTADOR', 'IE_MEDICO');

BEGIN

ds_sql_w := pls_filtro_regra_preco_cta_pck.obter_sql_ponto_filtro(ds_tabela_p);

-- se j_ tiver processado anteriormente filtros para esta tabela n_o entra aqui

-- pois o comando SQL j_ est_ salvo na vari_vel interna global

if (coalesce(ds_sql_w::text, '') = '') then

	-- obt_m os campos do select

	for r_c01_w in c01(ds_tabela_p) loop

		-- se for checkbox faz tratamento porque se for N n_o seleciona e n_o conta

		if (r_c01_w.ie_componente = 'cb') then
			ds_campo_temp_w := 'decode(nvl(' ||  r_c01_w.nm_atributo || ', ''N''), ''N'', 0, 100)';
		else
			ds_campo_temp_w := 'decode(' ||  r_c01_w.nm_atributo || ', null, 0, 100)';
		end if;
		
		-- concatena com + para somar os campos logo abaixo

		if (coalesce(ds_campos_w::text, '') = '') then
			ds_campos_w := ds_campo_temp_w;
		else
			ds_campos_w := ds_campos_w || ' + ' || ds_campo_temp_w;
		end if;
	end loop;

	-- monta o select

	ds_sql_w := 'select	sum(' || ds_campos_w || ') qtde' || pls_util_pck.enter_w ||
		    'from	' || ds_tabela_p || pls_util_pck.enter_w ||
		    'where	nr_seq_cp_cta_filtro = :nr_seq_cp_cta_filtro_pc' || pls_util_pck.enter_w ||
		    'and	ie_situacao = ''A''';
	
	-- salva o comando SQL na vari_vel interna global para n_o ficar refazendo o processo acima

	CALL CALL pls_filtro_regra_preco_cta_pck.alimenta_sql_ponto_filtro( ds_tabela_p, ds_sql_w);
end if;

EXECUTE ds_sql_w into STRICT qt_pontos_w using nr_seq_cp_cta_filtro_p;

return qt_pontos_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_filtro_regra_preco_cta_pck.obter_qt_ponto_filtro ( nr_seq_cp_cta_filtro_p pls_cp_cta_filtro.nr_sequencia%type, ds_tabela_p text) FROM PUBLIC;
