-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



-- controle para decidir quando o select para obten__o dos valores dos par_metros deve ser executado novamente



-- par_metros




CREATE OR REPLACE PROCEDURE pls_filtro_regra_preco_cta_pck.carrega_parametros ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
BEGIN

-- se a data da _ltima solicita__o n_o estiver registrada ou 

-- se j_ se passou 67 segundos deste a _ltima solicita__o ou

-- se a origem for diferente da _ltima solicitada ou

-- se o estabelecimento anterior for diferente do _ltimo solicitado

-- executa o comando para preencher os valores dos par_metros

if	((current_setting('pls_filtro_regra_preco_cta_pck.dt_solicitacao_ult_w')::coalesce(timestamp::text, '') = '') or
	(current_setting('pls_filtro_regra_preco_cta_pck.dt_solicitacao_ult_w')::timestamp <= (clock_timestamp() - interval '67 seconds')) or (coalesce(current_setting('pls_filtro_regra_preco_cta_pck.cd_estabelecimento_ult_w')::estabelecimento.cd_estabelecimento%type, -1) != coalesce(cd_estabelecimento_p, -2))) then

	-- se tiver estabelecimento filtra por estabelecimento

	-- caso contr_rio pega o registro m_ximo da tabela

	if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then
				
		select	coalesce(max(ie_calculo_pacote),'P'),
			coalesce(max(ie_calculo_coparticipacao),'P')
		into STRICT	current_setting('pls_filtro_regra_preco_cta_pck.ie_calculo_pacote_w')::pls_parametros.ie_calculo_pacote%type,
			current_setting('pls_filtro_regra_preco_cta_pck.ie_calculo_coparticipacao_w')::pls_parametros.ie_calculo_coparticipacao%type
		from	pls_parametros
		where	cd_estabelecimento = cd_estabelecimento_p;
	else

		select	coalesce(max(ie_calculo_pacote),'P'),
			coalesce(max(ie_calculo_coparticipacao),'P')
		into STRICT	current_setting('pls_filtro_regra_preco_cta_pck.ie_calculo_pacote_w')::pls_parametros.ie_calculo_pacote%type,
			current_setting('pls_filtro_regra_preco_cta_pck.ie_calculo_coparticipacao_w')::pls_parametros.ie_calculo_coparticipacao%type
		from	pls_parametros;
	end if;
	
	PERFORM set_config('pls_filtro_regra_preco_cta_pck.cd_estabelecimento_ult_w', cd_estabelecimento_p, false);
	PERFORM set_config('pls_filtro_regra_preco_cta_pck.dt_solicitacao_ult_w', clock_timestamp(), false);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_filtro_regra_preco_cta_pck.carrega_parametros ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
