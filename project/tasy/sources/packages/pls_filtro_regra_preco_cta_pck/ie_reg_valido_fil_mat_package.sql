-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_filtro_regra_preco_cta_pck.ie_reg_valido_fil_mat ( ie_mat_autorizacao_esp_p pls_cp_cta_filtro_mat.ie_mat_autorizacao_esp%type, nr_seq_segurado_p pls_conta.nr_seq_segurado%type, nr_seq_guia_p pls_conta.nr_seq_guia%type, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, nr_seq_material_p pls_conta_mat.nr_seq_material%type, ie_restringe_hosp_p pls_cp_cta_filtro_mat.ie_restringe_hosp%type) RETURNS boolean AS $body$
DECLARE


ie_valido_w		boolean;
qt_autorizacao_w 	integer;
nr_seq_guia_w		pls_guia_plano.nr_sequencia%type;


BEGIN
-- comeca sendo verdadeiro

ie_valido_w := true;

-- so verifica se o checkbox estiver checado

if (ie_mat_autorizacao_esp_p = 'S') then

	-- se tem a sequencia da guia na conta ja faz o count

	-- visto com Diogo, para o material ser valido e necessorio que ele esteja entre os materiais

	if (coalesce(nr_seq_guia_p::text, '') = '') then
		
		select	count(1)
		into STRICT	qt_autorizacao_w
		from	pls_solic_lib_mat_med 	a
		where	a.nr_seq_guia = nr_seq_guia_p
		and	a.nr_seq_material = nr_seq_material_p;
		
	-- seNAO busca a seq da guia pelo segurado e cod referencia da guia

	else
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_guia_w
		from	pls_guia_plano
		where	cd_guia	= cd_guia_referencia_p
		and	nr_seq_segurado = nr_seq_segurado_p;
		
		select	count(1)
		into STRICT	qt_autorizacao_w
		from	pls_solic_lib_mat_med	a
		where	a.nr_seq_guia = nr_seq_guia_w
		and	a.nr_seq_material = nr_seq_material_p;
	end if;
	
	-- se tiver mais que zero e valido

	if (qt_autorizacao_w = 0) then
		ie_valido_w := false;
	end if;
end if;

-- se NAO retornou S entao NAO e valido

if (ie_restringe_hosp_p != 'S') then

	ie_valido_w := false;
end if;

return ie_valido_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_filtro_regra_preco_cta_pck.ie_reg_valido_fil_mat ( ie_mat_autorizacao_esp_p pls_cp_cta_filtro_mat.ie_mat_autorizacao_esp%type, nr_seq_segurado_p pls_conta.nr_seq_segurado%type, nr_seq_guia_p pls_conta.nr_seq_guia%type, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, nr_seq_material_p pls_conta_mat.nr_seq_material%type, ie_restringe_hosp_p pls_cp_cta_filtro_mat.ie_restringe_hosp%type) FROM PUBLIC;
