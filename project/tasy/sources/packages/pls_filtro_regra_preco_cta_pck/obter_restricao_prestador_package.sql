-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_filtro_regra_preco_cta_pck.obter_restricao_prestador ( ie_tipo_prestador_p pls_cp_cta_filtro_prest.ie_tipo_prestador%type, ie_tipo_vinculo_p pls_cp_cta_filtro_prest.ie_tipo_vinculo%type, nr_seq_classificacao_p pls_cp_cta_filtro_prest.nr_seq_classificacao%type, nr_seq_grupo_prest_p pls_cp_cta_filtro_prest.nr_seq_grupo_prestador%type, nr_seq_prestador_p pls_cp_cta_filtro_prest.nr_seq_prestador%type, nr_seq_tipo_prest_p pls_cp_cta_filtro_prest.nr_seq_tipo_prestador%type, cd_especial_prest_p pls_cp_cta_filtro_prest.cd_especialidade_prest%type, ie_cooperado_p pls_cp_cta_filtro_prest.ie_cooperado%type, cd_prestador_p pls_cp_cta_filtro_prest.cd_prestador%type, ds_campos_p out text, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE


dados_restricao_w	varchar(2500);
ds_restricao_prest_w	varchar(2500);
ds_alias_w		varchar(10);
ds_campos_w 		varchar(500);


BEGIN
-- Inicializar o retorno

dados_restricao_w := null;
ds_restricao_prest_w := null;
ds_alias_w := 'prest';
ds_campos_w := null;

dados_restricao_w := dados_restricao_w || ' and exists( select 1 ' || pls_util_pck.enter_w ||
					'  		from	pls_prestador ' || ds_alias_w || pls_util_pck.enter_w;
					
-- monta a restricao inicial de acordo com o tipo do prestador

case(ie_tipo_prestador_p)

	when 'E' then
	
		dados_restricao_w := dados_restricao_w || '		where 	' || ds_alias_w || '.nr_sequencia = ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_prestador_exec ' || pls_util_pck.enter_w;
	when 'A' then
	
		dados_restricao_w := dados_restricao_w || '		where 	' || ds_alias_w || '.nr_sequencia = ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('protocolo') || '.nr_seq_prestador ' || pls_util_pck.enter_w;
	when 'S' then
	
		dados_restricao_w := dados_restricao_w || '		where 	' || ds_alias_w || '.nr_sequencia = ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_prestador_solic_ref ' || pls_util_pck.enter_w;
	else
		dados_restricao_w := null;
end case;

-- vinculo do prestador

if (ie_tipo_vinculo_p IS NOT NULL AND ie_tipo_vinculo_p::text <> '') then

	ds_restricao_prest_w :=	ds_restricao_prest_w || '	and	' || ds_alias_w || '.ie_tipo_vinculo = :ie_tipo_vinculo_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':ie_tipo_vinculo_pc', ie_tipo_vinculo_p, valor_bind_p);
end if;

-- Classificacao do prestador

if (nr_seq_classificacao_p IS NOT NULL AND nr_seq_classificacao_p::text <> '') then
	
	ds_restricao_prest_w :=	ds_restricao_prest_w || '	and	' || ds_alias_w || '.nr_seq_classificacao = :nr_seq_classificacao_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_classificacao_pc', nr_seq_classificacao_p, valor_bind_p);
end if;

-- Grupo de prestadores

if (nr_seq_grupo_prest_p IS NOT NULL AND nr_seq_grupo_prest_p::text <> '') then
	
	ds_restricao_prest_w := ds_restricao_prest_w || '	and	(select count(1) ' || pls_util_pck.enter_w ||
							' 		from table(pls_grupos_pck.obter_prestadores_grupo( ' || pls_util_pck.enter_w ||
							' 		:nr_seq_grupo_prest_pc, ' || ds_alias_w || '.nr_sequencia))) > 0 ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(':nr_seq_grupo_prest_pc', nr_seq_grupo_prest_p, valor_bind_p);
end if;

-- Seq prestador

if (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '') then
	
	ds_restricao_prest_w :=	ds_restricao_prest_w || '	and	' || ds_alias_w || '.nr_sequencia = :nr_seq_prestador_pc' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_prestador_pc', nr_seq_prestador_p, valor_bind_p);
end if;

-- Seq prestador

if (cd_prestador_p IS NOT NULL AND cd_prestador_p::text <> '') then
	
	ds_restricao_prest_w :=	ds_restricao_prest_w || '	and	' || ds_alias_w || '.cd_prestador = :cd_prestador_pc' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':cd_prestador_pc', cd_prestador_p, valor_bind_p);
end if;

-- Tipo de prestador

if (nr_seq_tipo_prest_p IS NOT NULL AND nr_seq_tipo_prest_p::text <> '') then

	ds_restricao_prest_w :=	ds_restricao_prest_w || '	and	' || ds_alias_w || '.nr_seq_tipo_prestador = :nr_seq_tipo_prest_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_tipo_prest_pc', nr_seq_tipo_prest_p, valor_bind_p);
end if;

-- Especialidade prestador

if (cd_especial_prest_p IS NOT NULL AND cd_especial_prest_p::text <> '') then
	
	ds_restricao_prest_w :=	ds_restricao_prest_w || '	and exists(	select	1 ' || pls_util_pck.enter_w ||
							'		from	pls_prestador_med_espec espec ' || pls_util_pck.enter_w ||
							'		where	espec.nr_seq_prestador = ' || ds_alias_w || '.nr_sequencia ' || pls_util_pck.enter_w ||
							'		and	espec.cd_especialidade = :cd_especial_prest_pc ' || pls_util_pck.enter_w ||
							'		and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.dt_atendimento_referencia between '||
									' espec.dt_inicio_vigencia_ref and espec.dt_fim_vigencia_ref ) ';
	valor_bind_p := sql_pck.bind_variable(	':cd_especial_prest_pc', cd_especial_prest_p, valor_bind_p);
end if;

-- Prestador cooperado (so e valido para prestador executor)

if (ie_cooperado_p = 'S') and (ie_tipo_prestador_p = 'E') then
	
	ds_campos_w := ds_campos_w  || ', ' || pls_util_pck.enter_w ||
			' pls_obter_se_cooperado_ativo(' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.cd_medico_executor, '||
			pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.dt_atendimento_referencia, ''X'', ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') ||
			'.nr_sequencia) ie_cooperado ';
else
	ds_campos_w := ds_campos_w  || ', ' || pls_util_pck.enter_w || '''S'' ie_cooperado ';
end if;

-- verifica se existe algum filtro que utiliza o exists, caso NAO existir devolve como null

if (ds_restricao_prest_w IS NOT NULL AND ds_restricao_prest_w::text <> '') then

	dados_restricao_w := dados_restricao_w || ds_restricao_prest_w || ' ) ' || pls_util_pck.enter_w;
else
	dados_restricao_w := null;
end if;

-- atribui valor as variaveis out

ds_campos_p := ds_campos_w;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_filtro_regra_preco_cta_pck.obter_restricao_prestador ( ie_tipo_prestador_p pls_cp_cta_filtro_prest.ie_tipo_prestador%type, ie_tipo_vinculo_p pls_cp_cta_filtro_prest.ie_tipo_vinculo%type, nr_seq_classificacao_p pls_cp_cta_filtro_prest.nr_seq_classificacao%type, nr_seq_grupo_prest_p pls_cp_cta_filtro_prest.nr_seq_grupo_prestador%type, nr_seq_prestador_p pls_cp_cta_filtro_prest.nr_seq_prestador%type, nr_seq_tipo_prest_p pls_cp_cta_filtro_prest.nr_seq_tipo_prestador%type, cd_especial_prest_p pls_cp_cta_filtro_prest.cd_especialidade_prest%type, ie_cooperado_p pls_cp_cta_filtro_prest.ie_cooperado%type, cd_prestador_p pls_cp_cta_filtro_prest.cd_prestador%type, ds_campos_p out text, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
