-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_filtro_regra_preco_cta_pck.obter_restricao_intercambio ( ie_tipo_tabela_p pls_cp_cta_filtro_interc.ie_tipo_tabela%type, ie_tipo_intercambio_p pls_cp_cta_filtro_interc.ie_tipo_intercambio%type, ie_tipo_contrato_p pls_cp_cta_filtro_interc.ie_tipo_contrato%type, nr_seq_grupo_inter_p pls_cp_cta_filtro_interc.nr_seq_grupo_intercambio%type, nr_seq_intercambio_p pls_cp_cta_filtro_interc.nr_seq_intercambio%type, sg_uf_operadora_inter_p pls_cp_cta_filtro_interc.sg_uf_operadora_intercambio%type, nr_seq_prest_inter_p pls_cp_cta_filtro_interc.nr_seq_prest_inter%type, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE


dados_restricao_w	varchar(500);
ds_restricao_inter_w	varchar(2500);
ds_alias_w		varchar(10);


BEGIN

ds_alias_w := 'inter';

-- Inicializar o retorno

dados_restricao_w := '	and	exists(select	1 ' || pls_util_pck.enter_w||
		'			from	pls_conta_intercambio_v ' || ds_alias_w || pls_util_pck.enter_w||
		'			where	' || ds_alias_w || '.nr_sequencia = ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_sequencia ' || pls_util_pck.enter_w;

-- Tipo tabela de intercambio

if (ie_tipo_tabela_p IS NOT NULL AND ie_tipo_tabela_p::text <> '') then
	
	null;
end if;

-- Tipo de intercambio

-- so restringe caso seja diferente de ambos

if (ie_tipo_intercambio_p != 'A') then

	ds_restricao_inter_w := ds_restricao_inter_w || '	and	' || ds_alias_w || '.ie_tipo_intercambio = :ie_tipo_intercambio_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':ie_tipo_intercambio_pc', ie_tipo_intercambio_p, valor_bind_p);
end if;

-- Tipo contrato de intercambio

if (ie_tipo_contrato_p IS NOT NULL AND ie_tipo_contrato_p::text <> '') then

	ds_restricao_inter_w := ds_restricao_inter_w || '	and	' || ds_alias_w || '.ie_tipo_contrato = :ie_tipo_contrato_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':ie_tipo_contrato_pc', ie_tipo_contrato_p, valor_bind_p);
end if;

-- Grupo de intercambio

if (nr_seq_grupo_inter_p IS NOT NULL AND nr_seq_grupo_inter_p::text <> '') then

	ds_restricao_inter_w := ds_restricao_inter_w || '	and exists(select	1' || pls_util_pck.enter_w ||
						'		from	pls_segurado x ' || pls_util_pck.enter_w ||
						'		where	x.nr_sequencia = ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_segurado ' || pls_util_pck.enter_w ||
						'		and	x.nr_seq_grupo_intercambio = :nr_seq_grupo_inter_pc) '|| pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_grupo_inter_pc', nr_seq_grupo_inter_p, valor_bind_p);
end if;

-- Seq intercambio

if (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then

	ds_restricao_inter_w := ds_restricao_inter_w || '	and exists(select	1' || pls_util_pck.enter_w ||
						'		from	pls_segurado x ' || pls_util_pck.enter_w ||
						'		where	x.nr_sequencia = ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_segurado ' || pls_util_pck.enter_w ||
						'		and	x.nr_seq_intercambio = :nr_seq_intercambio_pc) '|| pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_intercambio_pc', nr_seq_intercambio_p, valor_bind_p);
end if;

-- Estado da operadora

if (sg_uf_operadora_inter_p IS NOT NULL AND sg_uf_operadora_inter_p::text <> '') then

	ds_restricao_inter_w := ds_restricao_inter_w || '	and	' || ds_alias_w || '.sg_estado_congenere = :sg_uf_operadora_inter_pc ' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':sg_uf_operadora_inter_pc', sg_uf_operadora_inter_p, valor_bind_p);
end if;

-- Prestador de intercambio

if (nr_seq_prest_inter_p IS NOT NULL AND nr_seq_prest_inter_p::text <> '') then

	-- como e um filtro que e feito na pls_conta coloco ele no inicio e concateno no fim o resto da restricao.

	ds_restricao_inter_w := '	and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_prestador_inter = :nr_seq_prest_inter_pc ' || pls_util_pck.enter_w ||
				ds_restricao_inter_w;
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_prest_inter_pc', nr_seq_prest_inter_p, valor_bind_p);
end if;

-- se entrou em algum filtro completa a restricao, caso contrario retorna como null

if (ds_restricao_inter_w IS NOT NULL AND ds_restricao_inter_w::text <> '') then
	
	ds_restricao_inter_w := dados_restricao_w || ds_restricao_inter_w || ' ) ';
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_filtro_regra_preco_cta_pck.obter_restricao_intercambio ( ie_tipo_tabela_p pls_cp_cta_filtro_interc.ie_tipo_tabela%type, ie_tipo_intercambio_p pls_cp_cta_filtro_interc.ie_tipo_intercambio%type, ie_tipo_contrato_p pls_cp_cta_filtro_interc.ie_tipo_contrato%type, nr_seq_grupo_inter_p pls_cp_cta_filtro_interc.nr_seq_grupo_intercambio%type, nr_seq_intercambio_p pls_cp_cta_filtro_interc.nr_seq_intercambio%type, sg_uf_operadora_inter_p pls_cp_cta_filtro_interc.sg_uf_operadora_intercambio%type, nr_seq_prest_inter_p pls_cp_cta_filtro_interc.nr_seq_prest_inter%type, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
