-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_filtro_regra_preco_cta_pck.obter_restricao_reg_selecao ( ie_considera_selecao_p boolean, ie_tipo_regra_p pls_cp_cta_combinada.ie_tipo_regra%type, nr_id_transacao_p pls_oc_cta_selecao_ocor_v.nr_id_transacao%type, ie_excecao_p pls_cp_cta_filtro.ie_excecao%type, nr_seq_filtro_p pls_cp_cta_filtro.nr_sequencia%type, ds_campo_p out text, ds_tabela_p out text, valor_bind_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE


ds_restricao_w		varchar(1000);


BEGIN

ds_restricao_w := ds_restricao_w || 	' and ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('selecao') || '.nr_id_transacao = :nr_id_transacao_pc' || pls_util_pck.enter_w;
valor_bind_p := sql_pck.bind_variable(	':nr_id_transacao_pc', nr_id_transacao_p, valor_bind_p);

-- se for regra ou filtro de EXECAO, seleciona somente o que estiver marcado com o ie_excecao

if (ie_excecao_p = 'S') then
	ds_restricao_w := ds_restricao_w || ' and ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('selecao') || '.ie_excecao = ''S''' || pls_util_pck.enter_w;
else
	-- aplica a filtragem pelo filtro

	ds_restricao_w := 	ds_restricao_w || ' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('selecao') || '.nr_seq_filtro = :nr_seq_filtro_pc' || pls_util_pck.enter_w;
	valor_bind_p := sql_pck.bind_variable(	':nr_seq_filtro_pc', nr_seq_filtro_p, valor_bind_p);
end if;

ds_restricao_w := 	ds_restricao_w || ' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('selecao') || '.ie_valido = ''S''' || pls_util_pck.enter_w;

-- se for material, faz o join com material

-- se for participante, faz o join com participante

-- qualquer outra coisa e procedimento

if (ie_tipo_regra_p = 'M') then
	ds_restricao_w := 	ds_restricao_w || ' and ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('selecao') || '.nr_seq_conta_mat = ' ||
				pls_filtro_regra_preco_cta_pck.obter_alias_tabela('material') || '.nr_sequencia' || pls_util_pck.enter_w;
				
elsif (ie_tipo_regra_p = 'PP') then
	ds_restricao_w := 	ds_restricao_w || ' and ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('selecao') || '.nr_seq_proc_partic = ' ||
				pls_filtro_regra_preco_cta_pck.obter_alias_tabela('participante') || '.nr_sequencia' || pls_util_pck.enter_w;

else
	ds_restricao_w := 	ds_restricao_w || ' and ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('selecao') || '.nr_seq_conta_proc = ' ||
				pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_sequencia' || pls_util_pck.enter_w;
end if;


-- so restringe os registros com a tabela de selecao se for para considerar a selecao

if (ie_considera_selecao_p = true) then

	ds_tabela_p := ds_tabela_p || ', ' || pls_util_pck.enter_w ||
			'	pls_cp_cta_selecao ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('selecao');
	ds_campo_p := ds_campo_p || ', ' || pls_util_pck.enter_w ||
			pls_filtro_regra_preco_cta_pck.obter_alias_tabela('selecao') || '.nr_sequencia nr_seq_selecao ';
	
else
	ds_tabela_p := null;
	ds_campo_p := ds_campo_p || 	', '|| pls_util_pck.enter_w ||
					' (select	max(' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('selecao') || '.nr_sequencia)' || pls_util_pck.enter_w ||
					'   from 	pls_cp_cta_selecao ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('selecao') || pls_util_pck.enter_w ||
					'   where	1 = 1' || pls_util_pck.enter_w ||
					ds_restricao_w || ') nr_seq_selecao ';
					
	-- zera a restricao pois a mesma NAO deve ser retornada quando for fazer select via campo

	ds_restricao_w := null;
end if;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_filtro_regra_preco_cta_pck.obter_restricao_reg_selecao ( ie_considera_selecao_p boolean, ie_tipo_regra_p pls_cp_cta_combinada.ie_tipo_regra%type, nr_id_transacao_p pls_oc_cta_selecao_ocor_v.nr_id_transacao%type, ie_excecao_p pls_cp_cta_filtro.ie_excecao%type, nr_seq_filtro_p pls_cp_cta_filtro.nr_sequencia%type, ds_campo_p out text, ds_tabela_p out text, valor_bind_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
