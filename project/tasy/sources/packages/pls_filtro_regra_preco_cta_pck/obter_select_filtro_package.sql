-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_filtro_regra_preco_cta_pck.obter_select_filtro ( ie_considera_selecao_p boolean, ie_somente_regra_vinc_p text, ie_destino_regra_p text, ie_tipo_regra_p pls_cp_cta_combinada.ie_tipo_regra%type, nr_id_transacao_p pls_cp_cta_selecao.nr_id_transacao%type, ie_excecao_p pls_cp_cta_filtro.ie_excecao%type, nr_seq_filtro_p pls_cp_cta_filtro.nr_sequencia%type, dt_inicio_vigencia_p pls_cp_cta_combinada.dt_inicio_vigencia%type, dt_fim_vigencia_p pls_cp_cta_combinada.dt_fim_vigencia%type, nr_seq_lote_conta_p pls_protocolo_conta.nr_seq_lote%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ds_campo_filtro_p text, ds_tabela_p text, ds_restricao_filtro_p text, valor_bind_p INOUT sql_pck.t_dado_bind, ie_modo_alimenta_campo_nulo_p text default 'N') AS $body$
DECLARE


_ora2pg_r RECORD;
ds_select_w			varchar(20000);
ds_restricao_padrao_w		varchar(4000);
ds_restricao_reg_sel_w		varchar(2000);
ie_tipo_despesa_in_w		varchar(50);
ds_campo_sel_w			varchar(500);
ds_tabela_sel_w			varchar(60);
ds_tabela_vinc_regra_w		varchar(60);
ds_restricao_vinc_regra_w	varchar(400);
ie_filtro_status_partic_w	varchar(50);


BEGIN
-- inicia a variavel como null

ds_select_w := null;
-- obtem os filtros que sao padrao da selecao

valor_bind_p := pls_filtro_regra_preco_cta_pck.obter_restricao_padrao(	ie_tipo_regra_p, dt_inicio_vigencia_p, dt_fim_vigencia_p, nr_seq_lote_conta_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_conta_mat_p, nr_seq_analise_p, cd_estabelecimento_p, valor_bind_p);

-- se for apontado que a valorizacao de pacotes deve ser feita para OPS - Regras e criterios de preco

ie_tipo_despesa_in_w := null;
ie_filtro_status_partic_w := null;

-- se o modo NAO for de alimentar campos nulos

-- alimentar campos nulos deve pegar somente as restricoes padrao

if (ie_modo_alimenta_campo_nulo_p = 'N') then
	
	-- status do participante

	ie_filtro_status_partic_w := ' and ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('participante') || '.ie_status in (''G'', ''L'', ''P'', ''U'')' || pls_util_pck.enter_w;
	
	-- servicos

	if (ie_tipo_regra_p = 'S') then
		ie_tipo_despesa_in_w := '''2'', ''3''';
		
	-- procedimentos e participantes

	elsif (ie_tipo_regra_p in ('P', 'PP')) then

		-- se for para considerar pacotes

		if (current_setting('pls_filtro_regra_preco_cta_pck.ie_calculo_pacote_w')::pls_parametros.ie_calculo_pacote%type = 'R') then
			ie_tipo_despesa_in_w := '''1'', ''4''';
		else
			ie_tipo_despesa_in_w := '''1''';
		end if;
	end if;

	-- tratamento para filtro de exists da tabela de selecao

	-- isso e feito para considerar somente os registros que estao na tabela de selecao

	ds_restricao_reg_sel_w := ds_restricao_reg_sel_w || SELECT * FROM pls_filtro_regra_preco_cta_pck.obter_restricao_reg_selecao(	ie_considera_selecao_p, ie_tipo_regra_p, nr_id_transacao_p, ie_excecao_p, nr_seq_filtro_p, valor_bind_p) INTO STRICT _ora2pg_r;
 ds_campo_sel_w := _ora2pg_r.ds_campo_p; ds_tabela_sel_w := _ora2pg_r.ds_tabela_p; valor_bind_p := _ora2pg_r.valor_bind_p;
												
	-- obtem as restricoes relacionadas as tabelas de regras (se existem ou NAO e se existem e NAO tem valor											

	ds_restricao_vinc_regra_w := ds_restricao_vinc_regra_w || ds_tabela_vinc_regra_w := pls_filtro_regra_preco_cta_pck.obter_restricao_vinc_regra(	ie_somente_regra_vinc_p, ie_destino_regra_p, ie_tipo_regra_p);
												
else
	-- status do participante

	ie_filtro_status_partic_w :=' and ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('participante') || '.ie_status  is null' || pls_util_pck.enter_w;
	-- todos os tipos de despesa

	ie_tipo_despesa_in_w := '''1'', ''2'', ''3'', ''4''';
end if;

-- monta o select de acordo com o tipo de regra

case(ie_tipo_regra_p)
	-- Procedimento

	when 'P' then
		
		ds_select_w := 	' select ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_seq_conta,'|| pls_util_pck.enter_w ||
				'	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_sequencia nr_seq_conta_proc,'|| pls_util_pck.enter_w ||
				'	null	nr_seq_conta_mat,' || pls_util_pck.enter_w ||
				'	null	nr_seq_partic ' || 
				ds_campo_sel_w ||
				ds_campo_filtro_p || pls_util_pck.enter_w ||
				' from	pls_protocolo_conta ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('protocolo') || ',' || pls_util_pck.enter_w ||
				'	pls_conta ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || ',' || pls_util_pck.enter_w ||
				'	pls_conta_proc ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') ||
				ds_tabela_sel_w ||
				ds_tabela_p ||
				ds_tabela_vinc_regra_w || pls_util_pck.enter_w ||
				' where	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_protocolo = ' ||
					     pls_filtro_regra_preco_cta_pck.obter_alias_tabela('protocolo') || '.nr_sequencia ' || pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.ie_status in (''A'', ''F'', ''L'', ''P'', ''U'')' || pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_seq_conta = '||
					     pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_sequencia'|| pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.ie_tipo_despesa in (' || ie_tipo_despesa_in_w || ') ' || pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.ie_status in (''A'', ''C'', ''L'', ''P'', ''S'', ''U'')' || pls_util_pck.enter_w ||
				ds_restricao_padrao_w ||
				ds_restricao_filtro_p ||
				ds_restricao_reg_sel_w ||
				ds_restricao_vinc_regra_w;				
	-- Material			

	when 'M' then
	
		ds_select_w := 	' select ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('material') || '.nr_seq_conta,'|| pls_util_pck.enter_w ||
				'	null nr_seq_proc,'|| pls_util_pck.enter_w ||
				'	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('material') || '.nr_sequencia nr_seq_conta_mat,'|| pls_util_pck.enter_w ||
				'	null	nr_seq_partic '||
				ds_campo_sel_w ||
				ds_campo_filtro_p || pls_util_pck.enter_w ||
				' from	pls_protocolo_conta ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('protocolo') || ',' || pls_util_pck.enter_w ||
				'	pls_conta ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || ',' || pls_util_pck.enter_w ||
				'	pls_conta_mat ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('material') ||
				ds_tabela_sel_w ||
				ds_tabela_p ||
				ds_tabela_vinc_regra_w || pls_util_pck.enter_w ||
				' where	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_protocolo = ' ||
					     pls_filtro_regra_preco_cta_pck.obter_alias_tabela('protocolo') || '.nr_sequencia '|| pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.ie_status in (''A'', ''F'', ''L'', ''P'', ''U'')' || pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('material') || '.nr_seq_conta = '||
					     pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_sequencia'|| pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('material') || '.ie_status in (''A'', ''C'', ''L'', ''P'', ''S'', ''U'')' || pls_util_pck.enter_w ||
				ds_restricao_padrao_w ||
				ds_restricao_filtro_p ||
				ds_restricao_reg_sel_w ||
				ds_restricao_vinc_regra_w;
	-- servico

	when 'S' then
		
		ds_select_w := 	' select ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_seq_conta,'|| pls_util_pck.enter_w ||
				'	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_sequencia nr_seq_proc,'|| pls_util_pck.enter_w ||
				'	null	nr_seq_conta_mat,'|| pls_util_pck.enter_w ||
				'	null	nr_seq_partic '||
				ds_campo_sel_w ||
				ds_campo_filtro_p || pls_util_pck.enter_w ||
				' from	pls_protocolo_conta ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('protocolo') || ',' || pls_util_pck.enter_w ||
				'	pls_conta ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || ',' || pls_util_pck.enter_w ||
				'	pls_conta_proc ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') ||
				ds_tabela_sel_w ||
				ds_tabela_p ||
				ds_tabela_vinc_regra_w || pls_util_pck.enter_w ||
				' where	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_protocolo = ' ||
					     pls_filtro_regra_preco_cta_pck.obter_alias_tabela('protocolo') || '.nr_sequencia '|| pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.ie_status in (''A'', ''F'', ''L'', ''P'', ''U'')' || pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_seq_conta = ' ||
					     pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_sequencia' || pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.ie_tipo_despesa in (' || ie_tipo_despesa_in_w || ') ' || pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.ie_status in (''A'', ''C'', ''L'', ''P'', ''S'', ''U'')' || pls_util_pck.enter_w ||
				ds_restricao_padrao_w ||
				ds_restricao_filtro_p ||
				ds_restricao_reg_sel_w ||
				ds_restricao_vinc_regra_w;

	-- Participante do procedimento

	when 'PP' then
		
		ds_select_w := 	' select ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_seq_conta,'|| pls_util_pck.enter_w ||
				'	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_sequencia nr_seq_proc,'|| pls_util_pck.enter_w ||
				'	null	nr_seq_conta_mat,'|| pls_util_pck.enter_w ||
				'	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('participante') || '.nr_sequencia nr_seq_partic ' ||
				ds_campo_sel_w ||
				ds_campo_filtro_p || pls_util_pck.enter_w ||
				' from	pls_protocolo_conta ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('protocolo') || ',' || pls_util_pck.enter_w ||
				'	pls_conta ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || ',' || pls_util_pck.enter_w ||
				'	pls_conta_proc ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || ',' || pls_util_pck.enter_w ||
				'	pls_proc_participante ' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('participante') ||
				ds_tabela_sel_w ||
				ds_tabela_p || pls_util_pck.enter_w ||
				' where	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_seq_protocolo = ' ||
					     pls_filtro_regra_preco_cta_pck.obter_alias_tabela('protocolo') || '.nr_sequencia '|| pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.ie_status in (''A'', ''F'', ''L'', ''P'', ''U'')' || pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.nr_seq_conta = '||
					     pls_filtro_regra_preco_cta_pck.obter_alias_tabela('conta') || '.nr_sequencia'|| pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.ie_status in (''A'', ''C'', ''L'', ''P'', ''S'', ''U'')' || pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('participante') || '.nr_seq_conta_proc = ' ||
					     pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento')||'.nr_sequencia'|| pls_util_pck.enter_w ||
				' and	' || pls_filtro_regra_preco_cta_pck.obter_alias_tabela('procedimento') || '.ie_tipo_despesa in (' || ie_tipo_despesa_in_w || ') ' || pls_util_pck.enter_w ||
				ie_filtro_status_partic_w ||
				ds_restricao_padrao_w ||
				ds_restricao_filtro_p ||
				ds_restricao_reg_sel_w ||
				ds_restricao_vinc_regra_w;
	else
		null;
end case;

-- retorna o select que foi montado

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_filtro_regra_preco_cta_pck.obter_select_filtro ( ie_considera_selecao_p boolean, ie_somente_regra_vinc_p text, ie_destino_regra_p text, ie_tipo_regra_p pls_cp_cta_combinada.ie_tipo_regra%type, nr_id_transacao_p pls_cp_cta_selecao.nr_id_transacao%type, ie_excecao_p pls_cp_cta_filtro.ie_excecao%type, nr_seq_filtro_p pls_cp_cta_filtro.nr_sequencia%type, dt_inicio_vigencia_p pls_cp_cta_combinada.dt_inicio_vigencia%type, dt_fim_vigencia_p pls_cp_cta_combinada.dt_fim_vigencia%type, nr_seq_lote_conta_p pls_protocolo_conta.nr_seq_lote%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ds_campo_filtro_p text, ds_tabela_p text, ds_restricao_filtro_p text, valor_bind_p INOUT sql_pck.t_dado_bind, ie_modo_alimenta_campo_nulo_p text default 'N') FROM PUBLIC;
