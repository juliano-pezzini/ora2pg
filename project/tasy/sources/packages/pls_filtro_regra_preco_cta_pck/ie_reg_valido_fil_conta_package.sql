-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_filtro_regra_preco_cta_pck.ie_reg_valido_fil_conta ( ie_internado_filtro_p pls_cp_cta_filtro_conta.ie_internado%type, ie_carater_inter_filtro_p pls_cp_cta_filtro_conta.ie_carater_internacao%type, qt_dias_inter_final_p pls_cp_cta_filtro_conta.qt_dias_inter_final%type, qt_dias_inter_inicio_p pls_cp_cta_filtro_conta.qt_dias_inter_inicio%type, ie_ref_guia_intern_filtro_p pls_cp_cta_filtro_conta.ie_ref_guia_internacao%type, ie_internado_p text, ie_carater_internacao_p text, cd_versao_tiss_p text, qt_dias_internacao_p bigint, ie_ref_guia_internacao_p text) RETURNS boolean AS $body$
DECLARE

	
ie_registro_valido_w boolean;


BEGIN

ie_registro_valido_w := true;

-- se for marcado para filtra  Atendimento em internacao e verificado o campo ie_internado

if (ie_internado_filtro_p = 'S') then

	if (coalesce(ie_internado_p, 'N') != 'S') then
		ie_registro_valido_w := false;
	end if;
end if;

if (ie_carater_inter_filtro_p IS NOT NULL AND ie_carater_inter_filtro_p::text <> '') then

	-- Precisa ser verificado a versao do tiss pois existe um tratamento para versao TISS >= 3.01 para alimentar o campo ie_carater_internacao na pls_gerar_conta

	if (cd_versao_tiss_p >= '3.01.00') and (ie_carater_inter_filtro_p != ie_carater_internacao_p) then
		
		ie_registro_valido_w := false;
	end if;
end if;

-- se foi informado ambos os campos e uma validacao

if (qt_dias_inter_final_p IS NOT NULL AND qt_dias_inter_final_p::text <> '') and (qt_dias_inter_inicio_p IS NOT NULL AND qt_dias_inter_inicio_p::text <> '') then

	-- se for maior que a qt final ou menor que a inicial NAO e valido

	if (qt_dias_internacao_p > qt_dias_inter_final_p) or (qt_dias_internacao_p < qt_dias_inter_inicio_p) then
		
		ie_registro_valido_w := false;
	end if;
-- se foi apenas informado a qt inicial

elsif (qt_dias_inter_inicio_p IS NOT NULL AND qt_dias_inter_inicio_p::text <> '') then
	
	-- se for menor que a qt inicial NAO e valido

	if (qt_dias_internacao_p < qt_dias_inter_inicio_p) then
	
		ie_registro_valido_w := false;
	end if;
-- se foi apenas informado a qt final

elsif (qt_dias_inter_final_p IS NOT NULL AND qt_dias_inter_final_p::text <> '') then

	-- se for maior que a qt final NAO e valido

	if (qt_dias_internacao_p > qt_dias_inter_final_p) then
	
		ie_registro_valido_w := false;
	end if;
end if;

-- verifica se tem alguma guia de internacao ligada a conta

if (ie_ref_guia_intern_filtro_p IS NOT NULL AND ie_ref_guia_intern_filtro_p::text <> '') and (ie_ref_guia_intern_filtro_p != 'A') then

	-- I se for internacao N se NAO for

	if (ie_ref_guia_intern_filtro_p != ie_ref_guia_internacao_p) then 
		
		ie_registro_valido_w := false;
	end if;
end if;

return ie_registro_valido_w;
					
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_filtro_regra_preco_cta_pck.ie_reg_valido_fil_conta ( ie_internado_filtro_p pls_cp_cta_filtro_conta.ie_internado%type, ie_carater_inter_filtro_p pls_cp_cta_filtro_conta.ie_carater_internacao%type, qt_dias_inter_final_p pls_cp_cta_filtro_conta.qt_dias_inter_final%type, qt_dias_inter_inicio_p pls_cp_cta_filtro_conta.qt_dias_inter_inicio%type, ie_ref_guia_intern_filtro_p pls_cp_cta_filtro_conta.ie_ref_guia_internacao%type, ie_internado_p text, ie_carater_internacao_p text, cd_versao_tiss_p text, qt_dias_internacao_p bigint, ie_ref_guia_internacao_p text) FROM PUBLIC;
