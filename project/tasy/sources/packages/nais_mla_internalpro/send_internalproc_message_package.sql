-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/** 
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	NAIS MLA Event - Treatment Starts Here
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	**/
CREATE OR REPLACE PROCEDURE nais_mla_internalpro.send_internalproc_message ( nr_prescricao_p bigint, cd_classif_p text, file_output_p INOUT text ) AS $body$
DECLARE

    c_order_unit varchar(100);
    nr_seq_int_call_log_w bigint :=0;
    ds_log_message_w      varchar(500);
    nr_atendimento_w cpoe_procedimento.nr_atendimento%type;

    c04 CURSOR FOR 
     SELECT distinct co.nr_order_unit order_unit
     from   cpoe_procedimento a,         
            prescr_procedimento b,
            prescr_mat_alteracao d,
            proc_interno pi,
            cpoe_order_unit co,
            cpoe_tipo_pedido cp
     where  a.nr_sequencia = b.nr_seq_proc_cpoe 
     and    pi.nr_sequencia = a.nr_seq_proc_interno
     and    b.nr_prescricao = d.nr_prescricao
     and    d.nr_seq_procedimento = b.nr_agrupamento
     and (case 
                when b.nr_prescricao = nr_prescricao_p and a.ie_record_execution = 'S' and d.ie_alteracao = 3 and d.ie_tipo_item = 'P' THEN (1)
                when d.nr_sequencia = nr_prescricao_p and d.ie_mostra_adep = 'S' and d.ie_tipo_item = 'P' then (1)
                else 0
            end) = 1
      and   co.nr_seq_cpoe_tipo_pedido   = cp.nr_sequencia
      and   co.nr_sequencia              = a.nr_seq_cpoe_order_unit
      and   cp.nr_seq_sub_grp            = 'PC'
      and   obter_conversao_externa_int(null,'PROC_INTERNO_CLASSIF','NR_SEQUENCIA', pi.nr_seq_classif, 'NAIS' ) = 'P0'
      order by co.nr_order_unit asc;

      
BEGIN
        open c04;
          loop
                fetch c04 into c_order_unit;
                EXIT WHEN NOT FOUND; /* apply on c04 */
                file_output_p := nais_mla_internalpro.send_intprofs_data(nr_prescricao_p, cd_classif_p, c_order_unit);
          end loop;
        close c04;

      END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_mla_internalpro.send_internalproc_message ( nr_prescricao_p bigint, cd_classif_p text, file_output_p INOUT text ) FROM PUBLIC;
