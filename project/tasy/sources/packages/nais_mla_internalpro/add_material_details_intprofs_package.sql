-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE nais_mla_internalpro.add_material_details_intprofs ( record_p medtreatmentinforedtyp, message_data INOUT text, nr_prescricao_p bigint, material_number_p text, ordernumber_w bigint ) AS $body$
DECLARE

    c_materialfetch CURSOR FOR
        SELECT e.cd_material,
               d.qt_dose, 
               d.CD_UNIDADE_MEDIDA_DOSE,
               d.nr_sequencia
        from
               cpoe_procedimento a,
               prescr_procedimento b,
               prescr_mat_alteracao c,
               prescr_material d,
               cpoe_material e
        where
               a.nr_sequencia = b.nr_seq_proc_cpoe
        and    d.nr_seq_mat_cpoe = e.nr_sequencia 
        and    c.nr_seq_procedimento = b.nr_agrupamento
        and    d.nr_prescricao = c.nr_prescricao
        and    d.NR_SEQUENCIA_PROC = b.nr_agrupamento
        and    b.nr_prescricao = c.nr_prescricao
        and    d.NR_SEQUENCIA_PROC = material_number_p
        and (case 
                          when b.nr_prescricao = nr_prescricao_p and a.ie_record_execution = 'S' and c.ie_alteracao = 3 and c.ie_tipo_item = 'P' THEN (1)
                          when c.nr_sequencia = nr_prescricao_p and c.ie_mostra_adep = 'S' and c.ie_tipo_item = 'P' THEN (1)
                          else 0
                     end) = 1
        order by d.NR_SEQUENCIA asc;

        record_w medtreatmentinforedtyp;
        medical_affair_code nais_conversion_master%rowtype;
        intproccode_w varchar(100);
        intprocdose_w varchar(100);
        intprocunit_w varchar(200);
        intprosequencia_w varchar(100);
        dosageinfo_w varchar(100);

BEGIN 
        PERFORM set_config('nais_mla_internalpro.ds_line_w', null, false);
        open c_materialfetch;
        loop
            fetch c_materialfetch into intproccode_w, intprocdose_w, intprocunit_w, intprosequencia_w;
            EXIT WHEN NOT FOUND; /* apply on c_materialfetch */
        dosageinfo_w := OBTER_CONVERSAO_UNIDADE_NAIS(ordernumber_w,intprosequencia_w,intprocdose_w)*1000;
        record_w := record_p;

        medical_affair_code :=get_medicalaffair_code('PC', 'CPOE_MATERIAL', 'CD_MATERIAL', intproccode_w,null,null);

        record_w.internal_code := coalesce(rpad(medical_affair_code.CD_MEDICAL_AFFAIR, 6, ' '),'000000');
        record_w.dosage := dosageinfo_w;
        record_w.unit := intprocunit_w;
        record_w.free_comments := ' ';
        CALL CALL CALL CALL nais_mla_internalpro.common_med_treatment_info(record_w);
        end loop;
        close c_materialfetch;
        message_data := current_setting('nais_mla_internalpro.ds_line_w')::varchar(32767);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nais_mla_internalpro.add_material_details_intprofs ( record_p medtreatmentinforedtyp, message_data INOUT text, nr_prescricao_p bigint, material_number_p text, ordernumber_w bigint ) FROM PUBLIC;
