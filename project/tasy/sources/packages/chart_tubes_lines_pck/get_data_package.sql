-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION chart_tubes_lines_pck.get_data ( code_group_p text, nr_seq_pepo_p bigint, nr_cirurgia_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text, dt_atendimento_p timestamp, ie_em_andamento_p text, ie_tipo_ativacao_p text, nr_seq_episodio_p bigint) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE


t_objeto_row_w			t_objeto_row;

tubes_and_lines CURSOR FOR
	SELECT	SUBSTR(b.ds_dispositivo,1,80) NAME,
			SUBSTR(Obter_Cor_Grafico_Dispositivo(nr_seq_dispositivo,'S'),1,30) COLOR,
			a.dt_instalacao,
			(clock_timestamp() + interval '8640 seconds') end_date,
			a.nr_sequencia code_chart,
			b.nr_seq_apres,
			a.dt_retirada dt_fim,
			coalesce(a.ie_sucesso,'S') ie_sucesso,
			a.nr_atendimento nr_Atendimento,
			a.nr_cirurgia nr_cirurgia,
			a.nr_seq_pepo nr_seq_pepo,
			coalesce(b.ie_permite_disp_alta,'N') ie_permite_disp_alta,
			obter_se_exibe_graf_disp(a.nr_sequencia) ie_exige_disp_grafico
	FROM   	dispositivo b,
			atend_pac_dispositivo a
	WHERE 	a.nr_seq_dispositivo = b.nr_sequencia
	AND		((coalesce(ie_em_andamento_p,'N') = 'N') OR (coalesce(ie_em_andamento_p,'N') = 'S' AND (coalesce(a.dt_retirada::text, '') = '')))
	AND (ie_tipo_ativacao_p	=	'C')
	and		a.nr_cirurgia = nr_cirurgia_p
	
UNION

	SELECT	SUBSTR(b.ds_dispositivo,1,80) NAME,
			SUBSTR(Obter_Cor_Grafico_Dispositivo(nr_seq_dispositivo,'S'),1,30) COLOR,
			a.dt_instalacao,
			(clock_timestamp() + interval '8640 seconds') end_date,
			a.nr_sequencia code_chart,
			b.nr_seq_apres,
			a.dt_retirada dt_fim,
			coalesce(a.ie_sucesso,'S') ie_sucesso,
			a.nr_atendimento nr_Atendimento,
			a.nr_cirurgia nr_cirurgia,
			a.nr_seq_pepo nr_seq_pepo,
			coalesce(b.ie_permite_disp_alta,'N') ie_permite_disp_alta,
			obter_se_exibe_graf_disp(a.nr_sequencia) ie_exige_disp_grafico
	FROM   	dispositivo b,
			atend_pac_dispositivo a
	WHERE 	a.nr_seq_dispositivo = b.nr_sequencia
	AND (ie_tipo_ativacao_p	=	'PC')
	AND   	((coalesce(ie_em_andamento_p,'N') = 'N') OR (coalesce(ie_em_andamento_p,'N') = 'S' AND (coalesce(a.dt_retirada::text, '') = '')))
	and		a.nr_seq_pepo = nr_seq_pepo_p
	
UNION

	SELECT	SUBSTR(b.ds_dispositivo,1,80) NAME,
			SUBSTR(Obter_Cor_Grafico_Dispositivo(nr_seq_dispositivo,'S'),1,30) COLOR,
			a.dt_instalacao,
			(clock_timestamp() + interval '8640 seconds') end_date,
			a.nr_sequencia code_chart,
			b.nr_seq_apres,
			a.dt_retirada dt_fim,
			coalesce(a.ie_sucesso,'S') ie_sucesso,
			a.nr_atendimento nr_Atendimento,
			a.nr_cirurgia nr_cirurgia,
			a.nr_seq_pepo nr_seq_pepo,
			coalesce(b.ie_permite_disp_alta,'N') ie_permite_disp_alta,
			obter_se_exibe_graf_disp(a.nr_sequencia) ie_exige_disp_grafico
	FROM   	dispositivo b,
			atend_pac_dispositivo a
	WHERE 	a.nr_seq_dispositivo = b.nr_sequencia
	and 	((a.nr_atendimento = nr_atendimento_p) OR (	a.nr_atendimento IN (
																				SELECT	a.nr_atendimento
																				FROM		atendimento_paciente a,
																							atend_pac_dispositivo b
																				WHERE		b.nr_atendimento 			= a.nr_atendimento
																				AND 		a.cd_pessoa_fisica	 	= cd_pessoa_fisica_p
																				AND		a.cd_estabelecimento 	= coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1)
																				AND		(a.dt_alta IS NOT NULL AND a.dt_alta::text <> '')
																				AND 		obter_se_dispo_usado_paciente(a.nr_atendimento) = 'S'
																				AND 		coalesce(b.dt_retirada,clock_timestamp()) >= dt_atendimento_p
															)
															AND coalesce(b.ie_permite_disp_alta,'N') = 'S'
														))
	AND   	((coalesce(ie_em_andamento_p,'N') = 'N') OR (coalesce(ie_em_andamento_p,'N') = 'S' AND (coalesce(a.dt_retirada::text, '') = '')))
	AND (ie_tipo_ativacao_p	=	'A')
	
UNION

	SELECT	SUBSTR(b.ds_dispositivo,1,80) NAME,
			SUBSTR(Obter_Cor_Grafico_Dispositivo(nr_seq_dispositivo,'S'),1,30) COLOR,
			a.dt_instalacao,
			(clock_timestamp() + interval '8640 seconds') end_date,
			a.nr_sequencia code_chart,
			b.nr_seq_apres,
			a.dt_retirada dt_fim,
			coalesce(a.ie_sucesso,'S') ie_sucesso,
			a.nr_atendimento nr_Atendimento,
			a.nr_cirurgia nr_cirurgia,
			a.nr_seq_pepo nr_seq_pepo,
			coalesce(b.ie_permite_disp_alta,'N') ie_permite_disp_alta,
			obter_se_exibe_graf_disp(a.nr_sequencia) ie_exige_disp_grafico
	FROM   	dispositivo b,
			atend_pac_dispositivo a,
			atendimento_paciente c
	WHERE 	a.nr_seq_dispositivo 	= b.nr_sequencia
	AND		a.nr_atendimento 		= c.nr_atendimento
	AND (ie_tipo_ativacao_p	= 'P')
	AND		c.cd_pessoa_fisica		= cd_pessoa_fisica_p
	AND   	((coalesce(ie_em_andamento_p,'N') = 'N') OR (coalesce(ie_em_andamento_p,'N') = 'S' AND (coalesce(a.dt_retirada::text, '') = '')))
	
UNION

	SELECT	SUBSTR(b.ds_dispositivo,1,80) NAME,
			SUBSTR(Obter_Cor_Grafico_Dispositivo(nr_seq_dispositivo,'S'),1,30) COLOR,
			a.dt_instalacao,
			(clock_timestamp() + interval '8640 seconds') end_date,
			a.nr_sequencia code_chart,
			b.nr_seq_apres,
			a.dt_retirada dt_fim,
			coalesce(a.ie_sucesso,'S') ie_sucesso,
			a.nr_atendimento nr_Atendimento,
			a.nr_cirurgia nr_cirurgia,
			a.nr_seq_pepo nr_seq_pepo,
			coalesce(b.ie_permite_disp_alta,'N') ie_permite_disp_alta,
			obter_se_exibe_graf_disp(a.nr_sequencia) ie_exige_disp_grafico
	FROM   	dispositivo b,
			atend_pac_dispositivo a,
			atendimento_paciente c,
			episodio_paciente d
	WHERE 	a.nr_seq_dispositivo 	= b.nr_sequencia
	AND		a.nr_atendimento 		= c.nr_atendimento
	and		c.nr_seq_episodio		= d.nr_sequencia
	AND (ie_tipo_ativacao_p	= 'EP')
	AND		d.nr_sequencia			= nr_seq_episodio_p
	AND   	((coalesce(ie_em_andamento_p,'N') = 'N') OR (coalesce(ie_em_andamento_p,'N') = 'S' AND (coalesce(a.dt_retirada::text, '') = '')))
	AND		coalesce(c.dt_alta::text, '') = '';



equipment CURSOR FOR
	SELECT 	SUBSTR(d.ds_equipamento,1,80) NAME,
			SUBSTR(obter_dados_equipamento(c.cd_equipamento,'COR','S'),1,30) COLOR,
			c.dt_inicio dt_instalacao,
			(clock_timestamp() + interval '8640 seconds') end_date,
			c.nr_sequencia code_chart,
			1 nr_seq_apres,
			c.dt_fim dt_fim,
			'S' ie_sucesso,
			c.nr_atendimento nr_Atendimento,
			c.nr_cirurgia nr_cirurgia,
			c.nr_seq_pepo nr_seq_pepo,
			NULL ie_permite_disp_alta
	FROM equipamento d, equipamento_cirurgia c
LEFT OUTER JOIN cirurgia e ON (c.nr_cirurgia = e.nr_cirurgia)
WHERE c.cd_equipamento = d.cd_equipamento  AND coalesce(obter_dados_equipamento(c.cd_equipamento,'GD'),'S') = 'S' AND ((coalesce(ie_em_andamento_p,'N') = 'N') OR (coalesce(ie_em_andamento_p,'N') = 'S' AND (coalesce(c.dt_fim::text, '') = ''))) AND (c.dt_inicio IS NOT NULL AND c.dt_inicio::text <> '') and ((ie_tipo_ativacao_p	= 'C' AND c.nr_cirurgia = nr_cirurgia_p) or
			 (ie_tipo_ativacao_p	= 'PC' AND c.nr_seq_pepo = nr_seq_pepo_p) or
			 (ie_tipo_ativacao_p	= 'A' AND c.nr_atendimento = nr_atendimento_p) or
			 (ie_tipo_ativacao_p	= 'P' AND e.cd_pessoa_fisica = cd_pessoa_fisica_p) or
			 ((ie_tipo_ativacao_p	= 'EP') and (coalesce(c.nr_atendimento, e.nr_atendimento) in (	SELECT 	x.nr_atendimento
																		from 	atendimento_paciente x,
																				episodio_paciente y
																		where 	x.nr_seq_episodio = y.nr_sequencia
																		and 	y.nr_sequencia = nr_seq_episodio_p))));

BEGIN

t_objeto_row_w.code_group 	:= code_group_p;
t_objeto_row_w.style 		:= 'lines';
t_objeto_row_w.qt_size 		:= 10;
t_objeto_row_w.shaded 		:= 'true';
t_objeto_row_w.fixed_scale 	:= 0;

IF (code_group_p = 'D') THEN
	FOR r_c01 IN tubes_and_lines LOOP
		BEGIN

		IF (r_c01.ie_exige_disp_grafico	= 'S') THEN
			t_objeto_row_w.name 					:= r_c01.name;
			t_objeto_row_w.color 					:= r_c01.color;
			t_objeto_row_w.dt_instalacao 			:= r_c01.dt_instalacao;
			t_objeto_row_w.end_date 				:= r_c01.end_date;
			t_objeto_row_w.code_chart 				:= r_c01.code_chart;
			t_objeto_row_w.nr_seq_apres 			:= r_c01.nr_seq_apres;
			t_objeto_row_w.dt_fim 					:= r_c01.dt_fim;
			t_objeto_row_w.ie_sucesso 				:= r_c01.ie_sucesso;
			t_objeto_row_w.nr_atendimento 			:= r_c01.nr_atendimento;
			t_objeto_row_w.nr_cirurgia 				:= r_c01.nr_cirurgia;
			t_objeto_row_w.nr_seq_pepo 				:= r_c01.nr_seq_pepo;
			t_objeto_row_w.ie_permite_disp_alta 	:= r_c01.ie_permite_disp_alta;

			RETURN NEXT t_objeto_row_w;

		END IF;

		END;
	END LOOP;

ELSIF (code_group_p = 'E') THEN

	FOR r_c02 IN equipment LOOP
		BEGIN
		t_objeto_row_w.name 					:= r_c02.name;
		t_objeto_row_w.color 					:= r_c02.color;
		t_objeto_row_w.dt_instalacao 			:= r_c02.dt_instalacao;
		t_objeto_row_w.end_date 				:= r_c02.end_date;
		t_objeto_row_w.code_chart 				:= r_c02.code_chart;
		t_objeto_row_w.nr_seq_apres 			:= r_c02.nr_seq_apres;
		t_objeto_row_w.dt_fim 					:= r_c02.dt_fim;
		t_objeto_row_w.ie_sucesso 				:= r_c02.ie_sucesso;
		t_objeto_row_w.nr_atendimento 			:= r_c02.nr_atendimento;
		t_objeto_row_w.nr_cirurgia 				:= r_c02.nr_cirurgia;
		t_objeto_row_w.nr_seq_pepo 				:= r_c02.nr_seq_pepo;
		t_objeto_row_w.ie_permite_disp_alta 	:= r_c02.ie_permite_disp_alta;

		RETURN NEXT t_objeto_row_w;
		END;
	END LOOP;


END IF;

RETURN;


END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION chart_tubes_lines_pck.get_data ( code_group_p text, nr_seq_pepo_p bigint, nr_cirurgia_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text, dt_atendimento_p timestamp, ie_em_andamento_p text, ie_tipo_ativacao_p text, nr_seq_episodio_p bigint) FROM PUBLIC;
