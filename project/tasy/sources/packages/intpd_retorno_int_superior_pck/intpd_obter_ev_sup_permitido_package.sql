-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION intpd_retorno_int_superior_pck.intpd_obter_ev_sup_permitido ( nr_seq_evento_p bigint) RETURNS SETOF T_EVENTO_SUPERIOR AS $body$
DECLARE


r_evento_superior_row_w	r_evento_superior_row;
ie_evento_w		intpd_eventos.ie_evento%type;
ie_ish_w	varchar(1);

/*
81 - check natural person
12 - send natural person

104 - check patient's episode
106 - Send patient's episode

117 - check outpatient care
120 - send outpatient care

108 - check patient episode transactions
130 - check patient transaction
118 - send patient transactions

84 - check diagnosis
82 - send diagnosis

131 - consult insurance information of the patient encounter
135 - send insurance information of the patient encounter

105 - check performed procedures
110 - check performed services
54 - send patient procedure

119 - check patient discharge
114 - send patient discharge

12 - enviar pessoa física (superior)
214 - enviar atendimento do paciente (filha)

180 - enviar reserva da agenda de exames (superior)
148 - enviar solicitação de exames de imagem (filha)

214 - enviar atendimento do paciente (superior)
161 - enviar cargos do episodio (filha)

*/
c01 CURSOR FOR
SELECT	ie_evento_origem,
	ds_evento_origem,
	ie_evento_superior,
	ds_evento_superior
from	(	
SELECT	a.ie_evento ie_evento_origem,
	substr(obter_valor_dominio(8187, a.ie_evento),1,255) ds_evento_origem,
	b.ie_evento ie_evento_superior,
	substr(obter_valor_dominio(8187, b.ie_evento),1,255) ds_evento_superior
from	intpd_config_eventos a,
	intpd_config_eventos b
where	1 = 1
and (	(a.ie_evento = '214' and b.ie_evento in ('12')) or (a.ie_evento = '148' and b.ie_evento in ('180')) or (a.ie_evento = '81' and b.ie_evento in ('12')) or (a.ie_evento = '161' and b.ie_evento in ('214')) or (a.ie_evento = '12' and b.ie_evento in ('81')) or (a.ie_evento = '104' and b.ie_evento in ('81','12','106','127','120','117')) or (a.ie_evento = '106' and b.ie_evento in ('81','12','104','127','106','120','117','220')) or (a.ie_evento = '127' and b.ie_evento in ('81','12','104','106','120','117')) or (a.ie_evento = '253' and b.ie_evento in ('81','12','104','127','106','117')) or (a.ie_evento = '117' and b.ie_evento in ('81','12','104','127','106','120','117')) or (a.ie_evento = '120' and b.ie_evento in ('81','12','104','127','106','117')) or (a.ie_evento = '108' and b.ie_evento in ('81','12','104','127','106','117','120','130','118')) or (a.ie_evento = '130' and b.ie_evento in ('81','12','104','127','106','117','120','108','118')) or (a.ie_evento = '118' and b.ie_evento in ('81','12','104','127','106','117','120','108','130')) or (a.ie_evento = '195' and b.ie_evento in ('81','12','104','127','106','117','120','108','130','118')) or (a.ie_evento = '185' and b.ie_evento in ('81','12','104','127','106','117','120','108','130','118')) or (a.ie_evento = '190' and b.ie_evento in ('81','12','104','127','106','117','120','108')) or (a.ie_evento =  '84' and b.ie_evento in ('81','12','104','127','106','108','130','118','82','117')) or (a.ie_evento =  '82' and b.ie_evento in ('81','12','104','127','106','108','130','118','84','82','117')) or (a.ie_evento = '131' and b.ie_evento in ('81','12','104','127','106','135','117')) or (a.ie_evento = '135' and b.ie_evento in ('81','12','104','127','106','131','117')) or (a.ie_evento = '105' and b.ie_evento in ('81','12','104','127','106','117','120','131','135','54')) or (a.ie_evento = '110' and b.ie_evento in ('81','12','104','127','106','117','120','131','135','54')) or (a.ie_evento = '54' and b.ie_evento in ('81','12','104','127','106','117','120','131','135','105','110')) or (a.ie_evento = '119' and b.ie_evento in ('81','12','104','127','106','117','120','131','135','105','110','54','114')) or (a.ie_evento = '114' and b.ie_evento in ('81','12','104','127','106','117','120','131','135','105','110','54','119','402')) or (a.ie_evento = '402' and b.ie_evento in ('81','12','104','127','106','117','120','131','135','105','110','54','119','402')) or (a.ie_evento = '360' and b.ie_evento in ('81','12','104','127','106','117','120','135')) or (a.ie_evento = '362' and b.ie_evento in ('81','12','104','127','106','117','120','131')) or (a.ie_evento = '401' and b.ie_evento in ('106','82','54')) or (a.ie_evento = '403' and b.ie_evento in ('127','135')) or (a.ie_evento = '220' and b.ie_evento in ('127')))

union all

select	ie_evento_w ie_evento_origem,
	substr(obter_valor_dominio(8187, ie_evento_w),1,255) ds_evento_origem,
	a.ie_evento ie_evento_superior,
	substr(obter_valor_dominio(8187, a.ie_evento),1,255) ds_evento_superior
from	intpd_eventos a,
	intpd_eventos_sistema b
where	a.nr_sequencia = b.nr_seq_evento
and	obter_se_integracao_ish(b.nr_seq_projeto_xml) = 'S'
and	b.ie_situacao = 'A'
and	a.ie_situacao = 'A'
and	ie_ish_w = 'S') alias74
where	ie_evento_origem = ie_evento_w
group by	ie_evento_origem,
	ds_evento_origem,
	ie_evento_superior,
	ds_evento_superior
order by	ds_evento_origem,
	ds_evento_superior;

c01_w	c01%rowtype;




BEGIN

select	ie_evento
into STRICT	ie_evento_w
from	intpd_eventos
where	nr_sequencia = nr_seq_evento_p;

begin
select	'S'
into STRICT	ie_ish_w
from	intpd_eventos_sistema
where	nr_seq_evento = nr_seq_evento_p
and	obter_se_integracao_ish(nr_seq_projeto_xml) = 'S'
and	ie_situacao = 'A'  LIMIT 1;
exception
when others then
	ie_ish_w	:=	'N';
end;

open c01;
loop
fetch c01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	r_evento_superior_row_w.ie_evento	:=	c01_w.ie_evento_superior;
	RETURN NEXT r_evento_superior_row_w;
	end;
end loop;
close c01;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION intpd_retorno_int_superior_pck.intpd_obter_ev_sup_permitido ( nr_seq_evento_p bigint) FROM PUBLIC;
