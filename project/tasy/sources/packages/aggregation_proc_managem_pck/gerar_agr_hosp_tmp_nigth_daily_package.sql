-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE aggregation_proc_managem_pck.gerar_agr_hosp_tmp_nigth_daily (nr_seq_daily_report_p agreg_surgery_information.nr_seq_main_daily_rep%type ,cd_estabelecimento_p establishment_locale.cd_estabelecimento%type ,ie_main_flag_p agreg_surgery_information.ie_main_flag%type ,nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


cd_ward_w           agreg_hosp_temp_nigth.cd_ward%type;
dt_referencia_w     timestamp;
nr_sequencia_w      bigint;
ie_classification_w agreg_hosp_temp_nigth.ie_classification%type;

c01 CURSOR FOR
SELECT cir.cd_pessoa_fisica cd_patient
      ,obter_idade_pf(atp.cd_pessoa_fisica, clock_timestamp(), 'A') qt_age
      ,obter_sexo_pf(atp.cd_pessoa_fisica, 'C'/*'D'*/) ie_gender
      ,apu.cd_unidade_basica cd_room
from   cirurgia cir
      ,atend_paciente_unidade apu
      ,atendimento_paciente atp
where atp.nr_atendimento            = apu.nr_atendimento
and   apu.nr_atendimento            = cir.nr_atendimento
and   apu.cd_setor_atendimento      = cir.cd_setor_atendimento
and   establishment_timezone_utils.startOfDay(apu.dt_entrada_unidade) = dt_referencia_w
and   cir.cd_estabelecimento        = cd_estabelecimento_p;

BEGIN
  dt_referencia_w := trunc(clock_timestamp()) - 2;--1;
  
  -- obter setor de atendimento
  select max(cd_ward)
  into STRICT   cd_ward_w
  from   agreg_main_daily_reports
  where  nr_sequencia       = nr_seq_daily_report_p
  and    cd_estabelecimento = cd_estabelecimento_p;
  
  -- verificar a regra de negocio para ver se vai gravar na tabela o conteudo 5 ou 6
  if 1 = 1 then
    ie_classification_w := '5';
  else
    ie_classification_w := '6';
  end if;

  for r01 in c01
  loop
    select nextval('agreg_hosp_temp_nigth_seq')
    into STRICT   nr_sequencia_w
;

    insert into agreg_hosp_temp_nigth(nr_sequencia
           ,dt_atualizacao
           ,nm_usuario
           ,nm_usuario_nrec
           ,dt_atualizacao_nrec
           ,nr_seq_main_daily_rep
           ,dt_target
           ,cd_ward
           ,ie_classification
           ,cd_patient
           ,qt_age
           ,ie_gender
           ,dt_leave_hospital
           ,dt_come_back_hospital
           ,cd_room
           ,ie_main_flag )
    values (nr_sequencia_w
           ,clock_timestamp()
           ,nm_usuario_p
           ,nm_usuario_p
           ,clock_timestamp()
           ,nr_seq_daily_report_p
           ,clock_timestamp()
           ,cd_ward_w
           ,ie_classification_w
           ,r01.cd_patient
           ,r01.qt_age
           ,r01.ie_gender
           ,clock_timestamp() -- verificar ?? ORA-01400: nao e possivel inserir NULL em ("TASY"."AGREG_HOSP_TEMP_NIGTH"."DT_LEAVE_HOSPITAL")
           ,clock_timestamp() -- verificar ?? ORA-01400: nao e possivel inserir NULL em ("TASY"."AGREG_HOSP_TEMP_NIGTH"."DT_COME_BACK_HOSPITAL")
           ,r01.cd_room
           ,ie_main_flag_p );
  end loop;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aggregation_proc_managem_pck.gerar_agr_hosp_tmp_nigth_daily (nr_seq_daily_report_p agreg_surgery_information.nr_seq_main_daily_rep%type ,cd_estabelecimento_p establishment_locale.cd_estabelecimento%type ,ie_main_flag_p agreg_surgery_information.ie_main_flag%type ,nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
