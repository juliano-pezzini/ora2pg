-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE aggregation_proc_managem_pck.gerar_number_patient_dep (NR_SEQ_DAILY_REPORT_P bigint, CD_ESTABELECIMENTO_P bigint, IE_MAIN_FLAG_P bigint,nm_usuario_p AGREG_NUMBER_PATIENT.NM_USUARIO%TYPE) AS $body$
DECLARE


CD_WARD_W                   bigint;
CD_DEPARTMENT_W             bigint;
IE_EXIST_W                  bigint;
QT_CURRENT_PATIENTS_HOSP_W  bigint;


BEGIN

  -- OBTER SETOR DE ATENDIMENTO
  SELECT MAX(CD_WARD)
    INTO STRICT CD_WARD_W
  FROM AGREG_MAIN_DAILY_REPORTS
  WHERE NR_SEQUENCIA = NR_SEQ_DAILY_REPORT_P
  AND CD_ESTABELECIMENTO = CD_ESTABELECIMENTO_P;

  CD_DEPARTMENT_W := OBTER_DEPARTAMENTO_SETOR(CD_WARD_W);

  --VALIDA SE JA FOI GERADO O REGISTRO NO DIA, CASO JA EXISTIR O REGISTRO, 
  --ELE DEVERA SER DELETADO PARA QUE SEJA GERADO O NOVO REGISTRO ATUALIZADO
  SELECT COUNT(*)
    INTO STRICT IE_EXIST_W
  FROM AGREG_NUMBER_PATIENT_DEP
  WHERE TRUNC(DT_TARGET) = TRUNC(clock_timestamp()) 
  AND CD_WARD = CD_WARD_W;

  IF (IE_EXIST_W > 0) THEN
    DELETE from AGREG_NUMBER_PATIENT_DEP
    WHERE TRUNC(DT_TARGET) = TRUNC(clock_timestamp())
    AND CD_WARD = CD_WARD_W;
  END IF;

  --OBTER QUANTIDADE DE PACIENTES INTERNADOS
  SELECT MAX(NR_UNIDADES_OCUPADAS)
    INTO STRICT  QT_CURRENT_PATIENTS_HOSP_W
  FROM TOTAL_OCUPACAO_SETORES_V2 A, DEPARTAMENTO_MEDICO DM
  WHERE CD_ESTABELECIMENTO_BASE = CD_ESTABELECIMENTO_P
  AND DM.CD_DEPARTAMENTO = CD_DEPARTMENT_W
  AND A.CD_SETOR_ATENDIMENTO = CD_WARD_W;

  IF (NR_SEQ_DAILY_REPORT_P > 0 ) THEN
    INSERT INTO AGREG_NUMBER_PATIENT_DEP(
      NR_SEQUENCIA,
      DT_ATUALIZACAO,
      NM_USUARIO,
      NM_USUARIO_NREC,
      DT_ATUALIZACAO_NREC,
      NR_SEQ_MAIN_DAILY_REP,
      DT_TARGET,
      CD_WARD,
      CD_DEPARTMENT,
      QT_CURRENT_PATIENTS,
      IE_MAIN_FLAG) VALUES (
        nextval('agreg_number_patient_dep_seq'),
        clock_timestamp(),
        nm_usuario_p,
        nm_usuario_p,
        clock_timestamp(),
        NR_SEQ_DAILY_REPORT_P,
        clock_timestamp(),
        CD_WARD_W,
        CD_DEPARTMENT_W,
        QT_CURRENT_PATIENTS_HOSP_W,
        IE_MAIN_FLAG_P
      );
  END IF;
COMMIT;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aggregation_proc_managem_pck.gerar_number_patient_dep (NR_SEQ_DAILY_REPORT_P bigint, CD_ESTABELECIMENTO_P bigint, IE_MAIN_FLAG_P bigint,nm_usuario_p AGREG_NUMBER_PATIENT.NM_USUARIO%TYPE) FROM PUBLIC;
