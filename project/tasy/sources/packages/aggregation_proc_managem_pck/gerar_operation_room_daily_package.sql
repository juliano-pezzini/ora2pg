-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE aggregation_proc_managem_pck.gerar_operation_room_daily (NR_SEQ_DAILY_REPORT_P bigint, CD_ESTABELECIMENTO_P bigint, IE_MAIN_FLAG_P bigint,nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


    CD_DEPARTMENT_W             DEPARTAMENTO_SETOR.CD_DEPARTAMENTO%TYPE;
    IE_CLASSIFICATION_W         AGREG_PAT_OPERATION_ROOM.NR_SEQ_SHIFT_CATEGORY%type;
    CD_WARD_W                   bigint;
    CD_PATIENT_W                ATENDIMENTO_PACIENTE.CD_PESSOA_FISICA%TYPE;
    QT_AGE_W                    bigint;
    IE_GENDER_W                 varchar(10);
    DT_SURGERY_START_W          AGREG_PAT_OPERATION_ROOM.DT_SURGERY_START%TYPE;
    DT_SURGERY_END_W            AGREG_PAT_OPERATION_ROOM.DT_SURGERY_END%TYPE;
    DT_ROOM_ENTRY_W             AGREG_PAT_OPERATION_ROOM.DT_ROOM_ENTRY%TYPE;
    DT_ROOM_DEPARTURE_W         AGREG_PAT_OPERATION_ROOM.DT_ROOM_DEPARTURE%TYPE;
    DS_SURGERY_W                AGREG_PAT_OPERATION_ROOM.DS_SURGERY%TYPE;
    IE_INPATIENT_OUTPATIENT_W   AGREG_PAT_OPERATION_ROOM.IE_INPATIENT_OUTPATIENT%TYPE;


BEGIN 
	begin
        select 
            C.CD_SETOR_ATENDIMENTO,
            C.CD_PESSOA_FISICA,
            OBTER_IDADE_PF(AP.CD_PESSOA_FISICA, clock_timestamp(), 'A'),
            OBTER_SEXO_PF(AP.CD_PESSOA_FISICA, 'D'),
            C.DT_INICIO_REAL,
            to_date(C.DT_INICIO_REAL + (C.NR_MIN_DURACAO_PREV / 1440),'DD/MM/YYYY HH24:MI:SS'),
            C.DT_ENTRADA_UNIDADE,
            C.DT_SAIDA_SALA,
            substr(obter_exame_agenda(C.cd_procedimento_princ, C.ie_origem_proced, C.nr_seq_proc_interno),1,240),
            AP.IE_TIPO_ATENDIMENTO
        into STRICT
            CD_WARD_W,
            CD_PATIENT_W,
            QT_AGE_W,
            IE_GENDER_W,
            DT_SURGERY_START_W,
            DT_SURGERY_END_W,
            DT_ROOM_ENTRY_W,
            DT_ROOM_DEPARTURE_W,
            DS_SURGERY_W,
            IE_INPATIENT_OUTPATIENT_W
        from CIRURGIA C,
            ATEND_PACIENTE_UNIDADE APU,
            ATENDIMENTO_PACIENTE AP
        where C.CD_ESTABELECIMENTO     = CD_ESTABELECIMENTO_P
            AND TRUNC(APU.DT_ENTRADA_UNIDADE) = TRUNC(clock_timestamp() - interval '1 days')
            AND C.NR_ATENDIMENTO       = APU.NR_ATENDIMENTO
            AND C.CD_SETOR_ATENDIMENTO = APU.CD_SETOR_ATENDIMENTO
            AND APU.NR_ATENDIMENTO     = AP.NR_ATENDIMENTO  LIMIT 1;
		EXCEPTION
	    	WHEN no_data_found THEN
	    		return;
		END;
      CD_DEPARTMENT_W := OBTER_DEPARTAMENTO_SETOR(CD_WARD_W);
      IE_CLASSIFICATION_W := obter_operation_shift_catagory(DT_SURGERY_START_W,CD_ESTABELECIMENTO_P);

     IF (NR_SEQ_DAILY_REPORT_P > 0)THEN

        INSERT INTO AGREG_PAT_OPERATION_ROOM(
            NR_SEQUENCIA,
            DT_ATUALIZACAO,
            NM_USUARIO,
            DT_ATUALIZACAO_NREC,
            NM_USUARIO_NREC,
            NR_SEQ_MAIN_DAILY_REP,
            DT_TARGET,
            CD_DEPARTMENT,
            NR_SEQ_SHIFT_CATEGORY,
            CD_PATIENT,
            QT_AGE,
            IE_GENDER,
            DT_SURGERY_START,
            DT_SURGERY_END,
            DT_ROOM_ENTRY,
            DT_ROOM_DEPARTURE,
            DS_SURGERY,
            IE_INPATIENT_OUTPATIENT,
            IE_MAIN_FLAG)
              VALUES (
                nextval('agreg_pat_operation_room_seq'),
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
				nm_usuario_p,
                NR_SEQ_DAILY_REPORT_P,
                clock_timestamp(),
                CD_DEPARTMENT_W,
                IE_CLASSIFICATION_W,
                CD_PATIENT_W,
                QT_AGE_W,
                IE_GENDER_W,
                DT_SURGERY_START_W,
                DT_SURGERY_END_W,
                DT_ROOM_ENTRY_W,
                coalesce(DT_ROOM_DEPARTURE_W,DT_SURGERY_END_W),
                DS_SURGERY_W,
                IE_INPATIENT_OUTPATIENT_W,
                IE_MAIN_FLAG_P);
     END IF;
COMMIT;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aggregation_proc_managem_pck.gerar_operation_room_daily (NR_SEQ_DAILY_REPORT_P bigint, CD_ESTABELECIMENTO_P bigint, IE_MAIN_FLAG_P bigint,nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
