-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION spinal_pck.get_value (value_p text) RETURNS varchar AS $body$
DECLARE

		ds_retorn_w	varchar(4000);
		
BEGIN
		
		if ((header_json_w.get(value_p) IS NOT NULL AND (header_json_w.get(value_p))::text <> '')) then
			ds_retorn_w	:= header_json_w.get[value_p].get_string();
		end if;
		
		return ds_retorn_w;
		end;

	begin

	begin
	select	nm_user_spinal,
		cd_profile_spinal,
		cd_estab_spinal,
		cd_department_spinal,
		cd_spec_med_spinal,
		ds_locale_spinal
	into STRICT	nm_user_spinal_w,
		cd_profile_spinal_w,
		cd_estab_spinal_w,
		cd_department_spinal_w,
		cd_spec_med_spinal_w,
		ds_locale_spinal_w
	from	spinal_tasy_config LIMIT 1;
	exception
	when others then
		null;
	end;

	if (coalesce(trim(both ds_header_p),'XPTO') <> 'XPTO') then

		header_json_w 	:= philips_json_parser.parser(ds_header_p);		

		CALL wheb_usuario_pck.set_informacoes_usuario(
					spinal_pck.get_value('tasy-function'),
					coalesce(spinal_pck.get_value('tasy-profile'), cd_profile_spinal_w),
					coalesce(spinal_pck.get_value('tasy-establishment'), cd_estab_spinal_w),
					coalesce(spinal_pck.get_value('tasy-encounter-department'), cd_department_spinal_w),
					coalesce(spinal_pck.get_value('tasy-user'), nm_user_spinal_w),
					spinal_pck.get_value('tasy-idiom'),
					spinal_pck.get_value('tasy-form'),
					spinal_pck.get_value('tasy-machine-name'),
					spinal_pck.get_value('tasy-machine-ip'));

		CALL wheb_usuario_pck.set_cd_especialidade(coalesce(spinal_pck.get_value('tasy-specialty'), cd_spec_med_spinal_w));
		CALL wheb_usuario_pck.set_ie_atualizacao_contabil(spinal_pck.get_value('tasy-update-ledger-account'));
		CALL wheb_usuario_pck.set_ie_commit(spinal_pck.get_value('tasy-commit'));
		CALL wheb_usuario_pck.set_ie_executar_trigger(spinal_pck.get_value('tasy-execute-trigger'));
		CALL wheb_usuario_pck.set_ie_lote_contabil(spinal_pck.get_value('tasy-accounting-batch'));
		CALL wheb_usuario_pck.set_nm_estacao(spinal_pck.get_value('tasy-station-name'));

		CALL pkg_i18n.set_info(	coalesce(spinal_pck.get_value('tasy-user-locale'),ds_locale_spinal_w),
					spinal_pck.get_value('tasy-user-language'),
					spinal_pck.get_value('tasy-user-calendar'),
					spinal_pck.get_value('tasy-user-secondary-calendar'),
					spinal_pck.get_value('tasy-user-timezone'),
					spinal_pck.get_value('tasy-establishment-first-week-day'),
					spinal_pck.get_value('tasy-establishment-locale'),
					spinal_pck.get_value('tasy-establishment-calendar'),
					spinal_pck.get_value('tasy-establishment-secondary-calendar'),
					spinal_pck.get_value('tasy-establishment-timezone'),
					spinal_pck.get_value('tasy-establishment-currency'));


		dbms_application_info.set_client_info(coalesce(spinal_pck.get_value('tasy-user'), nm_user_spinal_w));
		dbms_application_info.set_module(spinal_pck.get_value('tasy-module-name'), spinal_pck.get_value('tasy-action-name'));

		CALL philips_param_pck.set_cd_pais(spinal_pck.get_value('tasy-country'));
		CALL philips_param_pck.set_ds_locale(spinal_pck.get_value('tasy-locale'));
		CALL philips_param_pck.set_nr_seq_idioma(spinal_pck.get_value('tasy-idiom'));

	else
		CALL wheb_usuario_pck.set_informacoes_usuario( null, cd_profile_spinal_w, cd_estab_spinal_w, cd_department_spinal_w, nm_user_spinal_w, null, null, null, null);

		CALL pkg_i18n.set_user_locale(ds_locale_spinal_w);
		CALL wheb_usuario_pck.set_cd_especialidade(cd_spec_med_spinal_w);
		dbms_application_info.set_client_info(nm_user_spinal_w);

	end if;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION spinal_pck.get_value (value_p text) FROM PUBLIC;
