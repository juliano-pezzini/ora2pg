-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE spinal_pck.read_response () AS $body$
BEGIN

		begin
		dbms_lob.createtemporary(response_content_w, TRUE);
		loop
			utl_http.read_line(res_w, buffer_w);
			response_content_w := substr(response_content_w||buffer_w,1,32000);
		end loop;
		exception
		when utl_http.end_of_body then
			null;
		end;

		utl_http.end_response(res_w);

		response_json_w 	:= philips_json_parser.parser(response_content_w);
		if ((response_json_w.get('error') IS NOT NULL AND (response_json_w.get('error'))::text <> '')) or (res_w.status_code <> '200') then
			ie_success_w := false;
			update 	spinal_messages
			set 	ds_status 	= 'ERROR',
				ds_fail_reponse	= 'Status Code:'||res_w.status_code||' Reason Phrase:'||res_w.reason_phrase||
						'Error: '||response_json_w.get['error'].get_string()||' - Path: '||response_json_w.get['path'].get_string(),
				qt_attempt	= qt_attempt + 1,
				dt_last_attempt	= clock_timestamp()
			where 	message_id 	= spinalmessage_id_p;
		else
			ie_success_w := true;
			delete from spinal_messages where message_id = spinalmessage_id_p;
		end if;

		dbms_lob.freetemporary(response_content_w);

		END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE spinal_pck.read_response () FROM PUBLIC;
