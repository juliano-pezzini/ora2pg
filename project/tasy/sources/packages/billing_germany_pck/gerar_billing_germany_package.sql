-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

----------------------------------------------------------------------
CREATE OR REPLACE FUNCTION billing_germany_pck.gerar_billing_germany () RETURNS SETOF T_BILLING_GERMANY_DATA AS $body$
DECLARE


	linha_w   	t_linha;
	trailler_w   	varchar(1000);
	max_unh_0062_w	bigint;

	c01 CURSOR FOR
        SELECT	unb		||'+'||
		unb_s001_0001	||':'||
		unb_s001_0002	||'+'||
		unb_s002_0004	||'+'||
		unb_s003_0010	||'+'||
		unb_s004_0017	||':'||
		unb_s004_0019	||':'||
		unb_s004_0020	||'+'||
		unb_s005_0026	||'''' 	linha
		,'0'		unh_0062
	from table(billing_germany_pck.gerar_header_billing_germany()) header
	
union

	SELECT	unh		||'+'||
		unh_0062	||'+'||
		unh_s009_0065	||':'||
		unh_s009_0052	||':'||
		unh_s009_0054	||':'||
		unh_s009_0051	||'+'||
		unt		||'+'||
		unt_0074	||'+'||
		unt_0062	||'''' 	linha
		,unh_0062
	from table(billing_germany_pck.gerar_dataset_billing_germany()) dataset;

	r_C01 	C01%rowtype;


	
BEGIN

	-- Identificar o último UNH.
	max_unh_0062_w := 0;
	select max((unh_0062)::numeric )
	into STRICT max_unh_0062_w
	from  table(billing_germany_pck.gerar_dataset_billing_germany()) dataset2;

	open C01;
	loop
	fetch C01 into r_C01;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		linha_w.linha	:=	r_C01.linha;

		-- Se o registro corrente for o último
		if max_unh_0062_w = (r_c01.unh_0062)::numeric  then
			select	unz		||'+'||
				unz_0036	||'+'||
				unz_0020	||'''' 	linha
			into STRICT trailler_w
			from table(billing_germany_pck.gerar_trailler_billing_germany()) trailler;
			--
			linha_w.linha := linha_w.linha || trailler_w;
		end if;
		RETURN NEXT linha_w;
	end loop;
	close C01;

	return;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION billing_germany_pck.gerar_billing_germany () FROM PUBLIC;
