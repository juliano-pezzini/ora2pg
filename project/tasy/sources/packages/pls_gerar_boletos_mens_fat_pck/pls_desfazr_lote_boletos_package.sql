-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerar_boletos_mens_fat_pck.pls_desfazr_lote_boletos ( nr_seq_lote_p pls_lote_boleto.nr_sequencia%type, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


	nr_seq_lote_grupo_w			bigint;
	current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_boleto_w')::pls_boleto.nr_sequencia%type				bigint;
	current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_boleto_banda_w')::pls_boleto_banda.nr_sequencia%type			bigint;
	nr_seq_boleto_banda_info_w		bigint;

	C01 CURSOR FOR
		SELECT	nr_sequencia
		from	pls_lote_boleto_grupo
		where	nr_seq_lote	= nr_seq_lote_p;

	C02 CURSOR FOR
		SELECT	nr_sequencia
		from	pls_boleto
		where	nr_seq_lote_grupo	= nr_seq_lote_grupo_w;

	C03 CURSOR FOR
		SELECT	nr_sequencia
		from	pls_boleto_banda
		where	nr_seq_boleto		= current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_boleto_w')::pls_boleto.nr_sequencia%type;

	C04 CURSOR FOR
		SELECT	nr_sequencia
		from	pls_boleto_banda_info
		where	nr_seq_boleto_banda	= current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_boleto_banda_w')::pls_boleto_banda.nr_sequencia%type;

	
BEGIN

	/*Setar o usu√°rio e estabelecimento*/

	CALL CALL CALL CALL CALL CALL CALL CALL pls_gerar_boletos_mens_fat_pck.set_nm_usuario(nm_usuario_p);
	CALL CALL CALL CALL CALL CALL CALL CALL CALL pls_gerar_boletos_mens_fat_pck.set_cd_estabelecimento(cd_estabelecimento_p);

	open C01;
	loop
	fetch C01 into
		nr_seq_lote_grupo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		open C02;
		loop
		fetch C02 into
			current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_boleto_w')::pls_boleto.nr_sequencia%type;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			open C03;
			loop
			fetch C03 into
				current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_boleto_banda_w')::pls_boleto_banda.nr_sequencia%type;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin

				open C04;
				loop
				fetch C04 into
					nr_seq_boleto_banda_info_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin

					delete	FROM pls_boleto_banda_info
					where	nr_sequencia	= nr_seq_boleto_banda_info_w;

					end;
				end loop;
				close C04;

				delete	FROM pls_boleto_banda
				where	nr_sequencia	= current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_boleto_banda_w')::pls_boleto_banda.nr_sequencia%type;

				end;
			end loop;
			close C03;

			delete	FROM pls_boleto
			where	nr_sequencia	= current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_boleto_w')::pls_boleto.nr_sequencia%type;

			end;
		end loop;
		close C02;

		delete	FROM pls_lote_boleto_grupo
		where	nr_sequencia	= nr_seq_lote_grupo_w;

		end;
	end loop;
	close C01;

	update	pls_lote_boleto
	set	dt_inicio_geracao		 = NULL,
		dt_fim_geracao			 = NULL,
		nr_seq_regra_ordem		 = NULL,
		nr_seq_regra_distribuicao	 = NULL,
		nm_atributos_ordem		= ''
	where	nr_sequencia		= nr_seq_lote_p;

	end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_boletos_mens_fat_pck.pls_desfazr_lote_boletos ( nr_seq_lote_p pls_lote_boleto.nr_sequencia%type, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
