-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


CREATE TYPE campos AS (	coluna			varchar(5000) , coluna_group_by	varchar(5000),
				coluna_valor		varchar(5000), nr_seq_informacao	pls_tipo_informacao_boleto.nr_sequencia%type,
				nr_seq_estru_agrup	pls_estrut_banda_bol_info.nr_sequencia%type,
				nr_coluna_agrup		pls_estrut_banda_bol_info.nr_coluna_agrup%type);


CREATE OR REPLACE PROCEDURE pls_gerar_boletos_mens_fat_pck.criar_estru_boleto_bandas ( estrutura_bol_banda_p pls_estrut_bol_banda, item_mensalidade_fatumento_p mensalidades_faturamento_rec, nr_seq_boleto_banda_p pls_boleto_banda.nr_sequencia%type) AS $body$
DECLARE


	nr_seq_estru_banda_agrup_w		pls_estrut_banda_agrup.nr_sequencia%type;
	estrut_band_bol_info_w			pls_estrut_banda_bol_info%rowtype;
	estrut_band_bol_compis_w		pls_estrut_banda_bol_info%rowtype;
	ds_sql_mensalidade_item_w		varchar(4000)	:= 	'	from	pls_mensalidade_seg_item	a,	' ||
									'	pls_mensalidade_segurado		b,	' ||
									'	pls_segurado				c,	' ||
									'	pls_plano				d	' ||
									'	where	a.nr_seq_mensalidade_seg	= b.nr_sequencia	' ||
									'	and	b.nr_seq_segurado		= c.nr_sequencia	' ||
									'	and	d.nr_sequencia			= b.nr_seq_plano	' ||
									'	and	b.nr_seq_mensalidade		= :nr_seq_mensalidade	';
	nr_colunas_w				bigint;
	index_w					bigint;
	ds_sql_select_w				varchar(4000);
	ds_sql_selec_info_w			varchar(4000);
	ds_enter_w				varchar(10) := chr(10);
	ds_espaco_w				varchar(10) := ' ';
	ds_groupby_select_w			varchar(4000);
	ds_char_1_w				varchar(100);

	c001					integer;
	var_retorno_w				integer;
	ds_comando_c001_w			varchar(4000);
	retorno_w				integer;
	nm_coluna_w				varchar(4000);

	ie_tipo_item_w				varchar(10);
	ds_tipos_itens_w			varchar(4000);
	type campos_coluna_v is table of  campos index by integer;
	camps_coluna_w			campos_coluna_v;

	C01 CURSOR FOR
		SELECT	nr_sequencia
		from	pls_estrut_banda_agrup
		where	nr_seq_estrut_banda	= estrutura_bol_banda_p.nr_sequencia
		order by nr_ordem;

	C02 CURSOR FOR
		SELECT	nr_sequencia,
			ie_agrupamento,
			nr_seq_informacao,
			ds_conteudo_ant,
			ds_conteudo_pos,
			nr_coluna_agrup
		from	pls_estrut_banda_bol_info
		where	nr_seq_estrut_agrup	= nr_seq_estru_banda_agrup_w
		and	coalesce(nr_seq_composicao::text, '') = '';

	C03 CURSOR FOR
		SELECT	nr_seq_informacao,
			ds_conteudo_ant,
			ds_conteudo_pos
		from	pls_estrut_banda_bol_info
		where	nr_seq_composicao	= estrut_band_bol_info_w.nr_sequencia
		order by nr_ordem;

	C04 CURSOR FOR
		SELECT	ie_tipo_item
		from	pls_estrut_banda_item
		where	nr_seq_estrut_agrup	= nr_seq_estru_banda_agrup_w;

	
BEGIN

	open C01;
	loop
	fetch C01 into
		nr_seq_estru_banda_agrup_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		ds_sql_select_w		:= 'select	';
		nr_colunas_w		:= 0;
		ds_tipos_itens_w	:= '';
		ds_groupby_select_w	:= '';

		if (camps_coluna_w.count > 0) then
			camps_coluna_w.delete;
		end if;

		open c02;
		loop
		fetch c02 into
			estrut_band_bol_info_w.nr_sequencia,
			estrut_band_bol_info_w.ie_agrupamento,
			estrut_band_bol_info_w.nr_seq_informacao,
			estrut_band_bol_info_w.ds_conteudo_ant,
			estrut_band_bol_info_w.ds_conteudo_pos,
			estrut_band_bol_info_w.nr_coluna_agrup;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin

			ds_sql_selec_info_w	:= '';

			if (estrut_band_bol_info_w.ie_agrupamento	= 'S') then
				ds_char_1_w	:= '';

				open c03;
				loop
				fetch c03 into
					estrut_band_bol_compis_w.nr_seq_informacao,
					estrut_band_bol_compis_w.ds_conteudo_ant,
					estrut_band_bol_compis_w.ds_conteudo_pos;
				EXIT WHEN NOT FOUND; /* apply on c03 */
					begin

					if ((pls_gerar_boletos_mens_fat_pck.obter_sql_informacao(estrut_band_bol_compis_w.nr_seq_informacao) IS NOT NULL AND (pls_gerar_boletos_mens_fat_pck.obter_sql_informacao(estrut_band_bol_compis_w.nr_seq_informacao))::text <> '')) then
						if (estrut_band_bol_compis_w.ds_conteudo_ant IS NOT NULL AND estrut_band_bol_compis_w.ds_conteudo_ant::text <> '') then
							ds_sql_selec_info_w		:= ds_sql_selec_info_w || ''''|| estrut_band_bol_compis_w.ds_conteudo_ant||'''' || ' || ';
						end if;

						if (c03%rowCount	> 1) then
							ds_char_1_w	:= ' chr(1)  || ';
						end if;

						ds_sql_selec_info_w		:= ds_sql_selec_info_w || ds_char_1_w || pls_gerar_boletos_mens_fat_pck.obter_sql_informacao(estrut_band_bol_compis_w.nr_seq_informacao) || ' || ';

						if (estrut_band_bol_compis_w.ds_conteudo_pos IS NOT NULL AND estrut_band_bol_compis_w.ds_conteudo_pos::text <> '') then
							ds_sql_selec_info_w		:= ds_sql_selec_info_w || '''' ||estrut_band_bol_compis_w.ds_conteudo_pos || '''' || ' || ';
						end if;
					end if;
					end;
				end loop;
				close c03;

				ds_sql_selec_info_w	:= substr(ds_sql_selec_info_w,1,length(ds_sql_selec_info_w)-3);
			else
				if (estrut_band_bol_info_w.ds_conteudo_ant IS NOT NULL AND estrut_band_bol_info_w.ds_conteudo_ant::text <> '') then
					ds_sql_selec_info_w		:= ds_sql_selec_info_w || ''''|| estrut_band_bol_info_w.ds_conteudo_ant||'''' || ' || ';
				end if;

				if ((pls_gerar_boletos_mens_fat_pck.obter_sql_informacao(estrut_band_bol_info_w.nr_seq_informacao) IS NOT NULL AND (pls_gerar_boletos_mens_fat_pck.obter_sql_informacao(estrut_band_bol_info_w.nr_seq_informacao))::text <> '')) then
					ds_sql_selec_info_w	:= ds_sql_selec_info_w|| pls_gerar_boletos_mens_fat_pck.obter_sql_informacao(estrut_band_bol_info_w.nr_seq_informacao);
				end if;

				if (estrut_band_bol_info_w.ds_conteudo_pos IS NOT NULL AND estrut_band_bol_info_w.ds_conteudo_pos::text <> '') then
					ds_sql_selec_info_w		:= ds_sql_selec_info_w || ' || ' ||  '''' ||estrut_band_bol_info_w.ds_conteudo_pos || '''';
				end if;
			end if;

			if (ds_sql_selec_info_w IS NOT NULL AND ds_sql_selec_info_w::text <> '') then
				nr_colunas_w		:= nr_colunas_w + 1;
				ds_sql_select_w	:= ds_sql_select_w || ds_sql_selec_info_w ||' COLUNA_'||nr_colunas_w  || ', ' || ds_enter_w;
				camps_coluna_w[nr_colunas_w].coluna		:= 'COLUNA_'||nr_colunas_w;
				camps_coluna_w[nr_colunas_w].nr_seq_informacao	:= estrut_band_bol_info_w.nr_seq_informacao;
				camps_coluna_w[nr_colunas_w].nr_seq_estru_agrup	:= estrut_band_bol_info_w.nr_sequencia;
				camps_coluna_w[nr_colunas_w].nr_coluna_agrup	:= estrut_band_bol_info_w.nr_coluna_agrup;

				if	((estrut_band_bol_info_w.nr_seq_informacao not in (17,16)) or (estrut_band_bol_info_w.ie_agrupamento = 'S')) then
					camps_coluna_w[nr_colunas_w].coluna_group_by	:= ds_sql_selec_info_w;
				else
					camps_coluna_w[nr_colunas_w].coluna_group_by	:= '';
				end if;
			end if;

			end;
		end loop;
		close c02;

		ds_sql_select_w		:= substr(ds_sql_select_w,1,length(ds_sql_select_w)-3);

		index_w	:= 0;

		ds_groupby_select_w	:= 'group by ';

		for index_w in 1..camps_coluna_w.count loop
			if (camps_coluna_w[index_w](.coluna_group_by IS NOT NULL AND .coluna_group_by::text <> '')) then
				ds_groupby_select_w	:=  ds_groupby_select_w||camps_coluna_w[index_w].coluna_group_by||',';
			end if;
		end loop;

		ds_groupby_select_w	:= substr(ds_groupby_select_w,1,length(ds_groupby_select_w)-1)|| ds_enter_w;

		open c04;
		loop
		fetch c04 into
			ie_tipo_item_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			begin

			if (coalesce(ds_tipos_itens_w::text, '') = '') then
				ds_tipos_itens_w	:= ' and a.ie_tipo_item in ( ';
			end if;

			ds_tipos_itens_w	:= ds_tipos_itens_w || ie_tipo_item_w || ',';

			end;
		end loop;
		close c04;

		if (ds_tipos_itens_w IS NOT NULL AND ds_tipos_itens_w::text <> '') then
			ds_tipos_itens_w	:= substr(ds_tipos_itens_w,1,length(ds_tipos_itens_w)-1) || ')' || ds_enter_w;
		end if;

		ds_comando_c001_w	:= ds_sql_select_w|| ds_sql_mensalidade_item_w||ds_tipos_itens_w||ds_groupby_select_w;


		c001 := dbms_sql.open_cursor;
		dbms_sql.parse(C001, ds_comando_c001_w, dbms_sql.native);
		dbms_sql.bind_variable(c001, ':nr_seq_mensalidade', item_mensalidade_fatumento_p.nr_seq_mensalidade);
		index_w	:= 0;

		for index_w in 1..camps_coluna_w.count loop
			dbms_sql.define_column(C001, index_w, camps_coluna_w[index_w].coluna_valor,4000);
		end loop;

		retorno_w := dbms_sql.execute(c001);

		loop
			var_retorno_w := dbms_sql.fetch_rows(c001);
			exit when var_retorno_w = 0;
			index_w	:= 0;
			PERFORM set_config('pls_gerar_boletos_mens_fat_pck.nr_linha_boleto_banda_w', current_setting('pls_gerar_boletos_mens_fat_pck.nr_linha_boleto_banda_w')::bigint + 1, false);
			for index_w in 1..camps_coluna_w.count loop
				dbms_sql.column_value(C001, index_w, camps_coluna_w[index_w].coluna_valor);

				insert into pls_boleto_banda_info(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
						nr_seq_boleto_banda,nr_seq_informacao,nr_linha,nr_pagina,nr_seq_estrut_info,
						nr_coluna_agrup,ds_informacao)
				values (	nextval('pls_boleto_banda_info_seq'),clock_timestamp(),get_nm_usuario,clock_timestamp(),get_nm_usuario,
						nr_seq_boleto_banda_p,camps_coluna_w[index_w].nr_seq_informacao,current_setting('pls_gerar_boletos_mens_fat_pck.nr_linha_boleto_banda_w')::bigint,0,camps_coluna_w[index_w].nr_seq_estru_agrup,
						camps_coluna_w[index_w].nr_coluna_agrup,camps_coluna_w[index_w].coluna_valor);

			end loop;
		end loop;
		dbms_sql.close_cursor(c001);

		end;
	end loop;
	close C01;

	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_boletos_mens_fat_pck.criar_estru_boleto_bandas ( estrutura_bol_banda_p pls_estrut_bol_banda, item_mensalidade_fatumento_p mensalidades_faturamento_rec, nr_seq_boleto_banda_p pls_boleto_banda.nr_sequencia%type) FROM PUBLIC;
