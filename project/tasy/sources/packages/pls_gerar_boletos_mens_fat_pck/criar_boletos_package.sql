-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerar_boletos_mens_fat_pck.criar_boletos ( item_mensalidade_fatumento_p mensalidades_faturamento_rec, nr_boleto_por_grupo_p bigint) AS $body$
BEGIN

	if (nr_boleto_por_grupo_p	> 0) then
		if (current_setting('pls_gerar_boletos_mens_fat_pck.qt_boletos_criados_w')::bigint >= nr_boleto_por_grupo_p) then

			if (current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_lote_boleto_grupo_w')::pls_lote_boleto_grupo.nr_sequencia%(type IS NOT NULL AND type::text <> '')) then
				update	pls_lote_boleto_grupo
				set	qt_boletos	= current_setting('pls_gerar_boletos_mens_fat_pck.qt_boletos_criados_w')::bigint,
					vl_titulos	= current_setting('pls_gerar_boletos_mens_fat_pck.vl_total_titulos_w')::pls_lote_boleto_grupo.vl_titulos%type,
					nr_grupo	= current_setting('pls_gerar_boletos_mens_fat_pck.nr_grupo_w')::bigint
				where	nr_sequencia	= current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_lote_boleto_grupo_w')::pls_lote_boleto_grupo.nr_sequencia%type;
			end if;

			PERFORM set_config('pls_gerar_boletos_mens_fat_pck.qt_boletos_criados_w', 0, false);
			PERFORM set_config('pls_gerar_boletos_mens_fat_pck.vl_total_titulos_w', 0, false);
			PERFORM set_config('pls_gerar_boletos_mens_fat_pck.nr_ordem_w', 0, false);
			PERFORM set_config('pls_gerar_boletos_mens_fat_pck.nr_grupo_w', current_setting('pls_gerar_boletos_mens_fat_pck.nr_grupo_w')::bigint+1, false);
		end if;
	end if;

	/*Se não tiver criado nenhum lote, então cria embaixo*/

	if (current_setting('pls_gerar_boletos_mens_fat_pck.qt_boletos_criados_w')::bigint = 0) then
		CALL pls_gerar_boletos_mens_fat_pck.insert_sublotes_boletos();
	end if;

	PERFORM set_config('pls_gerar_boletos_mens_fat_pck.nr_ordem_w', current_setting('pls_gerar_boletos_mens_fat_pck.nr_ordem_w')::pls_boleto.nr_ordem%type+1, false);

	select	nextval('pls_boleto_seq')
	into STRICT	current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_boleto_w')::pls_boleto.nr_sequencia%type
	;

	insert into pls_boleto(	nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_lote_grupo,
			nr_titulo,
			nr_ordem,
			nr_seq_mensalidade,
			nr_seq_fatura,
			nm_pagador,
			cd_cep,
			ds_endereco,
			nr_endereco,
			ds_complemento,
			ds_bairro,
			ds_municipio,
			vl_titulo)
	values (	current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_boleto_w')::pls_boleto.nr_sequencia%type,
			clock_timestamp(),
			get_nm_usuario,
			clock_timestamp(),
			get_nm_usuario,
			current_setting('pls_gerar_boletos_mens_fat_pck.nr_seq_lote_boleto_grupo_w')::pls_lote_boleto_grupo.nr_sequencia%type,
			item_mensalidade_fatumento_p.nr_titulo,
			current_setting('pls_gerar_boletos_mens_fat_pck.nr_ordem_w')::pls_boleto.nr_ordem%type,
			item_mensalidade_fatumento_p.nr_seq_mensalidade,
			null,
			item_mensalidade_fatumento_p.nm_pagador,
			item_mensalidade_fatumento_p.endereco_pagador_boleto_t.cd_cep,
			item_mensalidade_fatumento_p.endereco_pagador_boleto_t.ds_endereco,
			item_mensalidade_fatumento_p.endereco_pagador_boleto_t.nr_endereco,
			item_mensalidade_fatumento_p.endereco_pagador_boleto_t.ds_complemento,
			item_mensalidade_fatumento_p.endereco_pagador_boleto_t.ds_bairro,
			item_mensalidade_fatumento_p.endereco_pagador_boleto_t.ds_municipio,
			item_mensalidade_fatumento_p.vl_titulo);

	PERFORM set_config('pls_gerar_boletos_mens_fat_pck.qt_boletos_criados_w', current_setting('pls_gerar_boletos_mens_fat_pck.qt_boletos_criados_w')::bigint + 1, false);
	PERFORM set_config('pls_gerar_boletos_mens_fat_pck.vl_total_titulos_w', coalesce(current_setting('pls_gerar_boletos_mens_fat_pck.vl_total_titulos_w')::pls_lote_boleto_grupo.vl_titulos%type,0) + item_mensalidade_fatumento_p.vl_titulo, false);

	/*aaschlote 23/11/2013 - Irá ser tratado depois essas ações
	pls_gerar_boletos_mens_fat_pck.criar_boletos_bandas(nr_seq_boleto_w,item_mensalidade_fatumento_p);
	*/
	end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_boletos_mens_fat_pck.criar_boletos ( item_mensalidade_fatumento_p mensalidades_faturamento_rec, nr_boleto_por_grupo_p bigint) FROM PUBLIC;
