-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE cpoe_overview_pck.gerar_horarios ( item_Prescricao_p INOUT itemPrescricao) AS $body$
DECLARE


	indice_w			integer;
	dt_ult_horario_w		timestamp;
	ds_horario_w			varchar(4000);
	ds_hora_w			varchar(2000)	:= null;
	ds_horarios_w			varchar(2000)	:= null;
	ds_horarios_fut_w		varchar(2000)	:= null;
	cpoe_overview_item_w		cpoe_overview_item%rowtype;
	cpoe_overview_item_data_w	cpoe_overview_item_data%rowtype;
	dt_aux_w			timestamp;
	ds_status_hora_w        	varchar(4000) := '';
	ds_status_hora_fut_w        	varchar(4000) := '';
	k				integer;
	ds_mat_time_w			varchar(200) := null;

	C01 CURSOR FOR
		SELECT	x.*
		from	cpoe_overview_itens_data_v x
		where	x.nr_sequencia = item_Prescricao_p.nr_seq_item_cpoe
		and	x.ie_tipo_item = item_Prescricao_p.ie_tipo_item
		and	x.dt_horario between current_setting('cpoe_overview_pck.dt_inicio_w')::timestamp and current_setting('cpoe_overview_pck.dt_fim_w')::timestamp
		order by dt_horario;

	
BEGIN

	for r_c01 in c01 loop
		begin

		if (not item_Prescricao_p.horarios := cpoe_overview_pck.existe_horario(r_c01.dt_horario, item_Prescricao_p.horarios)) then --Nao sei pq ta trazendo duplicado na base wheb
			indice_w	:= item_Prescricao_p.horarios.count + 1;

			item_Prescricao_p.horarios[indice_w].dt_horario		:= r_c01.dt_horario;
			item_Prescricao_p.horarios[indice_w].dt_inicio		:= r_c01.dt_inicio;
			item_Prescricao_p.horarios[indice_w].ie_status		:= r_c01.ie_status;
			item_Prescricao_p.horarios[indice_w].nr_prescricao	:= r_c01.nr_prescricao;
			item_Prescricao_p.horarios[indice_w].nr_seq_item_prescr	:= r_c01.nr_seq_item_prescr;
			item_Prescricao_p.horarios[indice_w].nr_seq_prescr_hor	:= r_c01.nr_seq_prescr_hor;
			dt_ult_horario_w		:= r_c01.dt_horario;
			ds_horario_w			:= r_c01.ds_horarios;

		end if;

		end;
	end loop;

	if (ds_horario_w IS NOT NULL AND ds_horario_w::text <> '') then
		item_Prescricao_p.ds_horarios		:= ds_horario_w;
	else
		ds_horario_w		:= item_Prescricao_p.ds_horarios;
		dt_ult_horario_w	:= item_Prescricao_p.dt_inicio;
	end if;


	if (trunc(current_setting('cpoe_overview_pck.dt_inicio_w')::timestamp) > trunc(clock_timestamp())) then
		item_Prescricao_p := cpoe_overview_pck.gerar_horario_futuro(	ds_horario_w, current_setting('cpoe_overview_pck.dt_inicio_w')::timestamp, item_Prescricao_p);
	else
		 --Nao sei porque, mas precisei colocar.
					item_Prescricao_p := cpoe_overview_pck.gerar_horario_futuro(	ds_horario_w, dt_ult_horario_w - 1, 
					item_Prescricao_p);
	end if;

	select	nextval('cpoe_overview_item_seq')
	into STRICT	cpoe_overview_item_w.nr_sequencia
	;

	cpoe_overview_item_w.ds_item				:= item_Prescricao_p.ds_item;
	cpoe_overview_item_w.ds_html				:= item_Prescricao_p.ds_html;
	cpoe_overview_item_w.ds_label_html			:= item_Prescricao_p.ds_label_html;
	cpoe_overview_item_w.ie_tipo_item			:= item_Prescricao_p.ie_tipo_item;
	cpoe_overview_item_w.nm_usuario				:= current_setting('cpoe_overview_pck.nm_usuario_w')::varchar(15);
	cpoe_overview_item_w.dt_atualizacao			:= clock_timestamp();
	cpoe_overview_item_w.nr_seq_item_cpoe			:= item_Prescricao_p.nr_seq_item_cpoe;
	cpoe_overview_item_w.nr_atendimento			:= current_setting('cpoe_overview_pck.nr_atendimento_w')::bigint;
	cpoe_overview_item_w.cd_pessoa_fisica			:= current_setting('cpoe_overview_pck.cd_pessoa_fisica_w')::varchar(10);
	cpoe_overview_item_w.nr_seq_cpoe_rp			:= item_Prescricao_p.nr_seq_cpoe_rp;
	cpoe_overview_item_w.nr_seq_cpoe_order_unit		:= item_Prescricao_p.nr_seq_cpoe_order_unit;
	cpoe_overview_item_w.nr_seq_cpoe_tipo_pedido		:= item_Prescricao_p.nr_seq_cpoe_tipo_pedido;
	cpoe_overview_item_w.cd_departamento			:= item_Prescricao_p.cd_departamento;
	cpoe_overview_item_w.cd_material			:= item_Prescricao_p.cd_material;
	cpoe_overview_item_w.qt_dose				:= item_Prescricao_p.qt_dose;
	cpoe_overview_item_w.cd_unidade_medida			:= item_Prescricao_p.cd_unidade_medida;
	cpoe_overview_item_w.ie_via_aplicacao			:= item_Prescricao_p.ie_via_aplicacao;
	cpoe_overview_item_w.cd_intervalo			:= item_Prescricao_p.cd_intervalo;

	insert into cpoe_overview_item values (cpoe_overview_item_w.*);

	if (current_setting('cpoe_overview_pck.ie_show_dates_w')::varchar(2) = 'S') then

		dt_aux_w := current_setting('cpoe_overview_pck.dt_inicio_w')::timestamp;

		while(dt_aux_w <= current_setting('cpoe_overview_pck.dt_fim_w')::timestamp) loop

			if (not item_Prescricao_p.horarios := cpoe_overview_pck.existe_data(dt_aux_w, item_Prescricao_p.horarios)) then

				indice_w	:= item_Prescricao_p.horarios.count + 1;

				item_Prescricao_p.horarios[indice_w].dt_horario		:= dt_aux_w;
				item_Prescricao_p.horarios[indice_w].ie_status		:= 'V';

			end if;

			dt_aux_w := dt_aux_w + 1;

		end loop;

	end if;
	
	if (current_setting('cpoe_overview_pck.ie_view_type_w')::varchar(1) = 'M') then
		ds_horarios_w := trim(both ds_horario_w) || ' ';

		if (position('A' in ds_horarios_w) > 0) then
			ds_horarios_fut_w 	:= substr(ds_horarios_w, position('A' in ds_horarios_w), length(ds_horarios_w));
			ds_horarios_w 		:= replace(ds_horarios_w, ds_horarios_fut_w, '');
			ds_horarios_fut_w 	:= replace(ds_horarios_fut_w,'A','');
			
			while(ds_horarios_fut_w IS NOT NULL AND ds_horarios_fut_w::text <> '') loop
				k		:=	position(' ' in ds_horarios_fut_w);
				ds_hora_w 	:= 	substr(ds_horarios_fut_w, 1, k);
				ds_mat_time_w := cpoe_get_mat_time_desc(cpoe_overview_item_w.cd_intervalo, ds_hora_w);

				if (ds_mat_time_w IS NOT NULL AND ds_mat_time_w::text <> '') then
					ds_status_hora_fut_w := ds_status_hora_fut_w || 'PEND-' || trim(both ds_mat_time_w) || ';';
				else
					ds_status_hora_fut_w := ds_status_hora_fut_w || 'PEND-' || trim(both ds_hora_w) || ';';
				end if;

				ds_horarios_fut_w := replace(ds_horarios_fut_w, ds_hora_w, '');
			end loop;
		end if;

		while(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') loop
			k		:=	position(' ' in ds_horarios_w);
			ds_hora_w 	:= 	substr(ds_horarios_w, 1, k);
			ds_mat_time_w := cpoe_get_mat_time_desc(cpoe_overview_item_w.cd_intervalo, ds_hora_w);

			if (ds_mat_time_w IS NOT NULL AND ds_mat_time_w::text <> '') then
				ds_status_hora_fut_w := ds_status_hora_fut_w || 'PEND-' || trim(both ds_mat_time_w) || ';';
				ds_status_hora_w     := ds_status_hora_w || 'PEND-' || trim(both ds_mat_time_w) || ';';
			else
				ds_status_hora_fut_w := ds_status_hora_fut_w || 'PEND-' || trim(both ds_hora_w) || ';';
				ds_status_hora_w     := ds_status_hora_w || 'PEND-' || trim(both ds_hora_w) || ';';
			end if;

			ds_horarios_w := replace(ds_horarios_w, ds_hora_w, '');
		end loop;
			
		
	end if;

	for i in 1..item_Prescricao_p.horarios.count loop
		begin
		select	nextval('cpoe_overview_item_data_seq')
		into STRICT	cpoe_overview_item_data_w.nr_sequencia
		;

		cpoe_overview_item_data_w.nr_seq_item			:= cpoe_overview_item_w.nr_sequencia;
		cpoe_overview_item_data_w.nm_usuario			:= current_setting('cpoe_overview_pck.nm_usuario_w')::varchar(15);
		cpoe_overview_item_data_w.dt_atualizacao		:= clock_timestamp();
		cpoe_overview_item_data_w.dt_horario			:= item_Prescricao_p.horarios[i].dt_horario;
		cpoe_overview_item_data_w.ds_status			:= item_prescricao_p.horarios[i].ie_status;
		cpoe_overview_item_data_w.nr_prescricao			:= item_prescricao_p.horarios[i].nr_prescricao;
		cpoe_overview_item_data_w.nr_seq_item_prescr		:= item_prescricao_p.horarios[i].nr_seq_item_prescr;
		cpoe_overview_item_data_w.nr_seq_prescr_hor		:= item_prescricao_p.horarios[i].nr_seq_prescr_hor;

        	if (ds_status_hora_w IS NOT NULL AND ds_status_hora_w::text <> '') and (trunc(item_Prescricao_p.horarios[i].dt_horario) = trunc(item_Prescricao_p.horarios[i].dt_inicio)) then
			cpoe_overview_item_data_w.ds_status_hora    := ds_status_hora_w;
		elsif (ds_status_hora_fut_w IS NOT NULL AND ds_status_hora_fut_w::text <> '') then
			cpoe_overview_item_data_w.ds_status_hora    := ds_status_hora_fut_w;
		end if;

                if (current_setting('cpoe_overview_pck.ie_view_mode_w')::(varchar(2) IS NOT NULL AND (varchar(2))::text <> '') and pkg_i18n.get_user_locale = 'ja_JP') then

			if ((cpoe_overview_pck.existe_item_data(cpoe_overview_item_w.nr_sequencia, item_Prescricao_p.horarios[i].dt_horario) = 'N') and (current_setting('cpoe_overview_pck.ie_view_mode_w')::varchar(2) = 'DA')) then
                                cpoe_overview_item_data_w.dt_horario			:= trunc(item_Prescricao_p.horarios[i].dt_horario);

				insert into cpoe_overview_item_data values (cpoe_overview_item_data_w.*);

			elsif (current_setting('cpoe_overview_pck.ie_view_mode_w')::varchar(2) = 'DI') then

				insert into cpoe_overview_item_data values (cpoe_overview_item_data_w.*);

			end if;

		else

			insert into cpoe_overview_item_data values (cpoe_overview_item_data_w.*);

		end if;

		end;
	end loop;

	commit;


	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_overview_pck.gerar_horarios ( item_Prescricao_p INOUT itemPrescricao) FROM PUBLIC;
