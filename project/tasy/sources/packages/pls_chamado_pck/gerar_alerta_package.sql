-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_chamado_pck.gerar_alerta ( nr_seq_chamado_p pls_chamado.nr_sequencia%type, ie_tipo_processo_p pls_regra_geracao_evento.ie_tipo_processo_chamado%type, nr_seq_prestador_p pls_chamado.nr_seq_prestador%type, nr_seq_wsuite_usuario_p pls_chamado.nr_seq_wsuite_usuario%type, cd_estabelecimento_p pls_chamado.cd_estabelecimento%type, ie_tipo_atendimento_p pls_chamado.ie_tipo_atendimento%type, nm_usuario_p usuario.nm_usuario%type, ie_commit_p text) AS $body$
DECLARE


nr_seq_evento_controle_w	pls_alerta_evento_controle.nr_sequencia%type;
ds_titulo_w			pls_alerta_evento_mensagem.ds_titulo%type;
ds_mensagem_w			pls_alerta_evento_mensagem.ds_mensagem%type;
ds_email_w			wsuite_usuario.ds_email%type;
ie_aplicacao_w			pls_notificacao_tws.ie_aplicacao%type;
cd_prioridade_email_w		pls_email_parametros.cd_prioridade%type;
ie_origem_email_w		pls_email.ie_origem%type;

C01 CURSOR FOR
	SELECT	a.nr_seq_evento_mens,
		b.nr_seq_tipo_evento,
		b.ie_tipo_envio,
		b.ds_titulo,
		b.ds_mensagem,
		b.ds_remetente_email
	from	pls_regra_geracao_evento a,
		pls_alerta_evento_mensagem b
	where	b.nr_sequencia	= a.nr_seq_evento_mens
	and	a.ie_situacao = 'A'
	and	a.ie_evento_disparo = 15
	and	a.ie_tipo_processo_chamado = ie_tipo_processo_p;

C02 CURSOR(	nr_seq_evento_mensagem_pc	pls_alerta_evento_mensagem.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		ie_forma_envio,
		ie_tipo_pessoa_dest
	from	pls_alerta_evento_destino
	where	nr_seq_evento_mens = nr_seq_evento_mensagem_pc
	and	ie_situacao = 'A';
BEGIN
ie_origem_email_w	:= 11;

select	max(ds_email)
into STRICT	ds_email_w
from	wsuite_usuario
where	nr_sequencia	= nr_seq_wsuite_usuario_p;

if (ie_tipo_atendimento_p = 'CP') then
	ie_aplicacao_w		:= 8;
elsif (ie_tipo_atendimento_p = 'P') then
	ie_aplicacao_w		:= 9;
end if;

if (nr_seq_wsuite_usuario_p IS NOT NULL AND nr_seq_wsuite_usuario_p::text <> '') then
	for c01_w in C01 loop
		begin
		ds_titulo_w	:= replace(c01_w.ds_titulo,'@NR_CHAMADO',nr_seq_chamado_p);
		ds_mensagem_w	:= replace(c01_w.ds_mensagem,'@NR_CHAMADO',nr_seq_chamado_p);
		
		nr_seq_evento_controle_w := pls_chamado_pck.gerar_evento_controle(c01_w.nr_seq_tipo_evento, ds_titulo_w, ds_mensagem_w, nm_usuario_p, nr_seq_evento_controle_w);
		
		for c02_w in C02(c01_w.nr_seq_evento_mens) loop
			begin
			
			if (c02_w.ie_forma_envio = 'NTF') then --Notificacao web
				CALL tws_notificacao_hpms_pck.tws_gerar_notificacao_web(
							ie_tipo_processo_p => 'CH',
							ie_aplicacao_p => ie_aplicacao_w,
							ds_titulo_p => ds_titulo_w,
							ds_texto_p => ds_mensagem_w,
							nr_seq_conta_p => null,
							nr_seq_prestador_p => nr_seq_prestador_p,
							nr_seq_segurado_p => null,
							nr_seq_wsuite_usuario_p => nr_seq_wsuite_usuario_p,
							nm_usuario_p => nm_usuario_p
							);
				
				CALL CALL pls_chamado_pck.gerar_evento_controle_dest(nr_seq_evento_controle_w, c02_w.ie_forma_envio, c02_w.ie_tipo_pessoa_dest, ds_mensagem_w, null, nm_usuario_p);
			elsif (c02_w.ie_forma_envio = 'EM') then --Email
				
				if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then
					select	coalesce(max(cd_prioridade),5)
					into STRICT	cd_prioridade_email_w
					from	pls_email_parametros
					where	ie_origem		= ie_origem_email_w
					and	cd_estabelecimento	= cd_estabelecimento_p
					and	ie_situacao		= 'A';
					
					insert	into	pls_email(	nr_sequencia, cd_estabelecimento, nm_usuario_nrec,
							dt_atualizacao_nrec, nm_usuario, dt_atualizacao,
							ie_tipo_mensagem, ie_status, ie_origem,
							ds_remetente, cd_prioridade, ds_destinatario,
							nr_seq_chamado, ds_assunto, ds_mensagem )
						values (nextval('pls_email_seq'), cd_estabelecimento_p, nm_usuario_p,
							clock_timestamp(), nm_usuario_p, clock_timestamp(),
							'10', 'P', ie_origem_email_w,
							c01_w.ds_remetente_email, cd_prioridade_email_w, ds_email_w,
							nr_seq_chamado_p, ds_titulo_w, ds_mensagem_w );
					
					CALL CALL pls_chamado_pck.gerar_evento_controle_dest(nr_seq_evento_controle_w, c02_w.ie_forma_envio, c02_w.ie_tipo_pessoa_dest, ds_mensagem_w, null, nm_usuario_p);
				end if;
			end if;
			
			end;
		end loop; --C02
		
		end;
	end loop; --C01
end if;

if (ie_commit_p = 'S') then
	commit;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_chamado_pck.gerar_alerta ( nr_seq_chamado_p pls_chamado.nr_sequencia%type, ie_tipo_processo_p pls_regra_geracao_evento.ie_tipo_processo_chamado%type, nr_seq_prestador_p pls_chamado.nr_seq_prestador%type, nr_seq_wsuite_usuario_p pls_chamado.nr_seq_wsuite_usuario%type, cd_estabelecimento_p pls_chamado.cd_estabelecimento%type, ie_tipo_atendimento_p pls_chamado.ie_tipo_atendimento%type, nm_usuario_p usuario.nm_usuario%type, ie_commit_p text) FROM PUBLIC;
