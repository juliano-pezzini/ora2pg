-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_chamado_pck.encerrar_chamado ( nr_seq_chamado_etapa_p pls_chamado_etapa.nr_sequencia%type, nr_seq_motivo_encerramento_p pls_motivo_final_chamado.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

nr_seq_chamado_w		pls_chamado.nr_sequencia%type;
qt_chamado_hist_liberado_w	bigint;
qt_etapa_obrigatoria_w		bigint;

BEGIN
CALL pls_chamado_pck.liberar_etapa(nr_seq_chamado_etapa_p, nm_usuario_p, 'N');

select	nr_seq_chamado
into STRICT	nr_seq_chamado_w
from	pls_chamado_etapa
where	nr_sequencia = nr_seq_chamado_etapa_p;

select	count(1)
into STRICT	qt_chamado_hist_liberado_w
from	pls_chamado_historico a,
	pls_tipo_historico_chamado b
where	b.nr_sequencia	= a.nr_seq_tipo_historico
and	b.ie_externo = 'S'
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and	a.nr_seq_chamado = nr_seq_chamado_w;

if (qt_chamado_hist_liberado_w > 0) then
	select	count(a.nr_sequencia)
	into STRICT	qt_etapa_obrigatoria_w
	from	pls_tipo_chamado_etapa a,
		pls_tipo_chamado b,
		pls_chamado c
	where	a.nr_seq_tipo_chamado = b.nr_sequencia
	and	b.nr_sequencia = c.nr_seq_tipo_chamado
	and	a.ie_etapa_obrigatoria = 'S'
	and	c.nr_sequencia = nr_seq_chamado_w
	and	not exists (	SELECT	1
				from	pls_chamado_etapa x
				where	x.nr_seq_chamado = c.nr_sequencia
				and	x.nr_seq_tipo_etapa = a.nr_sequencia);

	if (qt_etapa_obrigatoria_w = 0) then
		update	pls_chamado
		set	ie_status = 3,
			dt_encerramento = clock_timestamp(),
			nr_seq_motivo_encerramento = nr_seq_motivo_encerramento_p,
			nr_seq_estagio = (SELECT a.nr_seq_estagio_enc from pls_tipo_chamado a, pls_chamado b where b.nr_seq_tipo_chamado = a.nr_sequencia and b.nr_sequencia = nr_seq_chamado_w)
		where nr_sequencia = nr_seq_chamado_w;
		
		CALL CALL pls_chamado_pck.gerar_alerta_evento(	nr_seq_chamado_p => nr_seq_chamado_w,
					ie_tipo_processo_p => '1',
					nm_usuario_p => nm_usuario_p,
					ie_commit_p => 'N');
	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1192608);
	end if;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1199940);
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_chamado_pck.encerrar_chamado ( nr_seq_chamado_etapa_p pls_chamado_etapa.nr_sequencia%type, nr_seq_motivo_encerramento_p pls_motivo_final_chamado.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
