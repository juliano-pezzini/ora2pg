-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION mult_schedule_pck.get_main_informations ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_agendas_p text, dt_agenda_inicial_p timestamp, dt_agenda_final_p timestamp, nm_usuario_p usuario.nm_usuario%type, ie_sem_atendimento_p text) RETURNS varchar AS $body$
DECLARE

	
	ds_sql_w 	varchar(30000);
	
BEGIN

		ds_sql_w := 'select ap.nr_sequencia nr_seq_agenda, ';
		ds_sql_w :=	 ds_sql_w || '  a.cd_agenda, ';
		ds_sql_w :=	 ds_sql_w || '	a.cd_tipo_agenda, ';
		ds_sql_w :=	 ds_sql_w || '	ap.hr_inicio dt_agenda, ';
		ds_sql_w :=	 ds_sql_w || '	ap.ie_status_agenda, ';
		ds_sql_w :=	 ds_sql_w || '	substr(obter_desc_agenda_integrada(a.cd_agenda, a.cd_tipo_agenda, null, '|| cd_estabelecimento_p || '),1,255) ds_agenda, ';
		ds_sql_w :=	 ds_sql_w || '	decode(ap.nr_minuto_duracao, 0, 30, ap.nr_minuto_duracao) nr_minuto_duracao, ';
		ds_sql_w :=	 ds_sql_w || '	ap.cd_pessoa_fisica cd_paciente, ';
		ds_sql_w :=	 ds_sql_w || '	ap.cd_medico, ';
		ds_sql_w :=	 ds_sql_w || '	ap.cd_medico_req, ';
		ds_sql_w :=	 ds_sql_w || '	ap.cd_convenio, ';
		ds_sql_w :=	 ds_sql_w || '	ap.nr_atendimento, ';
		ds_sql_w :=	 ds_sql_w || '	ap.nr_seq_proc_interno, ';
		ds_sql_w :=	 ds_sql_w || '	to_char(ap.hr_inicio, pkg_date_formaters.localize_mask(''shortTime'', pkg_date_formaters.getUserLanguageTag('|| cd_estabelecimento_p ||', '''|| nm_usuario_p || '''))) hr_inicio, ';
		ds_sql_w :=	 ds_sql_w || '	to_char(ap.hr_inicio + (ap.nr_minuto_duracao/1440), pkg_date_formaters.localize_mask(''shortTime'', pkg_date_formaters.getUserLanguageTag('|| cd_estabelecimento_p ||', '''|| nm_usuario_p ||'''))) hr_fim, ';
		ds_sql_w :=	 ds_sql_w || '	null nr_seq_horario, ';
		ds_sql_w :=	 ds_sql_w || '	''N'' ie_agendamento_grupo ';
		ds_sql_w :=	 ds_sql_w || '	from agenda_paciente ap, ';
		ds_sql_w :=	 ds_sql_w || '	 	 agenda a ';
		ds_sql_w :=	 ds_sql_w || '	where a.cd_agenda = ap.cd_agenda ';
		ds_sql_w :=	 ds_sql_w || '	and ap.cd_agenda in ('|| cd_agendas_p ||') ';
		ds_sql_w :=	 ds_sql_w || '	and ap.ie_status_agenda <> ''L'' ';
		ds_sql_w :=	 ds_sql_w || '	and ap.hr_inicio between inicio_dia(''' || dt_agenda_inicial_p ||''') and fim_dia(''' || dt_agenda_final_p || ''') ';
		ds_sql_w :=	 ds_sql_w || '	and	exists (select 1 ';
		ds_sql_w :=	 ds_sql_w || '				from	agenda_horario ah ';
		ds_sql_w :=	 ds_sql_w || '				where   ap.nr_seq_horario = ah.nr_sequencia ';
		ds_sql_w :=	 ds_sql_w || '				and	    ah.ie_turno_agendamento_grupo = ''N'') ';
		ds_sql_w :=	 ds_sql_w || '	and	((nvl('''|| ie_sem_atendimento_p ||''' ,''N'') = ''S'' and  ap.nr_atendimento is null) or (nvl('''|| ie_sem_atendimento_p ||''',''N'') = ''N'')) ';
		ds_sql_w :=	 ds_sql_w || '	and	ap.nr_sequencia in (select max(app.nr_sequencia) ';
		ds_sql_w :=	 ds_sql_w || '							from  agenda a, ';
		ds_sql_w :=	 ds_sql_w || '							  	  agenda_paciente app ';
		ds_sql_w :=	 ds_sql_w || '							where app.cd_agenda = a.cd_agenda ';
		ds_sql_w :=	 ds_sql_w || '							and   app.cd_agenda = ap.cd_agenda ';
		ds_sql_w :=	 ds_sql_w || '							and   pkg_date_utils.start_of(app.dt_agenda, ''dd'') = pkg_date_utils.start_of(ap.hr_inicio, ''dd'') ';
		ds_sql_w :=	 ds_sql_w || '							and   app.ie_status_agenda <> ''L'' ';
		ds_sql_w :=	 ds_sql_w || '							group by to_char(app.hr_inicio, pkg_date_formaters.localize_mask(''shortTime'', pkg_date_formaters.getUserLanguageTag('|| cd_estabelecimento_p ||', '''|| nm_usuario_p ||''')))) ';
		ds_sql_w :=	 ds_sql_w || '	union ';
		ds_sql_w :=	 ds_sql_w || '	select ap.nr_seq_horario + pkg_date_utils.extract_field(''DAY'', ap.dt_agenda) nr_seq_agenda, ';
		ds_sql_w :=	 ds_sql_w || '	a.cd_agenda, ';
		ds_sql_w :=	 ds_sql_w || '	a.cd_tipo_agenda, ';
		ds_sql_w :=	 ds_sql_w || '	ap.hr_inicio dt_agenda, ';
		ds_sql_w :=	 ds_sql_w || '	obter_status_age_grupo(ap.nr_seq_horario, a.cd_agenda, ap.dt_agenda) ie_status_agenda, ';
		ds_sql_w :=	 ds_sql_w || '	substr(obter_desc_agenda_integrada(a.cd_agenda, a.cd_tipo_agenda, null, '|| cd_estabelecimento_p ||'),1,255) ds_agenda, ';
		ds_sql_w :=	 ds_sql_w || '	60 nr_minuto_duracao, ';
		ds_sql_w :=	 ds_sql_w || '	null cd_paciente, ';
		ds_sql_w :=	 ds_sql_w || '	null cd_medico, ';
		ds_sql_w :=	 ds_sql_w || '	null cd_medico_req, ';
		ds_sql_w :=	 ds_sql_w || '	null cd_convenio, ';
		ds_sql_w :=	 ds_sql_w || '	null nr_atendimento, ';
		ds_sql_w :=	 ds_sql_w || '	null nr_seq_proc_interno, ';
		ds_sql_w :=	 ds_sql_w || '  (select to_char(x.hr_inicial, pkg_date_formaters.localize_mask(''shortTime'', pkg_date_formaters.getUserLanguageTag('|| cd_estabelecimento_p ||', '''|| nm_usuario_p ||'''))) ';
		ds_sql_w :=	 ds_sql_w || '	 from	agenda_horario x ';
		ds_sql_w :=	 ds_sql_w || '	 where  x.nr_sequencia = ap.nr_seq_horario) hr_inicio, ';
		ds_sql_w :=	 ds_sql_w || '	(select to_char(y.hr_final, pkg_date_formaters.localize_mask(''shortTime'', pkg_date_formaters.getUserLanguageTag('|| cd_estabelecimento_p ||', '''|| nm_usuario_p ||'''))) ';
		ds_sql_w :=	 ds_sql_w || '	 from	agenda_horario y ';
		ds_sql_w :=	 ds_sql_w || '	 where  y.nr_sequencia = ap.nr_seq_horario) hr_fim, ';
		ds_sql_w :=	 ds_sql_w || '	 ap.nr_seq_horario, ';
		ds_sql_w :=	 ds_sql_w || '	 ''S'' ie_agendamento_grupo ';
		ds_sql_w :=	 ds_sql_w || '	from agenda_paciente ap, ';
		ds_sql_w :=	 ds_sql_w || '		agenda a ';
		ds_sql_w :=	 ds_sql_w || '	where a.cd_agenda = ap.cd_agenda ';
		ds_sql_w :=	 ds_sql_w || '	and ap.cd_agenda in ('|| cd_agendas_p ||') ';
		ds_sql_w :=	 ds_sql_w || '	and ap.ie_status_agenda <> ''L'' ';
		ds_sql_w :=	 ds_sql_w || '	and ap.hr_inicio between inicio_dia(''' || dt_agenda_inicial_p ||''') and fim_dia(''' || dt_agenda_final_p || ''') ';
		ds_sql_w :=	 ds_sql_w || '	and	exists (select 1 ';
		ds_sql_w :=	 ds_sql_w || '				from	agenda_horario ah ';
		ds_sql_w :=	 ds_sql_w || '				where   ap.nr_seq_horario = ah.nr_sequencia ';
		ds_sql_w :=	 ds_sql_w || '				and	    ah.ie_turno_agendamento_grupo = ''S'') ';
		ds_sql_w :=	 ds_sql_w || '	and	((nvl('''|| ie_sem_atendimento_p ||''',''N'') = ''S'' and  ap.nr_atendimento is null) or (nvl('''|| ie_sem_atendimento_p ||''',''N'') = ''N'')) ';
		ds_sql_w :=	 ds_sql_w || '	and	ap.nr_sequencia in (select max(app.nr_sequencia) ';
		ds_sql_w :=	 ds_sql_w || '							from agenda a, ';
		ds_sql_w :=	 ds_sql_w || '								 agenda_paciente app ';
		ds_sql_w :=	 ds_sql_w || '							where app.cd_agenda = a.cd_agenda ';
		ds_sql_w :=	 ds_sql_w || '							and   app.cd_agenda = ap.cd_agenda ';
		ds_sql_w :=	 ds_sql_w || '							and pkg_date_utils.start_of(app.dt_agenda, ''dd'') = pkg_date_utils.start_of(ap.hr_inicio, ''dd'') ';
		ds_sql_w :=	 ds_sql_w || '							and app.ie_status_agenda <> ''L'' ';
		ds_sql_w :=	 ds_sql_w || '							group by to_char(app.hr_inicio, pkg_date_formaters.localize_mask(''shortTime'', pkg_date_formaters.getUserLanguageTag('|| cd_estabelecimento_p ||', '''|| nm_usuario_p ||''')))) ';
		ds_sql_w :=	 ds_sql_w || '	union ';
		ds_sql_w :=	 ds_sql_w || '	select ac.nr_sequencia nr_seq_agenda, ';
		ds_sql_w :=	 ds_sql_w || '		a.cd_agenda, ';
		ds_sql_w :=	 ds_sql_w || '		a.cd_tipo_agenda, ';
		ds_sql_w :=	 ds_sql_w || '		ac.dt_agenda, ';
		ds_sql_w :=	 ds_sql_w || '		ac.ie_status_agenda, ';
		ds_sql_w :=	 ds_sql_w || '		substr(obter_nome_medico_combo_agcons('|| cd_estabelecimento_p ||', a.cd_agenda, a.cd_tipo_agenda, null),1,255) ds_agenda, ';
		ds_sql_w :=	 ds_sql_w || '		decode(ac.nr_minuto_duracao, 0, 30, ac.nr_minuto_duracao) nr_minuto_duracao, ';
		ds_sql_w :=	 ds_sql_w || '		ac.cd_pessoa_fisica cd_paciente, ';
		ds_sql_w :=	 ds_sql_w || '		ac.cd_medico, ';
		ds_sql_w :=	 ds_sql_w || '		ac.cd_medico_req, ';
		ds_sql_w :=	 ds_sql_w || '		ac.cd_convenio, ';
		ds_sql_w :=	 ds_sql_w || '		ac.nr_atendimento, ';
		ds_sql_w :=	 ds_sql_w || '		null nr_seq_proc_interno, ';
		ds_sql_w :=	 ds_sql_w || '		to_char(ac.dt_agenda, pkg_date_formaters.localize_mask(''shortTime'', pkg_date_formaters.getUserLanguageTag('|| cd_estabelecimento_p ||', '''|| nm_usuario_p ||'''))) hr_inicio, ';
		ds_sql_w :=	 ds_sql_w || '		to_char(ac.dt_agenda + (ac.nr_minuto_duracao/1440), pkg_date_formaters.localize_mask(''shortTime'', pkg_date_formaters.getUserLanguageTag('|| cd_estabelecimento_p ||', '''|| nm_usuario_p ||'''))) hr_fim, ';
		ds_sql_w :=	 ds_sql_w || '		null nr_seq_horario, ';
		ds_sql_w :=	 ds_sql_w || '		''N'' ie_agendamento_grupo ';
		ds_sql_w :=	 ds_sql_w || '	from agenda_consulta ac, ';
		ds_sql_w :=	 ds_sql_w || '		 agenda a ';
		ds_sql_w :=	 ds_sql_w || '	where a.cd_agenda = ac.cd_agenda ';
		ds_sql_w :=	 ds_sql_w || '	and ac.cd_agenda in ('|| cd_agendas_p ||') ';
		ds_sql_w :=	 ds_sql_w || '	and ac.ie_status_agenda <> ''L'' ';
		ds_sql_w :=	 ds_sql_w || '	and ac.dt_agenda between inicio_dia(''' || dt_agenda_inicial_p ||''') and fim_dia(''' || dt_agenda_final_p || ''') ';
		ds_sql_w :=	 ds_sql_w || '	and	((nvl('''|| ie_sem_atendimento_p ||''',''N'') = ''S'' and  ac.nr_atendimento is null) or (nvl('''|| ie_sem_atendimento_p ||''',''N'') = ''N'')) ';
		ds_sql_w :=	 ds_sql_w || '	and	ac.nr_sequencia in 	(select	   max(acc.nr_sequencia) ';
		ds_sql_w :=	 ds_sql_w || '						     from	   agenda a, ';
		ds_sql_w :=	 ds_sql_w || '									   agenda_consulta acc ';
		ds_sql_w :=	 ds_sql_w || '						     where     acc.cd_agenda = a.cd_agenda ';
		ds_sql_w :=	 ds_sql_w || '						     and	   acc.cd_agenda = ac.cd_agenda ';
		ds_sql_w :=	 ds_sql_w || '						     and	   pkg_date_utils.start_of(acc.dt_agenda, ''dd'') = pkg_date_utils.start_of(ac.dt_agenda, ''dd'') ';
		ds_sql_w :=	 ds_sql_w || '						     and 	   acc.ie_status_agenda <> ''L'' ';
		ds_sql_w :=	 ds_sql_w || '						     group by to_char(acc.dt_agenda, pkg_date_formaters.localize_mask(''shortTime'', pkg_date_formaters.getUserLanguageTag('|| cd_estabelecimento_p ||', '''|| nm_usuario_p ||''')))) ';
		ds_sql_w :=	 ds_sql_w || '	order by dt_agenda, hr_inicio, nr_seq_agenda ';
		
		return ds_sql_w;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION mult_schedule_pck.get_main_informations ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_agendas_p text, dt_agenda_inicial_p timestamp, dt_agenda_final_p timestamp, nm_usuario_p usuario.nm_usuario%type, ie_sem_atendimento_p text) FROM PUBLIC;
