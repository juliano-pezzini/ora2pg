-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION mult_schedule_pck.get_all_informations (cd_agenda_p agenda.cd_agenda%type, dt_agenda_p timestamp, nr_seq_agenda_p agenda_paciente.nr_sequencia%type, cd_tipo_agenda_p agenda.cd_tipo_agenda%type, nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_medico_p agenda_paciente.cd_medico%type, cd_medico_req_p agenda_paciente.cd_medico_req%type, cd_convenio_p convenio.cd_convenio%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_proc_interno_p agenda_paciente.nr_seq_proc_interno%type, hr_inicio_p text, hr_fim_p text, cd_estabelecimento_p text) RETURNS varchar AS $body$
DECLARE

			
	ds_sql_w 	varchar(30000);
	cd_pessoa_fisica_ageint_w	pessoa_fisica.cd_pessoa_fisica%type;
	nr_seq_person_name_w		pessoa_fisica.nr_seq_person_name%type;
	nm_pessoa_fisica_w			varchar(255);
	nr_seq_ageint_w				agenda_integrada_item.nr_sequencia%type;
	nr_sequencia_ageint_w		agenda_integrada.nr_sequencia%type;
	nr_seq_episodio_w			episodio_paciente.nr_sequencia%type;
	nr_seq_tipo_episodio_w		episodio_paciente.nr_seq_tipo_episodio%type;
	nr_atend_discharge_w		atendimento_paciente.nr_atendimento%type;
	div_w						varchar(10) := '#DIV#';
	current_setting('mult_schedule_pck.cd_convenio_w')::convenio.cd_convenio%type				convenio.cd_convenio%type;
		
	
BEGIN
	
	if (coalesce(cd_pessoa_fisica_p::text, '') = '') then
		if (cd_tipo_agenda_p in (3,5)) then
			select max(b.cd_pessoa_fisica),
				   max(c.nr_sequencia),
				   max(b.nr_sequencia)
			into STRICT   cd_pessoa_fisica_ageint_w,
				   nr_seq_ageint_w,
				   nr_sequencia_ageint_w
			from   agenda_integrada b,
				   agenda_integrada_item c
			where  c.nr_seq_agenda_int = b.nr_sequencia
			and	   c.nr_seq_agenda_cons = nr_seq_agenda_p;
		elsif (cd_tipo_agenda_p = 2) then
			select max(b.cd_pessoa_fisica),
				   max(c.nr_sequencia),
				   max(b.nr_sequencia)
			into STRICT   cd_pessoa_fisica_ageint_w,
				   nr_seq_ageint_w,
				   nr_sequencia_ageint_w
			from   agenda_integrada b,
				   agenda_integrada_item c
			where  c.nr_seq_agenda_int = b.nr_sequencia
			and	   c.nr_seq_agenda_exame = nr_seq_agenda_p;
		end if;
	end if;
	
	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') or (cd_pessoa_fisica_ageint_w IS NOT NULL AND cd_pessoa_fisica_ageint_w::text <> '') then
		select  max(pf.nr_seq_person_name)
		into STRICT 	nr_seq_person_name_w
		from	pessoa_fisica pf
		where 	pf.cd_pessoa_fisica = coalesce(cd_pessoa_fisica_p, cd_pessoa_fisica_ageint_w);
		
		if (nr_seq_person_name_w IS NOT NULL AND nr_seq_person_name_w::text <> '') then
			select substr(nm_pessoa_fisica, 1, 255)
			into STRICT   nm_pessoa_fisica_w
			from   table(search_names_dev(null, null, nr_seq_person_name_w, 'list', 'social,main'));
		end if;
	end if;
	
	ds_sql_w :=  'select distinct  ac.nr_sequencia nr_seq_agenda, ';
	
	if (cd_tipo_agenda_p in (3,5)) then
		ds_sql_w := ds_sql_w || 'ac.cd_especialidade, ';
		ds_sql_w := ds_sql_w || 'substr(obter_desc_espec_medica(ac.cd_especialidade),1,255) ds_especialidade, ';
		ds_sql_w := ds_sql_w || 'ac.nr_seq_classif nr_seq_classif_agenda, ';
		ds_sql_w := ds_sql_w || 'substr(obter_dados_item_ageint(ac.nr_sequencia, null, null, ''C''),1,255) ds_classificacao, ';
		ds_sql_w := ds_sql_w || 'decode(ageint_obter_mot_bloq(ac.cd_agenda, ac.dt_agenda, obter_cod_dia_semana(ac.dt_agenda)), null, obter_desc_motivo_agenda(ac.nr_seq_motivo_transf), ageint_obter_mot_bloq(ac.cd_agenda, ac.dt_agenda, obter_cod_dia_semana(ac.dt_agenda))) ds_motivo_bloqueio, ';
		ds_sql_w := ds_sql_w || 'obter_desc_indicacao_ageint(ac.nr_sequencia,''C'') ds_indicacao, ';
		ds_sql_w := ds_sql_w || 'case when ac.ie_status_agenda = ''O'' and trunc(dt_agenda) = trunc(sysdate) then ''S'' else ''N'' end ie_delay_check, ';
		ds_sql_w := ds_sql_w || 'decode(ac.nr_minuto_duracao, 0 , (case when (((dt_agenda - sysdate) * 1440) > 0) then 0 else 101 end), round((((( sysdate - dt_agenda ) * 1440 ) * 100 ) / ac.nr_minuto_duracao))) qt_delaying_time, ';
		ds_sql_w := ds_sql_w || 'null nr_seq_interno, ';
		ds_sql_w := ds_sql_w || 'null ie_status_laudo, ';
		ds_sql_w := ds_sql_w || 'null nr_acesso_dicom, ';
		ds_sql_w := ds_sql_w || 'ac.nr_seq_lista_espera nr_seq_lista_espera, ';
	elsif (cd_tipo_agenda_p = 2) then	
		ds_sql_w := ds_sql_w || 'null cd_especialidade, ';
		ds_sql_w := ds_sql_w || 'null ds_especialidade, ';
		ds_sql_w := ds_sql_w || 'ac.nr_seq_classif_agenda nr_seq_classif_agenda, ';
		ds_sql_w := ds_sql_w || 'substr(obter_dados_item_ageint(null, ac.nr_sequencia, null, ''C''),1,255) ds_classificacao, ';
		ds_sql_w := ds_sql_w || 'decode(ageint_obter_mot_bloq(ac.cd_agenda, ac.dt_agenda, obter_cod_dia_semana(ac.dt_agenda)), null, obter_desc_motivo_agenda(ac.nr_seq_motivo_bloq), ageint_obter_mot_bloq(ac.cd_agenda, ac.dt_agenda, obter_cod_dia_semana(ac.dt_agenda))) ds_motivo_bloqueio,  ';
		ds_sql_w := ds_sql_w || 'obter_desc_indicacao_ageint(ac.nr_sequencia,''P'') ds_indicacao, ';
		ds_sql_w := ds_sql_w || 'case when ac.ie_status_agenda = ''O'' and	obter_status_laudo_agenda(ac.nr_sequencia, ac.nr_atendimento) = ''N'' and	trunc(dt_agenda) = trunc(sysdate) THEN ''S'' ELSE ''N'' END ie_delay_check, ';
		ds_sql_w := ds_sql_w || 'case when trunc(ac.dt_agenda) = trunc(sysdate) then decode(ac.nr_minuto_duracao, 0, 101, round((((sysdate - ac.hr_inicio) * 1440) * 100) / ac.nr_minuto_duracao)) else 0 end qt_delaying_time, ';
		ds_sql_w := ds_sql_w || '(select  max(pp.nr_seq_interno)
								  from	 prescr_procedimento pp,
										 prescr_medica pm
								  where   pp.nr_prescricao = pm.nr_prescricao 
								  and	 pp.nr_seq_proc_interno = ac.nr_seq_proc_interno 
								  and	 pm.nr_seq_agenda = ac.nr_sequencia ) nr_seq_interno, ';
		ds_sql_w := ds_sql_w || 'obter_status_laudo_agenda(ac.nr_sequencia, ac.nr_atendimento) ie_status_laudo,  ';
		ds_sql_w := ds_sql_w || '(select max(pp.nr_acesso_dicom)
								  from	prescr_procedimento pp,
										prescr_medica pm
								  where pp.nr_prescricao = pm.nr_prescricao 
								  and	pp.nr_seq_proc_interno = ac.nr_seq_proc_interno 
								  and	pm.nr_seq_agenda = ac.nr_sequencia) nr_acesso_dicom,  ';
		ds_sql_w := ds_sql_w || 'ac.nr_seq_lista nr_seq_lista_espera, ';
	end if;
	
	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
		ds_sql_w := ds_sql_w || 'obter_sexo_pf(ac.cd_pessoa_fisica, ''D'') ie_sexo_paciente, ';
		ds_sql_w := ds_sql_w || 'obter_sexo_pf(ac.cd_pessoa_fisica, ''C'') cd_sexo_paciente, ';
		ds_sql_w := ds_sql_w || 'coalesce('''|| nm_pessoa_fisica_w || ''', obter_nome_pf(ac.cd_pessoa_fisica), ac.nm_paciente) nm_paciente, ';
		ds_sql_w := ds_sql_w || 'to_char(obter_data_nascto_pf(ac.cd_pessoa_fisica), pkg_date_formaters.localize_mask(''shortDate'',pkg_date_formaters.getUserLanguageTag('''|| cd_estabelecimento_p || ''',''' || nm_usuario_p || '''))) dt_nascimento, ';
	else
		ds_sql_w := ds_sql_w || 'null ie_sexo_paciente, ';
		ds_sql_w := ds_sql_w || 'null cd_sexo_paciente, ';
		ds_sql_w := ds_sql_w || 'null nm_paciente, ';
		ds_sql_w := ds_sql_w || 'null dt_nascimento, ';
	end if;	
		
	
	if (cd_medico_p IS NOT NULL AND cd_medico_p::text <> '') then
		ds_sql_w := ds_sql_w || 'ac.cd_medico cd_medico, ';
		ds_sql_w := ds_sql_w || 'obter_nome_medico(ac.cd_medico,''N'') nm_medico, ';
	else
		ds_sql_w := ds_sql_w || 'null cd_medico, ';
		ds_sql_w := ds_sql_w || 'null nm_medico, ';
	end if;
	
	if (cd_medico_req_p IS NOT NULL AND cd_medico_req_p::text <> '') then
	   ds_sql_w := ds_sql_w || 'obter_nome_pf_pj(ac.cd_medico_req, null) nm_medico_req, ';
	else
	   ds_sql_w := ds_sql_w || 'null nm_medico_req, ';
	end if;

	ds_sql_w := ds_sql_w || 'decode(ac.dt_confirmacao, null, substr(obter_valor_dominio(83, ac.ie_status_agenda),1,200), substr(obter_valor_dominio(83, ''CN''),1,200)) ds_status_agenda, ';
	ds_sql_w := ds_sql_w || 'ac.dt_confirmacao, ';
	ds_sql_w := ds_sql_w || 'ac.cd_procedimento, ';
	ds_sql_w := ds_sql_w || 'ac.ie_origem_proced, ';
	ds_sql_w := ds_sql_w || 'substr(obter_exame_agenda(ac.cd_procedimento, ac.ie_origem_proced, ac.nr_seq_proc_interno),1,240) ds_procedimento, ';
	
	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
		ds_sql_w := ds_sql_w || 'obter_nome_contato(ac.cd_pessoa_fisica, 1) nm_contato, ';
		ds_sql_w := ds_sql_w || 'decode(ac.nr_telefone, null, nvl(obter_telefone_pf(ac.cd_pessoa_fisica, 1),obter_telefone_pf(ac.cd_pessoa_fisica, 9)), ac.nr_telefone) nr_telefone, ';
		ds_sql_w := ds_sql_w || 'to_char(nvl(ac.dt_nascimento_pac, obter_data_nascto_pf(ac.cd_pessoa_fisica)), pkg_date_formaters.localize_mask(''shortDate'',pkg_date_formaters.getUserLanguageTag('''|| cd_estabelecimento_p ||''','''|| nm_usuario_p ||'''))) dt_nascto_pac ,';
	else
		ds_sql_w := ds_sql_w || 'obter_nome_contato(ac.cd_pessoa_fisica, 1) nm_contato, ';
		ds_sql_w := ds_sql_w || 'ac.nr_telefone nr_telefone, ';
		ds_sql_w := ds_sql_w || 'decode(ac.dt_nascimento_pac, null, '''',to_char(ac.dt_nascimento_pac, pkg_date_formaters.localize_mask(''shortDate'',pkg_date_formaters.getUserLanguageTag('''|| cd_estabelecimento_p ||''','''|| nm_usuario_p ||''')))) dt_nascto_pac ,';
	end if;
	
	ds_sql_w := ds_sql_w || 'ac.nm_usuario, ';
	
	if (nr_seq_ageint_w IS NOT NULL AND nr_seq_ageint_w::text <> '') then
		ds_sql_w := ds_sql_w || nr_seq_ageint_w || ' nr_seq_ageint, ';
	else
		ds_sql_w := ds_sql_w ||  'null  nr_seq_ageint, ';
	end if;

	if (nr_sequencia_ageint_w IS NOT NULL AND nr_sequencia_ageint_w::text <> '') then
		ds_sql_w := ds_sql_w ||  nr_sequencia_ageint_w || ' nr_sequencia_ageint, ';
	else
		ds_sql_w := ds_sql_w ||  'null nr_sequencia_ageint, ';
	end if;

	
	
	if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	
		select  coalesce(max(nr_seq_episodio),0)
		into STRICT    nr_seq_episodio_w
		from    atendimento_paciente
		where   nr_atendimento = nr_atendimento_p;
	
		if (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '') then
			select max(nr_seq_tipo_episodio)
			into STRICT   nr_seq_tipo_episodio_w
			from   episodio_paciente
			where  nr_sequencia = nr_seq_episodio_w;
			
			select 	max(x.nr_atendimento)
			into STRICT	nr_atend_discharge_w
			from	atendimento_paciente x
			where 	x.nr_seq_episodio = nr_seq_episodio_w
			and		x.ie_tipo_atendimento = 1;
		else
			nr_seq_tipo_episodio_w := null;
			nr_atend_discharge_w   := null;
		end if;
		
		select coalesce(max(cd_convenio),0)
		into STRICT  current_setting('mult_schedule_pck.cd_convenio_w')::convenio.cd_convenio%type
		from  atend_categoria_convenio a
		where a.nr_atendimento		= nr_atendimento_p
		and a.dt_inicio_vigencia	= (SELECT max(dt_inicio_vigencia)
										from atend_categoria_convenio b
		where nr_atendimento		= nr_atendimento_p);
		
		if (current_setting('mult_schedule_pck.cd_convenio_w')::convenio.cd_convenio%(type IS NOT NULL AND type::text <> '')) then
			ds_sql_w := ds_sql_w || ' '''|| current_setting('mult_schedule_pck.cd_convenio_w')::convenio.cd_convenio%type ||''' cd_convenio, ';
			ds_sql_w := ds_sql_w || 'obter_desc_convenio('''|| current_setting('mult_schedule_pck.cd_convenio_w')::convenio.cd_convenio%type ||''') ds_convenio, ';
			ds_sql_w := ds_sql_w || 'obter_desc_tipo_convenio('''|| current_setting('mult_schedule_pck.cd_convenio_w')::convenio.cd_convenio%type ||''') ds_tipo_convenio, ';
		elsif (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '') then
			ds_sql_w := ds_sql_w || ' '''|| cd_convenio_p ||''' cd_convenio, ';
			ds_sql_w := ds_sql_w || 'obter_desc_convenio('''|| cd_convenio_p ||''') ds_convenio, ';
			ds_sql_w := ds_sql_w || 'obter_desc_tipo_convenio('''|| cd_convenio_p ||''') ds_tipo_convenio, ';
		else
			ds_sql_w := ds_sql_w || 'null cd_convenio, ';
			ds_sql_w := ds_sql_w || 'null ds_convenio, ';
			ds_sql_w := ds_sql_w || 'null ds_tipo_convenio, ';
		end if;
	
		ds_sql_w := ds_sql_w || 'decode(obter_episodio_atendimento(ac.nr_atendimento), 0, null, obter_episodio_atend_tela(ac.nr_atendimento)) nr_episodio, ';
		ds_sql_w := ds_sql_w || 'nvl(obter_desc_setor_atend(obter_setor_atendimento(ac.nr_atendimento)), obter_desc_setor_atend(ac.cd_setor_atendimento)) ds_setor_atendimento, ';
		ds_sql_w := ds_sql_w || 'obter_nome_departamento_medico(obter_departamento_data(ac.nr_atendimento)) ds_departamento_medico, ';
		ds_sql_w := ds_sql_w || 'decode(obter_se_atendimento_futuro(ac.nr_atendimento), ''S'', ''P'', ''N'') ie_planned, ';
		
		if (nr_seq_tipo_episodio_w IS NOT NULL AND nr_seq_tipo_episodio_w::text <> '') then
			ds_sql_w := ds_sql_w || 'obter_nome_tipo_episodio('''|| nr_seq_tipo_episodio_w ||''') ds_tipo_episodio,';
		else
			ds_sql_w := ds_sql_w || 'null ds_tipo_episodio,';
		end if;
		
		if (nr_atend_discharge_w IS NOT NULL AND nr_atend_discharge_w::text <> '') then
			ds_sql_w := ds_sql_w || nr_atend_discharge_w || ' nr_atend_discharge, ';
		else
			ds_sql_w := ds_sql_w || 'null nr_atend_discharge, ';
		end if;
		
		if (nr_seq_proc_interno_p > 0) then
			ds_sql_w := ds_sql_w || '(select max(cp.ie_urgencia)
									  from	 cpoe_procedimento cp
									  where  cp.nr_atendimento = ac.nr_atendimento 
									  and	 cp.nr_seq_proc_interno = ac.nr_seq_proc_interno 
									  and	 cp.nr_seq_agenda = ac.nr_sequencia) ie_urgencia_cpoe, ';
		else
			ds_sql_w := ds_sql_w || 'null ie_urgencia_cpoe, ';
		end if;
	else
		if (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '') then
			ds_sql_w := ds_sql_w || ' '''|| cd_convenio_p ||''' cd_convenio, ';
			ds_sql_w := ds_sql_w || 'obter_desc_convenio('''|| cd_convenio_p ||''') ds_convenio, ';
			ds_sql_w := ds_sql_w || 'obter_desc_tipo_convenio('''|| cd_convenio_p ||''') ds_tipo_convenio, ';
		else
			ds_sql_w := ds_sql_w || 'null cd_convenio, ';
			ds_sql_w := ds_sql_w || 'null ds_convenio, ';
			ds_sql_w := ds_sql_w || 'null ds_tipo_convenio, ';
		end if;
	
		
		ds_sql_w := ds_sql_w || 'null nr_episodio, ';
		ds_sql_w := ds_sql_w || 'obter_desc_setor_atend(ac.cd_setor_atendimento) ds_setor_atendimento, ';
		ds_sql_w := ds_sql_w || 'null ds_departamento_medico, ';
		ds_sql_w := ds_sql_w || 'decode(obter_se_atendimento_futuro(ac.nr_atendimento), ''S'', ''P'', ''N'') ie_planned, ';
		ds_sql_w := ds_sql_w || 'null ds_tipo_episodio,';
		ds_sql_w := ds_sql_w || 'null nr_atend_discharge, ';
		ds_sql_w := ds_sql_w || 'null ie_urgencia_cpoe, ';
	end if;
	
	ds_sql_w := ds_sql_w || 'ac.ds_observacao, ';
	ds_sql_w := ds_sql_w || 'ac.nm_pessoa_contato, ';
	ds_sql_w := ds_sql_w || 'ac.ie_encaixe, ';
	
	if (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '') then
		ds_sql_w := ds_sql_w ||  nr_seq_episodio_w || ' nr_seq_episodio, ';
	else
		ds_sql_w := ds_sql_w ||  'null  nr_seq_episodio, ';
	end if;
	
	ds_sql_w := ds_sql_w || 'ac.dt_nascimento_pac dt_nascimento_pac, ';
	ds_sql_w := ds_sql_w || 'atend.ie_paciente_isolado ie_paciente_isolado, ';
	ds_sql_w := ds_sql_w || 'ac.nr_seq_person_name nr_seq_person_name, ';
	ds_sql_w := ds_sql_w || 'decode(ac.nr_atendimento, null, '''', (select decode(nvl(cep.ds_cor, ''''), '''', '''', (cep.ds_classificacao ||''' || div_w || '''|| cep.ds_cor))
																  from	classif_especial_paciente cep
																  where  cep.ie_situacao = ''A'' 
																  and	cep.nr_sequencia = nvl(atend.nr_seq_classif_esp, 0))) ie_sc_color ';

	return ds_sql_w;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION mult_schedule_pck.get_all_informations (cd_agenda_p agenda.cd_agenda%type, dt_agenda_p timestamp, nr_seq_agenda_p agenda_paciente.nr_sequencia%type, cd_tipo_agenda_p agenda.cd_tipo_agenda%type, nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_medico_p agenda_paciente.cd_medico%type, cd_medico_req_p agenda_paciente.cd_medico_req%type, cd_convenio_p convenio.cd_convenio%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_proc_interno_p agenda_paciente.nr_seq_proc_interno%type, hr_inicio_p text, hr_fim_p text, cd_estabelecimento_p text) FROM PUBLIC;
