-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	--FIM REGRA_CONDICAO DE CRUD, LEGENDA, MENU ITEM 
	 
	--DIC_OBJETOS DO OBJETO SCHEMATIC 
CREATE OR REPLACE PROCEDURE convert_schematic_to_bo_pck.copy_dic_objeto ( nr_seq_obj_sch_old_p bigint, nr_seq_obj_sch_new_p bigint, nr_seq_dic_old_p bigint, nr_seq_obj_sup_new_p bigint, nr_seq_bo_p bigint, nm_usuario_p text, nr_seq_dic_obj_new_p INOUT bigint) AS $body$
DECLARE

				 
	dic_objeto_w		dic_objeto%rowtype;
	nr_seq_dic_obj_w	dic_objeto.nr_sequencia%type;
	nr_seq_dic_obj_child_w	dic_objeto.nr_sequencia%type;
	i integer;
	
	c01 CURSOR FOR 
	SELECT	a.* 
	from	dic_objeto a 
	where	a.nr_seq_obj_sup = nr_seq_dic_old_p 
	order by nr_seq_mi_sup desc;
	
	c01_w	c01%rowtype;	
		 
	
BEGIN 
 
	select	* 
	into STRICT	dic_objeto_w 
	from	dic_objeto 
	where	nr_sequencia = nr_seq_dic_old_p;
	 
	select	nextval('dic_objeto_seq') 
	into STRICT	nr_seq_dic_obj_w 
	;
	 
	dic_objeto_w.nr_sequencia		:= nr_seq_dic_obj_w;
	dic_objeto_w.cd_funcao			:= null;
	dic_objeto_w.nr_seq_bo			:= nr_seq_bo_p;
	dic_objeto_w.nm_usuario			:= nm_usuario_p;
	dic_objeto_w.nm_usuario_nrec		:= nm_usuario_p;
	dic_objeto_w.dt_atualizacao		:= clock_timestamp();
	dic_objeto_w.dt_atualizacao_nrec	:= clock_timestamp();
	if (nr_seq_obj_sup_new_p IS NOT NULL AND nr_seq_obj_sup_new_p::text <> '') then 
		dic_objeto_w.nr_seq_obj_sup	:= nr_seq_obj_sup_new_p;
	end if;
	 
	if (dic_objeto_w.nr_seq_mi_sup IS NOT NULL AND dic_objeto_w.nr_seq_mi_sup::text <> '') and (dic_objeto_w.nr_seq_mi_sup not in (360696, 360713, 360714, 360715, 360716, 360728)) then --opcoes padrões da HandleBar 
		dic_objeto_w.nr_seq_mi_sup	:= convert_schematic_to_bo_pck.get_seq_dic_obj_new(dic_objeto_w.nr_seq_mi_sup);
	end if;
	 
	insert into dic_objeto values (dic_objeto_w.*);
	 
	i := current_setting('convert_schematic_to_bo_pck.array_dic_obj_cp_w')::dic_obj_cp.count + 1;
	current_setting('convert_schematic_to_bo_pck.array_dic_obj_cp_w')::dic_obj_cp[i].nr_seq_dic_obj_old	:= nr_seq_dic_old_p;
	current_setting('convert_schematic_to_bo_pck.array_dic_obj_cp_w')::dic_obj_cp[i].nr_seq_dic_obj_new	:= nr_seq_dic_obj_w;	
	 
	--copia os eventos do menu item para o obj_schematic que está sendo copiado	 
	CALL convert_schematic_to_bo_pck.copy_obj_schematic_evento( nr_seq_obj_sch_old_p, nr_seq_obj_sch_new_p, nr_seq_dic_old_p, nr_seq_dic_obj_w);
	--copia as regras de enabled dos menus 
	CALL convert_schematic_to_bo_pck.copy_regra_condicao( null, null, nr_seq_obj_sch_old_p, nr_seq_obj_sch_new_p, nr_seq_dic_old_p, nr_seq_dic_obj_w, null, null, null, null);
	--copia registros filhos da dic_objeto_filtro 
	CALL convert_schematic_to_bo_pck.copy_dic_obj_filtro( nr_seq_dic_old_p, nr_seq_dic_obj_w);
 
	open C01;
	loop 
	fetch C01 into 
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	 
		nr_seq_dic_obj_child_w := convert_schematic_to_bo_pck.copy_dic_objeto(nr_seq_obj_sch_old_p, nr_seq_obj_sch_new_p, c01_w.nr_sequencia, nr_seq_dic_obj_w, nr_seq_bo_p, nm_usuario_p, nr_seq_dic_obj_child_w);	
	 
	end loop;
	close C01;
	 
	nr_seq_dic_obj_new_p	:= nr_seq_dic_obj_w;
	 
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE convert_schematic_to_bo_pck.copy_dic_objeto ( nr_seq_obj_sch_old_p bigint, nr_seq_obj_sch_new_p bigint, nr_seq_dic_old_p bigint, nr_seq_obj_sup_new_p bigint, nr_seq_bo_p bigint, nm_usuario_p text, nr_seq_dic_obj_new_p INOUT bigint) FROM PUBLIC;
