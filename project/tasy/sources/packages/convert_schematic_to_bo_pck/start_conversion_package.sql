-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE convert_schematic_to_bo_pck.start_conversion ( nr_seq_funcao_schematic_p bigint, nr_seq_objeto_start_p bigint, nr_level_end_p bigint, nr_seq_bo_p bigint, nm_usuario_p text) AS $body$
WITH RECURSIVE cte AS (
DECLARE

 
 
	c01 CURSOR FOR 
	SELECT 	a.*,1 as level,ARRAY[ row_number() OVER (ORDER BY  nr_seq_obj_sup desc) ] as hierarchy 
	from 	objeto_schematic a WHERE a.nr_sequencia 		= nr_seq_objeto_start_p 
	and 	a.nr_seq_funcao_schematic 	= nr_seq_funcao_schematic_p
  UNION ALL
DECLARE
 
 
 
	c01 CURSOR FOR 
	SELECT 	a.*,(c.level+1), array_append(c.hierarchy, row_number() OVER (ORDER BY  nr_seq_obj_sup desc))  as hierarchy 
	from 	objeto_schematic a JOIN cte c ON (c.prior nr_sequencia = a.nr_seq_obj_sup)

) SELECT * FROM cte WHERE nr_seq_funcao_schematic 	= nr_seq_funcao_schematic_p 
	and	ie_tipo_objeto		<> 'P' 
	and	level	<= nr_level_end_p ORDER BY hierarchy;
;

	c01_w	c01%rowtype;

	
BEGIN 
 
	PERFORM set_config('convert_schematic_to_bo_pck.nm_usuario_w', nm_usuario_p, false);
	PERFORM set_config('convert_schematic_to_bo_pck.nr_seq_bo_w', nr_seq_bo_p, false);
	PERFORM set_config('convert_schematic_to_bo_pck.nr_seq_funcao_schematic_w', nr_seq_funcao_schematic_p, false);
 
	open C01;
	loop 
	fetch C01 into 
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
 
		CALL convert_schematic_to_bo_pck.convert_objeto_schematic(c01_w.nr_sequencia);
 
	end loop;
	close C01;
 
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE convert_schematic_to_bo_pck.start_conversion ( nr_seq_funcao_schematic_p bigint, nr_seq_objeto_start_p bigint, nr_level_end_p bigint, nr_seq_bo_p bigint, nm_usuario_p text) FROM PUBLIC;
