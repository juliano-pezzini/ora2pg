-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION ageint_sugerir_html5_pck.get_questao_item (nr_seq_ageint_p bigint, cd_estabelecimento_p bigint, ie_apenas_agendamento_p text DEFAULT 'N') RETURNS SETOF QUEST_T AS $body$
DECLARE



  c_itens CURSOR(nr_seq_ageint_p bigint) FOR
    SELECT ai.cd_convenio,
           ai.cd_categoria,
           ai.cd_plano,
           ai.qt_idade_pac,
           obter_tipo_convenio(ai.cd_convenio) AS ie_tipo_convenio,
           aii.ie_tipo_agendamento AS ie_tipo_item,
           aii.cd_medico,
           ai.ie_sexo,
           aii.nr_seq_proc_interno,
           aii.cd_procedimento,
           aii.ie_origem_proced,
           aii.nr_sequencia,
           aii.nr_seq_agenda_int,
           substr(obter_item_grid_ageint(aii.nr_seq_proc_interno, aii.cd_medico, aii.cd_especialidade, 1), 1, 255) ds_item,
           ageint_obter_prior_apresent(aii.nr_seq_agenda_int,
                                       aii.nr_seq_proc_interno,
                                       obter_estabelecimento_ativo,
                                       aii.nr_seq_grupo_selec,
                                       aii.nr_sequencia) nr_seq_ordem_apresent,
           ageint_obter_prioridade(aii.nr_seq_agenda_int,
                                   aii.nr_seq_proc_interno,
                                   obter_estabelecimento_ativo,
                                   aii.nr_seq_grupo_selec) nr_seq_ordem,
					 aii.nr_seq_ageint_item_transf
      FROM agenda_integrada      ai,
           agenda_integrada_item aii
     WHERE aii.nr_seq_agenda_int = ai.nr_sequencia
       AND ai.nr_sequencia = nr_seq_ageint_p
       AND (ie_apenas_agendamento_p = 'N'
          OR exists (SELECT 1
                    from ageint_marcacao_usuario x
                    where coalesce(x.ie_gerado, 'N') = 'N'
                    and x.nr_seq_ageint_item = aii.nr_sequencia))
     ORDER BY nr_seq_ordem_apresent,
              nr_seq_ordem;

  c_bloqueio CURSOR(nr_seq_estrutura_p     bigint,
                    cd_estabelecimento_p   bigint,
                    cd_area_procedimento_p bigint,
                    cd_grupo_proc_p        bigint,
                    ie_tipo_item_p         text,
                    nr_seq_proc_interno_p  bigint,
                    cd_especialidade_p     bigint,
                    cd_medico_p            text,
                    cd_convenio_p          bigint,
                    cd_categoria_p         text,
                    cd_plano_convenio_p    text,
                    ie_tipo_convenio_p     text,
                    qt_idade_pac_p         bigint,
                    ie_sexo_p              text) FOR
    SELECT aqrb.ie_bloquear,
           aqrb.ds_alerta,
           aqrb.nr_seq_resposta
      FROM ageint_quest_regra_bloq aqrb,
           ageint_quest_utilizacao aqu
     WHERE coalesce(aqu.ie_situacao, 'A') = 'A'
       AND coalesce(aqrb.ie_situacao, 'A') = 'A'
       AND aqrb.nr_seq_estrutura = nr_seq_estrutura_p
       AND aqrb.nr_seq_estrutura = aqu.nr_seq_estrutura
       AND aqrb.nr_seq_quest_utilizacao = aqu.nr_sequencia
       AND (coalesce(aqu.cd_estabelecimento::text, '') = '' OR cd_estabelecimento_p = aqu.cd_estabelecimento)
       AND (coalesce(aqu.cd_area_procedimento::text, '') = '' OR cd_area_procedimento_p = aqu.cd_area_procedimento)
       AND (coalesce(aqu.cd_grupo_proc::text, '') = '' OR cd_grupo_proc_p = aqu.cd_grupo_proc)
       AND (coalesce(aqu.ie_tipo_item::text, '') = '' OR ie_tipo_item_p = aqu.ie_tipo_item)
       AND (coalesce(aqu.nr_seq_proc_interno::text, '') = '' OR nr_seq_proc_interno_p = aqu.nr_seq_proc_interno)
       AND (coalesce(aqu.cd_especialidade::text, '') = '' OR cd_especialidade_p = aqu.cd_especialidade)
       AND (coalesce(aqu.cd_medico::text, '') = '' OR cd_medico_p = aqu.cd_medico)
       AND (coalesce(aqu.cd_convenio::text, '') = '' OR cd_convenio_p = aqu.cd_convenio)
       AND (coalesce(aqu.cd_categoria::text, '') = '' OR cd_categoria_p = aqu.cd_categoria)
       AND (coalesce(aqu.cd_plano_convenio::text, '') = '' OR cd_plano_convenio_p = aqu.cd_plano_convenio)
       AND (coalesce(aqu.ie_tipo_convenio::text, '') = '' OR ie_tipo_convenio_p = aqu.ie_tipo_convenio)
       AND (coalesce(aqu.qt_idade_min::text, '') = '' OR qt_idade_pac_p >= aqu.qt_idade_min)
       AND (coalesce(aqu.qt_idade_max::text, '') = '' OR qt_idade_pac_p <= aqu.qt_idade_max)
	   AND((coalesce(aqu.nr_seq_grupo_proc::text, '') = '') OR ((aqu.nr_seq_grupo_proc IS NOT NULL AND aqu.nr_seq_grupo_proc::text <> '') AND EXISTS (SELECT	1
																						FROM 	ageint_proced_regra d
																						WHERE 	d.nr_seq_grupo			= aqu.nr_seq_grupo_proc
																						AND		d.nr_seq_proc_interno	= nr_seq_proc_interno_p
																						AND 	coalesce(d.ie_situacao,'A') = 'A')))
       AND (coalesce(aqu.ie_sexo, 'A') = 'A' OR ie_sexo_p = aqu.ie_sexo)

UNION ALL

    SELECT 'N',
           '',
           NULL
;WITH RECURSIVE cte AS (
 -- Gera um registro em branco

  c_questionario CURSOR(nr_seq_ageint_p        bigint,
                        cd_area_procedimento_p bigint,
                        cd_grupo_proc_p        bigint,
                        ie_tipo_item_p         text,
                        nr_seq_proc_interno_p  bigint,
                        cd_especialidade_p     bigint,
                        cd_medico_p            text,
                        cd_convenio_p          bigint,
                        cd_categoria_p         text,
                        cd_plano_convenio_p    text,
                        ie_tipo_convenio_p     text,
                        qt_idade_pac_p         bigint,
                        ie_sexo_p              text) IS

    WITH tab_est AS
     (SELECT aqe.nr_sequencia,
             aqe.ie_obrigatorio,
             aqe.nr_seq_pergunta,
             aqe.nr_seq_superior,
             aqe.ie_tipo_resposta,
             aqe.nr_seq_grupo_resp,
             aqe.nr_seq_ordem_apres,
             MAX(aqu.nr_sequencia) AS nr_seq_quest_util,
						 aqu.ie_questionar_trans
        FROM ageint_quest_estrutura  aqe,
             ageint_quest_utilizacao aqu
       WHERE coalesce(aqu.ie_situacao, 'A') = 'A'
         AND coalesce(aqe.ie_situacao, 'A') = 'A'
         AND coalesce(aqu.ie_tipo_regra, 'H') = 'H'
         AND aqe.nr_sequencia = aqu.nr_seq_estrutura
         AND (coalesce(aqu.cd_estabelecimento::text, '') = '' OR cd_estabelecimento_p = aqu.cd_estabelecimento)
         AND (coalesce(aqu.cd_area_procedimento::text, '') = '' OR cd_area_procedimento_p = aqu.cd_area_procedimento)
         AND (coalesce(aqu.cd_grupo_proc::text, '') = '' OR cd_grupo_proc_p = aqu.cd_grupo_proc)
         AND (coalesce(aqu.ie_tipo_item::text, '') = '' OR ie_tipo_item_p = aqu.ie_tipo_item)
         AND (coalesce(aqu.nr_seq_proc_interno::text, '') = '' OR nr_seq_proc_interno_p = aqu.nr_seq_proc_interno)
         AND (coalesce(aqu.cd_especialidade::text, '') = '' OR cd_especialidade_p = aqu.cd_especialidade)
         AND (coalesce(aqu.cd_medico::text, '') = '' OR cd_medico_p = aqu.cd_medico)
         AND (coalesce(aqu.cd_convenio::text, '') = '' OR cd_convenio_p = aqu.cd_convenio)
         AND (coalesce(aqu.cd_categoria::text, '') = '' OR cd_categoria_p = aqu.cd_categoria)
         AND (coalesce(aqu.cd_plano_convenio::text, '') = '' OR cd_plano_convenio_p = aqu.cd_plano_convenio)
         AND (coalesce(aqu.ie_tipo_convenio::text, '') = '' OR ie_tipo_convenio_p = aqu.ie_tipo_convenio)
         AND (coalesce(aqu.qt_idade_min::text, '') = '' OR qt_idade_pac_p >= aqu.qt_idade_min)
         AND (coalesce(aqu.qt_idade_max::text, '') = '' OR qt_idade_pac_p <= aqu.qt_idade_max)
		 AND ((coalesce(aqu.nr_seq_grupo_proc::text, '') = '') OR ((aqu.nr_seq_grupo_proc IS NOT NULL AND aqu.nr_seq_grupo_proc::text <> '') AND EXISTS (SELECT	1
																						FROM 	ageint_proced_regra d
																						WHERE 	d.nr_seq_grupo			= aqu.nr_seq_grupo_proc
																						AND		d.nr_seq_proc_interno	= nr_seq_proc_interno_p
																						AND 	coalesce(d.ie_situacao,'A') = 'A')))
         AND (coalesce(aqu.ie_sexo, 'A') = 'A' OR ie_sexo_p = aqu.ie_sexo)
         AND NOT EXISTS
       (SELECT 1
                FROM ageint_quest_utilizacao aqu1
               WHERE coalesce(aqu1.ie_tipo_regra, 'H') = 'B'
                 AND aqe.nr_sequencia = aqu1.nr_seq_estrutura
                 AND (coalesce(aqu1.cd_estabelecimento::text, '') = '' OR cd_estabelecimento_p = aqu1.cd_estabelecimento)
                 AND (coalesce(aqu1.cd_area_procedimento::text, '') = '' OR cd_area_procedimento_p = aqu1.cd_area_procedimento)
                 AND (coalesce(aqu1.cd_grupo_proc::text, '') = '' OR cd_grupo_proc_p = aqu1.cd_grupo_proc)
                 AND (coalesce(aqu1.ie_tipo_item::text, '') = '' OR ie_tipo_item_p = aqu1.ie_tipo_item)
                 AND (coalesce(aqu1.nr_seq_proc_interno::text, '') = '' OR nr_seq_proc_interno_p = aqu1.nr_seq_proc_interno)
                 AND (coalesce(aqu1.cd_especialidade::text, '') = '' OR cd_especialidade_p = aqu1.cd_especialidade)
                 AND (coalesce(aqu1.cd_medico::text, '') = '' OR cd_medico_p = aqu1.cd_medico)
                 AND (coalesce(aqu1.cd_convenio::text, '') = '' OR cd_convenio_p = aqu1.cd_convenio)
                 AND (coalesce(aqu1.cd_categoria::text, '') = '' OR cd_categoria_p = aqu1.cd_categoria)
                 AND (coalesce(aqu1.cd_plano_convenio::text, '') = '' OR cd_plano_convenio_p = aqu1.cd_plano_convenio)
                 AND (coalesce(aqu1.ie_tipo_convenio::text, '') = '' OR ie_tipo_convenio_p = aqu1.ie_tipo_convenio)
                 AND (coalesce(aqu1.qt_idade_min::text, '') = '' OR qt_idade_pac_p >= aqu1.qt_idade_min)
                 AND (coalesce(aqu1.qt_idade_max::text, '') = '' OR qt_idade_pac_p <= aqu1.qt_idade_max)
				 AND ((coalesce(aqu1.nr_seq_grupo_proc::text, '') = '') OR ((aqu1.nr_seq_grupo_proc IS NOT NULL AND aqu1.nr_seq_grupo_proc::text <> '') AND EXISTS (SELECT	1
																						FROM 	ageint_proced_regra d
																						WHERE 	d.nr_seq_grupo			= aqu1.nr_seq_grupo_proc
																						AND		d.nr_seq_proc_interno	= nr_seq_proc_interno_p
																						AND 	coalesce(d.ie_situacao,'A') = 'A')))
                 AND (coalesce(aqu1.ie_sexo, 'A') = 'A' OR ie_sexo_p = aqu1.ie_sexo))
       GROUP BY aqe.nr_sequencia,
                aqe.ie_obrigatorio,
                aqe.nr_seq_pergunta,
                aqe.nr_seq_superior,
                aqe.ie_tipo_resposta,
                aqe.nr_seq_grupo_resp,
                aqe.nr_seq_ordem_apres,
								aqu.ie_questionar_trans)
    SELECT aqe.nr_sequencia,aqe.nr_seq_superior,aqe.nr_seq_pergunta,aqe.ie_tipo_resposta,coalesce(aqe.ie_obrigatorio, 'N') AS ie_obrigatorio,1 lvl,connect_by_root aqe.nr_sequencia nr_seq_root,row_number() OVER () AS ordz,aqp.ds_pergunta,arq.nr_seq_resp,coalesce(arq.nr_seq_ageint, nr_seq_ageint_p) nr_seq_ageint,agiq_obter_resposta_grid(NULL, arq.nr_seq_estrutura, arq.nr_seq_resp, arq.ds_resposta) ds_resposta_grid,arq.ds_resposta,arq.nr_sequencia AS nr_seq_resp_utl,arq.ie_tipo_quest,aqe.nr_seq_quest_util,aqe.ie_questionar_trans,ARRAY[ row_number() OVER (ORDER BY  coalesce(aqe.nr_seq_ordem_apres, aqe.nr_sequencia)) ] as hierarchy
      FROM ageint_quest_perguntas aqp, tab_est aqe
LEFT OUTER JOIN ageint_resp_quest arq ON (aqe.nr_sequencia = arq.nr_seq_estrutura AND nr_seq_ageint_p = arq.nr_seq_ageint) WHERE coalesce(aqe.nr_seq_superior::text, '') = ''
  UNION ALL


  c_questionario CURSOR(nr_seq_ageint_p        bigint,
                        cd_area_procedimento_p bigint,
                        cd_grupo_proc_p        bigint,
                        ie_tipo_item_p         text,
                        nr_seq_proc_interno_p  bigint,
                        cd_especialidade_p     bigint,
                        cd_medico_p            text,
                        cd_convenio_p          bigint,
                        cd_categoria_p         text,
                        cd_plano_convenio_p    text,
                        ie_tipo_convenio_p     text,
                        qt_idade_pac_p         bigint,
                        ie_sexo_p              text) IS

    WITH tab_est AS
     (SELECT aqe.nr_sequencia,
             aqe.ie_obrigatorio,
             aqe.nr_seq_pergunta,
             aqe.nr_seq_superior,
             aqe.ie_tipo_resposta,
             aqe.nr_seq_grupo_resp,
             aqe.nr_seq_ordem_apres,
             MAX(aqu.nr_sequencia) AS nr_seq_quest_util,
						 aqu.ie_questionar_trans
        FROM ageint_quest_estrutura  aqe,
             ageint_quest_utilizacao aqu
       WHERE coalesce(aqu.ie_situacao, 'A') = 'A'
         AND coalesce(aqe.ie_situacao, 'A') = 'A'
         AND coalesce(aqu.ie_tipo_regra, 'H') = 'H'
         AND aqe.nr_sequencia = aqu.nr_seq_estrutura
         AND (coalesce(aqu.cd_estabelecimento::text, '') = '' OR cd_estabelecimento_p = aqu.cd_estabelecimento)
         AND (coalesce(aqu.cd_area_procedimento::text, '') = '' OR cd_area_procedimento_p = aqu.cd_area_procedimento)
         AND (coalesce(aqu.cd_grupo_proc::text, '') = '' OR cd_grupo_proc_p = aqu.cd_grupo_proc)
         AND (coalesce(aqu.ie_tipo_item::text, '') = '' OR ie_tipo_item_p = aqu.ie_tipo_item)
         AND (coalesce(aqu.nr_seq_proc_interno::text, '') = '' OR nr_seq_proc_interno_p = aqu.nr_seq_proc_interno)
         AND (coalesce(aqu.cd_especialidade::text, '') = '' OR cd_especialidade_p = aqu.cd_especialidade)
         AND (coalesce(aqu.cd_medico::text, '') = '' OR cd_medico_p = aqu.cd_medico)
         AND (coalesce(aqu.cd_convenio::text, '') = '' OR cd_convenio_p = aqu.cd_convenio)
         AND (coalesce(aqu.cd_categoria::text, '') = '' OR cd_categoria_p = aqu.cd_categoria)
         AND (coalesce(aqu.cd_plano_convenio::text, '') = '' OR cd_plano_convenio_p = aqu.cd_plano_convenio)
         AND (coalesce(aqu.ie_tipo_convenio::text, '') = '' OR ie_tipo_convenio_p = aqu.ie_tipo_convenio)
         AND (coalesce(aqu.qt_idade_min::text, '') = '' OR qt_idade_pac_p >= aqu.qt_idade_min)
         AND (coalesce(aqu.qt_idade_max::text, '') = '' OR qt_idade_pac_p <= aqu.qt_idade_max)
		 AND ((coalesce(aqu.nr_seq_grupo_proc::text, '') = '') OR ((aqu.nr_seq_grupo_proc IS NOT NULL AND aqu.nr_seq_grupo_proc::text <> '') AND EXISTS (SELECT	1
																						FROM 	ageint_proced_regra d
																						WHERE 	d.nr_seq_grupo			= aqu.nr_seq_grupo_proc
																						AND		d.nr_seq_proc_interno	= nr_seq_proc_interno_p
																						AND 	coalesce(d.ie_situacao,'A') = 'A')))
         AND (coalesce(aqu.ie_sexo, 'A') = 'A' OR ie_sexo_p = aqu.ie_sexo)
         AND NOT EXISTS
       (SELECT 1
                FROM ageint_quest_utilizacao aqu1
               WHERE coalesce(aqu1.ie_tipo_regra, 'H') = 'B'
                 AND aqe.nr_sequencia = aqu1.nr_seq_estrutura
                 AND (coalesce(aqu1.cd_estabelecimento::text, '') = '' OR cd_estabelecimento_p = aqu1.cd_estabelecimento)
                 AND (coalesce(aqu1.cd_area_procedimento::text, '') = '' OR cd_area_procedimento_p = aqu1.cd_area_procedimento)
                 AND (coalesce(aqu1.cd_grupo_proc::text, '') = '' OR cd_grupo_proc_p = aqu1.cd_grupo_proc)
                 AND (coalesce(aqu1.ie_tipo_item::text, '') = '' OR ie_tipo_item_p = aqu1.ie_tipo_item)
                 AND (coalesce(aqu1.nr_seq_proc_interno::text, '') = '' OR nr_seq_proc_interno_p = aqu1.nr_seq_proc_interno)
                 AND (coalesce(aqu1.cd_especialidade::text, '') = '' OR cd_especialidade_p = aqu1.cd_especialidade)
                 AND (coalesce(aqu1.cd_medico::text, '') = '' OR cd_medico_p = aqu1.cd_medico)
                 AND (coalesce(aqu1.cd_convenio::text, '') = '' OR cd_convenio_p = aqu1.cd_convenio)
                 AND (coalesce(aqu1.cd_categoria::text, '') = '' OR cd_categoria_p = aqu1.cd_categoria)
                 AND (coalesce(aqu1.cd_plano_convenio::text, '') = '' OR cd_plano_convenio_p = aqu1.cd_plano_convenio)
                 AND (coalesce(aqu1.ie_tipo_convenio::text, '') = '' OR ie_tipo_convenio_p = aqu1.ie_tipo_convenio)
                 AND (coalesce(aqu1.qt_idade_min::text, '') = '' OR qt_idade_pac_p >= aqu1.qt_idade_min)
                 AND (coalesce(aqu1.qt_idade_max::text, '') = '' OR qt_idade_pac_p <= aqu1.qt_idade_max)
				 AND ((coalesce(aqu1.nr_seq_grupo_proc::text, '') = '') OR ((aqu1.nr_seq_grupo_proc IS NOT NULL AND aqu1.nr_seq_grupo_proc::text <> '') AND EXISTS (SELECT	1
																						FROM 	ageint_proced_regra d
																						WHERE 	d.nr_seq_grupo			= aqu1.nr_seq_grupo_proc
																						AND		d.nr_seq_proc_interno	= nr_seq_proc_interno_p
																						AND 	coalesce(d.ie_situacao,'A') = 'A')))
                 AND (coalesce(aqu1.ie_sexo, 'A') = 'A' OR ie_sexo_p = aqu1.ie_sexo))
       GROUP BY aqe.nr_sequencia,
                aqe.ie_obrigatorio,
                aqe.nr_seq_pergunta,
                aqe.nr_seq_superior,
                aqe.ie_tipo_resposta,
                aqe.nr_seq_grupo_resp,
                aqe.nr_seq_ordem_apres,
								aqu.ie_questionar_trans)
    SELECT aqe.nr_sequencia,aqe.nr_seq_superior,aqe.nr_seq_pergunta,aqe.ie_tipo_resposta,coalesce(aqe.ie_obrigatorio, 'N') AS ie_obrigatorio,(c.level+1) lvl,connect_by_root aqe.nr_sequencia nr_seq_root,row_number() OVER () AS ordz,aqp.ds_pergunta,arq.nr_seq_resp,coalesce(arq.nr_seq_ageint, nr_seq_ageint_p) nr_seq_ageint,agiq_obter_resposta_grid(NULL, arq.nr_seq_estrutura, arq.nr_seq_resp, arq.ds_resposta) ds_resposta_grid,arq.ds_resposta,arq.nr_sequencia AS nr_seq_resp_utl,arq.ie_tipo_quest,aqe.nr_seq_quest_util,aqe.ie_questionar_trans, array_append(c.hierarchy, row_number() OVER (ORDER BY  coalesce(aqe.nr_seq_ordem_apres, aqe.nr_sequencia)))  as hierarchy
      FROM ageint_quest_perguntas aqp, tab_est aqe
LEFT OUTER JOIN ageint_resp_quest arq ON (aqe.nr_sequencia = arq.nr_seq_estrutura AND nr_seq_ageint_p = arq.nr_seq_ageint) JOIN cte c ON (c.nr_sequencia = aqp.aqe.nr_seq_superior)

) SELECT * FROM cte WHERE aqp.nr_sequencia = aqe.nr_seq_pergunta ORDER BY hierarchy;
;



  c_habilita CURSOR(nr_seq_estrutura_p bigint) FOR
    SELECT aqer.nr_seq_resp_ant FROM ageint_quest_estrut_resp aqer WHERE aqer.nr_seq_estrutura = nr_seq_estrutura_p;

  cd_area_procedimento_w bigint := NULL;
  cd_grupo_proc_w        bigint := NULL;
  cd_especialidade_w     bigint := NULL;
  cd_pessoa_fisica_w     ageint_marcacao_usuario.cd_pessoa_fisica%type;
  ie_tipo_quest_w        ageint_resp_quest.ie_tipo_quest%type;
  ie_status_item_w       varchar(100);
  ie_readonly_w          varchar(1);


  quest_w quest_r;
BEGIN
  FOR i IN c_itens(nr_seq_ageint_p => nr_seq_ageint_p) LOOP

    IF (i.ie_tipo_item NOT IN ('CI', 'CH', 'Q')) THEN

      SELECT MAX(cd_area_procedimento),
             MAX(cd_grupo_proc),
             MAX(cd_especialidade)
        INTO STRICT cd_area_procedimento_w,
             cd_grupo_proc_w,
             cd_especialidade_w
        FROM estrutura_procedimento_v
       WHERE cd_procedimento = i.cd_procedimento
         AND ie_origem_proced = i.ie_origem_proced;
    ELSE
      cd_area_procedimento_w := NULL;
      cd_grupo_proc_w        := NULL;
      cd_especialidade_w     := NULL;
    END IF;
    /*  dbms_output.put_line ('Item:');
    dbms_output.put_line (' nr_sequencia: '|| i.nr_sequencia||
                          ' nr_seq_agenda_int: '||i.nr_seq_agenda_int||
                          ' ds_item: '||i.ds_item||
                          ' nr_seq_ordem_apresent: '||i.nr_seq_ordem_apresent||
                          ' nr_seq_ordem: '||i.nr_seq_ordem);  */


    quest_w.nr_seq_ageint_item       := i.nr_sequencia;
    quest_w.nr_seq_agenda_int     := i.nr_seq_agenda_int;
    quest_w.ds_item               := i.ds_item;
    quest_w.nr_seq_ordem_apresent := i.nr_seq_ordem_apresent;
    quest_w.nr_seq_ordem          := i.nr_seq_ordem;

    select max(cd_pessoa_fisica)
    into STRICT   cd_pessoa_fisica_w
    from   ageint_marcacao_usuario
    where  nr_seq_ageint 	= nr_seq_ageint_p
    and    nr_seq_ageint_item	= quest_w.nr_seq_ageint_item;

    --dbms_output.put_line('Questoes:');

    FOR q IN c_questionario(nr_seq_ageint_p        => nr_seq_ageint_p,
                            cd_area_procedimento_p => cd_area_procedimento_w,
                            cd_grupo_proc_p        => cd_grupo_proc_w,
                            ie_tipo_item_p         => i.ie_tipo_item,
                            nr_seq_proc_interno_p  => i.nr_seq_proc_interno,
                            cd_especialidade_p     => cd_especialidade_w,
                            cd_medico_p            => coalesce(i.cd_medico,cd_pessoa_fisica_w),
                            cd_convenio_p          => i.cd_convenio,
                            cd_categoria_p         => i.cd_categoria,
                            cd_plano_convenio_p    => i.cd_plano,
                            ie_tipo_convenio_p     => i.ie_tipo_convenio,
                            qt_idade_pac_p         => i.qt_idade_pac,
                            ie_sexo_p              => i.ie_sexo) LOOP

        select CASE WHEN count(1)=0 THEN 'A'  ELSE 'T' END
        into STRICT   ie_tipo_quest_w
        from   ageint_marcacao_usuario
        where  nr_seq_ageint 	= nr_seq_ageint_p
        and    nr_seq_ageint_item	= quest_w.nr_seq_ageint_item
        and    coalesce(ie_gerado, 'N') = 'S';

      if (q.nr_seq_ageint IS NOT NULL AND q.nr_seq_ageint::text <> '') and
      ((q.ie_questionar_trans <> 'N' AND i.nr_seq_ageint_item_transf IS NOT NULL AND i.nr_seq_ageint_item_transf::text <> '')
			or (coalesce(i.nr_seq_ageint_item_transf::text, '') = '')) then

      ie_status_item_w := ageint_obter_status_item(q.nr_seq_ageint, i.nr_sequencia, 'C');

        if (ie_tipo_quest_w = 'T' and q.ie_questionar_trans = 'N') or (ie_tipo_quest_w = 'T' and ie_status_item_w in ('L', 'LF')) then
          ie_readonly_w := 'S';
        else
          ie_readonly_w := agiq_obter_se_questao_readonly(q.nr_seq_ageint, q.nr_seq_resp_utl);
        end if;

				quest_w.nr_sequencia     := q.nr_seq_resp_utl;
				quest_w.nr_seq_estrutura := q.nr_sequencia;
				quest_w.nr_seq_superior  := q.nr_seq_superior;
				quest_w.nr_seq_pergunta  := q.nr_seq_pergunta;
				quest_w.ds_pergunta      := q.ds_pergunta;
				quest_w.nr_seq_resp      := q.nr_seq_resp;
				quest_w.ds_resposta      := q.ds_resposta;
				quest_w.ie_tipo_quest    := q.ie_tipo_quest;
				quest_w.ie_obrigatorio   := q.ie_obrigatorio;
				quest_w.ds_resposta_grid := q.ds_resposta_grid;
				quest_w.ie_tipo_resposta := q.ie_tipo_resposta;
				quest_w.ie_readonly      := ie_readonly_w;
				quest_w.lvl              := q.lvl;
				quest_w.nr_seq_root      := q.nr_seq_root;
				quest_w.ordz             := q.ordz;
				quest_w.nr_seq_quest_util:= q.nr_seq_quest_util;

				quest_w.ie_bloquear    := 'N';
				quest_w.ds_alerta      := '';
				quest_w.cd_dependencia := '';
				quest_w.cd_bloquear    := '';
				/*  dbms_output.put_line ('Bloquerio:');   */


				FOR b IN c_bloqueio(nr_seq_estrutura_p     => q.nr_sequencia,
														cd_estabelecimento_p   => cd_estabelecimento_p,
														cd_area_procedimento_p => cd_area_procedimento_w,
														cd_grupo_proc_p        => cd_grupo_proc_w,
														ie_tipo_item_p         => i.ie_tipo_item,
														nr_seq_proc_interno_p  => i.nr_seq_proc_interno,
														cd_especialidade_p     => cd_especialidade_w,
														cd_medico_p            => coalesce(i.cd_medico,cd_pessoa_fisica_w),
														cd_convenio_p          => i.cd_convenio,
														cd_categoria_p         => i.cd_categoria,
														cd_plano_convenio_p    => i.cd_plano,
														ie_tipo_convenio_p     => i.ie_tipo_convenio,
														qt_idade_pac_p         => i.qt_idade_pac,
														ie_sexo_p              => i.ie_sexo) LOOP

					/*  dbms_output.put_line (' ie_bloquear:'||b.ie_bloquear||
					' ds_alerta:'||b.ds_alerta);*/

					IF b.ie_bloquear = 'S' THEN
						quest_w.ie_bloquear := 'S';
					 -- IF instr(quest_w.cd_bloquear, ';'|| b.nr_seq_resposta) IS NULL THEN

											quest_w.cd_bloquear :=  quest_w.cd_bloquear ||';'|| b.nr_seq_resposta;
					 -- END IF;

					END IF;
					IF (b.ds_alerta IS NOT NULL AND b.ds_alerta::text <> '') THEN
						quest_w.ds_alerta := quest_w.ds_alerta || '@;' || b.nr_seq_resposta ||'@:'||b.ds_alerta;
						/*
						 aqrb.ie_bloquear,
						 aqrb.ds_alerta
						 aqrb.nr_seq_resposta
						*/



					END IF;

				END LOOP;
				FOR d IN c_habilita(q.nr_sequencia) LOOP
					quest_w.cd_dependencia := d.nr_seq_resp_ant || ';' || quest_w.cd_dependencia;
				END LOOP;
				RETURN NEXT quest_w;
			end if;
    END LOOP;
  END LOOP;
  RETURN;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION ageint_sugerir_html5_pck.get_questao_item (nr_seq_ageint_p bigint, cd_estabelecimento_p bigint, ie_apenas_agendamento_p text DEFAULT 'N') FROM PUBLIC;
