-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ageint_sugerir_html5_pck.obter_info_item_padrao ( nr_seq_ageint_p bigint, nr_seq_ageint_item_p bigint, cd_procedimento_p bigint, nr_seq_proc_interno_p bigint, ie_origem_proced_p bigint, cd_convenio_ageint_p bigint, cd_categoria_ageint_p text, cd_plano_ageint_p text, nr_seq_grupo_selec_p bigint, qt_item_adic_p INOUT bigint, cd_conv_item_p INOUT bigint, cd_categ_item_p INOUT text, cd_plano_item_p INOUT text, qt_bloq_exam_p INOUT bigint, cd_proc_tab_int_p INOUT bigint, ie_orig_tab_int_p INOUT bigint, cd_area_proced_p INOUT bigint, cd_espec_proced_p INOUT bigint, cd_grupo_proced_p INOUT bigint, nr_seq_forma_org_p INOUT bigint, nr_seq_grupo_sus_p INOUT bigint, nr_seq_subgrupo_p INOUT bigint, nr_seq_area_selec_p INOUT bigint, ie_principal_p INOUT text ) AS $body$
DECLARE

	cd_convenio_w		convenio.cd_convenio%type;
	cd_categoria_w		categoria_convenio.cd_categoria%type;
	cd_plano_w		convenio_plano.cd_plano%type;

BEGIN
	select	count(*)
	into STRICT	qt_item_adic_p
	from	ageint_exame_adic_item
	where	nr_seq_item = nr_seq_ageint_item_p;

	select	max(cd_convenio),
		max(cd_categoria),
		max(cd_plano)
	into STRICT	cd_conv_item_p,
		cd_categ_item_p,
		cd_plano_item_p
	from	agenda_integrada_conv_item
	where	nr_seq_agenda_item  = nr_seq_ageint_item_p;

	select	count(*)
	into STRICT	qt_bloq_exam_p
	from	ageint_bloqueio_exame
	where	nr_seq_proc_interno = nr_seq_proc_interno_p;

	cd_convenio_w		:= cd_convenio_ageint_p;
	cd_categoria_w		:= cd_categoria_ageint_p;
	cd_plano_w		:= cd_plano_ageint_p;

	if (cd_conv_item_p IS NOT NULL AND cd_conv_item_p::text <> '') then
		cd_convenio_w		:= cd_conv_item_p;
		cd_categoria_w		:= cd_categ_item_p;
		cd_plano_w		:= cd_plano_item_p;
	end if;

	if (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') and
		((coalesce(cd_procedimento_p::text, '') = '') or (coalesce(ie_origem_proced_p::text, '') = '')) then
		obter_proc_tab_interno_conv(nr_seq_proc_interno_p,
					obter_estabelecimento_ativo,
					cd_convenio_w,
					cd_categoria_w,
					cd_plano_w,
					null,
					cd_proc_tab_int_p,
					ie_orig_tab_int_p,
					null,
					clock_timestamp(),
					null,
					null,
					null,
					null,
					null,
					null,
					null,
					null);
	end if;
	
	select	coalesce(max(cd_area_procedimento),0),
		coalesce(max(cd_especialidade),0),
		coalesce(max(cd_grupo_proc),0),
		coalesce(max(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento,ie_origem_proced, 'C', 'F'),'F'),1,10)),0),
		coalesce(max(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento,ie_origem_proced, 'C', 'G'),'G'),1,10)),0),
		coalesce(max(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento,ie_origem_proced, 'C', 'S'),'S'),1,10)),0)
	into STRICT	cd_area_proced_p,
		cd_espec_proced_p,
		cd_grupo_proced_p,
		nr_seq_forma_org_p,
		nr_seq_grupo_sus_p,
		nr_seq_subgrupo_p
	from	estrutura_procedimento_v
	where	cd_procedimento = cd_procedimento_p
	and	ie_origem_proced = ie_origem_proced_p;

	if (nr_seq_grupo_selec_p IS NOT NULL AND nr_seq_grupo_selec_p::text <> '') then
		select	max(x.nr_seq_area)
		into STRICT	nr_seq_area_selec_p
		from	agenda_int_grupo x
		where	x.nr_sequencia  = nr_seq_grupo_selec_p;
	else
		nr_seq_area_selec_p := null;
	end if;

	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_principal_p
	from	agenda_integrada_item a,
		ageint_grupo_proc b,
		ageint_grupo_proc_item c
	where	b.nr_sequencia = a.nr_seq_grupo_proc
	and	c.nr_seq_grupo_proc   = b.nr_sequencia
	and	c.nr_seq_proc_interno   = a.nr_seq_proc_interno
	and	a.nr_seq_Agenda_int  = nr_seq_ageint_p
	and	a.nr_sequencia    = nr_seq_ageint_item_p
	and	coalesce(c.ie_exame_principal,'N') = 'S';
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_sugerir_html5_pck.obter_info_item_padrao ( nr_seq_ageint_p bigint, nr_seq_ageint_item_p bigint, cd_procedimento_p bigint, nr_seq_proc_interno_p bigint, ie_origem_proced_p bigint, cd_convenio_ageint_p bigint, cd_categoria_ageint_p text, cd_plano_ageint_p text, nr_seq_grupo_selec_p bigint, qt_item_adic_p INOUT bigint, cd_conv_item_p INOUT bigint, cd_categ_item_p INOUT text, cd_plano_item_p INOUT text, qt_bloq_exam_p INOUT bigint, cd_proc_tab_int_p INOUT bigint, ie_orig_tab_int_p INOUT bigint, cd_area_proced_p INOUT bigint, cd_espec_proced_p INOUT bigint, cd_grupo_proced_p INOUT bigint, nr_seq_forma_org_p INOUT bigint, nr_seq_grupo_sus_p INOUT bigint, nr_seq_subgrupo_p INOUT bigint, nr_seq_area_selec_p INOUT bigint, ie_principal_p INOUT text ) FROM PUBLIC;
