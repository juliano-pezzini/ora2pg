-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ageint_sugerir_html5_pck.bloqueios_agenda_sugestao (cd_agenda_p bigint, dt_inicial_filtro_p timestamp, dt_final_filtro_p timestamp, nr_seq_item_p bigint, ie_somente_validar text) AS $body$
DECLARE


  dt_inicial_filtro_w timestamp;
  dt_fim_filtro_w timestamp;
  qt_contador_w bigint := 1;
  cd_estabelecimento_w estabelecimento.cd_estabelecimento%type;
  nm_usuario_w varchar(255);

  ie_classif_item_w             agenda_integrada_item.ie_classif_agenda%type;
  nr_seq_classif_agenda_item_w  agenda_integrada_item.nr_seq_classif_agenda%type;
  cd_procedimento_w             agenda_integrada_item.cd_procedimento%type;
  nr_seq_proc_interno_w         agenda_integrada_item.nr_seq_proc_interno%type;
  ie_origem_proced_w            agenda_integrada_item.ie_origem_proced%type;

  cd_grupo_proc_w			grupo_proc.cd_grupo_proc%type;
  cd_especialidade_w		especialidade_proc.cd_especialidade%type;
  cd_area_procedimento_w		area_procedimento.cd_area_procedimento%type;
  cd_tipo_agenda_w		agenda.cd_tipo_agenda%type;
  cd_espec_agenda_w		agenda.cd_especialidade%type;
  cd_setor_agenda_w		setor_atendimento.cd_setor_atendimento%type;
  cd_setor_exclusivo_w		setor_atendimento.cd_setor_atendimento%type;
  cd_profissional_agenda_w	pessoa_fisica.cd_pessoa_fisica%type;
  cd_setor_regra_w  bigint;

  C01 CURSOR FOR
  SELECT pkg_date_formaters.to_varchar(a.dt_inicial, 'shortDate', 1, cd_estabelecimento_w, nm_usuario_w) dt_inicial,
    pkg_date_formaters.to_varchar(a.dt_final, 'shortDate', 1, cd_estabelecimento_w, nm_usuario_w) dt_final,
    to_char(a.hr_inicio_bloqueio,'hh24:mi') hr_inicio_bloqueio,
    to_char(a.hr_final_bloqueio,'hh24:mi') hr_final_bloqueio,
    substr(obter_valor_dominio(1007,a.ie_motivo_bloqueio),1,200) ds_motivo_agenda
  from	agenda_bloqueio a
  where 	a.cd_agenda = cd_agenda_p
  and (a.dt_inicial between dt_inicial_filtro_w and dt_fim_filtro_w
  or  a.dt_final between dt_inicial_filtro_w and dt_fim_filtro_w);

  C02 CURSOR FOR
  SELECT 	pkg_date_formaters.to_varchar(dt_inicio_vigencia, 'shortDate', 1, cd_estabelecimento_w, nm_usuario_w) dt_inicial,
    pkg_date_formaters.to_varchar(dt_fim_vigencia, 'shortDate', 1, cd_estabelecimento_w, nm_usuario_w) dt_final,
    to_char(hr_inicial,'hh24:mi') hr_inicio_bloqueio,
    to_char(hr_final,'hh24:mi') hr_final_bloqueio,
    substr(obter_valor_dominio(1007,ie_motivo_bloqueio),1,200) ds_motivo_agenda
  from	agenda_bloqueio_geral
  where 	ie_situacao = 'A'
  and	coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_w,0)) = coalesce(cd_estabelecimento_w,0)
  and coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
  and	coalesce(cd_agenda,coalesce(cd_agenda_p,0)) = coalesce(cd_agenda_p,0) 
  and 	coalesce(cd_especialidade,coalesce(cd_especialidade_w,0)) = coalesce(cd_especialidade_w,0) 
  and	coalesce(nr_seq_proc_interno,coalesce(nr_seq_proc_interno_w,0)) = coalesce(nr_seq_proc_interno_w,0)
  and	coalesce(cd_procedimento,coalesce(cd_procedimento_w,0)) = coalesce(cd_procedimento_w,0) 
  and	((coalesce(cd_procedimento,0) = 0) or coalesce(ie_origem_proced,coalesce(ie_origem_proced_w,0)) = coalesce(ie_origem_proced_w,0))
  and	coalesce(cd_grupo_proc,coalesce(cd_grupo_proc_w,0)) = coalesce(cd_grupo_proc_w,0) 
  and	coalesce(cd_area_procedimento,coalesce(cd_area_procedimento_w,0)) = coalesce(cd_area_procedimento_w,0)
  and ((dt_inicio_vigencia between dt_inicial_filtro_w and dt_fim_filtro_w)
  or   dt_fim_vigencia between dt_inicial_filtro_w and dt_fim_filtro_w)
  and	((coalesce(ie_setor_agenda,'N') = 'N') or (coalesce(cd_setor_atendimento,coalesce(cd_setor_agenda_w,0)) = coalesce(cd_setor_agenda_w,0)))
  and 	((coalesce(ie_setor_agendamento,'N') = 'N') or (coalesce(cd_setor_atendimento,coalesce(cd_setor_regra_w,0)) = coalesce(cd_setor_regra_w,0)))
  and 	((coalesce(ie_setor_exclusivo,'N') = 'N') or (coalesce(cd_setor_atendimento,coalesce(cd_setor_exclusivo_w,0)) = coalesce(cd_setor_exclusivo_w,0)))
  and	((coalesce(ie_prof_agenda,'N') = 'N') or (coalesce(cd_pessoa_fisica,coalesce(cd_profissional_agenda_w,'0')) = coalesce(cd_profissional_agenda_w,'0')))
  and	((coalesce(ie_prof_agendamento,'N') = 'N') or (coalesce(cd_pessoa_fisica,'0') = '0'))
  and 	((coalesce(ie_espec_agenda,'N') = 'N') or (coalesce(cd_espec_medica, coalesce(cd_espec_agenda_w,0)) = coalesce(cd_espec_agenda_w,0)))
  and 	((coalesce(ie_espec_agendamento,'N') = 'N') or (coalesce(cd_espec_medica, 0) = 0))
  and	( ((cd_tipo_agenda_w = 2) and (coalesce(nr_seq_classif_agenda,coalesce(nr_seq_classif_agenda_item_w,0)) = coalesce( nr_seq_classif_agenda_item_w,0)))
  or 	  ((cd_tipo_agenda_w in (3,4,5)) and (coalesce(ie_classif_agenda,coalesce(ie_classif_item_w,'0')) = coalesce( ie_classif_item_w,'0'))) )
  and	coalesce(cd_tipo_agenda,cd_tipo_agenda_w) = cd_tipo_agenda_w;


BEGIN

    dt_inicial_filtro_w := trunc(dt_inicial_filtro_p);
    dt_fim_filtro_w := trunc(dt_final_filtro_p);
    cd_estabelecimento_w := obter_estabelecimento_ativo();
    nm_usuario_w := obter_usuario_ativo();

    select 	max(c.ie_classif_agenda),
      max(c.nr_seq_classif_agenda),
      max(c.cd_procedimento),
      max(c.nr_seq_proc_interno),
      max(c.ie_origem_proced)
    into STRICT	ie_classif_item_w,
      nr_seq_classif_agenda_item_w,
      cd_procedimento_w,
      nr_seq_proc_interno_w,
      ie_origem_proced_w
    from 	agenda_integrada_item c
    WHERE	c.nr_sequencia	= nr_seq_item_p;

    for r_c01 in C01 loop
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].dt_inicial := r_c01.dt_inicial;
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].dt_final := r_c01.dt_final;
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].hr_inicial := r_c01.hr_inicio_bloqueio;
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].hr_final := r_c01.hr_final_bloqueio;
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].ds_motivo_bloqueio := r_c01.ds_motivo_agenda;
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].ie_local  := 'R';
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].cd_agenda  := cd_agenda_p;

      qt_contador_w := qt_contador_w + 1;
      if (ie_somente_validar = 'S') then
        goto final_regra_bloq;
      end if;
    end loop;

    --quase o mesmo tratamento da function obter_se_bloq_geral_agenda

    select	cd_tipo_agenda,
      cd_especialidade,
      cd_setor_agenda,
      cd_setor_exclusivo,
      cd_pessoa_fisica
    into STRICT	cd_tipo_agenda_w,
      cd_espec_agenda_w,
      cd_setor_agenda_w,
      cd_setor_exclusivo_w,
      cd_profissional_agenda_w
    from	agenda
    where	cd_agenda	 = cd_agenda_p;

    begin
    select	cd_grupo_proc,
        cd_especialidade,
        cd_area_procedimento
    into STRICT	cd_grupo_proc_w,
        cd_especialidade_w,
        cd_area_procedimento_w
    from	estrutura_procedimento_v
    where	cd_procedimento	 	= cd_procedimento_w
    and		ie_origem_proced	= ie_origem_proced_w  LIMIT 1;
    exception
      when others then
      cd_grupo_proc_w := 0;
      cd_especialidade_w := 0;
      cd_area_procedimento_w := 0;
    end;

    cd_setor_regra_w := obter_setor_regras_ageint(cd_tipo_agenda_w,cd_agenda_p,cd_procedimento_w,'N',nm_usuario_w,cd_estabelecimento_w);
    for r_c02 in C02 loop
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].dt_inicial := r_c02.dt_inicial;
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].dt_final := r_c02.dt_final;
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].hr_inicial := r_c02.hr_inicio_bloqueio;
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].hr_final := r_c02.hr_final_bloqueio;
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].ds_motivo_bloqueio := r_c02.ds_motivo_agenda;
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].ie_local  := 'C';
      current_setting('ageint_sugerir_html5_pck.regras_bloqueios_w')::regras_bloqueios[qt_contador_w].cd_agenda  := cd_agenda_p;
      if (ie_somente_validar = 'S') then
        exit;
      end if;
    end loop;
    <<final_regra_bloq>>
    null;
  end;

-- mesmo tratamento da valida_tempo_entre_agenda


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_sugerir_html5_pck.bloqueios_agenda_sugestao (cd_agenda_p bigint, dt_inicial_filtro_p timestamp, dt_final_filtro_p timestamp, nr_seq_item_p bigint, ie_somente_validar text) FROM PUBLIC;
