-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ageint_sugerir_html5_pck.val_tempo_entre_agenda_vet (cd_estabelecimento_p bigint, cd_agenda_pri_p bigint, cd_estab_pri_p bigint, nr_seq_proc_pri_p bigint, nr_seq_grupo_pri_p bigint, cd_setor_pri_p bigint, nr_minuto_duracao_p bigint, cd_pessoa_fisica_p text, dt_referencia_p timestamp, ds_mensagem_p INOUT text, dt_incio_sug_p timestamp, dt_fim_sug_p timestamp, nr_seq_ageint_item_p bigint default null) AS $body$
DECLARE


  item RECORD;

BEGIN

if current_setting('ageint_sugerir_html5_pck.qt_tempo_regras_w')::coalesce(bigint::text, '') = '' then
  PERFORM set_config('ageint_sugerir_html5_pck.qt_tempo_regras_w', ageint_sugerir_html5_pck.obter_maior_tempo_regra(cd_agenda_pri_p, cd_estab_pri_p, nr_seq_proc_pri_p, nr_seq_grupo_pri_p, cd_setor_pri_p), false);
end if;

if (current_setting('ageint_sugerir_html5_pck.qt_tempo_regras_w')::bigint > 0) and (nr_seq_ageint_item_p IS NOT NULL AND nr_seq_ageint_item_p::text <> '') then
  CALL CALL ageint_sugerir_html5_pck.adicionar_agenda_vetor(dt_incio_sug_p, dt_fim_sug_p, nr_minuto_duracao_p, nr_seq_ageint_item_p, cd_pessoa_fisica_p);
  if (current_setting('ageint_sugerir_html5_pck.agendamento_w')::agendamento_table.count > 0) then
    for item in (SELECT * from table(get_agendamentos_perio)) loop
      PERFORM set_config('ageint_sugerir_html5_pck.nr_seq_ageint_item_seg_w', item.nr_seq_ageint_item, false);
      PERFORM set_config('ageint_sugerir_html5_pck.qt_regra_item_w', ageint_sugerir_html5_pck.obter_maior_tempo_entre_itens(item.cd_agenda, item.cd_estabelecimento, item.nr_seq_proc_interno, item.nr_seq_grupo_selec, item.cd_setor_exclusivo, item.hr_agenda,
                            cd_agenda_pri_p, cd_estab_pri_p, nr_seq_proc_pri_p, nr_seq_grupo_pri_p, cd_setor_pri_p, dt_referencia_p), false);
      if (dt_referencia_p between item.hr_agenda-(item.nr_minuto_duracao+current_setting('ageint_sugerir_html5_pck.qt_regra_item_w')::bigint)/60/24 and item.hr_agenda+(item.nr_minuto_duracao+current_setting('ageint_sugerir_html5_pck.qt_regra_item_w')::bigint)/60/24) then
        ds_mensagem_p := 'S';
        exit;
      end if;
    end loop;
  end if;
end if;

end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_sugerir_html5_pck.val_tempo_entre_agenda_vet (cd_estabelecimento_p bigint, cd_agenda_pri_p bigint, cd_estab_pri_p bigint, nr_seq_proc_pri_p bigint, nr_seq_grupo_pri_p bigint, cd_setor_pri_p bigint, nr_minuto_duracao_p bigint, cd_pessoa_fisica_p text, dt_referencia_p timestamp, ds_mensagem_p INOUT text, dt_incio_sug_p timestamp, dt_fim_sug_p timestamp, nr_seq_ageint_item_p bigint default null) FROM PUBLIC;
