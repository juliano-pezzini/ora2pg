-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION cpoe_mat_json_pck.get_material_prescr_changes (nr_seq_prescr_changes_p bigint) RETURNS PHILIPS_JSON_LIST AS $body$
DECLARE

  json_item_w		philips_json;
	json_item_list_w	philips_json_list;

	C01 CURSOR FOR
		SELECT
        dt_atualizacao,
        nm_usuario,
        dt_alteracao,
        ie_alteracao,
        ds_justificativa,
        dt_horario,
        qt_dose_adm,
        cd_um_dose_adm,
        obter_conv_envio('UNIDADE_MEDIDA', 'CD_UNIDADE_MEDIDA', cd_um_dose_adm, 'S')  cd_um_dose_adm_code_system,
        obter_conv_envio('UNIDADE_MEDIDA', 'CD_UNIDADE_MEDIDA', cd_um_dose_adm, 'E')  cd_um_dose_adm_code_value, 
        qt_dose_original,
        ds_observacao,
        nr_seq_motivo_susp,
        ds_observacao_item
    from prescr_mat_alteracao a
    where NR_SEQUENCIA = nr_seq_prescr_changes_p;

	
BEGIN
	json_item_list_w	:= philips_json_list();
	
	for r_c01 in c01 loop
		begin
		json_item_w		:= philips_json();

    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'dtAtualizacao', r_c01.DT_ATUALIZACAO);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'nmUsuario', r_c01.NM_USUARIO);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'dtAlteracao', r_c01.DT_ALTERACAO);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'ieAlteracao', r_c01.IE_ALTERACAO);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'dsJustificativa', r_c01.DS_JUSTIFICATIVA);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'dtHorario', r_c01.DT_HORARIO);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'qtDoseAdm', r_c01.QT_DOSE_ADM);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'cdUmDoseAdm', r_c01.CD_UM_DOSE_ADM);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'cdUmDoseAdmCodeSystem', r_c01.CD_UM_DOSE_ADM_CODE_SYSTEM);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'cdUmDoseAdmCodeValue', r_c01.CD_UM_DOSE_ADM_CODE_VALUE);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'qtDoseOriginal', r_c01.QT_DOSE_ORIGINAL);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'dsObservacao', r_c01.DS_OBSERVACAO);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'nrSeqMotivoSusp', r_c01.NR_SEQ_MOTIVO_SUSP);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'dsObservacaoItem', r_c01.DS_OBSERVACAO_ITEM);
		
		json_item_list_w.append(json_item_w.to_json_value());
		end;
	end loop;
	
	return json_item_list_w;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION cpoe_mat_json_pck.get_material_prescr_changes (nr_seq_prescr_changes_p bigint) FROM PUBLIC;
