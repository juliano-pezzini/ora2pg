-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION cpoe_mat_json_pck.get_solution_prescr_changes (nr_seq_sol_evento_p bigint, nr_seq_solucao_p bigint, nr_etapa_evento_p bigint, nr_prescricao_p bigint) RETURNS PHILIPS_JSON_LIST AS $body$
DECLARE

  json_item_w		philips_json;
	json_item_list_w	philips_json_list;

  dt_inicio_horario_w   prescr_mat_hor.dt_inicio_horario%type;
  dt_fim_horario_w      prescr_mat_hor.dt_fim_horario%type;

	C01 CURSOR FOR
		SELECT qt_vol_infundido,
        dt_alteracao,
        cd_pessoa_fisica,
        qt_dosagem,
        ie_tipo_dosagem,
        ds_justificativa
    from prescr_solucao_evento a
    where	nr_sequencia = nr_seq_sol_evento_p;


BEGIN
	json_item_list_w	:= philips_json_list();
	
  select dt_inicio_horario,
    dt_fim_horario
  into STRICT dt_inicio_horario_w,
    dt_fim_horario_w
  from (
    SELECT dt_inicio_horario,
      dt_fim_horario
    from prescr_mat_hor
    where nr_seq_solucao = nr_seq_solucao_p
    and nr_prescricao = nr_prescricao_p
    and (nr_etapa_evento_p = 0 or nr_etapa_sol = nr_etapa_evento_p)
  ) alias1 LIMIT 1;

	for r_c01 in c01 loop
		begin
		json_item_w		:= philips_json();

    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'qtVolInfundido', r_c01.QT_VOL_INFUNDIDO);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'dtAlteracao', r_c01.DT_ALTERACAO);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'cdPessoaFisica', r_c01.CD_PESSOA_FISICA);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'qtDosagem', r_c01.QT_DOSAGEM);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'ieTipoDosagem', r_c01.IE_TIPO_DOSAGEM);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'dsJustificativa', r_c01.DS_JUSTIFICATIVA);

		json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'dtInicioHorario', DT_INICIO_HORARIO_W);
    json_item_w := cpoe_mat_json_pck.add_json_value(json_item_w, 'dtFimHorario', DT_FIM_HORARIO_W);

		json_item_list_w.append(json_item_w.to_json_value());
		end;
	end loop;
	
	return json_item_list_w;

  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION cpoe_mat_json_pck.get_solution_prescr_changes (nr_seq_sol_evento_p bigint, nr_seq_solucao_p bigint, nr_etapa_evento_p bigint, nr_prescricao_p bigint) FROM PUBLIC;
