-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_pathway_preview_pck.get_settings_preview_rows (nr_seq_protocolo_integrado_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE) RETURNS SETOF COLUMN_TABLE_T AS $body$
DECLARE

        column_row_w column_row_t;
        column_data_c CURSOR FOR
            SELECT
                b.IE_TIPO_EVENTO,
                OBTER_DESCRICAO_DOMINIO(8828, b.IE_TIPO_EVENTO) DS_TIPO,
                d.NR_SEQUENCIA NR_SEQ_ACAO,
                d.DS_ACAO,
                a.NR_SEQ_PROTOCOLO_INTEGRADO,
                MAX(e.NR_ORDEM) NR_ORDEM_TIPO_EVENTO,
                MAX(f.NR_ORDEM) NR_ORDEM_PLANO
            FROM PROTOCOLO_INTEGRADO_ETAPA a
            INNER JOIN PROTOCOLO_INTEGRADO_EVENTO b ON
                a.NR_SEQUENCIA = b.NR_SEQ_ETAPA
            LEFT JOIN GQA_PENDENCIA_REGRA c ON
                c.NR_SEQUENCIA = b.NR_SEQ_PLANO AND
                c.IE_SITUACAO = 'A'
            LEFT JOIN GQA_ACAO d ON
                d.NR_SEQ_PEND_REGRA = c.NR_SEQUENCIA AND
                d.IE_SITUACAO = 'A'
            LEFT JOIN PROTOCOLO_INT_TIPO_EVENTO e ON
               e.NR_SEQ_PROTOCOLO = a.NR_SEQ_PROTOCOLO_INTEGRADO AND
               e.CD_DOMINIO_TP_EVENTO = b.IE_TIPO_EVENTO
            LEFT JOIN PROTOCOLO_INT_CATEGORIA f ON
                e.NR_SEQUENCIA = f.NR_SEQ_TP_EVENTO AND
                d.NR_SEQUENCIA = f.NR_SEQ_ACAO
            WHERE
                A.nr_seq_protocolo_integrado = nr_seq_protocolo_integrado_p
            GROUP BY
                b.IE_TIPO_EVENTO,
                a.NR_SEQ_PROTOCOLO_INTEGRADO,
                OBTER_DESCRICAO_DOMINIO(8828, b.IE_TIPO_EVENTO),
                d.NR_SEQUENCIA,
                d.DS_ACAO
            ORDER BY NR_ORDEM_TIPO_EVENTO, NR_ORDEM_PLANO, d.DS_ACAO;

BEGIN
        <<FOR_WCPANEL_ROWS>>
        FOR column_data_r IN column_data_c LOOP

            column_row_w.ie_tipo_evento := column_data_r.ie_tipo_evento;
            column_row_w.ds_tipo := column_data_r.ds_tipo;
            column_row_w.nr_seq_acao := column_data_r.nr_seq_acao;
            column_row_w.ds_acao := column_data_r.ds_acao;
            column_row_w.NR_SEQ_PROTOCOLO_INT_PAC := column_data_r.NR_SEQ_PROTOCOLO_INTEGRADO;
            column_row_w.nr_ordem_tipo_evento := column_data_r.nr_ordem_tipo_evento;
            column_row_w.nr_ordem_plano := column_data_r.nr_ordem_plano;
            RETURN NEXT column_row_w;

        END LOOP FOR_WCPANEL_ROWS;
        RETURN;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_pathway_preview_pck.get_settings_preview_rows (nr_seq_protocolo_integrado_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE) FROM PUBLIC;
