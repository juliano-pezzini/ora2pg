-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_pathway_preview_pck.get_settings_preview_plan (NR_SEQ_PROTOCOLO_INTEGRADO_P protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE, ie_nome_amigavel_p text DEFAULT 'N') RETURNS SETOF PLAN_TABLE_T AS $body$
DECLARE


        plan_c CURSOR FOR
           SELECT
                C.NR_SEQUENCIA NR_SEQ_EVENTO,
                C.IE_TIPO_EVENTO,
                E.NR_SEQUENCIA NR_SEQ_ACAO,
                coalesce( CASE WHEN IE_NOME_AMIGAVEL_P='S' THEN  E.DS_PLANO_AMIGAVEL  ELSE E.DS_PLANO END , E.DS_PLANO) DS_PLANO,
                REGEXP_REPLACE(c.ds_evento, '[^0-9A-Za-z]', '') || '_' || c.nr_dia_protocolo || '_' || c.nr_seq_ordem || '_' || coalesce(c.ie_ocultar_visao_paciente, 'N') COLUMN_ID
            FROM PROTOCOLO_INTEGRADO_ETAPA  B
            INNER JOIN PROTOCOLO_INTEGRADO_EVENTO C ON
                B.NR_SEQUENCIA = C.NR_SEQ_ETAPA
            LEFT JOIN GQA_PENDENCIA_REGRA D ON
                C.NR_SEQ_PLANO = D.NR_SEQUENCIA AND
                d.ie_situacao = 'A'
            LEFT JOIN GQA_ACAO  E ON
                 D.NR_SEQUENCIA = E.NR_SEQ_PEND_REGRA AND
                 e.ie_situacao = 'A'
            WHERE
                B.NR_SEQ_PROTOCOLO_INTEGRADO = NR_SEQ_PROTOCOLO_INTEGRADO_P;

        plan_row_w plan_row_t;


BEGIN

        FOR plan_c_w IN plan_c LOOP

            plan_row_w.nr_seq_evento := plan_c_w.nr_seq_evento;
            plan_row_w.ie_tipo_evento := plan_c_w.ie_tipo_evento;
            plan_row_w.nr_seq_acao := plan_c_w.nr_seq_acao;
            plan_row_w.ds_plano := plan_c_w.ds_plano;
            plan_row_w.column_id := plan_c_w.column_id;
            RETURN NEXT plan_row_w;

        END LOOP;
        RETURN;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_pathway_preview_pck.get_settings_preview_plan (NR_SEQ_PROTOCOLO_INTEGRADO_P protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE, ie_nome_amigavel_p text DEFAULT 'N') FROM PUBLIC;
