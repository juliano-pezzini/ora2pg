-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



    /*
        Get all WCpanel's rows in Electronic Patient Chart
    */
CREATE OR REPLACE FUNCTION clinical_pathway_preview_pck.get_patient_preview_rows (nr_seq_protocolo_int_pac_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE) RETURNS SETOF COLUMN_TABLE_T AS $body$
DECLARE

        column_row_w column_row_t;
        column_data_c CURSOR FOR
            SELECT
                b.ie_tipo_evento,
                obter_descricao_dominio(8828, b.ie_tipo_evento) DS_TIPO,
                d.nr_sequencia NR_SEQ_ACAO,
                d.ds_acao,
                a.nr_seq_protocolo_int_pac,
                MAX(e.nr_ordem) NR_ORDEM_TIPO_EVENTO,
                MAX(f.nr_ordem) NR_ORDEM_PLANO
            FROM protocolo_int_pac_etapa a
            INNER JOIN protocolo_int_pac_evento b ON
                a.nr_sequencia = b.nr_seq_prt_int_pac_etapa
            LEFT JOIN gqa_pendencia_regra c ON
                c.nr_sequencia = b.nr_seq_plano AND
                c.ie_situacao = 'A'
            LEFT JOIN gqa_acao d ON
                d.nr_seq_pend_regra = c.nr_sequencia AND
                d.ie_situacao = 'A'
            LEFT JOIN protocolo_int_pac_tp_event e ON
               e.nr_seq_protocolo = a.nr_seq_protocolo_int_pac AND
               e.cd_dominio_tp_evento = b.ie_tipo_evento
            LEFT JOIN protocolo_int_pac_categori f ON
                e.nr_sequencia = f.nr_seq_tp_evento AND
                d.nr_sequencia = f.nr_seq_acao
            WHERE
                a.nr_seq_protocolo_int_pac =  nr_seq_protocolo_int_pac_p
            GROUP BY
                b.ie_tipo_evento,
                a.nr_seq_protocolo_int_pac,
                obter_descricao_dominio(8828, b.ie_tipo_evento),
                d.nr_sequencia,
                d.ds_acao
            ORDER BY nr_ordem_tipo_evento, nr_ordem_plano, d.ds_acao;

BEGIN
        <<FOR_WCPANEL_ROWS>>
        FOR column_data_r IN column_data_c LOOP

            column_row_w.ie_tipo_evento := column_data_r.ie_tipo_evento;
            column_row_w.ds_tipo := column_data_r.ds_tipo;
            column_row_w.nr_seq_acao := column_data_r.nr_seq_acao;
            column_row_w.ds_acao := column_data_r.ds_acao;
            column_row_w.nr_seq_protocolo_int_pac := column_data_r.nr_seq_protocolo_int_pac;
            column_row_w.nr_ordem_tipo_evento := column_data_r.nr_ordem_tipo_evento;
            column_row_w.nr_ordem_plano := column_data_r.nr_ordem_plano;
            RETURN NEXT column_row_w;

        END LOOP FOR_WCPANEL_ROWS;
        RETURN;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_pathway_preview_pck.get_patient_preview_rows (nr_seq_protocolo_int_pac_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE) FROM PUBLIC;
