-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_pathway_preview_pck.get_resp_user_order_daily (nr_seq_protocolo_int_pac_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE, dt_prevista_p protocolo_int_pac_evento.dt_prevista%TYPE) RETURNS varchar AS $body$
DECLARE

   nm_pessoa_fisica_w pessoa_fisica.nm_pessoa_fisica%TYPE;

  c2 CURSOR FOR
    SELECT reg.*
       FROM (
     SELECT (SELECT MAX((select substr(p.nm_pessoa_fisica, 1,255) from pessoa_fisica p where p.cd_pessoa_fisica = u.cd_pessoa_fisica)) nm_pessoa_fisica
                  FROM  gqa_pendencia_pac f,
                        usuario u
                  WHERE f.nr_seq_protocolo_int_pac_even = c.nr_sequencia
                  AND   f.nm_usuario = u.nm_usuario) NM_PESSOA_FISICA,
            (SELECT coalesce(CASE WHEN MAX(obter_informacoes_pendencia(h.nr_sequencia,'D')) IS NULL THEN 'N'  ELSE 'S' END ,'N')
              FROM  gqa_pendencia_pac g,
                    gqa_pend_pac_acao h
              WHERE g.nr_seq_protocolo_int_pac_even = c.nr_sequencia
              AND   g.nr_sequencia = h.nr_seq_pend_pac
              AND   h.nr_seq_regra_acao = e.nr_sequencia) IE_HAS_EXECUTED
        FROM protocolo_int_pac_etapa b, protocolo_int_pac_evento c
LEFT OUTER JOIN gqa_pendencia_regra d ON (c.nr_seq_plano = d.nr_sequencia)
LEFT OUTER JOIN gqa_acao e ON (d.nr_sequencia = e.nr_seq_pend_regra)
WHERE b.nr_sequencia = c.nr_seq_prt_int_pac_etapa   AND d.ie_situacao = 'A' AND e.ie_situacao = 'A' AND b.nr_seq_protocolo_int_pac = nr_seq_protocolo_int_pac_p AND c.dt_prevista = dt_prevista_p  ) reg
        where reg.IE_HAS_EXECUTED = 'S';


BEGIN
    FOR i IN c2
    LOOP
      if length(nm_pessoa_fisica_w) > 0 then
        nm_pessoa_fisica_w := nm_pessoa_fisica_w || ', ';
      end if;
      nm_pessoa_fisica_w := nm_pessoa_fisica_w || i.nm_pessoa_fisica;
    END LOOP;

    RETURN nm_pessoa_fisica_w;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_pathway_preview_pck.get_resp_user_order_daily (nr_seq_protocolo_int_pac_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE, dt_prevista_p protocolo_int_pac_evento.dt_prevista%TYPE) FROM PUBLIC;
