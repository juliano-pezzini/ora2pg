-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


	/* Procedure para gerar o valor do atributos cadastrados pelo usuário */

CREATE OR REPLACE PROCEDURE sup_gerar_planej_pck.gerar_valor_atrib_planej ( nr_sequencia_p bigint, cd_material_p bigint, vl_retorno_p INOUT bigint, cd_estabelecimento_p bigint, cd_empresa_p bigint, nm_usuario_p text) AS $body$
DECLARE


	c001			integer;

	ds_sql_w			varchar(4000);
	ds_sql_original_w		varchar(4000);
	cd_estabelecimento_w	integer;
	vl_retorno_atrib_w		double precision	:= 0;
	vl_coluna_w		varchar(17);
	nm_atributo_w		varchar(255);

	c01 CURSOR FOR
	SELECT	cd_estabelecimento
	from	estabelecimento_v
	where	cd_empresa = cd_empresa_p
	and	((cd_estabelecimento_p = 0) or (cd_estabelecimento = cd_estabelecimento_p));

	
BEGIN

	/* Buscar o nome do atributo e sua query */

	select	upper(ds_sql),
		nm_atributo
	into STRICT	ds_sql_original_w,
		nm_atributo_w
	from	sup_atrib_planej_compras
	where	nr_sequencia = nr_sequencia_p;

	if (ds_sql_original_w IS NOT NULL AND ds_sql_original_w::text <> '') then
		begin

		/* Abre cursor com todos os estabelecimento, para gerar os atributos para cada um*/

		open c01;
		loop
		fetch c01 into
			cd_estabelecimento_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

			/* Realiza a substituição dos parâmetros permitidos (Mat e Estab) */

			/* e executa a query para obter e gravar o valor */

			ds_sql_w	:= ds_sql_original_w;

			ds_sql_w	:= replace(ds_sql_w,':CD_MATERIAL',cd_material_p);
			ds_sql_w := replace(ds_sql_w,':CD_ESTABELECIMENTO',cd_estabelecimento_w);

			c001	:= dbms_sql.open_cursor;
			dbms_sql.parse(c001,ds_sql_w,dbms_sql.native);
			dbms_sql.define_column(c001, 1, vl_coluna_w, 17);
			vl_retorno_atrib_w	:= dbms_sql.execute(c001);
			vl_retorno_atrib_w	:= dbms_sql.fetch_rows(c001);
			dbms_sql.column_value(c001,1,vl_coluna_w);
			dbms_sql.close_cursor(c001);

			vl_retorno_atrib_w	:= (coalesce(vl_coluna_w,'0'))::numeric;


			CALL CALL sup_gerar_planej_pck.gravar_valor_atrib_planej(	nm_atributo_w,
						vl_retorno_atrib_w,
						cd_material_p,
						cd_estabelecimento_w,
						nm_usuario_p);

			end;
		end loop;
		close c01;

		end;
	end if;

	vl_retorno_p	:= vl_retorno_atrib_w;

	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_gerar_planej_pck.gerar_valor_atrib_planej ( nr_sequencia_p bigint, cd_material_p bigint, vl_retorno_p INOUT bigint, cd_estabelecimento_p bigint, cd_empresa_p bigint, nm_usuario_p text) FROM PUBLIC;
