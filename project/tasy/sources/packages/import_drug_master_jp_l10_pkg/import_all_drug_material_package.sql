-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE import_drug_master_jp_l10_pkg.import_all_drug_material ( cd_estabelecimento_p bigint, nr_seq_version_p bigint, nm_usuario_p text, ie_no_change_p text, ie_new_material_p text, ie_dirty_check_p text, cd_yj_code_p text, ie_mat_import_p text ) AS $body$
DECLARE


        c01 CURSOR FOR
        SELECT a.*
        from   imp_material a
        where ( coalesce(cd_yj_code_p::text, '') = ''
                  or a.cd_yj_code = cd_yj_code_p )
            and nr_seq_mims_version = nr_seq_version_p
            and ( ( (ie_dirty_check_p = 'S'
                        and a.ie_dirty_check = 1)
                    or (ie_new_material_p = 'S'
                           and a.ie_dirty_check = 2)
                    or (ie_no_change_p = 'S'
                           and ( coalesce(a.ie_dirty_check::text, '') = ''
                                 or a.ie_dirty_check = 0 )) )
                  or ( ie_dirty_check_p = 'N'
                       and ie_new_material_p = 'N'
                       and ie_no_change_p = 'N' ) )
            and ((ie_mat_import_p =  'S'  and a.ie_cd_sistema_ant_updated = 1) or (ie_mat_import_p =  'N'  and (a.ie_cd_sistema_ant_updated = 0 or coalesce(a.ie_cd_sistema_ant_updated::text, '') = '')))
        order by
            cd_yj_code asc;

        r01_w c01%rowtype;

BEGIN
        open c01;
        loop
            fetch c01 into r01_w;
            EXIT WHEN NOT FOUND; /* apply on c01 */
            begin
                CALL import_drug_master_jp_l10_pkg.import_drug_master_material(cd_estabelecimento_p, nr_seq_version_p,
                nm_usuario_p, r01_w.cd_material, r01_w.cd_yj_code,r01_w.ie_dirty_check);
            end;
        end loop;
        CALL import_drug_master_jp_l10_pkg.update_imp_version_status(cd_estabelecimento_p, nr_seq_version_p, '3', nm_usuario_p, null);

        close c01;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_drug_master_jp_l10_pkg.import_all_drug_material ( cd_estabelecimento_p bigint, nr_seq_version_p bigint, nm_usuario_p text, ie_no_change_p text, ie_new_material_p text, ie_dirty_check_p text, cd_yj_code_p text, ie_mat_import_p text ) FROM PUBLIC;
