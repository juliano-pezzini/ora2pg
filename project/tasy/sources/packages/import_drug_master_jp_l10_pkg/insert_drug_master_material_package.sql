-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE import_drug_master_jp_l10_pkg.insert_drug_master_material ( cd_estabelecimento_p text, nr_version_seq_p text, nm_usuario_p text, cd_yj_code_p text, reciept_code_p text, ds_product_p text, general_name_p text, drug_price_unit_p text, dosage_form_code_p text, dosage_description_p text, narcotics_drug_flag_p text, psychotropic_drug_flag_p text, split_line_flag_p text, high_risk_drug_p text, brand_name_drug_flag_p text, generic_drug_flag_p text, key_component_p text ) AS $body$
DECLARE


        via_aplic_w                 imp_via_aplicacao%rowtype;
        imp_material_unidade_w      imp_material_conv_unidade%rowtype;
        cd_material_w               imp_material.cd_material%type;
        mat_via_aplic_w             imp_mat_via_aplic%rowtype;
        material_w                  imp_material%rowtype;
        medic_ficha_tecnica_w       imp_medic_ficha_tecnica%rowtype;
        medic_ficha_tecnica_seq_w   imp_medic_ficha_tecnica.nr_sequencia%type;
        subgrupo_material_w         imp_subgrupo_material%rowtype;
        subgrupo_material_seq_w     imp_subgrupo_material.cd_subgrupo_material%type;
        ds_subgrupo_material_w      imp_subgrupo_material.ds_subgrupo_material%type;
        classe_material_w           imp_classe_material%rowtype;
        classe_material_seq_w       imp_classe_material.cd_classe_material%type;
        classe_material_ds_w        imp_classe_material.ds_classe_material%type;
        unidade_medida_w            imp_unidade_medida%rowtype;
        cd_unidada_medida_w         imp_unidade_medida.cd_unidade_medida%type;
        ie_data_exist_w             varchar(2);

BEGIN
    
    /**Check and Insert Adminstratin Route  **/

        select
            CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END 
        into STRICT ie_data_exist_w
        from
            imp_via_aplicacao
        where
            ie_via_aplicacao = dosage_form_code_p;

        if ( ie_data_exist_w = 'N' ) then
            via_aplic_w.nr_seq_mims_version := nr_version_seq_p;
            via_aplic_w.ie_situacao := 'A';
            via_aplic_w.ie_gera_diluicao := 'N';
            via_aplic_w.ie_via_aplicacao := substr(dosage_form_code_p,1,5);
            via_aplic_w.ds_via_aplicacao := substr(dosage_description_p,1,80);
            via_aplic_w.nm_usuario := nm_usuario_p;
            via_aplic_w.nm_usuario_nrec := nm_usuario_p;
            via_aplic_w.dt_atualizacao := clock_timestamp();
            via_aplic_w.dt_atualizacao_nrec := clock_timestamp();
            via_aplic_w.ie_dirty_check := '2';
            insert into imp_via_aplicacao values (via_aplic_w.*);

        end if;

        
    /**Insert Active Ingredient  **/

        select
            CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END 
        into STRICT ie_data_exist_w
        from
            imp_medic_ficha_tecnica
        where
            ds_substancia = key_component_p;

        if ( ie_data_exist_w = 'N' ) then
            select  nextval('imp_medic_ficha_tecnica_seq')
            into STRICT    medic_ficha_tecnica_seq_w
;

            medic_ficha_tecnica_w.nr_seq_mims_version := nr_version_seq_p;
            medic_ficha_tecnica_w.nr_sequencia := medic_ficha_tecnica_seq_w;
            medic_ficha_tecnica_w.ds_substancia := substr(key_component_p,1,80);
            medic_ficha_tecnica_w.nr_externo := cd_yj_code_p;
            medic_ficha_tecnica_w.nm_usuario := nm_usuario_p;
            medic_ficha_tecnica_w.nm_usuario_nrec := nm_usuario_p;
            medic_ficha_tecnica_w.dt_atualizacao := clock_timestamp();
            medic_ficha_tecnica_w.dt_atualizacao_nrec := clock_timestamp();
            medic_ficha_tecnica_w.ie_dirty_check := '2';
            medic_ficha_tecnica_w.IE_ANTIMICROBIANO := 'N';
            insert into imp_medic_ficha_tecnica values (medic_ficha_tecnica_w.*);

        else
            select
                max(nr_sequencia)
            into STRICT medic_ficha_tecnica_seq_w
            from
                imp_medic_ficha_tecnica
            where
                ds_substancia = key_component_p;

        end if;

        
        
        /**Insert Material group into imp_subgrupo_material  table **/

        ds_subgrupo_material_w := 'NHI Material SubGroup';
        select
            CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
        into STRICT ie_data_exist_w
        from
            imp_subgrupo_material
        where
            ds_subgrupo_material = ds_subgrupo_material_w; --need to change with expression
        if ( ie_data_exist_w = 'N' ) then
            select
                max(cd_subgrupo_material) + 1
            into STRICT subgrupo_material_seq_w
            from
                imp_subgrupo_material;

            subgrupo_material_w.ie_situacao := 'A';
            subgrupo_material_w.cd_subgrupo_material := subgrupo_material_seq_w;
            subgrupo_material_w.ds_subgrupo_material := ds_subgrupo_material_w;
            subgrupo_material_w.nm_usuario := nm_usuario_p;
            subgrupo_material_w.nm_usuario_nrec := nm_usuario_p;
            subgrupo_material_w.dt_atualizacao := clock_timestamp();
            subgrupo_material_w.dt_atualizacao_nrec := clock_timestamp();
            subgrupo_material_w.ie_dirty_check := '2';
            subgrupo_material_w.nr_seq_mims_version := nr_version_seq_p;
            insert into imp_subgrupo_material values (subgrupo_material_w.*);

        else
            select
                max(cd_subgrupo_material)
            into STRICT subgrupo_material_seq_w
            from
                imp_subgrupo_material
            where
                ds_subgrupo_material = ds_subgrupo_material_w;

        end if;

        commit;

        /**Insert Material class into imp_classe_material  table **/

        classe_material_ds_w := substr(cd_yj_code_p, 1, 4)
                                || '- Material Class';
        select
            CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
        into STRICT ie_data_exist_w
        from
            imp_classe_material
        where
            ds_classe_material = classe_material_ds_w
            and cd_subgrupo_material = subgrupo_material_seq_w;

        if ( ie_data_exist_w = 'N' ) then
            select
                max(cd_classe_material) + 1
            into STRICT classe_material_seq_w
            from
                imp_classe_material;

            classe_material_w.ie_situacao := 'A';
            classe_material_w.cd_classe_material := classe_material_seq_w;
            classe_material_w.ds_classe_material := classe_material_ds_w;
            classe_material_w.nm_usuario := nm_usuario_p;
            classe_material_w.nm_usuario_nrec := nm_usuario_p;
            classe_material_w.dt_atualizacao := clock_timestamp();
            classe_material_w.dt_atualizacao_nrec := clock_timestamp();
            classe_material_w.ie_dirty_check := '2';
            classe_material_w.nr_seq_mims_version := nr_version_seq_p;
            classe_material_w.cd_subgrupo_material := subgrupo_material_seq_w;
            insert into imp_classe_material values (classe_material_w.*);

        else
            select
                max(cd_classe_material)
            into STRICT classe_material_seq_w
            from
                imp_classe_material
            where
                ds_classe_material = classe_material_ds_w
                and cd_subgrupo_material = subgrupo_material_seq_w;

        end if;

        /**Insert conversion unit  table **/

        select
            CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
        into STRICT ie_data_exist_w
        from
            imp_unidade_medida
        where
            cd_unidade_medida = drug_price_unit_p;

        if ( ie_data_exist_w = 'N' ) then
            cd_unidada_medida_w := drug_price_unit_p;
            unidade_medida_w.ie_situacao := 'A';
            unidade_medida_w.cd_unidade_medida := substr(cd_unidada_medida_w,1,30);
            unidade_medida_w.ds_unidade_medida := substr(cd_unidada_medida_w,1,40);
            unidade_medida_w.nm_usuario := nm_usuario_p;
            unidade_medida_w.nm_usuario_nrec := nm_usuario_p;
            unidade_medida_w.dt_atualizacao := clock_timestamp();
            unidade_medida_w.dt_atualizacao_nrec := clock_timestamp();
            unidade_medida_w.ie_dirty_check := '2';
            unidade_medida_w.nr_seq_mims_version := nr_version_seq_p;
            unidade_medida_w.ie_adm_diluicao := 'N';
            insert into imp_unidade_medida values (unidade_medida_w.*);

        else
            select
                max(cd_unidade_medida)
            into STRICT cd_unidada_medida_w
            from
                imp_unidade_medida
            where
                cd_unidade_medida = drug_price_unit_p;

        end if;

        commit;

      /**Insert Material into temp_material table **/

        select
            nextval('imp_material_seq')
        into STRICT cd_material_w
;

        material_w.cd_material := cd_material_w;
        material_w.cd_yj_code := trim(both cd_yj_code_p);
        material_w.cd_sistema_ant := reciept_code_p;
        material_w.cd_unidade_medida_compra := substr(cd_unidada_medida_w,1,30);
        material_w.cd_unidade_medida_consumo := substr(cd_unidada_medida_w,1,30);
        material_w.cd_unidade_medida_estoque := substr(cd_unidada_medida_w,1,30);
        material_w.ds_material := trim(both ds_product_p);
        material_w.ie_psychotropic := coalesce(trim(both psychotropic_drug_flag_p), 'N');
        material_w.ie_via_aplicacao := substr(dosage_form_code_p,1,5);
        material_w.nr_seq_ficha_tecnica := medic_ficha_tecnica_seq_w;
        material_w.ds_reduzida := general_name_p;
        material_w.ds_general_name := general_name_p;
        material_w.qt_conv_compra_estoque := 1;
        material_w.qt_conv_estoque_consumo := 1;
        material_w.qt_minimo_multiplo_solic := 1;
        material_w.cd_classe_material := classe_material_seq_w;
        material_w.cd_grupo_material := 1;
        material_w.ie_situacao := 'A';
        material_w.cd_material_estoque := cd_material_w;
        material_w.nr_seq_mims_version := nr_version_seq_p;
        material_w.nm_usuario := nm_usuario_p;
        material_w.nm_usuario_nrec := nm_usuario_p;
        material_w.dt_atualizacao := clock_timestamp();
        material_w.dt_atualizacao_nrec := clock_timestamp();
        material_w.cd_material_generico := null;
        material_w.ie_dirty_check := '2';
        material_w.ie_medicine_dirty_check := '2';
        material_w.ie_druginteract_dirty_check := '2';
        material_w.ie_cd_sistema_ant_updated := 0;
        select
            CASE WHEN high_risk_drug_p='1' THEN  'S'  ELSE 'N' END , 		/**Applicable:1 - 'S' , Not Applicable null - 'S' **/
            CASE WHEN split_line_flag_p='1' THEN  'P'  ELSE 'NA' END ,  	/**Applicable:1 - 'P' , Not Applicable null - 'NA' **/
            CASE WHEN narcotics_drug_flag_p='1' THEN  'S'  ELSE 'N' END     /**   **Drugs : 1 - S , Not applicable : null - N **/
        into STRICT
            material_w.ie_alto_risco,
            material_w.ie_permite_partir,
            material_w.ie_receita
;

        if ( coalesce(brand_name_drug_flag_p::text, '') = '' ) then
            if ( generic_drug_flag_p = 1 ) then
                material_w.ie_tipo_material := '8';
            else
                material_w.ie_tipo_material := '9';
            end if;
        else
            if ( brand_name_drug_flag_p = '1' ) then
                material_w.ie_tipo_material := '3';
            elsif ( brand_name_drug_flag_p = '2' ) then
                material_w.ie_tipo_material := '2';
            else
                material_w.ie_tipo_material := '9';
            end if;
        end if;

        insert into imp_material values (material_w.*);

        commit;
        /**Check and Insert Material Adminstratin Route  **/

        select nextval('imp_mat_via_aplic_seq')
        into STRICT   mat_via_aplic_w.nr_sequencia
;
        mat_via_aplic_w.nr_seq_mims_version := nr_version_seq_p;
        mat_via_aplic_w.cd_material := cd_material_w;
        mat_via_aplic_w.ie_diluicao := 'N';
        mat_via_aplic_w.ie_via_aplicacao := substr(dosage_form_code_p,1,5);
        mat_via_aplic_w.nm_usuario := nm_usuario_p;
        mat_via_aplic_w.nm_usuario_nrec := nm_usuario_p;
        mat_via_aplic_w.dt_atualizacao := clock_timestamp();
        mat_via_aplic_w.dt_atualizacao_nrec := clock_timestamp();
        mat_via_aplic_w.ie_dirty_check := '2';
        insert into imp_mat_via_aplic values (mat_via_aplic_w.*);
        commit;

        /**Check and Insert Material Adminstratin Route  **/

        imp_material_unidade_w.nr_seq_mims_version := nr_version_seq_p;
        imp_material_unidade_w.cd_material := cd_material_w;
        imp_material_unidade_w.cd_unidade_medida := substr(cd_unidada_medida_w,1,30);
        imp_material_unidade_w.nm_usuario := nm_usuario_p;
        imp_material_unidade_w.nm_usuario_nrec := nm_usuario_p;
        imp_material_unidade_w.dt_atualizacao := clock_timestamp();
        imp_material_unidade_w.dt_atualizacao_nrec := clock_timestamp();
        imp_material_unidade_w.ie_dirty_check := '2';
        imp_material_unidade_w.ie_PRIORIDADE := '1';
        insert into imp_material_conv_unidade values (imp_material_unidade_w.*);
        commit;

        CALL import_drug_master_jp_l10_pkg.compare_drug_master_material(cd_estabelecimento_p, nr_version_seq_p, nm_usuario_p, cd_material_w, cd_yj_code_p);

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_drug_master_jp_l10_pkg.insert_drug_master_material ( cd_estabelecimento_p text, nr_version_seq_p text, nm_usuario_p text, cd_yj_code_p text, reciept_code_p text, ds_product_p text, general_name_p text, drug_price_unit_p text, dosage_form_code_p text, dosage_description_p text, narcotics_drug_flag_p text, psychotropic_drug_flag_p text, split_line_flag_p text, high_risk_drug_p text, brand_name_drug_flag_p text, generic_drug_flag_p text, key_component_p text ) FROM PUBLIC;
