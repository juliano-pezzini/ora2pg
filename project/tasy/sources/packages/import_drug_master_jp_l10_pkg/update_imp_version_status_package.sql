-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE import_drug_master_jp_l10_pkg.update_imp_version_status ( cd_estabelecimento_p text, nr_version_seq_p bigint, ie_status_p text, nm_usuario_p text, ds_log_p text ) AS $body$
DECLARE

        ds_log_w text;
        count_diff_w bigint;

BEGIN
        case
            when( ie_status_p = '1' ) then  -- Uploaded
                update mims_version
                set
                    ie_status = ie_status_p,
                    nm_usuario = nm_usuario_p,
                    dt_atualizacao = clock_timestamp(),
                    dt_importation_material_cat = clock_timestamp()
                where
                    nr_sequencia = nr_version_seq_p;

                ds_log_w := 'All File uploaded in Temporary tables';
            when( ie_status_p = '2' ) then  -- Import in Progress
                update mims_version
                set
                    ie_status = ie_status_p,
                    nm_usuario = nm_usuario_p,
                    dt_atualizacao = clock_timestamp()
                where
                    nr_sequencia = nr_version_seq_p;

                ds_log_w := 'Importation started for Drug Master in Material Record';
            when( ie_status_p = '3' ) then  --Completed
                select abs(
                    ( select count(*)
                        from imp_material
                        where ie_dirty_check in (1,2,0)
                        and nr_seq_mims_version = nr_version_seq_p) -
                    ( select count(*) 
                        from imp_material
                        where ie_dirty_check in (1,2,0)
                        and IE_CD_SISTEMA_ANT_UPDATED = 1
                        and nr_seq_mims_version = nr_version_seq_p))
                into STRICT count_diff_w 
;

                if (count_diff_w = 0) then
                    update mims_version
                    set
                        ie_status = ie_status_p,
                        nm_usuario = nm_usuario_p,
                        dt_atualizacao = clock_timestamp(),
                        dt_importation = clock_timestamp()
                    where
                        nr_sequencia = nr_version_seq_p;
                    else
                        update  mims_version
                        set     ie_status = '1',
                                nm_usuario = nm_usuario_p,
                                dt_atualizacao = clock_timestamp(),
                                dt_importation = clock_timestamp()
                        where   nr_sequencia = nr_version_seq_p;
                end if;

                ds_log_w := 'Drug Master imported Successfully in Material Record';

            when( ie_status_p = '4' ) then  --Error in Import
                update mims_version
                set
                    ie_status = ie_status_p,
                    nm_usuario = nm_usuario_p,
                    dt_atualizacao = clock_timestamp()
                where
                    nr_sequencia = nr_version_seq_p;

                ds_log_w := 'Error occured while import in Material Record. Error -' || ds_log_p;
            when( ie_status_p = '5' ) then  --Pending
                update mims_version
                set
                    ie_status = ie_status_p,
                    nm_usuario = nm_usuario_p,
                    dt_atualizacao = clock_timestamp()
                where
                    nr_sequencia = nr_version_seq_p;

                ds_log_w := 'File started uploading in Temporary tables';
            when( ie_status_p = '6' ) then  --Fail
                update mims_version
                set
                    ie_status = ie_status_p,
                    nm_usuario = nm_usuario_p,
                    dt_atualizacao = clock_timestamp()
                where
                    nr_sequencia = nr_version_seq_p;

                ds_log_w := 'Failed while uploading drug master in Temporary tables. Error - '|| ds_log_p;
        end case;
        commit;

        CALL import_drug_master_jp_l10_pkg.insert_import_log(nr_version_seq_p, nm_usuario_p, ds_log_w);

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_drug_master_jp_l10_pkg.update_imp_version_status ( cd_estabelecimento_p text, nr_version_seq_p bigint, ie_status_p text, nm_usuario_p text, ds_log_p text ) FROM PUBLIC;
