-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ish_diagnosis_pck.ish_gerar_medic_diag ( diagnostico_doenca_p diagnostico_doenca, ds_classificacao_p text, ie_identificado_p text, reg_integracao_p INOUT gerar_int_padrao.reg_integracao_conv) AS $body$
DECLARE



medic_diagnostico_doenca_w	medic_diagnostico_doenca%rowtype;
nr_seq_classificacao_w		medic_diagnostico_doenca.nr_seq_classificacao%type;


BEGIN
if (ie_identificado_p = 'X') then
	begin
	reg_integracao_p.nm_tabela	:=	'MEDIC_DIAGNOSTICO_DOENCA';
	intpd_processar_atributo(reg_integracao_p, 'NR_SEQ_CLASSIFICACAO', ds_classificacao_p, 'S', medic_diagnostico_doenca_w.nr_seq_classificacao);

	begin
	select	*


	into STRICT	medic_diagnostico_doenca_w
	from	medic_diagnostico_doenca
	where	nr_atendimento = diagnostico_doenca_p.nr_atendimento
	and	cd_doenca = diagnostico_doenca_p.cd_doenca
	and	dt_diagnostico = diagnostico_doenca_p.dt_diagnostico
	and	nr_seq_classificacao = medic_diagnostico_doenca_w.nr_seq_classificacao  LIMIT 1;
	exception
	when others then

		medic_diagnostico_doenca_w.nr_sequencia	:=	null;
	end;

	medic_diagnostico_doenca_w.ie_situacao		:=	'A';
	medic_diagnostico_doenca_w.dt_atualizacao	:=	clock_timestamp();

	medic_diagnostico_doenca_w.nm_usuario		:=	current_setting('ish_diagnosis_pck.usernametasy')::varchar(15);

	if (reg_integracao_p.qt_reg_log = 0) then
		begin
		if (medic_diagnostico_doenca_w.nr_sequencia IS NOT NULL AND medic_diagnostico_doenca_w.nr_sequencia::text <> '') then


			update	medic_diagnostico_doenca
			set	row = medic_diagnostico_doenca_w
			where	nr_sequencia = medic_diagnostico_doenca_w.nr_sequencia;
		else
			begin
			select	cd_medico_atendimento,

				cd_estabelecimento,
				nextval('medic_diagnostico_doenca_seq')
			into STRICT	medic_diagnostico_doenca_w.cd_pessoa_fisica,


				medic_diagnostico_doenca_w.cd_estabelecimento,
				medic_diagnostico_doenca_w.nr_sequencia
			from	atendimento_paciente
			where	nr_atendimento = diagnostico_doenca_p.nr_atendimento;

			medic_diagnostico_doenca_w.nr_atendimento 	:=	diagnostico_doenca_p.nr_atendimento;
			medic_diagnostico_doenca_w.cd_doenca	:=	diagnostico_doenca_p.cd_doenca;
			medic_diagnostico_doenca_w.dt_diagnostico	:= 	diagnostico_doenca_p.dt_diagnostico;


			insert into medic_diagnostico_doenca values (medic_diagnostico_doenca_w.*);
			end;
		end if;
		end;
	end if;
	end;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ish_diagnosis_pck.ish_gerar_medic_diag ( diagnostico_doenca_p diagnostico_doenca, ds_classificacao_p text, ie_identificado_p text, reg_integracao_p INOUT gerar_int_padrao.reg_integracao_conv) FROM PUBLIC;
