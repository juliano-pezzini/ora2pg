-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION html_partograma_pck.gerar ( nr_atendimento_p bigint) RETURNS SETOF T_PARTOGRAMA AS $body$
DECLARE


t_partograma_row_w		t_partograma_row;
ie_hora_w			partograma.ie_hora%type;
qt_dilatacao_cervical_w 	partograma.qt_dilatacao_cervical%type;
ie_plano_lee_w			partograma.ie_plano_lee%type;
qt_bcf_w			partograma.qt_bcf%type;
ie_bolsa_w			varchar(10);
ie_aspecto_liquido_w		partograma.ie_aspecto_liquido%type;
qt_ocitocina_w			partograma.qt_ocitocina%type;

hr_registro_w			varchar(10);
i				integer;
ie_cursor_w			varchar(10);

c01 CURSOR FOR
SELECT	qt_dilatacao_cervical ,
	ie_plano_lee,
	to_char(dt_registro,'hh24:mi') hr_registro,
	qt_bcf
from	partograma
where	nr_atendimento 		= nr_atendimento_p
and	((Obter_Param_Medico(wheb_usuario_pck.get_cd_estabelecimento,'IE_LIB_PARTOGRAMA') = 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''))
and	coalesce(ie_situacao,'A') 	= 'A'
and	ie_hora 		= ie_hora_w  LIMIT 1;


BEGIN

for i in 0..23 loop
	begin
	ie_cursor_w := 'N';

	ie_hora_w					:= i;
	t_partograma_row_w.ie_hora 			:= ie_hora_w;
	t_partograma_row_w.qt_bcf			:= null;
	t_partograma_row_w.qt_dilatacao_cervical 	:= null;
	t_partograma_row_w.ie_plano_lee 		:= null;
	t_partograma_row_w.ie_plano_lee_aux		:= null;
	t_partograma_row_w.hr_registro			:= null;
	t_partograma_row_w.ie_bolsa			:= null;
	t_partograma_row_w.ie_aspecto_liquido		:= null;
	t_partograma_row_w.qt_ocitocina			:= null;
	t_partograma_row_w.qt_alerta			:= null;
	t_partograma_row_w.qt_acao			:= null;

	--Select separado para ficar conforme Delphi, para não duplicar estas informações para cada hora.
	select	max(CASE WHEN ie_bolsa='S' THEN 1 WHEN ie_bolsa='N' THEN 2  ELSE null END ),
		max(ie_aspecto_liquido),
		CASE WHEN max(ie_ocitocina)='S' THEN round((max(qt_ocitocina))::numeric,1)  ELSE null END  qt_ocitocina
	into STRICT	ie_bolsa_w,
		ie_aspecto_liquido_w,
		qt_ocitocina_w
	from	partograma
	where	nr_atendimento 		= nr_atendimento_p
	and	((Obter_Param_Medico(wheb_usuario_pck.get_cd_estabelecimento,'IE_LIB_PARTOGRAMA') = 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''))
	and	coalesce(ie_situacao,'A') 	= 'A'
	and	ie_hora 		= ie_hora_w;

	open C01;
	loop
	fetch C01 into
		qt_dilatacao_cervical_w,
		ie_plano_lee_w,
		hr_registro_w,
		qt_bcf_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		t_partograma_row_w.qt_dilatacao_cervical 	:= qt_dilatacao_cervical_w;
		t_partograma_row_w.ie_plano_lee 		:= html_partograma_pck.converte_de_lee(ie_plano_lee_w);
		t_partograma_row_w.ie_plano_lee_aux		:= ie_plano_lee_w;
		t_partograma_row_w.hr_registro			:= hr_registro_w;
		t_partograma_row_w.qt_bcf			:= qt_bcf_w;
		t_partograma_row_w.ie_bolsa			:= ie_bolsa_w;
		t_partograma_row_w.ie_aspecto_liquido		:= ie_aspecto_liquido_w;
		t_partograma_row_w.qt_ocitocina			:= qt_ocitocina_w;

		RETURN NEXT t_partograma_row_w;
		ie_cursor_w	:= 'S';
		end;
	end loop;
	close C01;

	if (ie_cursor_w = 'N') then
		RETURN NEXT t_partograma_row_w;
	end if;

	end;
end loop;

end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION html_partograma_pck.gerar ( nr_atendimento_p bigint) FROM PUBLIC;
