-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION html_partograma_pck.contracao ( nr_atendimento_p bigint) RETURNS SETOF T_CONTRACAO AS $body$
DECLARE


t_contracao_row_w		t_contracao_row;
i 				bigint;
ie_achou_w			varchar(1);
qt_contracao_w			partograma.qt_contracao%type;
ie_interv_contracoes_w		partograma.ie_interv_contracoes%type;
ie_hora_w			partograma.ie_hora%type;

c01 CURSOR FOR
SELECT	qt_contracao,
	ie_interv_contracoes
from	partograma
where	nr_atendimento 		= nr_atendimento_p
and	((Obter_Param_Medico(wheb_usuario_pck.get_cd_estabelecimento,'IE_LIB_PARTOGRAMA') = 'N') 	or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''))
and	coalesce(ie_situacao,'A') 	= 'A'
and	(qt_contracao IS NOT NULL AND qt_contracao::text <> '')
and	ie_hora 		= ie_hora_w;



BEGIN

for i in 0..23 loop
	begin

	ie_hora_w 	:= i;
	ie_achou_w 	:= 'N';

	open C01;
	loop
	fetch C01 into
		qt_contracao_w,
		ie_interv_contracoes_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		ie_achou_w := 'S';

		t_contracao_row_w.qt_contracao_fraca	:= null;
		t_contracao_row_w.qt_contracao_moderada	:= null;
		t_contracao_row_w.qt_contracao_forte	:= null;
		t_contracao_row_w.ie_hora 		:= ie_hora_w;

		if (ie_interv_contracoes_w = 'Ate20') then
			t_contracao_row_w.qt_contracao_fraca		:= qt_contracao_w;
		elsif (ie_interv_contracoes_w = 'Entre20-40') then
			t_contracao_row_w.qt_contracao_moderada		:= qt_contracao_w;
		elsif (ie_interv_contracoes_w = 'Maior40') then
			t_contracao_row_w.qt_contracao_forte		:= qt_contracao_w;
		end if;

		RETURN NEXT t_contracao_row_w;
		/*for j in 1..qt_contracao_w loop
			begin
			t_contracao_row_w.qt_contracao_fraca	:= null;
			t_contracao_row_w.qt_contracao_moderada	:= null;
			t_contracao_row_w.qt_contracao_forte	:= null;
			t_contracao_row_w.ie_hora 		:= ie_hora_w;

			if	(ie_interv_contracoes_w = 'Ate20') then
				t_contracao_row_w.qt_contracao_fraca		:= j;
			elsif	(ie_interv_contracoes_w = 'Entre20-40') then
				t_contracao_row_w.qt_contracao_moderada		:= j;
			elsif	(ie_interv_contracoes_w = 'Maior40') then
				t_contracao_row_w.qt_contracao_forte		:= j;
			end if;

			pipe row(t_contracao_row_w);

			end;
		end loop;*/
		end;
	end loop;
	close C01;

	if (ie_achou_w = 'N') then

		t_contracao_row_w.qt_contracao_fraca	:= null;
		t_contracao_row_w.qt_contracao_moderada	:= null;
		t_contracao_row_w.qt_contracao_forte	:= null;
		t_contracao_row_w.ie_hora		:= ie_hora_w;

		RETURN NEXT t_contracao_row_w;

	end if;

	end;
end loop;

end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION html_partograma_pck.contracao ( nr_atendimento_p bigint) FROM PUBLIC;
