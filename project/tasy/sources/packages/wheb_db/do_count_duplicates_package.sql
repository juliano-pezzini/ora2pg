-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



	-- C_INDICES
	

	-- C_INDICE_ATRIBUTOS
	

	-- C_INTEGRIDADES_REFERENCIAIS
	

	-- C_INTEGRIDADE_ATRIBUTOS
	


CREATE OR REPLACE FUNCTION wheb_db.do_count_duplicates (table_name_p text, constraint_name_p text) RETURNS bigint AS $body$
DECLARE

	count_w                bigint;
	group_by_w             varchar(250);
	indice_atributo_w      INDICE_ATRIBUTO%rowtype;
	integridade_atributo_w INTEGRIDADE_ATRIBUTO%rowtype;
	
BEGIN
	group_by_w := NULL;
	BEGIN
	  OPEN WHEB_DB.C_INTEGRIDADE_ATRIBUTOS(table_name_p, constraint_name_p);
	  LOOP
		FETCH WHEB_DB.C_INTEGRIDADE_ATRIBUTOS INTO integridade_atributo_w;
		EXIT WHEN NOT FOUND; /* apply on WHEB_DB.C_INTEGRIDADE_ATRIBUTOS */

		IF (integridade_atributo_w.NM_ATRIBUTO IS NOT NULL AND integridade_atributo_w.NM_ATRIBUTO::text <> '') THEN
		  IF (group_by_w IS NOT NULL AND group_by_w::text <> '') THEN
			group_by_w := group_by_w || ', ';
		  END IF;

		  group_by_w := group_by_w || integridade_atributo_w.NM_ATRIBUTO;
		END IF;
	  END LOOP;

	  CLOSE WHEB_DB.C_INTEGRIDADE_ATRIBUTOS;
	EXCEPTION
	  WHEN OTHERS THEN
		CLOSE WHEB_DB.C_INTEGRIDADE_ATRIBUTOS;
		CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(sqlerrm(SQLSTATE));
	END;

	IF coalesce(group_by_w::text, '') = '' THEN
	  BEGIN
		OPEN WHEB_DB.C_INDICE_ATRIBUTOS(table_name_p, constraint_name_p);
		LOOP
		  FETCH WHEB_DB.C_INDICE_ATRIBUTOS INTO indice_atributo_w;
		  EXIT WHEN NOT FOUND; /* apply on WHEB_DB.C_INDICE_ATRIBUTOS */

		  IF (indice_atributo_w.NM_ATRIBUTO IS NOT NULL AND indice_atributo_w.NM_ATRIBUTO::text <> '') THEN
			IF (group_by_w IS NOT NULL AND group_by_w::text <> '') THEN
			  group_by_w := group_by_w || ', ';
			END IF;

			group_by_w := group_by_w || indice_atributo_w.NM_ATRIBUTO;
		  END IF;
		END LOOP;

		CLOSE WHEB_DB.C_INDICE_ATRIBUTOS;
	  EXCEPTION
		WHEN OTHERS THEN
		  CLOSE WHEB_DB.C_INDICE_ATRIBUTOS;
		  CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(sqlerrm(SQLSTATE));
	  END;
	END IF;

	IF coalesce(group_by_w::text, '') = '' THEN
	  RETURN -1;
	END IF;

	EXECUTE 'SELECT SUM(X.NRECS)' ||
					  ' FROM ( SELECT COUNT(1) NRECS' ||
							   ' FROM ' || UPPER(trim(both table_name_p)) ||
						   ' GROUP BY ' || group_by_w ||
							 ' HAVING COUNT(1) > 1 ) X '
				 INTO STRICT count_w;

	RETURN count_w;
	END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION wheb_db.do_count_duplicates (table_name_p text, constraint_name_p text) FROM PUBLIC;
