-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION wheb_db.getsql_create_constraint (integridade_referencial_p INTEGRIDADE_REFERENCIAL) RETURNS varchar AS $body$
DECLARE

	sql_w        varchar(1000);
	fields_w     varchar(255);
	fields_ref_w varchar(255);
	indice_w     INDICE%rowtype;
	
BEGIN
	IF NOT wheb_db.is_rowtype_valid(integridade_referencial_p) THEN
	  RETURN NULL;
	END IF;

	fields_w     := wheb_db.getcomma_integridade_atributos('NM_ATRIBUTO',     integridade_referencial_p.NM_TABELA, integridade_referencial_p.NM_INTEGRIDADE_REFERENCIAL);
	fields_ref_w := wheb_db.getcomma_integridade_atributos('NM_ATRIBUTO_REF', integridade_referencial_p.NM_TABELA, integridade_referencial_p.NM_INTEGRIDADE_REFERENCIAL);

	IF coalesce(fields_ref_w::text, '') = '' THEN
	  BEGIN
		OPEN C_INDICES(integridade_referencial_p.NM_TABELA_REFERENCIA, 'PK');
		FETCH C_INDICES INTO indice_w;

		fields_ref_w := WHEB_DB.GETCOMMA_INDICE_ATRIBUTOS('NM_ATRIBUTO', indice_w.NM_TABELA, indice_w.NM_INDICE);

		CLOSE C_INDICES;
	  EXCEPTION
		WHEN OTHERS THEN
		  CLOSE C_INDICES;
		  CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(sqlerrm(SQLSTATE));
	  END;
	END IF;

	sql_w := 'ALTER TABLE ' || integridade_referencial_p.NM_TABELA ||
				 ' ADD CONSTRAINT ' || integridade_referencial_p.NM_INTEGRIDADE_REFERENCIAL ||
					 ' FOREIGN KEY (' || fields_w || ')' ||
					 ' REFERENCES ' || integridade_referencial_p.NM_TABELA_REFERENCIA || ' (' || fields_ref_w || ')';

	IF UPPER(integridade_referencial_p.IE_REGRA_DELECAO) = 'CASCADE' THEN
	  sql_w := sql_w || ' ON DELETE CASCADE';
	END IF;

	IF UPPER(WHEB_USUARIO_PCK.GET_NM_USUARIO) = 'NOVALIDATE' THEN
	  sql_w := sql_w || ' NOVALIDATE';
	END IF;

	RETURN sql_w;
	END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION wheb_db.getsql_create_constraint (integridade_referencial_p INTEGRIDADE_REFERENCIAL) FROM PUBLIC;
