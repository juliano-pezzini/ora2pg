-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_reajuste_individual_pck.liberar_reajuste ( nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

dt_preco_reajuste_w	timestamp;

BEGIN
CALL CALL CALL pls_reajuste_individual_pck.carregar_filtros_lote(nr_seq_reajuste_p);
CALL CALL CALL CALL CALL pls_reajuste_individual_pck.carregar_parametros(cd_estabelecimento_p);

if (current_setting('pls_reajuste_individual_pck.ie_data_preco_reajuste_w')::pls_parametros.ie_data_preco_reajuste%type = 'A') then
	dt_preco_reajuste_w	:= coalesce(current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_aplicacao_reajuste, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_reajuste);
else
	dt_preco_reajuste_w	:= current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_reajuste;
end if;

pls_reajuste_pck.liberar_reajustes(nr_seq_reajuste_p, nm_usuario_p);

if (current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_reajustar_copartic = 'S') then
	pls_reajuste_pck.aplicar_reajuste_copartic(nr_seq_reajuste_p, dt_preco_reajuste_w, nm_usuario_p);
end if;

if (current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_reajustar_inscricao = 'S') then
	pls_reajuste_pck.aplicar_reajuste_taxa_insc(nr_seq_reajuste_p, dt_preco_reajuste_w, nm_usuario_p);
end if;

CALL pls_reajuste_pck.aplicar_reajuste_benef(nr_seq_reajuste_p, dt_preco_reajuste_w, current_setting('pls_reajuste_individual_pck.ie_reajustar_benef_cancelado_w')::pls_parametros.ie_reajustar_benef_cancelado%type,
					nm_usuario_p, cd_estabelecimento_p);

pls_reajuste_pck.aplicar_reajuste_benef_sca(	nr_seq_reajuste_p, dt_preco_reajuste_w, current_setting('pls_reajuste_individual_pck.ie_reajustar_benef_cancelado_w')::pls_parametros.ie_reajustar_benef_cancelado%type,
						current_setting('pls_reajuste_individual_pck.ie_mes_cobranca_reaj_w')::pls_parametros.ie_mes_cobranca_reaj%type, current_setting('pls_reajuste_individual_pck.ie_mes_cobranca_reaj_regulam_w')::pls_parametros.ie_mes_cobranca_reaj_reg%type, nm_usuario_p,
						cd_estabelecimento_p);

if (current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_tipo_lote = 'A') then
	CALL pls_reaj_cobranca_retro_pck.gerar_lancamentos(nr_seq_reajuste_p, null, cd_estabelecimento_p, nm_usuario_p);
elsif (current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_tipo_lote = 'D') then
	if (current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%coalesce(rowtype.nr_seq_contrato::text, '') = '') then
		update	pls_segurado_mensalidade
		set	ie_situacao	= 'I',
			ds_observacao	= ds_observacao || ' - ' || wheb_mensagem_pck.get_texto(1110182, 'NR_SEQ_REAJUSTE='||nr_seq_reajuste_p),
			nm_usuario_nrec = nm_usuario_p,
			dt_atualizacao_nrec = clock_timestamp(),
			ie_acao_desfazer = 'I'
		where	nr_sequencia in (SELECT	a.nr_sequencia
					from	pls_segurado_mensalidade a,
						pls_reajuste_cobr_retro b,
						pls_reajuste c
					where	b.nr_sequencia = a.nr_seq_reaj_retro
					and	c.nr_sequencia = b.nr_seq_reajuste
					and	c.dt_reajuste = current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_reajuste
					and	c.nr_sequencia = current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_seq_reajuste_desfazer);
	else
		update	pls_segurado_mensalidade
		set	ie_situacao	= 'I',
			ds_observacao	= ds_observacao || ' - ' || wheb_mensagem_pck.get_texto(1110182, 'NR_SEQ_REAJUSTE='||nr_seq_reajuste_p),
			nm_usuario_nrec = nm_usuario_p,
			dt_atualizacao_nrec = clock_timestamp(),
			ie_acao_desfazer = 'I'
		where	nr_sequencia in (SELECT	a.nr_sequencia
					from	pls_segurado_mensalidade a,
						pls_reajuste_cobr_retro b,
						pls_reajuste c,
						pls_segurado d
					where	d.nr_sequencia = a.nr_seq_segurado
					and	b.nr_sequencia = a.nr_seq_reaj_retro
					and	c.nr_sequencia = b.nr_seq_reajuste
					and	d.nr_seq_contrato = current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_seq_contrato
					and	c.dt_reajuste = current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_reajuste
					and	c.nr_sequencia = current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_seq_reajuste_desfazer);
	end if;
end if;

update	pls_reajuste
set	ie_status		= '2',
	dt_liberacao		= clock_timestamp(),
	nm_usuario_liberacao	= nm_usuario_p,
	nm_usuario		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp()
where	nr_sequencia		= nr_seq_reajuste_p;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reajuste_individual_pck.liberar_reajuste ( nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
