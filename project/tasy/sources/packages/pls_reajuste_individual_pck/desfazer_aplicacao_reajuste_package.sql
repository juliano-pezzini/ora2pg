-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_reajuste_individual_pck.desfazer_aplicacao_reajuste ( nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, nr_contrato_p pls_contrato.nr_contrato%type, ie_tipo_lote_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


/*
ie_tipo_lote_p	-> vai desfazer o lote por completo ou apenas o contrato informado.
0	Lote
1	Contrato
*/


nr_lote_desfazer_pendente_w	pls_reajuste.nr_sequencia%type;
nr_seq_reajuste_desfazer_w	pls_reajuste.nr_sequencia%type;
tx_reajuste_w			pls_reajuste.tx_reajuste%type;
tx_reajuste_copartic_w		pls_reajuste.tx_reajuste_copartic%type;
tx_reajuste_copartic_max_w	pls_reajuste.tx_reajuste_copartic_max%type;
tx_reajuste_inscricao_w		pls_reajuste.tx_reajuste_inscricao%type;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
nr_contrato_w			pls_contrato.nr_contrato%type;
ie_tipo_lote_w			varchar(1);


BEGIN

-- O lote de origem do reajuste fica vinculado ao lote de desfazer reajuste


nr_contrato_w	:= nr_contrato_p;
ie_tipo_lote_w	:= ie_tipo_lote_p;

CALL CALL CALL pls_reajuste_individual_pck.carregar_filtros_lote(nr_seq_reajuste_p);
CALL CALL CALL CALL CALL pls_reajuste_individual_pck.carregar_parametros(cd_estabelecimento_p);

select	max(nr_sequencia)
into STRICT	nr_lote_desfazer_pendente_w
from	pls_reajuste
where	nr_seq_reajuste_desfazer = nr_seq_reajuste_p
and	ie_status = '3';

if (nr_lote_desfazer_pendente_w IS NOT NULL AND nr_lote_desfazer_pendente_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1043906,'NR_SEQ_REAJUSTE='||nr_lote_desfazer_pendente_w); -- E necessario finalizar a aplicacao do lote de reajuste #@NR_SEQ_REAJUSTE#@.
end if;

if (coalesce(nr_contrato_w, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_contrato) is not null) then -- Se existir um contrato no lote de reajuste o tipo de lote deve ser 1 (Contrato)
	ie_tipo_lote_w	:= '1';
end if;

if	((ie_tipo_lote_w = '1') and (current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%coalesce(rowtype.nr_seq_contrato::text, '') = '')) then
	select	max(nr_sequencia)
	into STRICT	nr_seq_contrato_w
	from	pls_contrato
	where	nr_contrato = nr_contrato_w;
end if;

tx_reajuste_w		:= pls_reajuste_individual_pck.obter_taxa_desfazer_reajuste(current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.tx_reajuste);
tx_reajuste_copartic_w	:= pls_reajuste_individual_pck.obter_taxa_desfazer_reajuste(current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.tx_reajuste_copartic);
tx_reajuste_copartic_max_w := pls_reajuste_individual_pck.obter_taxa_desfazer_reajuste(current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.tx_reajuste_copartic_max);
tx_reajuste_inscricao_w	:= pls_reajuste_individual_pck.obter_taxa_desfazer_reajuste(current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.tx_reajuste_inscricao);

insert into pls_reajuste(nr_sequencia, dt_atualizacao, nm_usuario,
	dt_atualizacao_nrec, nm_usuario_nrec, dt_reajuste,
	tx_reajuste, ie_indice_reajuste, ds_oficio_ans,
	nr_protocolo_ans, ie_tipo_reajuste, ds_observacao,
	ie_status, nr_seq_contrato, cd_estabelecimento,
	ie_reajuste_tabela, dt_autorizacao_ans, nr_contrato,
	ie_aplicacao_reajuste, nr_seq_plano, ie_tipo_contrato,
	ie_tipo_lote, nr_seq_reajuste_desfazer, nr_seq_regra,
	tx_reajuste_copartic, tx_reajuste_copartic_max, ie_reajustar_copartic,
	ie_vinculo_coparticipacao, ie_reajustar_inscricao, tx_reajuste_inscricao,
	dt_periodo_inicial, dt_periodo_final, dt_inicio_geracao,
	dt_fim_geracao, dt_aplicacao_reajuste)
values (nextval('pls_reajuste_seq'), clock_timestamp(), nm_usuario_p,
	clock_timestamp(), nm_usuario_p, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_reajuste,
	tx_reajuste_w, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_indice_reajuste, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ds_oficio_ans,
	current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_protocolo_ans, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_tipo_reajuste, null,
	'3', coalesce(nr_seq_contrato_w, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_seq_contrato), current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.cd_estabelecimento,
	current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_reajuste_tabela, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_autorizacao_ans, coalesce(nr_contrato_w, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_contrato),
	current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_aplicacao_reajuste, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_seq_plano, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_tipo_contrato,
	'D', nr_seq_reajuste_p, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_seq_regra,
	tx_reajuste_copartic_w, tx_reajuste_copartic_max_w, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_reajustar_copartic,
	current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_vinculo_coparticipacao, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_reajustar_inscricao, tx_reajuste_inscricao_w,
	current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_periodo_inicial, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_periodo_final, clock_timestamp(),
	clock_timestamp(), current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.dt_aplicacao_reajuste) returning nr_sequencia into nr_seq_reajuste_desfazer_w;
	
inserir_reajuste_tabela_desf(nr_seq_reajuste_p, nr_seq_reajuste_desfazer_w, coalesce(nr_seq_contrato_w, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_seq_contrato), ie_tipo_lote_w, nm_usuario_p);

inserir_reajuste_preco_desf(nr_seq_reajuste_p, nr_seq_reajuste_desfazer_w, nm_usuario_p);

if	((current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_reajustar_copartic = 'S') or (current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.ie_reajustar_inscricao = 'S')) then
	inserir_copartic_tx_inc_desf(nr_seq_reajuste_p, nr_seq_reajuste_desfazer_w, coalesce(nr_seq_contrato_w, current_setting('pls_reajuste_individual_pck.pls_reajuste_w')::pls_reajuste%rowtype.nr_seq_contrato), ie_tipo_lote_w, nm_usuario_p, cd_estabelecimento_p);
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reajuste_individual_pck.desfazer_aplicacao_reajuste ( nr_seq_reajuste_p pls_reajuste.nr_sequencia%type, nr_contrato_p pls_contrato.nr_contrato%type, ie_tipo_lote_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
