-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerencia_dados_ocor_pck.pls_gerencia_glo_ocor_alt_vl ( nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_conta_p pls_conta_v.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, nr_seq_motivo_glosa_p tiss_motivo_glosa.nr_sequencia%type, cd_acao_analise_p pls_acao_analise.cd_acao%type, qt_liberada_p pls_conta_proc_v.qt_procedimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

  
nr_seq_ocor_inativa_w      pls_ocorrencia_benef.nr_sequencia%type;
nr_seq_glosa_inat_w       pls_conta_glosa.nr_sequencia%type;
nr_seq_glosa_conta_w      pls_conta_glosa.nr_sequencia%type;
ie_interferencia_ocor_w		pls_ocorrencia.ie_glosar_faturamento%type;
qt_glosa_w			pls_conta_proc_v.qt_procedimento%type	:= 0;


BEGIN 
 
-- Somente quando for alterar taxa de intercâmbio ou o valor do item é que as glosas devem ser inativadas. 
if (cd_acao_analise_p in (1,2)) then 
 
	CALL pls_gerencia_dados_ocor_pck.pls_gerencia_situ_glo_ocor(	nr_seq_conta_p,	nr_seq_conta_proc_p, nr_seq_conta_mat_p, null, 
					'I', nm_usuario_p);
 
	-- se foi informada uma ocorrência ou glosa 
	if (nr_seq_ocorrencia_p IS NOT NULL AND nr_seq_ocorrencia_p::text <> '') or (nr_seq_motivo_glosa_p IS NOT NULL AND nr_seq_motivo_glosa_p::text <> '') then 
 
		-- retorna ocorrência inativa se existir 
 
		if (pls_gerencia_dados_ocor_pck.pls_obter_interferencia_ocor(nr_seq_ocorrencia_p) in ('A','F')) or (coalesce(nr_seq_ocorrencia_p::text, '') = '' and (nr_seq_motivo_glosa_p IS NOT NULL AND nr_seq_motivo_glosa_p::text <> '')) then 
			qt_glosa_w := pls_gerencia_dados_ocor_pck.pls_obter_qt_glosa( nr_seq_conta_proc_p, nr_seq_conta_mat_p, qt_liberada_p );
		end if;
		 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_ocor_inativa_w 
		from	pls_ocorrencia_benef 
		where	nr_seq_ocorrencia 	= nr_seq_ocorrencia_p 
		and (nr_seq_conta_proc	= nr_seq_conta_proc_p or nr_seq_conta_mat	= nr_seq_conta_mat_p);
			 
		-- retorna glosa inativa se existir 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_glosa_inat_w 
		from	pls_conta_glosa 
		where	nr_seq_motivo_glosa 	= nr_seq_motivo_glosa_p 
		and (nr_seq_conta_proc	= nr_seq_conta_proc_p or nr_seq_conta_mat	= nr_seq_conta_mat_p) 
		and	coalesce(nr_seq_ocorrencia_benef::text, '') = '';
			 
		-- se não existir uma ocorrência inativa e foi selecionado uma ocorrência OU 
		-- se não existir uma glosa inativa e foi selecionado uma glosa 
		 
		if	((coalesce(nr_seq_ocor_inativa_w::text, '') = '')	and (nr_seq_ocorrencia_p IS NOT NULL AND nr_seq_ocorrencia_p::text <> ''))	or 
			((coalesce(nr_seq_glosa_inat_w::text, '') = '')		and (nr_seq_motivo_glosa_p IS NOT NULL AND nr_seq_motivo_glosa_p::text <> ''))	then 
			--necessário excluir os registros da tabela temporaria 
			delete	FROM w_pls_analise_glosa_ocor	a 
			where	a.nr_seq_analise	= nr_seq_analise_p 
			and	a.nr_seq_ocorrencia	= nr_seq_ocorrencia_p;
 
			delete	FROM w_pls_analise_glosa_ocor	a 
			where	a.nr_seq_analise	= nr_seq_analise_p 
			and	a.nr_seq_motivo_glosa	= nr_seq_motivo_glosa_p;
			-- insere ocorrência ou glosa selecionada na tabela w_pls_analise_glosa_ocor  
			CALL pls_inserir_w_glosa_ocor(	nr_seq_analise_p, nr_seq_ocorrencia_p, nr_seq_motivo_glosa_p, 
							null, nm_usuario_p);
			-- insere ocorrência ou glosa de acordo com o que foi gravado na tabela w_pls_analise_glosa_ocor				 
			pls_analise_inserir_glosa_item( nr_seq_analise_p, nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_conta_mat_p, 
							null, nr_seq_ocorrencia_p, nr_seq_motivo_glosa_p, 'N', cd_estabelecimento_p, 
							nm_usuario_p, 'N', nr_seq_glosa_conta_w);
			 
			-- retorna ocorrência inativa se existir 
			select	max(nr_sequencia) 
			into STRICT	nr_seq_ocor_inativa_w 
			from	pls_ocorrencia_benef 
			where	nr_seq_ocorrencia 	= nr_seq_ocorrencia_p 
			and (nr_seq_conta_proc	= nr_seq_conta_proc_p or nr_seq_conta_mat	= nr_seq_conta_mat_p);
				 
			-- retorna glosa inativa se existir 
			select	max(nr_sequencia) 
			into STRICT	nr_seq_glosa_inat_w 
			from	pls_conta_glosa 
			where	nr_seq_motivo_glosa = nr_seq_motivo_glosa_p 
			and (nr_seq_conta_proc	= nr_seq_conta_proc_p or nr_seq_conta_mat	= nr_seq_conta_mat_p);
		end if;
 
		-- se foi informado a ocorrência 
		if (nr_seq_ocorrencia_p IS NOT NULL AND nr_seq_ocorrencia_p::text <> '')	then 
			-- ativa a ocorrência 
			CALL pls_gerencia_dados_ocor_pck.pls_gerencia_situacao_ocor( nr_seq_ocor_inativa_w, 'A', nm_usuario_p,'U');
				 
			-- ativa a ocorrência vinculada a glosa 
			CALL pls_gerencia_dados_ocor_pck.pls_gerencia_situacao_glosa( null, 'A', nm_usuario_p, nr_seq_ocor_inativa_w,'U');
			 
			--Caso exista quantidade de glosa superior a 0, será realizado o update na pls_ocorrencia_benef 
			CALL pls_gerencia_dados_ocor_pck.pls_atualizar_glosa_fat(nr_seq_ocor_inativa_w, null, qt_glosa_w);
			-- se foi informado a glosa 
		elsif (nr_seq_motivo_glosa_p IS NOT NULL AND nr_seq_motivo_glosa_p::text <> '')	then 
			-- ativa a glosa 
			CALL pls_gerencia_dados_ocor_pck.pls_gerencia_situacao_glosa( nr_seq_glosa_inat_w, 'A', nm_usuario_p, null,'U');
			--Caso exista quantidade de glosa superior a 0, será realizado o update do qt_glosa_fat 
			CALL pls_gerencia_dados_ocor_pck.pls_atualizar_glosa_fat(null, nr_seq_glosa_inat_w, qt_glosa_w);
		end if;	
 
 
	end if;
 
end if;
 
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_dados_ocor_pck.pls_gerencia_glo_ocor_alt_vl ( nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_conta_p pls_conta_v.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc_v.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat_v.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, nr_seq_motivo_glosa_p tiss_motivo_glosa.nr_sequencia%type, cd_acao_analise_p pls_acao_analise.cd_acao%type, qt_liberada_p pls_conta_proc_v.qt_procedimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
