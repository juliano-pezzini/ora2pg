-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_gerencia_dados_ocor_pck.obter_restricao_inat_comb ( ie_opcao_p text, nr_cursor_p integer, dados_consistencia_p pls_tipos_ocor_pck.dados_consistencia, cd_acao_analise_p pls_acao_analise.cd_acao%type, ie_tipo_item_p pls_ocorrencia_benef_v.ie_tipo_item%type) RETURNS varchar AS $body$
DECLARE

/*Está function irá atualizar a restrição do SQL dinamico para 
a inativação da ocorrência combinadas.*/
 
ds_restricao_w		varchar(4000);	
nr_seq_acao_w		pls_acao_analise.nr_sequencia%type;

BEGIN
ds_restricao_w	:= null;
 
-- obtém a sequência da ação da análise 
nr_seq_acao_w := pls_util_cta_pck.pls_obter_seq_acao_analise(cd_acao_analise_p);
 
--Restrição para as contas médicas 
if (ie_opcao_p = 'RESTRICAO')	then 
		ds_restricao_w	:= 'and ocor_benef_v.ie_tipo_item 	= :ie_tipo_item'||pls_tipos_ocor_pck.enter_w;
	 
	if (nr_seq_acao_w IS NOT NULL AND nr_seq_acao_w::text <> '')	then 
		ds_restricao_w	:= ds_restricao_w||	'and exists(	select	1'||pls_tipos_ocor_pck.enter_w|| 
							'		from 	pls_acao_analise_ocor acao_ocor'||pls_tipos_ocor_pck.enter_w|| 
							'		where	acao_ocor.nr_seq_acao_analise = :nr_seq_acao'||pls_tipos_ocor_pck.enter_w|| 
							'		and	acao_ocor.nr_seq_ocorrencia = ocor_benef_v.nr_seq_ocorrencia)'||pls_tipos_ocor_pck.enter_w;
	end if;
				 
elsif (ie_opcao_p = 'BINDS')	then 
	dbms_sql.bind_variable(nr_cursor_p, ':ie_tipo_item',ie_tipo_item_p);
	if (nr_seq_acao_w IS NOT NULL AND nr_seq_acao_w::text <> '')	then 
		dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_acao',nr_seq_acao_w);
	end if;
end if;
 
--Restricao para as contas 
if (ie_tipo_item_p = 'C')	then 
	if (ie_opcao_p = 'RESTRICAO')	then 
		ds_restricao_w	:= ds_restricao_w||'and ocor_benef_v.nr_seq_conta	= :nr_seq_conta'||pls_tipos_ocor_pck.enter_w;
	elsif (ie_opcao_p = 'BINDS')	then 
		dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_conta',dados_consistencia_p.nr_seq_conta);
	end if;
--Restrição para os procedimentos 
elsif (ie_tipo_item_p	= 'P')	then 
	if (ie_opcao_p = 'RESTRICAO')	then 
		ds_restricao_w	:= ds_restricao_w||'and ocor_benef_v.nr_seq_conta_proc	= :nr_seq_conta_proc';
	elsif (ie_opcao_p = 'BINDS')	then 
		dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_conta_proc',dados_consistencia_p.nr_seq_conta_proc);
	end if;
--Restrição para os materiais 
elsif (ie_tipo_item_p	= 'M')	then 
	if (ie_opcao_p = 'RESTRICAO')	then 
		ds_restricao_w	:= 	ds_restricao_w||'and ocor_benef_v.nr_seq_conta_mat	= :nr_seq_conta_mat';
	elsif (ie_opcao_p = 'BINDS')	then 
		dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_conta_mat',dados_consistencia_p.nr_seq_conta_mat);
	end if;					
--Restrição para os participantes 
elsif (ie_tipo_item_p	= 'R')	then 
	if (ie_opcao_p = 'RESTRICAO')	then 
		ds_restricao_w	:= 	ds_restricao_w||'and	ocor_benef_v.nr_seq_conta_proc	= :nr_seq_conta_proc'||pls_tipos_ocor_pck.enter_w|| 
					ds_restricao_w||'and	ocor_benef_v.nr_seq_proc_partic	= :nr_seq_proc_partic';
	elsif (ie_opcao_p = 'BINDS')	then 
		dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_conta_proc',dados_consistencia_p.nr_seq_conta_proc);
		dbms_sql.bind_variable(nr_cursor_p, ':nr_seq_proc_partic',dados_consistencia_p.nr_seq_participante);
	end if;
end if;
 
return ds_restricao_w;
 
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerencia_dados_ocor_pck.obter_restricao_inat_comb ( ie_opcao_p text, nr_cursor_p integer, dados_consistencia_p pls_tipos_ocor_pck.dados_consistencia, cd_acao_analise_p pls_acao_analise.cd_acao%type, ie_tipo_item_p pls_ocorrencia_benef_v.ie_tipo_item%type) FROM PUBLIC;
