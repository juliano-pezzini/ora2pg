-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

 
--Obtém se conta possui glosa ou ocorrência 
-- vai para a pls_gerencia_dados_ocor_pck 
CREATE OR REPLACE FUNCTION pls_gerencia_dados_ocor_pck.pls_obter_se_glosa_ocor ( nr_seq_conta_p pls_conta.nr_sequencia%type) RETURNS varchar AS $body$
DECLARE

 
qt_ocor_pagamento_w	bigint;
ds_retorno_w		varchar(1);
					

BEGIN 
 
	select	count(1) 
	into STRICT	qt_ocor_pagamento_w 
	from	pls_conta_glosa		a 
	where	a.nr_seq_conta	= nr_seq_conta_p 
	and	coalesce(a.nr_seq_conta_proc::text, '') = '' 
	and	coalesce(a.nr_seq_conta_mat::text, '') = '' 
	and	coalesce(a.nr_seq_proc_partic::text, '') = '' 
	and	a.ie_situacao		= 'A' 
	and (coalesce(a.ie_lib_manual::text, '') = '' or a.ie_lib_manual = 'N' );
 
	/*Se não existir na pls_conta_glosa procura se existe uma ocorrência na conta que impede pagamento, 
	se existir uma ocorrência na conta, ou uma glosa deve deixar o status do item como Indefinido - solicitação da Rio Pretos OS - 541834*/
 
	if (qt_ocor_pagamento_w = 0) then 
		select count(1) 
		into STRICT  	qt_ocor_pagamento_w 
		from 	pls_ocorrencia_benef b, 
			pls_ocorrencia  c 
		where b.nr_seq_conta_proc  = nr_seq_conta_p 
		and b.ie_situacao  = 'A' 
		and c.nr_sequencia  = b.nr_seq_ocorrencia   
		and c.ie_situacao  = 'A' 
		and c.ie_glosar_pagamento = 'S' 
		and (	SELECT count(1) 
			from  pls_conta_glosa x 
			where x.nr_seq_ocorrencia_benef = b.nr_sequencia 
			and x.ie_lib_manual   = 'S') = 0 
		and (	select count(1) 
			from  pls_conta_glosa x 
			where x.nr_sequencia   = b.nr_seq_glosa 
			and x.ie_lib_manual   = 'S') = 0;
		   
	end if;
 
if (qt_ocor_pagamento_w > 0) then 
	ds_retorno_w := 'S';
else 
	ds_retorno_w := 'N';
end if;
 
return ds_retorno_w;
 
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_gerencia_dados_ocor_pck.pls_obter_se_glosa_ocor ( nr_seq_conta_p pls_conta.nr_sequencia%type) FROM PUBLIC;
