-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION anzics_pck.get_icu_source ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint) RETURNS bigint AS $body$
DECLARE

    nr_icu_source_w           smallint  := 0;
    nr_prev_setor_classif_w    setor_atendimento.CD_CLASSIF_SETOR%type;
    ie_prev_setor_w           varchar(1) :='N';
    nr_seq_atepacu_prev_w     atend_paciente_unidade.nr_seq_interno%type;
    nr_prev_setor_2_classif_w setor_atendimento.CD_CLASSIF_SETOR%type;
    ie_prev_setor_w_2         varchar(1) :='N';
    nr_prior_location_w       procedencia.cd_procedencia_externo%type;
    is_surgery_cancelled_w    varchar(1)  := 'N';

BEGIN
    SELECT CASE WHEN COUNT(1)=0 THEN 'N'  ELSE 'S' END 
    INTO STRICT ie_prev_setor_w
    FROM atend_paciente_unidade
    WHERE nr_atendimento  = nr_atendimento_p
    AND nr_seq_interno    < nr_seq_atepacu_p
    AND ie_passagem_setor = 'N';
    SELECT MAX(nr_seq_interno)
    INTO STRICT nr_seq_atepacu_prev_w
    FROM atend_paciente_unidade
    WHERE nr_atendimento     = nr_atendimento_p
    AND nr_seq_interno       < nr_seq_atepacu_p
    AND ie_passagem_setor    = 'N';
    IF (nr_seq_atepacu_prev_w > 0) THEN
      SELECT CASE WHEN COUNT(1)=0 THEN 'N'  ELSE 'S' END
      INTO STRICT ie_prev_setor_w_2
      FROM atend_paciente_unidade
      WHERE nr_seq_interno =
        (SELECT MAX(nr_seq_interno)
        FROM atend_paciente_unidade
        WHERE nr_atendimento  = nr_atendimento_p
        AND nr_seq_interno    < nr_seq_atepacu_prev_w
        AND ie_passagem_setor = 'N'
        );
      IF (ie_prev_setor_w_2 ='S') THEN
        SELECT obter_classif_setor(MAX(cd_setor_atendimento))
        INTO STRICT nr_prev_setor_2_classif_w
        FROM atend_paciente_unidade
        WHERE nr_seq_interno =
          (SELECT MAX(nr_seq_interno)
          FROM atend_paciente_unidade
          WHERE nr_atendimento  = nr_atendimento_p
          AND nr_seq_interno    < nr_seq_atepacu_prev_w
          AND ie_passagem_setor = 'N'
          );
      END IF;
    END IF;
    SELECT CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END
    INTO STRICT is_surgery_cancelled_w
    FROM atend_paciente_unidade a
    INNER JOIN cirurgia c
    ON a.nr_cirurgia     = c.nr_cirurgia
    WHERE nr_seq_interno = nr_seq_atepacu_p
    AND (dt_cancelamento IS NOT NULL AND dt_cancelamento::text <> '');
    IF (ie_prev_setor_w   ='S') THEN
      SELECT obter_classif_setor(MAX(cd_setor_atendimento))
      INTO STRICT nr_prev_setor_classif_w
      FROM atend_paciente_unidade
      WHERE nr_seq_interno = nr_seq_atepacu_prev_w;
    END IF;
    SELECT MAX(a.cd_procedencia_externo)
    INTO STRICT nr_prior_location_w
    FROM procedencia a,
      atendimento_paciente b
    WHERE a.cd_procedencia     = b.cd_procedencia
    AND b.nr_atendimento       = nr_atendimento_p;
    IF (is_surgery_cancelled_w  ='S' AND ie_prev_setor_w_2 ='S') THEN
      nr_prev_setor_classif_w := nr_prev_setor_2_classif_w;
    END IF;
    IF (nr_prev_setor_classif_w = 2) THEN
      RETURN 1;
    elsif (nr_prev_setor_classif_w = 1) THEN
      RETURN 2;
    elsif (nr_prev_setor_classif_w = 3) THEN
      RETURN 3;
    elsif (nr_prev_setor_classif_w = 4) THEN
      RETURN 4;
    elsif (nr_prior_location_w = 2) THEN
      RETURN 5;
    elsif (nr_prior_location_w = 4) THEN
      RETURN 6;
    elsif (nr_prior_location_w = 1) THEN
      RETURN 9;
    END IF;
    RETURN NULL;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION anzics_pck.get_icu_source ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint) FROM PUBLIC;
