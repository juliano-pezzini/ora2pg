-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION anzics_pck.get_treatment_goals ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint ) RETURNS bigint AS $body$
DECLARE

    nr_return_w               bigint := NULL;
    ie_not_for_met_nfm_w       varchar(1);
    ie_met_resus_fully_mfr_w    varchar(1);
    ie_met_resus_limit_mrl_w varchar(1);

BEGIN
    CALL anzics_pck.set_icu_date(nr_seq_atepacu_p);

    SELECT CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END 
    INTO STRICT ie_not_for_met_nfm_w
    FROM diretriz_atendimento
    WHERE nr_atendimento              =nr_atendimento_p
    AND ie_diretriz                   = 'NFM'
    AND ie_resposta                   ='S'
    AND (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    AND ie_situacao                   ='A'
    AND coalesce(dt_inativacao::text, '') = ''
    AND TRUNC(coalesce(dt_final,clock_timestamp())) >= TRUNC(clock_timestamp());

    SELECT CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END 
    INTO STRICT ie_met_resus_limit_mrl_w
    FROM diretriz_atendimento
    WHERE nr_atendimento              =nr_atendimento_p
    AND ie_diretriz                   = 'MRL'
    AND ie_resposta                   ='S'
    AND (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    AND ie_situacao                   ='A'
    AND coalesce(dt_inativacao::text, '') = ''
    AND TRUNC(coalesce(dt_final,clock_timestamp())) >= TRUNC(clock_timestamp());

    SELECT CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END
    INTO STRICT ie_met_resus_fully_mfr_w
    FROM diretriz_atendimento
    WHERE nr_atendimento =nr_atendimento_p
    AND ie_diretriz     = 'MFR'
    AND ie_resposta      ='S'
    AND (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    AND ie_situacao      ='A'
    AND coalesce(dt_inativacao::text, '') = ''
    AND TRUNC(coalesce(dt_final,clock_timestamp())) >= TRUNC(clock_timestamp());
	
    IF (ie_met_resus_limit_mrl_w ='S') THEN
      nr_return_w               :=2;
    elsif (ie_not_for_met_nfm_w    ='S')THEN
      nr_return_w               :=3;
    elsif (ie_met_resus_fully_mfr_w = 'S') THEN
      nr_return_w               :=1;
    END IF;
    RETURN nr_return_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION anzics_pck.get_treatment_goals ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint ) FROM PUBLIC;
