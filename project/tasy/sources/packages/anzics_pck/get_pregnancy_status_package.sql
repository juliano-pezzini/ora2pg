-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION anzics_pck.get_pregnancy_status ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, nr_seq_atepacu_p bigint) RETURNS bigint AS $body$
DECLARE

    nr_reterno_w            bigint := NULL;
    ie_sex_w                varchar(1);
    qt_age_w                bigint;
    ie_pregnent_w           varchar(1) := 'N';
    dt_nascimento_w         timestamp;
    ie_birth_history_exists varchar(1) := 'N';

BEGIN
    SELECT obter_dados_pf(cd_pessoa_fisica_p,'SE'),
      obter_idade_pf(cd_pessoa_fisica_p,clock_timestamp(),'A')
    INTO STRICT ie_sex_w,
      qt_age_w
;
    IF (ie_sex_w   <> 'F') THEN
      nr_reterno_w := NULL;
    END IF;
    IF (ie_sex_w = 'F') THEN
      BEGIN
        IF (qt_age_w   <= 10 AND qt_age_w >= 61) THEN
          nr_reterno_w := NULL;
        ELSE
          BEGIN
            SELECT coalesce(ie_paciente_gravida ,'N')
            INTO STRICT ie_pregnent_w
            FROM atendimento_paciente
            WHERE nr_atendimento = nr_atendimento_p;
            IF (ie_pregnent_w    = 'N') THEN
              nr_reterno_w      := 2;
            END IF;
            IF (ie_pregnent_w = 'S') THEN
              nr_reterno_w   := 1;
            END IF;
            SELECT CASE WHEN COUNT(1)=0 THEN 'N'  ELSE 'S' END
            INTO STRICT ie_birth_history_exists
            FROM HISTORICO_SAUDE_MULHER
            WHERE cd_pessoa_fisica     = cd_pessoa_fisica_p
            AND (DT_LIBERACAO IS NOT NULL AND DT_LIBERACAO::text <> '')
            AND coalesce(DT_INATIVACAO::text, '') = ''
            AND IE_SITUACAO = 'A'
            AND (DT_ULT_PARTO IS NOT NULL AND DT_ULT_PARTO::text <> '');
            IF (ie_birth_history_exists = 'S') THEN
              SELECT MAX(DT_ULT_PARTO)
              INTO STRICT dt_nascimento_w
              FROM HISTORICO_SAUDE_MULHER
              WHERE cd_pessoa_fisica = cd_pessoa_fisica_p
              AND (DT_LIBERACAO IS NOT NULL AND DT_LIBERACAO::text <> '')
              AND coalesce(DT_INATIVACAO::text, '') = ''
              AND IE_SITUACAO = 'A'
              AND (DT_ULT_PARTO IS NOT NULL AND DT_ULT_PARTO::text <> '');
              IF ((dt_nascimento_w IS NOT NULL AND dt_nascimento_w::text <> '') AND (clock_timestamp() - dt_nascimento_w) <= 42) THEN
                nr_reterno_w        := 3;
              END IF;
            END IF;
          END;
        END IF;
      END;
    END IF;
    RETURN nr_reterno_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION anzics_pck.get_pregnancy_status ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, nr_seq_atepacu_p bigint) FROM PUBLIC;
