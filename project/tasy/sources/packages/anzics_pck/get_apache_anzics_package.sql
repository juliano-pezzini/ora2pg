-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION anzics_pck.get_apache_anzics ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint, ie_apache_type_p text, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

    ie_fio2_w           double precision;
    ie_pao2_w           double precision;
    ie_paco2_w          double precision;
    ie_ph_w             double precision;
    nr_seq_exame_fio2_w bigint;
    nr_seq_exame_pa02_w bigint;
    nr_seq_exame_co2_w  bigint;
    nr_seq_exame_ph_w   bigint;
    nr_seq_resultado_w  bigint;
    dt_resultado_w timestamp;
    ie_intubated_w varchar(1) := 'N';

BEGIN
    CALL anzics_pck.set_icu_date(nr_seq_atepacu_p);
    SELECT nr_seq_exame_apache_pao2 ,
      nr_seq_exame_apache_co2,
      nr_seq_exame_apache_ph,
      nr_seq_exame_apache_fio2
    INTO STRICT nr_seq_exame_pa02_w ,
      nr_seq_exame_co2_w ,
      nr_seq_exame_ph_w,
      nr_seq_exame_fio2_w
    FROM anzics_parameter
    WHERE cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
    SELECT anzics_pck.obter_apache_result_seq(nr_atendimento_p,current_setting('anzics_pck.dt_inicio_w')::timestamp,current_setting('anzics_pck.dt_fim_w')::timestamp,ie_apache_type_p,CASE WHEN ie_opcao_p='PH' THEN 'PH'  ELSE 'BG' END )
    INTO STRICT nr_seq_resultado_w
;
    SELECT MAX(anzics_pck.obter_apache_exam_result(nr_atendimento_p,current_setting('anzics_pck.dt_inicio_w')::timestamp,current_setting('anzics_pck.dt_fim_w')::timestamp,nr_seq_exame_fio2_w,nr_seq_resultado_w)) ,
      MAX(anzics_pck.obter_apache_exam_result(nr_atendimento_p,current_setting('anzics_pck.dt_inicio_w')::timestamp,current_setting('anzics_pck.dt_fim_w')::timestamp,nr_seq_exame_pa02_w,nr_seq_resultado_w)) ,
      MAX(anzics_pck.obter_apache_exam_result(nr_atendimento_p,current_setting('anzics_pck.dt_inicio_w')::timestamp,current_setting('anzics_pck.dt_fim_w')::timestamp,nr_seq_exame_co2_w, nr_seq_resultado_w)),
      MAX(anzics_pck.obter_apache_exam_result(nr_atendimento_p,current_setting('anzics_pck.dt_inicio_w')::timestamp,current_setting('anzics_pck.dt_fim_w')::timestamp,nr_seq_exame_ph_w, nr_seq_resultado_w))
    INTO STRICT ie_fio2_w,
      ie_pao2_w,
      ie_paco2_w,
      ie_ph_w
;

    if (ie_apache_type_p = 'III') then
    select dt_resultado 
    into STRICT dt_resultado_w 
    from exame_lab_resultado 
    where NR_SEQ_RESULTADO = nr_seq_resultado_w;

    ie_intubated_w := anzics_pck.get_intubation_status(nr_atendimento_p,(dt_resultado_w-((1/24/60)*59)),(dt_resultado_w + ((1/24/60)*59)));

    end if;

    IF (ie_opcao_p = 'FIO2') THEN
      RETURN ie_fio2_w;
    elsif (ie_opcao_p = 'PAO2') THEN
      RETURN ie_pao2_w;
    elsif (ie_opcao_p = 'PACO2') THEN
      RETURN ie_paco2_w;
    elsif (ie_opcao_p = 'PH') THEN
      RETURN ie_ph_w;
    elsif (ie_opcao_p = 'INTUBATED') THEN
    return ie_intubated_w;
    END IF;
    RETURN NULL;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION anzics_pck.get_apache_anzics ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint, ie_apache_type_p text, ie_opcao_p text) FROM PUBLIC;
