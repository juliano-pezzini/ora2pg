-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION anzics_pck.obter_apache_result_seq ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ie_apache_type_p text, ie_field_type_p text ) RETURNS bigint AS $body$
DECLARE

    /*
    BG - for blood gases (fio2,pao2,co2)
    PH - For arterial PH
    */
    nr_seq_apache_w exame_lab_resultado.nr_seq_resultado%type;
    nr_seq_exame_fio2_w exame_laboratorio.nr_seq_exame%type;
    nr_seq_exame_pa02_w exame_laboratorio.nr_seq_exame%type;
    nr_seq_exame_co2_w exame_laboratorio.nr_seq_exame%type;
    nr_seq_exame_ph_w exame_laboratorio.nr_seq_exame%type;
    qt_fio2_w                double precision;
    qt_pa02_w                double precision;
    qt_co2_w                 double precision;
    qt_ph_w                  double precision;
    nr_apache_result_curr_w  bigint;
    nr_apache_result_final_w bigint;
    ie_first_row_w           varchar(1) := 'S';
    c01 CURSOR FOR
      SELECT anzics_pck.obter_apache_exam_result(nr_atendimento_p,dt_inicio_p,dt_fim_p,nr_seq_exame_fio2_w, a.nr_seq_resultado) qt_fio2,
        anzics_pck.obter_apache_exam_result(nr_atendimento_p,dt_inicio_p,dt_fim_p,nr_seq_exame_pa02_w, a.nr_seq_resultado) qt_pao2,
        anzics_pck.obter_apache_exam_result(nr_atendimento_p,dt_inicio_p,dt_fim_p,nr_seq_exame_co2_w, a.nr_seq_resultado)qt_co2,
        anzics_pck.obter_apache_exam_result(nr_atendimento_p,dt_inicio_p,dt_fim_p,nr_seq_exame_ph_w, a.nr_seq_resultado) qt_ph,
        a.nr_seq_resultado,
        a.dt_resultado
      FROM exame_lab_result_item b,
        exame_lab_resultado a,
        prescr_procedimento x,
        exame_laboratorio y,
        prescr_medica c
      WHERE a.nr_seq_resultado = b.nr_seq_resultado
      AND a.nr_prescricao      = c.nr_prescricao
      AND x.nr_sequencia       = b.nr_seq_prescr
      AND x.nr_prescricao      = c.nr_prescricao
      AND c.nr_atendimento     = nr_atendimento_p
      AND b.nr_seq_exame       = y.nr_seq_exame
      AND x.ie_status_atend   >= 35
      AND a.dt_resultado BETWEEN dt_inicio_p AND dt_fim_p;

BEGIN
    SELECT nr_seq_exame_apache_pao2 ,
      nr_seq_exame_apache_co2,
      nr_seq_exame_apache_ph,
      nr_seq_exame_apache_fio2
    INTO STRICT nr_seq_exame_pa02_w ,
      nr_seq_exame_co2_w ,
      nr_seq_exame_ph_w,
      nr_seq_exame_fio2_w
    FROM anzics_parameter
    WHERE cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
    FOR r_c01 IN c01
    LOOP
      BEGIN
        IF (ie_first_row_w             = 'S') THEN
          ie_first_row_w             :='N';
          IF ( ie_field_type_p         = 'BG') THEN
            nr_apache_result_curr_w  := anzics_pck.obter_apache_score_anzics(r_c01.qt_fio2,r_c01.qt_pao2,r_c01.qt_co2,ie_apache_type_p,r_c01.dt_resultado,nr_atendimento_p);
            nr_apache_result_final_w := nr_apache_result_curr_w;
            nr_seq_apache_w          := r_c01.nr_seq_resultado;
          ELSE
            nr_apache_result_curr_w  := anzics_pck.obter_apache_score_anzics_ph(r_c01.qt_ph,r_c01.qt_co2,ie_apache_type_p);
            nr_apache_result_final_w := nr_apache_result_curr_w;
            nr_seq_apache_w          := r_c01.nr_seq_resultado;
          END IF;
        ELSE
          IF ( ie_field_type_p            = 'BG') THEN
            nr_apache_result_curr_w     := anzics_pck.obter_apache_score_anzics(r_c01.qt_fio2,r_c01.qt_pao2,r_c01.qt_co2,ie_apache_type_p,r_c01.dt_resultado,nr_atendimento_p);
            IF ( nr_apache_result_curr_w > nr_apache_result_final_w) THEN
              nr_apache_result_final_w  := nr_apache_result_curr_w;
              nr_seq_apache_w           := r_c01.nr_seq_resultado;
            END IF;
          ELSE
            nr_apache_result_curr_w    := anzics_pck.obter_apache_score_anzics_ph(r_c01.qt_ph,r_c01.qt_co2,ie_apache_type_p);
            IF (nr_apache_result_curr_w > nr_apache_result_final_w) THEN
              nr_apache_result_final_w := nr_apache_result_curr_w;
              nr_seq_apache_w          := r_c01.nr_seq_resultado;
            END IF;
          END IF;
        END IF;
      END;
    END LOOP;
    RETURN nr_seq_apache_w;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION anzics_pck.obter_apache_result_seq ( nr_atendimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ie_apache_type_p text, ie_field_type_p text ) FROM PUBLIC;
