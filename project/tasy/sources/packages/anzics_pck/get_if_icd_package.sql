-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION anzics_pck.get_if_icd ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, cd_doenca_cid_p text) RETURNS varchar AS $body$
DECLARE

    qt_reg_w bigint;

BEGIN
    SELECT COUNT(1)
    INTO STRICT qt_reg_w
    FROM diagnostico_doenca a
    WHERE a.nr_atendimento = nr_atendimento_p
    AND a.cd_doenca        = cd_doenca_cid_p
    AND (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
    AND coalesce(a.dt_inativacao::text, '') = '';
    IF (qt_reg_w           > 0) THEN
      RETURN 'S';
    ELSE
      SELECT COUNT(1)
      INTO STRICT qt_reg_w
      FROM diagnostico_doenca a,
        cid_categoria b,
        cid_doenca c
      WHERE a.nr_atendimento = nr_atendimento_p
      AND c.cd_doenca_cid    = a.cd_doenca
      AND b.cd_categoria_cid = c.cd_categoria_cid
      AND b.cd_categoria_cid = cd_doenca_cid_p
      AND (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
      AND coalesce(a.dt_inativacao::text, '') = '';
      IF (qt_reg_w           > 0) THEN
        RETURN 'S';
      ELSE
        SELECT COUNT(1)
        INTO STRICT qt_reg_w
        FROM paciente_antec_clinico a
        WHERE a.cd_pessoa_fisica   = cd_pessoa_fisica_p
        AND a.cd_doenca            = cd_doenca_cid_p
        AND (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
        AND coalesce(a.ie_paciente,'S') = 'S'
        AND ((coalesce(a.dt_fim::text, '') = '')
        OR (clock_timestamp() BETWEEN coalesce(a.dt_inicio,clock_timestamp()) AND a.dt_fim))
        AND coalesce(a.dt_inativacao::text, '') = '';
        IF (qt_reg_w         > 0) THEN
          RETURN 'S';
        ELSE
          SELECT COUNT(1)
          INTO STRICT qt_reg_w
          FROM paciente_antec_clinico a,
            cid_categoria b,
            cid_doenca c
          WHERE a.cd_pessoa_fisica   = cd_pessoa_fisica_p
          AND c.cd_doenca_cid        = a.cd_doenca
          AND b.cd_categoria_cid     = c.cd_categoria_cid
          AND b.cd_categoria_cid     = cd_doenca_cid_p
          AND coalesce(a.ie_paciente,'S') = 'S'
          AND (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
          AND ((coalesce(a.dt_fim::text, '') = '')
          OR (clock_timestamp() BETWEEN coalesce(a.dt_inicio,clock_timestamp()) AND a.dt_fim))
          AND coalesce(a.dt_inativacao::text, '') = '';
          IF (qt_reg_w         > 0) THEN
            RETURN 'S';
          END IF;
        END IF;
      END IF;
    END IF;
    NULL;
    RETURN 'N';
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION anzics_pck.get_if_icd ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, cd_doenca_cid_p text) FROM PUBLIC;
