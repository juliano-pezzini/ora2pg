-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION anzics_pck.get_icu_outcome ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint) RETURNS bigint AS $body$
DECLARE

    nr_next_setor_classif_w smallint;
    ie_obito_w              varchar(1) := 'N';
    ie_tranf_other_hosp_w   varchar(1) := 'N';
    dt_entrada_w            timestamp;
    dt_saida_w              timestamp;

BEGIN
    SELECT MAX(dt_entrada_unidade),
      MAX(dt_saida_unidade)
    INTO STRICT dt_entrada_w,
      dt_saida_w
    FROM atend_paciente_unidade
    WHERE nr_seq_interno = nr_seq_atepacu_p;
    SELECT MAX(ie_obito)
    INTO STRICT ie_obito_w
    FROM motivo_alta a
    LEFT OUTER JOIN atendimento_paciente b
    ON a.cd_motivo_alta    = b.cd_motivo_alta
    WHERE b.nr_atendimento = nr_atendimento_p
    AND b.dt_alta BETWEEN dt_entrada_w AND dt_saida_w;
    SELECT CASE WHEN COUNT(*)=1 THEN 'S'  ELSE 'N' END
    INTO STRICT ie_tranf_other_hosp_w
    FROM atendimento_paciente a,
      motivo_alta b
    WHERE a.cd_motivo_alta = b.cd_motivo_alta
    AND a.nr_atendimento   = nr_atendimento_p
    AND (a.dt_alta IS NOT NULL AND a.dt_alta::text <> '')
    AND b.ie_transferencia = 'S';
    SELECT obter_classif_setor(MAX(cd_setor_atendimento))
    INTO STRICT nr_next_setor_classif_w
    FROM atend_paciente_unidade
    WHERE nr_seq_interno =
      (SELECT MIN(nr_seq_interno)
      FROM atend_paciente_unidade
      WHERE nr_atendimento  = nr_atendimento_p
      AND nr_seq_interno    > nr_seq_atepacu_p
      AND ie_passagem_setor = 'N'
      );
    IF (ie_obito_w = 'S') THEN
      RETURN 2;
    elsif (ie_tranf_other_hosp_w ='S') THEN
      RETURN 6;
    elsif ( nr_next_setor_classif_w = 3) THEN
      RETURN 3;
    elsif ( nr_next_setor_classif_w = 4) THEN
      RETURN 5;
    END IF;
    RETURN NULL;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION anzics_pck.get_icu_outcome ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint) FROM PUBLIC;
