-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION anzics_pck.get_apache2 ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

    ie_fio2_w  double precision;
    ie_pao2_w  double precision;
    ie_paco2_w double precision;
    ie_ph_w    double precision;
    ie_ira_w   double precision;

BEGIN
    CALL anzics_pck.set_icu_date(nr_seq_atepacu_p);
    SELECT ROUND((MAX(qt_oxigenacao_fio2)/100),2),
      ROUND(MAX(qt_oxigenacao_pao2)),
      ROUND(MAX(qt_oxigenacao_pco2)),
      MAX(qt_pto_ph_art),
      CASE WHEN MAX(ie_ira)='S' THEN 1  ELSE 0 END
    INTO STRICT ie_fio2_w,
      ie_pao2_w,
      ie_paco2_w,
      ie_ph_w,
      ie_ira_w
    FROM apache a
    WHERE a.nr_sequencia =
      (SELECT MAX(nr_sequencia)
      FROM apache y
      WHERE y.nr_atendimento = nr_atendimento_p
      AND (y.dt_liberacao IS NOT NULL AND y.dt_liberacao::text <> '')
      AND coalesce(y.dt_inativacao::text, '') = ''
      AND (y.qt_apache_ii IS NOT NULL AND y.qt_apache_ii::text <> '')
      AND y.dt_apache BETWEEN current_setting('anzics_pck.dt_inicio_w')::timestamp AND current_setting('anzics_pck.dt_fim_w')::timestamp
      AND y.qt_apache_ii =
        (SELECT MIN(x.qt_apache_ii)
        FROM apache x
        WHERE x.nr_atendimento = nr_atendimento_p
        AND (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
        AND coalesce(x.dt_inativacao::text, '') = ''
        AND (x.qt_apache_ii IS NOT NULL AND x.qt_apache_ii::text <> '')
        AND x.dt_apache BETWEEN current_setting('anzics_pck.dt_inicio_w')::timestamp AND current_setting('anzics_pck.dt_fim_w')::timestamp
        )
      );
    IF (ie_opcao_p = 'FIO2') THEN
      RETURN ie_fio2_w;
    elsif (ie_opcao_p = 'PAO2') THEN
      RETURN ie_pao2_w;
    elsif (ie_opcao_p = 'PACO2') THEN
      RETURN ie_paco2_w;
    elsif (ie_opcao_p = 'PH') THEN
      RETURN ie_ph_w;
    elsif (ie_opcao_p = 'ARF') THEN
      RETURN ie_ira_w;
    END IF;
    RETURN NULL;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION anzics_pck.get_apache2 ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint, ie_opcao_p text) FROM PUBLIC;
