-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION anzics_pck.get_glasgow ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint, ie_opcao_p text) RETURNS bigint AS $body$
DECLARE

    ie_resposta_motora_w smallint;
    ie_resposta_verbal_w smallint;
    ie_abertura_ocular_w smallint;
    qt_glasgow_w         smallint;

BEGIN
    CALL anzics_pck.set_icu_date(nr_seq_atepacu_p);
    SELECT MAX(ie_resposta_motora),
      MAX(ie_resposta_verbal),
      MAX(ie_abertura_ocular),
      MAX(qt_glasgow)
    INTO STRICT ie_resposta_motora_w,
      ie_resposta_verbal_w,
      ie_abertura_ocular_w,
      qt_glasgow_w
    FROM atend_escala_indice a
    WHERE a.nr_sequencia =
      (SELECT MAX(nr_sequencia)
      FROM atend_escala_indice y
      WHERE y.nr_atendimento = nr_atendimento_p
      AND (y.dt_liberacao IS NOT NULL AND y.dt_liberacao::text <> '')
      AND coalesce(y.dt_inativacao::text, '') = ''
      AND (y.qt_glasgow IS NOT NULL AND y.qt_glasgow::text <> '')
      AND y.dt_avaliacao BETWEEN current_setting('anzics_pck.dt_inicio_w')::timestamp AND current_setting('anzics_pck.dt_fim_w')::timestamp
      AND y.qt_glasgow =
        (SELECT MIN(x.qt_glasgow)
        FROM atend_escala_indice x
        WHERE x.nr_atendimento = nr_atendimento_p
        AND (x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
        AND coalesce(x.dt_inativacao::text, '') = ''
        AND (x.qt_glasgow IS NOT NULL AND x.qt_glasgow::text <> '')
        AND x.dt_avaliacao BETWEEN current_setting('anzics_pck.dt_inicio_w')::timestamp AND current_setting('anzics_pck.dt_fim_w')::timestamp
        )
      );
    IF (ie_opcao_p = 'GCS') THEN
      RETURN qt_glasgow_w;
    elsif (ie_opcao_p = 'GCSEYE') THEN
      RETURN ie_abertura_ocular_w;
    elsif (ie_opcao_p = 'GCSVERB') THEN
      RETURN ie_resposta_verbal_w;
    elsif (ie_opcao_p = 'GCSMOTOR') THEN
      RETURN ie_resposta_motora_w;
    END IF;
    RETURN NULL;
  END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION anzics_pck.get_glasgow ( nr_atendimento_p bigint, nr_seq_atepacu_p bigint, ie_opcao_p text) FROM PUBLIC;
