-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_smp_pck.aplicar_regra_preco_mat ( regra_simulacao_p pls_smp_pck.regra_simulacao, regra_simulacao_preco_mat_p pls_smp_pck.regra_simulacao_preco_mat, dados_regra_preco_mat_p pls_cta_valorizacao_pck.dados_regra_preco_mat_data, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Aplica as regras de precos passasdas por parametro, gravando nas tabelas de simulacao
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atencao:
Alteracoes:
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
					
/* ie_tipo_tabela_p
	1 - Brasindice
	2 - Simpro
	3 - Tabela propria
	4 - Todas
*/
ie_origem_preco_ww		smallint;
dt_base_w			timestamp;
dt_vigencia_w			timestamp	:= clock_timestamp() - interval '1000 days';
dt_vigencia_orig_w		timestamp	:= clock_timestamp();
vl_material_w			double precision 	:= 0;
vl_material_brasindice_w	double precision 	:= null;
vl_material_simpro_w		double precision 	:= null;
vl_material_tabela_w		double precision 	:= null;
vl_material_orig_w		double precision 	:= null;
vl_material_ww			double precision 	:= 0;
vl_material_simpro_ww		double precision 	:= null;
vl_material_tabela_ww		double precision 	:= null;
vl_material_brasindice_ww	double precision 	:= null;
dt_ult_vigencia_w		timestamp;
nr_seq_material_preco_ww	bigint;
tx_ajuste_pfb_w			double precision	:= null;
tx_pmc_neut_w			double precision	:= null;
tx_pmc_neg_w			double precision	:= null;
tx_pmc_pos_w			double precision	:= null;
tx_simpro_pfb_w			double precision	:= null;
tx_simpro_pmc_w			double precision	:= null;
tx_ajuste_w			double precision	:= 0;
tx_ajuste_tab_w			double precision	:= null;
nr_seq_regra_w			bigint;
ie_origem_w			varchar(5);
ie_origem_ww			varchar(1);
vl_material_inf_w		double precision;
cd_tiss_w			varchar(40);
nr_seq_material_preco_w		bigint;
ie_tabela_adicional_w		bigint;
dt_base_fixo_w			timestamp;
ie_tipo_preco_brasindice_w	varchar(3);
ie_tipo_preco_simpro_w		varchar(1);
vl_apresentado_w		double precision;
vl_pfb_neutra_simpro_w		double precision	:= 0;
vl_pfb_positiva_simpro_w	double precision	:= 0;
vl_pfb_negativa_simpro_w	double precision	:= 0;
vl_pfb_nao_aplicavel_simpro_w	double precision	:= 0;
VL_PFB_NEUTRA_BRASINDICE_w	double precision	:= 0;
vl_pfb_positiva_brasindice_w	double precision	:= 0;
vl_pfb_negativa_brasindice_w	double precision	:= 0;
vl_material_a900_w		pls_material_unimed.vl_max_consumidor%type;
ie_tipo_ajuste_pfb_w		varchar(2);
dados_regra_preco_material_w	pls_cta_valorizacao_pck.dados_regra_preco_mat_data;
ie_tipo_preco_tab_adic_w	pls_regra_preco_mat.ie_tipo_preco_tab_adic%type;
nr_seq_guia_w			pls_conta.nr_seq_guia%type;
ds_origem_w			varchar(255);
vl_perc_icms_w			pls_regra_icms.vl_perc_icms%type;
i				integer;
ie_alc_w			pls_mat_unimed_trib.id_alc%type;
cd_municipio_w			sus_municipio.cd_municipio_ibge%type;
pr_icms_w			pls_regra_preco_mat.pr_icms%type;


BEGIN

-- So executa se tiver algum material e alguma regra
if (regra_simulacao_p.nr_sequencia IS NOT NULL AND regra_simulacao_p.nr_sequencia::text <> '') and (dados_regra_preco_mat_p.count > 0) then

	dt_vigencia_w 		:= trunc(regra_simulacao_p.dt_referencia, 'dd');
	vl_apresentado_w	:= 0;
	
	-- copia as regras passadas por parametros para o local
	dados_regra_preco_material_w	:= dados_regra_preco_mat_p;
	
	-- navega pelas regras
	for i in dados_regra_preco_material_w.first .. dados_regra_preco_material_w.last loop
		
		if (regra_simulacao_preco_mat_p.nr_seq_prestador IS NOT NULL AND regra_simulacao_preco_mat_p.nr_seq_prestador::text <> '') then
		
			cd_municipio_w := pls_obter_dados_prestador(regra_simulacao_preco_mat_p.nr_seq_prestador, 'IBGE');
				
			select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
			into STRICT	ie_alc_w
			from	pls_municipio_livre_com
			where	cd_municipio_ibge = cd_municipio_w;
		end if;
		
		nr_seq_regra_w			:= dados_regra_preco_material_w[i].nr_sequencia;
		tx_ajuste_w			:= dados_regra_preco_material_w[i].tx_ajuste;
		vl_material_w			:= dados_regra_preco_material_w[i].vl_negociado;
		tx_ajuste_pfb_w			:= dados_regra_preco_material_w[i].tx_ajuste_pfb;
		tx_pmc_neut_w			:= dados_regra_preco_material_w[i].tx_ajuste_pmc_neut;
		tx_pmc_neg_w			:= dados_regra_preco_material_w[i].tx_ajuste_pmc_neg;
		tx_pmc_pos_w			:= dados_regra_preco_material_w[i].tx_ajuste_pmc_pos;
		tx_simpro_pfb_w			:= dados_regra_preco_material_w[i].tx_ajuste_simpro_pfb;
		tx_simpro_pmc_w			:= dados_regra_preco_material_w[i].tx_ajuste_simpro_pmc;
		ie_origem_w			:= dados_regra_preco_material_w[i].ie_origem_preco;
		nr_seq_material_preco_w		:= dados_regra_preco_material_w[i].nr_seq_material_preco;
		tx_ajuste_tab_w			:= dados_regra_preco_material_w[i].tx_ajuste_tab_propria;
		ie_tabela_adicional_w		:= dados_regra_preco_material_w[i].ie_tabela_adicional;
		dt_base_fixo_w			:= dados_regra_preco_material_w[i].dt_base_fixo;
		ie_tipo_preco_brasindice_w	:= dados_regra_preco_material_w[i].ie_tipo_preco_brasindice;
		ie_tipo_preco_simpro_w		:= dados_regra_preco_material_w[i].ie_tipo_preco_simpro;
		vl_pfb_neutra_simpro_w		:= dados_regra_preco_material_w[i].vl_pfb_neutra_simpro;
		vl_pfb_positiva_simpro_w	:= dados_regra_preco_material_w[i].vl_pfb_positiva_simpro;
		vl_pfb_negativa_simpro_w	:= dados_regra_preco_material_w[i].vl_pfb_negativa_simpro;
		vl_pfb_nao_aplicavel_simpro_w	:= dados_regra_preco_material_w[i].vl_pfb_nao_aplicavel_simpro;
		vl_pfb_neutra_brasindice_w	:= dados_regra_preco_material_w[i].vl_pfb_neutra_brasindice;
		vl_pfb_positiva_brasindice_w	:= dados_regra_preco_material_w[i].vl_pfb_positiva_brasindice;
		vl_pfb_negativa_brasindice_w	:= dados_regra_preco_material_w[i].vl_pfb_negativa_brasindice;
		ie_tipo_ajuste_pfb_w		:= dados_regra_preco_material_w[i].ie_tipo_ajuste_pfb;
		ie_tipo_preco_tab_adic_w	:= dados_regra_preco_material_w[i].ie_tipo_preco_tab_adic;
		vl_material_inf_w		:= vl_material_w;
		pr_icms_w			:= dados_regra_preco_material_w[i].pr_icms;
		
		if (ie_origem_w IS NOT NULL AND ie_origem_w::text <> '') then
			--Percorre todos os caracteres do valor de dominio selecionado, priorizando a primeira que encontrar valor valido.
			for i in 1 .. length(ie_origem_w) loop

				vl_material_orig_w		:= 0;
				dt_vigencia_orig_w		:= clock_timestamp() - interval '2000 days';
				if (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'T') then
					
					ie_origem_ww	:= 'T';
					dt_base_w	:= regra_simulacao_p.dt_referencia;
					
					select 	substr(max(ds_valor_dominio),1,60)
					into STRICT	ds_origem_w
					from 	valor_dominio_v
					where 	cd_dominio = 7309
					and	vl_dominio = ie_origem_ww;
					
					if (coalesce(ie_tabela_adicional_w,0)	= 1) then
						pls_obter_preco_mat_adicional(	regra_simulacao_preco_mat_p.cd_estabelecimento, regra_simulacao_preco_mat_p.nr_seq_material, dt_base_w,
										tx_ajuste_tab_w, regra_simulacao_preco_mat_p.nr_seq_fornecedor, vl_material_orig_w,
										dt_vigencia_orig_w,dados_regra_preco_material_w[i].cd_versao_tiss);

					elsif (coalesce(ie_tabela_adicional_w,0)	= 2) then
						pls_obter_preco_mat_forn_adic(	regra_simulacao_preco_mat_p.cd_estabelecimento, regra_simulacao_preco_mat_p.nr_seq_material, dt_base_w,
										tx_ajuste_tab_w, regra_simulacao_preco_mat_p.nr_seq_fornecedor, vl_material_orig_w,
										dt_vigencia_orig_w);

					elsif (coalesce(ie_tabela_adicional_w,0)	= 0) then
						pls_obter_preco_tabela(	regra_simulacao_preco_mat_p.cd_estabelecimento, regra_simulacao_preco_mat_p.nr_seq_prestador, regra_simulacao_preco_mat_p.nr_seq_material,
									nr_seq_material_preco_w, dt_base_w, tx_ajuste_tab_w,
									ie_tipo_preco_tab_adic_w, vl_material_orig_w, dt_vigencia_orig_w,
									dados_regra_preco_material_w[i].cd_moeda_calculo);
					elsif (coalesce(ie_tabela_adicional_w,0)	= 3) then	
						pls_obter_preco_mat_A900(regra_simulacao_preco_mat_p.nr_seq_material, regra_simulacao_p.dt_referencia, vl_material_a900_w); -- Edgar 11/11/2013, OS 633529, tratar preco do A900 (TNUMM), mas nao aplicar a regra se retornar ZERO
						if (coalesce(vl_material_a900_w,0) > 0) then
							vl_material_orig_w	:= vl_material_a900_w;
						end if;
					elsif (coalesce(ie_tabela_adicional_w,0)	= 4) then

						
						if (pr_icms_w IS NOT NULL AND pr_icms_w::text <> '') then
						
							vl_perc_icms_w := pr_icms_w;
						else		
							vl_perc_icms_w := pls_obter_vl_icms( null, regra_simulacao_p.dt_referencia, nm_usuario_p, regra_simulacao_preco_mat_p.nr_seq_material);
							
						end if;
						
						pls_obter_icms_mat_A900( regra_simulacao_preco_mat_p.nr_seq_material, vl_perc_icms_w, regra_simulacao_p.dt_referencia, ie_alc_w, vl_material_a900_w); -- OS 874054 - Realizar a valorizacao considerando o percentual de ICMS do A900 cadastrado na Cooperativa Medica. 
						
						if (coalesce(vl_material_a900_w,0) > 0) then
							vl_material_orig_w	:= vl_material_a900_w;
						end if;
					end if;
					
					if 	((coalesce(ie_tabela_adicional_w,0)	= 0) or (ie_origem_w	in ('AT','AST','ATS'))) and (coalesce(vl_material_orig_w,0) = 0) then
						pls_obter_preco_tabela(	regra_simulacao_preco_mat_p.cd_estabelecimento, regra_simulacao_preco_mat_p.nr_seq_prestador, regra_simulacao_preco_mat_p.nr_seq_material,
									nr_seq_material_preco_w, dt_base_w, tx_ajuste_tab_w,
									ie_tipo_preco_tab_adic_w, vl_material_orig_w, dt_vigencia_orig_w,
									dados_regra_preco_material_w[i].cd_moeda_calculo);
					end if;
					dados_regra_preco_material_w[i].vl_material_tabela	:= vl_material_orig_w;
					if (dados_regra_preco_material_w[i](.cd_moeda_calculo IS NOT NULL AND .cd_moeda_calculo::text <> '')) then
						dados_regra_preco_material_w[i].vl_ch_material	:= obter_valor_cotacao_moeda_data(dados_regra_preco_material_w[i].cd_moeda_calculo, regra_simulacao_p.dt_referencia);
					end if;
					vl_material_tabela_w	:= vl_material_orig_w;
					ie_origem_preco_ww	:= 2;


				elsif (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'B') then

					ie_origem_ww	:= 'B';
					
					select 	substr(max(ds_valor_dominio),1,60)
					into STRICT	ds_origem_w
					from 	valor_dominio_v
					where 	cd_dominio = 7309
					and	vl_dominio = ie_origem_ww;
					
					/* Felipe - 26/07/2011 - OS 336183 */

					if (dt_base_fixo_w IS NOT NULL AND dt_base_fixo_w::text <> '') then
						dt_base_w	:= dt_base_fixo_w;
					else
						dt_base_w	:= regra_simulacao_p.dt_referencia;
					end if;

					pls_obter_preco_brasindice(regra_simulacao_preco_mat_p.cd_estabelecimento, regra_simulacao_preco_mat_p.nr_seq_prestador, regra_simulacao_preco_mat_p.nr_seq_material,
							dt_base_w, tx_ajuste_pfb_w, tx_pmc_neut_w,
							tx_pmc_neg_w, tx_pmc_pos_w, ie_tipo_preco_brasindice_w,
							vl_material_orig_w, dt_vigencia_orig_w, cd_tiss_w,
							vl_pfb_neutra_brasindice_w, vl_pfb_positiva_brasindice_w, vl_pfb_negativa_brasindice_w,
							ie_tipo_ajuste_pfb_w, nm_usuario_p);

					vl_material_brasindice_w	:= vl_material_orig_w;
					ie_origem_preco_ww		:= 2;

				elsif (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'S') then

					ie_origem_ww	:= 'S';
					dt_base_w		:= regra_simulacao_p.dt_referencia;
					
					select 	substr(max(ds_valor_dominio),1,60)
					into STRICT	ds_origem_w
					from 	valor_dominio_v
					where 	cd_dominio = 7309
					and	vl_dominio = ie_origem_ww;
					
					pls_calcular_preco_simpro(regra_simulacao_preco_mat_p.cd_estabelecimento, regra_simulacao_preco_mat_p.nr_seq_prestador, regra_simulacao_preco_mat_p.nr_seq_material,
								tx_simpro_pfb_w, tx_simpro_pmc_w, dt_base_w,
								ie_tipo_preco_simpro_w, vl_material_orig_w, dt_vigencia_orig_w,
								vl_pfb_neutra_simpro_w,	vl_pfb_positiva_simpro_w, vl_pfb_negativa_simpro_w,
								vl_pfb_nao_aplicavel_simpro_w, ie_tipo_ajuste_pfb_w, nm_usuario_p,
								'N');

					vl_material_simpro_w	:= vl_material_orig_w;
					ie_origem_preco_ww	:= 4;

				elsif (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'A') then
					ie_origem_ww	:= 'A';
					dt_base_w	:= regra_simulacao_p.dt_referencia;
					
					select 	substr(max(ds_valor_dominio),1,60)
					into STRICT	ds_origem_w
					from 	valor_dominio_v
					where 	cd_dominio = 7309
					and	vl_dominio = ie_origem_ww;
					
					pls_obter_valor_material_espec(null, regra_simulacao_preco_mat_p.nr_seq_material, vl_material_orig_w);
					dados_regra_preco_material_w[i].vl_material_tabela	:= vl_material_orig_w;
					vl_material_w	:= vl_material_orig_w;
					
					if (coalesce(vl_material_w,0) = 0) then
						select 	substr(max(ds_valor_dominio),1,60)
						into STRICT	ds_origem_w
						from 	valor_dominio_v
						where 	cd_dominio = 7309
						and	vl_dominio = ie_origem_ww;
						
						if (coalesce(ie_tabela_adicional_w,0)	= 1) then
							pls_obter_preco_mat_adicional(	regra_simulacao_preco_mat_p.cd_estabelecimento, regra_simulacao_preco_mat_p.nr_seq_material, dt_base_w,
											tx_ajuste_tab_w, regra_simulacao_preco_mat_p.nr_seq_fornecedor, vl_material_orig_w,
											dt_vigencia_orig_w,dados_regra_preco_material_w[i].cd_versao_tiss);

						elsif (coalesce(ie_tabela_adicional_w,0)	= 2) then
							pls_obter_preco_mat_forn_adic(	regra_simulacao_preco_mat_p.cd_estabelecimento, regra_simulacao_preco_mat_p.nr_seq_material, dt_base_w,
											tx_ajuste_tab_w, regra_simulacao_preco_mat_p.nr_seq_fornecedor, vl_material_orig_w,
											dt_vigencia_orig_w);

						elsif (coalesce(ie_tabela_adicional_w,0)	= 0) then
							pls_obter_preco_tabela(	regra_simulacao_preco_mat_p.cd_estabelecimento, regra_simulacao_preco_mat_p.nr_seq_prestador, regra_simulacao_preco_mat_p.nr_seq_material,
										nr_seq_material_preco_w, dt_base_w, tx_ajuste_tab_w,
										ie_tipo_preco_tab_adic_w, vl_material_orig_w, dt_vigencia_orig_w,
										dados_regra_preco_material_w[i].cd_moeda_calculo);
						elsif (coalesce(ie_tabela_adicional_w,0)	= 3) then	
							pls_obter_preco_mat_A900(regra_simulacao_preco_mat_p.nr_seq_material, regra_simulacao_p.dt_referencia, vl_material_a900_w); -- Edgar 11/11/2013, OS 633529, tratar preco do A900 (TNUMM), mas nao aplicar a regra se retornar ZERO
							if (coalesce(vl_material_a900_w,0) > 0) then
								vl_material_orig_w	:= vl_material_a900_w;
							end if;
						elsif (coalesce(ie_tabela_adicional_w,0)	= 4) then

							if (pr_icms_w IS NOT NULL AND pr_icms_w::text <> '') then
						
								vl_perc_icms_w := pr_icms_w;
							else		
								vl_perc_icms_w := pls_obter_vl_icms( null, regra_simulacao_p.dt_referencia, nm_usuario_p, regra_simulacao_preco_mat_p.nr_seq_material);
							end if;
							
								
							pls_obter_icms_mat_A900( regra_simulacao_preco_mat_p.nr_seq_material, vl_perc_icms_w, regra_simulacao_p.dt_referencia, ie_alc_w, vl_material_a900_w); -- OS 874054 - Realizar a valorizacao considerando o percentual de ICMS do A900 cadastrado na Cooperativa Medica. 
							
							if (coalesce(vl_material_a900_w,0) > 0) then
								vl_material_orig_w	:= vl_material_a900_w;
							end if;
						end if;
						
						dados_regra_preco_material_w[i].vl_material_tabela	:= vl_material_orig_w;
						if (dados_regra_preco_material_w[i](.cd_moeda_calculo IS NOT NULL AND .cd_moeda_calculo::text <> '')) then
							dados_regra_preco_material_w[i].vl_ch_material	:= obter_valor_cotacao_moeda_data(dados_regra_preco_material_w[i].cd_moeda_calculo, regra_simulacao_p.dt_referencia);
						end if;
						vl_material_tabela_w	:= vl_material_orig_w;
						ie_origem_preco_ww	:= 2;
					end if;
					dados_regra_preco_material_w[i].vl_material_tabela	:= vl_material_orig_w;
					vl_material_w	:= vl_material_orig_w;

				elsif (vl_material_w = 0) and (ie_origem_w = 'VAO') then
					vl_material_w := vl_apresentado_w;
					
				elsif (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'Z') then
				
					ie_origem_ww := 'Z';
					dt_base_w	:= regra_simulacao_p.dt_referencia;
					
					select 	substr(max(ds_valor_dominio),1,60)
					into STRICT	ds_origem_w
					from 	valor_dominio_v
					where 	cd_dominio = 7309
					and	vl_dominio = ie_origem_ww;
					
					if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
					
						vl_material_w := pls_obter_valor_autorizado(nr_seq_guia_w, regra_simulacao_preco_mat_p.nr_seq_material);
					
					end if;

				elsif (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'I') then
				
					ie_origem_ww := 'I';
					dt_base_w	:= regra_simulacao_p.dt_referencia;
					
					select 	substr(max(ds_valor_dominio),1,60)
					into STRICT	ds_origem_w
					from 	valor_dominio_v
					where 	cd_dominio = 7309
					and	vl_dominio = ie_origem_ww;
					
					if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
					
						vl_material_w := pls_obter_valor_solicmed(nr_seq_guia_w, regra_simulacao_preco_mat_p.nr_seq_material);
					
					end if;
		
				end if;
				
				if (vl_material_orig_w > 0) and
					((vl_material_w = 0) or (dt_vigencia_orig_w	> dt_vigencia_w)) then
					begin
					dt_vigencia_w		:= dt_vigencia_orig_w;
					vl_material_w		:= vl_material_orig_w;
					end;
				end if;
			end loop;
		end if;

		vl_material_tabela_w		:= (vl_material_tabela_w * tx_ajuste_w);
		vl_material_brasindice_w	:= (vl_material_brasindice_w * tx_ajuste_w);
		vl_material_simpro_w		:= (vl_material_simpro_w * tx_ajuste_w);
		vl_material_w 			:= (vl_material_w * tx_ajuste_w);

		if (coalesce(vl_material_inf_w,0) > 0) then
			vl_material_ww			:= vl_material_inf_w;
			vl_material_simpro_ww		:= vl_material_inf_w;
			vl_material_tabela_ww		:= vl_material_inf_w;
			vl_material_brasindice_ww	:= vl_material_inf_w;
			dt_ult_vigencia_w		:= dt_vigencia_w;
			nr_seq_material_preco_ww	:= null;
		else
			vl_material_ww			:= vl_material_w;
			vl_material_simpro_ww		:= vl_material_simpro_w;
			vl_material_tabela_ww		:= vl_material_tabela_w;
			vl_material_brasindice_ww 	:= vl_material_brasindice_w;
			dt_ult_vigencia_w		:= dt_vigencia_w;
			nr_seq_material_preco_ww	:= nr_seq_material_preco_w;
		end if;
		
		-- Apenas insere a regra, se o valor e maior que zero
		if (coalesce(vl_material_ww,0) > 0) then
		
			-- Aplica o deflator / inflator se existir
			vl_material_ww := pls_smp_pck.gerar_valor_deflator(regra_simulacao_p, vl_material_ww);
		
			insert into pls_smp_result_regra(	nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_seq_smp_result_regra,
								vl_simulacao,
								nr_seq_regra_preco_proc,
								nr_seq_regra_preco_mat,
								nr_seq_regra_preco_servico)
			SELECT	nextval('pls_smp_result_regra_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				regra_simulacao_preco_mat_p.nr_seq_item_mat,
				coalesce(vl_material_ww,0),
				null,
				nr_seq_regra_w,
				null
			;
		end if;
		
		commit;									

		
		
		
	end loop; -- fim regras
	
end if; -- Fim se tiver material e regra
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_smp_pck.aplicar_regra_preco_mat ( regra_simulacao_p pls_smp_pck.regra_simulacao, regra_simulacao_preco_mat_p pls_smp_pck.regra_simulacao_preco_mat, dados_regra_preco_mat_p pls_cta_valorizacao_pck.dados_regra_preco_mat_data, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
