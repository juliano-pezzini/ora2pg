-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_smp_pck.retorna_sql_cursor_serv ( regra_simulacao_preco_serv_p pls_smp_pck.regra_simulacao_preco_ser, bind_sql_valor_p INOUT sql_pck.t_dado_bind) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Monta a query que busca as regras de preco para os servicos, e tambem preenche as variaveis de bind
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atencao:
Alteracoes:
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
sql_cursor_w		varchar(32000);


BEGIN
-- monta o SQL do cursor
sql_cursor_w	:=	'select	b.vl_negociado, ' || pls_util_pck.enter_w ||
			'	b.tx_ajuste, ' || pls_util_pck.enter_w || 
			'	b.dt_inicio_vigencia, ' || pls_util_pck.enter_w || 
			'	b.cd_tabela_servico, ' || pls_util_pck.enter_w || 
			'	b.nr_sequencia, ' || pls_util_pck.enter_w || 
			'	b.nr_seq_grupo_contrato, ' || pls_util_pck.enter_w || 
			'	b.nr_seq_grupo_produto, ' || pls_util_pck.enter_w || 
			'	nvl(b.nr_seq_grupo_servico,0) nr_seq_grupo_servico, ' || pls_util_pck.enter_w || 
			'	cd_moeda, ' || pls_util_pck.enter_w || 
			'	b.TX_AJUSTE_PRECO, ' || pls_util_pck.enter_w || 
			'	b.nr_seq_regra_atend_cart, ' || pls_util_pck.enter_w || 
			'	b.cd_especialidade_prest, ' || pls_util_pck.enter_w || 
			'	b.nr_seq_grupo_operadora ' || pls_util_pck.enter_w || 
			'from	pls_regra_preco_servico	b ' || pls_util_pck.enter_w || 
			'where	(b.cd_estabelecimento		= :cd_estabelecimento_p) ' || pls_util_pck.enter_w || 
			'and	((b.cd_procedimento 		is null) or (( b.cd_procedimento = :cd_servico_p) and (b.ie_origem_proced = :ie_origem_proced_p))) ' || pls_util_pck.enter_w || 
			'and	:dt_servico_p	 		>= b.dt_inicio_vigencia  ' || pls_util_pck.enter_w || 
			'and 	(:dt_servico_p 			<= b.dt_fim_vigencia or b.dt_fim_vigencia is null) ' || pls_util_pck.enter_w || 
			'and	((b.cd_grupo_proc 		is null) or ( b.cd_grupo_proc = :cd_grupo_proc_p)) ' || pls_util_pck.enter_w || 
			'and	((b.cd_especialidade 		is null) or (b.cd_especialidade = :cd_especialidade_p)) ' || pls_util_pck.enter_w || 
			'and	((cd_area_procedimento 		is null) or ( cd_area_procedimento = :cd_area_procedimento_p)) ' || pls_util_pck.enter_w || 
			'and	b.ie_situacao			= ''A'' ' || pls_util_pck.enter_w || 
			'and	((b.ie_tipo_tabela		= :ie_tipo_tabela_pc)  ' || pls_util_pck.enter_w || 
			'or	(((b.ie_tipo_tabela		= ''IC'') or  (b.ie_tipo_tabela	= ''I'')) and (:ie_tipo_tabela_pc	= ''I'')))' || pls_util_pck.enter_w||
			'and	((b.ie_tipo_contratacao	 	is null) or (b.ie_tipo_contratacao = nvl(:ie_tipo_contratacao_p,0))) ' || pls_util_pck.enter_w || 
			'and	((b.ie_preco			is null) or (b.ie_preco = :ie_preco_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_plano 		is null) or (b.nr_seq_plano = :nr_seq_plano_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_contrato 		is null) or (b.nr_seq_contrato = :nr_seq_contrato_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_prestador 		is null) or (b.nr_seq_prestador = nvl(:nr_seq_prestador_p,0))) ' || pls_util_pck.enter_w || 
			'and	((b.cd_prestador 		is null) or (b.cd_prestador = nvl(:cd_prestador_p,''0''))) ' || pls_util_pck.enter_w || 
			'and	((b.cd_prestador_prot		is null) or (b.cd_prestador_prot = :cd_prestador_prot_p)) ' || pls_util_pck.enter_w || 
			'and	((b.ie_tipo_vinculo 		is null) or (b.ie_tipo_vinculo = :ie_tipo_vinculo_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_classificacao 	is null) or (b.nr_seq_classificacao = :nr_seq_classificacao_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_tipo_prestador 	is null) or (b.nr_seq_tipo_prestador = nvl(:nr_seq_tipo_prestador_p,''''))) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_tipo_prestador_prot	is null) or (b.nr_seq_tipo_prestador_prot = :nr_seq_tipo_prestador_prot_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_prestador_inter	is null) or (b.nr_seq_prestador_inter = :nr_seq_prest_inter_p)) ' || pls_util_pck.enter_w || 
			'and	(b.nr_seq_grupo_prestador 	is null 	or ' || pls_util_pck.enter_w || 
				'exists	(select	1 ' || pls_util_pck.enter_w || 
					'from	pls_preco_prestador x ' || pls_util_pck.enter_w || 
					'where	x.nr_seq_grupo	= b.nr_seq_grupo_prestador ' || pls_util_pck.enter_w || 
					'and	((x.nr_seq_prestador is null)	  or (x.nr_seq_prestador	= :nr_seq_prestador_p)) ' || pls_util_pck.enter_w || 
					'and	((x.nr_seq_classificacao is null) or (x.nr_seq_classificacao	= :nr_seq_classificacao_p)) ' || pls_util_pck.enter_w || 
					') ' || pls_util_pck.enter_w || 
				') ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_categoria 		is null) or (b.nr_seq_categoria = :nr_seq_categoria_p)) ' || pls_util_pck.enter_w || 
			'and	((b.ie_internado 		is null) or (b.ie_internado = ''N'') or (b.ie_internado = :ie_internado_p)) ' || pls_util_pck.enter_w || 
			'and	((b.ie_tipo_segurado 		is null) or (b.ie_tipo_segurado	= :ie_tipo_segurado_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_grupo_rec 		is null) or (b.nr_seq_grupo_rec	= nvl(:nr_seq_grupo_rec_p,0))) ' || pls_util_pck.enter_w || 
			--'and	((b.ie_tipo_intercambio 	is null) or (b.ie_tipo_intercambio = ''A'') or (b.ie_tipo_intercambio = :ie_tipo_intercambio_p)) ' || pls_util_pck.enter_w ||
			'and	((b.ie_acomodacao		is null) or (b.ie_acomodacao 	= :ie_acomodacao_p) or (b.ie_acomodacao = ''N'')) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_intercambio 		is null) or (b.nr_seq_intercambio = nvl(:nr_seq_intercambio_p,0))) ' || pls_util_pck.enter_w || 
			'and	((b.ie_cooperado		is null) or (b.ie_cooperado	= ''N'' ) or (b.ie_cooperado	= :ie_cooperado_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_cbo_saude 		is null) or (b.nr_seq_cbo_saude = nvl(:nr_seq_cbo_saude_p,0))) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_clinica 		is null) or (b.nr_seq_clinica = :nr_seq_clinica_p)) ' || pls_util_pck.enter_w || 
			'and	((b.ie_pcmso 			is null) or (b.ie_pcmso = ''N'') or (b.ie_pcmso = :ie_pcmso_p)) ' || pls_util_pck.enter_w || 
			--'and	((b.ie_ref_guia_internacao	is null) or (b.ie_ref_guia_internacao	= ''A'') or (b.ie_ref_guia_internacao = :ie_ref_guia_internacao_p)) ' || pls_util_pck.enter_w || 
	--		'and	((b.ie_tipo_guia 		is null) or (b.ie_tipo_guia 	= :ie_tipo_guia_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_grupo_intercambio 	is null) or (b.nr_seq_grupo_intercambio = nvl(:nr_seq_grupo_intercambio_p,0))) ' || pls_util_pck.enter_w || 
			'and	((b.ie_carater_internacao 	is null) or (nvl(b.ie_carater_internacao,''X'')	 = nvl(:ie_carater_internacao_p,''X''))) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_tipo_atendimento 	is null) or (b.nr_seq_tipo_atendimento = :nr_seq_tipo_atendimento_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_tipo_atend_princ 	is null) or (b.nr_seq_tipo_atend_princ = :nr_seq_tipo_atend_princ_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_tipo_acomodacao 	is null) or (b.nr_seq_tipo_acomodacao = :nr_seq_tipo_acomodacao_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_congenere		is null) or (b.nr_seq_congenere		= :nr_seq_congenere_p)) ' || pls_util_pck.enter_w || 
			'and	((b.nr_seq_congenere_prot 	is null) or (b.nr_seq_congenere_prot = :nr_seq_congenere_prot_p)) ' || pls_util_pck.enter_w || 
			'and	((b.ie_origem_protocolo		is null) or (b.ie_origem_protocolo	= :ie_origem_protocolo_p)) ' || pls_util_pck.enter_w || 
			'and	((b.cd_versao_tiss		is null) or (b.cd_versao_tiss		= :cd_versao_tiss_p)) ' || pls_util_pck.enter_w || 
			'and	((b.ie_atend_pcmso		is null) or (b.ie_atend_pcmso = ''A'') or (b.ie_atend_pcmso	= :ie_atend_pcmso_p)) ' || pls_util_pck.enter_w;

if (pls_util_cta_pck.usar_novo_agrup = 'S') then											
	sql_cursor_w	:= sql_cursor_w ||	'and	((b.nr_seq_grupo_servico	is null) or (exists	(select	1 ' || pls_util_pck.enter_w ||
												'from	pls_grupo_servico_tm grupo ' || pls_util_pck.enter_w || 
												'where	grupo.nr_seq_grupo_servico = b.nr_seq_grupo_servico ' || pls_util_pck.enter_w || 
												'and	grupo.ie_origem_proced = :ie_origem_proced_p ' || pls_util_pck.enter_w || 
												'and	grupo.cd_procedimento = :cd_servico_p))) ' || pls_util_pck.enter_w;
else
	sql_cursor_w	:= sql_cursor_w ||	'and	((b.nr_seq_grupo_servico	is null) or (exists	(select	1 ' || pls_util_pck.enter_w ||
												'from	table(pls_grupos_pck.obter_procs_grupo_servico(b.nr_seq_grupo_servico, :ie_origem_proced_p,:cd_servico_p)) grupo))) ' || pls_util_pck.enter_w;
end if;											

sql_cursor_w	:= sql_cursor_w || 	'and	((b.cd_prestador_solic 		is null) or (b.cd_prestador_solic =  :cd_prestador_solic_p)) ' || pls_util_pck.enter_w ||
					'and     (((b.ie_acomodacao_autorizada 	is null) or (b.ie_acomodacao_autorizada = ''N'')) or (b.ie_acomodacao_autorizada = :ie_acomodacao_autorizada_p)) ' || pls_util_pck.enter_w ||
					'and	((b.ie_tipo_atendimento 	= ''A'') or (b.ie_tipo_atendimento = :ie_tipo_atendimento_p))' || pls_util_pck.enter_w;

	
-- Realiza o bind dos parametros
bind_sql_valor_p := sql_pck.bind_variable(	':cd_estabelecimento_p', regra_simulacao_preco_serv_p.cd_estabelecimento, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':cd_servico_p', regra_simulacao_preco_serv_p.cd_servico, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_origem_proced_p', regra_simulacao_preco_serv_p.ie_origem_proced, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':dt_servico_p', regra_simulacao_preco_serv_p.dt_servico, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':cd_grupo_proc_p', regra_simulacao_preco_serv_p.cd_grupo_proc, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':cd_especialidade_p', regra_simulacao_preco_serv_p.cd_especialidade, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':cd_area_procedimento_p', regra_simulacao_preco_serv_p.cd_area_procedimento, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_tipo_tabela_pc', regra_simulacao_preco_serv_p.ie_tipo_tabela, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_tipo_contratacao_p', regra_simulacao_preco_serv_p.ie_tipo_contratacao, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_preco_p', regra_simulacao_preco_serv_p.ie_preco, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_plano_p', regra_simulacao_preco_serv_p.nr_seq_plano, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_contrato_p', regra_simulacao_preco_serv_p.nr_seq_contrato, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_prestador_p', regra_simulacao_preco_serv_p.nr_seq_prestador, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':cd_prestador_p', regra_simulacao_preco_serv_p.cd_prestador, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':cd_prestador_prot_p', regra_simulacao_preco_serv_p.cd_prestador_prot, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_tipo_vinculo_p', regra_simulacao_preco_serv_p.ie_tipo_vinculo, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_classificacao_p', regra_simulacao_preco_serv_p.nr_seq_classificacao, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_tipo_prestador_p', regra_simulacao_preco_serv_p.nr_seq_tipo_prestador, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_tipo_prestador_prot_p', regra_simulacao_preco_serv_p.nr_seq_tipo_prestador_prot, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_prest_inter_p', regra_simulacao_preco_serv_p.nr_seq_prest_inter, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_categoria_p', regra_simulacao_preco_serv_p.nr_seq_categoria, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_internado_p', regra_simulacao_preco_serv_p.ie_internado, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_tipo_segurado_p', regra_simulacao_preco_serv_p.ie_tipo_segurado, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_grupo_rec_p', regra_simulacao_preco_serv_p.nr_seq_grupo_rec, bind_sql_valor_p);
--sql_pck.bind_variable(	':ie_tipo_intercambio_p',	regra_simulacao_preco_serv_p.ie_tipo_intercambio, 		bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_acomodacao_p', regra_simulacao_preco_serv_p.ie_acomodacao, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_intercambio_p', regra_simulacao_preco_serv_p.nr_seq_intercambio, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_cooperado_p', regra_simulacao_preco_serv_p.ie_cooperado, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_cbo_saude_p', regra_simulacao_preco_serv_p.nr_seq_cbo_saude, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_clinica_p', regra_simulacao_preco_serv_p.nr_seq_clinica, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_pcmso_p', regra_simulacao_preco_serv_p.ie_pcmso, bind_sql_valor_p);
--sql_pck.bind_variable(	':ie_ref_guia_internacao_p',	regra_simulacao_preco_serv_p.ie_ref_guia_internacao, 		bind_sql_valor_p);
--sql_pck.bind_variable(	':ie_tipo_guia_p',		regra_simulacao_preco_serv_p.ie_tipo_guia, 			bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_grupo_intercambio_p', regra_simulacao_preco_serv_p.nr_seq_grupo_intercambio, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_carater_internacao_p', regra_simulacao_preco_serv_p.ie_carater_internacao, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_tipo_atendimento_p', regra_simulacao_preco_serv_p.nr_seq_tipo_atendimento, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_tipo_atend_princ_p', regra_simulacao_preco_serv_p.nr_seq_tipo_atend_princ, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_tipo_acomodacao_p', regra_simulacao_preco_serv_p.nr_seq_tipo_acomodacao, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_congenere_p', regra_simulacao_preco_serv_p.nr_seq_congenere, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':nr_seq_congenere_prot_p', regra_simulacao_preco_serv_p.nr_seq_congenere_prot, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_origem_protocolo_p', regra_simulacao_preco_serv_p.ie_origem_protocolo, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':cd_versao_tiss_p', regra_simulacao_preco_serv_p.cd_versao_tiss, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_atend_pcmso_p', regra_simulacao_preco_serv_p.ie_atend_pcmso, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':cd_prestador_solic_p', regra_simulacao_preco_serv_p.cd_prestador_solic, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_acomodacao_autorizada_p', regra_simulacao_preco_serv_p.ie_acomodacao_autorizada, bind_sql_valor_p);
bind_sql_valor_p := sql_pck.bind_variable(	':ie_tipo_atendimento_p', regra_simulacao_preco_serv_p.ie_tipo_atendimento, bind_sql_valor_p);

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_smp_pck.retorna_sql_cursor_serv ( regra_simulacao_preco_serv_p pls_smp_pck.regra_simulacao_preco_ser, bind_sql_valor_p INOUT sql_pck.t_dado_bind) FROM PUBLIC;
