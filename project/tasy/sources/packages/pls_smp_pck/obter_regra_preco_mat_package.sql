-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_smp_pck.obter_regra_preco_mat ( recuperar_regra_preco_mat_p pls_smp_pck.regra_simulacao_preco_mat, dados_regra_preco_mat_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_mat_data) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Obtem  as regras de precos para cada material, retornando na variavel out
	
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atencao:
Alteracoes:
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_congenere_prot_w		pls_protocolo_conta.nr_seq_congenere%type;
ie_restrito_w			brasindice_preco.ie_restrito%type;
cd_especialidade_prest_w	varchar(4000);
tx_ajuste_w			double precision	:= 0;
tx_ajuste_ww			double precision	:= 0;
vl_negociado_w			double precision	:= 0;
vl_negociado_ww			double precision	:= 0;
tx_ajuste_pfb_w			double precision	:= 0;
tx_ajuste_pmc_neut_w		double precision	:= 0;
tx_ajuste_pmc_neg_w		double precision	:= 0;
tx_ajuste_pmc_pos_w		double precision	:= 0;
tx_ajuste_simpro_pfb_w		double precision	:= 0;
tx_ajuste_simpro_pmc_w		double precision	:= 0;
tx_ajuste_pfb_ww		double precision	:= 0;
tx_ajuste_pmc_neut_ww		double precision	:= 0;
tx_ajuste_pmc_neg_ww		double precision	:= 0;
tx_ajuste_pmc_pos_ww		double precision	:= 0;
tx_ajuste_simpro_pfb_ww		double precision	:= 0;
tx_ajuste_simpro_pmc_ww		double precision	:= 0;
ie_origem_preco_w		varchar(5);
ie_origem_preco_ww		varchar(5);
nr_seq_regra_w			bigint;
nr_seq_material_preco_w		bigint;
tx_ajuste_tab_propria_w		double precision;
tx_ajuste_tab_propria_ww	double precision;
nr_seq_grupo_produto_w		bigint;
nr_seq_grupo_contrato_w		bigint;
nr_seq_regra_ww			bigint;
ie_grupo_produto_w		varchar(1)	:= 'S';
ie_grupo_contrato_w		varchar(1)	:= 'S';
ie_grupo_servico_w		varchar(1)	:= 'S';
ie_grupo_material_w		varchar(1)	:= 'S';
ie_tabela_adicional_w		bigint;
ie_tabela_adicional_ww		bigint;
dt_base_fixo_w			timestamp;
dt_base_fixo_ww			timestamp;
nr_seq_grupo_uf_w               bigint;
ie_grupo_uf_w                   varchar(10);
nr_seq_grupo_material_w		bigint;
ie_mat_autorizacao_esp_w	varchar(10);
ie_estrut_mat_w			varchar(1);
nr_seq_estrut_regra_w		bigint;
nr_seq_material_preco_ww	bigint;
nr_seq_congenere_prot_w		bigint;
ie_tipo_preco_brasindice_ww	varchar(3);
ie_tipo_preco_simpro_ww		varchar(1);
ie_tipo_preco_brasindice_w	varchar(3);
ie_tipo_preco_simpro_w		varchar(1);
ie_grupo_operadora_w		varchar(1);
nr_seq_regra_grupo_oper_w	bigint;
vl_pfb_neutra_simpro_w		double precision	:= 0;
vl_pfb_positiva_simpro_w	double precision	:= 0;
vl_pfb_negativa_simpro_w	double precision	:= 0;
vl_pfb_nao_aplicavel_simpro_w	double precision	:= 0;
VL_PFB_NEUTRA_BRASINDICE_w	double precision	:= 0;
vl_pfb_positiva_brasindice_w	double precision	:= 0;
vl_pfb_negativa_brasindice_w	double precision	:= 0;
ie_tipo_ajuste_pfb_w		varchar(2);
vl_pfb_neutra_simpro_ww		double precision	:= 0;
vl_pfb_positiva_simpro_ww	double precision	:= 0;
vl_pfb_negativa_simpro_ww	double precision	:= 0;
vl_pfb_nao_aplicavel_simpro_ww	double precision	:= 0;
VL_PFB_NEUTRA_BRASINDICE_ww	double precision	:= 0;
vl_pfb_positiva_brasindice_ww	double precision	:= 0;
vl_pfb_negativa_brasindice_ww	double precision	:= 0;
ie_tipo_ajuste_pfb_ww		varchar(2);
nr_seq_excecao_preco_mat_w	bigint;
qt_excecao_preco_mat_w		bigint;
ie_carteira_valida_w		varchar(1);
ie_especialidade_prest_w	varchar(1);
nr_seq_mat_tiss_w		pls_material.nr_sequencia%type;
ie_tipo_preco_tab_adic_w	pls_regra_preco_mat.ie_tipo_preco_tab_adic%type;
cd_versao_tiss_w		pls_conta_mat_v.cd_versao_tiss%type;
i				integer;
pr_icms_w			pls_regra_preco_mat.pr_icms%type;



c01 CURSOR(	ie_restringe_estab_pc		recuperar_regra_preco_mat_p.ie_restringe_estab%type,
		cd_estabelecimento_pc		recuperar_regra_preco_mat_p.cd_estabelecimento%type,
		nr_seq_prestador_pc		recuperar_regra_preco_mat_p.nr_seq_prestador%type,
		cd_prestador_pc			recuperar_regra_preco_mat_p.cd_prestador%type,
		ie_tipo_vinculo_pc		recuperar_regra_preco_mat_p.ie_tipo_vinculo%type,
		nr_seq_classificacao_pc		recuperar_regra_preco_mat_p.nr_seq_classificacao_prest%type,
		nr_seq_tipo_prestador_pc	recuperar_regra_preco_mat_p.nr_seq_tipo_prestador%type,
		dt_vigencia_pc			recuperar_regra_preco_mat_p.dt_vigencia%type,
		ie_tipo_tabela_pc		recuperar_regra_preco_mat_p.ie_tipo_tabela%type,
		ie_tipo_despesa_pc		recuperar_regra_preco_mat_p.ie_tipo_despesa%type,
		nr_seq_outorgante_pc		recuperar_regra_preco_mat_p.nr_seq_outorgante%type,
		ie_tipo_segurado_pc		recuperar_regra_preco_mat_p.ie_tipo_segurado%type,
		ie_preco_plano_pc		recuperar_regra_preco_mat_p.ie_preco%type,
		ie_tipo_contratacao_pc		recuperar_regra_preco_mat_p.ie_tipo_contratacao%type,
		nr_seq_plano_pc			recuperar_regra_preco_mat_p.nr_seq_plano%type,
		nr_seq_material_pc		recuperar_regra_preco_mat_p.nr_seq_material%type,
		nr_seq_contrato_pc		recuperar_regra_preco_mat_p.nr_seq_contrato%type,
		nr_seq_categoria_pc		recuperar_regra_preco_mat_p.nr_seq_categoria%type,
		cd_convenio_pc			recuperar_regra_preco_mat_p.cd_convenio%type,
		cd_categoria_pc			recuperar_regra_preco_mat_p.cd_categoria%type,
		nr_seq_contrato_intercambio_pc	recuperar_regra_preco_mat_p.nr_seq_contrato_intercambio%type,
		ie_pcmso_pc			recuperar_regra_preco_mat_p.ie_pcmso%type,
		nr_seq_clinica_pc		recuperar_regra_preco_mat_p.nr_seq_clinica%type,
		nr_seq_tipo_uso_pc		recuperar_regra_preco_mat_p.nr_seq_tipo_uso%type,
		ie_tipo_guia_pc			recuperar_regra_preco_mat_p.ie_tipo_guia%type,
		ie_generico_pc			text,
		ie_tipo_intercambio_pc		recuperar_regra_preco_mat_p.ie_tipo_intercambio%type,
		ie_internado_pc			recuperar_regra_preco_mat_p.ie_internado%type,
		nr_seq_congenere_pc		recuperar_regra_preco_mat_p.nr_seq_congenere%type,
		nr_seq_congenere_prot_pc	pls_protocolo_conta.nr_seq_congenere%type,
		sg_uf_operadora_intercambio_pc	recuperar_regra_preco_mat_p.sg_uf_operadora_intercambio%type,
		nr_seq_tipo_acomodacao_pc	recuperar_regra_preco_mat_p.nr_seq_tipo_acomodacao%type,
		nr_seq_tipo_atendimento_pc	recuperar_regra_preco_mat_p.nr_seq_tipo_atendimento%type,
		ie_atend_pcmso_pc		recuperar_regra_preco_mat_p.ie_atend_pcmso%type,
		cd_prestador_solic_pc		pls_prestador.cd_prestador%type,
		ie_restrito_pc			brasindice_preco.ie_restrito%type,
		ie_tipo_atendimento_pc		pls_regra_preco_mat.ie_tipo_atendimento%type) FOR
SELECT	
	a.nr_sequencia,
	a.dt_inicio_vigencia,
	a.dt_fim_vigencia,
	a.tx_ajuste,
	a.tx_ajuste_pfb,
	a.tx_ajuste_pmc_neut,
	a.tx_ajuste_pmc_neg,
	a.tx_ajuste_pmc_pos,
	a.tx_ajuste_simpro_pfb,
	a.tx_ajuste_simpro_pmc,
	a.ie_origem_preco,
	coalesce(a.vl_negociado,0) vl_negociado,
	a.nr_seq_material_preco,
	a.tx_ajuste_tab_propria,
	a.nr_seq_grupo_produto,
	a.nr_seq_grupo_contrato,
	a.ie_tabela_adicional,
	a.dt_base_fixo,
	a.nr_seq_grupo_uf,
	a.ie_mat_autorizacao_esp,
	a.nr_seq_grupo_material,
	a.nr_seq_estrutura_mat,
	a.ie_tipo_preco_simpro,
	a.ie_tipo_preco_brasindice,
	a.nr_seq_grupo_operadora,
	a.vl_pfb_neutra_simpro,
	a.vl_pfb_positiva_simpro,
	a.vl_pfb_negativa_simpro,
	a.vl_pfb_nao_aplicavel_simpro,
	a.vl_pfb_neutra_brasindice,
	a.vl_pfb_positiva_brasindice,
	a.vl_pfb_negativa_brasindice,
	a.ie_tipo_ajuste_pfb,
	a.nr_seq_regra_atend_cart,
	a.cd_especialidade_prest,
	a.ie_tipo_preco_tab_adic,
	a.cd_versao_tiss,
	a.ie_acomodacao_autorizada,
	a.pr_icms
from	pls_regra_preco_mat a
where	((ie_restringe_estab_pc	= 'N')	or (coalesce(ie_restringe_estab_pc::text, '') = '')	or (a.cd_estabelecimento = cd_estabelecimento_pc))
--Prestador executor
and	((coalesce(a.nr_seq_prestador::text, '') = '') 	or (a.nr_seq_prestador = nr_seq_prestador_pc))
and	((coalesce(a.cd_prestador::text, '') = '') 	or (a.cd_prestador = cd_prestador_pc))
and	((coalesce(a.ie_tipo_vinculo::text, '') = '')	or (a.ie_tipo_vinculo = ie_tipo_vinculo_pc))
and	((coalesce(a.nr_seq_classificacao::text, '') = '') 	or (a.nr_seq_classificacao = nr_seq_classificacao_pc))
and	((coalesce(a.nr_seq_tipo_prestador::text, '') = '')or (a.nr_seq_tipo_prestador = nr_seq_tipo_prestador_pc))
and	(coalesce(a.nr_seq_grupo_prestador::text, '') = '' 	or
	exists	(select	1
		from	pls_preco_prestador x
		where	x.nr_seq_grupo	= a.nr_seq_grupo_prestador
		and	((coalesce(x.nr_seq_prestador::text, '') = '')	or (x.nr_seq_prestador		= nr_seq_prestador_pc))
		and	((coalesce(x.nr_seq_classificacao::text, '') = '') or (x.nr_seq_classificacao	= nr_seq_classificacao_pc))
		)
	)

and	a.ie_situacao				= 'A'
and	dt_vigencia_pc >= a.dt_inicio_vigencia
and	((coalesce(a.dt_fim_vigencia::text, '') = '') 	or (dt_vigencia_pc <= a.dt_fim_vigencia))
and	((a.ie_tipo_tabela	=  ie_tipo_tabela_pc)  
or	(((a.ie_tipo_tabela	= 'IC') 	or (a.ie_tipo_tabela	= 'I')) and (ie_tipo_tabela_pc	= 'I')))
and	((coalesce(a.ie_tipo_despesa::text, '') = '') 	or (a.ie_tipo_despesa = ie_tipo_despesa_pc))
and	((coalesce(a.nr_seq_outorgante::text, '') = '') 	or (a.nr_seq_outorgante = nr_seq_outorgante_pc))
and	((coalesce(a.ie_tipo_segurado::text, '') = '') 	or (a.ie_tipo_segurado = ie_tipo_segurado_pc))
and	((coalesce(a.ie_preco::text, '') = '') 	or (a.ie_preco = ie_preco_plano_pc))
and	((coalesce(a.ie_tipo_contratacao::text, '') = '') 	or (a.ie_tipo_contratacao = ie_tipo_contratacao_pc))
and	((coalesce(a.nr_seq_plano::text, '') = '') 	or (a.nr_seq_plano = nr_seq_plano_pc))
and	((coalesce(a.nr_seq_material::text, '') = '') 	or (a.nr_seq_material = nr_seq_material_pc))
and	((coalesce(nr_seq_contrato::text, '') = '') 	or (nr_seq_contrato	= nr_seq_contrato_pc))
and	((coalesce(a.nr_seq_categoria::text, '') = '') 	or (a.nr_seq_categoria = nr_seq_categoria_pc))
and	((coalesce(a.cd_convenio::text, '') = '') 	or (a.cd_convenio = cd_convenio_pc))
and	((coalesce(a.cd_categoria::text, '') = '') 	or (a.cd_categoria = cd_categoria_pc))
and	((coalesce(a.nr_seq_intercambio::text, '') = '') 	or (a.nr_seq_intercambio = nr_seq_contrato_intercambio_pc))
and	((coalesce(a.ie_pcmso::text, '') = '') 	or (a.ie_pcmso = 'N') or (a.ie_pcmso = ie_pcmso_pc))
and	((coalesce(a.nr_seq_clinica::text, '') = '')	or (a.nr_seq_clinica 	= nr_seq_clinica_pc))
and	((coalesce(a.nr_seq_tipo_uso::text, '') = '') 	or (a.nr_seq_tipo_uso 	= nr_seq_tipo_uso_pc))
--and	((a.ie_tipo_guia 	is null) 	or (a.ie_tipo_guia 	= ie_tipo_guia_pc))
and     ((coalesce(a.ie_generico_unimed::text, '') = '')	or (a.ie_generico_unimed = ie_generico_pc))
--and	((a.ie_tipo_intercambio is null)	or (a.ie_tipo_intercambio 	= ie_tipo_intercambio_pc) or(a.ie_tipo_intercambio = 'A'))
and	((coalesce(a.ie_internado::text, '') = '') 	or (a.ie_internado 		= ie_internado_pc) or (a.ie_internado 	= 'N' ))
and	((coalesce(a.nr_seq_congenere::text, '') = '')	or (a.nr_seq_congenere		= nr_seq_congenere_pc))
and	((coalesce(a.nr_seq_congenere_prot::text, '') = '')or (a.nr_seq_congenere_prot 	= nr_seq_congenere_prot_pc))	
	and	((coalesce(a.sg_uf_operadora_intercambio::text, '') = '')or (a.sg_uf_operadora_intercambio	= sg_uf_operadora_intercambio_pc))
and	((coalesce(a.nr_seq_tipo_acomodacao::text, '') = '')or (a.nr_seq_tipo_acomodacao = nr_seq_tipo_acomodacao_pc))
and	((coalesce(a.nr_seq_tipo_atendimento::text, '') = '')or (a.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_pc))
and	((coalesce(a.ie_atend_pcmso::text, '') = '')or (a.ie_atend_pcmso = 'A') or (a.ie_atend_pcmso		= ie_atend_pcmso_pc))
and	((coalesce(a.cd_prestador_solic::text, '') = '')or (a.cd_prestador_solic	= cd_prestador_solic_pc))
and	((coalesce(a.ie_restringe_hosp::text, '') = '')or (a.ie_restringe_hosp		= 'N') or (a.ie_restringe_hosp	= ie_restrito_pc))
and	((a.ie_tipo_atendimento		= 'A') or (a.ie_tipo_atendimento = ie_tipo_atendimento_pc));	

BEGIN

-- Limpa o output
dados_regra_preco_mat_p.delete;

-- Somente executa se tiver material informado na regra
if (recuperar_regra_preco_mat_p.nr_seq_material IS NOT NULL AND recuperar_regra_preco_mat_p.nr_seq_material::text <> '') then

	-- Levanta as informacoes finais necessarias para calcular o valor de cada regra
	select	max(ie_restrito)
	into STRICT	ie_restrito_w
	from	brasindice_preco 	
	where	cd_tiss			= recuperar_regra_preco_mat_p.cd_tiss_brasindice
	and	dt_inicio_vigencia 	=
			(SELECT max(a.dt_inicio_vigencia)
			from	brasindice_preco a
			where	a.cd_tiss		= recuperar_regra_preco_mat_p.cd_tiss_brasindice
			and	a.dt_inicio_vigencia 	<= coalesce(recuperar_regra_preco_mat_p.dt_vigencia,clock_timestamp()));
			
	-- Epecialidade
	begin
		cd_especialidade_prest_w	:= substr(pls_obter_cod_espec_prest(recuperar_regra_preco_mat_p.nr_seq_prestador, null)||',',1,4000);
	exception
		when others then
		cd_especialidade_prest_w	:= null;
	end;
	
	-- Valores padroes
	vl_negociado_w			:= 0;
	tx_ajuste_pfb_w			:= 0;
	tx_ajuste_pmc_neut_w		:= 0;
	tx_ajuste_pmc_neg_w		:= 0;
	tx_ajuste_pmc_pos_w		:= 0;
	tx_ajuste_simpro_pfb_w		:= 0;
	tx_ajuste_simpro_pmc_w		:= 0;
	nr_seq_material_preco_w		:= 0;
	tx_ajuste_tab_propria_w		:= 0;
	vl_pfb_neutra_simpro_w		:= 0;
	vl_pfb_positiva_simpro_w	:= 0;
	vl_pfb_negativa_simpro_w	:= 0;
	vl_pfb_nao_aplicavel_simpro_w	:= 0;
	vl_pfb_neutra_brasindice_w	:= 0;
	vl_pfb_positiva_brasindice_w	:= 0;
	vl_pfb_negativa_brasindice_w	:= 0;
	ie_tipo_ajuste_pfb_w		:= 'U';
	i				:= 0;
	pr_icms_w			:= null;

	-- busca as regras condizentes
	for r_c01_w in c01(	recuperar_regra_preco_mat_p.ie_restringe_estab,
				recuperar_regra_preco_mat_p.cd_estabelecimento,
				recuperar_regra_preco_mat_p.nr_seq_prestador,
				recuperar_regra_preco_mat_p.cd_prestador,
				recuperar_regra_preco_mat_p.ie_tipo_vinculo,
				recuperar_regra_preco_mat_p.nr_seq_classificacao_prest,
				recuperar_regra_preco_mat_p.nr_seq_tipo_prestador,
				recuperar_regra_preco_mat_p.dt_vigencia,
				recuperar_regra_preco_mat_p.ie_tipo_tabela,
				recuperar_regra_preco_mat_p.ie_tipo_despesa,
				recuperar_regra_preco_mat_p.nr_seq_outorgante,
				recuperar_regra_preco_mat_p.ie_tipo_segurado,
				recuperar_regra_preco_mat_p.ie_preco,
				recuperar_regra_preco_mat_p.ie_tipo_contratacao,
				recuperar_regra_preco_mat_p.nr_seq_plano,
				recuperar_regra_preco_mat_p.nr_seq_material,
				recuperar_regra_preco_mat_p.nr_seq_contrato,
				recuperar_regra_preco_mat_p.nr_seq_categoria,
				recuperar_regra_preco_mat_p.cd_convenio,
				recuperar_regra_preco_mat_p.cd_categoria,
				recuperar_regra_preco_mat_p.nr_seq_contrato_intercambio,
				recuperar_regra_preco_mat_p.ie_pcmso,
				recuperar_regra_preco_mat_p.nr_seq_clinica,
				recuperar_regra_preco_mat_p.nr_seq_tipo_uso,
				recuperar_regra_preco_mat_p.ie_tipo_guia,
				'N',
				recuperar_regra_preco_mat_p.ie_tipo_intercambio,
				recuperar_regra_preco_mat_p.ie_internado,
				recuperar_regra_preco_mat_p.nr_seq_congenere,
				null,
				recuperar_regra_preco_mat_p.sg_uf_operadora_intercambio,
				recuperar_regra_preco_mat_p.nr_seq_tipo_acomodacao,
				recuperar_regra_preco_mat_p.nr_seq_tipo_atendimento,
				recuperar_regra_preco_mat_p.ie_atend_pcmso,
				null,
				ie_restrito_w,
				recuperar_regra_preco_mat_p.ie_tipo_atendimento) loop
		
		nr_seq_regra_ww			:= r_c01_w.nr_sequencia;
		tx_ajuste_ww			:= r_c01_w.tx_ajuste;
		tx_ajuste_pfb_ww		:= r_c01_w.tx_ajuste_pfb;
		tx_ajuste_pmc_neut_ww		:= r_c01_w.tx_ajuste_pmc_neut;
		tx_ajuste_pmc_neg_ww		:= r_c01_w.tx_ajuste_pmc_neg;
		tx_ajuste_pmc_pos_ww		:= r_c01_w.tx_ajuste_pmc_pos;
		tx_ajuste_simpro_pfb_ww		:= r_c01_w.tx_ajuste_simpro_pfb;
		tx_ajuste_simpro_pmc_ww		:= r_c01_w.tx_ajuste_simpro_pmc;
		ie_origem_preco_ww		:= r_c01_w.ie_origem_preco;
		vl_negociado_ww			:= r_c01_w.vl_negociado;
		nr_seq_material_preco_ww	:= r_c01_w.nr_seq_material_preco;
		tx_ajuste_tab_propria_ww	:= r_c01_w.tx_ajuste_tab_propria;
		nr_seq_grupo_produto_w		:= r_c01_w.nr_seq_grupo_produto;
		nr_seq_grupo_contrato_w		:= r_c01_w.nr_seq_grupo_contrato;
		ie_tabela_adicional_ww		:= r_c01_w.ie_tabela_adicional;
		dt_base_fixo_ww			:= r_c01_w.dt_base_fixo;
		nr_seq_grupo_uf_w		:= r_c01_w.nr_seq_grupo_uf;
		ie_mat_autorizacao_esp_w	:= r_c01_w.ie_mat_autorizacao_esp;
		nr_seq_grupo_material_w		:= r_c01_w.nr_seq_grupo_material;
		nr_seq_estrut_regra_w		:= r_c01_w.nr_seq_estrutura_mat;
		ie_tipo_preco_simpro_ww		:= r_c01_w.ie_tipo_preco_simpro;
		ie_tipo_preco_brasindice_ww	:= r_c01_w.ie_tipo_preco_brasindice;
		nr_seq_regra_grupo_oper_w	:= r_c01_w.nr_seq_grupo_operadora;
		vl_pfb_neutra_simpro_ww		:= r_c01_w.vl_pfb_neutra_simpro;
		vl_pfb_positiva_simpro_ww	:= r_c01_w.vl_pfb_positiva_simpro;
		vl_pfb_negativa_simpro_ww	:= r_c01_w.vl_pfb_negativa_simpro;
		vl_pfb_nao_aplicavel_simpro_ww	:= r_c01_w.vl_pfb_nao_aplicavel_simpro;
		VL_PFB_NEUTRA_BRASINDICE_ww	:= r_c01_w.VL_PFB_NEUTRA_BRASINDICE;
		vl_pfb_positiva_brasindice_ww	:= r_c01_w.vl_pfb_positiva_brasindice;
		vl_pfb_negativa_brasindice_ww	:= r_c01_w.vl_pfb_negativa_brasindice;
		ie_tipo_ajuste_pfb_ww		:= r_c01_w.ie_tipo_ajuste_pfb;
		pr_icms_w			:= r_c01_w.pr_icms;
				
		ie_grupo_produto_w		:= 'S';
		ie_grupo_contrato_w		:= 'S';
		ie_grupo_servico_w		:= 'S';
		ie_grupo_uf_w           	:= 'S';
		ie_grupo_material_w		:= 'S';
		ie_carteira_valida_w		:= 'S';
		ie_estrut_mat_w			:= 'S';
		ie_grupo_operadora_w		:= 'S';
		ie_especialidade_prest_w	:= 'S';
		nr_seq_excecao_preco_mat_w	:= 0;
		
		/* Grupo de contratos */

		if (coalesce(nr_seq_grupo_contrato_w,0) > 0) and
			((coalesce(recuperar_regra_preco_mat_p.nr_seq_contrato,0) > 0)	or (coalesce(recuperar_regra_preco_mat_p.nr_seq_contrato_intercambio,0) > 0)) then
			ie_grupo_contrato_w	:= pls_se_grupo_preco_contrato(nr_seq_grupo_contrato_w, recuperar_regra_preco_mat_p.nr_seq_contrato, recuperar_regra_preco_mat_p.nr_seq_contrato_intercambio);
		elsif (coalesce(nr_seq_grupo_contrato_w,0) > 0) then
			ie_grupo_contrato_w	:= 'N';
		end if;	
					
		if (nr_seq_estrut_regra_w IS NOT NULL AND nr_seq_estrut_regra_w::text <> '') and (ie_grupo_contrato_w 	= 'S') then
			ie_estrut_mat_w	:= pls_obter_se_mat_estrutura(recuperar_regra_preco_mat_p.nr_seq_material, nr_seq_estrut_regra_w);
		end if;
		
		nr_seq_mat_tiss_w := null;
		if (r_c01_w.cd_versao_tiss IS NOT NULL AND r_c01_w.cd_versao_tiss::text <> '') then
			pls_obter_mat_tiss_vigente( nr_seq_mat_tiss_w, clock_timestamp(), recuperar_regra_preco_mat_p.nr_seq_material, 'S', 'N', r_c01_w.cd_versao_tiss);
		end if;
		
		if (ie_estrut_mat_w 	= 'S') and (ie_grupo_contrato_w 	= 'S') and
			((coalesce(r_c01_w.cd_versao_tiss::text, '') = '') or (nr_seq_mat_tiss_w IS NOT NULL AND nr_seq_mat_tiss_w::text <> '')) then
			if (coalesce(nr_seq_grupo_uf_w,0) > 0) then
				ie_grupo_uf_w	:= pls_obter_se_grupo_uf(nr_seq_grupo_uf_w, recuperar_regra_preco_mat_p.sg_uf_operadora_intercambio);
			end if;
						
			if (ie_grupo_uf_w = 'S') then

				/* Grupo de produtos */

				if (coalesce(nr_seq_grupo_produto_w,0) > 0) then
					ie_grupo_produto_w	:= pls_se_grupo_preco_produto(nr_seq_grupo_produto_w, recuperar_regra_preco_mat_p.nr_seq_plano);
				end if;
				
				if (ie_grupo_produto_w = 'S') then
					
					if (ie_grupo_contrato_w = 'S') then
					
						/*Grupo material*/

						if (coalesce(nr_seq_grupo_material_w,0)	<> 0) then
							ie_grupo_material_w	:= pls_se_grupo_preco_material(nr_seq_grupo_material_w, recuperar_regra_preco_mat_p.nr_seq_material);
						end if;
						
						if (ie_grupo_material_w = 'S') then
							if (coalesce(nr_seq_regra_grupo_oper_w,0) > 0 ) then
								ie_grupo_operadora_w := pls_se_grupo_preco_operadora(nr_seq_regra_grupo_oper_w,recuperar_regra_preco_mat_p.nr_seq_congenere);
							end if;
							
							if (ie_grupo_operadora_w	= 'S') then
								if (r_c01_w.nr_seq_regra_atend_cart IS NOT NULL AND r_c01_w.nr_seq_regra_atend_cart::text <> '') then
									ie_carteira_valida_w	:= pls_valida_regra_cart(recuperar_regra_preco_mat_p.nr_seq_segurado, r_c01_w.nr_seq_regra_atend_cart);
								end if;
								
								if (ie_grupo_operadora_w	= 'S') then
									if (r_c01_w.cd_especialidade_prest	> 0) then
										if	not(cd_especialidade_prest_w like('%'||r_c01_w.cd_especialidade_prest||',%')) then
											ie_especialidade_prest_w	:= 'N';
										end if;
									end if;
								end if;
							end if;
						end if;
					end if;
				end if;

				if (ie_grupo_servico_w		= 'S') and (ie_grupo_contrato_w		= 'S') and (ie_grupo_produto_w		= 'S') and (ie_grupo_material_w		= 'S') and (ie_grupo_operadora_w   	= 'S') and (ie_carteira_valida_w		= 'S') and (ie_especialidade_prest_w 	= 'S')then
				
					select	count(1)
					into STRICT	qt_excecao_preco_mat_w  
					from	pls_excecao_preco_mat  
					where	nr_seq_regra	= nr_seq_regra_ww;
					
					if (qt_excecao_preco_mat_w > 0) then      
						pls_obter_excecao_preco_mat(	nr_seq_regra_ww, (recuperar_regra_preco_mat_p.cd_material_ops)::numeric , recuperar_regra_preco_mat_p.nr_seq_material, 
										recuperar_regra_preco_mat_p.dt_vigencia, recuperar_regra_preco_mat_p.ie_preco, recuperar_regra_preco_mat_p.ie_tipo_contratacao, 
										recuperar_regra_preco_mat_p.ie_tipo_segurado, recuperar_regra_preco_mat_p.nr_seq_contrato, recuperar_regra_preco_mat_p.nr_seq_prestador, 
										recuperar_regra_preco_mat_p.nr_seq_congenere, recuperar_regra_preco_mat_p.nr_seq_tipo_prestador, null,
										recuperar_regra_preco_mat_p.nr_seq_classificacao_prest, recuperar_regra_preco_mat_p.nr_seq_classificacao_prest, recuperar_regra_preco_mat_p.nr_seq_contrato_intercambio,
										null, nr_seq_excecao_preco_mat_w,null,
										recuperar_regra_preco_mat_p.ie_tipo_intercambio, null, null,recuperar_regra_preco_mat_p.ie_tipo_despesa);
					end if;
					
					if (coalesce(nr_seq_excecao_preco_mat_w,0)	= 0) then                      	
						nr_seq_regra_w			:= nr_seq_regra_ww;
						ie_origem_preco_w		:= ie_origem_preco_ww;
						nr_seq_material_preco_w 	:= nr_seq_material_preco_ww;
						tx_ajuste_w			:= tx_ajuste_ww;
						tx_ajuste_pfb_w 		:= tx_ajuste_pfb_ww;
						tx_ajuste_pmc_neut_w		:= tx_ajuste_pmc_neut_ww;
						tx_ajuste_pmc_neg_w		:= tx_ajuste_pmc_neg_ww;
						tx_ajuste_pmc_pos_w		:= tx_ajuste_pmc_pos_ww;
						tx_ajuste_simpro_pfb_w		:= tx_ajuste_simpro_pfb_ww;
						tx_ajuste_simpro_pmc_w		:= tx_ajuste_simpro_pmc_ww;
						ie_tipo_preco_brasindice_w	:= ie_tipo_preco_brasindice_ww;
						ie_tipo_preco_simpro_w		:= ie_tipo_preco_simpro_ww;
						vl_pfb_neutra_simpro_w		:= vl_pfb_neutra_simpro_ww;
						vl_pfb_positiva_simpro_w	:= vl_pfb_positiva_simpro_ww;
						vl_pfb_negativa_simpro_w	:= vl_pfb_negativa_simpro_ww;
						vl_pfb_nao_aplicavel_simpro_w	:= vl_pfb_nao_aplicavel_simpro_ww;
						vl_pfb_neutra_brasindice_w	:= vl_pfb_neutra_brasindice_ww;
						vl_pfb_positiva_brasindice_w	:= vl_pfb_positiva_brasindice_ww;
						vl_pfb_negativa_brasindice_w	:= vl_pfb_negativa_brasindice_ww;
						ie_tipo_ajuste_pfb_w		:= ie_tipo_ajuste_pfb_ww;
						tx_ajuste_tab_propria_w		:= tx_ajuste_tab_propria_ww;
						vl_negociado_w			:= vl_negociado_ww;
						ie_tabela_adicional_w		:= ie_tabela_adicional_ww;
						dt_base_fixo_w			:= dt_base_fixo_ww;
						ie_tipo_preco_tab_adic_w	:= r_c01_w.ie_tipo_preco_tab_adic;
					end if;
				end if;
				
			end if;
			
		end if;
		
		-- quando encontrar uma regra de excecao, nao deve  incluir ela
		if (coalesce(nr_seq_excecao_preco_mat_w,0)	= 0) then
			
			dados_regra_preco_mat_p[i].nr_sequencia			:= nr_seq_regra_ww;
			dados_regra_preco_mat_p[i].tx_ajuste			:= tx_ajuste_w;
			dados_regra_preco_mat_p[i].vl_negociado			:= vl_negociado_w;
			dados_regra_preco_mat_p[i].tx_ajuste_pfb		:= tx_ajuste_pfb_w;
			dados_regra_preco_mat_p[i].tx_ajuste_pmc_neut		:= tx_ajuste_pmc_neut_w;
			dados_regra_preco_mat_p[i].tx_ajuste_pmc_neg		:= tx_ajuste_pmc_neg_w;
			dados_regra_preco_mat_p[i].tx_ajuste_pmc_pos		:= tx_ajuste_pmc_pos_w;
			dados_regra_preco_mat_p[i].tx_ajuste_simpro_pfb		:= tx_ajuste_simpro_pfb_w;
			dados_regra_preco_mat_p[i].tx_ajuste_simpro_pmc		:= tx_ajuste_simpro_pmc_w;
			dados_regra_preco_mat_p[i].ie_origem_preco		:= ie_origem_preco_w;
			dados_regra_preco_mat_p[i].nr_seq_material_preco	:= nr_seq_material_preco_w;
			dados_regra_preco_mat_p[i].tx_ajuste_tab_propria	:= tx_ajuste_tab_propria_w;
			dados_regra_preco_mat_p[i].ie_tabela_adicional		:= ie_tabela_adicional_w;
			dados_regra_preco_mat_p[i].dt_base_fixo			:= dt_base_fixo_w;
			dados_regra_preco_mat_p[i].ie_tipo_preco_brasindice	:= ie_tipo_preco_brasindice_w;
			dados_regra_preco_mat_p[i].ie_tipo_preco_simpro		:= ie_tipo_preco_simpro_w;
			dados_regra_preco_mat_p[i].vl_pfb_neutra_simpro		:= vl_pfb_neutra_simpro_w;
			dados_regra_preco_mat_p[i].vl_pfb_positiva_simpro	:= vl_pfb_positiva_simpro_w;
			dados_regra_preco_mat_p[i].vl_pfb_negativa_simpro	:= vl_pfb_negativa_simpro_w;
			dados_regra_preco_mat_p[i].vl_pfb_nao_aplicavel_simpro	:= vl_pfb_nao_aplicavel_simpro_w;
			dados_regra_preco_mat_p[i].vl_pfb_neutra_brasindice	:= vl_pfb_neutra_brasindice_w;
			dados_regra_preco_mat_p[i].vl_pfb_positiva_brasindice	:= vl_pfb_positiva_brasindice_w;
			dados_regra_preco_mat_p[i].vl_pfb_negativa_brasindice	:= vl_pfb_negativa_brasindice_w;
			dados_regra_preco_mat_p[i].ie_tipo_ajuste_pfb		:= ie_tipo_ajuste_pfb_w;
			dados_regra_preco_mat_p[i].ie_tipo_preco_tab_adic	:= ie_tipo_preco_tab_adic_w;
			dados_regra_preco_mat_p[i].cd_versao_tiss		:= cd_versao_tiss_w;
			dados_regra_preco_mat_p[i].pr_icms			:= pr_icms_w;
			
			i := i +1;
		end if;
	
	end loop; -- Fim cursor com as regras
end if; -- fim se exisitir material
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_smp_pck.obter_regra_preco_mat ( recuperar_regra_preco_mat_p pls_smp_pck.regra_simulacao_preco_mat, dados_regra_preco_mat_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_mat_data) FROM PUBLIC;
