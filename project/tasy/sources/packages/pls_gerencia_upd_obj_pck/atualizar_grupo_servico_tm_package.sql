-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerencia_upd_obj_pck.atualizar_grupo_servico_tm ( nm_usuario_p usuario.nm_usuario%type, nr_seq_grupo_servico_p pls_preco_grupo_servico.nr_sequencia%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Atualizar a estrutura de grupos de serviços na tabela PLS_GRUPO_SERVICO_TM
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [X] Outros:
	
	SOMENTE NA PROCEDURE ATUALIZAR_OBJETO DESTA PACKAGE.
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

Alterações:
------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
tb_seq_grupo_servico_w		pls_util_cta_pck.t_number_table;
tb_ie_origem_proced_w		pls_util_cta_pck.t_number_table;
tb_cd_procedimento_w		pls_util_cta_pck.t_number_table;
nr_indice_w			integer;

-- grupos que devem ser atualizados
c_grupo CURSOR(	nr_seq_grupo_servico_pc	pls_preco_grupo_servico.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_grupo
	from	pls_preco_grupo_servico
	where (nr_sequencia = nr_seq_grupo_servico_pc or coalesce(nr_seq_grupo_servico_pc::text, '') = '');

-- retorna os procedimentos que fazem parte do grupo
c_proc_grupo CURSOR(	nr_seq_grupo_servico_pc	pls_preco_grupo_servico.nr_sequencia%type) FOR
	SELECT	distinct ie_origem_proced,
		cd_procedimento
	from 	table(pls_grupos_pck.obter_procs_grupo_servico(nr_seq_grupo_servico_pc, null, null));
BEGIN
begin
EXECUTE 'ALTER INDEX PLGRUSE_PK NOLOGGING';
exception
when others then
null;	
end;
-- se vier o grupo informado, limpa todos os registros da tabela para logo abaixo popular novamente
if (nr_seq_grupo_servico_p IS NOT NULL AND nr_seq_grupo_servico_p::text <> '') then
	delete 	 from pls_grupo_servico_tm tm
	where	nr_seq_grupo_servico = nr_seq_grupo_servico_p;
end if;

tb_seq_grupo_servico_w.delete;
tb_ie_origem_proced_w.delete;
tb_cd_procedimento_w.delete;
nr_indice_w := 0;

-- busca o grupo ou os grupos que devem ser atualizados
for r_c_grupo_w in c_grupo(nr_seq_grupo_servico_p) loop
	
	for r_c_proc_grupo_w in c_proc_grupo(r_c_grupo_w.nr_seq_grupo) loop
	
		tb_seq_grupo_servico_w(nr_indice_w) := r_c_grupo_w.nr_seq_grupo;
		tb_ie_origem_proced_w(nr_indice_w) := r_c_proc_grupo_w.ie_origem_proced;
		tb_cd_procedimento_w(nr_indice_w) := r_c_proc_grupo_w.cd_procedimento;
		
		if (nr_indice_w >= 7000) then
			-- manda para o banco
			CALL pls_gerencia_upd_obj_pck.grava_grupo_servico_tm(	tb_seq_grupo_servico_w, tb_ie_origem_proced_w,
						tb_cd_procedimento_w, nm_usuario_p);
			-- reinicializa as variáveis
			tb_seq_grupo_servico_w.delete;
			tb_ie_origem_proced_w.delete;
			tb_cd_procedimento_w.delete;
			nr_indice_w := 0;
		else
			nr_indice_w := nr_indice_w + 1;
		end if;
	end loop;
end loop;

-- manda para o banco o que sobrou se algo falta ser enviado
CALL pls_gerencia_upd_obj_pck.grava_grupo_servico_tm(	tb_seq_grupo_servico_w, tb_ie_origem_proced_w,
			tb_cd_procedimento_w, nm_usuario_p);
-- reinicializa as variáveis
tb_seq_grupo_servico_w.delete;
tb_ie_origem_proced_w.delete;
tb_cd_procedimento_w.delete;
EXECUTE 'ALTER INDEX PLGRUSE_PK LOGGING';
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_upd_obj_pck.atualizar_grupo_servico_tm ( nm_usuario_p usuario.nm_usuario%type, nr_seq_grupo_servico_p pls_preco_grupo_servico.nr_sequencia%type) FROM PUBLIC;
