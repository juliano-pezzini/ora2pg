-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


CREATE TYPE tb_prest_mat AS (
	nr_sequencia		pls_util_cta_pck.t_number_table,
	nr_seq_tipo_prestador	pls_util_cta_pck.t_number_table,
	nr_seq_prest_fornec	pls_util_cta_pck.t_number_table,
	nr_seq_prestador	pls_util_cta_pck.t_number_table,
	nr_seq_material		pls_util_cta_pck.t_number_table,
	nr_prioridade		pls_util_cta_pck.t_number_table,
	ie_tipo_atendimento	pls_util_cta_pck.t_varchar2_table_5,
	ie_liberado		pls_util_cta_pck.t_varchar2_table_5,
	dt_inicio_vigencia	pls_util_cta_pck.t_date_table,
	dt_fim_vigencia		pls_util_cta_pck.t_date_table
);


CREATE OR REPLACE PROCEDURE pls_gerencia_upd_obj_pck.atualizar_prest_mat_tm ( nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Atualizar a estrutura dos materiais habilitados para o prestador e copiá-la para a tabela
	PLS_PRESTADOR_MAT_TM.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [X] Outros:
	
	SOMENTE NA PROCEDURE ATUALIZAR_OBJETO DESTA PACKAGE.
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

Alterações:
------------------------------------------------------------------------------------------------------------------
jjung - OS 609316 - 23/12/2013 - Criação da procedure.
------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
-- Obtém o resultado da view que deve ser considerado como resultado da tabela. 
cs_prestador_mat CURSOR FOR
	SELECT	nextval('pls_prestador_mat_tm_seq') nr_sequencia,
		a.dt_fim_vigencia,
		a.dt_inicio_vigencia,
		a.ie_liberado,
		a.ie_tipo_atendimento,
		a.nr_prioridade,
		a.nr_seq_material,
		a.nr_seq_prestador,
		a.nr_seq_prest_fornec,
		a.nr_seq_tipo_prestador
	from	pls_prestador_mat_v a;

tb_prest_mat_w	tb_prest_mat;


BEGIN


-- Limpar as linhas da tabela, está sendo usado o DELETE no lugar do TRUNCATE TABLE pois se não a tabela será esvaziada para 
-- todas as sessões penduradas no Oracle.
delete	/*+ PARALLEL(tm,5) */ pls_prestador_mat_tm tm;

-- Abrir o cursor dos registros que devem ser gravados.
open cs_prestador_mat;
loop
-- Gravar o cursor na lista.
fetch cs_prestador_mat
bulk collect into	tb_prest_mat_w.nr_sequencia, tb_prest_mat_w.dt_fim_vigencia, tb_prest_mat_w.dt_inicio_vigencia,
			tb_prest_mat_w.ie_liberado, tb_prest_mat_w.ie_tipo_atendimento, tb_prest_mat_w.nr_prioridade,
			tb_prest_mat_w.nr_seq_material, tb_prest_mat_w.nr_seq_prestador, tb_prest_mat_w.nr_seq_prest_fornec,
			tb_prest_mat_w.nr_seq_tipo_prestador
limit current_setting('pls_gerencia_upd_obj_pck.qt_registro_transacao_w')::integer;

-- Se não tiver retornado registro sai do loop.
exit when tb_prest_mat_w.nr_seq_prestador.count = 0;
	
	-- Insere todoso os registos do cursor atual na tabela.
	forall	i in tb_prest_mat_w.nr_seq_prestador.first .. tb_prest_mat_w.nr_seq_prestador.last
		insert 	into pls_prestador_mat_tm(
			nr_seq_tipo_prestador, nr_seq_prest_fornec, nr_seq_prestador,
			nr_seq_material, nr_prioridade, ie_tipo_atendimento,
			ie_liberado, dt_inicio_vigencia, dt_fim_vigencia,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (	tb_prest_mat_w.nr_seq_tipo_prestador(i), tb_prest_mat_w.nr_seq_prest_fornec(i), tb_prest_mat_w.nr_seq_prestador(i),
			tb_prest_mat_w.nr_seq_material(i), tb_prest_mat_w.nr_prioridade(i), tb_prest_mat_w.ie_tipo_atendimento(i),
			tb_prest_mat_w.ie_liberado(i), tb_prest_mat_w.dt_inicio_vigencia(i), tb_prest_mat_w.dt_fim_vigencia(i),
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			nm_usuario_p);
	commit;
end loop;
close cs_prestador_mat;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_upd_obj_pck.atualizar_prest_mat_tm ( nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
