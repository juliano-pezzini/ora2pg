-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerencia_upd_obj_pck.atualizar_grupo_material_tm ( nm_usuario_p usuario.nm_usuario%type, nr_seq_grupo_material_p pls_preco_grupo_material.nr_sequencia%type) AS $body$
DECLARE


-- grupos que devem ser atualizados
c_grupo CURSOR(	nr_seq_grupo_material_pc 	pls_preco_grupo_material.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_grupo
	from	pls_preco_grupo_material
	where	nr_sequencia = nr_seq_grupo_material_pc
	
union all

	SELECT	nr_sequencia nr_seq_grupo
	from	pls_preco_grupo_material
	where	coalesce(nr_seq_grupo_material_pc::text, '') = '';

BEGIN

-- se vier o grupo informado, limpa todos os registros da tabela para logo abaixo popular novamente
if (nr_seq_grupo_material_p IS NOT NULL AND nr_seq_grupo_material_p::text <> '') then

	delete /*+ PARALLEL(tm,8) */	from pls_grupo_material_tm tm
	where	nr_seq_grupo = nr_seq_grupo_material_p;
end if;
commit;

-- busca o grupo ou os grupos que devem ser atualizados
for r_c_grupo_w in c_grupo(nr_seq_grupo_material_p) loop
	insert 	into pls_grupo_material_tm t(
			nr_sequencia, dt_atualizacao, nm_usuario,
			nr_seq_grupo, nr_seq_material)
	SELECT	nextval('pls_grupo_material_tm_seq'), clock_timestamp(), nm_usuario_p,
		r_c_grupo_w.nr_seq_grupo, m.nr_sequencia
	from	pls_material m
	where 	m.nr_sequencia in (SELECT	b.nr_sequencia
				   from 	pls_preco_material a,
						pls_material b
				   where	a.nr_seq_grupo = r_c_grupo_w.nr_seq_grupo
				   and		b.nr_sequencia = a.nr_seq_material
				
union all

				   select 	b.nr_sequencia nr_seq_material
				   from		pls_preco_material a,
						pls_material b
				   where 	a.nr_seq_grupo = r_c_grupo_w.nr_seq_grupo
				   and		coalesce(a.nr_seq_material, -1) = -1
				   and		b.nr_seq_estrut_mat = a.nr_seq_estrutura_mat);
	commit;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_upd_obj_pck.atualizar_grupo_material_tm ( nm_usuario_p usuario.nm_usuario%type, nr_seq_grupo_material_p pls_preco_grupo_material.nr_sequencia%type) FROM PUBLIC;
