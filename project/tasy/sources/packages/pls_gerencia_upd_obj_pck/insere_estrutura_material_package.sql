-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerencia_upd_obj_pck.insere_estrutura_material ( nr_seq_objeto_p pls_controle_upd_obj.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ds_parametro_p pls_controle_upd_obj.ds_parametros%type default null) AS $body$
DECLARE


nr_seq_material_w	pls_material.nr_sequencia%type;
nr_seq_estrutura_w	pls_material.nr_seq_estrut_mat%type;
ds_param_w		varchar(500);
ie_atualizar_w	varchar(1);

BEGIN

for r_c_param_w in current_setting('pls_gerencia_upd_obj_pck.c_param')::CURSOR((ds_parametro_p) loop

	for r_c_param_valor_w in current_setting('pls_gerencia_upd_obj_pck.c_param_valor')::CURSOR((r_c_param_w.ds_valor_vchr2) loop

		case(ds_param_w)
			when 'nr_seq_estrutura_p' then
				nr_seq_estrutura_w := r_c_param_valor_w.nr_valor_number;
			when 'nr_seq_material_p' then
				nr_seq_material_w := r_c_param_valor_w.nr_valor_number;
			else
				null;
		end case;

		ds_param_w := r_c_param_valor_w.ds_valor_vchr2;
	end loop;
end loop;
--chamar rotina de controle
ie_atualizar_w := 'S';
if (nr_seq_estrutura_w IS NOT NULL AND nr_seq_estrutura_w::text <> '') then

	select 	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ie_atualizar_w
	from	pls_estrutura_material
	where	nr_sequencia = nr_seq_estrutura_w;

elsif (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
	
	select 	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ie_atualizar_w
	from	pls_material
	where	nr_sequencia = nr_seq_material_w;

end if;

if (ie_atualizar_w = 'S') then
	insert into pls_controla_estrut_mat(	nr_sequencia,nr_seq_estrut_mat,dt_atualizacao,
						nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
						ie_status,nr_seq_controle_upd,ie_atualizacao_total,
						nr_seq_material)
				values (	nextval('pls_controla_estrut_mat_seq'),nr_seq_estrutura_w, clock_timestamp(),
						nm_usuario_p, clock_timestamp(), nm_usuario_p,
						'P',nr_seq_objeto_p, CASE WHEN coalesce(nr_seq_estrutura_w,0)=0 THEN CASE WHEN coalesce(nr_seq_material_w,0)=0 THEN 'S'  ELSE 'N' END   ELSE 'N' END ,
						nr_seq_material_w);
end if;						

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_upd_obj_pck.insere_estrutura_material ( nr_seq_objeto_p pls_controle_upd_obj.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ds_parametro_p pls_controle_upd_obj.ds_parametros%type default null) FROM PUBLIC;
