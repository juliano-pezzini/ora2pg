-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_gerencia_upd_obj_pck.set_status_objetos ( nr_sequencia_p pls_controle_upd_obj.nr_sequencia%type, ie_status_p pls_controle_upd_obj.ie_status%type, ds_atualizacao_fila_p pls_controle_upd_obj.ds_atualizacao_fila%type, nm_usuario_p pls_controle_upd_obj.nm_usuario%type) AS $body$
DECLARE

				
nm_id_sid_w	pls_controle_upd_obj.nm_id_sid%type;
nm_id_serial_w	pls_controle_upd_obj.nm_id_serial%type;
nm_osuser_w	pls_controle_upd_obj.nm_osuser%type;
nm_machine_w	pls_controle_upd_obj.nm_machine%type;
nm_terminal_w	pls_controle_upd_obj.nm_terminal%type;
nm_program_w	pls_controle_upd_obj.nm_program%type;
nm_module_w	pls_controle_upd_obj.nm_module%type;
nm_action_w	pls_controle_upd_obj.nm_action%type;


BEGIN

if (ie_status_p not in ('A','N')) then
	
	CALL wheb_mensagem_pck.exibir_mensagem_abort('Argumentos inválidos na chamada para a procedure PLS_GERENCIA_UPD_OBJ_PCK.SET_STATUS_OBJETOS()!'
 || pls_util_pck.enter_w ||
						'Status: ' || ie_status_p || pls_util_pck.enter_w ||
						dbms_utility.format_call_stack);
else	
	-- ínicio da atualização
	if (ie_status_p = 'A') then

		-- pega os dados da sessão atual
		SELECT * FROM pls_util_pck.obter_dados_sessao(nm_id_sid_w, nm_id_serial_w, nm_osuser_w, nm_machine_w, nm_terminal_w, nm_program_w, nm_module_w, nm_action_w) INTO STRICT nm_id_sid_w, nm_id_serial_w, nm_osuser_w, nm_machine_w, nm_terminal_w, nm_program_w, nm_module_w, nm_action_w;
						
		update	pls_controle_upd_obj
		set	nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp(),
			ie_status = ie_status_p,
			dt_inicio_atualizacao = clock_timestamp(),
			dt_fim_atualizacao  = NULL,
			ds_tempo_execucao  = NULL,
			nm_id_sid = nm_id_sid_w,
			nm_id_serial = nm_id_serial_w,
			nm_osuser = nm_osuser_w,
			nm_machine = nm_machine_w,
			nm_terminal = nm_terminal_w,
			nm_program = nm_program_w,
			nm_module = nm_module_w,
			nm_action = nm_action_w,
			ds_atualizacao_fila = ds_atualizacao_fila_p
		where	nr_sequencia = nr_sequencia_p;
	
	-- fim da atualização
	else
		update	pls_controle_upd_obj
		set	nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp(),
			ie_status = ie_status_p,
			dt_fim_atualizacao = clock_timestamp(),
			ds_tempo_execucao = pls_manipulacao_datas_pck.obter_tempo_execucao_format(dt_inicio_atualizacao, clock_timestamp())
		where	nr_sequencia = nr_sequencia_p;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_upd_obj_pck.set_status_objetos ( nr_sequencia_p pls_controle_upd_obj.nr_sequencia%type, ie_status_p pls_controle_upd_obj.ie_status%type, ds_atualizacao_fila_p pls_controle_upd_obj.ds_atualizacao_fila%type, nm_usuario_p pls_controle_upd_obj.nm_usuario%type) FROM PUBLIC;
