-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE gerar_pacote_autorizacao_pck.gerar_mat_pacote (nr_seq_pacote_p bigint) AS $body$
DECLARE


qt_material_w		double precision;
qt_mat_ja_pacote_w	double precision;
i			integer;

c01 CURSOR FOR
SELECT	'S',
	nr_seq_familia,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_material,
	qt_material
from	convenio_pacote_autor_mat
where	nr_seq_pacote	= nr_seq_pacote_p
and	ie_situacao	= 'A'
and	dt_autorizacao_w	between coalesce(dt_inicio_vigencia,clock_timestamp() - interval '999 days') and coalesce(dt_fim_vigencia,clock_timestamp() + interval '999 days')
order by coalesce(nr_seq_familia,0),
	coalesce(cd_grupo_material,0),
	coalesce(cd_subgrupo_material,0),
	coalesce(cd_classe_material,0),
	coalesce(cd_material,0),
	dt_inicio_vigencia,
	coalesce(qt_material,0);

c01_w	c01%rowtype;

c02 CURSOR FOR
SELECT	a.*
from	material_autorizado a
where	a.nr_sequencia_autor	= nr_sequencia_autor_w
and	a.qt_solicitada		> 0
and	((Obter_estrutura_material(a.cd_material,'C') 	= coalesce(c01_w.cd_classe_material,0)) or (Obter_estrutura_material(a.cd_material,'S') 	= coalesce(c01_w.cd_subgrupo_material,0)) or (Obter_estrutura_material(a.cd_material,'G') 	= coalesce(c01_w.cd_grupo_material,0)) or (obter_familia_material(a.cd_material) 	= coalesce(c01_w.nr_seq_familia,0)) or (a.cd_material = c01_w.cd_material))
and	not exists (select	1
			from	material_autor_pacote x
			where	x.nr_seq_mat_autor = a.nr_sequencia)
order by a.qt_solicitada desc;

c02_w	c02%rowtype;


BEGIN

current_setting('gerar_pacote_autorizacao_pck.mat_pacote_w')::mat_pacote_vt.delete;
qt_mat_ja_pacote_w	:= 0;

RAISE NOTICE '_______________________';
RAISE NOTICE 'gerar_mat_pacote';
RAISE NOTICE 'Pacote: %', nr_seq_pacote_p;

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	i := current_setting('gerar_pacote_autorizacao_pck.mat_pacote_w')::mat_pacote_vt.count;
	qt_mat_ja_pacote_w := 0;
	open C02;
	loop
	fetch C02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		if (c01_w.qt_material >= c02_w.qt_solicitada) then
			qt_material_w	:= c02_w.qt_solicitada;
		else
			qt_material_w	:= c01_w.qt_material;
		end if;

		if	(c01_w.qt_material < (qt_mat_ja_pacote_w + qt_material_w)) then
			RAISE NOTICE ' >>> Ultrapassou limite > mat: % qt_mat_ja_pacote_w: %  qt_material_w: %', c02_w.cd_material, qt_mat_ja_pacote_w, qt_material_w;
			goto final;
		end if;

		RAISE NOTICE 'Material: %', c02_w.cd_material;
		current_setting('gerar_pacote_autorizacao_pck.mat_pacote_w')::mat_pacote_vt[i].nr_sequencia	:= c02_w.nr_sequencia;
		current_setting('gerar_pacote_autorizacao_pck.mat_pacote_w')::mat_pacote_vt[i].nr_seq_pacote	:= nr_seq_pacote_p;
		current_setting('gerar_pacote_autorizacao_pck.mat_pacote_w')::mat_pacote_vt[i].cd_material	:= c02_w.cd_material;
		current_setting('gerar_pacote_autorizacao_pck.mat_pacote_w')::mat_pacote_vt[i].qt_solicitada	:= c02_w.qt_solicitada;
		if (c01_w.qt_material < c02_w.qt_solicitada) then
			qt_material_w	:= c01_w.qt_material;
			CALL gerar_pacote_autorizacao_pck.descobrar_mat_autorizado(c02_w.nr_sequencia, c02_w.qt_solicitada - c01_w.qt_material,null);
		end if;
		RAISE NOTICE 'Qt mat: %', qt_material_w;
		RAISE NOTICE 'i: %', i;
		current_setting('gerar_pacote_autorizacao_pck.mat_pacote_w')::mat_pacote_vt[i].qt_mat_pacote	:= qt_material_w;

		qt_mat_ja_pacote_w		:= qt_mat_ja_pacote_w + qt_material_w;

		i := i + 1;

		<<final>>
		i := i;
		end;

	end loop;
	close C02;

	end;
end loop;
close C01;



end;

--###################################################################
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pacote_autorizacao_pck.gerar_mat_pacote (nr_seq_pacote_p bigint) FROM PUBLIC;
