-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_agrupamento_analise_pck.obtem_seq_regra_valida (ie_tipo_guia_p pls_conta.ie_tipo_guia%type, nr_seq_tipo_atendimento_p pls_conta.nr_seq_tipo_atendimento%type, nr_seq_guia_p pls_conta.nr_seq_guia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type) RETURNS bigint AS $body$
DECLARE


ie_vinc_internacao_w	varchar(1);
qt_guia_w		integer;
nr_seq_guia_principal_w	pls_guia_plano.nr_seq_guia_principal%type;
ie_tipo_guia_w		pls_guia_plano.ie_tipo_guia%type;
C_regra CURSOR(	ie_tipo_guia_pc			pls_conta.ie_tipo_guia%type,
			nr_seq_tipo_atendimento_pc	pls_conta.nr_seq_tipo_atendimento%type)FOR
	SELECT	nr_sequencia,
		ie_guia_vinc_internacao
	from	pls_regra_an_agrup
	where	cd_estabelecimento		= cd_estabelecimento_p
	and	((coalesce(ie_tipo_guia::text, '') = '') or (ie_tipo_guia	= ie_tipo_guia_pc))
	and	((coalesce(nr_seq_tipo_atendimento::text, '') = '') or (nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_pc))
	and	((coalesce(ie_regime_atendimento::text, '') = '') or (ie_regime_atendimento = ie_regime_atendimento_p))
	and	((coalesce(ie_saude_ocupacional::text, '') = '') or (ie_saude_ocupacional = ie_saude_ocupacional_p));
BEGIN

for r_regra_w in c_regra(ie_tipo_guia_p, nr_seq_tipo_atendimento_p) loop
	begin
	ie_vinc_internacao_w	:= 'S';
	
	if (r_regra_w.ie_guia_vinc_internacao	= 'S') then
		begin
		select	max(nr_seq_guia_principal),
			max(ie_tipo_guia)
		into STRICT	nr_seq_guia_principal_w,
			ie_tipo_guia_w
		from	pls_guia_plano
		where	nr_sequencia	= nr_seq_guia_p;
		
		if (nr_seq_guia_principal_w IS NOT NULL AND nr_seq_guia_principal_w::text <> '') then
			begin
			select	count(1)
			into STRICT	qt_guia_w
			from	pls_guia_plano
			where	nr_sequencia	= nr_seq_guia_principal_w
			and	ie_tipo_guia	= '1';
			
			if (qt_guia_w	= 0) then
				begin
				ie_vinc_internacao_w	:= 'N';
				end;
			end if;
			
			end;
		elsif (ie_tipo_guia_w = '1') then
			
			ie_vinc_internacao_w	:= 'S';
		else
			begin
			ie_vinc_internacao_w	:= 'N';
			end;
		end if;
		
		end;
	end if;
	
	if (ie_vinc_internacao_w	= 'S') then
		begin
		return	r_regra_w.nr_sequencia;
		end;
	end if;
	
	end;
end loop;

return	null;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_agrupamento_analise_pck.obtem_seq_regra_valida (ie_tipo_guia_p pls_conta.ie_tipo_guia%type, nr_seq_tipo_atendimento_p pls_conta.nr_seq_tipo_atendimento%type, nr_seq_guia_p pls_conta.nr_seq_guia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type) FROM PUBLIC;
