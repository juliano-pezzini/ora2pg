-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_agrupamento_analise_pck.vincula_conta_analise_exist ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_analise_n_p pls_analise_conta.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_protocolo_w		pls_protocolo_conta.nr_sequencia%type;
nr_seq_prestador_w		pls_protocolo_conta.nr_seq_prestador%type;
ie_tipo_guia_w			pls_protocolo_conta.ie_tipo_guia%type;
nr_seq_lote_conta_w		pls_protocolo_conta.nr_seq_lote_conta%type;
nr_seq_lote_conta_orig_w	pls_protocolo_conta.nr_seq_lote_conta%type;
nr_seq_protocolo_orig_w		pls_protocolo_conta.nr_sequencia%type;
dt_mes_competencia_w		pls_protocolo_conta.dt_mes_competencia%type;
ds_retorno_w			varchar(1);
nr_seq_analise_orig_w		pls_analise_conta.nr_sequencia%type;
qt_contas_w			integer;
dt_max_item_w			pls_conta_proc.dt_procedimento%type;


BEGIN

select 	max(p.ie_tipo_guia),
	max(p.nr_seq_prestador),
	max(p.nr_seq_lote_conta),
	max(p.nr_sequencia),
	max(p.dt_mes_competencia),
	max(c.nr_seq_analise)
into STRICT	ie_tipo_guia_w,
	nr_seq_prestador_w,
	nr_seq_lote_conta_orig_w,
	nr_seq_protocolo_orig_w,
	dt_mes_competencia_w,
	nr_seq_analise_orig_w
from	pls_protocolo_conta	p,
	pls_conta		c
where	c.nr_sequencia		= nr_seq_conta_p
and	c.nr_seq_protocolo	= p.nr_sequencia;

select	max(dt_item)
into STRICT	dt_max_item_w
from (   SELECT	i.dt_procedimento dt_item
	    from	pls_conta_proc	i
	    where	nr_seq_conta	= nr_seq_conta_p
	
union all
	
	    SELECT	i.dt_atendimento dt_item
	    from	pls_conta_mat	i
	    where	nr_seq_conta	= nr_seq_conta_p) alias1;
	
select	max(nr_seq_lote_protocolo)
into STRICT	nr_seq_lote_conta_w
from	pls_analise_conta
where	nr_sequencia	= nr_seq_analise_n_p;

select	max(nr_sequencia)
into STRICT	nr_seq_protocolo_w
from	pls_protocolo_conta
where	ie_tipo_guia		= ie_tipo_guia_w
and	nr_seq_prestador	= nr_seq_prestador_w
and	nr_seq_lote_conta	= nr_seq_lote_conta_w
and	trunc(dt_mes_competencia,'month') = trunc(dt_mes_competencia_w,'month')
and	dt_protocolo		> trunc(dt_max_item_w);

if (nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') then
	begin
	
	update	pls_conta
	set	nr_seq_protocolo	= nr_seq_protocolo_w,
		nr_seq_lote_conta_orig	= nr_seq_lote_conta_orig_w,
		nr_seq_analise		= nr_seq_analise_n_p
	where	nr_sequencia		= nr_seq_conta_p;

	end;
else
	begin
	SELECT * FROM pls_agrupamento_analise_pck.gera_protocolo_conta(	nr_seq_protocolo_orig_w, ie_tipo_guia_w, nr_seq_lote_conta_w, nm_usuario_p, cd_estabelecimento_p, nr_seq_protocolo_w, ds_retorno_w) INTO STRICT nr_seq_protocolo_w, ds_retorno_w;

	update	pls_conta
	set	nr_seq_protocolo	= nr_seq_protocolo_w,
		nr_seq_lote_conta_orig	= nr_seq_lote_conta_orig_w,
		nr_seq_analise		= nr_seq_analise_n_p
	where	nr_sequencia		= nr_seq_conta_p;	
			
	end;
end if;

select	count(1)
into STRICT	qt_contas_w
from	pls_conta
where	nr_seq_analise = nr_seq_analise_orig_w;

if (qt_contas_w = 0) then
	begin
	delete FROM PLS_HIST_ANALISE_CONTA x
	where nr_seq_analise = nr_seq_analise_orig_w;

	delete FROM PLS_ANALISE_GLO_OCOR_GRUPO x
	where nr_seq_analise = nr_seq_analise_orig_w;

	delete  FROM PLS_TEMPO_CONTA_GRUPO y
	where   y.nr_seq_auditoria in (   SELECT 	x.nr_sequencia
					  from 		PLS_AUDITORIA_CONTA_GRUPO x
					  where 	nr_seq_analise = nr_seq_analise_orig_w);

	delete FROM PLS_ANALISE_FLUXO_OCOR  x
	where nr_seq_analise = nr_seq_analise_orig_w;

	delete FROM PLS_ANALISE_LOG_ACESSO x
	where nr_seq_analise = nr_seq_analise_orig_w;

	delete FROM PLS_ANALISE_FLUXO_ITEM x
	where nr_seq_analise = nr_seq_analise_orig_w;

	delete   FROM PLS_AUDITORIA_CONTA_GRUPO x
	where nr_seq_analise = nr_seq_analise_orig_w;

	delete FROM pls_analise_conta c
	where nr_sequencia = nr_seq_analise_orig_w;

	end;
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_agrupamento_analise_pck.vincula_conta_analise_exist ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_analise_n_p pls_analise_conta.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
