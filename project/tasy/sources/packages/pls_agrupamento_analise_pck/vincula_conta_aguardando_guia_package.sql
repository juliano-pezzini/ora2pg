-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_agrupamento_analise_pck.vincula_conta_aguardando_guia ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_protocolo_w		pls_protocolo_conta.nr_sequencia%type;
nr_seq_prestador_w		pls_protocolo_conta.nr_seq_prestador%type;
ie_tipo_guia_w			pls_protocolo_conta.ie_tipo_guia%type;
nr_seq_lote_conta_w		pls_protocolo_conta.nr_seq_lote_conta%type;
nr_seq_lote_conta_orig_w	pls_protocolo_conta.nr_seq_lote_conta%type;
nr_seq_protocolo_orig_w		pls_protocolo_conta.nr_sequencia%type;
ds_retorno_w			varchar(1);
dt_mes_competencia_w		pls_protocolo_conta.dt_mes_competencia%type;
dt_max_item_w			pls_conta_proc.dt_procedimento%type;

BEGIN

select 	max(nr_sequencia)
into STRICT	nr_seq_lote_conta_w
from	pls_lote_protocolo_conta
where	cd_estabelecimento	= cd_estabelecimento_p
and	ie_status		= 'G';

if (coalesce(nr_seq_lote_conta_w::text, '') = '') then
	begin
	nr_seq_lote_conta_w := pls_agrupamento_analise_pck.gerar_lote_conta(cd_estabelecimento_p, nm_usuario_p, nr_seq_lote_conta_w);
	end;
end if;

select 	max(p.ie_tipo_guia),
	max(p.nr_seq_prestador),
	max(p.nr_seq_lote_conta),
	max(p.nr_sequencia),
	max(p.dt_mes_competencia)
into STRICT	ie_tipo_guia_w,
	nr_seq_prestador_w,
	nr_seq_lote_conta_orig_w,
	nr_seq_protocolo_orig_w,
	dt_mes_competencia_w
from	pls_protocolo_conta	p,
	pls_conta		c
where	c.nr_sequencia		= nr_seq_conta_p
and	c.nr_seq_protocolo	= p.nr_sequencia;

select	max(dt_item)
into STRICT	dt_max_item_w
from (   SELECT	i.dt_procedimento dt_item
	    from	pls_conta_proc	i
	    where	nr_seq_conta	= nr_seq_conta_p
	
union all
	
	    SELECT	i.dt_atendimento dt_item
	    from	pls_conta_mat	i
	    where	nr_seq_conta	= nr_seq_conta_p) alias1;
	
select	max(nr_sequencia)
into STRICT	nr_seq_protocolo_w
from	pls_protocolo_conta
where	ie_tipo_guia			= ie_tipo_guia_w
and	nr_seq_prestador		= nr_seq_prestador_w
and	nr_seq_lote_conta		= nr_seq_lote_conta_w
and	dt_protocolo 			> trunc(dt_max_item_w)
and	trunc(dt_mes_competencia,'month') = trunc(dt_mes_competencia_w,'month');

if (nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') then
	begin
	update	pls_conta
	set	nr_seq_protocolo	= nr_seq_protocolo_w,
		nr_seq_lote_conta_orig	= nr_seq_lote_conta_orig_w
	where	nr_sequencia		= nr_seq_conta_p;
	end;
else
	begin
	SELECT * FROM pls_agrupamento_analise_pck.gera_protocolo_conta(	nr_seq_protocolo_orig_w, ie_tipo_guia_w, nr_seq_lote_conta_w, nm_usuario_p, cd_estabelecimento_p, nr_seq_protocolo_w, ds_retorno_w) INTO STRICT nr_seq_protocolo_w, ds_retorno_w;

	update	pls_conta
	set	nr_seq_protocolo	= nr_seq_protocolo_w,
		nr_seq_lote_conta_orig	= nr_seq_lote_conta_orig_w
	where	nr_sequencia		= nr_seq_conta_p;			
	
	end;
end if;

update	pls_analise_conta
set	nr_seq_lote_protocolo	= nr_seq_lote_conta_w,
	ie_status		= 'X'
where	nr_sequencia		= nr_seq_analise_p;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_agrupamento_analise_pck.vincula_conta_aguardando_guia ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
