-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION panorama_main_filter.fn_grid_panorama_clinico ( pr_cd_perfil bigint, pr_cd_setor_atendimento bigint, pr_ie_sem_acomodacao text, pr_ie_emprestado text, pr_ie_departamento_medico text, pr_cd_departamento bigint, pr_ie_status_unidade text, pr_ie_meus_pacientes text, pr_cd_pessoa_fisica bigint, pr_ie_pendencia_adep text, pr_nr_seq_servico bigint, pr_nr_seq_classif_esp bigint, pr_cd_pessoa_paciente text, pr_cd_classe_material bigint, pr_ie_controla_alta text, pr_dt_final timestamp, pr_dt_entrada timestamp, pr_cd_single_patient text, pr_ie_follow_up text, pr_cd_profissional bigint , pr_ie_new_patient text ) RETURNS SETOF TABLE_PANORAMA_OBJ AS $body$
DECLARE


        table_aux table_panorama_obj;

        cr_panorama CURSOR FOR
        SELECT CASE WHEN coalesce(temp.ds_unidade_acompanhante::text, '') = '' THEN  temp.cd_unidade_basica|| ' '                                                       || temp.cd_unidade_compl  ELSE ds_unidade_acompanhante END  ds_unidade,
            substr((SELECT obter_se_def_ret_atual(pr_cd_perfil) ), 1, 1) ie_permite_definir_retaguarda,
            cd_setor_atendimento,
            cd_unidade_basica,
            cd_unidade_compl,
            ie_adaptado,
            ie_temporario,
            ie_backup,
            ie_sexo,
            cd_exp_status,
            cd_exp_adaptado,
            cd_exp_temporario,
            cd_exp_backup,
            cd_exp_sexo,
            ie_concluido,
            nr_seq_interno,
            ie_status_unidade,
            cd_perfil,
            nr_seq_texto_adaptado,
            nr_seq_texto_temporario,
            nr_seq_texto_backup,
            ie_sem_acomodacao,
            ds_status,
            ds_sexo,
            nr_seq_texto_sexo,
            ds_unidade_atend,
            ie_emprestado,
            ds_unidade_acompanhante,
            nr_seq_apresentacao
        FROM
            (
                SELECT
                    *
                FROM
                    v_w_pan_leito a
                WHERE
                    a.cd_setor_atendimento = pr_cd_setor_atendimento
                    AND a.ie_sem_acomodacao = pr_ie_sem_acomodacao
                    AND a.ie_emprestado = pr_ie_emprestado
                    AND (coalesce(pr_ie_new_patient,'N')='N' OR exists (select 1 from w_pan_paciente pp where pp.nr_seq_interno= a.nr_seq_interno
                        and (select obter_se_paciente_novo_pan(pp.nr_atendimento, a.cd_setor_atendimento) ) = 'S' ))
                    AND ( coalesce(pr_ie_follow_up, 'N') = 'N'
                          OR a.nr_seq_interno IN (
                        SELECT
                            b.nr_seq_interno
                        FROM
                            w_pan_paciente b
                        WHERE b.nr_atendimento IN (
                                SELECT
                                    d.nr_atendimento
                                FROM
                                    panorama_acomp_prof d
                                WHERE
                                    d.ie_acomp_ativo = 'S' AND d.cd_profissional = pr_cd_profissional) )
                    )
                    AND ( ( coalesce(pr_ie_departamento_medico, 'N') = 'N' )
                          OR ( (select patient_belong_departament(a.nr_seq_interno, pr_cd_departamento) ) = 'S' ) )
                    AND ( coalesce(pr_ie_status_unidade::text, '') = ''
                          OR a.ie_status_unidade = pr_ie_status_unidade )
                    AND ('S' = coalesce(pr_ie_meus_pacientes, 'N')
                            AND ( a.nr_seq_interno IN (
                        SELECT
                            x.nr_seq_interno
                        FROM
                            w_pan_paciente x
                        WHERE
                            x.ie_concluido = 'S'
                            AND ( 'S' = coalesce(pr_ie_meus_pacientes, 'N')
                                  AND x.cd_medico = pr_cd_pessoa_fisica
                                  OR 'N' = coalesce(pr_ie_meus_pacientes, 'N') )
                    ) )
                            OR 'N' = coalesce(pr_ie_meus_pacientes, 'N'))
                    AND ( ( coalesce(pr_ie_pendencia_adep, 'N') = 'N' )
                          OR ( (
                        SELECT
                            MAX(d.ie_pendencia_adep)
                        FROM
                            w_pan_paciente d
                        WHERE
                            d.ie_concluido = 'S'
                            AND d.nr_seq_interno = a.nr_seq_interno
                    ) = 'S' ) )
                    AND ( coalesce(pr_nr_seq_servico::text, '') = ''
                          OR ( a.nr_seq_interno IN (
                        SELECT
                            nr_seq_interno
                        FROM
                            w_pan_paciente b
                        WHERE
                            b.ie_concluido = 'S'
                            AND b.nr_atendimento IN (
                                SELECT
                                    a.nr_atendimento
                                FROM
                                    atend_pac_servico_conta a
                                WHERE
                                    a.nr_seq_servico IN (WITH RECURSIVE cte AS (

                                        SELECT
                                            regexp_substr(pr_nr_seq_servico, '[^,]+', 1, level)
                                        
                                        (regexp_substr(pr_nr_seq_servico, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(pr_nr_seq_servico, '[^,]+', 1, level))::text <> '')
                                      UNION ALL

                                        SELECT
                                            regexp_substr(pr_nr_seq_servico, '[^,]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
)
                            )
                    ) ) )
                    AND ( coalesce(pr_nr_seq_classif_esp::text, '') = ''
                          OR ( a.nr_seq_interno IN (
                        SELECT
                            nr_seq_interno
                        FROM
                            w_pan_paciente b
                        WHERE
                            b.ie_concluido = 'S'
                            AND b.nr_atendimento IN (
                                SELECT
                                    a.nr_atendimento
                                FROM
                                    atendimento_paciente a
                                WHERE
                                    a.nr_seq_classif_esp IN (WITH RECURSIVE cte AS (

                                        SELECT
                                            regexp_substr(pr_nr_seq_classif_esp, '[^,]+', 1, level)
                                        
                                        (regexp_substr(pr_nr_seq_classif_esp, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(pr_nr_seq_classif_esp, '[^,]+', 1, level))::text <> '')
                                      UNION ALL

                                        SELECT
                                            regexp_substr(pr_nr_seq_classif_esp, '[^,]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
)
                            )
                    ) ) )
                    AND ( coalesce(replace(pr_cd_pessoa_paciente, ' ', '')::text, '') = ''
                          OR ( a.nr_seq_interno IN (
                        SELECT
                            b.nr_seq_interno
                        FROM
                            w_pan_paciente b
                        WHERE
                            b.cd_pessoa_paciente IN ((WITH RECURSIVE cte AS (

                                    SELECT
                                        regexp_substr(replace(pr_cd_pessoa_paciente, ' ', ''), '[^,]+', 1, level)
                                    
                                    regexp_substr(replace(pr_cd_pessoa_paciente, ' ', ''), '[^,    ]+', 1, level) IS NOT NULL
                                  UNION ALL

                                    SELECT
                                        regexp_substr(replace(pr_cd_pessoa_paciente, ' ', ''), '[^,]+', 1, level)
                                    
                                    regexp_substr(replace(pr_cd_pessoa_paciente, ' ', ''), '[^,    ]+', 1, level) IS NOT NULL
                                 JOIN cte c ON ()

) SELECT * FROM cte;
))
                    ) ) )
                    AND ( coalesce(pr_cd_classe_material::text, '') = ''
                          OR ( select get_if_medicine_class_cb(a.nr_seq_interno, pr_cd_classe_material)  ) = 'S' )
                    AND ( ( 'S' = pr_ie_controla_alta
                            AND ( a.nr_seq_interno IN (
                        SELECT
                            x.nr_seq_interno
                        FROM
                            w_pan_paciente x
                        WHERE
                            x.ie_concluido = 'S'
                            AND (select obter_se_participa_alta(x.nr_atendimento) ) = 'S'
                    ) ) )
                          OR ( 'N' = pr_ie_controla_alta
                               AND ( a.nr_seq_interno IN (
                        SELECT
                            x.nr_seq_interno
                        FROM
                            w_pan_paciente x
                        WHERE
                            x.ie_concluido = 'S'
                            AND (select obter_se_participa_alta(x.nr_atendimento) ) = 'N'
                    ) ) )
                          OR ( 'A' = pr_ie_controla_alta ) )
                    AND ( ( coalesce(pr_dt_entrada::text, '') = ''
                            AND coalesce(pr_dt_final::text, '') = '' )
                          OR ( a.nr_seq_interno IN (
                        SELECT
                            nr_seq_interno
                        FROM
                            w_pan_paciente b
                        WHERE
                            b.ie_concluido = 'S'
                            AND (
                                SELECT
                                    MAX(z.dt_entrada_unidade)
                                FROM
                                    atend_paciente_unidade z
                                WHERE
                                    z.nr_atendimento = b.nr_atendimento
                            ) BETWEEN inicio_dia(pr_dt_entrada) AND fim_dia(pr_dt_final)
                    ) ) )
                    AND ( coalesce(pr_cd_single_patient::text, '') = ''
                          OR a.nr_seq_interno in (
                        SELECT
                           DISTINCT wpp.nr_seq_interno
                        FROM
                            w_pan_paciente wpp
                        WHERE
                            wpp.ie_concluido = 'S'
                            AND wpp.cd_pessoa_paciente = pr_cd_single_patient
                            AND wpp.cd_unidade_basica = a.cd_unidade_basica
                            AND wpp.cd_unidade_compl = a.cd_unidade_compl
                    ) )
            ) temp
        GROUP BY
            1,
            2,
            cd_setor_atendimento,
            cd_unidade_basica,
            cd_unidade_compl,
            ie_adaptado,
            ie_temporario,
            ie_backup,
            ie_sexo,
            cd_exp_status,
            cd_exp_adaptado,
            cd_exp_temporario,
            cd_exp_backup,
            cd_exp_sexo,
            ie_concluido,
            nr_seq_interno,
            ie_status_unidade,
            cd_perfil,
            nr_seq_texto_adaptado,
            nr_seq_texto_temporario,
            nr_seq_texto_backup,
            ie_sem_acomodacao,
            ds_status,
            ds_sexo,
            nr_seq_texto_sexo,
            ds_unidade_atend,
            ie_emprestado,
            ds_unidade_acompanhante,
            nr_seq_apresentacao
        ORDER BY temp.nr_seq_apresentacao;


BEGIN

        OPEN cr_panorama;
        FETCH cr_panorama BULK COLLECT INTO table_aux;
        CLOSE cr_panorama;

        for i in 1..table_aux.count
        loop 
          RETURN NEXT  table_aux(i );
        end loop;

        return;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION panorama_main_filter.fn_grid_panorama_clinico ( pr_cd_perfil bigint, pr_cd_setor_atendimento bigint, pr_ie_sem_acomodacao text, pr_ie_emprestado text, pr_ie_departamento_medico text, pr_cd_departamento bigint, pr_ie_status_unidade text, pr_ie_meus_pacientes text, pr_cd_pessoa_fisica bigint, pr_ie_pendencia_adep text, pr_nr_seq_servico bigint, pr_nr_seq_classif_esp bigint, pr_cd_pessoa_paciente text, pr_cd_classe_material bigint, pr_ie_controla_alta text, pr_dt_final timestamp, pr_dt_entrada timestamp, pr_cd_single_patient text, pr_ie_follow_up text, pr_cd_profissional bigint , pr_ie_new_patient text ) FROM PUBLIC;
