-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION panorama_main_filter.fn_grid_panorama_clinico_v2 ( cd_setor_atendimento_p bigint , ie_todos_setores_P text , cd_estabelecimento_p bigint , cd_departamento_P bigint , ie_status_leito_p text , ie_new_patient_p text , ie_follow_up_p text , cd_profissional_p bigint , ie_meus_pacientes_p text , cd_single_patient_p bigint , ie_controla_alta_p text , ie_departamento_medico_p text , ie_pendencia_adep_p text , nr_seq_servico_p text , nr_seq_classif_esp_p text , cd_classe_material_p text , cd_pessoa_paciente_p text , cd_setor_avan_p text , cd_setor_avan_estab_p text , ie_chamada_perdida_p text , ie_acomp_bed_p text , ie_icu_p text , ie_acute_p text) RETURNS SETOF TABLE_PANORAMA_V2_OBJ AS $body$
DECLARE


    table_aux TABLE_PANORAMA_V2_OBJ;

		cr_panorama CURSOR FOR
			SELECT distinct sa.cd_setor_atendimento,
							sa.ds_setor_atendimento || CASE WHEN (SELECT count(1) 																where not exists	(select	1 from	departamento_setor x																					  where	x.cd_setor_atendimento = ua.cd_setor_atendimento																						and	x.cd_departamento = (select obter_departamento_data(ua.nr_atendimento,clock_timestamp()) )																					)																 and (select obter_departamento_data(ua.nr_atendimento,clock_timestamp()) ) is not null)=0 THEN null  ELSE ' - ' || (select wheb_mensagem_pck.get_texto(1044863) ) END  as ds_setor_atendimento
							, ua.cd_unidade_basica, 
              ua.ds_unidade_atend, 
              ua.nr_seq_interno, 
              ua.ie_status_unidade, 
              ua.cd_unidade_compl, 
              (select OBTER_NOME_ESTABELECIMENTO(sa.cd_estabelecimento) ) ds_estabelecimento
			from setor_atendimento sa
			inner join unidade_atendimento ua on sa.cd_setor_atendimento = ua.cd_setor_atendimento
			left join departamento_setor ds on ds.cd_setor_atendimento = sa.cd_setor_atendimento
			left join departamento_medico dm on dm.cd_departamento = ds.cd_departamento
			where	sa.ie_situacao = 'A'
			and (sa.cd_setor_atendimento = coalesce(cd_setor_atendimento_p, sa.cd_setor_atendimento) or ie_todos_setores_P = 'S')
			and sa.cd_estabelecimento = coalesce(cd_estabelecimento_p,sa.cd_estabelecimento)
			and ((coalesce(cd_departamento_P::text, '') = '' or ds.cd_departamento = coalesce(cd_departamento_P, ds.cd_departamento)) or ie_todos_setores_P = 'S')
			and ua.ie_status_unidade = coalesce(ie_status_leito_p,ua.ie_status_unidade)
			AND (coalesce(ie_new_patient_p,'N')='N' OR exists (select 1 FROM atendimento_paciente ap  WHERE ap.nr_atendimento = ua.nr_atendimento and (select obter_se_paciente_novo_pan(ap.nr_atendimento, sa.cd_setor_atendimento) ) = 'S' ))
			AND ( coalesce(ie_follow_up_p, 'N') = 'N' OR exists (SELECT 1 FROM panorama_acomp_prof d, atendimento_paciente ap  WHERE ap.cd_pessoa_fisica = d.cd_pessoa_fisica and d.nr_atendimento = ap.nr_atendimento and d.nr_atendimento = ua.nr_atendimento AND d.ie_acomp_ativo = 'S' AND d.cd_profissional = cd_profissional_p) )
			and (( 'S' = coalesce(ie_meus_pacientes_p,'N')
				and	exists (select 1 from atendimento_paciente ap
					where ap.nr_atendimento = ua.nr_atendimento
					and ap.cd_medico_resp = (select obter_dados_usuario_opcao(wheb_usuario_pck.get_nm_usuario,'C') ) )) or 'N' = coalesce(ie_meus_pacientes_p,'N'))
			and (coalesce(cd_single_patient_p::text, '') = ''
				or exists (select 1 from atendimento_paciente ap
					where ap.nr_atendimento = ua.nr_atendimento
					and ap.cd_pessoa_fisica = cd_single_patient_p))
			and (('S' = ie_controla_alta_p
				and (select obter_se_participa_alta(nr_atendimento) ) = 'S')
				or ('N' = ie_controla_alta_p
				and (select obter_se_participa_alta(nr_atendimento ) ) = 'N')
				or ('A' = ie_controla_alta_p))
			and ((coalesce(ie_departamento_medico_p, 'N') = 'N') OR ((select patient_belong_departament(ua.nr_seq_interno, cd_departamento_P) ) = 'S'))
			and ((coalesce(ie_pendencia_adep_p, 'N') = 'N') or (
          (select obter_qt_hor_pendente_prescr(ds.cd_estabelecimento,
              ds.cd_setor_atendimento,null,ua.nr_atendimento,
              0,trunc(clock_timestamp()),clock_timestamp(),1,'S',0,0,0,'S') ) > 0))
			and (coalesce(nr_seq_servico_p::text, '') = '' 
				or exists (select 1
					from	atend_pac_servico_conta a
					where a.nr_atendimento = ua.nr_atendimento
					and a.nr_seq_servico in (WITH RECURSIVE cte AS (
select regexp_substr(nr_seq_servico_p,'[^,]+', 1, level)
						 (regexp_substr(nr_seq_servico_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_seq_servico_p, '[^,]+', 1, level))::text <> '')  UNION ALL
select regexp_substr(nr_seq_servico_p,'[^,]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
)))
			and (coalesce(nr_seq_classif_esp_p::text, '') = '' 
				or exists (select 1
					from	atendimento_paciente a
					where a.nr_atendimento = ua.nr_atendimento
					and a.nr_seq_classif_esp in (WITH RECURSIVE cte AS (
select regexp_substr(nr_seq_classif_esp_p,'[^,]+', 1, level)
						 (regexp_substr(nr_seq_classif_esp_p,'[^,	]+',	1,level) IS NOT NULL AND (regexp_substr(nr_seq_classif_esp_p,'[^,	]+',	1,level))::text <> '')  UNION ALL
select regexp_substr(nr_seq_classif_esp_p,'[^,]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
)))
			and (coalesce(cd_classe_material_p::text, '') = '' or exists (select	1
				from	adep_pend_prev_v a
				where	a.nr_atendimento = ua.nr_atendimento
				and	a.dt_horario between clock_timestamp() - interval '2 days' and clock_timestamp() + interval '3 days'
				and	a.ie_tipo_item in ('M', 'MAT')
				and (select obter_classe_material(a.cd_item) ) in (WITH RECURSIVE cte AS (
select regexp_substr(cd_classe_material_p,'[^,]+', 1, level)
					 (regexp_substr(cd_classe_material_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(cd_classe_material_p, '[^,]+', 1, level))::text <> '')  UNION ALL
select regexp_substr(cd_classe_material_p,'[^,]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
)))
			and (coalesce(replace(cd_pessoa_paciente_p,' ','')::text, '') = '' or exists (select 1
				from	atendimento_paciente a
				where a.nr_atendimento = ua.nr_atendimento
				and a.cd_pessoa_fisica in ((WITH RECURSIVE cte AS (
select regexp_substr(replace(cd_pessoa_paciente_p,' ',''),'[^,]+', 1, level)
					 regexp_substr(replace(cd_pessoa_paciente_p,' ',''),'[^,]+',1,level) is not null  UNION ALL
select regexp_substr(replace(cd_pessoa_paciente_p,' ',''),'[^,]+', 1, level)
					 regexp_substr(replace(cd_pessoa_paciente_p,' ',''),'[^,]+',1,level) is not null JOIN cte c ON ()

) SELECT * FROM cte;
))))
			and (coalesce(cd_setor_avan_p::text, '') = '' or ua.cd_setor_atendimento in (WITH RECURSIVE cte AS (
select regexp_substr(cd_setor_avan_p,'[^,]+', 1, level)
				 (regexp_substr(cd_setor_avan_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(cd_setor_avan_p, '[^,]+', 1, level))::text <> '')  UNION ALL
select regexp_substr(cd_setor_avan_p,'[^,]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
))
			and (coalesce(cd_setor_avan_estab_p::text, '') = '' or ua.cd_setor_atendimento in (WITH RECURSIVE cte AS (
select regexp_substr(cd_setor_avan_estab_p,'[^,]+', 1, level)
				 (regexp_substr(cd_setor_avan_estab_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(cd_setor_avan_estab_p, '[^,]+', 1, level))::text <> '')  UNION ALL
select regexp_substr(cd_setor_avan_estab_p,'[^,]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
))				
			and (ie_chamada_perdida_p = 'N' 
					or ((ua.nr_atendimento IS NOT NULL AND ua.nr_atendimento::text <> '') 
						and exists (select 1 from video_server_notification vsn 
							where vsn.cd_setor_atendimento = ua.cd_setor_atendimento 
							and vsn.cd_unidade_basica = ua.cd_unidade_basica 
							and vsn.cd_unidade_compl = ua.cd_unidade_compl 
							and coalesce(vsn.dt_video_assessment::text, '') = '' 
							and (clock_timestamp() - cast(vsn.dt_notification as timestamp)) <= 1/3)))
			and (coalesce(ie_icu_p, 'N') = 'N' and coalesce(ie_acute_p, 'N') = 'N'
				or (coalesce(ie_icu_p, 'N') = 'S' and (sa.cd_classif_setor = 4 and coalesce(sa.ie_semi_intensiva, 'N') = 'N'))
				or (coalesce(ie_acute_p, 'N') = 'S' and (cd_classif_setor = 1 or cd_classif_setor = 3)))
			order by ds_setor_atendimento desc,CASE WHEN ua.ie_status_unidade='P' THEN 1 WHEN ua.ie_status_unidade='L' THEN 2 WHEN ua.ie_status_unidade='A' THEN 3 WHEN ua.ie_status_unidade='M' THEN CASE WHEN ie_acomp_bed_p='S' THEN 0  ELSE 4 END   ELSE 5 END , ua.cd_unidade_basica, ua.cd_unidade_compl;
	
BEGIN

    OPEN cr_panorama;
    FETCH cr_panorama BULK COLLECT INTO table_aux;
    CLOSE cr_panorama;

    for i in 1..table_aux.count
    loop 
      RETURN NEXT  table_aux(i );
    end loop;

		return;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION panorama_main_filter.fn_grid_panorama_clinico_v2 ( cd_setor_atendimento_p bigint , ie_todos_setores_P text , cd_estabelecimento_p bigint , cd_departamento_P bigint , ie_status_leito_p text , ie_new_patient_p text , ie_follow_up_p text , cd_profissional_p bigint , ie_meus_pacientes_p text , cd_single_patient_p bigint , ie_controla_alta_p text , ie_departamento_medico_p text , ie_pendencia_adep_p text , nr_seq_servico_p text , nr_seq_classif_esp_p text , cd_classe_material_p text , cd_pessoa_paciente_p text , cd_setor_avan_p text , cd_setor_avan_estab_p text , ie_chamada_perdida_p text , ie_acomp_bed_p text , ie_icu_p text , ie_acute_p text) FROM PUBLIC;
