-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


-- Retornar select de validacao do conteudo da view



CREATE OR REPLACE FUNCTION pls_cargas_pck.obter_select_val_conteudo ( nm_atributo_p tabela_atributo.nm_atributo%type, ie_componente_p tabela_atributo.ie_componente%type, cd_exp_valores_p tabela_atributo.cd_exp_valores%type, ds_valores_p tabela_atributo.ds_valores%type, cd_dominio_p tabela_atributo.cd_dominio%type) RETURNS text AS $body$
DECLARE

					
-- cursor

valor_bind_w		sql_pck.t_dado_bind;
cursor_w		sql_pck.t_cursor;
cd_codigo_w		varchar(255);
ds_descricao_w		varchar(255);
ds_restricao_w		text;
ds_sql_w		text;
ie_tabela_w		varchar(5); -- N - Nao e tabela, S - e tabela, V - Sao varias tabelas


BEGIN
-- OBTER VALORES ACEITOS

ds_sql_w := pls_obter_select_val_atrib( ie_componente_p, cd_exp_valores_p, ds_valores_p, cd_dominio_p, cd_estabelecimento_w);

if (ds_sql_w IS NOT NULL AND ds_sql_w::text <> '') then	
	-- executa o comando sql com os respectivos binds

	begin
	valor_bind_w := sql_pck.executa_sql_cursor(	ds_sql_w, valor_bind_w);
	exception
	when others then
		CALL pls_cargas_pck.gravar_val_view('N');
		-- #@DS_ERRO_W#@

		CALL wheb_mensagem_pck.exibir_mensagem_abort(685714,	'DS_ERRO_W=' || ds_sql_w);
	end;

	ds_restricao_w	:= null;
	ie_tabela_w	:= 'N';
	
	begin
	loop
	fetch cursor_w into
		cd_codigo_w,
		ds_descricao_w;
	EXIT WHEN NOT FOUND; /* apply on cursor_w */
		begin
		-- Se for indicacao de tabela e campo

		if (upper(ds_descricao_w) like upper('%Tabela%')) and (upper(cd_codigo_w) like upper('%Campo%')) then
			if (ie_tabela_w = 'N') then -- Passou primeira vez
				ie_tabela_w := 'S';
			elsif (ie_tabela_w = 'S') then -- Passou mais de uma vez
				ie_tabela_w := 'V';
			end if;
		end if;
		
		-- MONTAR RESTRICAO

		if (ie_tabela_w = 'V') then
			if (ds_restricao_w IS NOT NULL AND ds_restricao_w::text <> '') then
				ds_restricao_w := substr(trim(both ds_restricao_w),1,length(trim(both ds_restricao_w))-1);
			end if;
			
			ds_restricao_w := ds_restricao_w || ' union all select to_char('||replace(trim(both cd_codigo_w),'Campo:','')||') from '|| replace(trim(both ds_descricao_w),'Tabela:','')||') ';
			
		elsif (ie_tabela_w = 'S') then
			ds_restricao_w := ' not in (select to_char('||replace(trim(both cd_codigo_w),'Campo:','')||') from '|| replace(trim(both ds_descricao_w),'Tabela:','')||') ';
		else
			ds_restricao_w := chr(39)|| cd_codigo_w || chr(39) ||','|| ds_restricao_w;
		end if;
		
		end;
	end loop;
	close cursor_w;
	exception
	when others then
		CALL pls_cargas_pck.gravar_val_view('N');
		-- #@DS_ERRO_W#@

		CALL wheb_mensagem_pck.exibir_mensagem_abort(685714,	'DS_ERRO_W=' || ds_sql_w);
	end;

	-- MONTAR SELECT

	if (ie_tabela_w in ('V','S')) then
		ds_sql_w	:= ' select count(1) qt from '||nm_view_carga_w||' where '|| nm_atributo_p ||' '|| ds_restricao_w;
		
	elsif (ie_tabela_w = 'N') then
		ds_sql_w	:= ' select count(1) qt from '||nm_view_carga_w||' where '||nm_atributo_p||' not in ('||substr(trim(both ds_restricao_w),1,length(ds_restricao_w)-1)||')';
	end if;
end if;

return ds_sql_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_cargas_pck.obter_select_val_conteudo ( nm_atributo_p tabela_atributo.nm_atributo%type, ie_componente_p tabela_atributo.ie_componente%type, cd_exp_valores_p tabela_atributo.cd_exp_valores%type, ds_valores_p tabela_atributo.ds_valores%type, cd_dominio_p tabela_atributo.cd_dominio%type) FROM PUBLIC;
