-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE sap_fin_customer_pck.get_inv_settlement_response (nr_sequencia_p bigint) AS $body$
DECLARE


reg_integracao_w			gerar_int_padrao.reg_integracao_conv;
nr_seq_doc_origem_w		intpd_fila_transmissao.nr_seq_documento%type;
nr_seq_sistema_w			intpd_eventos_sistema.nr_seq_sistema%type;
ie_conversao_w			  intpd_eventos_sistema.ie_conversao%type;
nr_seq_projeto_xml_w	intpd_eventos_sistema.nr_seq_projeto_xml%type;
nr_seq_regra_w			  intpd_eventos_sistema.nr_seq_regra_conv%type;
nr_seq_agrupador_w		intpd_fila_transmissao.nr_seq_agrupador%type;
ds_xml_w				      text;
xml_w				          xml;
ie_status_w			      intpd_fila_transmissao.ie_status%type		:=	'S';
ie_tipo_erro_w			  intpd_fila_transmissao.ie_tipo_erro%type	:=	'F';
payments_w            xml;
settlement_items_w    r_get_inv_settlement_items;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
pessoa_fisica_w			  pessoa_fisica%rowtype;
nr_seq_trans_fin_w    parametro_contas_receber.nr_seq_trans_fin_baixa%type;
cd_tipo_recebimento_w transacao_financeira.cd_tipo_recebimento%type;
cd_estabelecimento_w  titulo_receber.cd_estabelecimento%type;

c01 CURSOR FOR
SELECT	*
from	xmltable('/ET_PAYMENTS' passing payments_w columns
	companyid	                  varchar(15)	path	'BUKRS',
  externalsystem	            varchar(20)	path	'EXTSYS',
  paymentid	                  varchar(20)	path	'POSID',
  paymentsliptype	            varchar(1)	  path	'BLART',
  billnumber	                varchar(20)	path	'RECHNR',
  referencedocument           varchar(20)	path	'XBLNR',
  documentdate	              varchar(10)	path	'BLDAT',
  custumernumber	            varchar(10)	path	'DEBITOR',
  amount	                    varchar(10)	path	'BETRAG',
  localcurrency	              varchar(3)	  path	'WAERS',
  invoicetext	                varchar(100)	path	'POSTXT',
  invoiceitem	                varchar(1)	  path	'POSKZ',
  cancel	                    varchar(1)   path	'STORNO');

c01_w	c01%rowtype;


BEGIN
      intpd_reg_integracao_inicio(nr_sequencia_p, 'R', reg_integracao_w);

      begin
        delete	FROM intpd_log_recebimento
        where	nr_seq_fila = nr_sequencia_p;

        select	a.nr_seq_documento,
          coalesce(b.ie_conversao,'I'),
          b.nr_seq_sistema,
          b.nr_seq_projeto_xml,
          b.nr_seq_regra_conv,
          a.ds_xml_retorno,
          a.nr_seq_agrupador
        into STRICT	nr_seq_doc_origem_w,
          ie_conversao_w,
          nr_seq_sistema_w,
          nr_seq_projeto_xml_w,
          nr_seq_regra_w,
          ds_xml_w,
          nr_seq_agrupador_w
        from	intpd_fila_transmissao a,
          intpd_eventos_sistema b
        where	a.nr_seq_evento_sistema = b.nr_sequencia
        and	a.nr_sequencia = nr_sequencia_p;
      exception
        when others then
          null;
      end;

      ish_converter_response(nr_sequencia_p, ds_xml_w, ie_status_w, ie_tipo_erro_w, xml_w);

      if (ie_status_w = 'E') then
        update	intpd_fila_transmissao
        set	ie_status = ie_status_w,
          ie_tipo_erro = ie_tipo_erro_w,
          ie_response_procedure = 'S'
        where	nr_sequencia = nr_sequencia_p;
      else
        begin
          select a.payments
          into STRICT	 payments_w
          from	 xmltable(
              xmlnamespaces(
              'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
              'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
            'soapenv:Envelope/soapenv:Body/urn:Z_FI_INV_PAY_URECHResponse' passing xml_w columns
            payments xmltype path 'ET_PAYMENTS') a;

          open c01;
          loop
          fetch c01 into
                c01_w;
          EXIT WHEN NOT FOUND; /* apply on c01 */
            select	max(a.cd_pessoa_fisica)
              into STRICT  cd_pessoa_fisica_w
              from	pf_codigo_externo a
             where	a.cd_pessoa_fisica_externo = c01_w.custumernumber
               and	a.ie_tipo_codigo_externo = 'ISH'
               and	exists (SELECT 1
                              from pessoa_fisica x
                             where x.cd_pessoa_fisica = a.cd_pessoa_fisica);

            if (coalesce(cd_pessoa_fisica_w,'NULL') <> 'NULL') then
              select	*
              into STRICT	pessoa_fisica_w
              from	pessoa_fisica
              where	cd_pessoa_fisica = cd_pessoa_fisica_w;
            else
              pessoa_fisica_w.cd_pessoa_fisica	:=	null;
              pessoa_fisica_w.nm_usuario := null;
            end if;

            reg_integracao_w.nm_tabela		:=	'TITULO_RECEBER_LIQ';
            reg_integracao_w.nm_elemento	:=	'Z_FI_INV_PAY_URECHResponse';
            reg_integracao_w.nr_seq_visao	:=	0;

            intpd_processar_atributo(reg_integracao_w, 'NR_SEQUENCIA', c01_w.paymentid, 'N', settlement_items_w.posid);
            intpd_processar_atributo(reg_integracao_w, 'NR_TITULO', c01_w.billnumber, 'N', settlement_items_w.rechnr);
            intpd_processar_atributo(reg_integracao_w, 'DT_RECEBIMENTO', c01_w.documentdate, 'N', settlement_items_w.bldat);
            intpd_processar_atributo(reg_integracao_w, 'VL_RECEBIDO', c01_w.amount, 'N', settlement_items_w.betrag);
            intpd_processar_atributo(reg_integracao_w, 'CD_MOEDA', c01_w.localcurrency, 'N', settlement_items_w.waers);
            intpd_processar_atributo(reg_integracao_w, 'DS_BOSERVACAO', c01_w.invoicetext, 'N', settlement_items_w.postxt);
            if c01_w.cancel = 'N' then

              select cd_estabelecimento
                into STRICT cd_estabelecimento_w
                from titulo_receber 
               where nr_titulo = c01_w.billnumber;

              select NR_SEQ_TRANS_FIN_BAIXA 
                into STRICT nr_seq_trans_fin_w 
                from PARAMETRO_CONTAS_RECEBER 
               where cd_estabelecimento = cd_estabelecimento_w;
            
              select cd_tipo_recebimento 
                into STRICT cd_tipo_recebimento_w
                from transacao_financeira 
               where nr_sequencia = nr_seq_trans_fin_w;

              CALL baixa_titulo_receber(	
                cd_estabelecimento_w, 
                cd_tipo_recebimento_w,--transacao_financeira.cd_tipo_recebimento,
                c01_w.billnumber,
                nr_seq_trans_fin_w, --PARAMETRO_CONTAS_RECEBER.NR_SEQ_TRANS_FIN_BAIXA,
                c01_w.amount, 
                clock_timestamp(),
                pessoa_fisica_w.nm_usuario, 
                0,
                null, 
                null,
                0, 
                0);
            commit;
           else
            CALL cancelar_titulo_receber(c01_w.billnumber, pessoa_fisica_w.nm_usuario, 'S', c01_w.documentdate);
           end if;
          end loop;
          close c01;
        exception
        when others then
          begin

          rollback;
          update	intpd_fila_transmissao
          set	ie_status = 'E',
            ie_response_procedure = 'S'
          where	nr_sequencia = nr_sequencia_p;
          end;
        end;
      end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sap_fin_customer_pck.get_inv_settlement_response (nr_sequencia_p bigint) FROM PUBLIC;
