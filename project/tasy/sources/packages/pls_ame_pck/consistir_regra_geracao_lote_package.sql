-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ame_pck.consistir_regra_geracao_lote () AS $body$
DECLARE

	ie_existe_regra_arquivo_w	integer;

	obtem_regras_destino_cursor CURSOR FOR
		SELECT	nr_sequencia
		from	pls_ame_regra_ger_dest
		where	nr_seq_regra_geracao	= current_setting('pls_ame_pck.dados_regra_geracao_lote_rem_w')::pls_ame_regra_geracao%rowtype.nr_sequencia
		and	((current_setting('pls_ame_pck.dados_lote_remessa_w')::pls_ame_lote_remessa%coalesce(rowtype.nr_seq_regra_destino::text, '') = '') or (current_setting('pls_ame_pck.dados_lote_remessa_w')::pls_ame_lote_remessa%rowtype.nr_seq_regra_destino = nr_sequencia));

	type obtem_regras_destino_type is table of obtem_regras_destino_cursor%rowtype index by integer;

	regras_destino_w	obtem_regras_destino_type;
BEGIN

	open obtem_regras_destino_cursor;
	fetch obtem_regras_destino_cursor bulk collect into regras_destino_w;
	close obtem_regras_destino_cursor;

	if (regras_destino_w.count = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(283890,	'NM_REGRA=' || current_setting('pls_ame_pck.dados_regra_geracao_lote_rem_w')::pls_ame_regra_geracao%rowtype.nm_regra || ';' ||
								'NR_SEQ_LOTE_REMESSA=' || current_setting('pls_ame_pck.dados_lote_remessa_w')::pls_ame_lote_remessa%rowtype.nr_sequencia);
	else
	
		for i in regras_destino_w.first .. regras_destino_w.last loop
			begin
			select	1
			into STRICT	ie_existe_regra_arquivo_w
			
			where	exists (SELECT	1
					from	pls_ame_regra_ger_arq
					where	nr_seq_regra_ger_dest	= regras_destino_w[i].nr_sequencia);
			exception
				when others then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(283916, 'NR_SEQ_REGRA_GER_DEST=' || regras_destino_w[i].nr_sequencia || ';' ||
											'NM_REGRA=' || current_setting('pls_ame_pck.dados_regra_geracao_lote_rem_w')::pls_ame_regra_geracao%rowtype.nm_regra);
			end;
		end loop;
	end if;

	if (not current_setting('pls_ame_pck.is_liberacao_debito_w')::boolean) and (coalesce(current_setting('pls_ame_pck.dados_regra_geracao_lote_rem_w')::pls_ame_regra_geracao%rowtype.IE_LIBERACAO_DEBITO,'N') = 'S') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(317228);
	end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ame_pck.consistir_regra_geracao_lote () FROM PUBLIC;
