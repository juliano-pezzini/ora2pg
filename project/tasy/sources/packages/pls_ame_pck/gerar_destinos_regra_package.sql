-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ame_pck.gerar_destinos_regra () AS $body$
DECLARE


	regras_destinos CURSOR FOR
		SELECT	nr_seq_ame_empresa,
			nr_seq_ame_subsidiaria,
			nr_sequencia
		from	pls_ame_regra_ger_dest
		where	nr_seq_regra_geracao	= current_setting('pls_ame_pck.dados_lote_remessa_w')::pls_ame_lote_remessa%rowtype.nr_seq_regra_geracao
		and	((current_setting('pls_ame_pck.dados_lote_remessa_w')::pls_ame_lote_remessa%coalesce(rowtype.nr_seq_regra_destino::text, '') = '') or (current_setting('pls_ame_pck.dados_lote_remessa_w')::pls_ame_lote_remessa%rowtype.nr_seq_regra_destino = nr_sequencia));

	type destinos_table is table of regras_destinos%rowtype index by integer;

	destinos_w	destinos_table;

	nr_seq_lote_rem_dest_w	pls_ame_lote_rem_destino.nr_sequencia%type;

	qt_arquivos_destino_w	integer;

	cd_cgc_destino_w	pessoa_juridica.cd_cgc%type;

BEGIN

	open regras_destinos;
	fetch regras_destinos bulk collect into destinos_w;
	close regras_destinos;

	for i in destinos_w.first .. destinos_w.last loop
		begin

		select	max(nr_sequencia)
		into STRICT	nr_seq_lote_rem_dest_w
		from	pls_ame_lote_rem_destino
		where	nr_seq_lote_rem	= current_setting('pls_ame_pck.dados_lote_remessa_w')::pls_ame_lote_remessa%rowtype.nr_sequencia
		and	nr_seq_ame_empresa	= destinos_w[i].nr_seq_ame_empresa
		and	((nr_seq_ame_subsidiaria	= destinos_w[i].nr_seq_ame_subsidiaria) or (destinos_w[i]coalesce(.nr_seq_ame_subsidiaria::text, '') = '' and coalesce(nr_seq_ame_subsidiaria::text, '') = ''));

		if (coalesce(nr_seq_lote_rem_dest_w::text, '') = '') then
			select	nextval('pls_ame_lote_rem_destino_seq')
			into STRICT	nr_seq_lote_rem_dest_w
			;

			insert into pls_ame_lote_rem_destino(	nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								nr_seq_lote_rem,
								nr_seq_ame_empresa,
								nr_seq_ame_subsidiaria,
								vl_total)
			values (				nr_seq_lote_rem_dest_w,
								clock_timestamp(),
								get_nm_usuario,
								current_setting('pls_ame_pck.dados_lote_remessa_w')::pls_ame_lote_remessa%rowtype.nr_sequencia,
								destinos_w[i].nr_seq_ame_empresa,
								destinos_w[i].nr_seq_ame_subsidiaria,
								0);
		end if;

		if (destinos_w[i](.nr_seq_ame_subsidiaria IS NOT NULL AND .nr_seq_ame_subsidiaria::text <> '')) then
			select	cd_cgc
			into STRICT	cd_cgc_destino_w
			from	pls_ame_subsidiaria
			where	nr_sequencia = destinos_w[i].nr_seq_ame_subsidiaria;
		elsif (destinos_w[i](.nr_seq_ame_empresa IS NOT NULL AND .nr_seq_ame_empresa::text <> '')) then
			select	cd_cgc
			into STRICT	cd_cgc_destino_w
			from	pls_ame_empresa
			where	nr_sequencia = destinos_w[i].nr_seq_ame_empresa;
		end if;

		CALL pls_ame_pck.gerar_arquivos_destino(destinos_w[i].nr_sequencia, nr_seq_lote_rem_dest_w, cd_cgc_destino_w);

		select	count(1)
		into STRICT	qt_arquivos_destino_w
		from	pls_ame_lote_rem_arquivo
		where	nr_seq_lote_rem_dest	= nr_seq_lote_rem_dest_w;

		if (qt_arquivos_destino_w = 0) then
			delete	FROM pls_ame_lote_rem_destino
			where	nr_sequencia	= nr_seq_lote_rem_dest_w;
		end if;

		end;
	end loop;
	destinos_w.delete;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ame_pck.gerar_destinos_regra () FROM PUBLIC;
