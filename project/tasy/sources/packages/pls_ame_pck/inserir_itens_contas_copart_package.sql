-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ame_pck.inserir_itens_contas_copart ( nr_seq_regra_ger_arq_p pls_ame_regra_ger_arq.nr_sequencia%type, nr_seq_rem_valor_detalhe_p bigint, nr_seq_mensalidade_seg_p bigint, nr_seq_conta_p bigint, nr_seq_conta_copartic_p bigint, ie_tipo_item_p text, nr_seq_item_mens_p bigint, ie_liberacao_debito_p text, nr_seq_centro_apropriacao_p bigint) AS $body$
DECLARE


vl_coparticipacao_w			pls_conta_coparticipacao.vl_coparticipacao%type;
cd_proced_mat_w				pls_ame_lote_rem_valor_cop.cd_proced_mat%type;
ds_proced_mat_w				pls_ame_lote_rem_valor_cop.ds_proced_mat%type;
ds_prestador_exec_w			pls_ame_lote_rem_valor_cop.ds_prestador_exec%type;
qt_copartic_w				bigint;
current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%type			bigint;
current_setting('pls_ame_pck.qt_registros_w')::bigint				bigint;
vl_baixa_centro_aprop_w			double precision;
vl_total_aprop_w			double precision;

current_setting('pls_ame_pck.c01')::CURSOR( CURSOR FOR
	SELECT	b.nr_sequencia 	nr_seq_conta_coparticipacao,
		null		nr_seq_conta_pos_estab,
		null		nr_seq_conta_co,
		null		nr_seq_tx_atend,
		d.vl_item	vl_coparticipacao,
		b.nr_seq_conta_mat,
		b.nr_seq_conta_proc,
		coalesce(a.dt_atendimento,a.dt_emissao) dt_atendimento,
		coalesce(a.nr_seq_prestador_exec,c.nr_seq_prestador) nr_seq_prestador,
		b.qt_liberada_copartic,
		c.nr_seq_congenere,
		null vl_baixa_copartic,
		d.nr_sequencia nr_seq_item_conta
	from	pls_conta_coparticipacao	b,
		pls_conta			a,
		pls_protocolo_conta		c,
		pls_mensalidade_item_conta	d
	where	b.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_protocolo		= c.nr_sequencia
	and	b.nr_sequencia			= d.nr_seq_conta_copartic
	and	b.nr_seq_conta			= nr_seq_conta_p
	and	((coalesce(nr_seq_item_mens_p::text, '') = '') or (d.nr_seq_item = nr_seq_item_mens_p))
	and	((coalesce(nr_seq_conta_copartic_p::text, '') = '') or (b.nr_sequencia = nr_seq_conta_copartic_p))
	and	coalesce(b.ie_cobrar_mensalidade,'S') 	= 'S'
	and	coalesce(b.ie_status_mensalidade,'L') in ('L','G')
	and	coalesce(b.ie_status_coparticipacao,'S') 	= 'S'
	and	not exists (	SELECT	1
				from	pls_ame_lote_rem_valor_cop	t,
					pls_ame_lote_rem_valor_det	u,
					pls_ame_lote_rem_valor		v,
					pls_ame_lote_rem_arquivo	w,
					pls_ame_lote_rem_destino	x,
					pls_ame_lote_remessa		y,
					pls_ame_regra_geracao		z
				where	t.nr_seq_conta_coparticipacao	= b.nr_sequencia
				and	t.nr_seq_rem_valor_detalhe	= u.nr_sequencia
				and	u.nr_seq_lote_rem_valor		= v.nr_sequencia
				and	v.nr_seq_lote_rem_arq		= w.nr_sequencia
				and	w.nr_seq_lote_rem_dest		= x.nr_sequencia
				and	x.nr_seq_lote_rem		= y.nr_sequencia
				and	y.nr_seq_regra_geracao		= z.nr_sequencia
				and	coalesce(z.ie_liberacao_debito,'N') = 'S')
	and	coalesce(current_setting('pls_ame_pck.dados_regra_geracao_lote_rem_w')::pls_ame_regra_geracao%rowtype.ie_origem_informacao, '1') = '1'
	and	ie_tipo_item_p = '3'
	and 	ie_liberacao_debito_p = 'N'
	
union all

	select	b.nr_sequencia 	nr_seq_conta_coparticipacao,
		null		nr_seq_conta_pos_estab,
		null		nr_seq_conta_co,
		null		nr_seq_tx_atend,
		b.vl_coparticipacao vl_coparticipacao,
		b.nr_seq_conta_mat,
		b.nr_seq_conta_proc,
		coalesce(a.dt_atendimento,a.dt_emissao) dt_atendimento,
		coalesce(a.nr_seq_prestador_exec,c.nr_seq_prestador) nr_seq_prestador,
		b.qt_liberada_copartic,
		c.nr_seq_congenere,
		(select coalesce(sum(mic.vl_item), 0)
		from 	pls_mensalidade_item_conta mic,
			pls_mensalidade_seg_item msi,
			pls_mensalidade_segurado ms,
			pls_mensalidade m
		where 	msi.nr_sequencia 	= mic.nr_seq_item
		and	ms.nr_sequencia		= msi.nr_seq_mensalidade_seg
		and	m.nr_sequencia		= ms.nr_seq_mensalidade
		and	mic.nr_seq_conta_copartic = b.nr_sequencia
		and	coalesce(m.ie_cancelamento::text, '') = '') vl_baixa_copartic,
		null nr_seq_item_conta
	from	pls_conta_coparticipacao	b,
		pls_conta			a,
		pls_protocolo_conta		c
	where	b.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_protocolo		= c.nr_sequencia
	and	b.nr_seq_conta			= nr_seq_conta_p
	and	coalesce(b.ie_cobrar_mensalidade,'S') 	= 'S'
	and	coalesce(b.ie_status_mensalidade,'L') in ('L','G')
	and	coalesce(b.ie_status_coparticipacao,'S') 	= 'S'
	and	not exists (	select	1
				from	pls_ame_lote_rem_valor_cop	t,
					pls_ame_lote_rem_valor_det	u,
					pls_ame_lote_rem_valor		v,
					pls_ame_lote_rem_arquivo	w,
					pls_ame_lote_rem_destino	x,
					pls_ame_lote_remessa		y,
					pls_ame_regra_geracao		z
				where	t.nr_seq_conta_coparticipacao	= b.nr_sequencia
				and	t.nr_seq_rem_valor_detalhe	= u.nr_sequencia
				and	u.nr_seq_lote_rem_valor		= v.nr_sequencia
				and	v.nr_seq_lote_rem_arq		= w.nr_sequencia
				and	w.nr_seq_lote_rem_dest		= x.nr_sequencia
				and	x.nr_seq_lote_rem		= y.nr_sequencia
				and	y.nr_seq_regra_geracao		= z.nr_sequencia
				and	coalesce(z.ie_liberacao_debito,'N') = 'S')
	and	coalesce(current_setting('pls_ame_pck.dados_regra_geracao_lote_rem_w')::pls_ame_regra_geracao%rowtype.ie_origem_informacao, '1') = '1'
	and	ie_tipo_item_p = '3'
	and 	((ie_liberacao_debito_p = 'S') and (coalesce(b.nr_seq_mensalidade_seg::text, '') = ''))
	
union all

	select	b.nr_sequencia 	nr_seq_conta_coparticipacao,
		null		nr_seq_conta_pos_estab,
		null		nr_seq_conta_co,
		null		nr_seq_tx_atend,
		b.vl_coparticipacao,
		b.nr_seq_conta_mat,
		b.nr_seq_conta_proc,
		coalesce(a.dt_atendimento,a.dt_emissao) dt_atendimento,
		coalesce(a.nr_seq_prestador_exec,c.nr_seq_prestador) nr_seq_prestador,
		b.qt_liberada_copartic,
		c.nr_seq_congenere,
		(select coalesce(sum(mic.vl_item), 0)
		from 	pls_mensalidade_item_conta mic,
			pls_mensalidade_seg_item msi,
			pls_mensalidade_segurado ms,
			pls_mensalidade m
		where 	msi.nr_sequencia 	= mic.nr_seq_item
		and	ms.nr_sequencia		= msi.nr_seq_mensalidade_seg
		and	m.nr_sequencia		= ms.nr_seq_mensalidade
		and	mic.nr_seq_conta_copartic = b.nr_sequencia
		and	coalesce(m.ie_cancelamento::text, '') = '') vl_baixa_copartic,
		null nr_seq_item_conta
	from	pls_conta_coparticipacao	b,
		pls_conta			a,
		pls_protocolo_conta		c
	where	b.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_protocolo		= c.nr_sequencia
	and	b.nr_seq_conta			= nr_seq_conta_p
	and	((nr_seq_mensalidade_seg_p IS NOT NULL AND nr_seq_mensalidade_seg_p::text <> '' AND b.nr_seq_mensalidade_seg = nr_seq_mensalidade_seg_p) or (coalesce(nr_seq_mensalidade_seg_p::text, '') = ''))
	and	((coalesce(nr_seq_conta_copartic_p::text, '') = '') or (b.nr_sequencia = nr_seq_conta_copartic_p))
	and	coalesce(b.ie_cobrar_mensalidade,'S') 	= 'S'
	and	coalesce(b.ie_status_mensalidade,'L') in ('L','G')
	and	coalesce(b.ie_status_coparticipacao,'S') 	= 'S'
	and	not exists (	select	1
				from	pls_ame_lote_rem_valor_cop	t,
					pls_ame_lote_rem_valor_det	u,
					pls_ame_lote_rem_valor		v,
					pls_ame_lote_rem_arquivo	w,
					pls_ame_lote_rem_destino	x,
					pls_ame_lote_remessa		y,
					pls_ame_regra_geracao		z
				where	t.nr_seq_conta_coparticipacao	= b.nr_sequencia
				and	t.nr_seq_rem_valor_detalhe	= u.nr_sequencia
				and	u.nr_seq_lote_rem_valor		= v.nr_sequencia
				and	v.nr_seq_lote_rem_arq		= w.nr_sequencia
				and	w.nr_seq_lote_rem_dest		= x.nr_sequencia
				and	x.nr_seq_lote_rem		= y.nr_sequencia
				and	y.nr_seq_regra_geracao		= z.nr_sequencia
				and	coalesce(z.ie_liberacao_debito,'N') = 'S')
	and	coalesce(current_setting('pls_ame_pck.dados_regra_geracao_lote_rem_w')::pls_ame_regra_geracao%rowtype.ie_origem_informacao, '1') = '2'
	and	exists (select	1
			from	pls_conta_coparticipacao x,
				pls_lib_coparticipacao y,
				pls_lote_coparticipacao z
			where	x.nr_Sequencia = b.nr_Sequencia
			and	x.nr_Sequencia = y.nr_seq_conta_coparticipacao
			and	z.nr_Sequencia = y.nr_seq_lote
			and	z.dt_competencia = dados_lote_remessa_w.dt_ref_mensalidade)
	and	ie_tipo_item_p = '3'
	and 	((ie_liberacao_debito_p = 'N') or ((ie_liberacao_debito_p= 'S') and (coalesce(b.nr_seq_mensalidade_seg::text, '') = '')))
	
union all

	select	null nr_seq_conta_coparticipacao,
		b.nr_sequencia	nr_seq_conta_pos_estab,
		null		nr_seq_conta_co,
		null		nr_seq_tx_atend,
		d.vl_item,
		b.nr_seq_conta_mat,
		b.nr_seq_conta_proc,
		coalesce(a.dt_atendimento,a.dt_emissao) dt_atendimento,
		coalesce(a.nr_seq_prestador_exec,c.nr_seq_prestador) nr_seq_prestador,
		(select	d.qt_procedimento
		from	pls_conta_proc d
		where	d.nr_sequencia = b.nr_seq_conta_proc
		
union	all

		select	e.qt_material
		from	pls_conta_mat e
		where	e.nr_sequencia = b.nr_seq_conta_mat)	qt_liberada_copartic,
		c.nr_seq_congenere,
		null vl_baixa_copartic,
		d.nr_sequencia nr_seq_item_conta
	from	pls_conta_pos_estabelecido	b,
		pls_conta			a,
		pls_protocolo_conta		c,
		pls_mensalidade_item_conta	d
	where	b.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_protocolo		= c.nr_sequencia
	and	b.nr_sequencia			= d.nr_seq_conta_pos_estab
	and	b.nr_seq_conta			= nr_seq_conta_p
	and	((coalesce(nr_seq_item_mens_p::text, '') = '') or (d.nr_seq_item = nr_seq_item_mens_p))
	and	((coalesce(nr_seq_conta_copartic_p::text, '') = '') or (b.nr_sequencia = nr_seq_conta_copartic_p))
	and	coalesce(b.ie_cobrar_mensalidade,'S') = 'S'
	and	not exists (	select	1
				from	pls_ame_lote_rem_valor_cop	t,
					pls_ame_lote_rem_valor_det	u,
					pls_ame_lote_rem_valor		v,
					pls_ame_lote_rem_arquivo	w,
					pls_ame_lote_rem_destino	x,
					pls_ame_lote_remessa		y,
					pls_ame_regra_geracao		z
				where	t.nr_seq_conta_pos_estab	= b.nr_sequencia
				and	t.nr_seq_rem_valor_detalhe	= u.nr_sequencia
				and	u.nr_seq_lote_rem_valor		= v.nr_sequencia
				and	v.nr_seq_lote_rem_arq		= w.nr_sequencia
				and	w.nr_seq_lote_rem_dest		= x.nr_sequencia
				and	x.nr_seq_lote_rem		= y.nr_sequencia
				and	y.nr_seq_regra_geracao		= z.nr_sequencia
				and	coalesce(z.ie_liberacao_debito,'N') = 'S')
	and	ie_tipo_item_p in ('6','7')
	and 	ie_liberacao_debito_p = 'N'
	
union all

	select	null nr_seq_conta_coparticipacao,
		b.nr_sequencia	nr_seq_conta_pos_estab,
		null		nr_seq_conta_co,
		null		nr_seq_tx_atend,
		b.vl_beneficiario,
		b.nr_seq_conta_mat,
		b.nr_seq_conta_proc,
		coalesce(a.dt_atendimento,a.dt_emissao) dt_atendimento,
		coalesce(a.nr_seq_prestador_exec,c.nr_seq_prestador) nr_seq_prestador,
		(	select	d.qt_procedimento
			from	pls_conta_proc d
			where	d.nr_sequencia = b.nr_seq_conta_proc
			
union	all

			select	e.qt_material
			from	pls_conta_mat e
			where	e.nr_sequencia = b.nr_seq_conta_mat)	qt_liberada_copartic,
		c.nr_seq_congenere,
		(select coalesce(sum(mic.vl_item), 0)
		from 	pls_mensalidade_item_conta mic,
			pls_mensalidade_seg_item msi,
			pls_mensalidade_segurado ms,
			pls_mensalidade m
		where 	msi.nr_sequencia 	= mic.nr_seq_item
		and	ms.nr_sequencia		= msi.nr_seq_mensalidade_seg
		and	m.nr_sequencia		= ms.nr_seq_mensalidade
		and	mic.nr_seq_conta_pos_estab = b.nr_sequencia
		and	coalesce(m.ie_cancelamento::text, '') = '') vl_baixa_copartic,
		null nr_seq_item_conta
	from	pls_conta_pos_estabelecido	b,
		pls_conta			a,
		pls_protocolo_conta		c
	where	b.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_protocolo		= c.nr_sequencia
	and	b.nr_seq_conta			= nr_seq_conta_p
	and	coalesce(b.ie_cobrar_mensalidade,'S') = 'S'
	and	not exists (	select	1
				from	pls_ame_lote_rem_valor_cop	t,
					pls_ame_lote_rem_valor_det	u,
					pls_ame_lote_rem_valor		v,
					pls_ame_lote_rem_arquivo	w,
					pls_ame_lote_rem_destino	x,
					pls_ame_lote_remessa		y,
					pls_ame_regra_geracao		z
				where	t.nr_seq_conta_pos_estab	= b.nr_sequencia
				and	t.nr_seq_rem_valor_detalhe	= u.nr_sequencia
				and	u.nr_seq_lote_rem_valor		= v.nr_sequencia
				and	v.nr_seq_lote_rem_arq		= w.nr_sequencia
				and	w.nr_seq_lote_rem_dest		= x.nr_sequencia
				and	x.nr_seq_lote_rem		= y.nr_sequencia
				and	y.nr_seq_regra_geracao		= z.nr_sequencia
				and	coalesce(z.ie_liberacao_debito,'N') = 'S')
	and	ie_tipo_item_p in ('6','7')
	and 	((ie_liberacao_debito_p = 'S') and (coalesce(b.nr_seq_mensalidade_seg::text, '') = ''))
	
union all

	select	null		nr_seq_conta_coparticipacao,
		null		nr_seq_conta_pos_estab,
		b.nr_sequencia	nr_seq_conta_co,
		null		nr_seq_tx_atend,
		d.vl_item,
		b.nr_seq_conta_mat,
		b.nr_seq_conta_proc,
		coalesce(a.dt_atendimento,a.dt_emissao) dt_atendimento,
		coalesce(a.nr_seq_prestador_exec,c.nr_seq_prestador) nr_seq_prestador,
		(select	d.qt_procedimento
		from	pls_conta_proc d
		where	d.nr_sequencia = b.nr_seq_conta_proc
		
union	all

		select	e.qt_material
		from	pls_conta_mat e
		where	e.nr_sequencia = b.nr_seq_conta_mat)	qt_liberada_copartic,
		c.nr_seq_congenere,
		null vl_baixa_copartic,
		d.nr_sequencia nr_seq_item_conta
	from	pls_conta_co			b,
		pls_conta			a,
		pls_protocolo_conta		c,
		pls_mensalidade_item_conta	d
	where	b.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_protocolo		= c.nr_sequencia
	and	b.nr_sequencia			= d.nr_seq_conta_co
	and	b.nr_seq_conta			= nr_seq_conta_p
	and	((coalesce(nr_seq_item_mens_p::text, '') = '') or (d.nr_seq_item = nr_seq_item_mens_p))
	and	((coalesce(nr_seq_conta_copartic_p::text, '') = '') or (b.nr_sequencia = nr_seq_conta_copartic_p))
	and	coalesce(b.ie_cobrar_mensalidade,'S') = 'S'
	and	not exists (	select	1
				from	pls_ame_lote_rem_valor_cop	t,
					pls_ame_lote_rem_valor_det	u,
					pls_ame_lote_rem_valor		v,
					pls_ame_lote_rem_arquivo	w,
					pls_ame_lote_rem_destino	x,
					pls_ame_lote_remessa		y,
					pls_ame_regra_geracao		z
				where	t.nr_seq_conta_co		= b.nr_sequencia
				and	t.nr_seq_rem_valor_detalhe 	= u.nr_sequencia
				and	u.nr_seq_lote_rem_valor		= v.nr_sequencia
				and	v.nr_seq_lote_rem_arq		= w.nr_sequencia
				and	w.nr_seq_lote_rem_dest		= x.nr_sequencia
				and	x.nr_seq_lote_rem		= y.nr_sequencia
				and	y.nr_seq_regra_geracao		= z.nr_sequencia
				and	coalesce(z.ie_liberacao_debito,'N') = 'S')
	and	ie_tipo_item_p = '13'
	and 	ie_liberacao_debito_p = 'N'
	
union all

	select	null		nr_seq_conta_coparticipacao,
		null		nr_seq_conta_pos_estab,
		b.nr_sequencia	nr_seq_conta_co,
		null		nr_seq_tx_atend,
		b.vl_beneficiario,
		b.nr_seq_conta_mat,
		b.nr_seq_conta_proc,
		coalesce(a.dt_atendimento,a.dt_emissao) dt_atendimento,
		coalesce(a.nr_seq_prestador_exec,c.nr_seq_prestador) nr_seq_prestador,
		(select	d.qt_procedimento
		from	pls_conta_proc d
		where	d.nr_sequencia = b.nr_seq_conta_proc
		
union	all

		select	e.qt_material
		from	pls_conta_mat e
		where	e.nr_sequencia = b.nr_seq_conta_mat)	qt_liberada_copartic,
		c.nr_seq_congenere,
		(select coalesce(sum(mic.vl_item), 0)
		from 	pls_mensalidade_item_conta mic,
			pls_mensalidade_seg_item msi,
			pls_mensalidade_segurado ms,
			pls_mensalidade m
		where 	msi.nr_sequencia 	= mic.nr_seq_item
		and	ms.nr_sequencia		= msi.nr_seq_mensalidade_seg
		and	m.nr_sequencia		= ms.nr_seq_mensalidade
		and	mic.nr_seq_conta_co	= b.nr_sequencia
		and	coalesce(m.ie_cancelamento::text, '') = '') vl_baixa_copartic,
		null nr_seq_item_conta
	from	pls_conta_co			b,
		pls_conta			a,
		pls_protocolo_conta		c
	where	b.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_protocolo		= c.nr_sequencia
	and	b.nr_seq_conta			= nr_seq_conta_p
	and	coalesce(b.ie_cobrar_mensalidade,'S') = 'S'
	and	not exists (	select	1
				from	pls_ame_lote_rem_valor_cop	t,
					pls_ame_lote_rem_valor_det	u,
					pls_ame_lote_rem_valor		v,
					pls_ame_lote_rem_arquivo	w,
					pls_ame_lote_rem_destino	x,
					pls_ame_lote_remessa		y,
					pls_ame_regra_geracao		z
				where	t.nr_seq_conta_co		= b.nr_sequencia
				and	t.nr_seq_rem_valor_detalhe 	= u.nr_sequencia
				and	u.nr_seq_lote_rem_valor		= v.nr_sequencia
				and	v.nr_seq_lote_rem_arq		= w.nr_sequencia
				and	w.nr_seq_lote_rem_dest		= x.nr_sequencia
				and	x.nr_seq_lote_rem		= y.nr_sequencia
				and	y.nr_seq_regra_geracao		= z.nr_sequencia
				and	coalesce(z.ie_liberacao_debito,'N') = 'S')
	and	ie_tipo_item_p = '13'
	and 	((ie_liberacao_debito_p = 'S') and (coalesce(b.nr_seq_mensalidade_seg::text, '') = ''))
	
union all

	select	null		nr_seq_conta_coparticipacao,
		null		nr_seq_conta_pos_estab,
		null		nr_seq_conta_co,
		b.nr_sequencia	nr_seq_tx_atend,
		b.vl_liberado,
		b.nr_seq_conta_mat,
		b.nr_seq_conta_proc,
		coalesce(a.dt_atendimento,a.dt_emissao) dt_atendimento,
		coalesce(a.nr_seq_prestador_exec,c.nr_seq_prestador) nr_seq_prestador,
		1 qt_liberada_copartic,
		c.nr_seq_congenere,
		null vl_baixa_copartic,
		null nr_seq_item_conta
	from	pls_conta_val_atend		b,
		pls_conta			a,
		pls_protocolo_conta		c
	where	b.nr_seq_conta			= a.nr_sequencia
	and	a.nr_seq_protocolo		= c.nr_sequencia
	and	b.nr_seq_conta			= nr_seq_conta_p
	and	((nr_seq_mensalidade_seg_p IS NOT NULL AND nr_seq_mensalidade_seg_p::text <> '' AND b.nr_seq_mensalidade_seg = nr_seq_mensalidade_seg_p) or (coalesce(nr_seq_mensalidade_seg_p::text, '') = ''))
	and	((coalesce(nr_seq_conta_copartic_p::text, '') = '') or (b.nr_sequencia = nr_seq_conta_copartic_p))
	and	coalesce(b.ie_cobrar_mensalidade,'S') = 'S'
	and	not exists (	select	1
				from	pls_ame_lote_rem_valor_cop	t,
					pls_ame_lote_rem_valor_det	u,
					pls_ame_lote_rem_valor		v,
					pls_ame_lote_rem_arquivo	w,
					pls_ame_lote_rem_destino	x,
					pls_ame_lote_remessa		y,
					pls_ame_regra_geracao		z
				where	t.nr_seq_conta_coparticipacao	= b.nr_sequencia
				and	t.nr_seq_rem_valor_detalhe	= u.nr_sequencia
				and	u.nr_seq_lote_rem_valor		= v.nr_sequencia
				and	v.nr_seq_lote_rem_arq		= w.nr_sequencia
				and	w.nr_seq_lote_rem_dest		= x.nr_sequencia
				and	x.nr_seq_lote_rem		= y.nr_sequencia
				and	y.nr_seq_regra_geracao		= z.nr_sequencia
				and	coalesce(z.ie_liberacao_debito,'N') = 'S')
	and	ie_tipo_item_p = '38';

BEGIN

for r_c01_w in current_setting('pls_ame_pck.c01')::CURSOR( loop
	begin

	PERFORM set_config('pls_ame_pck.nr_seq_regra_ger_item_w', pls_ame_pck.obter_regra_geracao_item(nr_seq_regra_ger_arq_p, ie_tipo_item_p), false);

	select	count(1)
	into STRICT	current_setting('pls_ame_pck.qt_registros_w')::bigint
	from	pls_ame_regra_ger_item_apr
	where	nr_seq_regra_item = current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%type;

	if (ie_liberacao_debito_p = 'S') then
		vl_coparticipacao_w	:= r_c01_w.vl_coparticipacao - r_c01_w.vl_baixa_copartic;

		if (current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%(type IS NOT NULL AND type::text <> '')) then
			if (ie_tipo_item_p = '3') then
				if (current_setting('pls_ame_pck.qt_registros_w')::bigint > 0) then
					select	coalesce(sum(b.vl_apropriacao), 0)
					into STRICT	vl_baixa_centro_aprop_w
					from	pls_mensalidade_item_conta a,
						pls_mens_item_conta_aprop b,
						pls_mensalidade_seg_item c,
						pls_mensalidade_segurado d,
						pls_mensalidade e
					where	a.nr_sequencia = b.nr_seq_mens_item_conta
					and	a.nr_seq_conta_copartic = r_c01_w.nr_seq_conta_coparticipacao
					and	e.nr_sequencia = d.nr_seq_mensalidade
					and	d.nr_sequencia = c.nr_seq_mensalidade_seg
					and	c.nr_sequencia = a.nr_seq_item
					and	coalesce(e.ie_cancelamento::text, '') = ''
					and	b.nr_seq_centro_apropriacao in (SELECT 	nr_seq_centro_apropriacao
										from	pls_ame_regra_ger_item_apr
										where	nr_seq_regra_item = current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%type);

					select	coalesce(sum(a.vl_apropriacao), 0)
					into STRICT	vl_total_aprop_w
					from	pls_conta_copartic_aprop a
					where	a.nr_seq_conta_coparticipacao = r_c01_w.nr_seq_conta_coparticipacao
					and	a.nr_seq_centro_apropriacao in (SELECT 	nr_seq_centro_apropriacao
										from	pls_ame_regra_ger_item_apr
										where	nr_seq_regra_item = current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%type);
				else
					select	coalesce(sum(b.vl_apropriacao), 0)
					into STRICT	vl_baixa_centro_aprop_w
					from	pls_mensalidade_item_conta a,
						pls_mens_item_conta_aprop b,
						pls_mensalidade_seg_item c,
						pls_mensalidade_segurado d,
						pls_mensalidade e
					where	a.nr_sequencia = b.nr_seq_mens_item_conta
					and	a.nr_seq_conta_copartic = r_c01_w.nr_seq_conta_coparticipacao
					and	e.nr_sequencia = d.nr_seq_mensalidade
					and	d.nr_sequencia = c.nr_seq_mensalidade_seg
					and	c.nr_sequencia = a.nr_seq_item
					and	coalesce(e.ie_cancelamento::text, '') = '';

					select	coalesce(sum(a.vl_apropriacao), 0)
					into STRICT	vl_total_aprop_w
					from	pls_conta_copartic_aprop a
					where	a.nr_seq_conta_coparticipacao = r_c01_w.nr_seq_conta_coparticipacao;
				end if;

				vl_coparticipacao_w	:= vl_total_aprop_w - vl_baixa_centro_aprop_w;
			elsif (ie_tipo_item_p = '6') then
				if (current_setting('pls_ame_pck.qt_registros_w')::bigint > 0) then
					select	coalesce(sum(b.vl_apropriacao), 0)
					into STRICT	vl_baixa_centro_aprop_w
					from	pls_mensalidade_item_conta a,
						pls_mens_item_conta_aprop b,
						pls_mensalidade_seg_item c,
						pls_mensalidade_segurado d,
						pls_mensalidade e
					where	a.nr_sequencia = b.nr_seq_mens_item_conta
					and	a.nr_seq_conta_pos_estab = r_c01_w.nr_seq_conta_pos_estab
					and	e.nr_sequencia = d.nr_seq_mensalidade
					and	d.nr_sequencia = c.nr_seq_mensalidade_seg
					and	c.nr_sequencia = a.nr_seq_item
					and	coalesce(e.ie_cancelamento::text, '') = ''
					and	b.nr_seq_centro_apropriacao in (SELECT 	nr_seq_centro_apropriacao
										from	pls_ame_regra_ger_item_apr
										where	nr_seq_regra_item = current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%type);

					select	coalesce(sum(a.vl_apropriacao), 0)
					into STRICT	vl_total_aprop_w
					from	pls_conta_pos_estab_aprop a
					where	a.nr_seq_conta_pos_estab = r_c01_w.nr_seq_conta_pos_estab
					and	a.nr_seq_centro_apropriacao in (SELECT 	nr_seq_centro_apropriacao
										from	pls_ame_regra_ger_item_apr
										where	nr_seq_regra_item = current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%type);
				else
					select	coalesce(sum(b.vl_apropriacao), 0)
					into STRICT	vl_baixa_centro_aprop_w
					from	pls_mensalidade_item_conta a,
						pls_mens_item_conta_aprop b,
						pls_mensalidade_seg_item c,
						pls_mensalidade_segurado d,
						pls_mensalidade e
					where	a.nr_sequencia = b.nr_seq_mens_item_conta
					and	a.nr_seq_conta_pos_estab = r_c01_w.nr_seq_conta_pos_estab
					and	e.nr_sequencia = d.nr_seq_mensalidade
					and	d.nr_sequencia = c.nr_seq_mensalidade_seg
					and	c.nr_sequencia = a.nr_seq_item
					and	coalesce(e.ie_cancelamento::text, '') = '';

					select	coalesce(sum(a.vl_apropriacao), 0)
					into STRICT	vl_total_aprop_w
					from	pls_conta_pos_estab_aprop a
					where	a.nr_seq_conta_pos_estab = r_c01_w.nr_seq_conta_pos_estab;
				end if;

				vl_coparticipacao_w	:= vl_total_aprop_w - vl_baixa_centro_aprop_w;
			elsif (ie_tipo_item_p = '13') then
				if (current_setting('pls_ame_pck.qt_registros_w')::bigint > 0) then
					select	coalesce(sum(b.vl_apropriacao), 0)
					into STRICT	vl_baixa_centro_aprop_w
					from	pls_mensalidade_item_conta a,
						pls_mens_item_conta_aprop b,
						pls_mensalidade_seg_item c,
						pls_mensalidade_segurado d,
						pls_mensalidade e
					where	a.nr_sequencia = b.nr_seq_mens_item_conta
					and	a.nr_seq_conta_co = r_c01_w.nr_seq_conta_co
					and	e.nr_sequencia = d.nr_seq_mensalidade
					and	d.nr_sequencia = c.nr_seq_mensalidade_seg
					and	c.nr_sequencia = a.nr_seq_item
					and	coalesce(e.ie_cancelamento::text, '') = ''
					and	b.nr_seq_centro_apropriacao in (SELECT 	nr_seq_centro_apropriacao
										from	pls_ame_regra_ger_item_apr
										where	nr_seq_regra_item = current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%type);

					select	coalesce(sum(a.vl_apropriacao), 0)
					into STRICT	vl_total_aprop_w
					from	pls_conta_co_aprop a
					where	a.nr_seq_conta_co = r_c01_w.nr_seq_conta_co
					and	a.nr_seq_centro_apropriacao in (SELECT 	nr_seq_centro_apropriacao
										from	pls_ame_regra_ger_item_apr
										where	nr_seq_regra_item = current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%type);
				else
					select	coalesce(sum(b.vl_apropriacao), 0)
					into STRICT	vl_baixa_centro_aprop_w
					from	pls_mensalidade_item_conta a,
						pls_mens_item_conta_aprop b,
						pls_mensalidade_seg_item c,
						pls_mensalidade_segurado d,
						pls_mensalidade e
					where	a.nr_sequencia = b.nr_seq_mens_item_conta
					and	a.nr_seq_conta_co = r_c01_w.nr_seq_conta_co
					and	e.nr_sequencia = d.nr_seq_mensalidade
					and	d.nr_sequencia = c.nr_seq_mensalidade_seg
					and	c.nr_sequencia = a.nr_seq_item
					and	coalesce(e.ie_cancelamento::text, '') = '';

					select	coalesce(sum(a.vl_apropriacao), 0)
					into STRICT	vl_total_aprop_w
					from	pls_conta_co_aprop a
					where	a.nr_seq_conta_co = r_c01_w.nr_seq_conta_co;
				end if;

				vl_coparticipacao_w	:= vl_total_aprop_w - vl_baixa_centro_aprop_w;
			else
				vl_coparticipacao_w	:= coalesce(pls_ame_pck.obter_valor_apropriacao(	nr_seq_regra_ger_arq_p, ie_tipo_item_p, nr_seq_item_mens_p,
											nr_seq_mensalidade_seg_p, r_c01_w.nr_seq_conta_coparticipacao, r_c01_w.vl_coparticipacao,
											null, null, nr_seq_conta_p,
											r_c01_w.nr_seq_conta_proc, r_c01_w.nr_seq_conta_mat, r_c01_w.nr_seq_conta_pos_estab),0);
			end if;
		end if;
	else
		vl_coparticipacao_w	:= r_c01_w.vl_coparticipacao;

		if	((nr_seq_centro_apropriacao_p IS NOT NULL AND nr_seq_centro_apropriacao_p::text <> '') and ((current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%(type IS NOT NULL AND type::text <> '')) or (current_setting('pls_ame_pck.dados_regra_geracao_lote_rem_w')::pls_ame_regra_geracao%rowtype.ie_item_apropriacao = 'S'))) then
			if (coalesce(r_c01_w.nr_seq_item_conta::text, '') = '') then
				vl_coparticipacao_w	:= coalesce(pls_ame_pck.obter_valor_apropriacao(	nr_seq_regra_ger_arq_p, ie_tipo_item_p, nr_seq_item_mens_p,
											nr_seq_mensalidade_seg_p, r_c01_w.nr_seq_conta_coparticipacao, r_c01_w.vl_coparticipacao,
											null, null, nr_seq_conta_p,
											r_c01_w.nr_seq_conta_proc, r_c01_w.nr_seq_conta_mat, r_c01_w.nr_seq_conta_pos_estab),0);
			else
				if (ie_tipo_item_p in ('3','6','7','13')) then
					select	coalesce(sum(b.vl_apropriacao), 0)
					into STRICT	vl_coparticipacao_w
					from	pls_mensalidade_item_conta a,
						pls_mens_item_conta_aprop b
					where	a.nr_sequencia = b.nr_seq_mens_item_conta
					and	b.nr_seq_centro_apropriacao = nr_seq_centro_apropriacao_p
					and	a.nr_sequencia = r_c01_w.nr_seq_item_conta;
				else
					select	coalesce(sum(vl_apropriacao),0)
					into STRICT	vl_coparticipacao_w
					from	pls_mens_seg_item_aprop
					where	nr_seq_item			= nr_seq_item_mens_p
					and	nr_seq_centro_apropriacao	= nr_seq_centro_apropriacao_p;
				end if;
			end if;
		end if;

		if	((current_setting('pls_ame_pck.dados_regra_geracao_lote_rem_w')::pls_ame_regra_geracao%rowtype.ie_item_apropriacao = 'N') and (current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%(type IS NOT NULL AND type::text <> ''))) then
			if (current_setting('pls_ame_pck.qt_registros_w')::bigint > 0) then
				select	coalesce(sum(b.vl_apropriacao), 0)
				into STRICT	vl_coparticipacao_w
				from	pls_mensalidade_item_conta a,
					pls_mens_item_conta_aprop b
				where	a.nr_sequencia = b.nr_seq_mens_item_conta
				and	a.nr_sequencia = r_c01_w.nr_seq_item_conta
				and	b.nr_seq_centro_apropriacao in (SELECT 	nr_seq_centro_apropriacao
									from	pls_ame_regra_ger_item_apr
									where	nr_seq_regra_item = current_setting('pls_ame_pck.nr_seq_regra_ger_item_w')::pls_ame_regra_ger_item.nr_sequencia%type);
			end if;
		end if;
	end if;

	if (vl_coparticipacao_w > 0) then
		cd_proced_mat_w		:= '';
		ds_proced_mat_w		:= '';
		ds_prestador_exec_w	:= '';

		if (r_c01_w.nr_seq_conta_proc IS NOT NULL AND r_c01_w.nr_seq_conta_proc::text <> '') then
			cd_proced_mat_w	:= substr(pls_obter_dados_conta_proc(r_c01_w.nr_seq_conta_proc,'C'),1,20);
			ds_proced_mat_w	:= substr(pls_obter_dados_conta_proc(r_c01_w.nr_seq_conta_proc,'D'),1,255);
		elsif (r_c01_w.nr_seq_conta_mat IS NOT NULL AND r_c01_w.nr_seq_conta_mat::text <> '') then
			cd_proced_mat_w	:= substr(pls_obter_dados_conta_mat(r_c01_w.nr_seq_conta_mat,'O'),1,20);
			ds_proced_mat_w	:= substr(pls_obter_dados_conta_mat(r_c01_w.nr_seq_conta_mat,'D'),1,255);
		end if;

		if (r_c01_w.nr_seq_prestador IS NOT NULL AND r_c01_w.nr_seq_prestador::text <> '') then
			ds_prestador_exec_w	:= substr(pls_obter_dados_prestador(r_c01_w.nr_seq_prestador,'N'),1,255);
		elsif (r_c01_w.nr_seq_congenere IS NOT NULL AND r_c01_w.nr_seq_congenere::text <> '') then
			select	max(a.nm_fantasia)
			into STRICT	ds_prestador_exec_w
			from	pessoa_juridica	a,
				pls_congenere	b
			where	b.cd_cgc	= a.cd_cgc
			and	b.nr_sequencia	= r_c01_w.nr_seq_congenere;
		end if;

		insert into pls_ame_lote_rem_valor_cop(	nr_sequencia,nm_usuario,dt_atualizacao,nm_usuario_nrec,dt_atualizacao_nrec,
				nr_seq_rem_valor_detalhe,vl_coparticipacao,nr_seq_conta_coparticipacao,cd_proced_mat,
				ds_proced_mat,ds_prestador_exec,qt_cobrada,dt_atendimento,nr_seq_conta_pos_estab,nr_seq_conta_co)
		values (	nextval('pls_ame_lote_rem_valor_cop_seq'),get_nm_usuario,clock_timestamp(),get_nm_usuario,clock_timestamp(),
				nr_seq_rem_valor_detalhe_p,vl_coparticipacao_w,r_c01_w.nr_seq_conta_coparticipacao,cd_proced_mat_w,
				ds_proced_mat_w,ds_prestador_exec_w,r_c01_w.qt_liberada_copartic,r_c01_w.dt_atendimento,r_c01_w.nr_seq_conta_pos_estab,r_c01_w.nr_seq_conta_co);
	end if;
	end;
end loop;

if (ie_tipo_item_p in ('3','6','7','13'))	then
	select	count(1)
	into STRICT	qt_copartic_w
	from	pls_ame_lote_rem_valor_cop
	where	nr_seq_rem_valor_detalhe = nr_seq_rem_valor_detalhe_p;

	if (qt_copartic_w = 0) then
		delete from pls_ame_lote_rem_valor_det
		where	nr_sequencia = nr_seq_rem_valor_detalhe_p;
	end if;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ame_pck.inserir_itens_contas_copart ( nr_seq_regra_ger_arq_p pls_ame_regra_ger_arq.nr_sequencia%type, nr_seq_rem_valor_detalhe_p bigint, nr_seq_mensalidade_seg_p bigint, nr_seq_conta_p bigint, nr_seq_conta_copartic_p bigint, ie_tipo_item_p text, nr_seq_item_mens_p bigint, ie_liberacao_debito_p text, nr_seq_centro_apropriacao_p bigint) FROM PUBLIC;
