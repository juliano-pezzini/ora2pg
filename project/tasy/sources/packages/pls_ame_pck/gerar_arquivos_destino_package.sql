-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ame_pck.gerar_arquivos_destino ( nr_seq_regra_ger_dest_p pls_ame_regra_ger_dest.nr_sequencia%type, nr_seq_lote_rem_dest_p pls_ame_lote_rem_destino.nr_sequencia%type, cd_cgc_estipulante_p pessoa_juridica.cd_cgc%type) AS $body$
DECLARE


	regras_arquivos CURSOR FOR
		SELECT	nr_sequencia,
			ds_caminho_arquivo,
			nm_arquivo,
			qt_max_titular,
			ie_nm_arquivo_div
		from	pls_ame_regra_ger_arq
		where	nr_seq_regra_ger_dest	= nr_seq_regra_ger_dest_p;

	type regras_arquivos_table is table of regras_arquivos%rowtype index by integer;

	regras_arquivos_w	regras_arquivos_table;
	nr_seq_lote_rem_arq_w	pls_ame_lote_rem_arquivo.nr_sequencia%type;
	qt_titulares_arquivo_w	integer;
	dt_ref_mensalidade_w	pls_ame_lote_remessa.dt_ref_mensalidade%type;
	dt_competencia_mens_w	pls_lote_coparticipacao.dt_competencia_mens%type;
	nm_arquivo_aux_w	pls_ame_regra_ger_arq.nm_arquivo%type;
	nr_seq_lote_w		pls_ame_lote_remessa.nr_sequencia%type;
	dt_lote_w		pls_ame_lote_remessa.dt_lote%type;

BEGIN
	open regras_arquivos;
	fetch regras_arquivos bulk collect into regras_arquivos_w;
	close regras_arquivos;

	select	a.dt_ref_mensalidade,
		a.nr_sequencia,
		a.dt_lote
	into STRICT	dt_ref_mensalidade_w,
		nr_seq_lote_w,
		dt_lote_w
	from	pls_ame_lote_remessa		a,
		pls_ame_lote_rem_destino	b
	where	b.nr_seq_lote_rem	= a.nr_sequencia
	and	b.nr_sequencia	= nr_seq_lote_rem_dest_p;

	for i in regras_arquivos_w.first .. regras_arquivos_w.last loop
		begin

		select	max(nr_sequencia)
		into STRICT	nr_seq_lote_rem_arq_w
		from	pls_ame_lote_rem_arquivo
		where	nr_seq_lote_rem_dest		= nr_seq_lote_rem_dest_p
		and	nr_seq_regra_ger_arquivo	= regras_arquivos_w[i].nr_sequencia;

		if (coalesce(nr_seq_lote_rem_arq_w::text, '') = '') then
			select	nextval('pls_ame_lote_rem_arquivo_seq')
			into STRICT	nr_seq_lote_rem_arq_w
			;
			
			insert into pls_ame_lote_rem_arquivo(	nr_sequencia, dt_atualizacao,nm_usuario, dt_atualizacao_nrec,nm_usuario_nrec,
					nr_seq_lote_rem_dest,vl_total,nr_seq_regra_ger_arquivo,dt_inicio_geracao,nm_arquivo)
			values (	nr_seq_lote_rem_arq_w,clock_timestamp(),get_nm_usuario,clock_timestamp(),get_nm_usuario,
					nr_seq_lote_rem_dest_p,0,regras_arquivos_w[i].nr_sequencia,clock_timestamp(),'-');
		end if;

		CALL pls_ame_pck.gerar_beneficiarios_arquivo(regras_arquivos_w[i].nr_sequencia, nr_seq_lote_rem_arq_w, cd_cgc_estipulante_p, regras_arquivos_w[i].qt_max_titular, regras_arquivos_w[i].ie_nm_arquivo_div);

		dt_competencia_mens_w	:= pls_ame_pck.obter_dt_competencia_copartic(nr_seq_lote_rem_dest_p);

		nm_arquivo_aux_w	:= pls_ame_pck.substituir_macro_nm_arquivo(regras_arquivos_w[i].nm_arquivo,dt_ref_mensalidade_w,dt_competencia_mens_w,nr_seq_lote_w,dt_lote_w);

		update	pls_ame_lote_rem_arquivo
		set	nm_arquivo = regras_arquivos_w[i].ds_caminho_arquivo || nm_arquivo_aux_w
		where	nr_sequencia = nr_seq_lote_rem_arq_w;

		select	count(1)
		into STRICT	qt_titulares_arquivo_w
		from	pls_ame_lote_rem_valor
		where	nr_seq_lote_rem_arq	= nr_seq_lote_rem_arq_w;

		if (qt_titulares_arquivo_w = 0) then
			delete	FROM pls_ame_lote_rem_arquivo
			where	nr_sequencia	= nr_seq_lote_rem_arq_w;
		else
			update	pls_ame_lote_rem_arquivo
			set	dt_fim_geracao	= clock_timestamp()
			where	nr_sequencia	= nr_seq_lote_rem_arq_w
			and	coalesce(dt_fim_geracao::text, '') = '';
		end if;

		end;
	end loop;

	regras_arquivos_w.delete;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ame_pck.gerar_arquivos_destino ( nr_seq_regra_ger_dest_p pls_ame_regra_ger_dest.nr_sequencia%type, nr_seq_lote_rem_dest_p pls_ame_lote_rem_destino.nr_sequencia%type, cd_cgc_estipulante_p pessoa_juridica.cd_cgc%type) FROM PUBLIC;
