-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ame_pck.desfazer_lote_remessa (nr_seq_lote_rem_p pls_ame_lote_remessa.nr_sequencia%type) AS $body$
DECLARE

	deleta_registros_destinos CURSOR FOR
		SELECT	nr_sequencia
		from	pls_ame_lote_rem_destino
		where	nr_seq_lote_rem = nr_seq_lote_rem_p;

	nr_seq_lote_rem_destino_w	dbms_sql.number_table;

	nr_seq_lote_rem_dest_w		pls_ame_lote_rem_destino.nr_sequencia%type;

	deleta_registros_arquivo CURSOR FOR
		SELECT	nr_sequencia
		from	pls_ame_lote_rem_arquivo
		where	nr_seq_lote_rem_dest = nr_seq_lote_rem_dest_w;

	nr_seq_lote_rem_arquivo_w	dbms_sql.number_table;

	nr_seq_lote_rem_arq_w		pls_ame_lote_rem_arquivo.nr_sequencia%type;

	deleta_registros_valor_benef CURSOR FOR
		SELECT	nr_sequencia
		from	pls_ame_lote_rem_valor
		where	nr_seq_lote_rem_arq = nr_seq_lote_rem_arq_w;

	nr_seq_lote_rem_valor_benef_w	dbms_sql.number_table;
BEGIN
	open deleta_registros_destinos;
	fetch deleta_registros_destinos bulk collect into nr_seq_lote_rem_destino_w;
	close deleta_registros_destinos;

	if (nr_seq_lote_rem_destino_w.count <> 0) then
		for i in nr_seq_lote_rem_destino_w.first .. nr_seq_lote_rem_destino_w.last loop
			begin

			nr_seq_lote_rem_dest_w	:= nr_seq_lote_rem_destino_w(i);

			open deleta_registros_arquivo;
			fetch deleta_registros_arquivo bulk collect into nr_seq_lote_rem_arquivo_w;
			close deleta_registros_arquivo;

			if (nr_seq_lote_rem_arquivo_w.count <> 0) then
				for x in nr_seq_lote_rem_arquivo_w.first .. nr_seq_lote_rem_arquivo_w.last loop
					begin

					nr_seq_lote_rem_arq_w	:= nr_seq_lote_rem_arquivo_w(x);

					open deleta_registros_valor_benef;
					fetch deleta_registros_valor_benef bulk collect into nr_seq_lote_rem_valor_benef_w;
					close deleta_registros_valor_benef;

					if (nr_seq_lote_rem_valor_benef_w.count <> 0) then
						for y in nr_seq_lote_rem_valor_benef_w.first .. nr_seq_lote_rem_valor_benef_w.last loop
							begin
							delete	FROM pls_ame_lote_rem_valor_cop
							where	nr_seq_rem_valor_detalhe in ( SELECT nr_sequencia
												from pls_ame_lote_rem_valor_det
												where	nr_seq_lote_rem_valor = nr_seq_lote_rem_valor_benef_w(y));

							delete	FROM pls_ame_lote_rem_valor_det
							where	nr_seq_lote_rem_valor = nr_seq_lote_rem_valor_benef_w(y);

							delete	FROM pls_ame_lote_rem_valor
							where	nr_sequencia	= nr_seq_lote_rem_valor_benef_w(y);
							end;
						end loop;
					end if;

					delete	FROM pls_ame_lote_rem_arquivo
					where	nr_sequencia = nr_seq_lote_rem_arq_w;
					end;
				end loop;
			end if;

			delete	FROM pls_ame_destino_envio
			where	nr_seq_lote_rem_dest = nr_seq_lote_rem_dest_w;

			delete	FROM pls_ame_lote_rem_destino
			where	nr_sequencia = nr_seq_lote_rem_dest_w;

			end;
		end loop;
	end if;

	update	pls_ame_lote_remessa
	set	dt_geracao_lote	 = NULL,
		vl_total	= 0,
		ie_visualizar_portal = 'N'
	where	nr_sequencia	= nr_seq_lote_rem_p;

	commit;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ame_pck.desfazer_lote_remessa (nr_seq_lote_rem_p pls_ame_lote_remessa.nr_sequencia%type) FROM PUBLIC;
