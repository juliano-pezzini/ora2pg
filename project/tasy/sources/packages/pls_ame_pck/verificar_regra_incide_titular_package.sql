-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_ame_pck.verificar_regra_incide_titular ( nr_seq_mensalidade_seg_p pls_mensalidade_segurado.nr_sequencia%type, nr_seq_regra_ger_arq_p bigint) RETURNS varchar AS $body$
DECLARE


ie_tipo_pessoa_pagador_w	varchar(2);
nr_seq_forma_cobranca_w		pls_mensalidade.nr_seq_forma_cobranca%type;
ie_gerar_w			varchar(1);	
	
current_setting('pls_ame_pck.c01')::CURSOR( CURSOR FOR
	SELECT	coalesce(ie_tipo_pessoa_pagador, 'A') ie_tipo_pessoa_pagador,
		nr_seq_forma_cobranca,
		ie_regra_excecao
	from	pls_ame_regra_ger_titular
	where	nr_seq_regra_ger_arq = nr_seq_regra_ger_arq_p
	and 	dt_lote_ww between trunc(coalesce(dt_inicio_vigencia,dt_lote_ww),'dd') and fim_dia(coalesce(dt_fim_vigencia,dt_lote_ww));

BEGIN

select	b.nr_seq_forma_cobranca,
	(select	CASE WHEN coalesce(x.cd_pessoa_fisica::text, '') = '' THEN  'PJ'  ELSE 'PF' END
	from	pls_contrato_pagador x
	where	x.nr_sequencia = b.nr_seq_pagador)
into STRICT	nr_seq_forma_cobranca_w,
	ie_tipo_pessoa_pagador_w
from	pls_mensalidade_segurado a,
	pls_mensalidade b
where	b.nr_sequencia = a.nr_seq_mensalidade
and	a.nr_sequencia = nr_seq_mensalidade_seg_p;

ie_gerar_w := 'S';

for r_c01_w in current_setting('pls_ame_pck.c01')::CURSOR( loop
	begin
	if (ie_gerar_w = 'S') then
		if (r_c01_w.ie_regra_excecao = 'S') then
			if	(((ie_tipo_pessoa_pagador_w = r_c01_w.ie_tipo_pessoa_pagador) or (r_c01_w.ie_tipo_pessoa_pagador = 'A')) and
				((r_c01_w.nr_seq_forma_cobranca IS NOT NULL AND r_c01_w.nr_seq_forma_cobranca::text <> '' AND nr_seq_forma_cobranca_w = r_c01_w.nr_seq_forma_cobranca) or (coalesce(r_c01_w.nr_seq_forma_cobranca::text, '') = '')) and
				((r_c01_w.ie_tipo_pessoa_pagador <> 'A') or (r_c01_w.nr_seq_forma_cobranca IS NOT NULL AND r_c01_w.nr_seq_forma_cobranca::text <> ''))) then
				ie_gerar_w	:= 'N';
			end if;
		elsif (r_c01_w.ie_regra_excecao = 'N') then
			if	((ie_tipo_pessoa_pagador_w <> r_c01_w.ie_tipo_pessoa_pagador AND r_c01_w.ie_tipo_pessoa_pagador <> 'A') or
				(r_c01_w.nr_seq_forma_cobranca IS NOT NULL AND r_c01_w.nr_seq_forma_cobranca::text <> '' AND nr_seq_forma_cobranca_w <> r_c01_w.nr_seq_forma_cobranca)) then
				ie_gerar_w	:= 'N';
			end if;
		end if;
	end if;
	end;
end loop;

return ie_gerar_w;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_ame_pck.verificar_regra_incide_titular ( nr_seq_mensalidade_seg_p pls_mensalidade_segurado.nr_sequencia%type, nr_seq_regra_ger_arq_p bigint) FROM PUBLIC;
