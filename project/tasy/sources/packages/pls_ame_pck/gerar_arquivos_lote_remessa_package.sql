-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ame_pck.gerar_arquivos_lote_remessa ( nr_seq_lote_rem_p pls_ame_lote_remessa.nr_sequencia%type, ie_origem_geracao_p text, arquivos_mensalidade_p INOUT text) AS $body$
DECLARE

arquivos_cursor CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nm_arquivo,
		a.nr_seq_regra_ger_arquivo,
		b.nr_sequencia nr_seq_lote_rem_dest,
		c.dt_ref_mensalidade,
		c.dt_lote
	from	pls_ame_lote_rem_arquivo	a,
		pls_ame_lote_rem_destino	b,
		pls_ame_lote_remessa		c
	where	b.nr_sequencia	= a.nr_seq_lote_rem_dest
	and	c.nr_sequencia	= b.nr_seq_lote_rem
	and	c.nr_sequencia	= nr_seq_lote_rem_p
	and	exists (SELECT	1
			from	pls_ame_regra_ger_arq x
			where	x.nr_sequencia = a.nr_seq_regra_ger_arquivo
			and	(x.nm_objeto_geracao IS NOT NULL AND x.nm_objeto_geracao::text <> ''));
			
type arquivos_type is table of arquivos_cursor%rowtype;

arquivos_table	arquivos_type;

offset_ultima_barra_w	integer	:= 0;
offset_barra_w		integer	:= 0;
index_w			integer	:= 0;

ds_local_w		varchar(255);
ds_local_windows_w	varchar(255);
ds_linha_w		varchar(255);
sql_chamada_procedure_w	varchar(4000);

nm_objeto_geracao_w	pls_ame_regra_ger_arq.nm_objeto_geracao%type;
nm_arquivo_regra_w	pls_ame_regra_ger_arq.nm_arquivo%type;
ds_subpasta_html_w	pls_ame_regra_ger_arq.ds_subpasta_html%type;

ie_existe_objeto_w	integer;
ie_liberar_portal_w	varchar(1);
qt_regra_arq_layout_w	bigint;

BEGIN
current_setting('pls_ame_pck.reg_arquivos_gerados_w')::reg_arquivos_gerados_v.delete;

select	coalesce(obter_valor_param_usuario(1389,3,obter_perfil_ativo,get_nm_usuario,get_cd_estabelecimento),'A')
into STRICT	ie_liberar_portal_w
;

open arquivos_cursor;
fetch arquivos_cursor bulk collect into arquivos_table;
close arquivos_cursor;

if (arquivos_table.count > 0) then
	for i in arquivos_table.first .. arquivos_table.last loop

		offset_ultima_barra_w := position(chr(92) /*chr(92) = '\''*/
 in arquivos_table[i].nm_arquivo);

		while(offset_ultima_barra_w  <> offset_barra_w) loop
			offset_barra_w := offset_ultima_barra_w;
			offset_ultima_barra_w := offset_ultima_barra_w + position(chr(92)/*chr(92) = '\''*/
 in substr(arquivos_table[i].nm_arquivo,offset_ultima_barra_w,length(arquivos_table[i].nm_arquivo)));
		end loop;

		select	max(ds_local),
			max(ds_local_rede)
		into STRICT	ds_local_w,
			ds_local_windows_w
		from	evento_tasy_utl_file
		where	cd_evento	= 5;

		if (coalesce(ds_local_w::text, '') = '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(285471);
		end if;

		select	nm_objeto_geracao,
			nm_arquivo,
			ds_subpasta_html
		into STRICT	nm_objeto_geracao_w,
			nm_arquivo_regra_w,
			ds_subpasta_html_w
		from	pls_ame_regra_ger_arq
		where	nr_sequencia	= arquivos_table[i].nr_seq_regra_ger_arquivo;

		nm_arquivo_regra_w	:= pls_ame_pck.substituir_macro_nm_arquivo(nm_arquivo_regra_w, arquivos_table[i].dt_ref_mensalidade, pls_ame_pck.obter_dt_competencia_copartic(arquivos_table[i].nr_seq_lote_rem_dest),
								nr_seq_lote_rem_p, arquivos_table[i].dt_lote);

		select	count(1)
		into STRICT	ie_existe_objeto_w
		from	user_objects
		where	object_name = upper(nm_objeto_geracao_w);
		
		if (ie_existe_objeto_w = 0) then

		CALL wheb_mensagem_pck.exibir_mensagem_abort(wheb_mensagem_pck.get_texto(1092342) ||  ' ' || nm_objeto_geracao_w );

		end if;

		sql_chamada_procedure_w	:= 'begin ' || nm_objeto_geracao_w || '(' || arquivos_table[i].nr_sequencia || ',''' || ds_local_w || ''',''' || nm_arquivo_regra_w || '''); end;';

		EXECUTE sql_chamada_procedure_w;

		/*Tratamento para a geracao do arquivo na versao Delphi e Java. O delphi tem uma limitacao das variaves de retorno, devido ao BDE*/


		if (coalesce(ie_origem_geracao_p,'D') = 'D') then
			index_w	:= current_setting('pls_ame_pck.reg_arquivos_gerados_w')::reg_arquivos_gerados_v.count+1;
			current_setting('pls_ame_pck.reg_arquivos_gerados_w')::reg_arquivos_gerados_v[index_w].ds_arquivo_ant	:= coalesce(ds_local_windows_w,ds_local_w) || substr(arquivos_table[i].nm_arquivo, offset_barra_w, length(arquivos_table[i].nm_arquivo));
			current_setting('pls_ame_pck.reg_arquivos_gerados_w')::reg_arquivos_gerados_v[index_w].ds_arquivo_novo := arquivos_table[i].nm_arquivo;
		elsif (ie_origem_geracao_p = 'J') then
			arquivos_mensalidade_p := arquivos_mensalidade_p || coalesce(ds_local_windows_w,ds_local_w) || substr(arquivos_table[i].nm_arquivo, offset_barra_w, length(arquivos_table[i].nm_arquivo)) || chr(10);
			arquivos_mensalidade_p := arquivos_mensalidade_p || arquivos_table[i].nm_arquivo || chr(10);
		elsif (ie_origem_geracao_p = 'H') then
			insert into pls_exp_geradas(	ds_arquivo,
					nm_arquivo,
					nm_usuario,
					ds_subpasta_html 			)
			values (	arquivos_table[i].nr_sequencia,
					nm_arquivo_regra_w,
					get_nm_usuario,
					ds_subpasta_html_w			);
		end if;
	end loop;

	update	pls_ame_lote_remessa
	set	dt_geracao_arquivos	= clock_timestamp(),
		ie_visualizar_portal 	= CASE WHEN ie_liberar_portal_w='A' THEN 'S'  ELSE coalesce(ie_visualizar_portal,'N') END
	where	nr_sequencia		= nr_seq_lote_rem_p;
end if;

select	count(1)
into STRICT	qt_regra_arq_layout_w
from	pls_ame_lote_rem_arquivo	a,
	pls_ame_lote_rem_destino	b,
	pls_ame_lote_remessa		c
where	b.nr_sequencia	= a.nr_seq_lote_rem_dest
and	c.nr_sequencia	= b.nr_seq_lote_rem
and	c.nr_sequencia	= nr_seq_lote_rem_p
and	exists (SELECT	1
		from	pls_ame_regra_ger_arq x
		where	x.nr_sequencia = a.nr_seq_regra_ger_arquivo
		and	(x.nr_seq_regra_layout IS NOT NULL AND x.nr_seq_regra_layout::text <> ''));
		
if	(qt_regra_arq_layout_w > 0 AND ie_origem_geracao_p = 'D') then
	CALL pls_gerar_arquivo_ame_pck.gerar_arquivo(nr_seq_lote_rem_p, ie_origem_geracao_p, wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario);
end if;
	
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ame_pck.gerar_arquivos_lote_remessa ( nr_seq_lote_rem_p pls_ame_lote_remessa.nr_sequencia%type, ie_origem_geracao_p text, arquivos_mensalidade_p INOUT text) FROM PUBLIC;
