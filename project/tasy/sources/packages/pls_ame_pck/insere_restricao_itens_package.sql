-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_ame_pck.insere_restricao_itens () AS $body$
DECLARE


		ie_inserir_todos_itens_w	varchar(1);

		
BEGIN
		open itens_beneficiario;
		fetch itens_beneficiario bulk collect into itens_beneficiario_w;
		close itens_beneficiario;

		ie_inserir_todos_itens_w	:= 'N';

		if (itens_beneficiario_w.count > 0) then
			for i in itens_beneficiario_w.first .. itens_beneficiario_w.last loop
				if (itens_beneficiario_w[i].ie_regra_excecao = 'S') then
					if (coalesce(itens_beneficiario_w[i].ie_tipo_item_mens,'20') <> '20') or
						((itens_beneficiario_w[i].ie_tipo_item_mens = '20') and (itens_beneficiario_w[i]coalesce(.nr_seq_tipo_lanc::text, '') = '')) then
						sql_base_w := sql_base_w || ' and a.ie_tipo_item <> ' || itens_beneficiario_w[i].ie_tipo_item_mens;
					end if;

					if (itens_beneficiario_w[i](.nr_seq_tipo_lanc IS NOT NULL AND .nr_seq_tipo_lanc::text <> '')) then
						sql_base_w := sql_base_w || ' and (((a.ie_tipo_item = 20) and ((a.nr_seq_tipo_lanc is null) or (a.nr_seq_tipo_lanc <> ' || itens_beneficiario_w[i].nr_seq_tipo_lanc || '))) ' ||
									    ' or (a.ie_tipo_item <> 20))';
					end if;
				elsif (itens_beneficiario_w[i].ie_regra_excecao = 'N') then
					if (itens_beneficiario_w[i](.ie_tipo_item_mens IS NOT NULL AND .ie_tipo_item_mens::text <> '')) then
						PERFORM set_config('pls_ame_pck.ie_tipo_item_restricao_w', current_setting('pls_ame_pck.ie_tipo_item_restricao_w')::varchar(4000) || itens_beneficiario_w[i].ie_tipo_item_mens || ',', false);
					else
						ie_inserir_todos_itens_w	:= 'S';
					end if;

					if (itens_beneficiario_w[i](.nr_seq_tipo_lanc IS NOT NULL AND .nr_seq_tipo_lanc::text <> '')) then
						PERFORM set_config('pls_ame_pck.ds_tipo_lanc_restricao_w', current_setting('pls_ame_pck.ds_tipo_lanc_restricao_w')::varchar(4000) || itens_beneficiario_w[i].nr_seq_tipo_lanc || ',', false);
					end if;
				end if;

				if (coalesce(itens_beneficiario_w[i].ie_consid_zerado,'N') = 'N') then
					sql_base_w := sql_base_w || ' and a.vl_item <> 0 ';
				end if;
			end loop;
		end if;

		itens_beneficiario_w.delete;

		if 	((current_setting('pls_ame_pck.ie_tipo_item_restricao_w')::(varchar(4000) IS NOT NULL AND (varchar(4000))::text <> '')) and (ie_inserir_todos_itens_w = 'N')) then
			sql_base_w := sql_base_w || ' and a.ie_tipo_item in (' || substr(current_setting('pls_ame_pck.ie_tipo_item_restricao_w')::varchar(4000),1,length(current_setting('pls_ame_pck.ie_tipo_item_restricao_w')::varchar(4000))-1) || ')';
		end if;

		if (current_setting('pls_ame_pck.ds_tipo_lanc_restricao_w')::(varchar(4000) IS NOT NULL AND (varchar(4000))::text <> '')) then
			sql_base_w := sql_base_w || 	' and	(a.nr_seq_tipo_lanc in (' || substr(current_setting('pls_ame_pck.ds_tipo_lanc_restricao_w')::varchar(4000),1,length(current_setting('pls_ame_pck.ds_tipo_lanc_restricao_w')::varchar(4000))-1) || ') or ' ||
							'	a.nr_seq_tipo_lanc is null) ';
		end if;

		if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') and (coalesce(ie_devolucao_mens_p,'N') = 'N') then
			sql_base_w	:= sql_base_w || ' and	b.nr_seq_segurado = ' || nr_seq_segurado_p;
		end if;

		END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ame_pck.insere_restricao_itens () FROM PUBLIC;
