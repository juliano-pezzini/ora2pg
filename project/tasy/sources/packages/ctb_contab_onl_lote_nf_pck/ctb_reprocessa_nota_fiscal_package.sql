-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_contab_onl_lote_nf_pck.ctb_reprocessa_nota_fiscal (nr_seq_nota_fiscal_p bigint, cd_tipo_lote_contabil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_ctb_movto_w ctb_movimento.nr_sequencia%type;

C01 CURSOR FOR
SELECT b.nr_sequencia
from   ctb_movimento          b,
        movimento_contabil_doc a
where  b.nr_sequencia = a.nr_seq_ctb_movto
and    a.nr_seq_ctb_documento in (select nr_sequencia
                                  from   ctb_documento c
                                  where  c.nr_documento = nr_seq_nota_fiscal_p
                                  and    c.cd_tipo_lote_contabil = cd_tipo_lote_contabil_p
                                  and    c.cd_estabelecimento = cd_estabelecimento_p)
order  by coalesce(b.nr_seq_movto_partida,0) desc;


BEGIN

open C01;
loop
    fetch C01
        into nr_seq_ctb_movto_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
    begin
        CALL ctb_online_pck.ctb_desatualizar_saldo_movto(nr_seq_ctb_movto_w,'N',nm_usuario_p);

        delete from ctb_movimento where nr_sequencia = nr_seq_ctb_movto_w;
    end;
end loop;

delete from ctb_documento c
where  c.nr_documento = nr_seq_nota_fiscal_p
and    c.cd_tipo_lote_contabil = cd_tipo_lote_contabil_p
and    c.cd_estabelecimento = cd_estabelecimento_p;

update nota_fiscal
set    nr_lote_contabil  = NULL
where  nr_sequencia = nr_seq_nota_fiscal_p
and    cd_estabelecimento = cd_estabelecimento_p;

CALL ctb_contab_onl_lote_nf_pck.ctb_contabiliza_nota_fiscal(nr_seq_nota_fiscal_p,cd_estabelecimento_p,nm_usuario_p);

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_lote_nf_pck.ctb_reprocessa_nota_fiscal (nr_seq_nota_fiscal_p bigint, cd_tipo_lote_contabil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
