-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_contab_onl_lote_nf_pck.ctb_contabiliza_nota_fiscal (nr_seq_nota_fiscal_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_lote_contabil_w          lote_contabil.nr_lote_contabil%type;
cd_tipo_lote_contabil_w     tipo_lote_contabil.cd_tipo_lote_contabil%type;
cd_evento_w                 operacao_estoque.cd_evento%type;
nr_sequencia_w              nota_fiscal.nr_sequencia%type;
ie_acao_nf_w                nota_fiscal.ie_acao_nf%type;
ie_situacao_w               nota_fiscal.ie_situacao%type;
nr_nota_fiscal_w            nota_fiscal.nr_nota_fiscal%type;
cd_cgc_w                    nota_fiscal.cd_cgc%type;
cd_cgc_emitente_w           nota_fiscal.cd_cgc_emitente%type;
cd_pessoa_fisica_w          nota_fiscal.cd_pessoa_fisica%type;
ds_observacao_nf_w          nota_fiscal.ds_observacao%type;
nr_interno_conta_w          nota_fiscal.nr_interno_conta%type;
nr_ordem_compra_w           nota_fiscal.nr_ordem_compra%type;
nr_seq_nf_ref_w             nota_fiscal.nr_seq_nf_ref%type;
vl_mercadoria_w             nota_fiscal.vl_mercadoria%type;
nr_sequencia_ref_w          nota_fiscal.nr_sequencia_ref%type;
ds_operacao_nf_w            operacao_nota.ds_operacao_nf%type;
cd_operacao_nf_w            operacao_nota.cd_operacao_nf%type;
dt_emissao_w                nota_fiscal.dt_emissao%type;
nr_atendimento_w            nota_fiscal_item.nr_atendimento%type;
nr_nfe_imp_w                nota_fiscal.nr_nfe_imp%type;
cd_estabelecimento_w        estabelecimento.cd_estabelecimento%type;
nm_estabelecimento_w        estabelecimento.nm_fantasia_estab%type;
nr_rps_w                    nota_fiscal.nr_rps%type;
ds_material_w               material.ds_material%type;
cd_unidade_medida_compra_w  nota_fiscal_item.cd_unidade_medida_compra%type;
cd_unidade_medida_estoque_w nota_fiscal_item.cd_unidade_medida_estoque%type;
ds_tributo_w                tributo.ds_tributo%type;
ds_observacao_item_w        nota_fiscal_item.ds_observacao%type;
ds_complemento_w            nota_fiscal_item.ds_complemento%type;
nr_documento_desp_w         nota_fiscal_desp_adic.nr_documento%type;
ie_data_contab_est_nf_w     ctb_param_lote_nf.ie_data_contab_est_nf%type;
ie_data_contab_nf_w         ctb_param_lote_nf.ie_data_contab_nf%type;
qt_item_nf_w                nota_fiscal_item.qt_item_nf%type;
qt_item_estoque_w           nota_fiscal_item.qt_item_estoque%type;
ie_contab_nf_estab_w        ctb_param_lote_nf.ie_contab_nf_estab%type;
cd_conta_transitoria_w      conta_contabil.cd_conta_contabil%type;
ie_permite_estab_dif_w      ctb_regra_estab_dif.ie_permite%type;
cd_hist_conta_transit_w     movimento_contabil.cd_historico%type;
cd_estab_financeiro_w       estabelecimento.cd_estab_financeiro%type;
cd_estab_movto_w            estabelecimento.cd_estabelecimento%type;
vl_contabil_w               nota_fiscal_conta.vl_contabil%type;
cd_conta_ctb_esp_w          nota_fiscal_conta.cd_conta_contabil%type;
vl_contabil_esp_w           nota_fiscal_conta.vl_contabil%type;
nr_seq_nf_ref_compl_w       nota_fiscal.nr_seq_nf_ref%type;
ie_contab_nf_compl_w        ctb_param_lote_nf.ie_contab_nf_compl%type;
cd_estab_centro_w           centro_custo.cd_estabelecimento%type;
dt_vencimento_w             varchar(255);
cd_convenio_w               bigint;
dt_movimento_w              timestamp;
nm_pessoa_w                 varchar(255);
nm_paciente_w               varchar(255);
ie_nf_consignado_w          varchar(1);
ie_nf_entrada_saida_w       varchar(1);
ie_nf_nfe_w                 varchar(15);
ds_situacao_w               varchar(255);
ds_conteudo_w               varchar(4000);
ie_estorno_w                varchar(20);
ds_estorno_w                varchar(80);
ds_titulos_pagar_nf_w       varchar(255);
ds_titulos_receber_nf_w     varchar(255);
ds_pessoa_nota_fiscal_w     varchar(80);
ds_consignado_w             varchar(15);
ds_compl_historico_w        varchar(255);
ds_comando_w                varchar(255);
ds_param_sql_w              varchar(2000);
vl_retorno_w                double precision;
qt_indice_w_movto_w         bigint;
qt_item_trib_w              bigint;
ie_intercompany_w           ctb_movimento.ie_intercompany%type := 'N';
cd_estab_intercompany_w     ctb_movimento.cd_estab_intercompany%type;
ie_operacao_fiscal_w        operacao_nota.ie_operacao_fiscal%type;
nr_seq_proj_rec_capa        ctb_movimento.nr_seq_proj_rec%type;
nr_seq_nota_orig_w          nota_fiscal.nr_sequencia%type;
nr_nota_orig_w              nota_fiscal.nr_nota_fiscal%type;
cd_serie_nf_orig_w          nota_fiscal.cd_serie_nf%type;
nr_nfe_imp_orig_w           nota_fiscal.nr_nfe_imp%type;
nr_grupo_contab_nf_w        operacao_nota.nr_seq_grupo_contab%type;

c01 CURSOR FOR
    SELECT  cd_conta_contabil,
            vl_contabil
    from    nota_fiscal_conta
    where   nr_seq_nf = nr_seq_nota_fiscal_p;

BEGIN

nr_seq_proj_rec_capa := OBTER_PROJETO_NOTA_FISCAL(nr_seq_nota_fiscal_p);

if (coalesce(nr_seq_nota_fiscal_p,0) <> 0) then
    begin
    CALL ctb_contab_onl_lote_nf_pck.ctb_consistir_contab_nf(nr_seq_nota_fiscal_p,
                            cd_estabelecimento_p,
                            'N',
                            nm_usuario_p);
    end;
end if;

begin
select x.*
into STRICT   ie_contab_nf_estab_w,
        ie_data_contab_est_nf_w,
        ie_data_contab_nf_w,
        ie_contab_nf_compl_w
from (SELECT coalesce(a.ie_contab_nf_estab,'EC'),
                a.ie_data_contab_est_nf,
                a.ie_data_contab_nf,
                a.ie_contab_nf_compl
        from   ctb_param_lote_nf a
        where  a.cd_empresa = Obter_Empresa_Estab(cd_estabelecimento_p)
        and    coalesce(a.cd_estab_exclusivo,cd_estabelecimento_p) = cd_estabelecimento_p
        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;
exception
    when others then
        ie_contab_nf_estab_w := 'EC';
end;

select a.cd_tipo_lote_contabil,
        a.cd_evento,
        c.nr_sequencia,
        c.ie_acao_nf,
        c.ie_situacao,
        substr(Obter_Valor_Dominio(1056,c.ie_situacao),1,80) ds_situacao,
        c.nr_nota_fiscal,
        c.cd_cgc,
        c.cd_cgc_emitente,
        c.cd_pessoa_fisica,
        Obter_Convenio_Nf(c.nr_sequencia) cd_convenio,
        substr(Obter_Nome_Pf_Pj(c.cd_pessoa_fisica,
                                CASE WHEN coalesce(c.cd_pessoa_fisica::text, '') = '' THEN                                       c.cd_cgc  ELSE null END ),
              1,80) nm_pessoa,
        CASE WHEN ie_acao_nf=1 THEN               CASE WHEN ie_data_contab_nf_w='ES' THEN c.dt_entrada_saida WHEN ie_data_contab_nf_w='ATU' THEN c.dt_atualizacao WHEN ie_data_contab_nf_w='EST' THEN c.dt_atualizacao_estoque WHEN ie_data_contab_nf_w='OPE' THEN                       CASE WHEN Obter_Regra_Contab_Nf_Operacao(c.nr_sequencia)='ES' THEN c.dt_entrada_saida WHEN Obter_Regra_Contab_Nf_Operacao(c.nr_sequencia)='ATU' THEN c.dt_atualizacao WHEN Obter_Regra_Contab_Nf_Operacao(c.nr_sequencia)='EST' THEN c.dt_atualizacao_estoque  ELSE c.dt_emissao END   ELSE c.dt_emissao END   ELSE CASE WHEN ie_data_contab_est_nf_w='ES' THEN c.dt_entrada_saida WHEN ie_data_contab_est_nf_w='ATU' THEN c.dt_atualizacao WHEN ie_data_contab_est_nf_w='EST' THEN c.dt_atualizacao_estoque WHEN ie_data_contab_est_nf_w='OPE' THEN                       CASE WHEN Obter_Regra_Contab_Nf_Operacao(c.nr_sequencia)='ES' THEN c.dt_entrada_saida WHEN Obter_Regra_Contab_Nf_Operacao(c.nr_sequencia)='ATU' THEN c.dt_atualizacao WHEN Obter_Regra_Contab_Nf_Operacao(c.nr_sequencia)='EST' THEN c.dt_atualizacao_estoque  ELSE c.dt_emissao END   ELSE c.dt_emissao END  END  dt_movimento,
        substr(Obter_Pessoa_Conta(c.nr_interno_conta,'N'),1,60) nm_paciente,
        substr(Obter_Se_Nota_Consignada(c.nr_sequencia),1,1) ie_nf_consignado,
        substr(Obter_Se_Nota_Entrada_Saida(c.nr_sequencia),1,1) ie_nf_entrada_saida,
        substr(c.ds_observacao,1,254) ds_observacao_nf,
        c.nr_interno_conta,
        c.nr_ordem_compra,
        substr('NF' || CASE WHEN coalesce(b.ie_servico,'N')='S' THEN 'S' END  || CASE WHEN coalesce(c.ie_nf_eletronica,'N')='S' THEN 'E' END ,1,15) ie_nf_nfe,
        c.nr_seq_nf_ref,
        c.vl_mercadoria,
        c.nr_sequencia_ref,
        b.ds_operacao_nf,
        b.cd_operacao_nf,
        c.dt_emissao,
        c.nr_nfe_imp,
        c.cd_estabelecimento,
        c.nr_rps,
        b.ie_operacao_fiscal,
        b.nr_seq_grupo_contab
into STRICT    cd_tipo_lote_contabil_w,
        cd_evento_w,
        nr_sequencia_w,
        ie_acao_nf_w,
        ie_situacao_w,
        ds_situacao_w,
        nr_nota_fiscal_w,
        cd_cgc_w,
        cd_cgc_emitente_w,
        cd_pessoa_fisica_w,
        cd_convenio_w,
        nm_pessoa_w,
        dt_movimento_w,
        nm_paciente_w,
        ie_nf_consignado_w,
        ie_nf_entrada_saida_w,
        ds_observacao_nf_w,
        nr_interno_conta_w,
        nr_ordem_compra_w,
        ie_nf_nfe_w,
        nr_seq_nf_ref_w,
        vl_mercadoria_w,
        nr_sequencia_ref_w,
        ds_operacao_nf_w,
        cd_operacao_nf_w,
        dt_emissao_w,
        nr_nfe_imp_w,
        cd_estabelecimento_w,
        nr_rps_w,
        ie_operacao_fiscal_w,
        nr_grupo_contab_nf_w
from    operacao_estoque a,
        operacao_nota    b,
        nota_fiscal      c
where  c.cd_operacao_nf = b.cd_operacao_nf
and    a.cd_operacao_estoque = b.cd_operacao_estoque
and    c.nr_sequencia = nr_seq_nota_fiscal_p
and    coalesce(c.nr_lote_contabil,0) = 0;

if (coalesce(cd_tipo_lote_contabil_w,0) = 0) then
    begin
    cd_tipo_lote_contabil_w := 2;

    if (ie_operacao_fiscal_w = 'S') then
        begin
        cd_tipo_lote_contabil_w := 51;
        end;
    end if;
    end;
end if;

CALL ctb_online_pck.obter_regra_lote_estab_dif(cd_tipo_lote_contabil_w,cd_estabelecimento_w);
ie_permite_estab_dif_w  := ctb_online_pck.get_permite_estab_dif(cd_tipo_lote_contabil_w,cd_estabelecimento_w);
cd_conta_transitoria_w  := ctb_online_pck.get_conta_transitoria_estab(cd_tipo_lote_contabil_w,cd_estabelecimento_w);
cd_hist_conta_transit_w := ctb_online_pck.get_historico_transit_estab(cd_tipo_lote_contabil_w,cd_estabelecimento_w);

ie_intercompany_w := holding_pck.get_se_intercompany_cnpj(cd_estabelecimento_w,cd_cgc_emitente_w);

if (ie_intercompany_w = 'S') then
    cd_estab_intercompany_w := holding_pck.get_estab_intercompany(cd_cgc_emitente_w);
end if;

if (coalesce(cd_evento_w,0) != 0) then
    CALL gerar_documento_nota_fiscal(nr_seq_nota_fiscal_p,
                              cd_tipo_lote_contabil_w,
                              cd_estabelecimento_p,
                              nm_usuario_p);

end if;

begin
select substr(Obter_Select_Concatenado_Bv('select dt_vencimento from nota_fiscal_venc where nr_sequencia = :nr_sequencia',
                                          'nr_sequencia=' || nr_sequencia_w,'  '),1,255)
into STRICT   dt_vencimento_w
;
exception
    when others then
        dt_vencimento_w := null;
end;

if (ie_acao_nf_w = '2') then
    ie_estorno_w := wheb_mensagem_pck.get_texto(682644,null);
elsif (ie_acao_nf_w = '1') and (ie_situacao_w = '3') then
    ie_estorno_w := wheb_mensagem_pck.get_texto(682645,null);
end if;

begin
ds_titulos_pagar_nf_w := substr(Obter_Titulos_Pagar_Nf(nr_sequencia_w,','),1,255);
exception
    when others then
        ds_titulos_pagar_nf_w := '';
end;

if (ie_situacao_w <> '1') then
    ds_estorno_w := ds_situacao_w;
end if;

select max(nr_atendimento) nr_atendimento into STRICT nr_atendimento_w from nota_fiscal_item where nr_sequencia = nr_sequencia_w;

if (coalesce(nr_ordem_compra_w,0) <> 0) then
    nr_atendimento_w := substr(obter_dados_ordem_compra(nr_ordem_compra_w,'NA'),1,255);
end if;

select  max(nm_fantasia_estab),
        max(cd_estab_financeiro)
into STRICT    nm_estabelecimento_w,
        cd_estab_financeiro_w
from    estabelecimento
where   cd_estabelecimento = cd_estabelecimento_w;

if (ie_nf_entrada_saida_w = 'E') then
    ds_pessoa_nota_fiscal_w := substr(Obter_Nome_Pf_Pj(cd_pessoa_fisica_w,cd_cgc_emitente_w),1,80);
else
    ds_pessoa_nota_fiscal_w := substr(Obter_Nome_Pf_Pj(cd_pessoa_fisica_w,cd_cgc_w),1,80);
end if;

begin
ds_titulos_receber_nf_w := substr(Obter_Titulos_Nf(nr_sequencia_w,','),1,255);
ds_titulos_receber_nf_w := substr(ds_titulos_receber_nf_w,1,length(ds_titulos_receber_nf_w) - 1);
exception
    when others then
        ds_titulos_receber_nf_w := '';
end;

ds_consignado_w := '';
if (coalesce(ie_nf_consignado_w,'N') = 'S') then
    ds_consignado_w := wheb_mensagem_pck.get_texto(682794,null);
end if;

nr_seq_nf_ref_compl_w := nr_seq_nf_ref_w;

if (ie_acao_nf_w = '2') then
    begin
    select max(nr_seq_nf_ref) into STRICT nr_seq_nf_ref_compl_w from nota_fiscal where nr_sequencia = nr_sequencia_ref_w;
    end;
end if;

for idx in 1 .. current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count loop
    begin
    if (coalesce(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_historico,0) <> 0) then
        begin
        ds_material_w := '';
        if (coalesce(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_material,0) <> 0) then
            begin
                ds_material_w := Obter_Desc_Material(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_material);
            end;
        end if;

        ds_tributo_w := '';
        if (coalesce(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_tributo,0) <> 0) then
            begin
            select substr(max(ds_tributo),1,100)
            into STRICT   ds_tributo_w
            from   tributo
            where  cd_tributo = current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_tributo;
            end;
        end if;

        begin
            select a.nr_sequencia,
                a.nr_nota_fiscal,
                a.cd_serie_nf,
                a.nr_nfe_imp
            into STRICT nr_seq_nota_orig_w,
                nr_nota_orig_w,
                cd_serie_nf_orig_w,
                nr_nfe_imp_orig_w
            from
                nota_fiscal a,
                nf_credito b
            where a.nr_sequencia = b.nr_seq_nf_orig
            and b.nr_seq_nf_gerada = nr_sequencia_w;
        exception
            when no_data_found then
                nr_seq_nota_orig_w := null;
                nr_nfe_imp_orig_w := null;
                cd_serie_nf_orig_w := null;
                nr_nota_orig_w := null;
            when too_many_rows then 
                nr_seq_nota_orig_w := null;
                nr_nfe_imp_orig_w := null;
                cd_serie_nf_orig_w := null;
                nr_nota_orig_w := null;
        end;

        cd_unidade_medida_compra_w  := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_unidade_medida_compra;
        cd_unidade_medida_estoque_w := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_unidade_medida_estoque;
        qt_item_nf_w                := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].qt_item_nf;
        qt_item_estoque_w           := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].qt_item_estoque;
        ds_observacao_item_w        := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ds_observacao_item;
        ds_complemento_w            := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ds_complemento;

        CALL ctb_online_pck.definir_atrib_compl(cd_tipo_lote_contabil_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_FISCAL',nr_nota_fiscal_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_PF_PJ',nm_pessoa_w);
        CALL ctb_online_pck.set_value_compl_hist('NM_PACIENTE',nm_paciente_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQUENCIA',nr_sequencia_w);
        CALL ctb_online_pck.set_value_compl_hist('DT_VENCIMENTO',dt_vencimento_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_OBSERVACAO',ds_observacao_nf_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_COMPLEMENTO_ITEM',ds_complemento_w);
        CALL ctb_online_pck.set_value_compl_hist('IE_ESTORNO',ie_estorno_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_DOC_DESP_ADIC',nr_documento_desp_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_SITUACAO',ds_situacao_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_TITULO_PAGAR_NF',substr(ds_titulos_pagar_nf_w,1,255));
        CALL ctb_online_pck.set_value_compl_hist('DS_ESTORNO',ds_estorno_w);
        CALL ctb_online_pck.set_value_compl_hist('DT_EMISSAO',to_char(dt_emissao_w,'dd/mm/yyyy'));
        CALL ctb_online_pck.set_value_compl_hist('NR_ATENDIMENTO',nr_atendimento_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_INTERNO_CONTA',nr_interno_conta_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_NFE_IMP',nr_nfe_imp_w);
        CALL ctb_online_pck.set_value_compl_hist('NM_ESTABELECIMENTO',nm_estabelecimento_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_RPS',nr_rps_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_MATERIAL',ds_material_w);
        CALL ctb_online_pck.set_value_compl_hist('CD_UNIDADE_MEDIDA_COMPRA',cd_unidade_medida_compra_w);
        CALL ctb_online_pck.set_value_compl_hist('CD_UNIDADE_MEDIDA_ESTOQUE',cd_unidade_medida_estoque_w);
        CALL ctb_online_pck.set_value_compl_hist('QT_ITEM_NF',qt_item_nf_w);
        CALL ctb_online_pck.set_value_compl_hist('QT_ITEM_ESTOQUE',qt_item_estoque_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_TRIBUTO',ds_tributo_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_ORDEM_COMPRA',nr_ordem_compra_w);
        CALL ctb_online_pck.set_value_compl_hist('IE_NF_NFE',ie_nf_nfe_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_OBSERVACAO_ITEM',ds_observacao_item_w);
        CALL ctb_online_pck.set_value_compl_hist('NM_PESSOA_NOTA_FISCAL',ds_pessoa_nota_fiscal_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_TITULO_RECEBER',ds_titulos_receber_nf_w);
        CALL ctb_online_pck.set_value_compl_hist('CD_CGC',cd_cgc_w);
        CALL ctb_online_pck.set_value_compl_hist('CD_PESSOA_FISICA',cd_pessoa_fisica_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_CONSIGNADO',ds_consignado_w);
        CALL ctb_online_pck.set_value_compl_hist('DS_OPERACAO_NF',ds_operacao_nf_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_PROJ_REC',nr_seq_proj_rec_capa);
        CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_NOTA_ORIG',nr_seq_nota_orig_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_ORIG',nr_nota_orig_w);
        CALL ctb_online_pck.set_value_compl_hist('CD_SERIE_NF_ORIG',cd_serie_nf_orig_w);
        CALL ctb_online_pck.set_value_compl_hist('NR_NFE_IMP_ORIG',nr_nfe_imp_orig_w);

        ds_compl_historico_w := ctb_online_pck.ctb_obter_compl_historico(cd_tipo_lote_contabil_w,current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_historico);

        if (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_tabela = 'NOTA_FISCAL') then
            begin
            ds_comando_w   := 'select ' || current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_atributo || ' vl_retorno_w from nota_fiscal ' || ' where nr_sequencia = :nr_sequencia';
            ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_w || ';';

            obter_valor_dinamico_bv(ds_comando_w,ds_param_sql_w,vl_retorno_w);

            select coalesce(sum(a.vl_contabil),0)
            into STRICT   vl_contabil_w
            from   nota_fiscal_conta a
            where  a.nr_seq_nf = nr_seq_nota_fiscal_p;

            cd_estab_movto_w := cd_estabelecimento_w;

            if (vl_contabil_w > 0) and (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_atributo like '%VL_TOTAL_NOTA%') then
                begin
                    vl_retorno_w := 0;
                    open c01;
                    loop
                        fetch c01
                            into cd_conta_ctb_esp_w,
                                  vl_contabil_esp_w;
                        EXIT WHEN NOT FOUND; /* apply on c01 */
                        begin
                            qt_indice_w_movto_w := ctb_online_pck.movimento_contabil_w.count + 1;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_sequencia := qt_indice_w_movto_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].dt_movimento := dt_movimento_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].vl_movimento := vl_contabil_esp_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_historico := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_historico;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_conta_contabil := cd_conta_ctb_esp_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_compl_historico := ds_compl_historico_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_agrupamento := nr_sequencia_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estabelecimento := cd_estab_movto_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_documento := nr_sequencia_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_origem_documento := 1;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_debito_credito := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_consistencia := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ds_consistencia;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_validacao := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_validacao;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_centro_custo := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_centro_custo;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_cgc := cd_cgc_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_pessoa_fisica := cd_pessoa_fisica_w;
                            --ctb_online_pck.movimento_contabil_w(qt_indice_w_movto_w).ie_transitorio     :=  ie_transitorio;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_atributo := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_atributo;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_tabela := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_tabela;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_lote_contabil := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_lote_contabil;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_info := 1;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_tab_orig := nr_sequencia_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_classif_movto := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_seq_classif_movto;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_intercompany := ie_intercompany_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estab_intercompany := cd_estab_intercompany_w;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_sequencia_parametro := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_sequencia_parametro;
                            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_proj_rec := nr_seq_proj_rec_capa;
                        end;
                    end loop;
                    close c01;
                    end;
                end if;

                if (coalesce(vl_retorno_w,
                        0) <> 0) then
                    begin
                    /*if    (ie_acao_nf_w = '2') then
                      begin
                      if    (array_atributos_w(idx).ie_debito_credito = 'D') then
                        array_atributos_w(idx).ie_debito_credito  := 'C';
                      else
                        array_atributos_w(idx).ie_debito_credito  := 'D';
                      end if;

                      end;
                    end if;*/
                    if (coalesce(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_tipo_ordem,'X') <> 'T') and (ie_contab_nf_estab_w = 'EF') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_financeiro_w <> cd_estabelecimento_w) then
                        if (ie_acao_nf_w = '2') or (ie_nf_entrada_saida_w = 'S') then
                            if (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito = 'D') then
                                cd_estab_movto_w := cd_estab_financeiro_w;
                            end if;
                        else
                            if (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito = 'C') then
                                cd_estab_movto_w := cd_estab_financeiro_w;
                            end if;

                        end if;
                    end if;

                    qt_indice_w_movto_w := ctb_online_pck.movimento_contabil_w.count + 1;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_sequencia := qt_indice_w_movto_w;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].dt_movimento := dt_movimento_w;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].vl_movimento := vl_retorno_w;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_historico := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_historico;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_conta_contabil := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_conta_contabil;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_compl_historico := ds_compl_historico_w;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_agrupamento := nr_sequencia_w;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estabelecimento := cd_estab_movto_w;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_documento := nr_sequencia_w;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_origem_documento := 1;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_debito_credito := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_consistencia := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ds_consistencia;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_validacao := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_validacao;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_centro_custo := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_centro_custo;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_cgc := cd_cgc_w;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_pessoa_fisica := cd_pessoa_fisica_w;
                    --ctb_online_pck.movimento_contabil_w(qt_indice_w_movto_w).ie_transitorio     :=  ie_transitorio;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_atributo := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_atributo;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_tabela := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_tabela;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_lote_contabil := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_lote_contabil;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_info := 1;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_tab_orig := nr_sequencia_w;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_classif_movto := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_seq_classif_movto;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_intercompany := ie_intercompany_w;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estab_intercompany := cd_estab_intercompany_w;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_sequencia_parametro := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_sequencia_parametro;
                    ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_proj_rec := nr_seq_proj_rec_capa;
                    end;
                end if;

                update  nota_fiscal
                set     nr_lote_contabil = current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_lote_contabil
                where   nr_sequencia = nr_sequencia_w;

            end;
        elsif (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_tabela = 'NOTA_FISCAL_ITEM') then
            begin

            ds_comando_w   := 'select ' || current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_atributo || ' vl_retorno_w From Nota_fiscal_item ' || ' Where nr_sequencia = :nr_sequencia' || ' and nr_item_nf = :nr_item_nf';
            ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_w || ';nr_item_nf=' || current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_item_nf;

            Obter_Valor_Dinamico_Bv(ds_comando_w,ds_param_sql_w,vl_retorno_w);

            if (coalesce(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].vl_nf_compl_rateio_item,0) <> 0) then
                begin
                    vl_retorno_w := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].vl_nf_compl_rateio_item;
                end;
            end if;

            if (coalesce(vl_retorno_w,0) <> 0) and ((coalesce(nr_seq_nf_ref_compl_w::text, '') = '') or (ie_contab_nf_compl_w = 'N')) then
                begin
                select coalesce(max(a.cd_estabelecimento),cd_estabelecimento_w)
                into STRICT   cd_estab_centro_w
                from   centro_custo a
                where  a.cd_centro_custo = current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_centro_custo;

                if (coalesce(ie_contab_nf_estab_w,'EC') = 'EC') then
                    begin
                        cd_estab_movto_w := cd_estab_centro_w;
                    end;
                elsif (coalesce(ie_contab_nf_estab_w,'EF') = 'EF') then
                    begin
                        cd_estab_movto_w := cd_estabelecimento_w;
                    end;
                end if;

                qt_indice_w_movto_w := ctb_online_pck.movimento_contabil_w.count + 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_sequencia := qt_indice_w_movto_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].dt_movimento := dt_movimento_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].vl_movimento := vl_retorno_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_historico := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_historico;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_conta_contabil := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_conta_contabil;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_compl_historico := ds_compl_historico_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_agrupamento := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estabelecimento := cd_estab_movto_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_documento := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_origem_documento := 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_debito_credito := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_consistencia := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ds_consistencia;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_validacao := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_validacao;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_centro_custo := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_centro_custo;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_cgc := cd_cgc_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_pessoa_fisica := cd_pessoa_fisica_w;
                --ctb_online_pck.movimento_contabil_w(qt_indice_w_movto_w).ie_transitorio     :=  ie_transitorio;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_atributo := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_atributo;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_tabela := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_tabela;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_lote_contabil := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_lote_contabil;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_info := 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_tab_orig := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_classif_movto := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_seq_classif_movto;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_intercompany := ie_intercompany_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estab_intercompany := cd_estab_intercompany_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_sequencia_parametro := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_sequencia_parametro;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_proj_rec := nr_seq_proj_rec_capa;
                end;
            end if;
            end;
        elsif (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_tabela = 'NOTA_FISCAL_ITEM_TRIB') then
            begin
            ds_comando_w   := 'select ' || current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_atributo || ' vl_retorno_w From Nota_fiscal_item_trib ' || 'Where nr_sequencia = :nr_sequencia' || '  and nr_item_nf   = :nr_item_nf' || '  and cd_tributo   = :cd_tributo';
            ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_w || ';nr_item_nf=' || current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_item_nf || ';cd_tributo=' || current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_tributo;

            Obter_Valor_Dinamico_Bv(ds_comando_w,ds_param_sql_w,vl_retorno_w);

            if (coalesce(vl_retorno_w,0) <> 0) then
                begin

                cd_estab_movto_w := cd_estabelecimento_w;

                if (ie_contab_nf_estab_w = 'EF') and (coalesce(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_tipo_ordem,'X') <> 'T') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_financeiro_w <> cd_estabelecimento_w) then
                    if (ie_acao_nf_w = '2') or (ie_nf_entrada_saida_w = 'S') then
                        if (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito = 'D') then
                            cd_estab_movto_w := cd_estab_financeiro_w;
                        end if;
                    else
                        if (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito = 'C') then
                            cd_estab_movto_w := cd_estab_financeiro_w;
                        end if;
                    end if;
                end if;

                qt_indice_w_movto_w := ctb_online_pck.movimento_contabil_w.count + 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_sequencia := qt_indice_w_movto_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].dt_movimento := dt_movimento_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].vl_movimento := vl_retorno_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_historico := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_historico;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_conta_contabil := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_conta_contabil;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_compl_historico := ds_compl_historico_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_agrupamento := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estabelecimento := cd_estab_movto_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_documento := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_origem_documento := 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_debito_credito := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_consistencia := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ds_consistencia;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_validacao := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_validacao;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_centro_custo := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_centro_custo;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_cgc := cd_cgc_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_pessoa_fisica := cd_pessoa_fisica_w;
                --ctb_online_pck.movimento_contabil_w(qt_indice_w_movto_w).ie_transitorio     :=  ie_transitorio;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_atributo := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_atributo;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_tabela := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_tabela;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_lote_contabil := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_lote_contabil;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_info := 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_tab_orig := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_classif_movto := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_seq_classif_movto;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_intercompany := ie_intercompany_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estab_intercompany := cd_estab_intercompany_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_sequencia_parametro := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_sequencia_parametro;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_proj_rec := nr_seq_proj_rec_capa;
                end;
            end if;
            end;
        elsif (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_tabela = 'NOTA_FISCAL_TRIB') then
            begin

                ds_comando_w   := 'select ' || current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_atributo || ' vl_retorno_w From Nota_fiscal_Trib ' || ' Where nr_sequencia = :nr_sequencia' || ' and cd_tributo = :cd_tributo';
                ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_w || ';cd_tributo=' || current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_tributo;

                Obter_Valor_Dinamico_Bv(ds_comando_w,ds_param_sql_w,vl_retorno_w);

                if (coalesce(vl_retorno_w,0) <> 0) then
                    begin

                        cd_estab_movto_w := cd_estabelecimento_w;

                        if (ie_contab_nf_estab_w = 'EF') and (coalesce(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_tipo_ordem,'X') <> 'T') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_financeiro_w <> cd_estabelecimento_w) then
                            begin
                                if (ie_acao_nf_w = '2') or (ie_nf_entrada_saida_w = 'S') then
                                    if (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito = 'D') then
                                        cd_estab_movto_w := cd_estab_financeiro_w;
                                    end if;
                                else
                                    if (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito = 'C') then
                                        cd_estab_movto_w := cd_estab_financeiro_w;
                                    end if;
                                end if;
                            end;
                        end if;

                        qt_indice_w_movto_w := ctb_online_pck.movimento_contabil_w.count + 1;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_sequencia := qt_indice_w_movto_w;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].dt_movimento := dt_movimento_w;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].vl_movimento := vl_retorno_w;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_historico := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_historico;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_conta_contabil := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_conta_contabil;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_compl_historico := ds_compl_historico_w;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_agrupamento := nr_sequencia_w;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estabelecimento := cd_estab_movto_w;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_documento := nr_sequencia_w;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_origem_documento := 1;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_debito_credito := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_consistencia := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ds_consistencia;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_validacao := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_validacao;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_centro_custo := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_centro_custo;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_cgc := cd_cgc_w;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_pessoa_fisica := cd_pessoa_fisica_w;
                        --ctb_online_pck.movimento_contabil_w(qt_indice_w_movto_w).ie_transitorio     :=  ie_transitorio;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_atributo := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_atributo;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_tabela := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_tabela;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_lote_contabil := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_lote_contabil;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_info := 1;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_tab_orig := nr_sequencia_w;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_classif_movto := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nr_seq_classif_movto;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_intercompany := ie_intercompany_w;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estab_intercompany := cd_estab_intercompany_w;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_sequencia_parametro := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_sequencia_parametro;
                        ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_proj_rec := nr_seq_proj_rec_capa;

                    end;
                end if;

            end;
        elsif (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_tabela = 'NOTA_FISCAL_VENC_TRIB') then
            begin
            ds_comando_w   := 'select ' || current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].nm_atributo || ' vl_retorno_w From Nota_fiscal_venc_Trib ' || ' Where nr_sequencia = :nr_sequencia' || ' and cd_tributo = :cd_tributo' || ' and dt_vencimento = :dt_vencimento';
            ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_w || ';cd_tributo=' || current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_tributo || ';dt_vencimento=' || dt_vencimento_w;

            Obter_Valor_Dinamico_Bv(ds_comando_w,ds_param_sql_w,vl_retorno_w);

            if (coalesce(vl_retorno_w,0) <> 0) then
                begin

                cd_estab_movto_w := cd_estabelecimento_w;

                if (ie_contab_nf_estab_w = 'EF') and (coalesce(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_tipo_ordem,'X') <> 'T') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_financeiro_w <> cd_estabelecimento_w) then
                    begin
                    if (ie_acao_nf_w = '2') or (ie_nf_entrada_saida_w = 'S') then
                        if (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito = 'D') then
                            cd_estab_movto_w := cd_estab_financeiro_w;
                        end if;
                    else
                        if (current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito = 'C') then
                            cd_estab_movto_w := cd_estab_financeiro_w;
                        end if;
                    end if;
                    end;
                end if;

                qt_indice_w_movto_w := ctb_online_pck.movimento_contabil_w.count + 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_sequencia := qt_indice_w_movto_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].dt_movimento := dt_movimento_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].vl_movimento := vl_retorno_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_historico := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_historico;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_conta_contabil := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].cd_conta_contabil;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_compl_historico := ds_compl_historico_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_agrupamento := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estabelecimento := cd_estab_movto_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_documento := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_origem_documento := 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_debito_credito := current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos[idx].ie_debito_credito;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_consistencia := array_atributos_w[idx].ds_consistencia;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_validacao := array_atributos_w[idx].ie_validacao;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_centro_custo := array_atributos_w[idx].cd_centro_custo;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_cgc := cd_cgc_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_pessoa_fisica := cd_pessoa_fisica_w;
                --ctb_online_pck.movimento_contabil_w(qt_indice_w_movto_w).ie_transitorio     :=  ie_transitorio;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_atributo := array_atributos_w[idx].nm_atributo;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_tabela := array_atributos_w[idx].nm_tabela;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_lote_contabil := array_atributos_w[idx].nr_lote_contabil;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_info := 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_tab_orig := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_classif_movto := array_atributos_w[idx].nr_seq_classif_movto;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_intercompany := ie_intercompany_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estab_intercompany := cd_estab_intercompany_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_sequencia_parametro := array_atributos_w[idx].cd_sequencia_parametro;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_proj_rec := nr_seq_proj_rec_capa;
                end;
            end if;
            end;
        elsif (array_atributos_w[idx].nm_tabela = 'NOTA_FISCAL_ITEM_RATEIO') then
            begin

                ds_comando_w := 'select ' || array_atributos_w[idx].nm_atributo || ' vl_retorno_w From Nota_fiscal_item_rateio ' || ' Where nr_seq_nota = :nr_sequencia' || ' and nr_item_nf = :nr_item_nf' || ' and nr_sequencia = :nr_seq_item_rateio';

                ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_w || ';nr_item_nf=' || array_atributos_w[idx].nr_item_nf || ';nr_seq_item_rateio=' || array_atributos_w[idx].nr_seq_item_rateio;

                Obter_Valor_Dinamico_Bv(ds_comando_w,ds_param_sql_w,vl_retorno_w);

                if (coalesce(array_atributos_w[idx].vl_nf_compl_rateio_item,0) <> 0) then
                    begin
                    vl_retorno_w := array_atributos_w[idx].vl_nf_compl_rateio_item;
                    end;
                end if;

                qt_indice_w_movto_w := ctb_online_pck.movimento_contabil_w.count + 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_sequencia := qt_indice_w_movto_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].dt_movimento := dt_movimento_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].vl_movimento := vl_retorno_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_historico := array_atributos_w[idx].cd_historico;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_conta_contabil := array_atributos_w[idx].cd_conta_contabil;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_compl_historico := ds_compl_historico_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_agrupamento := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estabelecimento := cd_estab_movto_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_documento := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_origem_documento := 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_debito_credito := array_atributos_w[idx].ie_debito_credito;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_consistencia := array_atributos_w[idx].ds_consistencia;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_validacao := array_atributos_w[idx].ie_validacao;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_centro_custo := array_atributos_w[idx].cd_centro_custo;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_cgc := cd_cgc_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_pessoa_fisica := cd_pessoa_fisica_w;
                --ctb_online_pck.movimento_contabil_w(qt_indice_w_movto_w).ie_transitorio     :=  ie_transitorio;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_atributo := array_atributos_w[idx].nm_atributo;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_tabela := array_atributos_w[idx].nm_tabela;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_lote_contabil := array_atributos_w[idx].nr_lote_contabil;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_info := 1;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_tab_orig := nr_sequencia_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_classif_movto := array_atributos_w[idx].nr_seq_classif_movto;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_intercompany := ie_intercompany_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estab_intercompany := cd_estab_intercompany_w;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_sequencia_parametro := array_atributos_w[idx].cd_sequencia_parametro;
                ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_proj_rec := nr_seq_proj_rec_capa;

            end;
        elsif (array_atributos_w[idx].nm_tabela = 'NOTA_FISCAL_DESP_ADIC') then
            begin
            ds_comando_w   := 'select ' || array_atributos_w[idx].nm_atributo || ' vl_retorno_w From nota_fiscal_desp_adic ' || ' Where nr_sequencia = :nr_sequencia' || ' and nr_seq_nf = :nr_seq_nf';
            ds_param_sql_w := 'nr_sequencia=' || array_atributos_w[idx].nr_sequencia_desp || ';nr_seq_nf=' || nr_sequencia_w;

            Obter_Valor_Dinamico_Bv(ds_comando_w,ds_param_sql_w,vl_retorno_w);

            qt_indice_w_movto_w := ctb_online_pck.movimento_contabil_w.count + 1;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_sequencia := qt_indice_w_movto_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].dt_movimento := dt_movimento_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].vl_movimento := vl_retorno_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_historico := array_atributos_w[idx].cd_historico;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_conta_contabil := array_atributos_w[idx].cd_conta_contabil;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_compl_historico := ds_compl_historico_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_agrupamento := nr_sequencia_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estabelecimento := cd_estab_movto_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_documento := nr_sequencia_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_origem_documento := 1;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_debito_credito := array_atributos_w[idx].ie_debito_credito;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_consistencia := array_atributos_w[idx].ds_consistencia;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_validacao := array_atributos_w[idx].ie_validacao;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_centro_custo := array_atributos_w[idx].cd_centro_custo;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_cgc := cd_cgc_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_pessoa_fisica := cd_pessoa_fisica_w;
            --ctb_online_pck.movimento_contabil_w(qt_indice_w_movto_w).ie_transitorio     :=  ie_transitorio;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_atributo := array_atributos_w[idx].nm_atributo;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_tabela := array_atributos_w[idx].nm_tabela;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_lote_contabil := array_atributos_w[idx].nr_lote_contabil;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_info := 1;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_tab_orig := nr_sequencia_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_classif_movto := array_atributos_w[idx].nr_seq_classif_movto;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_intercompany := ie_intercompany_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estab_intercompany := cd_estab_intercompany_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_sequencia_parametro := array_atributos_w[idx].cd_sequencia_parametro;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_proj_rec := nr_seq_proj_rec_capa;
            end;
        elsif (array_atributos_w[idx].nm_tabela = 'FIS_RATEIO_TRIB_ITEM') then
            begin
            select vl_rateio
            into STRICT   vl_retorno_w
            from   fis_rateio_trib_item
            where  nr_seq_nota_fiscal = nr_sequencia_w
            and    nr_item_nf = array_atributos_w[idx].nr_item_nf
            and    cd_tributo = array_atributos_w[idx].cd_tributo;

            if (coalesce(array_atributos_w[idx].ie_tipo_ordem,'X') <> 'T') and (ie_contab_nf_estab_w = 'EF') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_financeiro_w <> cd_estabelecimento_w) then
                if (ie_acao_nf_w = '2') or (ie_nf_entrada_saida_w = 'S') then
                    if (array_atributos_w[idx].ie_debito_credito = 'D') then
                        cd_estab_movto_w := cd_estab_financeiro_w;
                    end if;
                else
                    if (array_atributos_w[idx].ie_debito_credito = 'C') then
                        cd_estab_movto_w := cd_estab_financeiro_w;
                    end if;

                end if;
            end if;

            qt_indice_w_movto_w := ctb_online_pck.movimento_contabil_w.count + 1;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_sequencia := qt_indice_w_movto_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].dt_movimento := dt_movimento_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].vl_movimento := vl_retorno_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_historico := array_atributos_w[idx].cd_historico;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_conta_contabil := array_atributos_w[idx].cd_conta_contabil;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_compl_historico := ds_compl_historico_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_agrupamento := nr_sequencia_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estabelecimento := cd_estab_movto_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_documento := nr_sequencia_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_origem_documento := 1;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_debito_credito := array_atributos_w[idx].ie_debito_credito;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ds_consistencia := array_atributos_w[idx].ds_consistencia;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_validacao := array_atributos_w[idx].ie_validacao;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_centro_custo := array_atributos_w[idx].cd_centro_custo;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_cgc := cd_cgc_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_pessoa_fisica := cd_pessoa_fisica_w;
            --ctb_online_pck.movimento_contabil_w(qt_indice_w_movto_w).ie_transitorio     :=  ie_transitorio;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_atributo := array_atributos_w[idx].nm_atributo;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nm_tabela := array_atributos_w[idx].nm_tabela;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_lote_contabil := array_atributos_w[idx].nr_lote_contabil;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_info := 1;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_tab_orig := nr_sequencia_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_classif_movto := array_atributos_w[idx].nr_seq_classif_movto;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].ie_intercompany := ie_intercompany_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_estab_intercompany := cd_estab_intercompany_w;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].cd_sequencia_parametro := array_atributos_w[idx].cd_sequencia_parametro;
            ctb_online_pck.movimento_contabil_w[qt_indice_w_movto_w].nr_seq_proj_rec := nr_seq_proj_rec_capa;
            end;
        end if;
        end;
    end if;
    end;
end loop;

array_atributos_w.delete;

if (ctb_online_pck.movimento_contabil_w.count > 0) then
    CALL ctb_online_pck.gerar_movimento_contabil(cd_tipo_lote_contabil_w,cd_estabelecimento_w,dt_movimento_w,nm_usuario_p,nr_grupo_contab_nf_w);
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_lote_nf_pck.ctb_contabiliza_nota_fiscal (nr_seq_nota_fiscal_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;
