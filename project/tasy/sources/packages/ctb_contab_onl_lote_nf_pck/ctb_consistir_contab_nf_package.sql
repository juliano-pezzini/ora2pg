-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ctb_contab_onl_lote_nf_pck.ctb_consistir_contab_nf (nr_seq_nota_fiscal_p bigint, cd_estabelecimento_p bigint, ie_mensagem_p text, nm_usuario_p text) AS $body$
DECLARE


cd_evento_w                 operacao_estoque.cd_evento%type;
ie_operacao_fiscal_w        operacao_nota.ie_operacao_fiscal%type;
nm_tabela_w                 evento_contabil_param.nm_tabela%type;
nm_atributo_w               evento_contabil_param.nm_atributo%type;
cd_conta_contabil_w         evento_contabil_param_estab.cd_conta_contabil%type;
ie_origem_conta_w           evento_contabil_param_estab.ie_origem_conta%type;
vl_contabil_w               nota_fiscal_conta.vl_contabil%type;
cd_cgc_w                    nota_fiscal.cd_cgc%type;
cd_pessoa_fisica_w          nota_fiscal.cd_pessoa_fisica%type;
cd_convenio_w               convenio.cd_convenio%type;
ie_tipo_convenio_w          convenio.ie_tipo_convenio%type;
cd_centro_custo_w           centro_custo.cd_centro_custo%type;
nr_nota_fiscal_w            nota_fiscal.nr_nota_fiscal%type;
cd_empresa_w                empresa.cd_empresa%type;
nr_ordem_compra_w           ordem_compra.nr_ordem_compra%type;
dt_movimento_w              ctb_mes_ref.dt_referencia%type;
cd_estab_destino_w          estabelecimento.cd_estabelecimento%type;
cd_estabelecimento_w        estabelecimento.cd_estabelecimento%type;
nr_seq_motivo_solic_w       solic_compra.nr_seq_motivo_solic%type;
nr_solic_compra_w           nota_fiscal_item.nr_solic_compra%type;
cd_operacao_nf_w            operacao_nota.cd_operacao_nf%type;
ie_so_sem_rateio_w          evento_contabil_param.ie_so_sem_rateio%type;
cd_tributo_w                evento_contabil_param.cd_tributo%type;
nr_lote_contabil_w          lote_contabil.nr_lote_contabil%type;
nr_item_nf_w                nota_fiscal_item.nr_item_nf%type;
nr_seq_evento_param_w       evento_contabil_param.nr_sequencia%type;
ie_contab_trib_retido_w     ctb_param_lote_nf.ie_contab_trib_retido%type;
ie_data_contab_est_nf_w     ctb_param_lote_nf.ie_data_contab_est_nf%type;
ie_data_contab_nf_w         ctb_param_lote_nf.ie_data_contab_nf%type;
cd_tipo_lote_contabil_w     evento_contabil_param.cd_tipo_lote_contabil%type;
cd_material_w               nota_fiscal_item.cd_material%type;
cd_procedimento_w           nota_fiscal_item.cd_procedimento%type;
ie_origem_proced_w          nota_fiscal_item.ie_origem_proced%type;
cd_conta_contabil_nf_w      nota_fiscal_item.cd_conta_contabil%type;
cd_centro_custo_nf_w        nota_fiscal_item.cd_centro_custo%type;
cd_local_estoque_w          nota_fiscal_item.cd_local_estoque%type;
cd_tributo_nf_w             nota_fiscal_trib.cd_tributo%type;
ie_origem_centro_w          evento_contabil_param_estab.ie_origem_centro%type;
cd_centro_custo_event_w     evento_contabil_param_estab.cd_centro_custo%type;
cd_centro_custo_evento_w    evento_contabil_param_estab.cd_centro_custo%type;
ie_centro_custo_w           conta_contabil.ie_centro_custo%type;
cd_historico_w              evento_contabil_param_estab.cd_historico%type;
qt_rateio_w                 bigint;
qt_centro_custo_w           bigint;
qt_evento_contabil_w        bigint;
ie_nota_item_w              nota_fiscal_consist.ie_nota_item%type;
ds_observacao_w             nota_fiscal_consist.ds_observacao%type;
cd_unidade_medida_compra_w  nota_fiscal_item.cd_unidade_medida_compra%type;
cd_unidade_medida_estoque_w nota_fiscal_item.cd_unidade_medida_estoque%type;
qt_item_nf_w                nota_fiscal_item.qt_item_nf%type;
qt_item_estoque_w           nota_fiscal_item.qt_item_estoque%type;
ds_observacao_item_w        nota_fiscal_item.ds_observacao%type;
ds_complemento_w            nota_fiscal_item.ds_complemento%type;
ie_tipo_ordem_w             ordem_compra.ie_tipo_ordem%type;
ie_debito_credito_w         evento_contabil_param.ie_debito_credito%type;
ds_razao_social_desp_w      pessoa_juridica.ds_razao_social%type;
nr_sequencia_desp_w         nota_fiscal_desp_adic.nr_sequencia%type;
nr_seq_rateio_trib_item_w   fis_rateio_trib_item.nr_sequencia%type;
qt_item_trib_w              bigint;
ie_contab_nf_compl_w        ctb_param_lote_nf.ie_contab_nf_compl%type;
nr_seq_nf_ref_w             nota_fiscal.nr_seq_nf_ref%type;
nr_seq_nf_ref_compl_w       nota_fiscal.nr_seq_nf_ref%type;
ie_acao_nf_w                nota_fiscal.ie_acao_nf%type;
nr_sequencia_ref_w          nota_fiscal.nr_sequencia_ref%type;
vl_nf_compl_total_item_nf_w nota_fiscal_item.vl_total_item_nf%type;
vl_nf_compl_mercadoria_w    nota_fiscal.vl_mercadoria%type;
nr_seq_item_rateio_w        nota_fiscal_item_rateio.nr_sequencia%type;
qt_nf_compl_itens_w         bigint;
vl_nf_compl_rateio_item_w   double precision;
vl_nf_compl_perc_item_w     double precision;
qt_nf_compl_contar_itens_w  bigint;
vl_nf_compl_acumulado_w     double precision;
vl_total_nota_w             nota_fiscal.vl_mercadoria%type;
qt_regra_rateio_w           bigint;
cd_conta_contabil_evento_w  evento_contabil_param_estab.cd_conta_contabil%type;
qt_regra_geracao_lote_w     bigint := 0;
ds_consistencia             varchar(255);
ie_entrada_saida_w          operacao_estoque.ie_entrada_saida%type;
cd_tipo_lote_contabil_est_w operacao_estoque.cd_tipo_lote_contabil%type;
ie_tipo_local_estoque_w     varchar(20);
vl_rateio_w                 double precision;
vl_total_rateio_w           double precision;
cd_estab_centro_w           smallint;
nr_seq_classif_movto_w      evento_contabil_param_estab.nr_seq_classif_movto%type;
ie_intercompany_w           ctb_movimento.ie_intercompany%type := 'N';
cd_estab_intercompany_w     ctb_movimento.cd_estab_intercompany%type;
cd_cgc_emitente_w           nota_fiscal.cd_cgc_emitente%type;
ds_comando_w                varchar(255);
ds_param_sql_w              varchar(2000);
vl_retorno_w                double precision;
nr_seq_proc_interno_w       nota_fiscal_item.nr_seq_proc_interno%type;
nr_seq_proj_rec_w           nota_fiscal_item.nr_seq_proj_rec%type;
vl_regra_w                  double precision;
ie_param_estab_w            evento_contabil_param.ie_param_estab%type;
cd_sequencia_parametro_w    parametros_conta_contabil.cd_sequencia_parametro%type;
nr_seq_proj_rec_capa        ctb_movimento.nr_seq_proj_rec%type;
cd_sequencia_parametro_nf_w nota_fiscal_item.cd_sequencia_parametro%type;
nr_grupo_contab_nf_w        operacao_nota.nr_seq_grupo_contab%type;


c01 CURSOR FOR
    SELECT a.nm_tabela,
            a.nm_atributo,
            b.cd_conta_contabil,
            b.ie_origem_conta,
            a.cd_tributo,
            a.ie_so_sem_rateio,
            a.nr_sequencia,
            coalesce(b.ie_origem_centro,'2') ie_origem_centro,
            b.cd_centro_custo,
            b.cd_historico,
            a.ie_debito_credito,
            b.nr_seq_classif_movto,
            coalesce(a.ie_param_estab,'N') ie_param_estab
    from   evento_contabil_param       a,
            evento_contabil_param_estab b
    where  a.cd_tipo_lote_contabil = b.cd_tipo_lote_contabil
    and    a.cd_evento = b.cd_evento
    and    a.nr_sequencia = b.nr_sequencia
    and    a.cd_evento = cd_evento_w
    and    a.cd_tipo_lote_contabil = cd_tipo_lote_contabil_w
    and    b.cd_estabelecimento = cd_estabelecimento_p
    and    qt_regra_geracao_lote_w > 0;

c02 CURSOR FOR
    SELECT a.cd_material,
            a.cd_procedimento,
            a.ie_origem_proced,
            a.cd_local_estoque,
            a.nr_solic_compra,
            a.cd_conta_contabil,
            a.cd_centro_custo,
            a.nr_item_nf,
            a.cd_unidade_medida_compra,
            a.cd_unidade_medida_estoque,
            a.qt_item_nf,
            a.qt_item_estoque,
            a.ds_observacao,
            a.ds_complemento,
            a.nr_seq_proc_interno,
            a.nr_seq_proj_rec,
			a.cd_sequencia_parametro
    from   nota_fiscal_item a
    where  a.nr_sequencia = nr_seq_nota_fiscal_p
    and    ((ie_so_sem_rateio_w = 'N') or not exists (SELECT 1
                                                      from   nota_fiscal_item_rateio c
                                                      where  c.nr_seq_nota = a.nr_sequencia
                                                      and    c.nr_item_nf = a.nr_item_nf));

c03 CURSOR FOR
    SELECT b.nr_item_nf,
            a.cd_conta_contabil,
            a.cd_centro_custo,
            a.cd_material,
            a.cd_local_estoque,
            a.cd_procedimento,
            a.ie_origem_proced,
            b.cd_tributo,
            a.nr_seq_proj_rec,
			a.cd_sequencia_parametro
    from   nota_fiscal_item      a,
            nota_fiscal_item_trib b
    where  b.nr_sequencia = nr_seq_nota_fiscal_p
    and    a.nr_sequencia = b.nr_sequencia
    and    a.nr_item_nf = b.nr_item_nf
    and    b.cd_tributo = cd_tributo_w
    and    ((ie_so_sem_rateio_w = 'N') or not exists (SELECT 1
                                                      from   nota_fiscal_item_rateio c
                                                      where  c.nr_seq_nota = a.nr_sequencia
                                                      and    c.nr_item_nf = a.nr_item_nf));

    c04 CURSOR FOR
    SELECT a.cd_tributo
    from   nota_fiscal_trib a
    where  a.nr_sequencia = nr_seq_nota_fiscal_p
    and    a.cd_tributo = cd_tributo_w
    and    (((ie_contab_trib_retido_w = 'S') and (coalesce(a.ie_retencao,'D') <> 'N')) or (ie_contab_trib_retido_w = 'N'));

c05 CURSOR FOR
    SELECT a.cd_tributo
    from   nota_fiscal_venc_trib a
    where  a.nr_sequencia = nr_seq_nota_fiscal_p
    and    a.cd_tributo = cd_tributo_w;

c06 CURSOR FOR
    SELECT a.nr_sequencia,
            coalesce(a.cd_conta_contabil,cd_conta_contabil_w) cd_conta_contabil,
            coalesce(a.cd_centro_custo,cd_centro_custo_w) cd_centro_custo
    from   nota_fiscal_item_rateio a
    where  a.nr_seq_nota = nr_seq_nota_fiscal_p
    and    a.nr_item_nf = nr_item_nf_w
    and    not exists (SELECT 1
            from   ctb_movimento b,
                    movimento_contabil_doc c
            where  b.nr_lote_contabil = nr_lote_contabil_w
            and    c.nr_documento = a.nr_seq_nota
            and    c.nr_seq_ctb_movto = b.nr_sequencia
            and    c.nm_tabela = 'NOTA_FISCAL_ITEM_RATEIO'
            and    c.nm_atributo = substr(nm_atributo_w,1,50));

c07 CURSOR FOR
    SELECT b.cd_conta_contabil,
            b.ds_razao_social,
            b.cd_cgc,
            a.nr_sequencia
    from   nota_fiscal c,
            pessoa_juridica b,
            nota_fiscal_desp_adic a
    where  a.nr_seq_nf = c.nr_sequencia
    and    a.nr_seq_nf = nr_seq_nota_fiscal_p
    and    c.nr_lote_contabil = nr_lote_contabil_w
    and    a.cd_cgc = b.cd_cgc;

    C08 CURSOR FOR
    SELECT cd_centro_custo,
            nr_sequencia
    from   fis_rateio_trib_item
    where  nr_seq_nota_fiscal = nr_seq_nota_fiscal_p
    and    nr_item_nf = nr_item_nf_w
    and    cd_tributo = cd_tributo_w;

c09 CURSOR FOR
    SELECT a.cd_material,
            a.cd_conta_contabil,
            a.cd_centro_custo,
            a.vl_total_item_nf,
            b.vl_mercadoria,
            a.nr_seq_proj_rec,
			a.cd_sequencia_parametro
    from   nota_fiscal_item a,
            nota_fiscal b
    where  a.nr_sequencia = nr_seq_nf_ref_compl_w
    and    a.nr_sequencia = b.nr_sequencia;

/* cursor para ler os rateios do item da nota a ser contabilizada */

c010 CURSOR FOR
    SELECT coalesce(cd_conta_contabil,cd_conta_contabil_w),
            coalesce(cd_centro_custo,cd_centro_custo_w),
            (coalesce(vl_rateio,0) + coalesce(vl_frete,0) + coalesce(vl_seguro,0) + coalesce(vl_despesa_acessoria,0) - coalesce(vl_desconto,0) + coalesce(vl_tributo,0))
    from   nota_fiscal_item_rateio r
    where  nr_seq_nota = nr_seq_nota_fiscal_p
    and    nr_item_nf = nr_item_nf_w
    and    ie_tipo_local_estoque_w <> '8'

union all

    SELECT coalesce(cd_conta_contabil,cd_conta_contabil_w),coalesce(cd_centro_custo,cd_centro_custo_w),(coalesce(vl_rateio,0) + coalesce(vl_frete,0) + coalesce(vl_seguro,0) + coalesce(vl_despesa_acessoria,0) - coalesce(vl_desconto,0) + coalesce(vl_tributo,0))
    from   nota_fiscal_item_rateio r
    where  nr_seq_nota = nr_seq_nota_fiscal_p
    and    nr_item_nf = nr_item_nf_w
    and    ie_tipo_local_estoque_w = '8';

BEGIN

current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.delete;

cd_empresa_w := Obter_Empresa_Estab(cd_estabelecimento_p);
nr_seq_proj_rec_capa := OBTER_PROJETO_NOTA_FISCAL(nr_seq_nota_fiscal_p);

/*
delete
from    nota_fiscal_consist
where   nr_seq_nota = nr_seq_nota_fiscal_p;
*/
select x.*
into STRICT   ie_contab_trib_retido_w,
        ie_data_contab_est_nf_w,
        ie_data_contab_nf_w,
        ie_contab_nf_compl_w
from (SELECT coalesce(a.ie_contab_trib_retido,'N'),
                a.ie_data_contab_est_nf,
                a.ie_data_contab_nf,
                a.ie_contab_nf_compl
        from   ctb_param_lote_nf a
        where  a.cd_empresa = cd_empresa_w
        and    coalesce(a.cd_estab_exclusivo,cd_estabelecimento_p) = cd_estabelecimento_p
        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;

select c.cd_evento,
        b.ie_operacao_fiscal,
        a.cd_cgc,
        a.cd_pessoa_fisica,
        a.nr_nota_fiscal,
        CASE WHEN ie_acao_nf=1 THEN               CASE WHEN ie_data_contab_nf_w='ES' THEN a.dt_entrada_saida WHEN ie_data_contab_nf_w='ATU' THEN a.dt_atualizacao WHEN ie_data_contab_nf_w='EST' THEN a.dt_atualizacao_estoque WHEN ie_data_contab_nf_w='OPE' THEN                       CASE WHEN Obter_Regra_Contab_Nf_Operacao(a.nr_sequencia)='ES' THEN a.dt_entrada_saida WHEN Obter_Regra_Contab_Nf_Operacao(a.nr_sequencia)='ATU' THEN a.dt_atualizacao WHEN Obter_Regra_Contab_Nf_Operacao(a.nr_sequencia)='EST' THEN a.dt_atualizacao_estoque  ELSE a.dt_emissao END   ELSE a.dt_emissao END   ELSE CASE WHEN ie_data_contab_est_nf_w='ES' THEN a.dt_entrada_saida WHEN ie_data_contab_est_nf_w='ATU' THEN a.dt_atualizacao WHEN ie_data_contab_est_nf_w='EST' THEN a.dt_atualizacao_estoque WHEN ie_data_contab_est_nf_w='OPE' THEN                       CASE WHEN Obter_Regra_Contab_Nf_Operacao(a.nr_sequencia)='ES' THEN a.dt_entrada_saida WHEN Obter_Regra_Contab_Nf_Operacao(a.nr_sequencia)='ATU' THEN a.dt_atualizacao WHEN Obter_Regra_Contab_Nf_Operacao(a.nr_sequencia)='EST' THEN a.dt_atualizacao_estoque  ELSE a.dt_emissao END   ELSE a.dt_emissao END  END  dt_movimento,
        a.nr_ordem_compra,
        b.cd_operacao_nf,
        a.cd_estabelecimento,
        a.nr_seq_nf_ref,
        a.ie_acao_nf,
        a.nr_sequencia_ref,
        a.vl_mercadoria,
        Obter_Convenio_Nf(a.nr_sequencia) cd_convenio,
        ie_entrada_saida,
        coalesce(cd_tipo_lote_contabil,0),
        a.cd_cgc_emitente,
        b.nr_seq_grupo_contab
into STRICT   cd_evento_w,
        ie_operacao_fiscal_w,
        cd_cgc_w,
        cd_pessoa_fisica_w,
        nr_nota_fiscal_w,
        dt_movimento_w,
        nr_ordem_compra_w,
        cd_operacao_nf_w,
        cd_estabelecimento_w,
        nr_seq_nf_ref_w,
        ie_acao_nf_w,
        nr_sequencia_ref_w,
        vl_total_nota_w,
        cd_convenio_w,
        ie_entrada_saida_w,
        cd_tipo_lote_contabil_est_w,
        cd_cgc_emitente_w,
        nr_grupo_contab_nf_w
from    nota_fiscal      a,
        operacao_nota    b,
        operacao_estoque c
where   a.cd_operacao_nf = b.cd_operacao_nf
and     b.cd_operacao_estoque = c.cd_operacao_estoque
and     a.nr_sequencia = nr_seq_nota_fiscal_p;

dt_movimento_w := coalesce(dt_movimento_w,clock_timestamp());

cd_tipo_lote_contabil_w := 2;

if (ie_operacao_fiscal_w = 'S') then
    begin
        cd_tipo_lote_contabil_w := 51;
    end;
end if;

if ie_entrada_saida_w = 'S' and cd_tipo_lote_contabil_est_w = 2 and cd_tipo_lote_contabil_W = 51 then

    begin
    ds_consistencia := substr(wheb_mensagem_pck.get_texto(1077301,null),1,255);
    CALL gravar_nota_fiscal_consist(nr_seq_nota_fiscal_p,
                                ds_consistencia,
                                'S',
                                'N',
                                ds_consistencia,
                                nm_usuario_p,
                                'S',
                                0);
    end;

end if;

if (coalesce(cd_convenio_w,0) <> 0) then
    ie_tipo_convenio_w := Obter_Tipo_Convenio(cd_convenio_w);
end if;

if (coalesce(nr_ordem_compra_w,0) <> 0) then

    select coalesce(max(ie_tipo_ordem),''),
            max(a.cd_estabelecimento)
    into STRICT   ie_tipo_ordem_w,
            cd_estab_destino_w
    from   ordem_compra a
    where  a.nr_ordem_compra = nr_ordem_compra_w;

end if;

begin
select count(1)
into STRICT   qt_evento_contabil_w
from   evento_contabil_param       a,
        evento_contabil_param_estab b
where  a.cd_tipo_lote_contabil = b.cd_tipo_lote_contabil
and    a.cd_evento = b.cd_evento
and    a.nr_sequencia = b.nr_sequencia
and    a.cd_evento = cd_evento_w
and    a.cd_tipo_lote_contabil = cd_tipo_lote_contabil_w;
exception
    when others then
        qt_evento_contabil_w := 0;
end;

if (qt_evento_contabil_w = 0 and coalesce(cd_evento_w,0) != 0) then
    begin
    ds_consistencia := substr(wheb_mensagem_pck.get_texto(676177,null),1,255);
    CALL gravar_nota_fiscal_consist(nr_seq_nota_fiscal_p,
                                ds_consistencia,
                                'S',
                                'N',
                                ds_consistencia,
                                nm_usuario_p,
                                'S',
                                0);
    end;
end if;

begin
select count(1)
into STRICT   qt_regra_geracao_lote_w
from (SELECT ie_periodo,
                qt_periodo
        from   ctb_regra_geracao_lote a
        where  a.cd_tipo_lote_contabil = cd_tipo_lote_contabil_w
        and    a.cd_empresa = cd_empresa_w
        and    coalesce(cd_estab_exclusivo,cd_estabelecimento_w) = cd_estabelecimento_w
        order  by coalesce(cd_estab_exclusivo,0) desc) y LIMIT 1;
exception
    when others then
        qt_regra_geracao_lote_w := 0;
end;

if (coalesce(qt_regra_geracao_lote_w,0) = 0) and (ie_mensagem_p = 'S') then
    begin
    ds_consistencia := wheb_mensagem_pck.get_texto(709033,null) || ': ' || wheb_mensagem_pck.get_texto(709138,null) || '. ';
    if (cd_tipo_lote_contabil_w = 51) then
        begin
        ds_consistencia := wheb_mensagem_pck.get_texto(709033,null) || ': ' || wheb_mensagem_pck.get_texto(709139,null) || '. ';
        end;
    end if;

    CALL gravar_nota_fiscal_consist(nr_seq_nota_fiscal_p,
                                ds_consistencia,
                                'S',
                                'N',
                                ds_consistencia,
                                nm_usuario_p,
                                'S',
                                0);

    end;
end if;

if (coalesce(qt_regra_geracao_lote_w,0) <> 0 and coalesce(cd_evento_w,0) <> 0) then
    begin
    nr_lote_contabil_w      := ctb_online_pck.get_lote_contabil( cd_tipo_lote_contabil_w,
                                                            cd_estabelecimento_w,
                                                            dt_movimento_w,
                                                            nm_usuario_p,
                                                            null,
                                                            null,
                                                            nr_grupo_contab_nf_w);
    end;
end if;

ie_intercompany_w := holding_pck.get_se_intercompany_cnpj(cd_estabelecimento_w,cd_cgc_emitente_w);

if (ie_intercompany_w = 'S') then
    cd_estab_intercompany_w := holding_pck.get_estab_intercompany(cd_cgc_emitente_w);
end if;

open C01;
loop
    fetch C01
        into nm_tabela_w,
              nm_atributo_w,
              cd_conta_contabil_w,
              ie_origem_conta_w,
              cd_tributo_w,
              ie_so_sem_rateio_w,
              nr_seq_evento_param_w,
              ie_origem_centro_w,
              cd_centro_custo_event_w,
              cd_historico_w,
              ie_debito_credito_w,
              nr_seq_classif_movto_w,
              ie_param_estab_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
    begin
    cd_sequencia_parametro_w        := null;
    cd_conta_contabil_evento_w := cd_conta_contabil_w;

        if (nm_tabela_w = 'NOTA_FISCAL') then
            begin
            select coalesce(sum(a.vl_contabil),0)
            into STRICT   vl_contabil_w
            from   nota_fiscal_conta a
            where  a.nr_seq_nf = nr_seq_nota_fiscal_p;

            if (vl_contabil_w = 0) and (ie_origem_conta_w <> '10') then
                SELECT * FROM ctb_online_pck.Define_Conta_Contabil(ie_origem_conta_w, cd_estabelecimento_w, cd_cgc_w, cd_pessoa_fisica_w, ie_tipo_convenio_w, cd_convenio_w, null, null, null, null, cd_conta_contabil_w, cd_centro_custo_w, 'NF: ' || nr_nota_fiscal_w || ' Seq.:' || nr_seq_nota_fiscal_p || ' atrib: ' || nm_atributo_w, dt_movimento_w, null, null, cd_operacao_nf_w, null, null, nr_seq_proj_rec_capa) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
                cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();
            elsif (ie_origem_conta_w = '10') then
                select Obter_Conta_Transf_Est_Pj(cd_empresa_w,
                                                  cd_estabelecimento_w,
                                                  CASE WHEN ie_operacao_fiscal_w='E' THEN cd_estab_destino_w WHEN ie_operacao_fiscal_w='S' THEN cd_estabelecimento_w END ,
                                                  cd_cgc_w,
                                                  dt_movimento_w)
                into STRICT   cd_conta_contabil_w
;
            end if;

            if (ie_origem_centro_w = '1') then
                begin
                cd_centro_custo_w := cd_centro_custo_event_w;
                end;
            end if;

            if (ctb_online_pck.get_exige_centro_conta(cd_conta_contabil_w) = 'N') then
                begin
                cd_centro_custo_w := null;
                end;
            end if;
            if (ie_origem_conta_w = '1') and (coalesce(cd_conta_contabil_w,'0') = '0') and (coalesce(cd_conta_contabil_evento_w,'0') <> '0') then
                cd_conta_contabil_w := cd_conta_contabil_evento_w;
            end if;

            if (coalesce(cd_conta_contabil_w,'0') <> '0') then
                begin
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count + 1).nm_tabela := nm_tabela_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nm_atributo := nm_atributo_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nr_seq_nota_fiscal := nr_seq_nota_fiscal_p;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_evento := cd_evento_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_operacao_fiscal := ie_operacao_fiscal_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nr_seq_evento_param := nr_seq_evento_param_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_conta_contabil := cd_conta_contabil_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_historico := cd_historico_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_centro_custo := cd_centro_custo_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_tipo_ordem := ie_tipo_ordem_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nr_lote_contabil := nr_lote_contabil_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_debito_credito := ie_debito_credito_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nr_seq_classif_movto := nr_seq_classif_movto_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_intercompany := ie_intercompany_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_estab_intercompany := cd_estab_intercompany_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_sequencia_parametro := cd_sequencia_parametro_w;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nr_seq_proj_rec := nr_seq_proj_rec_w;

                if (ie_acao_nf_w = '2') then
                    begin
                    if (ie_debito_credito_w = 'D') then
                        current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_debito_credito := 'C';
                    else
                        current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_debito_credito := 'D';
                    end if;
                    end;
                end if;
                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_origem_centro := ie_origem_centro_w;
                end;
            end if;

            end;
        elsif (nm_tabela_w = 'NOTA_FISCAL_ITEM') then
            begin

            nr_seq_nf_ref_compl_w := nr_seq_nf_ref_w;

            if (ie_contab_nf_compl_w = 'S') and (coalesce(nr_seq_nf_ref_compl_w,0) <> 0) then
                begin
                if (ie_acao_nf_w = '2') then
                    begin
                    select  max(nr_seq_nf_ref)
                    into STRICT    nr_seq_nf_ref_compl_w
                    from    nota_fiscal
                    where   nr_sequencia = nr_sequencia_ref_w;
                    end;
                end if;

                select count(a.nr_sequencia)
                into STRICT   qt_nf_compl_itens_w
                from   nota_fiscal_item a,
                        nota_fiscal      b
                where  a.nr_sequencia = nr_seq_nf_ref_compl_w
                and    a.nr_sequencia = b.nr_sequencia;

                qt_nf_compl_contar_itens_w := 0;

                    open C09;
                    loop
                        fetch C09
                            into cd_material_w,
                                  cd_conta_contabil_w,
                                  cd_centro_custo_w,
                                  vl_nf_compl_total_item_nf_w,
                                  vl_nf_compl_mercadoria_w,
                                  nr_seq_proj_rec_w,
								  cd_sequencia_parametro_w;
                        EXIT WHEN NOT FOUND; /* apply on C09 */
                        begin

                            qt_nf_compl_contar_itens_w := qt_nf_compl_contar_itens_w + 1;
                            vl_nf_compl_perc_item_w    := 0;
                            vl_nf_compl_rateio_item_w  := 0;

                            if (qt_nf_compl_itens_w > qt_nf_compl_contar_itens_w) then
                                begin
                                vl_nf_compl_perc_item_w   := round((vl_nf_compl_total_item_nf_w * 100) / vl_nf_compl_mercadoria_w,2);
                                vl_nf_compl_rateio_item_w := round((vl_total_nota_w * vl_nf_compl_perc_item_w) / 100,2);
                                vl_nf_compl_acumulado_w   := vl_nf_compl_acumulado_w + vl_nf_compl_rateio_item_w;
                                end;
                            else
                                begin
                                vl_nf_compl_rateio_item_w := vl_total_nota_w - vl_nf_compl_acumulado_w;
                                end;
                            end if;

                            if (ie_origem_conta_w = '1') and
                              --(nvl(cd_conta_contabil_w,'0') = '0') and
                                (coalesce(cd_conta_contabil_evento_w,'0') <> '0') then
                                cd_conta_contabil_w := cd_conta_contabil_evento_w;
                            end if;

                            if (ctb_online_pck.get_exige_centro_conta(cd_conta_contabil_w) = 'N') then
                                begin
                                cd_centro_custo_w := null;
                                end;
                            end if;

                            if (coalesce(cd_conta_contabil_w,'0') <> '0') then
                                begin
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count + 1).nm_tabela := nm_tabela_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nm_atributo := nm_atributo_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nr_seq_nota_fiscal := nr_seq_nota_fiscal_p;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_evento := cd_evento_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_operacao_fiscal := ie_operacao_fiscal_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nr_seq_evento_param := nr_seq_evento_param_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nr_item_nf := nr_item_nf_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_conta_contabil := cd_conta_contabil_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_historico := cd_historico_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_centro_custo := cd_centro_custo_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_material := cd_material_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_unidade_medida_compra := cd_unidade_medida_compra_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_unidade_medida_estoque := cd_unidade_medida_estoque_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).qt_item_nf := qt_item_nf_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).qt_item_estoque := qt_item_estoque_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ds_observacao_item := ds_observacao_item_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ds_complemento := ds_complemento_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_tipo_ordem := ie_tipo_ordem_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nr_lote_contabil := nr_lote_contabil_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_debito_credito := ie_debito_credito_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nr_seq_classif_movto := nr_seq_classif_movto_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_intercompany := ie_intercompany_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_estab_intercompany := cd_estab_intercompany_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).cd_sequencia_parametro := cd_sequencia_parametro_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nr_seq_proj_rec := nr_seq_proj_rec_w;

                                if (ie_acao_nf_w = '2') then
                                    begin
                                    if (ie_debito_credito_w = 'D') then
                                        current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_debito_credito := 'C';
                                    else
                                        current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_debito_credito := 'D';
                                    end if;
                                    end;
                                end if;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).ie_origem_centro := ie_origem_centro_w;
                                current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).vl_nf_compl_rateio_item := vl_nf_compl_rateio_item_w;
                                end;
                            end if;
                        end;
                    end loop;
                    close C09;
                    end;
                else
                    begin
                    open C02;
                    loop
                        fetch C02
                            into cd_material_w,
                                  cd_procedimento_w,
                                  ie_origem_proced_w,
                                  cd_local_estoque_w,
                                  nr_solic_compra_w,
                                  cd_conta_contabil_nf_w,
                                  cd_centro_custo_nf_w,
                                  nr_item_nf_w,
                                  cd_unidade_medida_compra_w,
                                  cd_unidade_medida_estoque_w,
                                  qt_item_nf_w,
                                  qt_item_estoque_w,
                                  ds_observacao_item_w,
                                  ds_complemento_w,
                                  nr_seq_proc_interno_w,
                                  nr_seq_proj_rec_w,
								  cd_sequencia_parametro_nf_w;
                        EXIT WHEN NOT FOUND; /* apply on C02 */
                        begin
                            cd_sequencia_parametro_w := null;
                            cd_centro_custo_evento_w := null;

                            if (ie_origem_centro_w = '1') then
                                cd_centro_custo_evento_w := cd_centro_custo_event_w;
                            end if;

                            select coalesce(max(ie_tipo_local),'0')
                            into STRICT   ie_tipo_local_estoque_w
                            from   local_estoque
                            where  cd_local_estoque = cd_local_estoque_w;

                            if (ie_origem_conta_w = '1') and (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') then
                                cd_conta_contabil_w := cd_conta_contabil_w;
                            else
                                if (coalesce(cd_conta_contabil_nf_w::text, '') = '') or (coalesce(cd_centro_custo_nf_w::text, '') = '') or (ie_origem_conta_w in ('11', '16', '17', '18', '19')) then

                                    cd_conta_contabil_w      := cd_conta_contabil_nf_w;
                                    cd_centro_custo_w        := cd_centro_custo_nf_w;
									cd_sequencia_parametro_w := cd_sequencia_parametro_nf_w;

                                    begin
                                    select count(*)
                                    into STRICT   qt_rateio_w
                                    from (SELECT 1
                                            from   nota_fiscal_item_rateio r
                                            where  nr_seq_nota = nr_seq_nota_fiscal_p
                                            and    nr_item_nf = nr_item_nf_w) alias1;
                                    exception
                                        when others then
                                            qt_rateio_w := 0;
                                    end;

                                    if (qt_rateio_w = 0) then
                                        if (nr_solic_compra_w IS NOT NULL AND nr_solic_compra_w::text <> '') then
                                            begin
                                            select  nr_seq_motivo_solic
                                            into STRICT    nr_seq_motivo_solic_w
                                            from    solic_compra
                                            where   nr_solic_compra = nr_solic_compra_w;
                                            end;
                                        end if;

                                        vl_regra_w               := obter_valor_item_regra(nr_seq_nota_fiscal_p, nr_item_nf_w);
                                        SELECT * FROM ctb_online_pck.Define_Conta_Contabil(ie_origem_conta_w, cd_estabelecimento_w, null, null, ie_tipo_convenio_w, cd_convenio_w, cd_material_w, cd_procedimento_w, ie_origem_proced_w, cd_local_estoque_w, cd_conta_contabil_w, cd_centro_custo_w, Wheb_mensagem_pck.get_texto(795577) || ' ' || nr_nota_fiscal_w || ' ' || Wheb_mensagem_pck.get_texto(795579) || ' ' || nr_seq_nota_fiscal_p, dt_movimento_w, 'N', nr_seq_motivo_solic_w, cd_operacao_nf_w, nr_seq_proc_interno_w, nr_seq_proj_rec_w, vl_regra_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
                                        cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();
                                    end if;
                                end if;
                                if (ie_param_estab_w = 'N') and (ie_origem_conta_w not in ('11','14','16','17','18','19')) then
                                    begin
                                    if (cd_conta_contabil_nf_w IS NOT NULL AND cd_conta_contabil_nf_w::text <> '') then
                                        cd_conta_contabil_w      := cd_conta_contabil_nf_w;
										cd_sequencia_parametro_w := cd_sequencia_parametro_nf_w;
                                    end if;
                                    if (cd_centro_custo_nf_w IS NOT NULL AND cd_centro_custo_nf_w::text <> '') then
                                        cd_centro_custo_w := cd_centro_custo_nf_w;
                                    end if;
                                    end;
                                end if;
                            end if;

                            if (ctb_online_pck.get_exige_centro_conta(cd_conta_contabil_w) = 'N') then
                                begin
                                cd_centro_custo_nf_w     := null;
                                cd_centro_custo_evento_w := null;
                                end;
                            else
                                if (coalesce(cd_centro_custo_nf_w,0) = 0) then
                                    select  max(cd_centro_custo)
                                    into STRICT    cd_centro_custo_nf_w
                                    from    local_estoque
                                    where   cd_local_estoque = cd_local_estoque_w;
                                end if;
                            end if;

                            begin
                            qt_regra_rateio_w := 0;
                            vl_total_rateio_w := 0;

                            select 1
                            into STRICT   qt_regra_rateio_w
                            from   evento_contabil_param b
                            where  b.cd_tipo_lote_contabil = cd_tipo_lote_contabil_w
                            and    b.cd_evento = cd_evento_w
                            and    b.nm_tabela = 'NOTA_FISCAL_ITEM_RATEIO'  LIMIT 1;
                            exception
                                when others then
                                    qt_regra_rateio_w := 0;
                            end;

                            /*  contabilizar o rateio dos valores por centro de custo e conta */

                            /*  alterado por marcus em 20/04/2006 para atender situacoes com e sem rateio */

                            if (nm_atributo_w like '%VL_TOTAL_ITEM_NF%') and (qt_regra_rateio_w = 0) then

                                open c010;
                                loop
                                    fetch c010
                                        into cd_conta_contabil_w,
                                              cd_centro_custo_w,
                                              vl_rateio_w;
                                    EXIT WHEN NOT FOUND; /* apply on c010 */
                                    begin
                                    vl_total_rateio_w := vl_total_rateio_w + vl_rateio_w;

                                    select coalesce(max(cd_estabelecimento),cd_estabelecimento_w)
                                    into STRICT   cd_estab_centro_w
                                    from   centro_custo
                                    where  cd_centro_custo = cd_centro_custo_w;

                                    current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count + 1).nm_tabela := 'NOTA_FISCAL_ITEM_RATEIO';
                                    array_atributos_w(current_setting('ctb_contab_onl_lote_nf_pck.array_atributos_w')::campos.count).nm_atributo := 'VL_RATEIO';
                                    array_atributos_w[array_atributos_w.count].nr_seq_nota_fiscal := nr_seq_nota_fiscal_p;
                                    array_atributos_w[array_atributos_w.count].cd_evento := cd_evento_w;
                                    array_atributos_w[array_atributos_w.count].ie_operacao_fiscal := ie_operacao_fiscal_w;
                                    array_atributos_w[array_atributos_w.count].nr_seq_evento_param := nr_seq_evento_param_w;
                                    array_atributos_w[array_atributos_w.count].nr_item_nf := nr_item_nf_w;
                                    array_atributos_w[array_atributos_w.count].cd_conta_contabil := cd_conta_contabil_w;
                                    array_atributos_w[array_atributos_w.count].cd_historico := cd_historico_w;
                                    array_atributos_w[array_atributos_w.count].cd_centro_custo := cd_centro_custo_w;
                                    array_atributos_w[array_atributos_w.count].cd_material := cd_material_w;
                                    array_atributos_w[array_atributos_w.count].cd_unidade_medida_compra := cd_unidade_medida_compra_w;
                                    array_atributos_w[array_atributos_w.count].cd_unidade_medida_estoque := cd_unidade_medida_estoque_w;
                                    array_atributos_w[array_atributos_w.count].qt_item_nf := qt_item_nf_w;
                                    array_atributos_w[array_atributos_w.count].qt_item_estoque := qt_item_estoque_w;
                                    array_atributos_w[array_atributos_w.count].ds_observacao_item := ds_observacao_item_w;
                                    array_atributos_w[array_atributos_w.count].ds_complemento := ds_complemento_w;
                                    array_atributos_w[array_atributos_w.count].ie_tipo_ordem := ie_tipo_ordem_w;
                                    array_atributos_w[array_atributos_w.count].nr_lote_contabil := nr_lote_contabil_w;
                                    array_atributos_w[array_atributos_w.count].ie_debito_credito := ie_debito_credito_w;
                                    array_atributos_w[array_atributos_w.count].nr_seq_classif_movto := nr_seq_classif_movto_w;
                                    array_atributos_w[array_atributos_w.count].ie_intercompany := ie_intercompany_w;
                                    array_atributos_w[array_atributos_w.count].cd_estab_intercompany := cd_estab_intercompany_w;
                                    array_atributos_w[array_atributos_w.count].cd_sequencia_parametro := cd_sequencia_parametro_w;
                                    array_atributos_w[array_atributos_w.count].nr_seq_proj_rec := nr_seq_proj_rec_w;

                                    if (ie_acao_nf_w = '2') then
                                        begin
                                        if (ie_debito_credito_w = 'D') then
                                            array_atributos_w[array_atributos_w.count].ie_debito_credito := 'C';
                                        else
                                            array_atributos_w[array_atributos_w.count].ie_debito_credito := 'D';
                                        end if;
                                        end;
                                    end if;
                                    array_atributos_w[array_atributos_w.count].ie_origem_centro := ie_origem_centro_w;
                                    array_atributos_w[array_atributos_w.count].vl_nf_compl_rateio_item := vl_rateio_w;

                                    end;
                                end loop;
                                close c010;
                            end if;

                            ds_comando_w   := 'select ' || nm_atributo_w || ' vl_retorno_w From Nota_fiscal_item ' || ' Where nr_sequencia = :nr_sequencia' || ' and nr_item_nf = :nr_item_nf';
                            ds_param_sql_w := 'nr_sequencia=' || nr_seq_nota_fiscal_p || ';nr_item_nf=' || nr_item_nf_w;

                            Obter_Valor_Dinamico_Bv(ds_comando_w,ds_param_sql_w,vl_retorno_w);

                            /*           marcus - se nao teve rateio contabiliza o vl_total_item_nf do item da nota */

                            if (coalesce(vl_retorno_w,0) <> 0) and (vl_total_rateio_w = 0) and
                                ((coalesce(nr_seq_nf_ref_compl_w::text, '') = '') or (ie_contab_nf_compl_w = 'N')) then

                                if (ctb_online_pck.get_exige_centro_conta(cd_conta_contabil_w) = 'S') and (cd_centro_custo_evento_w IS NOT NULL AND cd_centro_custo_evento_w::text <> '') and (ie_origem_centro_w = '1') then
                                    cd_centro_custo_nf_w := cd_centro_custo_evento_w;
                                end if;

                                array_atributos_w[array_atributos_w.count + 1].nm_tabela := nm_tabela_w;
                                array_atributos_w[array_atributos_w.count].nm_atributo := nm_atributo_w;
                                array_atributos_w[array_atributos_w.count].nr_seq_nota_fiscal := nr_seq_nota_fiscal_p;
                                array_atributos_w[array_atributos_w.count].cd_evento := cd_evento_w;
                                array_atributos_w[array_atributos_w.count].ie_operacao_fiscal := ie_operacao_fiscal_w;
                                array_atributos_w[array_atributos_w.count].nr_seq_evento_param := nr_seq_evento_param_w;
                                array_atributos_w[array_atributos_w.count].nr_item_nf := nr_item_nf_w;
                                array_atributos_w[array_atributos_w.count].cd_conta_contabil := cd_conta_contabil_w;
                                array_atributos_w[array_atributos_w.count].cd_historico := cd_historico_w;
                                array_atributos_w[array_atributos_w.count].cd_centro_custo := cd_centro_custo_nf_w;
                                array_atributos_w[array_atributos_w.count].cd_material := cd_material_w;
                                array_atributos_w[array_atributos_w.count].cd_unidade_medida_compra := cd_unidade_medida_compra_w;
                                array_atributos_w[array_atributos_w.count].cd_unidade_medida_estoque := cd_unidade_medida_estoque_w;
                                array_atributos_w[array_atributos_w.count].qt_item_nf := qt_item_nf_w;
                                array_atributos_w[array_atributos_w.count].qt_item_estoque := qt_item_estoque_w;
                                array_atributos_w[array_atributos_w.count].ds_observacao_item := ds_observacao_item_w;
                                array_atributos_w[array_atributos_w.count].ds_complemento := ds_complemento_w;
                                array_atributos_w[array_atributos_w.count].ie_tipo_ordem := ie_tipo_ordem_w;
                                array_atributos_w[array_atributos_w.count].nr_lote_contabil := nr_lote_contabil_w;
                                array_atributos_w[array_atributos_w.count].ie_debito_credito := ie_debito_credito_w;
                                array_atributos_w[array_atributos_w.count].nr_seq_classif_movto := nr_seq_classif_movto_w;
                                array_atributos_w[array_atributos_w.count].ie_intercompany := ie_intercompany_w;
                                array_atributos_w[array_atributos_w.count].cd_estab_intercompany := cd_estab_intercompany_w;
                                array_atributos_w[array_atributos_w.count].cd_sequencia_parametro := cd_sequencia_parametro_w;
                                array_atributos_w[array_atributos_w.count].nr_seq_proj_rec := nr_seq_proj_rec_w;

                                if (ie_acao_nf_w = '2') then
                                    begin
                                    if (ie_debito_credito_w = 'D') then
                                        array_atributos_w[array_atributos_w.count].ie_debito_credito := 'C';
                                    else
                                        array_atributos_w[array_atributos_w.count].ie_debito_credito := 'D';
                                    end if;
                                    end;
                                end if;
                                array_atributos_w[array_atributos_w.count].ie_origem_centro := ie_origem_centro_w;
                            end if;

                        end;
                    end loop;
                    close C02;
                    end;
                end if;
            end;
        elsif (nm_tabela_w = 'NOTA_FISCAL_ITEM_TRIB') then
            begin
            open C03;
            loop
                fetch C03
                    into nr_item_nf_w,
                          cd_conta_contabil_nf_w,
                          cd_centro_custo_nf_w,
                          cd_material_w,
                          cd_local_estoque_w,
                          cd_procedimento_w,
                          ie_origem_proced_w,
                          cd_tributo_nf_w,
                          nr_seq_proj_rec_w,
						  cd_sequencia_parametro_nf_w;
                EXIT WHEN NOT FOUND; /* apply on C03 */
                begin
                cd_sequencia_parametro_w := null;
                if (ie_operacao_fiscal_w = 'S') or (coalesce(cd_centro_custo_nf_w::text, '') = '') or (coalesce(cd_conta_contabil_nf_w::text, '') = '') then

                    cd_centro_custo_w   := cd_centro_custo_nf_w;
                    SELECT * FROM ctb_online_pck.Define_Conta_Contabil(ie_origem_conta_w, cd_estabelecimento_w, null, null, ie_tipo_convenio_w, cd_convenio_w, cd_material_w, cd_procedimento_w, ie_origem_proced_w, cd_local_estoque_w, cd_conta_contabil_w, cd_centro_custo_w, 'NF Trib.Item:' || nr_nota_fiscal_w || ' Seq.:' || nr_seq_nota_fiscal_p || ' Trib: ' || nm_atributo_w, dt_movimento_w, null, null, cd_operacao_nf_w, null, null, nr_seq_proj_rec_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
                    cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();
                else

                    cd_conta_contabil_w      := cd_conta_contabil_nf_w;
					cd_sequencia_parametro_w := cd_sequencia_parametro_nf_w;
                    cd_centro_custo_w        := cd_centro_custo_nf_w;

                end if;

                if (ctb_online_pck.get_exige_centro_conta(cd_conta_contabil_w) = 'N') then
                    begin
                        cd_centro_custo_w := null;
                    end;
                end if;
                if (ie_origem_conta_w = '1') and (coalesce(cd_conta_contabil_evento_w,'0') <> '0') then
                    cd_conta_contabil_w := cd_conta_contabil_evento_w;
                end if;
                select count(nr_sequencia) qt_item_trib
                into STRICT   qt_item_trib_w
                from   fis_rateio_trib_item
                where  nr_seq_nota_fiscal = nr_seq_nota_fiscal_p
                and    nr_item_nf = nr_item_nf_w
                and    cd_tributo = cd_tributo_nf_w;

                if (coalesce(qt_item_trib_w,0) > 0) and (ie_origem_centro_w = 2) then
                    begin
                    open C08;
                    loop
                        fetch C08
                            into cd_centro_custo_w,
                                  nr_seq_rateio_trib_item_w;
                        EXIT WHEN NOT FOUND; /* apply on C08 */
                        begin
                        if (coalesce(cd_conta_contabil_w,'0') <> '0') then
                            begin
                            array_atributos_w[array_atributos_w.count + 1].nm_tabela := 'FIS_RATEIO_TRIB_ITEM';
                            array_atributos_w[array_atributos_w.count].nm_atributo := nm_atributo_w;
                            array_atributos_w[array_atributos_w.count].nr_seq_nota_fiscal := nr_seq_nota_fiscal_p;
                            array_atributos_w[array_atributos_w.count].cd_evento := cd_evento_w;
                            array_atributos_w[array_atributos_w.count].ie_operacao_fiscal := ie_operacao_fiscal_w;
                            array_atributos_w[array_atributos_w.count].nr_seq_evento_param := nr_seq_evento_param_w;
                            array_atributos_w[array_atributos_w.count].nr_item_nf := nr_item_nf_w;
                            array_atributos_w[array_atributos_w.count].cd_tributo := cd_tributo_nf_w;
                            array_atributos_w[array_atributos_w.count].cd_conta_contabil := cd_conta_contabil_w;
                            array_atributos_w[array_atributos_w.count].cd_historico := cd_historico_w;
                            array_atributos_w[array_atributos_w.count].cd_centro_custo := cd_centro_custo_w;
                            array_atributos_w[array_atributos_w.count].cd_material := cd_material_w;
                            array_atributos_w[array_atributos_w.count].ie_tipo_ordem := ie_tipo_ordem_w;
                            array_atributos_w[array_atributos_w.count].nr_lote_contabil := nr_lote_contabil_w;
                            array_atributos_w[array_atributos_w.count].ie_debito_credito := ie_debito_credito_w;
                            array_atributos_w[array_atributos_w.count].nr_seq_classif_movto := nr_seq_classif_movto_w;
                            array_atributos_w[array_atributos_w.count].ie_intercompany := ie_intercompany_w;
                            array_atributos_w[array_atributos_w.count].cd_estab_intercompany := cd_estab_intercompany_w;
                            array_atributos_w[array_atributos_w.count].cd_sequencia_parametro := cd_sequencia_parametro_w;
                            array_atributos_w[array_atributos_w.count].nr_seq_proj_rec := nr_seq_proj_rec_w;

                            if (ie_acao_nf_w = '2') then
                                begin
                                if (ie_debito_credito_w = 'D') then
                                    array_atributos_w[array_atributos_w.count].ie_debito_credito := 'C';
                                else
                                    array_atributos_w[array_atributos_w.count].ie_debito_credito := 'D';
                                end if;
                                end;
                            end if;
                            array_atributos_w[array_atributos_w.count].ie_origem_centro := ie_origem_centro_w;
                            array_atributos_w[array_atributos_w.count].nr_seq_rateio_trib_item := nr_seq_rateio_trib_item_w;
                            end;
                        end if;
                        end;
                    end loop;
                    close c08;
                    end;
                else
                    begin
                    if (coalesce(cd_conta_contabil_w,'0') <> '0') then
                        begin
                        array_atributos_w[array_atributos_w.count + 1].nm_tabela := nm_tabela_w;
                        array_atributos_w[array_atributos_w.count].nm_atributo := nm_atributo_w;
                        array_atributos_w[array_atributos_w.count].nr_seq_nota_fiscal := nr_seq_nota_fiscal_p;
                        array_atributos_w[array_atributos_w.count].cd_evento := cd_evento_w;
                        array_atributos_w[array_atributos_w.count].ie_operacao_fiscal := ie_operacao_fiscal_w;
                        array_atributos_w[array_atributos_w.count].nr_seq_evento_param := nr_seq_evento_param_w;
                        array_atributos_w[array_atributos_w.count].nr_item_nf := nr_item_nf_w;
                        array_atributos_w[array_atributos_w.count].cd_tributo := cd_tributo_nf_w;
                        array_atributos_w[array_atributos_w.count].cd_conta_contabil := cd_conta_contabil_w;
                        array_atributos_w[array_atributos_w.count].cd_historico := cd_historico_w;
                        array_atributos_w[array_atributos_w.count].cd_centro_custo := cd_centro_custo_w;
                        array_atributos_w[array_atributos_w.count].cd_material := cd_material_w;
                        array_atributos_w[array_atributos_w.count].ie_tipo_ordem := ie_tipo_ordem_w;
                        array_atributos_w[array_atributos_w.count].nr_lote_contabil := nr_lote_contabil_w;
                        array_atributos_w[array_atributos_w.count].ie_debito_credito := ie_debito_credito_w;
                        array_atributos_w[array_atributos_w.count].nr_seq_classif_movto := nr_seq_classif_movto_w;
                        array_atributos_w[array_atributos_w.count].ie_intercompany := ie_intercompany_w;
                        array_atributos_w[array_atributos_w.count].cd_estab_intercompany := cd_estab_intercompany_w;
                        array_atributos_w[array_atributos_w.count].cd_sequencia_parametro := cd_sequencia_parametro_w;
                        array_atributos_w[array_atributos_w.count].nr_seq_proj_rec := nr_seq_proj_rec_w;

                        if (ie_acao_nf_w = '2') then
                            begin
                            if (ie_debito_credito_w = 'D') then
                                array_atributos_w[array_atributos_w.count].ie_debito_credito := 'C';
                            else
                                array_atributos_w[array_atributos_w.count].ie_debito_credito := 'D';
                            end if;
                            end;
                        end if;
                        array_atributos_w[array_atributos_w.count].ie_origem_centro := ie_origem_centro_w;
                        end;
                    end if;
                    end;
                end if;
                end;
            end loop;
            close C03;

            end;
        elsif (nm_tabela_w = 'NOTA_FISCAL_TRIB') then
            begin
            open C04;
            loop
                fetch C04
                    into cd_tributo_nf_w;
                EXIT WHEN NOT FOUND; /* apply on C04 */
                begin
                cd_sequencia_parametro_w := null;
                if (ie_origem_centro_w = '1') then
                        cd_centro_custo_w := cd_centro_custo_event_w;
                end if;

                if (ie_origem_conta_w = '7') then

                    select coalesce(max(a.cd_conta_contabil),cd_conta_contabil_w)
                    into STRICT   cd_conta_contabil_w
                    from   tributo_conta_contabil a
                    where  cd_cgc = cd_cgc_w
                    and    a.cd_tributo = cd_tributo_nf_w
                    and    a.cd_empresa = cd_empresa_w
                    and (coalesce(a.dt_inicio_vigencia,dt_movimento_w) <= dt_movimento_w and coalesce(a.dt_fim_vigencia,dt_movimento_w) >= dt_movimento_w);

                end if;

                if (coalesce(cd_conta_contabil_w::text, '') = '') then
                    SELECT * FROM ctb_online_pck.Define_Conta_Contabil(ie_origem_conta_w, cd_estabelecimento_w, cd_cgc_w, cd_pessoa_fisica_w, ie_tipo_convenio_w, cd_convenio_w, null, null, null, null, cd_conta_contabil_w, cd_centro_custo_w, 'NF: ' || nr_nota_fiscal_w || ' Seq.:' || nr_seq_nota_fiscal_p || ' atrib: ' || nm_atributo_w, dt_movimento_w, null, null, cd_operacao_nf_w, null, null, nr_seq_proj_rec_capa) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
                    cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();
                end if;

                if (ctb_online_pck.get_exige_centro_conta(cd_conta_contabil_w) = 'N') then
                    begin
                    cd_centro_custo_w := null;
                    end;
                end if;
                if (ie_origem_conta_w = '1') and (coalesce(cd_conta_contabil_w,'0') = '0') and (coalesce(cd_conta_contabil_evento_w,'0') <> '0') then
                    cd_conta_contabil_w := cd_conta_contabil_evento_w;
                end if;

                if (coalesce(cd_conta_contabil_w,'0') <> '0') then
                    begin
                    array_atributos_w[array_atributos_w.count + 1].nm_tabela := nm_tabela_w;
                    array_atributos_w[array_atributos_w.count].nm_atributo := nm_atributo_w;
                    array_atributos_w[array_atributos_w.count].nr_seq_nota_fiscal := nr_seq_nota_fiscal_p;
                    array_atributos_w[array_atributos_w.count].cd_evento := cd_evento_w;
                    array_atributos_w[array_atributos_w.count].ie_operacao_fiscal := ie_operacao_fiscal_w;
                    array_atributos_w[array_atributos_w.count].nr_seq_evento_param := nr_seq_evento_param_w;
                    array_atributos_w[array_atributos_w.count].cd_tributo := cd_tributo_nf_w;
                    array_atributos_w[array_atributos_w.count].cd_conta_contabil := cd_conta_contabil_w;
                    array_atributos_w[array_atributos_w.count].cd_historico := cd_historico_w;
                    array_atributos_w[array_atributos_w.count].cd_centro_custo := cd_centro_custo_w;
                    array_atributos_w[array_atributos_w.count].ie_tipo_ordem := ie_tipo_ordem_w;
                    array_atributos_w[array_atributos_w.count].nr_lote_contabil := nr_lote_contabil_w;
                    array_atributos_w[array_atributos_w.count].ie_debito_credito := ie_debito_credito_w;
                    array_atributos_w[array_atributos_w.count].nr_seq_classif_movto := nr_seq_classif_movto_w;
                    array_atributos_w[array_atributos_w.count].ie_intercompany := ie_intercompany_w;
                    array_atributos_w[array_atributos_w.count].cd_estab_intercompany := cd_estab_intercompany_w;
                    array_atributos_w[array_atributos_w.count].cd_sequencia_parametro := cd_sequencia_parametro_w;

                    if (ie_acao_nf_w = '2') then
                        begin
                        if (ie_debito_credito_w = 'D') then
                            array_atributos_w[array_atributos_w.count].ie_debito_credito := 'C';
                        else
                            array_atributos_w[array_atributos_w.count].ie_debito_credito := 'D';
                        end if;
                        end;
                    end if;
                    array_atributos_w[array_atributos_w.count].ie_origem_centro := ie_origem_centro_w;
                    end;
                end if;
                end;
            end loop;
            close c04;
            end;
        elsif (nm_tabela_w = 'NOTA_FISCAL_VENC_TRIB') then
            begin
            open C05;
            loop
                fetch C05
                    into cd_tributo_nf_w;
                EXIT WHEN NOT FOUND; /* apply on C05 */
                begin
                cd_sequencia_parametro_w        := null;
                if (ie_origem_conta_w = '7') then

                    select coalesce(max(a.cd_conta_contabil),cd_conta_contabil_w)
                    into STRICT   cd_conta_contabil_w
                    from   tributo_conta_contabil a
                    where  cd_cgc = cd_cgc_w
                    and    a.cd_tributo = cd_tributo_nf_w
                    and    a.cd_empresa = cd_empresa_w
                    and (coalesce(a.dt_inicio_vigencia,dt_movimento_w) <= dt_movimento_w and
                            coalesce(a.dt_fim_vigencia,dt_movimento_w) >= dt_movimento_w);

                end if;

                if (coalesce(cd_conta_contabil_w::text, '') = '') then
                    SELECT * FROM ctb_online_pck.Define_Conta_Contabil(ie_origem_conta_w, cd_estabelecimento_w, cd_cgc_w, cd_pessoa_fisica_w, ie_tipo_convenio_w, cd_convenio_w, null, null, null, null, cd_conta_contabil_w, cd_centro_custo_w, 'NF: ' || nr_nota_fiscal_w || ' Seq.:' || nr_seq_nota_fiscal_p || ' atrib: ' || nm_atributo_w, dt_movimento_w, null, null, cd_operacao_nf_w, null, null, nr_seq_proj_rec_capa) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
                    cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();
                end if;

                if (ctb_online_pck.get_exige_centro_conta(cd_conta_contabil_w) = 'N') then
                    begin
                    cd_centro_custo_w := null;
                    end;
                end if;
                if (ie_origem_conta_w = '1') and (coalesce(cd_conta_contabil_w,'0') = '0') and (coalesce(cd_conta_contabil_evento_w,'0') <> '0') then
                    cd_conta_contabil_w := cd_conta_contabil_evento_w;
                end if;

                if (coalesce(cd_conta_contabil_w,'0') <> '0') then
                    begin
                    array_atributos_w[array_atributos_w.count + 1].nm_tabela := nm_tabela_w;
                    array_atributos_w[array_atributos_w.count].nm_atributo := nm_atributo_w;
                    array_atributos_w[array_atributos_w.count].nr_seq_nota_fiscal := nr_seq_nota_fiscal_p;
                    array_atributos_w[array_atributos_w.count].cd_evento := cd_evento_w;
                    array_atributos_w[array_atributos_w.count].ie_operacao_fiscal := ie_operacao_fiscal_w;
                    array_atributos_w[array_atributos_w.count].nr_seq_evento_param := nr_seq_evento_param_w;
                    array_atributos_w[array_atributos_w.count].cd_tributo := cd_tributo_nf_w;
                    array_atributos_w[array_atributos_w.count].cd_conta_contabil := cd_conta_contabil_w;
                    array_atributos_w[array_atributos_w.count].cd_historico := cd_historico_w;
                    array_atributos_w[array_atributos_w.count].cd_centro_custo := cd_centro_custo_w;
                    array_atributos_w[array_atributos_w.count].ie_tipo_ordem := ie_tipo_ordem_w;
                    array_atributos_w[array_atributos_w.count].nr_lote_contabil := nr_lote_contabil_w;
                    array_atributos_w[array_atributos_w.count].ie_debito_credito := ie_debito_credito_w;
                    array_atributos_w[array_atributos_w.count].nr_seq_classif_movto := nr_seq_classif_movto_w;
                    array_atributos_w[array_atributos_w.count].ie_intercompany := ie_intercompany_w;
                    array_atributos_w[array_atributos_w.count].cd_estab_intercompany := cd_estab_intercompany_w;
                    array_atributos_w[array_atributos_w.count].cd_sequencia_parametro := cd_sequencia_parametro_w;

                    if (ie_acao_nf_w = '2') then
                        begin
                        if (ie_debito_credito_w = 'D') then
                            array_atributos_w[array_atributos_w.count].ie_debito_credito := 'C';
                        else
                            array_atributos_w[array_atributos_w.count].ie_debito_credito := 'D';
                        end if;
                        end;
                    end if;
                    array_atributos_w[array_atributos_w.count].ie_origem_centro := ie_origem_centro_w;
                    end;
                end if;
                end;
            end loop;
            close c05;
            end;
        elsif (nm_tabela_w = 'NOTA_FISCAL_ITEM_RATEIO') then
            begin
            open C02;
            loop
                fetch C02
                    into cd_material_w,
                          cd_procedimento_w,
                          ie_origem_proced_w,
                          cd_local_estoque_w,
                          nr_solic_compra_w,
                          cd_conta_contabil_nf_w,
                          cd_centro_custo_nf_w,
                          nr_item_nf_w,
                          cd_unidade_medida_compra_w,
                          cd_unidade_medida_estoque_w,
                          qt_item_nf_w,
                          qt_item_estoque_w,
                          ds_observacao_item_w,
                          ds_complemento_w,
                          nr_seq_proc_interno_w,
                          nr_seq_proj_rec_w,
						  cd_sequencia_parametro_nf_w;
                EXIT WHEN NOT FOUND; /* apply on C02 */
                begin

                    if (ctb_online_pck.get_exige_centro_conta(cd_conta_contabil_w) = 'N') then
                        begin
                            cd_centro_custo_w := null;
                        end;
                    else
                        if (coalesce(cd_centro_custo_nf_w,0) = 0) then
                            select max(cd_centro_custo) into STRICT cd_centro_custo_nf_w from local_estoque where cd_local_estoque = cd_local_estoque_w;
                        end if;
                    end if;

                    if (ie_origem_conta_w = '1') and (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') then
                        cd_conta_contabil_w := cd_conta_contabil_w;
                    else

                        if (coalesce(cd_conta_contabil_nf_w::text, '') = '') or (coalesce(cd_centro_custo_nf_w::text, '') = '') or (ie_origem_conta_w = '11') then
                            cd_conta_contabil_w := cd_conta_contabil_nf_w;
                            cd_centro_custo_w   := cd_centro_custo_nf_w;

                            if (ie_origem_conta_w <> '11') then
                                begin
                                    if (cd_conta_contabil_nf_w IS NOT NULL AND cd_conta_contabil_nf_w::text <> '') then
                                        cd_conta_contabil_w := cd_conta_contabil_nf_w;
                                    end if;
                                    if (cd_centro_custo_nf_w IS NOT NULL AND cd_centro_custo_nf_w::text <> '') then
                                        cd_centro_custo_w := cd_centro_custo_nf_w;
                                    end if;
                                end;
                            end if;
                        end if;
                    end if;

                    open c06;
                    loop
                        fetch c06
                            into nr_seq_item_rateio_w,
                                  cd_conta_contabil_w,
                                  cd_centro_custo_w;
                        EXIT WHEN NOT FOUND; /* apply on c06 */
                        begin

                        if (coalesce(cd_conta_contabil_w,'0') <> '0') then
                            begin
                            array_atributos_w[array_atributos_w.count + 1].nm_tabela := nm_tabela_w;
                            array_atributos_w[array_atributos_w.count].nm_atributo := nm_atributo_w;
                            array_atributos_w[array_atributos_w.count].nr_seq_nota_fiscal := nr_seq_nota_fiscal_p;
                            array_atributos_w[array_atributos_w.count].cd_evento := cd_evento_w;
                            array_atributos_w[array_atributos_w.count].ie_operacao_fiscal := ie_operacao_fiscal_w;
                            array_atributos_w[array_atributos_w.count].nr_seq_evento_param := nr_seq_evento_param_w;
                            array_atributos_w[array_atributos_w.count].nr_item_nf := nr_item_nf_w;
                            array_atributos_w[array_atributos_w.count].cd_tributo := cd_tributo_w;
                            array_atributos_w[array_atributos_w.count].cd_conta_contabil := cd_conta_contabil_w;
                            array_atributos_w[array_atributos_w.count].cd_historico := cd_historico_w;
                            array_atributos_w[array_atributos_w.count].cd_centro_custo := cd_centro_custo_w;
                            array_atributos_w[array_atributos_w.count].ie_tipo_ordem := ie_tipo_ordem_w;
                            array_atributos_w[array_atributos_w.count].nr_lote_contabil := nr_lote_contabil_w;
                            array_atributos_w[array_atributos_w.count].ie_debito_credito := ie_debito_credito_w;
                            array_atributos_w[array_atributos_w.count].nr_seq_classif_movto := nr_seq_classif_movto_w;
                            array_atributos_w[array_atributos_w.count].ie_intercompany := ie_intercompany_w;
                            array_atributos_w[array_atributos_w.count].cd_estab_intercompany := cd_estab_intercompany_w;
                            array_atributos_w[array_atributos_w.count].cd_sequencia_parametro := cd_sequencia_parametro_w;
                            array_atributos_w[array_atributos_w.count].nr_seq_proj_rec := nr_seq_proj_rec_w;

                            if (ie_acao_nf_w = '2') then
                                begin
                                if (ie_debito_credito_w = 'D') then
                                    array_atributos_w[array_atributos_w.count].ie_debito_credito := 'C';
                                else
                                    array_atributos_w[array_atributos_w.count].ie_debito_credito := 'D';
                                end if;
                                end;
                            end if;
                            array_atributos_w[array_atributos_w.count].ie_origem_centro := ie_origem_centro_w;
                            array_atributos_w[array_atributos_w.count].nr_seq_item_rateio := nr_seq_item_rateio_w;
                            end;
                        end if;
                        end;
                    end loop;
                    close c06;
                    end;
                end loop;
                close c02;
            end;
        elsif (nm_tabela_w = 'NOTA_FISCAL_DESP_ADIC') then
            begin
            open C07;
            loop
                fetch C07
                    into cd_conta_contabil_w,
                          ds_razao_social_desp_w,
                          cd_cgc_w,
                          nr_sequencia_desp_w;
                EXIT WHEN NOT FOUND; /* apply on C07 */
                begin
                ie_debito_credito_w := 'C';

                if (ie_acao_nf_w = '2') then
                    ie_debito_credito_w := 'D';
                end if;
                if (coalesce(cd_conta_contabil_w,'0') = '0') then
                    cd_conta_contabil_w := Obter_Conta_Contab_Pj(cd_empresa_w,
                                                                  cd_estabelecimento_w,
                                                                  cd_cgc_w,
                                                                  'P',
                                                                  dt_movimento_w);
                end if;

                if (ctb_online_pck.get_exige_centro_conta(cd_conta_contabil_w) = 'N') then
                    begin
                    cd_centro_custo_w := null;
                    end;
                end if;
                if (ie_origem_conta_w = '1') and (coalesce(cd_conta_contabil_w,'0') = '0') and (coalesce(cd_conta_contabil_evento_w,'0') <> '0') then
                    cd_conta_contabil_w := cd_conta_contabil_evento_w;
                end if;
                if (coalesce(cd_conta_contabil_w,'0') <> '0') then
                    begin
                    array_atributos_w[array_atributos_w.count + 1].nm_tabela := nm_tabela_w;
                    array_atributos_w[array_atributos_w.count].nm_atributo := nm_atributo_w;
                    array_atributos_w[array_atributos_w.count].nr_seq_nota_fiscal := nr_seq_nota_fiscal_p;
                    array_atributos_w[array_atributos_w.count].cd_evento := cd_evento_w;
                    array_atributos_w[array_atributos_w.count].ie_operacao_fiscal := ie_operacao_fiscal_w;
                    array_atributos_w[array_atributos_w.count].nr_seq_evento_param := nr_seq_evento_param_w;
                    array_atributos_w[array_atributos_w.count].nr_item_nf := nr_item_nf_w;
                    array_atributos_w[array_atributos_w.count].cd_tributo := cd_tributo_w;
                    array_atributos_w[array_atributos_w.count].cd_conta_contabil := cd_conta_contabil_w;
                    array_atributos_w[array_atributos_w.count].cd_historico := cd_historico_w;
                    array_atributos_w[array_atributos_w.count].cd_centro_custo := cd_centro_custo_w;
                    array_atributos_w[array_atributos_w.count].ie_tipo_ordem := ie_tipo_ordem_w;
                    array_atributos_w[array_atributos_w.count].nr_lote_contabil := nr_lote_contabil_w;
                    array_atributos_w[array_atributos_w.count].ie_debito_credito := ie_debito_credito_w;
                    array_atributos_w[array_atributos_w.count].nr_seq_classif_movto := nr_seq_classif_movto_w;
                    array_atributos_w[array_atributos_w.count].ie_intercompany := ie_intercompany_w;
                    array_atributos_w[array_atributos_w.count].cd_estab_intercompany := cd_estab_intercompany_w;
                    array_atributos_w[array_atributos_w.count].cd_sequencia_parametro := cd_sequencia_parametro_w;

                    if (ie_acao_nf_w = '2') then
                        begin
                        if (ie_debito_credito_w = 'D') then
                            array_atributos_w[array_atributos_w.count].ie_debito_credito := 'C';
                        else
                            array_atributos_w[array_atributos_w.count].ie_debito_credito := 'D';
                        end if;
                        end;
                    end if;
                    array_atributos_w[array_atributos_w.count].ie_origem_centro := ie_origem_centro_w;
                    array_atributos_w[array_atributos_w.count].nr_sequencia_desp := nr_sequencia_desp_w;
                    end;
                end if;
                end;
            end loop;
            close C07;
            end;
        end if;

    end;
end loop;
close C01;

for idx in 1 .. array_atributos_w.count loop
    begin
    if (coalesce(array_atributos_w[idx].cd_conta_contabil,'0') <> '0') then
        begin
        array_atributos_w[idx].ie_conta_vigente := obter_se_conta_vigente(array_atributos_w[idx].cd_conta_contabil,dt_movimento_w);
        array_atributos_w[idx].ds_consistencia := substr(wheb_mensagem_pck.get_texto(739752,null),1,255);
        --Verificar: Expressao 739752 nao existe no Dicionario de Objetos, o retorno do get_texto acima eh null (23/marco/2022 - 2811071)
        end;
    end if;

    if (coalesce(array_atributos_w[idx].cd_centro_custo,0) <> 0) then
        begin
        select count(1)
        into STRICT   qt_centro_custo_w
        from   centro_custo a
        where  coalesce(a.dt_fim_contabil,clock_timestamp()) > dt_movimento_w
        and    a.cd_centro_custo = array_atributos_w[idx].cd_centro_custo;

        array_atributos_w[idx].ie_centro_vigente := 'S';

        if (qt_centro_custo_w > 0) then
            begin
                array_atributos_w[idx].ie_centro_vigente := 'N'; /* MENSAGEM VAZIA - CORRIGIR */
                array_atributos_w[idx].ds_consistencia := substr(wheb_mensagem_pck.get_texto(739754,null),1,255);
                --Verificar: Expressao 739754 nao existe no Dicionario de Objetos, o retorno do get_texto acima eh null (23/marco/2022 - 2811071)
            end;
        end if;
        end;
    end if;

    if (coalesce(array_atributos_w[idx].cd_historico,0) = 0) then
        begin
        array_atributos_w[idx].ds_consistencia := substr(wheb_mensagem_pck.get_texto(739742,null),1,255);
        --Verificar: Expressao 739742 nao existe no Dicionario de Objetos, o retorno do get_texto acima eh null (23/marco/2022 - 2811071)
        end;
    end if;

    if (ctb_online_pck.get_exige_centro_conta(array_atributos_w[idx].cd_conta_contabil) = 'S') and (ctb_contab_onl_lote_nf_pck.get_consistencia_item( array_atributos_w[idx].nr_lote_contabil,
                                array_atributos_w[idx].nm_tabela,
                                array_atributos_w[idx].nm_atributo,
                                substr(wheb_mensagem_pck.get_texto(676179,null),1,255)) = 0) and (coalesce(array_atributos_w[idx].cd_centro_custo,0) = 0) then
        begin
        --Centro de Custo nao encontrado
        array_atributos_w[idx].ds_consistencia := substr(wheb_mensagem_pck.get_texto(676179,null),1,255);
        array_atributos_w[idx].ie_validacao    := '31';
        end;
    end if;

    if (coalesce(array_atributos_w[idx].cd_conta_contabil,'0') = '0') and (ctb_contab_onl_lote_nf_pck.get_consistencia_item(array_atributos_w[idx].nr_lote_contabil,
                              array_atributos_w[idx].nm_tabela,
                              array_atributos_w[idx].nm_atributo,
                              substr(wheb_mensagem_pck.get_texto(676178,null),1,255)) = 0) then
        begin
        --Conta contabil nao encontrada
        array_atributos_w[idx].ds_consistencia := substr(wheb_mensagem_pck.get_texto(676178,null),1,255);
        array_atributos_w[idx].ie_validacao    := '30';
        end;
    end if;

    if (array_atributos_w[idx](.nm_tabela IS NOT NULL AND .nm_tabela::text <> '')) and (array_atributos_w[idx](.nm_atributo IS NOT NULL AND .nm_atributo::text <> '')) and (coalesce(array_atributos_w[idx].ds_consistencia,'X') <> 'X') and (coalesce(ie_mensagem_p,'S') = 'S') then
        begin

        ie_nota_item_w := 'N';

        if (coalesce(array_atributos_w[idx].nr_item_nf,0) <> 0) then
            begin
                ie_nota_item_w := 'I';
            end;
        end if;

        ds_observacao_w := substr(wheb_mensagem_pck.get_texto(680572,null) || ': ' ||
                                  array_atributos_w[idx].cd_evento || '. ' ||
                                  wheb_mensagem_pck.get_texto(680574,null) || ': ' ||
                                  array_atributos_w[idx].nm_tabela || '. ' ||
                                  wheb_mensagem_pck.get_texto(680576,null) || ': ' ||
                                  array_atributos_w[idx].nm_atributo || '.',
                                  1,255);

        CALL gravar_nota_fiscal_consist( nr_seq_nota_fiscal_p,
                                    array_atributos_w[idx].ds_consistencia,
                                    'S',
                                    ie_nota_item_w,
                                    ds_observacao_w,
                                    nm_usuario_p,
                                    'S',
                                    array_atributos_w[idx].nr_item_nf);
        end;
    end if;

    end;
end loop;

commit;
if (coalesce(ie_mensagem_p,'S') = 'S') then
    begin
    array_atributos_w.delete;
    end;
end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_lote_nf_pck.ctb_consistir_contab_nf (nr_seq_nota_fiscal_p bigint, cd_estabelecimento_p bigint, ie_mensagem_p text, nm_usuario_p text) FROM PUBLIC;
