-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE ugf_wheb_integr_sen_titpagar.gerar_titpagar_classif (nr_titulo_p text, cd_centro_custo_p text, cd_conta_contabil_p text, cd_conta_financeira_p text, vl_titulo_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
	cd_centro_custo_w		bigint;
	cd_conta_contabil_w	varchar(20);
	cd_conta_financeira_w	bigint;
	ds_erro_w		varchar(255);
	ds_erro_aux_w		varchar(255);
	nr_titulo_w		bigint;
	vl_titulo_w		double precision;
	vl_classif_w		double precision;
	vl_titulo_classif_w		double precision;
	nr_sequencia_w		bigint	:= 0;
	nr_seq_trans_fin_contab_w		titulo_pagar.nr_seq_trans_fin_contab%type;
	cd_conta_financ_w		transacao_financeira.cd_conta_financ%type;
	
BEGIN
 
	vl_classif_w	:= coalesce(vl_titulo_p,0);
 
	if (cd_centro_custo_p IS NOT NULL AND cd_centro_custo_p::text <> '') then 
	 
		select	coalesce(max(cd_centro_custo),0) 
		into STRICT	cd_centro_custo_w 
		from	centro_custo 
		where	cd_centro_custo	= cd_centro_custo_p;
 
		if (cd_centro_custo_w	= 0) then 
 
			select	coalesce(max(cd_centro_custo),0) 
			into STRICT	cd_centro_custo_w 
			from	centro_custo 
			where	cd_sistema_contabil	= cd_centro_custo_p;
 
		end if;
 
		if (cd_centro_custo_w = 0) then 
			ds_erro_w	:= substr(ds_erro_w || 'Centro de custo não cadastrado no Tasy: ' || cd_centro_custo_p,1,255);
		else 
 
			update	centro_custo 
			set	cd_sistema_contabil	= cd_centro_custo_p 
			where	cd_centro_custo		= cd_centro_custo_w;
 
		end if;
	end if;
	 
	if (cd_conta_contabil_p IS NOT NULL AND cd_conta_contabil_p::text <> '') then 
	 
		select	coalesce(max(cd_conta_contabil),'0') 
		into STRICT	cd_conta_contabil_w 
		from	conta_contabil 
		where	cd_conta_contabil	= cd_conta_contabil_p;
 
		if (cd_conta_contabil_w	= '0') then 
 
			select	coalesce(max(cd_conta_contabil),'0') 
			into STRICT	cd_conta_contabil_w 
			from	conta_contabil 
			where	cd_sistema_contabil	= cd_conta_contabil_p;
 
		end if;
 
		if (cd_conta_contabil_w = '0') then 
			ds_erro_w	:= substr(ds_erro_w || 'Conta contábil não cadastrada no Tasy: ' || cd_conta_contabil_p,1,255);
		else 
 
			update	conta_contabil 
			set	cd_sistema_contabil	= cd_conta_contabil_p 
			where	cd_conta_contabil	= cd_conta_contabil_w;
 
		end if;
	end if;
 
	if (cd_conta_financeira_p IS NOT NULL AND cd_conta_financeira_p::text <> '') then 
	 
		select	max(cd_conta_financ) 
		into STRICT	cd_conta_financeira_w 
		from	conta_financeira 
		where	cd_conta_financ	= cd_conta_financeira_p;
 
		if (coalesce(cd_conta_financeira_w::text, '') = '') then 
 
			select	max(cd_conta_financ) 
			into STRICT	cd_conta_financeira_w 
			from	conta_financeira 
			where	cd_sistema_externo	= cd_conta_financeira_p;
 
		end if;
 
		if (cd_conta_financeira_p IS NOT NULL AND cd_conta_financeira_p::text <> '') and (coalesce(cd_conta_financeira_w::text, '') = '') then 
 
 
			ds_erro_w	:= substr(ds_erro_w || 'Conta financeira não cadastrada no Tasy: ' || cd_conta_financeira_p,1,255);
			 
		elsif (cd_conta_financeira_w IS NOT NULL AND cd_conta_financeira_w::text <> '') then 
 
			update	conta_financeira 
			set	cd_sistema_externo	= cd_conta_financeira_p 
			where	cd_conta_financ		= cd_conta_financeira_w;
 
		end if;
	end if;
 
	select	coalesce(max(nr_titulo),0) 
	into STRICT	nr_titulo_w 
	from	titulo_pagar 
	where 	nr_titulo = nr_titulo_p;
	 
	if (nr_titulo_w <> 0) and (coalesce(ds_erro_w,'X') = 'X') then 
		begin 
		select	coalesce(max(vl_titulo),0) 
		into STRICT	vl_titulo_w 
		from	titulo_pagar 
		where	nr_titulo	= nr_titulo_w;
		 
		select	coalesce(sum(vl_titulo),0), 
			coalesce(max(nr_sequencia),0) 
		into STRICT	vl_titulo_classif_w, 
			nr_sequencia_w 
		from	titulo_pagar_classif 
		where	nr_titulo	= nr_titulo_w;
	 
		vl_titulo_classif_w	:= vl_titulo_classif_w + vl_titulo_p;
		if (vl_titulo_classif_w > vl_titulo_w) then 
			ds_erro_w	:= substr('O total dos rateios é superior ao valor total do título',1,255);
		end if;
		 
		if (coalesce(ds_erro_w,'X') = 'X') then 
			begin 
			nr_sequencia_w	:= nr_sequencia_w + 1;
			 
			select nr_seq_trans_fin_contab 
			into STRICT nr_seq_trans_fin_contab_w 
			from titulo_pagar 
			where nr_titulo = nr_titulo_p;
			 
			select cd_conta_financ 
			into STRICT cd_conta_financ_w 
			from transacao_financeira 
			where nr_sequencia = nr_seq_trans_fin_contab_w;
			 
			insert into titulo_pagar_classif( 
				nr_titulo, 
				nr_sequencia, 
				cd_centro_custo, 
				cd_conta_contabil, 
				nr_seq_conta_financ, 
				vl_titulo, 
				dt_atualizacao, 
				nm_usuario) 
			values (	nr_titulo_w, 
				nr_sequencia_w, 
				cd_centro_custo_w, 
				cd_conta_contabil_w, 
				coalesce(cd_conta_financ_w,cd_conta_financeira_w), 
				vl_classif_w, 
				clock_timestamp(), 
				nm_usuario_p);
			exception when others then 
				ds_erro_w := ugf_wheb_integr_sen_titpagar.excluir_titulo_pagar(	null, null, nr_titulo_p, null, nm_usuario_p, ds_erro_w);
				ds_erro_w	:= substr('Erro ao gerar a classificação do título no Tasy: (' || nr_titulo_w || ') ' || sqlerrm(SQLSTATE),1,255);
			end;
		end if;
		end;
	elsif (nr_titulo_w = 0) then 
		ds_erro_w	:= substr(ds_erro_w || ' Título não encontrado no Tasy: ' || nr_titulo_p,1,255);
	end if;
 
	if (coalesce(ds_erro_w,'X') <> 'X') and (nr_titulo_w <> 0) then 
		begin 
		ds_erro_aux_w := ugf_wheb_integr_sen_titpagar.excluir_titulo_pagar(null, null, nr_titulo_p, null, nm_usuario_p, ds_erro_aux_w);
		 
		if (coalesce(ds_erro_aux_w,'X') <> 'X') then 
			ds_erro_w := substr(ds_erro_w || chr(13) || chr(10) || ds_erro_aux_w ,1,255);
		end if;
		end;
	end if;
	ds_erro_p	:= substr(ds_erro_w,1,255);
	end;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ugf_wheb_integr_sen_titpagar.gerar_titpagar_classif (nr_titulo_p text, cd_centro_custo_p text, cd_conta_contabil_p text, cd_conta_financeira_p text, vl_titulo_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;
