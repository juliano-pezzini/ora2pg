-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_simulacao_preco_pck.add_sca ( nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_simul_benef_p pls_simulpreco_individual.nr_sequencia%type, nr_seq_simul_perfil_p pls_simulacao_perfil.nr_sequencia%type, qt_idade_p bigint, ie_titularidade_p text, qt_vidas_perfil_p bigint) AS $body$
DECLARE

	qt_vidas_w	bigint;
	vl_preco_sca_w	double precision;
	C01 CURSOR FOR
		SELECT	b.ds_plano,
			a.nr_seq_plano,
			a.nr_seq_tabela,
			coalesce(c.ie_preco_vidas_contrato,'N') ie_preco_vidas_contrato,
			coalesce(c.ie_calculo_vidas,'A') ie_calculo_vidas
		from	pls_sca_vinculo a,
			pls_plano b,
			pls_tabela_preco c
		where	b.nr_sequencia		= a.nr_seq_plano
		and	c.nr_sequencia		= a.nr_seq_tabela
		and	a.nr_seq_segurado_simul	= nr_seq_simul_benef_p
		
union all

		SELECT	b.ds_plano,
			a.nr_seq_plano,
			a.nr_seq_tabela,
			coalesce(c.ie_preco_vidas_contrato,'N') ie_preco_vidas_contrato,
			coalesce(c.ie_calculo_vidas,'A') ie_calculo_vidas
		from	pls_sca_vinculo a,
			pls_plano b,
			pls_tabela_preco c
		where	b.nr_sequencia		= a.nr_seq_plano
		and	c.nr_sequencia		= a.nr_seq_tabela
		and	a.nr_seq_simulacao_perfil	= nr_seq_simul_perfil_p
		
union all

		select	b.ds_plano,
			a.nr_seq_plano,
			a.nr_seq_tabela,
			coalesce(c.ie_preco_vidas_contrato,'N') ie_preco_vidas_contrato,
			coalesce(c.ie_calculo_vidas,'A') ie_calculo_vidas
		from	pls_sca_vinculo a,
			pls_plano b,
			pls_tabela_preco c
		where	b.nr_sequencia		= a.nr_seq_plano
		and	c.nr_sequencia		= a.nr_seq_tabela
		and	a.nr_seq_simulacao	= nr_seq_simulacao_p
		and	not exists (select	1
					from	pls_sca_vinculo x
					where	x.nr_seq_segurado_simul	= nr_seq_simul_benef_p
					and	x.nr_seq_plano		= a.nr_seq_plano);
	
	
BEGIN
	
	for r_c01_w in C01 loop
		begin
		if (nr_seq_simul_benef_p IS NOT NULL AND nr_seq_simul_benef_p::text <> '') then
			if (r_c01_w.ie_preco_vidas_contrato = 'S') then
				qt_vidas_w	:= pls_simulacao_preco_pck.obter_qt_vidas_simulacao(nr_seq_simulacao_p, r_c01_w.ie_calculo_vidas);
			else
				qt_vidas_w	:= 0;
			end if;
			
			select	coalesce(max(vl_preco_atual),0)
			into STRICT	vl_preco_sca_w
			from	pls_plano_preco
			where	nr_seq_tabela	= r_c01_w.nr_seq_tabela
			and	qt_idade_p between qt_idade_inicial and qt_idade_final
			and	((r_c01_w.ie_preco_vidas_contrato = 'S' and
				  qt_vidas_w between coalesce(qt_vidas_inicial,qt_vidas_w) and coalesce(qt_vidas_final,qt_vidas_w)) or (r_c01_w.ie_preco_vidas_contrato = 'N'));
			
			CALL CALL pls_simulacao_preco_pck.add_item(r_c01_w.ds_plano, vl_preco_sca_w, nr_seq_simul_benef_p, null, '15');
		elsif (nr_seq_simul_perfil_p IS NOT NULL AND nr_seq_simul_perfil_p::text <> '') then
			qt_vidas_w	:= qt_vidas_perfil_p;
			
			select	coalesce(max(vl_preco_atual),0)
			into STRICT	vl_preco_sca_w
			from	pls_plano_preco
			where	nr_seq_tabela	= r_c01_w.nr_seq_tabela
			and	((r_c01_w.ie_preco_vidas_contrato = 'S' and
				  qt_vidas_w between coalesce(qt_vidas_inicial,qt_vidas_w) and coalesce(qt_vidas_final,qt_vidas_w)) or (r_c01_w.ie_preco_vidas_contrato = 'N'));
			
			CALL CALL pls_simulacao_preco_pck.add_item(r_c01_w.ds_plano, vl_preco_sca_w*qt_vidas_perfil_p, null, nr_seq_simul_perfil_p, '15');
		end if;
		end;
	end loop;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_simulacao_preco_pck.add_sca ( nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_simul_benef_p pls_simulpreco_individual.nr_sequencia%type, nr_seq_simul_perfil_p pls_simulacao_perfil.nr_sequencia%type, qt_idade_p bigint, ie_titularidade_p text, qt_vidas_perfil_p bigint) FROM PUBLIC;
