-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_simulacao_preco_pck.obter_desconto_beneficiario ( nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_simul_benef_p pls_simulpreco_individual.nr_sequencia%type, ie_tipo_p text) RETURNS bigint AS $body$
DECLARE

	nr_seq_plano_w		pls_simulacao_preco.nr_seq_produto%type;
	nr_seq_tabela_w		pls_simulacao_preco.nr_seq_tabela%type;
	nr_seq_regra_w		pls_regra_desconto.nr_sequencia%type;
	tx_desconto_w		pls_preco_regra.tx_desconto%type;
	
BEGIN
	select	nr_seq_produto,
		nr_seq_tabela
	into STRICT	nr_seq_plano_w,
		nr_seq_tabela_w
	from	pls_simulacao_preco
	where	nr_sequencia	= nr_seq_simulacao_p;
	
	select	nr_seq_regra_desconto,
		tx_desconto
	into STRICT	nr_seq_regra_w,
		tx_desconto_w
	from	table(pls_simulacao_preco_pck.obter_resumo_simulacao(nr_seq_simulacao_p,null,nr_seq_plano_w,nr_seq_tabela_w,'S'))
	where	nr_seq_simul_individual	= nr_seq_simul_benef_p
	and	ie_totalizador = 'S';
	
	if (ie_tipo_p = 'R') then
		return nr_seq_regra_w;
	else
		return coalesce(tx_desconto_w,0);
	end if;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_simulacao_preco_pck.obter_desconto_beneficiario ( nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_simul_benef_p pls_simulpreco_individual.nr_sequencia%type, ie_tipo_p text) FROM PUBLIC;
