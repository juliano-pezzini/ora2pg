-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_simulacao_preco_pck.obter_valor_produto ( nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_simul_benef_p pls_simulpreco_individual.nr_sequencia%type, nr_seq_tabela_p pls_tabela_preco.nr_sequencia%type, qt_idade_p pls_simulpreco_individual.qt_idade%type, ie_titularidade_p text) RETURNS bigint AS $body$
DECLARE

	ie_preco_vidas_contrato_w	pls_tabela_preco.ie_preco_vidas_contrato%type;
	ie_calculo_vidas_w		pls_tabela_preco.ie_calculo_vidas%type;
	qt_vidas_w			bigint;
	vl_simulacao_produto_w		double precision;
	vl_sca_embutido_w		double precision;
	
	
BEGIN
		begin
		select	coalesce(ie_preco_vidas_contrato,'N'),
			coalesce(ie_calculo_vidas,'A')
		into STRICT	ie_preco_vidas_contrato_w,
			ie_calculo_vidas_w
		from	pls_tabela_preco
		where	nr_sequencia = nr_seq_tabela_p;
		exception
		when others then
			ie_preco_vidas_contrato_w	:= 'N';
			ie_calculo_vidas_w		:= 'A';
		end;
		
		if (ie_preco_vidas_contrato_w = 'S') then
			qt_vidas_w	:= pls_simulacao_preco_pck.obter_qt_vidas_simulacao(nr_seq_simulacao_p, ie_calculo_vidas_w);
		else
			qt_vidas_w	:= 0;
		end if;
		
		select	max(vl_preco_atual)
		into STRICT	vl_simulacao_produto_w
		from	pls_plano_preco
		where	nr_seq_tabela	= nr_seq_tabela_p
		and	qt_idade_p between qt_idade_inicial and qt_idade_final
		and	((substr(ie_grau_titularidade,1,1) = ie_titularidade_p) or (coalesce(ie_grau_titularidade::text, '') = ''))
		and	((ie_preco_vidas_contrato_w = 'S' and
			  qt_vidas_w between coalesce(qt_vidas_inicial,qt_vidas_w) and coalesce(qt_vidas_final,qt_vidas_w)) or (ie_preco_vidas_contrato_w = 'N'));
		
		vl_sca_embutido_w	:= coalesce(pls_obter_vl_sca_embut_simul(nr_seq_simul_benef_p),0);
		
		if (vl_sca_embutido_w > 0) then
			vl_simulacao_produto_w	:= vl_simulacao_produto_w + vl_sca_embutido_w;
		end if;
		
		return coalesce(vl_simulacao_produto_w,0);
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_simulacao_preco_pck.obter_valor_produto ( nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_simul_benef_p pls_simulpreco_individual.nr_sequencia%type, nr_seq_tabela_p pls_tabela_preco.nr_sequencia%type, qt_idade_p pls_simulpreco_individual.qt_idade%type, ie_titularidade_p text) FROM PUBLIC;
