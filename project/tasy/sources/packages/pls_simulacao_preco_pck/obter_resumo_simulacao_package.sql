-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION pls_simulacao_preco_pck.obter_resumo_simulacao ( nr_seq_simulacao_p bigint, nr_seq_simul_perfil_p bigint, nr_seq_plano_p bigint, nr_seq_tabela_p bigint, ie_html_p text) RETURNS SETOF T_ITEM AS $body$
DECLARE

	
	line_w			t_item_row;
	
	ie_tipo_contratacao_w	pls_simulacao_preco.ie_tipo_contratacao%type;
	nr_seq_contrato_w	pls_simulacao_preco.nr_seq_contrato%type;
	nr_seq_produto_w	pls_simulacao_preco.nr_seq_produto%type;
	nr_seq_tabela_w		pls_simulacao_preco.nr_seq_tabela%type;
	dt_simulacao_w		pls_simulacao_preco.dt_simulacao%type;
	vl_produto_w		double precision;
	dt_finalizacao_w	pls_simulacao_preco.dt_finalizacao%type;
	ie_produto_escolhido_w	varchar(1);
	ie_lanc_auto_contrato_exist_w	varchar(1);
	
	nr_seq_regra_desconto_w	pls_regra_desconto.nr_sequencia%type;
	tx_desconto_w		pls_preco_regra.tx_desconto%type;
	
	vl_preco_faixa_etaria_w	double precision;
	
	qt_vidas_perfil_w	bigint;
	vl_simulacao_perfil_w	double precision;
	tx_indice_w		pls_simulacao_perfil.tx_indice%type;
	
	C01 CURSOR FOR
		SELECT	a.nr_sequencia,
			a.nm_beneficiario,
			a.qt_idade,
			coalesce(a.ie_tipo_benef,'T') ie_titularidade,
			CASE WHEN a.ie_tipo_benef='T' THEN 'Titular'  ELSE 'Dependente' END  ds_titularidade,
			a.vl_inscricao,
			a.nr_seq_parentesco,
			coalesce((	SELECT	max(x.ie_tipo_parentesco)
				from	grau_parentesco x
				where	x.nr_sequencia	= a.nr_seq_parentesco),'0') ie_tipo_parentesco
		from	pls_simulpreco_individual a
		where	a.nr_seq_simulacao = nr_seq_simulacao_p
		and	a.ie_tipo_benef <> 'R'
		order by a.ie_tipo_benef desc,
			a.nm_beneficiario;
	
	C02 CURSOR FOR
		SELECT	qt_idade_inicial,
			qt_idade_final,
			qt_beneficiario
		from	pls_simulpreco_coletivo
		where	nr_seq_simul_perfil	= nr_seq_simul_perfil_p
		order by qt_idade_inicial;
	
	C03 CURSOR(	nr_seq_simulacao_pc	pls_simulacao_preco.nr_sequencia%type,
			nr_seq_plano_p		pls_plano.nr_sequencia%type,
			nr_seq_tabela_p		pls_tabela_preco.nr_sequencia%type) FOR
		SELECT	ds_item,
			ie_tipo_item,
			ie_totalizador,
			nr_seq_regra_desconto,
			nr_seq_simul_individual,
			nr_seq_simul_perfil,
			qt_beneficiario,
			tx_desconto,
			vl_item
		from	pls_simulacao_preco_resumo a
		where	a.nr_seq_simulacao	= nr_seq_simulacao_p
		and	a.nr_seq_plano		= nr_seq_plano_p
		and	a.nr_seq_tabela		= nr_seq_tabela_p;
	
	
BEGIN
		CALL CALL pls_simulacao_preco_pck.limpar_vetor_item();
		
		select	cd_estabelecimento,
			nm_usuario_nrec,
			ie_tipo_contratacao,
			nr_seq_contrato,
			coalesce(nr_seq_plano_p,nr_seq_produto) nr_seq_produto,
			coalesce(nr_seq_tabela_p,nr_seq_tabela) nr_seq_tabela,
			dt_simulacao,
			dt_finalizacao
		into STRICT	current_setting('pls_simulacao_preco_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type,
			current_setting('pls_simulacao_preco_pck.nm_usuario_w')::usuario.nm_usuario%type,
			ie_tipo_contratacao_w,
			nr_seq_contrato_w,
			nr_seq_produto_w,
			nr_seq_tabela_w,
			dt_simulacao_w,
			dt_finalizacao_w
		from	pls_simulacao_preco
		where	nr_sequencia	= nr_seq_simulacao_p;
		
		if (dt_finalizacao_w IS NOT NULL AND dt_finalizacao_w::text <> '') then
			for r_c03_w in c03(nr_seq_simulacao_p, nr_seq_produto_w, nr_seq_tabela_w) loop
				begin
				line_w.ds_item			:= r_c03_w.ds_item;
				line_w.vl_item			:= r_c03_w.vl_item;
				line_w.qt_beneficiario		:= r_c03_w.qt_beneficiario;
				line_w.ie_totalizador		:= r_c03_w.ie_totalizador;
				line_w.nr_seq_simul_individual	:= r_c03_w.nr_seq_simul_individual;
				line_w.nr_seq_simul_perfil	:= r_c03_w.nr_seq_simul_perfil;
				line_w.nr_seq_regra_desconto	:= r_c03_w.nr_seq_regra_desconto;
				line_w.tx_desconto		:= r_c03_w.tx_desconto;
				line_w.ie_tipo_item		:= r_c03_w.ie_tipo_item;
				RETURN NEXT line_w;
				end;
			end loop;
		else
			ie_lanc_auto_contrato_exist_w	:= coalesce(obter_valor_param_usuario(1233, 11, Obter_Perfil_Ativo, current_setting('pls_simulacao_preco_pck.nm_usuario_w')::usuario.nm_usuario%type, current_setting('pls_simulacao_preco_pck.cd_estabelecimento_w')::estabelecimento.cd_estabelecimento%type), 'N');
			ie_produto_escolhido_w	:= 'N';
			
			if (ie_tipo_contratacao_w = 'I') and (nr_seq_produto_w IS NOT NULL AND nr_seq_produto_w::text <> '') and (nr_seq_tabela_w IS NOT NULL AND nr_seq_tabela_w::text <> '') then
				
				select	max(ie_status)
				into STRICT	ie_produto_escolhido_w
				from	pls_simulacao_preco_plano
				where	nr_seq_simulacao	= nr_seq_simulacao_p
				and	nr_seq_plano		= nr_seq_produto_w;
				
				for r_c01_w in C01 loop
					begin
					
					--Produto

					vl_produto_w	:= pls_simulacao_preco_pck.obter_valor_produto(nr_seq_simulacao_p, r_c01_w.nr_sequencia, nr_seq_tabela_w, r_c01_w.qt_idade, r_c01_w.ie_titularidade);
					CALL CALL pls_simulacao_preco_pck.add_item('Produto '||pls_obter_dados_produto(nr_seq_produto_w,'N'), vl_produto_w, r_c01_w.nr_sequencia, null, '1');
					
					--Desconto

					SELECT * FROM pls_simulacao_preco_pck.add_desconto(nr_seq_simulacao_p, r_c01_w.nr_sequencia, dt_simulacao_w, r_c01_w.ie_titularidade, r_c01_w.ie_tipo_parentesco, vl_produto_w, nr_seq_regra_desconto_w, tx_desconto_w) INTO STRICT nr_seq_regra_desconto_w, tx_desconto_w;
					
					--Taxa de inscricao

					CALL CALL pls_simulacao_preco_pck.add_taxa_inscricao(r_c01_w.nr_sequencia, nr_seq_produto_w, r_c01_w.ie_titularidade, vl_produto_w);
					
					--Taxa de emissao do cartao de identificacao

					CALL pls_simulacao_preco_pck.add_taxa_emissao_carteira(r_c01_w.nr_sequencia, nr_seq_contrato_w, nr_seq_produto_w, vl_produto_w);
					
					--SCA

					CALL CALL pls_simulacao_preco_pck.add_sca(nr_seq_simulacao_p, r_c01_w.nr_sequencia, null, r_c01_w.qt_idade, r_c01_w.ie_titularidade, 0);
					
					--Bonificacao

					CALL CALL pls_simulacao_preco_pck.add_bonificacao(nr_seq_simulacao_p, r_c01_w.nr_sequencia, r_c01_w.qt_idade, r_c01_w.ie_titularidade, r_c01_w.nr_seq_parentesco, null, null, vl_produto_w);
					
					--Bonificacao de lancamento automatico

					if (ie_produto_escolhido_w = 'N') and --Quando escolhe o produto a bonificacao e copiada para a simulacao
						(ie_lanc_auto_contrato_exist_w = 'S' or coalesce(nr_seq_contrato_w::text, '') = '') then
						CALL pls_simulacao_preco_pck.add_bonificacao_auto(nr_seq_simulacao_p, nr_seq_produto_w, null, r_c01_w.nr_sequencia, r_c01_w.qt_idade, r_c01_w.ie_titularidade, r_c01_w.nr_seq_parentesco, null, null, vl_produto_w);
					end if;
					
					line_w.ds_item			:= '<strong>'||r_c01_w.nm_beneficiario||' - '||r_c01_w.qt_idade||' anos - '||r_c01_w.ds_titularidade||'</strong>';
					line_w.vl_item			:= current_setting('pls_simulacao_preco_pck.vl_item_w')::double;
					line_w.ie_totalizador		:= 'S';
					line_w.nr_seq_simul_individual	:= r_c01_w.nr_sequencia;
					line_w.nr_seq_regra_desconto	:= nr_seq_regra_desconto_w;
					line_w.ie_tipo_item		:= null;
					line_w.tx_desconto		:= tx_desconto_w;
					RETURN NEXT line_w;
					
					if (current_setting('pls_simulacao_preco_pck.tb_ds_item_w')::pls_util_cta_pck.t_varchar2_table_255.count > 0) then
						for i in current_setting('pls_simulacao_preco_pck.tb_ds_item_w')::pls_util_cta_pck.t_varchar2_table_255.first..tb_ds_item_w.last loop
							begin
							line_w.ds_item			:= current_setting('pls_simulacao_preco_pck.tb_ds_item_w')::pls_util_cta_pck.t_varchar2_table_255(i);
							line_w.vl_item			:= current_setting('pls_simulacao_preco_pck.tb_vl_item_w')::pls_util_cta_pck.t_number_table(i);
							line_w.ie_totalizador		:= 'N';
							line_w.ie_tipo_item		:= current_setting('pls_simulacao_preco_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_number_table(i);
							line_w.nr_seq_simul_individual	:= current_setting('pls_simulacao_preco_pck.tb_nr_seq_simul_individual_w')::pls_util_cta_pck.t_number_table(i);
							line_w.nr_seq_regra_desconto	:= null;
							line_w.tx_desconto		:= null;
							RETURN NEXT line_w;
							end;
						end loop;
					end if;
					
					CALL CALL pls_simulacao_preco_pck.limpar_vetor_item();
					end;
				end loop;
			elsif (ie_tipo_contratacao_w <> 'I') then
				vl_simulacao_perfil_w		:= 0;
				
				select	coalesce(max(tx_indice),1)
				into STRICT	tx_indice_w
				from	pls_simulacao_perfil
				where	nr_sequencia	= nr_seq_simul_perfil_p;
				
				if (coalesce(nr_seq_plano_p::text, '') = '' or coalesce(nr_seq_tabela_p::text, '') = '') then
					begin
					select	nr_seq_plano,
						nr_seq_tabela
					into STRICT	nr_seq_produto_w,
						nr_seq_tabela_w
					from	pls_simul_perfil_tabela
					where	nr_seq_simul_perfil = nr_seq_simul_perfil_p
					and	ie_tabela_selecionada = 'S';
					exception
					when others then
						nr_seq_produto_w	:= null;
						nr_seq_tabela_w		:= null;
					end;
					
					ie_produto_escolhido_w	:= 'S';
				else
					nr_seq_produto_w	:= nr_seq_plano_p;
					nr_seq_tabela_w		:= nr_seq_tabela_p;
					
					select	max(ie_tabela_selecionada)
					into STRICT	ie_produto_escolhido_w
					from	pls_simul_perfil_tabela
					where	nr_seq_simul_perfil	= nr_seq_simul_perfil_p
					and	nr_seq_plano		= nr_seq_produto_w;
				end if;
				
				if (nr_seq_produto_w IS NOT NULL AND nr_seq_produto_w::text <> '' AND nr_seq_tabela_w IS NOT NULL AND nr_seq_tabela_w::text <> '') then
					for r_c02_w in C02 loop
						begin
						
						select	coalesce(max(vl_preco_atual),0)
						into STRICT	vl_preco_faixa_etaria_w
						from	pls_plano_preco
						where	nr_seq_tabela		= nr_seq_tabela_p
						and	qt_idade_inicial	= r_c02_w.qt_idade_inicial
						and	qt_idade_final		= r_c02_w.qt_idade_final;
						
						if (r_c02_w.qt_beneficiario > 0) then
							vl_preco_faixa_etaria_w	:= vl_preco_faixa_etaria_w * tx_indice_w;
							
							line_w.ds_item			:= r_c02_w.qt_idade_inicial||' a '||r_c02_w.qt_idade_final||' anos';
							line_w.vl_item			:= r_c02_w.qt_beneficiario*vl_preco_faixa_etaria_w;
							line_w.qt_beneficiario		:= r_c02_w.qt_beneficiario;
							line_w.ie_totalizador		:= 'S';
							line_w.nr_seq_simul_individual	:= null;
							line_w.ie_tipo_item		:= null;
							line_w.nr_seq_simul_perfil	:= nr_seq_simul_perfil_p;
							line_w.nr_seq_regra_desconto	:= null;
							line_w.tx_desconto		:= null;
							RETURN NEXT line_w;
							
							vl_simulacao_perfil_w		:= vl_simulacao_perfil_w + r_c02_w.qt_beneficiario*vl_preco_faixa_etaria_w;
						end if;
						end;
					end loop; --C02
					
					qt_vidas_perfil_w	:= pls_obter_benef_perfil_simul(null,nr_seq_simul_perfil_p);
					
					if (qt_vidas_perfil_w > 0) then
						CALL CALL pls_simulacao_preco_pck.add_sca(nr_seq_simulacao_p, null, nr_seq_simul_perfil_p, 0, null, qt_vidas_perfil_w);
						
						CALL CALL pls_simulacao_preco_pck.add_bonificacao(nr_seq_simulacao_p, null, null, null, null, nr_seq_simul_perfil_p, qt_vidas_perfil_w, vl_simulacao_perfil_w);
						
						if (ie_produto_escolhido_w = 'N') and --Quando escolhe o produto a bonificacao e copiada para a simulacao
							(ie_lanc_auto_contrato_exist_w = 'S' or coalesce(nr_seq_contrato_w::text, '') = '') then
							CALL pls_simulacao_preco_pck.add_bonificacao_auto(nr_seq_simulacao_p, nr_seq_produto_w, nr_seq_tabela_w, null, null, null, null, nr_seq_simul_perfil_p, qt_vidas_perfil_w, vl_simulacao_perfil_w);
						end if;
						
						if (current_setting('pls_simulacao_preco_pck.tb_ds_item_w')::pls_util_cta_pck.t_varchar2_table_255.count > 0) then
							for i in current_setting('pls_simulacao_preco_pck.tb_ds_item_w')::pls_util_cta_pck.t_varchar2_table_255.first..tb_ds_item_w.last loop
								begin
								line_w.ds_item			:= current_setting('pls_simulacao_preco_pck.tb_ds_item_w')::pls_util_cta_pck.t_varchar2_table_255(i);
								line_w.vl_item			:= current_setting('pls_simulacao_preco_pck.tb_vl_item_w')::pls_util_cta_pck.t_number_table(i);
								line_w.qt_beneficiario		:= qt_vidas_perfil_w;
								line_w.ie_totalizador		:= 'S';
								line_w.nr_seq_simul_perfil	:= current_setting('pls_simulacao_preco_pck.tb_nr_seq_simulacao_perfil_w')::pls_util_cta_pck.t_number_table(i);
								line_w.ie_tipo_item		:= current_setting('pls_simulacao_preco_pck.tb_ie_tipo_item_w')::pls_util_cta_pck.t_number_table(i);
								line_w.nr_seq_regra_desconto	:= null;
								line_w.tx_desconto		:= null;
								RETURN NEXT line_w;
								end;
							end loop;
						end if;
					end if;
					CALL CALL pls_simulacao_preco_pck.limpar_vetor_item();
				end if;
			end if;
		end if;
		
		return;
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION pls_simulacao_preco_pck.obter_resumo_simulacao ( nr_seq_simulacao_p bigint, nr_seq_simul_perfil_p bigint, nr_seq_plano_p bigint, nr_seq_tabela_p bigint, ie_html_p text) FROM PUBLIC;
