-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_simulacao_preco_pck.add_bonificacao_auto ( nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_plano_p bigint, nr_seq_sca_p bigint, nr_seq_simul_benef_p pls_simulpreco_individual.nr_sequencia%type, qt_idade_p pls_simulpreco_individual.qt_idade%type, ie_tipo_benef_p pls_simulpreco_individual.ie_tipo_benef%type, nr_seq_parentesco_p pls_simulpreco_individual.nr_seq_parentesco%type, nr_seq_simul_perfil_p pls_simulacao_perfil.nr_sequencia%type, qt_vidas_perfil_p bigint, vl_base_p bigint) AS $body$
DECLARE

	vl_bonificacao_w	double precision;
	ie_tipo_contratacao_w	pls_plano.ie_tipo_contratacao%type;
	
	C01 CURSOR(	ie_tipo_contratacao_pc	pls_plano.ie_tipo_contratacao%type) FOR
		SELECT	c.nr_sequencia nr_seq_bonificacao,
			c.nm_bonificacao
		from	pls_regra_lanc_automatico a,
			pls_regra_lanc_aut_item b,
			pls_bonificacao c
		where	a.nr_sequencia	= b.nr_seq_regra
		and	c.nr_sequencia	= b.nr_seq_bonificacao
		and	clock_timestamp() between coalesce(b.dt_inicio_vigencia,clock_timestamp()) and coalesce(b.dt_fim_vigencia,clock_timestamp())
		and	b.ie_situacao	= 'A'
		and	a.ie_situacao	= 'A'
		and	a.ie_acao_regra = '6'
		and (coalesce(a.nr_seq_plano::text, '') = '' or a.nr_seq_plano = nr_seq_plano_p)
		and (coalesce(a.nr_seq_sca::text, '') = '' or a.nr_seq_sca = nr_seq_sca_p)
		and	((coalesce(a.ie_tipo_contratacao::text, '') = '') or (a.ie_tipo_contratacao = ie_tipo_contratacao_pc))
		and	not exists (	SELECT	1
					from	pls_bonificacao_vinculo x
					where	x.nr_seq_simulacao	= nr_seq_simulacao_p
					and	x.nr_seq_bonificacao	= b.nr_seq_bonificacao
					
union all

					select	1
					from	pls_bonificacao_vinculo x
					where	x.nr_seq_simulacao_perfil = nr_seq_simul_perfil_p
					and	x.nr_seq_bonificacao	= b.nr_seq_bonificacao
					
union all

					select	1
					from	pls_bonificacao_vinculo x
					where	x.nr_seq_segurado_simul = nr_seq_simul_benef_p
					and	x.nr_seq_bonificacao	= b.nr_seq_bonificacao);
	
BEGIN
	select	max(ie_tipo_contratacao)
	into STRICT	ie_tipo_contratacao_w
	from	pls_plano
	where	nr_sequencia = nr_seq_plano_p;
	
	for r_c01_w in C01(ie_tipo_contratacao_w) loop
		begin
		vl_bonificacao_w := pls_simulacao_preco_pck.calcular_bonificacao(nr_seq_simulacao_p, r_c01_w.nr_seq_bonificacao, nr_seq_simul_benef_p, qt_idade_p, ie_tipo_benef_p, nr_seq_parentesco_p, nr_seq_simul_perfil_p, qt_vidas_perfil_p, vl_base_p, null, null, vl_bonificacao_w);
		CALL CALL pls_simulacao_preco_pck.add_item(r_c01_w.nm_bonificacao||' ('||wheb_mensagem_pck.get_texto(1128351)||')', vl_bonificacao_w, nr_seq_simul_benef_p, nr_seq_simul_perfil_p, '14');
		end;
	end loop; --C01
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_simulacao_preco_pck.add_bonificacao_auto ( nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_plano_p bigint, nr_seq_sca_p bigint, nr_seq_simul_benef_p pls_simulpreco_individual.nr_sequencia%type, qt_idade_p pls_simulpreco_individual.qt_idade%type, ie_tipo_benef_p pls_simulpreco_individual.ie_tipo_benef%type, nr_seq_parentesco_p pls_simulpreco_individual.nr_seq_parentesco%type, nr_seq_simul_perfil_p pls_simulacao_perfil.nr_sequencia%type, qt_vidas_perfil_p bigint, vl_base_p bigint) FROM PUBLIC;
