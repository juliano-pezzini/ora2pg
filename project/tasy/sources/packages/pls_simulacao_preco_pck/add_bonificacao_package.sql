-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_simulacao_preco_pck.add_bonificacao ( nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_simul_benef_p pls_simulpreco_individual.nr_sequencia%type, qt_idade_p pls_simulpreco_individual.qt_idade%type, ie_tipo_benef_p pls_simulpreco_individual.ie_tipo_benef%type, nr_seq_parentesco_p pls_simulpreco_individual.nr_seq_parentesco%type, nr_seq_simul_perfil_p pls_simulacao_perfil.nr_sequencia%type, qt_vidas_perfil_p bigint, vl_simulacao_perfil_p bigint) AS $body$
DECLARE

	vl_bonificacao_w	double precision;
	C01 CURSOR FOR
		SELECT	b.nr_sequencia,
			b.nr_seq_bonificacao,
			a.nm_bonificacao,
			b.vl_bonificacao,
			b.tx_bonificacao
		from	pls_bonificacao_vinculo	b,
			pls_bonificacao		a
		where	b.nr_seq_bonificacao	= a.nr_sequencia
		and	b.nr_seq_segurado_simul	= nr_seq_simul_benef_p
		
union all

		SELECT	b.nr_sequencia,
			b.nr_seq_bonificacao,
			a.nm_bonificacao,
			b.vl_bonificacao,
			b.tx_bonificacao
		from	pls_bonificacao_vinculo	b,
			pls_bonificacao		a
		where	b.nr_seq_bonificacao	= a.nr_sequencia
		and	b.nr_seq_simulacao_perfil	= nr_seq_simul_perfil_p
		
union all

		select	b.nr_sequencia,
			b.nr_seq_bonificacao,
			a.nm_bonificacao,
			b.vl_bonificacao,
			b.tx_bonificacao
		from	pls_bonificacao_vinculo	b,
			pls_bonificacao		a
		where	b.nr_seq_bonificacao	= a.nr_sequencia
		and	b.nr_seq_simulacao	= nr_seq_simulacao_p
		and	not exists (	select	1
					from	pls_bonificacao_vinculo x
					where	x.nr_seq_simulacao_perfil = nr_seq_simul_perfil_p
					and	x.nr_seq_bonificacao	= b.nr_seq_bonificacao
					
union all

					select	1
					from	pls_bonificacao_vinculo x
					where	x.nr_seq_segurado_simul = nr_seq_simul_benef_p
					and	x.nr_seq_bonificacao	= b.nr_seq_bonificacao);
	
	
BEGIN
	for r_c01_w in C01 loop
		begin
		vl_bonificacao_w := pls_simulacao_preco_pck.calcular_bonificacao(nr_seq_simulacao_p, r_c01_w.nr_seq_bonificacao, nr_seq_simul_benef_p, qt_idade_p, ie_tipo_benef_p, nr_seq_parentesco_p, nr_seq_simul_perfil_p, qt_vidas_perfil_p, vl_simulacao_perfil_p, r_c01_w.vl_bonificacao, r_c01_w.tx_bonificacao, vl_bonificacao_w);
		
		CALL CALL pls_simulacao_preco_pck.add_item(r_c01_w.nm_bonificacao, vl_bonificacao_w, nr_seq_simul_benef_p, nr_seq_simul_perfil_p, '14');
		end;
	end loop;
	null;
	
	END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_simulacao_preco_pck.add_bonificacao ( nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_simul_benef_p pls_simulpreco_individual.nr_sequencia%type, qt_idade_p pls_simulpreco_individual.qt_idade%type, ie_tipo_benef_p pls_simulpreco_individual.ie_tipo_benef%type, nr_seq_parentesco_p pls_simulpreco_individual.nr_seq_parentesco%type, nr_seq_simul_perfil_p pls_simulacao_perfil.nr_sequencia%type, qt_vidas_perfil_p bigint, vl_simulacao_perfil_p bigint) FROM PUBLIC;
