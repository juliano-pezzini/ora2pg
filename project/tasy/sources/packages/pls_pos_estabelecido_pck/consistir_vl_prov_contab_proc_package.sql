-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

	
--Verifica e trata eventuais diverg_ncia de valor entre o vl_provis_o da pls_conta_pos_proc(tabela pai) e o somat_rio dos registros correspondentes na pls_conta_pos_proc_contab e atribui a 

--diferen_a ao registro de maior valor na pls_conta_pos_proc_contab	



CREATE OR REPLACE PROCEDURE pls_pos_estabelecido_pck.consistir_vl_prov_contab_proc ( nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


_ora2pg_r RECORD;
tb_vl_ajuste_w	pls_util_cta_pck.t_number_table;
tb_seq_ctb_w	pls_util_cta_pck.t_number_table;
i		integer := 0;
	
C00 CURSOR FOR
	SELECT	pos.nr_seq_conta_proc,
		pos.vl_provisao		vl_prov_pos,
		sum(ctb.vl_provisao)	vl_prov_ctb
	from	w_pls_conta_pos_proc 		proc,
		pls_conta_pos_proc		pos,
		pls_conta_pos_proc_contab 	ctb
	where	proc.nr_seq_conta_proc = pos.nr_seq_conta_proc
	and	pos.nr_sequencia = ctb.nr_seq_conta_pos_proc
	group by pos.nr_seq_conta_proc, pos.vl_provisao;

C01 CURSOR(	nr_seq_conta_proc_pc	pls_conta_pos_proc.nr_seq_conta_proc%type) FOR
	SELECT	max(ctb.nr_sequencia)		nr_sequencia
	from	pls_conta_pos_proc		pos,
		pls_conta_pos_proc_contab 	ctb
	where	pos.nr_sequencia 	= ctb.nr_seq_conta_pos_proc
	and	pos.nr_seq_conta_proc 	= nr_seq_conta_proc_pc
	and	ctb.vl_provisao = (	SELECT	max(ctb.vl_provisao)
				from	pls_conta_pos_proc		pos,
					pls_conta_pos_proc_contab 	ctb
				where	pos.nr_sequencia = ctb.nr_seq_conta_pos_proc
				and	pos.nr_seq_conta_proc = nr_seq_conta_proc_pc);	
BEGIN

	for r_c00_w in C00 loop
	
		if ( r_c00_w.vl_prov_pos <> r_c00_w.vl_prov_ctb) then
			
			for r_c01_w in C01( r_c00_w.nr_seq_conta_proc) loop
			
				tb_vl_ajuste_w(i) 	:= r_c00_w.vl_prov_pos - r_c00_w.vl_prov_ctb;
				tb_seq_ctb_w(i)		:= r_c01_w.nr_sequencia;
				
				if (i > pls_util_cta_pck.qt_registro_transacao_w) then
				
					SELECT * FROM pls_pos_estabelecido_pck.atualiza_prov_proc_ctb( tb_seq_ctb_w, tb_vl_ajuste_w, nm_usuario_p) INTO STRICT _ora2pg_r;
  tb_seq_ctb_w := _ora2pg_r.tb_seq_ctb_p; tb_vl_ajuste_w := _ora2pg_r.tb_vl_ajuste_p;
					i := 0;
				else
					i := i + 1;
				
				end if;
			
			end loop;
		end if;
	end loop;

	SELECT * FROM pls_pos_estabelecido_pck.atualiza_prov_proc_ctb( tb_seq_ctb_w, tb_vl_ajuste_w, nm_usuario_p) INTO STRICT _ora2pg_r;
  tb_seq_ctb_w := _ora2pg_r.tb_seq_ctb_p; tb_vl_ajuste_w := _ora2pg_r.tb_vl_ajuste_p;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pos_estabelecido_pck.consistir_vl_prov_contab_proc ( nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
