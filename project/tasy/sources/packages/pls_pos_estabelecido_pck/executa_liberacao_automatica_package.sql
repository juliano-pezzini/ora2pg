-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


--Processa liberacaes autom_ticas dos registros de p_s-estabelecido.



CREATE OR REPLACE PROCEDURE pls_pos_estabelecido_pck.executa_liberacao_automatica ( nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_chamada_p text default 'A') AS $body$
DECLARE


C01 CURSOR FOR
	SELECT distinct nr_seq_conta
	from (SELECT	a.nr_seq_conta
		from	pls_conta_pos_proc a,
			w_pls_conta_pos_proc b
		where	a.nr_seq_conta_proc = b.nr_seq_conta_proc
		and (a.vl_materiais_calc + a.vl_medico_calc + a.vl_custo_operacional_calc) > 0
		
union all

		select	a.nr_seq_conta
		from	pls_conta_pos_mat a,
			w_pls_conta_pos_mat b
		where	a.nr_seq_conta_mat = b.nr_seq_conta_mat
		and	a.vl_materiais_calc > 0) alias1;

BEGIN
	
	if (ie_origem_chamada_p = 'A')  then
		for r_c01_w in C01 loop
			CALL pls_pos_estabelecido_pck.libera_automatic_pos(	null, null, null, r_c01_w.nr_seq_conta, nm_usuario_p, cd_estabelecimento_p);
		end loop;
		
		else
		for r_c01_w in C01 loop
			CALL pls_pos_estabelecido_pck.libera_automatic_pos_gest_cta(	null, null, null, r_c01_w.nr_seq_conta, nm_usuario_p, cd_estabelecimento_p);
		end loop;
	end if;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pos_estabelecido_pck.executa_liberacao_automatica ( nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_chamada_p text default 'A') FROM PUBLIC;
