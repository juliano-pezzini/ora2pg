-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

/*

	AS ALTERAcaES REALIZADAS NESSA ROTINA DEVEM SER REFLETIDAS NA PLS_ATUALIZA_VALOR_MAT_INT

*/



CREATE OR REPLACE PROCEDURE pls_pos_estabelecido_pck.pls_atualiza_valor_mat_pos ( nr_sequencia_p bigint, nr_seq_conta_pos_cab_p pls_conta_pos_cabecalho.nr_sequencia%type, ie_gravar_log_p text, nm_usuario_p text, tx_intercambio_p bigint, ie_pos_estab_faturamento_p pls_parametros.ie_pos_estab_faturamento%type, ie_geracao_pos_estabelecido_p pls_parametros.ie_geracao_pos_estabelecido%type, ie_preco_interc_congenere_p pls_parametros.ie_preco_interc_congenere%type, nr_seq_regra_p INOUT bigint, vl_materiais_p INOUT bigint, tx_inter_out_p INOUT pls_conta_mat.tx_intercambio%type, vl_tx_material_p INOUT pls_conta_pos_mat.vl_taxa_material%type, dados_regra_preco_material_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_material) AS $body$
DECLARE


dt_preco_w			timestamp;
qt_material_w			double precision;
nr_seq_outorgante_w		bigint;
ds_retorno_w			varchar(100);
nr_seq_plano_w			bigint;
ie_autorizacao_espec_w		varchar(10)	:= 'N';
nr_seq_prestador_exec_w		bigint;
ie_tipo_segurado_w		varchar(10);
vl_material_ptu_w		double precision;
nr_seq_regra_int_w		bigint;
tx_intercambio_w		double precision;
current_setting('pls_pos_estabelecido_pck.ie_preco_interc_congenere_w')::pls_parametros.ie_preco_interc_congenere%type	pls_parametros.ie_preco_interc_congenere%type;
nr_seq_grupo_coop_seg_w		pls_segurado.nr_seq_grupo_coop%type;
ie_seguro_obito_w		pls_plano.ie_seguro_obito%type;
ie_pcmso_w			pls_segurado.ie_pcmso%type;
dados_conta_valor_w		pls_cta_valorizacao_pck.dados_conta;
dados_conta_mat_valor_w		pls_cta_valorizacao_pck.dados_conta_mat;
dados_beneficiario_valor_w	pls_cta_valorizacao_pck.dados_beneficiario;
dados_fatura_valor_w		pls_cta_valorizacao_pck.dados_fatura;
dados_tx_interc_valor_w		pls_cta_valorizacao_pck.dados_taxa_intercambio;
ie_internado_w			varchar(2);
ie_nao_gera_tx_inter_w		pls_regra_preco_mat.ie_nao_gera_tx_inter%type;
dados_regra_preco_material_w	pls_cta_valorizacao_pck.dados_regra_preco_material;
vl_calc_orig_w			pls_conta_mat.vl_material_imp%type;
ie_tipo_log_w			pls_log_calculo_proc.ie_tipo_log%type := 'C';
vl_tx_material_w		pls_conta_pos_mat.vl_taxa_material%type;
ie_status_w			pls_conta_mat.ie_status%type;
vl_material_w			pls_conta_mat.vl_material%type;
nr_seq_regra_pct_fat_w		pls_conta_mat.nr_seq_regra_pct_fat%type;

C01 CURSOR FOR
	SELECT 	max(mat.nr_seq_conta)					nr_seq_conta,
		max(mat.ie_tipo_despesa)				ie_tipo_despesa,
		max(mat.ie_origem_preco)				ie_origem_preco,
		max(coalesce(mat.qt_item,0)) 				qt_material_imp,
		max(mat.nr_seq_conta_mat)				nr_sequencia,
		max(coalesce(pos_estab.dt_item, mat.dt_item)) 	 	dt_item,
		max(coalesce(pos_estab.nr_seq_material, mat.nr_seq_material))nr_seq_material,
		max(cab.nr_seq_segurado)				nr_seq_segurado,
		max(cab.cd_estabelecimento)				cd_estabelecimento,
		max(coalesce(cab.nr_seq_tipo_acomodacao,0))			nr_seq_tipo_acomodacao,
		max(coalesce(cab.nr_seq_tipo_atendimento,0))			nr_seq_tipo_atendimento,
		max(cab.nr_seq_clinica)					nr_seq_clinica,
		max(cab.ie_tipo_guia)					ie_tipo_guia,
		max(cab.cd_guia_referencia)				cd_guia_referencia,
		max(cab.nr_seq_prestador_exec)				nr_seq_prestador_exec,
		max(cab.nr_seq_fatura)					nr_seq_fatura,
		max(cab.dt_alta)					dt_alta,
		max(cab.ie_tipo_protocolo)				ie_tipo_protocolo,
		max(mat.ie_tipo_conta)					ie_tipo_conta,
		max(mat.ie_origem_conta)				ie_origem_conta,
		max(mat.nr_seq_congenere)				nr_seq_congenere,
		max(mat.nr_seq_congenere_seg)				nr_seq_congenere_seg,
		max(mat.ie_tipo_intercambio)				ie_tipo_intercambio,
		max(mat.nr_seq_intercambio)				nr_seq_intercambio,
		max(mat.dt_recebimento_fatura)				dt_recebimento_fatura,
		max(mat.dt_postagem_fatura)				dt_postagem_fatura,
		max(coalesce(mat.dt_atendimento, coalesce(pos_estab.dt_item, mat.dt_item))) dt_atendimento_conta,
		max(mat.nr_seq_guia)					nr_seq_guia,
		max(mat.nr_seq_conta_mat)				nr_seq_conta_mat,
		max(mat.ie_tipo_tabela_valorizacao)			ie_tipo_tabela_valorizacao,
		max((SELECT	max(ie_tipo_congenere)
			from	pls_congenere
			where	nr_sequencia = mat.nr_seq_congenere_seg)) ie_tipo_congenere,
		max((select	max(nr_seq_categoria)
			from	pls_regra_categoria
			where	nr_seq_tipo_acomodacao	= cab.nr_seq_tipo_acomodacao)) nr_seq_categoria,
		max(cab.ie_tipo_segurado)			ie_tipo_segurado,
		max(cab.ie_regime_atendimento)	ie_regime_atendimento,
		max(cab.ie_regime_atendimento)	ie_saude_ocupacional
	FROM pls_conta_pos_cabecalho cab, w_pls_conta_pos_mat mat
LEFT OUTER JOIN pls_conta_pos_mat pos_estab ON (mat.nr_sequencia = pos_estab.nr_seq_conta_mat)
WHERE mat.nr_seq_conta 		= cab.nr_seq_conta  and cab.nr_sequencia		= nr_seq_conta_pos_cab_p and mat.nr_sequencia		= nr_sequencia_p;

BEGIN

tx_intercambio_w		:= coalesce(tx_intercambio_p,0);
PERFORM set_config('pls_pos_estabelecido_pck.ie_preco_interc_congenere_w', coalesce(ie_preco_interc_congenere_p,'I'), false);

for r_c01_w in C01 loop
	
	dados_conta_valor_w.nr_sequencia 		:= r_c01_w.nr_seq_conta;
	dados_conta_valor_w.nr_seq_congenere		:= r_c01_w.nr_seq_congenere;
	dados_conta_valor_w.ie_origem_conta		:= r_c01_w.ie_origem_conta;
	dados_conta_valor_w.ie_tipo_conta		:= 'C';
	dados_conta_valor_w.nr_seq_segurado		:= r_c01_w.nr_seq_segurado;
	dados_conta_valor_w.ie_tipo_intercambio		:= r_c01_w.ie_tipo_intercambio;
	dados_conta_valor_w.ie_tipo_guia		:= r_c01_w.ie_tipo_guia;
	dados_conta_valor_w.dt_alta			:= r_c01_w.dt_alta;
	dados_conta_valor_w.dt_atendimento		:= r_c01_w.dt_atendimento_conta;

	dados_fatura_valor_w.nr_sequencia		:= r_c01_w.nr_seq_fatura;
	dados_fatura_valor_w.dt_recebimento		:= r_c01_w.dt_recebimento_fatura;
	dados_fatura_valor_w.dt_postagem		:= r_c01_w.dt_postagem_fatura;

	dados_conta_mat_valor_w.nr_sequencia		:= r_c01_w.nr_seq_conta_mat;
	dados_conta_mat_valor_w.nr_seq_conta		:= r_c01_w.nr_seq_conta;
	dados_conta_mat_valor_w.nr_seq_material		:= r_c01_w.nr_seq_material;
	dados_conta_mat_valor_w.dt_atendimento		:= r_c01_w.dt_item;

	/*Obter se existe material especial*/


	select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_autorizacao_espec_w
	from	pls_solic_lib_mat_med	a,
		pls_guia_plano		b
	where	a.nr_seq_guia		= b.nr_sequencia
	and	b.nr_sequencia		= r_c01_w.nr_seq_guia;

	/* Obter dados do segurado */


	select	max(pls_obter_produto_benef(nr_sequencia, r_c01_w.dt_atendimento_conta)),
		max(ie_tipo_segurado),
		max(nr_seq_grupo_coop),
		max(ie_pcmso)
	into STRICT	nr_seq_plano_w,
		ie_tipo_segurado_w,
		nr_seq_grupo_coop_seg_w,
		ie_pcmso_w
	from	pls_segurado
	where	nr_sequencia	= r_c01_w.nr_seq_segurado;
	
	if (r_c01_w.ie_tipo_segurado IS NOT NULL AND r_c01_w.ie_tipo_segurado::text <> '') then
		ie_tipo_segurado_w := r_c01_w.ie_tipo_segurado;
	end if;

	select	max(nr_seq_outorgante),
		max(ie_seguro_obito)
	into STRICT	nr_seq_outorgante_w,
		ie_seguro_obito_w
	from	pls_plano
	where	nr_sequencia	= nr_seq_plano_w;

	if ( coalesce(r_c01_w.ie_tipo_congenere,'X') = 'OP') and ( ie_tipo_segurado_w = 'T') and ( current_setting('pls_pos_estabelecido_pck.ie_preco_interc_congenere_w')::pls_parametros.ie_preco_interc_congenere%type != 'F')then
		
		dados_conta_valor_w.nr_seq_congenere := r_c01_w.nr_seq_congenere;
	else
		dados_conta_valor_w.nr_seq_congenere := r_c01_w.nr_seq_congenere_seg;
	end if;
	
	dados_beneficiario_valor_w.nr_sequencia		:= r_c01_w.nr_seq_segurado;
	dados_beneficiario_valor_w.nr_seq_intercambio	:= r_c01_w.nr_seq_intercambio;
	dados_beneficiario_valor_w.nr_seq_plano		:= nr_seq_plano_w;
	dados_beneficiario_valor_w.nr_seq_grupo_coop	:= nr_seq_grupo_coop_seg_w;
	dados_beneficiario_valor_w.ie_tipo_beneficiario	:= ie_tipo_segurado_w;
	dados_beneficiario_valor_w.ie_beneficio_obito	:= ie_seguro_obito_w;
	dados_beneficiario_valor_w.ie_pcmso		:= ie_pcmso_w;
	
	ie_internado_w	:= pls_obter_se_internado(r_c01_w.nr_seq_conta,'C');
	dt_preco_w	:= pls_obter_data_preco_item(r_c01_w.nr_seq_conta_mat, 'M');
	
	if (pls_util_pck.ie_processo_pos_w = 'S') then
		ie_tipo_log_w := 'P';
	end if;
	
	delete	from pls_log_calculo_mat
	where	nr_seq_material = r_c01_w.nr_seq_conta_mat
	and	ie_tipo_log = ie_tipo_log_w;

	pls_define_preco_material(	r_c01_w.cd_estabelecimento, r_c01_w.nr_seq_prestador_exec, dt_preco_w,
					r_c01_w.nr_seq_material, 4, r_c01_w.ie_tipo_despesa,
					r_c01_w.ie_origem_preco, r_c01_w.ie_tipo_tabela_valorizacao, nr_seq_outorgante_w,
					r_c01_w.nr_seq_segurado, r_c01_w.nr_seq_intercambio, '',
					r_c01_w.nr_seq_categoria, r_c01_w.nr_seq_tipo_acomodacao, r_c01_w.nr_seq_tipo_atendimento,
					r_c01_w.nr_seq_clinica, r_c01_w.ie_tipo_guia, ie_autorizacao_espec_w,
					r_c01_w.nr_seq_guia, ie_gravar_log_p, nm_usuario_p, r_c01_w.nr_seq_conta_mat, '',
					null,null,null,null,null,
					null,null,null,null,null,
					ie_internado_w,null,null,null,null,
					vl_material_ptu_w, ds_retorno_w, ds_retorno_w,
					ds_retorno_w, ds_retorno_w, ds_retorno_w,
					dados_regra_preco_material_w, null, r_c01_w.ie_regime_atendimento,
					r_c01_w.ie_saude_ocupacional);
	
	nr_seq_regra_int_w	:= dados_regra_preco_material_w.nr_sequencia;
	vl_calc_orig_w		:= coalesce(vl_material_ptu_w,0);
	vl_material_ptu_w	:= (coalesce(vl_material_ptu_w,0) * r_c01_w.qt_material_imp);

	if ( vl_material_ptu_w = 0)  and ( vl_calc_orig_w != 0)  and ( r_c01_w.qt_material_imp	> 0)  then
		vl_material_ptu_w := vl_calc_orig_w;
	end if;

	select	coalesce(max(ie_nao_gera_tx_inter),'N')
	into STRICT	ie_nao_gera_tx_inter_w
	from	pls_regra_preco_mat
	where	nr_sequencia	= nr_seq_regra_int_w;

	--Se na regra de pre_o est_ apontando que n_o gera taxa de interc_mbio, ou atualiza tx_inter exceto filme,  ent_o atualiza a informacao da taxa na tabela tempor_ria. pois

	--como no caso de materiais o valor _ formado basicamente por filme, mesmo com retorno = 'F' desse campo, n_o dever_ aplicar taxa.

	if (ie_nao_gera_tx_inter_w in ('S','F')) then
		tx_intercambio_w	:= 0;
	end if;
	
	select	max(ie_status),
		max(vl_material),
		max(nr_seq_regra_pct_fat)
	into STRICT	ie_status_w,
		vl_material_w,
		nr_seq_regra_pct_fat_w
	from	pls_conta_mat
	where	nr_sequencia = r_c01_w.nr_seq_conta_mat;
	
	if (ie_status_w = 'M') and (nr_seq_regra_pct_fat_w IS NOT NULL AND nr_seq_regra_pct_fat_w::text <> '') and (vl_material_w > 0) then
		vl_material_ptu_w := vl_material_w;
		nr_seq_regra_int_w := null;
	end if;
	
	vl_tx_material_w := 0;
	if (tx_intercambio_w > 0) then
		vl_tx_material_w := coalesce(dividir((vl_material_ptu_w * tx_intercambio_w),100),0);
	end if;
	
	--Quando se refere a um material no p_s-estabelecido, a composicao do vl_beneficiario ocorre apenas com vl_material e taxa

	--vari_vel ser_ retornado para vl_materiais

	vl_materiais_p	:= vl_material_ptu_w;
	nr_seq_regra_p	:= nr_seq_regra_int_w;
	tx_inter_out_p	:= tx_intercambio_w;
	vl_tx_material_p := vl_tx_material_w;
	dados_regra_preco_material_p := dados_regra_preco_material_w;
end loop;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pos_estabelecido_pck.pls_atualiza_valor_mat_pos ( nr_sequencia_p bigint, nr_seq_conta_pos_cab_p pls_conta_pos_cabecalho.nr_sequencia%type, ie_gravar_log_p text, nm_usuario_p text, tx_intercambio_p bigint, ie_pos_estab_faturamento_p pls_parametros.ie_pos_estab_faturamento%type, ie_geracao_pos_estabelecido_p pls_parametros.ie_geracao_pos_estabelecido%type, ie_preco_interc_congenere_p pls_parametros.ie_preco_interc_congenere%type, nr_seq_regra_p INOUT bigint, vl_materiais_p INOUT bigint, tx_inter_out_p INOUT pls_conta_mat.tx_intercambio%type, vl_tx_material_p INOUT pls_conta_pos_mat.vl_taxa_material%type, dados_regra_preco_material_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_material) FROM PUBLIC;
