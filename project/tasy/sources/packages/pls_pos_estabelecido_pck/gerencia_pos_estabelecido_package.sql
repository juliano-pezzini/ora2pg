-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


/*
	Essa _ a sub-rotina principal, onde ir_ gerenciar o funcionamento da geracao/atualizacao
	das informacaes de p_s-estabelecido.
*/



CREATE OR REPLACE PROCEDURE pls_pos_estabelecido_pck.gerencia_pos_estabelecido ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_mat_p pls_conta_mat.nr_sequencia%type, ie_origem_valor_pos_p text, ie_acao_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_chamada_p text default 'A') AS $body$
BEGIN
	--Rotina respons_vel pela criacao de views utilizadas na valorizacao. Elas s_o necess_rias 

	--devido a necessidade de priorizar determinadas informacaes no momento de obtencao das 

	--regras de pre_o cadastradas.

	CALL pls_cta_consistir_pck.gera_views_valorizacao();
	
	--Esta procedure _ exclusiva para insercao do cabe_alho de conta para faturamento.

	
	CALL pls_pos_estabelecido_pck.gerar_conta_pos_cabecalho(	nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p,
					nr_seq_analise_p, nr_seq_conta_p, nr_seq_proc_p,
					nr_seq_mat_p, nm_usuario_p );
	
	--Nessa rotina ser_o gravados nas tabelas tempor_rias, os procedimentos selecionados para aplicabilidade da

	--geracao de p_s-estabelecido.

	CALL pls_pos_estabelecido_pck.carrega_procedimentos_geracao(nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p,
				      nr_seq_analise_p,	nr_seq_conta_p,	nr_seq_proc_p,
				      nm_usuario_p, cd_estabelecimento_p);
	
	--Nessa rotina ser_o gravados nas tabelas tempor_rias, os procedimentos selecionados para aplicabilidade da

	--geracao de p_s-estabelecido.

	CALL pls_pos_estabelecido_pck.carrega_materiais_geracao(	nr_seq_lote_p, nr_seq_protocolo_p, nr_seq_lote_processo_p,
					nr_seq_analise_p, nr_seq_conta_p, nr_seq_mat_p,
					nm_usuario_p, cd_estabelecimento_p);
	
	--Faz verificacaes relativas a geracao ou n_o de p_s-estabelecido e atualiza a IE_GERA_VALOR_POS_ESTAB em cada _tem

	CALL pls_pos_estabelecido_pck.identifica_item_elegivel_pos(nm_usuario_p, cd_estabelecimento_p);
	
	--Faz leitura inicial para identificar se gera valor de p_s conf. cobertura SCA. Corresponde _ pls_gerar_valor_pos_estab_sca.

	CALL pls_pos_estabelecido_pck.identifica_pos_estab_sca(nm_usuario_p, cd_estabelecimento_p);
	
	--Faz as verificacaes e eventuais convers_es de procedimentos conforme as respectivas regras. Essa etapa foi colocada ap_s 

	--a identifica_item_elegivel_pos para apenas processar os itens que dever_o de fato gerar p_s-estabelecido

	CALL pls_pos_estabelecido_pck.processa_conv_procedimentos( nm_usuario_p, cd_estabelecimento_p);
	
	--Faz as verificacaes e eventuais convers_es de materiais conforme as respectivas regras. 

	CALL pls_pos_estabelecido_pck.processa_conv_materiais( nm_usuario_p, cd_estabelecimento_p);
	
	--Identifica o tipo de valorizacao de p_s-estabelecido que ser_ aplicada.

	CALL pls_pos_estabelecido_pck.identifica_tp_valor_pos_estab(nm_usuario_p, cd_estabelecimento_p);
	
	--Identifica taxa de intercambio para os itens

	CALL pls_pos_estabelecido_pck.processa_tx_intercambio_itens( nm_usuario_p, cd_estabelecimento_p);
	
	--identificacao da tabela base para valoriza_ao.

	CALL pls_pos_estabelecido_pck.identifica_tab_base_valor( nm_usuario_p, cd_estabelecimento_p);
	
	--Etapa de valorizacao dos procedimentos selecionados. Ser_o chamadas funcionalidades para leitura e aplicacao de regras

	CALL pls_pos_estabelecido_pck.valorizacao_procedimentos( nm_usuario_p, cd_estabelecimento_p);
	
	--Etapa de valorizacao dos materiais selecionados. Ser_o chamadas funcionalidades para leitura e aplicacao de regras

	CALL pls_pos_estabelecido_pck.valorizacao_materiais( nm_usuario_p, cd_estabelecimento_p);
	
	--Leitura da regra de cobran_a p_s-estabelecido(OPS - Cadastro de Regras\OPS - Contas M_dicas\Cobran_a de p_s-estabelecido).

	CALL pls_pos_estabelecido_pck.obter_se_cobra_co_filme( nm_usuario_p, cd_estabelecimento_p);
	
	--Nessa etapa, processa as taxas de interc_mbio j_ identificadas sobre todos os itens eleg_veis para geracao de p_s.

	CALL pls_pos_estabelecido_pck.aplicacao_taxa_intercambio( nm_usuario_p, cd_estabelecimento_p);
	
	--Nessa etapa os valores presentes nas tabelas tempor_rias s_o enviados para as tabelas definitivas(tabelas )

	CALL pls_pos_estabelecido_pck.popula_tabelas_definitivas( nm_usuario_p, cd_estabelecimento_p);
	
	--geracao dos valores cont_beis de p_s-estabelecido.

	CALL pls_pos_estabelecido_pck.geracao_valores_contabeis( null, null, null, null, nm_usuario_p, cd_estabelecimento_p);
	
	--geracao dos valores PTU

	CALL pls_pos_estabelecido_pck.geracao_valores_ptu( nm_usuario_p, cd_estabelecimento_p);
	
	if (ie_origem_chamada_p = 'A') then
	
		--Processamento das ocorr_ncias de p_s-estabelecido(OPS - Glosas e ocorr_ncias\Ocorr_ncias\Conta m_dica\P_s-estabelecido)

		CALL pls_pos_estabelecido_pck.processa_ocorrencias_pos_estab( nm_usuario_p, cd_estabelecimento_p);
	end if;
	
	
	--Processa liberacaes autom_ticas dos registros de p_s-estabelecido.

	CALL pls_pos_estabelecido_pck.executa_liberacao_automatica( nm_usuario_p, cd_estabelecimento_p, ie_origem_chamada_p);
	
	--processamento de taxa de OPME de interc_mbio. (OPS - Cadastro de Regras\OPS - Faturamento\Regra de Taxa de OPME de interc_mbio)

	CALL pls_pos_estabelecido_pck.processa_tx_opme_intercambio( nm_usuario_p, cd_estabelecimento_p);
	
	--Processamento e Atualizacao do valor benefici_rio nos procedimentos e materiais

	CALL pls_pos_estabelecido_pck.processa_vl_beneficiario_itens( nm_usuario_p, cd_estabelecimento_p);
	
	--Processamento de taxas de p_s-estabelecido(OPS - Cadastro de Produtos\Regras\P_s-estabelecido). P_s-estabelecido antigo : pls_gerar_taxa_adm_pos_estab

	--Obs: Passa null como sequ_ncia da conta, pois aqui precisamos processar toda massa de dados atual. Essa rotina _ p_blica e se for chamada externamente, deve

	--ser passado um par_metro da sequencia da conta, para que sejam alimentadas as tabelas tempor_rias e a execucao possa ocorrer.

	CALL pls_pos_estabelecido_pck.processa_taxa_adm_pos( 	null, nm_usuario_p, cd_estabelecimento_p);	
		
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pos_estabelecido_pck.gerencia_pos_estabelecido ( nr_seq_lote_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_mat_p pls_conta_mat.nr_sequencia%type, ie_origem_valor_pos_p text, ie_acao_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_chamada_p text default 'A') FROM PUBLIC;
