-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_pos_estabelecido_pck.processa_tx_intercambio_itens (nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


dados_conta_valor_w		pls_cta_valorizacao_pck.dados_conta;
dados_conta_mat_valor_w		pls_cta_valorizacao_pck.dados_conta_mat;
dados_fatura_valor_w		pls_cta_valorizacao_pck.dados_fatura;
dados_beneficiario_valor_w	pls_cta_valorizacao_pck.dados_beneficiario;
dados_conta_proc_valor_w	pls_cta_valorizacao_pck.dados_conta_proc;
dados_procedimento_w		pls_cta_valorizacao_pck.dados_procedimento;
dados_tx_interc_valor_w		pls_cta_valorizacao_pck.dados_taxa_intercambio;
tb_tx_administracao_w		pls_util_cta_pck.t_number_table;
tb_seq_regra_tx_inter_w		pls_util_cta_pck.t_number_table;
tb_seq_item_w			pls_util_cta_pck.t_number_table;
i				integer := 0;

C01 CURSOR FOR
	SELECT	proc.nr_sequencia,
		proc.nr_seq_congenere,
		proc.nr_seq_segurado,
		proc.nr_seq_intercambio,
		proc.nr_seq_plano,
		proc.nr_seq_grupo_coop,
		proc.ie_tipo_segurado,
		proc.ie_obito,
		proc.dt_postagem_fatura,
		proc.dt_recebimento_fatura,
		proc.nr_seq_fatura,
		proc.ie_origem_conta,
		proc.ie_tipo_conta,
		proc.ie_tipo_guia,
		proc.dt_alta,
		proc.dt_atendimento,
		proc.nr_seq_conta,
		proc.ie_origem_proced,
		proc.cd_procedimento,
		proc.dt_item,
		proc.nr_seq_grupo_rec,
		proc.ie_tipo_intercambio,
		proc.ie_pcmso
	from	w_pls_conta_pos_proc	proc
	where	(proc.nr_seq_congenere_seg IS NOT NULL AND proc.nr_seq_congenere_seg::text <> '')
	and	ie_tipo_conta 	in ('I', 'C');

C02 CURSOR FOR
	SELECT	mat.nr_sequencia,
		mat.nr_seq_congenere,
		mat.nr_seq_segurado,
		mat.nr_seq_intercambio,
		mat.nr_seq_plano,
		mat.nr_seq_grupo_coop,
		mat.ie_tipo_segurado,
		mat.ie_obito,
		mat.dt_postagem_fatura,
		mat.dt_recebimento_fatura,
		mat.nr_seq_fatura,
		mat.ie_origem_conta,
		mat.ie_tipo_conta,
		mat.ie_tipo_guia,
		mat.dt_alta,
		mat.dt_atendimento,
		mat.nr_seq_conta,
		mat.nr_seq_material,
		mat.dt_item,
		mat.ie_tipo_intercambio,
		mat.ie_pcmso,
		mat.nr_Seq_conta_mat
	from	w_pls_conta_pos_mat	mat
	where	(mat.nr_seq_congenere_seg IS NOT NULL AND mat.nr_seq_congenere_seg::text <> '')
	and	mat.ie_tipo_conta	in ('I', 'C');

BEGIN
	tb_seq_item_w.delete;
	tb_tx_administracao_w.delete;
	tb_seq_regra_tx_inter_w.delete;
	for r_c01_w in C01 loop
	
		tb_seq_item_w(i) := r_c01_w.nr_sequencia;
		dados_procedimento_w.nr_seq_grupo_rec 		:= r_c01_w.nr_seq_grupo_rec;
		dados_fatura_valor_w.nr_sequencia 		:= r_c01_w.nr_seq_fatura;
		dados_fatura_valor_w.dt_recebimento		:= r_c01_w.dt_recebimento_fatura;
		dados_fatura_valor_w.dt_postagem		:= r_c01_w.dt_postagem_fatura;
		dados_conta_valor_w.nr_sequencia 		:= r_c01_w.nr_seq_conta;
		dados_conta_valor_w.nr_seq_congenere		:= r_c01_w.nr_seq_congenere;
		dados_conta_valor_w.ie_origem_conta		:= r_c01_w.ie_origem_conta;
		dados_conta_valor_w.ie_tipo_conta		:= r_c01_w.ie_tipo_conta;
		dados_conta_valor_w.nr_seq_segurado		:= r_c01_w.nr_seq_segurado;
		dados_conta_valor_w.ie_tipo_intercambio		:= r_c01_w.ie_tipo_intercambio;
		dados_conta_valor_w.ie_tipo_guia		:= r_c01_w.ie_tipo_guia;
		dados_conta_valor_w.dt_alta			:= r_c01_w.dt_alta;
		dados_conta_valor_w.dt_atendimento		:= r_c01_w.dt_atendimento;
		dados_conta_proc_valor_w.nr_sequencia		:= r_c01_w.nr_sequencia;
		dados_conta_proc_valor_w.nr_seq_conta		:= r_c01_w.nr_seq_conta;
		dados_conta_proc_valor_w.ie_origem_proced	:= r_c01_w.ie_origem_proced;
		dados_conta_proc_valor_w.cd_procedimento	:= r_c01_w.cd_procedimento;
		dados_conta_proc_valor_w.dt_procedimento	:= r_c01_w.dt_item;
		dados_beneficiario_valor_w.nr_sequencia		:= r_c01_w.nr_seq_segurado;
		dados_beneficiario_valor_w.nr_seq_intercambio	:= r_c01_w.nr_seq_intercambio;
		dados_beneficiario_valor_w.nr_seq_plano		:= r_c01_w.nr_seq_plano;
		dados_beneficiario_valor_w.nr_seq_grupo_coop	:= r_c01_w.nr_seq_grupo_coop;
		dados_beneficiario_valor_w.ie_tipo_beneficiario	:= r_c01_w.ie_tipo_segurado;
		dados_beneficiario_valor_w.ie_beneficio_obito	:= r_c01_w.ie_obito;
		dados_beneficiario_valor_w.ie_pcmso		:= r_c01_w.ie_pcmso;
		
		dados_tx_interc_valor_w	:= pls_cta_valorizacao_pck.obter_taxa_intercambio(	dados_conta_valor_w,
												dados_conta_proc_valor_w, 
												null,
												dados_fatura_valor_w, 
												dados_beneficiario_valor_w, 
												dados_procedimento_w, 
												cd_estabelecimento_p);
		tb_seq_regra_tx_inter_w(i) := 	dados_tx_interc_valor_w.nr_sequencia;
		tb_tx_administracao_w(i) :=	coalesce(dados_tx_interc_valor_w.pr_taxa,0);
		
		if ( i > pls_util_cta_pck.qt_registro_transacao_w) then
		
			CALL pls_pos_estabelecido_pck.atualiza_tx_inter_proc_temp(	tb_seq_item_w, tb_tx_administracao_w, tb_seq_regra_tx_inter_w);
			
			i := 0;
			tb_seq_item_w.delete;
			tb_tx_administracao_w.delete;
			tb_seq_regra_tx_inter_w.delete;
		else
			i := i + 1;
		end if;
		
	end loop;
	
	CALL pls_pos_estabelecido_pck.atualiza_tx_inter_proc_temp(	tb_seq_item_w, tb_tx_administracao_w, tb_seq_regra_tx_inter_w);
	tb_seq_item_w.delete;
	tb_tx_administracao_w.delete;
	tb_seq_regra_tx_inter_w.delete;
	
	for r_c02_w in C02 loop
		tb_seq_item_w(i) := r_c02_w.nr_sequencia;
		dados_fatura_valor_w.nr_sequencia 		:= r_c02_w.nr_seq_fatura;
		dados_fatura_valor_w.dt_recebimento		:= r_c02_w.dt_recebimento_fatura;
		dados_fatura_valor_w.dt_postagem		:= r_c02_w.dt_postagem_fatura;
		dados_conta_valor_w.nr_sequencia 		:= r_c02_w.nr_seq_conta;
		dados_conta_valor_w.nr_seq_congenere		:= r_c02_w.nr_seq_congenere;
		dados_conta_valor_w.ie_origem_conta		:= r_c02_w.ie_origem_conta;
		dados_conta_valor_w.ie_tipo_conta		:= r_c02_w.ie_tipo_conta;
		dados_conta_valor_w.nr_seq_segurado		:= r_c02_w.nr_seq_segurado;
		dados_conta_valor_w.ie_tipo_intercambio		:= r_c02_w.ie_tipo_intercambio;
		dados_conta_valor_w.ie_tipo_guia		:= r_c02_w.ie_tipo_guia;
		dados_conta_valor_w.dt_alta			:= r_c02_w.dt_alta;
		dados_conta_valor_w.dt_atendimento		:= r_c02_w.dt_atendimento;
		dados_beneficiario_valor_w.nr_sequencia		:= r_c02_w.nr_seq_segurado;
		dados_beneficiario_valor_w.nr_seq_intercambio	:= r_c02_w.nr_seq_intercambio;
		dados_beneficiario_valor_w.nr_seq_plano		:= r_c02_w.nr_seq_plano;
		dados_beneficiario_valor_w.nr_seq_grupo_coop	:= r_c02_w.nr_seq_grupo_coop;
		dados_beneficiario_valor_w.ie_tipo_beneficiario	:= r_c02_w.ie_tipo_segurado;
		dados_beneficiario_valor_w.ie_beneficio_obito	:= r_c02_w.ie_obito;
		dados_beneficiario_valor_w.ie_pcmso		:= r_c02_w.ie_pcmso;
		dados_conta_mat_valor_w.nr_sequencia		:= r_c02_w.nr_sequencia;
		dados_conta_mat_valor_w.nr_seq_conta		:= r_c02_w.nr_seq_conta;
		dados_conta_mat_valor_w.nr_seq_material		:= r_c02_w.nr_seq_material;
		dados_conta_mat_valor_w.dt_atendimento		:= r_c02_w.dt_item;
		
		dados_tx_interc_valor_w	:= pls_cta_valorizacao_pck.obter_taxa_intercambio(	dados_conta_valor_w,
												null, 
												dados_conta_mat_valor_w,
												dados_fatura_valor_w, 
												dados_beneficiario_valor_w, 
												null, 
												cd_estabelecimento_p);
		tb_seq_regra_tx_inter_w(i) := 	dados_tx_interc_valor_w.nr_sequencia;
		tb_tx_administracao_w(i) :=	coalesce(dados_tx_interc_valor_w.pr_taxa,0);
		
		if ( i > pls_util_cta_pck.qt_registro_transacao_w) then
		
			CALL pls_pos_estabelecido_pck.atualiza_tx_inter_mat_temp(	tb_seq_item_w, tb_tx_administracao_w, tb_seq_regra_tx_inter_w);
			
			i := 0;
			tb_seq_item_w.delete;
			tb_tx_administracao_w.delete;
			tb_seq_regra_tx_inter_w.delete;
		else
			i := i + 1;
		
		end if;
			
		CALL pls_pos_estabelecido_pck.atualiza_tx_inter_mat_temp(	tb_seq_item_w, tb_tx_administracao_w, tb_seq_regra_tx_inter_w);
		
		tb_seq_item_w.delete;
		tb_tx_administracao_w.delete;
		tb_seq_regra_tx_inter_w.delete;
	end loop;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pos_estabelecido_pck.processa_tx_intercambio_itens (nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
