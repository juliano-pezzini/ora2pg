-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION guias_nom_pck.obter_lista ( nm_usuario_p text, ds_cabecalho_p text ) RETURNS SETOF T_OBJETO_ROW_DATA AS $body$
DECLARE


ds_linha_w  varchar(4000);
count_w	bigint;

t_objeto_row_w			t_objeto_row;
nr_linha_w    w_geracao_guia.nr_linha%type;
ds_cabecalho_w  varchar(4000);

C01 CURSOR FOR
 SELECT NR_LINHA, DS_COLUNA, CASE WHEN IE_CONFIDENCIAL='S' THEN  DS_VALOR_CRIPTOGRAFADO  ELSE DS_VALOR END  DS_VALOR
 from w_geracao_guia
 where nm_usuario = nm_usuario_p
 order by nr_linha, nr_sequencia;

BEGIN

    nr_linha_w := 1;

    ds_cabecalho_w := coalesce(ds_cabecalho_p, '');

    t_objeto_row_w.ie_tipo_registro := 0;
    t_objeto_row_w.cabecalho := ds_cabecalho_w;
    t_objeto_row_w.registro	:= null;
    RETURN NEXT t_objeto_row_w;

    for r_c01 in C01 loop
    begin

      count_w := C01%ROWCOUNT;

      if (nr_linha_w = r_c01.nr_linha) then
        if length(trim(both ds_linha_w)) > 0 then
           ds_linha_w := ds_linha_w ||', '|| coalesce(r_c01.ds_valor, '');
        else
           ds_linha_w := coalesce(r_c01.ds_valor, '');
        end if;

        t_objeto_row_w.ie_tipo_registro := 2;
        t_objeto_row_w.cabecalho := null;
        t_objeto_row_w.registro	:= guias_nom_pck.monta_linha(ds_linha_w, r_c01.nr_linha, ',');
      else
      begin
        RETURN NEXT t_objeto_row_w;
        ds_linha_w := r_c01.ds_valor;
        nr_linha_w := r_c01.nr_linha;
      end;
      end if;

    end;
    END LOOP;
    RETURN NEXT t_objeto_row_w;

return;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION guias_nom_pck.obter_lista ( nm_usuario_p text, ds_cabecalho_p text ) FROM PUBLIC;
