-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_packway_preview_pck.get_patient_preview_column (nr_seq_protocolo_int_pac_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE) RETURNS SETOF COLUMN_TABLE_T AS $body$
DECLARE


        column_data_c CURSOR FOR
            SELECT
                a.nr_sequencia,
                b.ie_tipo_evento,
                obter_descricao_dominio(8828, b.ie_tipo_evento) DS_TIPO,
                d.nr_sequencia NR_SEQ_ACAO, 
                d.ds_acao, 
                a.nr_seq_protocolo_int_pac,
                MAX(e.nr_ordem) NR_ORDEM_TIPO_EVENTO,
                MAX(f.nr_ordem) NR_ORDEM_PLANO,
                b.nr_seq_origem,
                b.nr_sequencia NR_SEQ_EVENTO,
                b.ds_evento_plano || '_' || b.nr_dia_protocolo || '_' || b.nr_seq_ordem || '_' || coalesce(b.ie_ocultar_visao_paciente, 'N') COLUMN_ID
            FROM protocolo_int_pac_etapa a 
            INNER JOIN protocolo_int_pac_evento b ON
                a.nr_sequencia = b.nr_seq_prt_int_pac_etapa
            LEFT JOIN gqa_pendencia_regra c ON
                c.nr_sequencia = b.nr_seq_plano AND
                c.ie_situacao = 'A'
            LEFT JOIN gqa_acao d ON
                d.nr_seq_pend_regra = c.nr_sequencia AND
                d.ie_situacao = 'A'
            LEFT JOIN protocolo_int_pac_tp_event e ON
               e.nr_seq_protocolo = a.nr_seq_protocolo_int_pac AND 
               e.cd_dominio_tp_evento = b.ie_tipo_evento
            LEFT JOIN protocolo_int_pac_categori f ON
                e.nr_sequencia = f.nr_seq_tp_evento AND 
                d.nr_sequencia = f.nr_seq_acao
             WHERE 
                a.nr_seq_protocolo_int_pac = nr_seq_protocolo_int_pac_p
            GROUP BY 
                a.nr_sequencia,
                b.ie_tipo_evento,  
                a.nr_seq_protocolo_int_pac,
                obter_descricao_dominio(8828, b.ie_tipo_evento),
                d.nr_sequencia, 
                d.ds_acao,
                b.nr_seq_origem,
                b.nr_sequencia,
                b.ds_evento_plano || '_' || b.nr_dia_protocolo || '_' || b.nr_seq_ordem || '_' || coalesce(b.ie_ocultar_visao_paciente, 'N')
            ORDER BY nr_ordem_tipo_evento, nr_ordem_plano, d.ds_acao;

            column_row_w column_row_t;


BEGIN

        FOR column_data_r IN column_data_c LOOP

            column_row_w.nr_sequencia := column_data_r.nr_sequencia;
            column_row_w.ie_tipo_evento := column_data_r.ie_tipo_evento;
            column_row_w.ds_tipo := column_data_r.ds_tipo;
            column_row_w.nr_seq_acao := column_data_r.nr_seq_acao;
            column_row_w.ds_acao := column_data_r.ds_acao;
            column_row_w.nr_seq_protocolo_int_pac := column_data_r.nr_seq_protocolo_int_pac;
            column_row_w.nr_ordem_tipo_evento := column_data_r.nr_ordem_tipo_evento;
            column_row_w.nr_ordem_plano := column_data_r.nr_ordem_plano;
            column_row_w.nr_seq_origem := column_data_r.nr_seq_origem;
            column_row_w.nr_seq_evento := column_data_r.nr_seq_evento;
            column_row_w.column_id := column_data_r.column_id;
            RETURN NEXT column_row_w;

        END LOOP;
        RETURN;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_packway_preview_pck.get_patient_preview_column (nr_seq_protocolo_int_pac_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE) FROM PUBLIC;
