-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_packway_preview_pck.get_preview_plan (nr_seq_protocolo_int_pac_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE, nr_seq_acao_p gqa_acao.nr_sequencia%TYPE, ie_tipo_evento_p protocolo_int_pac_evento.ie_tipo_evento%TYPE, ie_nome_amigavel_p text DEFAULT 'N') RETURNS SETOF PLAN_TABLE_T AS $body$
DECLARE


        plan_c CURSOR FOR
            SELECT c.nr_sequencia NR_SEQ_EVENTO,
                   c.ie_tipo_evento IE_TIPO_EVENTO,
                   e.nr_sequencia NR_SEQ_ACAO,
                   coalesce(CASE WHEN ie_nome_amigavel_p='S' THEN  e.ds_plano_amigavel  ELSE e.ds_plano END , e.ds_plano) DS_PLANO,
                  (SELECT MAX(g.nm_pessoa_fisica)
                     FROM gqa_pendencia_pac f, pessoa_fisica g
                    WHERE f.nr_seq_protocolo_int_pac_even = c.nr_sequencia
                    AND g.nm_usuario = f.nm_usuario) DS_USUARIO,
                (SELECT coalesce(CASE WHEN MAX(obter_informacoes_pendencia(h.nr_sequencia,'D')) IS NULL THEN 'N'  ELSE 'S' END ,'N')
                  FROM protocolo_int_pac_evento f,
                       gqa_pendencia_pac        g,
                       gqa_pend_pac_acao        h
                 WHERE f.nr_sequencia      = g.nr_seq_protocolo_int_pac_even
                   AND g.nr_sequencia      = h.nr_seq_pend_pac
                   AND f.nr_sequencia      = c.nr_sequencia
                   AND h.nr_seq_regra_acao = e.nr_sequencia) IE_HAS_EXECUTED,
                CASE WHEN coalesce(c.nr_seq_origem::text, '') = '' THEN  'N'  ELSE 'S' END  IE_HAS_EXECUTED_EXTERNAL_CP,
                coalesce(ie_evento_manual, 'N') IE_HAS_VARIANCE_CANDIDATE,
                (SELECT CASE WHEN Count(1)=0 THEN 'N'  ELSE 'S' END
                  FROM protocolo_int_pac_variance
                 WHERE nr_seq_evento = c.nr_sequencia
                   AND nr_seq_acao   = e.nr_sequencia
                   AND ie_situacao   = 'A') IE_HAS_VARIANCE,
                 c.ds_evento_plano || '_' || c.nr_dia_protocolo || '_' || c.nr_seq_ordem || '_' || coalesce(c.ie_ocultar_visao_paciente, 'N') COLUMN_ID,
                 CASE WHEN coalesce(c.dt_real::text, '') = '' THEN  'N'  ELSE 'S' END  IE_FINISHED
              FROM protocolo_int_pac_etapa b, protocolo_int_pac_evento c
LEFT OUTER JOIN gqa_pendencia_regra d ON (c.nr_seq_plano = d.nr_sequencia)
LEFT OUTER JOIN gqa_acao e ON (d.nr_sequencia = e.nr_seq_pend_regra AND nr_seq_acao_p = e.nr_sequencia)
WHERE b.nr_sequencia = c.nr_seq_prt_int_pac_etapa   AND (coalesce(nr_seq_acao_p::text, '') = '' or d.ie_situacao  = 'A') AND (coalesce(nr_seq_acao_p::text, '') = '' or e.ie_situacao  = 'A') AND c.ie_tipo_evento = ie_tipo_evento_p  AND b.nr_seq_protocolo_int_pac = nr_seq_protocolo_int_pac_p;

        plan_row_w plan_row_t;


BEGIN

        FOR plan_c_w IN plan_c LOOP

            plan_row_w.nr_seq_evento := plan_c_w.nr_seq_evento;
            plan_row_w.ie_tipo_evento := plan_c_w.ie_tipo_evento;
            plan_row_w.nr_seq_acao := plan_c_w.nr_seq_acao;
            plan_row_w.ds_plano := plan_c_w.ds_plano;
            plan_row_w.ds_usuario := plan_c_w.ds_usuario;
            plan_row_w.ie_has_executed := plan_c_w.ie_has_executed;
            plan_row_w.ie_has_executed_external_cp := plan_c_w.ie_has_executed_external_cp;
            plan_row_w.ie_has_variance_candidate := plan_c_w.ie_has_variance_candidate;
            plan_row_w.ie_has_variance := plan_c_w.ie_has_variance;
            plan_row_w.ie_finished := plan_c_w.ie_finished;
            plan_row_w.column_id := plan_c_w.column_id;
            RETURN NEXT plan_row_w;

        END LOOP;
        RETURN;

    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION clinical_packway_preview_pck.get_preview_plan (nr_seq_protocolo_int_pac_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE, nr_seq_acao_p gqa_acao.nr_sequencia%TYPE, ie_tipo_evento_p protocolo_int_pac_evento.ie_tipo_evento%TYPE, ie_nome_amigavel_p text DEFAULT 'N') FROM PUBLIC;
