-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION clinical_packway_preview_pck.get_patient_preview_header (nr_seq_protocolo_int_pac_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE, ie_nome_amigavel_p text DEFAULT 'N') RETURNS SETOF HEADER_TABLE_T AS $body$
DECLARE


        header_data_c CURSOR FOR
            SELECT
                COLUMN_ID,
                SEQ_ETAPA,
                DS_EVENTO,
                DS_ETAPA,
                IE_OCULTAR_EVENTO,
                IE_OCULTAR_ETAPA,
                NR_DIAS_ETAPA,
                NR_DIA_EVENTO,
                NR_DIA_INICIAL,
                NR_DIA_FINAL,
                NR_SEQ_PROTOCOLO_INTEGRADO,
                IE_EVENTO_SUMARIO,
                DT_PREVISTA,
                clinical_packway_preview_pck.get_preview_patient_outcome(SEQ_ETAPA, 'N', ie_nome_amigavel_p) DS_OUTCOMES,
                CD_DPC
            FROM (
              SELECT
                b.nr_sequencia SEQ_ETAPA,
                coalesce( CASE WHEN ie_nome_amigavel_p='S' THEN  ds_evento_plano_paciente  ELSE ds_evento_plano END , ds_evento_plano ) DS_EVENTO,
                coalesce( CASE WHEN ie_nome_amigavel_p='S' THEN  ds_etapa_paciente  ELSE ds_etapa END , ds_etapa ) DS_ETAPA,
                a.ie_ocultar_visao_paciente IE_OCULTAR_EVENTO,
                b.ie_ocultar_visao_paciente IE_OCULTAR_ETAPA,
                b.nr_dias_real NR_DIAS_ETAPA,
                a.nr_dia_protocolo NR_DIA_EVENTO,
                b.nr_dia_inicial,
                b.nr_dia_final,
                b.nr_seq_protocolo_int_pac NR_SEQ_PROTOCOLO_INTEGRADO,
                b.ie_evento_sumario,
                a.dt_prevista,
                a.nr_seq_ordem NR_ORDEM,
                obter_codigo_dpc(d.nr_atendimento_origem, a.dt_prevista) CD_DPC,
                a.ds_evento_plano || '_' || a.nr_dia_protocolo || '_' || a.nr_seq_ordem || '_' || coalesce(a.ie_ocultar_visao_paciente, 'N') COLUMN_ID
            FROM protocolo_int_pac_evento a
            INNER JOIN protocolo_int_pac_etapa b ON
                b.nr_sequencia = a.nr_seq_prt_int_pac_etapa
            INNER JOIN protocolo_int_paciente d ON
                b.nr_seq_protocolo_int_pac = d.nr_sequencia
            LEFT JOIN protocolo_int_etapa_resul c ON
                c.nr_seq_etapa = b.nr_sequencia
            WHERE
                b.nr_seq_protocolo_int_pac = nr_seq_protocolo_int_pac_p
             ) alias5 
            GROUP BY
                COLUMN_ID,
                SEQ_ETAPA,
                DS_EVENTO,
                DS_ETAPA,
                IE_OCULTAR_EVENTO,
                IE_OCULTAR_ETAPA,
                NR_DIAS_ETAPA,
                NR_DIA_EVENTO,
                NR_DIA_INICIAL,
                NR_DIA_FINAL,
                NR_SEQ_PROTOCOLO_INTEGRADO,
                IE_EVENTO_SUMARIO,
                DT_PREVISTA,
                clinical_packway_preview_pck.get_preview_patient_outcome(SEQ_ETAPA, 'N', ie_nome_amigavel_p),
                CD_DPC,
                clinical_packway_preview_pck.get_header_events_id(SEQ_ETAPA, NR_DIA_EVENTO, NR_ORDEM),
                NR_ORDEM
            ORDER BY nr_dia_evento, nr_ordem, nr_seq_protocolo_integrado;

            header_row_w header_row_t;


BEGIN

        FOR header_data_r IN header_data_c LOOP

            header_row_w.column_id := header_data_r.column_id;
            header_row_w.seq_etapa := header_data_r.seq_etapa;
            header_row_w.ds_evento := header_data_r.ds_evento;
            header_row_w.ds_etapa := header_data_r.ds_etapa;
            header_row_w.ie_ocultar_evento := header_data_r.ie_ocultar_evento;
            header_row_w.ie_ocultar_etapa := header_data_r.ie_ocultar_etapa;
            header_row_w.nr_dias_etapa := header_data_r.nr_dias_etapa;
            header_row_w.nr_dia_evento := header_data_r.nr_dia_evento;
            header_row_w.nr_dia_inicial := header_data_r.nr_dia_inicial;
            header_row_w.nr_dia_final := header_data_r.nr_dia_final;
            header_row_w.nr_seq_protocolo_integrado := header_data_r.nr_seq_protocolo_integrado;
            header_row_w.ie_evento_sumario := header_data_r.ie_evento_sumario;
            header_row_w.dt_prevista := header_data_r.dt_prevista;
            header_row_w.ds_outcomes := header_data_r.ds_outcomes;
            header_row_w.cd_dpc := header_data_r.cd_dpc;
            RETURN NEXT header_row_w;

        END LOOP;
        RETURN;
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION clinical_packway_preview_pck.get_patient_preview_header (nr_seq_protocolo_int_pac_p protocolo_int_pac_etapa.nr_seq_protocolo_int_pac%TYPE, ie_nome_amigavel_p text DEFAULT 'N') FROM PUBLIC;
