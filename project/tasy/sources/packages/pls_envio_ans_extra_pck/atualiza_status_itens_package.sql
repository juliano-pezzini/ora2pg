-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_envio_ans_extra_pck.atualiza_status_itens ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


tb_seq_w    	pls_util_cta_pck.t_number_table;
tb_vazia_w	pls_util_cta_pck.t_number_table;				
				
C01 is CURSOR
	with query_temp as (
		SELECT	b.nr_seq_conta_proc
		from	pls_monitor_tiss_cta_val a,
			pls_monitor_tiss_proc_val b
		where	a.nr_seq_lote_monitor = nr_seq_lote_p
		and 	a.nr_sequencia = b.nr_seq_cta_val
		and 	a.ie_tipo_evento = 'PR'
		and 	exists ( 	SELECT 	1
					from 	pls_monitor_tiss_cta_val 
					where 	nr_seq_lote_monitor = a.nr_seq_lote_monitor
					and 	nr_seq_conta = a.nr_seq_conta 
					and 	ie_tipo_evento = 'PC')
		
union all

		select	b.nr_seq_conta_proc
		from	pls_monitor_tiss_cta_val a,
			pls_monitor_tiss_proc_val b
		where	a.nr_seq_lote_monitor = nr_seq_lote_p
		and 	a.nr_sequencia = b.nr_seq_cta_val
		and 	a.ie_tipo_evento = 'PD'
		and 	exists ( 	select 	1 
					from 	pls_monitor_tiss_cta_val 
					where 	nr_seq_lote_monitor = a.nr_seq_lote_monitor
					and 	nr_seq_conta = a.nr_seq_conta 
					and 	ie_tipo_evento = 'PC')
	)select x.nr_sequencia	
	from	pls_monitor_tiss_alt x,
		query_temp query_temp
	where 	x.nr_seq_conta_proc =  query_temp.nr_seq_conta_proc
	and 	x.dt_evento between dt_mes_comp_w and dt_fim_mes_comp_w
	and 	x.ie_tipo_evento in ('PR','PD')
	and 	x.ie_status in ('P','N');					
				
		
C02 is CURSOR
	with query_temp as (
		SELECT	b.nr_seq_conta_mat
		from	pls_monitor_tiss_cta_val a,
			pls_monitor_tiss_mat_val b
		where	a.nr_seq_lote_monitor = nr_seq_lote_p
		and 	a.nr_sequencia = b.nr_seq_cta_val
		and 	a.ie_tipo_evento = 'PR'
		and 	exists ( 	SELECT 	1
					from 	pls_monitor_tiss_cta_val 
					where 	nr_seq_lote_monitor = a.nr_seq_lote_monitor
					and 	nr_seq_conta = a.nr_seq_conta 
					and 	ie_tipo_evento = 'PC')
		
union all

		select	b.nr_seq_conta_mat
		from	pls_monitor_tiss_cta_val a,
			pls_monitor_tiss_mat_val b
		where	a.nr_seq_lote_monitor = nr_seq_lote_p
		and 	a.nr_sequencia = b.nr_seq_cta_val
		and 	a.ie_tipo_evento = 'PD'
		and 	exists ( 	select 	1 
					from 	pls_monitor_tiss_cta_val 
					where 	nr_seq_lote_monitor = a.nr_seq_lote_monitor
					and 	nr_seq_conta = a.nr_seq_conta 
					and 	ie_tipo_evento = 'PC')
	)select x.nr_sequencia	
	from	pls_monitor_tiss_alt x,
		query_temp query_temp
	where 	x.nr_seq_conta_mat =  query_temp.nr_seq_conta_mat
	and 	x.dt_evento between dt_mes_comp_w and dt_fim_mes_comp_w
	and 	x.ie_tipo_evento in ('PR','PD')
	and 	x.ie_status in ('P','N');
	
C03 is CURSOR
	with query_temp as (
		SELECT	b.nr_seq_conta_proc
		from	pls_monitor_tiss_cta_val a,
			pls_monitor_tiss_proc_val b
		where	a.nr_seq_lote_monitor = nr_seq_lote_p
		and 	a.nr_sequencia = b.nr_seq_cta_val
		and 	a.ie_tipo_evento = 'PD'
		and 	exists ( 	SELECT 	1
					from 	pls_monitor_tiss_cta_val 
					where 	nr_seq_lote_monitor = a.nr_seq_lote_monitor
					and 	nr_seq_conta = a.nr_seq_conta 
					and 	ie_tipo_evento = 'PR')
	)select x.nr_sequencia	
	from	pls_monitor_tiss_alt x,
		query_temp query_temp
	where 	x.nr_seq_conta_proc =  query_temp.nr_seq_conta_proc
	and 	x.dt_evento between dt_mes_comp_w and dt_fim_mes_comp_w
	and 	x.ie_tipo_evento = 'PD'
	and 	x.ie_status in ('P','N');					
				
		
C04 is CURSOR
	with query_temp as (
		SELECT	b.nr_seq_conta_mat
		from	pls_monitor_tiss_cta_val a,
			pls_monitor_tiss_mat_val b
		where	a.nr_seq_lote_monitor = nr_seq_lote_p
		and 	a.nr_sequencia = b.nr_seq_cta_val
		and 	a.ie_tipo_evento = 'PD'
		and 	exists ( 	SELECT 	1
					from 	pls_monitor_tiss_cta_val 
					where 	nr_seq_lote_monitor = a.nr_seq_lote_monitor
					and 	nr_seq_conta = a.nr_seq_conta 
					and 	ie_tipo_evento = 'PR')
	)select x.nr_sequencia	
	from	pls_monitor_tiss_alt x,
		query_temp query_temp
	where 	x.nr_seq_conta_mat =  query_temp.nr_seq_conta_mat
	and 	x.dt_evento between dt_mes_comp_w and dt_fim_mes_comp_w
	and 	x.ie_tipo_evento = 'PD'
	and 	x.ie_status in ('P','N');
					

BEGIN

	open c01;
	loop
		tb_seq_w.delete;
		
		fetch C01 bulk collect into tb_seq_w
		limit current_setting('pls_envio_ans_extra_pck.qt_registro_transacao_w')::integer;
		
		exit when tb_seq_w.count = 0;
		
		CALL pls_envio_ans_extra_pck.atualiza_tabela_controle(tb_seq_w , tb_vazia_w, 'AG');
	end loop;
	close C01;
	commit;

	open c02;
	loop
		tb_seq_w.delete;
		
		fetch C02 bulk collect into tb_seq_w
		limit current_setting('pls_envio_ans_extra_pck.qt_registro_transacao_w')::integer;
		
		exit when tb_seq_w.count = 0;
		
		CALL pls_envio_ans_extra_pck.atualiza_tabela_controle(tb_seq_w, tb_vazia_w,  'AG');

	end loop;
	close C02;
	commit;

	open c03;
	loop
		tb_seq_w.delete;
		
		fetch C03 bulk collect into tb_seq_w
		limit current_setting('pls_envio_ans_extra_pck.qt_registro_transacao_w')::integer;
		
		exit when tb_seq_w.count = 0;
		
		CALL pls_envio_ans_extra_pck.atualiza_tabela_controle(tb_seq_w, tb_vazia_w, 'AG');
		
	end loop;
	close C03;
	commit;

	open c04;
	loop
		tb_seq_w.delete;
		
		fetch C04 bulk collect into tb_seq_w
		limit current_setting('pls_envio_ans_extra_pck.qt_registro_transacao_w')::integer;
		
		exit when tb_seq_w.count = 0;
		
		CALL pls_envio_ans_extra_pck.atualiza_tabela_controle(tb_seq_w, tb_vazia_w, 'AG');
		
	end loop;
	close C04;
	commit;
	
END;					

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_envio_ans_extra_pck.atualiza_status_itens ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
