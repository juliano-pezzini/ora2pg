-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_envio_ans_extra_pck.marcar_estagio_geracao ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, ie_opcao_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

					
/*
	ie_opcao_p = I - Inicio da geracao das contas
	ie_opcao_p = F - Fim da geracao das contas
*/
				
					
ds_sql_w	varchar(4000);		
 nm_id_sid_w	varchar(50);
 nm_id_serial_w	varchar(50);		
					

BEGIN
	--Para controle, no final da geracao ira limpar o SID e Serial
	if ( ie_opcao_p = 'F') then
	
		update 	pls_monitor_tiss_lote
		set 	nm_id_serial  = NULL,
			nm_id_sid  = NULL,
			dt_fim_ger_lote = clock_timestamp()
		where 	nr_sequencia = nr_seq_lote_p;
	else --se for inicio da geracao, obtem o sid e serial
	
		ds_sql_w := 	'select	sid, ' || pls_util_pck.enter_w ||
		'	serial# ' || pls_util_pck.enter_w ||
		'	from	v$session ' || pls_util_pck.enter_w ||
		'where	audsid = userenv(''SESSIONID'') ';
		
		EXECUTE ds_sql_w into STRICT nm_id_sid_w, nm_id_serial_w;
		
		update 	pls_monitor_tiss_lote
		set 	nm_id_serial = nm_id_serial_w,
			nm_id_sid = nm_id_sid_w,
			dt_fim_ger_lote  = NULL,
			dt_inicio_ger_lote = clock_timestamp()
		where 	nr_sequencia = nr_seq_lote_p;
		
	end if;
	
	commit;
		
END; 					

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_envio_ans_extra_pck.marcar_estagio_geracao ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, ie_opcao_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
