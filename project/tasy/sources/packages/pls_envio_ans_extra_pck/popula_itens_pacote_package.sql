-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_envio_ans_extra_pck.popula_itens_pacote ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_conv_pacote_int_p pls_monitor_tiss_param.ie_conv_pacote_int%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


_ora2pg_r RECORD;
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;
nr_seq_prestador_retorno_w	pls_prestador.nr_sequencia%type;
nr_seq_regra_retorno_w		pls_prestador_consistencia.nr_sequencia%type;
qt_registro_w			integer;

cd_tabela_ref_w			pls_monitor_tiss_proc_val.cd_tabela_ref%type;
nr_seq_regra_tab_w		pls_regra_tabela_tiss.nr_sequencia%type;
ie_origem_tab_ref_w		pls_monitor_tiss_proc_val.ie_origem_tab_ref%type;
cd_grupo_proc_w			pls_monitor_tiss_proc_val.cd_grupo_proc%type;
nr_seq_regra_gpo_proc_w		pls_monitor_tiss_reg_gpo.nr_sequencia%type;
ie_origem_grupo_proc_w		pls_monitor_tiss_proc_val.ie_origem_grupo_proc%type;

tb_seq_cta_val_proc_w		pls_util_cta_pck.t_number_table;
tb_cd_material_w		pls_util_cta_pck.t_varchar2_table_10;
tb_seq_material_w		pls_util_cta_pck.t_number_table;
tb_ie_origem_proced_w		pls_util_cta_pck.t_number_table;
tb_cd_procedimento_w		pls_util_cta_pck.t_number_table;
tb_cd_tabela_ref_w		pls_util_cta_pck.t_varchar2_table_2;
tb_qt_item_w			pls_util_cta_pck.t_number_table;
tb_nr_seq_regra_tab_w		pls_util_cta_pck.t_number_table;
tb_ie_origem_tab_w		pls_util_cta_pck.t_varchar2_table_20;
nr_seq_ret_pacote_w		pls_conta_proc_regra.nr_seq_ret_pacote%type;
ie_origem_padrao_w		pls_conta_proc.ie_origem_proced%type;
qt_seq_proc_w				integer := 0;
tb_tx_ie_pacote_ausente_w	pls_util_cta_pck.t_varchar2_table_1;
tb_ie_item_comp_sispac_w	pls_util_cta_pck.t_varchar2_table_1;
tb_seq_proc_w				pls_util_cta_pck.t_number_table;
ie_item_comp_sispac_w		varchar(1);

qt_reg_conta_w			integer := 0;
nr_seq_conta_anterior_w	pls_conta.nr_sequencia%type;

-- retorna todos os pacotes com o sequencial da composi??o
C01 CURSOR(	nr_seq_lote_pc		pls_monitor_tiss_lote.nr_sequencia%type) FOR
	SELECT 	c.nr_sequencia nr_seq_ins,
		c.nr_seq_pacote,
		c.ie_tipo_despesa,
		y.nr_seq_composicao,
		z.ie_tipo_conta,
		z.nr_sequencia nr_seq_conta,
		u.nr_seq_prestador nr_seq_prestador_prot,
		coalesce(y.ie_abrir_contas_medicas, 'N') ie_abrir_contas_medicas,
		dt_procedimento_referencia,
		( 	SELECT 	count(1)
			from 	ptu_nota_servico x 
			where 	x.nr_seq_conta_proc = a.nr_sequencia 
			and 	x.ie_tipo_tabela = 4 
			and coalesce(ie_pacote,'N') = 'N'
			) qt_pac_int		
	from 	pls_monitor_tiss_cta_val f,
		pls_monitor_tiss_proc_val c,
		pls_conta_proc 		a,
		pls_pacote_tipo_acomodacao y,
		pls_conta z,
		pls_protocolo_conta u
	where	f.nr_seq_lote_monitor = nr_seq_lote_pc
	and	f.ie_conta_atualizada = 'S'
	and	c.nr_seq_cta_val = f.nr_sequencia
	and	c.ie_item_atualizado = 'S'
	and	c.ie_tipo_despesa = '4'
	and	(c.nr_seq_pacote IS NOT NULL AND c.nr_seq_pacote::text <> '')
	and	a.nr_sequencia = c.nr_seq_conta_proc
	and	y.nr_sequencia = a.nr_seq_preco_pacote
	and	z.nr_sequencia = a.nr_seq_conta
	and	u.nr_sequencia = z.nr_seq_protocolo;

c_proc CURSOR(	nr_seq_pacote_pc	pls_conta_proc.nr_seq_pacote%type,
			nr_seq_composicao_pc	pls_pacote_composicao.nr_sequencia%type,
			nr_seq_prestador_pc	pls_pacote_procedimento.nr_seq_prestador%type,
			ie_tipo_conta_pc	pls_pacote_procedimento.ie_tipo_guia%type,
			ie_tipo_despesa_pc	pls_monitor_tiss_proc_val.ie_tipo_despesa%type,
			cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type) FOR
        SELECT  b.ie_origem_proced,
		b.cd_procedimento,
                coalesce(b.qt_procedimento, 1) qt_procedimento
        from    pls_pacote_procedimento	b
        where   b.nr_seq_composicao	= nr_seq_composicao_pc
        and     b.ie_estrutura    	= 'S'
		and	coalesce(b.ie_situacao, 'A') = 'A'
		and 	(b.cd_procedimento IS NOT NULL AND b.cd_procedimento::text <> '')
        and     ((coalesce(b.nr_seq_prestador::text, '') = '') or (b.nr_seq_prestador = nr_seq_prestador_pc))
        and     ((coalesce(b.ie_tipo_guia::text, '') = '') or (b.ie_tipo_guia = ie_tipo_conta_pc));

c_mat CURSOR(	nr_seq_composicao_pc		pls_pacote_composicao.nr_sequencia%type,
		nr_seq_prestador_pc		pls_pacote_procedimento.nr_seq_prestador%type,
		ie_tipo_conta_pc		pls_pacote_procedimento.ie_tipo_guia%type,
		ie_tipo_despesa_pc		pls_monitor_tiss_proc_val.ie_tipo_despesa%type,
		dt_procedimento_referencia_pc	pls_conta_proc.dt_procedimento_referencia%type,
		cd_estabelecimento_pc		estabelecimento.cd_estabelecimento%type) FOR
        SELECT  pls_gerencia_envio_ans_pck.obter_cod_material_tuss(b.nr_seq_material, null, dt_procedimento_referencia_pc) cd_material,
		b.nr_seq_material,
                coalesce(b.qt_material, 1) qt_material,
		a.ie_tipo_despesa
        from    pls_pacote_material	b,
		pls_material		a
        where   b.nr_seq_composicao	= nr_seq_composicao_pc
	and	b.nr_seq_material	= a.nr_sequencia
	and	coalesce(b.ie_situacao, 'A') = 'A'
	and (b.nr_seq_material IS NOT NULL AND b.nr_seq_material::text <> '')
        and     ((coalesce(b.nr_seq_prestador::text, '') = '') or (b.nr_seq_prestador = nr_seq_prestador_pc))
        and     ((coalesce(b.ie_tipo_guia::text, '') = '') or (b.ie_tipo_guia = ie_tipo_conta_pc));
		
--pacotes intercambio		ie_item_comp_sispac_invalido
C02 CURSOR(	nr_seq_lote_pc		pls_monitor_tiss_lote.nr_sequencia%type) FOR
	SELECT 	c.nr_sequencia nr_seq_ins,
		c.nr_seq_pacote,
		c.ie_tipo_despesa,
		z.ie_tipo_conta,
		z.nr_sequencia nr_seq_conta,
		u.nr_seq_prestador nr_seq_prestador_prot,
		dt_procedimento_referencia,
		w.nr_seq_ret_pacote, -- nova integridade com a PLS_SIS_PAC_RETORNO_PACOTE
		z2.cd_unimed_origem,
		z.dt_atendimento_referencia,
		f.cd_cpf_cgc_prest_exec,
		c.cd_procedimento
	from 	pls_monitor_tiss_cta_val f,
		pls_monitor_tiss_proc_val c,
		pls_conta_proc 		a,
		pls_conta_proc_regra w,
		pls_conta z,
		ptu_nota_cobranca z1,
		ptu_fatura z2,
		pls_protocolo_conta u
	where	f.nr_seq_lote_monitor = nr_seq_lote_pc
	and	f.ie_conta_atualizada = 'S'
	and	c.nr_seq_cta_val = f.nr_sequencia
	and	c.ie_item_atualizado = 'S'
	--and	c.ie_tipo_despesa = '4'
	and	a.nr_sequencia = c.nr_seq_conta_proc
	and a.nr_sequencia = w.nr_sequencia
	and	z.nr_sequencia = a.nr_seq_conta
	and	u.nr_sequencia = z.nr_seq_protocolo
	and z.nr_seq_nota_cobranca = z1.nr_sequencia
	and z1.nr_seq_fatura = z2.nr_sequencia
	and z.ie_origem_conta = 'A'
	and exists ( 	SELECT 	1
			from 	ptu_nota_servico x 
			where 	x.nr_seq_conta_proc = a.nr_sequencia 
			and 	x.ie_tipo_tabela = 4 
			and coalesce(ie_pacote,'N') = 'N') -- item que refere ao pacote no intercambio e nao a composicao 
	and ie_conv_pacote_int_p = 'S'
	order by z.nr_sequencia;	
	--and	c.nr_seq_pacote is not null	
		
c_proc_inter CURSOR(	nr_seq_retorno_pc		pls_sis_pac_retorno_pacote.nr_sequencia%type,
						cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type) FOR
        SELECT  b.cd_procedimento,
                coalesce(b.qt_procedimento, 1) qt_procedimento,
				CASE WHEN b.ie_tp_composicao=1 THEN  2 WHEN b.ie_tp_composicao=2 THEN  3 WHEN b.ie_tp_composicao=6 THEN  1 END  ie_tipo_despesa,
				( 	SELECT 	max(ie_origem_proced)
					from 	procedimento 
					where 	cd_procedimento = b.cd_procedimento 
					and 	ie_situacao = 'A') ie_origem_proced
        from    pls_sis_pac_ret_pac_itens	b
        where   b.nr_seq_retorno	= nr_seq_retorno_pc
        and 	b.ie_tp_composicao in (1,2,6)
		and 	(b.cd_procedimento IS NOT NULL AND b.cd_procedimento::text <> '');

c_mat_inter CURSOR(	nr_seq_retorno_pc		pls_sis_pac_retorno_pacote.nr_sequencia%type,
						cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type) FOR
        SELECT  b.cd_procedimento cd_material,
                coalesce(b.qt_procedimento, 1) qt_material,
				CASE WHEN b.ie_tp_composicao=4 THEN  3 WHEN b.ie_tp_composicao=5 THEN  3 WHEN b.ie_tp_composicao=7 THEN  7 END  ie_tipo_despesa,
				( 	SELECT 	max(nr_sequencia)
					from 	pls_material 
					where 	cd_material_ops = to_char(b.cd_procedimento)) nr_seq_material
        from    pls_sis_pac_ret_pac_itens	b
        where   b.nr_seq_retorno	= nr_seq_retorno_pc
        and 	b.ie_tp_composicao in (4,5,7)
		and 	(b.cd_procedimento IS NOT NULL AND b.cd_procedimento::text <> '');
		
		
BEGIN

select  coalesce(max(ie_origem_proced), 4)
into STRICT 	ie_origem_padrao_w
from 	pls_regra_origem_proced
where 	dt_inicio_vigencia <= clock_timestamp()
and ((coalesce(dt_fim_vigencia::text, '') = '') or ( dt_fim_vigencia >= clock_timestamp()));

qt_registro_w := 0;

for r_C01_w in C01(nr_seq_lote_p) loop

	--se parametro ta marcado para converter pacote de intercambio, nao deve lancar os itens por esse cursor(e sim pelo cursor2), caso exista mesmo pacote no intercambio vinculado a esse item,
	--caso parametro seja = N, entao com ou sem pacote no intercambio, lanca a composicao por aqui e nao pelo cursor 2(exclusivo para quando parametro esta marcado)
				
	if (r_C01_w.qt_pac_int = 0 or ( ie_conv_pacote_int_p = 'N'))  then
		-- se o pacote n?o estiver configurado para n?o ser aberto
		if (r_C01_w.ie_abrir_contas_medicas = 'N') then

			if (r_C01_w.ie_tipo_conta <> 'I') then
				pls_obter_tipo_prest_consist(	r_C01_w.nr_seq_conta, nm_usuario_p,
								nr_seq_prestador_retorno_w, nr_seq_regra_retorno_w);
			end if;

			if (nr_seq_prestador_retorno_w IS NOT NULL AND nr_seq_prestador_retorno_w::text <> '') then
				nr_seq_prestador_w := nr_seq_prestador_retorno_w;
			else
				nr_seq_prestador_w := r_C01_w.nr_seq_prestador_prot;
			end if;

			--Excluir os registros j? existentes
			delete	FROM pls_moni_tiss_item_pac_val
			where	nr_seq_cta_val_proc = r_C01_w.nr_seq_ins;

			-- busca todos os procedimentos do pacote
			for r_c_proc_w in c_proc(	r_C01_w.nr_seq_pacote, r_C01_w.nr_seq_composicao,
							nr_seq_prestador_w, r_C01_w.ie_tipo_conta,
							r_C01_w.ie_tipo_despesa, cd_estabelecimento_p) loop

				SELECT * FROM pls_gerencia_envio_ans_pck.obter_grupo_proc_ans(	r_c_proc_w.cd_procedimento, r_c_proc_w.ie_origem_proced, r_C01_w.ie_tipo_despesa, null, '', cd_estabelecimento_p, 'S', cd_grupo_proc_w, nr_seq_regra_gpo_proc_w, ie_origem_grupo_proc_w) INTO STRICT cd_grupo_proc_w, nr_seq_regra_gpo_proc_w, ie_origem_grupo_proc_w;

				SELECT * FROM pls_gerencia_envio_ans_pck.obter_tipo_tabela_tiss(	r_c_proc_w.cd_procedimento, r_c_proc_w.ie_origem_proced, null, r_C01_w.ie_tipo_despesa, null, cd_estabelecimento_p, cd_tabela_ref_w, nr_seq_regra_tab_w, ie_origem_tab_ref_w) INTO STRICT cd_tabela_ref_w, nr_seq_regra_tab_w, ie_origem_tab_ref_w;

				if	(	(cd_tabela_ref_w In ( '18','19','20','22')) and (coalesce(cd_grupo_proc_w,'000') = '000') )  then

					tb_seq_cta_val_proc_w(qt_registro_w) := r_C01_w.nr_seq_ins;
					tb_cd_material_w(qt_registro_w) := null;
					tb_seq_material_w(qt_registro_w) := null;
					tb_ie_origem_proced_w(qt_registro_w) := r_c_proc_w.ie_origem_proced;
					tb_cd_procedimento_w(qt_registro_w) := r_c_proc_w.cd_procedimento;
					tb_qt_item_w(qt_registro_w) := r_c_proc_w.qt_procedimento;
					tb_cd_tabela_ref_w(qt_registro_w) := cd_tabela_ref_w;
					tb_nr_seq_regra_tab_w(qt_registro_w) := nr_seq_regra_tab_w;
					tb_ie_origem_tab_w(qt_registro_w) := ie_origem_tab_ref_w;

					if (qt_registro_w >= current_setting('pls_envio_ans_extra_pck.qt_registro_transacao_w')::integer) then
						-- insere no banco
						inserir_item_pacote_val(	tb_seq_cta_val_proc_w, tb_cd_material_w, tb_seq_material_w,
										tb_ie_origem_proced_w, tb_cd_procedimento_w, tb_cd_tabela_ref_w,
										tb_qt_item_w, tb_nr_seq_regra_tab_w, tb_ie_origem_tab_w,
										nm_usuario_p);

						--Limpa as vari?veis do type usado para insert
						SELECT * FROM pls_envio_ans_extra_pck.limpar_type_dados_pacote_val(	tb_seq_cta_val_proc_w, tb_cd_material_w, tb_seq_material_w, tb_ie_origem_proced_w, tb_cd_procedimento_w, tb_cd_tabela_ref_w, tb_qt_item_w, tb_nr_seq_regra_tab_w, tb_ie_origem_tab_w) INTO STRICT _ora2pg_r;
 	tb_seq_cta_val_proc_w := _ora2pg_r.tb_seq_cta_val_proc_p; tb_cd_material_w := _ora2pg_r.tb_cd_material_p; tb_seq_material_w := _ora2pg_r.tb_seq_material_p; tb_ie_origem_proced_w := _ora2pg_r.tb_ie_origem_proced_p; tb_cd_procedimento_w := _ora2pg_r.tb_cd_procedimento_p; tb_cd_tabela_ref_w := _ora2pg_r.tb_cd_tabela_ref_p; tb_qt_item_w := _ora2pg_r.tb_qt_item_p; tb_nr_seq_regra_tab_w := _ora2pg_r.tb_nr_seq_regra_tab_p; tb_ie_origem_tab_w := _ora2pg_r.tb_ie_origem_tab_p;

						qt_registro_w := 0;
					else
						qt_registro_w := qt_registro_w + 1;
					end if;
				end if;
			end loop;

			-- busca todos os materiais do pacote
			for r_c_mat_w in c_mat(	r_C01_w.nr_seq_composicao, nr_seq_prestador_w,
							r_C01_w.ie_tipo_conta, r_C01_w.ie_tipo_despesa,
							r_C01_w.dt_procedimento_referencia, cd_estabelecimento_p ) loop

				SELECT * FROM pls_gerencia_envio_ans_pck.obter_grupo_proc_ans(	null, null, '', r_c_mat_w.nr_seq_material, r_c_mat_w.ie_tipo_despesa, cd_estabelecimento_p, 'S', cd_grupo_proc_w, nr_seq_regra_gpo_proc_w, ie_origem_grupo_proc_w) INTO STRICT cd_grupo_proc_w, nr_seq_regra_gpo_proc_w, ie_origem_grupo_proc_w;

				SELECT * FROM pls_gerencia_envio_ans_pck.obter_tipo_tabela_tiss(	null, null, null, r_c_mat_w.ie_tipo_despesa, r_c_mat_w.nr_seq_material, cd_estabelecimento_p, cd_tabela_ref_w, nr_seq_regra_tab_w, ie_origem_tab_ref_w) INTO STRICT cd_tabela_ref_w, nr_seq_regra_tab_w, ie_origem_tab_ref_w;

				if	(	(cd_tabela_ref_w In ( '18','19','20','22')) and (coalesce(cd_grupo_proc_w,'000') = '000') ) then

					tb_seq_cta_val_proc_w(qt_registro_w) := r_C01_w.nr_seq_ins;
					tb_cd_material_w(qt_registro_w) := r_c_mat_w.cd_material;
					tb_seq_material_w(qt_registro_w) := r_c_mat_w.nr_seq_material;
					tb_ie_origem_proced_w(qt_registro_w) := null;
					tb_cd_procedimento_w(qt_registro_w) := null;
					tb_qt_item_w(qt_registro_w) := r_c_mat_w.qt_material;
					tb_cd_tabela_ref_w(qt_registro_w) := cd_tabela_ref_w;
					tb_nr_seq_regra_tab_w(qt_registro_w) := nr_seq_regra_tab_w;
					tb_ie_origem_tab_w(qt_registro_w) := ie_origem_tab_ref_w;

					if (qt_registro_w >= current_setting('pls_envio_ans_extra_pck.qt_registro_transacao_w')::integer) then
						-- insere no banco
						inserir_item_pacote_val(	tb_seq_cta_val_proc_w, tb_cd_material_w, tb_seq_material_w,
										tb_ie_origem_proced_w, tb_cd_procedimento_w, tb_cd_tabela_ref_w,
										tb_qt_item_w, tb_nr_seq_regra_tab_w, tb_ie_origem_tab_w,
										nm_usuario_p);

						--Limpa as vari?veis do type usado para insert
						SELECT * FROM pls_envio_ans_extra_pck.limpar_type_dados_pacote_val(	tb_seq_cta_val_proc_w, tb_cd_material_w, tb_seq_material_w, tb_ie_origem_proced_w, tb_cd_procedimento_w, tb_cd_tabela_ref_w, tb_qt_item_w, tb_nr_seq_regra_tab_w, tb_ie_origem_tab_w) INTO STRICT _ora2pg_r;
 	tb_seq_cta_val_proc_w := _ora2pg_r.tb_seq_cta_val_proc_p; tb_cd_material_w := _ora2pg_r.tb_cd_material_p; tb_seq_material_w := _ora2pg_r.tb_seq_material_p; tb_ie_origem_proced_w := _ora2pg_r.tb_ie_origem_proced_p; tb_cd_procedimento_w := _ora2pg_r.tb_cd_procedimento_p; tb_cd_tabela_ref_w := _ora2pg_r.tb_cd_tabela_ref_p; tb_qt_item_w := _ora2pg_r.tb_qt_item_p; tb_nr_seq_regra_tab_w := _ora2pg_r.tb_nr_seq_regra_tab_p; tb_ie_origem_tab_w := _ora2pg_r.tb_ie_origem_tab_p;

						qt_registro_w := 0;
					else
						qt_registro_w := qt_registro_w + 1;
					end if;
				end if;
			end loop;
		end if;
	end if;

end loop;

for r_C02_w in C02(nr_seq_lote_p) loop

	--deve resetar a variavel para N a cada iteracao no cursor de pacotes
	ie_item_comp_sispac_w := 'N';

	if (r_C02_w.ie_tipo_conta <> 'I') then
		pls_obter_tipo_prest_consist(	r_C02_w.nr_seq_conta, nm_usuario_p,
						nr_seq_prestador_retorno_w, nr_seq_regra_retorno_w);
	end if;

	if (nr_seq_prestador_retorno_w IS NOT NULL AND nr_seq_prestador_retorno_w::text <> '') then
		nr_seq_prestador_w := nr_seq_prestador_retorno_w;
	else
		nr_seq_prestador_w := r_C02_w.nr_seq_prestador_prot;
	end if;

	--Excluir os registros j? existentes
	delete	FROM pls_moni_tiss_item_pac_val
	where	nr_seq_cta_val_proc = r_C02_w.nr_seq_ins;
	
	nr_seq_ret_pacote_w := r_C02_w.nr_seq_ret_pacote;
	if (coalesce(nr_seq_ret_pacote_w::text, '') = '') then
	
		select max(nr_sequencia)
		into STRICT nr_seq_ret_pacote_w
		from (
			SELECT 	a.nr_sequencia
			from 	pls_sis_pac_retorno_pacote a,
					pls_sis_pac_ret_prestador b
			where 	a.cd_procedimento = r_C02_w.cd_procedimento
			and 	a.cd_unimed_origem = r_C02_w.cd_unimed_origem
			and 	a.dt_inicio_vigencia <= r_C02_w.dt_atendimento_referencia
			and 	a.dt_fim_vigencia >= r_C02_w.dt_atendimento_referencia
			and 	a.nr_sequencia = b.nr_seq_retorno
			and 	b.cd_cpf_cnpj = r_C02_w.cd_cpf_cgc_prest_exec
			
union all

			SELECT 	a.nr_sequencia
			from 	pls_sis_pac_retorno_pacote a,
					pls_sis_pac_ret_prestador b
			where 	a.cd_procedimento = r_C02_w.cd_procedimento
			and 	a.cd_unimed_origem = r_C02_w.cd_unimed_origem
			and 	a.dt_inicio_vigencia <= r_C02_w.dt_atendimento_referencia
			and 	coalesce(a.dt_fim_vigencia::text, '') = ''
			and 	a.nr_sequencia = b.nr_seq_retorno
			and 	b.cd_cpf_cnpj = r_C02_w.cd_cpf_cgc_prest_exec			
			
union all

			select 	a.nr_sequencia
			from 	pls_sis_pac_retorno_pacote a,
					pls_sis_pac_ret_prestador b
			where 	a.cd_procedimento = r_C02_w.cd_procedimento
			and 	a.cd_unimed_origem = r_C02_w.cd_unimed_origem
			and 	coalesce(a.dt_inicio_vigencia::text, '') = ''
			and 	coalesce(a.dt_fim_vigencia::text, '') = ''
			and 	a.nr_sequencia = b.nr_seq_retorno
			and 	b.cd_cpf_cnpj = r_C02_w.cd_cpf_cgc_prest_exec
			) alias6;
			
			--busca com cd_cpf somente_numero, pois visto que alguns retornos da unimed do brasil, enviado codigo 0026 e retornou apenas 26... 
			if (coalesce(nr_seq_ret_pacote_w::text, '') = '') then
				select max(nr_sequencia)
				into STRICT nr_seq_ret_pacote_w
				from (
					SELECT 	a.nr_sequencia
					from 	pls_sis_pac_retorno_pacote a,
						pls_sis_pac_ret_prestador b
					where 	a.cd_procedimento = r_C02_w.cd_procedimento
					and 	a.cd_unimed_origem = somente_numero(r_C02_w.cd_unimed_origem)
					and 	a.dt_inicio_vigencia <= r_C02_w.dt_atendimento_referencia
					and 	a.dt_fim_vigencia >= r_C02_w.dt_atendimento_referencia
					and 	a.nr_sequencia = b.nr_seq_retorno
					and 	b.cd_cpf_cnpj = r_C02_w.cd_cpf_cgc_prest_exec
					
union all

					SELECT 	a.nr_sequencia
					from 	pls_sis_pac_retorno_pacote a,
						pls_sis_pac_ret_prestador b
					where 	a.cd_procedimento = r_C02_w.cd_procedimento
					and 	a.cd_unimed_origem = somente_numero(r_C02_w.cd_unimed_origem)
					and 	a.dt_inicio_vigencia <= r_C02_w.dt_atendimento_referencia
					and 	coalesce(a.dt_fim_vigencia::text, '') = ''
					and 	a.nr_sequencia = b.nr_seq_retorno
					and 	b.cd_cpf_cnpj = r_C02_w.cd_cpf_cgc_prest_exec			
					
union all

					select 	a.nr_sequencia
					from 	pls_sis_pac_retorno_pacote a,
						pls_sis_pac_ret_prestador b
					where 	a.cd_procedimento = r_C02_w.cd_procedimento
					and 	a.cd_unimed_origem = somente_numero(r_C02_w.cd_unimed_origem)
					and 	coalesce(a.dt_inicio_vigencia::text, '') = ''
					and 	coalesce(a.dt_fim_vigencia::text, '') = ''
					and 	a.nr_sequencia = b.nr_seq_retorno
					and 	b.cd_cpf_cnpj = r_C02_w.cd_cpf_cgc_prest_exec
					) alias9;
			end if;
						
	end if;		
		
	if (nr_seq_ret_pacote_w IS NOT NULL AND nr_seq_ret_pacote_w::text <> '') then
		-- busca todos os procedimentos do pacote
			for r_c_proc_w in c_proc_inter(	nr_seq_ret_pacote_w, cd_estabelecimento_p) loop
			
				SELECT * FROM pls_gerencia_envio_ans_pck.obter_grupo_proc_ans(	r_c_proc_w.cd_procedimento, coalesce(r_c_proc_w.ie_origem_proced, ie_origem_padrao_w), r_C02_w.ie_tipo_despesa, null, '', cd_estabelecimento_p, 'S', cd_grupo_proc_w, nr_seq_regra_gpo_proc_w, ie_origem_grupo_proc_w) INTO STRICT cd_grupo_proc_w, nr_seq_regra_gpo_proc_w, ie_origem_grupo_proc_w;

				SELECT * FROM pls_gerencia_envio_ans_pck.obter_tipo_tabela_tiss(	r_c_proc_w.cd_procedimento, coalesce(r_c_proc_w.ie_origem_proced, ie_origem_padrao_w), null, r_C02_w.ie_tipo_despesa, null, cd_estabelecimento_p, cd_tabela_ref_w, nr_seq_regra_tab_w, ie_origem_tab_ref_w) INTO STRICT cd_tabela_ref_w, nr_seq_regra_tab_w, ie_origem_tab_ref_w;																
											
				if	(	(cd_tabela_ref_w In ( '18','19','20','22')) and (coalesce(cd_grupo_proc_w,'000') = '000') )  then

					tb_seq_cta_val_proc_w(qt_registro_w) := r_C02_w.nr_seq_ins;
					tb_cd_material_w(qt_registro_w) := null;
					tb_seq_material_w(qt_registro_w) := null;
					tb_ie_origem_proced_w(qt_registro_w) := coalesce(r_c_proc_w.ie_origem_proced,  ie_origem_padrao_w);
					tb_cd_procedimento_w(qt_registro_w) := r_c_proc_w.cd_procedimento;
					tb_qt_item_w(qt_registro_w) := r_c_proc_w.qt_procedimento;
					tb_cd_tabela_ref_w(qt_registro_w) := cd_tabela_ref_w;
					tb_nr_seq_regra_tab_w(qt_registro_w) := nr_seq_regra_tab_w;
					tb_ie_origem_tab_w(qt_registro_w) := ie_origem_tab_ref_w;

					if (qt_registro_w >= current_setting('pls_envio_ans_extra_pck.qt_registro_transacao_w')::integer) then
						-- insere no banco
						inserir_item_pacote_val(	tb_seq_cta_val_proc_w, tb_cd_material_w, tb_seq_material_w,
										tb_ie_origem_proced_w, tb_cd_procedimento_w, tb_cd_tabela_ref_w,
										tb_qt_item_w, tb_nr_seq_regra_tab_w, tb_ie_origem_tab_w,
										nm_usuario_p);

						--Limpa as vari?veis do type usado para insert
						SELECT * FROM pls_envio_ans_extra_pck.limpar_type_dados_pacote_val(	tb_seq_cta_val_proc_w, tb_cd_material_w, tb_seq_material_w, tb_ie_origem_proced_w, tb_cd_procedimento_w, tb_cd_tabela_ref_w, tb_qt_item_w, tb_nr_seq_regra_tab_w, tb_ie_origem_tab_w) INTO STRICT _ora2pg_r;
 	tb_seq_cta_val_proc_w := _ora2pg_r.tb_seq_cta_val_proc_p; tb_cd_material_w := _ora2pg_r.tb_cd_material_p; tb_seq_material_w := _ora2pg_r.tb_seq_material_p; tb_ie_origem_proced_w := _ora2pg_r.tb_ie_origem_proced_p; tb_cd_procedimento_w := _ora2pg_r.tb_cd_procedimento_p; tb_cd_tabela_ref_w := _ora2pg_r.tb_cd_tabela_ref_p; tb_qt_item_w := _ora2pg_r.tb_qt_item_p; tb_nr_seq_regra_tab_w := _ora2pg_r.tb_nr_seq_regra_tab_p; tb_ie_origem_tab_w := _ora2pg_r.tb_ie_origem_tab_p;

						qt_registro_w := 0;
					else
						qt_registro_w := qt_registro_w + 1;
					end if;
				end if;
				
				if (coalesce(r_c_proc_w.ie_origem_proced::text, '') = '') then
					ie_item_comp_sispac_w := 'S';
				end if;
				
			end loop;

			-- busca todos os materiais do pacote
			for r_c_mat_w in c_mat_inter(	nr_seq_ret_pacote_w, cd_estabelecimento_p ) loop

				if (coalesce(r_c_mat_w.nr_seq_material::text, '') = '') then
					ie_item_comp_sispac_w := 'S';
				end if;
			
				SELECT * FROM pls_gerencia_envio_ans_pck.obter_grupo_proc_ans(	null, null, '', r_c_mat_w.nr_seq_material, r_c_mat_w.ie_tipo_despesa, cd_estabelecimento_p, 'S', cd_grupo_proc_w, nr_seq_regra_gpo_proc_w, ie_origem_grupo_proc_w) INTO STRICT cd_grupo_proc_w, nr_seq_regra_gpo_proc_w, ie_origem_grupo_proc_w;

				SELECT * FROM pls_gerencia_envio_ans_pck.obter_tipo_tabela_tiss(	null, null, null, r_c_mat_w.ie_tipo_despesa, r_c_mat_w.nr_seq_material, cd_estabelecimento_p, cd_tabela_ref_w, nr_seq_regra_tab_w, ie_origem_tab_ref_w) INTO STRICT cd_tabela_ref_w, nr_seq_regra_tab_w, ie_origem_tab_ref_w;

				if	(	(cd_tabela_ref_w In ( '18','19','20','22')) and (coalesce(cd_grupo_proc_w,'000') = '000') ) then

					tb_seq_cta_val_proc_w(qt_registro_w) := r_C02_w.nr_seq_ins;
					tb_cd_material_w(qt_registro_w) := r_c_mat_w.cd_material;
					tb_seq_material_w(qt_registro_w) := r_c_mat_w.nr_seq_material;
					tb_ie_origem_proced_w(qt_registro_w) := null;
					tb_cd_procedimento_w(qt_registro_w) := null;
					tb_qt_item_w(qt_registro_w) := r_c_mat_w.qt_material;
					tb_cd_tabela_ref_w(qt_registro_w) := cd_tabela_ref_w;
					tb_nr_seq_regra_tab_w(qt_registro_w) := nr_seq_regra_tab_w;
					tb_ie_origem_tab_w(qt_registro_w) := ie_origem_tab_ref_w;

					if (qt_registro_w >= current_setting('pls_envio_ans_extra_pck.qt_registro_transacao_w')::integer) then
						-- insere no banco
						inserir_item_pacote_val(	tb_seq_cta_val_proc_w, tb_cd_material_w, tb_seq_material_w,
										tb_ie_origem_proced_w, tb_cd_procedimento_w, tb_cd_tabela_ref_w,
										tb_qt_item_w, tb_nr_seq_regra_tab_w, tb_ie_origem_tab_w,
										nm_usuario_p);

						--Limpa as vari?veis do type usado para insert
						SELECT * FROM pls_envio_ans_extra_pck.limpar_type_dados_pacote_val(	tb_seq_cta_val_proc_w, tb_cd_material_w, tb_seq_material_w, tb_ie_origem_proced_w, tb_cd_procedimento_w, tb_cd_tabela_ref_w, tb_qt_item_w, tb_nr_seq_regra_tab_w, tb_ie_origem_tab_w) INTO STRICT _ora2pg_r;
 	tb_seq_cta_val_proc_w := _ora2pg_r.tb_seq_cta_val_proc_p; tb_cd_material_w := _ora2pg_r.tb_cd_material_p; tb_seq_material_w := _ora2pg_r.tb_seq_material_p; tb_ie_origem_proced_w := _ora2pg_r.tb_ie_origem_proced_p; tb_cd_procedimento_w := _ora2pg_r.tb_cd_procedimento_p; tb_cd_tabela_ref_w := _ora2pg_r.tb_cd_tabela_ref_p; tb_qt_item_w := _ora2pg_r.tb_qt_item_p; tb_nr_seq_regra_tab_w := _ora2pg_r.tb_nr_seq_regra_tab_p; tb_ie_origem_tab_w := _ora2pg_r.tb_ie_origem_tab_p;

						qt_registro_w := 0;
					else
						qt_registro_w := qt_registro_w + 1;
					end if;
				end if;
			end loop;
						
			--se chegou aqui significa que encontrou correspondencia no sispac, mas ainda pode ter algum item de composicao nao localizado, por isso usa a variavel
			--de controle ie_item_comp_sispac_w
			tb_tx_ie_pacote_ausente_w(qt_seq_proc_w)	:= 'N';
			tb_ie_item_comp_sispac_w(qt_seq_proc_w)		:= ie_item_comp_sispac_w;
			tb_seq_proc_w(qt_seq_proc_w) := r_c02_w.nr_seq_ins;
		
		else
			--se cair aqui significa que nao achou correspondencia no sispac e obviamente nao consegue localizar composicao, entas as 
			--duas flags ficam marcadas
			tb_tx_ie_pacote_ausente_w(qt_seq_proc_w)	:= 'S';
			tb_ie_item_comp_sispac_w(qt_seq_proc_w)		:= 'S';
			tb_seq_proc_w(qt_seq_proc_w) := r_c02_w.nr_seq_ins;
		end if;
		
		if ( qt_seq_proc_w >= current_setting('pls_envio_ans_extra_pck.qt_registro_transacao_w')::integer) then

			CALL pls_envio_ans_extra_pck.atualiza_flag_tabela( tb_seq_proc_w, tb_tx_ie_pacote_ausente_w, tb_ie_item_comp_sispac_w);
			tb_tx_ie_pacote_ausente_w.delete;
			tb_ie_item_comp_sispac_w.delete;
			tb_seq_proc_w.delete;
			qt_seq_proc_w := 0;
		else
			qt_seq_proc_w := qt_seq_proc_w + 1;
		end if;
		
end loop;

-- se sobrar alguma coisa, manda para o banco
inserir_item_pacote_val(	tb_seq_cta_val_proc_w, tb_cd_material_w, tb_seq_material_w,
				tb_ie_origem_proced_w, tb_cd_procedimento_w, tb_cd_tabela_ref_w,
				tb_qt_item_w, tb_nr_seq_regra_tab_w, tb_ie_origem_tab_w,
				nm_usuario_p);

--Limpa as vari?veis do type usado para insert
SELECT * FROM pls_envio_ans_extra_pck.limpar_type_dados_pacote_val(	tb_seq_cta_val_proc_w, tb_cd_material_w, tb_seq_material_w, tb_ie_origem_proced_w, tb_cd_procedimento_w, tb_cd_tabela_ref_w, tb_qt_item_w, tb_nr_seq_regra_tab_w, tb_ie_origem_tab_w) INTO STRICT _ora2pg_r;
 	tb_seq_cta_val_proc_w := _ora2pg_r.tb_seq_cta_val_proc_p; tb_cd_material_w := _ora2pg_r.tb_cd_material_p; tb_seq_material_w := _ora2pg_r.tb_seq_material_p; tb_ie_origem_proced_w := _ora2pg_r.tb_ie_origem_proced_p; tb_cd_procedimento_w := _ora2pg_r.tb_cd_procedimento_p; tb_cd_tabela_ref_w := _ora2pg_r.tb_cd_tabela_ref_p; tb_qt_item_w := _ora2pg_r.tb_qt_item_p; tb_nr_seq_regra_tab_w := _ora2pg_r.tb_nr_seq_regra_tab_p; tb_ie_origem_tab_w := _ora2pg_r.tb_ie_origem_tab_p;
				
CALL pls_envio_ans_extra_pck.atualiza_flag_tabela( tb_seq_proc_w, tb_tx_ie_pacote_ausente_w, tb_ie_item_comp_sispac_w);
				
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_envio_ans_extra_pck.popula_itens_pacote ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_conv_pacote_int_p pls_monitor_tiss_param.ie_conv_pacote_int%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
