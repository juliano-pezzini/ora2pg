-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_envio_ans_extra_pck.verifica_lote_permissao_exec ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, dt_inicio_ger_lote_p pls_monitor_tiss_lote.dt_inicio_ger_lote%type, dt_fim_ger_lote_p pls_monitor_tiss_lote.dt_fim_ger_lote%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


--Finalidade:Busca por lotes de faturamento, que foram iniciada a sua geracao, mas por algum 
--	motivo a session da geracao foi interrompida, e os tratamentos de exception nao foram executados.	
--	Quando possuir uma situacao destas, nao sera permitido a geracao de nenhum outro lote, ate a situacao
--	do lote invalido ser resolvida.
nr_seq_lote_w	pls_monitor_tiss_lote.nr_sequencia%type;


BEGIN

--Se nao tem inicio de geracao ja setado no lote, entao pode prosseguir com a geracao atual, caso tiver e nao ter um fim geracao, serao necessarias verificacoes adicionais
if ((dt_inicio_ger_lote_p IS NOT NULL AND dt_inicio_ger_lote_p::text <> '') and coalesce(dt_fim_ger_lote_p::text, '') = '') then

	--aqui retorna o seq caso esse lote que tem um inicio de geracao ja setado, mas nao tem mais a session vinculada a ela(processo abortado por alguma razao). Caso 
	--retornar o seq, entao significa que pode prosseguir com a 
	nr_seq_lote_w := pls_envio_ans_extra_pck.retorna_lote_sem_session(nr_seq_lote_p, cd_estabelecimento_p);

	-- Caso retornar o seq, entao significa que pode prosseguir com a execucao atual, caso nao retornar, entao significa que esse lote esta em execucao em alguma outra sessao, entao	
	-- necessita abortar o processo
	if (nr_seq_lote_w is  null) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1194630);
		
	end if;
end if;
	
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_envio_ans_extra_pck.verifica_lote_permissao_exec ( nr_seq_lote_p pls_monitor_tiss_lote.nr_sequencia%type, dt_inicio_ger_lote_p pls_monitor_tiss_lote.dt_inicio_ger_lote%type, dt_fim_ger_lote_p pls_monitor_tiss_lote.dt_fim_ger_lote%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;
