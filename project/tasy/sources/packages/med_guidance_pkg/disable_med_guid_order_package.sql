-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE med_guidance_pkg.disable_med_guid_order ( nr_sequencia_p MEDICAL_GUIDANCE_ORDER.NR_SEQUENCIA%type, nm_usuario_p MEDICAL_GUIDANCE_ORDER.NM_USUARIO%type, cd_estabelecimento_p MEDICAL_GUIDANCE_ORDER.CD_ESTABELECIMENTO%type ) AS $body$
DECLARE


    dt_sysdate_s               timestamp := clock_timestamp();
    cd_evolucao_w              bigint;
    dt_inativacao_w            timestamp;
    ie_gerar_clinical_notes_w  varchar(1) := 'N';


BEGIN
        OBTER_PARAM_USUARIO(281, 1630, OBTER_PERFIL_ATIVO, nm_usuario_p, coalesce(cd_estabelecimento_p, 1), ie_gerar_clinical_notes_w);

        UPDATE  MEDICAL_GUIDANCE_ORDER
        SET     IE_SITUACAO             = 'I',
                DT_INATIVACAO           = dt_sysdate_s,
                DT_ATUALIZACAO          = dt_sysdate_s,
                NM_USUARIO              = nm_usuario_p,
                NM_USUARIO_INATIVACAO   = nm_usuario_p,
                CD_ESTABELECIMENTO      = cd_estabelecimento_p
        WHERE   NR_SEQUENCIA            = nr_sequencia_p;

        SELECT  DT_INATIVACAO
        INTO STRICT    dt_inativacao_w
        FROM    MEDICAL_GUIDANCE_ORDER
        WHERE   NR_SEQUENCIA = nr_sequencia_p;

        IF ie_gerar_clinical_notes_w = 'S' AND (dt_inativacao_w IS NOT NULL AND dt_inativacao_w::text <> '') THEN
            SELECT  max(CD_EVOLUCAO)
            INTO STRICT    cd_evolucao_w
            FROM    MEDICAL_GUIDANCE_ORDER
            WHERE   NR_SEQUENCIA = nr_sequencia_p;

            IF coalesce(cd_evolucao_w, 0) > 0  THEN
			DELETE FROM CLINICAL_NOTE_SOAP_DATA
			WHERE       CD_EVOLUCAO = cd_evolucao_w
			AND         IE_MED_REC_TYPE = 'MED_GUIDANCE'
			AND         IE_STAGE = 1
			AND         IE_SOAP_TYPE = 'P'
			AND         NR_SEQ_MED_ITEM = nr_sequencia_p;
            END IF;
			CALL clinical_notes_pck.soap_data_after_delete(cd_evolucao_w);

        END IF;
    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_guidance_pkg.disable_med_guid_order ( nr_sequencia_p MEDICAL_GUIDANCE_ORDER.NR_SEQUENCIA%type, nm_usuario_p MEDICAL_GUIDANCE_ORDER.NM_USUARIO%type, cd_estabelecimento_p MEDICAL_GUIDANCE_ORDER.CD_ESTABELECIMENTO%type ) FROM PUBLIC;
