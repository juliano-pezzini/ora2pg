-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION med_guidance_pkg.compare_disease_rule (nr_seq_med_guid_fee_p text, cd_pessoa_fisica_p PESSOA_FISICA.CD_PESSOA_FISICA%type) RETURNS boolean AS $body$
DECLARE
	
	
    cd_doenca_w varchar(255);
    qt_idade_w varchar(255);
    ie_diag_princ_depart_w varchar(255);
    ie_unidade_tempo_w varchar(255);
    qt_tempo_w double precision := 0;
    qt_days_w double precision := 0;
    qt_days_pacient_w double precision := 0;		
    ie_retorno_w boolean := false;
		
    cursor_rule CURSOR FOR
    SELECT	cd_doenca,
		si_main_diag,
		si_icd_group,
		si_condition_age,
		qt_age,
		si_condition_period,
		qt_disease_period,
		si_period
    FROM	med_guid_fee_disease
    WHERE	nr_seq_med_guid_fee = nr_seq_med_guid_fee_p
    AND		clock_timestamp() BETWEEN dt_start AND dt_end;
		

BEGIN

	FOR r_cursor_rule IN cursor_rule LOOP

		ie_retorno_w := false;
		ie_diag_princ_depart_w:= med_guidance_pkg.get_info_disease(cd_pessoa_fisica_p, r_cursor_rule.cd_doenca, 'DP');
		ie_unidade_tempo_w := med_guidance_pkg.get_info_disease(cd_pessoa_fisica_p, r_cursor_rule.cd_doenca, 'TMP');
		qt_tempo_w := med_guidance_pkg.get_info_disease(cd_pessoa_fisica_p, r_cursor_rule.cd_doenca, 'QTMP');
		cd_doenca_w := med_guidance_pkg.get_info_disease(cd_pessoa_fisica_p, r_cursor_rule.cd_doenca, 'CD');
			

		IF (r_cursor_rule.si_icd_group = 'S') THEN

			IF NOT(MED_GUIDANCE_PKG.GET_CATEGORY_CID(r_cursor_rule.cd_doenca) = MED_GUIDANCE_PKG.GET_CATEGORY_CID(cd_doenca_w)) THEN
				EXIT;
			END IF;

		ELSE
					
			IF NOT(r_cursor_rule.cd_doenca = cd_doenca_w) THEN
				EXIT;
			END IF;
					
		END IF;
					
		IF (r_cursor_rule.si_main_diag <> ie_diag_princ_depart_w) THEN
			EXIT;
		END IF;
					
		IF (r_cursor_rule.qt_age > 0) THEN
					
			qt_idade_w := obter_idade(obter_dados_pf(cd_pessoa_fisica_p,'DN'), clock_timestamp(), 'A');
					
			IF NOT(MED_GUIDANCE_PKG.COMPARE_RULE(qt_idade_w, r_cursor_rule.si_condition_age, r_cursor_rule.qt_age)) THEN
				EXIT;	
			END IF;
					
		END IF;
					
		IF (r_cursor_rule.qt_disease_period > 0) THEN
					
			qt_days_w := MED_GUIDANCE_PKG.CONVERT_PERIOD_DAYS_RULES(r_cursor_rule.si_period, r_cursor_rule.qt_disease_period);
			qt_days_pacient_w := MED_GUIDANCE_PKG.CONVERT_PERIOD_DAYS_PACIENT(ie_unidade_tempo_w, qt_tempo_w);
						
			IF NOT(MED_GUIDANCE_PKG.COMPARE_RULE(qt_days_w, r_cursor_rule.si_condition_period, qt_days_pacient_w)) THEN
				EXIT;
			END IF;
					
		END IF;
					
		ie_retorno_w := true;
				
	END LOOP;
	
     RETURN ie_retorno_w;
	
    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION med_guidance_pkg.compare_disease_rule (nr_seq_med_guid_fee_p text, cd_pessoa_fisica_p PESSOA_FISICA.CD_PESSOA_FISICA%type) FROM PUBLIC;
