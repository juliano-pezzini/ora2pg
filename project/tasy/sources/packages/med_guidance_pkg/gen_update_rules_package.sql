-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE med_guidance_pkg.gen_update_rules ( nr_seq_edition_p JPN_MEDICAL_GUIDANCE.NR_SEQ_EDITION%type, nm_usuario_p JPN_MEDICAL_GUIDANCE.NM_USUARIO%type ) AS $body$
DECLARE


    C_MEDICAL_GUIDANCE CURSOR FOR
    SELECT  CD_MEDICAL_PRACTICE_CODE,
            QT_CURRENT_SCORE,
            DT_UPDATE,
            DT_END_DATE
    FROM    JPN_MEDICAL_GUIDANCE
    WHERE   NR_SEQ_EDITION = nr_seq_edition_p;

    qt_registros_w          integer;
    cd_estabelecimento_w    JPN_MED_GUIDANCE_EDITION.CD_ESTABELECIMENTO%type;


BEGIN

        SELECT  CD_ESTABELECIMENTO
        INTO STRICT    cd_estabelecimento_w
        FROM    JPN_MED_GUIDANCE_EDITION
        WHERE   NR_SEQUENCIA = nr_seq_edition_p;

        FOR med_guidance_row IN C_MEDICAL_GUIDANCE LOOP

            SELECT  COUNT(*)
            INTO STRICT    qt_registros_w
            FROM    MEDICAL_GUID_ORDER_RULE
            WHERE   CD_MEDICAL_PRACTICE_CODE = med_guidance_row.CD_MEDICAL_PRACTICE_CODE;

            CALL MED_GUIDANCE_PKG.UPSERT_MEDICAL_GUID_ORDER_RULE(
                cd_medical_practice_code_p  => med_guidance_row.CD_MEDICAL_PRACTICE_CODE,
                cd_estabelecimento_p        => cd_estabelecimento_w,
                dt_start_p                  => med_guidance_row.DT_UPDATE,
                dt_end_p                    => med_guidance_row.DT_END_DATE,
                qt_current_score_p          => med_guidance_row.QT_CURRENT_SCORE,
                nm_usuario_p                => nm_usuario_p,
                qt_records_p                => qt_registros_w
            );

        END LOOP;

        COMMIT;
    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_guidance_pkg.gen_update_rules ( nr_seq_edition_p JPN_MEDICAL_GUIDANCE.NR_SEQ_EDITION%type, nm_usuario_p JPN_MEDICAL_GUIDANCE.NM_USUARIO%type ) FROM PUBLIC;
