-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE med_guidance_pkg.med_guidance_temp_action ( nr_seq_med_order_p MEDICAL_GUIDANCE_ORDER.NR_SEQUENCIA%type, nm_usuario_p MEDICAL_GUIDANCE_ORDER.NM_USUARIO%type ) AS $body$
DECLARE


    nr_seq_proc_interno_w       MEDICAL_GUIDANCE_ORDER.NR_SEQ_PROC_INTERNO%type;
    ie_origem_proced_w          MEDICAL_GUIDANCE_ORDER.IE_ORIGEM_PROCED%type;
    cd_procedimento_w           MEDICAL_GUIDANCE_ORDER.CD_PROCEDIMENTO%type;
    cd_procedimento_loc_w       PROCEDIMENTO.CD_PROCEDIMENTO_LOC%type;
    nr_seq_tipo_avaliacao_w     MEDICAL_GUIDANCE_ORDER.NR_SEQ_TIPO_AVALIACAO%type;
    cd_estabelecimento_w        MEDICAL_GUIDANCE_ORDER.CD_ESTABELECIMENTO%type;
    cd_pessoa_fisica_w          MEDICAL_GUIDANCE_ORDER.CD_PESSOA_FISICA%type;
    nr_atendimento_w            MEDICAL_GUIDANCE_ORDER.NR_ATENDIMENTO%type;
    dt_guidance_w               MEDICAL_GUIDANCE_ORDER.DT_GUIDANCE%type;
    dt_calculation_w            MEDICAL_GUIDANCE_ORDER.DT_CALCULATION%type;
    qt_guidance_time_w          MEDICAL_GUIDANCE_ORDER.QT_GUIDANCE_TIME%type;
    dt_guidance_start_time_w    MEDICAL_GUIDANCE_ORDER.DT_GUIDANCE_START_TIME%type;
    cd_professional_w           MEDICAL_GUIDANCE_ORDER.CD_PROFESSIONAL%type;

    ds_departments_w            MEDICAL_GUIDANCE_ORDER.DS_DEPARTMENTS%type;
    qt_score_w                  MEDICAL_GUIDANCE_ORDER.QT_SCORE%type;
    ds_general_explanation_w    MEDICAL_GUIDANCE_ORDER.DS_GENERAL_EXPLANATION%type;
    ds_calculation_method_w     MEDICAL_GUIDANCE_ORDER.DS_CALCULATION_METHOD%type;
    ds_diseases_applicable_w    MEDICAL_GUIDANCE_ORDER.DS_DISEASES_APPLICABLE%type;
    nr_seq_jpn_med_guid_w       JPN_MEDICAL_GUIDANCE.NR_SEQUENCIA%type;

    new_nr_seq_proc_interno_w   MEDICAL_GUIDANCE_ORDER.NR_SEQ_PROC_INTERNO%type;
    new_ie_origem_proced_w      MEDICAL_GUIDANCE_ORDER.IE_ORIGEM_PROCED%type;
    new_cd_procedimento_w       MEDICAL_GUIDANCE_ORDER.CD_PROCEDIMENTO%type;
    new_ds_procedimento_w       PROCEDIMENTO.DS_PROCEDIMENTO%type;
    new_cd_procedimento_loc_w   PROCEDIMENTO.CD_PROCEDIMENTO_LOC%type;
    new_nr_seq_tipo_avaliacao_w MEDICAL_GUIDANCE_ORDER.NR_SEQ_TIPO_AVALIACAO%type;
    nr_order_w                  bigint;

    dt_sysdate_s                timestamp := clock_timestamp();

    cursor_rules CURSOR(
        cd_procedimento_loc_pc      PROCEDIMENTO.CD_PROCEDIMENTO%type,
        nr_seq_tipo_avaliacao_pc    MEDICAL_GUID_ORDER_RULE.NR_SEQ_TIPO_AVALIACAO%type
    ) FOR
        SELECT  X.NR_SEQUENCIA,
                X.NR_SEQ_ORDER_RULE,
                M.NR_SEQ_TIPO_AVALIACAO,
                X.NR_SEQ_PROC_INTERNO,
                X.IE_ORIGEM_PROCED,
                X.CD_PROCEDIMENTO
        FROM    MEDICAL_GUID_ORDER_RULE M,
                JPN_MEDICAL_GUIDANCE J,
                MED_GUID_TEMP_ACTION X
        WHERE   J.CD_MEDICAL_PRACTICE_CODE  = M.CD_MEDICAL_PRACTICE_CODE
        AND     X.NR_SEQ_ORDER_RULE         = M.NR_SEQUENCIA
        AND     M.CD_MEDICAL_PRACTICE_CODE  = cd_procedimento_loc_pc
        AND     M.NR_SEQ_TIPO_AVALIACAO     = nr_seq_tipo_avaliacao_pc
        AND     X.IE_SITUACAO               = 'A';


BEGIN

    SELECT  NR_SEQ_PROC_INTERNO,
            IE_ORIGEM_PROCED,
            CD_PROCEDIMENTO,
            NR_SEQ_TIPO_AVALIACAO,
            CD_ESTABELECIMENTO,
            CD_PESSOA_FISICA,
            NR_ATENDIMENTO,
            DT_GUIDANCE,
            DT_CALCULATION,
            QT_GUIDANCE_TIME,
            DT_GUIDANCE_START_TIME,
            CD_PROFESSIONAL
    INTO STRICT    nr_seq_proc_interno_w,
            ie_origem_proced_w,
            cd_procedimento_w,  
            nr_seq_tipo_avaliacao_w,
            cd_estabelecimento_w,
            cd_pessoa_fisica_w,
            nr_atendimento_w,
            dt_guidance_w,
            dt_calculation_w,
            qt_guidance_time_w,
            dt_guidance_start_time_w,
            cd_professional_w
    FROM    MEDICAL_GUIDANCE_ORDER
    WHERE   NR_SEQUENCIA = nr_seq_med_order_p
    AND     coalesce(NR_SEQ_SUPERIOR_ORDER::text, '') = ''
    AND     coalesce(DT_INATIVACAO::text, '') = '';

    IF (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') THEN
        SELECT  MAX(CD_PROCEDIMENTO_LOC),
                MAX(CD_PROCEDIMENTO),
                MAX(IE_ORIGEM_PROCED)
        INTO STRICT    cd_procedimento_loc_w,
                cd_procedimento_w,
                ie_origem_proced_w
        FROM    PROCEDIMENTO
        WHERE   CD_PROCEDIMENTO = (
            SELECT  MAX(CD_PROCEDIMENTO)
            FROM    PROC_INTERNO
            WHERE   NR_SEQUENCIA = nr_seq_proc_interno_w
        )
        AND     IE_ORIGEM_PROCED = 24;

    ELSIF (cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '')  THEN
        SELECT  MAX(CD_PROCEDIMENTO_LOC)
        INTO STRICT    cd_procedimento_loc_w
        FROM    PROCEDIMENTO
        WHERE   IE_ORIGEM_PROCED = ie_origem_proced_w
        AND     CD_PROCEDIMENTO  = cd_procedimento_w;

    END IF;

    IF  (cd_procedimento_loc_w IS NOT NULL AND cd_procedimento_loc_w::text <> '') AND (nr_seq_tipo_avaliacao_w IS NOT NULL AND nr_seq_tipo_avaliacao_w::text <> '') THEN
        FOR r_cursor_rules IN cursor_rules(cd_procedimento_loc_w, nr_seq_tipo_avaliacao_w) LOOP

            IF  (r_cursor_rules.NR_SEQ_PROC_INTERNO IS NOT NULL AND r_cursor_rules.NR_SEQ_PROC_INTERNO::text <> '') THEN
               SELECT   MAX(CD_PROCEDIMENTO_LOC),
                        MAX(IE_ORIGEM_PROCED),
                        MAX(CD_PROCEDIMENTO),
                        MAX(DS_PROCEDIMENTO)
                INTO STRICT    new_cd_procedimento_loc_w,
                        new_ie_origem_proced_w,
                        new_cd_procedimento_w,
                        new_ds_procedimento_w
                FROM    PROCEDIMENTO
                WHERE   CD_PROCEDIMENTO = (
                    SELECT  MAX(CD_PROCEDIMENTO)
                    FROM    PROC_INTERNO
                    WHERE   NR_SEQUENCIA = r_cursor_rules.NR_SEQ_PROC_INTERNO
                )
                AND     IE_ORIGEM_PROCED = 24;

                new_nr_seq_proc_interno_w := r_cursor_rules.NR_SEQ_PROC_INTERNO;

            ELSIF (r_cursor_rules.CD_PROCEDIMENTO IS NOT NULL AND r_cursor_rules.CD_PROCEDIMENTO::text <> '') THEN
                SELECT  MAX(A.CD_PROCEDIMENTO_LOC) CD_PROCEDIMENTO_LOC,
                        A.IE_ORIGEM_PROCED,
                        A.CD_PROCEDIMENTO,
                        A.DS_PROCEDIMENTO,
                        (
                            SELECT  MAX(X.NR_SEQUENCIA)
                            FROM    PROC_INTERNO X
                            WHERE   X.IE_ORIGEM_PROCED =  A.IE_ORIGEM_PROCED
                            AND     X.CD_PROCEDIMENTO = A.CD_PROCEDIMENTO
                        ) NR_SEQ_PROC_INTERNO
                INTO STRICT    new_cd_procedimento_loc_w,
                        new_ie_origem_proced_w,
                        new_cd_procedimento_w,
                        new_ds_procedimento_w,
                        new_nr_seq_proc_interno_w
                FROM    PROCEDIMENTO A
                WHERE   A.IE_ORIGEM_PROCED = r_cursor_rules.IE_ORIGEM_PROCED
                AND     A.CD_PROCEDIMENTO   = r_cursor_rules.CD_PROCEDIMENTO;

            END IF;

            IF  (new_nr_seq_proc_interno_w IS NOT NULL AND new_nr_seq_proc_interno_w::text <> '') THEN
                IF med_guidance_pkg.validate_temp_med_rules(nr_seq_med_order_p, r_cursor_rules.NR_SEQUENCIA) THEN

                    SELECT  COUNT(1) + 1
                    INTO STRICT    nr_order_w
                    FROM    MEDICAL_GUIDANCE_ORDER
                    WHERE   NR_SEQ_SUPERIOR_ORDER = nr_seq_med_order_p;

                    SELECT  MAX(M.CD_MEDICAL_DEPARTMENT) CD_MEDICAL_DEPARTMENT,
                            MAX(M.QT_CURRENT_SCORE) QT_CURRENT_SCORE,
                            MAX(M.DS_GUIDANCE_EXPLANATION) DS_GUIDANCE_EXPLANATION,
                            MAX(M.DS_CALCULATION_METHOD) DS_CALCULATION_METHOD,
                            MAX(M.NR_SEQ_TIPO_AVALIACAO) NR_SEQ_TIPO_AVALIACAO,
                            MAX(M.CD_DISEASE_NAME) CD_DISEASE_NAME,
                            MAX(J.NR_SEQUENCIA)
                    INTO STRICT    ds_departments_w,
                            qt_score_w,
                            ds_general_explanation_w,
                            ds_calculation_method_w,
                            new_nr_seq_tipo_avaliacao_w,
                            ds_diseases_applicable_w,
                            nr_seq_jpn_med_guid_w
                    FROM    MEDICAL_GUID_ORDER_RULE M,
                            JPN_MEDICAL_GUIDANCE J
                    WHERE   J.CD_MEDICAL_PRACTICE_CODE = M.CD_MEDICAL_PRACTICE_CODE
                    AND     M.CD_MEDICAL_PRACTICE_CODE = new_cd_procedimento_loc_w;

                    INSERT INTO MEDICAL_GUIDANCE_ORDER(
                        NR_SEQUENCIA,
                        DT_ATUALIZACAO,
                        NM_USUARIO,
                        DT_ATUALIZACAO_NREC,
                        NM_USUARIO_NREC,
                        CD_ESTABELECIMENTO,
                        CD_PESSOA_FISICA,
                        NR_ATENDIMENTO,
                        IE_SITUACAO,
                        NR_SEQ_SUPERIOR_ORDER,
                        NR_ORDER,
                        DS_DEPARTMENTS,
                        QT_SCORE,
                        DS_GENERAL_EXPLANATION,
                        DS_CALCULATION_METHOD,
                        NR_SEQ_TIPO_AVALIACAO,
                        DS_DISEASES_APPLICABLE,
                        DT_GUIDANCE,
                        DT_CALCULATION,
                        QT_GUIDANCE_TIME,
                        DT_GUIDANCE_START_TIME,
                        CD_PROFESSIONAL,
                        NR_SEQ_JPN_MED_GUID,
                        IE_ORIGEM_PROCED,
                        CD_PROCEDIMENTO,
                        NR_SEQ_PROC_INTERNO,
                        DS_MEDICAL_INSTRUCTION
                    ) VALUES (
                        nextval('medical_guidance_order_seq'),
                        dt_sysdate_s,
                        nm_usuario_p,
                        dt_sysdate_s,
                        nm_usuario_p,
                        cd_estabelecimento_w,
                        cd_pessoa_fisica_w,
                        nr_atendimento_w,
                        'A',
                        nr_seq_med_order_p,
                        nr_order_w,
                        ds_departments_w,
                        qt_score_w,
                        ds_general_explanation_w,
                        ds_calculation_method_w,
                        new_nr_seq_tipo_avaliacao_w,
                        ds_diseases_applicable_w,
                        dt_guidance_w,
                        dt_calculation_w,
                        qt_guidance_time_w,
                        dt_guidance_start_time_w,
                        cd_professional_w,
                        nr_seq_jpn_med_guid_w,
                        new_ie_origem_proced_w,
                        new_cd_procedimento_w,
                        new_nr_seq_proc_interno_w,
                        new_ds_procedimento_w
                    );

                    COMMIT;
                END IF;
            END IF;
        END LOOP;
    END IF;

    EXCEPTION WHEN OTHERS THEN
        CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(799647, 'DS_ERRO_W=MED_GUIDANCE_TEMP_ACTION'|| chr(10) ||SQLERRM);
    END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_guidance_pkg.med_guidance_temp_action ( nr_seq_med_order_p MEDICAL_GUIDANCE_ORDER.NR_SEQUENCIA%type, nm_usuario_p MEDICAL_GUIDANCE_ORDER.NM_USUARIO%type ) FROM PUBLIC;
