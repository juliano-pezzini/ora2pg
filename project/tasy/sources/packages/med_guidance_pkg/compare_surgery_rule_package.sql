-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION med_guidance_pkg.compare_surgery_rule (nr_seq_med_guid_fee_p text, cd_pessoa_fisica_p PESSOA_FISICA.CD_PESSOA_FISICA%type) RETURNS boolean AS $body$
DECLARE
	

    cursor_rule CURSOR FOR
    SELECT	cd_procedimento,
		si_condition_period,
		qt_surgery_period,
		si_date_surgery,
		si_period
    FROM	med_guid_fee_surgery
    WHERE	clock_timestamp() BETWEEN dt_start AND dt_end
    AND		nr_seq_med_guid_fee = nr_seq_med_guid_fee_p;

    qt_days_w double precision := 0;
    qt_days_date_surgery_w varchar(255);
    qt_dias_w varchar(255);
    qt_dias_real_w varchar(255);
    cd_procedimento_princ_w  varchar(255);
    ie_retorno_w boolean := false;


BEGIN
	FOR r_cursor_rule IN cursor_rule LOOP

		ie_retorno_w := false;
		cd_procedimento_princ_w := med_guidance_pkg.get_info_surgery(cd_pessoa_fisica_p,  r_cursor_rule.cd_procedimento, 'PP');
		qt_dias_w := med_guidance_pkg.get_info_surgery(cd_pessoa_fisica_p,  r_cursor_rule.cd_procedimento, 'QTD');
		qt_dias_real_w := med_guidance_pkg.get_info_surgery(cd_pessoa_fisica_p,  r_cursor_rule.cd_procedimento, 'QTDR');
		
		IF (r_cursor_rule.cd_procedimento <> cd_procedimento_princ_w) THEN
			EXIT;
		END IF;
			
		IF (r_cursor_rule.qt_surgery_period > 0) THEN
			
			IF (r_cursor_rule.si_date_surgery = 'S') THEN
				qt_days_date_surgery_w := qt_dias_real_w;
			ELSE
				qt_days_date_surgery_w := qt_dias_w;
			END IF;
				
			qt_days_w := MED_GUIDANCE_PKG.CONVERT_PERIOD_DAYS_RULES(r_cursor_rule.si_period, r_cursor_rule.qt_surgery_period);
					
			IF NOT(MED_GUIDANCE_PKG.COMPARE_RULE(qt_days_w, r_cursor_rule.si_condition_period, qt_days_date_surgery_w)) THEN
				EXIT;
			END IF;
		END IF;
		
		ie_retorno_w := true;
			
	END LOOP;
		
     RETURN ie_retorno_w;
		
    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION med_guidance_pkg.compare_surgery_rule (nr_seq_med_guid_fee_p text, cd_pessoa_fisica_p PESSOA_FISICA.CD_PESSOA_FISICA%type) FROM PUBLIC;
