-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE med_guidance_pkg.submit_med_guid_order ( nr_sequencia_p MEDICAL_GUIDANCE_ORDER.NR_SEQUENCIA%type, nm_usuario_p MEDICAL_GUIDANCE_ORDER.NM_USUARIO%type, cd_estabelecimento_p MEDICAL_GUIDANCE_ORDER.CD_ESTABELECIMENTO%type ) AS $body$
DECLARE


    nr_atendimento_w            MEDICAL_GUIDANCE_ORDER.NR_ATENDIMENTO%type;
    cd_evolucao_w               bigint;
    dt_sysdate_s                timestamp := clock_timestamp();
    ie_gerar_clinical_notes_w   varchar(1) := 'N';
    cd_pessoa_fisica_w          MEDICAL_GUIDANCE_ORDER.CD_PESSOA_FISICA%type;


BEGIN
        UPDATE  MEDICAL_GUIDANCE_ORDER
        SET     IE_SITUACAO             = 'A',
                DT_LIBERACAO            = dt_sysdate_s,
                DT_ATUALIZACAO          = dt_sysdate_s,
                NM_USUARIO              = nm_usuario_p,
                CD_ESTABELECIMENTO      = cd_estabelecimento_p
        WHERE   NR_SEQUENCIA            = nr_sequencia_p;

        SELECT  NR_ATENDIMENTO,
				CD_PESSOA_FISICA
        INTO STRICT    nr_atendimento_w,
				cd_pessoa_fisica_w
        FROM    MEDICAL_GUIDANCE_ORDER
        WHERE   NR_SEQUENCIA            = nr_sequencia_p;

        OBTER_PARAM_USUARIO(281, 1630, OBTER_PERFIL_ATIVO, nm_usuario_p, coalesce(cd_estabelecimento_p, 1), ie_gerar_clinical_notes_w);
        CALL GENERATE_CPOE_SLIP_NUMBER(null, null, cd_pessoa_fisica_w, null, cd_estabelecimento_p, nm_usuario_p, nr_sequencia_p);

        IF ie_gerar_clinical_notes_w = 'S' THEN
            BEGIN
                cd_evolucao_w := CLINICAL_NOTES_PCK.GERAR_SOAP(nr_atendimento_w, nr_sequencia_p, 'MED_GUIDANCE', NULL, 'P', 1, cd_evolucao_w, null, cd_pessoa_fisica_w);

                UPDATE  MEDICAL_GUIDANCE_ORDER
                SET     CD_EVOLUCAO = cd_evolucao_w
                WHERE   NR_SEQUENCIA = nr_sequencia_p;
            END;
        END IF;

        CALL MED_GUIDANCE_PKG.MED_GUIDANCE_TEMP_ACTION(nr_sequencia_p, nm_usuario_p);
    END;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_guidance_pkg.submit_med_guid_order ( nr_sequencia_p MEDICAL_GUIDANCE_ORDER.NR_SEQUENCIA%type, nm_usuario_p MEDICAL_GUIDANCE_ORDER.NM_USUARIO%type, cd_estabelecimento_p MEDICAL_GUIDANCE_ORDER.CD_ESTABELECIMENTO%type ) FROM PUBLIC;
