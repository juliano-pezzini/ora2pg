-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION med_guidance_pkg.get_days_exam_by_status (cd_procedimento_p PROC_INTERNO.CD_PROCEDIMENTO%type, cd_pessoa_fisica_p PESSOA_FISICA.CD_PESSOA_FISICA%type, si_check_procedure_p text) RETURNS bigint AS $body$
DECLARE

    qt_dias_w varchar(255);

BEGIN	
		
	IF (si_check_procedure_p = '0') THEN
		SELECT TRUNC(clock_timestamp() - MAX(b.dt_atualizacao))
		INTO STRICT   qt_dias_w
		FROM   cpoe_procedimento a
		INNER JOIN proc_interno b ON a.nr_seq_proc_interno = b.nr_sequencia
		WHERE  a.cd_pessoa_fisica = cd_pessoa_fisica_p
		AND    b.cd_procedimento = cd_procedimento_p;
	END IF;
		
	IF (si_check_procedure_p = '1') THEN
		SELECT TRUNC(clock_timestamp() - MAX(a.dt_procedimento))
		INTO STRICT   qt_dias_w
		FROM   procedimento_paciente a
		INNER  JOIN exame_laboratorio b ON a.nr_seq_exame = b.nr_seq_exame
		WHERE  a.cd_pessoa_fisica = cd_pessoa_fisica_p
		AND    a.cd_procedimento = cd_procedimento_p;
	END IF;

	IF (si_check_procedure_p = '2') THEN
		SELECT TRUNC(clock_timestamp() - MAX(dt_exame))
		INTO STRICT   qt_dias_w
		FROM (SELECT max(b.dt_atualizacao) dt_exame
		 FROM   cpoe_procedimento a
		 INNER JOIN proc_interno b ON a.nr_seq_proc_interno = b.nr_sequencia
		 WHERE  a.cd_pessoa_fisica = cd_pessoa_fisica_p
		 AND    b.cd_procedimento = cd_procedimento_p
		
UNION ALL

		 SELECT max(a.dt_procedimento) dt_exame
		 FROM   procedimento_paciente a
		 INNER  JOIN exame_laboratorio b ON a.nr_seq_exame = b.nr_seq_exame
		 WHERE  a.cd_pessoa_fisica = cd_pessoa_fisica_p
		 AND    a.cd_procedimento = cd_procedimento_p) alias6;
	END IF;
		
     RETURN(qt_dias_w);

    END;
	

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION med_guidance_pkg.get_days_exam_by_status (cd_procedimento_p PROC_INTERNO.CD_PROCEDIMENTO%type, cd_pessoa_fisica_p PESSOA_FISICA.CD_PESSOA_FISICA%type, si_check_procedure_p text) FROM PUBLIC;
