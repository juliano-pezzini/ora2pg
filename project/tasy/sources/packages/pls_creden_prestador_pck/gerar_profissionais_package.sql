-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_creden_prestador_pck.gerar_profissionais ( nr_seq_credenciamento_p pls_creden_prestador.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
nr_crm_w		medico.nr_crm%type;
nr_seq_compl_pf_w	compl_pessoa_fisica.nr_sequencia%type;
nr_seq_prestador_med_w	pls_prestador_medico.nr_sequencia%type;

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nm_pessoa,
		a.nr_seq_vinculo,
		a.nr_crm,
		a.uf_crm,
		a.nr_cpf,
		a.ds_email,
		a.cd_cbo,
		b.cd_estabelecimento,
		(SELECT	max(x.nr_sequencia)
		from	cbo_saude x
		where	x.cd_cbo = a.cd_cbo) nr_seq_cbo_saude
	from	pls_cred_prest_med	a,
		pls_creden_prestador	b
	where	b.nr_sequencia		= a.nr_seq_credenciamento
	and	b.nr_sequencia		= nr_seq_credenciamento_p;

c02 CURSOR(	nr_seq_cred_prest_med_pc	pls_cred_prest_med.nr_sequencia%type) FOR
	SELECT	cd_especialidade,
		nr_seq_area_atuacao,
		ie_especialidade_princ
	from	pls_cred_prest_med_espec
	where	nr_seq_cred_prest_med = nr_seq_cred_prest_med_pc;
BEGIN
for c01_w in c01 loop
	begin
	
	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	pessoa_fisica
	where	nr_cpf			= c01_w.nr_cpf
	and	cd_estabelecimento	= c01_w.cd_estabelecimento;
	
	if (coalesce(cd_pessoa_fisica_w::text, '') = '') then
		insert	into	pessoa_fisica(	cd_pessoa_fisica, ie_tipo_pessoa, nm_pessoa_fisica,
				nr_cpf, nm_usuario, dt_atualizacao,
				nm_usuario_nrec, dt_atualizacao_nrec, cd_perfil_ativo,
				cd_estabelecimento, ie_funcionario,nr_seq_cbo_saude )
			values (nextval('pessoa_fisica_seq'), 2, c01_w.nm_pessoa,
				c01_w.nr_cpf, nm_usuario_p, clock_timestamp(),
				nm_usuario_p, clock_timestamp(), wheb_usuario_pck.get_cd_perfil,
				c01_w.cd_estabelecimento, 'N', c01_w.nr_seq_cbo_saude )
			returning cd_pessoa_fisica into cd_pessoa_fisica_w;
		
		if (c01_w.ds_email IS NOT NULL AND c01_w.ds_email::text <> '') then
			select	coalesce(max(nr_sequencia),0) +1
			into STRICT	nr_seq_compl_pf_w
			from	compl_pessoa_fisica
			where	cd_pessoa_fisica = cd_pessoa_fisica_w;
			
			insert	into	compl_pessoa_fisica(	nr_sequencia, cd_pessoa_fisica, ie_tipo_complemento,
					nm_usuario, dt_atualizacao, nm_usuario_nrec,
					dt_atualizacao_nrec, ds_email )
				values (nr_seq_compl_pf_w, cd_pessoa_fisica_w, 2,
					nm_usuario_p, clock_timestamp(), nm_usuario_p,
					clock_timestamp(), c01_w.ds_email );
		end if;
	end if;
	
	select	max(nr_crm)
	into STRICT	nr_crm_w
	from	medico
	where	cd_pessoa_fisica	= cd_pessoa_fisica_w;
	
	if (coalesce(nr_crm_w::text, '') = '') then
		insert	into	medico(	cd_pessoa_fisica, nm_usuario, ie_situacao,
				dt_atualizacao, nm_usuario_nrec, dt_atualizacao_nrec,
				nm_guerra, nr_crm, ie_corpo_clinico,
				ie_corpo_assist, ie_vinculo_medico, ie_ama,
				ie_retaguarda, ie_tsa, ie_coordenador,
				ie_email_laudo, ie_medico_senior, uf_crm )
			values (cd_pessoa_fisica_w, nm_usuario_p, 'A',
				clock_timestamp(), nm_usuario_p, clock_timestamp(),
				c01_w.nm_pessoa, c01_w.nr_crm, 'N',
				'N', 5, 'N',
				'N', 'N', 'N',
				'N', 'N', c01_w.uf_crm );
		
		for c02_w in c02(c01_w.nr_sequencia) loop
			begin
			insert	into	medico_especialidade(	cd_pessoa_fisica, cd_especialidade, nr_seq_prioridade,
					nm_usuario, dt_atualizacao )
				values (cd_pessoa_fisica_w, c02_w.cd_especialidade, 1,
					nm_usuario_p, clock_timestamp() );
			end;
		end loop;
	end if;
	
	insert	into	pls_prestador_medico(	nr_sequencia, nr_seq_prestador, nm_usuario,
			dt_atualizacao, nm_usuario_nrec, dt_atualizacao_nrec,
			cd_medico, ie_situacao, ie_guia_medico,
			ie_tipo_vinculo, ie_residencia_saude )
		values (nextval('pls_prestador_medico_seq'), nr_seq_prestador_p, nm_usuario_p,
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			cd_pessoa_fisica_w, 'A', 'N',
			'V', 'N' )
			returning nr_sequencia into nr_seq_prestador_med_w;

	insert	into	pls_prest_med_vinculo(	nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_prest_med,
			nr_seq_vinculo	)
		values (nextval('pls_prest_med_vinculo_seq'), clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, nr_seq_prestador_med_w,
			c01_w.nr_seq_vinculo );

	for c02_w in c02(c01_w.nr_sequencia) loop
		begin
		insert	into	pls_prestador_med_espec(	nr_sequencia, nr_seq_prestador, nm_usuario,
				dt_atualizacao, nm_usuario_nrec, dt_atualizacao_nrec,
				cd_pessoa_fisica, cd_especialidade, nr_seq_area_atuacao,
				ie_especialidade_princ, ie_rce_atuacao, ie_rqe_espec,
				ie_guia_medico, ie_ptu, ie_endereco_principal )
			values (nextval('pls_prestador_med_espec_seq'), nr_seq_prestador_p, nm_usuario_p,
				clock_timestamp(), nm_usuario_p, clock_timestamp(),
				cd_pessoa_fisica_w, c02_w.cd_especialidade, c02_w.nr_seq_area_atuacao,
				c02_w.ie_especialidade_princ, 'N', 'N',
				'N', 'N', 'S' );
		end;
	end loop;
	
	end;
end loop;
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_creden_prestador_pck.gerar_profissionais ( nr_seq_credenciamento_p pls_creden_prestador.nr_sequencia%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
