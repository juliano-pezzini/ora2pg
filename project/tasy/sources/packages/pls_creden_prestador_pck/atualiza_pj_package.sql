-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_creden_prestador_pck.atualiza_pj ( nr_seq_credenciamento_p pls_creden_prestador.nr_sequencia%type, cd_cgc_p pessoa_juridica.cd_cgc%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

qt_pj_estab_w	integer;
c01 CURSOR FOR
	SELECT	nr_cnpj,
		ds_razao_social,
		nm_fantasia,
		cd_cep,
		ds_endereco,
		nr_endereco,
		ds_complemento,
		ds_bairro,
		cd_municipio_ibge,
		obter_desc_municipio_ibge(cd_municipio_ibge) ds_municipio,
		sg_estado,
		nr_telefone,
		nr_inscricao_estadual,
		nr_inscricao_municipal,
		ds_site_internet,
		ds_email,
		cd_estabelecimento
	from	pls_creden_prestador
	where	nr_sequencia	= nr_seq_credenciamento_p;
BEGIN

for c01_w in c01 loop
	begin
	update	pessoa_juridica
	set	ds_razao_social		= coalesce(c01_w.ds_razao_social,ds_razao_social),
		nm_fantasia		= coalesce(c01_w.nm_fantasia, nm_fantasia),
		cd_cep			= coalesce(c01_w.cd_cep, cd_cep),
		ds_endereco		= coalesce(c01_w.ds_endereco, ds_endereco),
		nr_endereco		= coalesce(c01_w.nr_endereco, nr_endereco),
		ds_complemento		= coalesce(c01_w.ds_complemento, ds_complemento),
		ds_bairro		= coalesce(c01_w.ds_bairro, ds_bairro),
		cd_municipio_ibge	= coalesce(c01_w.cd_municipio_ibge, cd_municipio_ibge),
		ds_municipio		= coalesce(c01_w.ds_municipio, ds_municipio),
		sg_estado		= coalesce(c01_w.sg_estado, sg_estado),
		nr_telefone		= coalesce(c01_w.nr_telefone, nr_telefone),
		nr_inscricao_estadual	= coalesce(c01_w.nr_inscricao_estadual, nr_inscricao_estadual),
		nr_inscricao_municipal	= coalesce(c01_w.nr_inscricao_municipal, nr_inscricao_municipal),
		ds_site_internet	= coalesce(c01_w.ds_site_internet, ds_site_internet),
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	cd_cgc	= cd_cgc_p;
	
	select	count(1)
	into STRICT	qt_pj_estab_w
	from	pessoa_juridica_estab
	where	cd_cgc			= cd_cgc_p
	and	cd_estabelecimento	= c01_w.cd_estabelecimento;
	
	if (qt_pj_estab_w = 0) then
		insert	into	pessoa_juridica_estab(	nr_sequencia, cd_cgc, cd_estabelecimento,
				ds_email, ie_conta_dif_nf, ie_rateio_adiant,
				ie_retem_iss, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec )
			values (	nextval('pessoa_juridica_estab_seq'), cd_cgc_p, c01_w.cd_estabelecimento,
				c01_w.ds_email, 'N', 'P',
				'N', clock_timestamp(), nm_usuario_p,
				clock_timestamp(), nm_usuario_p );
	else
		update	pessoa_juridica_estab
		set	ds_email		= substr(ds_email || ';' || c01_w.ds_email,1,255),
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	cd_cgc			= cd_cgc_p
		and	cd_estabelecimento	= c01_w.cd_estabelecimento;
	end if;
	
	end;
end loop;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_creden_prestador_pck.atualiza_pj ( nr_seq_credenciamento_p pls_creden_prestador.nr_sequencia%type, cd_cgc_p pessoa_juridica.cd_cgc%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;
