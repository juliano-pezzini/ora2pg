-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE FUNCTION tosho_presc_injection_pck.obter_obs_order_unity (NR_SEQ_CPOE_ORDER_UNIT_P bigint) RETURNS varchar AS $body$
DECLARE

			
			DS_OBS_LOOP varchar(1000);
			DS_OBSERVACAO varchar(4000);
			NR_CONTADOR bigint;
			NR_SEQUENCIA_CL1 bigint;
			DS_DATA varchar(4000);
			DS_DATA_AUX varchar(2000);
			
			
BEGIN
			
				SELECT COUNT(*)
				  INTO STRICT NR_CONTADOR
				  FROM CPOE_ORDER_UNIT CO1
			      JOIN CPOE_COMMENT_LINKAGE CL1 ON (CO1.NR_SEQUENCIA = CL1.NR_SEQ_CPOE_ORDER_UNIT)
			      JOIN CPOE_STD_COMMENT CS1 ON (CL1.NR_SEQ_STD_COMMENT = CS1.NR_SEQUENCIA)
			  	 WHERE CO1.NR_SEQUENCIA = NR_SEQ_CPOE_ORDER_UNIT_P;
			  	
			  	 
			  	SELECT TO_CHAR(MAX(DT_ATUALIZACAO), 'DD/MM/YYYY HH24:MI:SS')
			  	  INTO STRICT DS_DATA
			  	  FROM CPOE_COMMENT_LINKAGE
			  	 WHERE NR_SEQ_CPOE_ORDER_UNIT = NR_SEQ_CPOE_ORDER_UNIT_P;
			  	
			  	SELECT MIN(NR_SEQUENCIA)
			  	  INTO STRICT NR_SEQUENCIA_CL1
			  	  FROM CPOE_COMMENT_LINKAGE
			  	 WHERE NR_SEQ_CPOE_ORDER_UNIT = NR_SEQ_CPOE_ORDER_UNIT_P;
			  	
			 	
			  	WHILE NR_CONTADOR >= 1
			  	LOOP
			
					SELECT CL1.NR_SEQUENCIA || ' ' || CL1.NR_SEQ_STD_COMMENT || ' ' || CS1.DS_COMMENT || ' ' || CL1.DS_ADDITIONAL_TEXT 
					  INTO STRICT DS_OBS_LOOP
					  FROM CPOE_ORDER_UNIT CO1
				      JOIN CPOE_COMMENT_LINKAGE CL1 ON (CO1.NR_SEQUENCIA = CL1.NR_SEQ_CPOE_ORDER_UNIT)
				      JOIN CPOE_STD_COMMENT CS1 ON (CL1.NR_SEQ_STD_COMMENT = CS1.NR_SEQUENCIA) 
				  	 WHERE CO1.NR_SEQUENCIA = NR_SEQ_CPOE_ORDER_UNIT_P
				  	   AND CL1.NR_SEQUENCIA = NR_SEQUENCIA_CL1;
				
				NR_CONTADOR := NR_CONTADOR - 1;
				  	
				DS_OBSERVACAO := DS_OBSERVACAO || DS_OBS_LOOP;
				
				
					SELECT MAX(NR_SEQUENCIA)
					  INTO STRICT NR_SEQUENCIA_CL1
					  FROM CPOE_COMMENT_LINKAGE
					 WHERE NR_SEQ_CPOE_ORDER_UNIT = NR_SEQ_CPOE_ORDER_UNIT_P
					   AND TO_CHAR(DT_ATUALIZACAO, 'DD/MM/YYYY HH24:MI:SS') NOT IN DS_DATA;
					
			
					   
					SELECT TO_CHAR(MAX(DT_ATUALIZACAO), 'DD/MM/YYYY HH24:MI:SS')
					  INTO STRICT DS_DATA_AUX
					  FROM CPOE_COMMENT_LINKAGE
					 WHERE NR_SEQ_CPOE_ORDER_UNIT = NR_SEQ_CPOE_ORDER_UNIT_P
					   AND TO_CHAR(DT_ATUALIZACAO, 'DD/MM/YYYY HH24:MI:SS') NOT IN DS_DATA;
					
				DS_DATA := DS_DATA || ',' || DS_DATA_AUX;
					
				
				END LOOP;
			  	
			RETURN DS_OBSERVACAO;
			
			END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION tosho_presc_injection_pck.obter_obs_order_unity (NR_SEQ_CPOE_ORDER_UNIT_P bigint) FROM PUBLIC;
