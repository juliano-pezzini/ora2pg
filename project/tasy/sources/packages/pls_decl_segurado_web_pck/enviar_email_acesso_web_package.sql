-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_decl_segurado_web_pck.enviar_email_acesso_web (nr_seq_declaracao_segurado_p pls_declaracao_segurado.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ds_email_pf_p compl_pessoa_fisica.ds_email%type, qt_dias_limite_hash_p integer, ds_hash_p pls_decl_segurado_web.ds_hash%type, cd_codigo_acesso_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) AS $body$
DECLARE


ds_link_w		pls_web_param_geral.ds_link_portal_ops%type;
ds_mensagem_w		varchar(4000);
ds_assinatura_w		varchar(500);
ds_email_remetente_w	pls_web_param_geral.ds_email_remetente%type;
ds_email_pj_w		pessoa_juridica_compl.ds_email%type;
ds_endereco_w		varchar(500);
ds_local_w		varchar(1000);
ie_assina_email_w	varchar(1);
ie_tipo_compl_w		varchar(255);
nm_fantasia_w		pls_outorgante.nm_fantasia%type;
nm_pf_w			varchar(60);
nr_telefone_w		pessoa_juridica.nr_telefone%type;
ds_assunto_w		varchar(50);


BEGIN
--  Parametros - funcao '1246': OPSW - Portal web
ie_assina_email_w	:= substr(pls_obter_param_padrao_funcao(3,'1246'),1,1); -- Assinar e-mails
ie_tipo_compl_w		:= substr(pls_obter_param_padrao_funcao(17,'1246'),1,255); -- Complemento de pessoa juridica utilizado no portal Web
ds_link_w		:= pls_parametro_operadora_web('LPO', cd_estabelecimento_p);
ds_email_remetente_w	:= pls_parametro_operadora_web('EREM', cd_estabelecimento_p);

nm_pf_w			:= tws_get_name_person(cd_pessoa_fisica_p, cd_estabelecimento_p);

if (coalesce(ds_email_remetente_w::text, '') = '' or ds_email_remetente_w = '') then
	--  Parametro - funcao: MENU DO SISTEMA, Nome do USERID do servidor de E-mail.
	ds_email_remetente_w := pls_obter_param_padrao_funcao(38,'0');
end if;

if (ie_assina_email_w = 'S') then
	ds_assinatura_w := substr(pls_obter_assinatura_email_web(3, 'N', cd_estabelecimento_p),1,500);
	
	if (coalesce(ds_assinatura_w::text, '') = '' or  ds_assinatura_w = '') then
		-- Caso estiver informado um complemento no parametro 17, sera feito a  busca no complemento pessoa juridica, caso contrario sera buscado em Pessoa Juridica
		if ((ie_tipo_compl_w IS NOT NULL AND ie_tipo_compl_w::text <> '') and ie_tipo_compl_w <> 'X') then
			begin
				select  b.nm_fantasia,
					c.ds_endereco ||', '||c.nr_endereco ||', '|| c.ds_complemento ||' - '|| c.ds_bairro ||' - '|| c.cd_cep ds_endereco,
					c.ds_municipio ||' - '|| c.sg_estado ds_local,
					c.nr_telefone,
					c.ds_email
				into STRICT	nm_fantasia_w,
					ds_endereco_w,
					ds_local_w,
					nr_telefone_w,
					ds_email_pj_w
				from	pessoa_juridica a,
					pls_outorgante b, 
					pessoa_juridica_compl c 
				where	a.cd_cgc = b.cd_cgc_outorgante 
				and	a.cd_cgc = c.cd_cgc 
				and	b.cd_cgc_outorgante = c.cd_cgc 
				and	b.cd_estabelecimento = cd_estabelecimento_p 
				and	c.ie_tipo_complemento = ie_tipo_compl_w 
				and	(c.ds_email IS NOT NULL AND c.ds_email::text <> '')  LIMIT 1;
			exception
			when others then
				nm_fantasia_w	:= null;
				ds_endereco_w	:= null;
				ds_local_w	:= null;
				nr_telefone_w	:= null;
				ds_email_pj_w	:= null;
			end;
		end if;	
		-- Caso nao estiver informado nenhum registro no complemento, sera feito a busca pelo Pessoa Juridica
		if (coalesce(nm_fantasia_w::text, '') = '') then
			begin
				select	b.nm_fantasia,
					a.ds_endereco       ||', '   ||
					a.nr_endereco       ||', '   ||
					a.ds_complemento    ||' - '  ||
					a.ds_bairro         ||' - '  ||
					a.cd_cep ds_endereco,
					a.ds_municipio      || ' - '   ||
					a.sg_estado ds_local,
					a.nr_telefone,
					coalesce(pls_obter_dados_pj_compl(b.cd_estabelecimento, a.cd_cgc, 'M'), a.ds_email) ds_email
				into STRICT	nm_fantasia_w,
					ds_endereco_w,
					ds_local_w,
					nr_telefone_w,
					ds_email_pj_w
				from	pessoa_juridica a,
					pls_outorgante b
				where	a.cd_cgc = b.cd_cgc_outorgante
				and	b.cd_estabelecimento = cd_estabelecimento_p  LIMIT 1;
			exception
			when others then
				nm_fantasia_w	:= null;
				ds_endereco_w	:= null;
				ds_local_w	:= null;
				nr_telefone_w	:= null;
				ds_email_pj_w	:= null;
			end;
		end if;
		
		-- Monta a assinatura de email
		ds_assinatura_w := nm_fantasia_w				|| chr(13) || chr(10);
		ds_assinatura_w := ds_assinatura_w ||ds_endereco_w		|| chr(13) || chr(10);
		ds_assinatura_w := ds_assinatura_w ||ds_local_w			|| chr(13) || chr(10);
		ds_assinatura_w := ds_assinatura_w ||'Fone: '|| nr_telefone_w	|| chr(13) || chr(10);
		ds_assinatura_w := ds_assinatura_w || ds_email_pj_w;
	end if;
	
end if;

select	(ds_link_w || (CASE WHEN substr(ds_link_w,length(ds_link_w),length(ds_link_w)-1)='/' THEN ''  ELSE '/' END ))
into STRICT	ds_link_w
;

ds_link_w := ds_link_w || 'pls_acessoDeclaracaoSaude.jsp?h=' || ds_hash_p;

ds_assunto_w	:= wheb_mensagem_pck.get_texto(1129102); --Acesso preenchimento Declaracao de Saude.
/*Monta a mensagem do e-mail. 
Ola #@NM_PF#@
Este e o seu acesso para preencher a declaracao de saude.
O link devera ser utilizado em ate #@QT_DIAS#@ dia(s).
Codigo de acesso
Codigo #@CD_CODIGO#@ 
Clique no link abaixo para acessar a sua declaracao de saude: 
<a href=" #@DS_LINK#@ " target="_blank"> Acesso a declaracao de saude</a> */
ds_mensagem_w	:= wheb_mensagem_pck.get_texto(1129109,'NM_PF=' || nm_pf_w || ';' || 'QT_DIAS=' || qt_dias_limite_hash_p || ';' || 'CD_CODIGO=' || cd_codigo_acesso_p || ';' || 'DS_LINK=' || ds_link_w);

-- Caso possuir assinatura de email, sera concatenado a mensagem com a assinatura
if (ie_assina_email_w = 'S' and (ds_assinatura_w IS NOT NULL AND ds_assinatura_w::text <> '')) then
	ds_mensagem_w := ds_mensagem_w || ds_assinatura_w;
end if;

CALL enviar_email(ds_assunto_w, ds_mensagem_w, ds_email_remetente_w, ds_email_pf_p, nm_usuario_p, 'A');

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_decl_segurado_web_pck.enviar_email_acesso_web (nr_seq_declaracao_segurado_p pls_declaracao_segurado.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ds_email_pf_p compl_pessoa_fisica.ds_email%type, qt_dias_limite_hash_p integer, ds_hash_p pls_decl_segurado_web.ds_hash%type, cd_codigo_acesso_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) FROM PUBLIC;
