-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_decl_segurado_web_pck.gerar_acesso_web (nr_seq_declaracao_segurado_p pls_declaracao_segurado.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) AS $body$
DECLARE

		
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Gerar o link e codigo de acesso a declaracao de saude e enviar os dados ao e-mail da PF.
-------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[  ]  Objetos do dicionario [x] Tasy (Delphi/Java/HTML5) [  ] Portal [  ]  Relatorios [ ] Outros:

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
		
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
ds_email_w			compl_pessoa_fisica.ds_email%type;
ds_hash_cd_acesso_w		pls_decl_segurado_web.ds_hash_cd_acesso%type;
ds_hash_w			wsuite_token.ds_token%type;
qt_dias_limite_hash_w		integer;
cd_codigo_acesso_w		varchar(6);
ie_declaracao_saude_tws_w     	pls_param_plano_saude_tws.ie_declaracao_saude%type;	

C01 CURSOR FOR
	SELECT	nr_sequencia nr_seq_decl_segurado_web
	from	pls_decl_segurado_web
	where	nr_seq_declaracao_segurado	= nr_seq_declaracao_segurado_p
	and	coalesce(dt_utilizacao_hash::text, '') = ''
	and	clock_timestamp() <= dt_validade_hash;

BEGIN

for c01_w in C01 loop
	begin
		CALL pls_decl_segurado_web_pck.inativar_acesso_web(c01_w.nr_seq_decl_segurado_web, cd_estabelecimento_p, nm_usuario_p, 'N');
	end;
end loop;

begin
	select	coalesce(cd_pessoa_responsavel, cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	pls_declaracao_segurado
	where	nr_sequencia	= nr_seq_declaracao_segurado_p
	and	ie_status	in ('L', 'E');
exception
when others then
	cd_pessoa_fisica_w	:= null;
end;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	begin
		select	ds_email
		into STRICT	ds_email_w
		from	compl_pessoa_fisica
		where	cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	ie_tipo_complemento	= 1;
	exception
	when others then
		ds_email_w	:= null;
	end;
	
	begin
		select	coalesce(ie_declaracao_saude, 'N')
		into STRICT	ie_declaracao_saude_tws_w
		from	pls_param_plano_saude_tws
		where	cd_estabelecimento	= cd_estabelecimento_p;
	exception
	when no_data_found then
		ie_declaracao_saude_tws_w	:= 'N';
	end;
	
	if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then
		qt_dias_limite_hash_w	:= Obter_Valor_Param_Usuario(1234, 6, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p);
		cd_codigo_acesso_w	:= dbms_random.string('X', 6);
		ds_hash_cd_acesso_w	:= OBTER_MD5(cd_codigo_acesso_w);
										
		if (ie_declaracao_saude_tws_w	= 'S') then
		
			ds_hash_w		:= wsuite_login_pck.wsuite_generate_hash;
			
			CALL pls_decl_segurado_web_pck.enviar_email_acesso_tws(nr_seq_declaracao_segurado_p, cd_pessoa_fisica_w, ds_email_w,
						qt_dias_limite_hash_w, ds_hash_w, cd_codigo_acesso_w,
						cd_estabelecimento_p, nm_usuario_p);						
		
		else		
			ds_hash_w		:= OBTER_MD5(nr_seq_declaracao_segurado_p || clock_timestamp());
			
			CALL pls_decl_segurado_web_pck.enviar_email_acesso_web(nr_seq_declaracao_segurado_p, cd_pessoa_fisica_w, ds_email_w,
						qt_dias_limite_hash_w, ds_hash_w, cd_codigo_acesso_w,
						cd_estabelecimento_p, nm_usuario_p);						
			
		end if;
		
		insert into pls_decl_segurado_web(	nr_sequencia, dt_atualizacao, nm_usuario,
							dt_atualizacao_nrec, nm_usuario_nrec, cd_estabelecimento, 
							ds_hash, nr_seq_declaracao_segurado, ds_observacao,
							dt_validade_hash, dt_geracao_hash, ds_hash_cd_acesso)
					values (	nextval('pls_decl_segurado_web_seq'), clock_timestamp(), nm_usuario_p,
							clock_timestamp(), nm_usuario_p, cd_estabelecimento_p,
							ds_hash_w, nr_seq_declaracao_segurado_p, '',
							fim_dia(clock_timestamp() + qt_dias_limite_hash_w), clock_timestamp(), ds_hash_cd_acesso_w);
							
		update	pls_declaracao_segurado
		set	ie_status	= 'E',
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia	= nr_seq_declaracao_segurado_p	
		and	ie_status	= 'L';
	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1129056); --Beneficiario sem e-mail cadastrado. Favor verificar.
	end if;
end if;
		
commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_decl_segurado_web_pck.gerar_acesso_web (nr_seq_declaracao_segurado_p pls_declaracao_segurado.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) FROM PUBLIC;
