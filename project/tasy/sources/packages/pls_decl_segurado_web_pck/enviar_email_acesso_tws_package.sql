-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_decl_segurado_web_pck.enviar_email_acesso_tws ( nr_seq_declaracao_segurado_p pls_declaracao_segurado.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ds_email_pf_p compl_pessoa_fisica.ds_email%type, qt_dias_limite_hash_p integer, ds_hash_p pls_decl_segurado_web.ds_hash%type, cd_codigo_acesso_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) AS $body$
DECLARE


ds_link_w		wsuite_configuracao.ds_link_web_suite%type;
ds_assinatura_w		varchar(1000);
ds_mensagem_w		varchar(4000);
ds_email_remetente_w	wsuite_configuracao.ds_email_remetente%type;
ds_email_rodape_w	wsuite_configuracao.ds_email_rodape%type;
ds_endereco_w		wsuite_configuracao.ds_endereco%type;
nm_fantasia_w		pls_outorgante.nm_fantasia%type;
nm_pf_w			varchar(255);
nr_telefone_w		wsuite_configuracao.nr_fone_contato%type;
ds_assunto_w		varchar(50);


BEGIN

select	ds_link_web_suite,
	ds_email_remetente,
	ds_endereco,
	ds_email_rodape,
	nr_fone_contato
into STRICT	ds_link_w,
	ds_email_remetente_w,
	ds_endereco_w,
	ds_email_rodape_w,
	nr_telefone_w
from	wsuite_configuracao
where	ie_aplicacao 		= 10
and	cd_estabelecimento	= cd_estabelecimento_p;

nm_pf_w			:= tws_get_name_person(cd_pessoa_fisica_p, cd_estabelecimento_p);

if (coalesce(ds_email_remetente_w::text, '') = '' or ds_email_remetente_w = '') then
	--  Parametro - funcao: MENU DO SISTEMA, Nome do USERID do servidor de E-mail.
	ds_email_remetente_w := pls_obter_param_padrao_funcao(38,'0');
end if;

nm_fantasia_w	:= pls_obter_dados_outorgante(cd_estabelecimento_p, 'NF');
			
-- Monta a assinatura de email
ds_assinatura_w := nm_fantasia_w				|| chr(13) || chr(10);
ds_assinatura_w := ds_assinatura_w ||ds_endereco_w		|| chr(13) || chr(10);
ds_assinatura_w := ds_assinatura_w ||'Fone: '|| nr_telefone_w	|| chr(13) || chr(10);
ds_assinatura_w := ds_assinatura_w || ds_email_rodape_w;


select	(ds_link_w || (CASE WHEN substr(ds_link_w,length(ds_link_w),length(ds_link_w)-1)='/' THEN ''  ELSE '/' END ))
into STRICT	ds_link_w
;

ds_link_w := ds_link_w || 'declaracao-saude/' || ds_hash_p;

ds_assunto_w	:= wheb_mensagem_pck.get_texto(1129102); --Acesso preenchimento Declaracao de Saude.
/*Monta a mensagem do e-mail. 
Ola #@NM_PF#@
Este e o seu acesso para preencher a declaracao de saude.
O link devera ser utilizado em ate #@QT_DIAS#@ dia(s).
Codigo de acesso
Codigo #@CD_CODIGO#@ 
Clique no link abaixo para acessar a sua declaracao de saude: 
<a href=" #@DS_LINK#@ " target="_blank"> Acesso a declaracao de saude</a> */
ds_mensagem_w	:= wheb_mensagem_pck.get_texto(1129109,'NM_PF=' || nm_pf_w || ';' || 'QT_DIAS=' || qt_dias_limite_hash_p || ';' || 'CD_CODIGO=' || cd_codigo_acesso_p || ';' || 'DS_LINK=' || ds_link_w);

ds_mensagem_w := substr(ds_mensagem_w || ds_assinatura_w,1,4000);

CALL enviar_email(ds_assunto_w, ds_mensagem_w, ds_email_remetente_w, ds_email_pf_p, nm_usuario_p, 'A');

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_decl_segurado_web_pck.enviar_email_acesso_tws ( nr_seq_declaracao_segurado_p pls_declaracao_segurado.nr_sequencia%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ds_email_pf_p compl_pessoa_fisica.ds_email%type, qt_dias_limite_hash_p integer, ds_hash_p pls_decl_segurado_web.ds_hash%type, cd_codigo_acesso_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) FROM PUBLIC;
