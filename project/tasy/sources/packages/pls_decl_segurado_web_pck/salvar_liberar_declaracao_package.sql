-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';




CREATE OR REPLACE PROCEDURE pls_decl_segurado_web_pck.salvar_liberar_declaracao ( nr_seq_declaracao_segurado_p pls_declaracao_segurado.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text, qt_peso_p bigint, qt_altura_cm_p bigint, qt_imc_p bigint, ds_ip_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Salvar os dados de peso, altura e IMC da pf na declaracao, alterar a declaracao para Preenchida
e marcar o hash como utilizado.
-------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[  ]  Objetos do dicionario [x] Tasy (Delphi/Java/HTML5) [ x ] Portal [  ]  Relatorios [ ] Outros:

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_declaracao_segurado_w	pls_declaracao_segurado.nr_sequencia%type;
nr_seq_termo_dec_saude_w	pls_termo_responsabilidade.nr_sequencia%type;
nm_pessoa_fisica_w		pessoa_fisica.nm_pessoa_fisica%type;
ds_mensagem_w			varchar(2000);
qt_registro_w			integer;
dt_atual_w			timestamp;


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_declaracao_segurado_w
from	pls_declaracao_segurado
where	nr_sequencia	= nr_seq_declaracao_segurado_p
and	ie_status	= 'E';

select	max(nr_seq_termo_dec_saude)
into STRICT	nr_seq_termo_dec_saude_w
from	pls_web_param_geral
where	cd_estabelecimento = cd_estabelecimento_p;

if (nr_seq_declaracao_segurado_w IS NOT NULL AND nr_seq_declaracao_segurado_w::text <> '') then
	update	pls_declaracao_segurado
	set	qt_peso		= qt_peso_p,
		qt_altura_cm	= qt_altura_cm_p,
		qt_imc		= qt_imc_p,
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
	where	nr_sequencia	= nr_seq_declaracao_segurado_w;
	
	select 	count(*)
	into STRICT 	qt_registro_w
	from 	pls_declaracao_resposta
	where 	nr_seq_declaracao	= nr_seq_declaracao_segurado_w;
	
	if (qt_registro_w = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(261857,'');
		--O questionario da declaracao de saude nao foi preenchido. Favor verificar.		
	end if;
	
	if (nr_seq_termo_dec_saude_w IS NOT NULL AND nr_seq_termo_dec_saude_w::text <> '') then

		select	substr(obter_nome_pf(cd_pessoa_fisica),1,255),
			clock_timestamp()
		into STRICT	nm_pessoa_fisica_w,
			dt_atual_w
		from	pls_declaracao_segurado
		where	nr_sequencia	= nr_seq_declaracao_segurado_w;

		/* 	Usuario: 
			Nome: 
			Data de finalizacao:
			IP: 
			Aceitou os termos para preenchimento da Declaracao de Saude.*/
			
		ds_mensagem_w := (wheb_mensagem_pck.get_texto(1136655,'NM_USUARIO=' || nm_usuario_p || ';' ||
					'NM_PESSOA_FISICA=' || nm_pessoa_fisica_w || ';' ||
					'DT_ATUAL=' || to_char(clock_timestamp(), 'dd/MM/yyyy hh24:mi:ss') || ';' || 'DS_IP=' || ds_ip_usuario_p));

		insert into pls_declaracao_complemento( nr_sequencia, nm_usuario, nm_usuario_nrec,
							dt_atualizacao, dt_atualizacao_nrec, nr_seq_declaracao,
							dt_complemento, ie_tipo_complemento, ds_complemento,
							nr_seq_termo_responsabilidade)
						values (	nextval('pls_declaracao_complemento_seq'), nm_usuario_p, nm_usuario_p,
							clock_timestamp(), clock_timestamp(), nr_seq_declaracao_segurado_w,
							clock_timestamp(), 'L', ds_mensagem_w,
							nr_seq_termo_dec_saude_w);
	end if;
		
	update	pls_declaracao_segurado
	set	ie_status	= 'P',
		ie_forma_preenchimento	= 'B',
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
	where	nr_sequencia	= nr_seq_declaracao_segurado_w;
	
	update	pls_decl_segurado_web
	set	dt_utilizacao_hash	= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()	
	where	nr_seq_declaracao_segurado	= nr_seq_declaracao_segurado_w
	and	coalesce(dt_utilizacao_hash::text, '') = ''
	and	clock_timestamp() <= fim_dia(dt_validade_hash);	
end if;

commit;

END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_decl_segurado_web_pck.salvar_liberar_declaracao ( nr_seq_declaracao_segurado_p pls_declaracao_segurado.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text, qt_peso_p bigint, qt_altura_cm_p bigint, qt_imc_p bigint, ds_ip_usuario_p text) FROM PUBLIC;
